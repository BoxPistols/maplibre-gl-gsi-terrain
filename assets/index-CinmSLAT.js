(function(){const wt=document.createElement("link").relList;if(wt&&wt.supports&&wt.supports("modulepreload"))return;for(const Dt of document.querySelectorAll('link[rel="modulepreload"]'))Lt(Dt);new MutationObserver(Dt=>{for(const Ft of Dt)if(Ft.type==="childList")for(const it of Ft.addedNodes)it.tagName==="LINK"&&it.rel==="modulepreload"&&Lt(it)}).observe(document,{childList:!0,subtree:!0});function vt(Dt){const Ft={};return Dt.integrity&&(Ft.integrity=Dt.integrity),Dt.referrerPolicy&&(Ft.referrerPolicy=Dt.referrerPolicy),Dt.crossOrigin==="use-credentials"?Ft.credentials="include":Dt.crossOrigin==="anonymous"?Ft.credentials="omit":Ft.credentials="same-origin",Ft}function Lt(Dt){if(Dt.ep)return;Dt.ep=!0;const Ft=vt(Dt);fetch(Dt.href,Ft)}})();var bb=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function wb($t){return $t&&$t.__esModule&&Object.prototype.hasOwnProperty.call($t,"default")?$t.default:$t}var Tb={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v5.13.0/LICENSE.txt
 */(function($t,wt){(function(vt,Lt){$t.exports=Lt()})(bb,function(){var vt={},Lt={};function Dt(it,i,Pe){if(Lt[it]=Pe,it==="index"){var yi="var sharedModule = {}; ("+Lt.shared+")(sharedModule); ("+Lt.worker+")(sharedModule);",tr={};return Lt.shared(tr),Lt.index(vt,tr),typeof window<"u"&&vt.setWorkerUrl(window.URL.createObjectURL(new Blob([yi],{type:"text/javascript"}))),vt}}Dt("shared",["exports"],function(it){function i(h,o,c,g){return new(c||(c=Promise))(function(x,T){function A(G){try{B(g.next(G))}catch(W){T(W)}}function z(G){try{B(g.throw(G))}catch(W){T(W)}}function B(G){var W;G.done?x(G.value):(W=G.value,W instanceof c?W:new c(function(K){K(W)})).then(A,z)}B((g=g.apply(h,o||[])).next())})}function Pe(h,o){this.x=h,this.y=o}function yi(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var tr,vn;typeof SuppressedError=="function"&&SuppressedError,Pe.prototype={clone(){return new Pe(this.x,this.y)},add(h){return this.clone()._add(h)},sub(h){return this.clone()._sub(h)},multByPoint(h){return this.clone()._multByPoint(h)},divByPoint(h){return this.clone()._divByPoint(h)},mult(h){return this.clone()._mult(h)},div(h){return this.clone()._div(h)},rotate(h){return this.clone()._rotate(h)},rotateAround(h,o){return this.clone()._rotateAround(h,o)},matMult(h){return this.clone()._matMult(h)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(h){return this.x===h.x&&this.y===h.y},dist(h){return Math.sqrt(this.distSqr(h))},distSqr(h){const o=h.x-this.x,c=h.y-this.y;return o*o+c*c},angle(){return Math.atan2(this.y,this.x)},angleTo(h){return Math.atan2(this.y-h.y,this.x-h.x)},angleWith(h){return this.angleWithSep(h.x,h.y)},angleWithSep(h,o){return Math.atan2(this.x*o-this.y*h,this.x*h+this.y*o)},_matMult(h){const o=h[2]*this.x+h[3]*this.y;return this.x=h[0]*this.x+h[1]*this.y,this.y=o,this},_add(h){return this.x+=h.x,this.y+=h.y,this},_sub(h){return this.x-=h.x,this.y-=h.y,this},_mult(h){return this.x*=h,this.y*=h,this},_div(h){return this.x/=h,this.y/=h,this},_multByPoint(h){return this.x*=h.x,this.y*=h.y,this},_divByPoint(h){return this.x/=h.x,this.y/=h.y,this},_unit(){return this._div(this.mag()),this},_perp(){const h=this.y;return this.y=this.x,this.x=-h,this},_rotate(h){const o=Math.cos(h),c=Math.sin(h),g=c*this.x+o*this.y;return this.x=o*this.x-c*this.y,this.y=g,this},_rotateAround(h,o){const c=Math.cos(h),g=Math.sin(h),x=o.y+g*(this.x-o.x)+c*(this.y-o.y);return this.x=o.x+c*(this.x-o.x)-g*(this.y-o.y),this.y=x,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Pe},Pe.convert=function(h){if(h instanceof Pe)return h;if(Array.isArray(h))return new Pe(+h[0],+h[1]);if(h.x!==void 0&&h.y!==void 0)return new Pe(+h.x,+h.y);throw new Error("Expected [x, y] or {x, y} point format")};var on=function(){if(vn)return tr;function h(o,c,g,x){this.cx=3*o,this.bx=3*(g-o)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*c,this.by=3*(x-c)-this.cy,this.ay=1-this.cy-this.by,this.p1x=o,this.p1y=c,this.p2x=g,this.p2y=x}return vn=1,tr=h,h.prototype={sampleCurveX:function(o){return((this.ax*o+this.bx)*o+this.cx)*o},sampleCurveY:function(o){return((this.ay*o+this.by)*o+this.cy)*o},sampleCurveDerivativeX:function(o){return(3*this.ax*o+2*this.bx)*o+this.cx},solveCurveX:function(o,c){if(c===void 0&&(c=1e-6),o<0)return 0;if(o>1)return 1;for(var g=o,x=0;x<8;x++){var T=this.sampleCurveX(g)-o;if(Math.abs(T)<c)return g;var A=this.sampleCurveDerivativeX(g);if(Math.abs(A)<1e-6)break;g-=T/A}var z=0,B=1;for(g=o,x=0;x<20&&(T=this.sampleCurveX(g),!(Math.abs(T-o)<c));x++)o>T?z=g:B=g,g=.5*(B-z)+z;return g},solve:function(o,c){return this.sampleCurveY(this.solveCurveX(o,c))}},tr}(),Br=yi(on);let Or,Ri;function Ve(){return Or==null&&(Or=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),Or}function Io(){if(Ri==null&&(Ri=!1,Ve())){const o=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(o){for(let g=0;g<5*5;g++){const x=4*g;o.fillStyle=`rgb(${x},${x+1},${x+2})`,o.fillRect(g%5,Math.floor(g/5),1,1)}const c=o.getImageData(0,0,5,5).data;for(let g=0;g<5*5*4;g++)if(g%4!=3&&c[g]!==g){Ri=!0;break}}}return Ri||!1}var gr=1e-6,Yr=typeof Float32Array<"u"?Float32Array:Array;function Fn(){var h=new Yr(9);return Yr!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[5]=0,h[6]=0,h[7]=0),h[0]=1,h[4]=1,h[8]=1,h}function us(h){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}function ao(){var h=new Yr(3);return Yr!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h}function Do(h){var o=h[0],c=h[1],g=h[2];return Math.sqrt(o*o+c*c+g*g)}function tl(h,o,c){var g=new Yr(3);return g[0]=h,g[1]=o,g[2]=c,g}function fa(h,o,c){return h[0]=o[0]+c[0],h[1]=o[1]+c[1],h[2]=o[2]+c[2],h}function Nl(h,o,c){return h[0]=o[0]*c,h[1]=o[1]*c,h[2]=o[2]*c,h}function nc(h,o,c){var g=o[0],x=o[1],T=o[2],A=c[0],z=c[1],B=c[2];return h[0]=x*B-T*z,h[1]=T*A-g*B,h[2]=g*z-x*A,h}var Vl,Zr=Do;function bh(h,o,c){var g=o[0],x=o[1],T=o[2],A=o[3];return h[0]=c[0]*g+c[4]*x+c[8]*T+c[12]*A,h[1]=c[1]*g+c[5]*x+c[9]*T+c[13]*A,h[2]=c[2]*g+c[6]*x+c[10]*T+c[14]*A,h[3]=c[3]*g+c[7]*x+c[11]*T+c[15]*A,h}function ws(){var h=new Yr(4);return Yr!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h[3]=1,h}function so(h,o,c,g){var x=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"zyx",T=Math.PI/360;o*=T,g*=T,c*=T;var A=Math.sin(o),z=Math.cos(o),B=Math.sin(c),G=Math.cos(c),W=Math.sin(g),K=Math.cos(g);switch(x){case"xyz":h[0]=A*G*K+z*B*W,h[1]=z*B*K-A*G*W,h[2]=z*G*W+A*B*K,h[3]=z*G*K-A*B*W;break;case"xzy":h[0]=A*G*K-z*B*W,h[1]=z*B*K-A*G*W,h[2]=z*G*W+A*B*K,h[3]=z*G*K+A*B*W;break;case"yxz":h[0]=A*G*K+z*B*W,h[1]=z*B*K-A*G*W,h[2]=z*G*W-A*B*K,h[3]=z*G*K+A*B*W;break;case"yzx":h[0]=A*G*K+z*B*W,h[1]=z*B*K+A*G*W,h[2]=z*G*W-A*B*K,h[3]=z*G*K-A*B*W;break;case"zxy":h[0]=A*G*K-z*B*W,h[1]=z*B*K+A*G*W,h[2]=z*G*W+A*B*K,h[3]=z*G*K-A*B*W;break;case"zyx":h[0]=A*G*K-z*B*W,h[1]=z*B*K+A*G*W,h[2]=z*G*W-A*B*K,h[3]=z*G*K+A*B*W;break;default:throw new Error("Unknown angle order "+x)}return h}function dn(){var h=new Yr(2);return Yr!=Float32Array&&(h[0]=0,h[1]=0),h}function Fo(h,o){var c=new Yr(2);return c[0]=h,c[1]=o,c}ao(),Vl=new Yr(4),Yr!=Float32Array&&(Vl[0]=0,Vl[1]=0,Vl[2]=0,Vl[3]=0),ao(),tl(1,0,0),tl(0,1,0),ws(),ws(),Fn(),dn();const Ln=8192;function Ea(h,o,c){return o*(Ln/(h.tileSize*Math.pow(2,c-h.tileID.overscaledZ)))}function js(h,o){return(h%o+o)%o}function Js(h,o,c){return h*(1-c)+o*c}function Jn(h){if(h<=0)return 0;if(h>=1)return 1;const o=h*h,c=o*h;return 4*(h<.5?c:3*(h-o)+c-.75)}function Ks(h,o,c,g){const x=new Br(h,o,c,g);return T=>x.solve(T)}const Ul=Ks(.25,.1,.25,1);function Qs(h,o,c){return Math.min(c,Math.max(o,h))}function ja(h,o,c){const g=c-o,x=((h-o)%g+g)%g+o;return x===o?c:x}function Wo(h,...o){for(const c of o)for(const g in c)h[g]=c[g];return h}let bn=1;function ho(h,o,c){const g={};for(const x in h)g[x]=o.call(this,h[x],x,h);return g}function qo(h,o,c){const g={};for(const x in h)o.call(this,h[x],x,h)&&(g[x]=h[x]);return g}function ma(h){return Array.isArray(h)?h.map(ma):typeof h=="object"&&h?ho(h,ma):h}const Kn={};function vo(h){Kn[h]||(typeof console<"u"&&console.warn(h),Kn[h]=!0)}function ns(h,o,c){return(c.y-h.y)*(o.x-h.x)>(o.y-h.y)*(c.x-h.x)}function Ds(h){return typeof WorkerGlobalScope<"u"&&h!==void 0&&h instanceof WorkerGlobalScope}let lo=null;function Zn(h){return typeof ImageBitmap<"u"&&h instanceof ImageBitmap}const el="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function jl(h,o,c,g,x){return i(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const T=new VideoFrame(h,{timestamp:0});try{const A=T?.format;if(!A||!A.startsWith("BGR")&&!A.startsWith("RGB"))throw new Error(`Unrecognized format ${A}`);const z=A.startsWith("BGR"),B=new Uint8ClampedArray(g*x*4);if(yield T.copyTo(B,function(G,W,K,ot,ct){const dt=4*Math.max(-W,0),xt=(Math.max(0,K)-K)*ot*4+dt,At=4*ot,jt=Math.max(0,W),ue=Math.max(0,K);return{rect:{x:jt,y:ue,width:Math.min(G.width,W+ot)-jt,height:Math.min(G.height,K+ct)-ue},layout:[{offset:xt,stride:At}]}}(h,o,c,g,x)),z)for(let G=0;G<B.length;G+=4){const W=B[G];B[G]=B[G+2],B[G+2]=W}return B}finally{T.close()}})}let Ts,ga;function Gl(h,o,c,g){return h.addEventListener(o,c,g),{unsubscribe:()=>{h.removeEventListener(o,c,g)}}}function ds(h){return h*Math.PI/180}function Ss(h){return h/Math.PI*180}const il={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},Sl={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},Il="AbortError";function zs(){return new Error(Il)}const rl={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Ga(h){return rl.REGISTERED_PROTOCOLS[h.substring(0,h.indexOf("://"))]}const $l="global-dispatcher";class Aa extends Error{constructor(o,c,g,x){super(`AJAXError: ${c} (${o}): ${g}`),this.status=o,this.statusText=c,this.url=g,this.body=x}}const Hn=()=>Ds(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,we=function(h,o){if(/:\/\//.test(h.url)&&!/^https?:|^file:/.test(h.url)){const g=Ga(h.url);if(g)return g(h,o);if(Ds(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,targetMapId:$l},o)}if(!(/^file:/.test(c=h.url)||/^file:/.test(Hn())&&!/^\w+:/.test(c))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(g,x){return i(this,void 0,void 0,function*(){const T=new Request(g.url,{method:g.method||"GET",body:g.body,credentials:g.credentials,headers:g.headers,cache:g.cache,referrer:Hn(),signal:x.signal});let A,z;g.type!=="json"||T.headers.has("Accept")||T.headers.set("Accept","application/json");try{A=yield fetch(T)}catch(G){throw new Aa(0,G.message,g.url,new Blob)}if(!A.ok){const G=yield A.blob();throw new Aa(A.status,A.statusText,g.url,G)}z=g.type==="arrayBuffer"||g.type==="image"?A.arrayBuffer():g.type==="json"?A.json():A.text();const B=yield z;if(x.signal.aborted)throw zs();return{data:B,cacheControl:A.headers.get("Cache-Control"),expires:A.headers.get("Expires")}})}(h,o);if(Ds(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,mustQueue:!0,targetMapId:$l},o)}var c;return function(g,x){return new Promise((T,A)=>{var z;const B=new XMLHttpRequest;B.open(g.method||"GET",g.url,!0),g.type!=="arrayBuffer"&&g.type!=="image"||(B.responseType="arraybuffer");for(const G in g.headers)B.setRequestHeader(G,g.headers[G]);g.type==="json"&&(B.responseType="text",!((z=g.headers)===null||z===void 0)&&z.Accept||B.setRequestHeader("Accept","application/json")),B.withCredentials=g.credentials==="include",B.onerror=()=>{A(new Error(B.statusText))},B.onload=()=>{if(!x.signal.aborted)if((B.status>=200&&B.status<300||B.status===0)&&B.response!==null){let G=B.response;if(g.type==="json")try{G=JSON.parse(B.response)}catch(W){return void A(W)}T({data:G,cacheControl:B.getResponseHeader("Cache-Control"),expires:B.getResponseHeader("Expires")})}else{const G=new Blob([B.response],{type:B.getResponseHeader("Content-Type")});A(new Aa(B.status,B.statusText,g.url,G))}},x.signal.addEventListener("abort",()=>{B.abort(),A(zs())}),B.send(g.body)})}(h,o)};function It(h){if(!h||h.indexOf("://")<=0||h.indexOf("data:image/")===0||h.indexOf("blob:")===0)return!0;const o=new URL(h),c=window.location;return o.protocol===c.protocol&&o.host===c.host}function Mt(h,o,c){c[h]&&c[h].indexOf(o)!==-1||(c[h]=c[h]||[],c[h].push(o))}function Ut(h,o,c){if(c&&c[h]){const g=c[h].indexOf(o);g!==-1&&c[h].splice(g,1)}}class he{constructor(o,c={}){Wo(this,c),this.type=o}}class le extends he{constructor(o,c={}){super("error",Wo({error:o},c))}}class Re{on(o,c){return this._listeners=this._listeners||{},Mt(o,c,this._listeners),{unsubscribe:()=>{this.off(o,c)}}}off(o,c){return Ut(o,c,this._listeners),Ut(o,c,this._oneTimeListeners),this}once(o,c){return c?(this._oneTimeListeners=this._oneTimeListeners||{},Mt(o,c,this._oneTimeListeners),this):new Promise(g=>this.once(o,g))}fire(o,c){typeof o=="string"&&(o=new he(o,c||{}));const g=o.type;if(this.listens(g)){o.target=this;const x=this._listeners&&this._listeners[g]?this._listeners[g].slice():[];for(const z of x)z.call(this,o);const T=this._oneTimeListeners&&this._oneTimeListeners[g]?this._oneTimeListeners[g].slice():[];for(const z of T)Ut(g,z,this._oneTimeListeners),z.call(this,o);const A=this._eventedParent;A&&(Wo(o,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),A.fire(o))}else o instanceof le&&console.error(o.error);return this}listens(o){return this._listeners&&this._listeners[o]&&this._listeners[o].length>0||this._oneTimeListeners&&this._oneTimeListeners[o]&&this._oneTimeListeners[o].length>0||this._eventedParent&&this._eventedParent.listens(o)}setEventedParent(o,c){return this._eventedParent=o,this._eventedParentData=c,this}}var te={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},"font-faces":{type:"array",value:"fontFaces"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},encoding:{type:"enum",values:{mvt:{},mlt:{}},default:"mvt"},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const ze=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function We(h,o){const c={};for(const g in h)g!=="ref"&&(c[g]=h[g]);return ze.forEach(g=>{g in o&&(c[g]=o[g])}),c}function ci(h,o){if(Array.isArray(h)){if(!Array.isArray(o)||h.length!==o.length)return!1;for(let c=0;c<h.length;c++)if(!ci(h[c],o[c]))return!1;return!0}if(typeof h=="object"&&h!==null&&o!==null){if(typeof o!="object"||Object.keys(h).length!==Object.keys(o).length)return!1;for(const c in h)if(!ci(h[c],o[c]))return!1;return!0}return h===o}function ui(h,o){h.push(o)}function or(h,o,c){ui(c,{command:"addSource",args:[h,o[h]]})}function Ir(h,o,c){ui(o,{command:"removeSource",args:[h]}),c[h]=!0}function Ae(h,o,c,g){Ir(h,c,g),or(h,o,c)}function bo(h,o,c){let g;for(g in h[c])if(Object.prototype.hasOwnProperty.call(h[c],g)&&g!=="data"&&!ci(h[c][g],o[c][g]))return!1;for(g in o[c])if(Object.prototype.hasOwnProperty.call(o[c],g)&&g!=="data"&&!ci(h[c][g],o[c][g]))return!1;return!0}function _n(h,o,c,g,x,T){h=h||{},o=o||{};for(const A in h)Object.prototype.hasOwnProperty.call(h,A)&&(ci(h[A],o[A])||c.push({command:T,args:[g,A,o[A],x]}));for(const A in o)Object.prototype.hasOwnProperty.call(o,A)&&!Object.prototype.hasOwnProperty.call(h,A)&&(ci(h[A],o[A])||c.push({command:T,args:[g,A,o[A],x]}))}function Un(h){return h.id}function rr(h,o){return h[o.id]=o,h}class bi{constructor(o,c,g,x){this.message=(o?`${o}: `:"")+g,x&&(this.identifier=x),c!=null&&c.__line__&&(this.line=c.__line__)}}function Bo(h,...o){for(const c of o)for(const g in c)h[g]=c[g];return h}class wo extends Error{constructor(o,c){super(c),this.message=c,this.key=o}}class se{constructor(o,c=[]){this.parent=o,this.bindings={};for(const[g,x]of c)this.bindings[g]=x}concat(o){return new se(this,o)}get(o){if(this.bindings[o])return this.bindings[o];if(this.parent)return this.parent.get(o);throw new Error(`${o} not found in scope.`)}has(o){return!!this.bindings[o]||!!this.parent&&this.parent.has(o)}}const st={kind:"null"},tt={kind:"number"},Tt={kind:"string"},Nt={kind:"boolean"},Wt={kind:"color"},oe={kind:"projectionDefinition"},ye={kind:"object"},Jt={kind:"value"},xe={kind:"collator"},ti={kind:"formatted"},$e={kind:"padding"},Mi={kind:"colorArray"},Ji={kind:"numberArray"},Xi={kind:"resolvedImage"},qi={kind:"variableAnchorOffsetCollection"};function hr(h,o){return{kind:"array",itemType:h,N:o}}function Yi(h){if(h.kind==="array"){const o=Yi(h.itemType);return typeof h.N=="number"?`array<${o}, ${h.N}>`:h.itemType.kind==="value"?"array":`array<${o}>`}return h.kind}const wn=[st,tt,Tt,Nt,Wt,oe,ti,ye,hr(Jt),$e,Ji,Mi,Xi,qi];function Pn(h,o){if(o.kind==="error")return null;if(h.kind==="array"){if(o.kind==="array"&&(o.N===0&&o.itemType.kind==="value"||!Pn(h.itemType,o.itemType))&&(typeof h.N!="number"||h.N===o.N))return null}else{if(h.kind===o.kind)return null;if(h.kind==="value"){for(const c of wn)if(!Pn(c,o))return null}}return`Expected ${Yi(h)} but found ${Yi(o)} instead.`}function zo(h,o){return o.some(c=>c.kind===h.kind)}function Gr(h,o){return o.some(c=>c==="null"?h===null:c==="array"?Array.isArray(h):c==="object"?h&&!Array.isArray(h)&&typeof h=="object":c===typeof h)}function Wn(h,o){return h.kind==="array"&&o.kind==="array"?h.itemType.kind===o.itemType.kind&&typeof h.N=="number":h.kind===o.kind}const an=.96422,Rr=.82521,Bn=4/29,jn=6/29,Tn=3*jn*jn,Gn=jn*jn*jn,os=Math.PI/180,ta=180/Math.PI;function El(h){return(h%=360)<0&&(h+=360),h}function wh([h,o,c,g]){let x,T;const A=nl((.2225045*(h=es(h))+.7168786*(o=es(o))+.0606169*(c=es(c)))/1);h===o&&o===c?x=T=A:(x=nl((.4360747*h+.3850649*o+.1430804*c)/an),T=nl((.0139322*h+.0971045*o+.7141733*c)/Rr));const z=116*A-16;return[z<0?0:z,500*(x-A),200*(A-T),g]}function es(h){return h<=.04045?h/12.92:Math.pow((h+.055)/1.055,2.4)}function nl(h){return h>Gn?Math.pow(h,1/3):h/Tn+Bn}function _a([h,o,c,g]){let x=(h+16)/116,T=isNaN(o)?x:x+o/500,A=isNaN(c)?x:x-c/200;return x=1*Pa(x),T=an*Pa(T),A=Rr*Pa(A),[Al(3.1338561*T-1.6168667*x-.4906146*A),Al(-.9787684*T+1.9161415*x+.033454*A),Al(.0719453*T-.2289914*x+1.4052427*A),g]}function Al(h){return(h=h<=.00304?12.92*h:1.055*Math.pow(h,1/2.4)-.055)<0?0:h>1?1:h}function Pa(h){return h>jn?h*h*h:Tn*(h-Bn)}const $a=Object.hasOwn||function(h,o){return Object.prototype.hasOwnProperty.call(h,o)};function ql(h,o){return $a(h,o)?h[o]:void 0}function Th(h){return parseInt(h.padEnd(2,h),16)/255}function Ou(h,o){return ol(o?h/100:h,0,1)}function ol(h,o,c){return Math.min(Math.max(o,h),c)}function Ma(h){return!h.some(Number.isNaN)}const oc={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function ss(h,o,c){return h+c*(o-h)}function Gs(h,o,c){return h.map((g,x)=>ss(g,o[x],c))}class tn{constructor(o,c,g,x=1,T=!0){this.r=o,this.g=c,this.b=g,this.a=x,T||(this.r*=x,this.g*=x,this.b*=x,x||this.overwriteGetter("rgb",[o,c,g,x]))}static parse(o){if(o instanceof tn)return o;if(typeof o!="string")return;const c=function(g){if((g=g.toLowerCase().trim())==="transparent")return[0,0,0,0];const x=ql(oc,g);if(x){const[A,z,B]=x;return[A/255,z/255,B/255,1]}if(g.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(g)){const A=g.length<6?1:2;let z=1;return[Th(g.slice(z,z+=A)),Th(g.slice(z,z+=A)),Th(g.slice(z,z+=A)),Th(g.slice(z,z+A)||"ff")]}if(g.startsWith("rgb")){const A=g.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(A){const[z,B,G,W,K,ot,ct,dt,xt,At,jt,ue]=A,Qt=[W||" ",ct||" ",At].join("");if(Qt==="  "||Qt==="  /"||Qt===",,"||Qt===",,,"){const ie=[G,ot,xt].join(""),Se=ie==="%%%"?100:ie===""?255:0;if(Se){const Ee=[ol(+B/Se,0,1),ol(+K/Se,0,1),ol(+dt/Se,0,1),jt?Ou(+jt,ue):1];if(Ma(Ee))return Ee}}return}}const T=g.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(T){const[A,z,B,G,W,K,ot,ct,dt]=T,xt=[B||" ",W||" ",ot].join("");if(xt==="  "||xt==="  /"||xt===",,"||xt===",,,"){const At=[+z,ol(+G,0,100),ol(+K,0,100),ct?Ou(+ct,dt):1];if(Ma(At))return function([jt,ue,Qt,ie]){function Se(Ee){const ei=(Ee+jt/30)%12,Ai=ue*Math.min(Qt,1-Qt);return Qt-Ai*Math.max(-1,Math.min(ei-3,9-ei,1))}return jt=El(jt),ue/=100,Qt/=100,[Se(0),Se(8),Se(4),ie]}(At)}}}(o);return c?new tn(...c,!1):void 0}get rgb(){const{r:o,g:c,b:g,a:x}=this,T=x||1/0;return this.overwriteGetter("rgb",[o/T,c/T,g/T,x])}get hcl(){return this.overwriteGetter("hcl",function(o){const[c,g,x,T]=wh(o),A=Math.sqrt(g*g+x*x);return[Math.round(1e4*A)?El(Math.atan2(x,g)*ta):NaN,A,c,T]}(this.rgb))}get lab(){return this.overwriteGetter("lab",wh(this.rgb))}overwriteGetter(o,c){return Object.defineProperty(this,o,{value:c}),c}toString(){const[o,c,g,x]=this.rgb;return`rgba(${[o,c,g].map(T=>Math.round(255*T)).join(",")},${x})`}static interpolate(o,c,g,x="rgb"){switch(x){case"rgb":{const[T,A,z,B]=Gs(o.rgb,c.rgb,g);return new tn(T,A,z,B,!1)}case"hcl":{const[T,A,z,B]=o.hcl,[G,W,K,ot]=c.hcl;let ct,dt;if(isNaN(T)||isNaN(G))isNaN(T)?isNaN(G)?ct=NaN:(ct=G,z!==1&&z!==0||(dt=W)):(ct=T,K!==1&&K!==0||(dt=A));else{let Qt=G-T;G>T&&Qt>180?Qt-=360:G<T&&T-G>180&&(Qt+=360),ct=T+g*Qt}const[xt,At,jt,ue]=function([Qt,ie,Se,Ee]){return Qt=isNaN(Qt)?0:Qt*os,_a([Se,Math.cos(Qt)*ie,Math.sin(Qt)*ie,Ee])}([ct,dt??ss(A,W,g),ss(z,K,g),ss(B,ot,g)]);return new tn(xt,At,jt,ue,!1)}case"lab":{const[T,A,z,B]=_a(Gs(o.lab,c.lab,g));return new tn(T,A,z,B,!1)}}}}tn.black=new tn(0,0,0,1),tn.white=new tn(1,1,1,1),tn.transparent=new tn(0,0,0,0),tn.red=new tn(1,0,0,1);class ea{constructor(o,c,g){this.sensitivity=o?c?"variant":"case":c?"accent":"base",this.locale=g,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(o,c){return this.collator.compare(o,c)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const Mn=["bottom","center","top"];class sc{constructor(o,c,g,x,T,A){this.text=o,this.image=c,this.scale=g,this.fontStack=x,this.textColor=T,this.verticalAlign=A}}class Lo{constructor(o){this.sections=o}static fromString(o){return new Lo([new sc(o,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(o=>o.text.length!==0||o.image&&o.image.name.length!==0)}static factory(o){return o instanceof Lo?o:Lo.fromString(o)}toString(){return this.sections.length===0?"":this.sections.map(o=>o.text).join("")}}class as{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof as)return o;if(typeof o=="number")return new as([o,o,o,o]);if(Array.isArray(o)&&!(o.length<1||o.length>4)){for(const c of o)if(typeof c!="number")return;switch(o.length){case 1:o=[o[0],o[0],o[0],o[0]];break;case 2:o=[o[0],o[1],o[0],o[1]];break;case 3:o=[o[0],o[1],o[2],o[1]]}return new as(o)}}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g){return new as(Gs(o.values,c.values,g))}}class ia{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof ia)return o;if(typeof o=="number")return new ia([o]);if(Array.isArray(o)){for(const c of o)if(typeof c!="number")return;return new ia(o)}}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g){return new ia(Gs(o.values,c.values,g))}}class Ls{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof Ls)return o;if(typeof o=="string"){const g=tn.parse(o);return g?new Ls([g]):void 0}if(!Array.isArray(o))return;const c=[];for(const g of o){if(typeof g!="string")return;const x=tn.parse(g);if(!x)return;c.push(x)}return new Ls(c)}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g,x="rgb"){const T=[];if(o.values.length!=c.values.length)throw new Error(`colorArray: Arrays have mismatched length (${o.values.length} vs. ${c.values.length}), cannot interpolate.`);for(let A=0;A<o.values.length;A++)T.push(tn.interpolate(o.values[A],c.values[A],g,x));return new Ls(T)}}class On extends Error{constructor(o){super(o),this.name="RuntimeError"}toJSON(){return this.message}}const Nu=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Is{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof Is)return o;if(Array.isArray(o)&&!(o.length<1)&&o.length%2==0){for(let c=0;c<o.length;c+=2){const g=o[c],x=o[c+1];if(typeof g!="string"||!Nu.has(g)||!Array.isArray(x)||x.length!==2||typeof x[0]!="number"||typeof x[1]!="number")return}return new Is(o)}}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g){const x=o.values,T=c.values;if(x.length!==T.length)throw new On(`Cannot interpolate values of different length. from: ${o.toString()}, to: ${c.toString()}`);const A=[];for(let z=0;z<x.length;z+=2){if(x[z]!==T[z])throw new On(`Cannot interpolate values containing mismatched anchors. from[${z}]: ${x[z]}, to[${z}]: ${T[z]}`);A.push(x[z]);const[B,G]=x[z+1],[W,K]=T[z+1];A.push([ss(B,W,g),ss(G,K,g)])}return new Is(A)}}class Rs{constructor(o){this.name=o.name,this.available=o.available}toString(){return this.name}static fromString(o){return o?new Rs({name:o,available:!1}):null}}class ra{constructor(o,c,g){this.from=o,this.to=c,this.transition=g}static interpolate(o,c,g){return new ra(o,c,g)}static parse(o){return o instanceof ra?o:Array.isArray(o)&&o.length===3&&typeof o[0]=="string"&&typeof o[1]=="string"&&typeof o[2]=="number"?new ra(o[0],o[1],o[2]):typeof o=="object"&&typeof o.from=="string"&&typeof o.to=="string"&&typeof o.transition=="number"?new ra(o.from,o.to,o.transition):typeof o=="string"?new ra(o,o,1):void 0}}function Vu(h,o,c,g){return typeof h=="number"&&h>=0&&h<=255&&typeof o=="number"&&o>=0&&o<=255&&typeof c=="number"&&c>=0&&c<=255?g===void 0||typeof g=="number"&&g>=0&&g<=1?null:`Invalid rgba value [${[h,o,c,g].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof g=="number"?[h,o,c,g]:[h,o,c]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Pl(h){if(h===null||typeof h=="string"||typeof h=="boolean"||typeof h=="number"||h instanceof ra||h instanceof tn||h instanceof ea||h instanceof Lo||h instanceof as||h instanceof ia||h instanceof Ls||h instanceof Is||h instanceof Rs)return!0;if(Array.isArray(h)){for(const o of h)if(!Pl(o))return!1;return!0}if(typeof h=="object"){for(const o in h)if(!Pl(h[o]))return!1;return!0}return!1}function pr(h){if(h===null)return st;if(typeof h=="string")return Tt;if(typeof h=="boolean")return Nt;if(typeof h=="number")return tt;if(h instanceof tn)return Wt;if(h instanceof ra)return oe;if(h instanceof ea)return xe;if(h instanceof Lo)return ti;if(h instanceof as)return $e;if(h instanceof ia)return Ji;if(h instanceof Ls)return Mi;if(h instanceof Is)return qi;if(h instanceof Rs)return Xi;if(Array.isArray(h)){const o=h.length;let c;for(const g of h){const x=pr(g);if(c){if(c===x)continue;c=Jt;break}c=x}return hr(c||Jt,o)}return ye}function Sh(h){const o=typeof h;return h===null?"":o==="string"||o==="number"||o==="boolean"?String(h):h instanceof tn||h instanceof ra||h instanceof Lo||h instanceof as||h instanceof ia||h instanceof Ls||h instanceof Is||h instanceof Rs?h.toString():JSON.stringify(h)}class Zl{constructor(o,c){this.type=o,this.value=c}static parse(o,c){if(o.length!==2)return c.error(`'literal' expression requires exactly one argument, but found ${o.length-1} instead.`);if(!Pl(o[1]))return c.error("invalid value");const g=o[1];let x=pr(g);const T=c.expectedType;return x.kind!=="array"||x.N!==0||!T||T.kind!=="array"||typeof T.N=="number"&&T.N!==0||(x=T),new Zl(x,g)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const Wc={string:Tt,number:tt,boolean:Nt,object:ye};class Ca{constructor(o,c){this.type=o,this.args=c}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");let g,x=1;const T=o[0];if(T==="array"){let z,B;if(o.length>2){const G=o[1];if(typeof G!="string"||!(G in Wc)||G==="object")return c.error('The item type argument of "array" must be one of string, number, boolean',1);z=Wc[G],x++}else z=Jt;if(o.length>3){if(o[2]!==null&&(typeof o[2]!="number"||o[2]<0||o[2]!==Math.floor(o[2])))return c.error('The length argument to "array" must be a positive integer literal',2);B=o[2],x++}g=hr(z,B)}else{if(!Wc[T])throw new Error(`Types doesn't contain name = ${T}`);g=Wc[T]}const A=[];for(;x<o.length;x++){const z=c.parse(o[x],x,Jt);if(!z)return null;A.push(z)}return new Ca(g,A)}evaluate(o){for(let c=0;c<this.args.length;c++){const g=this.args[c].evaluate(o);if(!Pn(this.type,pr(g)))return g;if(c===this.args.length-1)throw new On(`Expected value to be of type ${Yi(this.type)}, but found ${Yi(pr(g))} instead.`)}throw new Error}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every(o=>o.outputDefined())}}const Eo={"to-boolean":Nt,"to-color":Wt,"to-number":tt,"to-string":Tt};class sl{constructor(o,c){this.type=o,this.args=c}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");const g=o[0];if(!Eo[g])throw new Error(`Can't parse ${g} as it is not part of the known types`);if((g==="to-boolean"||g==="to-string")&&o.length!==2)return c.error("Expected one argument.");const x=Eo[g],T=[];for(let A=1;A<o.length;A++){const z=c.parse(o[A],A,Jt);if(!z)return null;T.push(z)}return new sl(x,T)}evaluate(o){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(o);case"color":{let c,g;for(const x of this.args){if(c=x.evaluate(o),g=null,c instanceof tn)return c;if(typeof c=="string"){const T=o.parseColor(c);if(T)return T}else if(Array.isArray(c)&&(g=c.length<3||c.length>4?`Invalid rgba value ${JSON.stringify(c)}: expected an array containing either three or four numeric values.`:Vu(c[0],c[1],c[2],c[3]),!g))return new tn(c[0]/255,c[1]/255,c[2]/255,c[3])}throw new On(g||`Could not parse color from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"padding":{let c;for(const g of this.args){c=g.evaluate(o);const x=as.parse(c);if(x)return x}throw new On(`Could not parse padding from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"numberArray":{let c;for(const g of this.args){c=g.evaluate(o);const x=ia.parse(c);if(x)return x}throw new On(`Could not parse numberArray from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"colorArray":{let c;for(const g of this.args){c=g.evaluate(o);const x=Ls.parse(c);if(x)return x}throw new On(`Could not parse colorArray from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"variableAnchorOffsetCollection":{let c;for(const g of this.args){c=g.evaluate(o);const x=Is.parse(c);if(x)return x}throw new On(`Could not parse variableAnchorOffsetCollection from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"number":{let c=null;for(const g of this.args){if(c=g.evaluate(o),c===null)return 0;const x=Number(c);if(!isNaN(x))return x}throw new On(`Could not convert ${JSON.stringify(c)} to number.`)}case"formatted":return Lo.fromString(Sh(this.args[0].evaluate(o)));case"resolvedImage":return Rs.fromString(Sh(this.args[0].evaluate(o)));case"projectionDefinition":return this.args[0].evaluate(o);default:return Sh(this.args[0].evaluate(o))}}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every(o=>o.outputDefined())}}const Rn=["Unknown","Point","LineString","Polygon"];class Hr{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Rn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(o){let c=this._parseColorCache.get(o);return c||(c=tn.parse(o),this._parseColorCache.set(o,c)),c}}class au{constructor(o,c,g=[],x,T=new se,A=[]){this.registry=o,this.path=g,this.key=g.map(z=>`[${z}]`).join(""),this.scope=T,this.errors=A,this.expectedType=x,this._isConstant=c}parse(o,c,g,x,T={}){return c?this.concat(c,g,x)._parse(o,T):this._parse(o,T)}_parse(o,c){function g(x,T,A){return A==="assert"?new Ca(T,[x]):A==="coerce"?new sl(T,[x]):x}if(o!==null&&typeof o!="string"&&typeof o!="boolean"&&typeof o!="number"||(o=["literal",o]),Array.isArray(o)){if(o.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const x=o[0];if(typeof x!="string")return this.error(`Expression name must be a string, but found ${typeof x} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const T=this.registry[x];if(T){let A=T.parse(o,this);if(!A)return null;if(this.expectedType){const z=this.expectedType,B=A.type;if(z.kind!=="string"&&z.kind!=="number"&&z.kind!=="boolean"&&z.kind!=="object"&&z.kind!=="array"||B.kind!=="value"){if(z.kind==="projectionDefinition"&&["string","array"].includes(B.kind)||["color","formatted","resolvedImage"].includes(z.kind)&&["value","string"].includes(B.kind)||["padding","numberArray"].includes(z.kind)&&["value","number","array"].includes(B.kind)||z.kind==="colorArray"&&["value","string","array"].includes(B.kind)||z.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(B.kind))A=g(A,z,c.typeAnnotation||"coerce");else if(this.checkSubtype(z,B))return null}else A=g(A,z,c.typeAnnotation||"assert")}if(!(A instanceof Zl)&&A.type.kind!=="resolvedImage"&&this._isConstant(A)){const z=new Hr;try{A=new Zl(A.type,A.evaluate(z))}catch(B){return this.error(B.message),null}}return A}return this.error(`Unknown expression "${x}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(o===void 0?"'undefined' value invalid. Use null instead.":typeof o=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof o} instead.`)}concat(o,c,g){const x=typeof o=="number"?this.path.concat(o):this.path,T=g?this.scope.concat(g):this.scope;return new au(this.registry,this._isConstant,x,c||null,T,this.errors)}error(o,...c){const g=`${this.key}${c.map(x=>`[${x}]`).join("")}`;this.errors.push(new wo(g,o))}checkSubtype(o,c){const g=Pn(o,c);return g&&this.error(g),g}}class Cn{constructor(o,c){this.type=c.type,this.bindings=[].concat(o),this.result=c}evaluate(o){return this.result.evaluate(o)}eachChild(o){for(const c of this.bindings)o(c[1]);o(this.result)}static parse(o,c){if(o.length<4)return c.error(`Expected at least 3 arguments, but found ${o.length-1} instead.`);const g=[];for(let T=1;T<o.length-1;T+=2){const A=o[T];if(typeof A!="string")return c.error(`Expected string, but found ${typeof A} instead.`,T);if(/[^a-zA-Z0-9_]/.test(A))return c.error("Variable names must contain only alphanumeric characters or '_'.",T);const z=c.parse(o[T+1],T+1);if(!z)return null;g.push([A,z])}const x=c.parse(o[o.length-1],o.length-1,c.expectedType,g);return x?new Cn(g,x):null}outputDefined(){return this.result.outputDefined()}}class Uu{constructor(o,c){this.type=c.type,this.name=o,this.boundExpression=c}static parse(o,c){if(o.length!==2||typeof o[1]!="string")return c.error("'var' expression requires exactly one string literal argument.");const g=o[1];return c.scope.has(g)?new Uu(g,c.scope.get(g)):c.error(`Unknown variable "${g}". Make sure "${g}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(o){return this.boundExpression.evaluate(o)}eachChild(){}outputDefined(){return!1}}class qa{constructor(o,c,g){this.type=o,this.index=c,this.input=g}static parse(o,c){if(o.length!==3)return c.error(`Expected 2 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,tt),x=c.parse(o[2],2,hr(c.expectedType||Jt));return g&&x?new qa(x.type.itemType,g,x):null}evaluate(o){const c=this.index.evaluate(o),g=this.input.evaluate(o);if(c<0)throw new On(`Array index out of bounds: ${c} < 0.`);if(c>=g.length)throw new On(`Array index out of bounds: ${c} > ${g.length-1}.`);if(c!==Math.floor(c))throw new On(`Array index must be an integer, but found ${c} instead.`);return g[c]}eachChild(o){o(this.index),o(this.input)}outputDefined(){return!1}}class ya{constructor(o,c){this.type=Nt,this.needle=o,this.haystack=c}static parse(o,c){if(o.length!==3)return c.error(`Expected 2 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,Jt),x=c.parse(o[2],2,Jt);return g&&x?zo(g.type,[Nt,Tt,tt,st,Jt])?new ya(g,x):c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Yi(g.type)} instead`):null}evaluate(o){const c=this.needle.evaluate(o),g=this.haystack.evaluate(o);if(!g)return!1;if(!Gr(c,["boolean","string","number","null"]))throw new On(`Expected first argument to be of type boolean, string, number or null, but found ${Yi(pr(c))} instead.`);if(!Gr(g,["string","array"]))throw new On(`Expected second argument to be of type array or string, but found ${Yi(pr(g))} instead.`);return g.indexOf(c)>=0}eachChild(o){o(this.needle),o(this.haystack)}outputDefined(){return!0}}class ac{constructor(o,c,g){this.type=tt,this.needle=o,this.haystack=c,this.fromIndex=g}static parse(o,c){if(o.length<=2||o.length>=5)return c.error(`Expected 2 or 3 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,Jt),x=c.parse(o[2],2,Jt);if(!g||!x)return null;if(!zo(g.type,[Nt,Tt,tt,st,Jt]))return c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Yi(g.type)} instead`);if(o.length===4){const T=c.parse(o[3],3,tt);return T?new ac(g,x,T):null}return new ac(g,x)}evaluate(o){const c=this.needle.evaluate(o),g=this.haystack.evaluate(o);if(!Gr(c,["boolean","string","number","null"]))throw new On(`Expected first argument to be of type boolean, string, number or null, but found ${Yi(pr(c))} instead.`);let x;if(this.fromIndex&&(x=this.fromIndex.evaluate(o)),Gr(g,["string"])){const T=g.indexOf(c,x);return T===-1?-1:[...g.slice(0,T)].length}if(Gr(g,["array"]))return g.indexOf(c,x);throw new On(`Expected second argument to be of type array or string, but found ${Yi(pr(g))} instead.`)}eachChild(o){o(this.needle),o(this.haystack),this.fromIndex&&o(this.fromIndex)}outputDefined(){return!1}}class Xc{constructor(o,c,g,x,T,A){this.inputType=o,this.type=c,this.input=g,this.cases=x,this.outputs=T,this.otherwise=A}static parse(o,c){if(o.length<5)return c.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if(o.length%2!=1)return c.error("Expected an even number of arguments.");let g,x;c.expectedType&&c.expectedType.kind!=="value"&&(x=c.expectedType);const T={},A=[];for(let G=2;G<o.length-1;G+=2){let W=o[G];const K=o[G+1];Array.isArray(W)||(W=[W]);const ot=c.concat(G);if(W.length===0)return ot.error("Expected at least one branch label.");for(const dt of W){if(typeof dt!="number"&&typeof dt!="string")return ot.error("Branch labels must be numbers or strings.");if(typeof dt=="number"&&Math.abs(dt)>Number.MAX_SAFE_INTEGER)return ot.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof dt=="number"&&Math.floor(dt)!==dt)return ot.error("Numeric branch labels must be integer values.");if(g){if(ot.checkSubtype(g,pr(dt)))return null}else g=pr(dt);if(T[String(dt)]!==void 0)return ot.error("Branch labels must be unique.");T[String(dt)]=A.length}const ct=c.parse(K,G,x);if(!ct)return null;x=x||ct.type,A.push(ct)}const z=c.parse(o[1],1,Jt);if(!z)return null;const B=c.parse(o[o.length-1],o.length-1,x);return B?z.type.kind!=="value"&&c.concat(1).checkSubtype(g,z.type)?null:new Xc(g,x,z,T,A,B):null}evaluate(o){const c=this.input.evaluate(o);return(pr(c)===this.inputType&&this.outputs[this.cases[c]]||this.otherwise).evaluate(o)}eachChild(o){o(this.input),this.outputs.forEach(o),o(this.otherwise)}outputDefined(){return this.outputs.every(o=>o.outputDefined())&&this.otherwise.outputDefined()}}class Yc{constructor(o,c,g){this.type=o,this.branches=c,this.otherwise=g}static parse(o,c){if(o.length<4)return c.error(`Expected at least 3 arguments, but found only ${o.length-1}.`);if(o.length%2!=0)return c.error("Expected an odd number of arguments.");let g;c.expectedType&&c.expectedType.kind!=="value"&&(g=c.expectedType);const x=[];for(let A=1;A<o.length-1;A+=2){const z=c.parse(o[A],A,Nt);if(!z)return null;const B=c.parse(o[A+1],A+1,g);if(!B)return null;x.push([z,B]),g=g||B.type}const T=c.parse(o[o.length-1],o.length-1,g);if(!T)return null;if(!g)throw new Error("Can't infer output type");return new Yc(g,x,T)}evaluate(o){for(const[c,g]of this.branches)if(c.evaluate(o))return g.evaluate(o);return this.otherwise.evaluate(o)}eachChild(o){for(const[c,g]of this.branches)o(c),o(g);o(this.otherwise)}outputDefined(){return this.branches.every(([o,c])=>c.outputDefined())&&this.otherwise.outputDefined()}}class Ml{constructor(o,c,g,x){this.type=o,this.input=c,this.beginIndex=g,this.endIndex=x}static parse(o,c){if(o.length<=2||o.length>=5)return c.error(`Expected 2 or 3 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,Jt),x=c.parse(o[2],2,tt);if(!g||!x)return null;if(!zo(g.type,[hr(Jt),Tt,Jt]))return c.error(`Expected first argument to be of type array or string, but found ${Yi(g.type)} instead`);if(o.length===4){const T=c.parse(o[3],3,tt);return T?new Ml(g.type,g,x,T):null}return new Ml(g.type,g,x)}evaluate(o){const c=this.input.evaluate(o),g=this.beginIndex.evaluate(o);let x;if(this.endIndex&&(x=this.endIndex.evaluate(o)),Gr(c,["string"]))return[...c].slice(g,x).join("");if(Gr(c,["array"]))return c.slice(g,x);throw new On(`Expected first argument to be of type array or string, but found ${Yi(pr(c))} instead.`)}eachChild(o){o(this.input),o(this.beginIndex),this.endIndex&&o(this.endIndex)}outputDefined(){return!1}}function Zo(h,o){const c=h.length-1;let g,x,T=0,A=c,z=0;for(;T<=A;)if(z=Math.floor((T+A)/2),g=h[z],x=h[z+1],g<=o){if(z===c||o<x)return z;T=z+1}else{if(!(g>o))throw new On("Input is not a number.");A=z-1}return 0}class Ih{constructor(o,c,g){this.type=o,this.input=c,this.labels=[],this.outputs=[];for(const[x,T]of g)this.labels.push(x),this.outputs.push(T)}static parse(o,c){if(o.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if((o.length-1)%2!=0)return c.error("Expected an even number of arguments.");const g=c.parse(o[1],1,tt);if(!g)return null;const x=[];let T=null;c.expectedType&&c.expectedType.kind!=="value"&&(T=c.expectedType);for(let A=1;A<o.length;A+=2){const z=A===1?-1/0:o[A],B=o[A+1],G=A,W=A+1;if(typeof z!="number")return c.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',G);if(x.length&&x[x.length-1][0]>=z)return c.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',G);const K=c.parse(B,W,T);if(!K)return null;T=T||K.type,x.push([z,K])}return new Ih(T,g,x)}evaluate(o){const c=this.labels,g=this.outputs;if(c.length===1)return g[0].evaluate(o);const x=this.input.evaluate(o);if(x<=c[0])return g[0].evaluate(o);const T=c.length;return x>=c[T-1]?g[T-1].evaluate(o):g[Zo(c,x)].evaluate(o)}eachChild(o){o(this.input);for(const c of this.outputs)o(c)}outputDefined(){return this.outputs.every(o=>o.outputDefined())}}function up(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var Hl,Dr,ju=function(){if(Dr)return Hl;function h(o,c,g,x){this.cx=3*o,this.bx=3*(g-o)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*c,this.by=3*(x-c)-this.cy,this.ay=1-this.cy-this.by,this.p1x=o,this.p1y=c,this.p2x=g,this.p2y=x}return Dr=1,Hl=h,h.prototype={sampleCurveX:function(o){return((this.ax*o+this.bx)*o+this.cx)*o},sampleCurveY:function(o){return((this.ay*o+this.by)*o+this.cy)*o},sampleCurveDerivativeX:function(o){return(3*this.ax*o+2*this.bx)*o+this.cx},solveCurveX:function(o,c){if(c===void 0&&(c=1e-6),o<0)return 0;if(o>1)return 1;for(var g=o,x=0;x<8;x++){var T=this.sampleCurveX(g)-o;if(Math.abs(T)<c)return g;var A=this.sampleCurveDerivativeX(g);if(Math.abs(A)<1e-6)break;g-=T/A}var z=0,B=1;for(g=o,x=0;x<20&&(T=this.sampleCurveX(g),!(Math.abs(T-o)<c));x++)o>T?z=g:B=g,g=.5*(B-z)+z;return g},solve:function(o,c){return this.sampleCurveY(this.solveCurveX(o,c))}},Hl}(),af=up(ju);class na{constructor(o,c,g,x,T){this.type=o,this.operator=c,this.interpolation=g,this.input=x,this.labels=[],this.outputs=[];for(const[A,z]of T)this.labels.push(A),this.outputs.push(z)}static interpolationFactor(o,c,g,x){let T=0;if(o.name==="exponential")T=Vi(c,o.base,g,x);else if(o.name==="linear")T=Vi(c,1,g,x);else if(o.name==="cubic-bezier"){const A=o.controlPoints;T=new af(A[0],A[1],A[2],A[3]).solve(Vi(c,1,g,x))}return T}static parse(o,c){let[g,x,T,...A]=o;if(!Array.isArray(x)||x.length===0)return c.error("Expected an interpolation type expression.",1);if(x[0]==="linear")x={name:"linear"};else if(x[0]==="exponential"){const G=x[1];if(typeof G!="number")return c.error("Exponential interpolation requires a numeric base.",1,1);x={name:"exponential",base:G}}else{if(x[0]!=="cubic-bezier")return c.error(`Unknown interpolation type ${String(x[0])}`,1,0);{const G=x.slice(1);if(G.length!==4||G.some(W=>typeof W!="number"||W<0||W>1))return c.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);x={name:"cubic-bezier",controlPoints:G}}}if(o.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if((o.length-1)%2!=0)return c.error("Expected an even number of arguments.");if(T=c.parse(T,2,tt),!T)return null;const z=[];let B=null;g!=="interpolate-hcl"&&g!=="interpolate-lab"||c.expectedType==Mi?c.expectedType&&c.expectedType.kind!=="value"&&(B=c.expectedType):B=Wt;for(let G=0;G<A.length;G+=2){const W=A[G],K=A[G+1],ot=G+3,ct=G+4;if(typeof W!="number")return c.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',ot);if(z.length&&z[z.length-1][0]>=W)return c.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',ot);const dt=c.parse(K,ct,B);if(!dt)return null;B=B||dt.type,z.push([W,dt])}return Wn(B,tt)||Wn(B,oe)||Wn(B,Wt)||Wn(B,$e)||Wn(B,Ji)||Wn(B,Mi)||Wn(B,qi)||Wn(B,hr(tt))?new na(B,g,x,T,z):c.error(`Type ${Yi(B)} is not interpolatable.`)}evaluate(o){const c=this.labels,g=this.outputs;if(c.length===1)return g[0].evaluate(o);const x=this.input.evaluate(o);if(x<=c[0])return g[0].evaluate(o);const T=c.length;if(x>=c[T-1])return g[T-1].evaluate(o);const A=Zo(c,x),z=na.interpolationFactor(this.interpolation,x,c[A],c[A+1]),B=g[A].evaluate(o),G=g[A+1].evaluate(o);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return ss(B,G,z);case"color":return tn.interpolate(B,G,z);case"padding":return as.interpolate(B,G,z);case"colorArray":return Ls.interpolate(B,G,z);case"numberArray":return ia.interpolate(B,G,z);case"variableAnchorOffsetCollection":return Is.interpolate(B,G,z);case"array":return Gs(B,G,z);case"projectionDefinition":return ra.interpolate(B,G,z)}case"interpolate-hcl":switch(this.type.kind){case"color":return tn.interpolate(B,G,z,"hcl");case"colorArray":return Ls.interpolate(B,G,z,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return tn.interpolate(B,G,z,"lab");case"colorArray":return Ls.interpolate(B,G,z,"lab")}}}eachChild(o){o(this.input);for(const c of this.outputs)o(c)}outputDefined(){return this.outputs.every(o=>o.outputDefined())}}function Vi(h,o,c,g){const x=g-c,T=h-c;return x===0?0:o===1?T/x:(Math.pow(o,T)-1)/(Math.pow(o,x)-1)}const Za={color:tn.interpolate,number:ss,padding:as.interpolate,numberArray:ia.interpolate,colorArray:Ls.interpolate,variableAnchorOffsetCollection:Is.interpolate,array:Gs};class al{constructor(o,c){this.type=o,this.args=c}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");let g=null;const x=c.expectedType;x&&x.kind!=="value"&&(g=x);const T=[];for(const z of o.slice(1)){const B=c.parse(z,1+T.length,g,void 0,{typeAnnotation:"omit"});if(!B)return null;g=g||B.type,T.push(B)}if(!g)throw new Error("No output type");const A=x&&T.some(z=>Pn(x,z.type));return new al(A?Jt:g,T)}evaluate(o){let c,g=null,x=0;for(const T of this.args)if(x++,g=T.evaluate(o),g&&g instanceof Rs&&!g.available&&(c||(c=g.name),g=null,x===this.args.length&&(g=c)),g!==null)break;return g}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every(o=>o.outputDefined())}}function ll(h,o){return h==="=="||h==="!="?o.kind==="boolean"||o.kind==="string"||o.kind==="number"||o.kind==="null"||o.kind==="value":o.kind==="string"||o.kind==="number"||o.kind==="value"}function Cl(h,o,c,g){return g.compare(o,c)===0}function Da(h,o,c){const g=h!=="=="&&h!=="!=";return class Sb{constructor(T,A,z){this.type=Nt,this.lhs=T,this.rhs=A,this.collator=z,this.hasUntypedArgument=T.type.kind==="value"||A.type.kind==="value"}static parse(T,A){if(T.length!==3&&T.length!==4)return A.error("Expected two or three arguments.");const z=T[0];let B=A.parse(T[1],1,Jt);if(!B)return null;if(!ll(z,B.type))return A.concat(1).error(`"${z}" comparisons are not supported for type '${Yi(B.type)}'.`);let G=A.parse(T[2],2,Jt);if(!G)return null;if(!ll(z,G.type))return A.concat(2).error(`"${z}" comparisons are not supported for type '${Yi(G.type)}'.`);if(B.type.kind!==G.type.kind&&B.type.kind!=="value"&&G.type.kind!=="value")return A.error(`Cannot compare types '${Yi(B.type)}' and '${Yi(G.type)}'.`);g&&(B.type.kind==="value"&&G.type.kind!=="value"?B=new Ca(G.type,[B]):B.type.kind!=="value"&&G.type.kind==="value"&&(G=new Ca(B.type,[G])));let W=null;if(T.length===4){if(B.type.kind!=="string"&&G.type.kind!=="string"&&B.type.kind!=="value"&&G.type.kind!=="value")return A.error("Cannot use collator to compare non-string types.");if(W=A.parse(T[3],3,xe),!W)return null}return new Sb(B,G,W)}evaluate(T){const A=this.lhs.evaluate(T),z=this.rhs.evaluate(T);if(g&&this.hasUntypedArgument){const B=pr(A),G=pr(z);if(B.kind!==G.kind||B.kind!=="string"&&B.kind!=="number")throw new On(`Expected arguments for "${h}" to be (string, string) or (number, number), but found (${B.kind}, ${G.kind}) instead.`)}if(this.collator&&!g&&this.hasUntypedArgument){const B=pr(A),G=pr(z);if(B.kind!=="string"||G.kind!=="string")return o(T,A,z)}return this.collator?c(T,A,z,this.collator.evaluate(T)):o(T,A,z)}eachChild(T){T(this.lhs),T(this.rhs),this.collator&&T(this.collator)}outputDefined(){return!0}}}const Oi=Da("==",function(h,o,c){return o===c},Cl),Ur=Da("!=",function(h,o,c){return o!==c},function(h,o,c,g){return!Cl(0,o,c,g)}),sn=Da("<",function(h,o,c){return o<c},function(h,o,c,g){return g.compare(o,c)<0}),Ha=Da(">",function(h,o,c){return o>c},function(h,o,c,g){return g.compare(o,c)>0}),Jc=Da("<=",function(h,o,c){return o<=c},function(h,o,c,g){return g.compare(o,c)<=0}),en=Da(">=",function(h,o,c){return o>=c},function(h,o,c,g){return g.compare(o,c)>=0});class oa{constructor(o,c,g){this.type=xe,this.locale=g,this.caseSensitive=o,this.diacriticSensitive=c}static parse(o,c){if(o.length!==2)return c.error("Expected one argument.");const g=o[1];if(typeof g!="object"||Array.isArray(g))return c.error("Collator options argument must be an object.");const x=c.parse(g["case-sensitive"]!==void 0&&g["case-sensitive"],1,Nt);if(!x)return null;const T=c.parse(g["diacritic-sensitive"]!==void 0&&g["diacritic-sensitive"],1,Nt);if(!T)return null;let A=null;return g.locale&&(A=c.parse(g.locale,1,Tt),!A)?null:new oa(x,T,A)}evaluate(o){return new ea(this.caseSensitive.evaluate(o),this.diacriticSensitive.evaluate(o),this.locale?this.locale.evaluate(o):null)}eachChild(o){o(this.caseSensitive),o(this.diacriticSensitive),this.locale&&o(this.locale)}outputDefined(){return!1}}class Ac{constructor(o,c,g,x,T){this.type=Tt,this.number=o,this.locale=c,this.currency=g,this.minFractionDigits=x,this.maxFractionDigits=T}static parse(o,c){if(o.length!==3)return c.error("Expected two arguments.");const g=c.parse(o[1],1,tt);if(!g)return null;const x=o[2];if(typeof x!="object"||Array.isArray(x))return c.error("NumberFormat options argument must be an object.");let T=null;if(x.locale&&(T=c.parse(x.locale,1,Tt),!T))return null;let A=null;if(x.currency&&(A=c.parse(x.currency,1,Tt),!A))return null;let z=null;if(x["min-fraction-digits"]&&(z=c.parse(x["min-fraction-digits"],1,tt),!z))return null;let B=null;return x["max-fraction-digits"]&&(B=c.parse(x["max-fraction-digits"],1,tt),!B)?null:new Ac(g,T,A,z,B)}evaluate(o){return new Intl.NumberFormat(this.locale?this.locale.evaluate(o):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(o):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(o):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(o):void 0}).format(this.number.evaluate(o))}eachChild(o){o(this.number),this.locale&&o(this.locale),this.currency&&o(this.currency),this.minFractionDigits&&o(this.minFractionDigits),this.maxFractionDigits&&o(this.maxFractionDigits)}outputDefined(){return!1}}class lc{constructor(o){this.type=ti,this.sections=o}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");const g=o[1];if(!Array.isArray(g)&&typeof g=="object")return c.error("First argument must be an image or text section.");const x=[];let T=!1;for(let A=1;A<=o.length-1;++A){const z=o[A];if(T&&typeof z=="object"&&!Array.isArray(z)){T=!1;let B=null;if(z["font-scale"]&&(B=c.parse(z["font-scale"],1,tt),!B))return null;let G=null;if(z["text-font"]&&(G=c.parse(z["text-font"],1,hr(Tt)),!G))return null;let W=null;if(z["text-color"]&&(W=c.parse(z["text-color"],1,Wt),!W))return null;let K=null;if(z["vertical-align"]){if(typeof z["vertical-align"]=="string"&&!Mn.includes(z["vertical-align"]))return c.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${z["vertical-align"]}' instead.`);if(K=c.parse(z["vertical-align"],1,Tt),!K)return null}const ot=x[x.length-1];ot.scale=B,ot.font=G,ot.textColor=W,ot.verticalAlign=K}else{const B=c.parse(o[A],1,Jt);if(!B)return null;const G=B.type.kind;if(G!=="string"&&G!=="value"&&G!=="null"&&G!=="resolvedImage")return c.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");T=!0,x.push({content:B,scale:null,font:null,textColor:null,verticalAlign:null})}}return new lc(x)}evaluate(o){return new Lo(this.sections.map(c=>{const g=c.content.evaluate(o);return pr(g)===Xi?new sc("",g,null,null,null,c.verticalAlign?c.verticalAlign.evaluate(o):null):new sc(Sh(g),null,c.scale?c.scale.evaluate(o):null,c.font?c.font.evaluate(o).join(","):null,c.textColor?c.textColor.evaluate(o):null,c.verticalAlign?c.verticalAlign.evaluate(o):null)}))}eachChild(o){for(const c of this.sections)o(c.content),c.scale&&o(c.scale),c.font&&o(c.font),c.textColor&&o(c.textColor),c.verticalAlign&&o(c.verticalAlign)}outputDefined(){return!1}}class ps{constructor(o){this.type=Xi,this.input=o}static parse(o,c){if(o.length!==2)return c.error("Expected two arguments.");const g=c.parse(o[1],1,Tt);return g?new ps(g):c.error("No image name provided.")}evaluate(o){const c=this.input.evaluate(o),g=Rs.fromString(c);return g&&o.availableImages&&(g.available=o.availableImages.indexOf(c)>-1),g}eachChild(o){o(this.input)}outputDefined(){return!1}}class Oo{constructor(o){this.type=tt,this.input=o}static parse(o,c){if(o.length!==2)return c.error(`Expected 1 argument, but found ${o.length-1} instead.`);const g=c.parse(o[1],1);return g?g.type.kind!=="array"&&g.type.kind!=="string"&&g.type.kind!=="value"?c.error(`Expected argument of type string or array, but found ${Yi(g.type)} instead.`):new Oo(g):null}evaluate(o){const c=this.input.evaluate(o);if(typeof c=="string")return[...c].length;if(Array.isArray(c))return c.length;throw new On(`Expected value to be of type string or array, but found ${Yi(pr(c))} instead.`)}eachChild(o){o(this.input)}outputDefined(){return!1}}const Pc=8192;function Ed(h,o){const c=(180+h[0])/360,g=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h[1]*Math.PI/360)))/360,x=Math.pow(2,o.z);return[Math.round(c*x*Pc),Math.round(g*x*Pc)]}function Ad(h,o){const c=Math.pow(2,o.z);return[(x=(h[0]/Pc+o.x)/c,360*x-180),(g=(h[1]/Pc+o.y)/c,360/Math.PI*Math.atan(Math.exp((180-360*g)*Math.PI/180))-90)];var g,x}function Kc(h,o){h[0]=Math.min(h[0],o[0]),h[1]=Math.min(h[1],o[1]),h[2]=Math.max(h[2],o[0]),h[3]=Math.max(h[3],o[1])}function cc(h,o){return!(h[0]<=o[0]||h[2]>=o[2]||h[1]<=o[1]||h[3]>=o[3])}function lf(h,o,c){const g=h[0]-o[0],x=h[1]-o[1],T=h[0]-c[0],A=h[1]-c[1];return g*A-T*x==0&&g*T<=0&&x*A<=0}function Qc(h,o,c,g){return(x=[g[0]-c[0],g[1]-c[1]])[0]*(T=[o[0]-h[0],o[1]-h[1]])[1]-x[1]*T[0]!=0&&!(!ls(h,o,c,g)||!ls(c,g,h,o));var x,T}function fs(h,o,c){for(const g of c)for(let x=0;x<g.length-1;++x)if(Qc(h,o,g[x],g[x+1]))return!0;return!1}function cl(h,o,c=!1){let g=!1;for(const z of o)for(let B=0;B<z.length-1;B++){if(lf(h,z[B],z[B+1]))return c;(T=z[B])[1]>(x=h)[1]!=(A=z[B+1])[1]>x[1]&&x[0]<(A[0]-T[0])*(x[1]-T[1])/(A[1]-T[1])+T[0]&&(g=!g)}var x,T,A;return g}function za(h,o){for(const c of o)if(cl(h,c))return!0;return!1}function Pd(h,o){for(const c of h)if(!cl(c,o))return!1;for(let c=0;c<h.length-1;++c)if(fs(h[c],h[c+1],o))return!1;return!0}function Gu(h,o){for(const c of o)if(Pd(h,c))return!0;return!1}function ls(h,o,c,g){const x=g[0]-c[0],T=g[1]-c[1],A=(h[0]-c[0])*T-x*(h[1]-c[1]),z=(o[0]-c[0])*T-x*(o[1]-c[1]);return A>0&&z<0||A<0&&z>0}function Wl(h,o,c){const g=[];for(let x=0;x<h.length;x++){const T=[];for(let A=0;A<h[x].length;A++){const z=Ed(h[x][A],c);Kc(o,z),T.push(z)}g.push(T)}return g}function Mc(h,o,c){const g=[];for(let x=0;x<h.length;x++){const T=Wl(h[x],o,c);g.push(T)}return g}function Ao(h,o,c,g){if(h[0]<c[0]||h[0]>c[2]){const x=.5*g;let T=h[0]-c[0]>x?-g:c[0]-h[0]>x?g:0;T===0&&(T=h[0]-c[2]>x?-g:c[2]-h[0]>x?g:0),h[0]+=T}Kc(o,h)}function yr(h,o,c,g){const x=Math.pow(2,g.z)*Pc,T=[g.x*Pc,g.y*Pc],A=[];for(const z of h)for(const B of z){const G=[B.x+T[0],B.y+T[1]];Ao(G,o,c,x),A.push(G)}return A}function zi(h,o,c,g){const x=Math.pow(2,g.z)*Pc,T=[g.x*Pc,g.y*Pc],A=[];for(const B of h){const G=[];for(const W of B){const K=[W.x+T[0],W.y+T[1]];Kc(o,K),G.push(K)}A.push(G)}if(o[2]-o[0]<=x/2){(z=o)[0]=z[1]=1/0,z[2]=z[3]=-1/0;for(const B of A)for(const G of B)Ao(G,o,c,x)}var z;return A}class Dl{constructor(o,c){this.type=Nt,this.geojson=o,this.geometries=c}static parse(o,c){if(o.length!==2)return c.error(`'within' expression requires exactly one argument, but found ${o.length-1} instead.`);if(Pl(o[1])){const g=o[1];if(g.type==="FeatureCollection"){const x=[];for(const T of g.features){const{type:A,coordinates:z}=T.geometry;A==="Polygon"&&x.push(z),A==="MultiPolygon"&&x.push(...z)}if(x.length)return new Dl(g,{type:"MultiPolygon",coordinates:x})}else if(g.type==="Feature"){const x=g.geometry.type;if(x==="Polygon"||x==="MultiPolygon")return new Dl(g,g.geometry)}else if(g.type==="Polygon"||g.type==="MultiPolygon")return new Dl(g,g)}return c.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(o){if(o.geometry()!=null&&o.canonicalID()!=null){if(o.geometryType()==="Point")return function(c,g){const x=[1/0,1/0,-1/0,-1/0],T=[1/0,1/0,-1/0,-1/0],A=c.canonicalID();if(g.type==="Polygon"){const z=Wl(g.coordinates,T,A),B=yr(c.geometry(),x,T,A);if(!cc(x,T))return!1;for(const G of B)if(!cl(G,z))return!1}if(g.type==="MultiPolygon"){const z=Mc(g.coordinates,T,A),B=yr(c.geometry(),x,T,A);if(!cc(x,T))return!1;for(const G of B)if(!za(G,z))return!1}return!0}(o,this.geometries);if(o.geometryType()==="LineString")return function(c,g){const x=[1/0,1/0,-1/0,-1/0],T=[1/0,1/0,-1/0,-1/0],A=c.canonicalID();if(g.type==="Polygon"){const z=Wl(g.coordinates,T,A),B=zi(c.geometry(),x,T,A);if(!cc(x,T))return!1;for(const G of B)if(!Pd(G,z))return!1}if(g.type==="MultiPolygon"){const z=Mc(g.coordinates,T,A),B=zi(c.geometry(),x,T,A);if(!cc(x,T))return!1;for(const G of B)if(!Gu(G,z))return!1}return!0}(o,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let sr=class{constructor(h=[],o=(c,g)=>c<g?-1:c>g?1:0){if(this.data=h,this.length=this.data.length,this.compare=o,this.length>0)for(let c=(this.length>>1)-1;c>=0;c--)this._down(c)}push(h){this.data.push(h),this._up(this.length++)}pop(){if(this.length===0)return;const h=this.data[0],o=this.data.pop();return--this.length>0&&(this.data[0]=o,this._down(0)),h}peek(){return this.data[0]}_up(h){const{data:o,compare:c}=this,g=o[h];for(;h>0;){const x=h-1>>1,T=o[x];if(c(g,T)>=0)break;o[h]=T,h=x}o[h]=g}_down(h){const{data:o,compare:c}=this,g=this.length>>1,x=o[h];for(;h<g;){let T=1+(h<<1);const A=T+1;if(A<this.length&&c(o[A],o[T])<0&&(T=A),c(o[T],x)>=0)break;o[h]=o[T],h=T}o[h]=x}};function lu(h,o,c=0,g=h.length-1,x=Qi){for(;g>c;){if(g-c>600){const B=g-c+1,G=o-c+1,W=Math.log(B),K=.5*Math.exp(2*W/3),ot=.5*Math.sqrt(W*K*(B-K)/B)*(G-B/2<0?-1:1);lu(h,o,Math.max(c,Math.floor(o-G*K/B+ot)),Math.min(g,Math.floor(o+(B-G)*K/B+ot)),x)}const T=h[o];let A=c,z=g;for(Eh(h,c,o),x(h[g],T)>0&&Eh(h,c,g);A<z;){for(Eh(h,A,z),A++,z--;x(h[A],T)<0;)A++;for(;x(h[z],T)>0;)z--}x(h[c],T)===0?Eh(h,c,z):(z++,Eh(h,z,g)),z<=o&&(c=z+1),o<=z&&(g=z-1)}}function Eh(h,o,c){const g=h[o];h[o]=h[c],h[c]=g}function Qi(h,o){return h<o?-1:h>o?1:0}function th(h,o){if(h.length<=1)return[h];const c=[];let g,x;for(const T of h){const A=Nf(T);A!==0&&(T.area=Math.abs(A),x===void 0&&(x=A<0),x===A<0?(g&&c.push(g),g=[T]):g.push(T))}if(g&&c.push(g),o>1)for(let T=0;T<c.length;T++)c[T].length<=o||(lu(c[T],o,1,c[T].length-1,dp),c[T]=c[T].slice(0,o));return c}function dp(h,o){return o.area-h.area}function Nf(h){let o=0;for(let c,g,x=0,T=h.length,A=T-1;x<T;A=x++)c=h[x],g=h[A],o+=(g.x-c.x)*(c.y+g.y);return o}const hc=1/298.257223563,cu=hc*(2-hc),ms=Math.PI/180;class $s{constructor(o){const c=6378.137*ms*1e3,g=Math.cos(o*ms),x=1/(1-cu*(1-g*g)),T=Math.sqrt(x);this.kx=c*T*g,this.ky=c*T*x*(1-cu)}distance(o,c){const g=this.wrap(o[0]-c[0])*this.kx,x=(o[1]-c[1])*this.ky;return Math.sqrt(g*g+x*x)}pointOnLine(o,c){let g,x,T,A,z=1/0;for(let B=0;B<o.length-1;B++){let G=o[B][0],W=o[B][1],K=this.wrap(o[B+1][0]-G)*this.kx,ot=(o[B+1][1]-W)*this.ky,ct=0;K===0&&ot===0||(ct=(this.wrap(c[0]-G)*this.kx*K+(c[1]-W)*this.ky*ot)/(K*K+ot*ot),ct>1?(G=o[B+1][0],W=o[B+1][1]):ct>0&&(G+=K/this.kx*ct,W+=ot/this.ky*ct)),K=this.wrap(c[0]-G)*this.kx,ot=(c[1]-W)*this.ky;const dt=K*K+ot*ot;dt<z&&(z=dt,g=G,x=W,T=B,A=ct)}return{point:[g,x],index:T,t:Math.max(0,Math.min(1,A))}}wrap(o){for(;o<-180;)o+=360;for(;o>180;)o-=360;return o}}function Ah(h,o){return o[0]-h[0]}function Cc(h){return h[1]-h[0]+1}function sa(h,o){return h[1]>=h[0]&&h[1]<o}function gs(h,o){if(h[0]>h[1])return[null,null];const c=Cc(h);if(o){if(c===2)return[h,null];const x=Math.floor(c/2);return[[h[0],h[0]+x],[h[0]+x,h[1]]]}if(c===1)return[h,null];const g=Math.floor(c/2)-1;return[[h[0],h[0]+g],[h[0]+g+1,h[1]]]}function cf(h,o){if(!sa(o,h.length))return[1/0,1/0,-1/0,-1/0];const c=[1/0,1/0,-1/0,-1/0];for(let g=o[0];g<=o[1];++g)Kc(c,h[g]);return c}function hf(h){const o=[1/0,1/0,-1/0,-1/0];for(const c of h)for(const g of c)Kc(o,g);return o}function hu(h){return h[0]!==-1/0&&h[1]!==-1/0&&h[2]!==1/0&&h[3]!==1/0}function Dc(h,o,c){if(!hu(h)||!hu(o))return NaN;let g=0,x=0;return h[2]<o[0]&&(g=o[0]-h[2]),h[0]>o[2]&&(g=h[0]-o[2]),h[1]>o[3]&&(x=h[1]-o[3]),h[3]<o[1]&&(x=o[1]-h[3]),c.distance([0,0],[g,x])}function Ph(h,o,c){const g=c.pointOnLine(o,h);return c.distance(h,g.point)}function hl(h,o,c,g,x){const T=Math.min(Ph(h,[c,g],x),Ph(o,[c,g],x)),A=Math.min(Ph(c,[h,o],x),Ph(g,[h,o],x));return Math.min(T,A)}function Vf(h,o,c,g,x){if(!sa(o,h.length)||!sa(g,c.length))return 1/0;let T=1/0;for(let A=o[0];A<o[1];++A){const z=h[A],B=h[A+1];for(let G=g[0];G<g[1];++G){const W=c[G],K=c[G+1];if(Qc(z,B,W,K))return 0;T=Math.min(T,hl(z,B,W,K,x))}}return T}function Qn(h,o,c,g,x){if(!sa(o,h.length)||!sa(g,c.length))return NaN;let T=1/0;for(let A=o[0];A<=o[1];++A)for(let z=g[0];z<=g[1];++z)if(T=Math.min(T,x.distance(h[A],c[z])),T===0)return T;return T}function Md(h,o,c){if(cl(h,o,!0))return 0;let g=1/0;for(const x of o){const T=x[0],A=x[x.length-1];if(T!==A&&(g=Math.min(g,Ph(h,[A,T],c)),g===0))return g;const z=c.pointOnLine(x,h);if(g=Math.min(g,c.distance(h,z.point)),g===0)return g}return g}function Mh(h,o,c,g){if(!sa(o,h.length))return NaN;for(let T=o[0];T<=o[1];++T)if(cl(h[T],c,!0))return 0;let x=1/0;for(let T=o[0];T<o[1];++T){const A=h[T],z=h[T+1];for(const B of c)for(let G=0,W=B.length,K=W-1;G<W;K=G++){const ot=B[K],ct=B[G];if(Qc(A,z,ot,ct))return 0;x=Math.min(x,hl(A,z,ot,ct,g))}}return x}function Uf(h,o){for(const c of h)for(const g of c)if(cl(g,o,!0))return!0;return!1}function jf(h,o,c,g=1/0){const x=hf(h),T=hf(o);if(g!==1/0&&Dc(x,T,c)>=g)return g;if(cc(x,T)){if(Uf(h,o))return 0}else if(Uf(o,h))return 0;let A=1/0;for(const z of h)for(let B=0,G=z.length,W=G-1;B<G;W=B++){const K=z[W],ot=z[B];for(const ct of o)for(let dt=0,xt=ct.length,At=xt-1;dt<xt;At=dt++){const jt=ct[At],ue=ct[dt];if(Qc(K,ot,jt,ue))return 0;A=Math.min(A,hl(K,ot,jt,ue,c))}}return A}function Gf(h,o,c,g,x,T){if(!T)return;const A=Dc(cf(g,T),x,c);A<o&&h.push([A,T,[0,0]])}function uc(h,o,c,g,x,T,A){if(!T||!A)return;const z=Dc(cf(g,T),cf(x,A),c);z<o&&h.push([z,T,A])}function pp(h,o,c,g,x=1/0){let T=Math.min(g.distance(h[0],c[0][0]),x);if(T===0)return T;const A=new sr([[0,[0,h.length-1],[0,0]]],Ah),z=hf(c);for(;A.length>0;){const B=A.pop();if(B[0]>=T)continue;const G=B[1],W=o?50:100;if(Cc(G)<=W){if(!sa(G,h.length))return NaN;if(o){const K=Mh(h,G,c,g);if(isNaN(K)||K===0)return K;T=Math.min(T,K)}else for(let K=G[0];K<=G[1];++K){const ot=Md(h[K],c,g);if(T=Math.min(T,ot),T===0)return 0}}else{const K=gs(G,o);Gf(A,T,g,h,z,K[0]),Gf(A,T,g,h,z,K[1])}}return T}function $u(h,o,c,g,x,T=1/0){let A=Math.min(T,x.distance(h[0],c[0]));if(A===0)return A;const z=new sr([[0,[0,h.length-1],[0,c.length-1]]],Ah);for(;z.length>0;){const B=z.pop();if(B[0]>=A)continue;const G=B[1],W=B[2],K=o?50:100,ot=g?50:100;if(Cc(G)<=K&&Cc(W)<=ot){if(!sa(G,h.length)&&sa(W,c.length))return NaN;let ct;if(o&&g)ct=Vf(h,G,c,W,x),A=Math.min(A,ct);else if(o&&!g){const dt=h.slice(G[0],G[1]+1);for(let xt=W[0];xt<=W[1];++xt)if(ct=Ph(c[xt],dt,x),A=Math.min(A,ct),A===0)return A}else if(!o&&g){const dt=c.slice(W[0],W[1]+1);for(let xt=G[0];xt<=G[1];++xt)if(ct=Ph(h[xt],dt,x),A=Math.min(A,ct),A===0)return A}else ct=Qn(h,G,c,W,x),A=Math.min(A,ct)}else{const ct=gs(G,o),dt=gs(W,g);uc(z,A,x,h,c,ct[0],dt[0]),uc(z,A,x,h,c,ct[0],dt[1]),uc(z,A,x,h,c,ct[1],dt[0]),uc(z,A,x,h,c,ct[1],dt[1])}}return A}function qu(h){return h.type==="MultiPolygon"?h.coordinates.map(o=>({type:"Polygon",coordinates:o})):h.type==="MultiLineString"?h.coordinates.map(o=>({type:"LineString",coordinates:o})):h.type==="MultiPoint"?h.coordinates.map(o=>({type:"Point",coordinates:o})):[h]}class eh{constructor(o,c){this.type=tt,this.geojson=o,this.geometries=c}static parse(o,c){if(o.length!==2)return c.error(`'distance' expression requires exactly one argument, but found ${o.length-1} instead.`);if(Pl(o[1])){const g=o[1];if(g.type==="FeatureCollection")return new eh(g,g.features.map(x=>qu(x.geometry)).flat());if(g.type==="Feature")return new eh(g,qu(g.geometry));if("type"in g&&"coordinates"in g)return new eh(g,qu(g))}return c.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(o){if(o.geometry()!=null&&o.canonicalID()!=null){if(o.geometryType()==="Point")return function(c,g){const x=c.geometry(),T=x.flat().map(B=>Ad([B.x,B.y],c.canonical));if(x.length===0)return NaN;const A=new $s(T[0][1]);let z=1/0;for(const B of g){switch(B.type){case"Point":z=Math.min(z,$u(T,!1,[B.coordinates],!1,A,z));break;case"LineString":z=Math.min(z,$u(T,!1,B.coordinates,!0,A,z));break;case"Polygon":z=Math.min(z,pp(T,!1,B.coordinates,A,z))}if(z===0)return z}return z}(o,this.geometries);if(o.geometryType()==="LineString")return function(c,g){const x=c.geometry(),T=x.flat().map(B=>Ad([B.x,B.y],c.canonical));if(x.length===0)return NaN;const A=new $s(T[0][1]);let z=1/0;for(const B of g){switch(B.type){case"Point":z=Math.min(z,$u(T,!0,[B.coordinates],!1,A,z));break;case"LineString":z=Math.min(z,$u(T,!0,B.coordinates,!0,A,z));break;case"Polygon":z=Math.min(z,pp(T,!0,B.coordinates,A,z))}if(z===0)return z}return z}(o,this.geometries);if(o.geometryType()==="Polygon")return function(c,g){const x=c.geometry();if(x.length===0||x[0].length===0)return NaN;const T=th(x,0).map(B=>B.map(G=>G.map(W=>Ad([W.x,W.y],c.canonical)))),A=new $s(T[0][0][0][1]);let z=1/0;for(const B of g)for(const G of T){switch(B.type){case"Point":z=Math.min(z,pp([B.coordinates],!1,G,A,z));break;case"LineString":z=Math.min(z,pp(B.coordinates,!0,G,A,z));break;case"Polygon":z=Math.min(z,jf(G,B.coordinates,A,z))}if(z===0)return z}return z}(o,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class uu{constructor(o){this.type=Jt,this.key=o}static parse(o,c){if(o.length!==2)return c.error(`Expected 1 argument, but found ${o.length-1} instead.`);const g=o[1];return g==null?c.error("Global state property must be defined."):typeof g!="string"?c.error(`Global state property must be string, but found ${typeof o[1]} instead.`):new uu(g)}evaluate(o){var c;const g=(c=o.globals)===null||c===void 0?void 0:c.globalState;return g&&Object.keys(g).length!==0?ql(g,this.key):null}eachChild(){}outputDefined(){return!1}}const xa={"==":Oi,"!=":Ur,">":Ha,"<":sn,">=":en,"<=":Jc,array:Ca,at:qa,boolean:Ca,case:Yc,coalesce:al,collator:oa,format:lc,image:ps,in:ya,"index-of":ac,interpolate:na,"interpolate-hcl":na,"interpolate-lab":na,length:Oo,let:Cn,literal:Zl,match:Xc,number:Ca,"number-format":Ac,object:Ca,slice:Ml,step:Ih,string:Ca,"to-boolean":sl,"to-color":sl,"to-number":sl,"to-string":sl,var:Uu,within:Dl,distance:eh,"global-state":uu};class aa{constructor(o,c,g,x){this.name=o,this.type=c,this._evaluate=g,this.args=x}evaluate(o){return this._evaluate(o,this.args)}eachChild(o){this.args.forEach(o)}outputDefined(){return!1}static parse(o,c){const g=o[0],x=aa.definitions[g];if(!x)return c.error(`Unknown expression "${g}". If you wanted a literal array, use ["literal", [...]].`,0);const T=Array.isArray(x)?x[0]:x.type,A=Array.isArray(x)?[[x[1],x[2]]]:x.overloads,z=A.filter(([G])=>!Array.isArray(G)||G.length===o.length-1);let B=null;for(const[G,W]of z){B=new au(c.registry,ih,c.path,null,c.scope);const K=[];let ot=!1;for(let ct=1;ct<o.length;ct++){const dt=o[ct],xt=Array.isArray(G)?G[ct-1]:G.type,At=B.parse(dt,1+K.length,xt);if(!At){ot=!0;break}K.push(At)}if(!ot)if(Array.isArray(G)&&G.length!==K.length)B.error(`Expected ${G.length} arguments, but found ${K.length} instead.`);else{for(let ct=0;ct<K.length;ct++){const dt=Array.isArray(G)?G[ct]:G.type,xt=K[ct];B.concat(ct+1).checkSubtype(dt,xt.type)}if(B.errors.length===0)return new aa(g,T,W,K)}}if(z.length===1)c.errors.push(...B.errors);else{const G=(z.length?z:A).map(([K])=>{return ot=K,Array.isArray(ot)?`(${ot.map(Yi).join(", ")})`:`(${Yi(ot.type)}...)`;var ot}).join(" | "),W=[];for(let K=1;K<o.length;K++){const ot=c.parse(o[K],1+W.length);if(!ot)return null;W.push(Yi(ot.type))}c.error(`Expected arguments of type ${G}, but found (${W.join(", ")}) instead.`)}return null}static register(o,c){aa.definitions=c;for(const g in c)o[g]=aa}}function Zu(h,[o,c,g,x]){o=o.evaluate(h),c=c.evaluate(h),g=g.evaluate(h);const T=x?x.evaluate(h):1,A=Vu(o,c,g,T);if(A)throw new On(A);return new tn(o/255,c/255,g/255,T,!1)}function fp(h,o){return h in o}function Cd(h,o){const c=o[h];return c===void 0?null:c}function Xl(h){return{type:h}}function ih(h){if(h instanceof Uu)return ih(h.boundExpression);if(h instanceof aa&&h.name==="error"||h instanceof oa||h instanceof Dl||h instanceof eh||h instanceof uu)return!1;const o=h instanceof sl||h instanceof Ca;let c=!0;return h.eachChild(g=>{c=o?c&&ih(g):c&&g instanceof Zl}),!!c&&Hu(h)&&La(h,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"])}function Hu(h){if(h instanceof aa&&(h.name==="get"&&h.args.length===1||h.name==="feature-state"||h.name==="has"&&h.args.length===1||h.name==="properties"||h.name==="geometry-type"||h.name==="id"||/^filter-/.test(h.name))||h instanceof Dl||h instanceof eh)return!1;let o=!0;return h.eachChild(c=>{o&&!Hu(c)&&(o=!1)}),o}function Ch(h){if(h instanceof aa&&h.name==="feature-state")return!1;let o=!0;return h.eachChild(c=>{o&&!Ch(c)&&(o=!1)}),o}function La(h,o){if(h instanceof aa&&o.indexOf(h.name)>=0)return!1;let c=!0;return h.eachChild(g=>{c&&!La(g,o)&&(c=!1)}),c}function Dd(h){return{result:"success",value:h}}function ri(h){return{result:"error",value:h}}function Dh(h){return h["property-type"]==="data-driven"||h["property-type"]==="cross-faded-data-driven"}function du(h){return!!h.expression&&h.expression.parameters.indexOf("zoom")>-1}function zh(h){return!!h.expression&&h.expression.interpolated}function yn(h){return h instanceof Number?"number":h instanceof String?"string":h instanceof Boolean?"boolean":Array.isArray(h)?"array":h===null?"null":typeof h}function Lh(h){return typeof h=="object"&&h!==null&&!Array.isArray(h)&&pr(h)===ye}function zc(h){return h}function zd(h,o){const c=h.stops&&typeof h.stops[0][0]=="object",g=c||!(c||h.property!==void 0),x=h.type||(zh(o)?"exponential":"interval"),T=function(W){switch(W.type){case"color":return tn.parse;case"padding":return as.parse;case"numberArray":return ia.parse;case"colorArray":return Ls.parse;default:return null}}(o);if(T&&((h=Bo({},h)).stops&&(h.stops=h.stops.map(W=>[W[0],T(W[1])])),h.default=T(h.default?h.default:o.default)),h.colorSpace&&(A=h.colorSpace)!=="rgb"&&A!=="hcl"&&A!=="lab")throw new Error(`Unknown color space: "${h.colorSpace}"`);var A;const z=function(W){switch(W){case"exponential":return $f;case"interval":return Wu;case"categorical":return kr;case"identity":return Mm;default:throw new Error(`Unknown function type "${W}"`)}}(x);let B,G;if(x==="categorical"){B=Object.create(null);for(const W of h.stops)B[W[0]]=W[1];G=typeof h.stops[0][0]}if(c){const W={},K=[];for(let dt=0;dt<h.stops.length;dt++){const xt=h.stops[dt],At=xt[0].zoom;W[At]===void 0&&(W[At]={zoom:At,type:h.type,property:h.property,default:h.default,stops:[]},K.push(At)),W[At].stops.push([xt[0].value,xt[1]])}const ot=[];for(const dt of K)ot.push([W[dt].zoom,zd(W[dt],o)]);const ct={name:"linear"};return{kind:"composite",interpolationType:ct,interpolationFactor:na.interpolationFactor.bind(void 0,ct),zoomStops:ot.map(dt=>dt[0]),evaluate:({zoom:dt},xt)=>$f({stops:ot,base:h.base},o,dt).evaluate(dt,xt)}}if(g){const W=x==="exponential"?{name:"exponential",base:h.base!==void 0?h.base:1}:null;return{kind:"camera",interpolationType:W,interpolationFactor:na.interpolationFactor.bind(void 0,W),zoomStops:h.stops.map(K=>K[0]),evaluate:({zoom:K})=>z(h,o,K,B,G)}}return{kind:"source",evaluate(W,K){const ot=K&&K.properties?K.properties[h.property]:void 0;return ot===void 0?Ra(h.default,o.default):z(h,o,ot,B,G)}}}function Ra(h,o,c){return h!==void 0?h:o!==void 0?o:c!==void 0?c:void 0}function kr(h,o,c,g,x){return Ra(typeof c===x?g[c]:void 0,h.default,o.default)}function Wu(h,o,c){if(yn(c)!=="number")return Ra(h.default,o.default);const g=h.stops.length;if(g===1||c<=h.stops[0][0])return h.stops[0][1];if(c>=h.stops[g-1][0])return h.stops[g-1][1];const x=Zo(h.stops.map(T=>T[0]),c);return h.stops[x][1]}function $f(h,o,c){const g=h.base!==void 0?h.base:1;if(yn(c)!=="number")return Ra(h.default,o.default);const x=h.stops.length;if(x===1||c<=h.stops[0][0])return h.stops[0][1];if(c>=h.stops[x-1][0])return h.stops[x-1][1];const T=Zo(h.stops.map(W=>W[0]),c),A=function(W,K,ot,ct){const dt=ct-ot,xt=W-ot;return dt===0?0:K===1?xt/dt:(Math.pow(K,xt)-1)/(Math.pow(K,dt)-1)}(c,g,h.stops[T][0],h.stops[T+1][0]),z=h.stops[T][1],B=h.stops[T+1][1],G=Za[o.type]||zc;return typeof z.evaluate=="function"?{evaluate(...W){const K=z.evaluate.apply(void 0,W),ot=B.evaluate.apply(void 0,W);if(K!==void 0&&ot!==void 0)return G(K,ot,A,h.colorSpace)}}:G(z,B,A,h.colorSpace)}function Mm(h,o,c){switch(o.type){case"color":c=tn.parse(c);break;case"formatted":c=Lo.fromString(c.toString());break;case"resolvedImage":c=Rs.fromString(c.toString());break;case"padding":c=as.parse(c);break;case"colorArray":c=Ls.parse(c);break;case"numberArray":c=ia.parse(c);break;default:yn(c)===o.type||o.type==="enum"&&o.values[c]||(c=void 0)}return Ra(c,h.default,o.default)}aa.register(xa,{error:[{kind:"error"},[Tt],(h,[o])=>{throw new On(o.evaluate(h))}],typeof:[Tt,[Jt],(h,[o])=>Yi(pr(o.evaluate(h)))],"to-rgba":[hr(tt,4),[Wt],(h,[o])=>{const[c,g,x,T]=o.evaluate(h).rgb;return[255*c,255*g,255*x,T]}],rgb:[Wt,[tt,tt,tt],Zu],rgba:[Wt,[tt,tt,tt,tt],Zu],has:{type:Nt,overloads:[[[Tt],(h,[o])=>fp(o.evaluate(h),h.properties())],[[Tt,ye],(h,[o,c])=>fp(o.evaluate(h),c.evaluate(h))]]},get:{type:Jt,overloads:[[[Tt],(h,[o])=>Cd(o.evaluate(h),h.properties())],[[Tt,ye],(h,[o,c])=>Cd(o.evaluate(h),c.evaluate(h))]]},"feature-state":[Jt,[Tt],(h,[o])=>Cd(o.evaluate(h),h.featureState||{})],properties:[ye,[],h=>h.properties()],"geometry-type":[Tt,[],h=>h.geometryType()],id:[Jt,[],h=>h.id()],zoom:[tt,[],h=>h.globals.zoom],"heatmap-density":[tt,[],h=>h.globals.heatmapDensity||0],elevation:[tt,[],h=>h.globals.elevation||0],"line-progress":[tt,[],h=>h.globals.lineProgress||0],accumulated:[Jt,[],h=>h.globals.accumulated===void 0?null:h.globals.accumulated],"+":[tt,Xl(tt),(h,o)=>{let c=0;for(const g of o)c+=g.evaluate(h);return c}],"*":[tt,Xl(tt),(h,o)=>{let c=1;for(const g of o)c*=g.evaluate(h);return c}],"-":{type:tt,overloads:[[[tt,tt],(h,[o,c])=>o.evaluate(h)-c.evaluate(h)],[[tt],(h,[o])=>-o.evaluate(h)]]},"/":[tt,[tt,tt],(h,[o,c])=>o.evaluate(h)/c.evaluate(h)],"%":[tt,[tt,tt],(h,[o,c])=>o.evaluate(h)%c.evaluate(h)],ln2:[tt,[],()=>Math.LN2],pi:[tt,[],()=>Math.PI],e:[tt,[],()=>Math.E],"^":[tt,[tt,tt],(h,[o,c])=>Math.pow(o.evaluate(h),c.evaluate(h))],sqrt:[tt,[tt],(h,[o])=>Math.sqrt(o.evaluate(h))],log10:[tt,[tt],(h,[o])=>Math.log(o.evaluate(h))/Math.LN10],ln:[tt,[tt],(h,[o])=>Math.log(o.evaluate(h))],log2:[tt,[tt],(h,[o])=>Math.log(o.evaluate(h))/Math.LN2],sin:[tt,[tt],(h,[o])=>Math.sin(o.evaluate(h))],cos:[tt,[tt],(h,[o])=>Math.cos(o.evaluate(h))],tan:[tt,[tt],(h,[o])=>Math.tan(o.evaluate(h))],asin:[tt,[tt],(h,[o])=>Math.asin(o.evaluate(h))],acos:[tt,[tt],(h,[o])=>Math.acos(o.evaluate(h))],atan:[tt,[tt],(h,[o])=>Math.atan(o.evaluate(h))],min:[tt,Xl(tt),(h,o)=>Math.min(...o.map(c=>c.evaluate(h)))],max:[tt,Xl(tt),(h,o)=>Math.max(...o.map(c=>c.evaluate(h)))],abs:[tt,[tt],(h,[o])=>Math.abs(o.evaluate(h))],round:[tt,[tt],(h,[o])=>{const c=o.evaluate(h);return c<0?-Math.round(-c):Math.round(c)}],floor:[tt,[tt],(h,[o])=>Math.floor(o.evaluate(h))],ceil:[tt,[tt],(h,[o])=>Math.ceil(o.evaluate(h))],"filter-==":[Nt,[Tt,Jt],(h,[o,c])=>h.properties()[o.value]===c.value],"filter-id-==":[Nt,[Jt],(h,[o])=>h.id()===o.value],"filter-type-==":[Nt,[Tt],(h,[o])=>h.geometryType()===o.value],"filter-<":[Nt,[Tt,Jt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g<x}],"filter-id-<":[Nt,[Jt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c<g}],"filter->":[Nt,[Tt,Jt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g>x}],"filter-id->":[Nt,[Jt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c>g}],"filter-<=":[Nt,[Tt,Jt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g<=x}],"filter-id-<=":[Nt,[Jt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c<=g}],"filter->=":[Nt,[Tt,Jt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g>=x}],"filter-id->=":[Nt,[Jt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c>=g}],"filter-has":[Nt,[Jt],(h,[o])=>o.value in h.properties()],"filter-has-id":[Nt,[],h=>h.id()!==null&&h.id()!==void 0],"filter-type-in":[Nt,[hr(Tt)],(h,[o])=>o.value.indexOf(h.geometryType())>=0],"filter-id-in":[Nt,[hr(Jt)],(h,[o])=>o.value.indexOf(h.id())>=0],"filter-in-small":[Nt,[Tt,hr(Jt)],(h,[o,c])=>c.value.indexOf(h.properties()[o.value])>=0],"filter-in-large":[Nt,[Tt,hr(Jt)],(h,[o,c])=>function(g,x,T,A){for(;T<=A;){const z=T+A>>1;if(x[z]===g)return!0;x[z]>g?A=z-1:T=z+1}return!1}(h.properties()[o.value],c.value,0,c.value.length-1)],all:{type:Nt,overloads:[[[Nt,Nt],(h,[o,c])=>o.evaluate(h)&&c.evaluate(h)],[Xl(Nt),(h,o)=>{for(const c of o)if(!c.evaluate(h))return!1;return!0}]]},any:{type:Nt,overloads:[[[Nt,Nt],(h,[o,c])=>o.evaluate(h)||c.evaluate(h)],[Xl(Nt),(h,o)=>{for(const c of o)if(c.evaluate(h))return!0;return!1}]]},"!":[Nt,[Nt],(h,[o])=>!o.evaluate(h)],"is-supported-script":[Nt,[Tt],(h,[o])=>{const c=h.globals&&h.globals.isSupportedScript;return!c||c(o.evaluate(h))}],upcase:[Tt,[Tt],(h,[o])=>o.evaluate(h).toUpperCase()],downcase:[Tt,[Tt],(h,[o])=>o.evaluate(h).toLowerCase()],concat:[Tt,Xl(Jt),(h,o)=>o.map(c=>Sh(c.evaluate(h))).join("")],"resolved-locale":[Tt,[xe],(h,[o])=>o.evaluate(h).resolvedLocale()]});class pu{constructor(o,c,g){this.expression=o,this._warningHistory={},this._evaluator=new Hr,this._defaultValue=c?function(x){if(x.type==="color"&&Lh(x.default))return new tn(0,0,0,0);switch(x.type){case"color":return tn.parse(x.default)||null;case"padding":return as.parse(x.default)||null;case"numberArray":return ia.parse(x.default)||null;case"colorArray":return Ls.parse(x.default)||null;case"variableAnchorOffsetCollection":return Is.parse(x.default)||null;case"projectionDefinition":return ra.parse(x.default)||null;default:return x.default===void 0?null:x.default}}(c):null,this._enumValues=c&&c.type==="enum"?c.values:null,this._globalState=g}evaluateWithoutErrorHandling(o,c,g,x,T,A){return this._globalState&&(o=fu(o,this._globalState)),this._evaluator.globals=o,this._evaluator.feature=c,this._evaluator.featureState=g,this._evaluator.canonical=x,this._evaluator.availableImages=T||null,this._evaluator.formattedSection=A,this.expression.evaluate(this._evaluator)}evaluate(o,c,g,x,T,A){this._globalState&&(o=fu(o,this._globalState)),this._evaluator.globals=o,this._evaluator.feature=c||null,this._evaluator.featureState=g||null,this._evaluator.canonical=x,this._evaluator.availableImages=T||null,this._evaluator.formattedSection=A||null;try{const z=this.expression.evaluate(this._evaluator);if(z==null||typeof z=="number"&&z!=z)return this._defaultValue;if(this._enumValues&&!(z in this._enumValues))throw new On(`Expected value to be one of ${Object.keys(this._enumValues).map(B=>JSON.stringify(B)).join(", ")}, but found ${JSON.stringify(z)} instead.`);return z}catch(z){return this._warningHistory[z.message]||(this._warningHistory[z.message]=!0,typeof console<"u"&&console.warn(z.message)),this._defaultValue}}}function mp(h){return Array.isArray(h)&&h.length>0&&typeof h[0]=="string"&&h[0]in xa}function Xn(h,o,c){const g=new au(xa,ih,[],o?function(T){const A={color:Wt,string:Tt,number:tt,enum:Tt,boolean:Nt,formatted:ti,padding:$e,numberArray:Ji,colorArray:Mi,projectionDefinition:oe,resolvedImage:Xi,variableAnchorOffsetCollection:qi};return T.type==="array"?hr(A[T.value]||Jt,T.length):A[T.type]}(o):void 0),x=g.parse(h,void 0,void 0,void 0,o&&o.type==="string"?{typeAnnotation:"coerce"}:void 0);return x?Dd(new pu(x,o,c)):ri(g.errors)}class Rh{constructor(o,c,g){this.kind=o,this._styleExpression=c,this.isStateDependent=o!=="constant"&&!Ch(c.expression),this.globalStateRefs=yp(c.expression),this._globalState=g}evaluateWithoutErrorHandling(o,c,g,x,T,A){return this._globalState&&(o=fu(o,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(o,c,g,x,T,A)}evaluate(o,c,g,x,T,A){return this._globalState&&(o=fu(o,this._globalState)),this._styleExpression.evaluate(o,c,g,x,T,A)}}class Xu{constructor(o,c,g,x,T){this.kind=o,this.zoomStops=g,this._styleExpression=c,this.isStateDependent=o!=="camera"&&!Ch(c.expression),this.globalStateRefs=yp(c.expression),this.interpolationType=x,this._globalState=T}evaluateWithoutErrorHandling(o,c,g,x,T,A){return this._globalState&&(o=fu(o,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(o,c,g,x,T,A)}evaluate(o,c,g,x,T,A){return this._globalState&&(o=fu(o,this._globalState)),this._styleExpression.evaluate(o,c,g,x,T,A)}interpolationFactor(o,c,g){return this.interpolationType?na.interpolationFactor(this.interpolationType,o,c,g):0}}function qf(h,o,c){const g=Xn(h,o,c);if(g.result==="error")return g;const x=g.value.expression,T=Hu(x);if(!T&&!Dh(o))return ri([new wo("","data expressions not supported")]);const A=La(x,["zoom"]);if(!A&&!du(o))return ri([new wo("","zoom expressions not supported")]);const z=_p(x);return z||A?z instanceof wo?ri([z]):z instanceof na&&!zh(o)?ri([new wo("",'"interpolate" expressions cannot be used with this property')]):Dd(z?new Xu(T?"camera":"composite",g.value,z.labels,z instanceof na?z.interpolation:void 0,c):new Rh(T?"constant":"source",g.value,c)):ri([new wo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class gp{constructor(o,c){this._parameters=o,this._specification=c,Bo(this,zd(this._parameters,this._specification))}static deserialize(o){return new gp(o._parameters,o._specification)}static serialize(o){return{_parameters:o._parameters,_specification:o._specification}}}function _p(h){let o=null;if(h instanceof Cn)o=_p(h.result);else if(h instanceof al){for(const c of h.args)if(o=_p(c),o)break}else(h instanceof Ih||h instanceof na)&&h.input instanceof aa&&h.input.name==="zoom"&&(o=h);return o instanceof wo||h.eachChild(c=>{const g=_p(c);g instanceof wo?o=g:!o&&g?o=new wo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):o&&g&&o!==g&&(o=new wo("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),o}function yp(h,o=new Set){return h instanceof uu&&o.add(h.key),h.eachChild(c=>{yp(c,o)}),o}function fu(h,o){const{zoom:c,heatmapDensity:g,elevation:x,lineProgress:T,isSupportedScript:A,accumulated:z}=h??{};return{zoom:c,heatmapDensity:g,elevation:x,lineProgress:T,isSupportedScript:A,accumulated:z,globalState:o}}function xp(h){if(h===!0||h===!1)return!0;if(!Array.isArray(h)||h.length===0)return!1;switch(h[0]){case"has":return h.length>=2&&h[1]!=="$id"&&h[1]!=="$type";case"in":return h.length>=3&&(typeof h[1]!="string"||Array.isArray(h[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return h.length!==3||Array.isArray(h[1])||Array.isArray(h[2]);case"any":case"all":for(const o of h.slice(1))if(!xp(o)&&typeof o!="boolean")return!1;return!0;default:return!0}}const Ld={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Rd(h,o){if(h==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};xp(h)||(h=kh(h));const c=Xn(h,Ld,o);if(c.result==="error")throw new Error(c.value.map(g=>`${g.key}: ${g.message}`).join(", "));return{filter:(g,x,T)=>c.value.evaluate(g,x,{},T),needGeometry:kd(h),getGlobalStateRefs:()=>yp(c.value.expression)}}function Zf(h,o){return h<o?-1:h>o?1:0}function kd(h){if(!Array.isArray(h))return!1;if(h[0]==="within"||h[0]==="distance")return!0;for(let o=1;o<h.length;o++)if(kd(h[o]))return!0;return!1}function kh(h){if(!h)return!0;const o=h[0];return h.length<=1?o!=="any":o==="=="?Yu(h[1],h[2],"=="):o==="!="?Bh(Yu(h[1],h[2],"==")):o==="<"||o===">"||o==="<="||o===">="?Yu(h[1],h[2],o):o==="any"?(c=h.slice(1),["any"].concat(c.map(kh))):o==="all"?["all"].concat(h.slice(1).map(kh)):o==="none"?["all"].concat(h.slice(1).map(kh).map(Bh)):o==="in"?Fh(h[1],h.slice(2)):o==="!in"?Bh(Fh(h[1],h.slice(2))):o==="has"?mu(h[1]):o!=="!has"||Bh(mu(h[1]));var c}function Yu(h,o,c){switch(h){case"$type":return[`filter-type-${c}`,o];case"$id":return[`filter-id-${c}`,o];default:return[`filter-${c}`,h,o]}}function Fh(h,o){if(o.length===0)return!1;switch(h){case"$type":return["filter-type-in",["literal",o]];case"$id":return["filter-id-in",["literal",o]];default:return o.length>200&&!o.some(c=>typeof c!=typeof o[0])?["filter-in-large",h,["literal",o.sort(Zf)]]:["filter-in-small",h,["literal",o]]}}function mu(h){switch(h){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",h]}}function Bh(h){return["!",h]}function Oh(h){const o=typeof h;if(o==="number"||o==="boolean"||o==="string"||h==null)return JSON.stringify(h);if(Array.isArray(h)){let x="[";for(const T of h)x+=`${Oh(T)},`;return`${x}]`}const c=Object.keys(h).sort();let g="{";for(let x=0;x<c.length;x++)g+=`${JSON.stringify(c[x])}:${Oh(h[c[x]])},`;return`${g}}`}function uf(h){let o="";for(const c of ze)o+=`/${Oh(h[c])}`;return o}function Fd(h){const o=h.value;return o?[new bi(h.key,o,"constants have been deprecated as of v8")]:[]}function Xo(h){return h instanceof Number||h instanceof String||h instanceof Boolean?h.valueOf():h}function ul(h){if(Array.isArray(h))return h.map(ul);if(h instanceof Object&&!(h instanceof Number||h instanceof String||h instanceof Boolean)){const o={};for(const c in h)o[c]=ul(h[c]);return o}return Xo(h)}function va(h){const o=h.key,c=h.value,g=h.valueSpec||{},x=h.objectElementValidators||{},T=h.style,A=h.styleSpec,z=h.validateSpec;let B=[];const G=yn(c);if(G!=="object")return[new bi(o,c,`object expected, ${G} found`)];for(const W in c){const K=W.split(".")[0],ot=ql(g,K)||g["*"];let ct;if(ql(x,K))ct=x[K];else if(ql(g,K))ct=z;else if(x["*"])ct=x["*"];else{if(!g["*"]){B.push(new bi(o,c[W],`unknown property "${W}"`));continue}ct=z}B=B.concat(ct({key:(o&&`${o}.`)+W,value:c[W],valueSpec:ot,style:T,styleSpec:A,object:c,objectKey:W,validateSpec:z},c))}for(const W in g)x[W]||g[W].required&&g[W].default===void 0&&c[W]===void 0&&B.push(new bi(o,c,`missing required property "${W}"`));return B}function Nh(h){const o=h.value,c=h.valueSpec,g=h.style,x=h.styleSpec,T=h.key,A=h.arrayElementValidator||h.validateSpec;if(yn(o)!=="array")return[new bi(T,o,`array expected, ${yn(o)} found`)];if(c.length&&o.length!==c.length)return[new bi(T,o,`array length ${c.length} expected, length ${o.length} found`)];if(c["min-length"]&&o.length<c["min-length"])return[new bi(T,o,`array length at least ${c["min-length"]} expected, length ${o.length} found`)];let z={type:c.value,values:c.values};x.$version<7&&(z.function=c.function),yn(c.value)==="object"&&(z=c.value);let B=[];for(let G=0;G<o.length;G++)B=B.concat(A({array:o,arrayIndex:G,value:o[G],valueSpec:z,validateSpec:h.validateSpec,style:g,styleSpec:x,key:`${T}[${G}]`}));return B}function rh(h){const o=h.key,c=h.value,g=h.valueSpec;let x=yn(c);return x==="number"&&c!=c&&(x="NaN"),x!=="number"?[new bi(o,c,`number expected, ${x} found`)]:"minimum"in g&&c<g.minimum?[new bi(o,c,`${c} is less than the minimum value ${g.minimum}`)]:"maximum"in g&&c>g.maximum?[new bi(o,c,`${c} is greater than the maximum value ${g.maximum}`)]:[]}function Bd(h){const o=h.valueSpec,c=Xo(h.value.type);let g,x,T,A={};const z=c!=="categorical"&&h.value.property===void 0,B=!z,G=yn(h.value.stops)==="array"&&yn(h.value.stops[0])==="array"&&yn(h.value.stops[0][0])==="object",W=va({key:h.key,value:h.value,valueSpec:h.styleSpec.function,validateSpec:h.validateSpec,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{stops:function(ct){if(c==="identity")return[new bi(ct.key,ct.value,'identity function may not have a "stops" property')];let dt=[];const xt=ct.value;return dt=dt.concat(Nh({key:ct.key,value:xt,valueSpec:ct.valueSpec,validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec,arrayElementValidator:K})),yn(xt)==="array"&&xt.length===0&&dt.push(new bi(ct.key,xt,"array must have at least one stop")),dt},default:function(ct){return ct.validateSpec({key:ct.key,value:ct.value,valueSpec:o,validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec})}}});return c==="identity"&&z&&W.push(new bi(h.key,h.value,'missing required property "property"')),c==="identity"||h.value.stops||W.push(new bi(h.key,h.value,'missing required property "stops"')),c==="exponential"&&h.valueSpec.expression&&!zh(h.valueSpec)&&W.push(new bi(h.key,h.value,"exponential functions not supported")),h.styleSpec.$version>=8&&(B&&!Dh(h.valueSpec)?W.push(new bi(h.key,h.value,"property functions not supported")):z&&!du(h.valueSpec)&&W.push(new bi(h.key,h.value,"zoom functions not supported"))),c!=="categorical"&&!G||h.value.property!==void 0||W.push(new bi(h.key,h.value,'"property" property is required')),W;function K(ct){let dt=[];const xt=ct.value,At=ct.key;if(yn(xt)!=="array")return[new bi(At,xt,`array expected, ${yn(xt)} found`)];if(xt.length!==2)return[new bi(At,xt,`array length 2 expected, length ${xt.length} found`)];if(G){if(yn(xt[0])!=="object")return[new bi(At,xt,`object expected, ${yn(xt[0])} found`)];if(xt[0].zoom===void 0)return[new bi(At,xt,"object stop key must have zoom")];if(xt[0].value===void 0)return[new bi(At,xt,"object stop key must have value")];if(T&&T>Xo(xt[0].zoom))return[new bi(At,xt[0].zoom,"stop zoom values must appear in ascending order")];Xo(xt[0].zoom)!==T&&(T=Xo(xt[0].zoom),x=void 0,A={}),dt=dt.concat(va({key:`${At}[0]`,value:xt[0],valueSpec:{zoom:{}},validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec,objectElementValidators:{zoom:rh,value:ot}}))}else dt=dt.concat(ot({key:`${At}[0]`,value:xt[0],validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec},xt));return mp(ul(xt[1]))?dt.concat([new bi(`${At}[1]`,xt[1],"expressions are not allowed in function stops.")]):dt.concat(ct.validateSpec({key:`${At}[1]`,value:xt[1],valueSpec:o,validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec}))}function ot(ct,dt){const xt=yn(ct.value),At=Xo(ct.value),jt=ct.value!==null?ct.value:dt;if(g){if(xt!==g)return[new bi(ct.key,jt,`${xt} stop domain type must match previous stop domain type ${g}`)]}else g=xt;if(xt!=="number"&&xt!=="string"&&xt!=="boolean")return[new bi(ct.key,jt,"stop domain value must be a number, string, or boolean")];if(xt!=="number"&&c!=="categorical"){let ue=`number expected, ${xt} found`;return Dh(o)&&c===void 0&&(ue+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new bi(ct.key,jt,ue)]}return c!=="categorical"||xt!=="number"||isFinite(At)&&Math.floor(At)===At?c!=="categorical"&&xt==="number"&&x!==void 0&&At<x?[new bi(ct.key,jt,"stop domain values must appear in ascending order")]:(x=At,c==="categorical"&&At in A?[new bi(ct.key,jt,"stop domain values must be unique")]:(A[At]=!0,[])):[new bi(ct.key,jt,`integer expected, found ${At}`)]}}function Lc(h){const o=(h.expressionContext==="property"?qf:Xn)(ul(h.value),h.valueSpec);if(o.result==="error")return o.value.map(g=>new bi(`${h.key}${g.key}`,h.value,g.message));const c=o.value.expression||o.value._styleExpression.expression;if(h.expressionContext==="property"&&h.propertyKey==="text-font"&&!c.outputDefined())return[new bi(h.key,h.value,`Invalid data expression for "${h.propertyKey}". Output values must be contained as literals within the expression.`)];if(h.expressionContext==="property"&&h.propertyType==="layout"&&!Ch(c))return[new bi(h.key,h.value,'"feature-state" data expressions are not supported with layout properties.')];if(h.expressionContext==="filter"&&!Ch(c))return[new bi(h.key,h.value,'"feature-state" data expressions are not supported with filters.')];if(h.expressionContext&&h.expressionContext.indexOf("cluster")===0){if(!La(c,["zoom","feature-state"]))return[new bi(h.key,h.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(h.expressionContext==="cluster-initial"&&!Hu(c))return[new bi(h.key,h.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function vp(h){const o=h.key,c=h.value,g=yn(c);return g!=="string"?[new bi(o,c,`color expected, ${g} found`)]:tn.parse(String(c))?[]:[new bi(o,c,`color expected, "${c}" found`)]}function Ju(h){const o=h.key,c=h.value,g=h.valueSpec,x=[];return Array.isArray(g.values)?g.values.indexOf(Xo(c))===-1&&x.push(new bi(o,c,`expected one of [${g.values.join(", ")}], ${JSON.stringify(c)} found`)):Object.keys(g.values).indexOf(Xo(c))===-1&&x.push(new bi(o,c,`expected one of [${Object.keys(g.values).join(", ")}], ${JSON.stringify(c)} found`)),x}function bp(h){return xp(ul(h.value))?Lc(Bo({},h,{expressionContext:"filter",valueSpec:{value:"boolean"}})):gu(h)}function gu(h){const o=h.value,c=h.key;if(yn(o)!=="array")return[new bi(c,o,`array expected, ${yn(o)} found`)];const g=h.styleSpec;let x,T=[];if(o.length<1)return[new bi(c,o,"filter array must have at least 1 element")];switch(T=T.concat(Ju({key:`${c}[0]`,value:o[0],valueSpec:g.filter_operator,style:h.style,styleSpec:h.styleSpec})),Xo(o[0])){case"<":case"<=":case">":case">=":o.length>=2&&Xo(o[1])==="$type"&&T.push(new bi(c,o,`"$type" cannot be use with operator "${o[0]}"`));case"==":case"!=":o.length!==3&&T.push(new bi(c,o,`filter array for operator "${o[0]}" must have 3 elements`));case"in":case"!in":o.length>=2&&(x=yn(o[1]),x!=="string"&&T.push(new bi(`${c}[1]`,o[1],`string expected, ${x} found`)));for(let A=2;A<o.length;A++)x=yn(o[A]),Xo(o[1])==="$type"?T=T.concat(Ju({key:`${c}[${A}]`,value:o[A],valueSpec:g.geometry_type,style:h.style,styleSpec:h.styleSpec})):x!=="string"&&x!=="number"&&x!=="boolean"&&T.push(new bi(`${c}[${A}]`,o[A],`string, number, or boolean expected, ${x} found`));break;case"any":case"all":case"none":for(let A=1;A<o.length;A++)T=T.concat(gu({key:`${c}[${A}]`,value:o[A],style:h.style,styleSpec:h.styleSpec}));break;case"has":case"!has":x=yn(o[1]),o.length!==2?T.push(new bi(c,o,`filter array for "${o[0]}" operator must have 2 elements`)):x!=="string"&&T.push(new bi(`${c}[1]`,o[1],`string expected, ${x} found`))}return T}function Ku(h,o){const c=h.key,g=h.validateSpec,x=h.style,T=h.styleSpec,A=h.value,z=h.objectKey,B=T[`${o}_${h.layerType}`];if(!B)return[];const G=z.match(/^(.*)-transition$/);if(o==="paint"&&G&&B[G[1]]&&B[G[1]].transition)return g({key:c,value:A,valueSpec:T.transition,style:x,styleSpec:T});const W=h.valueSpec||B[z];if(!W)return[new bi(c,A,`unknown property "${z}"`)];let K;if(yn(A)==="string"&&Dh(W)&&!W.tokens&&(K=/^{([^}]+)}$/.exec(A)))return[new bi(c,A,`"${z}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(K[1])} }\`.`)];const ot=[];return h.layerType==="symbol"&&z==="text-font"&&Lh(ul(A))&&Xo(A.type)==="identity"&&ot.push(new bi(c,A,'"text-font" does not support identity functions')),ot.concat(g({key:h.key,value:A,valueSpec:W,style:x,styleSpec:T,expressionContext:"property",propertyType:o,propertyKey:z}))}function df(h){return Ku(h,"paint")}function Qu(h){return Ku(h,"layout")}function Hf(h){let o=[];const c=h.value,g=h.key,x=h.style,T=h.styleSpec;if(yn(c)!=="object")return[new bi(g,c,`object expected, ${yn(c)} found`)];c.type||c.ref||o.push(new bi(g,c,'either "type" or "ref" is required'));let A=Xo(c.type);const z=Xo(c.ref);if(c.id){const B=Xo(c.id);for(let G=0;G<h.arrayIndex;G++){const W=x.layers[G];Xo(W.id)===B&&o.push(new bi(g,c.id,`duplicate layer id "${c.id}", previously used at line ${W.id.__line__}`))}}if("ref"in c){let B;["type","source","source-layer","filter","layout"].forEach(G=>{G in c&&o.push(new bi(g,c[G],`"${G}" is prohibited for ref layers`))}),x.layers.forEach(G=>{Xo(G.id)===z&&(B=G)}),B?B.ref?o.push(new bi(g,c.ref,"ref cannot reference another ref layer")):A=Xo(B.type):o.push(new bi(g,c.ref,`ref layer "${z}" not found`))}else if(A!=="background")if(c.source){const B=x.sources&&x.sources[c.source],G=B&&Xo(B.type);B?G==="vector"&&A==="raster"?o.push(new bi(g,c.source,`layer "${c.id}" requires a raster source`)):G!=="raster-dem"&&A==="hillshade"||G!=="raster-dem"&&A==="color-relief"?o.push(new bi(g,c.source,`layer "${c.id}" requires a raster-dem source`)):G==="raster"&&A!=="raster"?o.push(new bi(g,c.source,`layer "${c.id}" requires a vector source`)):G!=="vector"||c["source-layer"]?G==="raster-dem"&&A!=="hillshade"&&A!=="color-relief"?o.push(new bi(g,c.source,"raster-dem source can only be used with layer type 'hillshade' or 'color-relief'.")):A!=="line"||!c.paint||!c.paint["line-gradient"]||G==="geojson"&&B.lineMetrics||o.push(new bi(g,c,`layer "${c.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):o.push(new bi(g,c,`layer "${c.id}" must specify a "source-layer"`)):o.push(new bi(g,c.source,`source "${c.source}" not found`))}else o.push(new bi(g,c,'missing required property "source"'));return o=o.concat(va({key:g,value:c,valueSpec:T.layer,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,objectElementValidators:{"*":()=>[],type:()=>h.validateSpec({key:`${g}.type`,value:c.type,valueSpec:T.layer.type,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,object:c,objectKey:"type"}),filter:bp,layout:B=>va({layer:c,key:B.key,value:B.value,style:B.style,styleSpec:B.styleSpec,validateSpec:B.validateSpec,objectElementValidators:{"*":G=>Qu(Bo({layerType:A},G))}}),paint:B=>va({layer:c,key:B.key,value:B.value,style:B.style,styleSpec:B.styleSpec,validateSpec:B.validateSpec,objectElementValidators:{"*":G=>df(Bo({layerType:A},G))}})}})),o}function Rc(h){const o=h.value,c=h.key,g=yn(o);return g!=="string"?[new bi(c,o,`string expected, ${g} found`)]:[]}const Od={promoteId:function({key:h,value:o}){if(yn(o)==="string")return Rc({key:h,value:o});{const c=[];for(const g in o)c.push(...Rc({key:`${h}.${g}`,value:o[g]}));return c}}};function Nd(h){const o=h.value,c=h.key,g=h.styleSpec,x=h.style,T=h.validateSpec;if(!o.type)return[new bi(c,o,'"type" is required')];const A=Xo(o.type);let z;switch(A){case"vector":case"raster":return z=va({key:c,value:o,valueSpec:g[`source_${A.replace("-","_")}`],style:h.style,styleSpec:g,objectElementValidators:Od,validateSpec:T}),z;case"raster-dem":return z=function(B){var G;const W=(G=B.sourceName)!==null&&G!==void 0?G:"",K=B.value,ot=B.styleSpec,ct=ot.source_raster_dem,dt=B.style;let xt=[];const At=yn(K);if(K===void 0)return xt;if(At!=="object")return xt.push(new bi("source_raster_dem",K,`object expected, ${At} found`)),xt;const jt=Xo(K.encoding)==="custom",ue=["redFactor","greenFactor","blueFactor","baseShift"],Qt=B.value.encoding?`"${B.value.encoding}"`:"Default";for(const ie in K)!jt&&ue.includes(ie)?xt.push(new bi(ie,K[ie],`In "${W}": "${ie}" is only valid when "encoding" is set to "custom". ${Qt} encoding found`)):ct[ie]?xt=xt.concat(B.validateSpec({key:ie,value:K[ie],valueSpec:ct[ie],validateSpec:B.validateSpec,style:dt,styleSpec:ot})):xt.push(new bi(ie,K[ie],`unknown property "${ie}"`));return xt}({sourceName:c,value:o,style:h.style,styleSpec:g,validateSpec:T}),z;case"geojson":if(z=va({key:c,value:o,valueSpec:g.source_geojson,style:x,styleSpec:g,validateSpec:T,objectElementValidators:Od}),o.cluster)for(const B in o.clusterProperties){const[G,W]=o.clusterProperties[B],K=typeof G=="string"?[G,["accumulated"],["get",B]]:G;z.push(...Lc({key:`${c}.${B}.map`,value:W,expressionContext:"cluster-map"})),z.push(...Lc({key:`${c}.${B}.reduce`,value:K,expressionContext:"cluster-reduce"}))}return z;case"video":return va({key:c,value:o,valueSpec:g.source_video,style:x,validateSpec:T,styleSpec:g});case"image":return va({key:c,value:o,valueSpec:g.source_image,style:x,validateSpec:T,styleSpec:g});case"canvas":return[new bi(c,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Ju({key:`${c}.type`,value:o.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function td(h){const o=h.value,c=h.styleSpec,g=c.light,x=h.style;let T=[];const A=yn(o);if(o===void 0)return T;if(A!=="object")return T=T.concat([new bi("light",o,`object expected, ${A} found`)]),T;for(const z in o){const B=z.match(/^(.*)-transition$/);T=T.concat(B&&g[B[1]]&&g[B[1]].transition?h.validateSpec({key:z,value:o[z],valueSpec:c.transition,validateSpec:h.validateSpec,style:x,styleSpec:c}):g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],validateSpec:h.validateSpec,style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)])}return T}function nh(h){const o=h.value,c=h.styleSpec,g=c.sky,x=h.style,T=yn(o);if(o===void 0)return[];if(T!=="object")return[new bi("sky",o,`object expected, ${T} found`)];let A=[];for(const z in o)A=A.concat(g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)]);return A}function Vh(h){const o=h.value,c=h.styleSpec,g=c.terrain,x=h.style;let T=[];const A=yn(o);if(o===void 0)return T;if(A!=="object")return T=T.concat([new bi("terrain",o,`object expected, ${A} found`)]),T;for(const z in o)T=T.concat(g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],validateSpec:h.validateSpec,style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)]);return T}function pf(h){let o=[];const c=h.value,g=h.key;if(Array.isArray(c)){const x=[],T=[];for(const A in c)c[A].id&&x.includes(c[A].id)&&o.push(new bi(g,c,`all the sprites' ids must be unique, but ${c[A].id} is duplicated`)),x.push(c[A].id),c[A].url&&T.includes(c[A].url)&&o.push(new bi(g,c,`all the sprites' URLs must be unique, but ${c[A].url} is duplicated`)),T.push(c[A].url),o=o.concat(va({key:`${g}[${A}]`,value:c[A],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:h.validateSpec}));return o}return Rc({key:g,value:c})}function ed(h){return o=h.value,o&&o.constructor===Object?[]:[new bi(h.key,h.value,`object expected, ${yn(h.value)} found`)];var o}const Uh={"*":()=>[],array:Nh,boolean:function(h){const o=h.value,c=h.key,g=yn(o);return g!=="boolean"?[new bi(c,o,`boolean expected, ${g} found`)]:[]},number:rh,color:vp,constants:Fd,enum:Ju,filter:bp,function:Bd,layer:Hf,object:va,source:Nd,light:td,sky:nh,terrain:Vh,projection:function(h){const o=h.value,c=h.styleSpec,g=c.projection,x=h.style,T=yn(o);if(o===void 0)return[];if(T!=="object")return[new bi("projection",o,`object expected, ${T} found`)];let A=[];for(const z in o)A=A.concat(g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)]);return A},projectionDefinition:function(h){const o=h.key;let c=h.value;c=c instanceof String?c.valueOf():c;const g=yn(c);return g!=="array"||function(x){return Array.isArray(x)&&x.length===3&&typeof x[0]=="string"&&typeof x[1]=="string"&&typeof x[2]=="number"}(c)||function(x){return!!["interpolate","step","literal"].includes(x[0])}(c)?["array","string"].includes(g)?[]:[new bi(o,c,`projection expected, invalid type "${g}" found`)]:[new bi(o,c,`projection expected, invalid array ${JSON.stringify(c)} found`)]},string:Rc,formatted:function(h){return Rc(h).length===0?[]:Lc(h)},resolvedImage:function(h){return Rc(h).length===0?[]:Lc(h)},padding:function(h){const o=h.key,c=h.value;if(yn(c)==="array"){if(c.length<1||c.length>4)return[new bi(o,c,`padding requires 1 to 4 values; ${c.length} values found`)];const g={type:"number"};let x=[];for(let T=0;T<c.length;T++)x=x.concat(h.validateSpec({key:`${o}[${T}]`,value:c[T],validateSpec:h.validateSpec,valueSpec:g}));return x}return rh({key:o,value:c,valueSpec:{}})},numberArray:function(h){const o=h.key,c=h.value;if(yn(c)==="array"){const g={type:"number"};if(c.length<1)return[new bi(o,c,"array length at least 1 expected, length 0 found")];let x=[];for(let T=0;T<c.length;T++)x=x.concat(h.validateSpec({key:`${o}[${T}]`,value:c[T],validateSpec:h.validateSpec,valueSpec:g}));return x}return rh({key:o,value:c,valueSpec:{}})},colorArray:function(h){const o=h.key,c=h.value;if(yn(c)==="array"){if(c.length<1)return[new bi(o,c,"array length at least 1 expected, length 0 found")];let g=[];for(let x=0;x<c.length;x++)g=g.concat(vp({key:`${o}[${x}]`,value:c[x]}));return g}return vp({key:o,value:c})},variableAnchorOffsetCollection:function(h){const o=h.key,c=h.value,g=yn(c),x=h.styleSpec;if(g!=="array"||c.length<1||c.length%2!=0)return[new bi(o,c,"variableAnchorOffsetCollection requires a non-empty array of even length")];let T=[];for(let A=0;A<c.length;A+=2)T=T.concat(Ju({key:`${o}[${A}]`,value:c[A],valueSpec:x.layout_symbol["text-anchor"]})),T=T.concat(Nh({key:`${o}[${A+1}]`,value:c[A+1],valueSpec:{length:2,value:"number"},validateSpec:h.validateSpec,style:h.style,styleSpec:x}));return T},sprite:pf,state:ed};function _u(h){const o=h.value,c=h.valueSpec,g=h.styleSpec;return h.validateSpec=_u,c.expression&&Lh(Xo(o))?Bd(h):c.expression&&mp(ul(o))?Lc(h):c.type&&Uh[c.type]?Uh[c.type](h):va(Bo({},h,{valueSpec:c.type?g[c.type]:c}))}function dl(h){const o=h.value,c=h.key,g=Rc(h);return g.length||(o.indexOf("{fontstack}")===-1&&g.push(new bi(c,o,'"glyphs" url must include a "{fontstack}" token')),o.indexOf("{range}")===-1&&g.push(new bi(c,o,'"glyphs" url must include a "{range}" token'))),g}function pl(h,o=te){let c=[];return c=c.concat(_u({key:"",value:h,valueSpec:o.$root,styleSpec:o,style:h,validateSpec:_u,objectElementValidators:{glyphs:dl,"*":()=>[]}})),h.constants&&(c=c.concat(Fd({key:"constants",value:h.constants}))),kc(c)}function qs(h){return function(o){return h(Object.assign({},o,{validateSpec:_u}))}}function kc(h){return[].concat(h).sort((o,c)=>o.line-c.line)}function Yo(h){return function(...o){return kc(h.apply(this,o))}}pl.source=Yo(qs(Nd)),pl.sprite=Yo(qs(pf)),pl.glyphs=Yo(qs(dl)),pl.light=Yo(qs(td)),pl.sky=Yo(qs(nh)),pl.terrain=Yo(qs(Vh)),pl.state=Yo(qs(ed)),pl.layer=Yo(qs(Hf)),pl.filter=Yo(qs(bp)),pl.paintProperty=Yo(qs(df)),pl.layoutProperty=Yo(qs(Qu));const yu=te,oh=pl,Vd=oh.light,wp=oh.sky,Fc=oh.paintProperty,Ud=oh.layoutProperty;function xu(h,o){let c=!1;if(o&&o.length)for(const g of o)h.fire(new le(new Error(g.message))),c=!0;return c}class id{constructor(o,c,g){const x=this.cells=[];if(o instanceof ArrayBuffer){this.arrayBuffer=o;const A=new Int32Array(this.arrayBuffer);o=A[0],this.d=(c=A[1])+2*(g=A[2]);for(let B=0;B<this.d*this.d;B++){const G=A[3+B],W=A[3+B+1];x.push(G===W?null:A.subarray(G,W))}const z=A[3+x.length+1];this.keys=A.subarray(A[3+x.length],z),this.bboxes=A.subarray(z),this.insert=this._insertReadonly}else{this.d=c+2*g;for(let A=0;A<this.d*this.d;A++)x.push([]);this.keys=[],this.bboxes=[]}this.n=c,this.extent=o,this.padding=g,this.scale=c/o,this.uid=0;const T=g/c*o;this.min=-T,this.max=o+T}insert(o,c,g,x,T){this._forEachCell(c,g,x,T,this._insertCell,this.uid++,void 0,void 0),this.keys.push(o),this.bboxes.push(c),this.bboxes.push(g),this.bboxes.push(x),this.bboxes.push(T)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(o,c,g,x,T,A){this.cells[T].push(A)}query(o,c,g,x,T){const A=this.min,z=this.max;if(o<=A&&c<=A&&z<=g&&z<=x&&!T)return Array.prototype.slice.call(this.keys);{const B=[];return this._forEachCell(o,c,g,x,this._queryCell,B,{},T),B}}_queryCell(o,c,g,x,T,A,z,B){const G=this.cells[T];if(G!==null){const W=this.keys,K=this.bboxes;for(let ot=0;ot<G.length;ot++){const ct=G[ot];if(z[ct]===void 0){const dt=4*ct;(B?B(K[dt+0],K[dt+1],K[dt+2],K[dt+3]):o<=K[dt+2]&&c<=K[dt+3]&&g>=K[dt+0]&&x>=K[dt+1])?(z[ct]=!0,A.push(W[ct])):z[ct]=!1}}}}_forEachCell(o,c,g,x,T,A,z,B){const G=this._convertToCellCoord(o),W=this._convertToCellCoord(c),K=this._convertToCellCoord(g),ot=this._convertToCellCoord(x);for(let ct=G;ct<=K;ct++)for(let dt=W;dt<=ot;dt++){const xt=this.d*dt+ct;if((!B||B(this._convertFromCellCoord(ct),this._convertFromCellCoord(dt),this._convertFromCellCoord(ct+1),this._convertFromCellCoord(dt+1)))&&T.call(this,o,c,g,x,xt,A,z,B))return}}_convertFromCellCoord(o){return(o-this.padding)/this.scale}_convertToCellCoord(o){return Math.max(0,Math.min(this.d-1,Math.floor(o*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const o=this.cells,c=3+this.cells.length+1+1;let g=0;for(let A=0;A<this.cells.length;A++)g+=this.cells[A].length;const x=new Int32Array(c+g+this.keys.length+this.bboxes.length);x[0]=this.extent,x[1]=this.n,x[2]=this.padding;let T=c;for(let A=0;A<o.length;A++){const z=o[A];x[3+A]=T,x.set(z,T),T+=z.length}return x[3+o.length]=T,x.set(this.keys,T),T+=this.keys.length,x[3+o.length+1]=T,x.set(this.bboxes,T),T+=this.bboxes.length,x.buffer}static serialize(o,c){const g=o.toArrayBuffer();return c&&c.push(g),{buffer:g}}static deserialize(o){return new id(o.buffer)}}const Yl={};function Ki(h,o,c={}){if(Yl[h])throw new Error(`${h} is already registered.`);Object.defineProperty(o,"_classRegistryKey",{value:h,writeable:!1}),Yl[h]={klass:o,omit:c.omit||[],shallow:c.shallow||[]}}Ki("Object",Object),Ki("Set",Set),Ki("TransferableGridIndex",id),Ki("Color",tn),Ki("Error",Error),Ki("AJAXError",Aa),Ki("ResolvedImage",Rs),Ki("StylePropertyFunction",gp),Ki("StyleExpression",pu,{omit:["_evaluator"]}),Ki("ZoomDependentExpression",Xu),Ki("ZoomConstantExpression",Rh),Ki("CompoundExpression",aa,{omit:["_evaluate"]});for(const h in xa)xa[h]._classRegistryKey||Ki(`Expression_${h}`,xa[h]);function vu(h){return h&&typeof ArrayBuffer<"u"&&(h instanceof ArrayBuffer||h.constructor&&h.constructor.name==="ArrayBuffer")}function Tp(h){return h.$name||h.constructor._classRegistryKey}function Wf(h){return!function(o){if(o===null||typeof o!="object")return!1;const c=Tp(o);return!(!c||c==="Object")}(h)&&(h==null||typeof h=="boolean"||typeof h=="number"||typeof h=="string"||h instanceof Boolean||h instanceof Number||h instanceof String||h instanceof Date||h instanceof RegExp||h instanceof Blob||h instanceof Error||vu(h)||Zn(h)||ArrayBuffer.isView(h)||h instanceof ImageData)}function jd(h,o){if(Wf(h))return(vu(h)||Zn(h))&&o&&o.push(h),ArrayBuffer.isView(h)&&o&&o.push(h.buffer),h instanceof ImageData&&o&&o.push(h.data.buffer),h;if(Array.isArray(h)){const T=[];for(const A of h)T.push(jd(A,o));return T}if(typeof h!="object")throw new Error("can't serialize object of type "+typeof h);const c=Tp(h);if(!c)throw new Error(`can't serialize object of unregistered class ${h.constructor.name}`);if(!Yl[c])throw new Error(`${c} is not registered.`);const{klass:g}=Yl[c],x=g.serialize?g.serialize(h,o):{};if(g.serialize){if(o&&x===o[o.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const T in h){if(!h.hasOwnProperty(T)||Yl[c].omit.indexOf(T)>=0)continue;const A=h[T];x[T]=Yl[c].shallow.indexOf(T)>=0?A:jd(A,o)}h instanceof Error&&(x.message=h.message)}if(x.$name)throw new Error("$name property is reserved for worker serialization logic.");return c!=="Object"&&(x.$name=c),x}function sh(h){if(Wf(h))return h;if(Array.isArray(h))return h.map(sh);if(typeof h!="object")throw new Error("can't deserialize object of type "+typeof h);const o=Tp(h)||"Object";if(!Yl[o])throw new Error(`can't deserialize unregistered class ${o}`);const{klass:c}=Yl[o];if(!c)throw new Error(`can't deserialize unregistered class ${o}`);if(c.deserialize)return c.deserialize(h);const g=Object.create(c.prototype);for(const x of Object.keys(h)){if(x==="$name")continue;const T=h[x];g[x]=Yl[o].shallow.indexOf(x)>=0?T:sh(T)}return g}class rd{constructor(){this.first=!0}update(o,c){const g=Math.floor(o);return this.first?(this.first=!1,this.lastIntegerZoom=g,this.lastIntegerZoomTime=0,this.lastZoom=o,this.lastFloorZoom=g,!0):(this.lastFloorZoom>g?(this.lastIntegerZoom=g+1,this.lastIntegerZoomTime=c):this.lastFloorZoom<g&&(this.lastIntegerZoom=g,this.lastIntegerZoomTime=c),o!==this.lastZoom&&(this.lastZoom=o,this.lastFloorZoom=g,!0))}}function ff(h){return/[\u02EA\u02EB\u2E80-\u2FDF\u2FF0-\u303F\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FD-\u30FF\u3105-\u312F\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))}function jh(h){return/[\u02EA\u02EB\u1100-\u11FF\u1400-\u167F\u18B0-\u18F5\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u3007\u3012\u3013\u3020-\u302F\u3031-\u303F\u3041-\u3096\u309D-\u30FB\u30FD-\u30FF\u3105-\u312F\u3131-\u318E\u3190-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE48\uFE50-\uFE57\uFE5F-\uFE62\uFE67-\uFE6F\uFF00-\uFF07\uFF0A-\uFF0C\uFF0E-\uFF19\uFF1F-\uFF3A\uFF3C\uFF3E\uFF40-\uFF5A\uFFE0-\uFFE2\uFFE4-\uFFE7]|\uD802[\uDD80-\uDD9F]|\uD805[\uDD80-\uDDFF]|\uD806[\uDE00-\uDEBF]|\uD811[\uDC00-\uDE7F]|\uD81B[\uDFE0-\uDFE4\uDFF0-\uDFF6]|[\uD81C-\uD822\uD83D\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD30-\uDEFB]|\uD833[\uDEC0-\uDFCF]|\uD834[\uDC00-\uDDFF\uDEE0-\uDF7F]|\uD836[\uDC00-\uDEAF]|\uD83C[\uDC00-\uDE00\uDF00-\uDFFF]|\uD83E[\uDD00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))}function mf(h){return/\s/u.test(String.fromCodePoint(h))}function Bc(h){for(const o of h)if(jh(o.codePointAt(0)))return!0;return!1}function nd(h){for(const o of h)if(!Gd(o.codePointAt(0)))return!1;return!0}function Sp(h){const o=h.map(c=>{try{return new RegExp(`\\p{sc=${c}}`,"u").source}catch{return null}}).filter(c=>c);return new RegExp(o.join("|"),"u")}const gf=Sp(["Arab","Dupl","Mong","Ougr","Syrc"]);function Gd(h){return!gf.test(String.fromCodePoint(h))}function dc(h){return!(jh(h)||(o=h,/[\xA7\xA9\xAE\xB1\xBC-\xBE\xD7\xF7\u2016\u2020\u2021\u2030\u2031\u203B\u203C\u2042\u2047-\u2049\u2051\u2100-\u218F\u221E\u2234\u2235\u2300-\u2307\u230C-\u231F\u2324-\u2328\u232B\u237D-\u239A\u23BE-\u23CD\u23CF\u23D1-\u23DB\u23E2-\u2422\u2424-\u24FF\u25A0-\u2619\u2620-\u2767\u2776-\u2793\u2B12-\u2B2F\u2B50-\u2B59\u2BB8-\u2BEB\u3000-\u303F\u30A0-\u30FF\uE000-\uF8FF\uFE30-\uFE6F\uFF00-\uFFEF\uFFFC\uFFFD]|[\uDB80-\uDBFF][\uDC00-\uDFFF]/gim.test(String.fromCodePoint(o))));var o}const bu=Sp(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function od(h){return bu.test(String.fromCodePoint(h))}function wu(h,o){return!(!o&&od(h)||/[\u0900-\u0DFF\u0F00-\u109F\u1780-\u17FF]/gim.test(String.fromCodePoint(h)))}function ah(h){for(const o of h)if(od(o.codePointAt(0)))return!0;return!1}const Oc=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(h){this.pluginStatus=h.pluginStatus,this.pluginURL=h.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(h){if(Oc.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=h.applyArabicShaping,this.processBidirectionalText=h.processBidirectionalText,this.processStyledBidirectionalText=h.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(h,o){return i(this,void 0,void 0,function*(){if(this.isParsed())return this.getState();if(h.pluginStatus!=="loading")return this.setState(h),h;const c=h.pluginURL,g=new Promise(T=>{this.loadScriptResolve=T});o(c);const x=new Promise(T=>setTimeout(()=>T(),this.TIMEOUT));if(yield Promise.race([g,x]),this.isParsed()){const T={pluginStatus:"loaded",pluginURL:c};return this.setState(T),T}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${c}`)})}};class uo{constructor(o,c){this.isSupportedScript=_f,this.zoom=o,c?(this.now=c.now||0,this.fadeDuration=c.fadeDuration||0,this.zoomHistory=c.zoomHistory||new rd,this.transition=c.transition||{}):(this.now=0,this.fadeDuration=0,this.zoomHistory=new rd,this.transition={})}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const o=this.zoom,c=o-Math.floor(o),g=this.crossFadingFactor();return o>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:c+(1-c)*g}:{fromScale:.5,toScale:1,t:1-(1-g)*c}}}function _f(h){return function(o,c){for(const g of o)if(!wu(g.codePointAt(0),c))return!1;return!0}(h,Oc.getRTLTextPluginStatus()==="loaded")}const Tu="-transition";class Gh{constructor(o,c,g){this.property=o,this.value=c,this.expression=function(x,T,A){if(Lh(x))return new gp(x,T);if(mp(x)){const z=qf(x,T,A);if(z.result==="error")throw new Error(z.value.map(B=>`${B.key}: ${B.message}`).join(", "));return z.value}{let z=x;return T.type==="color"&&typeof x=="string"?z=tn.parse(x):T.type!=="padding"||typeof x!="number"&&!Array.isArray(x)?T.type!=="numberArray"||typeof x!="number"&&!Array.isArray(x)?T.type!=="colorArray"||typeof x!="string"&&!Array.isArray(x)?T.type==="variableAnchorOffsetCollection"&&Array.isArray(x)?z=Is.parse(x):T.type==="projectionDefinition"&&typeof x=="string"&&(z=ra.parse(x)):z=Ls.parse(x):z=ia.parse(x):z=as.parse(x),{globalStateRefs:new Set,_globalState:null,kind:"constant",evaluate:()=>z}}}(c===void 0?o.specification.default:c,o.specification,g)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}getGlobalStateRefs(){return this.expression.globalStateRefs||new Set}possiblyEvaluate(o,c,g){return this.property.possiblyEvaluate(this,o,c,g)}}class sd{constructor(o,c){this.property=o,this.value=new Gh(o,void 0,c)}transitioned(o,c){return new ad(this.property,this.value,c,Wo({},o.transition,this.transition),o.now)}untransitioned(){return new ad(this.property,this.value,null,{},0)}}class Ip{constructor(o,c){this._properties=o,this._values=Object.create(o.defaultTransitionablePropertyValues),this._globalState=c}getValue(o){return ma(this._values[o].value.value)}setValue(o,c){Object.prototype.hasOwnProperty.call(this._values,o)||(this._values[o]=new sd(this._values[o].property,this._globalState)),this._values[o].value=new Gh(this._values[o].property,c===null?void 0:ma(c),this._globalState)}getTransition(o){return ma(this._values[o].transition)}setTransition(o,c){Object.prototype.hasOwnProperty.call(this._values,o)||(this._values[o]=new sd(this._values[o].property,this._globalState)),this._values[o].transition=ma(c)||void 0}serialize(){const o={};for(const c of Object.keys(this._values)){const g=this.getValue(c);g!==void 0&&(o[c]=g);const x=this.getTransition(c);x!==void 0&&(o[`${c}${Tu}`]=x)}return o}transitioned(o,c){const g=new $h(this._properties);for(const x of Object.keys(this._values))g._values[x]=this._values[x].transitioned(o,c._values[x]);return g}untransitioned(){const o=new $h(this._properties);for(const c of Object.keys(this._values))o._values[c]=this._values[c].untransitioned();return o}}class ad{constructor(o,c,g,x,T){this.property=o,this.value=c,this.begin=T+x.delay||0,this.end=this.begin+x.duration||0,o.specification.transition&&(x.delay||x.duration)&&(this.prior=g)}possiblyEvaluate(o,c,g){const x=o.now||0,T=this.value.possiblyEvaluate(o,c,g),A=this.prior;if(A){if(x>this.end)return this.prior=null,T;if(this.value.isDataDriven())return this.prior=null,T;if(x<this.begin)return A.possiblyEvaluate(o,c,g);{const z=(x-this.begin)/(this.end-this.begin);return this.property.interpolate(A.possiblyEvaluate(o,c,g),T,Jn(z))}}return T}}class $h{constructor(o){this._properties=o,this._values=Object.create(o.defaultTransitioningPropertyValues)}possiblyEvaluate(o,c,g){const x=new qh(this._properties);for(const T of Object.keys(this._values))x._values[T]=this._values[T].possiblyEvaluate(o,c,g);return x}hasTransition(){for(const o of Object.keys(this._values))if(this._values[o].prior)return!0;return!1}}class Xf{constructor(o,c){this._properties=o,this._values=Object.create(o.defaultPropertyValues),this._globalState=c}hasValue(o){return this._values[o].value!==void 0}getValue(o){return ma(this._values[o].value)}setValue(o,c){this._values[o]=new Gh(this._values[o].property,c===null?void 0:ma(c),this._globalState)}serialize(){const o={};for(const c of Object.keys(this._values)){const g=this.getValue(c);g!==void 0&&(o[c]=g)}return o}possiblyEvaluate(o,c,g){const x=new qh(this._properties);for(const T of Object.keys(this._values))x._values[T]=this._values[T].possiblyEvaluate(o,c,g);return x}}class la{constructor(o,c,g){this.property=o,this.value=c,this.parameters=g}isConstant(){return this.value.kind==="constant"}constantOr(o){return this.value.kind==="constant"?this.value.value:o}evaluate(o,c,g,x){return this.property.evaluate(this.value,this.parameters,o,c,g,x)}}class qh{constructor(o){this._properties=o,this._values=Object.create(o.defaultPossiblyEvaluatedValues)}get(o){return this._values[o]}}class xr{constructor(o){this.specification=o}possiblyEvaluate(o,c){if(o.isDataDriven())throw new Error("Value should not be data driven");return o.expression.evaluate(c)}interpolate(o,c,g){const x=Za[this.specification.type];return x?x(o,c,g):o}}class zr{constructor(o,c){this.specification=o,this.overrides=c}possiblyEvaluate(o,c,g,x){return new la(this,o.expression.kind==="constant"||o.expression.kind==="camera"?{kind:"constant",value:o.expression.evaluate(c,null,{},g,x)}:o.expression,c)}interpolate(o,c,g){if(o.value.kind!=="constant"||c.value.kind!=="constant")return o;if(o.value.value===void 0||c.value.value===void 0)return new la(this,{kind:"constant",value:void 0},o.parameters);const x=Za[this.specification.type];if(x){const T=x(o.value.value,c.value.value,g);return new la(this,{kind:"constant",value:T},o.parameters)}return o}evaluate(o,c,g,x,T,A){return o.kind==="constant"?o.value:o.evaluate(c,g,x,T,A)}}class Zh extends zr{possiblyEvaluate(o,c,g,x){if(o.value===void 0)return new la(this,{kind:"constant",value:void 0},c);if(o.expression.kind==="constant"){const T=o.expression.evaluate(c,null,{},g,x),A=o.property.specification.type==="resolvedImage"&&typeof T!="string"?T.name:T,z=this._calculate(A,A,A,c);return new la(this,{kind:"constant",value:z},c)}if(o.expression.kind==="camera"){const T=this._calculate(o.expression.evaluate({zoom:c.zoom-1}),o.expression.evaluate({zoom:c.zoom}),o.expression.evaluate({zoom:c.zoom+1}),c);return new la(this,{kind:"constant",value:T},c)}return new la(this,o.expression,c)}evaluate(o,c,g,x,T,A){if(o.kind==="source"){const z=o.evaluate(c,g,x,T,A);return this._calculate(z,z,z,c)}return o.kind==="composite"?this._calculate(o.evaluate({zoom:Math.floor(c.zoom)-1},g,x),o.evaluate({zoom:Math.floor(c.zoom)},g,x),o.evaluate({zoom:Math.floor(c.zoom)+1},g,x),c):o.value}_calculate(o,c,g,x){return x.zoom>x.zoomHistory.lastIntegerZoom?{from:o,to:c}:{from:g,to:c}}interpolate(o){return o}}class pc{constructor(o){this.specification=o}possiblyEvaluate(o,c,g,x){if(o.value!==void 0){if(o.expression.kind==="constant"){const T=o.expression.evaluate(c,null,{},g,x);return this._calculate(T,T,T,c)}return this._calculate(o.expression.evaluate(new uo(Math.floor(c.zoom-1),c)),o.expression.evaluate(new uo(Math.floor(c.zoom),c)),o.expression.evaluate(new uo(Math.floor(c.zoom+1),c)),c)}}_calculate(o,c,g,x){return x.zoom>x.zoomHistory.lastIntegerZoom?{from:o,to:c}:{from:g,to:c}}interpolate(o){return o}}class lh{constructor(o){this.specification=o}possiblyEvaluate(o,c,g,x){return!!o.expression.evaluate(c,null,{},g,x)}interpolate(){return!1}}class cs{constructor(o){this.properties=o,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const c in o){const g=o[c];g.specification.overridable&&this.overridableProperties.push(c);const x=this.defaultPropertyValues[c]=new Gh(g,void 0,void 0),T=this.defaultTransitionablePropertyValues[c]=new sd(g,void 0);this.defaultTransitioningPropertyValues[c]=T.untransitioned(),this.defaultPossiblyEvaluatedValues[c]=x.possiblyEvaluate({})}}}Ki("DataDrivenProperty",zr),Ki("DataConstantProperty",xr),Ki("CrossFadedDataDrivenProperty",Zh),Ki("CrossFadedProperty",pc),Ki("ColorRampProperty",lh);class fl extends Re{constructor(o,c,g){if(super(),this.id=o.id,this.type=o.type,this._globalState=g,this._featureFilter={filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set},o.type!=="custom"&&(this.metadata=o.metadata,this.minzoom=o.minzoom,this.maxzoom=o.maxzoom,o.type!=="background"&&(this.source=o.source,this.sourceLayer=o["source-layer"],this.filter=o.filter,this._featureFilter=Rd(o.filter,g)),c.layout&&(this._unevaluatedLayout=new Xf(c.layout,g)),c.paint)){this._transitionablePaint=new Ip(c.paint,g);for(const x in o.paint)this.setPaintProperty(x,o.paint[x],{validate:!1});for(const x in o.layout)this.setLayoutProperty(x,o.layout[x],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new qh(c.paint)}}setFilter(o){this.filter=o,this._featureFilter=Rd(o,this._globalState)}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(o){return o==="visibility"?this.visibility:this._unevaluatedLayout.getValue(o)}getLayoutAffectingGlobalStateRefs(){const o=new Set;if(this._unevaluatedLayout)for(const c in this._unevaluatedLayout._values){const g=this._unevaluatedLayout._values[c];for(const x of g.getGlobalStateRefs())o.add(x)}for(const c of this._featureFilter.getGlobalStateRefs())o.add(c);return o}getPaintAffectingGlobalStateRefs(){var o;const c=new globalThis.Map;if(this._transitionablePaint)for(const g in this._transitionablePaint._values){const x=this._transitionablePaint._values[g].value;for(const T of x.getGlobalStateRefs()){const A=(o=c.get(T))!==null&&o!==void 0?o:[];A.push({name:g,value:x.value}),c.set(T,A)}}return c}setLayoutProperty(o,c,g={}){c!=null&&this._validate(Ud,`layers.${this.id}.layout.${o}`,o,c,g)||(o!=="visibility"?this._unevaluatedLayout.setValue(o,c):this.visibility=c)}getPaintProperty(o){return o.endsWith(Tu)?this._transitionablePaint.getTransition(o.slice(0,-11)):this._transitionablePaint.getValue(o)}setPaintProperty(o,c,g={}){if(c!=null&&this._validate(Fc,`layers.${this.id}.paint.${o}`,o,c,g))return!1;if(o.endsWith(Tu))return this._transitionablePaint.setTransition(o.slice(0,-11),c||void 0),!1;{const x=this._transitionablePaint._values[o],T=x.property.specification["property-type"]==="cross-faded-data-driven",A=x.value.isDataDriven(),z=x.value;this._transitionablePaint.setValue(o,c),this._handleSpecialPaintPropertyUpdate(o);const B=this._transitionablePaint._values[o].value;return B.isDataDriven()||A||T||this._handleOverridablePaintPropertyUpdate(o,z,B)}}_handleSpecialPaintPropertyUpdate(o){}_handleOverridablePaintPropertyUpdate(o,c,g){return!1}isHidden(o,c=!1){return!!(this.minzoom&&o<(c?Math.floor(this.minzoom):this.minzoom))||!!(this.maxzoom&&o>=this.maxzoom)||this.visibility==="none"}updateTransitions(o){this._transitioningPaint=this._transitionablePaint.transitioned(o,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(o,c){o.getCrossfadeParameters&&(this._crossfadeParameters=o.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(o,void 0,c)),this.paint=this._transitioningPaint.possiblyEvaluate(o,void 0,c)}serialize(){const o={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(o.layout=o.layout||{},o.layout.visibility=this.visibility),qo(o,(c,g)=>!(c===void 0||g==="layout"&&!Object.keys(c).length||g==="paint"&&!Object.keys(c).length))}_validate(o,c,g,x,T={}){return(!T||T.validate!==!1)&&xu(this,o.call(oh,{key:c,layerType:this.type,objectKey:g,value:x,styleSpec:te,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const o in this.paint._values){const c=this.paint.get(o);if(c instanceof la&&Dh(c.property.specification)&&(c.value.kind==="source"||c.value.kind==="composite")&&c.value.isStateDependent)return!0}return!1}}let $d;var Ep={get paint(){return $d=$d||new cs({"raster-opacity":new xr(te.paint_raster["raster-opacity"]),"raster-hue-rotate":new xr(te.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new xr(te.paint_raster["raster-brightness-min"]),"raster-brightness-max":new xr(te.paint_raster["raster-brightness-max"]),"raster-saturation":new xr(te.paint_raster["raster-saturation"]),"raster-contrast":new xr(te.paint_raster["raster-contrast"]),"raster-resampling":new xr(te.paint_raster["raster-resampling"]),"raster-fade-duration":new xr(te.paint_raster["raster-fade-duration"])})}};class qd extends fl{constructor(o,c){super(o,Ep,c)}}const Ap={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ld{constructor(o,c){this._structArray=o,this._pos1=c*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class to{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(o,c){return o._trim(),c&&(o.isTransferred=!0,c.push(o.arrayBuffer)),{length:o.length,arrayBuffer:o.arrayBuffer}}static deserialize(o){const c=Object.create(this.prototype);return c.arrayBuffer=o.arrayBuffer,c.length=o.length,c.capacity=o.arrayBuffer.byteLength/c.bytesPerElement,c._refreshViews(),c}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(o){this.reserve(o),this.length=o}reserve(o){if(o>this.capacity){this.capacity=Math.max(o,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const c=this.uint8;this._refreshViews(),c&&this.uint8.set(c)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Go(h,o=1){let c=0,g=0;return{members:h.map(x=>{const T=Ap[x.type].BYTES_PER_ELEMENT,A=c=Si(c,Math.max(o,T)),z=x.components||1;return g=Math.max(g,T),c+=T*z,{name:x.name,type:x.type,components:z,offset:A}}),size:Si(c,Math.max(g,o)),alignment:o}}function Si(h,o){return Math.ceil(h/o)*o}class Su extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c){const g=this.length;return this.resize(g+1),this.emplace(g,o,c)}emplace(o,c,g){const x=2*o;return this.int16[x+0]=c,this.int16[x+1]=g,o}}Su.prototype.bytesPerElement=4,Ki("StructArrayLayout2i4",Su);class zl extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.int16[T+0]=c,this.int16[T+1]=g,this.int16[T+2]=x,o}}zl.prototype.bytesPerElement=6,Ki("StructArrayLayout3i6",zl);class Nc extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x){const T=this.length;return this.resize(T+1),this.emplace(T,o,c,g,x)}emplace(o,c,g,x,T){const A=4*o;return this.int16[A+0]=c,this.int16[A+1]=g,this.int16[A+2]=x,this.int16[A+3]=T,o}}Nc.prototype.bytesPerElement=8,Ki("StructArrayLayout4i8",Nc);class Vc extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=6*o;return this.int16[B+0]=c,this.int16[B+1]=g,this.int16[B+2]=x,this.int16[B+3]=T,this.int16[B+4]=A,this.int16[B+5]=z,o}}Vc.prototype.bytesPerElement=12,Ki("StructArrayLayout2i4i12",Vc);class $i extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=4*o,G=8*o;return this.int16[B+0]=c,this.int16[B+1]=g,this.uint8[G+4]=x,this.uint8[G+5]=T,this.uint8[G+6]=A,this.uint8[G+7]=z,o}}$i.prototype.bytesPerElement=8,Ki("StructArrayLayout2i4ub8",$i);class Hh extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c){const g=this.length;return this.resize(g+1),this.emplace(g,o,c)}emplace(o,c,g){const x=2*o;return this.float32[x+0]=c,this.float32[x+1]=g,o}}Hh.prototype.bytesPerElement=8,Ki("StructArrayLayout2f8",Hh);class cd extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W){const K=this.length;return this.resize(K+1),this.emplace(K,o,c,g,x,T,A,z,B,G,W)}emplace(o,c,g,x,T,A,z,B,G,W,K){const ot=10*o;return this.uint16[ot+0]=c,this.uint16[ot+1]=g,this.uint16[ot+2]=x,this.uint16[ot+3]=T,this.uint16[ot+4]=A,this.uint16[ot+5]=z,this.uint16[ot+6]=B,this.uint16[ot+7]=G,this.uint16[ot+8]=W,this.uint16[ot+9]=K,o}}cd.prototype.bytesPerElement=20,Ki("StructArrayLayout10ui20",cd);class Iu extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B){const G=this.length;return this.resize(G+1),this.emplace(G,o,c,g,x,T,A,z,B)}emplace(o,c,g,x,T,A,z,B,G){const W=8*o;return this.uint16[W+0]=c,this.uint16[W+1]=g,this.uint16[W+2]=x,this.uint16[W+3]=T,this.uint16[W+4]=A,this.uint16[W+5]=z,this.uint16[W+6]=B,this.uint16[W+7]=G,o}}Iu.prototype.bytesPerElement=16,Ki("StructArrayLayout8ui16",Iu);class Wh extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W,K,ot){const ct=this.length;return this.resize(ct+1),this.emplace(ct,o,c,g,x,T,A,z,B,G,W,K,ot)}emplace(o,c,g,x,T,A,z,B,G,W,K,ot,ct){const dt=12*o;return this.int16[dt+0]=c,this.int16[dt+1]=g,this.int16[dt+2]=x,this.int16[dt+3]=T,this.uint16[dt+4]=A,this.uint16[dt+5]=z,this.uint16[dt+6]=B,this.uint16[dt+7]=G,this.int16[dt+8]=W,this.int16[dt+9]=K,this.int16[dt+10]=ot,this.int16[dt+11]=ct,o}}Wh.prototype.bytesPerElement=24,Ki("StructArrayLayout4i4ui4i24",Wh);class Zd extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.float32[T+0]=c,this.float32[T+1]=g,this.float32[T+2]=x,o}}Zd.prototype.bytesPerElement=12,Ki("StructArrayLayout3f12",Zd);class Xh extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(o){const c=this.length;return this.resize(c+1),this.emplace(c,o)}emplace(o,c){return this.uint32[1*o+0]=c,o}}Xh.prototype.bytesPerElement=4,Ki("StructArrayLayout1ul4",Xh);class Yh extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G){const W=this.length;return this.resize(W+1),this.emplace(W,o,c,g,x,T,A,z,B,G)}emplace(o,c,g,x,T,A,z,B,G,W){const K=10*o,ot=5*o;return this.int16[K+0]=c,this.int16[K+1]=g,this.int16[K+2]=x,this.int16[K+3]=T,this.int16[K+4]=A,this.int16[K+5]=z,this.uint32[ot+3]=B,this.uint16[K+8]=G,this.uint16[K+9]=W,o}}Yh.prototype.bytesPerElement=20,Ki("StructArrayLayout6i1ul2ui20",Yh);class yf extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=6*o;return this.int16[B+0]=c,this.int16[B+1]=g,this.int16[B+2]=x,this.int16[B+3]=T,this.int16[B+4]=A,this.int16[B+5]=z,o}}yf.prototype.bytesPerElement=12,Ki("StructArrayLayout2i2i2i12",yf);class Pp extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T){const A=this.length;return this.resize(A+1),this.emplace(A,o,c,g,x,T)}emplace(o,c,g,x,T,A){const z=4*o,B=8*o;return this.float32[z+0]=c,this.float32[z+1]=g,this.float32[z+2]=x,this.int16[B+6]=T,this.int16[B+7]=A,o}}Pp.prototype.bytesPerElement=16,Ki("StructArrayLayout2f1f2i16",Pp);class ks extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=16*o,G=4*o,W=8*o;return this.uint8[B+0]=c,this.uint8[B+1]=g,this.float32[G+1]=x,this.float32[G+2]=T,this.int16[W+6]=A,this.int16[W+7]=z,o}}ks.prototype.bytesPerElement=16,Ki("StructArrayLayout2ub2f2i16",ks);class hd extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.uint16[T+0]=c,this.uint16[T+1]=g,this.uint16[T+2]=x,o}}hd.prototype.bytesPerElement=6,Ki("StructArrayLayout3ui6",hd);class ca extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt,xt,At,jt){const ue=this.length;return this.resize(ue+1),this.emplace(ue,o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt,xt,At,jt)}emplace(o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt,xt,At,jt,ue){const Qt=24*o,ie=12*o,Se=48*o;return this.int16[Qt+0]=c,this.int16[Qt+1]=g,this.uint16[Qt+2]=x,this.uint16[Qt+3]=T,this.uint32[ie+2]=A,this.uint32[ie+3]=z,this.uint32[ie+4]=B,this.uint16[Qt+10]=G,this.uint16[Qt+11]=W,this.uint16[Qt+12]=K,this.float32[ie+7]=ot,this.float32[ie+8]=ct,this.uint8[Se+36]=dt,this.uint8[Se+37]=xt,this.uint8[Se+38]=At,this.uint32[ie+10]=jt,this.int16[Qt+22]=ue,o}}ca.prototype.bytesPerElement=48,Ki("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",ca);class fc extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt,xt,At,jt,ue,Qt,ie,Se,Ee,ei,Ai,mi,Ei,Hi,Ui){const ji=this.length;return this.resize(ji+1),this.emplace(ji,o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt,xt,At,jt,ue,Qt,ie,Se,Ee,ei,Ai,mi,Ei,Hi,Ui)}emplace(o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt,xt,At,jt,ue,Qt,ie,Se,Ee,ei,Ai,mi,Ei,Hi,Ui,ji){const gi=32*o,Ar=16*o;return this.int16[gi+0]=c,this.int16[gi+1]=g,this.int16[gi+2]=x,this.int16[gi+3]=T,this.int16[gi+4]=A,this.int16[gi+5]=z,this.int16[gi+6]=B,this.int16[gi+7]=G,this.uint16[gi+8]=W,this.uint16[gi+9]=K,this.uint16[gi+10]=ot,this.uint16[gi+11]=ct,this.uint16[gi+12]=dt,this.uint16[gi+13]=xt,this.uint16[gi+14]=At,this.uint16[gi+15]=jt,this.uint16[gi+16]=ue,this.uint16[gi+17]=Qt,this.uint16[gi+18]=ie,this.uint16[gi+19]=Se,this.uint16[gi+20]=Ee,this.uint16[gi+21]=ei,this.uint16[gi+22]=Ai,this.uint32[Ar+12]=mi,this.float32[Ar+13]=Ei,this.float32[Ar+14]=Hi,this.uint16[gi+30]=Ui,this.uint16[gi+31]=ji,o}}fc.prototype.bytesPerElement=64,Ki("StructArrayLayout8i15ui1ul2f2ui64",fc);class Hd extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o){const c=this.length;return this.resize(c+1),this.emplace(c,o)}emplace(o,c){return this.float32[1*o+0]=c,o}}Hd.prototype.bytesPerElement=4,Ki("StructArrayLayout1f4",Hd);class C extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.uint16[6*o+0]=c,this.float32[T+1]=g,this.float32[T+2]=x,o}}C.prototype.bytesPerElement=12,Ki("StructArrayLayout1ui2f12",C);class s extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=4*o;return this.uint32[2*o+0]=c,this.uint16[T+2]=g,this.uint16[T+3]=x,o}}s.prototype.bytesPerElement=8,Ki("StructArrayLayout1ul2ui8",s);class d extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c){const g=this.length;return this.resize(g+1),this.emplace(g,o,c)}emplace(o,c,g){const x=2*o;return this.uint16[x+0]=c,this.uint16[x+1]=g,o}}d.prototype.bytesPerElement=4,Ki("StructArrayLayout2ui4",d);class v extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o){const c=this.length;return this.resize(c+1),this.emplace(c,o)}emplace(o,c){return this.uint16[1*o+0]=c,o}}v.prototype.bytesPerElement=2,Ki("StructArrayLayout1ui2",v);class S extends to{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g,x){const T=this.length;return this.resize(T+1),this.emplace(T,o,c,g,x)}emplace(o,c,g,x,T){const A=4*o;return this.float32[A+0]=c,this.float32[A+1]=g,this.float32[A+2]=x,this.float32[A+3]=T,o}}S.prototype.bytesPerElement=16,Ki("StructArrayLayout4f16",S);class D extends ld{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Pe(this.anchorPointX,this.anchorPointY)}}D.prototype.size=20;class k extends Yh{get(o){return new D(this,o)}}Ki("CollisionBoxArray",k);class j extends ld{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(o){this._structArray.uint8[this._pos1+37]=o}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(o){this._structArray.uint8[this._pos1+38]=o}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(o){this._structArray.uint32[this._pos4+10]=o}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}j.prototype.size=48;class H extends ca{get(o){return new j(this,o)}}Ki("PlacedSymbolArray",H);class J extends ld{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(o){this._structArray.uint32[this._pos4+12]=o}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}J.prototype.size=64;class et extends fc{get(o){return new J(this,o)}}Ki("SymbolInstanceArray",et);class mt extends Hd{getoffsetX(o){return this.float32[1*o+0]}}Ki("GlyphOffsetArray",mt);class ut extends zl{getx(o){return this.int16[3*o+0]}gety(o){return this.int16[3*o+1]}gettileUnitDistanceFromAnchor(o){return this.int16[3*o+2]}}Ki("SymbolLineVertexArray",ut);class St extends ld{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}St.prototype.size=12;class pt extends C{get(o){return new St(this,o)}}Ki("TextAnchorOffsetArray",pt);class Et extends ld{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}Et.prototype.size=8;class Kt extends s{get(o){return new Et(this,o)}}Ki("FeatureIndexArray",Kt);class Xt extends Su{}class ft extends Su{}class _e extends Su{}class ce extends Vc{}class me extends $i{}class be extends Hh{}class de extends cd{}class De extends Iu{}class Qe extends Wh{}class Xe extends Zd{}class Je extends Xh{}class ii extends yf{}class Di extends ks{}class Fi extends hd{}class wi extends d{}const fr=Go([{name:"a_pos",components:2,type:"Int16"}],4),{members:$r}=fr;class Nr{constructor(o=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=o}prepareSegment(o,c,g,x){const T=this.segments[this.segments.length-1];return o>Nr.MAX_VERTEX_ARRAY_LENGTH&&vo(`Max vertices per segment is ${Nr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${o}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${Nr.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!T||T.vertexLength+o>Nr.MAX_VERTEX_ARRAY_LENGTH||T.sortKey!==x?this.createNewSegment(c,g,x):T}createNewSegment(o,c,g){const x={vertexOffset:o.length,primitiveOffset:c.length,vertexLength:0,primitiveLength:0,vaos:{}};return g!==void 0&&(x.sortKey=g),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(x),x}getOrCreateLatestSegment(o,c,g){return this.prepareSegment(0,o,c,g)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const o of this.segments)for(const c in o.vaos)o.vaos[c].destroy()}static simpleSegment(o,c,g,x){return new Nr([{vertexOffset:o,primitiveOffset:c,vertexLength:g,primitiveLength:x,vaos:{},sortKey:0}])}}function co(h,o){return 256*(h=Qs(Math.floor(h),0,255))+Qs(Math.floor(o),0,255)}Nr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ki("SegmentVector",Nr);const No=Go([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]),Jo=Go([{name:"a_dasharray_from",components:4,type:"Uint16"},{name:"a_dasharray_to",components:4,type:"Uint16"}]);var Vo,Es,Ko,$n={exports:{}},_s={exports:{}},Qo={exports:{}},Jr=function(){if(Ko)return $n.exports;Ko=1;var h=(Vo||(Vo=1,_s.exports=function(c,g){var x,T,A,z,B,G,W,K;for(T=c.length-(x=3&c.length),A=g,B=3432918353,G=461845907,K=0;K<T;)W=255&c.charCodeAt(K)|(255&c.charCodeAt(++K))<<8|(255&c.charCodeAt(++K))<<16|(255&c.charCodeAt(++K))<<24,++K,A=27492+(65535&(z=5*(65535&(A=(A^=W=(65535&(W=(W=(65535&W)*B+(((W>>>16)*B&65535)<<16)&4294967295)<<15|W>>>17))*G+(((W>>>16)*G&65535)<<16)&4294967295)<<13|A>>>19))+((5*(A>>>16)&65535)<<16)&4294967295))+((58964+(z>>>16)&65535)<<16);switch(W=0,x){case 3:W^=(255&c.charCodeAt(K+2))<<16;case 2:W^=(255&c.charCodeAt(K+1))<<8;case 1:A^=W=(65535&(W=(W=(65535&(W^=255&c.charCodeAt(K)))*B+(((W>>>16)*B&65535)<<16)&4294967295)<<15|W>>>17))*G+(((W>>>16)*G&65535)<<16)&4294967295}return A^=c.length,A=2246822507*(65535&(A^=A>>>16))+((2246822507*(A>>>16)&65535)<<16)&4294967295,A=3266489909*(65535&(A^=A>>>13))+((3266489909*(A>>>16)&65535)<<16)&4294967295,(A^=A>>>16)>>>0}),_s.exports),o=(Es||(Es=1,Qo.exports=function(c,g){for(var x,T=c.length,A=g^T,z=0;T>=4;)x=1540483477*(65535&(x=255&c.charCodeAt(z)|(255&c.charCodeAt(++z))<<8|(255&c.charCodeAt(++z))<<16|(255&c.charCodeAt(++z))<<24))+((1540483477*(x>>>16)&65535)<<16),A=1540483477*(65535&A)+((1540483477*(A>>>16)&65535)<<16)^(x=1540483477*(65535&(x^=x>>>24))+((1540483477*(x>>>16)&65535)<<16)),T-=4,++z;switch(T){case 3:A^=(255&c.charCodeAt(z+2))<<16;case 2:A^=(255&c.charCodeAt(z+1))<<8;case 1:A=1540483477*(65535&(A^=255&c.charCodeAt(z)))+((1540483477*(A>>>16)&65535)<<16)}return A=1540483477*(65535&(A^=A>>>13))+((1540483477*(A>>>16)&65535)<<16),(A^=A>>>15)>>>0}),Qo.exports);return $n.exports=h,$n.exports.murmur3=h,$n.exports.murmur2=o,$n.exports}(),vr=yi(Jr);class Jl{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(o,c,g,x){this.ids.push(ys(o)),this.positions.push(c,g,x)}getPositions(o){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const c=ys(o);let g=0,x=this.ids.length-1;for(;g<x;){const A=g+x>>1;this.ids[A]>=c?x=A:g=A+1}const T=[];for(;this.ids[g]===c;)T.push({index:this.positions[3*g],start:this.positions[3*g+1],end:this.positions[3*g+2]}),g++;return T}static serialize(o,c){const g=new Float64Array(o.ids),x=new Uint32Array(o.positions);return ml(g,x,0,g.length-1),c&&c.push(g.buffer,x.buffer),{ids:g,positions:x}}static deserialize(o){const c=new Jl;return c.ids=o.ids,c.positions=o.positions,c.indexed=!0,c}}function ys(h){const o=+h;return!isNaN(o)&&o<=Number.MAX_SAFE_INTEGER?o:vr(String(h))}function ml(h,o,c,g){for(;c<g;){const x=h[c+g>>1];let T=c-1,A=g+1;for(;;){do T++;while(h[T]<x);do A--;while(h[A]>x);if(T>=A)break;Kl(h,T,A),Kl(o,3*T,3*A),Kl(o,3*T+1,3*A+1),Kl(o,3*T+2,3*A+2)}A-c<g-A?(ml(h,o,c,A),c=A+1):(ml(h,o,A+1,g),g=A)}}function Kl(h,o,c){const g=h[o];h[o]=h[c],h[c]=g}Ki("FeaturePositionMap",Jl);class Fs{constructor(o,c){this.gl=o.gl,this.location=c}}class mc extends Fs{constructor(o,c){super(o,c),this.current=0}set(o){this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class Wa extends Fs{constructor(o,c){super(o,c),this.current=[0,0,0,0]}set(o){o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3]))}}class Ql extends Fs{constructor(o,c){super(o,c),this.current=tn.transparent}set(o){o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a))}}const Uc=new Float32Array(16);function Zs(h){return[co(255*h.r,255*h.g),co(255*h.b,255*h.a)]}class Po{constructor(o,c,g){this.value=o,this.uniformNames=c.map(x=>`u_${x}`),this.type=g}setUniform(o,c,g){o.set(g.constantOr(this.value))}getBinding(o,c,g){return this.type==="color"?new Ql(o,c):new mc(o,c)}}class Mo{constructor(o,c){this.uniformNames=c.map(g=>`u_${g}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(o,c){this.pixelRatioFrom=c.pixelRatio,this.pixelRatioTo=o.pixelRatio,this.patternFrom=c.tlbr,this.patternTo=o.tlbr}setConstantDashPositions(o,c){this.dashTo=[0,o.y,o.height,o.width],this.dashFrom=[0,c.y,c.height,c.width]}setUniform(o,c,g,x){let T=null;x==="u_pattern_to"?T=this.patternTo:x==="u_pattern_from"?T=this.patternFrom:x==="u_dasharray_to"?T=this.dashTo:x==="u_dasharray_from"?T=this.dashFrom:x==="u_pixel_ratio_to"?T=this.pixelRatioTo:x==="u_pixel_ratio_from"&&(T=this.pixelRatioFrom),T!==null&&o.set(T)}getBinding(o,c,g){return g.substr(0,9)==="u_pattern"||g.substr(0,12)==="u_dasharray_"?new Wa(o,c):new mc(o,c)}}class hs{constructor(o,c,g,x){this.expression=o,this.type=g,this.maxValue=0,this.paintVertexAttributes=c.map(T=>({name:`a_${T}`,type:"Float32",components:g==="color"?2:1,offset:0})),this.paintVertexArray=new x}populatePaintArray(o,c,g){const x=this.paintVertexArray.length,T=this.expression.evaluate(new uo(0,g),c,{},g.canonical,[],g.formattedSection);this.paintVertexArray.resize(o),this._setPaintValue(x,o,T)}updatePaintArray(o,c,g,x,T){const A=this.expression.evaluate(new uo(0,T),g,x);this._setPaintValue(o,c,A)}_setPaintValue(o,c,g){if(this.type==="color"){const x=Zs(g);for(let T=o;T<c;T++)this.paintVertexArray.emplace(T,x[0],x[1])}else{for(let x=o;x<c;x++)this.paintVertexArray.emplace(x,g);this.maxValue=Math.max(this.maxValue,Math.abs(g))}}upload(o){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=o.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class To{constructor(o,c,g,x,T,A){this.expression=o,this.uniformNames=c.map(z=>`u_${z}_t`),this.type=g,this.useIntegerZoom=x,this.zoom=T,this.maxValue=0,this.paintVertexAttributes=c.map(z=>({name:`a_${z}`,type:"Float32",components:g==="color"?4:2,offset:0})),this.paintVertexArray=new A}populatePaintArray(o,c,g){const x=this.expression.evaluate(new uo(this.zoom,g),c,{},g.canonical,[],g.formattedSection),T=this.expression.evaluate(new uo(this.zoom+1,g),c,{},g.canonical,[],g.formattedSection),A=this.paintVertexArray.length;this.paintVertexArray.resize(o),this._setPaintValue(A,o,x,T)}updatePaintArray(o,c,g,x,T){const A=this.expression.evaluate(new uo(this.zoom,T),g,x),z=this.expression.evaluate(new uo(this.zoom+1,T),g,x);this._setPaintValue(o,c,A,z)}_setPaintValue(o,c,g,x){if(this.type==="color"){const T=Zs(g),A=Zs(x);for(let z=o;z<c;z++)this.paintVertexArray.emplace(z,T[0],T[1],A[0],A[1])}else{for(let T=o;T<c;T++)this.paintVertexArray.emplace(T,g,x);this.maxValue=Math.max(this.maxValue,Math.abs(g),Math.abs(x))}}upload(o){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=o.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(o,c){const g=this.useIntegerZoom?Math.floor(c.zoom):c.zoom,x=Qs(this.expression.interpolationFactor(g,this.zoom,this.zoom+1),0,1);o.set(x)}getBinding(o,c,g){return new mc(o,c)}}class Ll{constructor(o,c,g,x,T,A){this.expression=o,this.type=c,this.useIntegerZoom=g,this.zoom=x,this.layerId=A,this.zoomInPaintVertexArray=new T,this.zoomOutPaintVertexArray=new T}populatePaintArray(o,c,g){const x=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(o),this.zoomOutPaintVertexArray.resize(o),this._setPaintValues(x,o,this.getPositionIds(c),g)}updatePaintArray(o,c,g,x,T){this._setPaintValues(o,c,this.getPositionIds(g),T)}_setPaintValues(o,c,g,x){const T=this.getPositions(x);if(!T||!g)return;const A=T[g.min],z=T[g.mid],B=T[g.max];if(A&&z&&B)for(let G=o;G<c;G++)this.emplace(this.zoomInPaintVertexArray,G,z,A),this.emplace(this.zoomOutPaintVertexArray,G,z,B)}upload(o){if(this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer){const c=this.getVertexAttributes();this.zoomInPaintVertexBuffer=o.createVertexBuffer(this.zoomInPaintVertexArray,c,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=o.createVertexBuffer(this.zoomOutPaintVertexArray,c,this.expression.isStateDependent)}}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class ch extends Ll{getPositions(o){return o.imagePositions}getPositionIds(o){return o.patterns&&o.patterns[this.layerId]}getVertexAttributes(){return No.members}emplace(o,c,g,x){o.emplace(c,g.tlbr[0],g.tlbr[1],g.tlbr[2],g.tlbr[3],x.tlbr[0],x.tlbr[1],x.tlbr[2],x.tlbr[3],g.pixelRatio,x.pixelRatio)}}class Mp extends Ll{getPositions(o){return o.dashPositions}getPositionIds(o){return o.dashes&&o.dashes[this.layerId]}getVertexAttributes(){return Jo.members}emplace(o,c,g,x){o.emplace(c,0,g.y,g.height,g.width,0,x.y,x.height,x.width)}}class Rl{constructor(o,c,g){this.binders={},this._buffers=[];const x=[];for(const T in o.paint._values){if(!g(T))continue;const A=o.paint.get(T);if(!(A instanceof la&&Dh(A.property.specification)))continue;const z=Cp(T,o.type),B=A.value,G=A.property.specification.type,W=A.property.useIntegerZoom,K=A.property.specification["property-type"],ot=K==="cross-faded"||K==="cross-faded-data-driven";if(B.kind==="constant")this.binders[T]=ot?new Mo(B.value,z):new Po(B.value,z,G),x.push(`/u_${T}`);else if(B.kind==="source"||ot){const ct=kl(T,G,"source");this.binders[T]=ot?T==="line-dasharray"?new Mp(B,G,W,c,ct,o.id):new ch(B,G,W,c,ct,o.id):new hs(B,z,G,ct),x.push(`/a_${T}`)}else{const ct=kl(T,G,"composite");this.binders[T]=new To(B,z,G,W,c,ct),x.push(`/z_${T}`)}}this.cacheKey=x.sort().join("")}getMaxValue(o){const c=this.binders[o];return c instanceof hs||c instanceof To?c.maxValue:0}populatePaintArrays(o,c,g){for(const x in this.binders){const T=this.binders[x];(T instanceof hs||T instanceof To||T instanceof Ll)&&T.populatePaintArray(o,c,g)}}setConstantPatternPositions(o,c){for(const g in this.binders){const x=this.binders[g];x instanceof Mo&&x.setConstantPatternPositions(o,c)}}setConstantDashPositions(o,c){for(const g in this.binders){const x=this.binders[g];x instanceof Mo&&x.setConstantDashPositions(o,c)}}updatePaintArrays(o,c,g,x,T){let A=!1;for(const z in o){const B=c.getPositions(z);for(const G of B){const W=g.feature(G.index);for(const K in this.binders){const ot=this.binders[K];if((ot instanceof hs||ot instanceof To||ot instanceof Ll)&&ot.expression.isStateDependent===!0){const ct=x.paint.get(K);ot.expression=ct.value,ot.updatePaintArray(G.start,G.end,W,o[z],T),A=!0}}}}return A}defines(){const o=[];for(const c in this.binders){const g=this.binders[c];(g instanceof Po||g instanceof Mo)&&o.push(...g.uniformNames.map(x=>`#define HAS_UNIFORM_${x}`))}return o}getBinderAttributes(){const o=[];for(const c in this.binders){const g=this.binders[c];if(g instanceof hs||g instanceof To)for(let x=0;x<g.paintVertexAttributes.length;x++)o.push(g.paintVertexAttributes[x].name);else if(g instanceof Ll){const x=g.getVertexAttributes();for(const T of x)o.push(T.name)}}return o}getBinderUniforms(){const o=[];for(const c in this.binders){const g=this.binders[c];if(g instanceof Po||g instanceof Mo||g instanceof To)for(const x of g.uniformNames)o.push(x)}return o}getPaintVertexBuffers(){return this._buffers}getUniforms(o,c){const g=[];for(const x in this.binders){const T=this.binders[x];if(T instanceof Po||T instanceof Mo||T instanceof To){for(const A of T.uniformNames)if(c[A]){const z=T.getBinding(o,c[A],A);g.push({name:A,property:x,binding:z})}}}return g}setUniforms(o,c,g,x){for(const{name:T,property:A,binding:z}of c)this.binders[A].setUniform(z,x,g.get(A),T)}updatePaintBuffers(o){this._buffers=[];for(const c in this.binders){const g=this.binders[c];if(o&&g instanceof Ll){const x=o.fromScale===2?g.zoomInPaintVertexBuffer:g.zoomOutPaintVertexBuffer;x&&this._buffers.push(x)}else(g instanceof hs||g instanceof To)&&g.paintVertexBuffer&&this._buffers.push(g.paintVertexBuffer)}}upload(o){for(const c in this.binders){const g=this.binders[c];(g instanceof hs||g instanceof To||g instanceof Ll)&&g.upload(o)}this.updatePaintBuffers()}destroy(){for(const o in this.binders){const c=this.binders[o];(c instanceof hs||c instanceof To||c instanceof Ll)&&c.destroy()}}}class hh{constructor(o,c,g=()=>!0){this.programConfigurations={};for(const x of o)this.programConfigurations[x.id]=new Rl(x,c,g);this.needsUpload=!1,this._featureMap=new Jl,this._bufferOffset=0}populatePaintArrays(o,c,g,x){for(const T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(o,c,x);c.id!==void 0&&this._featureMap.add(c.id,g,this._bufferOffset,o),this._bufferOffset=o,this.needsUpload=!0}updatePaintArrays(o,c,g,x){for(const T of g)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(o,this._featureMap,c,T,x)||this.needsUpload}get(o){return this.programConfigurations[o]}upload(o){if(this.needsUpload){for(const c in this.programConfigurations)this.programConfigurations[c].upload(o);this.needsUpload=!1}}destroy(){for(const o in this.programConfigurations)this.programConfigurations[o].destroy()}}function Cp(h,o){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-dasharray":["dasharray_to","dasharray_from"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[h]||[h.replace(`${o}-`,"").replace(/-/g,"_")]}function kl(h,o,c){const g={color:{source:Hh,composite:S},number:{source:Hd,composite:Hh}},x=function(T){return{"line-pattern":{source:de,composite:de},"fill-pattern":{source:de,composite:de},"fill-extrusion-pattern":{source:de,composite:de},"line-dasharray":{source:De,composite:De}}[T]}(h);return x&&x[c]||g[o][c]}Ki("ConstantBinder",Po),Ki("CrossFadedConstantBinder",Mo),Ki("SourceExpressionBinder",hs),Ki("CrossFadedPatternBinder",ch),Ki("CrossFadedDasharrayBinder",Mp),Ki("CompositeExpressionBinder",To),Ki("ProgramConfiguration",Rl,{omit:["_buffers"]}),Ki("ProgramConfigurationSet",hh);const uh=Math.pow(2,14)-1,qn=-uh-1;function Fl(h){const o=Ln/h.extent,c=h.loadGeometry();for(let g=0;g<c.length;g++){const x=c[g];for(let T=0;T<x.length;T++){const A=x[T],z=Math.round(A.x*o),B=Math.round(A.y*o);A.x=Qs(z,qn,uh),A.y=Qs(B,qn,uh),(z<A.x||z>A.x+1||B<A.y||B>A.y+1)&&vo("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return c}function gc(h,o){return{type:h.type,id:h.id,properties:h.properties,geometry:o?Fl(h):[]}}const Wd=-32768;function dh(h,o,c,g,x){h.emplaceBack(Wd+8*o+g,Wd+8*c+x)}class xf{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.layoutVertexArray=new ft,this.indexArray=new Fi,this.segments=new Nr,this.programConfigurations=new hh(o.layers,o.zoom),this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){const x=this.layers[0],T=[];let A=null,z=!1,B=x.type==="heatmap";if(x.type==="circle"){const W=x;A=W.layout.get("circle-sort-key"),z=!A.isConstant(),B=B||W.paint.get("circle-pitch-alignment")==="map"}const G=B?c.subdivisionGranularity.circle:1;for(const{feature:W,id:K,index:ot,sourceLayerIndex:ct}of o){const dt=this.layers[0]._featureFilter.needGeometry,xt=gc(W,dt);if(!this.layers[0]._featureFilter.filter(new uo(this.zoom),xt,g))continue;const At=z?A.evaluate(xt,{},g):void 0,jt={id:K,properties:W.properties,type:W.type,sourceLayerIndex:ct,index:ot,geometry:dt?xt.geometry:Fl(W),patterns:{},sortKey:At};T.push(jt)}z&&T.sort((W,K)=>W.sortKey-K.sortKey);for(const W of T){const{geometry:K,index:ot,sourceLayerIndex:ct}=W,dt=o[ot].feature;this.addFeature(W,K,ot,g,G),c.featureIndex.insert(dt,K,ot,ct,this.index)}}update(o,c,g){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g})}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,$r),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(o,c,g,x,T=1){let A;switch(T){case 1:A=[0,7];break;case 3:A=[0,2,5,7];break;case 5:A=[0,1,3,4,6,7];break;case 7:A=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${T}; valid values are 1, 3, 5, 7.`)}const z=A.length;for(const B of c)for(const G of B){const W=G.x,K=G.y;if(W<0||W>=Ln||K<0||K>=Ln)continue;const ot=this.segments.prepareSegment(z*z,this.layoutVertexArray,this.indexArray,o.sortKey),ct=ot.vertexLength;for(let dt=0;dt<z;dt++)for(let xt=0;xt<z;xt++)dh(this.layoutVertexArray,W,K,A[xt],A[dt]);for(let dt=0;dt<z-1;dt++)for(let xt=0;xt<z-1;xt++){const At=ct+dt*z+xt,jt=ct+(dt+1)*z+xt;this.indexArray.emplaceBack(At,jt+1,At+1),this.indexArray.emplaceBack(At,jt,jt+1)}ot.vertexLength+=z*z,ot.primitiveLength+=(z-1)*(z-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:{},canonical:x})}}function Dp(h,o){for(let c=0;c<h.length;c++)if(dd(o,h[c]))return!0;for(let c=0;c<o.length;c++)if(dd(h,o[c]))return!0;return!!Lp(h,o)}function zp(h,o,c){return!!dd(h,o)||!!ud(o,h,c)}function Eu(h,o){if(h.length===1)return vf(o,h[0]);for(let c=0;c<o.length;c++){const g=o[c];for(let x=0;x<g.length;x++)if(dd(h,g[x]))return!0}for(let c=0;c<h.length;c++)if(vf(o,h[c]))return!0;for(let c=0;c<o.length;c++)if(Lp(h,o[c]))return!0;return!1}function Cm(h,o,c){if(h.length>1){if(Lp(h,o))return!0;for(let g=0;g<o.length;g++)if(ud(o[g],h,c))return!0}for(let g=0;g<h.length;g++)if(ud(h[g],o,c))return!0;return!1}function Lp(h,o){if(h.length===0||o.length===0)return!1;for(let c=0;c<h.length-1;c++){const g=h[c],x=h[c+1];for(let T=0;T<o.length-1;T++)if(Yf(g,x,o[T],o[T+1]))return!0}return!1}function Yf(h,o,c,g){return ns(h,c,g)!==ns(o,c,g)&&ns(h,o,c)!==ns(h,o,g)}function ud(h,o,c){const g=c*c;if(o.length===1)return h.distSqr(o[0])<g;for(let x=1;x<o.length;x++)if(Jf(h,o[x-1],o[x])<g)return!0;return!1}function Jf(h,o,c){const g=o.distSqr(c);if(g===0)return h.distSqr(o);const x=((h.x-o.x)*(c.x-o.x)+(h.y-o.y)*(c.y-o.y))/g;return h.distSqr(x<0?o:x>1?c:c.sub(o)._mult(x)._add(o))}function vf(h,o){let c,g,x,T=!1;for(let A=0;A<h.length;A++){c=h[A];for(let z=0,B=c.length-1;z<c.length;B=z++)g=c[z],x=c[B],g.y>o.y!=x.y>o.y&&o.x<(x.x-g.x)*(o.y-g.y)/(x.y-g.y)+g.x&&(T=!T)}return T}function dd(h,o){let c=!1;for(let g=0,x=h.length-1;g<h.length;x=g++){const T=h[g],A=h[x];T.y>o.y!=A.y>o.y&&o.x<(A.x-T.x)*(o.y-T.y)/(A.y-T.y)+T.x&&(c=!c)}return c}function fg(h,o,c){const g=c[0],x=c[2];if(h.x<g.x&&o.x<g.x||h.x>x.x&&o.x>x.x||h.y<g.y&&o.y<g.y||h.y>x.y&&o.y>x.y)return!1;const T=ns(h,o,c[0]);return T!==ns(h,o,c[1])||T!==ns(h,o,c[2])||T!==ns(h,o,c[3])}function Au(h,o,c){const g=o.paint.get(h).value;return g.kind==="constant"?g.value:c.programConfigurations.get(o.id).getMaxValue(h)}function pd(h){return Math.sqrt(h[0]*h[0]+h[1]*h[1])}function Rp(h,o,c,g,x){if(!o[0]&&!o[1])return h;const T=Pe.convert(o)._mult(x);c==="viewport"&&T._rotate(-g);const A=[];for(let z=0;z<h.length;z++)A.push(h[z].sub(T));return A}function mg({queryGeometry:h,size:o},c){return zp(h,c,o)}function Dm({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x},T){return zp(h,T,o*(c.projectTileCoordinates(T.x,T.y,g,x).signedDistanceFromCamera/c.cameraToCenterDistance))}function gg({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x},T){const A=c.projectTileCoordinates(T.x,T.y,g,x).signedDistanceFromCamera,z=o*(c.cameraToCenterDistance/A);return zp(h,Qf(T,c,g,x),z)}function Kf({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x},T){return zp(h,Qf(T,c,g,x),o)}function zm({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x,pitchAlignment:T="map",pitchScale:A="map"},z){const B=T==="map"?A==="map"?mg:Dm:A==="map"?gg:Kf,G={queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x};for(const W of z)for(const K of W)if(B(G,K))return!0;return!1}function Qf(h,o,c,g){const x=o.projectTileCoordinates(h.x,h.y,c,g).point;return new Pe((.5*x.x+.5)*o.width,(.5*-x.y+.5)*o.height)}let Lm,Rm;Ki("CircleBucket",xf,{omit:["layers"]});var _g={get paint(){return Rm=Rm||new cs({"circle-radius":new zr(te.paint_circle["circle-radius"]),"circle-color":new zr(te.paint_circle["circle-color"]),"circle-blur":new zr(te.paint_circle["circle-blur"]),"circle-opacity":new zr(te.paint_circle["circle-opacity"]),"circle-translate":new xr(te.paint_circle["circle-translate"]),"circle-translate-anchor":new xr(te.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new xr(te.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new xr(te.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new zr(te.paint_circle["circle-stroke-width"]),"circle-stroke-color":new zr(te.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new zr(te.paint_circle["circle-stroke-opacity"])})},get layout(){return Lm=Lm||new cs({"circle-sort-key":new zr(te.layout_circle["circle-sort-key"])})}};class f_ extends fl{constructor(o,c){super(o,_g,c)}createBucket(o){return new xf(o)}queryRadius(o){const c=o;return Au("circle-radius",this,c)+Au("circle-stroke-width",this,c)+pd(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A,unwrappedTileID:z,getElevation:B}){const G=Rp(o,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-T.bearingInRadians,A),W=this.paint.get("circle-radius").evaluate(c,g)+this.paint.get("circle-stroke-width").evaluate(c,g),K=this.paint.get("circle-pitch-scale"),ot=this.paint.get("circle-pitch-alignment");let ct,dt;return ot==="map"?(ct=G,dt=W*A):(ct=function(xt,At,jt,ue){return xt.map(Qt=>Qf(Qt,At,jt,ue))}(G,T,z,B),dt=W),zm({queryGeometry:ct,size:dt,transform:T,unwrappedTileID:z,getElevation:B,pitchAlignment:ot,pitchScale:K},x)}}class yg extends xf{}let po;Ki("HeatmapBucket",yg,{omit:["layers"]});var xg={get paint(){return po=po||new cs({"heatmap-radius":new zr(te.paint_heatmap["heatmap-radius"]),"heatmap-weight":new zr(te.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new xr(te.paint_heatmap["heatmap-intensity"]),"heatmap-color":new lh(te.paint_heatmap["heatmap-color"]),"heatmap-opacity":new xr(te.paint_heatmap["heatmap-opacity"])})}};function km(h,{width:o,height:c},g,x){if(x){if(x instanceof Uint8ClampedArray)x=new Uint8Array(x.buffer);else if(x.length!==o*c*g)throw new RangeError(`mismatched image size. expected: ${x.length} but got: ${o*c*g}`)}else x=new Uint8Array(o*c*g);return h.width=o,h.height=c,h.data=x,h}function vg(h,{width:o,height:c},g){if(o===h.width&&c===h.height)return;const x=km({},{width:o,height:c},g);Fm(h,x,{x:0,y:0},{x:0,y:0},{width:Math.min(h.width,o),height:Math.min(h.height,c)},g),h.width=o,h.height=c,h.data=x.data}function Fm(h,o,c,g,x,T){if(x.width===0||x.height===0)return o;if(x.width>h.width||x.height>h.height||c.x>h.width-x.width||c.y>h.height-x.height)throw new RangeError("out of range source coordinates for image copy");if(x.width>o.width||x.height>o.height||g.x>o.width-x.width||g.y>o.height-x.height)throw new RangeError("out of range destination coordinates for image copy");const A=h.data,z=o.data;if(A===z)throw new Error("srcData equals dstData, so image is already copied");for(let B=0;B<x.height;B++){const G=((c.y+B)*h.width+c.x)*T,W=((g.y+B)*o.width+g.x)*T;for(let K=0;K<x.width*T;K++)z[W+K]=A[G+K]}return o}class Pu{constructor(o,c){km(this,o,1,c)}resize(o){vg(this,o,1)}clone(){return new Pu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(o,c,g,x,T){Fm(o,c,g,x,T,1)}}class ba{constructor(o,c){km(this,o,4,c)}resize(o){vg(this,o,4)}replace(o,c){c?this.data.set(o):this.data=o instanceof Uint8ClampedArray?new Uint8Array(o.buffer):o}clone(){return new ba({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(o,c,g,x,T){Fm(o,c,g,x,T,4)}setPixel(o,c,g){const x=4*(o*this.width+c);this.data[x+0]=Math.round(255*g.r/g.a),this.data[x+1]=Math.round(255*g.g/g.a),this.data[x+2]=Math.round(255*g.b/g.a),this.data[x+3]=Math.round(255*g.a)}}function tm(h){const o={},c=h.resolution||256,g=h.clips?h.clips.length:1,x=h.image||new ba({width:c,height:g});if(Math.log(c)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${c}`);const T=(A,z,B)=>{o[h.evaluationKey]=B;const G=h.expression.evaluate(o);x.setPixel(A/4/c,z/4,G)};if(h.clips)for(let A=0,z=0;A<g;++A,z+=4*c)for(let B=0,G=0;B<c;B++,G+=4){const W=B/(c-1),{start:K,end:ot}=h.clips[A];T(z,G,K*(1-W)+ot*W)}else for(let A=0,z=0;A<c;A++,z+=4)T(0,z,A/(c-1));return x}Ki("AlphaImage",Pu),Ki("RGBAImage",ba);const kp="big-fb";class jc extends fl{createBucket(o){return new yg(o)}constructor(o,c){super(o,xg,c),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(o){o==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=tm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(kp)&&this.heatmapFbos.delete(kp)}queryRadius(o){return Au("heatmap-radius",this,o)}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A,unwrappedTileID:z,getElevation:B}){return zm({queryGeometry:o,size:this.paint.get("heatmap-radius").evaluate(c,g)*A,transform:T,unwrappedTileID:z,getElevation:B},x)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let bf;var ts={get paint(){return bf=bf||new cs({"hillshade-illumination-direction":new xr(te.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-altitude":new xr(te.paint_hillshade["hillshade-illumination-altitude"]),"hillshade-illumination-anchor":new xr(te.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new xr(te.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new xr(te.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new xr(te.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new xr(te.paint_hillshade["hillshade-accent-color"]),"hillshade-method":new xr(te.paint_hillshade["hillshade-method"])})}};class Jh extends fl{constructor(o,c){super(o,ts,c),this.recalculate({zoom:0,zoomHistory:{}},void 0)}getIlluminationProperties(){let o=this.paint.get("hillshade-illumination-direction").values,c=this.paint.get("hillshade-illumination-altitude").values,g=this.paint.get("hillshade-highlight-color").values,x=this.paint.get("hillshade-shadow-color").values;const T=Math.max(o.length,c.length,g.length,x.length);o=o.concat(Array(T-o.length).fill(o.at(-1))),c=c.concat(Array(T-c.length).fill(c.at(-1))),g=g.concat(Array(T-g.length).fill(g.at(-1))),x=x.concat(Array(T-x.length).fill(x.at(-1)));const A=c.map(ds);return{directionRadians:o.map(ds),altitudeRadians:A,shadowColor:x,highlightColor:g}}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}let Xd;var wf={get paint(){return Xd=Xd||new cs({"color-relief-opacity":new xr(te["paint_color-relief"]["color-relief-opacity"]),"color-relief-color":new lh(te["paint_color-relief"]["color-relief-color"])})}};class Tf{constructor(o,c,g,x){this.context=o,this.format=g,this.texture=o.gl.createTexture(),this.update(c,x)}update(o,c,g){const{width:x,height:T}=o,A=!(this.size&&this.size[0]===x&&this.size[1]===T||g),{context:z}=this,{gl:B}=z;if(this.useMipmap=!!(c&&c.useMipmap),B.bindTexture(B.TEXTURE_2D,this.texture),z.pixelStoreUnpackFlipY.set(!1),z.pixelStoreUnpack.set(1),z.pixelStoreUnpackPremultiplyAlpha.set(this.format===B.RGBA&&(!c||c.premultiply!==!1)),A)this.size=[x,T],o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof HTMLVideoElement||o instanceof ImageData||Zn(o)?B.texImage2D(B.TEXTURE_2D,0,this.format,this.format,B.UNSIGNED_BYTE,o):B.texImage2D(B.TEXTURE_2D,0,this.format,x,T,0,this.format,B.UNSIGNED_BYTE,o.data);else{const{x:G,y:W}=g||{x:0,y:0};o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof HTMLVideoElement||o instanceof ImageData||Zn(o)?B.texSubImage2D(B.TEXTURE_2D,0,G,W,B.RGBA,B.UNSIGNED_BYTE,o):B.texSubImage2D(B.TEXTURE_2D,0,G,W,x,T,B.RGBA,B.UNSIGNED_BYTE,o.data)}this.useMipmap&&this.isSizePowerOfTwo()&&B.generateMipmap(B.TEXTURE_2D),z.pixelStoreUnpackFlipY.setDefault(),z.pixelStoreUnpack.setDefault(),z.pixelStoreUnpackPremultiplyAlpha.setDefault()}bind(o,c,g){const{context:x}=this,{gl:T}=x;T.bindTexture(T.TEXTURE_2D,this.texture),g!==T.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(g=T.LINEAR),o!==this.filter&&(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,o),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,g||o),this.filter=o),c!==this.wrap&&(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,c),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,c),this.wrap=c)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:o}=this.context;o.deleteTexture(this.texture),this.texture=null}}class Bm{constructor(o,c,g,x=1,T=1,A=1,z=0){if(this.uid=o,c.height!==c.width)throw new RangeError("DEM tiles must be square");if(g&&!["mapbox","terrarium","custom"].includes(g))return void vo(`"${g}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=c.height;const B=this.dim=c.height-2;switch(this.data=new Uint32Array(c.data.buffer),g){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=x,this.greenFactor=T,this.blueFactor=A,this.baseShift=z;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let G=0;G<B;G++)this.data[this._idx(-1,G)]=this.data[this._idx(0,G)],this.data[this._idx(B,G)]=this.data[this._idx(B-1,G)],this.data[this._idx(G,-1)]=this.data[this._idx(G,0)],this.data[this._idx(G,B)]=this.data[this._idx(G,B-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(B,-1)]=this.data[this._idx(B-1,0)],this.data[this._idx(-1,B)]=this.data[this._idx(0,B-1)],this.data[this._idx(B,B)]=this.data[this._idx(B-1,B-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let G=0;G<B;G++)for(let W=0;W<B;W++){const K=this.get(G,W);K>this.max&&(this.max=K),K<this.min&&(this.min=K)}}get(o,c){const g=new Uint8Array(this.data.buffer),x=4*this._idx(o,c);return this.unpack(g[x],g[x+1],g[x+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(o,c){if(o<-1||o>=this.dim+1||c<-1||c>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(c+1)*this.stride+(o+1)}unpack(o,c,g){return o*this.redFactor+c*this.greenFactor+g*this.blueFactor-this.baseShift}pack(o){return Fp(o,this.getUnpackVector())}getPixels(){return new ba({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(o,c,g){if(this.dim!==o.dim)throw new Error("dem dimension mismatch");let x=c*this.dim,T=c*this.dim+this.dim,A=g*this.dim,z=g*this.dim+this.dim;switch(c){case-1:x=T-1;break;case 1:T=x+1}switch(g){case-1:A=z-1;break;case 1:z=A+1}const B=-c*this.dim,G=-g*this.dim;for(let W=A;W<z;W++)for(let K=x;K<T;K++)this.data[this._idx(K,W)]=o.data[this._idx(K+B,W+G)]}}function Fp(h,o){const c=o[0],g=o[1],x=o[2],T=o[3],A=Math.min(c,g,x),z=Math.round((h+T)/A);return{r:Math.floor(z*A/c)%256,g:Math.floor(z*A/g)%256,b:Math.floor(z*A/x)%256}}Ki("DEMData",Bm);class m_ extends fl{constructor(o,c){super(o,wf,c)}_createColorRamp(o){const c={elevationStops:[],colorStops:[]},g=this._transitionablePaint._values["color-relief-color"].value.expression;if(g instanceof Rh&&g._styleExpression.expression instanceof na){this.colorRampExpression=g;const A=g._styleExpression.expression;c.elevationStops=A.labels,c.colorStops=[];for(const z of c.elevationStops)c.colorStops.push(A.evaluate({globals:{elevation:z}}))}if(c.elevationStops.length<1&&(c.elevationStops=[0],c.colorStops=[tn.transparent]),c.elevationStops.length<2&&(c.elevationStops.push(c.elevationStops[0]+1),c.colorStops.push(c.colorStops[0])),c.elevationStops.length<=o)return c;const x={elevationStops:[],colorStops:[]},T=(c.elevationStops.length-1)/(o-1);for(let A=0;A<c.elevationStops.length-.5;A+=T)x.elevationStops.push(c.elevationStops[Math.round(A)]),x.colorStops.push(c.colorStops[Math.round(A)]);return vo(`Too many colors in specification of ${this.id} color-relief layer, may not render properly. Max possible colors: ${o}, provided: ${c.elevationStops.length}`),x}_colorRampChanged(){return this.colorRampExpression!=this._transitionablePaint._values["color-relief-color"].value.expression}getColorRampTextures(o,c,g){if(this.colorRampTextures&&!this._colorRampChanged())return this.colorRampTextures;const x=this._createColorRamp(c),T=new ba({width:x.colorStops.length,height:1}),A=new ba({width:x.colorStops.length,height:1});for(let z=0;z<x.elevationStops.length;z++){const B=Fp(x.elevationStops[z],g);A.setPixel(0,z,new tn(B.r/255,B.g/255,B.b/255,1)),T.setPixel(0,z,x.colorStops[z])}return this.colorRampTextures={elevationTexture:new Tf(o,A,o.gl.RGBA),colorTexture:new Tf(o,T,o.gl.RGBA)},this.colorRampTextures}hasOffscreenPass(){return this.visibility!=="none"&&!!this.colorRampTextures}}const bg=Go([{name:"a_pos",components:2,type:"Int16"}],4),{members:Om}=bg;function Bp(h,o,c){const g=c.patternDependencies;let x=!1;for(const T of o){const A=T.paint.get(`${h}-pattern`);A.isConstant()||(x=!0);const z=A.constantOr(null);z&&(x=!0,g[z.to]=!0,g[z.from]=!0)}return x}function Op(h,o,c,g,x){const{zoom:T}=g,A=x.patternDependencies;for(const z of o){const B=z.paint.get(`${h}-pattern`).value;if(B.kind!=="constant"){let G=B.evaluate({zoom:T-1},c,{},x.availableImages),W=B.evaluate({zoom:T},c,{},x.availableImages),K=B.evaluate({zoom:T+1},c,{},x.availableImages);G=G&&G.name?G.name:G,W=W&&W.name?W.name:W,K=K&&K.name?K.name:K,A[G]=!0,A[W]=!0,A[K]=!0,c.patterns[z.id]={min:G,mid:W,max:K}}}return c}function Sf(h,o,c,g,x){let T;if(x===function(A,z,B,G){let W=0;for(let K=z,ot=B-G;K<B;K+=G)W+=(A[ot]-A[K])*(A[K+1]+A[ot+1]),ot=K;return W}(h,o,c,g)>0)for(let A=o;A<c;A+=g)T=N(A/g|0,h[A],h[A+1],T);else for(let A=c-g;A>=o;A-=g)T=N(A/g|0,h[A],h[A+1],T);return T&&f(T,T.next)&&(V(T),T=T.next),T}function ph(h,o){if(!h)return h;o||(o=h);let c,g=h;do if(c=!1,g.steiner||!f(g,g.next)&&a(g.prev,g,g.next)!==0)g=g.next;else{if(V(g),g=o=g.prev,g===g.next)break;c=!0}while(c||g!==o);return o}function _c(h,o,c,g,x,T,A){if(!h)return;!A&&T&&function(B,G,W,K){let ot=B;do ot.z===0&&(ot.z=Nm(ot.x,ot.y,G,W,K)),ot.prevZ=ot.prev,ot.nextZ=ot.next,ot=ot.next;while(ot!==B);ot.prevZ.nextZ=null,ot.prevZ=null,function(ct){let dt,xt=1;do{let At,jt=ct;ct=null;let ue=null;for(dt=0;jt;){dt++;let Qt=jt,ie=0;for(let Ee=0;Ee<xt&&(ie++,Qt=Qt.nextZ,Qt);Ee++);let Se=xt;for(;ie>0||Se>0&&Qt;)ie!==0&&(Se===0||!Qt||jt.z<=Qt.z)?(At=jt,jt=jt.nextZ,ie--):(At=Qt,Qt=Qt.nextZ,Se--),ue?ue.nextZ=At:ct=At,At.prevZ=ue,ue=At;jt=Qt}ue.nextZ=null,xt*=2}while(dt>1)}(ot)}(h,g,x,T);let z=h;for(;h.prev!==h.next;){const B=h.prev,G=h.next;if(T?ka(h,g,x,T):fh(h))o.push(B.i,h.i,G.i),V(h),h=G.next,z=G.next;else if((h=G)===z){A?A===1?_c(h=Mu(ph(h),o),o,c,g,x,T,2):A===2&&mh(h,o,c,g,x,T):_c(ph(h),o,c,g,x,T,1);break}}}function fh(h){const o=h.prev,c=h,g=h.next;if(a(o,c,g)>=0)return!1;const x=o.x,T=c.x,A=g.x,z=o.y,B=c.y,G=g.y,W=Math.min(x,T,A),K=Math.min(z,B,G),ot=Math.max(x,T,A),ct=Math.max(z,B,G);let dt=g.next;for(;dt!==o;){if(dt.x>=W&&dt.x<=ot&&dt.y>=K&&dt.y<=ct&&p(x,z,T,B,A,G,dt.x,dt.y)&&a(dt.prev,dt,dt.next)>=0)return!1;dt=dt.next}return!0}function ka(h,o,c,g){const x=h.prev,T=h,A=h.next;if(a(x,T,A)>=0)return!1;const z=x.x,B=T.x,G=A.x,W=x.y,K=T.y,ot=A.y,ct=Math.min(z,B,G),dt=Math.min(W,K,ot),xt=Math.max(z,B,G),At=Math.max(W,K,ot),jt=Nm(ct,dt,o,c,g),ue=Nm(xt,At,o,c,g);let Qt=h.prevZ,ie=h.nextZ;for(;Qt&&Qt.z>=jt&&ie&&ie.z<=ue;){if(Qt.x>=ct&&Qt.x<=xt&&Qt.y>=dt&&Qt.y<=At&&Qt!==x&&Qt!==A&&p(z,W,B,K,G,ot,Qt.x,Qt.y)&&a(Qt.prev,Qt,Qt.next)>=0||(Qt=Qt.prevZ,ie.x>=ct&&ie.x<=xt&&ie.y>=dt&&ie.y<=At&&ie!==x&&ie!==A&&p(z,W,B,K,G,ot,ie.x,ie.y)&&a(ie.prev,ie,ie.next)>=0))return!1;ie=ie.nextZ}for(;Qt&&Qt.z>=jt;){if(Qt.x>=ct&&Qt.x<=xt&&Qt.y>=dt&&Qt.y<=At&&Qt!==x&&Qt!==A&&p(z,W,B,K,G,ot,Qt.x,Qt.y)&&a(Qt.prev,Qt,Qt.next)>=0)return!1;Qt=Qt.prevZ}for(;ie&&ie.z<=ue;){if(ie.x>=ct&&ie.x<=xt&&ie.y>=dt&&ie.y<=At&&ie!==x&&ie!==A&&p(z,W,B,K,G,ot,ie.x,ie.y)&&a(ie.prev,ie,ie.next)>=0)return!1;ie=ie.nextZ}return!0}function Mu(h,o){let c=h;do{const g=c.prev,x=c.next.next;!f(g,x)&&y(g,c,c.next,x)&&M(g,x)&&M(x,g)&&(o.push(g.i,c.i,x.i),V(c),V(c.next),c=h=x),c=c.next}while(c!==h);return ph(c)}function mh(h,o,c,g,x,T){let A=h;do{let z=A.next.next;for(;z!==A.prev;){if(A.i!==z.i&&e(A,z)){let B=L(A,z);return A=ph(A,A.next),B=ph(B,B.next),_c(A,o,c,g,x,T,0),void _c(B,o,c,g,x,T,0)}z=z.next}A=A.next}while(A!==h)}function g_(h,o){let c=h.x-o.x;return c===0&&(c=h.y-o.y,c===0)&&(c=(h.next.y-h.y)/(h.next.x-h.x)-(o.next.y-o.y)/(o.next.x-o.x)),c}function __(h,o){const c=function(x,T){let A=T;const z=x.x,B=x.y;let G,W=-1/0;if(f(x,A))return A;do{if(f(x,A.next))return A.next;if(B<=A.y&&B>=A.next.y&&A.next.y!==A.y){const xt=A.x+(B-A.y)*(A.next.x-A.x)/(A.next.y-A.y);if(xt<=z&&xt>W&&(W=xt,G=A.x<A.next.x?A:A.next,xt===z))return G}A=A.next}while(A!==T);if(!G)return null;const K=G,ot=G.x,ct=G.y;let dt=1/0;A=G;do{if(z>=A.x&&A.x>=ot&&z!==A.x&&gl(B<ct?z:W,B,ot,ct,B<ct?W:z,B,A.x,A.y)){const xt=Math.abs(B-A.y)/(z-A.x);M(A,x)&&(xt<dt||xt===dt&&(A.x>G.x||A.x===G.x&&y_(G,A)))&&(G=A,dt=xt)}A=A.next}while(A!==K);return G}(h,o);if(!c)return o;const g=L(c,h);return ph(g,g.next),ph(c,c.next)}function y_(h,o){return a(h.prev,h,o.prev)<0&&a(o.next,h,h.next)<0}function Nm(h,o,c,g,x){return(h=1431655765&((h=858993459&((h=252645135&((h=16711935&((h=(h-c)*x|0)|h<<8))|h<<4))|h<<2))|h<<1))|(o=1431655765&((o=858993459&((o=252645135&((o=16711935&((o=(o-g)*x|0)|o<<8))|o<<4))|o<<2))|o<<1))<<1}function Vm(h){let o=h,c=h;do(o.x<c.x||o.x===c.x&&o.y<c.y)&&(c=o),o=o.next;while(o!==h);return c}function gl(h,o,c,g,x,T,A,z){return(x-A)*(o-z)>=(h-A)*(T-z)&&(h-A)*(g-z)>=(c-A)*(o-z)&&(c-A)*(T-z)>=(x-A)*(g-z)}function p(h,o,c,g,x,T,A,z){return!(h===A&&o===z)&&gl(h,o,c,g,x,T,A,z)}function e(h,o){return h.next.i!==o.i&&h.prev.i!==o.i&&!function(c,g){let x=c;do{if(x.i!==c.i&&x.next.i!==c.i&&x.i!==g.i&&x.next.i!==g.i&&y(x,x.next,c,g))return!0;x=x.next}while(x!==c);return!1}(h,o)&&(M(h,o)&&M(o,h)&&function(c,g){let x=c,T=!1;const A=(c.x+g.x)/2,z=(c.y+g.y)/2;do x.y>z!=x.next.y>z&&x.next.y!==x.y&&A<(x.next.x-x.x)*(z-x.y)/(x.next.y-x.y)+x.x&&(T=!T),x=x.next;while(x!==c);return T}(h,o)&&(a(h.prev,h,o.prev)||a(h,o.prev,o))||f(h,o)&&a(h.prev,h,h.next)>0&&a(o.prev,o,o.next)>0)}function a(h,o,c){return(o.y-h.y)*(c.x-o.x)-(o.x-h.x)*(c.y-o.y)}function f(h,o){return h.x===o.x&&h.y===o.y}function y(h,o,c,g){const x=I(a(h,o,c)),T=I(a(h,o,g)),A=I(a(c,g,h)),z=I(a(c,g,o));return x!==T&&A!==z||!(x!==0||!w(h,c,o))||!(T!==0||!w(h,g,o))||!(A!==0||!w(c,h,g))||!(z!==0||!w(c,o,g))}function w(h,o,c){return o.x<=Math.max(h.x,c.x)&&o.x>=Math.min(h.x,c.x)&&o.y<=Math.max(h.y,c.y)&&o.y>=Math.min(h.y,c.y)}function I(h){return h>0?1:h<0?-1:0}function M(h,o){return a(h.prev,h,h.next)<0?a(h,o,h.next)>=0&&a(h,h.prev,o)>=0:a(h,o,h.prev)<0||a(h,h.next,o)<0}function L(h,o){const c=Z(h.i,h.x,h.y),g=Z(o.i,o.x,o.y),x=h.next,T=o.prev;return h.next=o,o.prev=h,c.next=x,x.prev=c,g.next=c,c.prev=g,T.next=g,g.prev=T,g}function N(h,o,c,g){const x=Z(h,o,c);return g?(x.next=g.next,x.prev=g,g.next.prev=x,g.next=x):(x.prev=x,x.next=x),x}function V(h){h.next.prev=h.prev,h.prev.next=h.next,h.prevZ&&(h.prevZ.nextZ=h.nextZ),h.nextZ&&(h.nextZ.prevZ=h.prevZ)}function Z(h,o,c){return{i:h,x:o,y:c,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class U{constructor(o,c){if(c>o)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=o,this._minGranularity=c}getGranularityForZoomLevel(o){return Math.max(Math.floor(this._baseZoomGranularity/(1<<o)),this._minGranularity,1)}}class X{constructor(o){this.fill=o.fill,this.line=o.line,this.tile=o.tile,this.stencil=o.stencil,this.circle=o.circle}}X.noSubdivision=new X({fill:new U(0,0),line:new U(0,0),tile:new U(0,0),stencil:new U(0,0),circle:1}),Ki("SubdivisionGranularityExpression",U),Ki("SubdivisionGranularitySetting",X);const Q=-32768,nt=32767;class ht{constructor(o,c){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=o,this._granularityCellSize=Ln/o,this._canonical=c}_getKey(o,c){return(o+=32768)<<16|c+32768}_vertexToIndex(o,c){if(o<-32768||c<-32768||o>32767||c>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const g=0|Math.round(o),x=0|Math.round(c),T=this._getKey(g,x);if(this._vertexDictionary.has(T))return this._vertexDictionary.get(T);const A=this._vertexBuffer.length/2;return this._vertexDictionary.set(T,A),this._vertexBuffer.push(g,x),A}_subdivideTrianglesScanline(o){if(this._granularity<2)return function(x,T){const A=[];for(let z=0;z<T.length;z+=3){const B=T[z],G=T[z+1],W=T[z+2],K=x[2*B],ot=x[2*B+1];(x[2*G]-K)*(x[2*W+1]-ot)-(x[2*G+1]-ot)*(x[2*W]-K)>0?(A.push(B),A.push(W),A.push(G)):(A.push(B),A.push(G),A.push(W))}return A}(this._vertexBuffer,o);const c=[],g=o.length;for(let x=0;x<g;x+=3){const T=[o[x+0],o[x+1],o[x+2]],A=[this._vertexBuffer[2*o[x+0]+0],this._vertexBuffer[2*o[x+0]+1],this._vertexBuffer[2*o[x+1]+0],this._vertexBuffer[2*o[x+1]+1],this._vertexBuffer[2*o[x+2]+0],this._vertexBuffer[2*o[x+2]+1]];let z=1/0,B=1/0,G=-1/0,W=-1/0;for(let xt=0;xt<3;xt++){const At=A[2*xt],jt=A[2*xt+1];z=Math.min(z,At),G=Math.max(G,At),B=Math.min(B,jt),W=Math.max(W,jt)}if(z===G||B===W)continue;const K=Math.floor(z/this._granularityCellSize),ot=Math.ceil(G/this._granularityCellSize),ct=Math.floor(B/this._granularityCellSize),dt=Math.ceil(W/this._granularityCellSize);if(K!==ot||ct!==dt)for(let xt=ct;xt<dt;xt++){const At=this._scanlineGenerateVertexRingForCellRow(xt,A,T);Ct(this._vertexBuffer,At,c)}else c.push(...T)}return c}_scanlineGenerateVertexRingForCellRow(o,c,g){const x=o*this._granularityCellSize,T=x+this._granularityCellSize,A=[];for(let z=0;z<3;z++){const B=c[2*z],G=c[2*z+1],W=c[2*(z+1)%6],K=c[(2*(z+1)+1)%6],ot=c[2*(z+2)%6],ct=c[(2*(z+2)+1)%6],dt=W-B,xt=K-G,At=dt===0,jt=xt===0,ue=(x-G)/xt,Qt=(T-G)/xt,ie=Math.min(ue,Qt),Se=Math.max(ue,Qt);if(!jt&&(ie>=1||Se<=0)||jt&&(G<x||G>T)){K>=x&&K<=T&&A.push(g[(z+1)%3]);continue}!jt&&ie>0&&A.push(this._vertexToIndex(B+dt*ie,G+xt*ie));const Ee=B+dt*Math.max(ie,0),ei=B+dt*Math.min(Se,1);At||this._generateIntraEdgeVertices(A,B,G,W,K,Ee,ei),!jt&&Se<1&&A.push(this._vertexToIndex(B+dt*Se,G+xt*Se)),(jt||K>=x&&K<=T)&&A.push(g[(z+1)%3]),!jt&&(K<=x||K>=T)&&this._generateInterEdgeVertices(A,B,G,W,K,ot,ct,ei,x,T)}return A}_generateIntraEdgeVertices(o,c,g,x,T,A,z){const B=x-c,G=T-g,W=G===0,K=W?Math.min(c,x):Math.min(A,z),ot=W?Math.max(c,x):Math.max(A,z),ct=Math.floor(K/this._granularityCellSize)+1,dt=Math.ceil(ot/this._granularityCellSize)-1;if(W?c<x:A<z)for(let xt=ct;xt<=dt;xt++){const At=xt*this._granularityCellSize;o.push(this._vertexToIndex(At,g+G*(At-c)/B))}else for(let xt=dt;xt>=ct;xt--){const At=xt*this._granularityCellSize;o.push(this._vertexToIndex(At,g+G*(At-c)/B))}}_generateInterEdgeVertices(o,c,g,x,T,A,z,B,G,W){const K=T-g,ot=A-x,ct=z-T,dt=(G-T)/ct,xt=(W-T)/ct,At=Math.min(dt,xt),jt=Math.max(dt,xt),ue=x+ot*At;let Qt=Math.floor(Math.min(ue,B)/this._granularityCellSize)+1,ie=Math.ceil(Math.max(ue,B)/this._granularityCellSize)-1,Se=B<ue;const Ee=ct===0;if(Ee&&(z===G||z===W))return;if(Ee||At>=1||jt<=0){const Ai=g-z,mi=A+(c-A)*Math.min((G-z)/Ai,(W-z)/Ai);Qt=Math.floor(Math.min(mi,B)/this._granularityCellSize)+1,ie=Math.ceil(Math.max(mi,B)/this._granularityCellSize)-1,Se=B<mi}const ei=K>0?W:G;if(Se)for(let Ai=Qt;Ai<=ie;Ai++)o.push(this._vertexToIndex(Ai*this._granularityCellSize,ei));else for(let Ai=ie;Ai>=Qt;Ai--)o.push(this._vertexToIndex(Ai*this._granularityCellSize,ei))}_generateOutline(o){const c=[];for(const g of o){const x=_t(g,this._granularity,!0),T=this._pointArrayToIndices(x),A=[];for(let z=1;z<T.length;z++)A.push(T[z-1]),A.push(T[z]);c.push(A)}return c}_handlePoles(o){let c=!1,g=!1;this._canonical&&(this._canonical.y===0&&(c=!0),this._canonical.y===(1<<this._canonical.z)-1&&(g=!0)),(c||g)&&this._fillPoles(o,c,g)}_ensureNoPoleVertices(){const o=this._vertexBuffer;for(let c=0;c<o.length;c+=2){const g=o[c+1];g===Q&&(o[c+1]=-32767),g===nt&&(o[c+1]=32766)}}_generatePoleQuad(o,c,g,x,T,A){x>T!=(A===Q)?(o.push(c),o.push(g),o.push(this._vertexToIndex(x,A)),o.push(g),o.push(this._vertexToIndex(T,A)),o.push(this._vertexToIndex(x,A))):(o.push(g),o.push(c),o.push(this._vertexToIndex(x,A)),o.push(this._vertexToIndex(T,A)),o.push(g),o.push(this._vertexToIndex(x,A)))}_fillPoles(o,c,g){const x=this._vertexBuffer,T=Ln,A=o.length;for(let z=2;z<A;z+=3){const B=o[z-2],G=o[z-1],W=o[z],K=x[2*B],ot=x[2*B+1],ct=x[2*G],dt=x[2*G+1],xt=x[2*W],At=x[2*W+1];c&&(ot===0&&dt===0&&this._generatePoleQuad(o,B,G,K,ct,Q),dt===0&&At===0&&this._generatePoleQuad(o,G,W,ct,xt,Q),At===0&&ot===0&&this._generatePoleQuad(o,W,B,xt,K,Q)),g&&(ot===T&&dt===T&&this._generatePoleQuad(o,B,G,K,ct,nt),dt===T&&At===T&&this._generatePoleQuad(o,G,W,ct,xt,nt),At===T&&ot===T&&this._generatePoleQuad(o,W,B,xt,K,nt))}}_initializeVertices(o){for(let c=0;c<o.length;c+=2)this._vertexToIndex(o[c],o[c+1])}subdividePolygonInternal(o,c){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:g,holeIndices:x}=function(z){const B=[],G=[];for(const W of z)if(W.length!==0){W!==z[0]&&B.push(G.length/2);for(let K=0;K<W.length;K++)G.push(W[K].x),G.push(W[K].y)}return{flattened:G,holeIndices:B}}(o);let T;this._initializeVertices(g);try{const z=function(G,W,K=2){const ot=W&&W.length,ct=ot?W[0]*K:G.length;let dt=Sf(G,0,ct,K,!0);const xt=[];if(!dt||dt.next===dt.prev)return xt;let At,jt,ue;if(ot&&(dt=function(Qt,ie,Se,Ee){const ei=[];for(let Ai=0,mi=ie.length;Ai<mi;Ai++){const Ei=Sf(Qt,ie[Ai]*Ee,Ai<mi-1?ie[Ai+1]*Ee:Qt.length,Ee,!1);Ei===Ei.next&&(Ei.steiner=!0),ei.push(Vm(Ei))}ei.sort(g_);for(let Ai=0;Ai<ei.length;Ai++)Se=__(ei[Ai],Se);return Se}(G,W,dt,K)),G.length>80*K){At=G[0],jt=G[1];let Qt=At,ie=jt;for(let Se=K;Se<ct;Se+=K){const Ee=G[Se],ei=G[Se+1];Ee<At&&(At=Ee),ei<jt&&(jt=ei),Ee>Qt&&(Qt=Ee),ei>ie&&(ie=ei)}ue=Math.max(Qt-At,ie-jt),ue=ue!==0?32767/ue:0}return _c(dt,xt,K,At,jt,ue,0),xt}(g,x),B=this._convertIndices(g,z);T=this._subdivideTrianglesScanline(B)}catch(z){console.error(z)}let A=[];return c&&(A=this._generateOutline(o)),this._ensureNoPoleVertices(),this._handlePoles(T),{verticesFlattened:this._vertexBuffer,indicesTriangles:T,indicesLineList:A}}_convertIndices(o,c){const g=[];for(let x=0;x<c.length;x++)g.push(this._vertexToIndex(o[2*c[x]],o[2*c[x]+1]));return g}_pointArrayToIndices(o){const c=[];for(let g=0;g<o.length;g++){const x=o[g];c.push(this._vertexToIndex(x.x,x.y))}return c}}function lt(h,o,c,g=!0){return new ht(c,o).subdividePolygonInternal(h,g)}function _t(h,o,c=!1){if(!h||h.length<1)return[];if(h.length<2)return[];const g=h[0],x=h[h.length-1],T=c&&(g.x!==x.x||g.y!==x.y);if(o<2)return T?[...h,h[0]]:[...h];const A=Math.floor(Ln/o),z=[];z.push(new Pe(h[0].x,h[0].y));const B=h.length,G=T?B:B-1;for(let W=0;W<G;W++){const K=h[W],ot=W<B-1?h[W+1]:h[0],ct=K.x,dt=K.y,xt=ot.x,At=ot.y,jt=ct!==xt,ue=dt!==At;if(!jt&&!ue)continue;const Qt=xt-ct,ie=At-dt,Se=Math.abs(Qt),Ee=Math.abs(ie);let ei=ct,Ai=dt;for(;;){const Ei=Qt>0?(Math.floor(ei/A)+1)*A:(Math.ceil(ei/A)-1)*A,Hi=ie>0?(Math.floor(Ai/A)+1)*A:(Math.ceil(Ai/A)-1)*A,Ui=Math.abs(ei-Ei),ji=Math.abs(Ai-Hi),gi=Math.abs(ei-xt),Ar=Math.abs(Ai-At),Pr=jt?Ui/Se:Number.POSITIVE_INFINITY,Mr=ue?ji/Ee:Number.POSITIVE_INFINITY;if((gi<=Ui||!jt)&&(Ar<=ji||!ue))break;if(Pr<Mr&&jt||!ue){ei=Ei,Ai+=ie*Pr;const ur=new Pe(ei,Math.round(Ai));z[z.length-1].x===ur.x&&z[z.length-1].y===ur.y||z.push(ur)}else{ei+=Qt*Mr,Ai=Hi;const ur=new Pe(Math.round(ei),Ai);z[z.length-1].x===ur.x&&z[z.length-1].y===ur.y||z.push(ur)}}const mi=new Pe(xt,At);z[z.length-1].x===mi.x&&z[z.length-1].y===mi.y||z.push(mi)}return z}function Ct(h,o,c){if(o.length===0)throw new Error("Subdivision vertex ring is empty.");let g=0,x=h[2*o[0]];for(let B=1;B<o.length;B++){const G=h[2*o[B]];G<x&&(x=G,g=B)}const T=o.length;let A=g,z=(A+1)%T;for(;;){const B=A-1>=0?A-1:T-1,G=(z+1)%T,W=h[2*o[B]],K=h[2*o[G]],ot=h[2*o[A]],ct=h[2*o[A]+1],dt=h[2*o[z]+1];let xt=!1;if(W<K)xt=!0;else if(W>K)xt=!1;else{const At=dt-ct,jt=-(h[2*o[z]]-ot),ue=ct<dt?1:-1;((W-ot)*At+(h[2*o[B]+1]-ct)*jt)*ue>((K-ot)*At+(h[2*o[G]+1]-ct)*jt)*ue&&(xt=!0)}if(xt){const At=o[B],jt=o[A],ue=o[z];At!==jt&&At!==ue&&jt!==ue&&c.push(ue,jt,At),A--,A<0&&(A=T-1)}else{const At=o[G],jt=o[A],ue=o[z];At!==jt&&At!==ue&&jt!==ue&&c.push(ue,jt,At),z++,z>=T&&(z=0)}if(B===G)break}}function bt(h,o,c,g,x,T,A,z,B){const G=x.length/2,W=A&&z&&B;if(G<Nr.MAX_VERTEX_ARRAY_LENGTH){const K=o.prepareSegment(G,c,g),ot=K.vertexLength;for(let xt=0;xt<T.length;xt+=3)g.emplaceBack(ot+T[xt],ot+T[xt+1],ot+T[xt+2]);let ct,dt;K.vertexLength+=G,K.primitiveLength+=T.length/3,W&&(dt=A.prepareSegment(G,c,z),ct=dt.vertexLength,dt.vertexLength+=G);for(let xt=0;xt<x.length;xt+=2)h(x[xt],x[xt+1]);if(W)for(let xt=0;xt<B.length;xt++){const At=B[xt];for(let jt=1;jt<At.length;jt+=2)z.emplaceBack(ct+At[jt-1],ct+At[jt]);dt.primitiveLength+=At.length/2}}else(function(K,ot,ct,dt,xt,At){const jt=[];for(let Ee=0;Ee<dt.length/2;Ee++)jt.push(-1);const ue={count:0};let Qt=0,ie=K.getOrCreateLatestSegment(ot,ct),Se=ie.vertexLength;for(let Ee=2;Ee<xt.length;Ee+=3){const ei=xt[Ee-2],Ai=xt[Ee-1],mi=xt[Ee];let Ei=jt[ei]<Qt,Hi=jt[Ai]<Qt,Ui=jt[mi]<Qt;ie.vertexLength+((Ei?1:0)+(Hi?1:0)+(Ui?1:0))>Nr.MAX_VERTEX_ARRAY_LENGTH&&(ie=K.createNewSegment(ot,ct),Qt=ue.count,Ei=!0,Hi=!0,Ui=!0,Se=0);const ji=Gt(jt,dt,At,ue,ei,Ei,ie),gi=Gt(jt,dt,At,ue,Ai,Hi,ie),Ar=Gt(jt,dt,At,ue,mi,Ui,ie);ct.emplaceBack(Se+ji-Qt,Se+gi-Qt,Se+Ar-Qt),ie.primitiveLength++}})(o,c,g,x,T,h),W&&function(K,ot,ct,dt,xt,At){const jt=[];for(let Ee=0;Ee<dt.length/2;Ee++)jt.push(-1);const ue={count:0};let Qt=0,ie=K.getOrCreateLatestSegment(ot,ct),Se=ie.vertexLength;for(let Ee=0;Ee<xt.length;Ee++){const ei=xt[Ee];for(let Ai=1;Ai<xt[Ee].length;Ai+=2){const mi=ei[Ai-1],Ei=ei[Ai];let Hi=jt[mi]<Qt,Ui=jt[Ei]<Qt;ie.vertexLength+((Hi?1:0)+(Ui?1:0))>Nr.MAX_VERTEX_ARRAY_LENGTH&&(ie=K.createNewSegment(ot,ct),Qt=ue.count,Hi=!0,Ui=!0,Se=0);const ji=Gt(jt,dt,At,ue,mi,Hi,ie),gi=Gt(jt,dt,At,ue,Ei,Ui,ie);ct.emplaceBack(Se+ji-Qt,Se+gi-Qt),ie.primitiveLength++}}}(A,c,z,x,B,h),o.forceNewSegmentOnNextPrepare(),A?.forceNewSegmentOnNextPrepare()}function Gt(h,o,c,g,x,T,A){if(T){const z=g.count;return c(o[2*x],o[2*x+1]),h[x]=g.count,g.count++,A.vertexLength++,z}return h[x]}class zt{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.patternFeatures=[],this.layoutVertexArray=new _e,this.indexArray=new Fi,this.indexArray2=new wi,this.programConfigurations=new hh(o.layers,o.zoom),this.segments=new Nr,this.segments2=new Nr,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){this.hasDependencies=Bp("fill",this.layers,c);const x=this.layers[0].layout.get("fill-sort-key"),T=!x.isConstant(),A=[];for(const{feature:z,id:B,index:G,sourceLayerIndex:W}of o){const K=this.layers[0]._featureFilter.needGeometry,ot=gc(z,K);if(!this.layers[0]._featureFilter.filter(new uo(this.zoom),ot,g))continue;const ct=T?x.evaluate(ot,{},g,c.availableImages):void 0,dt={id:B,properties:z.properties,type:z.type,sourceLayerIndex:W,index:G,geometry:K?ot.geometry:Fl(z),patterns:{},sortKey:ct};A.push(dt)}T&&A.sort((z,B)=>z.sortKey-B.sortKey);for(const z of A){const{geometry:B,index:G,sourceLayerIndex:W}=z;if(this.hasDependencies){const K=Op("fill",this.layers,z,{zoom:this.zoom},c);this.patternFeatures.push(K)}else this.addFeature(z,B,G,g,{},c.subdivisionGranularity);c.featureIndex.insert(o[G].feature,B,G,W,this.index)}}update(o,c,g){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g})}addFeatures(o,c,g){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,c,g,o.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,Om),this.indexBuffer=o.createIndexBuffer(this.indexArray),this.indexBuffer2=o.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(o,c,g,x,T,A){for(const z of th(c,500)){const B=lt(z,x,A.fill.getGranularityForZoomLevel(x.z)),G=this.layoutVertexArray;bt((W,K)=>{G.emplaceBack(W,K)},this.segments,this.layoutVertexArray,this.indexArray,B.verticesFlattened,B.indicesTriangles,this.segments2,this.indexArray2,B.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:T,canonical:x})}}let Zt,Vt;Ki("FillBucket",zt,{omit:["layers","patternFeatures"]});var kt={get paint(){return Vt=Vt||new cs({"fill-antialias":new xr(te.paint_fill["fill-antialias"]),"fill-opacity":new zr(te.paint_fill["fill-opacity"]),"fill-color":new zr(te.paint_fill["fill-color"]),"fill-outline-color":new zr(te.paint_fill["fill-outline-color"]),"fill-translate":new xr(te.paint_fill["fill-translate"]),"fill-translate-anchor":new xr(te.paint_fill["fill-translate-anchor"]),"fill-pattern":new Zh(te.paint_fill["fill-pattern"])})},get layout(){return Zt=Zt||new cs({"fill-sort-key":new zr(te.layout_fill["fill-sort-key"])})}};class Ht extends fl{constructor(o,c){super(o,kt,c)}recalculate(o,c){super.recalculate(o,c);const g=this.paint._values["fill-outline-color"];g.value.kind==="constant"&&g.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(o){return new zt(o)}queryRadius(){return pd(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:o,geometry:c,transform:g,pixelsToTileUnits:x}){return Eu(Rp(o,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-g.bearingInRadians,x),c)}isTileClipped(){return!0}}const pe=Go([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),ae=Go([{name:"a_centroid",components:2,type:"Int16"}],4),{members:Ce}=pe;class ve{constructor(o,c,g,x,T){this.properties={},this.extent=g,this.type=0,this.id=void 0,this._pbf=o,this._geometry=-1,this._keys=x,this._values=T,o.readFields(Fe,this,c)}loadGeometry(){const o=this._pbf;o.pos=this._geometry;const c=o.readVarint()+o.pos,g=[];let x,T=1,A=0,z=0,B=0;for(;o.pos<c;){if(A<=0){const G=o.readVarint();T=7&G,A=G>>3}if(A--,T===1||T===2)z+=o.readSVarint(),B+=o.readSVarint(),T===1&&(x&&g.push(x),x=[]),x&&x.push(new Pe(z,B));else{if(T!==7)throw new Error(`unknown command ${T}`);x&&x.push(x[0].clone())}}return x&&g.push(x),g}bbox(){const o=this._pbf;o.pos=this._geometry;const c=o.readVarint()+o.pos;let g=1,x=0,T=0,A=0,z=1/0,B=-1/0,G=1/0,W=-1/0;for(;o.pos<c;){if(x<=0){const K=o.readVarint();g=7&K,x=K>>3}if(x--,g===1||g===2)T+=o.readSVarint(),A+=o.readSVarint(),T<z&&(z=T),T>B&&(B=T),A<G&&(G=A),A>W&&(W=A);else if(g!==7)throw new Error(`unknown command ${g}`)}return[z,G,B,W]}toGeoJSON(o,c,g){const x=this.extent*Math.pow(2,g),T=this.extent*o,A=this.extent*c,z=this.loadGeometry();function B(ot){return[360*(ot.x+T)/x-180,360/Math.PI*Math.atan(Math.exp((1-2*(ot.y+A)/x)*Math.PI))-90]}function G(ot){return ot.map(B)}let W;if(this.type===1){const ot=[];for(const dt of z)ot.push(dt[0]);const ct=G(ot);W=ot.length===1?{type:"Point",coordinates:ct[0]}:{type:"MultiPoint",coordinates:ct}}else if(this.type===2){const ot=z.map(G);W=ot.length===1?{type:"LineString",coordinates:ot[0]}:{type:"MultiLineString",coordinates:ot}}else{if(this.type!==3)throw new Error("unknown feature type");{const ot=function(dt){const xt=dt.length;if(xt<=1)return[dt];const At=[];let jt,ue;for(let Qt=0;Qt<xt;Qt++){const ie=oi(dt[Qt]);ie!==0&&(ue===void 0&&(ue=ie<0),ue===ie<0?(jt&&At.push(jt),jt=[dt[Qt]]):jt&&jt.push(dt[Qt]))}return jt&&At.push(jt),At}(z),ct=[];for(const dt of ot)ct.push(dt.map(G));W=ct.length===1?{type:"Polygon",coordinates:ct[0]}:{type:"MultiPolygon",coordinates:ct}}}const K={type:"Feature",geometry:W,properties:this.properties};return this.id!=null&&(K.id=this.id),K}}function Fe(h,o,c){h===1?o.id=c.readVarint():h===2?function(g,x){const T=g.readVarint()+g.pos;for(;g.pos<T;){const A=x._keys[g.readVarint()],z=x._values[g.readVarint()];x.properties[A]=z}}(c,o):h===3?o.type=c.readVarint():h===4&&(o._geometry=c.pos)}function oi(h){let o=0;for(let c,g,x=0,T=h.length,A=T-1;x<T;A=x++)c=h[x],g=h[A],o+=(g.x-c.x)*(c.y+g.y);return o}ve.types=["Unknown","Point","LineString","Polygon"];class ge{constructor(o,c){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=o,this._keys=[],this._values=[],this._features=[],o.readFields(re,this,c),this.length=this._features.length}feature(o){if(o<0||o>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[o];const c=this._pbf.readVarint()+this._pbf.pos;return new ve(this._pbf,c,this.extent,this._keys,this._values)}}function re(h,o,c){h===15?o.version=c.readVarint():h===1?o.name=c.readString():h===5?o.extent=c.readVarint():h===2?o._features.push(c.pos):h===3?o._keys.push(c.readString()):h===4&&o._values.push(function(g){let x=null;const T=g.readVarint()+g.pos;for(;g.pos<T;){const A=g.readVarint()>>3;x=A===1?g.readString():A===2?g.readFloat():A===3?g.readDouble():A===4?g.readVarint64():A===5?g.readVarint():A===6?g.readSVarint():A===7?g.readBoolean():null}if(x==null)throw new Error("unknown feature value");return x}(c))}class Be{constructor(o,c){this.layers=o.readFields(Te,{},c)}}function Te(h,o,c){if(h===3){const g=new ge(c,c.readVarint()+c.pos);g.length&&(o[g.name]=g)}}const qe=Math.pow(2,13);function si(h,o,c,g,x,T,A,z){h.emplaceBack(o,c,2*Math.floor(g*qe)+A,x*qe*2,T*qe*2,Math.round(z))}class Ci{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.layoutVertexArray=new ce,this.centroidVertexArray=new Xt,this.indexArray=new Fi,this.programConfigurations=new hh(o.layers,o.zoom),this.segments=new Nr,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){this.features=[],this.hasDependencies=Bp("fill-extrusion",this.layers,c);for(const{feature:x,id:T,index:A,sourceLayerIndex:z}of o){const B=this.layers[0]._featureFilter.needGeometry,G=gc(x,B);if(!this.layers[0]._featureFilter.filter(new uo(this.zoom),G,g))continue;const W={id:T,sourceLayerIndex:z,index:A,geometry:B?G.geometry:Fl(x),properties:x.properties,type:x.type,patterns:{}};this.hasDependencies?this.features.push(Op("fill-extrusion",this.layers,W,{zoom:this.zoom},c)):this.addFeature(W,W.geometry,A,g,{},c.subdivisionGranularity),c.featureIndex.insert(x,W.geometry,A,z,this.index,!0)}}addFeatures(o,c,g){for(const x of this.features){const{geometry:T}=x;this.addFeature(x,T,x.index,c,g,o.subdivisionGranularity)}}update(o,c,g){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g})}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,Ce),this.centroidVertexBuffer=o.createVertexBuffer(this.centroidVertexArray,ae.members,!0),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(o,c,g,x,T,A){for(const z of th(c,500)){const B={x:0,y:0,sampleCount:0},G=this.layoutVertexArray.length;this.processPolygon(B,x,o,z,A);const W=this.layoutVertexArray.length-G,K=Math.floor(B.x/B.sampleCount),ot=Math.floor(B.y/B.sampleCount);for(let ct=0;ct<W;ct++)this.centroidVertexArray.emplaceBack(K,ot)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:T,canonical:x})}processPolygon(o,c,g,x,T){if(x.length<1||Li(x[0]))return;for(const K of x)K.length!==0&&ni(o,K);const A={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},z=T.fill.getGranularityForZoomLevel(c.z),B=ve.types[g.type]==="Polygon";for(const K of x){if(K.length===0||Li(K))continue;const ot=_t(K,z,B);this._generateSideFaces(ot,A)}if(!B)return;const G=lt(x,c,z,!1),W=this.layoutVertexArray;bt((K,ot)=>{si(W,K,ot,0,0,1,1,0)},this.segments,this.layoutVertexArray,this.indexArray,G.verticesFlattened,G.indicesTriangles)}_generateSideFaces(o,c){let g=0;for(let x=1;x<o.length;x++){const T=o[x],A=o[x-1];if(li(T,A))continue;c.segment.vertexLength+4>Nr.MAX_VERTEX_ARRAY_LENGTH&&(c.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const z=T.sub(A)._perp()._unit(),B=A.dist(T);g+B>32768&&(g=0),si(this.layoutVertexArray,T.x,T.y,z.x,z.y,0,0,g),si(this.layoutVertexArray,T.x,T.y,z.x,z.y,0,1,g),g+=B,si(this.layoutVertexArray,A.x,A.y,z.x,z.y,0,0,g),si(this.layoutVertexArray,A.x,A.y,z.x,z.y,0,1,g);const G=c.segment.vertexLength;this.indexArray.emplaceBack(G,G+2,G+1),this.indexArray.emplaceBack(G+1,G+2,G+3),c.segment.vertexLength+=4,c.segment.primitiveLength+=2}}}function ni(h,o){for(let c=0;c<o.length;c++){const g=o[c];c===o.length-1&&o[0].x===g.x&&o[0].y===g.y||(h.x+=g.x,h.y+=g.y,h.sampleCount++)}}function li(h,o){return h.x===o.x&&(h.x<0||h.x>Ln)||h.y===o.y&&(h.y<0||h.y>Ln)}function Li(h){return h.every(o=>o.x<0)||h.every(o=>o.x>Ln)||h.every(o=>o.y<0)||h.every(o=>o.y>Ln)}let Ti;Ki("FillExtrusionBucket",Ci,{omit:["layers","features"]});var xi={get paint(){return Ti=Ti||new cs({"fill-extrusion-opacity":new xr(te["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new zr(te["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new xr(te["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new xr(te["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Zh(te["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new zr(te["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new zr(te["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new xr(te["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class Ii extends fl{constructor(o,c){super(o,xi,c)}createBucket(o){return new Ci(o)}queryRadius(){return pd(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A,pixelPosMatrix:z}){const B=Rp(o,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-T.bearingInRadians,A),G=this.paint.get("fill-extrusion-height").evaluate(c,g),W=this.paint.get("fill-extrusion-base").evaluate(c,g),K=function(ct,dt){const xt=[];for(const At of ct){const jt=[At.x,At.y,0,1];bh(jt,jt,dt),xt.push(new Pe(jt[0]/jt[3],jt[1]/jt[3]))}return xt}(B,z),ot=function(ct,dt,xt,At){const jt=[],ue=[],Qt=At[8]*dt,ie=At[9]*dt,Se=At[10]*dt,Ee=At[11]*dt,ei=At[8]*xt,Ai=At[9]*xt,mi=At[10]*xt,Ei=At[11]*xt;for(const Hi of ct){const Ui=[],ji=[];for(const gi of Hi){const Ar=gi.x,Pr=gi.y,Mr=At[0]*Ar+At[4]*Pr+At[12],ur=At[1]*Ar+At[5]*Pr+At[13],Sn=At[2]*Ar+At[6]*Pr+At[14],is=At[3]*Ar+At[7]*Pr+At[15],xs=Sn+Se,yl=is+Ee,Gc=Mr+ei,Ja=ur+Ai,Sa=Sn+mi,Vs=is+Ei,vs=new Pe((Mr+Qt)/yl,(ur+ie)/yl);vs.z=xs/yl,Ui.push(vs);const Ka=new Pe(Gc/Vs,Ja/Vs);Ka.z=Sa/Vs,ji.push(Ka)}jt.push(Ui),ue.push(ji)}return[jt,ue]}(x,W,G,z);return function(ct,dt,xt){let At=1/0;Eu(xt,dt)&&(At=Fr(xt,dt[0]));for(let jt=0;jt<dt.length;jt++){const ue=dt[jt],Qt=ct[jt];for(let ie=0;ie<ue.length-1;ie++){const Se=ue[ie],Ee=[Se,ue[ie+1],Qt[ie+1],Qt[ie],Se];Dp(xt,Ee)&&(At=Math.min(At,Fr(xt,Ee)))}}return At!==1/0&&At}(ot[0],ot[1],K)}}function Zi(h,o){return h.x*o.x+h.y*o.y}function Fr(h,o){if(h.length===1){let c=0;const g=o[c++];let x;for(;!x||g.equals(x);)if(x=o[c++],!x)return 1/0;for(;c<o.length;c++){const T=o[c],A=h[0],z=x.sub(g),B=T.sub(g),G=A.sub(g),W=Zi(z,z),K=Zi(z,B),ot=Zi(B,B),ct=Zi(G,z),dt=Zi(G,B),xt=W*ot-K*K,At=(ot*ct-K*dt)/xt,jt=(W*dt-K*ct)/xt,ue=g.z*(1-At-jt)+x.z*At+T.z*jt;if(isFinite(ue))return ue}return 1/0}{let c=1/0;for(const g of o)c=Math.min(c,g.z);return c}}const qr=Go([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:En}=qr,ar=Go([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:jr}=ar,br=Math.cos(Math.PI/180*37.5),xn=Math.pow(2,14)/.5;class Vr{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(c=>{this.gradients[c.id]={}}),this.layoutVertexArray=new me,this.layoutVertexArray2=new be,this.indexArray=new Fi,this.programConfigurations=new hh(o.layers,o.zoom),this.segments=new Nr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){this.hasDependencies=Bp("line",this.layers,c)||this.hasLineDasharray(this.layers);const x=this.layers[0].layout.get("line-sort-key"),T=!x.isConstant(),A=[];for(const{feature:z,id:B,index:G,sourceLayerIndex:W}of o){const K=this.layers[0]._featureFilter.needGeometry,ot=gc(z,K);if(!this.layers[0]._featureFilter.filter(new uo(this.zoom),ot,g))continue;const ct=T?x.evaluate(ot,{},g):void 0,dt={id:B,properties:z.properties,type:z.type,sourceLayerIndex:W,index:G,geometry:K?ot.geometry:Fl(z),patterns:{},dashes:{},sortKey:ct};A.push(dt)}T&&A.sort((z,B)=>z.sortKey-B.sortKey);for(const z of A){const{geometry:B,index:G,sourceLayerIndex:W}=z;this.hasDependencies?(Bp("line",this.layers,c)?Op("line",this.layers,z,{zoom:this.zoom},c):this.hasLineDasharray(this.layers)&&this.addLineDashDependencies(this.layers,z,this.zoom,c),this.patternFeatures.push(z)):this.addFeature(z,B,G,g,{},{},c.subdivisionGranularity),c.featureIndex.insert(o[G].feature,B,G,W,this.index)}}update(o,c,g,x){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g,dashPositions:x})}addFeatures(o,c,g,x){for(const T of this.patternFeatures)this.addFeature(T,T.geometry,T.index,c,g,x,o.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=o.createVertexBuffer(this.layoutVertexArray2,jr)),this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,En),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(o){if(o.properties&&Object.prototype.hasOwnProperty.call(o.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(o.properties,"mapbox_clip_end"))return{start:+o.properties.mapbox_clip_start,end:+o.properties.mapbox_clip_end}}addFeature(o,c,g,x,T,A,z){const B=this.layers[0].layout,G=B.get("line-join").evaluate(o,{}),W=B.get("line-cap"),K=B.get("line-miter-limit"),ot=B.get("line-round-limit");this.lineClips=this.lineFeatureClips(o);for(const ct of c)this.addLine(ct,o,G,W,K,ot,x,z);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:T,dashPositions:A,canonical:x})}addLine(o,c,g,x,T,A,z,B){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,o=_t(o,z?B.line.getGranularityForZoomLevel(z.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Qt=0;Qt<o.length-1;Qt++)this.totalDistance+=o[Qt].dist(o[Qt+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const G=ve.types[c.type]==="Polygon";let W=o.length;for(;W>=2&&o[W-1].equals(o[W-2]);)W--;let K=0;for(;K<W-1&&o[K].equals(o[K+1]);)K++;if(W<(G?3:2))return;g==="bevel"&&(T=1.05);const ot=this.overscaling<=16?122880/(512*this.overscaling):0,ct=this.segments.prepareSegment(10*W,this.layoutVertexArray,this.indexArray);let dt,xt,At,jt,ue;this.e1=this.e2=-1,G&&(dt=o[W-2],ue=o[K].sub(dt)._unit()._perp());for(let Qt=K;Qt<W;Qt++){if(At=Qt===W-1?G?o[K+1]:void 0:o[Qt+1],At&&o[Qt].equals(At))continue;ue&&(jt=ue),dt&&(xt=dt),dt=o[Qt],ue=At?At.sub(dt)._unit()._perp():jt,jt=jt||ue;let ie=jt.add(ue);ie.x===0&&ie.y===0||ie._unit();const Se=jt.x*ue.x+jt.y*ue.y,Ee=ie.x*ue.x+ie.y*ue.y,ei=Ee!==0?1/Ee:1/0,Ai=2*Math.sqrt(2-2*Ee),mi=Ee<br&&xt&&At,Ei=jt.x*ue.y-jt.y*ue.x>0;if(mi&&Qt>K){const ji=dt.dist(xt);if(ji>2*ot){const gi=dt.sub(dt.sub(xt)._mult(ot/ji)._round());this.updateDistance(xt,gi),this.addCurrentVertex(gi,jt,0,0,ct),xt=gi}}const Hi=xt&&At;let Ui=Hi?g:G?"butt":x;if(Hi&&Ui==="round"&&(ei<A?Ui="miter":ei<=2&&(Ui="fakeround")),Ui==="miter"&&ei>T&&(Ui="bevel"),Ui==="bevel"&&(ei>2&&(Ui="flipbevel"),ei<T&&(Ui="miter")),xt&&this.updateDistance(xt,dt),Ui==="miter")ie._mult(ei),this.addCurrentVertex(dt,ie,0,0,ct);else if(Ui==="flipbevel"){if(ei>100)ie=ue.mult(-1);else{const ji=ei*jt.add(ue).mag()/jt.sub(ue).mag();ie._perp()._mult(ji*(Ei?-1:1))}this.addCurrentVertex(dt,ie,0,0,ct),this.addCurrentVertex(dt,ie.mult(-1),0,0,ct)}else if(Ui==="bevel"||Ui==="fakeround"){const ji=-Math.sqrt(ei*ei-1),gi=Ei?ji:0,Ar=Ei?0:ji;if(xt&&this.addCurrentVertex(dt,jt,gi,Ar,ct),Ui==="fakeround"){const Pr=Math.round(180*Ai/Math.PI/20);for(let Mr=1;Mr<Pr;Mr++){let ur=Mr/Pr;if(ur!==.5){const is=ur-.5;ur+=ur*is*(ur-1)*((1.0904+Se*(Se*(3.55645-1.43519*Se)-3.2452))*is*is+(.848013+Se*(.215638*Se-1.06021)))}const Sn=ue.sub(jt)._mult(ur)._add(jt)._unit()._mult(Ei?-1:1);this.addHalfVertex(dt,Sn.x,Sn.y,!1,Ei,0,ct)}}At&&this.addCurrentVertex(dt,ue,-gi,-Ar,ct)}else if(Ui==="butt")this.addCurrentVertex(dt,ie,0,0,ct);else if(Ui==="square"){const ji=xt?1:-1;this.addCurrentVertex(dt,ie,ji,ji,ct)}else Ui==="round"&&(xt&&(this.addCurrentVertex(dt,jt,0,0,ct),this.addCurrentVertex(dt,jt,1,1,ct,!0)),At&&(this.addCurrentVertex(dt,ue,-1,-1,ct,!0),this.addCurrentVertex(dt,ue,0,0,ct)));if(mi&&Qt<W-1){const ji=dt.dist(At);if(ji>2*ot){const gi=dt.add(At.sub(dt)._mult(ot/ji)._round());this.updateDistance(dt,gi),this.addCurrentVertex(gi,ue,0,0,ct),dt=gi}}}}addCurrentVertex(o,c,g,x,T,A=!1){const z=c.y*x-c.x,B=-c.y-c.x*x;this.addHalfVertex(o,c.x+c.y*g,c.y-c.x*g,A,!1,g,T),this.addHalfVertex(o,z,B,A,!0,-x,T),this.distance>xn/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(o,c,g,x,T,A))}addHalfVertex({x:o,y:c},g,x,T,A,z,B){const G=.5*(this.lineClips?this.scaledDistance*(xn-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((o<<1)+(T?1:0),(c<<1)+(A?1:0),Math.round(63*g)+128,Math.round(63*x)+128,1+(z===0?0:z<0?-1:1)|(63&G)<<2,G>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const W=B.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,W,this.e2),B.primitiveLength++),A?this.e2=W:this.e1=W}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(o,c){this.distance+=o.dist(c),this.updateScaledDistance()}hasLineDasharray(o){for(const c of o){const g=c.paint.get("line-dasharray");if(g&&!g.isConstant())return!0}return!1}addLineDashDependencies(o,c,g,x){for(const T of o){const A=T.paint.get("line-dasharray");if(!A||A.value.kind==="constant")continue;const z=T.layout.get("line-cap")==="round",B={dasharray:A.value.evaluate({zoom:g-1},c,{}),round:z},G={dasharray:A.value.evaluate({zoom:g},c,{}),round:z},W={dasharray:A.value.evaluate({zoom:g+1},c,{}),round:z},K=`${B.dasharray.join(",")},${B.round}`,ot=`${G.dasharray.join(",")},${G.round}`,ct=`${W.dasharray.join(",")},${W.round}`;x.dashDependencies[K]=B,x.dashDependencies[ot]=G,x.dashDependencies[ct]=W,c.dashes[T.id]={min:K,mid:ot,max:ct}}}}let kn,Kr;Ki("LineBucket",Vr,{omit:["layers","patternFeatures"]});var wr={get paint(){return Kr=Kr||new cs({"line-opacity":new zr(te.paint_line["line-opacity"]),"line-color":new zr(te.paint_line["line-color"]),"line-translate":new xr(te.paint_line["line-translate"]),"line-translate-anchor":new xr(te.paint_line["line-translate-anchor"]),"line-width":new zr(te.paint_line["line-width"]),"line-gap-width":new zr(te.paint_line["line-gap-width"]),"line-offset":new zr(te.paint_line["line-offset"]),"line-blur":new zr(te.paint_line["line-blur"]),"line-dasharray":new Zh(te.paint_line["line-dasharray"]),"line-pattern":new Zh(te.paint_line["line-pattern"]),"line-gradient":new lh(te.paint_line["line-gradient"])})},get layout(){return kn=kn||new cs({"line-cap":new xr(te.layout_line["line-cap"]),"line-join":new zr(te.layout_line["line-join"]),"line-miter-limit":new xr(te.layout_line["line-miter-limit"]),"line-round-limit":new xr(te.layout_line["line-round-limit"]),"line-sort-key":new zr(te.layout_line["line-sort-key"])})}};class ln extends zr{possiblyEvaluate(o,c){return c=new uo(Math.floor(c.zoom),{now:c.now,fadeDuration:c.fadeDuration,zoomHistory:c.zoomHistory,transition:c.transition}),super.possiblyEvaluate(o,c)}evaluate(o,c,g,x){return c=Wo({},c,{zoom:Math.floor(c.zoom)}),super.evaluate(o,c,g,x)}}let Er;class eo extends fl{constructor(o,c){super(o,wr,c),this.gradientVersion=0,Er||(Er=new ln(wr.paint.properties["line-width"].specification),Er.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(o){if(o==="line-gradient"){const c=this.gradientExpression();this.stepInterpolant=!!function(g){return g._styleExpression!==void 0}(c)&&c._styleExpression.expression instanceof Ih,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(o,c){super.recalculate(o,c),this.paint._values["line-floorwidth"]=Er.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,o)}createBucket(o){return new Vr(o)}queryRadius(o){const c=o,g=cn(Au("line-width",this,c),Au("line-gap-width",this,c)),x=Au("line-offset",this,c);return g/2+Math.abs(x)+pd(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A}){const z=Rp(o,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-T.bearingInRadians,A),B=A/2*cn(this.paint.get("line-width").evaluate(c,g),this.paint.get("line-gap-width").evaluate(c,g)),G=this.paint.get("line-offset").evaluate(c,g);return G&&(x=function(W,K){const ot=[];for(let ct=0;ct<W.length;ct++){const dt=W[ct],xt=[];for(let At=0;At<dt.length;At++){const jt=dt[At-1],ue=dt[At],Qt=dt[At+1],ie=At===0?new Pe(0,0):ue.sub(jt)._unit()._perp(),Se=At===dt.length-1?new Pe(0,0):Qt.sub(ue)._unit()._perp(),Ee=ie._add(Se)._unit(),ei=Ee.x*Se.x+Ee.y*Se.y;ei!==0&&Ee._mult(1/ei),xt.push(Ee._mult(K)._add(ue))}ot.push(xt)}return ot}(x,G*A)),function(W,K,ot){for(let ct=0;ct<K.length;ct++){const dt=K[ct];if(W.length>=3){for(let xt=0;xt<dt.length;xt++)if(dd(W,dt[xt]))return!0}if(Cm(W,dt,ot))return!0}return!1}(z,x,B)}isTileClipped(){return!0}}function cn(h,o){return o>0?o+2*h:h}const cr=Go([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Wr=Go([{name:"a_projected_pos",components:3,type:"Float32"}],4);Go([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const fo=Go([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);Go([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Uo=Go([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),So=Go([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Ro(h,o,c){return h.sections.forEach(g=>{g.text=function(x,T,A){const z=T.layout.get("text-transform").evaluate(A,{});return z==="uppercase"?x=x.toLocaleUpperCase():z==="lowercase"&&(x=x.toLocaleLowerCase()),Oc.applyArabicShaping&&(x=Oc.applyArabicShaping(x)),x}(g.text,o,c)}),h}Go([{name:"triangle",components:3,type:"Uint16"}]),Go([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Go([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Go([{type:"Float32",name:"offsetX"}]),Go([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Go([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);var mo=24;const ha={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""},wa={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},Fa={40:!0};function tc(h,o,c,g,x,T){if("fontStack"in o){const A=c[o.fontStack],z=A&&A[h];return z?z.metrics.advance*o.scale+x:0}{const A=g[o.imageName];return A?A.displaySize[0]*o.scale*mo/T+x:0}}function ua(h,o,c,g){const x=Math.pow(h-o,2);return g?h<o?x/2:2*x:x+Math.abs(c)*c}function yc(h,o,c){let g=0;return h===10&&(g-=1e4),c&&(g+=150),h!==40&&h!==65288||(g+=50),o!==41&&o!==65289||(g+=50),g}function xc(h,o,c,g,x,T){let A=null,z=ua(o,c,x,T);for(const B of g){const G=ua(o-B.x,c,x,T)+B.badness;G<=z&&(A=B,z=G)}return{index:h,x:o,priorBreak:A,badness:z}}function Bs(h){return h?Bs(h.priorBreak).concat(h.index):[]}class io{constructor(o="",c=[],g=[]){this.text=o,this.sections=c,this.sectionIndex=g,this.imageSectionID=null}static fromFeature(o,c){const g=new io;for(let x=0;x<o.sections.length;x++){const T=o.sections[x];T.image?g.addImageSection(T):g.addTextSection(T,c)}return g}length(){return[...this.text].length}getSection(o){return this.sections[this.sectionIndex[o]]}getSectionIndex(o){return this.sectionIndex[o]}verticalizePunctuation(){this.text=function(o){let c="",g={premature:!0,value:void 0};const x=o[Symbol.iterator]();let T=x.next();const A=o[Symbol.iterator]();A.next();let z=A.next();for(;!T.done;)c+=!z.done&&dc(z.value.codePointAt(0))&&!ha[z.value]||!g.premature&&dc(g.value.codePointAt(0))&&!ha[g.value]||!ha[T.value]?T.value:ha[T.value],g={value:T.value,premature:!1},T=x.next(),z=A.next();return c}(this.text)}hasZeroWidthSpaces(){return this.text.includes("")}trim(){const o=this.text.match(/^\s*/),c=o?o[0].length:0,g=this.text.match(/\S\s*$/),x=g?g[0].length-1:0;this.text=this.text.substring(c,this.text.length-x),this.sectionIndex=this.sectionIndex.slice(c,this.sectionIndex.length-x)}substring(o,c){const g=[...this.text].slice(o,c).join(""),x=this.sectionIndex.slice(o,c);return new io(g,this.sections,x)}toCodeUnitIndex(o){return[...this.text].slice(0,o).join("").length}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((o,c)=>Math.max(o,this.sections[c].scale),0)}getMaxImageSize(o){let c=0,g=0;for(let x=0;x<this.length();x++){const T=this.getSection(x);if("imageName"in T){const A=o[T.imageName];if(!A)continue;const z=A.displaySize;c=Math.max(c,z[0]),g=Math.max(g,z[1])}}return{maxImageWidth:c,maxImageHeight:g}}addTextSection(o,c){this.text+=o.text,this.sections.push({scale:o.scale||1,verticalAlign:o.verticalAlign||"bottom",fontStack:o.fontStack||c});const g=this.sections.length-1;this.sectionIndex.push(...[...o.text].map(()=>g))}addImageSection(o){const c=o.image?o.image.name:"";if(c.length===0)return void vo("Can't add FormattedSection with an empty image.");const g=this.getNextImageSectionCharCode();g?(this.text+=String.fromCharCode(g),this.sections.push({scale:1,verticalAlign:o.verticalAlign||"bottom",imageName:c}),this.sectionIndex.push(this.sections.length-1)):vo("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}determineLineBreaks(o,c,g,x,T){const A=[],z=this.determineAverageLineWidth(o,c,g,x,T),B=this.hasZeroWidthSpaces();let G=0,W=0;const K=this.text[Symbol.iterator]();let ot=K.next();const ct=this.text[Symbol.iterator]();ct.next();let dt=ct.next();const xt=this.text[Symbol.iterator]();xt.next(),xt.next();let At=xt.next();for(;!ot.done;){const jt=this.getSection(W),ue=ot.value.codePointAt(0);if(mf(ue)||(G+=tc(ue,jt,g,x,o,T)),!dt.done){const Qt=ff(ue),ie=dt.value.codePointAt(0);(wa[ue]||Qt||"imageName"in jt||!At.done&&Fa[ie])&&A.push(xc(W+1,G,z,A,yc(ue,ie,Qt&&B),!1))}W++,ot=K.next(),dt=ct.next(),At=xt.next()}return Bs(xc(this.length(),G,z,A,0,!0))}determineAverageLineWidth(o,c,g,x,T){let A=0,z=0;for(const B of this.text){const G=this.getSection(z);A+=tc(B.codePointAt(0),G,g,x,o,T),z++}return A/Math.max(1,Math.ceil(A/c))}}const ko=4294967296,Dn=1/ko,$o=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");class As{constructor(o=new Uint8Array(16)){this.buf=ArrayBuffer.isView(o)?o:new Uint8Array(o),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(o,c,g=this.length){for(;this.pos<g;){const x=this.readVarint(),T=x>>3,A=this.pos;this.type=7&x,o(T,c,this),this.pos===A&&this.skip(x)}return c}readMessage(o,c){return this.readFields(o,c,this.readVarint()+this.pos)}readFixed32(){const o=this.dataView.getUint32(this.pos,!0);return this.pos+=4,o}readSFixed32(){const o=this.dataView.getInt32(this.pos,!0);return this.pos+=4,o}readFixed64(){const o=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*ko;return this.pos+=8,o}readSFixed64(){const o=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*ko;return this.pos+=8,o}readFloat(){const o=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,o}readDouble(){const o=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,o}readVarint(o){const c=this.buf;let g,x;return x=c[this.pos++],g=127&x,x<128?g:(x=c[this.pos++],g|=(127&x)<<7,x<128?g:(x=c[this.pos++],g|=(127&x)<<14,x<128?g:(x=c[this.pos++],g|=(127&x)<<21,x<128?g:(x=c[this.pos],g|=(15&x)<<28,function(T,A,z){const B=z.buf;let G,W;if(W=B[z.pos++],G=(112&W)>>4,W<128||(W=B[z.pos++],G|=(127&W)<<3,W<128)||(W=B[z.pos++],G|=(127&W)<<10,W<128)||(W=B[z.pos++],G|=(127&W)<<17,W<128)||(W=B[z.pos++],G|=(127&W)<<24,W<128)||(W=B[z.pos++],G|=(1&W)<<31,W<128))return ro(T,G,A);throw new Error("Expected varint not more than 10 bytes")}(g,o,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const o=this.readVarint();return o%2==1?(o+1)/-2:o/2}readBoolean(){return!!this.readVarint()}readString(){const o=this.readVarint()+this.pos,c=this.pos;return this.pos=o,o-c>=12&&$o?$o.decode(this.buf.subarray(c,o)):function(g,x,T){let A="",z=x;for(;z<T;){const B=g[z];let G,W,K,ot=null,ct=B>239?4:B>223?3:B>191?2:1;if(z+ct>T)break;ct===1?B<128&&(ot=B):ct===2?(G=g[z+1],(192&G)==128&&(ot=(31&B)<<6|63&G,ot<=127&&(ot=null))):ct===3?(G=g[z+1],W=g[z+2],(192&G)==128&&(192&W)==128&&(ot=(15&B)<<12|(63&G)<<6|63&W,(ot<=2047||ot>=55296&&ot<=57343)&&(ot=null))):ct===4&&(G=g[z+1],W=g[z+2],K=g[z+3],(192&G)==128&&(192&W)==128&&(192&K)==128&&(ot=(15&B)<<18|(63&G)<<12|(63&W)<<6|63&K,(ot<=65535||ot>=1114112)&&(ot=null))),ot===null?(ot=65533,ct=1):ot>65535&&(ot-=65536,A+=String.fromCharCode(ot>>>10&1023|55296),ot=56320|1023&ot),A+=String.fromCharCode(ot),z+=ct}return A}(this.buf,c,o)}readBytes(){const o=this.readVarint()+this.pos,c=this.buf.subarray(this.pos,o);return this.pos=o,c}readPackedVarint(o=[],c){const g=this.readPackedEnd();for(;this.pos<g;)o.push(this.readVarint(c));return o}readPackedSVarint(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readSVarint());return o}readPackedBoolean(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readBoolean());return o}readPackedFloat(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readFloat());return o}readPackedDouble(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readDouble());return o}readPackedFixed32(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readFixed32());return o}readPackedSFixed32(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readSFixed32());return o}readPackedFixed64(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readFixed64());return o}readPackedSFixed64(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readSFixed64());return o}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(o){const c=7&o;if(c===0)for(;this.buf[this.pos++]>127;);else if(c===2)this.pos=this.readVarint()+this.pos;else if(c===5)this.pos+=4;else{if(c!==1)throw new Error(`Unimplemented type: ${c}`);this.pos+=8}}writeTag(o,c){this.writeVarint(o<<3|c)}realloc(o){let c=this.length||16;for(;c<this.pos+o;)c*=2;if(c!==this.length){const g=new Uint8Array(c);g.set(this.buf),this.buf=g,this.dataView=new DataView(g.buffer),this.length=c}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(o){this.realloc(4),this.dataView.setInt32(this.pos,o,!0),this.pos+=4}writeSFixed32(o){this.realloc(4),this.dataView.setInt32(this.pos,o,!0),this.pos+=4}writeFixed64(o){this.realloc(8),this.dataView.setInt32(this.pos,-1&o,!0),this.dataView.setInt32(this.pos+4,Math.floor(o*Dn),!0),this.pos+=8}writeSFixed64(o){this.realloc(8),this.dataView.setInt32(this.pos,-1&o,!0),this.dataView.setInt32(this.pos+4,Math.floor(o*Dn),!0),this.pos+=8}writeVarint(o){(o=+o||0)>268435455||o<0?function(c,g){let x,T;if(c>=0?(x=c%4294967296|0,T=c/4294967296|0):(x=~(-c%4294967296),T=~(-c/4294967296),4294967295^x?x=x+1|0:(x=0,T=T+1|0)),c>=18446744073709552e3||c<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");g.realloc(10),function(A,z,B){B.buf[B.pos++]=127&A|128,A>>>=7,B.buf[B.pos++]=127&A|128,A>>>=7,B.buf[B.pos++]=127&A|128,A>>>=7,B.buf[B.pos++]=127&A|128,B.buf[B.pos]=127&(A>>>=7)}(x,0,g),function(A,z){const B=(7&A)<<4;z.buf[z.pos++]|=B|((A>>>=3)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A)))))}(T,g)}(o,this):(this.realloc(4),this.buf[this.pos++]=127&o|(o>127?128:0),o<=127||(this.buf[this.pos++]=127&(o>>>=7)|(o>127?128:0),o<=127||(this.buf[this.pos++]=127&(o>>>=7)|(o>127?128:0),o<=127||(this.buf[this.pos++]=o>>>7&127))))}writeSVarint(o){this.writeVarint(o<0?2*-o-1:2*o)}writeBoolean(o){this.writeVarint(+o)}writeString(o){o=String(o),this.realloc(4*o.length),this.pos++;const c=this.pos;this.pos=function(x,T,A){for(let z,B,G=0;G<T.length;G++){if(z=T.charCodeAt(G),z>55295&&z<57344){if(!B){z>56319||G+1===T.length?(x[A++]=239,x[A++]=191,x[A++]=189):B=z;continue}if(z<56320){x[A++]=239,x[A++]=191,x[A++]=189,B=z;continue}z=B-55296<<10|z-56320|65536,B=null}else B&&(x[A++]=239,x[A++]=191,x[A++]=189,B=null);z<128?x[A++]=z:(z<2048?x[A++]=z>>6|192:(z<65536?x[A++]=z>>12|224:(x[A++]=z>>18|240,x[A++]=z>>12&63|128),x[A++]=z>>6&63|128),x[A++]=63&z|128)}return A}(this.buf,o,this.pos);const g=this.pos-c;g>=128&&ec(c,g,this),this.pos=c-1,this.writeVarint(g),this.pos+=g}writeFloat(o){this.realloc(4),this.dataView.setFloat32(this.pos,o,!0),this.pos+=4}writeDouble(o){this.realloc(8),this.dataView.setFloat64(this.pos,o,!0),this.pos+=8}writeBytes(o){const c=o.length;this.writeVarint(c),this.realloc(c);for(let g=0;g<c;g++)this.buf[this.pos++]=o[g]}writeRawMessage(o,c){this.pos++;const g=this.pos;o(c,this);const x=this.pos-g;x>=128&&ec(g,x,this),this.pos=g-1,this.writeVarint(x),this.pos+=x}writeMessage(o,c,g){this.writeTag(o,2),this.writeRawMessage(c,g)}writePackedVarint(o,c){c.length&&this.writeMessage(o,Np,c)}writePackedSVarint(o,c){c.length&&this.writeMessage(o,Cu,c)}writePackedBoolean(o,c){c.length&&this.writeMessage(o,vc,c)}writePackedFloat(o,c){c.length&&this.writeMessage(o,Vp,c)}writePackedDouble(o,c){c.length&&this.writeMessage(o,Up,c)}writePackedFixed32(o,c){c.length&&this.writeMessage(o,Kh,c)}writePackedSFixed32(o,c){c.length&&this.writeMessage(o,Os,c)}writePackedFixed64(o,c){c.length&&this.writeMessage(o,bc,c)}writePackedSFixed64(o,c){c.length&&this.writeMessage(o,Yd,c)}writeBytesField(o,c){this.writeTag(o,2),this.writeBytes(c)}writeFixed32Field(o,c){this.writeTag(o,5),this.writeFixed32(c)}writeSFixed32Field(o,c){this.writeTag(o,5),this.writeSFixed32(c)}writeFixed64Field(o,c){this.writeTag(o,1),this.writeFixed64(c)}writeSFixed64Field(o,c){this.writeTag(o,1),this.writeSFixed64(c)}writeVarintField(o,c){this.writeTag(o,0),this.writeVarint(c)}writeSVarintField(o,c){this.writeTag(o,0),this.writeSVarint(c)}writeStringField(o,c){this.writeTag(o,2),this.writeString(c)}writeFloatField(o,c){this.writeTag(o,5),this.writeFloat(c)}writeDoubleField(o,c){this.writeTag(o,1),this.writeDouble(c)}writeBooleanField(o,c){this.writeVarintField(o,+c)}}function ro(h,o,c){return c?4294967296*o+(h>>>0):4294967296*(o>>>0)+(h>>>0)}function ec(h,o,c){const g=o<=16383?1:o<=2097151?2:o<=268435455?3:Math.floor(Math.log(o)/(7*Math.LN2));c.realloc(g);for(let x=c.pos-1;x>=h;x--)c.buf[x+g]=c.buf[x]}function Np(h,o){for(let c=0;c<h.length;c++)o.writeVarint(h[c])}function Cu(h,o){for(let c=0;c<h.length;c++)o.writeSVarint(h[c])}function Vp(h,o){for(let c=0;c<h.length;c++)o.writeFloat(h[c])}function Up(h,o){for(let c=0;c<h.length;c++)o.writeDouble(h[c])}function vc(h,o){for(let c=0;c<h.length;c++)o.writeBoolean(h[c])}function Kh(h,o){for(let c=0;c<h.length;c++)o.writeFixed32(h[c])}function Os(h,o){for(let c=0;c<h.length;c++)o.writeSFixed32(h[c])}function bc(h,o){for(let c=0;c<h.length;c++)o.writeFixed64(h[c])}function Yd(h,o){for(let c=0;c<h.length;c++)o.writeSFixed64(h[c])}function wg(h,o,c){h===1&&c.readMessage(em,o)}function em(h,o,c){if(h===3){const{id:g,bitmap:x,width:T,height:A,left:z,top:B,advance:G}=c.readMessage(ex,{});o.push({id:g,bitmap:new Pu({width:T+6,height:A+6},x),metrics:{width:T,height:A,left:z,top:B,advance:G}})}}function ex(h,o,c){h===1?o.id=c.readVarint():h===2?o.bitmap=c.readBytes():h===3?o.width=c.readVarint():h===4?o.height=c.readVarint():h===5?o.left=c.readSVarint():h===6?o.top=c.readSVarint():h===7&&(o.advance=c.readVarint())}function x_(h){let o=0,c=0;for(const A of h)o+=A.w*A.h,c=Math.max(c,A.w);h.sort((A,z)=>z.h-A.h);const g=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(o/.95)),c),h:1/0}];let x=0,T=0;for(const A of h)for(let z=g.length-1;z>=0;z--){const B=g[z];if(!(A.w>B.w||A.h>B.h)){if(A.x=B.x,A.y=B.y,T=Math.max(T,A.y+A.h),x=Math.max(x,A.x+A.w),A.w===B.w&&A.h===B.h){const G=g.pop();G&&z<g.length&&(g[z]=G)}else A.h===B.h?(B.x+=A.w,B.w-=A.w):A.w===B.w?(B.y+=A.h,B.h-=A.h):(g.push({x:B.x+A.w,y:B.y,w:B.w-A.w,h:A.h}),B.y+=A.h,B.h-=A.h);break}}return{w:x,h:T,fill:o/(x*T)||0}}class im{constructor(o,{pixelRatio:c,version:g,stretchX:x,stretchY:T,content:A,textFitWidth:z,textFitHeight:B}){this.paddedRect=o,this.pixelRatio=c,this.stretchX=x,this.stretchY=T,this.content=A,this.version=g,this.textFitWidth=z,this.textFitHeight=B}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Dy{constructor(o,c){const g={},x={};this.haveRenderCallbacks=[];const T=[];this.addImages(o,g,T),this.addImages(c,x,T);const{w:A,h:z}=x_(T),B=new ba({width:A||1,height:z||1});for(const G in o){const W=o[G],K=g[G].paddedRect;ba.copy(W.data,B,{x:0,y:0},{x:K.x+1,y:K.y+1},W.data)}for(const G in c){const W=c[G],K=x[G].paddedRect,ot=K.x+1,ct=K.y+1,dt=W.data.width,xt=W.data.height;ba.copy(W.data,B,{x:0,y:0},{x:ot,y:ct},W.data),ba.copy(W.data,B,{x:0,y:xt-1},{x:ot,y:ct-1},{width:dt,height:1}),ba.copy(W.data,B,{x:0,y:0},{x:ot,y:ct+xt},{width:dt,height:1}),ba.copy(W.data,B,{x:dt-1,y:0},{x:ot-1,y:ct},{width:1,height:xt}),ba.copy(W.data,B,{x:0,y:0},{x:ot+dt,y:ct},{width:1,height:xt})}this.image=B,this.iconPositions=g,this.patternPositions=x}addImages(o,c,g){for(const x in o){const T=o[x],A={x:0,y:0,w:T.data.width+2,h:T.data.height+2};g.push(A),c[x]=new im(A,T),T.hasRenderCallback&&this.haveRenderCallbacks.push(x)}}patchUpdatedImages(o,c){o.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const g in o.updatedImages)this.patchUpdatedImage(this.iconPositions[g],o.getImage(g),c),this.patchUpdatedImage(this.patternPositions[g],o.getImage(g),c)}patchUpdatedImage(o,c,g){if(!o||!c||o.version===c.version)return;o.version=c.version;const[x,T]=o.tl;g.update(c.data,void 0,{x,y:T})}}var Jd;function Tg(h,o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt){const xt=io.fromFeature(h,x);let At;K===it.ay.vertical&&xt.verticalizePunctuation();let jt=xt.determineLineBreaks(G,T,o,g,ct);const{processBidirectionalText:ue,processStyledBidirectionalText:Qt}=Oc;if(ue&&xt.sections.length===1){At=[],jt=jt.map(ei=>xt.toCodeUnitIndex(ei));const Ee=ue(xt.toString(),jt);for(const ei of Ee){const Ai=[...ei].map(()=>0);At.push(new io(ei,xt.sections,Ai))}}else if(Qt){At=[],jt=jt.map(mi=>xt.toCodeUnitIndex(mi));let Ee=0;const ei=[];for(const mi of xt.text)ei.push(...Array(mi.length).fill(xt.sectionIndex[Ee])),Ee++;const Ai=Qt(xt.text,ei,jt);for(const mi of Ai){const Ei=[];let Hi="";for(const Ui of mi[0])Ei.push(mi[1][Hi.length]),Hi+=Ui;At.push(new io(mi[0],xt.sections,Ei))}}else At=function(Ee,ei){const Ai=[];let mi=0;for(const Ei of ei)Ai.push(Ee.substring(mi,Ei)),mi=Ei;return mi<Ee.length()&&Ai.push(Ee.substring(mi,Ee.length())),Ai}(xt,jt);const ie=[],Se={positionedLines:ie,text:xt.toString(),top:W[1],bottom:W[1],left:W[0],right:W[0],writingMode:K,iconsInText:!1,verticalizable:!1};return function(Ee,ei,Ai,mi,Ei,Hi,Ui,ji,gi,Ar,Pr,Mr){let ur=0,Sn=0,is=0,xs=0;const yl=ji==="right"?1:ji==="left"?0:.5,Gc=mo/Mr;let Ja=0;for(const vs of Ei){vs.trim();const Ka=vs.getMaxScale(),xl={positionedGlyphs:[],lineOffset:0};Ee.positionedLines[Ja]=xl;const Bl=xl.positionedGlyphs;let Ic=0;if(!vs.length()){Sn+=Hi,++Ja;continue}const vl=fd(mi,vs,Gc);let Ol=0;for(const Ia of vs.text){const bs=vs.getSection(Ol),Xs=Ia.codePointAt(0),Ps=zy(gi,Pr,Xs),Na={glyph:Xs,imageName:null,x:ur,y:Sn+-17,vertical:Ps,scale:1,fontStack:"",sectionIndex:vs.getSectionIndex(Ol),metrics:null,rect:null};let Td;if("fontStack"in bs){if(Td=Ly(bs,Xs,Ps,vl,ei,Ai),!Td)continue;Na.fontStack=bs.fontStack}else{if(Ee.iconsInText=!0,bs.scale*=Gc,Td=Sg(bs,Ps,Ka,vl,mi),!Td)continue;Ic=Math.max(Ic,Td.imageOffset),Na.imageName=bs.imageName}const{rect:zu,metrics:ng,baselineOffset:Yp}=Td;Na.y+=Yp,Na.scale=bs.scale,Na.metrics=ng,Na.rect=zu,Bl.push(Na),Ps?(Ee.verticalizable=!0,ur+=("imageName"in bs?ng.advance:mo)*bs.scale+Ar):ur+=ng.advance*bs.scale+Ar,Ol++}Bl.length!==0&&(is=Math.max(ur-Ar,is),v_(Bl,0,Bl.length-1,yl)),ur=0,xl.lineOffset=Math.max(Ic,(Ka-1)*mo);const ru=Hi*Ka+Ic;Sn+=ru,xs=Math.max(ru,xs),++Ja}const{horizontalAlign:Sa,verticalAlign:Vs}=Um(Ui);(function(vs,Ka,xl,Bl,Ic,vl,Ol,ru,Ia){const bs=(Ka-xl)*Ic;let Xs=0;Xs=vl!==Ol?-ru*Bl- -17:-Bl*Ia*Ol+.5*Ol;for(const Ps of vs)for(const Na of Ps.positionedGlyphs)Na.x+=bs,Na.y+=Xs})(Ee.positionedLines,yl,Sa,Vs,is,xs,Hi,Sn,Ei.length),Ee.top+=-Vs*Sn,Ee.bottom=Ee.top+Sn,Ee.left+=-Sa*is,Ee.right=Ee.left+is}(Se,o,c,g,At,A,z,B,K,G,ot,dt),!function(Ee){for(const ei of Ee)if(ei.positionedGlyphs.length!==0)return!1;return!0}(ie)&&Se}function Um(h){let o=.5,c=.5;switch(h){case"right":case"top-right":case"bottom-right":o=1;break;case"left":case"top-left":case"bottom-left":o=0}switch(h){case"bottom":case"bottom-right":case"bottom-left":c=1;break;case"top":case"top-right":case"top-left":c=0}return{horizontalAlign:o,verticalAlign:c}}function fd(h,o,c){const g=o.getMaxScale()*mo,{maxImageWidth:x,maxImageHeight:T}=o.getMaxImageSize(h),A=Math.max(g,T*c);return{verticalLineContentWidth:Math.max(g,x*c),horizontalLineContentHeight:A}}function md(h){switch(h){case"top":return 0;case"center":return .5;default:return 1}}function zy(h,o,c){return!(h===it.ay.horizontal||!o&&!jh(c)||o&&(mf(c)||(g=c,/\p{sc=Arab}/u.test(String.fromCodePoint(g)))));var g}function Ly(h,o,c,g,x,T){const A=T[h.fontStack],z=function(G,W,K,ot){if(G&&G.rect)return G;const ct=W[K.fontStack],dt=ct&&ct[ot];return dt?{rect:null,metrics:dt.metrics}:null}(A&&A[o],x,h,o);if(z===null)return null;let B;if(c)B=g.verticalLineContentWidth-h.scale*mo;else{const G=md(h.verticalAlign);B=(g.horizontalLineContentHeight-h.scale*mo)*G}return{rect:z.rect,metrics:z.metrics,baselineOffset:B}}function Sg(h,o,c,g,x){const T=x[h.imageName];if(!T)return null;const A=T.paddedRect,z=T.displaySize,B={width:z[0],height:z[1],left:1,top:-3,advance:o?z[1]:z[0]};let G;if(o)G=g.verticalLineContentWidth-z[1]*h.scale;else{const W=md(h.verticalAlign);G=(g.horizontalLineContentHeight-z[1]*h.scale)*W}return{rect:A,metrics:B,baselineOffset:G,imageOffset:(o?z[0]:z[1])*h.scale-mo*c}}function v_(h,o,c,g){if(g===0)return;const x=h[c],T=(h[c].x+x.metrics.advance*x.scale)*g;for(let A=o;A<=c;A++)h[A].x-=T}function jm(h,o,c){const{horizontalAlign:g,verticalAlign:x}=Um(c),T=o[0]-h.displaySize[0]*g,A=o[1]-h.displaySize[1]*x;return{image:h,top:A,bottom:A+h.displaySize[1],left:T,right:T+h.displaySize[0]}}function Gm(h){var o,c;let g=h.left,x=h.top,T=h.right-g,A=h.bottom-x;const z=(o=h.image.textFitWidth)!==null&&o!==void 0?o:"stretchOrShrink",B=(c=h.image.textFitHeight)!==null&&c!==void 0?c:"stretchOrShrink",G=(h.image.content[2]-h.image.content[0])/(h.image.content[3]-h.image.content[1]);if(B==="proportional"){if(z==="stretchOnly"&&T/A<G||z==="proportional"){const W=Math.ceil(A*G);g*=W/T,T=W}}else if(z==="proportional"&&B==="stretchOnly"&&G!==0&&T/A>G){const W=Math.ceil(T/G);x*=W/A,A=W}return{x1:g,y1:x,x2:g+T,y2:x+A}}function b_(h,o,c,g,x,T){const A=h.image;let z;if(A.content){const At=A.content,jt=A.pixelRatio||1;z=[At[0]/jt,At[1]/jt,A.displaySize[0]-At[2]/jt,A.displaySize[1]-At[3]/jt]}const B=o.left*T,G=o.right*T;let W,K,ot,ct;c==="width"||c==="both"?(ct=x[0]+B-g[3],K=x[0]+G+g[1]):(ct=x[0]+(B+G-A.displaySize[0])/2,K=ct+A.displaySize[0]);const dt=o.top*T,xt=o.bottom*T;return c==="height"||c==="both"?(W=x[1]+dt-g[0],ot=x[1]+xt+g[2]):(W=x[1]+(dt+xt-A.displaySize[1])/2,ot=W+A.displaySize[1]),{image:A,top:W,right:K,bottom:ot,left:ct,collisionPadding:z}}Ki("ImagePosition",im),Ki("ImageAtlas",Dy),it.ay=void 0,(Jd=it.ay||(it.ay={}))[Jd.none=0]="none",Jd[Jd.horizontal=1]="horizontal",Jd[Jd.vertical=2]="vertical",Jd[Jd.horizontalOnly=3]="horizontalOnly";const Qh=128,gd=32640;function Ig(h,o){const{expression:c}=o;if(c.kind==="constant")return{kind:"constant",layoutSize:c.evaluate(new uo(h+1))};if(c.kind==="source")return{kind:"source"};{const{zoomStops:g,interpolationType:x}=c;let T=0;for(;T<g.length&&g[T]<=h;)T++;T=Math.max(0,T-1);let A=T;for(;A<g.length&&g[A]<h+1;)A++;A=Math.min(g.length-1,A);const z=g[T],B=g[A];return c.kind==="composite"?{kind:"composite",minZoom:z,maxZoom:B,interpolationType:x}:{kind:"camera",minZoom:z,maxZoom:B,minSize:c.evaluate(new uo(z)),maxSize:c.evaluate(new uo(B)),interpolationType:x}}}function Eg(h,o,c){let g="never";const x=h.get(o);return x?g=x:h.get(c)&&(g="always"),g}const Ry=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Du(h,o,c,g,x,T,A,z,B,G,W,K,ot){const ct=z?Math.min(gd,Math.round(z[0])):0,dt=z?Math.min(gd,Math.round(z[1])):0;h.emplaceBack(o,c,Math.round(32*g),Math.round(32*x),T,A,(ct<<1)+(B?1:0),dt,16*G,16*W,256*K,256*ot)}function Ag(h,o,c){h.emplaceBack(o.x,o.y,c),h.emplaceBack(o.x,o.y,c),h.emplaceBack(o.x,o.y,c),h.emplaceBack(o.x,o.y,c)}function w_(h){for(const o of h.sections)if(ah(o.text))return!0;return!1}class Pg{constructor(o){this.layoutVertexArray=new Qe,this.indexArray=new Fi,this.programConfigurations=o,this.segments=new Nr,this.dynamicLayoutVertexArray=new Xe,this.opacityVertexArray=new Je,this.hasVisibleVertices=!1,this.placedSymbolArray=new H}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(o,c,g,x){this.isEmpty()||(g&&(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,cr.members),this.indexBuffer=o.createIndexBuffer(this.indexArray,c),this.dynamicLayoutVertexBuffer=o.createVertexBuffer(this.dynamicLayoutVertexArray,Wr.members,!0),this.opacityVertexBuffer=o.createVertexBuffer(this.opacityVertexArray,Ry,!0),this.opacityVertexBuffer.itemSize=1),(g||x)&&this.programConfigurations.upload(o))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Ki("SymbolBuffers",Pg);class T_{constructor(o,c,g){this.layoutVertexArray=new o,this.layoutAttributes=c,this.indexArray=new g,this.segments=new Nr,this.collisionVertexArray=new Di}upload(o){this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=o.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=o.createVertexBuffer(this.collisionVertexArray,fo.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Ki("CollisionBuffers",T_);class rm{constructor(o){this.collisionBoxArray=o.collisionBoxArray,this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(A=>A.id),this.index=o.index,this.pixelRatio=o.pixelRatio,this.sourceLayerIndex=o.sourceLayerIndex,this.hasDependencies=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const c=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Ig(this.zoom,c["text-size"]),this.iconSizeData=Ig(this.zoom,c["icon-size"]);const g=this.layers[0].layout,x=g.get("symbol-sort-key"),T=g.get("symbol-z-order");this.canOverlap=Eg(g,"text-overlap","text-allow-overlap")!=="never"||Eg(g,"icon-overlap","icon-allow-overlap")!=="never"||g.get("text-ignore-placement")||g.get("icon-ignore-placement"),this.sortFeaturesByKey=T!=="viewport-y"&&!x.isConstant(),this.sortFeaturesByY=(T==="viewport-y"||T==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,g.get("symbol-placement")==="point"&&(this.writingModes=g.get("text-writing-mode").map(A=>it.ay[A])),this.stateDependentLayerIds=this.layers.filter(A=>A.isStateDependent()).map(A=>A.id),this.sourceID=o.sourceID}createArrays(){this.text=new Pg(new hh(this.layers,this.zoom,o=>/^text/.test(o))),this.icon=new Pg(new hh(this.layers,this.zoom,o=>/^icon/.test(o))),this.glyphOffsetArray=new mt,this.lineVertexArray=new ut,this.symbolInstances=new et,this.textAnchorOffsets=new pt}calculateGlyphDependencies(o,c,g,x,T){for(const A of o)if(c[A.codePointAt(0)]=!0,(g||x)&&T){const z=ha[A];z&&(c[z.codePointAt(0)]=!0)}}populate(o,c,g){const x=this.layers[0],T=x.layout,A=T.get("text-font"),z=T.get("text-field"),B=T.get("icon-image"),G=(z.value.kind!=="constant"||z.value.value instanceof Lo&&!z.value.value.isEmpty()||z.value.value.toString().length>0)&&(A.value.kind!=="constant"||A.value.value.length>0),W=B.value.kind!=="constant"||!!B.value.value||Object.keys(B.parameters).length>0,K=T.get("symbol-sort-key");if(this.features=[],!G&&!W)return;const ot=c.iconDependencies,ct=c.glyphDependencies,dt=c.availableImages,xt=new uo(this.zoom);for(const{feature:At,id:jt,index:ue,sourceLayerIndex:Qt}of o){const ie=x._featureFilter.needGeometry,Se=gc(At,ie);if(!x._featureFilter.filter(xt,Se,g))continue;let Ee,ei;if(ie||(Se.geometry=Fl(At)),G){const mi=x.getValueAndResolveTokens("text-field",Se,g,dt),Ei=Lo.factory(mi),Hi=this.hasRTLText=this.hasRTLText||w_(Ei);(!Hi||Oc.getRTLTextPluginStatus()==="unavailable"||Hi&&Oc.isParsed())&&(Ee=Ro(Ei,x,Se))}if(W){const mi=x.getValueAndResolveTokens("icon-image",Se,g,dt);ei=mi instanceof Rs?mi:Rs.fromString(mi)}if(!Ee&&!ei)continue;const Ai=this.sortFeaturesByKey?K.evaluate(Se,{},g):void 0;if(this.features.push({id:jt,text:Ee,icon:ei,index:ue,sourceLayerIndex:Qt,geometry:Se.geometry,properties:At.properties,type:ve.types[At.type],sortKey:Ai}),ei&&(ot[ei.name]=!0),Ee){const mi=A.evaluate(Se,{},g).join(","),Ei=T.get("text-rotation-alignment")!=="viewport"&&T.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(it.ay.vertical)>=0;for(const Hi of Ee.sections)if(Hi.image)ot[Hi.image.name]=!0;else{const Ui=Bc(Ee.toString()),ji=Hi.fontStack||mi,gi=ct[ji]=ct[ji]||{};this.calculateGlyphDependencies(Hi.text,gi,Ei,this.allowVerticalPlacement,Ui)}}}T.get("symbol-placement")==="line"&&(this.features=function(At){const jt={},ue={},Qt=[];let ie=0;function Se(mi){Qt.push(At[mi]),ie++}function Ee(mi,Ei,Hi){const Ui=ue[mi];return delete ue[mi],ue[Ei]=Ui,Qt[Ui].geometry[0].pop(),Qt[Ui].geometry[0]=Qt[Ui].geometry[0].concat(Hi[0]),Ui}function ei(mi,Ei,Hi){const Ui=jt[Ei];return delete jt[Ei],jt[mi]=Ui,Qt[Ui].geometry[0].shift(),Qt[Ui].geometry[0]=Hi[0].concat(Qt[Ui].geometry[0]),Ui}function Ai(mi,Ei,Hi){const Ui=Hi?Ei[0][Ei[0].length-1]:Ei[0][0];return`${mi}:${Ui.x}:${Ui.y}`}for(let mi=0;mi<At.length;mi++){const Ei=At[mi],Hi=Ei.geometry,Ui=Ei.text?Ei.text.toString():null;if(!Ui){Se(mi);continue}const ji=Ai(Ui,Hi),gi=Ai(Ui,Hi,!0);if(ji in ue&&gi in jt&&ue[ji]!==jt[gi]){const Ar=ei(ji,gi,Hi),Pr=Ee(ji,gi,Qt[Ar].geometry);delete jt[ji],delete ue[gi],ue[Ai(Ui,Qt[Pr].geometry,!0)]=Pr,Qt[Ar].geometry=null}else ji in ue?Ee(ji,gi,Hi):gi in jt?ei(ji,gi,Hi):(Se(mi),jt[ji]=ie-1,ue[gi]=ie-1)}return Qt.filter(mi=>mi.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((At,jt)=>At.sortKey-jt.sortKey)}update(o,c,g){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(o,c,this.layers,{imagePositions:g}),this.icon.programConfigurations.updatePaintArrays(o,c,this.layers,{imagePositions:g}))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(o){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(o),this.iconCollisionBox.upload(o)),this.text.upload(o,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(o,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(o,c){const g=this.lineVertexArray.length;if(o.segment!==void 0){let x=o.dist(c[o.segment+1]),T=o.dist(c[o.segment]);const A={};for(let z=o.segment+1;z<c.length;z++)A[z]={x:c[z].x,y:c[z].y,tileUnitDistanceFromAnchor:x},z<c.length-1&&(x+=c[z+1].dist(c[z]));for(let z=o.segment||0;z>=0;z--)A[z]={x:c[z].x,y:c[z].y,tileUnitDistanceFromAnchor:T},z>0&&(T+=c[z-1].dist(c[z]));for(let z=0;z<c.length;z++){const B=A[z];this.lineVertexArray.emplaceBack(B.x,B.y,B.tileUnitDistanceFromAnchor)}}return{lineStartIndex:g,lineLength:this.lineVertexArray.length-g}}addSymbols(o,c,g,x,T,A,z,B,G,W,K,ot){const ct=o.indexArray,dt=o.layoutVertexArray,xt=o.segments.prepareSegment(4*c.length,dt,ct,this.canOverlap?A.sortKey:void 0),At=this.glyphOffsetArray.length,jt=xt.vertexLength,ue=this.allowVerticalPlacement&&z===it.ay.vertical?Math.PI/2:0,Qt=A.text&&A.text.sections;for(let ie=0;ie<c.length;ie++){const{tl:Se,tr:Ee,bl:ei,br:Ai,tex:mi,pixelOffsetTL:Ei,pixelOffsetBR:Hi,minFontScaleX:Ui,minFontScaleY:ji,glyphOffset:gi,isSDF:Ar,sectionIndex:Pr}=c[ie],Mr=xt.vertexLength,ur=gi[1];Du(dt,B.x,B.y,Se.x,ur+Se.y,mi.x,mi.y,g,Ar,Ei.x,Ei.y,Ui,ji),Du(dt,B.x,B.y,Ee.x,ur+Ee.y,mi.x+mi.w,mi.y,g,Ar,Hi.x,Ei.y,Ui,ji),Du(dt,B.x,B.y,ei.x,ur+ei.y,mi.x,mi.y+mi.h,g,Ar,Ei.x,Hi.y,Ui,ji),Du(dt,B.x,B.y,Ai.x,ur+Ai.y,mi.x+mi.w,mi.y+mi.h,g,Ar,Hi.x,Hi.y,Ui,ji),Ag(o.dynamicLayoutVertexArray,B,ue),ct.emplaceBack(Mr,Mr+2,Mr+1),ct.emplaceBack(Mr+1,Mr+2,Mr+3),xt.vertexLength+=4,xt.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(gi[0]),ie!==c.length-1&&Pr===c[ie+1].sectionIndex||o.programConfigurations.populatePaintArrays(dt.length,A,A.index,{imagePositions:{},canonical:ot,formattedSection:Qt&&Qt[Pr]})}o.placedSymbolArray.emplaceBack(B.x,B.y,At,this.glyphOffsetArray.length-At,jt,G,W,B.segment,g?g[0]:0,g?g[1]:0,x[0],x[1],z,0,!1,0,K)}_addCollisionDebugVertex(o,c,g,x,T,A){return c.emplaceBack(0,0),o.emplaceBack(g.x,g.y,x,T,Math.round(A.x),Math.round(A.y))}addCollisionDebugVertices(o,c,g,x,T,A,z){const B=T.segments.prepareSegment(4,T.layoutVertexArray,T.indexArray),G=B.vertexLength,W=T.layoutVertexArray,K=T.collisionVertexArray,ot=z.anchorX,ct=z.anchorY;this._addCollisionDebugVertex(W,K,A,ot,ct,new Pe(o,c)),this._addCollisionDebugVertex(W,K,A,ot,ct,new Pe(g,c)),this._addCollisionDebugVertex(W,K,A,ot,ct,new Pe(g,x)),this._addCollisionDebugVertex(W,K,A,ot,ct,new Pe(o,x)),B.vertexLength+=4;const dt=T.indexArray;dt.emplaceBack(G,G+1),dt.emplaceBack(G+1,G+2),dt.emplaceBack(G+2,G+3),dt.emplaceBack(G+3,G),B.primitiveLength+=4}addDebugCollisionBoxes(o,c,g,x){for(let T=o;T<c;T++){const A=this.collisionBoxArray.get(T);this.addCollisionDebugVertices(A.x1,A.y1,A.x2,A.y2,x?this.textCollisionBox:this.iconCollisionBox,A.anchorPoint,g)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new T_(ii,Uo.members,wi),this.iconCollisionBox=new T_(ii,Uo.members,wi);for(let o=0;o<this.symbolInstances.length;o++){const c=this.symbolInstances.get(o);this.addDebugCollisionBoxes(c.textBoxStartIndex,c.textBoxEndIndex,c,!0),this.addDebugCollisionBoxes(c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c,!0),this.addDebugCollisionBoxes(c.iconBoxStartIndex,c.iconBoxEndIndex,c,!1),this.addDebugCollisionBoxes(c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex,c,!1)}}_deserializeCollisionBoxesForSymbol(o,c,g,x,T,A,z,B,G){const W={};for(let K=c;K<g;K++){const ot=o.get(K);W.textBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.textFeatureIndex=ot.featureIndex;break}for(let K=x;K<T;K++){const ot=o.get(K);W.verticalTextBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.verticalTextFeatureIndex=ot.featureIndex;break}for(let K=A;K<z;K++){const ot=o.get(K);W.iconBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.iconFeatureIndex=ot.featureIndex;break}for(let K=B;K<G;K++){const ot=o.get(K);W.verticalIconBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.verticalIconFeatureIndex=ot.featureIndex;break}return W}deserializeCollisionBoxes(o){this.collisionArrays=[];for(let c=0;c<this.symbolInstances.length;c++){const g=this.symbolInstances.get(c);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(o,g.textBoxStartIndex,g.textBoxEndIndex,g.verticalTextBoxStartIndex,g.verticalTextBoxEndIndex,g.iconBoxStartIndex,g.iconBoxEndIndex,g.verticalIconBoxStartIndex,g.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(o,c){const g=o.placedSymbolArray.get(c),x=g.vertexStartIndex+4*g.numGlyphs;for(let T=g.vertexStartIndex;T<x;T+=4)o.indexArray.emplaceBack(T,T+2,T+1),o.indexArray.emplaceBack(T+1,T+2,T+3)}getSortedSymbolIndexes(o){if(this.sortedAngle===o&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const c=Math.sin(o),g=Math.cos(o),x=[],T=[],A=[];for(let z=0;z<this.symbolInstances.length;++z){A.push(z);const B=this.symbolInstances.get(z);x.push(0|Math.round(c*B.anchorX+g*B.anchorY)),T.push(B.featureIndex)}return A.sort((z,B)=>x[z]-x[B]||T[B]-T[z]),A}addToSortKeyRanges(o,c){const g=this.sortKeyRanges[this.sortKeyRanges.length-1];g&&g.sortKey===c?g.symbolInstanceEnd=o+1:this.sortKeyRanges.push({sortKey:c,symbolInstanceStart:o,symbolInstanceEnd:o+1})}sortFeatures(o){if(this.sortFeaturesByY&&this.sortedAngle!==o&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(o),this.sortedAngle=o,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const c of this.symbolInstanceIndexes){const g=this.symbolInstances.get(c);this.featureSortOrder.push(g.featureIndex),[g.rightJustifiedTextSymbolIndex,g.centerJustifiedTextSymbolIndex,g.leftJustifiedTextSymbolIndex].forEach((x,T,A)=>{x>=0&&A.indexOf(x)===T&&this.addIndicesForPlacedSymbol(this.text,x)}),g.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,g.verticalPlacedTextSymbolIndex),g.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,g.placedIconSymbolIndex),g.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,g.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let ky,S_;Ki("SymbolBucket",rm,{omit:["layers","collisionBoxArray","features","compareText"]}),rm.MAX_GLYPHS=65535,rm.addDynamicAttributes=Ag;var Mg={get paint(){return S_=S_||new cs({"icon-opacity":new zr(te.paint_symbol["icon-opacity"]),"icon-color":new zr(te.paint_symbol["icon-color"]),"icon-halo-color":new zr(te.paint_symbol["icon-halo-color"]),"icon-halo-width":new zr(te.paint_symbol["icon-halo-width"]),"icon-halo-blur":new zr(te.paint_symbol["icon-halo-blur"]),"icon-translate":new xr(te.paint_symbol["icon-translate"]),"icon-translate-anchor":new xr(te.paint_symbol["icon-translate-anchor"]),"text-opacity":new zr(te.paint_symbol["text-opacity"]),"text-color":new zr(te.paint_symbol["text-color"],{runtimeType:Wt,getOverride:h=>h.textColor,hasOverride:h=>!!h.textColor}),"text-halo-color":new zr(te.paint_symbol["text-halo-color"]),"text-halo-width":new zr(te.paint_symbol["text-halo-width"]),"text-halo-blur":new zr(te.paint_symbol["text-halo-blur"]),"text-translate":new xr(te.paint_symbol["text-translate"]),"text-translate-anchor":new xr(te.paint_symbol["text-translate-anchor"])})},get layout(){return ky=ky||new cs({"symbol-placement":new xr(te.layout_symbol["symbol-placement"]),"symbol-spacing":new xr(te.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new xr(te.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new zr(te.layout_symbol["symbol-sort-key"]),"symbol-z-order":new xr(te.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new xr(te.layout_symbol["icon-allow-overlap"]),"icon-overlap":new xr(te.layout_symbol["icon-overlap"]),"icon-ignore-placement":new xr(te.layout_symbol["icon-ignore-placement"]),"icon-optional":new xr(te.layout_symbol["icon-optional"]),"icon-rotation-alignment":new xr(te.layout_symbol["icon-rotation-alignment"]),"icon-size":new zr(te.layout_symbol["icon-size"]),"icon-text-fit":new xr(te.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new xr(te.layout_symbol["icon-text-fit-padding"]),"icon-image":new zr(te.layout_symbol["icon-image"]),"icon-rotate":new zr(te.layout_symbol["icon-rotate"]),"icon-padding":new zr(te.layout_symbol["icon-padding"]),"icon-keep-upright":new xr(te.layout_symbol["icon-keep-upright"]),"icon-offset":new zr(te.layout_symbol["icon-offset"]),"icon-anchor":new zr(te.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new xr(te.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new xr(te.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new xr(te.layout_symbol["text-rotation-alignment"]),"text-field":new zr(te.layout_symbol["text-field"]),"text-font":new zr(te.layout_symbol["text-font"]),"text-size":new zr(te.layout_symbol["text-size"]),"text-max-width":new zr(te.layout_symbol["text-max-width"]),"text-line-height":new xr(te.layout_symbol["text-line-height"]),"text-letter-spacing":new zr(te.layout_symbol["text-letter-spacing"]),"text-justify":new zr(te.layout_symbol["text-justify"]),"text-radial-offset":new zr(te.layout_symbol["text-radial-offset"]),"text-variable-anchor":new xr(te.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new zr(te.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new zr(te.layout_symbol["text-anchor"]),"text-max-angle":new xr(te.layout_symbol["text-max-angle"]),"text-writing-mode":new xr(te.layout_symbol["text-writing-mode"]),"text-rotate":new zr(te.layout_symbol["text-rotate"]),"text-padding":new xr(te.layout_symbol["text-padding"]),"text-keep-upright":new xr(te.layout_symbol["text-keep-upright"]),"text-transform":new zr(te.layout_symbol["text-transform"]),"text-offset":new zr(te.layout_symbol["text-offset"]),"text-allow-overlap":new xr(te.layout_symbol["text-allow-overlap"]),"text-overlap":new xr(te.layout_symbol["text-overlap"]),"text-ignore-placement":new xr(te.layout_symbol["text-ignore-placement"]),"text-optional":new xr(te.layout_symbol["text-optional"])})}};class Fy{constructor(o){if(o.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=o.property.overrides?o.property.overrides.runtimeType:st,this.defaultValue=o}evaluate(o){if(o.formattedSection){const c=this.defaultValue.property.overrides;if(c&&c.hasOverride(o.formattedSection))return c.getOverride(o.formattedSection)}return o.feature&&o.featureState?this.defaultValue.evaluate(o.feature,o.featureState):this.defaultValue.property.specification.default}eachChild(o){this.defaultValue.isConstant()||o(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ki("FormatSectionOverride",Fy,{omit:["defaultValue"]});class $m extends fl{constructor(o,c){super(o,Mg,c)}recalculate(o,c){if(super.recalculate(o,c),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const g=this.layout.get("text-writing-mode");if(g){const x=[];for(const T of g)x.indexOf(T)<0&&x.push(T);this.layout._values["text-writing-mode"]=x}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(o,c,g,x){const T=this.layout.get(o).evaluate(c,{},g,x),A=this._unevaluatedLayout._values[o];return A.isDataDriven()||mp(A.value)||!T?T:function(z,B){return B.replace(/{([^{}]+)}/g,(G,W)=>z&&W in z?String(z[W]):"")}(c.properties,T)}createBucket(o){return new rm(o)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const o of Mg.paint.overridableProperties){if(!$m.hasPaintOverride(this.layout,o))continue;const c=this.paint.get(o),g=new Fy(c),x=new pu(g,c.property.specification);let T=null;T=c.value.kind==="constant"||c.value.kind==="source"?new Rh("source",x):new Xu("composite",x,c.value.zoomStops),this.paint._values[o]=new la(c.property,T,c.parameters)}}_handleOverridablePaintPropertyUpdate(o,c,g){return!(!this.layout||c.isDataDriven()||g.isDataDriven())&&$m.hasPaintOverride(this.layout,o)}static hasPaintOverride(o,c){const g=o.get("text-field"),x=Mg.paint.properties[c];let T=!1;const A=z=>{for(const B of z)if(x.overrides&&x.overrides.hasOverride(B))return void(T=!0)};if(g.value.kind==="constant"&&g.value.value instanceof Lo)A(g.value.value.sections);else if(g.value.kind==="source"||g.value.kind==="composite"){const z=G=>{T||(G instanceof Zl&&pr(G.value)===ti?A(G.value.sections):G instanceof lc?A(G.sections):G.eachChild(z))},B=g.value;B._styleExpression&&z(B._styleExpression.expression)}return T}}let By;var ix={get paint(){return By=By||new cs({"background-color":new xr(te.paint_background["background-color"]),"background-pattern":new pc(te.paint_background["background-pattern"]),"background-opacity":new xr(te.paint_background["background-opacity"])})}};class Oy extends fl{constructor(o,c){super(o,ix,c)}}class Ny extends fl{constructor(o,c){super(o,{},c),this.onAdd=g=>{this.implementation.onAdd&&this.implementation.onAdd(g,g.painter.context.gl)},this.onRemove=g=>{this.implementation.onRemove&&this.implementation.onRemove(g,g.painter.context.gl)},this.implementation=o}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class Vy{constructor(o){this._methodToThrottle=o,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const Uy={once:!0},Cg=63710088e-1;class Kd{constructor(o,c){if(isNaN(o)||isNaN(c))throw new Error(`Invalid LngLat object: (${o}, ${c})`);if(this.lng=+o,this.lat=+c,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Kd(ja(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(o){const c=Math.PI/180,g=this.lat*c,x=o.lat*c,T=Math.sin(g)*Math.sin(x)+Math.cos(g)*Math.cos(x)*Math.cos((o.lng-this.lng)*c);return Cg*Math.acos(Math.min(T,1))}static convert(o){if(o instanceof Kd)return o;if(Array.isArray(o)&&(o.length===2||o.length===3))return new Kd(Number(o[0]),Number(o[1]));if(!Array.isArray(o)&&typeof o=="object"&&o!==null)return new Kd(Number("lng"in o?o.lng:o.lon),Number(o.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const I_=2*Math.PI*Cg;function Dg(h){return I_*Math.cos(h*Math.PI/180)}function Qd(h){return(180+h)/360}function Ta(h){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h*Math.PI/360)))/360}function E_(h,o){return h/Dg(o)}function nm(h){return 360*h-180}function zg(h){return 360/Math.PI*Math.atan(Math.exp((180-360*h)*Math.PI/180))-90}function jy(h,o){return h*Dg(zg(o))}class qm{constructor(o,c,g=0){this.x=+o,this.y=+c,this.z=+g}static fromLngLat(o,c=0){const g=Kd.convert(o);return new qm(Qd(g.lng),Ta(g.lat),E_(c,g.lat))}toLngLat(){return new Kd(nm(this.x),zg(this.y))}toAltitude(){return jy(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/I_*(o=zg(this.y),1/Math.cos(o*Math.PI/180));var o}}function Gy(h,o,c){var g=2*Math.PI*6378137/256/Math.pow(2,c);return[h*g-2*Math.PI*6378137/2,o*g-2*Math.PI*6378137/2]}class jp{constructor(o,c,g){if(!function(x,T,A){return!(x<0||x>25||A<0||A>=Math.pow(2,x)||T<0||T>=Math.pow(2,x))}(o,c,g))throw new Error(`x=${c}, y=${g}, z=${o} outside of bounds. 0<=x<${Math.pow(2,o)}, 0<=y<${Math.pow(2,o)} 0<=z<=25 `);this.z=o,this.x=c,this.y=g,this.key=_d(0,o,o,c,g)}equals(o){return this.z===o.z&&this.x===o.x&&this.y===o.y}url(o,c,g){const x=(A=this.y,z=this.z,B=Gy(256*(T=this.x),256*(A=Math.pow(2,z)-A-1),z),G=Gy(256*(T+1),256*(A+1),z),B[0]+","+B[1]+","+G[0]+","+G[1]);var T,A,z,B,G;const W=function(K,ot,ct){let dt,xt="";for(let At=K;At>0;At--)dt=1<<At-1,xt+=(ot&dt?1:0)+(ct&dt?2:0);return xt}(this.z,this.x,this.y);return o[(this.x+this.y)%o.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(g==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,c>1?"@2x":"").replace(/{quadkey}/g,W).replace(/{bbox-epsg-3857}/g,x)}isChildOf(o){const c=this.z-o.z;return c>0&&o.x===this.x>>c&&o.y===this.y>>c}getTilePoint(o){const c=Math.pow(2,this.z);return new Pe((o.x*c-this.x)*Ln,(o.y*c-this.y)*Ln)}toString(){return`${this.z}/${this.x}/${this.y}`}}class A_{constructor(o,c){this.wrap=o,this.canonical=c,this.key=_d(o,c.z,c.z,c.x,c.y)}}class Xa{constructor(o,c,g,x,T){if(this.terrainRttPosMatrix32f=null,o<g)throw new Error(`overscaledZ should be >= z; overscaledZ = ${o}; z = ${g}`);this.overscaledZ=o,this.wrap=c,this.canonical=new jp(g,+x,+T),this.key=_d(c,o,g,x,T)}clone(){return new Xa(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(o){return this.overscaledZ===o.overscaledZ&&this.wrap===o.wrap&&this.canonical.equals(o.canonical)}scaledTo(o){if(o>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${o}; overscaledZ = ${this.overscaledZ}`);const c=this.canonical.z-o;return o>this.canonical.z?new Xa(o,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Xa(o,this.wrap,o,this.canonical.x>>c,this.canonical.y>>c)}isOverscaled(){return this.overscaledZ>this.canonical.z}calculateScaledKey(o,c){if(o>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${o}; overscaledZ = ${this.overscaledZ}`);const g=this.canonical.z-o;return o>this.canonical.z?_d(this.wrap*+c,o,this.canonical.z,this.canonical.x,this.canonical.y):_d(this.wrap*+c,o,o,this.canonical.x>>g,this.canonical.y>>g)}isChildOf(o){if(o.wrap!==this.wrap||this.overscaledZ-o.overscaledZ<=0)return!1;if(o.overscaledZ===0)return this.overscaledZ>0;const c=this.canonical.z-o.canonical.z;return!(c<0)&&o.canonical.x===this.canonical.x>>c&&o.canonical.y===this.canonical.y>>c}children(o){if(this.overscaledZ>=o)return[new Xa(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const c=this.canonical.z+1,g=2*this.canonical.x,x=2*this.canonical.y;return[new Xa(c,this.wrap,c,g,x),new Xa(c,this.wrap,c,g+1,x),new Xa(c,this.wrap,c,g,x+1),new Xa(c,this.wrap,c,g+1,x+1)]}isLessThan(o){return this.wrap<o.wrap||!(this.wrap>o.wrap)&&(this.overscaledZ<o.overscaledZ||!(this.overscaledZ>o.overscaledZ)&&(this.canonical.x<o.canonical.x||!(this.canonical.x>o.canonical.x)&&this.canonical.y<o.canonical.y))}wrapped(){return new Xa(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(o){return new Xa(this.overscaledZ,o,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new A_(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(o){return this.canonical.getTilePoint(new qm(o.x-this.wrap,o.y))}}function _d(h,o,c,g,x){(h*=2)<0&&(h=-1*h-1);const T=1<<c;return(T*T*h+T*x+g).toString(36)+c.toString(36)+o.toString(36)}function Zm(h,o){return o?h.properties[o]:h.id}function rx(h,o){const c={id:h.id};if(o.removeAllProperties&&(delete h.removeProperties,delete h.addOrUpdateProperties,delete o.removeProperties),o.removeProperties)for(const g of o.removeProperties){const x=h.addOrUpdateProperties.findIndex(T=>T.key===g);x>-1&&h.addOrUpdateProperties.splice(x,1)}return(h.removeAllProperties||o.removeAllProperties)&&(c.removeAllProperties=!0),(h.removeProperties||o.removeProperties)&&(c.removeProperties=[...h.removeProperties||[],...o.removeProperties||[]]),(h.addOrUpdateProperties||o.addOrUpdateProperties)&&(c.addOrUpdateProperties=[...h.addOrUpdateProperties||[],...o.addOrUpdateProperties||[]]),(h.newGeometry||o.newGeometry)&&(c.newGeometry=o.newGeometry||h.newGeometry),c}function $y(h){var o,c;if(!h)return{};const g={};return g.removeAll=h.removeAll,g.remove=new Set(h.remove||[]),g.add=new Map((o=h.add)===null||o===void 0?void 0:o.map(x=>[x.id,x])),g.update=new Map((c=h.update)===null||c===void 0?void 0:c.map(x=>[x.id,x])),g}Ki("CanonicalTileID",jp),Ki("OverscaledTileID",Xa,{omit:["terrainRttPosMatrix32f"]});class qy{constructor(o){this._stringToNumber={},this._numberToString=[];for(let c=0;c<o.length;c++){const g=o[c];this._stringToNumber[g]=c,this._numberToString[c]=g}}encode(o){return this._stringToNumber[o]}decode(o){if(o>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${o} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[o]}}class Zy{constructor(o,c,g,x,T){this.type="Feature",this._vectorTileFeature=o,o._z=c,o._x=g,o._y=x,this.properties=o.properties,this.id=T}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(o){this._geometry=o}toJSON(){const o={geometry:this.geometry};for(const c in this)c!=="_geometry"&&c!=="_vectorTileFeature"&&(o[c]=this[c]);return o}}class om{_name;dataBuffer;nullabilityBuffer;_size;constructor(o,c,g){this._name=o,this.dataBuffer=c,typeof g=="number"?this._size=g:(this.nullabilityBuffer=g,this._size=g.size())}getValue(o){return this.nullabilityBuffer&&!this.nullabilityBuffer.get(o)?null:this.getValueFromBuffer(o)}has(o){return this.nullabilityBuffer&&this.nullabilityBuffer.get(o)||!this.nullabilityBuffer}get name(){return this._name}get size(){return this._size}}class Lg extends om{}class Hm extends Lg{getValueFromBuffer(o){return this.dataBuffer[o]}}class P_ extends Lg{getValueFromBuffer(o){return this.dataBuffer[o]}}class M_ extends om{delta;constructor(o,c,g,x){super(o,c,x),this.delta=g}}class If extends M_{constructor(o,c,g,x){super(o,Int32Array.of(c),g,x)}getValueFromBuffer(o){return this.dataBuffer[0]+o*this.delta}}class C_ extends om{constructor(o,c,g){super(o,Int32Array.of(c),g)}getValueFromBuffer(o){return this.dataBuffer[0]}}class Hs{_name;_geometryVector;_idVector;_propertyVectors;_extent;propertyVectorsMap;constructor(o,c,g,x,T=4096){this._name=o,this._geometryVector=c,this._idVector=g,this._propertyVectors=x,this._extent=T}get name(){return this._name}get idVector(){return this._idVector}get geometryVector(){return this._geometryVector}get propertyVectors(){return this._propertyVectors}getPropertyVector(o){return this.propertyVectorsMap||(this.propertyVectorsMap=new Map(this._propertyVectors.map(c=>[c.name,c]))),this.propertyVectorsMap.get(o)}*[Symbol.iterator](){const o=this.geometryVector[Symbol.iterator]();let c=0;for(;c<this.numFeatures;){let g;this.idVector&&(g=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(c)):this.idVector.getValue(c));const x=o?.next().value,T={};for(const A of this.propertyVectors){if(!A)continue;const z=A.name,B=A.getValue(c);B!==null&&(T[z]=B)}c++,yield{id:g,geometry:x,properties:T}}}get numFeatures(){return this.geometryVector.numGeometries}get extent(){return this._extent}getFeatures(){const o=[],c=this.geometryVector.getGeometries();for(let g=0;g<this.numFeatures;g++){let x;this.idVector&&(x=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(g)):this.idVector.getValue(g));const T={coordinates:c[g],type:this.geometryVector.geometryType(g)},A={};for(const z of this.propertyVectors){if(!z)continue;const B=z.name,G=z.getValue(g);G!==null&&(A[B]=G)}o.push({id:x,geometry:T,properties:A})}return o}containsMaxSaveIntegerValues(o){return o instanceof Hm||o instanceof C_&&o instanceof If||o instanceof P_}}class sm{value;constructor(o){this.value=o}get(){return this.value}set(o){this.value=o}increment(){return this.value++}add(o){this.value+=o}}var Ya,An,tu,wc,Gp,Tc,Ns,da,am,gh;(function(h){h.PRESENT="PRESENT",h.DATA="DATA",h.OFFSET="OFFSET",h.LENGTH="LENGTH"})(Ya||(Ya={}));class Rg{_dictionaryType;_offsetType;_lengthType;constructor(o,c,g){this._dictionaryType=o,this._offsetType=c,this._lengthType=g}get dictionaryType(){return this._dictionaryType}get offsetType(){return this._offsetType}get lengthType(){return this._lengthType}}function Ws(h,o,c){const g=new Int32Array(c);let x=0,T=o.get();for(let A=0;A<g.length;A++){let z=h[T++],B=127&z;z<128||(z=h[T++],B|=(127&z)<<7,z<128||(z=h[T++],B|=(127&z)<<14,z<128||(z=h[T++],B|=(127&z)<<21,z<128||(z=h[T++],B|=(15&z)<<28)))),g[x++]=B}return o.set(T),g}function lm(h,o,c){const g=new BigInt64Array(c);for(let x=0;x<g.length;x++)g[x]=Wy(h,o);return g}function Hy(h,o){let c,g;return g=h[o.get()],o.increment(),c=127&g,g<128?c:(g=h[o.get()],o.increment(),c|=(127&g)<<7,g<128?c:(g=h[o.get()],o.increment(),c|=(127&g)<<14,g<128?c:(g=h[o.get()],o.increment(),c|=(127&g)<<21,g<128?c:(g=h[o.get()],c|=(15&g)<<28,function(x,T,A){let z,B;if(B=T[A.get()],A.increment(),z=(112&B)>>4,B<128||(B=T[A.get()],A.increment(),z|=(127&B)<<3,B<128)||(B=T[A.get()],A.increment(),z|=(127&B)<<10,B<128)||(B=T[A.get()],A.increment(),z|=(127&B)<<17,B<128)||(B=T[A.get()],A.increment(),z|=(127&B)<<24,B<128)||(B=T[A.get()],A.increment(),z|=(1&B)<<31,B<128))return 4294967296*z+(x>>>0);throw new Error("Expected varint not more than 10 bytes")}(c,h,o)))))}function yd(h,o,c,g){throw new Error("FastPFor is not implemented yet.")}function Ef(h){return h>>>1^-(1&h)}function Ba(h){return h>>1n^-(1n&h)}function Wy(h,o){let c=0n,g=0,x=o.get();for(;x<h.length;){const T=h[x++];if(c|=BigInt(127&T)<<BigInt(g),!(128&T))break;if(g+=7,g>=64)throw new Error("Varint too long")}return o.set(x),c}function D_(h,o,c){const g=new Int32Array(c);let x=0;for(let T=0;T<o;T++){const A=h[T];g.fill(h[T+o],x,x+A),x+=A}return g}function z_(h,o,c){const g=new BigInt64Array(c);let x=0;for(let T=0;T<o;T++){const A=Number(h[T]);g.fill(h[T+o],x,x+A),x+=A}return g}function Wm(h,o,c){const g=new Float64Array(c);let x=0;for(let T=0;T<o;T++){const A=h[T];g.fill(h[T+o],x,x+A),x+=A}return g}function L_(h){const o=h.length/4*4;let c=1;if(o>=4)for(let g=h[0];c<o-4;c+=4)g=h[c]+=g,g=h[c+1]+=g,g=h[c+2]+=g,g=h[c+3]+=g;for(;c!=h.length;)h[c]+=h[c-1],++c}function Xy(h){h[0]=h[0]>>>1^-(1&h[0]),h[1]=h[1]>>>1^-(1&h[1]);const o=h.length/4*4;let c=2;if(o>=4)for(;c<o-4;c+=4){const g=h[c],x=h[c+1],T=h[c+2],A=h[c+3];h[c]=(g>>>1^-(1&g))+h[c-2],h[c+1]=(x>>>1^-(1&x))+h[c-1],h[c+2]=(T>>>1^-(1&T))+h[c],h[c+3]=(A>>>1^-(1&A))+h[c+1]}for(;c!=h.length;c+=2)h[c]=(h[c]>>>1^-(1&h[c]))+h[c-2],h[c+1]=(h[c+1]>>>1^-(1&h[c+1]))+h[c-1]}function xd(h,o,c){return Math.min(c,Math.max(o,h))}(function(h){h.NONE="NONE",h.DELTA="DELTA",h.COMPONENTWISE_DELTA="COMPONENTWISE_DELTA",h.RLE="RLE",h.MORTON="MORTON",h.PDE="PDE"})(An||(An={})),function(h){h.NONE="NONE",h.FAST_PFOR="FAST_PFOR",h.VARINT="VARINT",h.ALP="ALP"}(tu||(tu={})),function(h){h.NONE="NONE",h.SINGLE="SINGLE",h.SHARED="SHARED",h.VERTEX="VERTEX",h.MORTON="MORTON",h.FSST="FSST"}(wc||(wc={})),function(h){h.VERTEX="VERTEX",h.INDEX="INDEX",h.STRING="STRING",h.KEY="KEY"}(Gp||(Gp={})),function(h){h.VAR_BINARY="VAR_BINARY",h.GEOMETRIES="GEOMETRIES",h.PARTS="PARTS",h.RINGS="RINGS",h.TRIANGLES="TRIANGLES",h.SYMBOL="SYMBOL",h.DICTIONARY="DICTIONARY"}(Tc||(Tc={}));class $p{_physicalStreamType;_logicalStreamType;_logicalLevelTechnique1;_logicalLevelTechnique2;_physicalLevelTechnique;_numValues;_byteLength;constructor(o,c,g,x,T,A,z){this._physicalStreamType=o,this._logicalStreamType=c,this._logicalLevelTechnique1=g,this._logicalLevelTechnique2=x,this._physicalLevelTechnique=T,this._numValues=A,this._byteLength=z}static decode(o,c){const g=o[c.get()],x=Object.values(Ya)[g>>4];let T=null;switch(x){case Ya.DATA:T=new Rg(Object.values(wc)[15&g]);break;case Ya.OFFSET:T=new Rg(null,Object.values(Gp)[15&g]);break;case Ya.LENGTH:T=new Rg(null,null,Object.values(Tc)[15&g])}c.increment();const A=o[c.get()],z=Object.values(An)[A>>5],B=Object.values(An)[A>>2&7],G=Object.values(tu)[3&A];c.increment();const W=Ws(o,c,2);return new $p(x,T,z,B,G,W[0],W[1])}get physicalStreamType(){return this._physicalStreamType}get logicalStreamType(){return this._logicalStreamType}get logicalLevelTechnique1(){return this._logicalLevelTechnique1}get logicalLevelTechnique2(){return this._logicalLevelTechnique2}get physicalLevelTechnique(){return this._physicalLevelTechnique}get numValues(){return this._numValues}get byteLength(){return this._byteLength}getDecompressedCount(){return this._numValues}}class cm extends $p{num_bits;coordinate_shift;constructor(o,c,g,x,T,A,z,B,G){super(o,c,g,x,T,A,z),this.num_bits=B,this.coordinate_shift=G}static decode(o,c){const g=$p.decode(o,c),x=Ws(o,c,2);return new cm(g.physicalStreamType,g.logicalStreamType,g.logicalLevelTechnique1,g.logicalLevelTechnique2,g.physicalLevelTechnique,g.numValues,g.byteLength,x[0],x[1])}static decodePartial(o,c,g){const x=Ws(c,g,2);return new cm(o.physicalStreamType,o.logicalStreamType,o.logicalLevelTechnique1,o.logicalLevelTechnique2,o.physicalLevelTechnique,o.numValues,o.byteLength,x[0],x[1])}numBits(){return this.num_bits}coordinateShift(){return this.coordinate_shift}}class Af extends $p{_runs;_numRleValues;constructor(o,c,g,x,T,A,z,B,G){super(o,c,g,x,T,A,z),this._runs=B,this._numRleValues=G}static decode(o,c){const g=$p.decode(o,c),x=Ws(o,c,2);return new Af(g.physicalStreamType,g.logicalStreamType,g.logicalLevelTechnique1,g.logicalLevelTechnique2,g.physicalLevelTechnique,g.numValues,g.byteLength,x[0],x[1])}static decodePartial(o,c,g){const x=Ws(c,g,2);return new Af(o.physicalStreamType,o.logicalStreamType,o.logicalLevelTechnique1,o.logicalLevelTechnique2,o.physicalLevelTechnique,o.numValues,o.byteLength,x[0],x[1])}get runs(){return this._runs}get numRleValues(){return this._numRleValues}getDecompressedCount(){return this._numRleValues}}class _l{static decode(o,c){const g=$p.decode(o,c);return g.logicalLevelTechnique1===An.MORTON?cm.decodePartial(g,o,c):An.RLE!==g.logicalLevelTechnique1&&An.RLE!==g.logicalLevelTechnique2||tu.NONE===g.physicalLevelTechnique?g:Af.decodePartial(g,o,c)}}(function(h){h[h.FLAT=0]="FLAT",h[h.CONST=1]="CONST",h[h.SEQUENCE=2]="SEQUENCE",h[h.DICTIONARY=3]="DICTIONARY",h[h.FSST_DICTIONARY=4]="FSST_DICTIONARY"})(Ns||(Ns={}));class eu{values;_size;constructor(o,c){this.values=o,this._size=c}get(o){const c=Math.floor(o/8);return(this.values[c]>>o%8&1)==1}set(o,c){const g=Math.floor(o/8);this.values[g]=this.values[g]|(c?1:0)<<o%8}getInt(o){const c=Math.floor(o/8);return this.values[c]>>o%8&1}size(){return this._size}getBuffer(){return this.values}}class hn{constructor(){}static decodeIntStream(o,c,g,x,T){const A=hn.decodePhysicalLevelTechnique(o,c,g);return this.decodeIntBuffer(A,g,x,T)}static decodeLengthStreamToOffsetBuffer(o,c,g){const x=hn.decodePhysicalLevelTechnique(o,c,g);return this.decodeLengthToOffsetBuffer(x,g)}static decodePhysicalLevelTechnique(o,c,g){const x=g.physicalLevelTechnique;if(x===tu.FAST_PFOR)return yd();if(x===tu.VARINT)return Ws(o,c,g.numValues);if(x===tu.NONE){const T=c.get();c.add(g.byteLength);const A=o.subarray(T,c.get());return new Int32Array(A)}throw new Error("Specified physicalLevelTechnique is not supported (yet).")}static decodeConstIntStream(o,c,g,x){const T=hn.decodePhysicalLevelTechnique(o,c,g);if(T.length===1){const A=T[0];return x?Ef(A):A}return x?function(A){return Ef(A[1])}(T):function(A){return A[1]}(T)}static decodeSequenceIntStream(o,c,g){return function(x){if(x.length==2){const T=Ef(x[1]);return[T,T]}return[Ef(x[2]),Ef(x[3])]}(hn.decodePhysicalLevelTechnique(o,c,g))}static decodeSequenceLongStream(o,c,g){return function(x){if(x.length==2){const T=Ba(x[1]);return[T,T]}return[Ba(x[2]),Ba(x[3])]}(lm(o,c,g.numValues))}static decodeLongStream(o,c,g,x){const T=lm(o,c,g.numValues);return this.decodeLongBuffer(T,g,x)}static decodeLongFloat64Stream(o,c,g,x){const T=function(A,z,B){const G=new Float64Array(z);for(let W=0;W<z;W++)G[W]=Hy(A,B);return G}(o,g.numValues,c);return this.decodeFloat64Buffer(T,g,x)}static decodeConstLongStream(o,c,g,x){const T=lm(o,c,g.numValues);if(T.length===1){const A=T[0];return x?Ba(A):A}return x?function(A){return Ba(A[1])}(T):function(A){return A[1]}(T)}static decodeIntBuffer(o,c,g,x){switch(c.logicalLevelTechnique1){case An.DELTA:return c.logicalLevelTechnique2===An.RLE?function(T,A,z){const B=new Int32Array(z);let G=0,W=0;for(let K=0;K<A;K++){const ot=T[K],ct=Ef(T[K+A]);for(let dt=0;dt<ot;dt++)W+=ct,B[G++]=W}return B}(o,c.runs,c.numRleValues):(function(T){T[0]=T[0]>>>1^-(1&T[0]);const A=T.length/4*4;let z=1;if(A>=4)for(;z<A-4;z+=4){const B=T[z],G=T[z+1],W=T[z+2],K=T[z+3];T[z]=(B>>>1^-(1&B))+T[z-1],T[z+1]=(G>>>1^-(1&G))+T[z],T[z+2]=(W>>>1^-(1&W))+T[z+1],T[z+3]=(K>>>1^-(1&K))+T[z+2]}for(;z!=T.length;++z)T[z]=(T[z]>>>1^-(1&T[z]))+T[z-1]}(o),o);case An.RLE:return function(T,A,z){return z?function(B,G,W){const K=new Int32Array(W);let ot=0;for(let ct=0;ct<G;ct++){const dt=B[ct];let xt=B[ct+G];xt=xt>>>1^-(1&xt),K.fill(xt,ot,ot+dt),ot+=dt}return K}(T,A.runs,A.numRleValues):D_(T,A.runs,A.numRleValues)}(o,c,g);case An.MORTON:return L_(o),o;case An.COMPONENTWISE_DELTA:return x?(function(T,A,z,B){let G=T[0]>>>1^-(1&T[0]),W=T[1]>>>1^-(1&T[1]);T[0]=xd(Math.round(G*A),z,B),T[1]=xd(Math.round(W*A),z,B);const K=T.length/16;let ot=2;if(K>=4)for(;ot<K-4;ot+=4){const ct=T[ot],dt=T[ot+1],xt=(ct>>>1^-(1&ct))+G,At=(dt>>>1^-(1&dt))+W;T[ot]=xd(Math.round(xt*A),z,B),T[ot+1]=xd(Math.round(At*A),z,B);const jt=T[ot+2],ue=T[ot+3];G=(jt>>>1^-(1&jt))+xt,W=(ue>>>1^-(1&ue))+At,T[ot+2]=xd(Math.round(G*A),z,B),T[ot+3]=xd(Math.round(W*A),z,B)}for(;ot!=T.length;ot+=2)G+=T[ot]>>>1^-(1&T[ot]),W+=T[ot+1]>>>1^-(1&T[ot+1]),T[ot]=xd(Math.round(G*A),z,B),T[ot+1]=xd(Math.round(W*A),z,B)}(o,x.scale,x.min,x.max),o):(Xy(o),o);case An.NONE:return g&&function(T){for(let A=0;A<T.length;A++){const z=T[A];T[A]=z>>>1^-(1&z)}}(o),o;default:throw new Error(`The specified Logical level technique is not supported: ${c.logicalLevelTechnique1}`)}}static decodeLongBuffer(o,c,g){switch(c.logicalLevelTechnique1){case An.DELTA:return c.logicalLevelTechnique2===An.RLE?function(x,T,A){const z=new BigInt64Array(A);let B=0,G=0n;for(let W=0;W<T;W++){const K=Number(x[W]),ot=Ba(x[W+T]);for(let ct=0;ct<K;ct++)G+=ot,z[B++]=G}return z}(o,c.runs,c.numRleValues):(function(x){x[0]=x[0]>>1n^-(1n&x[0]);const T=x.length/4*4;let A=1;if(T>=4)for(;A<T-4;A+=4){const z=x[A],B=x[A+1],G=x[A+2],W=x[A+3];x[A]=(z>>1n^-(1n&z))+x[A-1],x[A+1]=(B>>1n^-(1n&B))+x[A],x[A+2]=(G>>1n^-(1n&G))+x[A+1],x[A+3]=(W>>1n^-(1n&W))+x[A+2]}for(;A!=x.length;++A)x[A]=(x[A]>>1n^-(1n&x[A]))+x[A-1]}(o),o);case An.RLE:return function(x,T,A){return A?function(z,B,G){const W=new BigInt64Array(G);let K=0;for(let ot=0;ot<B;ot++){const ct=Number(z[ot]);let dt=z[ot+B];dt=dt>>1n^-(1n&dt),W.fill(dt,K,K+ct),K+=ct}return W}(x,T.runs,T.numRleValues):z_(x,T.runs,T.numRleValues)}(o,c,g);case An.NONE:return g&&function(x){for(let T=0;T<x.length;T++){const A=x[T];x[T]=A>>1n^-(1n&A)}}(o),o;default:throw new Error(`The specified Logical level technique is not supported: ${c.logicalLevelTechnique1}`)}}static decodeFloat64Buffer(o,c,g){switch(c.logicalLevelTechnique1){case An.DELTA:return c.logicalLevelTechnique2===An.RLE&&(o=Wm(o,c.runs,c.numRleValues)),function(x){x[0]=x[0]%2==1?(x[0]+1)/-2:x[0]/2;const T=x.length/4*4;let A=1;if(T>=4)for(;A<T-4;A+=4){const z=x[A],B=x[A+1],G=x[A+2],W=x[A+3];x[A]=(z%2==1?(z+1)/-2:z/2)+x[A-1],x[A+1]=(B%2==1?(B+1)/-2:B/2)+x[A],x[A+2]=(G%2==1?(G+1)/-2:G/2)+x[A+1],x[A+3]=(W%2==1?(W+1)/-2:W/2)+x[A+2]}for(;A!=x.length;++A)x[A]=(x[A]%2==1?(x[A]+1)/-2:x[A]/2)+x[A-1]}(o),o;case An.RLE:return function(x,T,A){return A?function(z,B,G){const W=new Float64Array(G);let K=0;for(let ot=0;ot<B;ot++){const ct=z[ot];let dt=z[ot+B];dt=dt%2==1?(dt+1)/-2:dt/2,W.fill(dt,K,K+ct),K+=ct}return W}(x,T.runs,T.numRleValues):Wm(x,T.runs,T.numRleValues)}(o,c,g);case An.NONE:return g&&function(x){for(let T=0;T<x.length;T++){const A=x[T];x[T]=A%2==1?(A+1)/-2:A/2}}(o),o;default:throw new Error(`The specified Logical level technique is not supported: ${c.logicalLevelTechnique1}`)}}static decodeLengthToOffsetBuffer(o,c){if(c.logicalLevelTechnique1===An.DELTA&&c.logicalLevelTechnique2===An.NONE)return function(g){const x=new Int32Array(g.length+1);x[0]=0,x[1]=Ef(g[0]);let T=x[1],A=2;for(;A!=x.length;++A){const z=g[A-1];T+=z>>>1^-(1&z),x[A]=x[A-1]+T}return x}(o);if(c.logicalLevelTechnique1===An.RLE&&c.logicalLevelTechnique2===An.NONE)return function(g,x,T){const A=new Int32Array(T+1);A[0]=0;let z=1,B=A[0];for(let G=0;G<x;G++){const W=g[G],K=g[G+x];for(let ot=z;ot<z+W;ot++)A[ot]=K+B,B=A[ot];z+=W}return A}(o,c.runs,c.numRleValues);if(c.logicalLevelTechnique1===An.NONE&&c.logicalLevelTechnique2===An.NONE){(function(x){let T=0;for(let A=0;A<x.length;A++)x[A]+=T,T=x[A]})(o);const g=new Int32Array(c.numValues+1);return g[0]=0,g.set(o,1),g}if(c.logicalLevelTechnique1===An.DELTA&&c.logicalLevelTechnique2===An.RLE){const g=function(x,T,A){const z=new Int32Array(A+1);z[0]=0;let B=1,G=z[0];for(let W=0;W<T;W++){const K=x[W];let ot=x[W+T];ot=ot>>>1^-(1&ot);for(let ct=B;ct<B+K;ct++)z[ct]=ot+G,G=z[ct];B+=K}return z}(o,c.runs,c.numRleValues);return L_(g),g}throw new Error("Only delta encoding is supported for transforming length to offset streams yet.")}static decodeNullableIntStream(o,c,g,x,T){const A=g.physicalLevelTechnique===tu.FAST_PFOR?yd():Ws(o,c,g.numValues);return this.decodeNullableIntBuffer(A,g,x,T)}static decodeNullableLongStream(o,c,g,x,T){const A=lm(o,c,g.numValues);return this.decodeNullableLongBuffer(A,g,x,T)}static decodeNullableIntBuffer(o,c,g,x){switch(c.logicalLevelTechnique1){case An.DELTA:return c.logicalLevelTechnique2===An.RLE&&(o=D_(o,c.runs,c.numRleValues)),function(T,A){const z=new Int32Array(T.size());let B=0;T.get(0)?(z[0]=T.get(0)?A[0]>>>1^-(1&A[0]):0,B=1):z[0]=0;let G=1;for(;G!=z.length;++G)z[G]=T.get(G)?z[G-1]+(A[B]>>>1^-(1&A[B++])):z[G-1];return z}(x,o);case An.RLE:return function(T,A,z,B){const G=A;return z?function(W,K,ot){const ct=new Int32Array(W.size());let dt=0;for(let xt=0;xt<ot;xt++){const At=K[xt];let jt=K[xt+ot];jt=jt>>>1^-(1&jt);for(let ue=dt;ue<dt+At;ue++)W.get(ue)?ct[ue]=jt:(ct[ue]=0,dt++);dt+=At}return ct}(B,T,G.runs):function(W,K,ot){const ct=new Int32Array(W.size());let dt=0;for(let xt=0;xt<ot;xt++){const At=K[xt],jt=K[xt+ot];for(let ue=dt;ue<dt+At;ue++)W.get(ue)?ct[ue]=jt:(ct[ue]=0,dt++);dt+=At}return ct}(B,T,G.runs)}(o,c,g,x);case An.MORTON:return L_(o),o;case An.COMPONENTWISE_DELTA:return Xy(o),o;case An.NONE:return o=g?function(T,A){const z=new Int32Array(T.size());let B=0,G=0;for(;G!=z.length;++G)if(T.get(G)){const W=A[B++];z[G]=W>>>1^-(1&W)}else z[G]=0;return z}(x,o):function(T,A){const z=new Int32Array(T.size());let B=0,G=0;for(;G!=z.length;++G)z[G]=T.get(G)?A[B++]:0;return z}(x,o),o;default:throw new Error("The specified Logical level technique is not supported")}}static decodeNullableLongBuffer(o,c,g,x){switch(c.logicalLevelTechnique1){case An.DELTA:return c.logicalLevelTechnique2===An.RLE&&(o=z_(o,c.runs,c.numRleValues)),function(T,A){const z=new BigInt64Array(T.size());let B=0;T.get(0)?(z[0]=T.get(0)?A[0]>>1n^-(1n&A[0]):0n,B=1):z[0]=0n;let G=1;for(;G!=z.length;++G)z[G]=T.get(G)?z[G-1]+(A[B]>>1n^-(1n&A[B++])):z[G-1];return z}(x,o);case An.RLE:return function(T,A,z,B){const G=A;return z?function(W,K,ot){const ct=new BigInt64Array(W.size());let dt=0;for(let xt=0;xt<ot;xt++){const At=Number(K[xt]);let jt=K[xt+ot];jt=jt>>1n^-(1n&jt);for(let ue=dt;ue<dt+At;ue++)W.get(ue)?ct[ue]=jt:(ct[ue]=0n,dt++);dt+=At}return ct}(B,T,G.runs):function(W,K,ot){const ct=new BigInt64Array(W.size());let dt=0;for(let xt=0;xt<ot;xt++){const At=Number(K[xt]),jt=K[xt+ot];for(let ue=dt;ue<dt+At;ue++)W.get(ue)?ct[ue]=jt:(ct[ue]=0n,dt++);dt+=At}return ct}(B,T,G.runs)}(o,c,g,x);case An.NONE:return o=g?function(T,A){const z=new BigInt64Array(T.size());let B=0,G=0;for(;G!=z.length;++G)if(T.get(G)){const W=A[B++];z[G]=W>>1n^-(1n&W)}else z[G]=0n;return z}(x,o):function(T,A){const z=new BigInt64Array(T.size());let B=0,G=0;for(;G!=z.length;++G)z[G]=T.get(G)?A[B++]:0n;return z}(x,o),o;default:throw new Error("The specified Logical level technique is not supported")}}static getVectorType(o,c,g,x){const T=o.logicalLevelTechnique1;if(T===An.RLE)return o.runs===1?Ns.CONST:Ns.FLAT;const A=c instanceof eu?c.size():c;if(T===An.DELTA&&o.logicalLevelTechnique2===An.RLE){const z=o.runs,B=2;if(o.numRleValues!==A)return Ns.FLAT;if(z===1)return Ns.SEQUENCE;if(z===2){const G=x.get();let W;if(o.physicalLevelTechnique===tu.VARINT)W=Ws(g,x,4);else{const K=x.get();W=new Int32Array(g.buffer,g.byteOffset+K,4)}if(x.set(G),W[2]===B&&W[3]===B)return Ns.SEQUENCE}}return o.numValues===1?Ns.CONST:Ns.FLAT}}class R_ extends Lg{getValueFromBuffer(o){return this.dataBuffer[o]}}class Xm extends M_{constructor(o,c,g,x){super(o,BigInt64Array.of(c),g,x)}getValueFromBuffer(o){return this.dataBuffer[0]+BigInt(o)*this.delta}}class Sc{_geometryOffsets;_partOffsets;_ringOffsets;constructor(o,c,g){this._geometryOffsets=o,this._partOffsets=c,this._ringOffsets=g}get geometryOffsets(){return this._geometryOffsets}get partOffsets(){return this._partOffsets}get ringOffsets(){return this._ringOffsets}}class Yy{tileExtent;_numBits;_coordinateShift;minBound;maxBound;constructor(o,c){this._coordinateShift=o<0?Math.abs(o):0,this.tileExtent=c+this._coordinateShift,this._numBits=Math.ceil(Math.log2(this.tileExtent)),this.minBound=o,this.maxBound=c}validateCoordinates(o){if(o.x<this.minBound||o.y<this.minBound||o.x>this.maxBound||o.y>this.maxBound)throw new Error("The specified tile buffer size is currently not supported.")}numBits(){return this._numBits}coordinateShift(){return this._coordinateShift}}class hm extends Yy{encode(o){this.validateCoordinates(o);const c=o.x+this._coordinateShift,g=o.y+this._coordinateShift;let x=0;for(let T=0;T<this._numBits;T++)x|=(c&1<<T)<<T|(g&1<<T)<<T+1;return x}decode(o){return{x:this.decodeMorton(o)-this._coordinateShift,y:this.decodeMorton(o>>1)-this._coordinateShift}}decodeMorton(o){let c=0;for(let g=0;g<this._numBits;g++)c|=(o&1<<2*g)>>g;return c}static decode(o,c,g){return{x:hm.decodeMorton(o,c)-g,y:hm.decodeMorton(o>>1,c)-g}}static decodeMorton(o,c){let g=0;for(let x=0;x<c;x++)g|=(o&1<<2*x)>>x;return g}}(function(h){h[h.POINT=0]="POINT",h[h.LINESTRING=1]="LINESTRING",h[h.POLYGON=2]="POLYGON",h[h.MULTIPOINT=3]="MULTIPOINT",h[h.MULTILINESTRING=4]="MULTILINESTRING",h[h.MULTIPOLYGON=5]="MULTIPOLYGON"})(da||(da={})),function(h){h[h.POINT=0]="POINT",h[h.LINESTRING=1]="LINESTRING",h[h.POLYGON=2]="POLYGON"}(am||(am={})),function(h){h[h.MORTON=0]="MORTON",h[h.VEC_2=1]="VEC_2",h[h.VEC_3=2]="VEC_3"}(gh||(gh={}));class nx{createPoint(o){return[[o]]}createMultiPoint(o){return o.map(c=>[c])}createLineString(o){return[o]}createMultiLineString(o){return o}createPolygon(o,c){return[o,...c]}createMultiPolygon(o){return o.flat()}}function Jy(h){const o=new Array(h.numGeometries);let c=1,g=1,x=1,T=0;const A=new nx;let z=0,B=0;const G=h.mortonSettings,W=h.topologyVector,K=W.geometryOffsets,ot=W.partOffsets,ct=W.ringOffsets,dt=h.vertexOffsets,xt=h.containsPolygonGeometry(),At=h.vertexBuffer;for(let jt=0;jt<h.numGeometries;jt++){const ue=h.geometryType(jt);if(ue===da.POINT){if(dt&&dt.length!==0)if(h.vertexBufferType===gh.VEC_2){const Qt=2*dt[B++],ie=new Pe(At[Qt],At[Qt+1]);o[T++]=A.createPoint(ie)}else{const Qt=dt[B++],ie=hm.decode(At[Qt],G.numBits,G.coordinateShift),Se=new Pe(ie.x,ie.y);o[T++]=A.createPoint(Se)}else{const Qt=new Pe(At[z++],At[z++]);o[T++]=A.createPoint(Qt)}K&&x++,ot&&c++,ct&&g++}else if(ue===da.MULTIPOINT){const Qt=K[x]-K[x-1];x++;const ie=new Array(Qt);if(dt&&dt.length!==0){for(let Se=0;Se<Qt;Se++){const Ee=2*dt[B++];ie[Se]=new Pe(At[Ee],At[Ee+1])}o[T++]=A.createMultiPoint(ie)}else{for(let Se=0;Se<Qt;Se++){const Ee=At[z++],ei=At[z++];ie[Se]=new Pe(Ee,ei)}o[T++]=A.createMultiPoint(ie)}}else if(ue===da.LINESTRING){let Qt,ie=0;xt?(ie=ct[g]-ct[g-1],g++):ie=ot[c]-ot[c-1],c++,dt&&dt.length!==0?(Qt=h.vertexBufferType===gh.VEC_2?F_(At,dt,B,ie,!1):Pf(At,dt,B,ie,!1,G),B+=ie):(Qt=k_(At,z,ie,!1),z+=2*ie),o[T++]=A.createLineString(Qt),K&&x++}else if(ue===da.POLYGON){const Qt=ot[c]-ot[c-1];c++;const ie=new Array(Qt-1);let Se=ct[g]-ct[g-1];if(g++,dt&&dt.length!==0){const Ee=h.vertexBufferType===gh.VEC_2?Fg(At,dt,B,Se):Bg(At,dt,B,Se,0,G);B+=Se;for(let ei=0;ei<ie.length;ei++)Se=ct[g]-ct[g-1],g++,ie[ei]=h.vertexBufferType===gh.VEC_2?Fg(At,dt,B,Se):Bg(At,dt,B,Se,0,G),B+=Se;o[T++]=A.createPolygon(Ee,ie)}else{const Ee=kg(At,z,Se);z+=2*Se;for(let ei=0;ei<ie.length;ei++)Se=ct[g]-ct[g-1],g++,ie[ei]=kg(At,z,Se),z+=2*Se;o[T++]=A.createPolygon(Ee,ie)}K&&x++}else if(ue===da.MULTILINESTRING){const Qt=K[x]-K[x-1];x++;const ie=new Array(Qt);if(dt&&dt.length!==0){for(let Se=0;Se<Qt;Se++){let Ee=0;xt?(Ee=ct[g]-ct[g-1],g++):Ee=ot[c]-ot[c-1],c++;const ei=h.vertexBufferType===gh.VEC_2?F_(At,dt,B,Ee,!1):Pf(At,dt,B,Ee,!1,G);ie[Se]=ei,B+=Ee}o[T++]=A.createMultiLineString(ie)}else{for(let Se=0;Se<Qt;Se++){let Ee=0;xt?(Ee=ct[g]-ct[g-1],g++):Ee=ot[c]-ot[c-1],c++,ie[Se]=k_(At,z,Ee,!1),z+=2*Ee}o[T++]=A.createMultiLineString(ie)}}else{if(ue!==da.MULTIPOLYGON)throw new Error("The specified geometry type is currently not supported.");{const Qt=K[x]-K[x-1];x++;const ie=new Array(Qt);let Se=0;if(dt&&dt.length!==0){for(let Ee=0;Ee<Qt;Ee++){const ei=ot[c]-ot[c-1];c++;const Ai=new Array(ei-1);Se=ct[g]-ct[g-1],g++;const mi=h.vertexBufferType===gh.VEC_2?Fg(At,dt,B,Se):Bg(At,dt,B,Se,0,G);B+=Se;for(let Ei=0;Ei<Ai.length;Ei++)Se=ct[g]-ct[g-1],g++,Ai[Ei]=h.vertexBufferType===gh.VEC_2?Fg(At,dt,B,Se):Bg(At,dt,B,Se,0,G),B+=Se;ie[Ee]=A.createPolygon(mi,Ai)}o[T++]=A.createMultiPolygon(ie)}else{for(let Ee=0;Ee<Qt;Ee++){const ei=ot[c]-ot[c-1];c++;const Ai=new Array(ei-1);Se=ct[g]-ct[g-1],g++;const mi=kg(At,z,Se);z+=2*Se;for(let Ei=0;Ei<Ai.length;Ei++){const Hi=ct[g]-ct[g-1];g++,Ai[Ei]=kg(At,z,Hi),z+=2*Hi}ie[Ee]=A.createPolygon(mi,Ai)}o[T++]=A.createMultiPolygon(ie)}}}}return o}function kg(h,o,c){return k_(h,o,c,!0)}function Fg(h,o,c,g){return F_(h,o,c,g,!0)}function Bg(h,o,c,g,x,T){return Pf(h,o,c,g,!0,T)}function k_(h,o,c,g){const x=new Array(g?c+1:c);for(let T=0;T<2*c;T+=2)x[T/2]=new Pe(h[o+T],h[o+T+1]);return g&&(x[x.length-1]=x[0]),x}function F_(h,o,c,g,x){const T=new Array(x?g+1:g);for(let A=0;A<2*g;A+=2){const z=2*o[c+A/2];T[A/2]=new Pe(h[z],h[z+1])}return x&&(T[T.length-1]=T[0]),T}function Pf(h,o,c,g,x,T){const A=new Array(x?g+1:g);for(let z=0;z<g;z++){const B=hm.decode(h[o[c+z]],T.numBits,T.coordinateShift);A[z]=new Pe(B.x,B.y)}return x&&(A[A.length-1]=A[0]),A}class B_{_vertexBufferType;_topologyVector;_vertexOffsets;_vertexBuffer;_mortonSettings;constructor(o,c,g,x,T){this._vertexBufferType=o,this._topologyVector=c,this._vertexOffsets=g,this._vertexBuffer=x,this._mortonSettings=T}get vertexBufferType(){return this._vertexBufferType}get topologyVector(){return this._topologyVector}get vertexOffsets(){return this._vertexOffsets}get vertexBuffer(){return this._vertexBuffer}*[Symbol.iterator](){const o=Jy(this);let c=0;for(;c<this.numGeometries;)yield{coordinates:o[c],type:this.geometryType(c)},c++}getSimpleEncodedVertex(o){const c=this.vertexOffsets?2*this.vertexOffsets[o]:2*o;return[this.vertexBuffer[c],this.vertexBuffer[c+1]]}getVertex(o){if(this.vertexOffsets&&this.mortonSettings){const g=hm.decode(this.vertexBuffer[this.vertexOffsets[o]],this.mortonSettings.numBits,this.mortonSettings.coordinateShift);return[g.x,g.y]}const c=this.vertexOffsets?2*this.vertexOffsets[o]:2*o;return[this.vertexBuffer[c],this.vertexBuffer[c+1]]}getGeometries(){return Jy(this)}get mortonSettings(){return this._mortonSettings}}class um extends B_{_numGeometries;_geometryType;constructor(o,c,g,x,T,A,z){super(g,x,T,A,z),this._numGeometries=o,this._geometryType=c}static createMortonEncoded(o,c,g,x,T,A){return new um(o,c,gh.MORTON,g,x,T,A)}static create(o,c,g,x,T){return new um(o,c,gh.VEC_2,g,x,T)}geometryType(o){return this._geometryType}get numGeometries(){return this._numGeometries}containsPolygonGeometry(){return this._geometryType===da.POLYGON||this._geometryType===da.MULTIPOLYGON}containsSingleGeometryType(){return!0}}class qp extends B_{_geometryTypes;constructor(o,c,g,x,T,A){super(o,g,x,T,A),this._geometryTypes=c}static createMortonEncoded(o,c,g,x,T){return new qp(gh.MORTON,o,c,g,x,T)}static create(o,c,g,x){return new qp(gh.VEC_2,o,c,g,x)}geometryType(o){return this._geometryTypes[o]}get numGeometries(){return this._geometryTypes.length}containsPolygonGeometry(){for(let o=0;o<this.numGeometries;o++)if(this.geometryType(o)===da.POLYGON||this.geometryType(o)===da.MULTIPOLYGON)return!0;return!1}containsSingleGeometryType(){return!1}}class O_{_triangleOffsets;_indexBuffer;_vertexBuffer;_topologyVector;constructor(o,c,g,x){this._triangleOffsets=o,this._indexBuffer=c,this._vertexBuffer=g,this._topologyVector=x}get triangleOffsets(){return this._triangleOffsets}get indexBuffer(){return this._indexBuffer}get vertexBuffer(){return this._vertexBuffer}get topologyVector(){return this._topologyVector}getGeometries(){if(!this._topologyVector)throw new Error("Cannot convert GpuVector to coordinates without topology information");const o=new Array(this.numGeometries),c=this._topologyVector,g=c.partOffsets,x=c.ringOffsets,T=c.geometryOffsets;let A=0,z=1,B=1,G=1;for(let W=0;W<this.numGeometries;W++)switch(this.geometryType(W)){case da.POLYGON:{const K=g[z]-g[z-1];z++;const ot=[];for(let ct=0;ct<K;ct++){const dt=x[B]-x[B-1];B++;const xt=[];for(let At=0;At<dt;At++){const jt=this._vertexBuffer[A++],ue=this._vertexBuffer[A++];xt.push(new Pe(jt,ue))}xt.length>0&&xt.push(xt[0]),ot.push(xt)}o[W]=ot,T&&G++}break;case da.MULTIPOLYGON:{const K=T[G]-T[G-1];G++;const ot=[];for(let ct=0;ct<K;ct++){const dt=g[z]-g[z-1];z++;for(let xt=0;xt<dt;xt++){const At=x[B]-x[B-1];B++;const jt=[];for(let ue=0;ue<At;ue++){const Qt=this._vertexBuffer[A++],ie=this._vertexBuffer[A++];jt.push(new Pe(Qt,ie))}jt.length>0&&jt.push(jt[0]),ot.push(jt)}}o[W]=ot}}return o}[Symbol.iterator](){return null}}class dm extends O_{_numGeometries;_geometryType;constructor(o,c,g,x,T,A){super(g,x,T,A),this._numGeometries=o,this._geometryType=c}static create(o,c,g,x,T,A){return new dm(o,c,g,x,T,A)}geometryType(o){return this._geometryType}get numGeometries(){return this._numGeometries}containsSingleGeometryType(){return!0}}class Mf extends O_{_geometryTypes;constructor(o,c,g,x,T){super(c,g,x,T),this._geometryTypes=o}static create(o,c,g,x,T){return new Mf(o,c,g,x,T)}geometryType(o){return this._geometryTypes[o]}get numGeometries(){return this._geometryTypes.length}containsSingleGeometryType(){return!1}}function Ky(h,o,c,g,x){const T=_l.decode(h,c);let A=null,z=null,B=null,G=null,W=null,K=null,ot=null,ct=null;if(hn.getVectorType(T,g,h,c)===Ns.CONST){const xt=hn.decodeConstIntStream(h,c,T,!1);for(let At=0;At<o-1;At++){const jt=_l.decode(h,c);switch(jt.physicalStreamType){case Ya.LENGTH:switch(jt.logicalStreamType.lengthType){case Tc.GEOMETRIES:A=hn.decodeLengthStreamToOffsetBuffer(h,c,jt);break;case Tc.PARTS:z=hn.decodeLengthStreamToOffsetBuffer(h,c,jt);break;case Tc.RINGS:B=hn.decodeLengthStreamToOffsetBuffer(h,c,jt);break;case Tc.TRIANGLES:ot=hn.decodeLengthStreamToOffsetBuffer(h,c,jt)}break;case Ya.OFFSET:switch(jt.logicalStreamType.offsetType){case Gp.VERTEX:G=hn.decodeIntStream(h,c,jt,!1);break;case Gp.INDEX:ct=hn.decodeIntStream(h,c,jt,!1)}break;case Ya.DATA:if(wc.VERTEX===jt.logicalStreamType.dictionaryType)W=hn.decodeIntStream(h,c,jt,!0,x);else{const ue=jt;K={numBits:ue.numBits(),coordinateShift:ue.coordinateShift()},W=hn.decodeIntStream(h,c,jt,!1,x)}}}if(ct!==null){if(A!=null||z!=null){const At=new Sc(A,z,B);return dm.create(g,xt,ot,ct,W,At)}return dm.create(g,xt,ot,ct,W)}return K===null?um.create(g,xt,new Sc(A,z,B),G,W):um.createMortonEncoded(g,xt,new Sc(A,z,B),G,W,K)}const dt=hn.decodeIntStream(h,c,T,!1);for(let xt=0;xt<o-1;xt++){const At=_l.decode(h,c);switch(At.physicalStreamType){case Ya.LENGTH:switch(At.logicalStreamType.lengthType){case Tc.GEOMETRIES:A=hn.decodeIntStream(h,c,At,!1);break;case Tc.PARTS:z=hn.decodeIntStream(h,c,At,!1);break;case Tc.RINGS:B=hn.decodeIntStream(h,c,At,!1);break;case Tc.TRIANGLES:ot=hn.decodeLengthStreamToOffsetBuffer(h,c,At)}break;case Ya.OFFSET:switch(At.logicalStreamType.offsetType){case Gp.VERTEX:G=hn.decodeIntStream(h,c,At,!1);break;case Gp.INDEX:ct=hn.decodeIntStream(h,c,At,!1)}break;case Ya.DATA:if(wc.VERTEX===At.logicalStreamType.dictionaryType)W=hn.decodeIntStream(h,c,At,!0,x);else{const jt=At;K={numBits:jt.numBits(),coordinateShift:jt.coordinateShift()},W=hn.decodeIntStream(h,c,At,!1,x)}}}return ct!==null&&z===null?Mf.create(dt,ot,ct,W):(A!==null?(A=N_(dt,A,2),z!==null&&B!==null?(z=Og(dt,A,z,!1),B=function(xt,At,jt,ue){const Qt=new Int32Array(jt[jt.length-1]+1);let ie=0;Qt[0]=ie;let Se=1,Ee=1,ei=0;for(let Ai=0;Ai<xt.length;Ai++){const mi=xt[Ai],Ei=At[Ai+1]-At[Ai];if(mi!==0&&mi!==3)for(let Hi=0;Hi<Ei;Hi++){const Ui=jt[Se]-jt[Se-1];Se++;for(let ji=0;ji<Ui;ji++)ie=Qt[Ee++]=ie+ue[ei++]}else for(let Hi=0;Hi<Ei;Hi++)Qt[Ee++]=++ie,Se++}return Qt}(dt,A,z,B)):z!==null&&(z=function(xt,At,jt){const ue=new Int32Array(At[At.length-1]+1);let Qt=0;ue[0]=Qt;let ie=1,Se=0;for(let Ee=0;Ee<xt.length;Ee++){const ei=xt[Ee],Ai=At[Ee+1]-At[Ee];if(ei===4||ei===1)for(let mi=0;mi<Ai;mi++)Qt=ue[ie++]=Qt+jt[Se++];else for(let mi=0;mi<Ai;mi++)ue[ie++]=++Qt}return ue}(dt,A,z))):z!==null&&B!==null?(z=N_(dt,z,1),B=Og(dt,z,B,!0)):z!==null&&(z=N_(dt,z,0)),ct!==null?Mf.create(dt,ot,ct,W,new Sc(A,z,B)):K===null?qp.create(dt,new Sc(A,z,B),G,W):qp.createMortonEncoded(dt,new Sc(A,z,B),G,W,K))}function N_(h,o,c){const g=new Int32Array(h.length+1);let x=0;g[0]=x;let T=0;for(let A=0;A<h.length;A++)x=g[A+1]=x+(h[A]>c?o[T++]:1);return g}function Og(h,o,c,g){const x=new Int32Array(o[o.length-1]+1);let T=0;x[0]=T;let A=1,z=0;for(let B=0;B<h.length;B++){const G=h[B],W=o[B+1]-o[B];if(G===5||G===2||g&&(G===4||G===1))for(let K=0;K<W;K++)T=x[A++]=T+c[z++];else for(let K=0;K<W;K++)x[A++]=++T}return x}class Qy extends om{dataVector;constructor(o,c,g){super(o,c.getBuffer(),g),this.dataVector=c}getValueFromBuffer(o){return this.dataVector.get(o)}}class t0 extends Lg{getValueFromBuffer(o){return this.dataBuffer[o]}}class Ng extends om{constructor(o,c,g){super(o,BigInt64Array.of(c),g)}getValueFromBuffer(o){return this.dataBuffer[0]}}function V_(h,o,c){for(let g=0;g<h;g++){const x=_l.decode(o,c);c.add(x.byteLength)}}function pm(h,o,c){return Vg(h,Math.ceil(o/8),c)}function Vg(h,o,c){const g=new Uint8Array(o);let x=0;for(;x<o;){const T=h[c.increment()];if(T<=127){const A=T+3,z=h[c.increment()],B=x+A;g.fill(z,x,B),x=B}else{const A=256-T;for(let z=0;z<A;z++)g[x++]=h[c.increment()]}}return g}const ox=new TextDecoder;function U_(h,o,c){return c-o>=12?ox.decode(h.subarray(o,c)):function(g,x,T){let A="",z=x;for(;z<T;){const B=g[z];let G,W,K,ot=null,ct=B>239?4:B>223?3:B>191?2:1;if(z+ct>T)break;ct===1?B<128&&(ot=B):ct===2?(G=g[z+1],(192&G)==128&&(ot=(31&B)<<6|63&G,ot<=127&&(ot=null))):ct===3?(G=g[z+1],W=g[z+2],(192&G)==128&&(192&W)==128&&(ot=(15&B)<<12|(63&G)<<6|63&W,(ot<=2047||ot>=55296&&ot<=57343)&&(ot=null))):ct===4&&(G=g[z+1],W=g[z+2],K=g[z+3],(192&G)==128&&(192&W)==128&&(192&K)==128&&(ot=(15&B)<<18|(63&G)<<12|(63&W)<<6|63&K,(ot<=65535||ot>=1114112)&&(ot=null))),ot===null?(ot=65533,ct=1):ot>65535&&(ot-=65536,A+=String.fromCharCode(ot>>>10&1023|55296),ot=56320|1023&ot),A+=String.fromCharCode(ot),z+=ct}return A}(h,o,c)}class j_ extends om{offsetBuffer;constructor(o,c,g,x){super(o,g,x),this.offsetBuffer=c}}class e0 extends j_{textEncoder;constructor(o,c,g,x){super(o,c,g,x??c.length-1),this.textEncoder=new TextEncoder}getValueFromBuffer(o){return U_(this.dataBuffer,this.offsetBuffer[o],this.offsetBuffer[o+1])}}class Cf extends j_{indexBuffer;textEncoder;constructor(o,c,g,x,T){super(o,g,x,T??c.length),this.indexBuffer=c,this.indexBuffer=c,this.textEncoder=new TextEncoder}getValueFromBuffer(o){const c=this.indexBuffer[o];return U_(this.dataBuffer,this.offsetBuffer[c],this.offsetBuffer[c+1])}}class tp extends j_{indexBuffer;symbolOffsetBuffer;symbolTableBuffer;textEncoder;symbolLengthBuffer;lengthBuffer;decodedDictionary;constructor(o,c,g,x,T,A,z){super(o,g,x,z),this.indexBuffer=c,this.symbolOffsetBuffer=T,this.symbolTableBuffer=A,this.textEncoder=new TextEncoder}getValueFromBuffer(o){this.decodedDictionary==null&&(this.symbolLengthBuffer==null&&(this.symbolLengthBuffer=this.offsetToLengthBuffer(this.symbolOffsetBuffer),this.lengthBuffer=this.offsetToLengthBuffer(this.offsetBuffer)),this.decodedDictionary=function(g,x,T){const A=[],z=new Array(x.length).fill(0);for(let B=1;B<x.length;B++)z[B]=z[B-1]+x[B-1];for(let B=0;B<T.length;B++)if(T[B]===255)A.push(T[++B]);else{const G=x[T[B]],W=z[T[B]];for(let K=0;K<G;K++)A.push(g[W+K])}return new Uint8Array(A)}(this.symbolTableBuffer,this.symbolLengthBuffer,this.dataBuffer));const c=this.indexBuffer[o];return U_(this.decodedDictionary,this.offsetBuffer[c],this.offsetBuffer[c+1])}offsetToLengthBuffer(o){const c=new Uint32Array(o.length-1);let g=o[0];for(let x=1;x<o.length;x++){const T=o[x];c[x-1]=T-g,g=T}return c}}class fm{static ROOT_COLUMN_NAME="default";static NESTED_COLUMN_SEPARATOR=":";constructor(){}static decode(o,c,g,x,T){let A=null,z=null,B=null,G=null,W=null,K=null,ot=null,ct=null;for(let dt=0;dt<x;dt++){const xt=_l.decode(c,g);if(xt.byteLength!==0)switch(xt.physicalStreamType){case Ya.PRESENT:{const At=pm(c,xt.numValues,g);K=new eu(At,xt.numValues);break}case Ya.OFFSET:z=T!=null||K!=null?hn.decodeNullableIntStream(c,g,xt,!1,T??K):hn.decodeIntStream(c,g,xt,!1);break;case Ya.LENGTH:{const At=hn.decodeLengthStreamToOffsetBuffer(c,g,xt);Tc.DICTIONARY===xt.logicalStreamType.lengthType?A=At:Tc.SYMBOL===xt.logicalStreamType.lengthType?G=At:ot=At;break}case Ya.DATA:{const At=c.subarray(g.get(),g.get()+xt.byteLength);g.add(xt.byteLength);const jt=xt.logicalStreamType.dictionaryType;wc.FSST===jt?W=At:wc.SINGLE===jt||wc.SHARED===jt?B=At:wc.NONE===jt&&(ct=At);break}}}return this.decodeFsstDictionaryVector(o,W,z,A,B,G,T??K)??this.decodeDictionaryVector(o,B,z,A,T??K)??this.decodePlainStringVector(o,ot,ct,z,T??K)}static decodeFsstDictionaryVector(o,c,g,x,T,A,z){return c?new tp(o,g,x,T,A,c,z):null}static decodeDictionaryVector(o,c,g,x,T){return c?T?new Cf(o,g,x,c,T):new Cf(o,g,x,c):null}static decodePlainStringVector(o,c,g,x,T){if(!c||!g)return null;if(x)return T?new Cf(o,x,c,g,T):new Cf(o,x,c,g);if(T&&T.size()!==c.length-1){const A=new Int32Array(T.size());let z=0;for(let B=0;B<T.size();B++)A[B]=T.get(B)?z++:0;return new Cf(o,A,c,g,T)}return T?new e0(o,c,g,T):new e0(o,c,g)}static decodeSharedDictionary(o,c,g,x,T){let A=null,z=null,B=null,G=null,W=!1;for(;!W;){const dt=_l.decode(o,c);switch(dt.physicalStreamType){case Ya.LENGTH:Tc.DICTIONARY===dt.logicalStreamType.lengthType?A=hn.decodeLengthStreamToOffsetBuffer(o,c,dt):B=hn.decodeLengthStreamToOffsetBuffer(o,c,dt);break;case Ya.DATA:wc.SINGLE===dt.logicalStreamType.dictionaryType||wc.SHARED===dt.logicalStreamType.dictionaryType?(z=o.subarray(c.get(),c.get()+dt.byteLength),W=!0):G=o.subarray(c.get(),c.get()+dt.byteLength),c.add(dt.byteLength)}}const K=g.complexType.children,ot=[];let ct=0;for(const dt of K){const xt=Ws(o,c,1)[0];if(xt==0)continue;const At=`${g.name}${dt.name===fm.ROOT_COLUMN_NAME?"":fm.NESTED_COLUMN_SEPARATOR+dt.name}`;if(T&&!T.has(At)){V_(xt,o,c);continue}if(xt!==2||dt.type!=="scalarField"||dt.scalarField.physicalType!==9)throw new Error("Currently only optional string fields are implemented for a struct.");const jt=_l.decode(o,c),ue=pm(o,jt.numValues,c),Qt=_l.decode(o,c),ie=(Qt instanceof Af?Qt.numRleValues:Qt.numValues)!==x?hn.decodeNullableIntStream(o,c,Qt,!1,new eu(ue,jt.numValues)):hn.decodeIntStream(o,c,Qt,!1);ot[ct++]=G?new tp(At,ie,A,z,B,G,new eu(ue,jt.numValues)):new Cf(At,ie,A,z,new eu(ue,jt.numValues))}return ot}}function i0(h,o,c,g,x,T){return c.type==="scalarType"?function(A,z,B,G,W,K){let ot=null,ct=0;if(A===0)return null;if(K.nullable){const xt=_l.decode(z,B);ct=xt.numValues;const At=B.get(),jt=pm(z,ct,B);B.set(At+xt.byteLength),ot=new eu(jt,xt.numValues)}const dt=ot??G;switch(W.physicalType){case 4:case 3:return function(xt,At,jt,ue,Qt){const ie=_l.decode(xt,At),Se=hn.getVectorType(ie,Qt,xt,At),Ee=ue.physicalType===3;if(Se===Ns.FLAT){const ei=ep(Qt)?hn.decodeNullableIntStream(xt,At,ie,Ee,Qt):hn.decodeIntStream(xt,At,ie,Ee);return new Hm(jt.name,ei,Qt)}if(Se===Ns.SEQUENCE){const ei=hn.decodeSequenceIntStream(xt,At,ie);return new If(jt.name,ei[0],ei[1],ie.numRleValues)}{const ei=hn.decodeConstIntStream(xt,At,ie,Ee);return new C_(jt.name,ei,Qt)}}(z,B,K,W,dt);case 9:return fm.decode(K.name,z,B,K.nullable?A-1:A,ot);case 0:return function(xt,At,jt,ue,Qt){const ie=_l.decode(xt,At),Se=ie.numValues,Ee=At.get(),ei=ep(Qt)?function(mi,Ei,Hi,Ui){const ji=Vg(mi,Math.ceil(Ei/8),Hi),gi=new eu(ji,Ei),Ar=Ui.size(),Pr=new eu(new Uint8Array(Ar),Ar);let Mr=0;for(let ur=0;ur<Ui.size();ur++){const Sn=!!Ui.get(ur)&&gi.get(Mr++);Pr.set(ur,Sn)}return Pr.getBuffer()}(xt,Se,At,Qt):pm(xt,Se,At);At.set(Ee+ie.byteLength);const Ai=new eu(ei,Se);return new Qy(jt.name,Ai,Qt)}(z,B,K,0,dt);case 6:case 5:return function(xt,At,jt,ue,Qt){const ie=_l.decode(xt,At),Se=hn.getVectorType(ie,ue,xt,At),Ee=Qt.physicalType===5;if(Se===Ns.FLAT){const ei=ep(ue)?hn.decodeNullableLongStream(xt,At,ie,Ee,ue):hn.decodeLongStream(xt,At,ie,Ee);return new R_(jt.name,ei,ue)}if(Se===Ns.SEQUENCE){const ei=hn.decodeSequenceLongStream(xt,At,ie);return new Xm(jt.name,ei[0],ei[1],ie.numRleValues)}{const ei=hn.decodeConstLongStream(xt,At,ie,Ee);return new Ng(jt.name,ei,ue)}}(z,B,K,dt,W);case 7:return function(xt,At,jt,ue){const Qt=_l.decode(xt,At),ie=ep(ue)?function(Se,Ee,ei,Ai){const mi=Ee.get(),Ei=mi+Ai*Float32Array.BYTES_PER_ELEMENT,Hi=new Uint8Array(Se.subarray(mi,Ei)).buffer,Ui=new Float32Array(Hi);Ee.set(Ei);const ji=ei.size(),gi=new Float32Array(ji);let Ar=0;for(let Pr=0;Pr<ji;Pr++)gi[Pr]=ei.get(Pr)?Ui[Ar++]:0;return gi}(xt,At,ue,Qt.numValues):function(Se,Ee,ei){const Ai=Ee.get(),mi=Ai+ei*Float32Array.BYTES_PER_ELEMENT,Ei=new Uint8Array(Se.subarray(Ai,mi)).buffer,Hi=new Float32Array(Ei);return Ee.set(mi),Hi}(xt,At,Qt.numValues);return new t0(jt.name,ie,ue)}(z,B,K,dt);case 8:return function(xt,At,jt,ue){const Qt=_l.decode(xt,At),ie=ep(ue)?function(Se,Ee,ei,Ai){const mi=Ee.get(),Ei=mi+Ai*Float64Array.BYTES_PER_ELEMENT,Hi=new Uint8Array(Se.subarray(mi,Ei)).buffer,Ui=new Float64Array(Hi);Ee.set(Ei);const ji=ei.size(),gi=new Float64Array(ji);let Ar=0;for(let Pr=0;Pr<ji;Pr++)gi[Pr]=ei.get(Pr)?Ui[Ar++]:0;return gi}(xt,At,ue,Qt.numValues):function(Se,Ee,ei){const Ai=Ee.get(),mi=Ai+ei*Float64Array.BYTES_PER_ELEMENT,Ei=new Uint8Array(Se.subarray(Ai,mi)).buffer,Hi=new Float64Array(Ei);return Ee.set(mi),Hi}(xt,At,Qt.numValues);return new P_(jt.name,ie,ue)}(z,B,K,dt);default:throw new Error(`The specified data type for the field is currently not supported: ${W}`)}}(g,h,o,x,c.scalarType,c):g!=1?null:fm.decodeSharedDictionary(h,o,c,x,T)}function ep(h){return h instanceof eu}class Zp{static decodeColumnType(o){switch(o){case 0:case 1:case 2:case 3:{const c={};c.nullable=!!(1&o),c.columnScope=0;const g={};return g.physicalType=o>1?6:4,g.type="physicalType",c.scalarType=g,c.type="scalarType",c}case 4:{const c={nullable:!1,columnScope:0},g={type:"physicalType",physicalType:0};return c.type="complexType",c.complexType=g,c}case 30:{const c={nullable:!1,columnScope:0},g={type:"physicalType",physicalType:1};return c.type="complexType",c.complexType=g,c}default:return this.mapScalarType(o)}}static columnTypeHasName(o){return o>=10}static columnTypeHasChildren(o){return o===30}static hasStreamCount(o){if(o.name==="id")return!1;if(o.type==="scalarType"){const c=o.scalarType;if(c.type==="physicalType")switch(c.physicalType){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:default:return!1;case 9:return!0}else if(c.type==="logicalType")return!1}else if(o.type==="complexType"){const c=o.complexType;if(c.type==="physicalType")switch(c.physicalType){case 0:case 1:return!0;default:return!1}}return console.warn("Unexpected column type in hasStreamCount",o),!1}static mapScalarType(o){let c=null;switch(o){case 10:case 11:c=0;break;case 12:case 13:c=1;break;case 14:case 15:c=2;break;case 16:case 17:c=3;break;case 18:case 19:c=4;break;case 20:case 21:c=5;break;case 22:case 23:c=6;break;case 24:case 25:c=7;break;case 26:case 27:c=8;break;case 28:case 29:c=9;break;default:return null}const g={};g.nullable=!!(1&o),g.columnScope=0;const x={type:"physicalType"};return x.physicalType=c,g.type="scalarType",g.scalarType=x,g}}const Ug=new TextDecoder;function mm(h,o){const c=Ws(h,o,1)[0];if(c===0)return"";const g=o.get(),x=h.subarray(g,g+c);return o.add(c),Ug.decode(x)}function G_(h,o){const c=Ws(h,o,1)[0]>>>0,g=!!(4&c),x=!!(2&c),T=Ws(h,o,1)[0]>>>0,A={};if(1&c&&(A.nullable=!0),x){const z={};if(g?(z.type="logicalType",z.logicalType=T):(z.type="physicalType",z.physicalType=T),8&c){const B=Ws(h,o,1)[0]>>>0;z.children=new Array(B);for(let G=0;G<B;G++)z.children[G]=G_(h,o)}A.type="complexField",A.complexField=z}else{const z={};g?(z.type="logicalType",z.logicalType=T):(z.type="physicalType",z.physicalType=T),A.type="scalarField",A.scalarField=z}return A}function r0(h,o){const c=Ws(h,o,1)[0]>>>0,g=Zp.decodeColumnType(c);if(!g)throw new Error(`Unsupported column type code: ${c}`);if(Zp.columnTypeHasName(c)?g.name=mm(h,o):c>=0&&c<=3?g.name="id":c===4&&(g.name="geometry"),Zp.columnTypeHasChildren(c)){const x=Ws(h,o,1)[0]>>>0,T=g.complexType;T.children=new Array(x);for(let A=0;A<x;A++)T.children[A]=G_(h,o)}return g}function n0(h,o){const c={featureTables:[]},g={};g.name=mm(h,o);const x=Ws(h,o,1)[0]>>>0,T=Ws(h,o,1)[0]>>>0;g.columns=new Array(T);for(let A=0;A<T;A++)g.columns[A]=r0(h,o);return c.featureTables.push(g),[c,x]}function o0(h,o,c,g,x,T,A=!1){const z=o.scalarType.physicalType,B=hn.getVectorType(x,T,h,c);if(z===4)switch(B){case Ns.FLAT:{const G=hn.decodeIntStream(h,c,x,!1);return new Hm(g,G,T)}case Ns.SEQUENCE:{const G=hn.decodeSequenceIntStream(h,c,x);return new If(g,G[0],G[1],x.numRleValues)}case Ns.CONST:{const G=hn.decodeConstIntStream(h,c,x,!1);return new C_(g,G,T)}}else switch(B){case Ns.FLAT:{if(A){const W=hn.decodeLongFloat64Stream(h,c,x,!1);return new P_(g,W,T)}const G=hn.decodeLongStream(h,c,x,!1);return new R_(g,G,T)}case Ns.SEQUENCE:{const G=hn.decodeSequenceLongStream(h,c,x);return new Xm(g,G[0],G[1],x.numRleValues)}case Ns.CONST:{const G=hn.decodeConstLongStream(h,c,x,!1);return new Ng(g,G,T)}}throw new Error("Vector type not supported for id column.")}class sx{constructor(o,c){var g;switch(this._featureData=o,this.properties=this._featureData.properties||{},(g=this._featureData.geometry)===null||g===void 0?void 0:g.type){case da.POINT:case da.MULTIPOINT:this.type=1;break;case da.LINESTRING:case da.MULTILINESTRING:this.type=2;break;case da.POLYGON:case da.MULTIPOLYGON:this.type=3;break;default:this.type=0}this.extent=c,this.id=Number(this._featureData.id)}projectPoint(o,c,g,x){return[360*(o.x+c)/x-180,360/Math.PI*Math.atan(Math.exp((1-2*(o.y+g)/x)*Math.PI))-90]}projectLine(o,c,g,x){return o.map(T=>this.projectPoint(T,c,g,x))}toGeoJSON(o,c,g){const x=this.extent*Math.pow(2,g),T=this.extent*o,A=this.extent*c,z=this.loadGeometry();let B;switch(this.type){case 1:{const W=[];for(const ot of z)W.push(ot[0]);const K=this.projectLine(W,T,A,x);B=W.length===1?{type:"Point",coordinates:K[0]}:{type:"MultiPoint",coordinates:K};break}case 2:{const W=z.map(K=>this.projectLine(K,T,A,x));B=W.length===1?{type:"LineString",coordinates:W[0]}:{type:"MultiLineString",coordinates:W};break}case 3:{const W=th(z),K=[];for(const ot of W)K.push(ot.map(ct=>this.projectLine(ct,T,A,x)));B=K.length===1?{type:"Polygon",coordinates:K[0]}:{type:"MultiPolygon",coordinates:K};break}default:throw new Error(`unknown feature type: ${this.type}`)}const G={type:"Feature",geometry:B,properties:this.properties};return this.id!=null&&(G.id=this.id),G}loadGeometry(){const o=[];for(const c of this._featureData.geometry.coordinates){const g=[];for(const x of c)g.push(new Pe(x.x,x.y));o.push(g)}return o}bbox(){return[0,0,0,0]}}class ax{constructor(o){this.features=[],this.featureTable=o,this.name=o.name,this.extent=o.extent,this.version=2,this.features=o.getFeatures(),this.length=this.features.length}feature(o){return new sx(this.features[o],this.extent)}}class jg{constructor(o){this.layers={};const c=function(g,x,T=!0){const A=new sm(0),z=[];for(;A.get()<g.length;){const B=Ws(g,A,1)[0]>>>0,G=A.get()+B;if(G>g.length)throw new Error(`Block overruns tile: ${G} > ${g.length}`);if(Ws(g,A,1)[0]>>>0!=1){A.set(G);continue}const W=n0(g,A),K=W[1],ot=W[0].featureTables[0];let ct=null,dt=null;const xt=[];let At=0;for(const ue of ot.columns){const Qt=ue.name;if(Qt==="id"){let ie=null;if(ue.nullable){const Ee=_l.decode(g,A),ei=A.get(),Ai=pm(g,Ee.numValues,A);A.set(ei+Ee.byteLength),ie=new eu(Ai,Ee.numValues)}const Se=_l.decode(g,A);At=Se.getDecompressedCount(),ct=o0(g,ue,A,Qt,Se,ie??At,T)}else if(Qt==="geometry"){const ie=Ws(g,A,1)[0];if(At===0){const Se=A.get();At=_l.decode(g,A).getDecompressedCount(),A.set(Se)}dt=Ky(g,ie,A,At,x)}else{const ie=Zp.hasStreamCount(ue)?Ws(g,A,1)[0]:1;if(ie===0&&ue.type==="scalarType")continue;const Se=i0(g,A,ue,ie,At,void 0);Se&&(Array.isArray(Se)?xt.push(...Se):xt.push(Se))}}const jt=new Hs(ot.name,dt,ct,xt,K);z.push(jt),A.set(G)}return z}(new Uint8Array(o));this.layers=c.reduce((g,x)=>Object.assign(Object.assign({},g),{[x.name]:new ax(x)}),{})}}class vd{constructor(){this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0}extend(o){return this.minX=Math.min(this.minX,o.x),this.minY=Math.min(this.minY,o.y),this.maxX=Math.max(this.maxX,o.x),this.maxY=Math.max(this.maxY,o.y),this}expandBy(o){return this.minX-=o,this.minY-=o,this.maxX+=o,this.maxY+=o,(this.minX>this.maxX||this.minY>this.maxY)&&(this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0),this}shrinkBy(o){return this.expandBy(-o)}map(o){const c=new vd;return c.extend(o(new Pe(this.minX,this.minY))),c.extend(o(new Pe(this.maxX,this.minY))),c.extend(o(new Pe(this.minX,this.maxY))),c.extend(o(new Pe(this.maxX,this.maxY))),c}static fromPoints(o){const c=new vd;for(const g of o)c.extend(g);return c}contains(o){return o.x>=this.minX&&o.x<=this.maxX&&o.y>=this.minY&&o.y<=this.maxY}empty(){return this.minX>this.maxX}width(){return this.maxX-this.minX}height(){return this.maxY-this.minY}covers(o){return!this.empty()&&!o.empty()&&o.minX>=this.minX&&o.maxX<=this.maxX&&o.minY>=this.minY&&o.maxY<=this.maxY}intersects(o){return!this.empty()&&!o.empty()&&o.minX<=this.maxX&&o.maxX>=this.minX&&o.minY<=this.maxY&&o.maxY>=this.minY}}const Gg="_geojsonTileLayer";class s0{constructor(o,c){this.tileID=o,this.x=o.canonical.x,this.y=o.canonical.y,this.z=o.canonical.z,this.grid=new id(Ln,16,0),this.grid3D=new id(Ln,16,0),this.featureIndexArray=new Kt,this.promoteId=c}insert(o,c,g,x,T,A){const z=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(g,x,T);const B=A?this.grid3D:this.grid;for(let G=0;G<c.length;G++){const W=c[G],K=[1/0,1/0,-1/0,-1/0];for(let ot=0;ot<W.length;ot++){const ct=W[ot];K[0]=Math.min(K[0],ct.x),K[1]=Math.min(K[1],ct.y),K[2]=Math.max(K[2],ct.x),K[3]=Math.max(K[3],ct.y)}K[0]<Ln&&K[1]<Ln&&K[2]>=0&&K[3]>=0&&B.insert(z,K[0],K[1],K[2],K[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=this.encoding!=="mlt"?new Be(new As(this.rawTileData)).layers:new jg(this.rawTileData).layers,this.sourceLayerCoder=new qy(this.vtLayers?Object.keys(this.vtLayers).sort():[Gg])),this.vtLayers}query(o,c,g,x){this.loadVTLayers();const T=o.params,A=Ln/o.tileSize/o.scale,z=Rd(T.filter,T.globalState),B=o.queryGeometry,G=o.queryPadding*A,W=vd.fromPoints(B),K=this.grid.query(W.minX-G,W.minY-G,W.maxX+G,W.maxY+G),ot=vd.fromPoints(o.cameraQueryGeometry).expandBy(G),ct=this.grid3D.query(ot.minX,ot.minY,ot.maxX,ot.maxY,(At,jt,ue,Qt)=>function(ie,Se,Ee,ei,Ai){for(const Ei of ie)if(Se<=Ei.x&&Ee<=Ei.y&&ei>=Ei.x&&Ai>=Ei.y)return!0;const mi=[new Pe(Se,Ee),new Pe(Se,Ai),new Pe(ei,Ai),new Pe(ei,Ee)];if(ie.length>2){for(const Ei of mi)if(dd(ie,Ei))return!0}for(let Ei=0;Ei<ie.length-1;Ei++)if(fg(ie[Ei],ie[Ei+1],mi))return!0;return!1}(o.cameraQueryGeometry,At-G,jt-G,ue+G,Qt+G));for(const At of ct)K.push(At);K.sort(q_);const dt={};let xt;for(let At=0;At<K.length;At++){const jt=K[At];if(jt===xt)continue;xt=jt;const ue=this.featureIndexArray.get(jt);let Qt=null;this.loadMatchingFeature(dt,ue.bucketIndex,ue.sourceLayerIndex,ue.featureIndex,z,T.layers,T.availableImages,c,g,x,(ie,Se,Ee)=>(Qt||(Qt=Fl(ie)),Se.queryIntersectsFeature({queryGeometry:B,feature:ie,featureState:Ee,geometry:Qt,zoom:this.z,transform:o.transform,pixelsToTileUnits:A,pixelPosMatrix:o.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:o.getElevation})))}return dt}loadMatchingFeature(o,c,g,x,T,A,z,B,G,W,K){const ot=this.bucketLayerIDs[c];if(A&&!ot.some(At=>A.has(At)))return;const ct=this.sourceLayerCoder.decode(g),dt=this.vtLayers[ct].feature(x);if(T.needGeometry){const At=gc(dt,!0);if(!T.filter(new uo(this.tileID.overscaledZ),At,this.tileID.canonical))return}else if(!T.filter(new uo(this.tileID.overscaledZ),dt))return;const xt=this.getId(dt,ct);for(let At=0;At<ot.length;At++){const jt=ot[At];if(A&&!A.has(jt))continue;const ue=B[jt];if(!ue)continue;let Qt={};xt&&W&&(Qt=W.getState(ue.sourceLayer||Gg,xt));const ie=Wo({},G[jt]);ie.paint=$_(ie.paint,ue.paint,dt,Qt,z),ie.layout=$_(ie.layout,ue.layout,dt,Qt,z);const Se=!K||K(dt,ue,Qt);if(!Se)continue;const Ee=new Zy(dt,this.z,this.x,this.y,xt);Ee.layer=ie;let ei=o[jt];ei===void 0&&(ei=o[jt]=[]),ei.push({featureIndex:x,feature:Ee,intersectionZ:Se})}}lookupSymbolFeatures(o,c,g,x,T,A,z,B){const G={};this.loadVTLayers();const W=Rd(T.filterSpec,T.globalState);for(const K of o)this.loadMatchingFeature(G,g,x,K,W,A,z,B,c);return G}hasLayer(o){for(const c of this.bucketLayerIDs)for(const g of c)if(o===g)return!0;return!1}getId(o,c){var g;let x=o.id;return this.promoteId&&(x=o.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[c]],typeof x=="boolean"&&(x=Number(x)),x===void 0&&(!((g=o.properties)===null||g===void 0)&&g.cluster)&&this.promoteId&&(x=Number(o.properties.cluster_id))),x}}function $_(h,o,c,g,x){return ho(h,(T,A)=>{const z=o instanceof qh?o.get(A):null;return z&&z.evaluate?z.evaluate(c,g,x):z})}function q_(h,o){return o-h}function Z_(h,o,c,g,x){const T=[];for(let A=0;A<h.length;A++){const z=h[A];let B;for(let G=0;G<z.length-1;G++){let W=z[G],K=z[G+1];W.x<o&&K.x<o||(W.x<o?W=new Pe(o,W.y+(o-W.x)/(K.x-W.x)*(K.y-W.y))._round():K.x<o&&(K=new Pe(o,W.y+(o-W.x)/(K.x-W.x)*(K.y-W.y))._round()),W.y<c&&K.y<c||(W.y<c?W=new Pe(W.x+(c-W.y)/(K.y-W.y)*(K.x-W.x),c)._round():K.y<c&&(K=new Pe(W.x+(c-W.y)/(K.y-W.y)*(K.x-W.x),c)._round()),W.x>=g&&K.x>=g||(W.x>=g?W=new Pe(g,W.y+(g-W.x)/(K.x-W.x)*(K.y-W.y))._round():K.x>=g&&(K=new Pe(g,W.y+(g-W.x)/(K.x-W.x)*(K.y-W.y))._round()),W.y>=x&&K.y>=x||(W.y>=x?W=new Pe(W.x+(x-W.y)/(K.y-W.y)*(K.x-W.x),x)._round():K.y>=x&&(K=new Pe(W.x+(x-W.y)/(K.y-W.y)*(K.x-W.x),x)._round()),B&&W.equals(B[B.length-1])||(B=[W],T.push(B)),B.push(K)))))}}return T}function H_(h,o,c,g,x){switch(o){case 1:return function(T,A,z,B){const G=[];for(const W of T)for(const K of W){const ot=B===0?K.x:K.y;ot>=A&&ot<=z&&G.push([K])}return G}(h,c,g,x);case 2:return W_(h,c,g,x,!1);case 3:return W_(h,c,g,x,!0)}return[]}function a0(h,o,c,g,x){const T=g===0?l0:lx;let A=[];const z=[];for(let W=0;W<h.length-1;W++){const K=h[W],ot=h[W+1],ct=g===0?K.x:K.y,dt=g===0?ot.x:ot.y;let xt=!1;ct<o?dt>o&&A.push(T(K,ot,o)):ct>c?dt<c&&A.push(T(K,ot,c)):A.push(K),dt<o&&ct>=o&&(A.push(T(K,ot,o)),xt=!0),dt>c&&ct<=c&&(A.push(T(K,ot,c)),xt=!0),!x&&xt&&(z.push(A),A=[])}const B=h.length-1,G=g===0?h[B].x:h[B].y;return G>=o&&G<=c&&A.push(h[B]),x&&A.length>0&&!A[0].equals(A[A.length-1])&&A.push(new Pe(A[0].x,A[0].y)),A.length>0&&z.push(A),z}function W_(h,o,c,g,x){const T=[];for(const A of h){const z=a0(A,o,c,g,x);z.length>0&&T.push(...z)}return T}function l0(h,o,c){return new Pe(c,h.y+(c-h.x)/(o.x-h.x)*(o.y-h.y))}function lx(h,o,c){return new Pe(h.x+(c-h.y)/(o.y-h.y)*(o.x-h.x),c)}Ki("FeatureIndex",s0,{omit:["rawTileData","sourceLayerCoder"]});class ip extends Pe{constructor(o,c,g,x){super(o,c),this.angle=g,x!==void 0&&(this.segment=x)}clone(){return new ip(this.x,this.y,this.angle,this.segment)}}function X_(h,o,c,g,x){if(o.segment===void 0||c===0)return!0;let T=o,A=o.segment+1,z=0;for(;z>-c/2;){if(A--,A<0)return!1;z-=h[A].dist(T),T=h[A]}z+=h[A].dist(h[A+1]),A++;const B=[];let G=0;for(;z<c/2;){const W=h[A],K=h[A+1];if(!K)return!1;let ot=h[A-1].angleTo(W)-W.angleTo(K);for(ot=Math.abs((ot+3*Math.PI)%(2*Math.PI)-Math.PI),B.push({distance:z,angleDelta:ot}),G+=ot;z-B[0].distance>g;)G-=B.shift().angleDelta;if(G>x)return!1;A++,z+=W.dist(K)}return!0}function Hp(h){let o=0;for(let c=0;c<h.length-1;c++)o+=h[c].dist(h[c+1]);return o}function Y_(h,o,c){return h?.6*o*c:0}function J_(h,o){return Math.max(h?h.right-h.left:0,o?o.right-o.left:0)}function c0(h,o,c,g,x,T){const A=Y_(c,x,T),z=J_(c,g)*T;let B=0;const G=Hp(h)/2;for(let W=0;W<h.length-1;W++){const K=h[W],ot=h[W+1],ct=K.dist(ot);if(B+ct>G){const dt=(G-B)/ct,xt=Za.number(K.x,ot.x,dt),At=Za.number(K.y,ot.y,dt),jt=new ip(xt,At,ot.angleTo(K),W);return jt._round(),!A||X_(h,jt,z,A,o)?jt:void 0}B+=ct}}function $g(h,o,c,g,x,T,A,z,B){const G=Y_(g,T,A),W=J_(g,x),K=W*A,ot=h[0].x===0||h[0].x===B||h[0].y===0||h[0].y===B;return o-K<o/4&&(o=K+o/4),h0(h,ot?o/2*z%o:(W/2+2*T)*A*z%o,o,G,c,K,ot,!1,B)}function h0(h,o,c,g,x,T,A,z,B){const G=T/2,W=Hp(h);let K=0,ot=o-c,ct=[];for(let dt=0;dt<h.length-1;dt++){const xt=h[dt],At=h[dt+1],jt=xt.dist(At),ue=At.angleTo(xt);for(;ot+c<K+jt;){ot+=c;const Qt=(ot-K)/jt,ie=Za.number(xt.x,At.x,Qt),Se=Za.number(xt.y,At.y,Qt);if(ie>=0&&ie<B&&Se>=0&&Se<B&&ot-G>=0&&ot+G<=W){const Ee=new ip(ie,Se,ue,dt);Ee._round(),g&&!X_(h,Ee,T,g,x)||ct.push(Ee)}}K+=jt}return z||ct.length||A||(ct=h0(h,K/2,c,g,x,T,A,!0,B)),ct}function K_(h,o,c,g){const x=[],T=h.image,A=T.pixelRatio,z=T.paddedRect.w-2,B=T.paddedRect.h-2;let G={x1:h.left,y1:h.top,x2:h.right,y2:h.bottom};const W=T.stretchX||[[0,z]],K=T.stretchY||[[0,B]],ot=(gi,Ar)=>gi+Ar[1]-Ar[0],ct=W.reduce(ot,0),dt=K.reduce(ot,0),xt=z-ct,At=B-dt;let jt=0,ue=ct,Qt=0,ie=dt,Se=0,Ee=xt,ei=0,Ai=At;if(T.content&&g){const gi=T.content,Ar=gi[2]-gi[0],Pr=gi[3]-gi[1];(T.textFitWidth||T.textFitHeight)&&(G=Gm(h)),jt=Wp(W,0,gi[0]),Qt=Wp(K,0,gi[1]),ue=Wp(W,gi[0],gi[2]),ie=Wp(K,gi[1],gi[3]),Se=gi[0]-jt,ei=gi[1]-Qt,Ee=Ar-ue,Ai=Pr-ie}const mi=G.x1,Ei=G.y1,Hi=G.x2-mi,Ui=G.y2-Ei,ji=(gi,Ar,Pr,Mr)=>{const ur=Ym(gi.stretch-jt,ue,Hi,mi),Sn=Jm(gi.fixed-Se,Ee,gi.stretch,ct),is=Ym(Ar.stretch-Qt,ie,Ui,Ei),xs=Jm(Ar.fixed-ei,Ai,Ar.stretch,dt),yl=Ym(Pr.stretch-jt,ue,Hi,mi),Gc=Jm(Pr.fixed-Se,Ee,Pr.stretch,ct),Ja=Ym(Mr.stretch-Qt,ie,Ui,Ei),Sa=Jm(Mr.fixed-ei,Ai,Mr.stretch,dt),Vs=new Pe(ur,is),vs=new Pe(yl,is),Ka=new Pe(yl,Ja),xl=new Pe(ur,Ja),Bl=new Pe(Sn/A,xs/A),Ic=new Pe(Gc/A,Sa/A),vl=o*Math.PI/180;if(vl){const Ia=Math.sin(vl),bs=Math.cos(vl),Xs=[bs,-Ia,Ia,bs];Vs._matMult(Xs),vs._matMult(Xs),xl._matMult(Xs),Ka._matMult(Xs)}const Ol=gi.stretch+gi.fixed,ru=Ar.stretch+Ar.fixed;return{tl:Vs,tr:vs,bl:xl,br:Ka,tex:{x:T.paddedRect.x+1+Ol,y:T.paddedRect.y+1+ru,w:Pr.stretch+Pr.fixed-Ol,h:Mr.stretch+Mr.fixed-ru},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Bl,pixelOffsetBR:Ic,minFontScaleX:Ee/A/Hi,minFontScaleY:Ai/A/Ui,isSDF:c}};if(g&&(T.stretchX||T.stretchY)){const gi=Q_(W,xt,ct),Ar=Q_(K,At,dt);for(let Pr=0;Pr<gi.length-1;Pr++){const Mr=gi[Pr],ur=gi[Pr+1];for(let Sn=0;Sn<Ar.length-1;Sn++)x.push(ji(Mr,Ar[Sn],ur,Ar[Sn+1]))}}else x.push(ji({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:z+1},{fixed:0,stretch:B+1}));return x}function Wp(h,o,c){let g=0;for(const x of h)g+=Math.max(o,Math.min(c,x[1]))-Math.max(o,Math.min(c,x[0]));return g}function Q_(h,o,c){const g=[{fixed:-1,stretch:0}];for(const[x,T]of h){const A=g[g.length-1];g.push({fixed:x-A.stretch,stretch:A.stretch}),g.push({fixed:x-A.stretch,stretch:A.stretch+(T-x)})}return g.push({fixed:o+1,stretch:c}),g}function Ym(h,o,c,g){return h/o*c+g}function Jm(h,o,c,g){return h-o*c/g}Ki("Anchor",ip);class Km{constructor(o,c,g,x,T,A,z,B,G,W){var K;if(this.boxStartIndex=o.length,G){let ot=A.top,ct=A.bottom;const dt=A.collisionPadding;dt&&(ot-=dt[1],ct+=dt[3]);let xt=ct-ot;xt>0&&(xt=Math.max(10,xt),this.circleDiameter=xt)}else{const ot=!((K=A.image)===null||K===void 0)&&K.content&&(A.image.textFitWidth||A.image.textFitHeight)?Gm(A):{x1:A.left,y1:A.top,x2:A.right,y2:A.bottom};ot.y1=ot.y1*z-B[0],ot.y2=ot.y2*z+B[2],ot.x1=ot.x1*z-B[3],ot.x2=ot.x2*z+B[1];const ct=A.collisionPadding;if(ct&&(ot.x1-=ct[0]*z,ot.y1-=ct[1]*z,ot.x2+=ct[2]*z,ot.y2+=ct[3]*z),W){const dt=new Pe(ot.x1,ot.y1),xt=new Pe(ot.x2,ot.y1),At=new Pe(ot.x1,ot.y2),jt=new Pe(ot.x2,ot.y2),ue=W*Math.PI/180;dt._rotate(ue),xt._rotate(ue),At._rotate(ue),jt._rotate(ue),ot.x1=Math.min(dt.x,xt.x,At.x,jt.x),ot.x2=Math.max(dt.x,xt.x,At.x,jt.x),ot.y1=Math.min(dt.y,xt.y,At.y,jt.y),ot.y2=Math.max(dt.y,xt.y,At.y,jt.y)}o.emplaceBack(c.x,c.y,ot.x1,ot.y1,ot.x2,ot.y2,g,x,T)}this.boxEndIndex=o.length}}class cx{constructor(o=[],c=(g,x)=>g<x?-1:g>x?1:0){if(this.data=o,this.length=this.data.length,this.compare=c,this.length>0)for(let g=(this.length>>1)-1;g>=0;g--)this._down(g)}push(o){this.data.push(o),this._up(this.length++)}pop(){if(this.length===0)return;const o=this.data[0],c=this.data.pop();return--this.length>0&&(this.data[0]=c,this._down(0)),o}peek(){return this.data[0]}_up(o){const{data:c,compare:g}=this,x=c[o];for(;o>0;){const T=o-1>>1,A=c[T];if(g(x,A)>=0)break;c[o]=A,o=T}c[o]=x}_down(o){const{data:c,compare:g}=this,x=this.length>>1,T=c[o];for(;o<x;){let A=1+(o<<1);const z=A+1;if(z<this.length&&g(c[z],c[A])<0&&(A=z),g(c[A],T)>=0)break;c[o]=c[A],o=A}c[o]=T}}function hx(h,o=1,c=!1){const g=vd.fromPoints(h[0]),x=Math.min(g.width(),g.height());let T=x/2;const A=new cx([],u0),{minX:z,minY:B,maxX:G,maxY:W}=g;if(x===0)return new Pe(z,B);for(let ct=z;ct<G;ct+=x)for(let dt=B;dt<W;dt+=x)A.push(new bd(ct+T,dt+T,T,h));let K=function(ct){let dt=0,xt=0,At=0;const jt=ct[0];for(let ue=0,Qt=jt.length,ie=Qt-1;ue<Qt;ie=ue++){const Se=jt[ue],Ee=jt[ie],ei=Se.x*Ee.y-Ee.x*Se.y;xt+=(Se.x+Ee.x)*ei,At+=(Se.y+Ee.y)*ei,dt+=3*ei}return new bd(xt/dt,At/dt,0,ct)}(h),ot=A.length;for(;A.length;){const ct=A.pop();(ct.d>K.d||!K.d)&&(K=ct,c&&console.log("found best %d after %d probes",Math.round(1e4*ct.d)/1e4,ot)),ct.max-K.d<=o||(T=ct.h/2,A.push(new bd(ct.p.x-T,ct.p.y-T,T,h)),A.push(new bd(ct.p.x+T,ct.p.y-T,T,h)),A.push(new bd(ct.p.x-T,ct.p.y+T,T,h)),A.push(new bd(ct.p.x+T,ct.p.y+T,T,h)),ot+=4)}return c&&(console.log(`num probes: ${ot}`),console.log(`best distance: ${K.d}`)),K.p}function u0(h,o){return o.max-h.max}function bd(h,o,c,g){this.p=new Pe(h,o),this.h=c,this.d=function(x,T){let A=!1,z=1/0;for(let B=0;B<T.length;B++){const G=T[B];for(let W=0,K=G.length,ot=K-1;W<K;ot=W++){const ct=G[W],dt=G[ot];ct.y>x.y!=dt.y>x.y&&x.x<(dt.x-ct.x)*(x.y-ct.y)/(dt.y-ct.y)+ct.x&&(A=!A),z=Math.min(z,Jf(x,ct,dt))}}return(A?1:-1)*Math.sqrt(z)}(this.p,g),this.max=this.d+this.h*Math.SQRT2}var Oa;it.aO=void 0,(Oa=it.aO||(it.aO={}))[Oa.center=1]="center",Oa[Oa.left=2]="left",Oa[Oa.right=3]="right",Oa[Oa.top=4]="top",Oa[Oa.bottom=5]="bottom",Oa[Oa["top-left"]=6]="top-left",Oa[Oa["top-right"]=7]="top-right",Oa[Oa["bottom-left"]=8]="bottom-left",Oa[Oa["bottom-right"]=9]="bottom-right";const rp=Number.POSITIVE_INFINITY;function Df(h,o){return o[1]!==rp?function(c,g,x){let T=0,A=0;switch(g=Math.abs(g),x=Math.abs(x),c){case"top-right":case"top-left":case"top":A=x-7;break;case"bottom-right":case"bottom-left":case"bottom":A=7-x}switch(c){case"top-right":case"bottom-right":case"right":T=-g;break;case"top-left":case"bottom-left":case"left":T=g}return[T,A]}(h,o[0],o[1]):function(c,g){let x=0,T=0;g<0&&(g=0);const A=g/Math.SQRT2;switch(c){case"top-right":case"top-left":T=A-7;break;case"bottom-right":case"bottom-left":T=7-A;break;case"bottom":T=7-g;break;case"top":T=g-7}switch(c){case"top-right":case"bottom-right":x=-A;break;case"top-left":case"bottom-left":x=A;break;case"left":x=g;break;case"right":x=-g}return[x,T]}(h,o[0])}function gm(h,o,c){var g;const x=h.layout,T=(g=x.get("text-variable-anchor-offset"))===null||g===void 0?void 0:g.evaluate(o,{},c);if(T){const z=T.values,B=[];for(let G=0;G<z.length;G+=2){const W=B[G]=z[G],K=z[G+1].map(ot=>ot*mo);W.startsWith("top")?K[1]-=7:W.startsWith("bottom")&&(K[1]+=7),B[G+1]=K}return new Is(B)}const A=x.get("text-variable-anchor");if(A){let z;z=h._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[x.get("text-radial-offset").evaluate(o,{},c)*mo,rp]:x.get("text-offset").evaluate(o,{},c).map(G=>G*mo);const B=[];for(const G of A)B.push(G,Df(G,z));return new Is(B)}return null}function Qm(h){switch(h){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function qg(h,o,c,g,x,T,A,z,B,G,W,K){let ot=T.textMaxSize.evaluate(o,{});ot===void 0&&(ot=A);const ct=h.layers[0].layout,dt=ct.get("icon-offset").evaluate(o,{},W),xt=_m(c.horizontal),At=A/24,jt=h.tilePixelRatio*At,ue=h.tilePixelRatio*ot/24,Qt=h.tilePixelRatio*z,ie=h.tilePixelRatio*ct.get("symbol-spacing"),Se=ct.get("text-padding")*h.tilePixelRatio,Ee=function(Pr,Mr,ur,Sn=1){const is=Pr.get("icon-padding").evaluate(Mr,{},ur),xs=is&&is.values;return[xs[0]*Sn,xs[1]*Sn,xs[2]*Sn,xs[3]*Sn]}(ct,o,W,h.tilePixelRatio),ei=ct.get("text-max-angle")/180*Math.PI,Ai=ct.get("text-rotation-alignment")!=="viewport"&&ct.get("symbol-placement")!=="point",mi=ct.get("icon-rotation-alignment")==="map"&&ct.get("symbol-placement")!=="point",Ei=ct.get("symbol-placement"),Hi=ie/2,Ui=ct.get("icon-text-fit");let ji;g&&Ui!=="none"&&(h.allowVerticalPlacement&&c.vertical&&(ji=b_(g,c.vertical,Ui,ct.get("icon-text-fit-padding"),dt,At)),xt&&(g=b_(g,xt,Ui,ct.get("icon-text-fit-padding"),dt,At)));const gi=W?K.line.getGranularityForZoomLevel(W.z):1,Ar=(Pr,Mr)=>{Mr.x<0||Mr.x>=Ln||Mr.y<0||Mr.y>=Ln||function(ur,Sn,is,xs,yl,Gc,Ja,Sa,Vs,vs,Ka,xl,Bl,Ic,vl,Ol,ru,Ia,bs,Xs,Ps,Na,Td,zu,ng){const Yp=ur.addToLineVertexArray(Sn,is);let Rf,xm,kf,np,f0=0,iy=0,Wg=0,ry=0,ny=-1,Xg=-1;const Sd={};let m0=vr("");if(ur.allowVerticalPlacement&&xs.vertical){const bl=Sa.layout.get("text-rotate").evaluate(Ps,{},zu)+90;kf=new Km(Vs,Sn,vs,Ka,xl,xs.vertical,Bl,Ic,vl,bl),Ja&&(np=new Km(Vs,Sn,vs,Ka,xl,Ja,ru,Ia,vl,bl))}if(yl){const bl=Sa.layout.get("icon-rotate").evaluate(Ps,{}),$c=Sa.layout.get("icon-text-fit")!=="none",Jp=K_(yl,bl,Td,$c),nu=Ja?K_(Ja,bl,Td,$c):void 0;xm=new Km(Vs,Sn,vs,Ka,xl,yl,ru,Ia,!1,bl),f0=4*Jp.length;const Kp=ur.iconSizeData;let ou=null;Kp.kind==="source"?(ou=[Qh*Sa.layout.get("icon-size").evaluate(Ps,{})],ou[0]>gd&&vo(`${ur.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Kp.kind==="composite"&&(ou=[Qh*Na.compositeIconSizes[0].evaluate(Ps,{},zu),Qh*Na.compositeIconSizes[1].evaluate(Ps,{},zu)],(ou[0]>gd||ou[1]>gd)&&vo(`${ur.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),ur.addSymbols(ur.icon,Jp,ou,Xs,bs,Ps,it.ay.none,Sn,Yp.lineStartIndex,Yp.lineLength,-1,zu),ny=ur.icon.placedSymbolArray.length-1,nu&&(iy=4*nu.length,ur.addSymbols(ur.icon,nu,ou,Xs,bs,Ps,it.ay.vertical,Sn,Yp.lineStartIndex,Yp.lineLength,-1,zu),Xg=ur.icon.placedSymbolArray.length-1)}const g0=Object.keys(xs.horizontal);for(const bl of g0){const $c=xs.horizontal[bl];if(!Rf){m0=vr($c.text);const nu=Sa.layout.get("text-rotate").evaluate(Ps,{},zu);Rf=new Km(Vs,Sn,vs,Ka,xl,$c,Bl,Ic,vl,nu)}const Jp=$c.positionedLines.length===1;if(Wg+=d0(ur,Sn,$c,Gc,Sa,vl,Ps,Ol,Yp,xs.vertical?it.ay.horizontal:it.ay.horizontalOnly,Jp?g0:[bl],Sd,ny,Na,zu),Jp)break}xs.vertical&&(ry+=d0(ur,Sn,xs.vertical,Gc,Sa,vl,Ps,Ol,Yp,it.ay.vertical,["vertical"],Sd,Xg,Na,zu));const ux=Rf?Rf.boxStartIndex:ur.collisionBoxArray.length,dx=Rf?Rf.boxEndIndex:ur.collisionBoxArray.length,px=kf?kf.boxStartIndex:ur.collisionBoxArray.length,fx=kf?kf.boxEndIndex:ur.collisionBoxArray.length,mx=xm?xm.boxStartIndex:ur.collisionBoxArray.length,_0=xm?xm.boxEndIndex:ur.collisionBoxArray.length,gx=np?np.boxStartIndex:ur.collisionBoxArray.length,_x=np?np.boxEndIndex:ur.collisionBoxArray.length;let Lu=-1;const vm=(bl,$c)=>bl&&bl.circleDiameter?Math.max(bl.circleDiameter,$c):$c;Lu=vm(Rf,Lu),Lu=vm(kf,Lu),Lu=vm(xm,Lu),Lu=vm(np,Lu);const Yg=Lu>-1?1:0;Yg&&(Lu*=ng/mo),ur.glyphOffsetArray.length>=rm.MAX_GLYPHS&&vo("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Ps.sortKey!==void 0&&ur.addToSortKeyRanges(ur.symbolInstances.length,Ps.sortKey);const y0=gm(Sa,Ps,zu),[x0,v0]=function(bl,$c){const Jp=bl.length,nu=$c?.values;if(nu?.length>0)for(let Kp=0;Kp<nu.length;Kp+=2){const ou=nu[Kp+1];bl.emplaceBack(it.aO[nu[Kp]],ou[0],ou[1])}return[Jp,bl.length]}(ur.textAnchorOffsets,y0);ur.symbolInstances.emplaceBack(Sn.x,Sn.y,Sd.right>=0?Sd.right:-1,Sd.center>=0?Sd.center:-1,Sd.left>=0?Sd.left:-1,Sd.vertical||-1,ny,Xg,m0,ux,dx,px,fx,mx,_0,gx,_x,vs,Wg,ry,f0,iy,Yg,0,Bl,Lu,x0,v0)}(h,Mr,Pr,c,g,x,ji,h.layers[0],h.collisionBoxArray,o.index,o.sourceLayerIndex,h.index,jt,[Se,Se,Se,Se],Ai,B,Qt,Ee,mi,dt,o,T,G,W,A)};if(Ei==="line")for(const Pr of Z_(o.geometry,0,0,Ln,Ln)){const Mr=_t(Pr,gi),ur=$g(Mr,ie,ei,c.vertical||xt,g,24,ue,h.overscaling,Ln);for(const Sn of ur)xt&&ty(h,xt.text,Hi,Sn)||Ar(Mr,Sn)}else if(Ei==="line-center"){for(const Pr of o.geometry)if(Pr.length>1){const Mr=_t(Pr,gi),ur=c0(Mr,ei,c.vertical||xt,g,24,ue);ur&&Ar(Mr,ur)}}else if(o.type==="Polygon")for(const Pr of th(o.geometry,0)){const Mr=hx(Pr,16);Ar(_t(Pr[0],gi,!0),new ip(Mr.x,Mr.y,0))}else if(o.type==="LineString")for(const Pr of o.geometry){const Mr=_t(Pr,gi);Ar(Mr,new ip(Mr[0].x,Mr[0].y,0))}else if(o.type==="Point")for(const Pr of o.geometry)for(const Mr of Pr)Ar([Mr],new ip(Mr.x,Mr.y,0))}function d0(h,o,c,g,x,T,A,z,B,G,W,K,ot,ct,dt){const xt=function(ue,Qt,ie,Se,Ee,ei,Ai,mi){const Ei=Se.layout.get("text-rotate").evaluate(ei,{})*Math.PI/180,Hi=[];for(const Ui of Qt.positionedLines)for(const ji of Ui.positionedGlyphs){if(!ji.rect)continue;const gi=ji.rect||{};let Ar=4,Pr=!0,Mr=1,ur=0;const Sn=(Ee||mi)&&ji.vertical,is=ji.metrics.advance*ji.scale/2;if(mi&&Qt.verticalizable&&(ur=Ui.lineOffset/2-(ji.imageName?-(mo-ji.metrics.width*ji.scale)/2:(ji.scale-1)*mo)),ji.imageName){const Ia=Ai[ji.imageName];Pr=Ia.sdf,Mr=Ia.pixelRatio,Ar=1/Mr}const xs=Ee?[ji.x+is,ji.y]:[0,0];let yl=Ee?[0,0]:[ji.x+is+ie[0],ji.y+ie[1]-ur],Gc=[0,0];Sn&&(Gc=yl,yl=[0,0]);const Ja=ji.metrics.isDoubleResolution?2:1,Sa=(ji.metrics.left-Ar)*ji.scale-is+yl[0],Vs=(-ji.metrics.top-Ar)*ji.scale+yl[1],vs=Sa+gi.w/Ja*ji.scale/Mr,Ka=Vs+gi.h/Ja*ji.scale/Mr,xl=new Pe(Sa,Vs),Bl=new Pe(vs,Vs),Ic=new Pe(Sa,Ka),vl=new Pe(vs,Ka);if(Sn){const Ia=new Pe(-is,is- -17),bs=-Math.PI/2,Xs=12-is,Ps=new Pe(22-Xs,-(ji.imageName?Xs:0)),Na=new Pe(...Gc);xl._rotateAround(bs,Ia)._add(Ps)._add(Na),Bl._rotateAround(bs,Ia)._add(Ps)._add(Na),Ic._rotateAround(bs,Ia)._add(Ps)._add(Na),vl._rotateAround(bs,Ia)._add(Ps)._add(Na)}if(Ei){const Ia=Math.sin(Ei),bs=Math.cos(Ei),Xs=[bs,-Ia,Ia,bs];xl._matMult(Xs),Bl._matMult(Xs),Ic._matMult(Xs),vl._matMult(Xs)}const Ol=new Pe(0,0),ru=new Pe(0,0);Hi.push({tl:xl,tr:Bl,bl:Ic,br:vl,tex:gi,writingMode:Qt.writingMode,glyphOffset:xs,sectionIndex:ji.sectionIndex,isSDF:Pr,pixelOffsetTL:Ol,pixelOffsetBR:ru,minFontScaleX:0,minFontScaleY:0})}return Hi}(0,c,z,x,T,A,g,h.allowVerticalPlacement),At=h.textSizeData;let jt=null;At.kind==="source"?(jt=[Qh*x.layout.get("text-size").evaluate(A,{})],jt[0]>gd&&vo(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):At.kind==="composite"&&(jt=[Qh*ct.compositeTextSizes[0].evaluate(A,{},dt),Qh*ct.compositeTextSizes[1].evaluate(A,{},dt)],(jt[0]>gd||jt[1]>gd)&&vo(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),h.addSymbols(h.text,xt,jt,z,T,A,G,o,B.lineStartIndex,B.lineLength,ot,dt);for(const ue of W)K[ue]=h.text.placedSymbolArray.length-1;return 4*xt.length}function _m(h){for(const o in h)return h[o];return null}function ty(h,o,c,g){const x=h.compareText;if(o in x){const T=x[o];for(let A=T.length-1;A>=0;A--)if(g.dist(T[A])<c)return!0}else x[o]=[];return x[o].push(g),!1}const iu=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Xp{static from(o){if(!(o instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[c,g]=new Uint8Array(o,0,2);if(c!==219)throw new Error("Data does not appear to be in a KDBush format.");const x=g>>4;if(x!==1)throw new Error(`Got v${x} data when expected v1.`);const T=iu[15&g];if(!T)throw new Error("Unrecognized array type.");const[A]=new Uint16Array(o,2,1),[z]=new Uint32Array(o,4,1);return new Xp(z,A,T,o)}constructor(o,c=64,g=Float64Array,x){if(isNaN(o)||o<0)throw new Error(`Unpexpected numItems value: ${o}.`);this.numItems=+o,this.nodeSize=Math.min(Math.max(+c,2),65535),this.ArrayType=g,this.IndexArrayType=o<65536?Uint16Array:Uint32Array;const T=iu.indexOf(this.ArrayType),A=2*o*this.ArrayType.BYTES_PER_ELEMENT,z=o*this.IndexArrayType.BYTES_PER_ELEMENT,B=(8-z%8)%8;if(T<0)throw new Error(`Unexpected typed array class: ${g}.`);x&&x instanceof ArrayBuffer?(this.data=x,this.ids=new this.IndexArrayType(this.data,8,o),this.coords=new this.ArrayType(this.data,8+z+B,2*o),this._pos=2*o,this._finished=!0):(this.data=new ArrayBuffer(8+A+z+B),this.ids=new this.IndexArrayType(this.data,8,o),this.coords=new this.ArrayType(this.data,8+z+B,2*o),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+T]),new Uint16Array(this.data,2,1)[0]=c,new Uint32Array(this.data,4,1)[0]=o)}add(o,c){const g=this._pos>>1;return this.ids[g]=g,this.coords[this._pos++]=o,this.coords[this._pos++]=c,g}finish(){const o=this._pos>>1;if(o!==this.numItems)throw new Error(`Added ${o} items when expected ${this.numItems}.`);return tg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(o,c,g,x){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:T,coords:A,nodeSize:z}=this,B=[0,T.length-1,0],G=[];for(;B.length;){const W=B.pop()||0,K=B.pop()||0,ot=B.pop()||0;if(K-ot<=z){for(let At=ot;At<=K;At++){const jt=A[2*At],ue=A[2*At+1];jt>=o&&jt<=g&&ue>=c&&ue<=x&&G.push(T[At])}continue}const ct=ot+K>>1,dt=A[2*ct],xt=A[2*ct+1];dt>=o&&dt<=g&&xt>=c&&xt<=x&&G.push(T[ct]),(W===0?o<=dt:c<=xt)&&(B.push(ot),B.push(ct-1),B.push(1-W)),(W===0?g>=dt:x>=xt)&&(B.push(ct+1),B.push(K),B.push(1-W))}return G}within(o,c,g){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:x,coords:T,nodeSize:A}=this,z=[0,x.length-1,0],B=[],G=g*g;for(;z.length;){const W=z.pop()||0,K=z.pop()||0,ot=z.pop()||0;if(K-ot<=A){for(let At=ot;At<=K;At++)eg(T[2*At],T[2*At+1],o,c)<=G&&B.push(x[At]);continue}const ct=ot+K>>1,dt=T[2*ct],xt=T[2*ct+1];eg(dt,xt,o,c)<=G&&B.push(x[ct]),(W===0?o-g<=dt:c-g<=xt)&&(z.push(ot),z.push(ct-1),z.push(1-W)),(W===0?o+g>=dt:c+g>=xt)&&(z.push(ct+1),z.push(K),z.push(1-W))}return B}}function tg(h,o,c,g,x,T){if(x-g<=c)return;const A=g+x>>1;zf(h,o,A,g,x,T),tg(h,o,c,g,A-1,1-T),tg(h,o,c,A+1,x,1-T)}function zf(h,o,c,g,x,T){for(;x>g;){if(x-g>600){const G=x-g+1,W=c-g+1,K=Math.log(G),ot=.5*Math.exp(2*K/3),ct=.5*Math.sqrt(K*ot*(G-ot)/G)*(W-G/2<0?-1:1);zf(h,o,c,Math.max(g,Math.floor(c-W*ot/G+ct)),Math.min(x,Math.floor(c+(G-W)*ot/G+ct)),T)}const A=o[2*c+T];let z=g,B=x;for(wd(h,o,g,c),o[2*x+T]>A&&wd(h,o,g,x);z<B;){for(wd(h,o,z,B),z++,B--;o[2*z+T]<A;)z++;for(;o[2*B+T]>A;)B--}o[2*g+T]===A?wd(h,o,g,B):(B++,wd(h,o,B,x)),B<=c&&(g=B+1),c<=B&&(x=B-1)}}function wd(h,o,c,g){Zg(h,c,g),Zg(o,2*c,2*g),Zg(o,2*c+1,2*g+1)}function Zg(h,o,c){const g=h[o];h[o]=h[c],h[c]=g}function eg(h,o,c,g){const x=h-c,T=o-g;return x*x+T*T}var Hg;it.cG=void 0,(Hg=it.cG||(it.cG={})).create="create",Hg.load="load",Hg.fullLoad="fullLoad";let ig=null,rg=[];const ym=1e3/60,ey="loadTime",Lf="fullLoadTime",p0={mark(h){performance.mark(h)},frame(h){const o=h;ig!=null&&rg.push(o-ig),ig=o},clearMetrics(){ig=null,rg=[],performance.clearMeasures(ey),performance.clearMeasures(Lf);for(const h in it.cG)performance.clearMarks(it.cG[h])},getPerformanceMetrics(){performance.measure(ey,it.cG.create,it.cG.load),performance.measure(Lf,it.cG.create,it.cG.fullLoad);const h=performance.getEntriesByName(ey)[0].duration,o=performance.getEntriesByName(Lf)[0].duration,c=rg.length,g=1/(rg.reduce((T,A)=>T+A,0)/c/1e3),x=rg.filter(T=>T>ym).reduce((T,A)=>T+(A-ym)/ym,0);return{loadTime:h,fullLoadTime:o,fps:g,percentDroppedFrames:x/(c+x)*100,totalFrames:c}}};it.$=Io,it.A=Yr,it.B=xu,it.C=oh,it.D=xr,it.E=Re,it.F=function([h,o,c]){return o+=90,o*=Math.PI/180,c*=Math.PI/180,{x:h*Math.cos(o)*Math.sin(c),y:h*Math.sin(o)*Math.sin(c),z:h*Math.cos(c)}},it.G=Za,it.H=uo,it.I=im,it.J=wp,it.K=function(h){if(lo==null){const o=h.navigator?h.navigator.userAgent:null;lo=!!h.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return lo},it.L=class{constructor(h,o){this.target=h,this.mapId=o,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new Vy(()=>this.process()),this.subscription=Gl(this.target,"message",c=>this.receive(c),!1),this.globalScope=Ds(self)?h:window}registerMessageHandler(h,o){this.messageHandlers[h]=o}unregisterMessageHandler(h){delete this.messageHandlers[h]}sendAsync(h,o){return new Promise((c,g)=>{const x=Math.round(1e18*Math.random()).toString(36).substring(0,10),T=o?Gl(o.signal,"abort",()=>{T?.unsubscribe(),delete this.resolveRejects[x];const B={id:x,type:"<cancel>",origin:location.origin,targetMapId:h.targetMapId,sourceMapId:this.mapId};this.target.postMessage(B)},Uy):null;this.resolveRejects[x]={resolve:B=>{T?.unsubscribe(),c(B)},reject:B=>{T?.unsubscribe(),g(B)}};const A=[],z=Object.assign(Object.assign({},h),{id:x,sourceMapId:this.mapId,origin:location.origin,data:jd(h.data,A)});this.target.postMessage(z,{transfer:A})})}receive(h){const o=h.data,c=o.id;if(!(o.origin!=="file://"&&location.origin!=="file://"&&o.origin!=="resource://android"&&location.origin!=="resource://android"&&o.origin!==location.origin||o.targetMapId&&this.mapId!==o.targetMapId)){if(o.type==="<cancel>"){delete this.tasks[c];const g=this.abortControllers[c];return delete this.abortControllers[c],void(g&&g.abort())}if(Ds(self)||o.mustQueue)return this.tasks[c]=o,this.taskQueue.push(c),void this.invoker.trigger();this.processTask(c,o)}}process(){if(this.taskQueue.length===0)return;const h=this.taskQueue.shift(),o=this.tasks[h];delete this.tasks[h],this.taskQueue.length>0&&this.invoker.trigger(),o&&this.processTask(h,o)}processTask(h,o){return i(this,void 0,void 0,function*(){if(o.type==="<response>"){const x=this.resolveRejects[h];return delete this.resolveRejects[h],x?void(o.error?x.reject(sh(o.error)):x.resolve(sh(o.data))):void 0}if(!this.messageHandlers[o.type])return void this.completeTask(h,new Error(`Could not find a registered handler for ${o.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const c=sh(o.data),g=new AbortController;this.abortControllers[h]=g;try{const x=yield this.messageHandlers[o.type](o.sourceMapId,c,g);this.completeTask(h,null,x)}catch(x){this.completeTask(h,x)}})}completeTask(h,o,c){const g=[];delete this.abortControllers[h];const x={id:h,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:o?jd(o):null,data:jd(c,g)};this.target.postMessage(x,{transfer:g})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},it.M=$l,it.N=function(){var h=new Yr(16);return Yr!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0),h[0]=1,h[5]=1,h[10]=1,h[15]=1,h},it.O=function(h,o,c){var g,x,T,A,z,B,G,W,K,ot,ct,dt,xt=c[0],At=c[1],jt=c[2];return o===h?(h[12]=o[0]*xt+o[4]*At+o[8]*jt+o[12],h[13]=o[1]*xt+o[5]*At+o[9]*jt+o[13],h[14]=o[2]*xt+o[6]*At+o[10]*jt+o[14],h[15]=o[3]*xt+o[7]*At+o[11]*jt+o[15]):(x=o[1],T=o[2],A=o[3],z=o[4],B=o[5],G=o[6],W=o[7],K=o[8],ot=o[9],ct=o[10],dt=o[11],h[0]=g=o[0],h[1]=x,h[2]=T,h[3]=A,h[4]=z,h[5]=B,h[6]=G,h[7]=W,h[8]=K,h[9]=ot,h[10]=ct,h[11]=dt,h[12]=g*xt+z*At+K*jt+o[12],h[13]=x*xt+B*At+ot*jt+o[13],h[14]=T*xt+G*At+ct*jt+o[14],h[15]=A*xt+W*At+dt*jt+o[15]),h},it.P=Pe,it.Q=function(h,o,c){var g=c[0],x=c[1],T=c[2];return h[0]=o[0]*g,h[1]=o[1]*g,h[2]=o[2]*g,h[3]=o[3]*g,h[4]=o[4]*x,h[5]=o[5]*x,h[6]=o[6]*x,h[7]=o[7]*x,h[8]=o[8]*T,h[9]=o[9]*T,h[10]=o[10]*T,h[11]=o[11]*T,h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15],h},it.R=ba,it.S=function(h,o,c){var g=o[0],x=o[1],T=o[2],A=o[3],z=o[4],B=o[5],G=o[6],W=o[7],K=o[8],ot=o[9],ct=o[10],dt=o[11],xt=o[12],At=o[13],jt=o[14],ue=o[15],Qt=c[0],ie=c[1],Se=c[2],Ee=c[3];return h[0]=Qt*g+ie*z+Se*K+Ee*xt,h[1]=Qt*x+ie*B+Se*ot+Ee*At,h[2]=Qt*T+ie*G+Se*ct+Ee*jt,h[3]=Qt*A+ie*W+Se*dt+Ee*ue,h[4]=(Qt=c[4])*g+(ie=c[5])*z+(Se=c[6])*K+(Ee=c[7])*xt,h[5]=Qt*x+ie*B+Se*ot+Ee*At,h[6]=Qt*T+ie*G+Se*ct+Ee*jt,h[7]=Qt*A+ie*W+Se*dt+Ee*ue,h[8]=(Qt=c[8])*g+(ie=c[9])*z+(Se=c[10])*K+(Ee=c[11])*xt,h[9]=Qt*x+ie*B+Se*ot+Ee*At,h[10]=Qt*T+ie*G+Se*ct+Ee*jt,h[11]=Qt*A+ie*W+Se*dt+Ee*ue,h[12]=(Qt=c[12])*g+(ie=c[13])*z+(Se=c[14])*K+(Ee=c[15])*xt,h[13]=Qt*x+ie*B+Se*ot+Ee*At,h[14]=Qt*T+ie*G+Se*ct+Ee*jt,h[15]=Qt*A+ie*W+Se*dt+Ee*ue,h},it.T=Tf,it.U=function(h,o){const c={};for(let g=0;g<o.length;g++){const x=o[g];x in h&&(c[x]=h[x])}return c},it.V=Kd,it.W=ja,it.X=Ta,it.Y=Qd,it.Z=Ve,it._=i,it.a=rl,it.a$=fa,it.a0=jl,it.a1=Xa,it.a2=nm,it.a3=zg,it.a4=Ln,it.a5=function(h,o,c){if(!h)return o||{};if(!o)return h||{};const g=$y(h),x=$y(o);(function(A,z){z.removeAll&&(A.add.clear(),A.update.clear(),A.remove.clear(),z.remove.clear());for(const B of z.remove)A.add.delete(B),A.update.delete(B);for(const[B,G]of z.update){const W=A.update.get(B);W&&(z.update.set(B,rx(W,G)),A.update.delete(B))}})(g,x);const T={};if((g.removeAll||x.removeAll)&&(T.removeAll=!0),T.remove=new Set([...g.remove,...x.remove]),T.add=new Map([...g.add,...x.add]),T.update=new Map([...g.update,...x.update]),T.remove.size&&T.add.size)for(const A of T.add.keys())T.remove.delete(A);return function(A){const z={};return A.removeAll&&(z.removeAll=A.removeAll),A.remove&&(z.remove=Array.from(A.remove)),A.add&&(z.add=Array.from(A.add.values())),A.update&&(z.update=Array.from(A.update.values())),z}(T)},it.a6=function(h,o){if(h==null)return!0;if(h.type==="Feature")return Zm(h,o)!=null;if(h.type==="FeatureCollection"){const c=new Set;for(const g of h.features){const x=Zm(g,o);if(x==null||c.has(x))return!1;c.add(x)}return!0}return!1},it.a7=function(h,o){const c=new Map;if(h!=null)if(h.type==="Feature")c.set(Zm(h,o),h);else for(const g of h.features)c.set(Zm(g,o),g);return c},it.a8=function(h,o,c){var g,x;if(o.removeAll)h.clear();else if(o.remove)for(const T of o.remove)h.delete(T);if(o.add)for(const T of o.add){const A=Zm(T,c);A!=null&&h.set(A,T)}if(o.update)for(const T of o.update){let A=h.get(T.id);if(!A)continue;const z=!!T.newGeometry,B=T.removeAllProperties||((g=T.removeProperties)===null||g===void 0?void 0:g.length)>0||((x=T.addOrUpdateProperties)===null||x===void 0?void 0:x.length)>0;if((z||B)&&(A=Object.assign({},A),h.set(T.id,A),z&&(A.geometry=T.newGeometry),B)){if(A.properties=T.removeAllProperties?{}:Object.assign({},A.properties||{}),T.removeProperties)for(const G of T.removeProperties)delete A.properties[G];if(T.addOrUpdateProperties)for(const{key:G,value:W}of T.addOrUpdateProperties)A.properties[G]=W}}},it.a9=Gg,it.aA=function(h,o){var c=o[0],g=o[1],x=o[2],T=o[3],A=o[4],z=o[5],B=o[6],G=o[7],W=o[8],K=o[9],ot=o[10],ct=o[11],dt=o[12],xt=o[13],At=o[14],jt=o[15],ue=c*z-g*A,Qt=c*B-x*A,ie=c*G-T*A,Se=g*B-x*z,Ee=g*G-T*z,ei=x*G-T*B,Ai=W*xt-K*dt,mi=W*At-ot*dt,Ei=W*jt-ct*dt,Hi=K*At-ot*xt,Ui=K*jt-ct*xt,ji=ot*jt-ct*At,gi=ue*ji-Qt*Ui+ie*Hi+Se*Ei-Ee*mi+ei*Ai;return gi?(h[0]=(z*ji-B*Ui+G*Hi)*(gi=1/gi),h[1]=(x*Ui-g*ji-T*Hi)*gi,h[2]=(xt*ei-At*Ee+jt*Se)*gi,h[3]=(ot*Ee-K*ei-ct*Se)*gi,h[4]=(B*Ei-A*ji-G*mi)*gi,h[5]=(c*ji-x*Ei+T*mi)*gi,h[6]=(At*ie-dt*ei-jt*Qt)*gi,h[7]=(W*ei-ot*ie+ct*Qt)*gi,h[8]=(A*Ui-z*Ei+G*Ai)*gi,h[9]=(g*Ei-c*Ui-T*Ai)*gi,h[10]=(dt*Ee-xt*ie+jt*ue)*gi,h[11]=(K*ie-W*Ee-ct*ue)*gi,h[12]=(z*mi-A*Hi-B*Ai)*gi,h[13]=(c*Hi-g*mi+x*Ai)*gi,h[14]=(xt*Qt-dt*Se-At*ue)*gi,h[15]=(W*Se-K*Qt+ot*ue)*gi,h):null},it.aB=dn,it.aC=function(h){var o=h[0],c=h[1];return Math.sqrt(o*o+c*c)},it.aD=function(h){return h[0]=0,h[1]=0,h},it.aE=function(h,o,c){return h[0]=o[0]*c,h[1]=o[1]*c,h},it.aF=Ag,it.aG=bh,it.aH=function(h,o,c,g){const x=o.y-h.y,T=o.x-h.x,A=g.y-c.y,z=g.x-c.x,B=A*T-z*x;if(B===0)return null;const G=(z*(h.y-c.y)-A*(h.x-c.x))/B;return new Pe(h.x+G*T,h.y+G*x)},it.aI=Z_,it.aJ=Dp,it.aK=function(h){let o=1/0,c=1/0,g=-1/0,x=-1/0;for(const T of h)o=Math.min(o,T.x),c=Math.min(c,T.y),g=Math.max(g,T.x),x=Math.max(x,T.y);return[o,c,g,x]},it.aL=mo,it.aM=Ea,it.aN=function(h,o,c,g,x=!1){if(!c[0]&&!c[1])return[0,0];const T=x?g==="map"?-h.bearingInRadians:0:g==="viewport"?h.bearingInRadians:0;if(T){const A=Math.sin(T),z=Math.cos(T);c=[c[0]*z-c[1]*A,c[0]*A+c[1]*z]}return[x?c[0]:Ea(o,c[0],h.zoom),x?c[1]:Ea(o,c[1],h.zoom)]},it.aP=Eg,it.aQ=Qm,it.aR=Um,it.aS=Xp,it.aT=Go,it.aU=X,it.aV=Xt,it.aW=Nr,it.aX=Fi,it.aY=Ss,it.aZ=jy,it.a_=Nl,it.aa=qm,it.ab=vd,it.ac=25,it.ad=jp,it.ae=h=>{const o=window.document.createElement("video");return o.muted=!0,new Promise(c=>{o.onloadstart=()=>{c(o)};for(const g of h){const x=window.document.createElement("source");It(g)||(o.crossOrigin="Anonymous"),x.src=g,o.appendChild(x)}})},it.af=bi,it.ag=function(){return bn++},it.ah=k,it.ai=rm,it.aj=Rd,it.ak=gc,it.al=Zy,it.am=function(h){const o={};if(h.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(c,g,x,T)=>{const A=x||T;return o[g]=!A||A.toLowerCase(),""}),o["max-age"]){const c=parseInt(o["max-age"],10);isNaN(c)?delete o["max-age"]:o["max-age"]=c}return o},it.an=Qs,it.ao=85.051129,it.ap=ds,it.aq=function(h){return Math.pow(2,h)},it.ar=us,it.as=E_,it.at=function(h){return Math.log(h)/Math.LN2},it.au=function(h){var o=h[0],c=h[1];return o*o+c*c},it.av=class{constructor(h,o){this.max=h,this.onRemove=o,this.reset()}reset(){for(const h in this.data)for(const o of this.data[h])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(h,o,c){const g=h.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);const x={value:o,timeout:void 0};if(c!==void 0&&(x.timeout=setTimeout(()=>{this.remove(h,x)},c)),this.data[g].push(x),this.order.push(g),this.order.length>this.max){const T=this._getAndRemoveByKey(this.order[0]);T&&this.onRemove(T)}return this}has(h){return h.wrapped().key in this.data}getAndRemove(h){return this.has(h)?this._getAndRemoveByKey(h.wrapped().key):null}_getAndRemoveByKey(h){const o=this.data[h].shift();return o.timeout&&clearTimeout(o.timeout),this.data[h].length===0&&delete this.data[h],this.order.splice(this.order.indexOf(h),1),o.value}getByKey(h){const o=this.data[h];return o?o[0].value:null}get(h){return this.has(h)?this.data[h.wrapped().key][0].value:null}remove(h,o){if(!this.has(h))return this;const c=h.wrapped().key,g=o===void 0?0:this.data[c].indexOf(o),x=this.data[c][g];return this.data[c].splice(g,1),x.timeout&&clearTimeout(x.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(x.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(h){for(this.max=h;this.order.length>this.max;){const o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(h){const o=[];for(const c in this.data)for(const g of this.data[c])h(g.value)||o.push(g);for(const c of o)this.remove(c.value.tileID,c)}},it.aw=function(h){if(!h.length)return new Set;const o=Math.max(...h.map(B=>B.canonical.z));let c=1/0,g=-1/0,x=1/0,T=-1/0;const A=[];for(const B of h){const{x:G,y:W,z:K}=B.canonical,ot=Math.pow(2,o-K),ct=G*ot,dt=W*ot;A.push({id:B,x:ct,y:dt}),ct<c&&(c=ct),ct>g&&(g=ct),dt<x&&(x=dt),dt>T&&(T=dt)}const z=new Set;for(const B of A)B.x!==c&&B.x!==g&&B.y!==x&&B.y!==T||z.add(B.id);return z},it.ax=function(h,o){let c=0,g=0;if(h.kind==="constant")g=h.layoutSize;else if(h.kind!=="source"){const{interpolationType:x,minZoom:T,maxZoom:A}=h,z=x?Qs(na.interpolationFactor(x,o,T,A),0,1):0;h.kind==="camera"?g=Za.number(h.minSize,h.maxSize,z):c=z}return{uSizeT:c,uSize:g}},it.az=function(h,{uSize:o,uSizeT:c},{lowerSize:g,upperSize:x}){return h.kind==="source"?g/Qh:h.kind==="composite"?Za.number(g/Qh,x/Qh,c):o},it.b=Zn,it.b$=class extends Fs{constructor(h,o){super(h,o),this.current=Uc}set(h){if(h[12]!==this.current[12]||h[0]!==this.current[0])return this.current=h,void this.gl.uniformMatrix4fv(this.location,!1,h);for(let o=1;o<16;o++)if(h[o]!==this.current[o]){this.current=h,this.gl.uniformMatrix4fv(this.location,!1,h);break}}},it.b0=function(h){var o=new Yr(3);return o[0]=h[0],o[1]=h[1],o[2]=h[2],o},it.b1=function(h,o,c){return h[0]=o[0]-c[0],h[1]=o[1]-c[1],h[2]=o[2]-c[2],h},it.b2=function(h,o){var c=o[0],g=o[1],x=o[2],T=c*c+g*g+x*x;return T>0&&(T=1/Math.sqrt(T)),h[0]=o[0]*T,h[1]=o[1]*T,h[2]=o[2]*T,h},it.b3=nc,it.b4=function(h,o){return h[0]*o[0]+h[1]*o[1]+h[2]*o[2]},it.b5=function(h,o,c){return h[0]=o[0]*c[0],h[1]=o[1]*c[1],h[2]=o[2]*c[2],h[3]=o[3]*c[3],h},it.b6=Do,it.b7=function(h,o,c){const g=o[0]*c[0]+o[1]*c[1]+o[2]*c[2];return g===0?null:(-(h[0]*c[0]+h[1]*c[1]+h[2]*c[2])-c[3])/g},it.b8=Zr,it.b9=function(h,o,c){return h[0]=o[0]*c,h[1]=o[1]*c,h[2]=o[2]*c,h[3]=o[3]*c,h},it.bA=so,it.bB=function(h,o,c){var g=c[0],x=c[1],T=c[2],A=c[3],z=o[0],B=o[1],G=o[2],W=x*G-T*B,K=T*z-g*G,ot=g*B-x*z;return h[0]=z+A*(W+=W)+x*(ot+=ot)-T*(K+=K),h[1]=B+A*K+T*W-g*ot,h[2]=G+A*ot+g*K-x*W,h},it.bC=function(h,o,c){const g=(x=[h[0],h[1],h[2],o[0],o[1],o[2],c[0],c[1],c[2]])[0]*((W=x[8])*(A=x[4])-(z=x[5])*(G=x[7]))+x[1]*(-W*(T=x[3])+z*(B=x[6]))+x[2]*(G*T-A*B);var x,T,A,z,B,G,W;if(g===0)return null;const K=nc([],[o[0],o[1],o[2]],[c[0],c[1],c[2]]),ot=nc([],[c[0],c[1],c[2]],[h[0],h[1],h[2]]),ct=nc([],[h[0],h[1],h[2]],[o[0],o[1],o[2]]),dt=Nl([],K,-h[3]);return fa(dt,dt,Nl([],ot,-o[3])),fa(dt,dt,Nl([],ct,-c[3])),Nl(dt,dt,1/g),dt},it.bD=Cg,it.bE=function(){return new Float64Array(4)},it.bF=function(h,o,c,g){var x=[],T=[];return x[0]=o[0]-c[0],x[1]=o[1]-c[1],x[2]=o[2]-c[2],T[0]=x[0]*Math.cos(g)-x[1]*Math.sin(g),T[1]=x[0]*Math.sin(g)+x[1]*Math.cos(g),T[2]=x[2],h[0]=T[0]+c[0],h[1]=T[1]+c[1],h[2]=T[2]+c[2],h},it.bG=function(h,o,c,g){var x=[],T=[];return x[0]=o[0]-c[0],x[1]=o[1]-c[1],x[2]=o[2]-c[2],T[0]=x[0],T[1]=x[1]*Math.cos(g)-x[2]*Math.sin(g),T[2]=x[1]*Math.sin(g)+x[2]*Math.cos(g),h[0]=T[0]+c[0],h[1]=T[1]+c[1],h[2]=T[2]+c[2],h},it.bH=function(h,o,c,g){var x=[],T=[];return x[0]=o[0]-c[0],x[1]=o[1]-c[1],x[2]=o[2]-c[2],T[0]=x[2]*Math.sin(g)+x[0]*Math.cos(g),T[1]=x[1],T[2]=x[2]*Math.cos(g)-x[0]*Math.sin(g),h[0]=T[0]+c[0],h[1]=T[1]+c[1],h[2]=T[2]+c[2],h},it.bI=function(h,o,c){var g=Math.sin(c),x=Math.cos(c),T=o[0],A=o[1],z=o[2],B=o[3],G=o[8],W=o[9],K=o[10],ot=o[11];return o!==h&&(h[4]=o[4],h[5]=o[5],h[6]=o[6],h[7]=o[7],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15]),h[0]=T*x-G*g,h[1]=A*x-W*g,h[2]=z*x-K*g,h[3]=B*x-ot*g,h[8]=T*g+G*x,h[9]=A*g+W*x,h[10]=z*g+K*x,h[11]=B*g+ot*x,h},it.bJ=function(h,o){const c=js(h,360),g=js(o,360),x=g-c,T=g>c?x-360:x+360;return Math.abs(x)<Math.abs(T)?x:T},it.bK=function(h){return h[0]=0,h[1]=0,h[2]=0,h},it.bL=function(h,o,c,g){const x=Math.sqrt(h*h+o*o),T=Math.sqrt(c*c+g*g);h/=x,o/=x,c/=T,g/=T;const A=Math.acos(h*c+o*g);return-o*c+h*g>0?A:-A},it.bM=function(h,o){const c=js(h,2*Math.PI),g=js(o,2*Math.PI);return Math.min(Math.abs(c-g),Math.abs(c-g+2*Math.PI),Math.abs(c-g-2*Math.PI))},it.bN=function(){const h={},o=te.$version;for(const c in te.$root){const g=te.$root[c];if(g.required){let x=null;x=c==="version"?o:g.type==="array"?[]:{},x!=null&&(h[c]=x)}}return h},it.bO=Hn,it.bP=rd,it.bQ=function h(o,c){if(Array.isArray(o)){if(!Array.isArray(c)||o.length!==c.length)return!1;for(let g=0;g<o.length;g++)if(!h(o[g],c[g]))return!1;return!0}if(typeof o=="object"&&o!==null&&c!==null){if(typeof c!="object"||Object.keys(o).length!==Object.keys(c).length)return!1;for(const g in o)if(!h(o[g],c[g]))return!1;return!0}return o===c},it.bR=function(h){h=h.slice();const o=Object.create(null);for(let c=0;c<h.length;c++)o[h[c].id]=h[c];for(let c=0;c<h.length;c++)"ref"in h[c]&&(h[c]=We(h[c],o[h[c].ref]));return h},it.bS=function(h,o){if(h.type==="custom")return new Ny(h,o);switch(h.type){case"background":return new Oy(h,o);case"circle":return new f_(h,o);case"color-relief":return new m_(h,o);case"fill":return new Ht(h,o);case"fill-extrusion":return new Ii(h,o);case"heatmap":return new jc(h,o);case"hillshade":return new Jh(h,o);case"line":return new eo(h,o);case"raster":return new qd(h,o);case"symbol":return new $m(h,o)}},it.bT=h=>h.type==="raster",it.bU=ma,it.bV=function(h,o){if(!h)return[{command:"setStyle",args:[o]}];let c=[];try{if(!ci(h.version,o.version))return[{command:"setStyle",args:[o]}];ci(h.center,o.center)||c.push({command:"setCenter",args:[o.center]}),ci(h.state,o.state)||c.push({command:"setGlobalState",args:[o.state]}),ci(h.centerAltitude,o.centerAltitude)||c.push({command:"setCenterAltitude",args:[o.centerAltitude]}),ci(h.zoom,o.zoom)||c.push({command:"setZoom",args:[o.zoom]}),ci(h.bearing,o.bearing)||c.push({command:"setBearing",args:[o.bearing]}),ci(h.pitch,o.pitch)||c.push({command:"setPitch",args:[o.pitch]}),ci(h.roll,o.roll)||c.push({command:"setRoll",args:[o.roll]}),ci(h.sprite,o.sprite)||c.push({command:"setSprite",args:[o.sprite]}),ci(h.glyphs,o.glyphs)||c.push({command:"setGlyphs",args:[o.glyphs]}),ci(h.transition,o.transition)||c.push({command:"setTransition",args:[o.transition]}),ci(h.light,o.light)||c.push({command:"setLight",args:[o.light]}),ci(h.terrain,o.terrain)||c.push({command:"setTerrain",args:[o.terrain]}),ci(h.sky,o.sky)||c.push({command:"setSky",args:[o.sky]}),ci(h.projection,o.projection)||c.push({command:"setProjection",args:[o.projection]});const g={},x=[];(function(A,z,B,G){let W;for(W in z=z||{},A=A||{})Object.prototype.hasOwnProperty.call(A,W)&&(Object.prototype.hasOwnProperty.call(z,W)||Ir(W,B,G));for(W in z)Object.prototype.hasOwnProperty.call(z,W)&&(Object.prototype.hasOwnProperty.call(A,W)?ci(A[W],z[W])||(A[W].type==="geojson"&&z[W].type==="geojson"&&bo(A,z,W)?ui(B,{command:"setGeoJSONSourceData",args:[W,z[W].data]}):Ae(W,z,B,G)):or(W,z,B))})(h.sources,o.sources,x,g);const T=[];h.layers&&h.layers.forEach(A=>{"source"in A&&g[A.source]?c.push({command:"removeLayer",args:[A.id]}):T.push(A)}),c=c.concat(x),function(A,z,B){z=z||[];const G=(A=A||[]).map(Un),W=z.map(Un),K=A.reduce(rr,{}),ot=z.reduce(rr,{}),ct=G.slice(),dt=Object.create(null);let xt,At,jt,ue,Qt;for(let ie=0,Se=0;ie<G.length;ie++)xt=G[ie],Object.prototype.hasOwnProperty.call(ot,xt)?Se++:(ui(B,{command:"removeLayer",args:[xt]}),ct.splice(ct.indexOf(xt,Se),1));for(let ie=0,Se=0;ie<W.length;ie++)xt=W[W.length-1-ie],ct[ct.length-1-ie]!==xt&&(Object.prototype.hasOwnProperty.call(K,xt)?(ui(B,{command:"removeLayer",args:[xt]}),ct.splice(ct.lastIndexOf(xt,ct.length-Se),1)):Se++,ue=ct[ct.length-ie],ui(B,{command:"addLayer",args:[ot[xt],ue]}),ct.splice(ct.length-ie,0,xt),dt[xt]=!0);for(let ie=0;ie<W.length;ie++)if(xt=W[ie],At=K[xt],jt=ot[xt],!dt[xt]&&!ci(At,jt))if(ci(At.source,jt.source)&&ci(At["source-layer"],jt["source-layer"])&&ci(At.type,jt.type)){for(Qt in _n(At.layout,jt.layout,B,xt,null,"setLayoutProperty"),_n(At.paint,jt.paint,B,xt,null,"setPaintProperty"),ci(At.filter,jt.filter)||ui(B,{command:"setFilter",args:[xt,jt.filter]}),ci(At.minzoom,jt.minzoom)&&ci(At.maxzoom,jt.maxzoom)||ui(B,{command:"setLayerZoomRange",args:[xt,jt.minzoom,jt.maxzoom]}),At)Object.prototype.hasOwnProperty.call(At,Qt)&&Qt!=="layout"&&Qt!=="paint"&&Qt!=="filter"&&Qt!=="metadata"&&Qt!=="minzoom"&&Qt!=="maxzoom"&&(Qt.indexOf("paint.")===0?_n(At[Qt],jt[Qt],B,xt,Qt.slice(6),"setPaintProperty"):ci(At[Qt],jt[Qt])||ui(B,{command:"setLayerProperty",args:[xt,Qt,jt[Qt]]}));for(Qt in jt)Object.prototype.hasOwnProperty.call(jt,Qt)&&!Object.prototype.hasOwnProperty.call(At,Qt)&&Qt!=="layout"&&Qt!=="paint"&&Qt!=="filter"&&Qt!=="metadata"&&Qt!=="minzoom"&&Qt!=="maxzoom"&&(Qt.indexOf("paint.")===0?_n(At[Qt],jt[Qt],B,xt,Qt.slice(6),"setPaintProperty"):ci(At[Qt],jt[Qt])||ui(B,{command:"setLayerProperty",args:[xt,Qt,jt[Qt]]}))}else ui(B,{command:"removeLayer",args:[xt]}),ue=ct[ct.lastIndexOf(xt)+1],ui(B,{command:"addLayer",args:[jt,ue]})}(T,o.layers,c)}catch(g){console.warn("Unable to compute style diff:",g),c=[{command:"setStyle",args:[o]}]}return c},it.bW=function(h){const o=[],c=h.id;return c===void 0&&o.push({message:`layers.${c}: missing required property "id"`}),h.render===void 0&&o.push({message:`layers.${c}: missing required method "render"`}),h.renderingMode&&h.renderingMode!=="2d"&&h.renderingMode!=="3d"&&o.push({message:`layers.${c}: property "renderingMode" must be either "2d" or "3d"`}),o},it.bX=ho,it.bY=qo,it.bZ=class extends Fs{constructor(h,o){super(h,o),this.current=0}set(h){this.current!==h&&(this.current=h,this.gl.uniform1i(this.location,h))}},it.b_=Ql,it.ba=function(h,o){return h[0]*o[0]+h[1]*o[1]+h[2]*o[2]+h[3]},it.bb=A_,it.bc=_d,it.bd=function(h,o,c,g,x){var T=1/Math.tan(o/2);if(h[0]=T/c,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=T,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,x!=null&&x!==1/0){var A=1/(g-x);h[10]=(x+g)*A,h[14]=2*x*g*A}else h[10]=-1,h[14]=-2*g;return h},it.be=function(h){var o=new Yr(16);return o[0]=h[0],o[1]=h[1],o[2]=h[2],o[3]=h[3],o[4]=h[4],o[5]=h[5],o[6]=h[6],o[7]=h[7],o[8]=h[8],o[9]=h[9],o[10]=h[10],o[11]=h[11],o[12]=h[12],o[13]=h[13],o[14]=h[14],o[15]=h[15],o},it.bf=function(h,o,c){var g=Math.sin(c),x=Math.cos(c),T=o[0],A=o[1],z=o[2],B=o[3],G=o[4],W=o[5],K=o[6],ot=o[7];return o!==h&&(h[8]=o[8],h[9]=o[9],h[10]=o[10],h[11]=o[11],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15]),h[0]=T*x+G*g,h[1]=A*x+W*g,h[2]=z*x+K*g,h[3]=B*x+ot*g,h[4]=G*x-T*g,h[5]=W*x-A*g,h[6]=K*x-z*g,h[7]=ot*x-B*g,h},it.bg=function(h,o,c){var g=Math.sin(c),x=Math.cos(c),T=o[4],A=o[5],z=o[6],B=o[7],G=o[8],W=o[9],K=o[10],ot=o[11];return o!==h&&(h[0]=o[0],h[1]=o[1],h[2]=o[2],h[3]=o[3],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15]),h[4]=T*x+G*g,h[5]=A*x+W*g,h[6]=z*x+K*g,h[7]=B*x+ot*g,h[8]=G*x-T*g,h[9]=W*x-A*g,h[10]=K*x-z*g,h[11]=ot*x-B*g,h},it.bh=function(){const h=new Float32Array(16);return us(h),h},it.bi=function(){const h=new Float64Array(16);return us(h),h},it.bj=function(){return new Float64Array(16)},it.bk=function(h,o,c){const g=new Float64Array(4);return so(g,h,o-90,c),g},it.bl=function(h,o,c,g){var x,T,A,z,B,G=o[0],W=o[1],K=o[2],ot=o[3],ct=c[0],dt=c[1],xt=c[2],At=c[3];return(T=G*ct+W*dt+K*xt+ot*At)<0&&(T=-T,ct=-ct,dt=-dt,xt=-xt,At=-At),1-T>gr?(x=Math.acos(T),A=Math.sin(x),z=Math.sin((1-g)*x)/A,B=Math.sin(g*x)/A):(z=1-g,B=g),h[0]=z*G+B*ct,h[1]=z*W+B*dt,h[2]=z*K+B*xt,h[3]=z*ot+B*At,h},it.bm=function(h){const o=new Float64Array(9);var c,g,x,T,A,z,B,G,W,K,ot,ct,dt,xt,At,jt,ue,Qt;K=(x=(g=h)[0])*(B=x+x),ot=(T=g[1])*B,dt=(A=g[2])*B,xt=A*(G=T+T),jt=(z=g[3])*B,ue=z*G,Qt=z*(W=A+A),(c=o)[0]=1-(ct=T*G)-(At=A*W),c[3]=ot-Qt,c[6]=dt+ue,c[1]=ot+Qt,c[4]=1-K-At,c[7]=xt-jt,c[2]=dt-ue,c[5]=xt+jt,c[8]=1-K-ct;const ie=Ss(-Math.asin(Qs(o[2],-1,1)));let Se,Ee;return Math.hypot(o[5],o[8])<.001?(Se=0,Ee=-Ss(Math.atan2(o[3],o[4]))):(Se=Ss(o[5]===0&&o[8]===0?0:Math.atan2(o[5],o[8])),Ee=Ss(o[1]===0&&o[0]===0?0:Math.atan2(o[1],o[0]))),{roll:Se,pitch:ie+90,bearing:Ee}},it.bn=function(h,o){return h.roll==o.roll&&h.pitch==o.pitch&&h.bearing==o.bearing},it.bo=tn,it.bp=mc,it.bq=Q,it.br=nt,it.bs=U,it.bt=Js,it.bu=Jn,it.bv=ra,it.bw=function(h,o,c,g,x){return Js(g,x,Qs((h-o)/(c-o),0,1))},it.bx=js,it.by=function(){return new Float64Array(3)},it.bz=function(h,o,c,g){return h[0]=o[0]+c[0]*g,h[1]=o[1]+c[1]*g,h[2]=o[2]+c[2]*g,h},it.c=zs,it.c$=class{constructor(h){this._marks={start:[h.url,"start"].join("#"),end:[h.url,"end"].join("#"),measure:h.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let h=performance.getEntriesByName(this._marks.measure);return h.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),h=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),h}},it.c0=Wa,it.c1=class extends Fs{constructor(h,o){super(h,o),this.current=[0,0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]&&h[2]===this.current[2]||(this.current=h,this.gl.uniform3f(this.location,h[0],h[1],h[2]))}},it.c2=class extends Fs{constructor(h,o){super(h,o),this.current=[0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]||(this.current=h,this.gl.uniform2f(this.location,h[0],h[1]))}},it.c3=Fn,it.c4=function(h,o){var c=Math.sin(o),g=Math.cos(o);return h[0]=g,h[1]=c,h[2]=0,h[3]=-c,h[4]=g,h[5]=0,h[6]=0,h[7]=0,h[8]=1,h},it.c5=function(h,o,c){var g=o[0],x=o[1],T=o[2];return h[0]=g*c[0]+x*c[3]+T*c[6],h[1]=g*c[1]+x*c[4]+T*c[7],h[2]=g*c[2]+x*c[5]+T*c[8],h},it.c6=function(h,o,c,g,x,T,A){var z=1/(o-c),B=1/(g-x),G=1/(T-A);return h[0]=-2*z,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=-2*B,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=2*G,h[11]=0,h[12]=(o+c)*z,h[13]=(x+g)*B,h[14]=(A+T)*G,h[15]=1,h},it.c7=class extends Fs{constructor(h,o){super(h,o),this.current=new Array}set(h){if(h!=this.current){this.current=h;const o=new Float32Array(4*h.length);for(let c=0;c<h.length;c++)o[4*c]=h[c].r,o[4*c+1]=h[c].g,o[4*c+2]=h[c].b,o[4*c+3]=h[c].a;this.gl.uniform4fv(this.location,o)}}},it.c8=class extends Fs{constructor(h,o){super(h,o),this.current=new Array}set(h){if(h!=this.current){this.current=h;const o=new Float32Array(h);this.gl.uniform1fv(this.location,o)}}},it.c9=class extends Pp{},it.cA=function(h){return il[h]||Sl[h]},it.cB=function(h,o,c){var g=o[0],x=o[1];return h[0]=c[0]*g+c[4]*x+c[12],h[1]=c[1]*g+c[5]*x+c[13],h},it.cC=function(h,o){const{x:c,y:g}=qm.fromLngLat(o);return!(h<0||h>25||g<0||g>=1||c<0||c>=1)},it.cD=function(h,o){return h[0]=o[0],h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=o[1],h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=o[2],h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},it.cE=class extends zl{},it.cF=p0,it.cH=function(h){return h.message===Il},it.cI=Aa,it.cJ=function(h,o){rl.REGISTERED_PROTOCOLS[h]=o},it.cK=function(h){delete rl.REGISTERED_PROTOCOLS[h]},it.cL=function(h,o){const c={};for(let x=0;x<h.length;x++){const T=o&&o[h[x].id]||uf(h[x]);o&&(o[h[x].id]=T);let A=c[T];A||(A=c[T]=[]),A.push(h[x])}const g=[];for(const x in c)g.push(c[x]);return g},it.cM=Ki,it.cN=qy,it.cO=s0,it.cP=Dy,it.cQ=function(h){h.bucket.createArrays(),h.bucket.tilePixelRatio=Ln/(512*h.bucket.overscaling),h.bucket.compareText={},h.bucket.iconsNeedLinear=!1;const o=h.bucket.layers[0],c=o.layout,g=o._unevaluatedLayout._values,x={layoutIconSize:g["icon-size"].possiblyEvaluate(new uo(h.bucket.zoom+1),h.canonical),layoutTextSize:g["text-size"].possiblyEvaluate(new uo(h.bucket.zoom+1),h.canonical),textMaxSize:g["text-size"].possiblyEvaluate(new uo(18))};if(h.bucket.textSizeData.kind==="composite"){const{minZoom:G,maxZoom:W}=h.bucket.textSizeData;x.compositeTextSizes=[g["text-size"].possiblyEvaluate(new uo(G),h.canonical),g["text-size"].possiblyEvaluate(new uo(W),h.canonical)]}if(h.bucket.iconSizeData.kind==="composite"){const{minZoom:G,maxZoom:W}=h.bucket.iconSizeData;x.compositeIconSizes=[g["icon-size"].possiblyEvaluate(new uo(G),h.canonical),g["icon-size"].possiblyEvaluate(new uo(W),h.canonical)]}const T=c.get("text-line-height")*mo,A=c.get("text-rotation-alignment")!=="viewport"&&c.get("symbol-placement")!=="point",z=c.get("text-keep-upright"),B=c.get("text-size");for(const G of h.bucket.features){const W=c.get("text-font").evaluate(G,{},h.canonical).join(","),K=B.evaluate(G,{},h.canonical),ot=x.layoutTextSize.evaluate(G,{},h.canonical),ct=x.layoutIconSize.evaluate(G,{},h.canonical),dt={horizontal:{},vertical:void 0},xt=G.text;let At,jt=[0,0];if(xt){const ie=xt.toString(),Se=c.get("text-letter-spacing").evaluate(G,{},h.canonical)*mo,Ee=nd(ie)?Se:0,ei=c.get("text-anchor").evaluate(G,{},h.canonical),Ai=gm(o,G,h.canonical);if(!Ai){const Ui=c.get("text-radial-offset").evaluate(G,{},h.canonical);jt=Ui?Df(ei,[Ui*mo,rp]):c.get("text-offset").evaluate(G,{},h.canonical).map(ji=>ji*mo)}let mi=A?"center":c.get("text-justify").evaluate(G,{},h.canonical);const Ei=c.get("symbol-placement")==="point"?c.get("text-max-width").evaluate(G,{},h.canonical)*mo:1/0,Hi=()=>{h.bucket.allowVerticalPlacement&&Bc(ie)&&(dt.vertical=Tg(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,Ei,T,ei,"left",Ee,jt,it.ay.vertical,!0,ot,K))};if(!A&&Ai){const Ui=new Set;if(mi==="auto")for(let gi=0;gi<Ai.values.length;gi+=2)Ui.add(Qm(Ai.values[gi]));else Ui.add(mi);let ji=!1;for(const gi of Ui)if(!dt.horizontal[gi])if(ji)dt.horizontal[gi]=dt.horizontal[0];else{const Ar=Tg(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,Ei,T,"center",gi,Ee,jt,it.ay.horizontal,!1,ot,K);Ar&&(dt.horizontal[gi]=Ar,ji=Ar.positionedLines.length===1)}Hi()}else{mi==="auto"&&(mi=Qm(ei));const Ui=Tg(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,Ei,T,ei,mi,Ee,jt,it.ay.horizontal,!1,ot,K);Ui&&(dt.horizontal[mi]=Ui),Hi(),Bc(ie)&&A&&z&&(dt.vertical=Tg(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,Ei,T,ei,mi,Ee,jt,it.ay.vertical,!1,ot,K))}}let ue=!1;if(G.icon&&G.icon.name){const ie=h.imageMap[G.icon.name];ie&&(At=jm(h.imagePositions[G.icon.name],c.get("icon-offset").evaluate(G,{},h.canonical),c.get("icon-anchor").evaluate(G,{},h.canonical)),ue=!!ie.sdf,h.bucket.sdfIcons===void 0?h.bucket.sdfIcons=ue:h.bucket.sdfIcons!==ue&&vo("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(ie.pixelRatio!==h.bucket.pixelRatio||c.get("icon-rotate").constantOr(1)!==0)&&(h.bucket.iconsNeedLinear=!0))}const Qt=_m(dt.horizontal)||dt.vertical;h.bucket.iconsInText=!!Qt&&Qt.iconsInText,(Qt||At)&&qg(h.bucket,G,dt,At,h.imageMap,x,ot,ct,jt,ue,h.canonical,h.subdivisionGranularity)}h.showCollisionBoxes&&h.bucket.generateCollisionDebugBuffers()},it.cR=zt,it.cS=Ci,it.cT=Vr,it.cU=ge,it.cV=As,it.cW=ve,it.cX=function(h,o,c,g,x,T){let A=H_(h,o,c,x,0);return A=H_(A,o,g,T,1),A},it.cY=class{constructor(h){this.maxEntries=h,this.map=new Map}get(h){const o=this.map.get(h);return o!==void 0&&(this.map.delete(h),this.map.set(h,o)),o}set(h,o){if(this.map.has(h))this.map.delete(h);else if(this.map.size>=this.maxEntries){const c=this.map.keys().next().value;this.map.delete(c)}this.map.set(h,o)}clear(){this.map.clear()}},it.cZ=Be,it.c_=jg,it.ca=So,it.cb=class extends hd{},it.cc=kp,it.cd=function(h){return h<=1?1:Math.pow(2,Math.ceil(Math.log(h)/Math.LN2))},it.ce=tm,it.cf=function(h,o,c){var g=o[0],x=o[1],T=o[2],A=c[3]*g+c[7]*x+c[11]*T+c[15];return h[0]=(c[0]*g+c[4]*x+c[8]*T+c[12])/(A=A||1),h[1]=(c[1]*g+c[5]*x+c[9]*T+c[13])/A,h[2]=(c[2]*g+c[6]*x+c[10]*T+c[14])/A,h},it.cg=class extends Nc{},it.ch=class extends v{},it.ci=function(h,o){return h[0]===o[0]&&h[1]===o[1]&&h[2]===o[2]&&h[3]===o[3]&&h[4]===o[4]&&h[5]===o[5]&&h[6]===o[6]&&h[7]===o[7]&&h[8]===o[8]&&h[9]===o[9]&&h[10]===o[10]&&h[11]===o[11]&&h[12]===o[12]&&h[13]===o[13]&&h[14]===o[14]&&h[15]===o[15]},it.cj=function(h,o){var c=h[0],g=h[1],x=h[2],T=h[3],A=h[4],z=h[5],B=h[6],G=h[7],W=h[8],K=h[9],ot=h[10],ct=h[11],dt=h[12],xt=h[13],At=h[14],jt=h[15],ue=o[0],Qt=o[1],ie=o[2],Se=o[3],Ee=o[4],ei=o[5],Ai=o[6],mi=o[7],Ei=o[8],Hi=o[9],Ui=o[10],ji=o[11],gi=o[12],Ar=o[13],Pr=o[14],Mr=o[15];return Math.abs(c-ue)<=gr*Math.max(1,Math.abs(c),Math.abs(ue))&&Math.abs(g-Qt)<=gr*Math.max(1,Math.abs(g),Math.abs(Qt))&&Math.abs(x-ie)<=gr*Math.max(1,Math.abs(x),Math.abs(ie))&&Math.abs(T-Se)<=gr*Math.max(1,Math.abs(T),Math.abs(Se))&&Math.abs(A-Ee)<=gr*Math.max(1,Math.abs(A),Math.abs(Ee))&&Math.abs(z-ei)<=gr*Math.max(1,Math.abs(z),Math.abs(ei))&&Math.abs(B-Ai)<=gr*Math.max(1,Math.abs(B),Math.abs(Ai))&&Math.abs(G-mi)<=gr*Math.max(1,Math.abs(G),Math.abs(mi))&&Math.abs(W-Ei)<=gr*Math.max(1,Math.abs(W),Math.abs(Ei))&&Math.abs(K-Hi)<=gr*Math.max(1,Math.abs(K),Math.abs(Hi))&&Math.abs(ot-Ui)<=gr*Math.max(1,Math.abs(ot),Math.abs(Ui))&&Math.abs(ct-ji)<=gr*Math.max(1,Math.abs(ct),Math.abs(ji))&&Math.abs(dt-gi)<=gr*Math.max(1,Math.abs(dt),Math.abs(gi))&&Math.abs(xt-Ar)<=gr*Math.max(1,Math.abs(xt),Math.abs(Ar))&&Math.abs(At-Pr)<=gr*Math.max(1,Math.abs(At),Math.abs(Pr))&&Math.abs(jt-Mr)<=gr*Math.max(1,Math.abs(jt),Math.abs(Mr))},it.ck=function(h,o){return h[0]=o[0],h[1]=o[1],h[2]=o[2],h[3]=o[3],h[4]=o[4],h[5]=o[5],h[6]=o[6],h[7]=o[7],h[8]=o[8],h[9]=o[9],h[10]=o[10],h[11]=o[11],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15],h},it.cl=h=>h.type==="symbol",it.cm=h=>h.type==="circle",it.cn=h=>h.type==="heatmap",it.co=h=>h.type==="line",it.cp=h=>h.type==="fill",it.cq=h=>h.type==="fill-extrusion",it.cr=h=>h.type==="hillshade",it.cs=h=>h.type==="color-relief",it.ct=h=>h.type==="background",it.cu=h=>h.type==="custom",it.cv=Ks,it.cw=function(h,o,c){const g=Fo(o.x-c.x,o.y-c.y),x=Fo(h.x-c.x,h.y-c.y);var T,A;return Ss(Math.atan2(g[0]*x[1]-g[1]*x[0],(T=g)[0]*(A=x)[0]+T[1]*A[1]))},it.cx=Ul,it.cy=function(h,o){return Sl[o]&&(h instanceof MouseEvent||h instanceof WheelEvent)},it.cz=function(h,o){return il[o]&&"touches"in h},it.d=It,it.d0=function(h,o,c,g,x){return i(this,void 0,void 0,function*(){if(Io())try{return yield jl(h,o,c,g,x)}catch{}return function(T,A,z,B,G){const W=T.width,K=T.height;Ts&&ga||(Ts=new OffscreenCanvas(W,K),ga=Ts.getContext("2d",{willReadFrequently:!0})),Ts.width=W,Ts.height=K,ga.drawImage(T,0,0,W,K);const ot=ga.getImageData(A,z,B,G);return ga.clearRect(0,0,W,K),ot.data}(h,o,c,g,x)})},it.d1=Bm,it.d2=yi,it.d3=Xn,it.d4=Oc,it.e=Wo,it.f=h=>i(void 0,void 0,void 0,function*(){if(h.byteLength===0)return createImageBitmap(new ImageData(1,1));const o=new Blob([new Uint8Array(h)],{type:"image/png"});try{return createImageBitmap(o)}catch(c){throw new Error(`Could not load image because of ${c.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),it.g=Ga,it.h=h=>new Promise((o,c)=>{const g=new Image;g.onload=()=>{o(g),URL.revokeObjectURL(g.src),g.onload=null,window.requestAnimationFrame(()=>{g.src=el})},g.onerror=()=>c(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const x=new Blob([new Uint8Array(h)],{type:"image/png"});g.src=h.byteLength?URL.createObjectURL(x):el}),it.i=Ds,it.j=(h,o)=>we(Wo(h,{type:"json"}),o),it.k=le,it.l=he,it.m=we,it.n=(h,o)=>we(Wo(h,{type:"arrayBuffer"}),o),it.o=function(h){return new As(h).readFields(wg,[])},it.p=x_,it.q=function(h){return/[\u02EA\u02EB\u1100-\u11FF\u2E80-\u2FDF\u3000-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))},it.r=Pu,it.s=Gl,it.t=cs,it.u=te,it.v=yu,it.w=vo,it.x=Ip,it.y=Vd,it.z=Tu}),Dt("worker",["./shared"],function(it){class i{constructor(It,Mt){this.keyCache={},It&&this.replace(It,Mt)}replace(It,Mt){this._layerConfigs={},this._layers={},this.update(It,[],Mt)}update(It,Mt,Ut){for(const le of It){this._layerConfigs[le.id]=le;const Re=this._layers[le.id]=it.bS(le,Ut);Re._featureFilter=it.aj(Re.filter,Ut),this.keyCache[le.id]&&delete this.keyCache[le.id]}for(const le of Mt)delete this.keyCache[le],delete this._layerConfigs[le],delete this._layers[le];this.familiesBySource={};const he=it.cL(Object.values(this._layerConfigs),this.keyCache);for(const le of he){const Re=le.map(or=>this._layers[or.id]),te=Re[0];if(te.visibility==="none")continue;const ze=te.source||"";let We=this.familiesBySource[ze];We||(We=this.familiesBySource[ze]={});const ci=te.sourceLayer||it.a9;let ui=We[ci];ui||(ui=We[ci]=[]),ui.push(Re)}}}class Pe{constructor(It){const Mt={},Ut=[];for(const te in It){const ze=It[te],We=Mt[te]={};for(const ci in ze){const ui=ze[+ci];if(!ui||ui.bitmap.width===0||ui.bitmap.height===0)continue;const or={x:0,y:0,w:ui.bitmap.width+2,h:ui.bitmap.height+2};Ut.push(or),We[ci]={rect:or,metrics:ui.metrics}}}const{w:he,h:le}=it.p(Ut),Re=new it.r({width:he||1,height:le||1});for(const te in It){const ze=It[te];for(const We in ze){const ci=ze[+We];if(!ci||ci.bitmap.width===0||ci.bitmap.height===0)continue;const ui=Mt[te][We].rect;it.r.copy(ci.bitmap,Re,{x:0,y:0},{x:ui.x+1,y:ui.y+1},ci.bitmap)}}this.image=Re,this.positions=Mt}}it.cM("GlyphAtlas",Pe);class yi{constructor(It){this.tileID=new it.a1(It.tileID.overscaledZ,It.tileID.wrap,It.tileID.canonical.z,It.tileID.canonical.x,It.tileID.canonical.y),this.uid=It.uid,this.zoom=It.zoom,this.pixelRatio=It.pixelRatio,this.tileSize=It.tileSize,this.source=It.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=It.showCollisionBoxes,this.collectResourceTiming=!!It.collectResourceTiming,this.returnDependencies=!!It.returnDependencies,this.promoteId=It.promoteId,this.inFlightDependencies=[]}parse(It,Mt,Ut,he,le){return it._(this,void 0,void 0,function*(){this.status="parsing",this.data=It,this.collisionBoxArray=new it.ah;const Re=new it.cN(Object.keys(It.layers).sort()),te=new it.cO(this.tileID,this.promoteId);te.bucketLayerIDs=[];const ze={},We={featureIndex:te,iconDependencies:{},patternDependencies:{},glyphDependencies:{},dashDependencies:{},availableImages:Ut,subdivisionGranularity:le},ci=Mt.familiesBySource[this.source];for(const Tt in ci){const Nt=It.layers[Tt];if(!Nt)continue;Nt.version===1&&it.w(`Vector tile source "${this.source}" layer "${Tt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Wt=Re.encode(Tt),oe=[];for(let ye=0;ye<Nt.length;ye++){const Jt=Nt.feature(ye),xe=te.getId(Jt,Tt);oe.push({feature:Jt,id:xe,index:ye,sourceLayerIndex:Wt})}for(const ye of ci[Tt]){const Jt=ye[0];Jt.source!==this.source&&it.w(`layer.source = ${Jt.source} does not equal this.source = ${this.source}`),Jt.isHidden(this.zoom,!0)||(tr(ye,this.zoom,Ut),(ze[Jt.id]=Jt.createBucket({index:te.bucketLayerIDs.length,layers:ye,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Wt,sourceID:this.source})).populate(oe,We,this.tileID.canonical),te.bucketLayerIDs.push(ye.map(xe=>xe.id)))}}const ui=it.bX(We.glyphDependencies,Tt=>Object.keys(Tt).map(Number));this.inFlightDependencies.forEach(Tt=>Tt?.abort()),this.inFlightDependencies=[];let or=Promise.resolve({});if(Object.keys(ui).length){const Tt=new AbortController;this.inFlightDependencies.push(Tt),or=he.sendAsync({type:"GG",data:{stacks:ui,source:this.source,tileID:this.tileID,type:"glyphs"}},Tt)}const Ir=Object.keys(We.iconDependencies);let Ae=Promise.resolve({});if(Ir.length){const Tt=new AbortController;this.inFlightDependencies.push(Tt),Ae=he.sendAsync({type:"GI",data:{icons:Ir,source:this.source,tileID:this.tileID,type:"icons"}},Tt)}const bo=Object.keys(We.patternDependencies);let _n=Promise.resolve({});if(bo.length){const Tt=new AbortController;this.inFlightDependencies.push(Tt),_n=he.sendAsync({type:"GI",data:{icons:bo,source:this.source,tileID:this.tileID,type:"patterns"}},Tt)}const Un=We.dashDependencies;let rr=Promise.resolve({});if(Object.keys(Un).length){const Tt=new AbortController;this.inFlightDependencies.push(Tt),rr=he.sendAsync({type:"GDA",data:{dashes:Un}},Tt)}const[bi,Bo,wo,se]=yield Promise.all([or,Ae,_n,rr]),st=new Pe(bi),tt=new it.cP(Bo,wo);for(const Tt in ze){const Nt=ze[Tt];Nt instanceof it.ai?(tr(Nt.layers,this.zoom,Ut),it.cQ({bucket:Nt,glyphMap:bi,glyphPositions:st.positions,imageMap:Bo,imagePositions:tt.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:We.subdivisionGranularity})):Nt.hasDependencies&&(Nt instanceof it.cR||Nt instanceof it.cS||Nt instanceof it.cT)&&(tr(Nt.layers,this.zoom,Ut),Nt.addFeatures(We,this.tileID.canonical,tt.patternPositions,se))}return this.status="done",{buckets:Object.values(ze).filter(Tt=>!Tt.isEmpty()),featureIndex:te,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:st.image,imageAtlas:tt,dashPositions:se,glyphMap:this.returnDependencies?bi:null,iconMap:this.returnDependencies?Bo:null,glyphPositions:this.returnDependencies?st.positions:null}})}}function tr(we,It,Mt){const Ut=new it.H(It);for(const he of we)he.recalculate(Ut,Mt)}class vn extends it.cW{constructor(It,Mt){super(new it.cV,0,Mt,[],[]),this.feature=It,this.type=It.type,this.properties=It.tags?It.tags:{},"id"in It&&(typeof It.id=="string"?this.id=parseInt(It.id,10):typeof It.id!="number"||isNaN(It.id)||(this.id=It.id))}loadGeometry(){const It=[],Mt=this.feature.type===1?[this.feature.geometry]:this.feature.geometry;for(const Ut of Mt){const he=[];for(const le of Ut)he.push(new it.P(le[0],le[1]));It.push(he)}return It}}class on extends it.cU{constructor(It,Mt){super(new it.cV),this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.version=Mt?Mt.version:1,this.extent=Mt?Mt.extent:4096,this.length=It.length,this.features=It}feature(It){return new vn(this.features[It],this.extent)}}function Br(we,It){It.writeVarintField(15,we.version||1),It.writeStringField(1,we.name||""),It.writeVarintField(5,we.extent||4096);const Mt={keys:[],values:[],keycache:{},valuecache:{}};for(let le=0;le<we.length;le++)Mt.feature=we.feature(le),It.writeMessage(2,Or,Mt);const Ut=Mt.keys;for(const le of Ut)It.writeStringField(3,le);const he=Mt.values;for(const le of he)It.writeMessage(4,Yr,le)}function Or(we,It){if(!we.feature)return;const Mt=we.feature;Mt.id!==void 0&&It.writeVarintField(1,Mt.id),It.writeMessage(2,Ri,we),It.writeVarintField(3,Mt.type),It.writeMessage(4,gr,Mt)}function Ri(we,It){for(const Mt in we.feature?.properties){let Ut=we.feature.properties[Mt],he=we.keycache[Mt];if(Ut===null)continue;he===void 0&&(we.keys.push(Mt),he=we.keys.length-1,we.keycache[Mt]=he),It.writeVarint(he),typeof Ut!="string"&&typeof Ut!="boolean"&&typeof Ut!="number"&&(Ut=JSON.stringify(Ut));const le=typeof Ut+":"+Ut;let Re=we.valuecache[le];Re===void 0&&(we.values.push(Ut),Re=we.values.length-1,we.valuecache[le]=Re),It.writeVarint(Re)}}function Ve(we,It){return(It<<3)+(7&we)}function Io(we){return we<<1^we>>31}function gr(we,It){const Mt=we.loadGeometry(),Ut=we.type;let he=0,le=0;for(const Re of Mt){let te=1;Ut===1&&(te=Re.length),It.writeVarint(Ve(1,te));const ze=Ut===3?Re.length-1:Re.length;for(let We=0;We<ze;We++){We===1&&Ut!==1&&It.writeVarint(Ve(2,ze-1));const ci=Re[We].x-he,ui=Re[We].y-le;It.writeVarint(Io(ci)),It.writeVarint(Io(ui)),he+=ci,le+=ui}we.type===3&&It.writeVarint(Ve(7,1))}}function Yr(we,It){const Mt=typeof we;Mt==="string"?It.writeStringField(1,we):Mt==="boolean"?It.writeBooleanField(7,we):Mt==="number"&&(we%1!=0?It.writeDoubleField(3,we):we<0?It.writeSVarintField(6,we):It.writeVarintField(5,we))}class Fn extends it.cW{constructor(It,Mt,Ut,he,le){super(new it.cV,0,le,[],[]),this.type=It,this.properties=Ut||{},this.extent=le,this.pointsArray=Mt,this.id=he}loadGeometry(){return this.pointsArray.map(It=>It.map(Mt=>new it.P(Mt.x,Mt.y)))}}class us extends it.cU{constructor(It,Mt,Ut){super(new it.cV),this.version=2,this._myFeatures=It,this.name=Mt,this.length=It.length,this.extent=Ut}feature(It){return this._myFeatures[It]}}class ao{constructor(){this.layers={}}addLayer(It){this.layers[It.name]=It}}function Do(we){let It=function(Mt){const Ut=new it.cV;return function(he,le){for(const Re in he.layers)le.writeMessage(3,Br,he.layers[Re])}(Mt,Ut),Ut.finish()}(we);return It.byteOffset===0&&It.byteLength===It.buffer.byteLength||(It=new Uint8Array(It)),{vectorTile:we,rawData:It.buffer}}function tl(we,It,Mt){const{extent:Ut}=we,he=Math.pow(2,Mt.z-It.z),le=(Mt.x-It.x*he)*Ut,Re=(Mt.y-It.y*he)*Ut,te=[];for(let ze=0;ze<we.length;ze++){const We=we.feature(ze);let ci=We.loadGeometry();for(const or of ci)for(const Ir of or)Ir.x=Ir.x*he-le,Ir.y=Ir.y*he-Re;const ui=128;ci=it.cX(ci,We.type,-ui,-ui,Ut+ui,Ut+ui),ci.length!==0&&te.push(new Fn(We.type,ci,We.properties,We.id,Ut))}return new us(te,we.name,Ut)}class fa{constructor(It,Mt,Ut){this.actor=It,this.layerIndex=Mt,this.availableImages=Ut,this.fetching={},this.loading={},this.loaded={},this.overzoomedTileResultCache=new it.cY(1e3)}loadVectorTile(It,Mt){return it._(this,void 0,void 0,function*(){const Ut=yield it.n(It.request,Mt);try{return{vectorTile:It.encoding!=="mlt"?new it.cZ(new it.cV(Ut.data)):new it.c_(Ut.data),rawData:Ut.data,cacheControl:Ut.cacheControl,expires:Ut.expires}}catch(he){const le=new Uint8Array(Ut.data);let Re=`Unable to parse the tile at ${It.request.url}, `;throw Re+=le[0]===31&&le[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${he.message}`,new Error(Re)}})}loadTile(It){return it._(this,void 0,void 0,function*(){const{uid:Mt,overzoomParameters:Ut}=It;Ut&&(It.request=Ut.overzoomRequest);const he=!!(It&&It.request&&It.request.collectResourceTiming)&&new it.c$(It.request),le=new yi(It);this.loading[Mt]=le;const Re=new AbortController;le.abort=Re;try{const te=yield this.loadVectorTile(It,Re);if(delete this.loading[Mt],!te)return null;if(Ut){const or=this._getOverzoomTile(It,te.vectorTile);te.rawData=or.rawData,te.vectorTile=or.vectorTile}const ze=te.rawData,We={};te.expires&&(We.expires=te.expires),te.cacheControl&&(We.cacheControl=te.cacheControl);const ci={};if(he){const or=he.finish();or&&(ci.resourceTiming=JSON.parse(JSON.stringify(or)))}le.vectorTile=te.vectorTile;const ui=le.parse(te.vectorTile,this.layerIndex,this.availableImages,this.actor,It.subdivisionGranularity);this.loaded[Mt]=le,this.fetching[Mt]={rawTileData:ze,cacheControl:We,resourceTiming:ci};try{const or=yield ui;return it.e({rawTileData:ze.slice(0),encoding:It.encoding},or,We,ci)}finally{delete this.fetching[Mt]}}catch(te){throw delete this.loading[Mt],le.status="done",this.loaded[Mt]=le,te}})}_getOverzoomTile(It,Mt){const{tileID:Ut,source:he,overzoomParameters:le}=It,{maxZoomTileID:Re}=le,te=`${Re.key}_${Ut.key}`,ze=this.overzoomedTileResultCache.get(te);if(ze)return ze;const We=new ao,ci=this.layerIndex.familiesBySource[he];for(const or in ci){const Ir=Mt.layers[or];if(!Ir)continue;const Ae=tl(Ir,Re,Ut.canonical);Ae.length>0&&We.addLayer(Ae)}const ui=Do(We);return this.overzoomedTileResultCache.set(te,ui),ui}reloadTile(It){return it._(this,void 0,void 0,function*(){const Mt=It.uid;if(!this.loaded||!this.loaded[Mt])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const Ut=this.loaded[Mt];if(Ut.showCollisionBoxes=It.showCollisionBoxes,Ut.status==="parsing"){const he=yield Ut.parse(Ut.vectorTile,this.layerIndex,this.availableImages,this.actor,It.subdivisionGranularity);let le;if(this.fetching[Mt]){const{rawTileData:Re,cacheControl:te,resourceTiming:ze}=this.fetching[Mt];delete this.fetching[Mt],le=it.e({rawTileData:Re.slice(0),encoding:It.encoding},he,te,ze)}else le=he;return le}if(Ut.status==="done"&&Ut.vectorTile)return Ut.parse(Ut.vectorTile,this.layerIndex,this.availableImages,this.actor,It.subdivisionGranularity)})}abortTile(It){return it._(this,void 0,void 0,function*(){const Mt=this.loading,Ut=It.uid;Mt&&Mt[Ut]&&Mt[Ut].abort&&(Mt[Ut].abort.abort(),delete Mt[Ut])})}removeTile(It){return it._(this,void 0,void 0,function*(){this.loaded&&this.loaded[It.uid]&&delete this.loaded[It.uid]})}}class Nl{constructor(){this.loaded={}}loadTile(It){return it._(this,void 0,void 0,function*(){const{uid:Mt,encoding:Ut,rawImageData:he,redFactor:le,greenFactor:Re,blueFactor:te,baseShift:ze}=It,We=he.width+2,ci=he.height+2,ui=it.b(he)?new it.R({width:We,height:ci},yield it.d0(he,-1,-1,We,ci)):he,or=new it.d1(Mt,ui,Ut,le,Re,te,ze);return this.loaded=this.loaded||{},this.loaded[Mt]=or,or})}removeTile(It){const Mt=this.loaded,Ut=It.uid;Mt&&Mt[Ut]&&delete Mt[Ut]}}var nc,Vl,Zr=function(){if(Vl)return nc;function we(Mt,Ut){if(Mt.length!==0){It(Mt[0],Ut);for(var he=1;he<Mt.length;he++)It(Mt[he],!Ut)}}function It(Mt,Ut){for(var he=0,le=0,Re=0,te=Mt.length,ze=te-1;Re<te;ze=Re++){var We=(Mt[Re][0]-Mt[ze][0])*(Mt[ze][1]+Mt[Re][1]),ci=he+We;le+=Math.abs(he)>=Math.abs(We)?he-ci+We:We-ci+he,he=ci}he+le>=0!=!!Ut&&Mt.reverse()}return Vl=1,nc=function Mt(Ut,he){var le,Re=Ut&&Ut.type;if(Re==="FeatureCollection")for(le=0;le<Ut.features.length;le++)Mt(Ut.features[le],he);else if(Re==="GeometryCollection")for(le=0;le<Ut.geometries.length;le++)Mt(Ut.geometries[le],he);else if(Re==="Feature")Mt(Ut.geometry,he);else if(Re==="Polygon")we(Ut.coordinates,he);else if(Re==="MultiPolygon")for(le=0;le<Ut.coordinates.length;le++)we(Ut.coordinates[le],he);return Ut}}(),bh=it.d2(Zr);const ws={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:we=>we},so=Math.fround||(dn=new Float32Array(1),we=>(dn[0]=+we,dn[0]));var dn;class Fo{constructor(It){this.options=Object.assign(Object.create(ws),It),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(It){const{log:Mt,minZoom:Ut,maxZoom:he}=this.options;Mt&&console.time("total time");const le=`prepare ${It.length} points`;Mt&&console.time(le),this.points=It;const Re=[];for(let ze=0;ze<It.length;ze++){const We=It[ze];if(!We.geometry)continue;const[ci,ui]=We.geometry.coordinates,or=so(js(ci)),Ir=so(Js(ui));Re.push(or,Ir,1/0,ze,-1,1),this.options.reduce&&Re.push(0)}let te=this.trees[he+1]=this._createTree(Re);Mt&&console.timeEnd(le);for(let ze=he;ze>=Ut;ze--){const We=+Date.now();te=this.trees[ze]=this._createTree(this._cluster(te,ze)),Mt&&console.log("z%d: %d clusters in %dms",ze,te.numItems,+Date.now()-We)}return Mt&&console.timeEnd("total time"),this}getClusters(It,Mt){let Ut=((It[0]+180)%360+360)%360-180;const he=Math.max(-90,Math.min(90,It[1]));let le=It[2]===180?180:((It[2]+180)%360+360)%360-180;const Re=Math.max(-90,Math.min(90,It[3]));if(It[2]-It[0]>=360)Ut=-180,le=180;else if(Ut>le){const ui=this.getClusters([Ut,he,180,Re],Mt),or=this.getClusters([-180,he,le,Re],Mt);return ui.concat(or)}const te=this.trees[this._limitZoom(Mt)],ze=te.range(js(Ut),Js(Re),js(le),Js(he)),We=te.data,ci=[];for(const ui of ze){const or=this.stride*ui;ci.push(We[or+5]>1?Ln(We,or,this.clusterProps):this.points[We[or+3]])}return ci}getChildren(It){const Mt=this._getOriginId(It),Ut=this._getOriginZoom(It),he="No cluster with the specified id.",le=this.trees[Ut];if(!le)throw new Error(he);const Re=le.data;if(Mt*this.stride>=Re.length)throw new Error(he);const te=this.options.radius/(this.options.extent*Math.pow(2,Ut-1)),ze=le.within(Re[Mt*this.stride],Re[Mt*this.stride+1],te),We=[];for(const ci of ze){const ui=ci*this.stride;Re[ui+4]===It&&We.push(Re[ui+5]>1?Ln(Re,ui,this.clusterProps):this.points[Re[ui+3]])}if(We.length===0)throw new Error(he);return We}getLeaves(It,Mt,Ut){const he=[];return this._appendLeaves(he,It,Mt=Mt||10,Ut=Ut||0,0),he}getTile(It,Mt,Ut){const he=this.trees[this._limitZoom(It)],le=Math.pow(2,It),{extent:Re,radius:te}=this.options,ze=te/Re,We=(Ut-ze)/le,ci=(Ut+1+ze)/le,ui={features:[]};return this._addTileFeatures(he.range((Mt-ze)/le,We,(Mt+1+ze)/le,ci),he.data,Mt,Ut,le,ui),Mt===0&&this._addTileFeatures(he.range(1-ze/le,We,1,ci),he.data,le,Ut,le,ui),Mt===le-1&&this._addTileFeatures(he.range(0,We,ze/le,ci),he.data,-1,Ut,le,ui),ui.features.length?ui:null}getClusterExpansionZoom(It){let Mt=this._getOriginZoom(It)-1;for(;Mt<=this.options.maxZoom;){const Ut=this.getChildren(It);if(Mt++,Ut.length!==1)break;It=Ut[0].properties.cluster_id}return Mt}_appendLeaves(It,Mt,Ut,he,le){const Re=this.getChildren(Mt);for(const te of Re){const ze=te.properties;if(ze&&ze.cluster?le+ze.point_count<=he?le+=ze.point_count:le=this._appendLeaves(It,ze.cluster_id,Ut,he,le):le<he?le++:It.push(te),It.length===Ut)break}return le}_createTree(It){const Mt=new it.aS(It.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Ut=0;Ut<It.length;Ut+=this.stride)Mt.add(It[Ut],It[Ut+1]);return Mt.finish(),Mt.data=It,Mt}_addTileFeatures(It,Mt,Ut,he,le,Re){for(const te of It){const ze=te*this.stride,We=Mt[ze+5]>1;let ci,ui,or;if(We)ci=Ea(Mt,ze,this.clusterProps),ui=Mt[ze],or=Mt[ze+1];else{const bo=this.points[Mt[ze+3]];ci=bo.properties;const[_n,Un]=bo.geometry.coordinates;ui=js(_n),or=Js(Un)}const Ir={type:1,geometry:[[Math.round(this.options.extent*(ui*le-Ut)),Math.round(this.options.extent*(or*le-he))]],tags:ci};let Ae;Ae=We||this.options.generateId?Mt[ze+3]:this.points[Mt[ze+3]].id,Ae!==void 0&&(Ir.id=Ae),Re.features.push(Ir)}}_limitZoom(It){return Math.max(this.options.minZoom,Math.min(Math.floor(+It),this.options.maxZoom+1))}_cluster(It,Mt){const{radius:Ut,extent:he,reduce:le,minPoints:Re}=this.options,te=Ut/(he*Math.pow(2,Mt)),ze=It.data,We=[],ci=this.stride;for(let ui=0;ui<ze.length;ui+=ci){if(ze[ui+2]<=Mt)continue;ze[ui+2]=Mt;const or=ze[ui],Ir=ze[ui+1],Ae=It.within(ze[ui],ze[ui+1],te),bo=ze[ui+5];let _n=bo;for(const Un of Ae){const rr=Un*ci;ze[rr+2]>Mt&&(_n+=ze[rr+5])}if(_n>bo&&_n>=Re){let Un,rr=or*bo,bi=Ir*bo,Bo=-1;const wo=(ui/ci<<5)+(Mt+1)+this.points.length;for(const se of Ae){const st=se*ci;if(ze[st+2]<=Mt)continue;ze[st+2]=Mt;const tt=ze[st+5];rr+=ze[st]*tt,bi+=ze[st+1]*tt,ze[st+4]=wo,le&&(Un||(Un=this._map(ze,ui,!0),Bo=this.clusterProps.length,this.clusterProps.push(Un)),le(Un,this._map(ze,st)))}ze[ui+4]=wo,We.push(rr/_n,bi/_n,1/0,wo,-1,_n),le&&We.push(Bo)}else{for(let Un=0;Un<ci;Un++)We.push(ze[ui+Un]);if(_n>1)for(const Un of Ae){const rr=Un*ci;if(!(ze[rr+2]<=Mt)){ze[rr+2]=Mt;for(let bi=0;bi<ci;bi++)We.push(ze[rr+bi])}}}}return We}_getOriginId(It){return It-this.points.length>>5}_getOriginZoom(It){return(It-this.points.length)%32}_map(It,Mt,Ut){if(It[Mt+5]>1){const Re=this.clusterProps[It[Mt+6]];return Ut?Object.assign({},Re):Re}const he=this.points[It[Mt+3]].properties,le=this.options.map(he);return Ut&&le===he?Object.assign({},le):le}}function Ln(we,It,Mt){return{type:"Feature",id:we[It+3],properties:Ea(we,It,Mt),geometry:{type:"Point",coordinates:[(Ut=we[It],360*(Ut-.5)),Jn(we[It+1])]}};var Ut}function Ea(we,It,Mt){const Ut=we[It+5],he=Ut>=1e4?`${Math.round(Ut/1e3)}k`:Ut>=1e3?Math.round(Ut/100)/10+"k":Ut,le=we[It+6],Re=le===-1?{}:Object.assign({},Mt[le]);return Object.assign(Re,{cluster:!0,cluster_id:we[It+3],point_count:Ut,point_count_abbreviated:he})}function js(we){return we/360+.5}function Js(we){const It=Math.sin(we*Math.PI/180),Mt=.5-.25*Math.log((1+It)/(1-It))/Math.PI;return Mt<0?0:Mt>1?1:Mt}function Jn(we){const It=(180-360*we)*Math.PI/180;return 360*Math.atan(Math.exp(It))/Math.PI-90}function Ks(we,It,Mt,Ut){let he=Ut;const le=It+(Mt-It>>1);let Re,te=Mt-It;const ze=we[It],We=we[It+1],ci=we[Mt],ui=we[Mt+1];for(let or=It+3;or<Mt;or+=3){const Ir=Ul(we[or],we[or+1],ze,We,ci,ui);if(Ir>he)Re=or,he=Ir;else if(Ir===he){const Ae=Math.abs(or-le);Ae<te&&(Re=or,te=Ae)}}he>Ut&&(Re-It>3&&Ks(we,It,Re,Ut),we[Re+2]=he,Mt-Re>3&&Ks(we,Re,Mt,Ut))}function Ul(we,It,Mt,Ut,he,le){let Re=he-Mt,te=le-Ut;if(Re!==0||te!==0){const ze=((we-Mt)*Re+(It-Ut)*te)/(Re*Re+te*te);ze>1?(Mt=he,Ut=le):ze>0&&(Mt+=Re*ze,Ut+=te*ze)}return Re=we-Mt,te=It-Ut,Re*Re+te*te}function Qs(we,It,Mt,Ut){const he={id:we??null,type:It,geometry:Mt,tags:Ut,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(It==="Point"||It==="MultiPoint"||It==="LineString")ja(he,Mt);else if(It==="Polygon")ja(he,Mt[0]);else if(It==="MultiLineString")for(const le of Mt)ja(he,le);else if(It==="MultiPolygon")for(const le of Mt)ja(he,le[0]);return he}function ja(we,It){for(let Mt=0;Mt<It.length;Mt+=3)we.minX=Math.min(we.minX,It[Mt]),we.minY=Math.min(we.minY,It[Mt+1]),we.maxX=Math.max(we.maxX,It[Mt]),we.maxY=Math.max(we.maxY,It[Mt+1])}function Wo(we,It,Mt,Ut){if(!It.geometry)return;const he=It.geometry.coordinates;if(he&&he.length===0)return;const le=It.geometry.type,Re=Math.pow(Mt.tolerance/((1<<Mt.maxZoom)*Mt.extent),2);let te=[],ze=It.id;if(Mt.promoteId?ze=It.properties[Mt.promoteId]:Mt.generateId&&(ze=Ut||0),le==="Point")bn(he,te);else if(le==="MultiPoint")for(const We of he)bn(We,te);else if(le==="LineString")ho(he,te,Re,!1);else if(le==="MultiLineString"){if(Mt.lineMetrics){for(const We of he)te=[],ho(We,te,Re,!1),we.push(Qs(ze,"LineString",te,It.properties));return}qo(he,te,Re,!1)}else if(le==="Polygon")qo(he,te,Re,!0);else{if(le!=="MultiPolygon"){if(le==="GeometryCollection"){for(const We of It.geometry.geometries)Wo(we,{id:ze,geometry:We,properties:It.properties},Mt,Ut);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const We of he){const ci=[];qo(We,ci,Re,!0),te.push(ci)}}we.push(Qs(ze,le,te,It.properties))}function bn(we,It){It.push(ma(we[0]),Kn(we[1]),0)}function ho(we,It,Mt,Ut){let he,le,Re=0;for(let ze=0;ze<we.length;ze++){const We=ma(we[ze][0]),ci=Kn(we[ze][1]);It.push(We,ci,0),ze>0&&(Re+=Ut?(he*ci-We*le)/2:Math.sqrt(Math.pow(We-he,2)+Math.pow(ci-le,2))),he=We,le=ci}const te=It.length-3;It[2]=1,Ks(It,0,te,Mt),It[te+2]=1,It.size=Math.abs(Re),It.start=0,It.end=It.size}function qo(we,It,Mt,Ut){for(let he=0;he<we.length;he++){const le=[];ho(we[he],le,Mt,Ut),It.push(le)}}function ma(we){return we/360+.5}function Kn(we){const It=Math.sin(we*Math.PI/180),Mt=.5-.25*Math.log((1+It)/(1-It))/Math.PI;return Mt<0?0:Mt>1?1:Mt}function vo(we,It,Mt,Ut,he,le,Re,te){if(Ut/=It,le>=(Mt/=It)&&Re<Ut)return we;if(Re<Mt||le>=Ut)return null;const ze=[];for(const We of we){const ci=We.geometry;let ui=We.type;const or=he===0?We.minX:We.minY,Ir=he===0?We.maxX:We.maxY;if(or>=Mt&&Ir<Ut){ze.push(We);continue}if(Ir<Mt||or>=Ut)continue;let Ae=[];if(ui==="Point"||ui==="MultiPoint")ns(ci,Ae,Mt,Ut,he);else if(ui==="LineString")Ds(ci,Ae,Mt,Ut,he,!1,te.lineMetrics);else if(ui==="MultiLineString")Zn(ci,Ae,Mt,Ut,he,!1);else if(ui==="Polygon")Zn(ci,Ae,Mt,Ut,he,!0);else if(ui==="MultiPolygon")for(const bo of ci){const _n=[];Zn(bo,_n,Mt,Ut,he,!0),_n.length&&Ae.push(_n)}if(Ae.length){if(te.lineMetrics&&ui==="LineString"){for(const bo of Ae)ze.push(Qs(We.id,ui,bo,We.tags));continue}ui!=="LineString"&&ui!=="MultiLineString"||(Ae.length===1?(ui="LineString",Ae=Ae[0]):ui="MultiLineString"),ui!=="Point"&&ui!=="MultiPoint"||(ui=Ae.length===3?"Point":"MultiPoint"),ze.push(Qs(We.id,ui,Ae,We.tags))}}return ze.length?ze:null}function ns(we,It,Mt,Ut,he){for(let le=0;le<we.length;le+=3){const Re=we[le+he];Re>=Mt&&Re<=Ut&&el(It,we[le],we[le+1],we[le+2])}}function Ds(we,It,Mt,Ut,he,le,Re){let te=lo(we);const ze=he===0?jl:Ts;let We,ci,ui=we.start;for(let _n=0;_n<we.length-3;_n+=3){const Un=we[_n],rr=we[_n+1],bi=we[_n+2],Bo=we[_n+3],wo=we[_n+4],se=he===0?Un:rr,st=he===0?Bo:wo;let tt=!1;Re&&(We=Math.sqrt(Math.pow(Un-Bo,2)+Math.pow(rr-wo,2))),se<Mt?st>Mt&&(ci=ze(te,Un,rr,Bo,wo,Mt),Re&&(te.start=ui+We*ci)):se>Ut?st<Ut&&(ci=ze(te,Un,rr,Bo,wo,Ut),Re&&(te.start=ui+We*ci)):el(te,Un,rr,bi),st<Mt&&se>=Mt&&(ci=ze(te,Un,rr,Bo,wo,Mt),tt=!0),st>Ut&&se<=Ut&&(ci=ze(te,Un,rr,Bo,wo,Ut),tt=!0),!le&&tt&&(Re&&(te.end=ui+We*ci),It.push(te),te=lo(we)),Re&&(ui+=We)}let or=we.length-3;const Ir=we[or],Ae=we[or+1],bo=he===0?Ir:Ae;bo>=Mt&&bo<=Ut&&el(te,Ir,Ae,we[or+2]),or=te.length-3,le&&or>=3&&(te[or]!==te[0]||te[or+1]!==te[1])&&el(te,te[0],te[1],te[2]),te.length&&It.push(te)}function lo(we){const It=[];return It.size=we.size,It.start=we.start,It.end=we.end,It}function Zn(we,It,Mt,Ut,he,le){for(const Re of we)Ds(Re,It,Mt,Ut,he,le,!1)}function el(we,It,Mt,Ut){we.push(It,Mt,Ut)}function jl(we,It,Mt,Ut,he,le){const Re=(le-It)/(Ut-It);return el(we,le,Mt+(he-Mt)*Re,1),Re}function Ts(we,It,Mt,Ut,he,le){const Re=(le-Mt)/(he-Mt);return el(we,It+(Ut-It)*Re,le,1),Re}function ga(we,It){const Mt=[];for(let Ut=0;Ut<we.length;Ut++){const he=we[Ut],le=he.type;let Re;if(le==="Point"||le==="MultiPoint"||le==="LineString")Re=Gl(he.geometry,It);else if(le==="MultiLineString"||le==="Polygon"){Re=[];for(const te of he.geometry)Re.push(Gl(te,It))}else if(le==="MultiPolygon"){Re=[];for(const te of he.geometry){const ze=[];for(const We of te)ze.push(Gl(We,It));Re.push(ze)}}Mt.push(Qs(he.id,le,Re,he.tags))}return Mt}function Gl(we,It){const Mt=[];Mt.size=we.size,we.start!==void 0&&(Mt.start=we.start,Mt.end=we.end);for(let Ut=0;Ut<we.length;Ut+=3)Mt.push(we[Ut]+It,we[Ut+1],we[Ut+2]);return Mt}function ds(we,It){if(we.transformed)return we;const Mt=1<<we.z,Ut=we.x,he=we.y;for(const le of we.features){const Re=le.geometry,te=le.type;if(le.geometry=[],te===1)for(let ze=0;ze<Re.length;ze+=2)le.geometry.push(Ss(Re[ze],Re[ze+1],It,Mt,Ut,he));else for(let ze=0;ze<Re.length;ze++){const We=[];for(let ci=0;ci<Re[ze].length;ci+=2)We.push(Ss(Re[ze][ci],Re[ze][ci+1],It,Mt,Ut,he));le.geometry.push(We)}}return we.transformed=!0,we}function Ss(we,It,Mt,Ut,he,le){return[Math.round(Mt*(we*Ut-he)),Math.round(Mt*(It*Ut-le))]}function il(we,It,Mt,Ut,he){const le=It===he.maxZoom?0:he.tolerance/((1<<It)*he.extent),Re={features:[],numPoints:0,numSimplified:0,numFeatures:we.length,source:null,x:Mt,y:Ut,z:It,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const te of we)Sl(Re,te,le,he);return Re}function Sl(we,It,Mt,Ut){const he=It.geometry,le=It.type,Re=[];if(we.minX=Math.min(we.minX,It.minX),we.minY=Math.min(we.minY,It.minY),we.maxX=Math.max(we.maxX,It.maxX),we.maxY=Math.max(we.maxY,It.maxY),le==="Point"||le==="MultiPoint")for(let te=0;te<he.length;te+=3)Re.push(he[te],he[te+1]),we.numPoints++,we.numSimplified++;else if(le==="LineString")Il(Re,he,we,Mt,!1,!1);else if(le==="MultiLineString"||le==="Polygon")for(let te=0;te<he.length;te++)Il(Re,he[te],we,Mt,le==="Polygon",te===0);else if(le==="MultiPolygon")for(let te=0;te<he.length;te++){const ze=he[te];for(let We=0;We<ze.length;We++)Il(Re,ze[We],we,Mt,!0,We===0)}if(Re.length){let te=It.tags||null;if(le==="LineString"&&Ut.lineMetrics){te={};for(const We in It.tags)te[We]=It.tags[We];te.mapbox_clip_start=he.start/he.size,te.mapbox_clip_end=he.end/he.size}const ze={geometry:Re,type:le==="Polygon"||le==="MultiPolygon"?3:le==="LineString"||le==="MultiLineString"?2:1,tags:te};It.id!==null&&(ze.id=It.id),we.features.push(ze)}}function Il(we,It,Mt,Ut,he,le){const Re=Ut*Ut;if(Ut>0&&It.size<(he?Re:Ut))return void(Mt.numPoints+=It.length/3);const te=[];for(let ze=0;ze<It.length;ze+=3)(Ut===0||It[ze+2]>Re)&&(Mt.numSimplified++,te.push(It[ze],It[ze+1])),Mt.numPoints++;he&&function(ze,We){let ci=0;for(let ui=0,or=ze.length,Ir=or-2;ui<or;Ir=ui,ui+=2)ci+=(ze[ui]-ze[Ir])*(ze[ui+1]+ze[Ir+1]);if(ci>0===We)for(let ui=0,or=ze.length;ui<or/2;ui+=2){const Ir=ze[ui],Ae=ze[ui+1];ze[ui]=ze[or-2-ui],ze[ui+1]=ze[or-1-ui],ze[or-2-ui]=Ir,ze[or-1-ui]=Ae}}(te,le),we.push(te)}const zs={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class rl{constructor(It,Mt){const Ut=(Mt=this.options=function(le,Re){for(const te in Re)le[te]=Re[te];return le}(Object.create(zs),Mt)).debug;if(Ut&&console.time("preprocess data"),Mt.maxZoom<0||Mt.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Mt.promoteId&&Mt.generateId)throw new Error("promoteId and generateId cannot be used together.");let he=function(le,Re){const te=[];if(le.type==="FeatureCollection")for(let ze=0;ze<le.features.length;ze++)Wo(te,le.features[ze],Re,ze);else Wo(te,le.type==="Feature"?le:{geometry:le},Re);return te}(It,Mt);this.tiles={},this.tileCoords=[],Ut&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Mt.indexMaxZoom,Mt.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),he=function(le,Re){const te=Re.buffer/Re.extent;let ze=le;const We=vo(le,1,-1-te,te,0,-1,2,Re),ci=vo(le,1,1-te,2+te,0,-1,2,Re);return(We||ci)&&(ze=vo(le,1,-te,1+te,0,-1,2,Re)||[],We&&(ze=ga(We,1).concat(ze)),ci&&(ze=ze.concat(ga(ci,-1)))),ze}(he,Mt),he.length&&this.splitTile(he,0,0,0),Ut&&(he.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(It,Mt,Ut,he,le,Re,te){const ze=[It,Mt,Ut,he],We=this.options,ci=We.debug;for(;ze.length;){he=ze.pop(),Ut=ze.pop(),Mt=ze.pop(),It=ze.pop();const ui=1<<Mt,or=Ga(Mt,Ut,he);let Ir=this.tiles[or];if(!Ir&&(ci>1&&console.time("creation"),Ir=this.tiles[or]=il(It,Mt,Ut,he,We),this.tileCoords.push({z:Mt,x:Ut,y:he}),ci)){ci>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Mt,Ut,he,Ir.numFeatures,Ir.numPoints,Ir.numSimplified),console.timeEnd("creation"));const tt=`z${Mt}`;this.stats[tt]=(this.stats[tt]||0)+1,this.total++}if(Ir.source=It,le==null){if(Mt===We.indexMaxZoom||Ir.numPoints<=We.indexMaxPoints)continue}else{if(Mt===We.maxZoom||Mt===le)continue;if(le!=null){const tt=le-Mt;if(Ut!==Re>>tt||he!==te>>tt)continue}}if(Ir.source=null,It.length===0)continue;ci>1&&console.time("clipping");const Ae=.5*We.buffer/We.extent,bo=.5-Ae,_n=.5+Ae,Un=1+Ae;let rr=null,bi=null,Bo=null,wo=null,se=vo(It,ui,Ut-Ae,Ut+_n,0,Ir.minX,Ir.maxX,We),st=vo(It,ui,Ut+bo,Ut+Un,0,Ir.minX,Ir.maxX,We);It=null,se&&(rr=vo(se,ui,he-Ae,he+_n,1,Ir.minY,Ir.maxY,We),bi=vo(se,ui,he+bo,he+Un,1,Ir.minY,Ir.maxY,We),se=null),st&&(Bo=vo(st,ui,he-Ae,he+_n,1,Ir.minY,Ir.maxY,We),wo=vo(st,ui,he+bo,he+Un,1,Ir.minY,Ir.maxY,We),st=null),ci>1&&console.timeEnd("clipping"),ze.push(rr||[],Mt+1,2*Ut,2*he),ze.push(bi||[],Mt+1,2*Ut,2*he+1),ze.push(Bo||[],Mt+1,2*Ut+1,2*he),ze.push(wo||[],Mt+1,2*Ut+1,2*he+1)}}getTile(It,Mt,Ut){It=+It,Mt=+Mt,Ut=+Ut;const he=this.options,{extent:le,debug:Re}=he;if(It<0||It>24)return null;const te=1<<It,ze=Ga(It,Mt=Mt+te&te-1,Ut);if(this.tiles[ze])return ds(this.tiles[ze],le);Re>1&&console.log("drilling down to z%d-%d-%d",It,Mt,Ut);let We,ci=It,ui=Mt,or=Ut;for(;!We&&ci>0;)ci--,ui>>=1,or>>=1,We=this.tiles[Ga(ci,ui,or)];return We&&We.source?(Re>1&&(console.log("found parent tile z%d-%d-%d",ci,ui,or),console.time("drilling down")),this.splitTile(We.source,ci,ui,or,It,Mt,Ut),Re>1&&console.timeEnd("drilling down"),this.tiles[ze]?ds(this.tiles[ze],le):null):null}}function Ga(we,It,Mt){return 32*((1<<we)*Mt+It)+we}class $l extends fa{constructor(It,Mt,Ut,he=Aa){super(It,Mt,Ut),this._dataUpdateable=new Map,this._createGeoJSONIndex=he}loadVectorTile(It,Mt){return it._(this,void 0,void 0,function*(){const Ut=It.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const he=this._geoJSONIndex.getTile(Ut.z,Ut.x,Ut.y);return he?Do(new on(he.features,{version:2,extent:it.a4})):null})}loadData(It){return it._(this,void 0,void 0,function*(){var Mt;(Mt=this._pendingRequest)===null||Mt===void 0||Mt.abort();const Ut=this._startPerformance(It);this._pendingRequest=new AbortController;try{(!this._pendingData||It.request||It.data||It.dataDiff)&&(this._pendingData=this.loadAndProcessGeoJSON(It,this._pendingRequest));const he=yield this._pendingData;this._geoJSONIndex=this._createGeoJSONIndex(he,It),this.loaded={};const le=It.dataDiff&&it.a6(he)?{applyDiff:!0}:{data:he};return this._finishPerformance(Ut,It,le),le}catch(he){if(delete this._pendingRequest,it.cH(he))return{abandoned:!0};throw he}})}_startPerformance(It){var Mt;if(!((Mt=It?.request)===null||Mt===void 0)&&Mt.collectResourceTiming)return new it.c$(It.request)}_finishPerformance(It,Mt,Ut){if(!It)return;const he=It.finish();he&&(Ut.resourceTiming={},Ut.resourceTiming[Mt.source]=JSON.parse(JSON.stringify(he)))}getData(){return it._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(It){const Mt=this.loaded;return Mt&&Mt[It.uid]?super.reloadTile(It):this.loadTile(It)}loadAndProcessGeoJSON(It,Mt){return it._(this,void 0,void 0,function*(){let Ut;if(It.request?Ut=yield this.loadGeoJSONFromUrl(It.request,It.promoteId,Mt):It.data?Ut=this._loadGeoJSONFromObject(It.data,It.promoteId):It.dataDiff&&(Ut=this._loadGeoJSONFromDiff(It.dataDiff,It.promoteId,It.source)),delete this._pendingRequest,typeof Ut!="object")throw new Error(`Input data given to '${It.source}' is not a valid GeoJSON object.`);return bh(Ut,!0),It.filter&&(Ut=this._filterGeoJSON(Ut,It.filter)),Ut})}loadGeoJSONFromUrl(It,Mt,Ut){return it._(this,void 0,void 0,function*(){const he=yield it.j(It,Ut);return this._dataUpdateable=it.a6(he.data,Mt)?it.a7(he.data,Mt):void 0,he.data})}_loadGeoJSONFromObject(It,Mt){return this._dataUpdateable=it.a6(It,Mt)?it.a7(It,Mt):void 0,It}_loadGeoJSONFromDiff(It,Mt,Ut){if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${Ut}`);it.a8(this._dataUpdateable,It,Mt);const he=Array.from(this._dataUpdateable.values());return this._toFeatureCollection(he)}_filterGeoJSON(It,Mt){const Ut=it.d3(Mt,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Ut.result==="error")throw new Error(Ut.value.map(le=>`${le.key}: ${le.message}`).join(", "));const he=It.features.filter(le=>Ut.value.evaluate({zoom:0},le));return this._toFeatureCollection(he)}_toFeatureCollection(It){return{type:"FeatureCollection",features:It}}removeSource(It){return it._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(It){return this._geoJSONIndex.getClusterExpansionZoom(It.clusterId)}getClusterChildren(It){return this._geoJSONIndex.getChildren(It.clusterId)}getClusterLeaves(It){return this._geoJSONIndex.getLeaves(It.clusterId,It.limit,It.offset)}}function Aa(we,It){return It.cluster?new Fo(function({superclusterOptions:Mt,clusterProperties:Ut}){if(!Ut||!Mt)return Mt;const he={},le={},Re={accumulated:null,zoom:0},te={properties:null},ze=Object.keys(Ut);for(const We of ze){const[ci,ui]=Ut[We],or=it.d3(ui),Ir=it.d3(typeof ci=="string"?[ci,["accumulated"],["get",We]]:ci);he[We]=or.value,le[We]=Ir.value}return Mt.map=We=>{te.properties=We;const ci={};for(const ui of ze)ci[ui]=he[ui].evaluate(Re,te);return ci},Mt.reduce=(We,ci)=>{te.properties=ci;for(const ui of ze)Re.accumulated=We[ui],We[ui]=le[ui].evaluate(Re,te)},Mt}(It)).load(we.features):function(Mt,Ut){return new rl(Mt,Ut)}(we,It.geojsonVtOptions)}class Hn{constructor(It){this.self=It,this.actor=new it.L(It),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.globalStates=new Map,this.self.registerWorkerSource=(Mt,Ut)=>{if(this.externalWorkerSourceTypes[Mt])throw new Error(`Worker source with name "${Mt}" already registered.`);this.externalWorkerSourceTypes[Mt]=Ut},this.self.addProtocol=it.cJ,this.self.removeProtocol=it.cK,this.self.registerRTLTextPlugin=Mt=>{it.d4.setMethods(Mt)},this.actor.registerMessageHandler("LDT",(Mt,Ut)=>this._getDEMWorkerSource(Mt,Ut.source).loadTile(Ut)),this.actor.registerMessageHandler("RDT",(Mt,Ut)=>it._(this,void 0,void 0,function*(){this._getDEMWorkerSource(Mt,Ut.source).removeTile(Ut)})),this.actor.registerMessageHandler("GCEZ",(Mt,Ut)=>it._(this,void 0,void 0,function*(){return this._getWorkerSource(Mt,Ut.type,Ut.source).getClusterExpansionZoom(Ut)})),this.actor.registerMessageHandler("GCC",(Mt,Ut)=>it._(this,void 0,void 0,function*(){return this._getWorkerSource(Mt,Ut.type,Ut.source).getClusterChildren(Ut)})),this.actor.registerMessageHandler("GCL",(Mt,Ut)=>it._(this,void 0,void 0,function*(){return this._getWorkerSource(Mt,Ut.type,Ut.source).getClusterLeaves(Ut)})),this.actor.registerMessageHandler("LD",(Mt,Ut)=>this._getWorkerSource(Mt,Ut.type,Ut.source).loadData(Ut)),this.actor.registerMessageHandler("GD",(Mt,Ut)=>this._getWorkerSource(Mt,Ut.type,Ut.source).getData()),this.actor.registerMessageHandler("LT",(Mt,Ut)=>this._getWorkerSource(Mt,Ut.type,Ut.source).loadTile(Ut)),this.actor.registerMessageHandler("RT",(Mt,Ut)=>this._getWorkerSource(Mt,Ut.type,Ut.source).reloadTile(Ut)),this.actor.registerMessageHandler("AT",(Mt,Ut)=>this._getWorkerSource(Mt,Ut.type,Ut.source).abortTile(Ut)),this.actor.registerMessageHandler("RMT",(Mt,Ut)=>this._getWorkerSource(Mt,Ut.type,Ut.source).removeTile(Ut)),this.actor.registerMessageHandler("RS",(Mt,Ut)=>it._(this,void 0,void 0,function*(){if(!this.workerSources[Mt]||!this.workerSources[Mt][Ut.type]||!this.workerSources[Mt][Ut.type][Ut.source])return;const he=this.workerSources[Mt][Ut.type][Ut.source];delete this.workerSources[Mt][Ut.type][Ut.source],he.removeSource!==void 0&&he.removeSource(Ut)})),this.actor.registerMessageHandler("RM",Mt=>it._(this,void 0,void 0,function*(){delete this.layerIndexes[Mt],delete this.availableImages[Mt],delete this.workerSources[Mt],delete this.demWorkerSources[Mt],this.globalStates.delete(Mt)})),this.actor.registerMessageHandler("SR",(Mt,Ut)=>it._(this,void 0,void 0,function*(){this.referrer=Ut})),this.actor.registerMessageHandler("SRPS",(Mt,Ut)=>this._syncRTLPluginState(Mt,Ut)),this.actor.registerMessageHandler("IS",(Mt,Ut)=>it._(this,void 0,void 0,function*(){this.self.importScripts(Ut)})),this.actor.registerMessageHandler("SI",(Mt,Ut)=>this._setImages(Mt,Ut)),this.actor.registerMessageHandler("UL",(Mt,Ut)=>it._(this,void 0,void 0,function*(){this._getLayerIndex(Mt).update(Ut.layers,Ut.removedIds,this._getGlobalState(Mt))})),this.actor.registerMessageHandler("UGS",(Mt,Ut)=>it._(this,void 0,void 0,function*(){const he=this._getGlobalState(Mt);for(const le in Ut)he[le]=Ut[le]})),this.actor.registerMessageHandler("SL",(Mt,Ut)=>it._(this,void 0,void 0,function*(){this._getLayerIndex(Mt).replace(Ut,this._getGlobalState(Mt))}))}_getGlobalState(It){let Mt=this.globalStates.get(It);return Mt||(Mt={},this.globalStates.set(It,Mt)),Mt}_setImages(It,Mt){return it._(this,void 0,void 0,function*(){this.availableImages[It]=Mt;for(const Ut in this.workerSources[It]){const he=this.workerSources[It][Ut];for(const le in he)he[le].availableImages=Mt}})}_syncRTLPluginState(It,Mt){return it._(this,void 0,void 0,function*(){return yield it.d4.syncState(Mt,this.self.importScripts)})}_getAvailableImages(It){let Mt=this.availableImages[It];return Mt||(Mt=[]),Mt}_getLayerIndex(It){let Mt=this.layerIndexes[It];return Mt||(Mt=this.layerIndexes[It]=new i),Mt}_getWorkerSource(It,Mt,Ut){if(this.workerSources[It]||(this.workerSources[It]={}),this.workerSources[It][Mt]||(this.workerSources[It][Mt]={}),!this.workerSources[It][Mt][Ut]){const he={sendAsync:(le,Re)=>(le.targetMapId=It,this.actor.sendAsync(le,Re))};switch(Mt){case"vector":this.workerSources[It][Mt][Ut]=new fa(he,this._getLayerIndex(It),this._getAvailableImages(It));break;case"geojson":this.workerSources[It][Mt][Ut]=new $l(he,this._getLayerIndex(It),this._getAvailableImages(It));break;default:this.workerSources[It][Mt][Ut]=new this.externalWorkerSourceTypes[Mt](he,this._getLayerIndex(It),this._getAvailableImages(It))}}return this.workerSources[It][Mt][Ut]}_getDEMWorkerSource(It,Mt){return this.demWorkerSources[It]||(this.demWorkerSources[It]={}),this.demWorkerSources[It][Mt]||(this.demWorkerSources[It][Mt]=new Nl),this.demWorkerSources[It][Mt]}}return it.i(self)&&(self.worker=new Hn(self)),Hn}),Dt("index",["exports","./shared"],function(it,i){var Pe="5.13.0";function yi(){var C=new i.A(4);return i.A!=Float32Array&&(C[1]=0,C[2]=0),C[0]=1,C[3]=1,C}let tr,vn,on;const Br={frame(C,s,d){const v=requestAnimationFrame(D=>{S(),s(D)}),{unsubscribe:S}=i.s(C.signal,"abort",()=>{S(),cancelAnimationFrame(v),d(i.c())},!1)},frameAsync(C){return new Promise((s,d)=>{this.frame(C,s,d)})},getImageData(C,s=0){return this.getImageCanvasContext(C).getImageData(-s,-s,C.width+2*s,C.height+2*s)},getImageCanvasContext(C){const s=window.document.createElement("canvas"),d=s.getContext("2d",{willReadFrequently:!0});if(!d)throw new Error("failed to create canvas 2d context");return s.width=C.width,s.height=C.height,d.drawImage(C,0,0,C.width,C.height),d},resolveURL:C=>(tr||(tr=document.createElement("a")),tr.href=C,tr.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return on!==void 0?on:!!matchMedia&&(vn==null&&(vn=matchMedia("(prefers-reduced-motion: reduce)")),vn.matches)},set prefersReducedMotion(C){on=C}},Or=new class{constructor(){this._realTime=typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),this._frozenAt=null}getCurrentTime(){return this._frozenAt!==null?this._frozenAt:this._realTime()}setNow(C){this._frozenAt=C}restoreNow(){this._frozenAt=null}isFrozen(){return this._frozenAt!==null}};function Ri(){return Or.getCurrentTime()}class Ve{static testProp(s){if(!Ve.docStyle)return s[0];for(let d=0;d<s.length;d++)if(s[d]in Ve.docStyle)return s[d];return s[0]}static create(s,d,v){const S=window.document.createElement(s);return d!==void 0&&(S.className=d),v&&v.appendChild(S),S}static createNS(s,d){return window.document.createElementNS(s,d)}static disableDrag(){Ve.docStyle&&Ve.selectProp&&(Ve.userSelect=Ve.docStyle[Ve.selectProp],Ve.docStyle[Ve.selectProp]="none")}static enableDrag(){Ve.docStyle&&Ve.selectProp&&(Ve.docStyle[Ve.selectProp]=Ve.userSelect)}static setTransform(s,d){s.style[Ve.transformProp]=d}static addEventListener(s,d,v,S={}){s.addEventListener(d,v,"passive"in S?S:S.capture)}static removeEventListener(s,d,v,S={}){s.removeEventListener(d,v,"passive"in S?S:S.capture)}static suppressClickInternal(s){s.preventDefault(),s.stopPropagation(),window.removeEventListener("click",Ve.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",Ve.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",Ve.suppressClickInternal,!0)},0)}static getScale(s){const d=s.getBoundingClientRect();return{x:d.width/s.offsetWidth||1,y:d.height/s.offsetHeight||1,boundingClientRect:d}}static getPoint(s,d,v){const S=d.boundingClientRect;return new i.P((v.clientX-S.left)/d.x-s.clientLeft,(v.clientY-S.top)/d.y-s.clientTop)}static mousePos(s,d){const v=Ve.getScale(s);return Ve.getPoint(s,v,d)}static touchPos(s,d){const v=[],S=Ve.getScale(s);for(let D=0;D<d.length;D++)v.push(Ve.getPoint(s,S,d[D]));return v}static mouseButton(s){return s.button}static remove(s){s.parentNode&&s.parentNode.removeChild(s)}static sanitize(s){const d=new DOMParser().parseFromString(s,"text/html").body||document.createElement("body"),v=d.querySelectorAll("script");for(const S of v)S.remove();return Ve.clean(d),d.innerHTML}static isPossiblyDangerous(s,d){const v=d.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(s)||!v.includes("javascript:")&&!v.includes("data:"))||!!s.startsWith("on")||void 0}static clean(s){const d=s.children;for(const v of d)Ve.removeAttributes(v),Ve.clean(v)}static removeAttributes(s){for(const{name:d,value:v}of s.attributes)Ve.isPossiblyDangerous(d,v)&&s.removeAttribute(d)}}Ve.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,Ve.selectProp=Ve.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),Ve.transformProp=Ve.testProp(["transform","WebkitTransform"]);const Io={supported:!1,testSupport:function(C){!Fn&&Yr&&(us?ao(C):gr=C)}};let gr,Yr,Fn=!1,us=!1;function ao(C){const s=C.createTexture();C.bindTexture(C.TEXTURE_2D,s);try{if(C.texImage2D(C.TEXTURE_2D,0,C.RGBA,C.RGBA,C.UNSIGNED_BYTE,Yr),C.isContextLost())return;Io.supported=!0}catch{}C.deleteTexture(s),Fn=!0}var Do;typeof document<"u"&&(Yr=document.createElement("img"),Yr.onload=()=>{gr&&ao(gr),gr=null,us=!0},Yr.onerror=()=>{Fn=!0,gr=null},Yr.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(C){let s,d,v,S;C.resetRequestQueue=()=>{s=[],d=0,v=0,S={}},C.addThrottleControl=H=>{const J=v++;return S[J]=H,J},C.removeThrottleControl=H=>{delete S[H],k()},C.getImage=(H,J,et=!0)=>new Promise((mt,ut)=>{Io.supported&&(H.headers||(H.headers={}),H.headers.accept="image/webp,*/*"),i.e(H,{type:"image"}),s.push({abortController:J,requestParameters:H,supportImageRefresh:et,state:"queued",onError:St=>{ut(St)},onSuccess:St=>{mt(St)}}),k()});const D=H=>i._(this,void 0,void 0,function*(){H.state="running";const{requestParameters:J,supportImageRefresh:et,onError:mt,onSuccess:ut,abortController:St}=H,pt=et===!1&&!i.i(self)&&!i.g(J.url)&&(!J.headers||Object.keys(J.headers).reduce((Xt,ft)=>Xt&&ft==="accept",!0));d++;const Et=pt?j(J,St):i.m(J,St);try{const Xt=yield Et;delete H.abortController,H.state="completed",Xt.data instanceof HTMLImageElement||i.b(Xt.data)?ut(Xt):Xt.data&&ut({data:yield(Kt=Xt.data,typeof createImageBitmap=="function"?i.f(Kt):i.h(Kt)),cacheControl:Xt.cacheControl,expires:Xt.expires})}catch(Xt){delete H.abortController,mt(Xt)}finally{d--,k()}var Kt}),k=()=>{const H=(()=>{for(const J of Object.keys(S))if(S[J]())return!0;return!1})()?i.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:i.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let J=d;J<H&&s.length>0;J++){const et=s.shift();et.abortController.signal.aborted?J--:D(et)}},j=(H,J)=>new Promise((et,mt)=>{const ut=new Image,St=H.url,pt=H.credentials;pt&&pt==="include"?ut.crossOrigin="use-credentials":(pt&&pt==="same-origin"||!i.d(St))&&(ut.crossOrigin="anonymous"),J.signal.addEventListener("abort",()=>{ut.src="",mt(i.c())}),ut.fetchPriority="high",ut.onload=()=>{ut.onerror=ut.onload=null,et({data:ut})},ut.onerror=()=>{ut.onerror=ut.onload=null,J.signal.aborted||mt(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},ut.src=St})}(Do||(Do={})),Do.resetRequestQueue();class tl{constructor(s){this._transformRequestFn=s??null}transformRequest(s,d){return this._transformRequestFn&&this._transformRequestFn(s,d)||{url:s}}setTransformRequest(s){this._transformRequestFn=s}}function fa(C){const s=[];if(typeof C=="string")s.push({id:"default",url:C});else if(C&&C.length>0){const d=[];for(const{id:v,url:S}of C){const D=`${v}${S}`;d.indexOf(D)===-1&&(d.push(D),s.push({id:v,url:S}))}}return s}function Nl(C,s,d){try{const v=new URL(C);return v.pathname+=`${s}${d}`,v.toString()}catch{throw new Error(`Invalid sprite URL "${C}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}function nc(C){const{userImage:s}=C;return!!(s&&s.render&&s.render())&&(C.data.replace(new Uint8Array(s.data.buffer)),!0)}class Vl extends i.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new i.R({width:1,height:1}),this.dirty=!0}destroy(){this.atlasTexture&&(this.atlasTexture.destroy(),this.atlasTexture=null);for(const s of Object.keys(this.images))this.removeImage(s);this.patterns={},this.atlasImage=new i.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(s){if(this.loaded!==s&&(this.loaded=s,s)){for(const{ids:d,promiseResolve:v}of this.requestors)v(this._getImagesForIds(d));this.requestors=[]}}getImage(s){const d=this.images[s];if(d&&!d.data&&d.spriteData){const v=d.spriteData;d.data=new i.R({width:v.width,height:v.height},v.context.getImageData(v.x,v.y,v.width,v.height).data),d.spriteData=null}return d}addImage(s,d){if(this.images[s])throw new Error(`Image id ${s} already exist, use updateImage instead`);this._validate(s,d)&&(this.images[s]=d)}_validate(s,d){let v=!0;const S=d.data||d.spriteData;return this._validateStretch(d.stretchX,S&&S.width)||(this.fire(new i.k(new Error(`Image "${s}" has invalid "stretchX" value`))),v=!1),this._validateStretch(d.stretchY,S&&S.height)||(this.fire(new i.k(new Error(`Image "${s}" has invalid "stretchY" value`))),v=!1),this._validateContent(d.content,d)||(this.fire(new i.k(new Error(`Image "${s}" has invalid "content" value`))),v=!1),v}_validateStretch(s,d){if(!s)return!0;let v=0;for(const S of s){if(S[0]<v||S[1]<S[0]||d<S[1])return!1;v=S[1]}return!0}_validateContent(s,d){if(!s)return!0;if(s.length!==4)return!1;const v=d.spriteData,S=v&&v.width||d.data.width,D=v&&v.height||d.data.height;return!(s[0]<0||S<s[0]||s[1]<0||D<s[1]||s[2]<0||S<s[2]||s[3]<0||D<s[3]||s[2]<s[0]||s[3]<s[1])}updateImage(s,d,v=!0){const S=this.getImage(s);if(v&&(S.data.width!==d.data.width||S.data.height!==d.data.height))throw new Error(`size mismatch between old image (${S.data.width}x${S.data.height}) and new image (${d.data.width}x${d.data.height}).`);d.version=S.version+1,this.images[s]=d,this.updatedImages[s]=!0}removeImage(s){const d=this.images[s];delete this.images[s],delete this.patterns[s],d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(s){return new Promise((d,v)=>{let S=!0;if(!this.isLoaded())for(const D of s)this.images[D]||(S=!1);this.isLoaded()||S?d(this._getImagesForIds(s)):this.requestors.push({ids:s,promiseResolve:d})})}_getImagesForIds(s){const d={};for(const v of s){let S=this.getImage(v);S||(this.fire(new i.l("styleimagemissing",{id:v})),S=this.getImage(v)),S?d[v]={data:S.data.clone(),pixelRatio:S.pixelRatio,sdf:S.sdf,version:S.version,stretchX:S.stretchX,stretchY:S.stretchY,content:S.content,textFitWidth:S.textFitWidth,textFitHeight:S.textFitHeight,hasRenderCallback:!!(S.userImage&&S.userImage.render)}:i.w(`Image "${v}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return d}getPixelSize(){const{width:s,height:d}=this.atlasImage;return{width:s,height:d}}getPattern(s){const d=this.patterns[s],v=this.getImage(s);if(!v)return null;if(d&&d.position.version===v.version)return d.position;if(d)d.position.version=v.version;else{const S={w:v.data.width+2,h:v.data.height+2,x:0,y:0},D=new i.I(S,v);this.patterns[s]={bin:S,position:D}}return this._updatePatternAtlas(),this.patterns[s].position}bind(s){const d=s.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new i.T(s,this.atlasImage,d.RGBA),this.atlasTexture.bind(d.LINEAR,d.CLAMP_TO_EDGE)}_updatePatternAtlas(){const s=[];for(const D in this.patterns)s.push(this.patterns[D].bin);const{w:d,h:v}=i.p(s),S=this.atlasImage;S.resize({width:d||1,height:v||1});for(const D in this.patterns){const{bin:k}=this.patterns[D],j=k.x+1,H=k.y+1,J=this.getImage(D).data,et=J.width,mt=J.height;i.R.copy(J,S,{x:0,y:0},{x:j,y:H},{width:et,height:mt}),i.R.copy(J,S,{x:0,y:mt-1},{x:j,y:H-1},{width:et,height:1}),i.R.copy(J,S,{x:0,y:0},{x:j,y:H+mt},{width:et,height:1}),i.R.copy(J,S,{x:et-1,y:0},{x:j-1,y:H},{width:1,height:mt}),i.R.copy(J,S,{x:0,y:0},{x:j+et,y:H},{width:1,height:mt})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(s){for(const d of s){if(this.callbackDispatchedThisFrame[d])continue;this.callbackDispatchedThisFrame[d]=!0;const v=this.getImage(d);v||i.w(`Image with ID: "${d}" was not found`),nc(v)&&this.updateImage(d,v)}}cloneImages(){const s={};for(const d in this.images){const v=this.images[d];s[d]=Object.assign(Object.assign({},v),{data:v.data?v.data.clone():null})}return s}}const Zr=1e20;function bh(C,s,d,v,S,D,k,j,H){for(let J=s;J<s+v;J++)ws(C,d*D+J,D,S,k,j,H);for(let J=d;J<d+S;J++)ws(C,J*D+s,1,v,k,j,H)}function ws(C,s,d,v,S,D,k){D[0]=0,k[0]=-Zr,k[1]=Zr,S[0]=C[s];for(let j=1,H=0,J=0;j<v;j++){S[j]=C[s+j*d];const et=j*j;do{const mt=D[H];J=(S[j]-S[mt]+et-mt*mt)/(j-mt)/2}while(J<=k[H]&&--H>-1);H++,D[H]=j,k[H]=J,k[H+1]=Zr}for(let j=0,H=0;j<v;j++){for(;k[H+1]<j;)H++;const J=D[H],et=j-J;C[s+j*d]=S[J]+et*et}}const so=i.v.layout_symbol["text-font"].default.join(",");class dn{constructor(s,d,v){this.requestManager=s,this.localIdeographFontFamily=d,this.entries={},this.lang=v}setURL(s){this.url=s}getGlyphs(s){return i._(this,void 0,void 0,function*(){const d=[];for(const D in s)for(const k of s[D])d.push(this._getAndCacheGlyphsPromise(D,k));const v=yield Promise.all(d),S={};for(const{stack:D,id:k,glyph:j}of v)S[D]||(S[D]={}),S[D][k]=j&&{id:j.id,bitmap:j.bitmap.clone(),metrics:j.metrics};return S})}_getAndCacheGlyphsPromise(s,d){return i._(this,void 0,void 0,function*(){let v=this.entries[s];v||(v=this.entries[s]={glyphs:{},requests:{},ranges:{}});let S=v.glyphs[d];return S!==void 0?{stack:s,id:d,glyph:S}:!this.url||this._charUsesLocalIdeographFontFamily(d)?(S=v.glyphs[d]=this._drawGlyph(v,s,d),{stack:s,id:d,glyph:S}):yield this._downloadAndCacheRangePromise(s,d)})}_downloadAndCacheRangePromise(s,d){return i._(this,void 0,void 0,function*(){const v=this.entries[s],S=Math.floor(d/256);if(v.ranges[S])return{stack:s,id:d,glyph:null};if(!v.requests[S]){const D=dn.loadGlyphRange(s,S,this.url,this.requestManager);v.requests[S]=D}try{const D=yield v.requests[S];for(const k in D)v.glyphs[+k]=D[+k];return v.ranges[S]=!0,{stack:s,id:d,glyph:D[d]||null}}catch(D){const k=v.glyphs[d]=this._drawGlyph(v,s,d);return this._warnOnMissingGlyphRange(k,S,d,D),{stack:s,id:d,glyph:k}}})}_warnOnMissingGlyphRange(s,d,v,S){const D=256*d,k=D+255,j=v.toString(16).padStart(4,"0").toUpperCase();i.w(`Unable to load glyph range ${d}, ${D}-${k}. Rendering codepoint U+${j} locally instead. ${S}`)}_charUsesLocalIdeographFontFamily(s){return!!this.localIdeographFontFamily&&i.q(s)}_drawGlyph(s,d,v){const S=d===so&&this.localIdeographFontFamily!==""&&this._charUsesLocalIdeographFontFamily(v),D=S?"ideographTinySDF":"tinySDF";s[D]||(s[D]=this._createTinySDF(S?this.localIdeographFontFamily:d));const k=s[D].draw(String.fromCodePoint(v));return{id:v,bitmap:new i.r({width:k.width||60,height:k.height||60},k.data),metrics:{width:k.glyphWidth/2||24,height:k.glyphHeight/2||24,left:k.glyphLeft/2+.5||0,top:k.glyphTop/2-27.5||-8,advance:k.glyphAdvance/2||24,isDoubleResolution:!0}}}_createTinySDF(s){const d=s?s.split(","):[];d.push("sans-serif");const v=d.map(S=>/[-\w]+/.test(S)?S:`'${CSS.escape(S)}'`).join(",");return new dn.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:v,fontWeight:this._fontWeight(d[0]),fontStyle:this._fontStyle(d[0]),lang:this.lang})}_fontStyle(s){return/italic/i.test(s)?"italic":/oblique/i.test(s)?"oblique":"normal"}_fontWeight(s){const d={thin:100,hairline:100,"extra light":200,"ultra light":200,light:300,normal:400,regular:400,medium:500,semibold:600,demibold:600,bold:700,"extra bold":800,"ultra bold":800,black:900,heavy:900,"extra black":950,"ultra black":950};let v;for(const[S,D]of Object.entries(d))new RegExp(`\\b${S}\\b`,"i").test(s)&&(v=`${D}`);return v}destroy(){for(const s in this.entries){const d=this.entries[s];d.tinySDF&&(d.tinySDF=null),d.ideographTinySDF&&(d.ideographTinySDF=null),d.glyphs={},d.requests={},d.ranges={}}this.entries={}}}dn.loadGlyphRange=function(C,s,d,v){return i._(this,void 0,void 0,function*(){const S=256*s,D=S+255,k=v.transformRequest(d.replace("{fontstack}",C).replace("{range}",`${S}-${D}`),"Glyphs"),j=yield i.n(k,new AbortController);if(!j||!j.data)throw new Error(`Could not load glyph range. range: ${s}, ${S}-${D}`);const H={};for(const J of i.o(j.data))H[J.id]=J;return H})},dn.TinySDF=class{constructor({fontSize:C=24,buffer:s=3,radius:d=8,cutoff:v=.25,fontFamily:S="sans-serif",fontWeight:D="normal",fontStyle:k="normal",lang:j=null}={}){this.buffer=s,this.cutoff=v,this.radius=d,this.lang=j;const H=this.size=C+4*s,J=this._createCanvas(H),et=this.ctx=J.getContext("2d",{willReadFrequently:!0});et.font=`${k} ${D} ${C}px ${S}`,et.textBaseline="alphabetic",et.textAlign="left",et.fillStyle="black",this.gridOuter=new Float64Array(H*H),this.gridInner=new Float64Array(H*H),this.f=new Float64Array(H),this.z=new Float64Array(H+1),this.v=new Uint16Array(H)}_createCanvas(C){const s=document.createElement("canvas");return s.width=s.height=C,s}draw(C){const{width:s,actualBoundingBoxAscent:d,actualBoundingBoxDescent:v,actualBoundingBoxLeft:S,actualBoundingBoxRight:D}=this.ctx.measureText(C),k=Math.ceil(d),j=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(D-S))),H=Math.min(this.size-this.buffer,k+Math.ceil(v)),J=j+2*this.buffer,et=H+2*this.buffer,mt=Math.max(J*et,0),ut=new Uint8ClampedArray(mt),St={data:ut,width:J,height:et,glyphWidth:j,glyphHeight:H,glyphTop:k,glyphLeft:0,glyphAdvance:s};if(j===0||H===0)return St;const{ctx:pt,buffer:Et,gridInner:Kt,gridOuter:Xt}=this;this.lang&&(pt.lang=this.lang),pt.clearRect(Et,Et,j,H),pt.fillText(C,Et,Et+k);const ft=pt.getImageData(Et,Et,j,H);Xt.fill(Zr,0,mt),Kt.fill(0,0,mt);for(let _e=0;_e<H;_e++)for(let ce=0;ce<j;ce++){const me=ft.data[4*(_e*j+ce)+3]/255;if(me===0)continue;const be=(_e+Et)*J+ce+Et;if(me===1)Xt[be]=0,Kt[be]=Zr;else{const de=.5-me;Xt[be]=de>0?de*de:0,Kt[be]=de<0?de*de:0}}bh(Xt,0,0,J,et,J,this.f,this.v,this.z),bh(Kt,Et,Et,j,H,J,this.f,this.v,this.z);for(let _e=0;_e<mt;_e++){const ce=Math.sqrt(Xt[_e])-Math.sqrt(Kt[_e]);ut[_e]=Math.round(255-255*(ce/this.radius+this.cutoff))}return St}};class Fo{constructor(){this.specification=i.u.light.position}possiblyEvaluate(s,d){return i.F(s.expression.evaluate(d))}interpolate(s,d,v){return{x:i.G.number(s.x,d.x,v),y:i.G.number(s.y,d.y,v),z:i.G.number(s.z,d.z,v)}}}let Ln;class Ea extends i.E{constructor(s){super(),Ln=Ln||new i.t({anchor:new i.D(i.u.light.anchor),position:new Fo,color:new i.D(i.u.light.color),intensity:new i.D(i.u.light.intensity)}),this._transitionable=new i.x(Ln,void 0),this.setLight(s),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(s,d={}){if(!this._validate(i.y,s,d))for(const v in s){const S=s[v];v.endsWith(i.z)?this._transitionable.setTransition(v.slice(0,-i.z.length),S):this._transitionable.setValue(v,S)}}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}_validate(s,d,v){return(!v||v.validate!==!1)&&i.B(this,s.call(i.C,{value:d,style:{glyphs:!0,sprite:!0},styleSpec:i.u}))}}const js=new i.t({"sky-color":new i.D(i.u.sky["sky-color"]),"horizon-color":new i.D(i.u.sky["horizon-color"]),"fog-color":new i.D(i.u.sky["fog-color"]),"fog-ground-blend":new i.D(i.u.sky["fog-ground-blend"]),"horizon-fog-blend":new i.D(i.u.sky["horizon-fog-blend"]),"sky-horizon-blend":new i.D(i.u.sky["sky-horizon-blend"]),"atmosphere-blend":new i.D(i.u.sky["atmosphere-blend"])});class Js extends i.E{constructor(s){super(),this._transitionable=new i.x(js,void 0),this.setSky(s),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new i.H(0))}setSky(s,d={}){if(!this._validate(i.J,s,d)){s||(s={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const v in s){const S=s[v];v.endsWith(i.z)?this._transitionable.setTransition(v.slice(0,-i.z.length),S):this._transitionable.setValue(v,S)}}}getSky(){return this._transitionable.serialize()}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}_validate(s,d,v={}){return v?.validate!==!1&&i.B(this,s.call(i.C,i.e({value:d,style:{glyphs:!0,sprite:!0},styleSpec:i.u})))}calculateFogBlendOpacity(s){return s<60?0:s<70?(s-60)/10:1}}class Jn{constructor(s,d){this.width=s,this.height=d,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(s,d){const v=s.join(",")+String(d);return this.dashEntry[v]||(this.dashEntry[v]=this.addDash(s,d)),this.dashEntry[v]}getDashRanges(s,d,v){const S=[];let D=s.length%2==1?-s[s.length-1]*v:0,k=s[0]*v,j=!0;S.push({left:D,right:k,isDash:j,zeroLength:s[0]===0});let H=s[0];for(let J=1;J<s.length;J++){j=!j;const et=s[J];D=H*v,H+=et,k=H*v,S.push({left:D,right:k,isDash:j,zeroLength:et===0})}return S}addRoundDash(s,d,v){const S=d/2;for(let D=-v;D<=v;D++){const k=this.width*(this.nextRow+v+D);let j=0,H=s[j];for(let J=0;J<this.width;J++){J/H.right>1&&(H=s[++j]);const et=Math.abs(J-H.left),mt=Math.abs(J-H.right),ut=Math.min(et,mt);let St;const pt=D/v*(S+1);if(H.isDash){const Et=S-Math.abs(pt);St=Math.sqrt(ut*ut+Et*Et)}else St=S-Math.sqrt(ut*ut+pt*pt);this.data[k+J]=Math.max(0,Math.min(255,St+128))}}}addRegularDash(s){for(let j=s.length-1;j>=0;--j){const H=s[j],J=s[j+1];H.zeroLength?s.splice(j,1):J&&J.isDash===H.isDash&&(J.left=H.left,s.splice(j,1))}const d=s[0],v=s[s.length-1];d.isDash===v.isDash&&(d.left=v.left-this.width,v.right=d.right+this.width);const S=this.width*this.nextRow;let D=0,k=s[D];for(let j=0;j<this.width;j++){j/k.right>1&&(k=s[++D]);const H=Math.abs(j-k.left),J=Math.abs(j-k.right),et=Math.min(H,J);this.data[S+j]=Math.max(0,Math.min(255,(k.isDash?et:-et)+128))}}addDash(s,d){const v=d?7:0,S=2*v+1;if(this.nextRow+S>this.height)return i.w("LineAtlas out of space"),null;let D=0;for(let j=0;j<s.length;j++)D+=s[j];if(D!==0){const j=this.width/D,H=this.getDashRanges(s,this.width,j);d?this.addRoundDash(H,j,v):this.addRegularDash(H)}const k={y:this.nextRow+v,height:2*v,width:D};return this.nextRow+=S,this.dirty=!0,k}bind(s){const d=s.gl;this.texture?(d.bindTexture(d.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,d.texSubImage2D(d.TEXTURE_2D,0,0,0,this.width,this.height,d.ALPHA,d.UNSIGNED_BYTE,this.data))):(this.texture=d.createTexture(),d.bindTexture(d.TEXTURE_2D,this.texture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texImage2D(d.TEXTURE_2D,0,d.ALPHA,this.width,this.height,0,d.ALPHA,d.UNSIGNED_BYTE,this.data))}}const Ks="maplibre_preloaded_worker_pool";class Ul{constructor(){this.active={}}acquire(s){if(!this.workers)for(this.workers=[];this.workers.length<Ul.workerCount;)this.workers.push(new Worker(i.a.WORKER_URL));return this.active[s]=!0,this.workers.slice()}release(s){delete this.active[s],this.numActive()===0&&(this.workers.forEach(d=>{d.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Ks]}numActive(){return Object.keys(this.active).length}}const Qs=Math.floor(Br.hardwareConcurrency/2);let ja,Wo;function bn(){return ja||(ja=new Ul),ja}Ul.workerCount=i.K(globalThis)?Math.max(Math.min(Qs,3),1):1;class ho{constructor(s,d){this.workerPool=s,this.actors=[],this.currentActor=0,this.id=d;const v=this.workerPool.acquire(d);for(let S=0;S<v.length;S++){const D=new i.L(v[S],d);D.name=`Worker ${S}`,this.actors.push(D)}if(!this.actors.length)throw new Error("No actors found")}broadcast(s,d){const v=[];for(const S of this.actors)v.push(S.sendAsync({type:s,data:d}));return Promise.all(v)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(s=!0){this.actors.forEach(d=>{d.remove()}),this.actors=[],s&&this.workerPool.release(this.id)}registerMessageHandler(s,d){for(const v of this.actors)v.registerMessageHandler(s,d)}unregisterMessageHandler(s){for(const d of this.actors)d.unregisterMessageHandler(s)}}function qo(){return Wo||(Wo=new ho(bn(),i.M),Wo.registerMessageHandler("GR",(C,s,d)=>i.m(s,d))),Wo}function ma(C,s){const d=i.N();return i.O(d,d,[1,1,0]),i.Q(d,d,[.5*C.width,.5*C.height,1]),C.calculatePosMatrix?i.S(d,d,C.calculatePosMatrix(s.toUnwrapped())):d}function Kn(C,s,d,v,S,D,k){var j;const H=function(ut,St,pt){if(ut)for(const Et of ut){const Kt=St[Et];if(Kt&&Kt.source===pt&&Kt.type==="fill-extrusion")return!0}else for(const Et in St){const Kt=St[Et];if(Kt.source===pt&&Kt.type==="fill-extrusion")return!0}return!1}((j=S?.layers)!==null&&j!==void 0?j:null,s,C.id),J=D.maxPitchScaleFactor(),et=C.tilesIn(v,J,H);et.sort(vo);const mt=[];for(const ut of et)mt.push({wrappedTileID:ut.tileID.wrapped().key,queryResults:ut.tile.queryRenderedFeatures(s,d,C.getState(),ut.queryGeometry,ut.cameraQueryGeometry,ut.scale,S,D,J,ma(D,ut.tileID),k?(St,pt)=>k(ut.tileID,St,pt):void 0)});return function(ut,St){for(const pt in ut)for(const Et of ut[pt])ns(Et,St);return ut}(function(ut){const St={},pt={};for(const Et of ut){const Kt=Et.queryResults,Xt=Et.wrappedTileID,ft=pt[Xt]=pt[Xt]||{};for(const _e in Kt){const ce=Kt[_e],me=ft[_e]=ft[_e]||{},be=St[_e]=St[_e]||[];for(const de of ce)me[de.featureIndex]||(me[de.featureIndex]=!0,be.push(de))}}return St}(mt),C)}function vo(C,s){const d=C.tileID,v=s.tileID;return d.overscaledZ-v.overscaledZ||d.canonical.y-v.canonical.y||d.wrap-v.wrap||d.canonical.x-v.canonical.x}function ns(C,s){const d=C.feature,v=s.getFeatureState(d.layer["source-layer"],d.id);d.source=d.layer.source,d.layer["source-layer"]&&(d.sourceLayer=d.layer["source-layer"]),d.state=v}function Ds(C,s,d){return i._(this,void 0,void 0,function*(){let v=C;if(C.url?v=(yield i.j(s.transformRequest(C.url,"Source"),d)).data:yield Br.frameAsync(d),!v)return null;const S=i.U(i.e(v,C),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in v&&v.vector_layers&&(S.vectorLayerIds=v.vector_layers.map(D=>D.id)),S})}class lo{constructor(s,d){s&&(d?this.setSouthWest(s).setNorthEast(d):Array.isArray(s)&&(s.length===4?this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]]):this.setSouthWest(s[0]).setNorthEast(s[1])))}setNorthEast(s){return this._ne=s instanceof i.V?new i.V(s.lng,s.lat):i.V.convert(s),this}setSouthWest(s){return this._sw=s instanceof i.V?new i.V(s.lng,s.lat):i.V.convert(s),this}extend(s){const d=this._sw,v=this._ne;let S,D;if(s instanceof i.V)S=s,D=s;else{if(!(s instanceof lo))return Array.isArray(s)?s.length===4||s.every(Array.isArray)?this.extend(lo.convert(s)):this.extend(i.V.convert(s)):s&&("lng"in s||"lon"in s)&&"lat"in s?this.extend(i.V.convert(s)):this;if(S=s._sw,D=s._ne,!S||!D)return this}return d||v?(d.lng=Math.min(S.lng,d.lng),d.lat=Math.min(S.lat,d.lat),v.lng=Math.max(D.lng,v.lng),v.lat=Math.max(D.lat,v.lat)):(this._sw=new i.V(S.lng,S.lat),this._ne=new i.V(D.lng,D.lat)),this}getCenter(){return new i.V((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new i.V(this.getWest(),this.getNorth())}getSouthEast(){return new i.V(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(s){const{lng:d,lat:v}=i.V.convert(s);let S=this._sw.lng<=d&&d<=this._ne.lng;return this._sw.lng>this._ne.lng&&(S=this._sw.lng>=d&&d>=this._ne.lng),this._sw.lat<=v&&v<=this._ne.lat&&S}intersects(s){if((s=lo.convert(s)).getNorth()<this.getSouth()||s.getSouth()>this.getNorth())return!1;const d=i.W(this.getWest(),-180,180),v=i.W(this.getEast(),-180,180),S=i.W(s.getWest(),-180,180),D=i.W(s.getEast(),-180,180),k=d>v,j=S>D;return!(!k||!j)||(k?D>=d||S<=v:j?v>=S||d<=D:!(S>v||D<d))}static convert(s){return s instanceof lo?s:s&&new lo(s)}static fromLngLat(s,d=0){const v=360*d/40075017,S=v/Math.cos(Math.PI/180*s.lat);return new lo(new i.V(s.lng-S,s.lat-v),new i.V(s.lng+S,s.lat+v))}adjustAntiMeridian(){const s=new i.V(this._sw.lng,this._sw.lat),d=new i.V(this._ne.lng,this._ne.lat);return new lo(s,s.lng>d.lng?new i.V(d.lng+360,d.lat):d)}}class Zn{constructor(s,d,v){this.bounds=lo.convert(this.validateBounds(s)),this.minzoom=d||0,this.maxzoom=v||24}validateBounds(s){return Array.isArray(s)&&s.length===4?[Math.max(-180,s[0]),Math.max(-90,s[1]),Math.min(180,s[2]),Math.min(90,s[3])]:[-180,-90,180,90]}contains(s){const d=Math.pow(2,s.z),v=Math.floor(i.Y(this.bounds.getWest())*d),S=Math.floor(i.X(this.bounds.getNorth())*d),D=Math.ceil(i.Y(this.bounds.getEast())*d),k=Math.ceil(i.X(this.bounds.getSouth())*d);return s.x>=v&&s.x<D&&s.y>=S&&s.y<k}}class el extends i.E{constructor(s,d,v,S){if(super(),this.id=s,this.dispatcher=v,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,i.e(this,i.U(d,["url","scheme","tileSize","promoteId","encoding"])),this._options=i.e({type:"vector"},d),this._collectResourceTiming=d.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(S)}load(){return i._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new i.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const s=yield Ds(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.tileManagers[this.id].clearTiles(),s&&(i.e(this,s),s.bounds&&(this.tileBounds=new Zn(s.bounds,this.minzoom,this.maxzoom)),this.fire(new i.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.l("data",{dataType:"source",sourceDataType:"content"})))}catch(s){this._tileJSONRequest=null,this._loaded=!0,this.fire(new i.k(s))}})}loaded(){return this._loaded}hasTile(s){return!this.tileBounds||this.tileBounds.contains(s.canonical)}onAdd(s){this.map=s,this.load()}setSourceProperty(s){this._tileJSONRequest&&this._tileJSONRequest.abort(),s(),this.load()}setTiles(s){return this.setSourceProperty(()=>{this._options.tiles=s}),this}setUrl(s){return this.setSourceProperty(()=>{this.url=s,this._options.url=s}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return i.e({},this._options)}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),v={request:this.map._requestManager.transformRequest(d,"Tile"),uid:s.uid,tileID:s.tileID,zoom:s.tileID.overscaledZ,tileSize:this.tileSize*s.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,encoding:this.encoding,overzoomParameters:this._getOverzoomParameters(s)};v.request.collectResourceTiming=this._collectResourceTiming;let S="RT";if(s.actor&&s.state!=="expired"){if(s.state==="loading")return new Promise((D,k)=>{s.reloadPromise={resolve:D,reject:k}})}else s.actor=this.dispatcher.getActor(),S="LT";s.abortController=new AbortController;try{const D=yield s.actor.sendAsync({type:S,data:v},s.abortController);if(delete s.abortController,s.aborted)return;this._afterTileLoadWorkerResponse(s,D)}catch(D){if(delete s.abortController,s.aborted)return;if(D&&D.status!==404)throw D;this._afterTileLoadWorkerResponse(s,null)}})}_getOverzoomParameters(s){if(s.tileID.canonical.z<=this.maxzoom||this.map._zoomLevelsToOverscale===void 0)return;const d=s.tileID.scaledTo(this.maxzoom).canonical,v=d.url(this.tiles,this.map.getPixelRatio(),this.scheme);return{maxZoomTileID:d,overzoomRequest:this.map._requestManager.transformRequest(v,"Tile")}}_afterTileLoadWorkerResponse(s,d){if(d&&d.resourceTiming&&(s.resourceTiming=d.resourceTiming),d&&this.map._refreshExpiredTiles&&s.setExpiryData(d),s.loadVectorData(d,this.map.painter),s.reloadPromise){const v=s.reloadPromise;s.reloadPromise=null,this.loadTile(s).then(v.resolve).catch(v.reject)}}abortTile(s){return i._(this,void 0,void 0,function*(){s.abortController&&(s.abortController.abort(),delete s.abortController),s.actor&&(yield s.actor.sendAsync({type:"AT",data:{uid:s.uid,type:this.type,source:this.id}}))})}unloadTile(s){return i._(this,void 0,void 0,function*(){s.unloadVectorData(),s.actor&&(yield s.actor.sendAsync({type:"RMT",data:{uid:s.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class jl extends i.E{constructor(s,d,v,S){super(),this.id=s,this.dispatcher=v,this.setEventedParent(S),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=i.e({type:"raster"},d),i.e(this,i.U(d,["url","scheme","tileSize"]))}load(){return i._(this,arguments,void 0,function*(s=!1){this._loaded=!1,this.fire(new i.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const d=yield Ds(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,d&&(i.e(this,d),d.bounds&&(this.tileBounds=new Zn(d.bounds,this.minzoom,this.maxzoom)),this.fire(new i.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:s})))}catch(d){this._tileJSONRequest=null,this._loaded=!0,this.fire(new i.k(d))}})}loaded(){return this._loaded}onAdd(s){this.map=s,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(s){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),s(),this.load(!0)}setTiles(s){return this.setSourceProperty(()=>{this._options.tiles=s}),this}setUrl(s){return this.setSourceProperty(()=>{this.url=s,this._options.url=s}),this}serialize(){return i.e({},this._options)}hasTile(s){return!this.tileBounds||this.tileBounds.contains(s.canonical)}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);s.abortController=new AbortController;try{const v=yield Do.getImage(this.map._requestManager.transformRequest(d,"Tile"),s.abortController,this.map._refreshExpiredTiles);if(delete s.abortController,s.aborted)return void(s.state="unloaded");if(v&&v.data){this.map._refreshExpiredTiles&&(v.cacheControl||v.expires)&&s.setExpiryData({cacheControl:v.cacheControl,expires:v.expires});const S=this.map.painter.context,D=S.gl,k=v.data;s.texture=this.map.painter.getTileTexture(k.width),s.texture?s.texture.update(k,{useMipmap:!0}):(s.texture=new i.T(S,k,D.RGBA,{useMipmap:!0}),s.texture.bind(D.LINEAR,D.CLAMP_TO_EDGE,D.LINEAR_MIPMAP_NEAREST)),s.state="loaded"}}catch(v){if(delete s.abortController,s.aborted)s.state="unloaded";else if(v)throw s.state="errored",v}})}abortTile(s){return i._(this,void 0,void 0,function*(){s.abortController&&(s.abortController.abort(),delete s.abortController)})}unloadTile(s){return i._(this,void 0,void 0,function*(){s.texture&&this.map.painter.saveTileTexture(s.texture)})}hasTransition(){return!1}}class Ts extends jl{constructor(s,d,v,S){super(s,d,v,S),this.type="raster-dem",this.maxzoom=22,this._options=i.e({type:"raster-dem"},d),this.encoding=d.encoding||"mapbox",this.redFactor=d.redFactor,this.greenFactor=d.greenFactor,this.blueFactor=d.blueFactor,this.baseShift=d.baseShift}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),v=this.map._requestManager.transformRequest(d,"Tile");s.neighboringTiles=this._getNeighboringTiles(s.tileID),s.abortController=new AbortController;try{const S=yield Do.getImage(v,s.abortController,this.map._refreshExpiredTiles);if(delete s.abortController,s.aborted)return void(s.state="unloaded");if(S&&S.data){const D=S.data;this.map._refreshExpiredTiles&&(S.cacheControl||S.expires)&&s.setExpiryData({cacheControl:S.cacheControl,expires:S.expires});const k=i.b(D)&&i.Z()?D:yield this.readImageNow(D),j={type:this.type,uid:s.uid,source:this.id,rawImageData:k,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!s.actor||s.state==="expired"){s.actor=this.dispatcher.getActor();const H=yield s.actor.sendAsync({type:"LDT",data:j});s.dem=H,s.needsHillshadePrepare=!0,s.needsTerrainPrepare=!0,s.state="loaded"}}}catch(S){if(delete s.abortController,s.aborted)s.state="unloaded";else if(S)throw s.state="errored",S}})}readImageNow(s){return i._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&i.$()){const d=s.width+2,v=s.height+2;try{return new i.R({width:d,height:v},yield i.a0(s,-1,-1,d,v))}catch{}}return Br.getImageData(s,1)})}_getNeighboringTiles(s){const d=s.canonical,v=Math.pow(2,d.z),S=(d.x-1+v)%v,D=d.x===0?s.wrap-1:s.wrap,k=(d.x+1+v)%v,j=d.x+1===v?s.wrap+1:s.wrap,H={};return H[new i.a1(s.overscaledZ,D,d.z,S,d.y).key]={backfilled:!1},H[new i.a1(s.overscaledZ,j,d.z,k,d.y).key]={backfilled:!1},d.y>0&&(H[new i.a1(s.overscaledZ,D,d.z,S,d.y-1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,s.wrap,d.z,d.x,d.y-1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,j,d.z,k,d.y-1).key]={backfilled:!1}),d.y+1<v&&(H[new i.a1(s.overscaledZ,D,d.z,S,d.y+1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,s.wrap,d.z,d.x,d.y+1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,j,d.z,k,d.y+1).key]={backfilled:!1}),H}unloadTile(s){return i._(this,void 0,void 0,function*(){s.demTexture&&this.map.painter.saveTileTexture(s.demTexture),s.fbo&&(s.fbo.destroy(),delete s.fbo),s.dem&&delete s.dem,delete s.neighboringTiles,s.state="unloaded",s.actor&&(yield s.actor.sendAsync({type:"RDT",data:{type:this.type,uid:s.uid,source:this.id}}))})}}function ga(C){return C.type==="GeometryCollection"?C.geometries.map(s=>s.coordinates).flat(1/0):C.coordinates.flat(1/0)}function Gl(C){const s=new lo;let d;switch(C.type){case"FeatureCollection":d=C.features.map(v=>ga(v.geometry)).flat(1/0);break;case"Feature":d=ga(C.geometry);break;default:d=ga(C)}if(d.length==0)return s;for(let v=0;v<d.length-1;v+=2)s.extend([d[v],d[v+1]]);return s}class ds extends i.E{constructor(s,d,v,S){super(),this.id=s,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._isUpdatingWorker=!1,this._pendingWorkerUpdate={data:d.data},this.actor=v.getActor(),this.setEventedParent(S),this._data=typeof d.data=="string"?{url:d.data}:{geojson:d.data},this._options=i.e({},d),this._collectResourceTiming=d.collectResourceTiming,d.maxzoom!==void 0&&(this.maxzoom=d.maxzoom),d.type&&(this.type=d.type),d.attribution&&(this.attribution=d.attribution),this.promoteId=d.promoteId,d.clusterMaxZoom!==void 0&&this.maxzoom<=d.clusterMaxZoom&&i.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${d.clusterMaxZoom}".`),this.workerOptions=i.e({source:this.id,cluster:d.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(d.buffer!==void 0?d.buffer:128),tolerance:this._pixelsToTileUnits(d.tolerance!==void 0?d.tolerance:.375),extent:i.a4,maxZoom:this.maxzoom,lineMetrics:d.lineMetrics||!1,generateId:d.generateId||!1},superclusterOptions:{maxZoom:this._getClusterMaxZoom(d.clusterMaxZoom),minPoints:Math.max(2,d.clusterMinPoints||2),extent:i.a4,radius:this._pixelsToTileUnits(d.clusterRadius||50),log:!1,generateId:d.generateId||!1},clusterProperties:d.clusterProperties,filter:d.filter},d.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_hasPendingWorkerUpdate(){return this._pendingWorkerUpdate.data!==void 0||this._pendingWorkerUpdate.diff!==void 0||this._pendingWorkerUpdate.optionsChanged}_pixelsToTileUnits(s){return s*(i.a4/this.tileSize)}_getClusterMaxZoom(s){const d=s?Math.round(s):this.maxzoom-1;return Number.isInteger(s)||s===void 0||i.w(`Integer expected for option 'clusterMaxZoom': provided value "${s}" rounded to "${d}"`),d}load(){return i._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(s){this.map=s,this.load()}setData(s,d){this._data=typeof s=="string"?{url:s}:{geojson:s},this._pendingWorkerUpdate={data:s};const v=this._updateWorkerData();return d?v:this}updateData(s,d){this._pendingWorkerUpdate.diff=i.a5(this._pendingWorkerUpdate.diff,s);const v=this._updateWorkerData();return d?v:this}getData(){return i._(this,void 0,void 0,function*(){const s=i.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:s})})}getBounds(){return i._(this,void 0,void 0,function*(){return Gl(yield this.getData())})}setClusterOptions(s){return this.workerOptions.cluster=s.cluster,s.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(s.clusterRadius)),s.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=this._getClusterMaxZoom(s.clusterMaxZoom)),this._pendingWorkerUpdate.optionsChanged=!0,this._updateWorkerData(),this}getClusterExpansionZoom(s){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:s,source:this.id}})}getClusterChildren(s){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:s,source:this.id}})}getClusterLeaves(s,d,v){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:s,limit:d,offset:v}})}_updateWorkerData(){return i._(this,void 0,void 0,function*(){if(this._isUpdatingWorker)return;if(!this._hasPendingWorkerUpdate())return void i.w(`No pending worker updates for GeoJSONSource ${this.id}.`);const{data:s,diff:d}=this._pendingWorkerUpdate,v=i.e({type:this.type},this.workerOptions);s?(typeof s=="string"?(v.request=this.map._requestManager.transformRequest(Br.resolveURL(s),"Source"),v.request.collectResourceTiming=this._collectResourceTiming):v.data=s,this._pendingWorkerUpdate.data=void 0):d&&(v.dataDiff=d,this._pendingWorkerUpdate.diff=void 0),this._pendingWorkerUpdate.optionsChanged=void 0,this._isUpdatingWorker=!0,this.fire(new i.l("dataloading",{dataType:"source"}));try{const S=yield this.actor.sendAsync({type:"LD",data:v});if(this._isUpdatingWorker=!1,this._removed||S.abandoned)return void this.fire(new i.l("dataabort",{dataType:"source"}));S.applyDiff?this._applyDiff(d):this._data={geojson:S.data};let D=null;S.resourceTiming&&S.resourceTiming[this.id]&&(D=S.resourceTiming[this.id].slice(0));const k={dataType:"source"};this._collectResourceTiming&&D&&D.length>0&&i.e(k,{resourceTiming:D}),this.fire(new i.l("data",Object.assign(Object.assign({},k),{sourceDataType:"metadata"}))),this.fire(new i.l("data",Object.assign(Object.assign({},k),{sourceDataType:"content",shouldReloadTileOptions:this._getShouldReloadTileOptions(d)})))}catch(S){if(this._isUpdatingWorker=!1,this._removed)return void this.fire(new i.l("dataabort",{dataType:"source"}));this.fire(new i.k(S))}finally{this._hasPendingWorkerUpdate()&&this._updateWorkerData()}})}_applyDiff(s){const d=typeof this.promoteId=="string"?this.promoteId:void 0;this._data.url||this._data.updateable||!i.a6(this._data.geojson,d)||(this._data={updateable:i.a7(this._data.geojson,d)}),s&&this._data.updateable?i.a8(this._data.updateable,s,d):i.w("Cannot apply GeoJSONSource#updateData due to internal error")}_getShouldReloadTileOptions(s){if(this._options.cluster||!s||s.removeAll)return;const{add:d=[],update:v=[],remove:S=[]}=s||{},D=new Set([...v.map(k=>k.id),...S]);for(const k of D.values())if(typeof k!="number"&&this.promoteId==null)return void i.w(`GeoJSONSource "${this.id}": updateData is slower when using string GeoJSON feature IDs (e.g. "${k}"). Consider using promoteId or numeric IDs for better performance.`);return{nextBounds:[...v.map(k=>k.newGeometry),...d.map(k=>k.geometry)].filter(Boolean).map(k=>Gl(k)),prevIds:D}}shouldReloadTile(s,{nextBounds:d,prevIds:v}){if(!s.latestFeatureIndex)return s.state!=="unloaded";const S=s.latestFeatureIndex.loadVTLayers();for(let H=0;H<s.latestFeatureIndex.featureIndexArray.length;H++){const J=s.latestFeatureIndex.featureIndexArray.get(H),et=S[i.a9].feature(J.featureIndex),mt=s.latestFeatureIndex.getId(et,i.a9);if(v.has(mt))return!0}const{buffer:D,extent:k}=this.workerOptions.geojsonVtOptions,j=function({x:H,y:J,z:et},mt=0){const ut=i.a2((H-mt)/Math.pow(2,et)),St=i.a3((J+1+mt)/Math.pow(2,et)),pt=i.a2((H+1+mt)/Math.pow(2,et)),Et=i.a3((J-mt)/Math.pow(2,et));return new lo([ut,St],[pt,Et])}(s.tileID.canonical,D/k);for(const H of d)if(j.intersects(H))return!0;return!1}loaded(){return!this._isUpdatingWorker&&!this._hasPendingWorkerUpdate()}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.actor?"RT":"LT";s.actor=this.actor;const v={type:this.type,uid:s.uid,tileID:s.tileID,zoom:s.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};s.abortController=new AbortController;const S=yield this.actor.sendAsync({type:d,data:v},s.abortController);delete s.abortController,s.unloadVectorData(),s.aborted||s.loadVectorData(S,this.map.painter,d==="RT")})}abortTile(s){return i._(this,void 0,void 0,function*(){s.abortController&&(s.abortController.abort(),delete s.abortController),s.aborted=!0})}unloadTile(s){return i._(this,void 0,void 0,function*(){s.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:s.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return i.e({},this._options,{type:this.type,data:this._data.updateable?{type:"FeatureCollection",features:Array.from(this._data.updateable.values())}:this._data.url||this._data.geojson})}hasTransition(){return!1}}class Ss extends i.E{constructor(s,d,v,S){super(),this.flippedWindingOrder=!1,this.id=s,this.dispatcher=v,this.coordinates=d.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(S),this.options=d}load(s){return i._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new i.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const d=yield Do.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,d&&d.data&&(this.image=d.data,s&&(this.coordinates=s),this._finishLoading())}catch(d){this._request=null,this._loaded=!0,this.fire(new i.k(d))}})}loaded(){return this._loaded}updateImage(s){return s.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=s.url,this.load(s.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new i.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(s){this.map=s,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(s){this.coordinates=s;const d=s.map(i.aa.fromLngLat);var v;return this.tileID=function(S){const D=i.ab.fromPoints(S),k=D.width(),j=D.height(),H=Math.max(k,j),J=Math.max(0,Math.floor(-Math.log(H)/Math.LN2)),et=Math.pow(2,J);return new i.ad(J,Math.floor((D.minX+D.maxX)/2*et),Math.floor((D.minY+D.maxY)/2*et))}(d),this.terrainTileRanges=this._getOverlappingTileRanges(d),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=d.map(S=>this.tileID.getTilePoint(S)._round()),this.flippedWindingOrder=((v=this.tileCoords)[1].x-v[0].x)*(v[2].y-v[0].y)-(v[1].y-v[0].y)*(v[2].x-v[0].x)<0,this.fire(new i.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const s=this.map.painter.context,d=s.gl;this.texture||(this.texture=new i.T(s,this.image,d.RGBA),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE));let v=!1;for(const S in this.tiles){const D=this.tiles[S];D.state!=="loaded"&&(D.state="loaded",D.texture=this.texture,v=!0)}v&&this.fire(new i.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(s){return i._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(s.tileID.canonical)?(this.tiles[String(s.tileID.wrap)]=s,s.buckets={}):s.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(s){const{minX:d,minY:v,maxX:S,maxY:D}=i.ab.fromPoints(s),k={};for(let j=0;j<=i.ac;j++){const H=Math.pow(2,j),J=Math.floor(d*H),et=Math.floor(v*H),mt=Math.floor(S*H),ut=Math.floor(D*H);k[j]={minTileX:J,minTileY:et,maxTileX:mt,maxTileY:ut}}return k}}class il extends Ss{constructor(s,d,v,S){super(s,d,v,S),this.roundZoom=!0,this.type="video",this.options=d}load(){return i._(this,void 0,void 0,function*(){this._loaded=!1;const s=this.options;this.urls=[];for(const d of s.urls)this.urls.push(this.map._requestManager.transformRequest(d,"Source").url);try{const d=yield i.ae(this.urls);if(this._loaded=!0,!d)return;this.video=d,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(d){this.fire(new i.k(d))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(s){if(this.video){const d=this.video.seekable;s<d.start(0)||s>d.end(0)?this.fire(new i.k(new i.af(`sources.${this.id}`,null,`Playback for this video can be set only between the ${d.start(0)} and ${d.end(0)}-second mark.`))):this.video.currentTime=s}}getVideo(){return this.video}onAdd(s){this.map||(this.map=s,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const s=this.map.painter.context,d=s.gl;this.texture?this.video.paused||(this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE),d.texSubImage2D(d.TEXTURE_2D,0,0,0,d.RGBA,d.UNSIGNED_BYTE,this.video)):(this.texture=new i.T(s,this.video,d.RGBA),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE));let v=!1;for(const S in this.tiles){const D=this.tiles[S];D.state!=="loaded"&&(D.state="loaded",D.texture=this.texture,v=!0)}v&&this.fire(new i.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class Sl extends Ss{constructor(s,d,v,S){super(s,d,v,S),d.coordinates?Array.isArray(d.coordinates)&&d.coordinates.length===4&&!d.coordinates.some(D=>!Array.isArray(D)||D.length!==2||D.some(k=>typeof k!="number"))||this.fire(new i.k(new i.af(`sources.${s}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new i.k(new i.af(`sources.${s}`,null,'missing required property "coordinates"'))),d.animate&&typeof d.animate!="boolean"&&this.fire(new i.k(new i.af(`sources.${s}`,null,'optional "animate" property must be a boolean value'))),d.canvas?typeof d.canvas=="string"||d.canvas instanceof HTMLCanvasElement||this.fire(new i.k(new i.af(`sources.${s}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new i.k(new i.af(`sources.${s}`,null,'missing required property "canvas"'))),this.options=d,this.animate=d.animate===void 0||d.animate}load(){return i._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new i.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(s){this.map=s,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let s=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,s=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,s=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const d=this.map.painter.context,v=d.gl;this.texture?(s||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new i.T(d,this.canvas,v.RGBA,{premultiply:!0});let S=!1;for(const D in this.tiles){const k=this.tiles[D];k.state!=="loaded"&&(k.state="loaded",k.texture=this.texture,S=!0)}S&&this.fire(new i.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",animate:this.animate,canvas:this.options.canvas,coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const s of[this.canvas.width,this.canvas.height])if(isNaN(s)||s<=0)return!0;return!1}}const Il={},zs=C=>{switch(C){case"geojson":return ds;case"image":return Ss;case"raster":return jl;case"raster-dem":return Ts;case"vector":return el;case"video":return il;case"canvas":return Sl}return Il[C]},rl="RTLPluginLoaded";class Ga extends i.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=qo()}_syncState(s){return this.status=s,this.dispatcher.broadcast("SRPS",{pluginStatus:s,pluginURL:this.url}).catch(d=>{throw this.status="error",d})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(s){return i._(this,arguments,void 0,function*(d,v=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=Br.resolveURL(d),!this.url)throw new Error(`requested url ${d} is invalid`);if(this.status==="unavailable"){if(!v)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return i._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new i.l(rl))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let $l=null;function Aa(){return $l||($l=new Ga),$l}var Hn,we;(function(C){C[C.Base=0]="Base",C[C.Parent=1]="Parent"})(Hn||(Hn={})),function(C){C[C.Departing=0]="Departing",C[C.Incoming=1]="Incoming"}(we||(we={}));class It{constructor(s,d){this.timeAdded=0,this.fadeEndTime=0,this.fadeOpacity=1,this.tileID=s,this.uid=i.ag(),this.uses=0,this.tileSize=d,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}isRenderable(s){return this.hasData()&&(!this.fadeEndTime||this.fadeOpacity>0)&&(s||!this.holdingForSymbolFade())}setCrossFadeLogic({fadingRole:s,fadingDirection:d,fadingParentID:v,fadeEndTime:S}){this.resetFadeLogic(),this.fadingRole=s,this.fadingDirection=d,this.fadingParentID=v,this.fadeEndTime=S}setSelfFadeLogic(s){this.resetFadeLogic(),this.selfFading=!0,this.fadeEndTime=s}resetFadeLogic(){this.fadingRole=null,this.fadingDirection=null,this.fadingParentID=null,this.selfFading=!1,this.timeAdded=Ri(),this.fadeEndTime=0,this.fadeOpacity=1}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(s){this.demTexture&&s.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(s,d,v){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",s){s.featureIndex&&(this.latestFeatureIndex=s.featureIndex,s.rawTileData?(this.latestRawTileData=s.rawTileData,this.latestFeatureIndex.rawTileData=s.rawTileData,this.latestFeatureIndex.encoding=s.encoding):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData,this.latestFeatureIndex.encoding=this.latestEncoding)),this.collisionBoxArray=s.collisionBoxArray,this.buckets=function(S,D){const k={};if(!D)return k;for(const j of S){const H=j.layerIds.map(J=>D.getLayer(J)).filter(Boolean);if(H.length!==0){j.layers=H,j.stateDependentLayerIds&&(j.stateDependentLayers=j.stateDependentLayerIds.map(J=>H.filter(et=>et.id===J)[0]));for(const J of H)k[J.id]=j}}return k}(s.buckets,d?.style),this.hasSymbolBuckets=!1;for(const S in this.buckets){const D=this.buckets[S];if(D instanceof i.ai){if(this.hasSymbolBuckets=!0,!v)break;D.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const S in this.buckets){const D=this.buckets[S];if(D instanceof i.ai&&D.hasRTLText){this.hasRTLText=!0,Aa().lazyLoad();break}}this.queryPadding=0;for(const S in this.buckets){const D=this.buckets[S];this.queryPadding=Math.max(this.queryPadding,d.style.getLayer(S).queryRadius(D))}s.imageAtlas&&(this.imageAtlas=s.imageAtlas),s.glyphAtlasImage&&(this.glyphAtlasImage=s.glyphAtlasImage),this.dashPositions=s.dashPositions}else this.collisionBoxArray=new i.ah}unloadVectorData(){for(const s in this.buckets)this.buckets[s].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.dashPositions&&(this.dashPositions=null),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(s){return this.buckets[s.id]}upload(s){for(const v in this.buckets){const S=this.buckets[v];S.uploadPending()&&S.upload(s)}const d=s.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new i.T(s,this.imageAtlas.image,d.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new i.T(s,this.glyphAtlasImage,d.ALPHA),this.glyphAtlasImage=null)}prepare(s){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(s,this.imageAtlasTexture)}queryRenderedFeatures(s,d,v,S,D,k,j,H,J,et,mt){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:S,cameraQueryGeometry:D,scale:k,tileSize:this.tileSize,pixelPosMatrix:et,transform:H,params:j,queryPadding:this.queryPadding*J,getElevation:mt},s,d,v):{}}querySourceFeatures(s,d){const v=this.latestFeatureIndex;if(!v||!v.rawTileData)return;const S=v.loadVTLayers(),D=d&&d.sourceLayer?d.sourceLayer:"",k=S[i.a9]||S[D];if(!k)return;const j=i.aj(d?.filter,d?.globalState),{z:H,x:J,y:et}=this.tileID.canonical,mt={z:H,x:J,y:et};for(let ut=0;ut<k.length;ut++){const St=k.feature(ut);if(j.needGeometry){const Kt=i.ak(St,!0);if(!j.filter(new i.H(this.tileID.overscaledZ),Kt,this.tileID.canonical))continue}else if(!j.filter(new i.H(this.tileID.overscaledZ),St))continue;const pt=v.getId(St,D),Et=new i.al(St,H,J,et,pt);Et.tile=mt,s.push(Et)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(s){const d=this.expirationTime;if(s.cacheControl){const v=i.am(s.cacheControl);v["max-age"]&&(this.expirationTime=Date.now()+1e3*v["max-age"])}else s.expires&&(this.expirationTime=new Date(s.expires).getTime());if(this.expirationTime){const v=Date.now();let S=!1;if(this.expirationTime>v)S=!1;else if(d)if(this.expirationTime<d)S=!0;else{const D=this.expirationTime-d;D?this.expirationTime=v+Math.max(D,3e4):S=!0}else S=!0;S?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(s,d){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(s).length===0)return;const v=this.latestFeatureIndex.loadVTLayers();for(const S in this.buckets){if(!d.style.hasLayer(S))continue;const D=this.buckets[S],k=D.layers[0].sourceLayer||i.a9,j=v[k],H=s[k];if(!j||!H||Object.keys(H).length===0)continue;D.update(H,j,this.imageAtlas&&this.imageAtlas.patternPositions||{},this.dashPositions||{});const J=d&&d.style&&d.style.getLayer(S);J&&(this.queryPadding=Math.max(this.queryPadding,J.queryRadius(D)))}}holdingForSymbolFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Ri()}clearSymbolFadeHold(){this.symbolFadeHoldUntil=void 0}setSymbolHoldDuration(s){this.symbolFadeHoldUntil=Ri()+s}setDependencies(s,d){const v={};for(const S of d)v[S]=!0;this.dependencies[s]=v}hasDependency(s,d){for(const v of s){const S=this.dependencies[v];if(S){for(const D of d)if(S[D])return!0}}return!1}}class Mt{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(s,d,v){const S=String(d);if(this.stateChanges[s]=this.stateChanges[s]||{},this.stateChanges[s][S]=this.stateChanges[s][S]||{},i.e(this.stateChanges[s][S],v),this.deletedStates[s]===null){this.deletedStates[s]={};for(const D in this.state[s])D!==S&&(this.deletedStates[s][D]=null)}else if(this.deletedStates[s]&&this.deletedStates[s][S]===null){this.deletedStates[s][S]={};for(const D in this.state[s][S])v[D]||(this.deletedStates[s][S][D]=null)}else for(const D in v)this.deletedStates[s]&&this.deletedStates[s][S]&&this.deletedStates[s][S][D]===null&&delete this.deletedStates[s][S][D]}removeFeatureState(s,d,v){if(this.deletedStates[s]===null)return;const S=String(d);if(this.deletedStates[s]=this.deletedStates[s]||{},v&&d!==void 0)this.deletedStates[s][S]!==null&&(this.deletedStates[s][S]=this.deletedStates[s][S]||{},this.deletedStates[s][S][v]=null);else if(d!==void 0)if(this.stateChanges[s]&&this.stateChanges[s][S])for(v in this.deletedStates[s][S]={},this.stateChanges[s][S])this.deletedStates[s][S][v]=null;else this.deletedStates[s][S]=null;else this.deletedStates[s]=null}getState(s,d){const v=String(d),S=i.e({},(this.state[s]||{})[v],(this.stateChanges[s]||{})[v]);if(this.deletedStates[s]===null)return{};if(this.deletedStates[s]){const D=this.deletedStates[s][d];if(D===null)return{};for(const k in D)delete S[k]}return S}initializeTileState(s,d){s.setFeatureState(this.state,d)}coalesceChanges(s,d){const v={};for(const S in this.stateChanges){this.state[S]=this.state[S]||{};const D={};for(const k in this.stateChanges[S])this.state[S][k]||(this.state[S][k]={}),i.e(this.state[S][k],this.stateChanges[S][k]),D[k]=this.state[S][k];v[S]=D}for(const S in this.deletedStates){this.state[S]=this.state[S]||{};const D={};if(this.deletedStates[S]===null)for(const k in this.state[S])D[k]={},this.state[S][k]={};else for(const k in this.deletedStates[S]){if(this.deletedStates[S][k]===null)this.state[S][k]={};else for(const j of Object.keys(this.deletedStates[S][k]))delete this.state[S][k][j];D[k]=this.state[S][k]}v[S]=v[S]||{},i.e(v[S],D)}if(this.stateChanges={},this.deletedStates={},Object.keys(v).length!==0)for(const S in s)s[S].setFeatureState(v,d)}}const Ut=89.25;function he(C,s){const d=i.an(s.lat,-i.ao,i.ao);return new i.P(i.Y(s.lng)*C,i.X(d)*C)}function le(C,s){return new i.aa(s.x/C,s.y/C).toLngLat()}function Re(C){return C.cameraToCenterDistance*Math.min(.85*Math.tan(i.ap(90-C.pitch)),Math.tan(i.ap(Ut-C.pitch)))}function te(C,s){const d=C.canonical,v=s/i.aq(d.z),S=d.x+Math.pow(2,d.z)*C.wrap,D=i.ar(new Float64Array(16));return i.O(D,D,[S*v,d.y*v,0]),i.Q(D,D,[v/i.a4,v/i.a4,1]),D}function ze(C,s,d,v,S){const D=i.aa.fromLngLat(C,s),k=S*i.as(1,C.lat),j=k*Math.cos(i.ap(d)),H=Math.sqrt(k*k-j*j),J=H*Math.sin(i.ap(-v)),et=H*Math.cos(i.ap(-v));return new i.aa(D.x+J,D.y+et,D.z+j)}function We(C,s,d){const v=s.intersectsFrustum(C);if(!d||v===0)return v;const S=s.intersectsPlane(d);return S===0?0:v===2&&S===2?2:1}function ci(C,s,d){let v=0;const S=(d-s)/10;for(let D=0;D<10;D++)v+=S*Math.pow(Math.cos(s+(D+.5)/10*(d-s)),C);return v}function ui(C,s){return function(d,v,S,D,k){const j=2*((C-1)/i.at(Math.cos(i.ap(Ut-k))/Math.cos(i.ap(Ut)))-1),H=Math.acos(S/D),J=2*ci(j-1,0,i.ap(k/2)),et=Math.min(i.ap(Ut),H+i.ap(k/2)),mt=ci(j-1,Math.min(et,H-i.ap(k/2)),et),ut=Math.atan(v/S),St=Math.hypot(v,S);let pt=d;return pt+=i.at(D/St/Math.max(.5,Math.cos(i.ap(k/2)))),pt+=j*i.at(Math.cos(ut))/2,pt-=i.at(Math.max(1,mt/J/s))/2,pt}}const or=ui(9.314,3);function Ir(C,s){const d=(s.roundZoom?Math.round:Math.floor)(C.zoom+i.at(C.tileSize/s.tileSize));return Math.max(0,d)}function Ae(C,s){const d=C.getCameraFrustum(),v=C.getClippingPlane(),S=C.screenPointToMercatorCoordinate(C.getCameraPoint()),D=i.aa.fromLngLat(C.center,C.elevation);S.z=D.z+Math.cos(C.pitchInRadians)*C.cameraToCenterDistance/C.worldSize;const k=C.getCoveringTilesDetailsProvider(),j=k.allowVariableZoom(C,s),H=Ir(C,s),J=s.minzoom||0,et=s.maxzoom!==void 0?s.maxzoom:C.maxZoom,mt=Math.min(Math.max(0,H),et),ut=Math.pow(2,mt),St=[ut*S.x,ut*S.y,0],pt=[ut*D.x,ut*D.y,0],Et=Math.hypot(D.x-S.x,D.y-S.y),Kt=Math.abs(D.z-S.z),Xt=Math.hypot(Et,Kt),ft=me=>({zoom:0,x:0,y:0,wrap:me,fullyVisible:!1}),_e=[],ce=[];if(C.renderWorldCopies&&k.allowWorldCopies())for(let me=1;me<=3;me++)_e.push(ft(-me)),_e.push(ft(me));for(_e.push(ft(0));_e.length>0;){const me=_e.pop(),be=me.x,de=me.y;let De=me.fullyVisible;const Qe={x:be,y:de,z:me.zoom},Xe=k.getTileBoundingVolume(Qe,me.wrap,C.elevation,s);if(!De){const Fi=We(d,Xe,v);if(Fi===0)continue;De=Fi===2}const Je=k.distanceToTile2d(S.x,S.y,Qe,Xe);let ii=H;j&&(ii=(s.calculateTileZoom||or)(C.zoom+i.at(C.tileSize/s.tileSize),Je,Kt,Xt,C.fov)),ii=(s.roundZoom?Math.round:Math.floor)(ii),ii=Math.max(0,ii);const Di=Math.min(ii,et);if(me.wrap=k.getWrap(D,Qe,me.wrap),me.zoom>=Di){if(me.zoom<J)continue;const Fi=mt-me.zoom,wi=St[0]-.5-(be<<Fi),fr=St[1]-.5-(de<<Fi),$r=s.reparseOverscaled?Math.max(me.zoom,ii):me.zoom;ce.push({tileID:new i.a1(me.zoom===et?$r:me.zoom,me.wrap,me.zoom,be,de),distanceSq:i.au([pt[0]-.5-be,pt[1]-.5-de]),tileDistanceToCamera:Math.sqrt(wi*wi+fr*fr)})}else for(let Fi=0;Fi<4;Fi++)_e.push({zoom:me.zoom+1,x:(be<<1)+Fi%2,y:(de<<1)+(Fi>>1),wrap:me.wrap,fullyVisible:De})}return ce.sort((me,be)=>me.distanceSq-be.distanceSq).map(me=>me.tileID)}const bo=i.ab.fromPoints([new i.P(0,0),new i.P(i.a4,i.a4)]);class _n extends i.E{constructor(s,d,v){super(),this.id=s,this.dispatcher=v,this.on("data",S=>this._dataHandler(S)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((S,D,k,j)=>{const H=new(zs(D.type))(S,D,k,j);if(H.id!==S)throw new Error(`Expected Source id to be ${S} instead of ${H.id}`);return H})(s,d,v,this),this._tiles={},this._cache=new i.av(0,S=>this._unloadTile(S)),this._timers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._rasterFadeDuration=0,this._maxFadingAncestorLevels=5,this._state=new Mt,this._didEmitContent=!1,this._updated=!1}onAdd(s){this.map=s,this._maxTileCacheSize=s?s._maxTileCacheSize:null,this._maxTileCacheZoomLevels=s?s._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(s)}onRemove(s){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(s)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const s in this._tiles){const d=this._tiles[s];if(d.state!=="loaded"&&d.state!=="errored")return!1}return!0}getSource(){return this._source}getState(){return this._state}pause(){this._paused=!0}resume(){if(!this._paused)return;const s=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,s&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(s,d,v){return i._(this,void 0,void 0,function*(){try{yield this._source.loadTile(s),this._tileLoaded(s,d,v)}catch(S){s.state="errored",S.status!==404?this._source.fire(new i.k(S,{tile:s})):this.update(this.transform,this.terrain)}})}_unloadTile(s){this._source.unloadTile&&this._source.unloadTile(s)}_abortTile(s){this._source.abortTile&&this._source.abortTile(s),this._source.fire(new i.l("dataabort",{tile:s,coord:s.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(s){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const d in this._tiles){const v=this._tiles[d];v.upload(s),v.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(s=>s.tileID).sort(Un).map(s=>s.key)}getRenderableIds(s){const d=[];for(const v in this._tiles)this._isIdRenderable(v,s)&&d.push(this._tiles[v]);return s?d.sort((v,S)=>{const D=v.tileID,k=S.tileID,j=new i.P(D.canonical.x,D.canonical.y)._rotate(-this.transform.bearingInRadians),H=new i.P(k.canonical.x,k.canonical.y)._rotate(-this.transform.bearingInRadians);return D.overscaledZ-k.overscaledZ||H.y-j.y||H.x-j.x}).map(v=>v.tileID.key):d.map(v=>v.tileID).sort(Un).map(v=>v.key)}hasRenderableParent(s){const d=s.overscaledZ-1;if(d>=this._source.minzoom){const v=this.getLoadedTile(s.scaledTo(d));if(v)return this._isIdRenderable(v.tileID.key)}return!1}_isIdRenderable(s,d=!1){var v;return(v=this._tiles[s])===null||v===void 0?void 0:v.isRenderable(d)}reload(s,d=void 0){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const v in this._tiles)d&&this._source.shouldReloadTile&&!this._source.shouldReloadTile(this._tiles[v],d)||(s?this._reloadTile(v,"expired"):this._tiles[v].state!=="errored"&&this._reloadTile(v,"reloading"))}}_reloadTile(s,d){return i._(this,void 0,void 0,function*(){const v=this._tiles[s];v&&(v.state!=="loading"&&(v.state=d),yield this._loadTile(v,s,d))})}_tileLoaded(s,d,v){s.timeAdded=Ri(),s.selfFading&&(s.fadeEndTime=s.timeAdded+this._rasterFadeDuration),v==="expired"&&(s.refreshedUponExpiration=!0),this._setTileReloadTimer(d,s),this.getSource().type==="raster-dem"&&s.dem&&this._backfillDEM(s),this._state.initializeTileState(s,this.map?this.map.painter:null),s.aborted||this._source.fire(new i.l("data",{dataType:"source",tile:s,coord:s.tileID}))}_backfillDEM(s){const d=this.getRenderableIds();for(let S=0;S<d.length;S++){const D=d[S];if(s.neighboringTiles&&s.neighboringTiles[D]){const k=this.getTileByID(D);v(s,k),v(k,s)}}function v(S,D){S.needsHillshadePrepare=!0,S.needsTerrainPrepare=!0;let k=D.tileID.canonical.x-S.tileID.canonical.x;const j=D.tileID.canonical.y-S.tileID.canonical.y,H=Math.pow(2,S.tileID.canonical.z),J=D.tileID.key;k===0&&j===0||Math.abs(j)>1||(Math.abs(k)>1&&(Math.abs(k+H)===1?k+=H:Math.abs(k-H)===1&&(k-=H)),D.dem&&S.dem&&(S.dem.backfillBorder(D.dem,k,j),S.neighboringTiles&&S.neighboringTiles[J]&&(S.neighboringTiles[J].backfilled=!0)))}}getTile(s){return this.getTileByID(s.key)}getTileByID(s){return this._tiles[s]}_retainLoadedChildren(s,d){const v=this._getLoadedDescendents(d),S=new Set;for(const D of d){const k=v[D.key];if(!k?.length){S.add(D);continue}const j=D.overscaledZ+_n.maxOverzooming,H=k.filter(mt=>mt.tileID.overscaledZ<=j);if(!H.length){S.add(D);continue}const J=Math.min(...H.map(mt=>mt.tileID.overscaledZ)),et=H.filter(mt=>mt.tileID.overscaledZ===J).map(mt=>mt.tileID);for(const mt of et)s[mt.key]=mt;this._areDescendentsComplete(et,J,D.overscaledZ)||S.add(D)}return S}_getLoadedDescendents(s){var d;const v={};for(const S in this._tiles){const D=this._tiles[S];if(D.hasData())for(const k of s)D.tileID.isChildOf(k)&&(v[d=k.key]||(v[d]=[])).push(D)}return v}_areDescendentsComplete(s,d,v){return s.length===1&&s[0].isOverscaled()?s[0].overscaledZ===d:Math.pow(4,d-v)===s.length}getLoadedTile(s){const d=this._tiles[s.key];return d?.hasData()?d:null}updateCacheSize(s){const d=Math.ceil(s.width/this._source.tileSize)+1,v=Math.ceil(s.height/this._source.tileSize)+1,S=Math.floor(d*v*(this._maxTileCacheZoomLevels===null?i.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),D=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,S):S;this._cache.setMaxSize(D)}handleWrapJump(s){const d=Math.round((s-(this._prevLng===void 0?s:this._prevLng))/360);if(this._prevLng=s,d){const v={};for(const S in this._tiles){const D=this._tiles[S];D.tileID=D.tileID.unwrapTo(D.tileID.wrap+d),v[D.tileID.key]=D}this._tiles=v,this._resetTileReloadTimers()}}update(s,d){if(!this._sourceLoaded||this._paused)return;let v;this.transform=s,this.terrain=d,this.updateCacheSize(s),this.handleWrapJump(this.transform.center.lng),this.used||this.usedForTerrain?this._source.tileID?v=s.getVisibleUnwrappedCoordinates(this._source.tileID).map(H=>new i.a1(H.canonical.z,H.wrap,H.canonical.z,H.canonical.x,H.canonical.y)):(v=Ae(s,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.type==="vector"&&this.map._zoomLevelsToOverscale!==void 0?s.maxZoom-this.map._zoomLevelsToOverscale:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:d,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(v=v.filter(H=>this._source.hasTile(H)))):v=[],this.usedForTerrain&&(v=this._addTerrainIdealTiles(v));const S=v.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,S&&this.fire(new i.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const D=Ir(s,this._source),k=this._updateRetainedTiles(v,D),j=rr(this._source.type);j&&this._rasterFadeDuration>0&&!d&&this._updateFadingTiles(v,k),j?this._cleanUpRasterTiles(k):this._cleanUpVectorTiles(k)}_cleanUpRasterTiles(s){for(const d in this._tiles)s[d]||this._removeTile(d)}_cleanUpVectorTiles(s){for(const d in this._tiles){const v=this._tiles[d];s[d]?v.clearSymbolFadeHold():v.hasSymbolBuckets?v.holdingForSymbolFade()?v.symbolFadeFinished()&&this._removeTile(d):v.setSymbolHoldDuration(this.map._fadeDuration):this._removeTile(d)}}_addTerrainIdealTiles(s){const d=[];for(const v of s)if(v.canonical.z>this._source.minzoom){const S=v.scaledTo(v.canonical.z-1);d.push(S);const D=v.scaledTo(Math.max(this._source.minzoom,Math.min(v.canonical.z,5)));d.push(D)}return s.concat(d)}releaseSymbolFadeTiles(){for(const s in this._tiles)this._tiles[s].holdingForSymbolFade()&&this._removeTile(s)}_updateRetainedTiles(s,d){var v;const S=new Set;for(const J of s)this._addTile(J).hasData()||S.add(J);const D=s.reduce((J,et)=>(J[et.key]=et,J),{}),k=this._retainLoadedChildren(D,S),j={},H=Math.max(d-_n.maxUnderzooming,this._source.minzoom);for(const J of k){let et=this._tiles[J.key],mt=et?.wasRequested();for(let ut=J.overscaledZ-1;ut>=H;--ut){const St=J.scaledTo(ut);if(j[St.key])break;if(j[St.key]=!0,et=this.getTile(St),!et&&mt&&(et=this._addTile(St)),et){const pt=et.hasData();if((pt||!(!((v=this.map)===null||v===void 0)&&v.cancelPendingTileRequestsWhileZooming)||mt)&&(D[St.key]=St),mt=et.wasRequested(),pt)break}}}return D}_updateFadingTiles(s,d){const v=Ri(),S=i.aw(s);for(const D of s){const k=this._tiles[D.key];k.fadingDirection!==we.Departing&&k.fadeOpacity!==0||k.resetFadeLogic(),this._updateFadingAncestor(k,d,v)||this._updateFadingDescendents(k,d,v)||this._updateFadingEdge(k,S,v)||k.resetFadeLogic()}}_updateFadingAncestor(s,d,v){if(!s.hasData())return!1;const{tileID:S,fadingRole:D,fadingDirection:k,fadingParentID:j}=s;if(D===Hn.Base&&k===we.Incoming&&j)return d[j.key]=j,!0;const H=Math.max(S.overscaledZ-this._maxFadingAncestorLevels,this._source.minzoom);for(let J=S.overscaledZ-1;J>=H;J--){const et=S.scaledTo(J),mt=this.getLoadedTile(et);if(mt)return s.setCrossFadeLogic({fadingRole:Hn.Base,fadingDirection:we.Incoming,fadingParentID:mt.tileID,fadeEndTime:v+this._rasterFadeDuration}),mt.setCrossFadeLogic({fadingRole:Hn.Parent,fadingDirection:we.Departing,fadeEndTime:v+this._rasterFadeDuration}),d[et.key]=et,!0}return!1}_updateFadingDescendents(s,d,v){if(!s.hasData())return!1;const S=s.tileID.children(this._source.maxzoom);let D=this._updateFadingChildren(s,S,d,v);if(D)return!0;for(const k of S){const j=k.children(this._source.maxzoom);this._updateFadingChildren(s,j,d,v)&&(D=!0)}return D}_updateFadingChildren(s,d,v,S){if(d[0].overscaledZ>=this._source.maxzoom)return!1;let D=!1;for(const k of d){const j=this.getLoadedTile(k);if(!j)continue;const{fadingRole:H,fadingDirection:J,fadingParentID:et}=j;H===Hn.Base&&J===we.Departing&&et||(j.setCrossFadeLogic({fadingRole:Hn.Base,fadingDirection:we.Departing,fadingParentID:s.tileID,fadeEndTime:S+this._rasterFadeDuration}),s.setCrossFadeLogic({fadingRole:Hn.Parent,fadingDirection:we.Incoming,fadeEndTime:S+this._rasterFadeDuration})),v[k.key]=k,D=!0}return D}_updateFadingEdge(s,d,v){const S=s.tileID;return!!s.selfFading||!s.hasData()&&!!d.has(S)&&(s.setSelfFadeLogic(v+this._rasterFadeDuration),!0)}_addTile(s){let d=this._tiles[s.key];if(d)return d;d=this._cache.getAndRemove(s),d&&(d.resetFadeLogic(),this._setTileReloadTimer(s.key,d),d.tileID=s,this._state.initializeTileState(d,this.map?this.map.painter:null));const v=d;return d||(d=new It(s,this._source.tileSize*s.overscaleFactor()),this._loadTile(d,s.key,d.state)),d.uses++,this._tiles[s.key]=d,v||this._source.fire(new i.l("dataloading",{tile:d,coord:d.tileID,dataType:"source"})),d}_setTileReloadTimer(s,d){this._clearTileReloadTimer(s);const v=d.getExpiryTimeout();v&&(this._timers[s]=setTimeout(()=>{this._reloadTile(s,"expired"),delete this._timers[s]},v))}_clearTileReloadTimer(s){const d=this._timers[s];d&&(clearTimeout(d),delete this._timers[s])}_resetTileReloadTimers(){for(const s in this._timers)clearTimeout(this._timers[s]),delete this._timers[s];for(const s in this._tiles)this._setTileReloadTimer(s,this._tiles[s])}refreshTiles(s){for(const d in this._tiles)(this._isIdRenderable(d)||this._tiles[d].state=="errored")&&s.some(v=>v.equals(this._tiles[d].tileID.canonical))&&this._reloadTile(d,"expired")}_removeTile(s){const d=this._tiles[s];d&&(d.uses--,delete this._tiles[s],this._clearTileReloadTimer(s),d.uses>0||(d.hasData()&&d.state!=="reloading"?this._cache.add(d.tileID,d,d.getExpiryTimeout()):(d.aborted=!0,this._abortTile(d),this._unloadTile(d))))}_dataHandler(s){s.dataType==="source"&&(s.sourceDataType!=="metadata"?s.sourceDataType==="content"&&this._sourceLoaded&&!this._paused&&(this.reload(s.sourceDataChanged,s.shouldReloadTileOptions),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0):this._sourceLoaded=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const s in this._tiles)this._removeTile(s);this._cache.reset()}tilesIn(s,d,v){const S=[],D=this.transform;if(!D)return S;const k=D.getCoveringTilesDetailsProvider().allowWorldCopies(),j=v?D.getCameraQueryGeometry(s):s,H=St=>D.screenPointToMercatorCoordinate(St,this.terrain),J=this.transformBbox(s,H,!k),et=this.transformBbox(j,H,!k),mt=this.getIds(),ut=i.ab.fromPoints(et);for(let St=0;St<mt.length;St++){const pt=this._tiles[mt[St]];if(pt.holdingForSymbolFade())continue;const Et=k?[pt.tileID]:[pt.tileID.unwrapTo(-1),pt.tileID.unwrapTo(0)],Kt=Math.pow(2,D.zoom-pt.tileID.overscaledZ),Xt=d*pt.queryPadding*i.a4/pt.tileSize/Kt;for(const ft of Et){const _e=ut.map(ce=>ft.getTilePoint(new i.aa(ce.x,ce.y)));if(_e.expandBy(Xt),_e.intersects(bo)){const ce=J.map(be=>ft.getTilePoint(be)),me=et.map(be=>ft.getTilePoint(be));S.push({tile:pt,tileID:k?ft:ft.unwrapTo(0),queryGeometry:ce,cameraQueryGeometry:me,scale:Kt})}}}return S}transformBbox(s,d,v){let S=s.map(d);if(v){const D=i.ab.fromPoints(s);D.shrinkBy(.001*Math.min(D.width(),D.height()));const k=D.map(d);i.ab.fromPoints(S).covers(k)||(S=S.map(j=>j.x>.5?new i.aa(j.x-1,j.y,j.z):j))}return S}getVisibleCoordinates(s){const d=this.getRenderableIds(s).map(v=>this._tiles[v].tileID);return this.transform&&this.transform.populateCache(d),d}hasTransition(){if(this._source.hasTransition())return!0;if(rr(this._source.type)&&this._rasterFadeDuration>0){const s=Ri();for(const d in this._tiles)if(this._tiles[d].fadeEndTime>=s)return!0}return!1}setRasterFadeDuration(s){this._rasterFadeDuration=s}setFeatureState(s,d,v){this._state.updateState(s=s||i.a9,d,v)}removeFeatureState(s,d,v){this._state.removeFeatureState(s=s||i.a9,d,v)}getFeatureState(s,d){return this._state.getState(s=s||i.a9,d)}setDependencies(s,d,v){const S=this._tiles[s];S&&S.setDependencies(d,v)}reloadTilesForDependencies(s,d){for(const v in this._tiles)this._tiles[v].hasDependency(s,d)&&this._reloadTile(v,"reloading");this._cache.filter(v=>!v.hasDependency(s,d))}}function Un(C,s){const d=Math.abs(2*C.wrap)-+(C.wrap<0),v=Math.abs(2*s.wrap)-+(s.wrap<0);return C.overscaledZ-s.overscaledZ||v-d||s.canonical.y-C.canonical.y||s.canonical.x-C.canonical.x}function rr(C){return C==="raster"||C==="image"||C==="video"}_n.maxUnderzooming=10,_n.maxOverzooming=3;class bi{constructor(s,d){this.reset(s,d)}reset(s,d){this.points=s||[],this._distances=[0];for(let v=1;v<this.points.length;v++)this._distances[v]=this._distances[v-1]+this.points[v].dist(this.points[v-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(d||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(s){if(this.points.length===1)return this.points[0];s=i.an(s,0,1);let d=1,v=this._distances[d];const S=s*this.paddedLength+this.padding;for(;v<S&&d<this._distances.length;)v=this._distances[++d];const D=d-1,k=this._distances[D],j=v-k,H=j>0?(S-k)/j:0;return this.points[D].mult(1-H).add(this.points[d].mult(H))}}function Bo(C,s){let d=!0;return C==="always"||C!=="never"&&s!=="never"||(d=!1),d}class wo{constructor(s,d,v){const S=this.boxCells=[],D=this.circleCells=[];this.xCellCount=Math.ceil(s/v),this.yCellCount=Math.ceil(d/v);for(let k=0;k<this.xCellCount*this.yCellCount;k++)S.push([]),D.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=s,this.height=d,this.xScale=this.xCellCount/s,this.yScale=this.yCellCount/d,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(s,d,v,S,D){this._forEachCell(d,v,S,D,this._insertBoxCell,this.boxUid++),this.boxKeys.push(s),this.bboxes.push(d),this.bboxes.push(v),this.bboxes.push(S),this.bboxes.push(D)}insertCircle(s,d,v,S){this._forEachCell(d-S,v-S,d+S,v+S,this._insertCircleCell,this.circleUid++),this.circleKeys.push(s),this.circles.push(d),this.circles.push(v),this.circles.push(S)}_insertBoxCell(s,d,v,S,D,k){this.boxCells[D].push(k)}_insertCircleCell(s,d,v,S,D,k){this.circleCells[D].push(k)}_query(s,d,v,S,D,k,j){if(v<0||s>this.width||S<0||d>this.height)return[];const H=[];if(s<=0&&d<=0&&this.width<=v&&this.height<=S){if(D)return[{key:null,x1:s,y1:d,x2:v,y2:S}];for(let J=0;J<this.boxKeys.length;J++)H.push({key:this.boxKeys[J],x1:this.bboxes[4*J],y1:this.bboxes[4*J+1],x2:this.bboxes[4*J+2],y2:this.bboxes[4*J+3]});for(let J=0;J<this.circleKeys.length;J++){const et=this.circles[3*J],mt=this.circles[3*J+1],ut=this.circles[3*J+2];H.push({key:this.circleKeys[J],x1:et-ut,y1:mt-ut,x2:et+ut,y2:mt+ut})}}else this._forEachCell(s,d,v,S,this._queryCell,H,{hitTest:D,overlapMode:k,seenUids:{box:{},circle:{}}},j);return H}query(s,d,v,S){return this._query(s,d,v,S,!1,null)}hitTest(s,d,v,S,D,k){return this._query(s,d,v,S,!0,D,k).length>0}hitTestCircle(s,d,v,S,D){const k=s-v,j=s+v,H=d-v,J=d+v;if(j<0||k>this.width||J<0||H>this.height)return!1;const et=[];return this._forEachCell(k,H,j,J,this._queryCellCircle,et,{hitTest:!0,overlapMode:S,circle:{x:s,y:d,radius:v},seenUids:{box:{},circle:{}}},D),et.length>0}_queryCell(s,d,v,S,D,k,j,H){const{seenUids:J,hitTest:et,overlapMode:mt}=j,ut=this.boxCells[D];if(ut!==null){const pt=this.bboxes;for(const Et of ut)if(!J.box[Et]){J.box[Et]=!0;const Kt=4*Et,Xt=this.boxKeys[Et];if(s<=pt[Kt+2]&&d<=pt[Kt+3]&&v>=pt[Kt+0]&&S>=pt[Kt+1]&&(!H||H(Xt))&&(!et||!Bo(mt,Xt.overlapMode))&&(k.push({key:Xt,x1:pt[Kt],y1:pt[Kt+1],x2:pt[Kt+2],y2:pt[Kt+3]}),et))return!0}}const St=this.circleCells[D];if(St!==null){const pt=this.circles;for(const Et of St)if(!J.circle[Et]){J.circle[Et]=!0;const Kt=3*Et,Xt=this.circleKeys[Et];if(this._circleAndRectCollide(pt[Kt],pt[Kt+1],pt[Kt+2],s,d,v,S)&&(!H||H(Xt))&&(!et||!Bo(mt,Xt.overlapMode))){const ft=pt[Kt],_e=pt[Kt+1],ce=pt[Kt+2];if(k.push({key:Xt,x1:ft-ce,y1:_e-ce,x2:ft+ce,y2:_e+ce}),et)return!0}}}return!1}_queryCellCircle(s,d,v,S,D,k,j,H){const{circle:J,seenUids:et,overlapMode:mt}=j,ut=this.boxCells[D];if(ut!==null){const pt=this.bboxes;for(const Et of ut)if(!et.box[Et]){et.box[Et]=!0;const Kt=4*Et,Xt=this.boxKeys[Et];if(this._circleAndRectCollide(J.x,J.y,J.radius,pt[Kt+0],pt[Kt+1],pt[Kt+2],pt[Kt+3])&&(!H||H(Xt))&&!Bo(mt,Xt.overlapMode))return k.push(!0),!0}}const St=this.circleCells[D];if(St!==null){const pt=this.circles;for(const Et of St)if(!et.circle[Et]){et.circle[Et]=!0;const Kt=3*Et,Xt=this.circleKeys[Et];if(this._circlesCollide(pt[Kt],pt[Kt+1],pt[Kt+2],J.x,J.y,J.radius)&&(!H||H(Xt))&&!Bo(mt,Xt.overlapMode))return k.push(!0),!0}}}_forEachCell(s,d,v,S,D,k,j,H){const J=this._convertToXCellCoord(s),et=this._convertToYCellCoord(d),mt=this._convertToXCellCoord(v),ut=this._convertToYCellCoord(S);for(let St=J;St<=mt;St++)for(let pt=et;pt<=ut;pt++)if(D.call(this,s,d,v,S,this.xCellCount*pt+St,k,j,H))return}_convertToXCellCoord(s){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(s*this.xScale)))}_convertToYCellCoord(s){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(s*this.yScale)))}_circlesCollide(s,d,v,S,D,k){const j=S-s,H=D-d,J=v+k;return J*J>j*j+H*H}_circleAndRectCollide(s,d,v,S,D,k,j){const H=(k-S)/2,J=Math.abs(s-(S+H));if(J>H+v)return!1;const et=(j-D)/2,mt=Math.abs(d-(D+et));if(mt>et+v)return!1;if(J<=H||mt<=et)return!0;const ut=J-H,St=mt-et;return ut*ut+St*St<=v*v}}function se(C,s,d){const v=i.N();if(!C){const{vecSouth:mt,vecEast:ut}=tt(s),St=yi();St[0]=ut[0],St[1]=ut[1],St[2]=mt[0],St[3]=mt[1],S=St,(et=(k=(D=St)[0])*(J=D[3])-(H=D[2])*(j=D[1]))&&(S[0]=J*(et=1/et),S[1]=-j*et,S[2]=-H*et,S[3]=k*et),v[0]=St[0],v[1]=St[1],v[4]=St[2],v[5]=St[3]}var S,D,k,j,H,J,et;return i.Q(v,v,[1/d,1/d,1]),v}function st(C,s,d,v){if(C){const S=i.N();if(!s){const{vecSouth:D,vecEast:k}=tt(d);S[0]=k[0],S[1]=k[1],S[4]=D[0],S[5]=D[1]}return i.Q(S,S,[v,v,1]),S}return d.pixelsToClipSpaceMatrix}function tt(C){const s=Math.cos(C.rollInRadians),d=Math.sin(C.rollInRadians),v=Math.cos(C.pitchInRadians),S=Math.cos(C.bearingInRadians),D=Math.sin(C.bearingInRadians),k=i.aB();k[0]=-S*v*d-D*s,k[1]=-D*v*d+S*s;const j=i.aC(k);j<1e-9?i.aD(k):i.aE(k,k,1/j);const H=i.aB();H[0]=S*v*s-D*d,H[1]=D*v*s+S*d;const J=i.aC(H);return J<1e-9?i.aD(H):i.aE(H,H,1/J),{vecEast:H,vecSouth:k}}function Tt(C,s,d,v){let S;v?(S=[C,s,v(C,s),1],i.aG(S,S,d)):(S=[C,s,0,1],zo(S,S,d));const D=S[3];return{point:new i.P(S[0]/D,S[1]/D),signedDistanceFromCamera:D,isOccluded:!1}}function Nt(C,s){return .5+C/s*.5}function Wt(C,s){return C.x>=-s[0]&&C.x<=s[0]&&C.y>=-s[1]&&C.y<=s[1]}function oe(C,s,d,v,S,D,k,j,H,J,et,mt,ut){const St=d?C.textSizeData:C.iconSizeData,pt=i.ax(St,s.transform.zoom),Et=[256/s.width*2+1,256/s.height*2+1],Kt=d?C.text.dynamicLayoutVertexArray:C.icon.dynamicLayoutVertexArray;Kt.clear();const Xt=C.lineVertexArray,ft=d?C.text.placedSymbolArray:C.icon.placedSymbolArray,_e=s.transform.width/s.transform.height;let ce=!1;for(let me=0;me<ft.length;me++){const be=ft.get(me);if(be.hidden||be.writingMode===i.ay.vertical&&!ce){Pn(be.numGlyphs,Kt);continue}ce=!1;const de=new i.P(be.anchorX,be.anchorY),De={getElevation:ut,pitchedLabelPlaneMatrix:v,lineVertexArray:Xt,pitchWithMap:D,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:s.transform,tileAnchorPoint:de,unwrappedTileID:H,width:J,height:et,translation:mt},Qe=Xi(be.anchorX,be.anchorY,De);if(!Wt(Qe.point,Et)){Pn(be.numGlyphs,Kt);continue}const Xe=Nt(s.transform.cameraToCenterDistance,Qe.signedDistanceFromCamera),Je=i.az(St,pt,be),ii=D?Je*s.transform.getPitchedTextCorrection(be.anchorX,be.anchorY,H)/Xe:Je*Xe,Di=xe({projectionContext:De,pitchedLabelPlaneMatrixInverse:S,symbol:be,fontSize:ii,flip:!1,keepUpright:k,glyphOffsetArray:C.glyphOffsetArray,dynamicLayoutVertexArray:Kt,aspectRatio:_e,rotateToLine:j});ce=Di.useVertical,(Di.notEnoughRoom||ce||Di.needsFlipping&&xe({projectionContext:De,pitchedLabelPlaneMatrixInverse:S,symbol:be,fontSize:ii,flip:!0,keepUpright:k,glyphOffsetArray:C.glyphOffsetArray,dynamicLayoutVertexArray:Kt,aspectRatio:_e,rotateToLine:j}).notEnoughRoom)&&Pn(be.numGlyphs,Kt)}d?C.text.dynamicLayoutVertexBuffer.updateData(Kt):C.icon.dynamicLayoutVertexBuffer.updateData(Kt)}function ye(C,s,d,v,S,D,k,j){const H=D.glyphStartIndex+D.numGlyphs,J=D.lineStartIndex,et=D.lineStartIndex+D.lineLength,mt=s.getoffsetX(D.glyphStartIndex),ut=s.getoffsetX(H-1),St=Yi(C*mt,d,v,S,D.segment,J,et,j,k);if(!St)return null;const pt=Yi(C*ut,d,v,S,D.segment,J,et,j,k);return pt?j.projectionCache.anyProjectionOccluded?null:{first:St,last:pt}:null}function Jt(C,s,d,v){return C===i.ay.horizontal&&Math.abs(d.y-s.y)>Math.abs(d.x-s.x)*v?{useVertical:!0}:(C===i.ay.vertical?s.y<d.y:s.x>d.x)?{needsFlipping:!0}:null}function xe(C){const{projectionContext:s,pitchedLabelPlaneMatrixInverse:d,symbol:v,fontSize:S,flip:D,keepUpright:k,glyphOffsetArray:j,dynamicLayoutVertexArray:H,aspectRatio:J,rotateToLine:et}=C,mt=S/24,ut=v.lineOffsetX*mt,St=v.lineOffsetY*mt;let pt;if(v.numGlyphs>1){const Et=v.glyphStartIndex+v.numGlyphs,Kt=v.lineStartIndex,Xt=v.lineStartIndex+v.lineLength,ft=ye(mt,j,ut,St,D,v,et,s);if(!ft)return{notEnoughRoom:!0};const _e=Ji(ft.first.point.x,ft.first.point.y,s,d),ce=Ji(ft.last.point.x,ft.last.point.y,s,d);if(k&&!D){const me=Jt(v.writingMode,_e,ce,J);if(me)return me}pt=[ft.first];for(let me=v.glyphStartIndex+1;me<Et-1;me++){const be=Yi(mt*j.getoffsetX(me),ut,St,D,v.segment,Kt,Xt,s,et);if(!be)return{notEnoughRoom:!0};pt.push(be)}pt.push(ft.last)}else{if(k&&!D){const Kt=Mi(s.tileAnchorPoint.x,s.tileAnchorPoint.y,s).point,Xt=v.lineStartIndex+v.segment+1,ft=new i.P(s.lineVertexArray.getx(Xt),s.lineVertexArray.gety(Xt)),_e=Mi(ft.x,ft.y,s),ce=_e.signedDistanceFromCamera>0?_e.point:ti(s.tileAnchorPoint,ft,Kt,1,s),me=Ji(Kt.x,Kt.y,s,d),be=Ji(ce.x,ce.y,s,d),de=Jt(v.writingMode,me,be,J);if(de)return de}const Et=Yi(mt*j.getoffsetX(v.glyphStartIndex),ut,St,D,v.segment,v.lineStartIndex,v.lineStartIndex+v.lineLength,s,et);if(!Et||s.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};pt=[Et]}for(const Et of pt)i.aF(H,Et.point,Et.angle);return{}}function ti(C,s,d,v,S){const D=C.add(C.sub(s)._unit()),k=Mi(D.x,D.y,S).point,j=d.sub(k);return d.add(j._mult(v/j.mag()))}function $e(C,s,d){const v=s.projectionCache;if(v.projections[C])return v.projections[C];const S=new i.P(s.lineVertexArray.getx(C),s.lineVertexArray.gety(C)),D=Mi(S.x,S.y,s);if(D.signedDistanceFromCamera>0)return v.projections[C]=D.point,v.anyProjectionOccluded=v.anyProjectionOccluded||D.isOccluded,D.point;const k=C-d.direction;return ti(d.distanceFromAnchor===0?s.tileAnchorPoint:new i.P(s.lineVertexArray.getx(k),s.lineVertexArray.gety(k)),S,d.previousVertex,d.absOffsetX-d.distanceFromAnchor+1,s)}function Mi(C,s,d){const v=C+d.translation[0],S=s+d.translation[1];let D;return d.pitchWithMap?(D=Tt(v,S,d.pitchedLabelPlaneMatrix,d.getElevation),D.isOccluded=!1):(D=d.transform.projectTileCoordinates(v,S,d.unwrappedTileID,d.getElevation),D.point.x=(.5*D.point.x+.5)*d.width,D.point.y=(.5*-D.point.y+.5)*d.height),D}function Ji(C,s,d,v){if(d.pitchWithMap){const S=[C,s,0,1];return i.aG(S,S,v),d.transform.projectTileCoordinates(S[0]/S[3],S[1]/S[3],d.unwrappedTileID,d.getElevation).point}return{x:C/d.width*2-1,y:1-s/d.height*2}}function Xi(C,s,d){return d.transform.projectTileCoordinates(C,s,d.unwrappedTileID,d.getElevation)}function qi(C,s,d){return C._unit()._perp()._mult(s*d)}function hr(C,s,d,v,S,D,k,j,H){if(j.projectionCache.offsets[C])return j.projectionCache.offsets[C];const J=d.add(s);if(C+H.direction<v||C+H.direction>=S)return j.projectionCache.offsets[C]=J,J;const et=$e(C+H.direction,j,H),mt=qi(et.sub(d),k,H.direction),ut=d.add(mt),St=et.add(mt);return j.projectionCache.offsets[C]=i.aH(D,J,ut,St)||J,j.projectionCache.offsets[C]}function Yi(C,s,d,v,S,D,k,j,H){const J=v?C-s:C+s;let et=J>0?1:-1,mt=0;v&&(et*=-1,mt=Math.PI),et<0&&(mt+=Math.PI);let ut,St=et>0?D+S:D+S+1;j.projectionCache.cachedAnchorPoint?ut=j.projectionCache.cachedAnchorPoint:(ut=Mi(j.tileAnchorPoint.x,j.tileAnchorPoint.y,j).point,j.projectionCache.cachedAnchorPoint=ut);let pt,Et,Kt=ut,Xt=ut,ft=0,_e=0;const ce=Math.abs(J),me=[];let be;for(;ft+_e<=ce;){if(St+=et,St<D||St>=k)return null;ft+=_e,Xt=Kt,Et=pt;const Qe={absOffsetX:ce,direction:et,distanceFromAnchor:ft,previousVertex:Xt};if(Kt=$e(St,j,Qe),d===0)me.push(Xt),be=Kt.sub(Xt);else{let Xe;const Je=Kt.sub(Xt);Xe=Je.mag()===0?qi($e(St+et,j,Qe).sub(Kt),d,et):qi(Je,d,et),Et||(Et=Xt.add(Xe)),pt=hr(St,Xe,Kt,D,k,Et,d,j,Qe),me.push(Et),be=pt.sub(Et)}_e=be.mag()}const de=be._mult((ce-ft)/_e)._add(Et||Xt),De=mt+Math.atan2(Kt.y-Xt.y,Kt.x-Xt.x);return me.push(de),{point:de,angle:H?De:0,path:me}}const wn=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Pn(C,s){for(let d=0;d<C;d++){const v=s.length;s.resize(v+4),s.float32.set(wn,3*v)}}function zo(C,s,d){const v=s[0],S=s[1];return C[0]=d[0]*v+d[4]*S+d[12],C[1]=d[1]*v+d[5]*S+d[13],C[3]=d[3]*v+d[7]*S+d[15],C}const Gr=100;class Wn{constructor(s,d=new wo(s.width+200,s.height+200,25),v=new wo(s.width+200,s.height+200,25)){this.transform=s,this.grid=d,this.ignoredGrid=v,this.pitchFactor=Math.cos(s.pitch*Math.PI/180)*s.cameraToCenterDistance,this.screenRightBoundary=s.width+Gr,this.screenBottomBoundary=s.height+Gr,this.gridRightBoundary=s.width+200,this.gridBottomBoundary=s.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(s,d,v,S,D,k,j,H,J,et,mt,ut){const St=this.projectAndGetPerspectiveRatio(s.anchorPointX+H[0],s.anchorPointY+H[1],D,et,ut),pt=v*St.perspectiveRatio;let Et;if(k||j)Et=this._projectCollisionBox(s,pt,S,D,k,j,H,St,et,mt,ut);else{const be=St.x+(mt?mt.x*pt:0),de=St.y+(mt?mt.y*pt:0);Et={allPointsOccluded:!1,box:[be+s.x1*pt,de+s.y1*pt,be+s.x2*pt,de+s.y2*pt]}}const[Kt,Xt,ft,_e]=Et.box,ce=k?Et.allPointsOccluded:St.isOccluded;let me=ce;return me||(me=St.perspectiveRatio<this.perspectiveRatioCutoff),me||(me=!this.isInsideGrid(Kt,Xt,ft,_e)),me||d!=="always"&&this.grid.hitTest(Kt,Xt,ft,_e,d,J)?{box:[Kt,Xt,ft,_e],placeable:!1,offscreen:!1,occluded:ce}:{box:[Kt,Xt,ft,_e],placeable:!0,offscreen:this.isOffscreen(Kt,Xt,ft,_e),occluded:ce}}placeCollisionCircles(s,d,v,S,D,k,j,H,J,et,mt,ut,St,pt){const Et=[],Kt=new i.P(d.anchorX,d.anchorY),Xt=this.getPerspectiveRatio(Kt.x,Kt.y,k,pt),ft=(J?D*this.transform.getPitchedTextCorrection(d.anchorX,d.anchorY,k)/Xt:D*Xt)/i.aL,_e={getElevation:pt,pitchedLabelPlaneMatrix:j,lineVertexArray:v,pitchWithMap:J,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:Kt,unwrappedTileID:k,width:this.transform.width,height:this.transform.height,translation:St},ce=ye(ft,S,d.lineOffsetX*ft,d.lineOffsetY*ft,!1,d,!1,_e);let me=!1,be=!1,de=!0;if(ce){const De=.5*mt*Xt+ut,Qe=new i.P(-100,-100),Xe=new i.P(this.screenRightBoundary,this.screenBottomBoundary),Je=new bi,ii=ce.first,Di=ce.last;let Fi=[];for(let $r=ii.path.length-1;$r>=1;$r--)Fi.push(ii.path[$r]);for(let $r=1;$r<Di.path.length;$r++)Fi.push(Di.path[$r]);const wi=2.5*De;if(J){const $r=this.projectPathToScreenSpace(Fi,_e);Fi=$r.some(Nr=>Nr.signedDistanceFromCamera<=0)?[]:$r.map(Nr=>Nr.point)}let fr=[];if(Fi.length>0){const $r=Fi[0].clone(),Nr=Fi[0].clone();for(let co=1;co<Fi.length;co++)$r.x=Math.min($r.x,Fi[co].x),$r.y=Math.min($r.y,Fi[co].y),Nr.x=Math.max(Nr.x,Fi[co].x),Nr.y=Math.max(Nr.y,Fi[co].y);fr=$r.x>=Qe.x&&Nr.x<=Xe.x&&$r.y>=Qe.y&&Nr.y<=Xe.y?[Fi]:Nr.x<Qe.x||$r.x>Xe.x||Nr.y<Qe.y||$r.y>Xe.y?[]:i.aI([Fi],Qe.x,Qe.y,Xe.x,Xe.y)}for(const $r of fr){Je.reset($r,.25*De);let Nr=0;Nr=Je.length<=.5*De?1:Math.ceil(Je.paddedLength/wi)+1;for(let co=0;co<Nr;co++){const No=co/Math.max(Nr-1,1),Jo=Je.lerp(No),Vo=Jo.x+Gr,Es=Jo.y+Gr;Et.push(Vo,Es,De,0);const Ko=Vo-De,$n=Es-De,_s=Vo+De,Qo=Es+De;if(de=de&&this.isOffscreen(Ko,$n,_s,Qo),be=be||this.isInsideGrid(Ko,$n,_s,Qo),s!=="always"&&this.grid.hitTestCircle(Vo,Es,De,s,et)&&(me=!0,!H))return{circles:[],offscreen:!1,collisionDetected:me}}}}return{circles:!H&&me||!be||Xt<this.perspectiveRatioCutoff?[]:Et,offscreen:de,collisionDetected:me}}projectPathToScreenSpace(s,d){const v=function(S,D){const k=i.N();return i.aA(k,D.pitchedLabelPlaneMatrix),S.map(j=>{const H=Tt(j.x,j.y,k,D.getElevation),J=D.transform.projectTileCoordinates(H.point.x,H.point.y,D.unwrappedTileID,D.getElevation);return J.point.x=(.5*J.point.x+.5)*D.width,J.point.y=(.5*-J.point.y+.5)*D.height,J})}(s,d);return function(S){let D=0,k=0,j=0,H=0;for(let J=0;J<S.length;J++)S[J].isOccluded?(j=J+1,H=0):(H++,H>k&&(k=H,D=j));return S.slice(D,D+k)}(v)}queryRenderedSymbols(s){if(s.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const d=[],v=new i.ab;for(const mt of s){const ut=new i.P(mt.x+Gr,mt.y+Gr);v.extend(ut),d.push(ut)}const{minX:S,minY:D,maxX:k,maxY:j}=v,H=this.grid.query(S,D,k,j).concat(this.ignoredGrid.query(S,D,k,j)),J={},et={};for(const mt of H){const ut=mt.key;if(J[ut.bucketInstanceId]===void 0&&(J[ut.bucketInstanceId]={}),J[ut.bucketInstanceId][ut.featureIndex])continue;const St=[new i.P(mt.x1,mt.y1),new i.P(mt.x2,mt.y1),new i.P(mt.x2,mt.y2),new i.P(mt.x1,mt.y2)];i.aJ(d,St)&&(J[ut.bucketInstanceId][ut.featureIndex]=!0,et[ut.bucketInstanceId]===void 0&&(et[ut.bucketInstanceId]=[]),et[ut.bucketInstanceId].push(ut.featureIndex))}return et}insertCollisionBox(s,d,v,S,D,k){(v?this.ignoredGrid:this.grid).insert({bucketInstanceId:S,featureIndex:D,collisionGroupID:k,overlapMode:d},s[0],s[1],s[2],s[3])}insertCollisionCircles(s,d,v,S,D,k){const j=v?this.ignoredGrid:this.grid,H={bucketInstanceId:S,featureIndex:D,collisionGroupID:k,overlapMode:d};for(let J=0;J<s.length;J+=4)j.insertCircle(H,s[J],s[J+1],s[J+2])}projectAndGetPerspectiveRatio(s,d,v,S,D){if(D){let k;S?(k=[s,d,S(s,d),1],i.aG(k,k,D)):(k=[s,d,0,1],zo(k,k,D));const j=k[3];return{x:(k[0]/j+1)/2*this.transform.width+Gr,y:(-k[1]/j+1)/2*this.transform.height+Gr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/j*.5,isOccluded:!1,signedDistanceFromCamera:j}}{const k=this.transform.projectTileCoordinates(s,d,v,S);return{x:(k.point.x+1)/2*this.transform.width+Gr,y:(1-k.point.y)/2*this.transform.height+Gr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/k.signedDistanceFromCamera*.5,isOccluded:k.isOccluded,signedDistanceFromCamera:k.signedDistanceFromCamera}}}getPerspectiveRatio(s,d,v,S){const D=this.transform.projectTileCoordinates(s,d,v,S);return .5+this.transform.cameraToCenterDistance/D.signedDistanceFromCamera*.5}isOffscreen(s,d,v,S){return v<Gr||s>=this.screenRightBoundary||S<Gr||d>this.screenBottomBoundary}isInsideGrid(s,d,v,S){return v>=0&&s<this.gridRightBoundary&&S>=0&&d<this.gridBottomBoundary}getViewportMatrix(){const s=i.ar([]);return i.O(s,s,[-100,-100,0]),s}_projectCollisionBox(s,d,v,S,D,k,j,H,J,et,mt){let ut=1,St=0,pt=0,Et=1;const Kt=s.anchorPointX+j[0],Xt=s.anchorPointY+j[1];if(k&&!D){const Fi=this.projectAndGetPerspectiveRatio(Kt+1,Xt,S,J,mt),wi=Fi.x-H.x,fr=Math.atan((Fi.y-H.y)/wi)+(wi<0?Math.PI:0),$r=Math.sin(fr),Nr=Math.cos(fr);ut=Nr,St=$r,pt=-$r,Et=Nr}else if(!k&&D){const Fi=tt(this.transform);ut=Fi.vecEast[0],St=Fi.vecEast[1],pt=Fi.vecSouth[0],Et=Fi.vecSouth[1]}let ft=H.x,_e=H.y,ce=d;D&&(ft=Kt,_e=Xt,ce=Math.pow(2,-(this.transform.zoom-v.overscaledZ)),ce*=this.transform.getPitchedTextCorrection(Kt,Xt,S),et||(ce*=i.an(.5+H.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),et&&(ft+=ut*et.x*ce+pt*et.y*ce,_e+=St*et.x*ce+Et*et.y*ce);const me=s.x1*ce,be=s.x2*ce,de=(me+be)/2,De=s.y1*ce,Qe=s.y2*ce,Xe=(De+Qe)/2,Je=[{offsetX:me,offsetY:De},{offsetX:de,offsetY:De},{offsetX:be,offsetY:De},{offsetX:be,offsetY:Xe},{offsetX:be,offsetY:Qe},{offsetX:de,offsetY:Qe},{offsetX:me,offsetY:Qe},{offsetX:me,offsetY:Xe}];let ii=[];for(const{offsetX:Fi,offsetY:wi}of Je)ii.push(new i.P(ft+ut*Fi+pt*wi,_e+St*Fi+Et*wi));let Di=!1;if(D){const Fi=ii.map(wi=>this.projectAndGetPerspectiveRatio(wi.x,wi.y,S,J,mt));Di=Fi.some(wi=>!wi.isOccluded),ii=Fi.map(wi=>new i.P(wi.x,wi.y))}else Di=!0;return{box:i.aK(ii),allPointsOccluded:!Di}}}class an{constructor(s,d,v,S){this.opacity=s?Math.max(0,Math.min(1,s.opacity+(s.placed?d:-d))):S&&v?1:0,this.placed=v}isHidden(){return this.opacity===0&&!this.placed}}class Rr{constructor(s,d,v,S,D){this.text=new an(s?s.text:null,d,v,D),this.icon=new an(s?s.icon:null,d,S,D)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Bn{constructor(s,d,v){this.text=s,this.icon=d,this.skipFade=v}}class jn{constructor(s,d,v,S,D){this.bucketInstanceId=s,this.featureIndex=d,this.sourceLayerIndex=v,this.bucketIndex=S,this.tileID=D}}class Tn{constructor(s){this.crossSourceCollisions=s,this.maxGroupID=0,this.collisionGroups={}}get(s){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[s]){const d=++this.maxGroupID;this.collisionGroups[s]={ID:d,predicate:v=>v.collisionGroupID===d}}return this.collisionGroups[s]}}function Gn(C,s,d,v,S){const{horizontalAlign:D,verticalAlign:k}=i.aR(C);return new i.P(-(D-.5)*s+v[0]*S,-(k-.5)*d+v[1]*S)}class os{constructor(s,d,v,S,D){this.transform=s.clone(),this.terrain=d,this.collisionIndex=new Wn(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=v,this.retainedQueryData={},this.collisionGroups=new Tn(S),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=D,D&&(D.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(s){const d=this.terrain;return d?(v,S)=>d.getElevation(s,v,S):null}getBucketParts(s,d,v,S){const D=v.getBucket(d),k=v.latestFeatureIndex;if(!D||!k||d.id!==D.layerIds[0])return;const j=v.collisionBoxArray,H=D.layers[0].layout,J=D.layers[0].paint,et=Math.pow(2,this.transform.zoom-v.tileID.overscaledZ),mt=v.tileSize/i.a4,ut=v.tileID.toUnwrapped(),St=H.get("text-rotation-alignment")==="map",pt=i.aM(v,1,this.transform.zoom),Et=i.aN(this.collisionIndex.transform,v,J.get("text-translate"),J.get("text-translate-anchor")),Kt=i.aN(this.collisionIndex.transform,v,J.get("icon-translate"),J.get("icon-translate-anchor")),Xt=se(St,this.transform,pt);this.retainedQueryData[D.bucketInstanceId]=new jn(D.bucketInstanceId,k,D.sourceLayerIndex,D.index,v.tileID);const ft={bucket:D,layout:H,translationText:Et,translationIcon:Kt,unwrappedTileID:ut,pitchedLabelPlaneMatrix:Xt,scale:et,textPixelRatio:mt,holdingForFade:v.holdingForSymbolFade(),collisionBoxArray:j,partiallyEvaluatedTextSize:i.ax(D.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(D.sourceID)};if(S)for(const _e of D.sortKeyRanges){const{sortKey:ce,symbolInstanceStart:me,symbolInstanceEnd:be}=_e;s.push({sortKey:ce,symbolInstanceStart:me,symbolInstanceEnd:be,parameters:ft})}else s.push({symbolInstanceStart:0,symbolInstanceEnd:D.symbolInstances.length,parameters:ft})}attemptAnchorPlacement(s,d,v,S,D,k,j,H,J,et,mt,ut,St,pt,Et,Kt,Xt,ft,_e,ce){const me=i.aO[s.textAnchor],be=[s.textOffset0,s.textOffset1],de=Gn(me,v,S,be,D),De=this.collisionIndex.placeCollisionBox(d,ut,H,J,et,j,k,Kt,mt.predicate,_e,de,ce);if((!ft||this.collisionIndex.placeCollisionBox(ft,ut,H,J,et,j,k,Xt,mt.predicate,_e,de,ce).placeable)&&De.placeable){let Qe;if(this.prevPlacement&&this.prevPlacement.variableOffsets[St.crossTileID]&&this.prevPlacement.placements[St.crossTileID]&&this.prevPlacement.placements[St.crossTileID].text&&(Qe=this.prevPlacement.variableOffsets[St.crossTileID].anchor),St.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[St.crossTileID]={textOffset:be,width:v,height:S,anchor:me,textBoxScale:D,prevAnchor:Qe},this.markUsedJustification(pt,me,St,Et),pt.allowVerticalPlacement&&(this.markUsedOrientation(pt,Et,St),this.placedOrientations[St.crossTileID]=Et),{shift:de,placedGlyphBoxes:De}}}placeLayerBucketPart(s,d,v){const{bucket:S,layout:D,translationText:k,translationIcon:j,unwrappedTileID:H,pitchedLabelPlaneMatrix:J,textPixelRatio:et,holdingForFade:mt,collisionBoxArray:ut,partiallyEvaluatedTextSize:St,collisionGroup:pt}=s.parameters,Et=D.get("text-optional"),Kt=D.get("icon-optional"),Xt=i.aP(D,"text-overlap","text-allow-overlap"),ft=Xt==="always",_e=i.aP(D,"icon-overlap","icon-allow-overlap"),ce=_e==="always",me=D.get("text-rotation-alignment")==="map",be=D.get("text-pitch-alignment")==="map",de=D.get("icon-text-fit")!=="none",De=D.get("symbol-z-order")==="viewport-y",Qe=ft&&(ce||!S.hasIconData()||Kt),Xe=ce&&(ft||!S.hasTextData()||Et);!S.collisionArrays&&ut&&S.deserializeCollisionBoxes(ut);const Je=this.retainedQueryData[S.bucketInstanceId].tileID,ii=this._getTerrainElevationFunc(Je),Di=this.transform.getFastPathSimpleProjectionMatrix(Je),Fi=(wi,fr,$r)=>{var Nr,co;if(d[wi.crossTileID])return;if(mt)return void(this.placements[wi.crossTileID]=new Bn(!1,!1,!1));let No=!1,Jo=!1,Vo=!0,Es=null,Ko={box:null,placeable:!1,offscreen:null,occluded:!1},$n={placeable:!1},_s=null,Qo=null,Jr=null,vr=0,Jl=0,ys=0;fr.textFeatureIndex?vr=fr.textFeatureIndex:wi.useRuntimeCollisionCircles&&(vr=wi.featureIndex),fr.verticalTextFeatureIndex&&(Jl=fr.verticalTextFeatureIndex);const ml=fr.textBox;if(ml){const Wa=Po=>{let Mo=i.ay.horizontal;if(S.allowVerticalPlacement&&!Po&&this.prevPlacement){const hs=this.prevPlacement.placedOrientations[wi.crossTileID];hs&&(this.placedOrientations[wi.crossTileID]=hs,Mo=hs,this.markUsedOrientation(S,Mo,wi))}return Mo},Ql=(Po,Mo)=>{if(S.allowVerticalPlacement&&wi.numVerticalGlyphVertices>0&&fr.verticalTextBox){for(const hs of S.writingModes)if(hs===i.ay.vertical?(Ko=Mo(),$n=Ko):Ko=Po(),Ko&&Ko.placeable)break}else Ko=Po()},Uc=wi.textAnchorOffsetStartIndex,Zs=wi.textAnchorOffsetEndIndex;if(Zs===Uc){const Po=(Mo,hs)=>{const To=this.collisionIndex.placeCollisionBox(Mo,Xt,et,Je,H,be,me,k,pt.predicate,ii,void 0,Di);return To&&To.placeable&&(this.markUsedOrientation(S,hs,wi),this.placedOrientations[wi.crossTileID]=hs),To};Ql(()=>Po(ml,i.ay.horizontal),()=>{const Mo=fr.verticalTextBox;return S.allowVerticalPlacement&&wi.numVerticalGlyphVertices>0&&Mo?Po(Mo,i.ay.vertical):{box:null,offscreen:null}}),Wa(Ko&&Ko.placeable)}else{let Po=i.aO[(co=(Nr=this.prevPlacement)===null||Nr===void 0?void 0:Nr.variableOffsets[wi.crossTileID])===null||co===void 0?void 0:co.anchor];const Mo=(To,Ll,ch)=>{const Mp=To.x2-To.x1,Rl=To.y2-To.y1,hh=wi.textBoxScale,Cp=de&&_e==="never"?Ll:null;let kl=null,uh=Xt==="never"?1:2,qn="never";Po&&uh++;for(let Fl=0;Fl<uh;Fl++){for(let gc=Uc;gc<Zs;gc++){const Wd=S.textAnchorOffsets.get(gc);if(Po&&Wd.textAnchor!==Po)continue;const dh=this.attemptAnchorPlacement(Wd,To,Mp,Rl,hh,me,be,et,Je,H,pt,qn,wi,S,ch,k,j,Cp,ii);if(dh&&(kl=dh.placedGlyphBoxes,kl&&kl.placeable))return No=!0,Es=dh.shift,kl}Po?Po=null:qn=Xt}return v&&!kl&&(kl={box:this.collisionIndex.placeCollisionBox(ml,"always",et,Je,H,be,me,k,pt.predicate,ii,void 0,Di).box,offscreen:!1,placeable:!1,occluded:!1}),kl};Ql(()=>Mo(ml,fr.iconBox,i.ay.horizontal),()=>{const To=fr.verticalTextBox;return S.allowVerticalPlacement&&(!Ko||!Ko.placeable)&&wi.numVerticalGlyphVertices>0&&To?Mo(To,fr.verticalIconBox,i.ay.vertical):{box:null,occluded:!0,offscreen:null}}),Ko&&(No=Ko.placeable,Vo=Ko.offscreen);const hs=Wa(Ko&&Ko.placeable);if(!No&&this.prevPlacement){const To=this.prevPlacement.variableOffsets[wi.crossTileID];To&&(this.variableOffsets[wi.crossTileID]=To,this.markUsedJustification(S,To.anchor,wi,hs))}}}if(_s=Ko,No=_s&&_s.placeable,Vo=_s&&_s.offscreen,wi.useRuntimeCollisionCircles&&wi.centerJustifiedTextSymbolIndex>=0){const Wa=S.text.placedSymbolArray.get(wi.centerJustifiedTextSymbolIndex),Ql=i.az(S.textSizeData,St,Wa),Uc=D.get("text-padding");Qo=this.collisionIndex.placeCollisionCircles(Xt,Wa,S.lineVertexArray,S.glyphOffsetArray,Ql,H,J,v,be,pt.predicate,wi.collisionCircleDiameter,Uc,k,ii),Qo.circles.length&&Qo.collisionDetected&&!v&&i.w("Collisions detected, but collision boxes are not shown"),No=ft||Qo.circles.length>0&&!Qo.collisionDetected,Vo=Vo&&Qo.offscreen}if(fr.iconFeatureIndex&&(ys=fr.iconFeatureIndex),fr.iconBox){const Wa=Ql=>this.collisionIndex.placeCollisionBox(Ql,_e,et,Je,H,be,me,j,pt.predicate,ii,de&&Es?Es:void 0,Di);$n&&$n.placeable&&fr.verticalIconBox?(Jr=Wa(fr.verticalIconBox),Jo=Jr.placeable):(Jr=Wa(fr.iconBox),Jo=Jr.placeable),Vo=Vo&&Jr.offscreen}const Kl=Et||wi.numHorizontalGlyphVertices===0&&wi.numVerticalGlyphVertices===0,Fs=Kt||wi.numIconVertices===0;Kl||Fs?Fs?Kl||(Jo=Jo&&No):No=Jo&&No:Jo=No=Jo&&No;const mc=Jo&&Jr.placeable;if(No&&_s.placeable&&this.collisionIndex.insertCollisionBox(_s.box,Xt,D.get("text-ignore-placement"),S.bucketInstanceId,$n&&$n.placeable&&Jl?Jl:vr,pt.ID),mc&&this.collisionIndex.insertCollisionBox(Jr.box,_e,D.get("icon-ignore-placement"),S.bucketInstanceId,ys,pt.ID),Qo&&No&&this.collisionIndex.insertCollisionCircles(Qo.circles,Xt,D.get("text-ignore-placement"),S.bucketInstanceId,vr,pt.ID),v&&this.storeCollisionData(S.bucketInstanceId,$r,fr,_s,Jr,Qo),wi.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(S.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[wi.crossTileID]=new Bn((No||Qe)&&!_s?.occluded,(Jo||Xe)&&!Jr?.occluded,Vo||S.justReloaded),d[wi.crossTileID]=!0};if(De){if(s.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const wi=S.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let fr=wi.length-1;fr>=0;--fr){const $r=wi[fr];Fi(S.symbolInstances.get($r),S.collisionArrays[$r],$r)}}else for(let wi=s.symbolInstanceStart;wi<s.symbolInstanceEnd;wi++)Fi(S.symbolInstances.get(wi),S.collisionArrays[wi],wi);S.justReloaded=!1}storeCollisionData(s,d,v,S,D,k){if(v.textBox||v.iconBox){let j,H;this.collisionBoxArrays.has(s)?j=this.collisionBoxArrays.get(s):(j=new Map,this.collisionBoxArrays.set(s,j)),j.has(d)?H=j.get(d):(H={text:null,icon:null},j.set(d,H)),v.textBox&&(H.text=S.box),v.iconBox&&(H.icon=D.box)}if(k){let j=this.collisionCircleArrays[s];j===void 0&&(j=this.collisionCircleArrays[s]=[]);for(let H=0;H<k.circles.length;H+=4)j.push(k.circles[H+0]-Gr),j.push(k.circles[H+1]-Gr),j.push(k.circles[H+2]),j.push(k.collisionDetected?1:0)}}markUsedJustification(s,d,v,S){let D;D=S===i.ay.vertical?v.verticalPlacedTextSymbolIndex:{left:v.leftJustifiedTextSymbolIndex,center:v.centerJustifiedTextSymbolIndex,right:v.rightJustifiedTextSymbolIndex}[i.aQ(d)];const k=[v.leftJustifiedTextSymbolIndex,v.centerJustifiedTextSymbolIndex,v.rightJustifiedTextSymbolIndex,v.verticalPlacedTextSymbolIndex];for(const j of k)j>=0&&(s.text.placedSymbolArray.get(j).crossTileID=D>=0&&j!==D?0:v.crossTileID)}markUsedOrientation(s,d,v){const S=d===i.ay.horizontal||d===i.ay.horizontalOnly?d:0,D=d===i.ay.vertical?d:0,k=[v.leftJustifiedTextSymbolIndex,v.centerJustifiedTextSymbolIndex,v.rightJustifiedTextSymbolIndex];for(const j of k)s.text.placedSymbolArray.get(j).placedOrientation=S;v.verticalPlacedTextSymbolIndex&&(s.text.placedSymbolArray.get(v.verticalPlacedTextSymbolIndex).placedOrientation=D)}commit(s){this.commitTime=s,this.zoomAtLastRecencyCheck=this.transform.zoom;const d=this.prevPlacement;let v=!1;this.prevZoomAdjustment=d?d.zoomAdjustment(this.transform.zoom):0;const S=d?d.symbolFadeChange(s):1,D=d?d.opacities:{},k=d?d.variableOffsets:{},j=d?d.placedOrientations:{};for(const H in this.placements){const J=this.placements[H],et=D[H];et?(this.opacities[H]=new Rr(et,S,J.text,J.icon),v=v||J.text!==et.text.placed||J.icon!==et.icon.placed):(this.opacities[H]=new Rr(null,S,J.text,J.icon,J.skipFade),v=v||J.text||J.icon)}for(const H in D){const J=D[H];if(!this.opacities[H]){const et=new Rr(J,S,!1,!1);et.isHidden()||(this.opacities[H]=et,v=v||J.text.placed||J.icon.placed)}}for(const H in k)this.variableOffsets[H]||!this.opacities[H]||this.opacities[H].isHidden()||(this.variableOffsets[H]=k[H]);for(const H in j)this.placedOrientations[H]||!this.opacities[H]||this.opacities[H].isHidden()||(this.placedOrientations[H]=j[H]);if(d&&d.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");v?this.lastPlacementChangeTime=s:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=d?d.lastPlacementChangeTime:s)}updateLayerOpacities(s,d){const v={};for(const S of d){const D=S.getBucket(s);D&&S.latestFeatureIndex&&s.id===D.layerIds[0]&&this.updateBucketOpacities(D,S.tileID,v,S.collisionBoxArray)}}updateBucketOpacities(s,d,v,S){s.hasTextData()&&(s.text.opacityVertexArray.clear(),s.text.hasVisibleVertices=!1),s.hasIconData()&&(s.icon.opacityVertexArray.clear(),s.icon.hasVisibleVertices=!1),s.hasIconCollisionBoxData()&&s.iconCollisionBox.collisionVertexArray.clear(),s.hasTextCollisionBoxData()&&s.textCollisionBox.collisionVertexArray.clear();const D=s.layers[0],k=D.layout,j=new Rr(null,0,!1,!1,!0),H=k.get("text-allow-overlap"),J=k.get("icon-allow-overlap"),et=D._unevaluatedLayout.hasValue("text-variable-anchor")||D._unevaluatedLayout.hasValue("text-variable-anchor-offset"),mt=k.get("text-rotation-alignment")==="map",ut=k.get("text-pitch-alignment")==="map",St=k.get("icon-text-fit")!=="none",pt=new Rr(null,0,H&&(J||!s.hasIconData()||k.get("icon-optional")),J&&(H||!s.hasTextData()||k.get("text-optional")),!0);!s.collisionArrays&&S&&(s.hasIconCollisionBoxData()||s.hasTextCollisionBoxData())&&s.deserializeCollisionBoxes(S);const Et=(Xt,ft,_e)=>{for(let ce=0;ce<ft/4;ce++)Xt.opacityVertexArray.emplaceBack(_e);Xt.hasVisibleVertices=Xt.hasVisibleVertices||_e!==ql},Kt=this.collisionBoxArrays.get(s.bucketInstanceId);for(let Xt=0;Xt<s.symbolInstances.length;Xt++){const ft=s.symbolInstances.get(Xt),{numHorizontalGlyphVertices:_e,numVerticalGlyphVertices:ce,crossTileID:me}=ft;let be=this.opacities[me];v[me]?be=j:be||(be=pt,this.opacities[me]=be),v[me]=!0;const de=ft.numIconVertices>0,De=this.placedOrientations[ft.crossTileID],Qe=De===i.ay.vertical,Xe=De===i.ay.horizontal||De===i.ay.horizontalOnly;if(_e>0||ce>0){const ii=$a(be.text);Et(s.text,_e,Qe?ql:ii),Et(s.text,ce,Xe?ql:ii);const Di=be.text.isHidden();[ft.rightJustifiedTextSymbolIndex,ft.centerJustifiedTextSymbolIndex,ft.leftJustifiedTextSymbolIndex].forEach(fr=>{fr>=0&&(s.text.placedSymbolArray.get(fr).hidden=Di||Qe?1:0)}),ft.verticalPlacedTextSymbolIndex>=0&&(s.text.placedSymbolArray.get(ft.verticalPlacedTextSymbolIndex).hidden=Di||Xe?1:0);const Fi=this.variableOffsets[ft.crossTileID];Fi&&this.markUsedJustification(s,Fi.anchor,ft,De);const wi=this.placedOrientations[ft.crossTileID];wi&&(this.markUsedJustification(s,"left",ft,wi),this.markUsedOrientation(s,wi,ft))}if(de){const ii=$a(be.icon),Di=!(St&&ft.verticalPlacedIconSymbolIndex&&Qe);ft.placedIconSymbolIndex>=0&&(Et(s.icon,ft.numIconVertices,Di?ii:ql),s.icon.placedSymbolArray.get(ft.placedIconSymbolIndex).hidden=be.icon.isHidden()),ft.verticalPlacedIconSymbolIndex>=0&&(Et(s.icon,ft.numVerticalIconVertices,Di?ql:ii),s.icon.placedSymbolArray.get(ft.verticalPlacedIconSymbolIndex).hidden=be.icon.isHidden())}const Je=Kt&&Kt.has(Xt)?Kt.get(Xt):{text:null,icon:null};if(s.hasIconCollisionBoxData()||s.hasTextCollisionBoxData()){const ii=s.collisionArrays[Xt];if(ii){let Di=new i.P(0,0);if(ii.textBox||ii.verticalTextBox){let Fi=!0;if(et){const wi=this.variableOffsets[me];wi?(Di=Gn(wi.anchor,wi.width,wi.height,wi.textOffset,wi.textBoxScale),mt&&Di._rotate(ut?-this.transform.bearingInRadians:this.transform.bearingInRadians)):Fi=!1}if(ii.textBox||ii.verticalTextBox){let wi;ii.textBox&&(wi=Qe),ii.verticalTextBox&&(wi=Xe),ta(s.textCollisionBox.collisionVertexArray,be.text.placed,!Fi||wi,Je.text,Di.x,Di.y)}}if(ii.iconBox||ii.verticalIconBox){const Fi=!!(!Xe&&ii.verticalIconBox);let wi;ii.iconBox&&(wi=Fi),ii.verticalIconBox&&(wi=!Fi),ta(s.iconCollisionBox.collisionVertexArray,be.icon.placed,wi,Je.icon,St?Di.x:0,St?Di.y:0)}}}}if(s.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[s.bucketInstanceId]&&(this.retainedQueryData[s.bucketInstanceId].featureSortOrder=s.featureSortOrder),s.hasTextData()&&s.text.opacityVertexBuffer&&s.text.opacityVertexBuffer.updateData(s.text.opacityVertexArray),s.hasIconData()&&s.icon.opacityVertexBuffer&&s.icon.opacityVertexBuffer.updateData(s.icon.opacityVertexArray),s.hasIconCollisionBoxData()&&s.iconCollisionBox.collisionVertexBuffer&&s.iconCollisionBox.collisionVertexBuffer.updateData(s.iconCollisionBox.collisionVertexArray),s.hasTextCollisionBoxData()&&s.textCollisionBox.collisionVertexBuffer&&s.textCollisionBox.collisionVertexBuffer.updateData(s.textCollisionBox.collisionVertexArray),s.text.opacityVertexArray.length!==s.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${s.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${s.text.layoutVertexArray.length}) / 4`);if(s.icon.opacityVertexArray.length!==s.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${s.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${s.icon.layoutVertexArray.length}) / 4`);s.bucketInstanceId in this.collisionCircleArrays&&(s.collisionCircleArray=this.collisionCircleArrays[s.bucketInstanceId],delete this.collisionCircleArrays[s.bucketInstanceId])}symbolFadeChange(s){return this.fadeDuration===0?1:(s-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(s){return Math.max(0,(this.transform.zoom-s)/1.5)}hasTransitions(s){return this.stale||s-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(s,d){const v=this.zoomAtLastRecencyCheck===d?1-this.zoomAdjustment(d):1;return this.zoomAtLastRecencyCheck=d,this.commitTime+this.fadeDuration*v>s}setStale(){this.stale=!0}}function ta(C,s,d,v,S,D){v&&v.length!==0||(v=[0,0,0,0]);const k=v[0]-Gr,j=v[1]-Gr,H=v[2]-Gr,J=v[3]-Gr;C.emplaceBack(s?1:0,d?1:0,S||0,D||0,k,j),C.emplaceBack(s?1:0,d?1:0,S||0,D||0,H,j),C.emplaceBack(s?1:0,d?1:0,S||0,D||0,H,J),C.emplaceBack(s?1:0,d?1:0,S||0,D||0,k,J)}const El=Math.pow(2,25),wh=Math.pow(2,24),es=Math.pow(2,17),nl=Math.pow(2,16),_a=Math.pow(2,9),Al=Math.pow(2,8),Pa=Math.pow(2,1);function $a(C){if(C.opacity===0&&!C.placed)return 0;if(C.opacity===1&&C.placed)return 4294967295;const s=C.placed?1:0,d=Math.floor(127*C.opacity);return d*El+s*wh+d*es+s*nl+d*_a+s*Al+d*Pa+s}const ql=0;class Th{constructor(s){this._sortAcrossTiles=s.layout.get("symbol-z-order")!=="viewport-y"&&!s.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(s,d,v,S,D){const k=this._bucketParts;for(;this._currentTileIndex<s.length;)if(d.getBucketParts(k,S,s[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,D())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,k.sort((j,H)=>j.sortKey-H.sortKey));this._currentPartIndex<k.length;)if(d.placeLayerBucketPart(k[this._currentPartIndex],this._seenCrossTileIDs,v),this._currentPartIndex++,D())return!0;return!1}}class Ou{constructor(s,d,v,S,D,k,j,H){this.placement=new os(s,d,k,j,H),this._currentPlacementIndex=v.length-1,this._forceFullPlacement=S,this._showCollisionBoxes=D,this._done=!1}isDone(){return this._done}continuePlacement(s,d,v){const S=Ri(),D=()=>!this._forceFullPlacement&&Ri()-S>2;for(;this._currentPlacementIndex>=0;){const k=d[s[this._currentPlacementIndex]],j=this.placement.collisionIndex.transform.zoom;if(k.type==="symbol"&&(!k.minzoom||k.minzoom<=j)&&(!k.maxzoom||k.maxzoom>j)){if(this._inProgressLayer||(this._inProgressLayer=new Th(k)),this._inProgressLayer.continuePlacement(v[k.source],this.placement,this._showCollisionBoxes,k,D))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(s){return this.placement.commit(s),this.placement}}const ol=512/i.a4/2;class Ma{constructor(s,d,v){this.tileID=s,this.bucketInstanceId=v,this._symbolsByKey={};const S=new Map;for(let D=0;D<d.length;D++){const k=d.get(D),j=k.key,H=S.get(j);H?H.push(k):S.set(j,[k])}for(const[D,k]of S){const j={positions:k.map(H=>({x:Math.floor(H.anchorX*ol),y:Math.floor(H.anchorY*ol)})),crossTileIDs:k.map(H=>H.crossTileID)};if(j.positions.length>128){const H=new i.aS(j.positions.length,16,Uint16Array);for(const{x:J,y:et}of j.positions)H.add(J,et);H.finish(),delete j.positions,j.index=H}this._symbolsByKey[D]=j}}getScaledCoordinates(s,d){const{x:v,y:S,z:D}=this.tileID.canonical,{x:k,y:j,z:H}=d.canonical,J=ol/Math.pow(2,H-D),et=(j*i.a4+s.anchorY)*J,mt=S*i.a4*ol;return{x:Math.floor((k*i.a4+s.anchorX)*J-v*i.a4*ol),y:Math.floor(et-mt)}}findMatches(s,d,v){const S=this.tileID.canonical.z<d.canonical.z?1:Math.pow(2,this.tileID.canonical.z-d.canonical.z);for(let D=0;D<s.length;D++){const k=s.get(D);if(k.crossTileID)continue;const j=this._symbolsByKey[k.key];if(!j)continue;const H=this.getScaledCoordinates(k,d);if(j.index){const J=j.index.range(H.x-S,H.y-S,H.x+S,H.y+S).sort();for(const et of J){const mt=j.crossTileIDs[et];if(!v[mt]){v[mt]=!0,k.crossTileID=mt;break}}}else if(j.positions)for(let J=0;J<j.positions.length;J++){const et=j.positions[J],mt=j.crossTileIDs[J];if(Math.abs(et.x-H.x)<=S&&Math.abs(et.y-H.y)<=S&&!v[mt]){v[mt]=!0,k.crossTileID=mt;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:s})=>s)}}class oc{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class ss{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(s){const d=Math.round((s-this.lng)/360);if(d!==0)for(const v in this.indexes){const S=this.indexes[v],D={};for(const k in S){const j=S[k];j.tileID=j.tileID.unwrapTo(j.tileID.wrap+d),D[j.tileID.key]=j}this.indexes[v]=D}this.lng=s}addBucket(s,d,v){if(this.indexes[s.overscaledZ]&&this.indexes[s.overscaledZ][s.key]){if(this.indexes[s.overscaledZ][s.key].bucketInstanceId===d.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(s.overscaledZ,this.indexes[s.overscaledZ][s.key])}for(let D=0;D<d.symbolInstances.length;D++)d.symbolInstances.get(D).crossTileID=0;this.usedCrossTileIDs[s.overscaledZ]||(this.usedCrossTileIDs[s.overscaledZ]={});const S=this.usedCrossTileIDs[s.overscaledZ];for(const D in this.indexes){const k=this.indexes[D];if(Number(D)>s.overscaledZ)for(const j in k){const H=k[j];H.tileID.isChildOf(s)&&H.findMatches(d.symbolInstances,s,S)}else{const j=k[s.scaledTo(Number(D)).key];j&&j.findMatches(d.symbolInstances,s,S)}}for(let D=0;D<d.symbolInstances.length;D++){const k=d.symbolInstances.get(D);k.crossTileID||(k.crossTileID=v.generate(),S[k.crossTileID]=!0)}return this.indexes[s.overscaledZ]===void 0&&(this.indexes[s.overscaledZ]={}),this.indexes[s.overscaledZ][s.key]=new Ma(s,d.symbolInstances,d.bucketInstanceId),!0}removeBucketCrossTileIDs(s,d){for(const v of d.getCrossTileIDsLists())for(const S of v)delete this.usedCrossTileIDs[s][S]}removeStaleBuckets(s){let d=!1;for(const v in this.indexes){const S=this.indexes[v];for(const D in S)s[S[D].bucketInstanceId]||(this.removeBucketCrossTileIDs(v,S[D]),delete S[D],d=!0)}return d}}class Gs{constructor(){this.layerIndexes={},this.crossTileIDs=new oc,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(s,d,v){let S=this.layerIndexes[s.id];S===void 0&&(S=this.layerIndexes[s.id]=new ss);let D=!1;const k={};S.handleWrapJump(v);for(const j of d){const H=j.getBucket(s);H&&s.id===H.layerIds[0]&&(H.bucketInstanceId||(H.bucketInstanceId=++this.maxBucketInstanceId),S.addBucket(j.tileID,H,this.crossTileIDs)&&(D=!0),k[H.bucketInstanceId]=!0)}return S.removeStaleBuckets(k)&&(D=!0),D}pruneUnusedLayers(s){const d={};s.forEach(v=>{d[v]=!0});for(const v in this.layerIndexes)d[v]||delete this.layerIndexes[v]}}var tn="void main() {fragColor=vec4(1.0);}";const ea={prelude:Mn(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:Mn("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:Mn("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:Mn(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:Mn(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Mn(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Mn(tn,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:Mn(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:Mn(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Mn("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Mn("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),colorRelief:Mn(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;uniform vec4 u_unpack;uniform sampler2D u_elevation_stops;uniform sampler2D u_color_stops;uniform int u_color_ramp_size;uniform float u_opacity;in vec2 v_pos;float getElevation(vec2 coord) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}float getElevationStop(int stop) {float x=(float(stop)+0.5)/float(u_color_ramp_size);vec4 data=texture(u_elevation_stops,vec2(x,0))*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {float el=getElevation(v_pos);int r=(u_color_ramp_size-1);int l=0;float el_l=getElevationStop(l);float el_r=getElevationStop(r);while(r-l > 1){int m=(r+l)/2;float el_m=getElevationStop(m);if(el < el_m){r=m;el_r=el_m;}else
{l=m;el_l=el_m;}}float x=(float(l)+(el-el_l)/(el_r-el_l)+0.5)/float(u_color_ramp_size);fragColor=u_opacity*texture(u_color_stops,vec2(x,0));
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_dimension;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_pos/8192.0)*scale+epsilon;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),debug:Mn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:Mn(tn,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:Mn(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:Mn(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:Mn(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:Mn(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Mn(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Mn(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Mn(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {vec2 epsilon=1.0/u_dimension;float tileSize=u_dimension.x-2.0;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))*tileSize/pow(2.0,exaggeration+(28.2562-u_zoom));fragColor=clamp(vec4(deriv.x/8.0+0.5,deriv.y/8.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Mn(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform float u_exaggeration;uniform vec4 u_accent;uniform int u_method;uniform float u_altitudes[NUM_ILLUMINATION_SOURCES];uniform float u_azimuths[NUM_ILLUMINATION_SOURCES];uniform vec4 u_shadows[NUM_ILLUMINATION_SOURCES];uniform vec4 u_highlights[NUM_ILLUMINATION_SOURCES];
#define PI 3.141592653589793
#define STANDARD 0
#define COMBINED 1
#define IGOR 2
#define MULTIDIRECTIONAL 3
#define BASIC 4
float get_aspect(vec2 deriv){return deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);}void igor_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float aspect=get_aspect(deriv);float azimuth=u_azimuths[0]+PI;float slope_stength=atan(length(deriv))*2.0/PI;float aspect_strength=1.0-abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);float shadow_strength=slope_stength*aspect_strength;float highlight_strength=slope_stength*(1.0-aspect_strength);fragColor=u_shadows[0]*shadow_strength+u_highlights[0]*highlight_strength;}void standard_hillshade(vec2 deriv){float azimuth=u_azimuths[0]+PI;float slope=atan(0.625*length(deriv));float aspect=get_aspect(deriv);float intensity=u_exaggeration;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadows[0],u_highlights[0],shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;}void basic_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor=u_highlights[0]*(2.0*shade-1.0);}else
{fragColor=u_shadows[0]*(1.0-2.0*shade);}}void multidirectional_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;fragColor=vec4(0,0,0,0);for(int i=0; i < NUM_ILLUMINATION_SOURCES; i++){float cos_alt=cos(u_altitudes[i]);float sin_alt=sin(u_altitudes[i]);float cos_az=-cos(u_azimuths[i]);float sin_az=-sin(u_azimuths[i]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor+=u_highlights[i]*(2.0*shade-1.0)/float(NUM_ILLUMINATION_SOURCES);}else
{fragColor+=u_shadows[i]*(1.0-2.0*shade)/float(NUM_ILLUMINATION_SOURCES);}}}void combined_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=acos((sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv)));cang=clamp(cang,0.0,PI/2.0);float shade=cang*atan(length(deriv))*4.0/PI/PI;float highlight=(PI/2.0-cang)*atan(length(deriv))*4.0/PI/PI;fragColor=u_shadows[0]*shade+u_highlights[0]*highlight;}void main() {vec4 pixel=texture(u_image,v_pos);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));vec2 deriv=((pixel.rg*8.0)-4.0)/scaleFactor;if (u_method==BASIC) {basic_hillshade(deriv);} else if (u_method==COMBINED) {combined_hillshade(deriv);} else if (u_method==IGOR) {igor_hillshade(deriv);} else if (u_method==MULTIDIRECTIONAL) {multidirectional_hillshade(deriv);} else if (u_method==STANDARD) {standard_hillshade(deriv);} else {standard_hillshade(deriv);}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:Mn(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Mn(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Mn(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Mn(`uniform lowp float u_device_pixel_ratio;uniform lowp float u_lineatlas_width;uniform sampler2D u_image;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0/u_device_pixel_ratio)/min(dasharray_from.w,dasharray_to.w);alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),lineGradientSDF:Mn(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform sampler2D u_image_dash;uniform float u_mix;uniform lowp float u_lineatlas_width;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);float sdfdist_a=texture(u_image_dash,v_tex_a).a;float sdfdist_b=texture(u_image_dash,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0)/min(dasharray_from.w,dasharray_to.w);float dash_alpha=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*dash_alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;out vec2 v_tex_a;out vec2 v_tex_b;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;float texel_height=1.0/u_image_height;float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),raster:Mn(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:Mn(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Mn(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Mn(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Mn("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Mn("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Mn("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:Mn("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:Mn(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:Mn("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Mn(C,s){const d=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,v=s.match(/in ([\w]+) ([\w]+)/g),S=C.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),D=s.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),k=D?D.concat(S):S,j={};return{fragmentSource:C=C.replace(d,(H,J,et,mt,ut)=>(j[ut]=!0,J==="define"?`
#ifndef HAS_UNIFORM_u_${ut}
in ${et} ${mt} ${ut};
#else
uniform ${et} ${mt} u_${ut};
#endif
`:`
#ifdef HAS_UNIFORM_u_${ut}
    ${et} ${mt} ${ut} = u_${ut};
#endif
`)),vertexSource:s=s.replace(d,(H,J,et,mt,ut)=>{const St=mt==="float"?"vec2":"vec4",pt=ut.match(/color/)?"color":St;return j[ut]?J==="define"?`
#ifndef HAS_UNIFORM_u_${ut}
uniform lowp float u_${ut}_t;
in ${et} ${St} a_${ut};
out ${et} ${mt} ${ut};
#else
uniform ${et} ${mt} u_${ut};
#endif
`:pt==="vec4"?`
#ifndef HAS_UNIFORM_u_${ut}
    ${ut} = a_${ut};
#else
    ${et} ${mt} ${ut} = u_${ut};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ut}
    ${ut} = unpack_mix_${pt}(a_${ut}, u_${ut}_t);
#else
    ${et} ${mt} ${ut} = u_${ut};
#endif
`:J==="define"?`
#ifndef HAS_UNIFORM_u_${ut}
uniform lowp float u_${ut}_t;
in ${et} ${St} a_${ut};
#else
uniform ${et} ${mt} u_${ut};
#endif
`:pt==="vec4"?`
#ifndef HAS_UNIFORM_u_${ut}
    ${et} ${mt} ${ut} = a_${ut};
#else
    ${et} ${mt} ${ut} = u_${ut};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ut}
    ${et} ${mt} ${ut} = unpack_mix_${pt}(a_${ut}, u_${ut}_t);
#else
    ${et} ${mt} ${ut} = u_${ut};
#endif
`}),staticAttributes:v,staticUniforms:k}}class sc{constructor(s,d,v){this.vertexBuffer=s,this.indexBuffer=d,this.segments=v}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var Lo=i.aT([{name:"a_pos",type:"Int16",components:2}]);const as="#define PROJECTION_MERCATOR",ia="mercator";class Ls{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return ia}get shaderDefine(){return as}get shaderPreludeCode(){return ea.projectionMercator}get vertexShaderPreludeCode(){return ea.projectionMercator.vertexSource}get subdivisionGranularity(){return i.aU.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(s){}getMeshFromTileID(s,d,v,S,D){if(this._cachedMesh)return this._cachedMesh;const k=new i.aV;k.emplaceBack(0,0),k.emplaceBack(i.a4,0),k.emplaceBack(0,i.a4),k.emplaceBack(i.a4,i.a4);const j=s.createVertexBuffer(k,Lo.members),H=i.aW.simpleSegment(0,0,4,2),J=new i.aX;J.emplaceBack(1,0,2),J.emplaceBack(1,2,3);const et=s.createIndexBuffer(J);return this._cachedMesh=new sc(j,et,H),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(s){}}class On{constructor(s=0,d=0,v=0,S=0){if(isNaN(s)||s<0||isNaN(d)||d<0||isNaN(v)||v<0||isNaN(S)||S<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=s,this.bottom=d,this.left=v,this.right=S}interpolate(s,d,v){return d.top!=null&&s.top!=null&&(this.top=i.G.number(s.top,d.top,v)),d.bottom!=null&&s.bottom!=null&&(this.bottom=i.G.number(s.bottom,d.bottom,v)),d.left!=null&&s.left!=null&&(this.left=i.G.number(s.left,d.left,v)),d.right!=null&&s.right!=null&&(this.right=i.G.number(s.right,d.right,v)),this}getCenter(s,d){const v=i.an((this.left+s-this.right)/2,0,s),S=i.an((this.top+d-this.bottom)/2,0,d);return new i.P(v,S)}equals(s){return this.top===s.top&&this.bottom===s.bottom&&this.left===s.left&&this.right===s.right}clone(){return new On(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Nu(C,s){if(!C.renderWorldCopies||C.lngRange)return;const d=s.lng-C.center.lng;s.lng+=d>180?-360:d<-180?360:0}function Is(C){return Math.max(0,Math.floor(C))}class Rs{constructor(s,d){var v;this.applyConstrain=(S,D)=>this._constrainOverride!==null?this._constrainOverride(S,D):this._callbacks.defaultConstrain(S,D),this._callbacks=s,this._tileSize=512,this._renderWorldCopies=d?.renderWorldCopies===void 0||!!d?.renderWorldCopies,this._minZoom=d?.minZoom||0,this._maxZoom=d?.maxZoom||22,this._minPitch=d?.minPitch==null?0:d?.minPitch,this._maxPitch=d?.maxPitch==null?60:d?.maxPitch,this._constrainOverride=(v=d?.constrainOverride)!==null&&v!==void 0?v:null,this.setMaxBounds(),this._width=0,this._height=0,this._center=new i.V(0,0),this._elevation=0,this._zoom=0,this._tileZoom=Is(this._zoom),this._scale=i.aq(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new On,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(s,d,v){this._constrainOverride=s.constrainOverride,this._latRange=s.latRange,this._lngRange=s.lngRange,this._width=s.width,this._height=s.height,this._center=s.center,this._elevation=s.elevation,this._minElevationForCurrentTile=s.minElevationForCurrentTile,this._zoom=s.zoom,this._tileZoom=Is(this._zoom),this._scale=i.aq(this._zoom),this._bearingInRadians=s.bearingInRadians,this._fovInRadians=s.fovInRadians,this._pitchInRadians=s.pitchInRadians,this._rollInRadians=s.rollInRadians,this._unmodified=s.unmodified,this._edgeInsets=new On(s.padding.top,s.padding.bottom,s.padding.left,s.padding.right),this._minZoom=s.minZoom,this._maxZoom=s.maxZoom,this._minPitch=s.minPitch,this._maxPitch=s.maxPitch,this._renderWorldCopies=s.renderWorldCopies,this._cameraToCenterDistance=s.cameraToCenterDistance,this._nearZ=s.nearZ,this._farZ=s.farZ,this._autoCalculateNearFarZ=!v&&s.autoCalculateNearFarZ,d&&this.constrainInternal(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(s){this._minElevationForCurrentTile=s}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(s){this._minZoom!==s&&(this._minZoom=s,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(s){this._maxZoom!==s&&(this._maxZoom=s,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(s){this._minPitch!==s&&(this._minPitch=s,this.setPitch(Math.max(this.pitch,s)))}get maxPitch(){return this._maxPitch}setMaxPitch(s){this._maxPitch!==s&&(this._maxPitch=s,this.setPitch(Math.min(this.pitch,s)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(s){s===void 0?s=!0:s===null&&(s=!1),this._renderWorldCopies=s}get constrainOverride(){return this._constrainOverride}setConstrainOverride(s){s===void 0&&(s=null),this._constrainOverride!==s&&(this._constrainOverride=s,this.constrainInternal(),this._calcMatrices())}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new i.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(s){const d=i.W(s,-180,180)*Math.PI/180;var v,S,D,k,j,H,J,et,mt;this._bearingInRadians!==d&&(this._unmodified=!1,this._bearingInRadians=d,this._calcMatrices(),this._rotationMatrix=yi(),v=this._rotationMatrix,D=-this._bearingInRadians,k=(S=this._rotationMatrix)[0],j=S[1],H=S[2],J=S[3],et=Math.sin(D),mt=Math.cos(D),v[0]=k*mt+H*et,v[1]=j*mt+J*et,v[2]=k*-et+H*mt,v[3]=j*-et+J*mt)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(s){const d=i.an(s,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==d&&(this._unmodified=!1,this._pitchInRadians=d,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(s){const d=s/180*Math.PI;this._rollInRadians!==d&&(this._unmodified=!1,this._rollInRadians=d,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return i.aY(this._fovInRadians)}setFov(s){s=i.an(s,.1,150),this.fov!==s&&(this._unmodified=!1,this._fovInRadians=i.ap(s),this._calcMatrices())}get zoom(){return this._zoom}setZoom(s){const d=this.applyConstrain(this._center,s).zoom;this._zoom!==d&&(this._unmodified=!1,this._zoom=d,this._tileZoom=Math.max(0,Math.floor(d)),this._scale=i.aq(d),this.constrainInternal(),this._calcMatrices())}get center(){return this._center}setCenter(s){s.lat===this._center.lat&&s.lng===this._center.lng||(this._unmodified=!1,this._center=s,this.constrainInternal(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(s){s!==this._elevation&&(this._elevation=s,this.constrainInternal(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(s){this._edgeInsets.equals(s)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,s,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(s,d){this._autoCalculateNearFarZ=!1,this._nearZ=s,this._farZ=d,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(s){return this._edgeInsets.equals(s)}interpolatePadding(s,d,v){this._unmodified=!1,this._edgeInsets.interpolate(s,d,v),this.constrainInternal(),this._calcMatrices()}resize(s,d,v=!0){this._width=s,this._height=d,v&&this.constrainInternal(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new lo([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(s){s?(this._lngRange=[s.getWest(),s.getEast()],this._latRange=[s.getSouth(),s.getNorth()],this.constrainInternal()):(this._lngRange=null,this._latRange=[-i.ao,i.ao])}getCameraQueryGeometry(s,d){if(d.length===1)return[d[0],s];{const{minX:v,minY:S,maxX:D,maxY:k}=i.ab.fromPoints(d).extend(s);return[new i.P(v,S),new i.P(D,S),new i.P(D,k),new i.P(v,k),new i.P(v,S)]}}constrainInternal(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const s=this._unmodified,{center:d,zoom:v}=this.applyConstrain(this.center,this.zoom);this.setCenter(d),this.setZoom(v),this._unmodified=s,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let s=i.ar(new Float64Array(16));i.Q(s,s,[this._width/2,-this._height/2,1]),i.O(s,s,[1,-1,0]),this._clipSpaceToPixelsMatrix=s,s=i.ar(new Float64Array(16)),i.Q(s,s,[1,-1,1]),i.O(s,s,[-1,-1,0]),i.Q(s,s,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=s,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(s,d,v,S){const D=v!==void 0?v:this.bearing,k=S=S!==void 0?S:this.pitch,j=i.aa.fromLngLat(s,d),H=-Math.cos(i.ap(k)),J=Math.sin(i.ap(k)),et=J*Math.sin(i.ap(D)),mt=-J*Math.cos(i.ap(D));let ut=this.elevation;const St=d-ut;let pt;H*St>=0||Math.abs(H)<.1?(pt=1e4,ut=d+pt*H):pt=-St/H;let Et,Kt,Xt=i.aZ(1,j.y),ft=0;do{if(ft+=1,ft>10)break;Kt=pt/Xt,Et=new i.aa(j.x+et*Kt,j.y+mt*Kt),Xt=1/Et.meterInMercatorCoordinateUnits()}while(Math.abs(pt-Kt*Xt)>1e-12);return{center:Et.toLngLat(),elevation:ut,zoom:i.at(this.height/2/Math.tan(this.fovInRadians/2)/Kt/this.tileSize)}}recalculateZoomAndCenter(s){if(this.elevation-s==0)return;const d=i.as(1,this.center.lat)*this.worldSize,v=this.cameraToCenterDistance/d,S=i.aa.fromLngLat(this.center,this.elevation),D=ze(this.center,this.elevation,this.pitch,this.bearing,v);this._elevation=s;const k=this.calculateCenterFromCameraLngLatAlt(D.toLngLat(),i.aZ(D.z,S.y),this.bearing,this.pitch);this._elevation=k.elevation,this._center=k.center,this.setZoom(k.zoom)}getCameraPoint(){const s=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new i.P(s*Math.sin(this.rollInRadians),s*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const s=i.as(1,this.center.lat)*this.worldSize;return ze(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/s).toLngLat()}getMercatorTileCoordinates(s){if(!s)return[0,0,1,1];const d=s.canonical.z>=0?1<<s.canonical.z:Math.pow(2,s.canonical.z);return[s.canonical.x/d,s.canonical.y/d,1/d/i.a4,1/d/i.a4]}}class ra{constructor(s,d){this.min=s,this.max=d,this.center=i.a_([],i.a$([],this.min,this.max),.5)}quadrant(s){const d=[s%2==0,s<2],v=i.b0(this.min),S=i.b0(this.max);for(let D=0;D<d.length;D++)v[D]=d[D]?this.min[D]:this.center[D],S[D]=d[D]?this.center[D]:this.max[D];return S[2]=this.max[2],new ra(v,S)}distanceX(s){return Math.max(Math.min(this.max[0],s[0]),this.min[0])-s[0]}distanceY(s){return Math.max(Math.min(this.max[1],s[1]),this.min[1])-s[1]}intersectsFrustum(s){let d=!0;for(let v=0;v<s.planes.length;v++){const S=this.intersectsPlane(s.planes[v]);if(S===0)return 0;S===1&&(d=!1)}return d?2:s.aabb.min[0]>this.max[0]||s.aabb.min[1]>this.max[1]||s.aabb.min[2]>this.max[2]||s.aabb.max[0]<this.min[0]||s.aabb.max[1]<this.min[1]||s.aabb.max[2]<this.min[2]?0:1}intersectsPlane(s){let d=s[3],v=s[3];for(let S=0;S<3;S++)s[S]>0?(d+=s[S]*this.min[S],v+=s[S]*this.max[S]):(v+=s[S]*this.min[S],d+=s[S]*this.max[S]);return d>=0?2:v<0?0:1}}class Vu{distanceToTile2d(s,d,v,S){const D=S.distanceX([s,d]),k=S.distanceY([s,d]);return Math.hypot(D,k)}getWrap(s,d,v){return v}getTileBoundingVolume(s,d,v,S){var D,k;let j=0,H=0;if(S?.terrain){const et=new i.a1(s.z,d,s.z,s.x,s.y),mt=S.terrain.getMinMaxElevation(et);j=(D=mt.minElevation)!==null&&D!==void 0?D:Math.min(0,v),H=(k=mt.maxElevation)!==null&&k!==void 0?k:Math.max(0,v)}const J=1<<s.z;return new ra([d+s.x/J,s.y/J,j],[d+(s.x+1)/J,(s.y+1)/J,H])}allowVariableZoom(s,d){const v=s.fov*(Math.abs(Math.cos(s.rollInRadians))*s.height+Math.abs(Math.sin(s.rollInRadians))*s.width)/s.height,S=i.an(78.5-v/2,0,60);return!!d.terrain||s.pitch>S}allowWorldCopies(){return!0}prepareNextFrame(){}}class Pl{constructor(s,d,v){this.points=s,this.planes=d,this.aabb=v}static fromInvProjectionMatrix(s,d=1,v=0,S,D){const k=D?[[6,5,4],[0,1,2],[0,3,7],[2,1,5],[3,2,6],[0,4,5]]:[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]],j=Math.pow(2,v),H=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(ut=>function(St,pt,Et,Kt){const Xt=i.aG([],St,pt),ft=1/Xt[3]/Et*Kt;return i.b5(Xt,Xt,[ft,ft,1/Xt[3],ft])}(ut,s,d,j));S&&function(ut,St,pt,Et){const Kt=Et?4:0,Xt=Et?0:4;let ft=0;const _e=[],ce=[];for(let de=0;de<4;de++){const De=i.b1([],ut[de+Xt],ut[de+Kt]),Qe=i.b6(De);i.a_(De,De,1/Qe),_e.push(Qe),ce.push(De)}for(let de=0;de<4;de++){const De=i.b7(ut[de+Kt],ce[de],pt);ft=De!==null&&De>=0?Math.max(ft,De):Math.max(ft,_e[de])}const me=function(de,De){const Qe=i.b1([],de[De[0]],de[De[1]]),Xe=i.b1([],de[De[2]],de[De[1]]),Je=[0,0,0,0];return i.b2(Je,i.b3([],Qe,Xe)),Je[3]=-i.b4(Je,de[De[0]]),Je}(ut,St),be=function(de,De){const Qe=i.b8(de),Xe=i.b9([],de,1/Qe),Je=i.b1([],De,i.a_([],Xe,i.b4(De,Xe))),ii=i.b8(Je);if(ii>0){const Di=Math.sqrt(1-Xe[3]*Xe[3]),Fi=i.a_([],Xe,-Xe[3]),wi=i.a$([],Fi,i.a_([],Je,Di/ii));return i.ba(De,wi)}return null}(pt,me);if(be!==null){const de=be/i.b4(ce[0],me);ft=Math.min(ft,de)}for(let de=0;de<4;de++){const De=Math.min(ft,_e[de]);ut[de+Xt]=[ut[de+Kt][0]+ce[de][0]*De,ut[de+Kt][1]+ce[de][1]*De,ut[de+Kt][2]+ce[de][2]*De,1]}}(H,k[0],S,D);const J=k.map(ut=>{const St=i.b1([],H[ut[0]],H[ut[1]]),pt=i.b1([],H[ut[2]],H[ut[1]]),Et=i.b2([],i.b3([],St,pt)),Kt=-i.b4(Et,H[ut[1]]);return Et.concat(Kt)}),et=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],mt=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const ut of H)for(let St=0;St<3;St++)et[St]=Math.min(et[St],ut[St]),mt[St]=Math.max(mt[St],ut[St]);return new Pl(H,J,new ra(et,mt))}}class pr{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(s){this._helper.setMinZoom(s)}setMaxZoom(s){this._helper.setMaxZoom(s)}setMinPitch(s){this._helper.setMinPitch(s)}setMaxPitch(s){this._helper.setMaxPitch(s)}setRenderWorldCopies(s){this._helper.setRenderWorldCopies(s)}setBearing(s){this._helper.setBearing(s)}setPitch(s){this._helper.setPitch(s)}setRoll(s){this._helper.setRoll(s)}setFov(s){this._helper.setFov(s)}setZoom(s){this._helper.setZoom(s)}setCenter(s){this._helper.setCenter(s)}setElevation(s){this._helper.setElevation(s)}setMinElevationForCurrentTile(s){this._helper.setMinElevationForCurrentTile(s)}setPadding(s){this._helper.setPadding(s)}interpolatePadding(s,d,v){return this._helper.interpolatePadding(s,d,v)}isPaddingEqual(s){return this._helper.isPaddingEqual(s)}resize(s,d,v=!0){this._helper.resize(s,d,v)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(s){this._helper.setMaxBounds(s)}setConstrainOverride(s){this._helper.setConstrainOverride(s)}overrideNearFarZ(s,d){this._helper.overrideNearFarZ(s,d)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(s){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),s)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(s,d){}constructor(s){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this.defaultConstrain=(d,v)=>{v=i.an(+v,this.minZoom,this.maxZoom);const S={center:new i.V(d.lng,d.lat),zoom:v};let D=this._helper._lngRange;if(!this._helper._renderWorldCopies&&D===null){const ce=179.9999999999;D=[-ce,ce]}const k=this.tileSize*i.aq(S.zoom);let j=0,H=k,J=0,et=k,mt=0,ut=0;const{x:St,y:pt}=this.size;if(this._helper._latRange){const ce=this._helper._latRange;j=i.X(ce[1])*k,H=i.X(ce[0])*k,H-j<pt&&(mt=pt/(H-j))}D&&(J=i.W(i.Y(D[0])*k,0,k),et=i.W(i.Y(D[1])*k,0,k),et<J&&(et+=k),et-J<St&&(ut=St/(et-J)));const{x:Et,y:Kt}=he(k,d);let Xt,ft;const _e=Math.max(ut||0,mt||0);if(_e){const ce=new i.P(ut?(et+J)/2:Et,mt?(H+j)/2:Kt);return S.center=le(k,ce).wrap(),S.zoom+=i.at(_e),S}if(this._helper._latRange){const ce=pt/2;Kt-ce<j&&(ft=j+ce),Kt+ce>H&&(ft=H-ce)}if(D){const ce=(J+et)/2;let me=Et;this._helper._renderWorldCopies&&(me=i.W(Et,ce-k/2,ce+k/2));const be=St/2;me-be<J&&(Xt=J+be),me+be>et&&(Xt=et-be)}if(Xt!==void 0||ft!==void 0){const ce=new i.P(Xt??Et,ft??Kt);S.center=le(k,ce).wrap()}return S},this.applyConstrain=(d,v)=>this._helper.applyConstrain(d,v),this._helper=new Rs({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(d,v)=>this.defaultConstrain(d,v)},s),this._coveringTilesDetailsProvider=new Vu}clone(){const s=new pr;return s.apply(this),s}apply(s,d,v){this._helper.apply(s,d,v)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(s){const d=[new i.bb(0,s)];if(this._helper._renderWorldCopies){const v=this.screenPointToMercatorCoordinate(new i.P(0,0)),S=this.screenPointToMercatorCoordinate(new i.P(this._helper._width,0)),D=this.screenPointToMercatorCoordinate(new i.P(this._helper._width,this._helper._height)),k=this.screenPointToMercatorCoordinate(new i.P(0,this._helper._height)),j=Math.floor(Math.min(v.x,S.x,D.x,k.x)),H=Math.floor(Math.max(v.x,S.x,D.x,k.x)),J=1;for(let et=j-J;et<=H+J;et++)et!==0&&d.push(new i.bb(et,s))}return d}getCameraFrustum(){return Pl.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(s){const d=this.screenPointToLocation(this.centerPoint,s),v=s?s.getElevationForLngLatZoom(d,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(v)}setLocationAtPoint(s,d){const v=i.as(this.elevation,this.center.lat),S=this.screenPointToMercatorCoordinateAtZ(d,v),D=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,v),k=i.aa.fromLngLat(s),j=new i.aa(k.x-(S.x-D.x),k.y-(S.y-D.y));this.setCenter(j?.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(s,d){return d?this.coordinatePoint(i.aa.fromLngLat(s),d.getElevationForLngLatZoom(s,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(i.aa.fromLngLat(s))}screenPointToLocation(s,d){var v;return(v=this.screenPointToMercatorCoordinate(s,d))===null||v===void 0?void 0:v.toLngLat()}screenPointToMercatorCoordinate(s,d){if(d){const v=d.pointCoordinate(s);if(v!=null)return v}return this.screenPointToMercatorCoordinateAtZ(s)}screenPointToMercatorCoordinateAtZ(s,d){const v=d||0,S=[s.x,s.y,0,1],D=[s.x,s.y,1,1];i.aG(S,S,this._pixelMatrixInverse),i.aG(D,D,this._pixelMatrixInverse);const k=S[3],j=D[3],H=S[1]/k,J=D[1]/j,et=S[2]/k,mt=D[2]/j,ut=et===mt?0:(v-et)/(mt-et);return new i.aa(i.G.number(S[0]/k,D[0]/j,ut)/this.worldSize,i.G.number(H,J,ut)/this.worldSize,v)}coordinatePoint(s,d=0,v=this._pixelMatrix){const S=[s.x*this.worldSize,s.y*this.worldSize,d,1];return i.aG(S,S,v),new i.P(S[0]/S[3],S[1]/S[3])}getBounds(){const s=Math.max(0,this._helper._height/2-Re(this));return new lo().extend(this.screenPointToLocation(new i.P(0,s))).extend(this.screenPointToLocation(new i.P(this._helper._width,s))).extend(this.screenPointToLocation(new i.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new i.P(0,this._helper._height)))}isPointOnMapSurface(s,d){return d?d.pointCoordinate(s)!=null:s.y>this.height/2-Re(this)}calculatePosMatrix(s,d=!1,v){var S;const D=(S=s.key)!==null&&S!==void 0?S:i.bc(s.wrap,s.canonical.z,s.canonical.z,s.canonical.x,s.canonical.y),k=d?this._alignedPosMatrixCache:this._posMatrixCache;if(k.has(D)){const J=k.get(D);return v?J.f32:J.f64}const j=te(s,this.worldSize);i.S(j,d?this._alignedProjMatrix:this._viewProjMatrix,j);const H={f64:j,f32:new Float32Array(j)};return k.set(D,H),v?H.f32:H.f64}calculateFogMatrix(s){const d=s.key,v=this._fogMatrixCacheF32;if(v.has(d))return v.get(d);const S=te(s,this.worldSize);return i.S(S,this._fogMatrix,S),v.set(d,new Float32Array(S)),v.get(d)}calculateCenterFromCameraLngLatAlt(s,d,v,S){return this._helper.calculateCenterFromCameraLngLatAlt(s,d,v,S)}_calculateNearFarZIfNeeded(s,d,v){if(!this._helper.autoCalculateNearFarZ)return;const S=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),D=s-S*this._helper._pixelPerMeter/Math.cos(d),k=S<0?D:s,j=Math.PI/2+this.pitchInRadians,H=i.ap(this.fov)*(Math.abs(Math.cos(i.ap(this.roll)))*this.height+Math.abs(Math.sin(i.ap(this.roll)))*this.width)/this.height*(.5+v.y/this.height),J=Math.sin(H)*k/Math.sin(i.an(Math.PI-j-H,.01,Math.PI-.01)),et=Re(this),mt=Math.atan(et/this._helper.cameraToCenterDistance),ut=i.ap(.75),St=mt>ut?2*mt*(.5+v.y/(2*et)):ut,pt=Math.sin(St)*k/Math.sin(i.an(Math.PI-j-St,.01,Math.PI-.01)),Et=Math.min(J,pt);this._helper._farZ=1.01*(Math.cos(Math.PI/2-d)*Et+k),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const s=this.centerOffset,d=he(this.worldSize,this.center),v=d.x,S=d.y;this._helper._pixelPerMeter=i.as(1,this.center.lat)*this.worldSize;const D=i.ap(Math.min(this.pitch,Ut)),k=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(D));let j;this._calculateNearFarZIfNeeded(k,D,s),j=new Float64Array(16),i.bd(j,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),i.aA(this._invProjMatrix,j),j[8]=2*-s.x/this._helper._width,j[9]=2*s.y/this._helper._height,this._projectionMatrix=i.be(j),i.Q(j,j,[1,-1,1]),i.O(j,j,[0,0,-this._helper.cameraToCenterDistance]),i.bf(j,j,-this.rollInRadians),i.bg(j,j,this.pitchInRadians),i.bf(j,j,-this.bearingInRadians),i.O(j,j,[-v,-S,0]),this._mercatorMatrix=i.Q([],j,[this.worldSize,this.worldSize,this.worldSize]),i.Q(j,j,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=i.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,j),i.O(j,j,[0,0,-this.elevation]),this._viewProjMatrix=j,this._invViewProjMatrix=i.aA([],j);const H=[0,0,-1,1];i.aG(H,H,this._invViewProjMatrix),this._cameraPosition=[H[0]/H[3],H[1]/H[3],H[2]/H[3]],this._fogMatrix=new Float64Array(16),i.bd(this._fogMatrix,this.fovInRadians,this.width/this.height,k,this._helper._farZ),this._fogMatrix[8]=2*-s.x/this.width,this._fogMatrix[9]=2*s.y/this.height,i.Q(this._fogMatrix,this._fogMatrix,[1,-1,1]),i.O(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),i.bf(this._fogMatrix,this._fogMatrix,-this.rollInRadians),i.bg(this._fogMatrix,this._fogMatrix,this.pitchInRadians),i.bf(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),i.O(this._fogMatrix,this._fogMatrix,[-v,-S,0]),i.Q(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),i.O(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=i.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,j);const J=this._helper._width%2/2,et=this._helper._height%2/2,mt=Math.cos(this.bearingInRadians),ut=Math.sin(-this.bearingInRadians),St=v-Math.round(v)+mt*J+ut*et,pt=S-Math.round(S)+mt*et+ut*J,Et=new Float64Array(j);if(i.O(Et,Et,[St>.5?St-1:St,pt>.5?pt-1:pt,0]),this._alignedProjMatrix=Et,j=i.aA(new Float64Array(16),this._pixelMatrix),!j)throw new Error("failed to invert matrix");this._pixelMatrixInverse=j,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const s=this.screenPointToMercatorCoordinate(new i.P(0,0)),d=[s.x*this.worldSize,s.y*this.worldSize,0,1];return i.aG(d,d,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const s=i.as(1,this.center.lat)*this.worldSize;return ze(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/s).toLngLat()}lngLatToCameraDepth(s,d){const v=i.aa.fromLngLat(s),S=[v.x*this.worldSize,v.y*this.worldSize,d,1];return i.aG(S,S,this._viewProjMatrix),S[2]/S[3]}getProjectionData(s){const{overscaledTileID:d,aligned:v,applyTerrainMatrix:S}=s,D=this._helper.getMercatorTileCoordinates(d),k=d?this.calculatePosMatrix(d,v,!0):null;let j;return j=d&&d.terrainRttPosMatrix32f&&S?d.terrainRttPosMatrix32f:k||i.bh(),{mainMatrix:j,tileMercatorCoords:D,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:j}}isLocationOccluded(s){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(s,d,v){return 1}transformLightDirection(s){return i.b0(s)}getRayDirectionFromPixel(s){throw new Error("Not implemented.")}projectTileCoordinates(s,d,v,S){const D=this.calculatePosMatrix(v);let k;S?(k=[s,d,S(s,d),1],i.aG(k,k,D)):(k=[s,d,0,1],zo(k,k,D));const j=k[3];return{point:new i.P(k[0]/j,k[1]/j),signedDistanceFromCamera:j,isOccluded:!1}}populateCache(s){for(const d of s)this.calculatePosMatrix(d)}getMatrixForModel(s,d){const v=i.aa.fromLngLat(s,d),S=v.meterInMercatorCoordinateUnits(),D=i.bi();return i.O(D,D,[v.x,v.y,v.z]),i.bf(D,D,Math.PI),i.bg(D,D,Math.PI/2),i.Q(D,D,[-S,S,S]),D}getProjectionDataForCustomLayer(s=!0){const d=new i.a1(0,0,0,0,0),v=this.getProjectionData({overscaledTileID:d,applyGlobeMatrix:s}),S=te(d,this.worldSize);i.S(S,this._viewProjMatrix,S),v.tileMercatorCoords=[0,0,1,1];const D=[i.a4,i.a4,this.worldSize/this._helper.pixelsPerMeter],k=i.bj();return i.Q(k,S,D),v.fallbackMatrix=k,v.mainMatrix=k,v}getFastPathSimpleProjectionMatrix(s){return this.calculatePosMatrix(s)}}function Sh(){i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function Zl(C){if(C.useSlerp)if(C.k<1){const s=i.bk(C.startEulerAngles.roll,C.startEulerAngles.pitch,C.startEulerAngles.bearing),d=i.bk(C.endEulerAngles.roll,C.endEulerAngles.pitch,C.endEulerAngles.bearing),v=new Float64Array(4);i.bl(v,s,d,C.k);const S=i.bm(v);C.tr.setRoll(S.roll),C.tr.setPitch(S.pitch),C.tr.setBearing(S.bearing)}else C.tr.setRoll(C.endEulerAngles.roll),C.tr.setPitch(C.endEulerAngles.pitch),C.tr.setBearing(C.endEulerAngles.bearing);else C.tr.setRoll(i.G.number(C.startEulerAngles.roll,C.endEulerAngles.roll,C.k)),C.tr.setPitch(i.G.number(C.startEulerAngles.pitch,C.endEulerAngles.pitch,C.k)),C.tr.setBearing(i.G.number(C.startEulerAngles.bearing,C.endEulerAngles.bearing,C.k))}function Wc(C,s,d,v,S){const D=S.padding,k=he(S.worldSize,d.getNorthWest()),j=he(S.worldSize,d.getNorthEast()),H=he(S.worldSize,d.getSouthEast()),J=he(S.worldSize,d.getSouthWest()),et=i.ap(-v),mt=k.rotate(et),ut=j.rotate(et),St=H.rotate(et),pt=J.rotate(et),Et=new i.P(Math.max(mt.x,ut.x,pt.x,St.x),Math.max(mt.y,ut.y,pt.y,St.y)),Kt=new i.P(Math.min(mt.x,ut.x,pt.x,St.x),Math.min(mt.y,ut.y,pt.y,St.y)),Xt=Et.sub(Kt),ft=(S.width-(D.left+D.right+s.left+s.right))/Xt.x,_e=(S.height-(D.top+D.bottom+s.top+s.bottom))/Xt.y;if(_e<0||ft<0)return void Sh();const ce=Math.min(i.at(S.scale*Math.min(ft,_e)),C.maxZoom),me=i.P.convert(C.offset),be=new i.P((s.left-s.right)/2,(s.top-s.bottom)/2).rotate(i.ap(v)),de=me.add(be).mult(S.scale/i.aq(ce));return{center:le(S.worldSize,k.add(H).div(2).sub(de)),zoom:ce,bearing:v}}class Ca{get useGlobeControls(){return!1}handlePanInertia(s,d){const v=s.mag(),S=Math.abs(Re(d));return{easingOffset:s.mult(Math.min(.75*S/v,1)),easingCenter:d.center}}handleMapControlsRollPitchBearingZoom(s,d){s.bearingDelta&&d.setBearing(d.bearing+s.bearingDelta),s.pitchDelta&&d.setPitch(d.pitch+s.pitchDelta),s.rollDelta&&d.setRoll(d.roll+s.rollDelta),s.zoomDelta&&d.setZoom(d.zoom+s.zoomDelta)}handleMapControlsPan(s,d,v){s.around.distSqr(d.centerPoint)<.01||d.setLocationAtPoint(v,s.around)}cameraForBoxAndBearing(s,d,v,S,D){return Wc(s,d,v,S,D)}handleJumpToCenterZoom(s,d){s.zoom!==(d.zoom!==void 0?+d.zoom:s.zoom)&&s.setZoom(+d.zoom),d.center!==void 0&&s.setCenter(i.V.convert(d.center))}handleEaseTo(s,d){const v=s.zoom,S=s.padding,D={roll:s.roll,pitch:s.pitch,bearing:s.bearing},k={roll:d.roll===void 0?s.roll:d.roll,pitch:d.pitch===void 0?s.pitch:d.pitch,bearing:d.bearing===void 0?s.bearing:d.bearing},j=d.zoom!==void 0,H=!s.isPaddingEqual(d.padding);let J=!1;const et=j?+d.zoom:s.zoom;let mt=s.centerPoint.add(d.offsetAsPoint);const ut=s.screenPointToLocation(mt),{center:St,zoom:pt}=s.applyConstrain(i.V.convert(d.center||ut),et??v);Nu(s,St);const Et=he(s.worldSize,ut),Kt=he(s.worldSize,St).sub(Et),Xt=i.aq(pt-v);return J=pt!==v,{easeFunc:ft=>{if(J&&s.setZoom(i.G.number(v,pt,ft)),i.bn(D,k)||Zl({startEulerAngles:D,endEulerAngles:k,tr:s,k:ft,useSlerp:D.roll!=k.roll}),H&&(s.interpolatePadding(S,d.padding,ft),mt=s.centerPoint.add(d.offsetAsPoint)),d.around)s.setLocationAtPoint(d.around,d.aroundPoint);else{const _e=i.aq(s.zoom-v),ce=pt>v?Math.min(2,Xt):Math.max(.5,Xt),me=Math.pow(ce,1-ft),be=le(s.worldSize,Et.add(Kt.mult(ft*me)).mult(_e));s.setLocationAtPoint(s.renderWorldCopies?be.wrap():be,mt)}},isZooming:J,elevationCenter:St}}handleFlyTo(s,d){const v=d.zoom!==void 0,S=s.zoom,D=s.applyConstrain(i.V.convert(d.center||d.locationAtOffset),v?+d.zoom:S),k=D.center,j=D.zoom;Nu(s,k);const H=he(s.worldSize,d.locationAtOffset),J=he(s.worldSize,k).sub(H),et=J.mag(),mt=i.aq(j-S);let ut;if(d.minZoom!==void 0){const St=Math.min(+d.minZoom,S,j),pt=s.applyConstrain(k,St).zoom;ut=i.aq(pt-S)}return{easeFunc:(St,pt,Et,Kt)=>{s.setZoom(St===1?j:S+i.at(pt));const Xt=St===1?k:le(s.worldSize,H.add(J.mult(Et)).mult(pt));s.setLocationAtPoint(s.renderWorldCopies?Xt.wrap():Xt,Kt)},scaleOfZoom:mt,targetCenter:k,scaleOfMinZoom:ut,pixelPathLength:et}}}class Eo{constructor(s,d,v){this.blendFunction=s,this.blendColor=d,this.mask=v}}Eo.Replace=[1,0],Eo.disabled=new Eo(Eo.Replace,i.bo.transparent,[!1,!1,!1,!1]),Eo.unblended=new Eo(Eo.Replace,i.bo.transparent,[!0,!0,!0,!0]),Eo.alphaBlended=new Eo([1,771],i.bo.transparent,[!0,!0,!0,!0]);const sl=2305;class Rn{constructor(s,d,v){this.enable=s,this.mode=d,this.frontFace=v}}Rn.disabled=new Rn(!1,1029,sl),Rn.backCCW=new Rn(!0,1029,sl),Rn.frontCCW=new Rn(!0,1028,sl);class Hr{constructor(s,d,v){this.func=s,this.mask=d,this.range=v}}Hr.ReadOnly=!1,Hr.ReadWrite=!0,Hr.disabled=new Hr(519,Hr.ReadOnly,[0,1]);const au=7680;class Cn{constructor(s,d,v,S,D,k){this.test=s,this.ref=d,this.mask=v,this.fail=S,this.depthFail=D,this.pass=k}}Cn.disabled=new Cn({func:519,mask:0},0,0,au,au,au);const Uu=new WeakMap;function qa(C){var s;if(Uu.has(C))return Uu.get(C);{const d=(s=C.getParameter(C.VERSION))===null||s===void 0?void 0:s.startsWith("WebGL 2.0");return Uu.set(C,d),d}}class ya{get awaitingQuery(){return!!this._readbackQueue}constructor(s){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=s;const d=s.context,v=d.gl;this._texFormat=v.RGBA,this._texType=v.UNSIGNED_BYTE;const S=new i.aV;S.emplaceBack(-1,-1),S.emplaceBack(2,-1),S.emplaceBack(-1,2);const D=new i.aX;D.emplaceBack(0,1,2),this._fullscreenTriangle=new sc(d.createVertexBuffer(S,Lo.members),d.createIndexBuffer(D),i.aW.simpleSegment(0,0,S.length,D.length)),this._resultBuffer=new Uint8Array(4),d.activeTexture.set(v.TEXTURE1);const k=v.createTexture();v.bindTexture(v.TEXTURE_2D,k),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.NEAREST),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.NEAREST),v.texImage2D(v.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=d.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(k),qa(v)&&(this._pbo=v.createBuffer(),v.bindBuffer(v.PIXEL_PACK_BUFFER,this._pbo),v.bufferData(v.PIXEL_PACK_BUFFER,4,v.STREAM_READ),v.bindBuffer(v.PIXEL_PACK_BUFFER,null))}destroy(){const s=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),s.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(s,d){const v=this._updateCount;return this._readbackQueue?v>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():v>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(s,d),this._updateCount++,this._measuredError}_bindFramebuffer(){const s=this._cachedRenderContext.context,d=s.gl;s.activeTexture.set(d.TEXTURE1),d.bindTexture(d.TEXTURE_2D,this._fbo.colorAttachment.get()),s.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(s,d){const v=this._cachedRenderContext.context,S=v.gl;if(this._bindFramebuffer(),v.viewport.set([0,0,this._texWidth,this._texHeight]),v.clear({color:i.bo.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(v,S.TRIANGLES,Hr.disabled,Cn.disabled,Eo.unblended,Rn.disabled,((D,k)=>({u_input:D,u_output_expected:k}))(s,d),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&qa(S)){S.bindBuffer(S.PIXEL_PACK_BUFFER,this._pbo),S.readBuffer(S.COLOR_ATTACHMENT0),S.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),S.bindBuffer(S.PIXEL_PACK_BUFFER,null);const D=S.fenceSync(S.SYNC_GPU_COMMANDS_COMPLETE,0);S.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:D}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const s=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&qa(s)){const d=s.clientWaitSync(this._readbackQueue.sync,0,0);if(d===s.WAIT_FAILED)return i.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(d===s.TIMEOUT_EXPIRED)return;s.bindBuffer(s.PIXEL_PACK_BUFFER,this._pbo),s.getBufferSubData(s.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),s.bindBuffer(s.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),s.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=ya._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(s){let d=0;return d+=s[0]/256,d+=s[1]/65536,d+=s[2]/16777216,s[3]<127&&(d=-d),d/128}}const ac=i.a4/128;function Xc(C,s){const d=C.granularity!==void 0?Math.max(C.granularity,1):1,v=d+(C.generateBorders?2:0),S=d+(C.extendToNorthPole||C.generateBorders?1:0)+(C.extendToSouthPole||C.generateBorders?1:0),D=v+1,k=S+1,j=C.generateBorders?-1:0,H=C.generateBorders||C.extendToNorthPole?-1:0,J=d+(C.generateBorders?1:0),et=d+(C.generateBorders||C.extendToSouthPole?1:0),mt=D*k,ut=v*S*6,St=D*k>65536;if(St&&s==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const pt=St||s==="32bit",Et=new Int16Array(2*mt);let Kt=0;for(let _e=H;_e<=et;_e++)for(let ce=j;ce<=J;ce++){let me=ce/d*i.a4;ce===-1&&(me=-ac),ce===d+1&&(me=i.a4+ac);let be=_e/d*i.a4;_e===-1&&(be=C.extendToNorthPole?i.bq:-ac),_e===d+1&&(be=C.extendToSouthPole?i.br:i.a4+ac),Et[Kt++]=me,Et[Kt++]=be}const Xt=pt?new Uint32Array(ut):new Uint16Array(ut);let ft=0;for(let _e=0;_e<S;_e++)for(let ce=0;ce<v;ce++){const me=ce+1+_e*D,be=ce+(_e+1)*D,de=ce+1+(_e+1)*D;Xt[ft++]=ce+_e*D,Xt[ft++]=be,Xt[ft++]=me,Xt[ft++]=me,Xt[ft++]=be,Xt[ft++]=de}return{vertices:Et.buffer.slice(0),indices:Xt.buffer.slice(0),uses32bitIndices:pt}}const Yc=new i.aU({fill:new i.bs(128,2),line:new i.bs(512,0),tile:new i.bs(128,32),stencil:new i.bs(128,1),circle:3});class Ml{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return ea.projectionGlobe}get vertexShaderPreludeCode(){return ea.projectionMercator.vertexSource}get subdivisionGranularity(){return Yc}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(s){this._errorMeasurement||(this._errorMeasurement=new ya(s));const d=i.X(this._errorQueryLatitudeDegrees),v=2*Math.atan(Math.exp(Math.PI-d*Math.PI*2))-.5*Math.PI,S=this._errorMeasurement.updateErrorLoop(d,v),D=Ri();S!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=S,this._errorMeasurementLastChangeTime=D);const k=Math.min(Math.max((D-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=i.bt(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,i.bu(k))}_getMeshKey(s){return`${s.granularity.toString(36)}_${s.generateBorders?"b":""}${s.extendToNorthPole?"n":""}${s.extendToSouthPole?"s":""}`}getMeshFromTileID(s,d,v,S,D){const k=(D==="stencil"?Yc.stencil:Yc.tile).getGranularityForZoomLevel(d.z);return this._getMesh(s,{granularity:k,generateBorders:v,extendToNorthPole:d.y===0&&S,extendToSouthPole:d.y===(1<<d.z)-1&&S})}_getMesh(s,d){const v=this._getMeshKey(d);if(v in this._tileMeshCache)return this._tileMeshCache[v];const S=function(D,k){const j=Xc(k,"16bit"),H=i.aV.deserialize({arrayBuffer:j.vertices,length:j.vertices.byteLength/2/2}),J=i.aX.deserialize({arrayBuffer:j.indices,length:j.indices.byteLength/2/3});return new sc(D.createVertexBuffer(H,Lo.members),D.createIndexBuffer(J),i.aW.simpleSegment(0,0,H.length,J.length))}(s,d);return this._tileMeshCache[v]=S,S}recalculate(s){}hasTransition(){const s=Ri();let d=!1;return d=d||(s-this._errorMeasurementLastChangeTime)/1e3<.7,d=d||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,d}setErrorQueryLatitudeDegrees(s){this._errorQueryLatitudeDegrees=s}}const Zo=new i.t({type:new i.D(i.u.projection.type)});class Ih extends i.E{constructor(s){super(),this._transitionable=new i.x(Zo,void 0),this.setProjection(s),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new i.H(0)),this._mercatorProjection=new Ls,this._verticalPerspectiveProjection=new Ml}get transitionState(){const s=this.properties.get("type");if(typeof s=="string"&&s==="mercator")return 0;if(typeof s=="string"&&s==="vertical-perspective")return 1;if(s instanceof i.bv){if(s.from==="vertical-perspective"&&s.to==="mercator")return 1-s.transition;if(s.from==="mercator"&&s.to==="vertical-perspective")return s.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(s){this._mercatorProjection.updateGPUdependent(s),this._verticalPerspectiveProjection.updateGPUdependent(s)}getMeshFromTileID(s,d,v,S,D){return this.currentProjection.getMeshFromTileID(s,d,v,S,D)}setProjection(s){this._transitionable.setValue("type",s?.type||"mercator")}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}setErrorQueryLatitudeDegrees(s){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(s),this._mercatorProjection.setErrorQueryLatitudeDegrees(s)}}function up(C){const s=ju(C.worldSize,C.center.lat);return 2*Math.PI*s}function Hl(C,s,d,v,S){const D=1/(1<<S),k=s/i.a4*D+v*D,j=i.bx((C/i.a4*D+d*D)*Math.PI*2+Math.PI,2*Math.PI),H=2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI,J=Math.cos(H),et=new Float64Array(3);return et[0]=Math.sin(j)*J,et[1]=Math.sin(H),et[2]=Math.cos(j)*J,et}function Dr(C){return function(s,d){const v=Math.cos(d),S=new Float64Array(3);return S[0]=Math.sin(s)*v,S[1]=Math.sin(d),S[2]=Math.cos(s)*v,S}(C.lng*Math.PI/180,C.lat*Math.PI/180)}function ju(C,s){return C/(2*Math.PI)/Math.cos(s*Math.PI/180)}function af(C){const s=Math.asin(C[1])/Math.PI*180,d=Math.sqrt(C[0]*C[0]+C[2]*C[2]);if(d>1e-6){const v=C[0]/d,S=Math.acos(C[2]/d),D=(v>0?S:-S)/Math.PI*180;return new i.V(i.W(D,-180,180),s)}return new i.V(0,s)}function na(C){return Math.cos(C*Math.PI/180)}function Vi(C,s){const d=na(C),v=na(s);return i.at(v/d)}function Za(C,s){const d=C.rotate(s.bearingInRadians),v=s.zoom+Vi(s.center.lat,0),S=i.bt(1/na(s.center.lat),1/na(Math.min(Math.abs(s.center.lat),60)),i.bw(v,7,3,0,1)),D=360/up({worldSize:s.worldSize,center:{lat:s.center.lat}});return new i.V(s.center.lng-d.x*D*S,i.an(s.center.lat+d.y*D,-i.ao,i.ao))}function al(C){const s=.5*C,d=Math.sin(s),v=Math.cos(s);return Math.log(d+v)-Math.log(v-d)}function ll(C,s,d,v){const S=C.lat+d*v;if(Math.abs(d)>1){const D=(Math.sign(C.lat+d)!==Math.sign(C.lat)?-Math.abs(C.lat):Math.abs(C.lat))*Math.PI/180,k=Math.abs(C.lat+d)*Math.PI/180,j=al(D+v*(k-D)),H=al(D),J=al(k);return new i.V(C.lng+s*((j-H)/(J-H)),S)}return new i.V(C.lng+s*v,S)}class Cl{constructor(s){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._boundingVolumeFactory=s}swapBuffers(){if(!this._hadAnyChanges)return;const s=this._cachePrevious;this._cachePrevious=this._cache,this._cache=s,this._cache.clear(),this._hadAnyChanges=!1}getTileBoundingVolume(s,d,v,S){const D=`${s.z}_${s.x}_${s.y}_${S?.terrain?"t":""}`,k=this._cache.get(D);if(k)return k;const j=this._cachePrevious.get(D);if(j)return this._cache.set(D,j),j;const H=this._boundingVolumeFactory(s,d,v,S);return this._cache.set(D,H),this._hadAnyChanges=!0,H}}class Da{constructor(s,d,v,S){this.min=v,this.max=S,this.points=s,this.planes=d}static fromAabb(s,d){const v=[];for(let S=0;S<8;S++)v.push([1&~S?s[0]:d[0],(S>>1&1)==1?d[1]:s[1],(S>>2&1)==1?d[2]:s[2]]);return new Da(v,[[-1,0,0,d[0]],[1,0,0,-s[0]],[0,-1,0,d[1]],[0,1,0,-s[1]],[0,0,-1,d[2]],[0,0,1,-s[2]]],s,d)}static fromCenterSizeAngles(s,d,v){const S=i.bA([],v[0],v[1],v[2]),D=i.bB([],[d[0],0,0],S),k=i.bB([],[0,d[1],0],S),j=i.bB([],[0,0,d[2]],S),H=[...s],J=[...s];for(let mt=0;mt<8;mt++)for(let ut=0;ut<3;ut++){const St=s[ut]+D[ut]*(1&~mt?-1:1)+k[ut]*((mt>>1&1)==1?1:-1)+j[ut]*((mt>>2&1)==1?1:-1);H[ut]=Math.min(H[ut],St),J[ut]=Math.max(J[ut],St)}const et=[];for(let mt=0;mt<8;mt++){const ut=[...s];i.a$(ut,ut,i.a_([],D,1&~mt?-1:1)),i.a$(ut,ut,i.a_([],k,(mt>>1&1)==1?1:-1)),i.a$(ut,ut,i.a_([],j,(mt>>2&1)==1?1:-1)),et.push(ut)}return new Da(et,[[...D,-i.b4(D,et[0])],[...k,-i.b4(k,et[0])],[...j,-i.b4(j,et[0])],[-D[0],-D[1],-D[2],-i.b4(D,et[7])],[-k[0],-k[1],-k[2],-i.b4(k,et[7])],[-j[0],-j[1],-j[2],-i.b4(j,et[7])]],H,J)}intersectsFrustum(s){let d=!0;const v=this.points.length,S=this.planes.length,D=s.planes.length,k=s.points.length;for(let j=0;j<D;j++){const H=s.planes[j];let J=0;for(let et=0;et<v;et++){const mt=this.points[et];H[0]*mt[0]+H[1]*mt[1]+H[2]*mt[2]+H[3]>=0&&J++}if(J===0)return 0;J<v&&(d=!1)}if(d)return 2;for(let j=0;j<S;j++){const H=this.planes[j];let J=0;for(let et=0;et<k;et++){const mt=s.points[et];H[0]*mt[0]+H[1]*mt[1]+H[2]*mt[2]+H[3]>=0&&J++}if(J===0)return 0}return 1}intersectsPlane(s){const d=this.points.length;let v=0;for(let S=0;S<d;S++){const D=this.points[S];s[0]*D[0]+s[1]*D[1]+s[2]*D[2]+s[3]>=0&&v++}return v===d?2:v===0?0:1}}function Oi(C,s,d){const v=C-s;return v<0?-v:Math.max(0,v-d)}function Ur(C,s,d,v,S){const D=C-d;let k;return k=D<0?Math.min(-D,1+D-S):D>1?Math.min(Math.max(D-S,0),1-D):0,Math.max(k,Oi(s,v,S))}class sn{constructor(){this._boundingVolumeCache=new Cl(this._computeTileBoundingVolume)}prepareNextFrame(){this._boundingVolumeCache.swapBuffers()}distanceToTile2d(s,d,v,S){const D=1<<v.z,k=1/D,j=v.x/D,H=v.y/D;let J=2;return J=Math.min(J,Ur(s,d,j,H,k)),J=Math.min(J,Ur(s,d,j+.5,-H-k,k)),J=Math.min(J,Ur(s,d,j+.5,2-H-k,k)),J}getWrap(s,d,v){const S=1<<d.z,D=1/S,k=d.x/S,j=Oi(s.x,k,D),H=Oi(s.x,k-1,D),J=Oi(s.x,k+1,D),et=Math.min(j,H,J);return et===J?1:et===H?-1:0}allowVariableZoom(s,d){return Ir(s,d)>4}allowWorldCopies(){return!1}getTileBoundingVolume(s,d,v,S){return this._boundingVolumeCache.getTileBoundingVolume(s,d,v,S)}_computeTileBoundingVolume(s,d,v,S){var D,k;let j=0,H=0;if(S?.terrain){const J=new i.a1(s.z,d,s.z,s.x,s.y),et=S.terrain.getMinMaxElevation(J);j=(D=et.minElevation)!==null&&D!==void 0?D:Math.min(0,v),H=(k=et.maxElevation)!==null&&k!==void 0?k:Math.max(0,v)}if(j/=i.bD,H/=i.bD,j+=1,H+=1,s.z<=0)return Da.fromAabb([-H,-H,-H],[H,H,H]);if(s.z===1)return Da.fromAabb([s.x===0?-H:0,s.y===0?0:-H,-H],[s.x===0?0:H,s.y===0?H:0,H]);{const J=[Hl(0,0,s.x,s.y,s.z),Hl(i.a4,0,s.x,s.y,s.z),Hl(i.a4,i.a4,s.x,s.y,s.z),Hl(0,i.a4,s.x,s.y,s.z)],et=[];for(const Je of J)et.push(i.a_([],Je,H));if(H!==j)for(const Je of J)et.push(i.a_([],Je,j));s.y===0&&et.push([0,1,0]),s.y===(1<<s.z)-1&&et.push([0,-1,0]);const mt=[1,1,1],ut=[-1,-1,-1];for(const Je of et)for(let ii=0;ii<3;ii++)mt[ii]=Math.min(mt[ii],Je[ii]),ut[ii]=Math.max(ut[ii],Je[ii]);const St=Hl(i.a4/2,i.a4/2,s.x,s.y,s.z),pt=i.b3([],[0,1,0],St);i.b2(pt,pt);const Et=i.b3([],St,pt);i.b2(Et,Et);const Kt=i.b3([],J[2],J[1]);i.b2(Kt,Kt);const Xt=i.b3([],J[0],J[3]);i.b2(Xt,Xt),et.push(i.a_([],St,H)),s.y>=(1<<s.z)/2&&et.push(i.a_([],Hl(i.a4/2,0,s.x,s.y,s.z),H)),s.y<(1<<s.z)/2&&et.push(i.a_([],Hl(i.a4/2,i.a4,s.x,s.y,s.z),H));const ft=Ha(St,et),_e=Ha(Et,et),ce=[-St[0],-St[1],-St[2],ft.max],me=[St[0],St[1],St[2],-ft.min],be=[-Et[0],-Et[1],-Et[2],_e.max],de=[Et[0],Et[1],Et[2],-_e.min],De=[...Kt,0],Qe=[...Xt,0],Xe=[];return s.y===0?Xe.push(i.bC(Qe,De,ce),i.bC(Qe,De,me)):Xe.push(i.bC(be,De,ce),i.bC(be,De,me),i.bC(be,Qe,ce),i.bC(be,Qe,me)),s.y===(1<<s.z)-1?Xe.push(i.bC(Qe,De,ce),i.bC(Qe,De,me)):Xe.push(i.bC(de,De,ce),i.bC(de,De,me),i.bC(de,Qe,ce),i.bC(de,Qe,me)),new Da(Xe,[ce,me,be,de,De,Qe],mt,ut)}}}function Ha(C,s){let d=1/0,v=-1/0;for(const S of s){const D=i.b4(C,S);d=Math.min(d,D),v=Math.max(v,D)}return{min:d,max:v}}class Jc{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(s){this._helper.setMinZoom(s)}setMaxZoom(s){this._helper.setMaxZoom(s)}setMinPitch(s){this._helper.setMinPitch(s)}setMaxPitch(s){this._helper.setMaxPitch(s)}setRenderWorldCopies(s){this._helper.setRenderWorldCopies(s)}setBearing(s){this._helper.setBearing(s)}setPitch(s){this._helper.setPitch(s)}setRoll(s){this._helper.setRoll(s)}setFov(s){this._helper.setFov(s)}setZoom(s){this._helper.setZoom(s)}setCenter(s){this._helper.setCenter(s)}setElevation(s){this._helper.setElevation(s)}setMinElevationForCurrentTile(s){this._helper.setMinElevationForCurrentTile(s)}setPadding(s){this._helper.setPadding(s)}interpolatePadding(s,d,v){return this._helper.interpolatePadding(s,d,v)}isPaddingEqual(s){return this._helper.isPaddingEqual(s)}resize(s,d){this._helper.resize(s,d)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(s){this._helper.setMaxBounds(s)}setConstrainOverride(s){this._helper.setConstrainOverride(s)}overrideNearFarZ(s,d){this._helper.overrideNearFarZ(s,d)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(s){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),s)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(s){}constructor(s){this._cachedClippingPlane=i.bE(),this._projectionMatrix=i.bi(),this._globeViewProjMatrix32f=i.bh(),this._globeViewProjMatrixNoCorrection=i.bi(),this._globeViewProjMatrixNoCorrectionInverted=i.bi(),this._globeProjMatrixInverted=i.bi(),this._cameraPosition=i.by(),this._globeLatitudeErrorCorrectionRadians=0,this.defaultConstrain=(d,v)=>{const S=i.an(d.lat,-i.ao,i.ao),D=i.an(+v,this.minZoom+Vi(0,S),this.maxZoom);return{center:new i.V(d.lng,S),zoom:D}},this.applyConstrain=(d,v)=>this._helper.applyConstrain(d,v),this._helper=new Rs({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(d,v)=>this.defaultConstrain(d,v)},s),this._coveringTilesDetailsProvider=new sn}clone(){const s=new Jc;return s.apply(this),s}apply(s,d){this._globeLatitudeErrorCorrectionRadians=d||0,this._helper.apply(s)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const s=i.by();return s[0]=this._cameraPosition[0],s[1]=this._cameraPosition[1],s[2]=this._cameraPosition[2],s}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(s){const{overscaledTileID:d,applyGlobeMatrix:v}=s,S=this._helper.getMercatorTileCoordinates(d);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:S,clippingPlane:this._cachedClippingPlane,projectionTransition:v?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(s){const d=this.pitchInRadians,v=this.cameraToCenterDistance/s,S=Math.sin(d)*v,D=Math.cos(d)*v+1,k=1/Math.sqrt(S*S+D*D)*1;let j=-S,H=D;const J=Math.sqrt(j*j+H*H);j/=J,H/=J;const et=[0,j,H];i.bF(et,et,[0,0,0],-this.bearingInRadians),i.bG(et,et,[0,0,0],-1*this.center.lat*Math.PI/180),i.bH(et,et,[0,0,0],this.center.lng*Math.PI/180);const mt=1/i.b6(et);return i.a_(et,et,mt),[...et,-k*mt]}isLocationOccluded(s){return!this.isSurfacePointVisible(Dr(s))}transformLightDirection(s){const d=this._helper._center.lng*Math.PI/180,v=this._helper._center.lat*Math.PI/180,S=Math.cos(v),D=[Math.sin(d)*S,Math.sin(v),Math.cos(d)*S],k=[D[2],0,-D[0]],j=[0,0,0];i.b3(j,k,D),i.b2(k,k),i.b2(j,j);const H=[0,0,0];return i.b2(H,[k[0]*s[0]+j[0]*s[1]+D[0]*s[2],k[1]*s[0]+j[1]*s[1]+D[1]*s[2],k[2]*s[0]+j[2]*s[1]+D[2]*s[2]]),H}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(s,d,v){const S=function(j,H,J){const et=1/(1<<J.z);return new i.aa(j/i.a4*et+J.x*et,H/i.a4*et+J.y*et)}(s,d,v.canonical),D=(k=S.y,[i.bx(S.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI]);var k;return this.getCircleRadiusCorrection()/Math.cos(D[1])}projectTileCoordinates(s,d,v,S){const D=v.canonical,k=Hl(s,d,D.x,D.y,D.z),j=1+(S?S(s,d):0)/i.bD,H=[k[0]*j,k[1]*j,k[2]*j,1];i.aG(H,H,this._globeViewProjMatrixNoCorrection);const J=this._cachedClippingPlane,et=J[0]*k[0]+J[1]*k[1]+J[2]*k[2]+J[3]<0;return{point:new i.P(H[0]/H[3],H[1]/H[3]),signedDistanceFromCamera:H[3],isOccluded:et}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const s=ju(this.worldSize,this.center.lat),d=i.bj(),v=i.bj();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*s),i.bd(d,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const S=this.centerOffset;d[8]=2*-S.x/this._helper._width,d[9]=2*S.y/this._helper._height,this._projectionMatrix=i.be(d),this._globeProjMatrixInverted=i.bj(),i.aA(this._globeProjMatrixInverted,d),i.O(d,d,[0,0,-this.cameraToCenterDistance]),i.bf(d,d,this.rollInRadians),i.bg(d,d,-this.pitchInRadians),i.bf(d,d,this.bearingInRadians),i.O(d,d,[0,0,-s]);const D=i.by();D[0]=s,D[1]=s,D[2]=s,i.bg(v,d,this.center.lat*Math.PI/180),i.bI(v,v,-this.center.lng*Math.PI/180),i.Q(v,v,D),this._globeViewProjMatrixNoCorrection=v,i.bg(d,d,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),i.bI(d,d,-this.center.lng*Math.PI/180),i.Q(d,d,D),this._globeViewProjMatrix32f=new Float32Array(d),this._globeViewProjMatrixNoCorrectionInverted=i.bj(),i.aA(this._globeViewProjMatrixNoCorrectionInverted,v);const k=i.by();this._cameraPosition=i.by(),this._cameraPosition[2]=this.cameraToCenterDistance/s,i.bF(this._cameraPosition,this._cameraPosition,k,-this.rollInRadians),i.bG(this._cameraPosition,this._cameraPosition,k,this.pitchInRadians),i.bF(this._cameraPosition,this._cameraPosition,k,-this.bearingInRadians),i.a$(this._cameraPosition,this._cameraPosition,[0,0,1]),i.bG(this._cameraPosition,this._cameraPosition,k,-this.center.lat*Math.PI/180),i.bH(this._cameraPosition,this._cameraPosition,k,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(s);const j=i.be(this._globeViewProjMatrixNoCorrectionInverted);i.Q(j,j,[1,1,-1]),this._cachedFrustum=Pl.fromInvProjectionMatrix(j,1,0,this._cachedClippingPlane,!0)}calculateFogMatrix(s){i.w("calculateFogMatrix is not supported on globe projection.");const d=i.bj();return i.ar(d),d}getVisibleUnwrappedCoordinates(s){return[new i.bb(0,s)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(s){s&&i.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(s,d){if(!this._globeViewProjMatrixNoCorrection)return 1;const v=Dr(s);i.a_(v,v,1+d/i.bD);const S=i.bE();return i.aG(S,[v[0],v[1],v[2],1],this._globeViewProjMatrixNoCorrection),S[2]/S[3]}populateCache(s){}getBounds(){const s=.5*this.width,d=.5*this.height,v=[new i.P(0,0),new i.P(s,0),new i.P(this.width,0),new i.P(this.width,d),new i.P(this.width,this.height),new i.P(s,this.height),new i.P(0,this.height),new i.P(0,d)],S=[];for(const mt of v)S.push(this.unprojectScreenPoint(mt));let D=0,k=0,j=0,H=0;const J=this.center;for(const mt of S){const ut=i.bJ(J.lng,mt.lng),St=i.bJ(J.lat,mt.lat);ut<k&&(k=ut),ut>D&&(D=ut),St<H&&(H=St),St>j&&(j=St)}const et=[J.lng+k,J.lat+H,J.lng+D,J.lat+j];return this.isSurfacePointOnScreen([0,1,0])&&(et[3]=90,et[0]=-180,et[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(et[1]=-90,et[0]=-180,et[2]=180),new lo(et)}calculateCenterFromCameraLngLatAlt(s,d,v,S){return this._helper.calculateCenterFromCameraLngLatAlt(s,d,v,S)}setLocationAtPoint(s,d){const v=Dr(this.unprojectScreenPoint(d)),S=Dr(s),D=i.by();i.bK(D);const k=i.by();i.bH(k,v,D,-this.center.lng*Math.PI/180),i.bG(k,k,D,this.center.lat*Math.PI/180);const j=S[0]*S[0]+S[2]*S[2],H=k[0]*k[0];if(j<H)return;const J=Math.sqrt(j-H),et=-J,mt=i.bL(S[0],S[2],k[0],J),ut=i.bL(S[0],S[2],k[0],et),St=i.by();i.bH(St,S,D,-mt);const pt=i.bL(St[1],St[2],k[1],k[2]),Et=i.by();i.bH(Et,S,D,-ut);const Kt=i.bL(Et[1],Et[2],k[1],k[2]),Xt=.5*Math.PI,ft=pt>=-Xt&&pt<=Xt,_e=Kt>=-Xt&&Kt<=Xt;let ce,me;if(ft&&_e){const Qe=this.center.lng*Math.PI/180,Xe=this.center.lat*Math.PI/180;i.bM(mt,Qe)+i.bM(pt,Xe)<i.bM(ut,Qe)+i.bM(Kt,Xe)?(ce=mt,me=pt):(ce=ut,me=Kt)}else if(ft)ce=mt,me=pt;else{if(!_e)return;ce=ut,me=Kt}const be=ce/Math.PI*180,de=me/Math.PI*180,De=this.center.lat;this.setCenter(new i.V(be,i.an(de,-90,90))),this.setZoom(this.zoom+Vi(De,this.center.lat))}locationToScreenPoint(s,d){const v=Dr(s);if(d){const S=d.getElevationForLngLatZoom(s,this._helper._tileZoom);i.a_(v,v,1+S/i.bD)}return this._projectSurfacePointToScreen(v)}_projectSurfacePointToScreen(s){const d=i.bE();return i.aG(d,[...s,1],this._globeViewProjMatrixNoCorrection),d[0]/=d[3],d[1]/=d[3],new i.P((.5*d[0]+.5)*this.width,(.5*-d[1]+.5)*this.height)}screenPointToMercatorCoordinate(s,d){if(d){const v=d.pointCoordinate(s);if(v)return v}return i.aa.fromLngLat(this.unprojectScreenPoint(s))}screenPointToLocation(s,d){var v;return(v=this.screenPointToMercatorCoordinate(s,d))===null||v===void 0?void 0:v.toLngLat()}isPointOnMapSurface(s,d){const v=this._cameraPosition,S=this.getRayDirectionFromPixel(s);return!!this.rayPlanetIntersection(v,S)}getRayDirectionFromPixel(s){const d=i.bE();d[0]=s.x/this.width*2-1,d[1]=-1*(s.y/this.height*2-1),d[2]=1,d[3]=1,i.aG(d,d,this._globeViewProjMatrixNoCorrectionInverted),d[0]/=d[3],d[1]/=d[3],d[2]/=d[3];const v=i.by();v[0]=d[0]-this._cameraPosition[0],v[1]=d[1]-this._cameraPosition[1],v[2]=d[2]-this._cameraPosition[2];const S=i.by();return i.b2(S,v),S}isSurfacePointVisible(s){const d=this._cachedClippingPlane;return d[0]*s[0]+d[1]*s[1]+d[2]*s[2]+d[3]>=0}isSurfacePointOnScreen(s){if(!this.isSurfacePointVisible(s))return!1;const d=i.bE();return i.aG(d,[...s,1],this._globeViewProjMatrixNoCorrection),d[0]/=d[3],d[1]/=d[3],d[2]/=d[3],d[0]>-1&&d[0]<1&&d[1]>-1&&d[1]<1&&d[2]>-1&&d[2]<1}rayPlanetIntersection(s,d){const v=i.b4(s,d),S=i.by(),D=i.by();i.a_(D,d,v),i.b1(S,s,D);const k=1-i.b4(S,S);if(k<0)return null;const j=i.b4(s,s)-1,H=-v+(v<0?1:-1)*Math.sqrt(k),J=j/H,et=H;return{tMin:Math.min(J,et),tMax:Math.max(J,et)}}unprojectScreenPoint(s){const d=this._cameraPosition,v=this.getRayDirectionFromPixel(s),S=this.rayPlanetIntersection(d,v);if(S){const et=i.by();i.a$(et,d,[v[0]*S.tMin,v[1]*S.tMin,v[2]*S.tMin]);const mt=i.by();return i.b2(mt,et),af(mt)}const D=this._cachedClippingPlane,k=D[0]*v[0]+D[1]*v[1]+D[2]*v[2],j=-i.ba(D,d)/k,H=i.by();if(j>0)i.a$(H,d,[v[0]*j,v[1]*j,v[2]*j]);else{const et=i.by();i.a$(et,d,[2*v[0],2*v[1],2*v[2]]);const mt=i.ba(this._cachedClippingPlane,et);i.b1(H,et,[this._cachedClippingPlane[0]*mt,this._cachedClippingPlane[1]*mt,this._cachedClippingPlane[2]*mt])}const J=function(et){const mt=i.by();return mt[0]=et[0]*-et[3],mt[1]=et[1]*-et[3],mt[2]=et[2]*-et[3],{center:mt,radius:Math.sqrt(1-et[3]*et[3])}}(D);return af(function(et,mt,ut){const St=i.by();i.b1(St,ut,et);const pt=i.by();return i.bz(pt,et,St,mt/i.b8(St)),pt}(J.center,J.radius,H))}getMatrixForModel(s,d){const v=i.V.convert(s),S=1/i.bD,D=i.bi();return i.bI(D,D,v.lng/180*Math.PI),i.bg(D,D,-v.lat/180*Math.PI),i.O(D,D,[0,0,1+d/i.bD]),i.bg(D,D,.5*Math.PI),i.Q(D,D,[S,S,S]),D}getProjectionDataForCustomLayer(s=!0){const d=this.getProjectionData({overscaledTileID:new i.a1(0,0,0,0,0),applyGlobeMatrix:s});return d.tileMercatorCoords=[0,0,1,1],d}getFastPathSimpleProjectionMatrix(s){}}class en{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(s){this._helper.setMinZoom(s)}setMaxZoom(s){this._helper.setMaxZoom(s)}setMinPitch(s){this._helper.setMinPitch(s)}setMaxPitch(s){this._helper.setMaxPitch(s)}setRenderWorldCopies(s){this._helper.setRenderWorldCopies(s)}setBearing(s){this._helper.setBearing(s)}setPitch(s){this._helper.setPitch(s)}setRoll(s){this._helper.setRoll(s)}setFov(s){this._helper.setFov(s)}setZoom(s){this._helper.setZoom(s)}setCenter(s){this._helper.setCenter(s)}setElevation(s){this._helper.setElevation(s)}setMinElevationForCurrentTile(s){this._helper.setMinElevationForCurrentTile(s)}setPadding(s){this._helper.setPadding(s)}interpolatePadding(s,d,v){return this._helper.interpolatePadding(s,d,v)}isPaddingEqual(s){return this._helper.isPaddingEqual(s)}resize(s,d,v=!0){this._helper.resize(s,d,v)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(s){this._helper.setMaxBounds(s)}setConstrainOverride(s){this._helper.setConstrainOverride(s)}overrideNearFarZ(s,d){this._helper.overrideNearFarZ(s,d)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(s){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),s)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(s,d){this._globeness=s,this._globeLatitudeErrorCorrectionRadians=d,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().prepareNextFrame(),this._mercatorTransform.getCoveringTilesDetailsProvider().prepareNextFrame()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(s){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this.defaultConstrain=(d,v)=>this.currentTransform.defaultConstrain(d,v),this.applyConstrain=(d,v)=>this._helper.applyConstrain(d,v),this._helper=new Rs({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(d,v)=>this.defaultConstrain(d,v)},s),this._globeness=1,this._mercatorTransform=new pr,this._verticalPerspectiveTransform=new Jc}clone(){const s=new en;return s._globeness=this._globeness,s._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,s.apply(this),s}apply(s){this._helper.apply(s),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(s){const d=this._mercatorTransform.getProjectionData(s),v=this._verticalPerspectiveTransform.getProjectionData(s);return{mainMatrix:this.isGlobeRendering?v.mainMatrix:d.mainMatrix,clippingPlane:v.clippingPlane,tileMercatorCoords:v.tileMercatorCoords,projectionTransition:s.applyGlobeMatrix?this._globeness:0,fallbackMatrix:d.fallbackMatrix}}isLocationOccluded(s){return this.currentTransform.isLocationOccluded(s)}transformLightDirection(s){return this.currentTransform.transformLightDirection(s)}getPixelScale(){return i.bt(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return i.bt(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(s,d,v){const S=this._mercatorTransform.getPitchedTextCorrection(s,d,v),D=this._verticalPerspectiveTransform.getPitchedTextCorrection(s,d,v);return i.bt(S,D,this._globeness)}projectTileCoordinates(s,d,v,S){return this.currentTransform.projectTileCoordinates(s,d,v,S)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(s){return this.currentTransform.calculateFogMatrix(s)}getVisibleUnwrappedCoordinates(s){return this.currentTransform.getVisibleUnwrappedCoordinates(s)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(s){this._mercatorTransform.recalculateZoomAndCenter(s),this._verticalPerspectiveTransform.recalculateZoomAndCenter(s)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(s,d){return this.currentTransform.lngLatToCameraDepth(s,d)}populateCache(s){this._mercatorTransform.populateCache(s),this._verticalPerspectiveTransform.populateCache(s)}getBounds(){return this.currentTransform.getBounds()}calculateCenterFromCameraLngLatAlt(s,d,v,S){return this._helper.calculateCenterFromCameraLngLatAlt(s,d,v,S)}setLocationAtPoint(s,d){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(s,d),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(s,d),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(s,d){return this.currentTransform.locationToScreenPoint(s,d)}screenPointToMercatorCoordinate(s,d){return this.currentTransform.screenPointToMercatorCoordinate(s,d)}screenPointToLocation(s,d){return this.currentTransform.screenPointToLocation(s,d)}isPointOnMapSurface(s,d){return this.currentTransform.isPointOnMapSurface(s,d)}getRayDirectionFromPixel(s){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(s)}getMatrixForModel(s,d){return this.currentTransform.getMatrixForModel(s,d)}getProjectionDataForCustomLayer(s=!0){const d=this._mercatorTransform.getProjectionDataForCustomLayer(s);if(!this.isGlobeRendering)return d;const v=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(s);return v.fallbackMatrix=d.mainMatrix,v}getFastPathSimpleProjectionMatrix(s){return this.currentTransform.getFastPathSimpleProjectionMatrix(s)}}class oa{get useGlobeControls(){return!0}handlePanInertia(s,d){const v=Za(s,d);return Math.abs(v.lng-d.center.lng)>180&&(v.lng=d.center.lng+179.5*Math.sign(v.lng-d.center.lng)),{easingCenter:v,easingOffset:new i.P(0,0)}}handleMapControlsRollPitchBearingZoom(s,d){const v=s.around,S=d.screenPointToLocation(v);s.bearingDelta&&d.setBearing(d.bearing+s.bearingDelta),s.pitchDelta&&d.setPitch(d.pitch+s.pitchDelta),s.rollDelta&&d.setRoll(d.roll+s.rollDelta);const D=d.zoom;s.zoomDelta&&d.setZoom(d.zoom+s.zoomDelta);const k=d.zoom-D;if(k===0)return;const j=i.bJ(d.center.lng,S.lng),H=j/(Math.abs(j/180)+1),J=i.bJ(d.center.lat,S.lat),et=d.getRayDirectionFromPixel(v),mt=d.cameraPosition,ut=-1*i.b4(mt,et),St=i.by();i.a$(St,mt,[et[0]*ut,et[1]*ut,et[2]*ut]);const pt=i.b6(St)-1,Et=Math.exp(.5*-Math.max(pt-.3,0)),Kt=ju(d.worldSize,d.center.lat)/Math.min(d.width,d.height),Xt=i.bw(Kt,.9,.5,1,.25),ft=(1-i.aq(-k))*Math.min(Et,Xt),_e=d.center.lat,ce=d.zoom,me=new i.V(d.center.lng+H*ft,i.an(d.center.lat+J*ft,-i.ao,i.ao));d.setLocationAtPoint(S,v);const be=d.center,de=i.bw(Math.abs(j),45,85,0,1),De=i.bw(Kt,.75,.35,0,1),Qe=Math.pow(Math.max(de,De),.25),Xe=i.bJ(be.lng,me.lng),Je=i.bJ(be.lat,me.lat);d.setCenter(new i.V(be.lng+Xe*Qe,be.lat+Je*Qe).wrap()),d.setZoom(ce+Vi(_e,d.center.lat))}handleMapControlsPan(s,d,v){if(!s.panDelta)return;const S=d.center.lat,D=d.zoom;d.setCenter(Za(s.panDelta,d).wrap()),d.setZoom(D+Vi(S,d.center.lat))}cameraForBoxAndBearing(s,d,v,S,D){const k=Wc(s,d,v,S,D),j=d.left/D.width*2-1,H=(D.width-d.right)/D.width*2-1,J=d.top/D.height*-2+1,et=(D.height-d.bottom)/D.height*-2+1,mt=i.bJ(v.getWest(),v.getEast())<0,ut=mt?v.getEast():v.getWest(),St=mt?v.getWest():v.getEast(),pt=Math.max(v.getNorth(),v.getSouth()),Et=Math.min(v.getNorth(),v.getSouth()),Kt=ut+.5*i.bJ(ut,St),Xt=pt+.5*i.bJ(pt,Et),ft=D.clone();ft.setCenter(k.center),ft.setBearing(k.bearing),ft.setPitch(0),ft.setRoll(0),ft.setZoom(k.zoom);const _e=ft.modelViewProjectionMatrix,ce=[Dr(v.getNorthWest()),Dr(v.getNorthEast()),Dr(v.getSouthWest()),Dr(v.getSouthEast()),Dr(new i.V(St,Xt)),Dr(new i.V(ut,Xt)),Dr(new i.V(Kt,pt)),Dr(new i.V(Kt,Et))],me=Dr(k.center);let be=Number.POSITIVE_INFINITY;for(const de of ce)j<0&&(be=oa.getLesserNonNegativeNonNull(be,oa.solveVectorScale(de,me,_e,"x",j))),H>0&&(be=oa.getLesserNonNegativeNonNull(be,oa.solveVectorScale(de,me,_e,"x",H))),J>0&&(be=oa.getLesserNonNegativeNonNull(be,oa.solveVectorScale(de,me,_e,"y",J))),et<0&&(be=oa.getLesserNonNegativeNonNull(be,oa.solveVectorScale(de,me,_e,"y",et)));if(Number.isFinite(be)&&be!==0)return k.zoom=ft.zoom+i.at(be),k;Sh()}handleJumpToCenterZoom(s,d){const v=s.center.lat,S=s.applyConstrain(d.center?i.V.convert(d.center):s.center,s.zoom).center;s.setCenter(S.wrap());const D=d.zoom!==void 0?+d.zoom:s.zoom+Vi(v,S.lat);s.zoom!==D&&s.setZoom(D)}handleEaseTo(s,d){const v=s.zoom,S=s.center,D=s.padding,k={roll:s.roll,pitch:s.pitch,bearing:s.bearing},j={roll:d.roll===void 0?s.roll:d.roll,pitch:d.pitch===void 0?s.pitch:d.pitch,bearing:d.bearing===void 0?s.bearing:d.bearing},H=d.zoom!==void 0,J=!s.isPaddingEqual(d.padding);let et=!1;const mt=d.center?i.V.convert(d.center):S,ut=s.applyConstrain(mt,v).center;Nu(s,ut);const St=s.clone();St.setCenter(ut),St.setZoom(H?+d.zoom:v+Vi(S.lat,mt.lat)),St.setBearing(d.bearing);const pt=new i.P(i.an(s.centerPoint.x+d.offsetAsPoint.x,0,s.width),i.an(s.centerPoint.y+d.offsetAsPoint.y,0,s.height));St.setLocationAtPoint(ut,pt);const Et=(d.offset&&d.offsetAsPoint.mag())>0?St.center:ut,Kt=H?+d.zoom:v+Vi(S.lat,Et.lat),Xt=v+Vi(S.lat,0),ft=Kt+Vi(Et.lat,0),_e=i.bJ(S.lng,Et.lng),ce=i.bJ(S.lat,Et.lat),me=i.aq(ft-Xt);return et=Kt!==v,{easeFunc:be=>{if(i.bn(k,j)||Zl({startEulerAngles:k,endEulerAngles:j,tr:s,k:be,useSlerp:k.roll!=j.roll}),J&&s.interpolatePadding(D,d.padding,be),d.around)i.w("Easing around a point is not supported under globe projection."),s.setLocationAtPoint(d.around,d.aroundPoint);else{const de=ft>Xt?Math.min(2,me):Math.max(.5,me),De=Math.pow(de,1-be),Qe=ll(S,_e,ce,be*De);s.setCenter(Qe.wrap())}if(et){const de=i.G.number(Xt,ft,be)+Vi(0,s.center.lat);s.setZoom(de)}},isZooming:et,elevationCenter:Et}}handleFlyTo(s,d){const v=d.zoom!==void 0,S=s.center,D=s.zoom,k=s.padding,j=!s.isPaddingEqual(d.padding),H=s.applyConstrain(i.V.convert(d.center||d.locationAtOffset),D).center,J=v?+d.zoom:s.zoom+Vi(s.center.lat,H.lat),et=s.clone();et.setCenter(H),et.setZoom(J),et.setBearing(d.bearing);const mt=new i.P(i.an(s.centerPoint.x+d.offsetAsPoint.x,0,s.width),i.an(s.centerPoint.y+d.offsetAsPoint.y,0,s.height));et.setLocationAtPoint(H,mt);const ut=et.center;Nu(s,ut);const St=function(ce,me,be){const de=Dr(me),De=Dr(be),Qe=i.b4(de,De),Xe=Math.acos(Qe),Je=up(ce);return Xe/(2*Math.PI)*Je}(s,S,ut),pt=D+Vi(S.lat,0),Et=J+Vi(ut.lat,0),Kt=i.aq(Et-pt);let Xt;if(typeof d.minZoom=="number"){const ce=+d.minZoom+Vi(ut.lat,0),me=Math.min(ce,pt,Et)+Vi(0,ut.lat),be=s.applyConstrain(ut,me).zoom+Vi(ut.lat,0);Xt=i.aq(be-pt)}const ft=i.bJ(S.lng,ut.lng),_e=i.bJ(S.lat,ut.lat);return{easeFunc:(ce,me,be,de)=>{const De=ll(S,ft,_e,be);j&&s.interpolatePadding(k,d.padding,ce);const Qe=ce===1?ut:De;s.setCenter(Qe.wrap());const Xe=pt+i.at(me);s.setZoom(ce===1?J:Xe+Vi(0,Qe.lat))},scaleOfZoom:Kt,targetCenter:ut,scaleOfMinZoom:Xt,pixelPathLength:St}}static solveVectorScale(s,d,v,S,D){const k=S==="x"?[v[0],v[4],v[8],v[12]]:[v[1],v[5],v[9],v[13]],j=[v[3],v[7],v[11],v[15]],H=s[0]*k[0]+s[1]*k[1]+s[2]*k[2],J=s[0]*j[0]+s[1]*j[1]+s[2]*j[2],et=d[0]*k[0]+d[1]*k[1]+d[2]*k[2],mt=d[0]*j[0]+d[1]*j[1]+d[2]*j[2];return et+D*J===H+D*mt||j[3]*(H-et)+k[3]*(mt-J)+H*mt==et*J?null:(et+k[3]-D*mt-D*j[3])/(et-H-D*mt+D*J)}static getLesserNonNegativeNonNull(s,d){return d!==null&&d>=0&&d<s?d:s}}class Ac{constructor(s){this._globe=s,this._mercatorCameraHelper=new Ca,this._verticalPerspectiveCameraHelper=new oa}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(s,d){return this.currentHelper.handlePanInertia(s,d)}handleMapControlsRollPitchBearingZoom(s,d){return this.currentHelper.handleMapControlsRollPitchBearingZoom(s,d)}handleMapControlsPan(s,d,v){this.currentHelper.handleMapControlsPan(s,d,v)}cameraForBoxAndBearing(s,d,v,S,D){return this.currentHelper.cameraForBoxAndBearing(s,d,v,S,D)}handleJumpToCenterZoom(s,d){this.currentHelper.handleJumpToCenterZoom(s,d)}handleEaseTo(s,d){return this.currentHelper.handleEaseTo(s,d)}handleFlyTo(s,d){return this.currentHelper.handleFlyTo(s,d)}}const lc=(C,s)=>i.B(C,s&&s.filter(d=>d.identifier!=="source.canvas")),ps=i.bN();class Oo extends i.E{constructor(s,d={}){var v,S;super(),this._rtlPluginLoaded=()=>{for(const k in this.tileManagers){const j=this.tileManagers[k].getSource().type;j!=="vector"&&j!=="geojson"||this.tileManagers[k].reload()}},this.map=s,this.dispatcher=new ho(bn(),s._getMapId()),this.dispatcher.registerMessageHandler("GG",(k,j)=>this.getGlyphs(k,j)),this.dispatcher.registerMessageHandler("GI",(k,j)=>this.getImages(k,j)),this.dispatcher.registerMessageHandler("GDA",(k,j)=>this.getDashes(k,j)),this.imageManager=new Vl,this.imageManager.setEventedParent(this);const D=((v=s._container)===null||v===void 0?void 0:v.lang)||typeof document<"u"&&((S=document.documentElement)===null||S===void 0?void 0:S.lang)||void 0;this.glyphManager=new dn(s._requestManager,d.localIdeographFontFamily,D),this.lineAtlas=new Jn(256,512),this.crossTileSymbolIndex=new Gs,this._setInitialValues(),this._resetUpdates(),this.dispatcher.broadcast("SR",i.bO()),Aa().on(rl,this._rtlPluginLoaded),this.on("data",k=>{if(k.dataType!=="source"||k.sourceDataType!=="metadata")return;const j=this.tileManagers[k.sourceId];if(!j)return;const H=j.getSource();if(H&&H.vectorLayerIds)for(const J in this._layers){const et=this._layers[J];et.source===H.id&&this._validateLayer(et)}})}_setInitialValues(){var s;this._spritesImagesIds={},this._layers={},this._order=[],this.tileManagers={},this.zoomHistory=new i.bP,this._availableImages=[],this._globalState={},this._serializedLayers={},this.stylesheet=null,this.light=null,this.sky=null,this.projection&&(this.projection.destroy(),delete this.projection),this._loaded=!1,this._changed=!1,this._updatedLayers={},this._updatedSources={},this._changedImages={},this._glyphsDidChange=!1,this._updatedPaintProps={},this._layerOrderChanged=!1,this.crossTileSymbolIndex=new(((s=this.crossTileSymbolIndex)===null||s===void 0?void 0:s.constructor)||Object),this.pauseablePlacement=void 0,this.placement=void 0,this.z=0}setGlobalStateProperty(s,d){var v,S,D;this._checkLoaded();const k=d===null?(D=(S=(v=this.stylesheet.state)===null||v===void 0?void 0:v[s])===null||S===void 0?void 0:S.default)!==null&&D!==void 0?D:null:d;if(i.bQ(k,this._globalState[s]))return this;this._globalState[s]=k,this._applyGlobalStateChanges([s])}getGlobalState(){return this._globalState}setGlobalState(s){this._checkLoaded();const d=[];for(const v in s)!i.bQ(this._globalState[v],s[v].default)&&(d.push(v),this._globalState[v]=s[v].default);this._applyGlobalStateChanges(d)}_applyGlobalStateChanges(s){if(s.length===0)return;const d=new Set,v={};for(const S of s){v[S]=this._globalState[S];for(const D in this._layers){const k=this._layers[D],j=k.getLayoutAffectingGlobalStateRefs(),H=k.getPaintAffectingGlobalStateRefs();if(j.has(S)&&d.add(k.source),H.has(S))for(const{name:J,value:et}of H.get(S))this._updatePaintProperty(k,J,et)}}this.dispatcher.broadcast("UGS",v);for(const S in this.tileManagers)d.has(S)&&(this._reloadSource(S),this._changed=!0)}loadURL(s,d={},v){this.fire(new i.l("dataloading",{dataType:"style"})),d.validate=typeof d.validate!="boolean"||d.validate;const S=this.map._requestManager.transformRequest(s,"Style");this._loadStyleRequest=new AbortController;const D=this._loadStyleRequest;i.j(S,this._loadStyleRequest).then(k=>{this._loadStyleRequest=null,this._load(k.data,d,v)}).catch(k=>{this._loadStyleRequest=null,k&&!D.signal.aborted&&this.fire(new i.k(k))})}loadJSON(s,d={},v){this.fire(new i.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,Br.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,d.validate=d.validate!==!1,this._load(s,d,v)}).catch(()=>{})}loadEmpty(){this.fire(new i.l("dataloading",{dataType:"style"})),this._load(ps,{validate:!1})}_load(s,d,v){var S,D;let k=d.transformStyle?d.transformStyle(v,s):s;if(!d.validate||!lc(this,i.C(k))){k=Object.assign({},k),this._loaded=!0,this.stylesheet=k;for(const j in k.sources)this.addSource(j,k.sources[j],{validate:!1});k.sprite?this._loadSprite(k.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(k.glyphs),this._createLayers(),this.light=new Ea(this.stylesheet.light),this._setProjectionInternal(((S=this.stylesheet.projection)===null||S===void 0?void 0:S.type)||"mercator"),this.sky=new Js(this.stylesheet.sky),this.map.setTerrain((D=this.stylesheet.terrain)!==null&&D!==void 0?D:null),this.fire(new i.l("data",{dataType:"style"})),this.fire(new i.l("style.load"))}}_createLayers(){var s,d,v;const S=i.bR(this.stylesheet.layers);this.setGlobalState((s=this.stylesheet.state)!==null&&s!==void 0?s:null),this.dispatcher.broadcast("SL",S),this._order=S.map(D=>D.id),this._layers={},this._serializedLayers=null;for(const D of S){const k=i.bS(D,this._globalState);if(k.setEventedParent(this,{layer:{id:D.id}}),this._layers[D.id]=k,i.bT(k)&&this.tileManagers[k.source]){const j=(v=(d=D.paint)===null||d===void 0?void 0:d["raster-fade-duration"])!==null&&v!==void 0?v:k.paint.get("raster-fade-duration");this.tileManagers[k.source].setRasterFadeDuration(j)}}}_loadSprite(s,d=!1,v=void 0){let S;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(D,k,j,H){return i._(this,void 0,void 0,function*(){const J=fa(D),et=j>1?"@2x":"",mt={},ut={};for(const{id:St,url:pt}of J){const Et=k.transformRequest(Nl(pt,et,".json"),"SpriteJSON");mt[St]=i.j(Et,H);const Kt=k.transformRequest(Nl(pt,et,".png"),"SpriteImage");ut[St]=Do.getImage(Kt,H)}return yield Promise.all([...Object.values(mt),...Object.values(ut)]),function(St,pt){return i._(this,void 0,void 0,function*(){const Et={};for(const Kt in St){Et[Kt]={};const Xt=Br.getImageCanvasContext((yield pt[Kt]).data),ft=(yield St[Kt]).data;for(const _e in ft){const{width:ce,height:me,x:be,y:de,sdf:De,pixelRatio:Qe,stretchX:Xe,stretchY:Je,content:ii,textFitWidth:Di,textFitHeight:Fi}=ft[_e];Et[Kt][_e]={data:null,pixelRatio:Qe,sdf:De,stretchX:Xe,stretchY:Je,content:ii,textFitWidth:Di,textFitHeight:Fi,spriteData:{width:ce,height:me,x:be,y:de,context:Xt}}}}return Et})}(mt,ut)})}(s,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(D=>{if(this._spriteRequest=null,D)for(const k in D){this._spritesImagesIds[k]=[];const j=this._spritesImagesIds[k]?this._spritesImagesIds[k].filter(H=>!(H in D)):[];for(const H of j)this.imageManager.removeImage(H),this._changedImages[H]=!0;for(const H in D[k]){const J=k==="default"?H:`${k}:${H}`;this._spritesImagesIds[k].push(J),J in this.imageManager.images?this.imageManager.updateImage(J,D[k][H],!1):this.imageManager.addImage(J,D[k][H]),d&&(this._changedImages[J]=!0)}}}).catch(D=>{this._spriteRequest=null,S=D,this.fire(new i.k(S))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),d&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"})),v&&v(S)})}_unloadSprite(){for(const s of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(s),this._changedImages[s]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"}))}_validateLayer(s){const d=this.tileManagers[s.source];if(!d)return;const v=s.sourceLayer;if(!v)return;const S=d.getSource();(S.type==="geojson"||S.vectorLayerIds&&S.vectorLayerIds.indexOf(v)===-1)&&this.fire(new i.k(new Error(`Source layer "${v}" does not exist on source "${S.id}" as specified by style layer "${s.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const s in this.tileManagers)if(!this.tileManagers[s].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(s,d=!1){const v=this._serializedAllLayers();if(!s||s.length===0)return Object.values(d?i.bU(v):v);const S=[];for(const D of s)if(v[D]){const k=d?i.bU(v[D]):v[D];S.push(k)}return S}_serializedAllLayers(){let s=this._serializedLayers;if(s)return s;s=this._serializedLayers={};const d=Object.keys(this._layers);for(const v of d){const S=this._layers[v];S.type!=="custom"&&(s[v]=S.serialize())}return s}hasTransitions(){var s,d,v;if(!((s=this.light)===null||s===void 0)&&s.hasTransition()||!((d=this.sky)===null||d===void 0)&&d.hasTransition()||!((v=this.projection)===null||v===void 0)&&v.hasTransition())return!0;for(const S in this.tileManagers)if(this.tileManagers[S].hasTransition())return!0;for(const S in this._layers)if(this._layers[S].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(s){if(!this._loaded)return;const d=this._changed;if(d){const S=Object.keys(this._updatedLayers),D=Object.keys(this._removedLayers);(S.length||D.length)&&this._updateWorkerLayers(S,D);for(const k in this._updatedSources){const j=this._updatedSources[k];if(j==="reload")this._reloadSource(k);else{if(j!=="clear")throw new Error(`Invalid action ${j}`);this._clearSource(k)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const k in this._updatedPaintProps)this._layers[k].updateTransitions(s);this.light.updateTransitions(s),this.sky.updateTransitions(s),this._resetUpdates()}const v={};for(const S in this.tileManagers){const D=this.tileManagers[S];v[S]=D.used,D.used=!1}for(const S of this._order){const D=this._layers[S];D.recalculate(s,this._availableImages),!D.isHidden(s.zoom)&&D.source&&(this.tileManagers[D.source].used=!0)}for(const S in v){const D=this.tileManagers[S];!!v[S]!=!!D.used&&D.fire(new i.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:S}))}this.light.recalculate(s),this.sky.recalculate(s),this.projection.recalculate(s),this.z=s.zoom,d&&this.fire(new i.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const s=Object.keys(this._changedImages);if(s.length){for(const d in this.tileManagers)this.tileManagers[d].reloadTilesForDependencies(["icons","patterns"],s);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const s in this.tileManagers)this.tileManagers[s].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(s,d){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(s,!1),removedIds:d})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(s,d={}){var v;this._checkLoaded();const S=this.serialize();if(s=d.transformStyle?d.transformStyle(S,s):s,((v=d.validate)===null||v===void 0||v)&&lc(this,i.C(s)))return!1;(s=i.bU(s)).layers=i.bR(s.layers);const D=i.bV(S,s),k=this._getOperationsToPerform(D);if(k.unimplemented.length>0)throw new Error(`Unimplemented: ${k.unimplemented.join(", ")}.`);if(k.operations.length===0)return!1;for(const j of k.operations)j();return this.stylesheet=s,this._serializedLayers=null,!0}_getOperationsToPerform(s){const d=[],v=[];for(const S of s)switch(S.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":d.push(()=>this.addLayer.apply(this,S.args));break;case"removeLayer":d.push(()=>this.removeLayer.apply(this,S.args));break;case"setPaintProperty":d.push(()=>this.setPaintProperty.apply(this,S.args));break;case"setLayoutProperty":d.push(()=>this.setLayoutProperty.apply(this,S.args));break;case"setFilter":d.push(()=>this.setFilter.apply(this,S.args));break;case"addSource":d.push(()=>this.addSource.apply(this,S.args));break;case"removeSource":d.push(()=>this.removeSource.apply(this,S.args));break;case"setLayerZoomRange":d.push(()=>this.setLayerZoomRange.apply(this,S.args));break;case"setLight":d.push(()=>this.setLight.apply(this,S.args));break;case"setGeoJSONSourceData":d.push(()=>this.setGeoJSONSourceData.apply(this,S.args));break;case"setGlyphs":d.push(()=>this.setGlyphs.apply(this,S.args));break;case"setSprite":d.push(()=>this.setSprite.apply(this,S.args));break;case"setTerrain":d.push(()=>this.map.setTerrain.apply(this,S.args));break;case"setSky":d.push(()=>this.setSky.apply(this,S.args));break;case"setProjection":this.setProjection.apply(this,S.args);break;case"setGlobalState":d.push(()=>this.setGlobalState.apply(this,S.args));break;case"setTransition":d.push(()=>{});break;default:v.push(S.command)}return{operations:d,unimplemented:v}}addImage(s,d){if(this.getImage(s))return this.fire(new i.k(new Error(`An image named "${s}" already exists.`)));this.imageManager.addImage(s,d),this._afterImageUpdated(s)}updateImage(s,d){this.imageManager.updateImage(s,d)}getImage(s){return this.imageManager.getImage(s)}removeImage(s){if(!this.getImage(s))return this.fire(new i.k(new Error(`An image named "${s}" does not exist.`)));this.imageManager.removeImage(s),this._afterImageUpdated(s)}_afterImageUpdated(s){this._availableImages=this.imageManager.listImages(),this._changedImages[s]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(s,d,v={}){if(this._checkLoaded(),this.tileManagers[s]!==void 0)throw new Error(`Source "${s}" already exists.`);if(!d.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(d).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(d.type)>=0&&this._validate(i.C.source,`sources.${s}`,d,null,v))return;this.map&&this.map._collectResourceTiming&&(d.collectResourceTiming=!0);const S=this.tileManagers[s]=new _n(s,d,this.dispatcher);S.style=this,S.setEventedParent(this,()=>({isSourceLoaded:S.loaded(),source:S.serialize(),sourceId:s})),S.onAdd(this.map),this._changed=!0}removeSource(s){if(this._checkLoaded(),this.tileManagers[s]===void 0)throw new Error("There is no source with this ID");for(const v in this._layers)if(this._layers[v].source===s)return this.fire(new i.k(new Error(`Source "${s}" cannot be removed while layer "${v}" is using it.`)));const d=this.tileManagers[s];delete this.tileManagers[s],delete this._updatedSources[s],d.fire(new i.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:s})),d.setEventedParent(null),d.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(s,d){if(this._checkLoaded(),this.tileManagers[s]===void 0)throw new Error(`There is no source with this ID=${s}`);const v=this.tileManagers[s].getSource();if(v.type!=="geojson")throw new Error(`geojsonSource.type is ${v.type}, which is !== 'geojson`);v.setData(d),this._changed=!0}getSource(s){return this.tileManagers[s]&&this.tileManagers[s].getSource()}addLayer(s,d,v={}){this._checkLoaded();const S=s.id;if(this.getLayer(S))return void this.fire(new i.k(new Error(`Layer "${S}" already exists on this map.`)));let D;if(s.type==="custom"){if(lc(this,i.bW(s)))return;D=i.bS(s,this._globalState)}else{if("source"in s&&typeof s.source=="object"&&(this.addSource(S,s.source),s=i.bU(s),s=i.e(s,{source:S})),this._validate(i.C.layer,`layers.${S}`,s,{arrayIndex:-1},v))return;D=i.bS(s,this._globalState),this._validateLayer(D),D.setEventedParent(this,{layer:{id:S}})}const k=d?this._order.indexOf(d):this._order.length;if(d&&k===-1)this.fire(new i.k(new Error(`Cannot add layer "${S}" before non-existing layer "${d}".`)));else{if(this._order.splice(k,0,S),this._layerOrderChanged=!0,this._layers[S]=D,this._removedLayers[S]&&D.source&&D.type!=="custom"){const j=this._removedLayers[S];delete this._removedLayers[S],j.type!==D.type?this._updatedSources[D.source]="clear":(this._updatedSources[D.source]="reload",this.tileManagers[D.source].pause())}this._updateLayer(D),D.onAdd&&D.onAdd(this.map)}}moveLayer(s,d){if(this._checkLoaded(),this._changed=!0,!this._layers[s])return void this.fire(new i.k(new Error(`The layer '${s}' does not exist in the map's style and cannot be moved.`)));if(s===d)return;const v=this._order.indexOf(s);this._order.splice(v,1);const S=d?this._order.indexOf(d):this._order.length;d&&S===-1?this.fire(new i.k(new Error(`Cannot move layer "${s}" before non-existing layer "${d}".`))):(this._order.splice(S,0,s),this._layerOrderChanged=!0)}removeLayer(s){this._checkLoaded();const d=this._layers[s];if(!d)return void this.fire(new i.k(new Error(`Cannot remove non-existing layer "${s}".`)));d.setEventedParent(null);const v=this._order.indexOf(s);this._order.splice(v,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[s]=d,delete this._layers[s],this._serializedLayers&&delete this._serializedLayers[s],delete this._updatedLayers[s],delete this._updatedPaintProps[s],d.onRemove&&d.onRemove(this.map)}getLayer(s){return this._layers[s]}getLayersOrder(){return[...this._order]}hasLayer(s){return s in this._layers}setLayerZoomRange(s,d,v){this._checkLoaded();const S=this.getLayer(s);S?S.minzoom===d&&S.maxzoom===v||(d!=null&&(S.minzoom=d),v!=null&&(S.maxzoom=v),this._updateLayer(S)):this.fire(new i.k(new Error(`Cannot set the zoom range of non-existing layer "${s}".`)))}setFilter(s,d,v={}){this._checkLoaded();const S=this.getLayer(s);if(S){if(!i.bQ(S.filter,d))return d==null?(S.setFilter(void 0),void this._updateLayer(S)):void(this._validate(i.C.filter,`layers.${S.id}.filter`,d,null,v)||(S.setFilter(i.bU(d)),this._updateLayer(S)))}else this.fire(new i.k(new Error(`Cannot filter non-existing layer "${s}".`)))}getFilter(s){return i.bU(this.getLayer(s).filter)}setLayoutProperty(s,d,v,S={}){this._checkLoaded();const D=this.getLayer(s);D?i.bQ(D.getLayoutProperty(d),v)||(D.setLayoutProperty(d,v,S),this._updateLayer(D)):this.fire(new i.k(new Error(`Cannot style non-existing layer "${s}".`)))}getLayoutProperty(s,d){const v=this.getLayer(s);if(v)return v.getLayoutProperty(d);this.fire(new i.k(new Error(`Cannot get style of non-existing layer "${s}".`)))}setPaintProperty(s,d,v,S={}){this._checkLoaded();const D=this.getLayer(s);D?i.bQ(D.getPaintProperty(d),v)||this._updatePaintProperty(D,d,v,S):this.fire(new i.k(new Error(`Cannot style non-existing layer "${s}".`)))}_updatePaintProperty(s,d,v,S={}){s.setPaintProperty(d,v,S)&&this._updateLayer(s),i.bT(s)&&d==="raster-fade-duration"&&this.tileManagers[s.source].setRasterFadeDuration(v),this._changed=!0,this._updatedPaintProps[s.id]=!0,this._serializedLayers=null}getPaintProperty(s,d){return this.getLayer(s).getPaintProperty(d)}setFeatureState(s,d){this._checkLoaded();const v=s.source,S=s.sourceLayer,D=this.tileManagers[v];if(D===void 0)return void this.fire(new i.k(new Error(`The source '${v}' does not exist in the map's style.`)));const k=D.getSource().type;k==="geojson"&&S?this.fire(new i.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):k!=="vector"||S?(s.id===void 0&&this.fire(new i.k(new Error("The feature id parameter must be provided."))),D.setFeatureState(S,s.id,d)):this.fire(new i.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(s,d){this._checkLoaded();const v=s.source,S=this.tileManagers[v];if(S===void 0)return void this.fire(new i.k(new Error(`The source '${v}' does not exist in the map's style.`)));const D=S.getSource().type,k=D==="vector"?s.sourceLayer:void 0;D!=="vector"||k?d&&typeof s.id!="string"&&typeof s.id!="number"?this.fire(new i.k(new Error("A feature id is required to remove its specific state property."))):S.removeFeatureState(k,s.id,d):this.fire(new i.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(s){this._checkLoaded();const d=s.source,v=s.sourceLayer,S=this.tileManagers[d];if(S!==void 0)return S.getSource().type!=="vector"||v?(s.id===void 0&&this.fire(new i.k(new Error("The feature id parameter must be provided."))),S.getFeatureState(v,s.id)):void this.fire(new i.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new i.k(new Error(`The source '${d}' does not exist in the map's style.`)))}getTransition(){return i.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const s=i.bX(this.tileManagers,D=>D.serialize()),d=this._serializeByIds(this._order,!0),v=this.map.getTerrain()||void 0,S=this.stylesheet;return i.bY({version:S.version,name:S.name,metadata:S.metadata,light:S.light,sky:S.sky,center:S.center,zoom:S.zoom,bearing:S.bearing,pitch:S.pitch,sprite:S.sprite,glyphs:S.glyphs,transition:S.transition,projection:S.projection,sources:s,layers:d,terrain:v},D=>D!==void 0)}_updateLayer(s){this._updatedLayers[s.id]=!0,s.source&&!this._updatedSources[s.source]&&this.tileManagers[s.source].getSource().type!=="raster"&&(this._updatedSources[s.source]="reload",this.tileManagers[s.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(s){const d=k=>this._layers[k].type==="fill-extrusion",v={},S=[];for(let k=this._order.length-1;k>=0;k--){const j=this._order[k];if(d(j)){v[j]=k;for(const H of s){const J=H[j];if(J)for(const et of J)S.push(et)}}}S.sort((k,j)=>j.intersectionZ-k.intersectionZ);const D=[];for(let k=this._order.length-1;k>=0;k--){const j=this._order[k];if(d(j))for(let H=S.length-1;H>=0;H--){const J=S[H].feature;if(v[J.layer.id]<k)break;D.push(J),S.pop()}else for(const H of s){const J=H[j];if(J)for(const et of J)D.push(et.feature)}}return D}queryRenderedFeatures(s,d,v){d&&d.filter&&this._validate(i.C.filter,"queryRenderedFeatures.filter",d.filter,null,d);const S={};if(d&&d.layers){if(!(Array.isArray(d.layers)||d.layers instanceof Set))return this.fire(new i.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const J of d.layers){const et=this._layers[J];if(!et)return this.fire(new i.k(new Error(`The layer '${J}' does not exist in the map's style and cannot be queried for features.`))),[];S[et.source]=!0}}const D=[];d.availableImages=this._availableImages;const k=this._serializedAllLayers(),j=d.layers instanceof Set?d.layers:Array.isArray(d.layers)?new Set(d.layers):null,H=Object.assign(Object.assign({},d),{layers:j,globalState:this._globalState});for(const J in this.tileManagers)d.layers&&!S[J]||D.push(Kn(this.tileManagers[J],this._layers,k,s,H,v,this.map.terrain?(et,mt,ut)=>this.map.terrain.getElevation(et,mt,ut):void 0));return this.placement&&D.push(function(J,et,mt,ut,St,pt,Et){const Kt={},Xt=pt.queryRenderedSymbols(ut),ft=[];for(const _e of Object.keys(Xt).map(Number))ft.push(Et[_e]);ft.sort(vo);for(const _e of ft){const ce=_e.featureIndex.lookupSymbolFeatures(Xt[_e.bucketInstanceId],et,_e.bucketIndex,_e.sourceLayerIndex,{filterSpec:St.filter,globalState:St.globalState},St.layers,St.availableImages,J);for(const me in ce){const be=Kt[me]=Kt[me]||[],de=ce[me];de.sort((De,Qe)=>{const Xe=_e.featureSortOrder;if(Xe){const Je=Xe.indexOf(De.featureIndex);return Xe.indexOf(Qe.featureIndex)-Je}return Qe.featureIndex-De.featureIndex});for(const De of de)be.push(De)}}return function(_e,ce,me){for(const be in _e)for(const de of _e[be])ns(de,me[ce[be].source]);return _e}(Kt,J,mt)}(this._layers,k,this.tileManagers,s,H,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(D)}querySourceFeatures(s,d){d?.filter&&this._validate(i.C.filter,"querySourceFeatures.filter",d.filter,null,d);const v=this.tileManagers[s];return v?function(S,D){const k=S.getRenderableIds().map(J=>S.getTileByID(J)),j=[],H={};for(let J=0;J<k.length;J++){const et=k[J],mt=et.tileID.canonical.key;H[mt]||(H[mt]=!0,et.querySourceFeatures(j,D))}return j}(v,d?Object.assign(Object.assign({},d),{globalState:this._globalState}):{globalState:this._globalState}):[]}getLight(){return this.light.getLight()}setLight(s,d={}){this._checkLoaded();const v=this.light.getLight();let S=!1;for(const k in s)if(!i.bQ(s[k],v[k])){S=!0;break}if(!S)return;const D={now:Ri(),transition:i.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(s,d),this.light.updateTransitions(D)}getProjection(){var s;return(s=this.stylesheet)===null||s===void 0?void 0:s.projection}setProjection(s){if(this._checkLoaded(),this.projection){if(this.projection.name===s.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=s,this._setProjectionInternal(s.type)}getSky(){var s;return(s=this.stylesheet)===null||s===void 0?void 0:s.sky}setSky(s,d={}){this._checkLoaded();const v=this.getSky();let S=!1;if(!s&&!v)return;if(s&&!v)S=!0;else if(!s&&v)S=!0;else for(const k in s)if(!i.bQ(s[k],v[k])){S=!0;break}if(!S)return;const D={now:Ri(),transition:i.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=s,this.sky.setSky(s,d),this.sky.updateTransitions(D)}_setProjectionInternal(s){const d=function(v,S){const D={constrainOverride:S};if(Array.isArray(v)){const k=new Ih({type:v});return{projection:k,transform:new en(D),cameraHelper:new Ac(k)}}switch(v){case"mercator":return{projection:new Ls,transform:new pr(D),cameraHelper:new Ca};case"globe":{const k=new Ih({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:k,transform:new en(D),cameraHelper:new Ac(k)}}case"vertical-perspective":return{projection:new Ml,transform:new Jc(D),cameraHelper:new oa};default:return i.w(`Unknown projection name: ${v}. Falling back to mercator projection.`),{projection:new Ls,transform:new pr(D),cameraHelper:new Ca}}}(s,this.map.transformConstrain);this.projection=d.projection,this.map.migrateProjection(d.transform,d.cameraHelper);for(const v in this.tileManagers)this.tileManagers[v].reload()}_validate(s,d,v,S,D={}){return(!D||D.validate!==!1)&&lc(this,s.call(i.C,i.e({key:d,style:this.serialize(),value:v,styleSpec:i.u},S)))}_remove(s=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Aa().off(rl,this._rtlPluginLoaded);for(const d in this._layers)this._layers[d].setEventedParent(null);for(const d in this.tileManagers){const v=this.tileManagers[d];v.setEventedParent(null),v.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),s&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(s)}_clearSource(s){this.tileManagers[s].clearTiles()}_reloadSource(s){this.tileManagers[s].resume(),this.tileManagers[s].reload()}_updateSources(s){for(const d in this.tileManagers)this.tileManagers[d].update(s,this.map.terrain)}_generateCollisionBoxes(){for(const s in this.tileManagers)this._reloadSource(s)}_updatePlacement(s,d,v,S,D=!1){let k=!1,j=!1;const H={};for(const J of this._order){const et=this._layers[J];if(et.type!=="symbol")continue;if(!H[et.source]){const ut=this.tileManagers[et.source];H[et.source]=ut.getRenderableIds(!0).map(St=>ut.getTileByID(St)).sort((St,pt)=>pt.tileID.overscaledZ-St.tileID.overscaledZ||(St.tileID.isLessThan(pt.tileID)?-1:1))}const mt=this.crossTileSymbolIndex.addLayer(et,H[et.source],s.center.lng);k=k||mt}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((D=D||this._layerOrderChanged||v===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(Ri(),s.zoom))&&(this.pauseablePlacement=new Ou(s,this.map.terrain,this._order,D,d,v,S,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,H),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(Ri()),j=!0),k&&this.pauseablePlacement.placement.setStale()),j||k)for(const J of this._order){const et=this._layers[J];et.type==="symbol"&&this.placement.updateLayerOpacities(et,H[et.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(Ri())}_releaseSymbolFadeTiles(){for(const s in this.tileManagers)this.tileManagers[s].releaseSymbolFadeTiles()}getImages(s,d){return i._(this,void 0,void 0,function*(){const v=yield this.imageManager.getImages(d.icons);this._updateTilesForChangedImages();const S=this.tileManagers[d.source];return S&&S.setDependencies(d.tileID.key,d.type,d.icons),v})}getGlyphs(s,d){return i._(this,void 0,void 0,function*(){const v=yield this.glyphManager.getGlyphs(d.stacks),S=this.tileManagers[d.source];return S&&S.setDependencies(d.tileID.key,d.type,[""]),v})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(s,d={}){this._checkLoaded(),s&&this._validate(i.C.glyphs,"glyphs",s,null,d)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=s,this.glyphManager.entries={},this.glyphManager.setURL(s))}getDashes(s,d){return i._(this,void 0,void 0,function*(){const v={};for(const[S,D]of Object.entries(d.dashes))v[S]=this.lineAtlas.getDash(D.dasharray,D.round);return v})}addSprite(s,d,v={},S){this._checkLoaded();const D=[{id:s,url:d}],k=[...fa(this.stylesheet.sprite),...D];this._validate(i.C.sprite,"sprite",k,null,v)||(this.stylesheet.sprite=k,this._loadSprite(D,!0,S))}removeSprite(s){this._checkLoaded();const d=fa(this.stylesheet.sprite);if(d.find(v=>v.id===s)){if(this._spritesImagesIds[s])for(const v of this._spritesImagesIds[s])this.imageManager.removeImage(v),this._changedImages[v]=!0;d.splice(d.findIndex(v=>v.id===s),1),this.stylesheet.sprite=d.length>0?d:void 0,delete this._spritesImagesIds[s],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"}))}else this.fire(new i.k(new Error(`Sprite "${s}" doesn't exists on this map.`)))}getSprite(){return fa(this.stylesheet.sprite)}setSprite(s,d={},v){this._checkLoaded(),s&&this._validate(i.C.sprite,"sprite",s,null,d)||(this.stylesheet.sprite=s,s?this._loadSprite(s,!0,v):(this._unloadSprite(),v&&v(null)))}destroy(){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null);for(const s in this.tileManagers){const d=this.tileManagers[s];if(d.setEventedParent(null),d._tiles){for(const v in d._tiles)d._tiles[v].unloadVectorData();d._tiles={}}d._cache.reset(),d.onRemove(this.map)}this.tileManagers={},this.imageManager&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this._availableImages=[],this._spritesImagesIds={}),this.glyphManager&&this.glyphManager.destroy();for(const s in this._layers){const d=this._layers[s];d.setEventedParent(null),d.onRemove&&d.onRemove(this.map)}this._setInitialValues(),this.setEventedParent(null),this.dispatcher.unregisterMessageHandler("GG"),this.dispatcher.unregisterMessageHandler("GI"),this.dispatcher.unregisterMessageHandler("GDA"),this.dispatcher.remove(!0),this._listeners={},this._oneTimeListeners={}}}var Pc=i.aT([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Ed{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(s,d,v,S,D,k,j,H,J){this.context=s;let et=this.boundPaintVertexBuffers.length!==S.length;for(let mt=0;!et&&mt<S.length;mt++)this.boundPaintVertexBuffers[mt]!==S[mt]&&(et=!0);!this.vao||this.boundProgram!==d||this.boundLayoutVertexBuffer!==v||et||this.boundIndexBuffer!==D||this.boundVertexOffset!==k||this.boundDynamicVertexBuffer!==j||this.boundDynamicVertexBuffer2!==H||this.boundDynamicVertexBuffer3!==J?this.freshBind(d,v,S,D,k,j,H,J):(s.bindVertexArray.set(this.vao),j&&j.bind(),D&&D.dynamicDraw&&D.bind(),H&&H.bind(),J&&J.bind())}freshBind(s,d,v,S,D,k,j,H){const J=s.numAttributes,et=this.context,mt=et.gl;this.vao&&this.destroy(),this.vao=et.createVertexArray(),et.bindVertexArray.set(this.vao),this.boundProgram=s,this.boundLayoutVertexBuffer=d,this.boundPaintVertexBuffers=v,this.boundIndexBuffer=S,this.boundVertexOffset=D,this.boundDynamicVertexBuffer=k,this.boundDynamicVertexBuffer2=j,this.boundDynamicVertexBuffer3=H,d.enableAttributes(mt,s);for(const ut of v)ut.enableAttributes(mt,s);k&&k.enableAttributes(mt,s),j&&j.enableAttributes(mt,s),H&&H.enableAttributes(mt,s),d.bind(),d.setVertexAttribPointers(mt,s,D);for(const ut of v)ut.bind(),ut.setVertexAttribPointers(mt,s,D);k&&(k.bind(),k.setVertexAttribPointers(mt,s,D)),S&&S.bind(),j&&(j.bind(),j.setVertexAttribPointers(mt,s,D)),H&&(H.bind(),H.setVertexAttribPointers(mt,s,D)),et.currentNumAttributes=J}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Ad=(C,s,d,v,S)=>({u_texture:0,u_ele_delta:C,u_fog_matrix:s,u_fog_color:d?d.properties.get("fog-color"):i.bo.white,u_fog_ground_blend:d?d.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:S?0:d?d.calculateFogBlendOpacity(v):0,u_horizon_color:d?d.properties.get("horizon-color"):i.bo.white,u_horizon_fog_blend:d?d.properties.get("horizon-fog-blend"):1,u_is_globe_mode:S?1:0}),Kc={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function cc(C){const s=[];for(let d=0;d<C.length;d++){if(C[d]===null)continue;const v=C[d].split(" ");s.push(v.pop())}return s}class lf{constructor(s,d,v,S,D,k,j,H,J=[]){const et=s.gl;this.program=et.createProgram();const mt=cc(d.staticAttributes),ut=v?v.getBinderAttributes():[],St=mt.concat(ut),pt=ea.prelude.staticUniforms?cc(ea.prelude.staticUniforms):[],Et=j.staticUniforms?cc(j.staticUniforms):[],Kt=d.staticUniforms?cc(d.staticUniforms):[],Xt=v?v.getBinderUniforms():[],ft=pt.concat(Et).concat(Kt).concat(Xt),_e=[];for(const Xe of ft)_e.indexOf(Xe)<0&&_e.push(Xe);const ce=v?v.defines():[];qa(et)&&ce.unshift("#version 300 es"),D&&ce.push("#define OVERDRAW_INSPECTOR;"),k&&ce.push("#define TERRAIN3D;"),H&&ce.push(H),J&&ce.push(...J);let me=ce.concat(ea.prelude.fragmentSource,j.fragmentSource,d.fragmentSource).join(`
`),be=ce.concat(ea.prelude.vertexSource,j.vertexSource,d.vertexSource).join(`
`);qa(et)||(me=function(Xe){return Xe.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")}(me),be=function(Xe){return Xe.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")}(be));const de=et.createShader(et.FRAGMENT_SHADER);if(et.isContextLost())return void(this.failedToCreate=!0);if(et.shaderSource(de,me),et.compileShader(de),!et.getShaderParameter(de,et.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${et.getShaderInfoLog(de)}`);et.attachShader(this.program,de);const De=et.createShader(et.VERTEX_SHADER);if(et.isContextLost())return void(this.failedToCreate=!0);if(et.shaderSource(De,be),et.compileShader(De),!et.getShaderParameter(De,et.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${et.getShaderInfoLog(De)}`);et.attachShader(this.program,De),this.attributes={};const Qe={};this.numAttributes=St.length;for(let Xe=0;Xe<this.numAttributes;Xe++)St[Xe]&&(et.bindAttribLocation(this.program,Xe,St[Xe]),this.attributes[St[Xe]]=Xe);if(et.linkProgram(this.program),!et.getProgramParameter(this.program,et.LINK_STATUS))throw new Error(`Program failed to link: ${et.getProgramInfoLog(this.program)}`);et.deleteShader(De),et.deleteShader(de);for(let Xe=0;Xe<_e.length;Xe++){const Je=_e[Xe];if(Je&&!Qe[Je]){const ii=et.getUniformLocation(this.program,Je);ii&&(Qe[Je]=ii)}}this.fixedUniforms=S(s,Qe),this.terrainUniforms=((Xe,Je)=>({u_depth:new i.bZ(Xe,Je.u_depth),u_terrain:new i.bZ(Xe,Je.u_terrain),u_terrain_dim:new i.bp(Xe,Je.u_terrain_dim),u_terrain_matrix:new i.b$(Xe,Je.u_terrain_matrix),u_terrain_unpack:new i.c0(Xe,Je.u_terrain_unpack),u_terrain_exaggeration:new i.bp(Xe,Je.u_terrain_exaggeration)}))(s,Qe),this.projectionUniforms=((Xe,Je)=>({u_projection_matrix:new i.b$(Xe,Je.u_projection_matrix),u_projection_tile_mercator_coords:new i.c0(Xe,Je.u_projection_tile_mercator_coords),u_projection_clipping_plane:new i.c0(Xe,Je.u_projection_clipping_plane),u_projection_transition:new i.bp(Xe,Je.u_projection_transition),u_projection_fallback_matrix:new i.b$(Xe,Je.u_projection_fallback_matrix)}))(s,Qe),this.binderUniforms=v?v.getUniforms(s,Qe):[]}draw(s,d,v,S,D,k,j,H,J,et,mt,ut,St,pt,Et,Kt,Xt,ft,_e){const ce=s.gl;if(this.failedToCreate)return;if(s.program.set(this.program),s.setDepthMode(v),s.setStencilMode(S),s.setColorMode(D),s.setCullFace(k),H){s.activeTexture.set(ce.TEXTURE2),ce.bindTexture(ce.TEXTURE_2D,H.depthTexture),s.activeTexture.set(ce.TEXTURE3),ce.bindTexture(ce.TEXTURE_2D,H.texture);for(const be in this.terrainUniforms)this.terrainUniforms[be].set(H[be])}if(J)for(const be in J)this.projectionUniforms[Kc[be]].set(J[be]);if(j)for(const be in this.fixedUniforms)this.fixedUniforms[be].set(j[be]);Kt&&Kt.setUniforms(s,this.binderUniforms,pt,{zoom:Et});let me=0;switch(d){case ce.LINES:me=2;break;case ce.TRIANGLES:me=3;break;case ce.LINE_STRIP:me=1}for(const be of St.get()){const de=be.vaos||(be.vaos={});(de[et]||(de[et]=new Ed)).bind(s,this,mt,Kt?Kt.getPaintVertexBuffers():[],ut,be.vertexOffset,Xt,ft,_e),ce.drawElements(d,be.primitiveLength*me,ce.UNSIGNED_SHORT,be.primitiveOffset*me*2)}}}function Qc(C,s,d){const v=1/i.aM(d,1,s.transform.tileZoom),S=Math.pow(2,d.tileID.overscaledZ),D=d.tileSize*Math.pow(2,s.transform.tileZoom)/S,k=D*(d.tileID.canonical.x+d.tileID.wrap*S),j=D*d.tileID.canonical.y;return{u_image:0,u_texsize:d.imageAtlasTexture.size,u_scale:[v,C.fromScale,C.toScale],u_fade:C.t,u_pixel_coord_upper:[k>>16,j>>16],u_pixel_coord_lower:[65535&k,65535&j]}}const fs=(C,s,d,v)=>{const S=C.style.light,D=S.properties.get("position"),k=[D.x,D.y,D.z],j=i.c3();S.properties.get("anchor")==="viewport"&&i.c4(j,C.transform.bearingInRadians),i.c5(k,k,j);const H=C.transform.transformLightDirection(k),J=S.properties.get("color");return{u_lightpos:k,u_lightpos_globe:H,u_lightintensity:S.properties.get("intensity"),u_lightcolor:[J.r,J.g,J.b],u_vertical_gradient:+s,u_opacity:d,u_fill_translate:v}},cl=(C,s,d,v,S,D,k)=>i.e(fs(C,s,d,v),Qc(D,C,k),{u_height_factor:-Math.pow(2,S.overscaledZ)/k.tileSize/8}),za=(C,s,d,v)=>i.e(Qc(s,C,d),{u_fill_translate:v}),Pd=(C,s)=>({u_world:C,u_fill_translate:s}),Gu=(C,s,d,v,S)=>i.e(za(C,s,d,S),{u_world:v}),ls=(C,s,d,v,S)=>{const D=C.transform;let k,j,H=0;if(d.paint.get("circle-pitch-alignment")==="map"){const J=i.aM(s,1,D.zoom);k=!0,j=[J,J],H=J/(i.a4*Math.pow(2,s.tileID.overscaledZ))*2*Math.PI*S}else k=!1,j=D.pixelsToGLUnits;return{u_camera_to_center_distance:D.cameraToCenterDistance,u_scale_with_map:+(d.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+k,u_device_pixel_ratio:C.pixelRatio,u_extrude_scale:j,u_globe_extrude_scale:H,u_translate:v}},Wl=C=>({u_pixel_extrude_scale:[1/C.width,1/C.height]}),Mc=C=>({u_viewport_size:[C.width,C.height]}),Ao=(C,s=1)=>({u_color:C,u_overlay:0,u_overlay_scale:s}),yr=(C,s,d,v)=>{const S=i.aM(C,1,s)/(i.a4*Math.pow(2,C.tileID.overscaledZ))*2*Math.PI*v;return{u_extrude_scale:i.aM(C,1,s),u_intensity:d,u_globe_extrude_scale:S}},zi=(C,s,d,v)=>{const S=i.N();i.c6(S,0,C.width,C.height,0,0,1);const D=C.context.gl;return{u_matrix:S,u_world:[D.drawingBufferWidth,D.drawingBufferHeight],u_image:d,u_color_ramp:v,u_opacity:s.paint.get("heatmap-opacity")}},Dl=(C,s,d)=>{const v=d.paint.get("hillshade-accent-color");let S;switch(d.paint.get("hillshade-method")){case"basic":S=4;break;case"combined":S=1;break;case"igor":S=2;break;case"multidirectional":S=3;break;default:S=0}const D=d.getIlluminationProperties();for(let k=0;k<D.directionRadians.length;k++)d.paint.get("hillshade-illumination-anchor")==="viewport"&&(D.directionRadians[k]+=C.transform.bearingInRadians);return{u_image:0,u_latrange:lu(0,s.tileID),u_exaggeration:d.paint.get("hillshade-exaggeration"),u_altitudes:D.altitudeRadians,u_azimuths:D.directionRadians,u_accent:v,u_method:S,u_highlights:D.highlightColor,u_shadows:D.shadowColor}},sr=(C,s)=>{const d=s.stride,v=i.N();return i.c6(v,0,i.a4,-i.a4,0,0,1),i.O(v,v,[0,-i.a4,0]),{u_matrix:v,u_image:1,u_dimension:[d,d],u_zoom:C.overscaledZ,u_unpack:s.getUnpackVector()}};function lu(C,s){const d=Math.pow(2,s.canonical.z),v=s.canonical.y;return[new i.aa(0,v/d).toLngLat().lat,new i.aa(0,(v+1)/d).toLngLat().lat]}const Eh=(C,s,d=0)=>({u_image:0,u_unpack:s.getUnpackVector(),u_dimension:[s.stride,s.stride],u_elevation_stops:1,u_color_stops:4,u_color_ramp_size:d,u_opacity:C.paint.get("color-relief-opacity")}),Qi=(C,s,d,v)=>{const S=C.transform;return{u_translation:ms(C,s,d),u_ratio:v/i.aM(s,1,S.zoom),u_device_pixel_ratio:C.pixelRatio,u_units_to_pixels:[1/S.pixelsToGLUnits[0],1/S.pixelsToGLUnits[1]]}},th=(C,s,d,v,S)=>i.e(Qi(C,s,d,v),{u_image:0,u_image_height:S}),dp=(C,s,d,v,S)=>{const D=C.transform,k=cu(s,D);return{u_translation:ms(C,s,d),u_texsize:s.imageAtlasTexture.size,u_ratio:v/i.aM(s,1,D.zoom),u_device_pixel_ratio:C.pixelRatio,u_image:0,u_scale:[k,S.fromScale,S.toScale],u_fade:S.t,u_units_to_pixels:[1/D.pixelsToGLUnits[0],1/D.pixelsToGLUnits[1]]}},Nf=(C,s,d,v,S)=>{const D=cu(s,C.transform);return i.e(Qi(C,s,d,v),{u_tileratio:D,u_crossfade_from:S.fromScale,u_crossfade_to:S.toScale,u_image:0,u_mix:S.t,u_lineatlas_width:C.lineAtlas.width,u_lineatlas_height:C.lineAtlas.height})},hc=(C,s,d,v,S,D)=>{const k=cu(s,C.transform);return i.e(Qi(C,s,d,v),{u_image:0,u_image_height:D,u_tileratio:k,u_crossfade_from:S.fromScale,u_crossfade_to:S.toScale,u_image_dash:1,u_mix:S.t,u_lineatlas_width:C.lineAtlas.width,u_lineatlas_height:C.lineAtlas.height})};function cu(C,s){return 1/i.aM(C,1,s.tileZoom)}function ms(C,s,d){return i.aN(C.transform,s,d.paint.get("line-translate"),d.paint.get("line-translate-anchor"))}const $s=(C,s,d,v,S)=>{return{u_tl_parent:C,u_scale_parent:s,u_buffer_scale:1,u_fade_t:d.mix,u_opacity:d.opacity*v.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:v.paint.get("raster-brightness-min"),u_brightness_high:v.paint.get("raster-brightness-max"),u_saturation_factor:(k=v.paint.get("raster-saturation"),k>0?1-1/(1.001-k):-k),u_contrast_factor:(D=v.paint.get("raster-contrast"),D>0?1/(1-D):1+D),u_spin_weights:Ah(v.paint.get("raster-hue-rotate")),u_coords_top:[S[0].x,S[0].y,S[1].x,S[1].y],u_coords_bottom:[S[3].x,S[3].y,S[2].x,S[2].y]};var D,k};function Ah(C){C*=Math.PI/180;const s=Math.sin(C),d=Math.cos(C);return[(2*d+1)/3,(-Math.sqrt(3)*s-d+1)/3,(Math.sqrt(3)*s-d+1)/3]}const Cc=(C,s,d,v,S,D,k,j,H,J,et,mt,ut)=>{const St=k.transform;return{u_is_size_zoom_constant:+(C==="constant"||C==="source"),u_is_size_feature_constant:+(C==="constant"||C==="camera"),u_size_t:s?s.uSizeT:0,u_size:s?s.uSize:0,u_camera_to_center_distance:St.cameraToCenterDistance,u_pitch:St.pitch/360*2*Math.PI,u_rotate_symbol:+d,u_aspect_ratio:St.width/St.height,u_fade_change:k.options.fadeDuration?k.symbolFadeChange:1,u_label_plane_matrix:j,u_coord_matrix:H,u_is_text:+et,u_pitch_with_map:+v,u_is_along_line:S,u_is_variable_anchor:D,u_texsize:mt,u_texture:0,u_translation:J,u_pitched_scale:ut}},sa=(C,s,d,v,S,D,k,j,H,J,et,mt,ut,St)=>{const pt=k.transform;return i.e(Cc(C,s,d,v,S,D,k,j,H,J,et,mt,St),{u_gamma_scale:v?Math.cos(pt.pitch*Math.PI/180)*pt.cameraToCenterDistance:1,u_device_pixel_ratio:k.pixelRatio,u_is_halo:1})},gs=(C,s,d,v,S,D,k,j,H,J,et,mt,ut)=>i.e(sa(C,s,d,v,S,D,k,j,H,J,!0,et,0,ut),{u_texsize_icon:mt,u_texture_icon:1}),cf=(C,s)=>({u_opacity:C,u_color:s}),hf=(C,s,d,v,S)=>i.e(function(D,k,j,H){const J=j.imageManager.getPattern(D.from.toString()),et=j.imageManager.getPattern(D.to.toString()),{width:mt,height:ut}=j.imageManager.getPixelSize(),St=Math.pow(2,H.tileID.overscaledZ),pt=H.tileSize*Math.pow(2,j.transform.tileZoom)/St,Et=pt*(H.tileID.canonical.x+H.tileID.wrap*St),Kt=pt*H.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:J.tl,u_pattern_br_a:J.br,u_pattern_tl_b:et.tl,u_pattern_br_b:et.br,u_texsize:[mt,ut],u_mix:k.t,u_pattern_size_a:J.displaySize,u_pattern_size_b:et.displaySize,u_scale_a:k.fromScale,u_scale_b:k.toScale,u_tile_units_to_pixels:1/i.aM(H,1,j.transform.tileZoom),u_pixel_coord_upper:[Et>>16,Kt>>16],u_pixel_coord_lower:[65535&Et,65535&Kt]}}(d,S,s,v),{u_opacity:C}),hu=(C,s)=>{},Dc={fillExtrusion:(C,s)=>({u_lightpos:new i.c1(C,s.u_lightpos),u_lightpos_globe:new i.c1(C,s.u_lightpos_globe),u_lightintensity:new i.bp(C,s.u_lightintensity),u_lightcolor:new i.c1(C,s.u_lightcolor),u_vertical_gradient:new i.bp(C,s.u_vertical_gradient),u_opacity:new i.bp(C,s.u_opacity),u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillExtrusionPattern:(C,s)=>({u_lightpos:new i.c1(C,s.u_lightpos),u_lightpos_globe:new i.c1(C,s.u_lightpos_globe),u_lightintensity:new i.bp(C,s.u_lightintensity),u_lightcolor:new i.c1(C,s.u_lightcolor),u_vertical_gradient:new i.bp(C,s.u_vertical_gradient),u_height_factor:new i.bp(C,s.u_height_factor),u_opacity:new i.bp(C,s.u_opacity),u_fill_translate:new i.c2(C,s.u_fill_translate),u_image:new i.bZ(C,s.u_image),u_texsize:new i.c2(C,s.u_texsize),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade)}),fill:(C,s)=>({u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillPattern:(C,s)=>({u_image:new i.bZ(C,s.u_image),u_texsize:new i.c2(C,s.u_texsize),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade),u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillOutline:(C,s)=>({u_world:new i.c2(C,s.u_world),u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillOutlinePattern:(C,s)=>({u_world:new i.c2(C,s.u_world),u_image:new i.bZ(C,s.u_image),u_texsize:new i.c2(C,s.u_texsize),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade),u_fill_translate:new i.c2(C,s.u_fill_translate)}),circle:(C,s)=>({u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_scale_with_map:new i.bZ(C,s.u_scale_with_map),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_extrude_scale:new i.c2(C,s.u_extrude_scale),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_globe_extrude_scale:new i.bp(C,s.u_globe_extrude_scale),u_translate:new i.c2(C,s.u_translate)}),collisionBox:(C,s)=>({u_pixel_extrude_scale:new i.c2(C,s.u_pixel_extrude_scale)}),collisionCircle:(C,s)=>({u_viewport_size:new i.c2(C,s.u_viewport_size)}),debug:(C,s)=>({u_color:new i.b_(C,s.u_color),u_overlay:new i.bZ(C,s.u_overlay),u_overlay_scale:new i.bp(C,s.u_overlay_scale)}),depth:hu,clippingMask:hu,heatmap:(C,s)=>({u_extrude_scale:new i.bp(C,s.u_extrude_scale),u_intensity:new i.bp(C,s.u_intensity),u_globe_extrude_scale:new i.bp(C,s.u_globe_extrude_scale)}),heatmapTexture:(C,s)=>({u_matrix:new i.b$(C,s.u_matrix),u_world:new i.c2(C,s.u_world),u_image:new i.bZ(C,s.u_image),u_color_ramp:new i.bZ(C,s.u_color_ramp),u_opacity:new i.bp(C,s.u_opacity)}),hillshade:(C,s)=>({u_image:new i.bZ(C,s.u_image),u_latrange:new i.c2(C,s.u_latrange),u_exaggeration:new i.bp(C,s.u_exaggeration),u_altitudes:new i.c8(C,s.u_altitudes),u_azimuths:new i.c8(C,s.u_azimuths),u_accent:new i.b_(C,s.u_accent),u_method:new i.bZ(C,s.u_method),u_shadows:new i.c7(C,s.u_shadows),u_highlights:new i.c7(C,s.u_highlights)}),hillshadePrepare:(C,s)=>({u_matrix:new i.b$(C,s.u_matrix),u_image:new i.bZ(C,s.u_image),u_dimension:new i.c2(C,s.u_dimension),u_zoom:new i.bp(C,s.u_zoom),u_unpack:new i.c0(C,s.u_unpack)}),colorRelief:(C,s)=>({u_image:new i.bZ(C,s.u_image),u_unpack:new i.c0(C,s.u_unpack),u_dimension:new i.c2(C,s.u_dimension),u_elevation_stops:new i.bZ(C,s.u_elevation_stops),u_color_stops:new i.bZ(C,s.u_color_stops),u_color_ramp_size:new i.bZ(C,s.u_color_ramp_size),u_opacity:new i.bp(C,s.u_opacity)}),line:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels)}),lineGradient:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_image:new i.bZ(C,s.u_image),u_image_height:new i.bp(C,s.u_image_height)}),linePattern:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_texsize:new i.c2(C,s.u_texsize),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_image:new i.bZ(C,s.u_image),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade)}),lineSDF:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_image:new i.bZ(C,s.u_image),u_mix:new i.bp(C,s.u_mix),u_tileratio:new i.bp(C,s.u_tileratio),u_crossfade_from:new i.bp(C,s.u_crossfade_from),u_crossfade_to:new i.bp(C,s.u_crossfade_to),u_lineatlas_width:new i.bp(C,s.u_lineatlas_width),u_lineatlas_height:new i.bp(C,s.u_lineatlas_height)}),lineGradientSDF:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_image:new i.bZ(C,s.u_image),u_image_height:new i.bp(C,s.u_image_height),u_tileratio:new i.bp(C,s.u_tileratio),u_crossfade_from:new i.bp(C,s.u_crossfade_from),u_crossfade_to:new i.bp(C,s.u_crossfade_to),u_image_dash:new i.bZ(C,s.u_image_dash),u_mix:new i.bp(C,s.u_mix),u_lineatlas_width:new i.bp(C,s.u_lineatlas_width),u_lineatlas_height:new i.bp(C,s.u_lineatlas_height)}),raster:(C,s)=>({u_tl_parent:new i.c2(C,s.u_tl_parent),u_scale_parent:new i.bp(C,s.u_scale_parent),u_buffer_scale:new i.bp(C,s.u_buffer_scale),u_fade_t:new i.bp(C,s.u_fade_t),u_opacity:new i.bp(C,s.u_opacity),u_image0:new i.bZ(C,s.u_image0),u_image1:new i.bZ(C,s.u_image1),u_brightness_low:new i.bp(C,s.u_brightness_low),u_brightness_high:new i.bp(C,s.u_brightness_high),u_saturation_factor:new i.bp(C,s.u_saturation_factor),u_contrast_factor:new i.bp(C,s.u_contrast_factor),u_spin_weights:new i.c1(C,s.u_spin_weights),u_coords_top:new i.c0(C,s.u_coords_top),u_coords_bottom:new i.c0(C,s.u_coords_bottom)}),symbolIcon:(C,s)=>({u_is_size_zoom_constant:new i.bZ(C,s.u_is_size_zoom_constant),u_is_size_feature_constant:new i.bZ(C,s.u_is_size_feature_constant),u_size_t:new i.bp(C,s.u_size_t),u_size:new i.bp(C,s.u_size),u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_pitch:new i.bp(C,s.u_pitch),u_rotate_symbol:new i.bZ(C,s.u_rotate_symbol),u_aspect_ratio:new i.bp(C,s.u_aspect_ratio),u_fade_change:new i.bp(C,s.u_fade_change),u_label_plane_matrix:new i.b$(C,s.u_label_plane_matrix),u_coord_matrix:new i.b$(C,s.u_coord_matrix),u_is_text:new i.bZ(C,s.u_is_text),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_is_along_line:new i.bZ(C,s.u_is_along_line),u_is_variable_anchor:new i.bZ(C,s.u_is_variable_anchor),u_texsize:new i.c2(C,s.u_texsize),u_texture:new i.bZ(C,s.u_texture),u_translation:new i.c2(C,s.u_translation),u_pitched_scale:new i.bp(C,s.u_pitched_scale)}),symbolSDF:(C,s)=>({u_is_size_zoom_constant:new i.bZ(C,s.u_is_size_zoom_constant),u_is_size_feature_constant:new i.bZ(C,s.u_is_size_feature_constant),u_size_t:new i.bp(C,s.u_size_t),u_size:new i.bp(C,s.u_size),u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_pitch:new i.bp(C,s.u_pitch),u_rotate_symbol:new i.bZ(C,s.u_rotate_symbol),u_aspect_ratio:new i.bp(C,s.u_aspect_ratio),u_fade_change:new i.bp(C,s.u_fade_change),u_label_plane_matrix:new i.b$(C,s.u_label_plane_matrix),u_coord_matrix:new i.b$(C,s.u_coord_matrix),u_is_text:new i.bZ(C,s.u_is_text),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_is_along_line:new i.bZ(C,s.u_is_along_line),u_is_variable_anchor:new i.bZ(C,s.u_is_variable_anchor),u_texsize:new i.c2(C,s.u_texsize),u_texture:new i.bZ(C,s.u_texture),u_gamma_scale:new i.bp(C,s.u_gamma_scale),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_is_halo:new i.bZ(C,s.u_is_halo),u_translation:new i.c2(C,s.u_translation),u_pitched_scale:new i.bp(C,s.u_pitched_scale)}),symbolTextAndIcon:(C,s)=>({u_is_size_zoom_constant:new i.bZ(C,s.u_is_size_zoom_constant),u_is_size_feature_constant:new i.bZ(C,s.u_is_size_feature_constant),u_size_t:new i.bp(C,s.u_size_t),u_size:new i.bp(C,s.u_size),u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_pitch:new i.bp(C,s.u_pitch),u_rotate_symbol:new i.bZ(C,s.u_rotate_symbol),u_aspect_ratio:new i.bp(C,s.u_aspect_ratio),u_fade_change:new i.bp(C,s.u_fade_change),u_label_plane_matrix:new i.b$(C,s.u_label_plane_matrix),u_coord_matrix:new i.b$(C,s.u_coord_matrix),u_is_text:new i.bZ(C,s.u_is_text),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_is_along_line:new i.bZ(C,s.u_is_along_line),u_is_variable_anchor:new i.bZ(C,s.u_is_variable_anchor),u_texsize:new i.c2(C,s.u_texsize),u_texsize_icon:new i.c2(C,s.u_texsize_icon),u_texture:new i.bZ(C,s.u_texture),u_texture_icon:new i.bZ(C,s.u_texture_icon),u_gamma_scale:new i.bp(C,s.u_gamma_scale),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_is_halo:new i.bZ(C,s.u_is_halo),u_translation:new i.c2(C,s.u_translation),u_pitched_scale:new i.bp(C,s.u_pitched_scale)}),background:(C,s)=>({u_opacity:new i.bp(C,s.u_opacity),u_color:new i.b_(C,s.u_color)}),backgroundPattern:(C,s)=>({u_opacity:new i.bp(C,s.u_opacity),u_image:new i.bZ(C,s.u_image),u_pattern_tl_a:new i.c2(C,s.u_pattern_tl_a),u_pattern_br_a:new i.c2(C,s.u_pattern_br_a),u_pattern_tl_b:new i.c2(C,s.u_pattern_tl_b),u_pattern_br_b:new i.c2(C,s.u_pattern_br_b),u_texsize:new i.c2(C,s.u_texsize),u_mix:new i.bp(C,s.u_mix),u_pattern_size_a:new i.c2(C,s.u_pattern_size_a),u_pattern_size_b:new i.c2(C,s.u_pattern_size_b),u_scale_a:new i.bp(C,s.u_scale_a),u_scale_b:new i.bp(C,s.u_scale_b),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_tile_units_to_pixels:new i.bp(C,s.u_tile_units_to_pixels)}),terrain:(C,s)=>({u_texture:new i.bZ(C,s.u_texture),u_ele_delta:new i.bp(C,s.u_ele_delta),u_fog_matrix:new i.b$(C,s.u_fog_matrix),u_fog_color:new i.b_(C,s.u_fog_color),u_fog_ground_blend:new i.bp(C,s.u_fog_ground_blend),u_fog_ground_blend_opacity:new i.bp(C,s.u_fog_ground_blend_opacity),u_horizon_color:new i.b_(C,s.u_horizon_color),u_horizon_fog_blend:new i.bp(C,s.u_horizon_fog_blend),u_is_globe_mode:new i.bp(C,s.u_is_globe_mode)}),terrainDepth:(C,s)=>({u_ele_delta:new i.bp(C,s.u_ele_delta)}),terrainCoords:(C,s)=>({u_texture:new i.bZ(C,s.u_texture),u_terrain_coords_id:new i.bp(C,s.u_terrain_coords_id),u_ele_delta:new i.bp(C,s.u_ele_delta)}),projectionErrorMeasurement:(C,s)=>({u_input:new i.bp(C,s.u_input),u_output_expected:new i.bp(C,s.u_output_expected)}),atmosphere:(C,s)=>({u_sun_pos:new i.c1(C,s.u_sun_pos),u_atmosphere_blend:new i.bp(C,s.u_atmosphere_blend),u_globe_position:new i.c1(C,s.u_globe_position),u_globe_radius:new i.bp(C,s.u_globe_radius),u_inv_proj_matrix:new i.b$(C,s.u_inv_proj_matrix)}),sky:(C,s)=>({u_sky_color:new i.b_(C,s.u_sky_color),u_horizon_color:new i.b_(C,s.u_horizon_color),u_horizon:new i.c2(C,s.u_horizon),u_horizon_normal:new i.c2(C,s.u_horizon_normal),u_sky_horizon_blend:new i.bp(C,s.u_sky_horizon_blend),u_sky_blend:new i.bp(C,s.u_sky_blend)})};class Ph{constructor(s,d,v){this.context=s;const S=s.gl;this.buffer=S.createBuffer(),this.dynamicDraw=!!v,this.context.unbindVAO(),s.bindElementBuffer.set(this.buffer),S.bufferData(S.ELEMENT_ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?S.DYNAMIC_DRAW:S.STATIC_DRAW),this.dynamicDraw||delete d.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(s){const d=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),d.bufferSubData(d.ELEMENT_ARRAY_BUFFER,0,s.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const hl={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Vf{constructor(s,d,v,S){this.length=d.length,this.attributes=v,this.itemSize=d.bytesPerElement,this.dynamicDraw=S,this.context=s;const D=s.gl;this.buffer=D.createBuffer(),s.bindVertexBuffer.set(this.buffer),D.bufferData(D.ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?D.DYNAMIC_DRAW:D.STATIC_DRAW),this.dynamicDraw||delete d.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(s){if(s.length!==this.length)throw new Error(`Length of new data is ${s.length}, which doesn't match current length of ${this.length}`);const d=this.context.gl;this.bind(),d.bufferSubData(d.ARRAY_BUFFER,0,s.arrayBuffer)}enableAttributes(s,d){for(let v=0;v<this.attributes.length;v++){const S=d.attributes[this.attributes[v].name];S!==void 0&&s.enableVertexAttribArray(S)}}setVertexAttribPointers(s,d,v){for(let S=0;S<this.attributes.length;S++){const D=this.attributes[S],k=d.attributes[D.name];k!==void 0&&s.vertexAttribPointer(k,D.components,s[hl[D.type]],!1,this.itemSize,D.offset+this.itemSize*(v||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Qn{constructor(s){this.gl=s.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(s){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Md extends Qn{getDefault(){return i.bo.transparent}set(s){const d=this.current;(s.r!==d.r||s.g!==d.g||s.b!==d.b||s.a!==d.a||this.dirty)&&(this.gl.clearColor(s.r,s.g,s.b,s.a),this.current=s,this.dirty=!1)}}class Mh extends Qn{getDefault(){return 1}set(s){(s!==this.current||this.dirty)&&(this.gl.clearDepth(s),this.current=s,this.dirty=!1)}}class Uf extends Qn{getDefault(){return 0}set(s){(s!==this.current||this.dirty)&&(this.gl.clearStencil(s),this.current=s,this.dirty=!1)}}class jf extends Qn{getDefault(){return[!0,!0,!0,!0]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||s[3]!==d[3]||this.dirty)&&(this.gl.colorMask(s[0],s[1],s[2],s[3]),this.current=s,this.dirty=!1)}}class Gf extends Qn{getDefault(){return!0}set(s){(s!==this.current||this.dirty)&&(this.gl.depthMask(s),this.current=s,this.dirty=!1)}}class uc extends Qn{getDefault(){return 255}set(s){(s!==this.current||this.dirty)&&(this.gl.stencilMask(s),this.current=s,this.dirty=!1)}}class pp extends Qn{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(s){const d=this.current;(s.func!==d.func||s.ref!==d.ref||s.mask!==d.mask||this.dirty)&&(this.gl.stencilFunc(s.func,s.ref,s.mask),this.current=s,this.dirty=!1)}}class $u extends Qn{getDefault(){const s=this.gl;return[s.KEEP,s.KEEP,s.KEEP]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||this.dirty)&&(this.gl.stencilOp(s[0],s[1],s[2]),this.current=s,this.dirty=!1)}}class qu extends Qn{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),this.current=s,this.dirty=!1}}class eh extends Qn{getDefault(){return[0,1]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||this.dirty)&&(this.gl.depthRange(s[0],s[1]),this.current=s,this.dirty=!1)}}class uu extends Qn{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),this.current=s,this.dirty=!1}}class xa extends Qn{getDefault(){return this.gl.LESS}set(s){(s!==this.current||this.dirty)&&(this.gl.depthFunc(s),this.current=s,this.dirty=!1)}}class aa extends Qn{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.BLEND):d.disable(d.BLEND),this.current=s,this.dirty=!1}}class Zu extends Qn{getDefault(){const s=this.gl;return[s.ONE,s.ZERO]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||this.dirty)&&(this.gl.blendFunc(s[0],s[1]),this.current=s,this.dirty=!1)}}class fp extends Qn{getDefault(){return i.bo.transparent}set(s){const d=this.current;(s.r!==d.r||s.g!==d.g||s.b!==d.b||s.a!==d.a||this.dirty)&&(this.gl.blendColor(s.r,s.g,s.b,s.a),this.current=s,this.dirty=!1)}}class Cd extends Qn{getDefault(){return this.gl.FUNC_ADD}set(s){(s!==this.current||this.dirty)&&(this.gl.blendEquation(s),this.current=s,this.dirty=!1)}}class Xl extends Qn{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.CULL_FACE):d.disable(d.CULL_FACE),this.current=s,this.dirty=!1}}class ih extends Qn{getDefault(){return this.gl.BACK}set(s){(s!==this.current||this.dirty)&&(this.gl.cullFace(s),this.current=s,this.dirty=!1)}}class Hu extends Qn{getDefault(){return this.gl.CCW}set(s){(s!==this.current||this.dirty)&&(this.gl.frontFace(s),this.current=s,this.dirty=!1)}}class Ch extends Qn{getDefault(){return null}set(s){(s!==this.current||this.dirty)&&(this.gl.useProgram(s),this.current=s,this.dirty=!1)}}class La extends Qn{getDefault(){return this.gl.TEXTURE0}set(s){(s!==this.current||this.dirty)&&(this.gl.activeTexture(s),this.current=s,this.dirty=!1)}}class Dd extends Qn{getDefault(){const s=this.gl;return[0,0,s.drawingBufferWidth,s.drawingBufferHeight]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||s[3]!==d[3]||this.dirty)&&(this.gl.viewport(s[0],s[1],s[2],s[3]),this.current=s,this.dirty=!1)}}class ri extends Qn{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindFramebuffer(d.FRAMEBUFFER,s),this.current=s,this.dirty=!1}}class Dh extends Qn{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindRenderbuffer(d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}class du extends Qn{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindTexture(d.TEXTURE_2D,s),this.current=s,this.dirty=!1}}class zh extends Qn{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindBuffer(d.ARRAY_BUFFER,s),this.current=s,this.dirty=!1}}class yn extends Qn{getDefault(){return null}set(s){const d=this.gl;d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,s),this.current=s,this.dirty=!1}}class Lh extends Qn{getDefault(){return null}set(s){var d;if(s===this.current&&!this.dirty)return;const v=this.gl;qa(v)?v.bindVertexArray(s):(d=v.getExtension("OES_vertex_array_object"))===null||d===void 0||d.bindVertexArrayOES(s),this.current=s,this.dirty=!1}}class zc extends Qn{getDefault(){return 4}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_ALIGNMENT,s),this.current=s,this.dirty=!1}}class zd extends Qn{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s),this.current=s,this.dirty=!1}}class Ra extends Qn{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,s),this.current=s,this.dirty=!1}}class kr extends Qn{constructor(s,d){super(s),this.context=s,this.parent=d}getDefault(){return null}}class Wu extends kr{setDirty(){this.dirty=!0}set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,s,0),this.current=s,this.dirty=!1}}class $f extends kr{set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}class Mm extends kr{set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}const pu="Framebuffer is not complete";class mp{constructor(s,d,v,S,D){this.context=s,this.width=d,this.height=v;const k=s.gl,j=this.framebuffer=k.createFramebuffer();if(this.colorAttachment=new Wu(s,j),S)this.depthAttachment=D?new Mm(s,j):new $f(s,j);else if(D)throw new Error("Stencil cannot be set without depth");if(k.checkFramebufferStatus(k.FRAMEBUFFER)!==k.FRAMEBUFFER_COMPLETE)throw new Error(pu)}destroy(){const s=this.context.gl,d=this.colorAttachment.get();if(d&&s.deleteTexture(d),this.depthAttachment){const v=this.depthAttachment.get();v&&s.deleteRenderbuffer(v)}s.deleteFramebuffer(this.framebuffer)}}class Xn{constructor(s){var d,v;if(this.gl=s,this.clearColor=new Md(this),this.clearDepth=new Mh(this),this.clearStencil=new Uf(this),this.colorMask=new jf(this),this.depthMask=new Gf(this),this.stencilMask=new uc(this),this.stencilFunc=new pp(this),this.stencilOp=new $u(this),this.stencilTest=new qu(this),this.depthRange=new eh(this),this.depthTest=new uu(this),this.depthFunc=new xa(this),this.blend=new aa(this),this.blendFunc=new Zu(this),this.blendColor=new fp(this),this.blendEquation=new Cd(this),this.cullFace=new Xl(this),this.cullFaceSide=new ih(this),this.frontFace=new Hu(this),this.program=new Ch(this),this.activeTexture=new La(this),this.viewport=new Dd(this),this.bindFramebuffer=new ri(this),this.bindRenderbuffer=new Dh(this),this.bindTexture=new du(this),this.bindVertexBuffer=new zh(this),this.bindElementBuffer=new yn(this),this.bindVertexArray=new Lh(this),this.pixelStoreUnpack=new zc(this),this.pixelStoreUnpackPremultiplyAlpha=new zd(this),this.pixelStoreUnpackFlipY=new Ra(this),this.extTextureFilterAnisotropic=s.getExtension("EXT_texture_filter_anisotropic")||s.getExtension("MOZ_EXT_texture_filter_anisotropic")||s.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=s.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),qa(s)){this.HALF_FLOAT=s.HALF_FLOAT;const S=s.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(d=s.RGBA16F)!==null&&d!==void 0?d:S?.RGBA16F_EXT,this.RGB16F=(v=s.RGB16F)!==null&&v!==void 0?v:S?.RGB16F_EXT,s.getExtension("EXT_color_buffer_float")}else{s.getExtension("EXT_color_buffer_half_float"),s.getExtension("OES_texture_half_float_linear");const S=s.getExtension("OES_texture_half_float");this.HALF_FLOAT=S?.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(s,d){return new Ph(this,s,d)}createVertexBuffer(s,d,v){return new Vf(this,s,d,v)}createRenderbuffer(s,d,v){const S=this.gl,D=S.createRenderbuffer();return this.bindRenderbuffer.set(D),S.renderbufferStorage(S.RENDERBUFFER,s,d,v),this.bindRenderbuffer.set(null),D}createFramebuffer(s,d,v,S){return new mp(this,s,d,v,S)}clear({color:s,depth:d,stencil:v}){const S=this.gl;let D=0;s&&(D|=S.COLOR_BUFFER_BIT,this.clearColor.set(s),this.colorMask.set([!0,!0,!0,!0])),d!==void 0&&(D|=S.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(d),this.depthMask.set(!0)),v!==void 0&&(D|=S.STENCIL_BUFFER_BIT,this.clearStencil.set(v),this.stencilMask.set(255)),S.clear(D)}setCullFace(s){s.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(s.mode),this.frontFace.set(s.frontFace))}setDepthMode(s){s.func!==this.gl.ALWAYS||s.mask?(this.depthTest.set(!0),this.depthFunc.set(s.func),this.depthMask.set(s.mask),this.depthRange.set(s.range)):this.depthTest.set(!1)}setStencilMode(s){s.test.func!==this.gl.ALWAYS||s.mask?(this.stencilTest.set(!0),this.stencilMask.set(s.mask),this.stencilOp.set([s.fail,s.depthFail,s.pass]),this.stencilFunc.set({func:s.test.func,ref:s.ref,mask:s.test.mask})):this.stencilTest.set(!1)}setColorMode(s){i.bQ(s.blendFunction,Eo.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(s.blendFunction),this.blendColor.set(s.blendColor)),this.colorMask.set(s.mask)}createVertexArray(){var s;return qa(this.gl)?this.gl.createVertexArray():(s=this.gl.getExtension("OES_vertex_array_object"))===null||s===void 0?void 0:s.createVertexArrayOES()}deleteVertexArray(s){var d;return qa(this.gl)?this.gl.deleteVertexArray(s):(d=this.gl.getExtension("OES_vertex_array_object"))===null||d===void 0?void 0:d.deleteVertexArrayOES(s)}unbindVAO(){this.bindVertexArray.set(null)}}let Rh;function Xu(C,s,d,v,S){const D=C.context,k=C.transform,j=D.gl,H=C.useProgram("collisionBox"),J=[];let et=0,mt=0;for(let Xt=0;Xt<v.length;Xt++){const ft=v[Xt],_e=s.getTile(ft).getBucket(d);if(!_e)continue;const ce=S?_e.textCollisionBox:_e.iconCollisionBox,me=_e.collisionCircleArray;me.length>0&&(J.push({circleArray:me,circleOffset:mt,coord:ft}),et+=me.length/4,mt=et),ce&&H.draw(D,j.LINES,Hr.disabled,Cn.disabled,C.colorModeForRenderPass(),Rn.disabled,Wl(C.transform),C.style.map.terrain&&C.style.map.terrain.getTerrainData(ft),k.getProjectionData({overscaledTileID:ft,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),d.id,ce.layoutVertexBuffer,ce.indexBuffer,ce.segments,null,C.transform.zoom,null,null,ce.collisionVertexBuffer)}if(!S||!J.length)return;const ut=C.useProgram("collisionCircle"),St=new i.c9;St.resize(4*et),St._trim();let pt=0;for(const Xt of J)for(let ft=0;ft<Xt.circleArray.length/4;ft++){const _e=4*ft,ce=Xt.circleArray[_e+0],me=Xt.circleArray[_e+1],be=Xt.circleArray[_e+2],de=Xt.circleArray[_e+3];St.emplace(pt++,ce,me,be,de,0),St.emplace(pt++,ce,me,be,de,1),St.emplace(pt++,ce,me,be,de,2),St.emplace(pt++,ce,me,be,de,3)}(!Rh||Rh.length<2*et)&&(Rh=function(Xt){const ft=2*Xt,_e=new i.cb;_e.resize(ft),_e._trim();for(let ce=0;ce<ft;ce++){const me=6*ce;_e.uint16[me+0]=4*ce+0,_e.uint16[me+1]=4*ce+1,_e.uint16[me+2]=4*ce+2,_e.uint16[me+3]=4*ce+2,_e.uint16[me+4]=4*ce+3,_e.uint16[me+5]=4*ce+0}return _e}(et));const Et=D.createIndexBuffer(Rh,!0),Kt=D.createVertexBuffer(St,i.ca.members,!0);for(const Xt of J){const ft=Mc(C.transform);ut.draw(D,j.TRIANGLES,Hr.disabled,Cn.disabled,C.colorModeForRenderPass(),Rn.disabled,ft,C.style.map.terrain&&C.style.map.terrain.getTerrainData(Xt.coord),null,d.id,Kt,Et,i.aW.simpleSegment(0,2*Xt.circleOffset,Xt.circleArray.length,Xt.circleArray.length/2),null,C.transform.zoom,null,null,null)}Kt.destroy(),Et.destroy()}const qf=i.ar(new Float32Array(16));function gp(C,s,d,v,S,D){const{horizontalAlign:k,verticalAlign:j}=i.aR(C);return new i.P((-(k-.5)*s/S+v[0])*D,(-(j-.5)*d/S+v[1])*D)}function _p(C,s,d,v,S,D){const k=s.tileAnchorPoint.add(new i.P(s.translation[0],s.translation[1]));if(s.pitchWithMap){let j=v.mult(D);d||(j=j.rotate(-S));const H=k.add(j);return Tt(H.x,H.y,s.pitchedLabelPlaneMatrix,s.getElevation).point}if(d){const j=Mi(s.tileAnchorPoint.x+1,s.tileAnchorPoint.y,s).point.sub(C),H=Math.atan(j.y/j.x)+(j.x<0?Math.PI:0);return C.add(v.rotate(H))}return C.add(v)}function yp(C,s,d,v,S,D,k,j,H,J,et,mt){const ut=C.text.placedSymbolArray,St=C.text.dynamicLayoutVertexArray,pt=C.icon.dynamicLayoutVertexArray,Et={};St.clear();for(let Kt=0;Kt<ut.length;Kt++){const Xt=ut.get(Kt),ft=Xt.hidden||!Xt.crossTileID||C.allowVerticalPlacement&&!Xt.placedOrientation?null:v[Xt.crossTileID];if(ft){const _e=new i.P(Xt.anchorX,Xt.anchorY),ce={getElevation:mt,width:S.width,height:S.height,pitchedLabelPlaneMatrix:D,pitchWithMap:d,transform:S,tileAnchorPoint:_e,translation:J,unwrappedTileID:et},me=d?Xi(_e.x,_e.y,ce):Mi(_e.x,_e.y,ce),be=Nt(S.cameraToCenterDistance,me.signedDistanceFromCamera);let de=i.az(C.textSizeData,j,Xt)*be/i.aL;d&&(de*=C.tilePixelRatio/k);const{width:De,height:Qe,anchor:Xe,textOffset:Je,textBoxScale:ii}=ft,Di=gp(Xe,De,Qe,Je,ii,de),Fi=S.getPitchedTextCorrection(_e.x+J[0],_e.y+J[1],et),wi=_p(me.point,ce,s,Di,-S.bearingInRadians,Fi),fr=C.allowVerticalPlacement&&Xt.placedOrientation===i.ay.vertical?Math.PI/2:0;for(let $r=0;$r<Xt.numGlyphs;$r++)i.aF(St,wi,fr);H&&Xt.associatedIconIndex>=0&&(Et[Xt.associatedIconIndex]={shiftedAnchor:wi,angle:fr})}else Pn(Xt.numGlyphs,St)}if(H){pt.clear();const Kt=C.icon.placedSymbolArray;for(let Xt=0;Xt<Kt.length;Xt++){const ft=Kt.get(Xt);if(ft.hidden)Pn(ft.numGlyphs,pt);else{const _e=Et[Xt];if(_e)for(let ce=0;ce<ft.numGlyphs;ce++)i.aF(pt,_e.shiftedAnchor,_e.angle);else Pn(ft.numGlyphs,pt)}}C.icon.dynamicLayoutVertexBuffer.updateData(pt)}C.text.dynamicLayoutVertexBuffer.updateData(St)}function fu(C,s,d){return d.iconsInText&&s?"symbolTextAndIcon":C?"symbolSDF":"symbolIcon"}function xp(C,s,d,v,S,D,k,j,H,J,et,mt,ut){const St=C.context,pt=St.gl,Et=C.transform,Kt=j==="map",Xt=H==="map",ft=j!=="viewport"&&d.layout.get("symbol-placement")!=="point",_e=Kt&&!Xt&&!ft,ce=!d.layout.get("symbol-sort-key").isConstant();let me=!1;const be=C.getDepthModeForSublayer(0,Hr.ReadOnly),de=d._unevaluatedLayout.hasValue("text-variable-anchor")||d._unevaluatedLayout.hasValue("text-variable-anchor-offset"),De=[],Qe=Et.getCircleRadiusCorrection();for(const Xe of v){const Je=s.getTile(Xe),ii=Je.getBucket(d);if(!ii)continue;const Di=S?ii.text:ii.icon;if(!Di||!Di.segments.get().length||!Di.hasVisibleVertices)continue;const Fi=Di.programConfigurations.get(d.id),wi=S||ii.sdfIcons,fr=S?ii.textSizeData:ii.iconSizeData,$r=Xt||Et.pitch!==0,Nr=C.useProgram(fu(wi,S,ii),Fi),co=i.ax(fr,Et.zoom),No=C.style.map.terrain&&C.style.map.terrain.getTerrainData(Xe);let Jo,Vo,Es,Ko,$n=[0,0],_s=null;if(S)Vo=Je.glyphAtlasTexture,Es=pt.LINEAR,Jo=Je.glyphAtlasTexture.size,ii.iconsInText&&($n=Je.imageAtlasTexture.size,_s=Je.imageAtlasTexture,Ko=$r||C.options.rotating||C.options.zooming||fr.kind==="composite"||fr.kind==="camera"?pt.LINEAR:pt.NEAREST);else{const Po=d.layout.get("icon-size").constantOr(0)!==1||ii.iconsNeedLinear;Vo=Je.imageAtlasTexture,Es=wi||C.options.rotating||C.options.zooming||Po||$r?pt.LINEAR:pt.NEAREST,Jo=Je.imageAtlasTexture.size}const Qo=i.aM(Je,1,C.transform.zoom),Jr=se(Kt,C.transform,Qo),vr=i.N();i.aA(vr,Jr);const Jl=st(Xt,Kt,C.transform,Qo),ys=i.aN(Et,Je,D,k),ml=Et.getProjectionData({overscaledTileID:Xe,applyGlobeMatrix:!ut,applyTerrainMatrix:!0}),Kl=de&&ii.hasTextData(),Fs=d.layout.get("icon-text-fit")!=="none"&&Kl&&ii.hasIconData();if(ft){const Po=C.style.map.terrain?(hs,To)=>C.style.map.terrain.getElevation(Xe,hs,To):null,Mo=d.layout.get("text-rotation-alignment")==="map";oe(ii,C,S,Jr,vr,Xt,J,Mo,Xe.toUnwrapped(),Et.width,Et.height,ys,Po)}const mc=S&&de||Fs,Wa=ft||mc?qf:Xt?Jr:C.transform.clipSpaceToPixelsMatrix,Ql=wi&&d.paint.get(S?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Uc;Uc=wi?ii.iconsInText?gs(fr.kind,co,_e,Xt,ft,mc,C,Wa,Jl,ys,Jo,$n,Qe):sa(fr.kind,co,_e,Xt,ft,mc,C,Wa,Jl,ys,S,Jo,0,Qe):Cc(fr.kind,co,_e,Xt,ft,mc,C,Wa,Jl,ys,S,Jo,Qe);const Zs={program:Nr,buffers:Di,uniformValues:Uc,projectionData:ml,atlasTexture:Vo,atlasTextureIcon:_s,atlasInterpolation:Es,atlasInterpolationIcon:Ko,isSDF:wi,hasHalo:Ql};if(ce&&ii.canOverlap){me=!0;const Po=Di.segments.get();for(const Mo of Po)De.push({segments:new i.aW([Mo]),sortKey:Mo.sortKey,state:Zs,terrainData:No})}else De.push({segments:Di.segments,sortKey:0,state:Zs,terrainData:No})}me&&De.sort((Xe,Je)=>Xe.sortKey-Je.sortKey);for(const Xe of De){const Je=Xe.state;if(St.activeTexture.set(pt.TEXTURE0),Je.atlasTexture.bind(Je.atlasInterpolation,pt.CLAMP_TO_EDGE),Je.atlasTextureIcon&&(St.activeTexture.set(pt.TEXTURE1),Je.atlasTextureIcon&&Je.atlasTextureIcon.bind(Je.atlasInterpolationIcon,pt.CLAMP_TO_EDGE)),Je.isSDF){const ii=Je.uniformValues;Je.hasHalo&&(ii.u_is_halo=1,Ld(Je.buffers,Xe.segments,d,C,Je.program,be,et,mt,ii,Je.projectionData,Xe.terrainData)),ii.u_is_halo=0}Ld(Je.buffers,Xe.segments,d,C,Je.program,be,et,mt,Je.uniformValues,Je.projectionData,Xe.terrainData)}}function Ld(C,s,d,v,S,D,k,j,H,J,et){const mt=v.context;S.draw(mt,mt.gl.TRIANGLES,D,k,j,Rn.backCCW,H,et,J,d.id,C.layoutVertexBuffer,C.indexBuffer,s,d.paint,v.transform.zoom,C.programConfigurations.get(d.id),C.dynamicLayoutVertexBuffer,C.opacityVertexBuffer)}function Rd(C,s,d,v,S){const D=C.context,k=D.gl,j=Cn.disabled,H=new Eo([k.ONE,k.ONE],i.bo.transparent,[!0,!0,!0,!0]),J=s.getBucket(d);if(!J)return;const et=v.key;let mt=d.heatmapFbos.get(et);mt||(mt=kd(D,s.tileSize,s.tileSize),d.heatmapFbos.set(et,mt)),D.bindFramebuffer.set(mt.framebuffer),D.viewport.set([0,0,s.tileSize,s.tileSize]),D.clear({color:i.bo.transparent});const ut=J.programConfigurations.get(d.id),St=C.useProgram("heatmap",ut,!S),pt=C.transform.getProjectionData({overscaledTileID:s.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),Et=C.style.map.terrain.getTerrainData(v);St.draw(D,k.TRIANGLES,Hr.disabled,j,H,Rn.disabled,yr(s,C.transform.zoom,d.paint.get("heatmap-intensity"),1),Et,pt,d.id,J.layoutVertexBuffer,J.indexBuffer,J.segments,d.paint,C.transform.zoom,ut)}function Zf(C,s,d,v,S){const D=C.context,k=D.gl,j=C.transform;D.setColorMode(C.colorModeForRenderPass());const H=kh(D,s),J=d.key,et=s.heatmapFbos.get(J);if(!et)return;D.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,et.colorAttachment.get()),D.activeTexture.set(k.TEXTURE1),H.bind(k.LINEAR,k.CLAMP_TO_EDGE);const mt=j.getProjectionData({overscaledTileID:d,applyTerrainMatrix:S,applyGlobeMatrix:!v});C.useProgram("heatmapTexture").draw(D,k.TRIANGLES,Hr.disabled,Cn.disabled,C.colorModeForRenderPass(),Rn.disabled,zi(C,s,0,1),null,mt,s.id,C.rasterBoundsBuffer,C.quadTriangleIndexBuffer,C.rasterBoundsSegments,s.paint,j.zoom),et.destroy(),s.heatmapFbos.delete(J)}function kd(C,s,d){var v,S;const D=C.gl,k=D.createTexture();D.bindTexture(D.TEXTURE_2D,k),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,D.LINEAR);const j=(v=C.HALF_FLOAT)!==null&&v!==void 0?v:D.UNSIGNED_BYTE,H=(S=C.RGBA16F)!==null&&S!==void 0?S:D.RGBA;D.texImage2D(D.TEXTURE_2D,0,H,s,d,0,D.RGBA,j,null);const J=C.createFramebuffer(s,d,!1,!1);return J.colorAttachment.set(k),J}function kh(C,s){return s.colorRampTexture||(s.colorRampTexture=new i.T(C,s.colorRamp,C.gl.RGBA)),s.colorRampTexture}function Yu(C,s,d,v,S,D,k,j){let H=256;if(S.stepInterpolant){const J=s.getSource().maxzoom,et=k.canonical.z===J?Math.ceil(1<<C.transform.maxZoom-k.canonical.z):1;H=i.an(i.cd(D.maxLineLength/i.a4*1024*et),256,d.maxTextureSize)}return j.gradient=i.ce({expression:S.gradientExpression(),evaluationKey:"lineProgress",resolution:H,image:j.gradient||void 0,clips:D.lineClipsArray}),j.texture?j.texture.update(j.gradient):j.texture=new i.T(d,j.gradient,v.RGBA),j.version=S.gradientVersion,j.texture}function Fh(C,s,d,v,S){C.activeTexture.set(s.TEXTURE0),d.imageAtlasTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE),v.updatePaintBuffers(S)}function mu(C,s,d,v,S,D){(S||C.lineAtlas.dirty)&&(s.activeTexture.set(d.TEXTURE0),C.lineAtlas.bind(s)),v.updatePaintBuffers(D)}function Bh(C,s,d,v,S,D,k){const j=D.gradients[S.id];let H=j.texture;S.gradientVersion!==j.version&&(H=Yu(C,s,d,v,S,D,k,j)),d.activeTexture.set(v.TEXTURE0),H.bind(S.stepInterpolant?v.NEAREST:v.LINEAR,v.CLAMP_TO_EDGE)}function Oh(C,s,d,v,S,D,k,j,H){const J=D.gradients[S.id];let et=J.texture;S.gradientVersion!==J.version&&(et=Yu(C,s,d,v,S,D,k,J)),d.activeTexture.set(v.TEXTURE0),et.bind(S.stepInterpolant?v.NEAREST:v.LINEAR,v.CLAMP_TO_EDGE),d.activeTexture.set(v.TEXTURE1),C.lineAtlas.bind(d),j.updatePaintBuffers(H)}function uf(C,s,d,v,S){if(!d||!v||!v.imageAtlas)return;const D=v.imageAtlas.patternPositions;let k=D[d.to.toString()],j=D[d.from.toString()];if(!k&&j&&(k=j),!j&&k&&(j=k),!k||!j){const H=S.getPaintProperty(s);k=D[H],j=D[H]}k&&j&&C.setConstantPatternPositions(k,j)}function Fd(C,s,d,v,S,D,k,j){const H=C.context.gl,J="fill-pattern",et=d.paint.get(J),mt=et&&et.constantOr(1),ut=d.getCrossfadeParameters();let St,pt,Et,Kt,Xt;const ft=C.transform,_e=d.paint.get("fill-translate"),ce=d.paint.get("fill-translate-anchor");k?(pt=mt&&!d.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",St=H.LINES):(pt=mt?"fillPattern":"fill",St=H.TRIANGLES);const me=et.constantOr(null);for(const be of v){const de=s.getTile(be);if(mt&&!de.patternsLoaded())continue;const De=de.getBucket(d);if(!De)continue;const Qe=De.programConfigurations.get(d.id),Xe=C.useProgram(pt,Qe),Je=C.style.map.terrain&&C.style.map.terrain.getTerrainData(be);mt&&(C.context.activeTexture.set(H.TEXTURE0),de.imageAtlasTexture.bind(H.LINEAR,H.CLAMP_TO_EDGE),Qe.updatePaintBuffers(ut)),uf(Qe,J,me,de,d);const ii=ft.getProjectionData({overscaledTileID:be,applyGlobeMatrix:!j,applyTerrainMatrix:!0}),Di=i.aN(ft,de,_e,ce);if(k){Kt=De.indexBuffer2,Xt=De.segments2;const wi=[H.drawingBufferWidth,H.drawingBufferHeight];Et=pt==="fillOutlinePattern"&&mt?Gu(C,ut,de,wi,Di):Pd(wi,Di)}else Kt=De.indexBuffer,Xt=De.segments,Et=mt?za(C,ut,de,Di):{u_fill_translate:Di};const Fi=C.stencilModeForClipping(be);Xe.draw(C.context,St,S,Fi,D,Rn.backCCW,Et,Je,ii,d.id,De.layoutVertexBuffer,Kt,Xt,d.paint,C.transform.zoom,Qe)}}function Xo(C,s,d,v,S,D,k,j){const H=C.context,J=H.gl,et="fill-extrusion-pattern",mt=d.paint.get(et),ut=mt.constantOr(1),St=d.getCrossfadeParameters(),pt=d.paint.get("fill-extrusion-opacity"),Et=mt.constantOr(null),Kt=C.transform;for(const Xt of v){const ft=s.getTile(Xt),_e=ft.getBucket(d);if(!_e)continue;const ce=C.style.map.terrain&&C.style.map.terrain.getTerrainData(Xt),me=_e.programConfigurations.get(d.id),be=C.useProgram(ut?"fillExtrusionPattern":"fillExtrusion",me);ut&&(C.context.activeTexture.set(J.TEXTURE0),ft.imageAtlasTexture.bind(J.LINEAR,J.CLAMP_TO_EDGE),me.updatePaintBuffers(St));const de=Kt.getProjectionData({overscaledTileID:Xt,applyGlobeMatrix:!j,applyTerrainMatrix:!0});uf(me,et,Et,ft,d);const De=i.aN(Kt,ft,d.paint.get("fill-extrusion-translate"),d.paint.get("fill-extrusion-translate-anchor")),Qe=d.paint.get("fill-extrusion-vertical-gradient"),Xe=ut?cl(C,Qe,pt,De,Xt,St,ft):fs(C,Qe,pt,De);be.draw(H,H.gl.TRIANGLES,S,D,k,Rn.backCCW,Xe,ce,de,d.id,_e.layoutVertexBuffer,_e.indexBuffer,_e.segments,d.paint,C.transform.zoom,me,C.style.map.terrain&&_e.centroidVertexBuffer)}}function ul(C,s,d,v,S,D,k,j,H){var J;const et=C.style.projection,mt=C.context,ut=C.transform,St=mt.gl,pt=[`#define NUM_ILLUMINATION_SOURCES ${d.paint.get("hillshade-highlight-color").values.length}`],Et=C.useProgram("hillshade",null,!1,pt),Kt=!C.options.moving;for(const Xt of v){const ft=s.getTile(Xt),_e=ft.fbo;if(!_e)continue;const ce=et.getMeshFromTileID(mt,Xt.canonical,j,!0,"raster"),me=(J=C.style.map.terrain)===null||J===void 0?void 0:J.getTerrainData(Xt);mt.activeTexture.set(St.TEXTURE0),St.bindTexture(St.TEXTURE_2D,_e.colorAttachment.get());const be=ut.getProjectionData({overscaledTileID:Xt,aligned:Kt,applyGlobeMatrix:!H,applyTerrainMatrix:!0});Et.draw(mt,St.TRIANGLES,D,S[Xt.overscaledZ],k,Rn.backCCW,Dl(C,ft,d),me,be,d.id,ce.vertexBuffer,ce.indexBuffer,ce.segments)}}function va(C,s,d,v,S,D,k,j,H){var J;const et=C.style.projection,mt=C.context,ut=C.transform,St=mt.gl,pt=C.useProgram("colorRelief"),Et=!C.options.moving;let Kt=!0,Xt=0;for(const ft of v){const _e=s.getTile(ft),ce=_e.dem;if(Kt){const Xe=St.getParameter(St.MAX_TEXTURE_SIZE),{elevationTexture:Je,colorTexture:ii}=d.getColorRampTextures(mt,Xe,ce.getUnpackVector());mt.activeTexture.set(St.TEXTURE1),Je.bind(St.NEAREST,St.CLAMP_TO_EDGE),mt.activeTexture.set(St.TEXTURE4),ii.bind(St.LINEAR,St.CLAMP_TO_EDGE),Kt=!1,Xt=Je.size[0]}if(!ce||!ce.data)continue;const me=ce.stride,be=ce.getPixels();if(mt.activeTexture.set(St.TEXTURE0),mt.pixelStoreUnpackPremultiplyAlpha.set(!1),_e.demTexture=_e.demTexture||C.getTileTexture(me),_e.demTexture){const Xe=_e.demTexture;Xe.update(be,{premultiply:!1}),Xe.bind(St.LINEAR,St.CLAMP_TO_EDGE)}else _e.demTexture=new i.T(mt,be,St.RGBA,{premultiply:!1}),_e.demTexture.bind(St.LINEAR,St.CLAMP_TO_EDGE);const de=et.getMeshFromTileID(mt,ft.canonical,j,!0,"raster"),De=(J=C.style.map.terrain)===null||J===void 0?void 0:J.getTerrainData(ft),Qe=ut.getProjectionData({overscaledTileID:ft,aligned:Et,applyGlobeMatrix:!H,applyTerrainMatrix:!0});pt.draw(mt,St.TRIANGLES,D,S[ft.overscaledZ],k,Rn.backCCW,Eh(d,_e.dem,Xt),De,Qe,d.id,de.vertexBuffer,de.indexBuffer,de.segments)}}const Nh=[new i.P(0,0),new i.P(i.a4,0),new i.P(i.a4,i.a4),new i.P(0,i.a4)];function rh(C,s,d,v,S,D,k,j,H=!1,J=!1){const et=v[v.length-1].overscaledZ,mt=C.context,ut=mt.gl,St=C.useProgram("raster"),pt=C.transform,Et=C.style.projection,Kt=C.colorModeForRenderPass(),Xt=!C.options.moving,ft=d.paint.get("raster-opacity"),_e=d.paint.get("raster-resampling"),ce=d.paint.get("raster-fade-duration"),me=!!C.style.map.terrain;for(const be of v){const de=C.getDepthModeForSublayer(be.overscaledZ-et,ft===1?Hr.ReadWrite:Hr.ReadOnly,ut.LESS),De=s.getTile(be),Qe=_e==="nearest"?ut.NEAREST:ut.LINEAR;mt.activeTexture.set(ut.TEXTURE0),De.texture.bind(Qe,ut.CLAMP_TO_EDGE,ut.LINEAR_MIPMAP_NEAREST),mt.activeTexture.set(ut.TEXTURE1);const{parentTile:Xe,parentScaleBy:Je,parentTopLeft:ii,fadeValues:Di}=Bd(De,s,ce,me);De.fadeOpacity=Di.tileOpacity,Xe?(Xe.fadeOpacity=Di.parentTileOpacity,Xe.texture.bind(Qe,ut.CLAMP_TO_EDGE,ut.LINEAR_MIPMAP_NEAREST)):De.texture.bind(Qe,ut.CLAMP_TO_EDGE,ut.LINEAR_MIPMAP_NEAREST),De.texture.useMipmap&&mt.extTextureFilterAnisotropic&&C.transform.pitch>20&&ut.texParameterf(ut.TEXTURE_2D,mt.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,mt.extTextureFilterAnisotropicMax);const Fi=C.style.map.terrain&&C.style.map.terrain.getTerrainData(be),wi=pt.getProjectionData({overscaledTileID:be,aligned:Xt,applyGlobeMatrix:!J,applyTerrainMatrix:!0}),fr=$s(ii,Je,Di.fadeMix,d,j),$r=Et.getMeshFromTileID(mt,be.canonical,D,k,"raster");St.draw(mt,ut.TRIANGLES,de,S?S[be.overscaledZ]:Cn.disabled,Kt,H?Rn.frontCCW:Rn.backCCW,fr,Fi,wi,d.id,$r.vertexBuffer,$r.indexBuffer,$r.segments)}}function Bd(C,s,d,v){const S={parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:{tileOpacity:1,parentTileOpacity:1,fadeMix:{opacity:1,mix:0}}};if(d===0||v)return S;if(C.fadingParentID){const D=s.getLoadedTile(C.fadingParentID);if(!D)return S;const k=Math.pow(2,D.tileID.overscaledZ-C.tileID.overscaledZ),j=[C.tileID.canonical.x*k%1,C.tileID.canonical.y*k%1],H=function(J,et,mt){const ut=Ri(),St=(ut-et.timeAdded)/mt,pt=J.fadingDirection===we.Incoming,Et=i.an((ut-J.timeAdded)/mt,0,1),Kt=i.an(1-St,0,1),Xt=pt?Et:Kt;return{tileOpacity:Xt,parentTileOpacity:pt?Kt:Et,fadeMix:{opacity:1,mix:1-Xt}}}(C,D,d);return{parentTile:D,parentScaleBy:k,parentTopLeft:j,fadeValues:H}}if(C.selfFading){const D=function(k,j){const H=(Ri()-k.timeAdded)/j,J=i.an(H,0,1);return{tileOpacity:J,fadeMix:{opacity:J,mix:0}}}(C,d);return{parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:D}}return S}const Lc=new i.bo(1,0,0,1),vp=new i.bo(0,1,0,1),Ju=new i.bo(0,0,1,1),bp=new i.bo(1,0,1,1),gu=new i.bo(0,1,1,1);function Ku(C,s,d,v){Qu(C,0,s+d/2,C.transform.width,d,v)}function df(C,s,d,v){Qu(C,s-d/2,0,d,C.transform.height,v)}function Qu(C,s,d,v,S,D){const k=C.context,j=k.gl;j.enable(j.SCISSOR_TEST),j.scissor(s*C.pixelRatio,d*C.pixelRatio,v*C.pixelRatio,S*C.pixelRatio),k.clear({color:D}),j.disable(j.SCISSOR_TEST)}function Hf(C,s,d){const v=C.context,S=v.gl,D=C.useProgram("debug"),k=Hr.disabled,j=Cn.disabled,H=C.colorModeForRenderPass(),J="$debug",et=C.style.map.terrain&&C.style.map.terrain.getTerrainData(d);v.activeTexture.set(S.TEXTURE0);const mt=s.getTileByID(d.key).latestRawTileData,ut=Math.floor((mt&&mt.byteLength||0)/1024),St=s.getTile(d).tileSize,pt=512/Math.min(St,512)*(d.overscaledZ/C.transform.zoom)*.5;let Et=d.canonical.toString();d.overscaledZ!==d.canonical.z&&(Et+=` => ${d.overscaledZ}`),function(Xt,ft){Xt.initDebugOverlayCanvas();const _e=Xt.debugOverlayCanvas,ce=Xt.context.gl,me=Xt.debugOverlayCanvas.getContext("2d");me.clearRect(0,0,_e.width,_e.height),me.shadowColor="white",me.shadowBlur=2,me.lineWidth=1.5,me.strokeStyle="white",me.textBaseline="top",me.font="bold 36px Open Sans, sans-serif",me.fillText(ft,5,5),me.strokeText(ft,5,5),Xt.debugOverlayTexture.update(_e),Xt.debugOverlayTexture.bind(ce.LINEAR,ce.CLAMP_TO_EDGE)}(C,`${Et} ${ut}kB`);const Kt=C.transform.getProjectionData({overscaledTileID:d,applyGlobeMatrix:!0,applyTerrainMatrix:!0});D.draw(v,S.TRIANGLES,k,j,Eo.alphaBlended,Rn.disabled,Ao(i.bo.transparent,pt),null,Kt,J,C.debugBuffer,C.quadTriangleIndexBuffer,C.debugSegments),D.draw(v,S.LINE_STRIP,k,j,H,Rn.disabled,Ao(i.bo.red),et,Kt,J,C.debugBuffer,C.tileBorderIndexBuffer,C.debugSegments)}function Rc(C,s,d,v){const{isRenderingGlobe:S}=v,D=C.context,k=D.gl,j=C.transform,H=C.colorModeForRenderPass(),J=C.getDepthModeFor3D(),et=C.useProgram("terrain");D.bindFramebuffer.set(null),D.viewport.set([0,0,C.width,C.height]);for(const mt of d){const ut=s.getTerrainMesh(mt.tileID),St=C.renderToTexture.getTexture(mt),pt=s.getTerrainData(mt.tileID);D.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,St.texture);const Et=s.getMeshFrameDelta(j.zoom),Kt=j.calculateFogMatrix(mt.tileID.toUnwrapped()),Xt=Ad(Et,Kt,C.style.sky,j.pitch,S),ft=j.getProjectionData({overscaledTileID:mt.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});et.draw(D,k.TRIANGLES,J,Cn.disabled,H,Rn.backCCW,Xt,pt,ft,"terrain",ut.vertexBuffer,ut.indexBuffer,ut.segments)}}function Od(C,s){if(!s.mesh){const d=new i.aV;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(1,1),d.emplaceBack(-1,1);const v=new i.aX;v.emplaceBack(0,1,2),v.emplaceBack(0,2,3),s.mesh=new sc(C.createVertexBuffer(d,Lo.members),C.createIndexBuffer(v),i.aW.simpleSegment(0,0,d.length,v.length))}return s.mesh}class Nd{constructor(s,d){this.context=new Xn(s),this.transform=d,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:i.ar(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=_n.maxOverzooming+_n.maxUnderzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Gs}resize(s,d,v){if(this.width=Math.floor(s*v),this.height=Math.floor(d*v),this.pixelRatio=v,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const S of this.style._order)this.style._layers[S].resize()}setup(){const s=this.context,d=new i.aV;d.emplaceBack(0,0),d.emplaceBack(i.a4,0),d.emplaceBack(0,i.a4),d.emplaceBack(i.a4,i.a4),this.tileExtentBuffer=s.createVertexBuffer(d,Lo.members),this.tileExtentSegments=i.aW.simpleSegment(0,0,4,2);const v=new i.aV;v.emplaceBack(0,0),v.emplaceBack(i.a4,0),v.emplaceBack(0,i.a4),v.emplaceBack(i.a4,i.a4),this.debugBuffer=s.createVertexBuffer(v,Lo.members),this.debugSegments=i.aW.simpleSegment(0,0,4,5);const S=new i.cg;S.emplaceBack(0,0,0,0),S.emplaceBack(i.a4,0,i.a4,0),S.emplaceBack(0,i.a4,0,i.a4),S.emplaceBack(i.a4,i.a4,i.a4,i.a4),this.rasterBoundsBuffer=s.createVertexBuffer(S,Pc.members),this.rasterBoundsSegments=i.aW.simpleSegment(0,0,4,2);const D=new i.aV;D.emplaceBack(0,0),D.emplaceBack(i.a4,0),D.emplaceBack(0,i.a4),D.emplaceBack(i.a4,i.a4),this.rasterBoundsBufferPosOnly=s.createVertexBuffer(D,Lo.members),this.rasterBoundsSegmentsPosOnly=i.aW.simpleSegment(0,0,4,5);const k=new i.aV;k.emplaceBack(0,0),k.emplaceBack(1,0),k.emplaceBack(0,1),k.emplaceBack(1,1),this.viewportBuffer=s.createVertexBuffer(k,Lo.members),this.viewportSegments=i.aW.simpleSegment(0,0,4,2);const j=new i.ch;j.emplaceBack(0),j.emplaceBack(1),j.emplaceBack(3),j.emplaceBack(2),j.emplaceBack(0),this.tileBorderIndexBuffer=s.createIndexBuffer(j);const H=new i.aX;H.emplaceBack(1,0,2),H.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=s.createIndexBuffer(H);const J=this.context.gl;this.stencilClearMode=new Cn({func:J.ALWAYS,mask:0},0,255,J.ZERO,J.ZERO,J.ZERO),this.tileExtentMesh=new sc(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const s=this.context,d=s.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const v=i.N();i.c6(v,0,this.width,this.height,0,0,1),i.Q(v,v,[d.drawingBufferWidth,d.drawingBufferHeight,0]);const S={mainMatrix:v,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:v};this.useProgram("clippingMask",null,!0).draw(s,d.TRIANGLES,Hr.disabled,this.stencilClearMode,Eo.disabled,Rn.disabled,null,null,S,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(s,d,v){if(this.currentStencilSource===s.source||!s.isTileClipped()||!d||!d.length)return;this.currentStencilSource=s.source,this.nextStencilID+d.length>256&&this.clearStencil();const S=this.context;S.setColorMode(Eo.disabled),S.setDepthMode(Hr.disabled);const D={};for(const k of d)D[k.key]=this.nextStencilID++;this._renderTileMasks(D,d,v,!0),this._renderTileMasks(D,d,v,!1),this._tileClippingMaskIDs=D}_renderTileMasks(s,d,v,S){const D=this.context,k=D.gl,j=this.style.projection,H=this.transform,J=this.useProgram("clippingMask");for(const et of d){const mt=s[et.key],ut=this.style.map.terrain&&this.style.map.terrain.getTerrainData(et),St=j.getMeshFromTileID(this.context,et.canonical,S,!0,"stencil"),pt=H.getProjectionData({overscaledTileID:et,applyGlobeMatrix:!v,applyTerrainMatrix:!0});J.draw(D,k.TRIANGLES,Hr.disabled,new Cn({func:k.ALWAYS,mask:0},mt,255,k.KEEP,k.KEEP,k.REPLACE),Eo.disabled,v?Rn.disabled:Rn.backCCW,null,ut,pt,"$clipping",St.vertexBuffer,St.indexBuffer,St.segments)}}_renderTilesDepthBuffer(){const s=this.context,d=s.gl,v=this.style.projection,S=this.transform,D=this.useProgram("depth"),k=this.getDepthModeFor3D(),j=Ae(S,{tileSize:S.tileSize});for(const H of j){const J=this.style.map.terrain&&this.style.map.terrain.getTerrainData(H),et=v.getMeshFromTileID(this.context,H.canonical,!0,!0,"raster"),mt=S.getProjectionData({overscaledTileID:H,applyGlobeMatrix:!0,applyTerrainMatrix:!0});D.draw(s,d.TRIANGLES,k,Cn.disabled,Eo.disabled,Rn.backCCW,null,J,mt,"$clipping",et.vertexBuffer,et.indexBuffer,et.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const s=this.nextStencilID++,d=this.context.gl;return new Cn({func:d.NOTEQUAL,mask:255},s,255,d.KEEP,d.KEEP,d.REPLACE)}stencilModeForClipping(s){const d=this.context.gl;return new Cn({func:d.EQUAL,mask:255},this._tileClippingMaskIDs[s.key],0,d.KEEP,d.KEEP,d.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(s){const d=this.context.gl,v=s.sort((k,j)=>j.overscaledZ-k.overscaledZ),S=v[v.length-1].overscaledZ,D=v[0].overscaledZ-S+1;if(D>1){this.currentStencilSource=void 0,this.nextStencilID+D>256&&this.clearStencil();const k={};for(let j=0;j<D;j++)k[j+S]=new Cn({func:d.GEQUAL,mask:255},j+this.nextStencilID,255,d.KEEP,d.KEEP,d.REPLACE);return this.nextStencilID+=D,[k,v]}return[{[S]:Cn.disabled},v]}stencilConfigForOverlapTwoPass(s){const d=this.context.gl,v=s.sort((k,j)=>j.overscaledZ-k.overscaledZ),S=v[v.length-1].overscaledZ,D=v[0].overscaledZ-S+1;if(this.clearStencil(),D>1){const k={},j={};for(let H=0;H<D;H++)k[H+S]=new Cn({func:d.GREATER,mask:255},D+1+H,255,d.KEEP,d.KEEP,d.REPLACE),j[H+S]=new Cn({func:d.GREATER,mask:255},1+H,255,d.KEEP,d.KEEP,d.REPLACE);return this.nextStencilID=2*D+1,[k,j,v]}return this.nextStencilID=3,[{[S]:new Cn({func:d.GREATER,mask:255},2,255,d.KEEP,d.KEEP,d.REPLACE)},{[S]:new Cn({func:d.GREATER,mask:255},1,255,d.KEEP,d.KEEP,d.REPLACE)},v]}colorModeForRenderPass(){const s=this.context.gl;return this._showOverdrawInspector?new Eo([s.CONSTANT_COLOR,s.ONE],new i.bo(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Eo.unblended:Eo.alphaBlended}getDepthModeForSublayer(s,d,v){if(!this.opaquePassEnabledForLayer())return Hr.disabled;const S=1-((1+this.currentLayer)*this.numSublayers+s)*this.depthEpsilon;return new Hr(v||this.context.gl.LEQUAL,d,[S,S])}getDepthModeFor3D(){return new Hr(this.context.gl.LEQUAL,Hr.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(s,d){var v,S;this.style=s,this.options=d,this.lineAtlas=s.lineAtlas,this.imageManager=s.imageManager,this.glyphManager=s.glyphManager,this.symbolFadeChange=s.placement.symbolFadeChange(Ri()),this.imageManager.beginFrame();const D=this.style._order,k=this.style.tileManagers,j={},H={},J={},et={isRenderingToTexture:!1,isRenderingGlobe:((v=s.projection)===null||v===void 0?void 0:v.transitionState)>0};for(const ut in k){const St=k[ut];St.used&&St.prepare(this.context),j[ut]=St.getVisibleCoordinates(!1),H[ut]=j[ut].slice().reverse(),J[ut]=St.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let ut=0;ut<D.length;ut++)if(this.style._layers[D[ut]].is3D()){this.opaquePassCutoff=ut;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const ut of D){const St=this.style._layers[ut];if(!St.hasOffscreenPass()||St.isHidden(this.transform.zoom))continue;const pt=H[St.source];(St.type==="custom"||pt.length)&&this.renderLayer(this,k[St.source],St,pt,et)}if((S=this.style.projection)===null||S===void 0||S.updateGPUdependent({context:this.context,useProgram:ut=>this.useProgram(ut)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:d.showOverdrawInspector?i.bo.black:i.bo.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(ut,St){const pt=ut.context,Et=pt.gl,Kt=((be,de,De)=>{const Qe=Math.cos(de.rollInRadians),Xe=Math.sin(de.rollInRadians),Je=Re(de),ii=de.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:be.properties.get("sky-color"),u_horizon_color:be.properties.get("horizon-color"),u_horizon:[(de.width/2-Je*Xe)*De,(de.height/2+Je*Qe)*De],u_horizon_normal:[-Xe,Qe],u_sky_horizon_blend:be.properties.get("sky-horizon-blend")*de.height/2*De,u_sky_blend:ii}})(St,ut.style.map.transform,ut.pixelRatio),Xt=new Hr(Et.LEQUAL,Hr.ReadWrite,[0,1]),ft=Cn.disabled,_e=ut.colorModeForRenderPass(),ce=ut.useProgram("sky"),me=Od(pt,St);ce.draw(pt,Et.TRIANGLES,Xt,ft,_e,Rn.disabled,Kt,null,void 0,"sky",me.vertexBuffer,me.indexBuffer,me.segments)}(this,this.style.sky),this._showOverdrawInspector=d.showOverdrawInspector,this.depthRangeFor3D=[0,1-(s._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=D.length-1;this.currentLayer>=0;this.currentLayer--){const ut=this.style._layers[D[this.currentLayer]],St=k[ut.source],pt=j[ut.source];this._renderTileClippingMasks(ut,pt,!1),this.renderLayer(this,St,ut,pt,et)}this.renderPass="translucent";let mt=!1;for(this.currentLayer=0;this.currentLayer<D.length;this.currentLayer++){const ut=this.style._layers[D[this.currentLayer]],St=k[ut.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(ut,et))continue;this.opaquePassEnabledForLayer()||mt||(mt=!0,et.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const pt=(ut.type==="symbol"?J:H)[ut.source];this._renderTileClippingMasks(ut,j[ut.source],!!this.renderToTexture),this.renderLayer(this,St,ut,pt,et)}if(et.isRenderingGlobe&&function(ut,St,pt){const Et=ut.context,Kt=Et.gl,Xt=ut.useProgram("atmosphere"),ft=new Hr(Kt.LEQUAL,Hr.ReadOnly,[0,1]),_e=ut.transform,ce=function(ii,Di){const Fi=ii.properties.get("position"),wi=[-Fi.x,-Fi.y,-Fi.z],fr=i.ar(new Float64Array(16));return ii.properties.get("anchor")==="map"&&(i.bf(fr,fr,Di.rollInRadians),i.bg(fr,fr,-Di.pitchInRadians),i.bf(fr,fr,Di.bearingInRadians),i.bg(fr,fr,Di.center.lat*Math.PI/180),i.bI(fr,fr,-Di.center.lng*Math.PI/180)),i.cf(wi,wi,fr),wi}(pt,ut.transform),me=_e.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),be=St.properties.get("atmosphere-blend")*me.projectionTransition;if(be===0)return;const de=ju(_e.worldSize,_e.center.lat),De=_e.inverseProjectionMatrix,Qe=new Float64Array(4);Qe[3]=1,i.aG(Qe,Qe,_e.modelViewProjectionMatrix),Qe[0]/=Qe[3],Qe[1]/=Qe[3],Qe[2]/=Qe[3],Qe[3]=1,i.aG(Qe,Qe,De),Qe[0]/=Qe[3],Qe[1]/=Qe[3],Qe[2]/=Qe[3],Qe[3]=1;const Xe=((ii,Di,Fi,wi,fr)=>({u_sun_pos:ii,u_atmosphere_blend:Di,u_globe_position:Fi,u_globe_radius:wi,u_inv_proj_matrix:fr}))(ce,be,[Qe[0],Qe[1],Qe[2]],de,De),Je=Od(Et,St);Xt.draw(Et,Kt.TRIANGLES,ft,Cn.disabled,Eo.alphaBlended,Rn.disabled,Xe,null,null,"atmosphere",Je.vertexBuffer,Je.indexBuffer,Je.segments)}(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const ut=function(St,pt){let Et=null;const Kt=Object.values(St._layers).flatMap(ce=>ce.source&&!ce.isHidden(pt)?[St.tileManagers[ce.source]]:[]),Xt=Kt.filter(ce=>ce.getSource().type==="vector"),ft=Kt.filter(ce=>ce.getSource().type!=="vector"),_e=ce=>{(!Et||Et.getSource().maxzoom<ce.getSource().maxzoom)&&(Et=ce)};return Xt.forEach(ce=>_e(ce)),Et||ft.forEach(ce=>_e(ce)),Et}(this.style,this.transform.zoom);ut&&function(St,pt,Et){for(let Kt=0;Kt<Et.length;Kt++)Hf(St,pt,Et[Kt])}(this,ut,ut.getVisibleCoordinates())}this.options.showPadding&&function(ut){const St=ut.transform.padding;Ku(ut,ut.transform.height-(St.top||0),3,Lc),Ku(ut,St.bottom||0,3,vp),df(ut,St.left||0,3,Ju),df(ut,ut.transform.width-(St.right||0),3,bp);const pt=ut.transform.centerPoint;(function(Et,Kt,Xt,ft){Qu(Et,Kt-1,Xt-10,2,20,ft),Qu(Et,Kt-10,Xt-1,20,2,ft)})(ut,pt.x,ut.transform.height-pt.y,gu)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(s){if(!this.style||!this.style.map||!this.style.map.terrain)return;const d=this.terrainFacilitator.matrix,v=this.transform.modelViewProjectionMatrix;let S=this.terrainFacilitator.dirty;S||(S=s?!i.ci(d,v):!i.cj(d,v)),S||(S=this.style.map.terrain.tileManager.anyTilesAfterTime(this.terrainFacilitator.renderTime)),S&&(i.ck(d,v),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(D,k){const j=D.context,H=j.gl,J=D.transform,et=Eo.unblended,mt=new Hr(H.LEQUAL,Hr.ReadWrite,[0,1]),ut=k.tileManager.getRenderableTiles(),St=D.useProgram("terrainDepth");j.bindFramebuffer.set(k.getFramebuffer("depth").framebuffer),j.viewport.set([0,0,D.width/devicePixelRatio,D.height/devicePixelRatio]),j.clear({color:i.bo.transparent,depth:1});for(const pt of ut){const Et=k.getTerrainMesh(pt.tileID),Kt=k.getTerrainData(pt.tileID),Xt=J.getProjectionData({overscaledTileID:pt.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),ft={u_ele_delta:k.getMeshFrameDelta(J.zoom)};St.draw(j,H.TRIANGLES,mt,Cn.disabled,et,Rn.backCCW,ft,Kt,Xt,"terrain",Et.vertexBuffer,Et.indexBuffer,Et.segments)}j.bindFramebuffer.set(null),j.viewport.set([0,0,D.width,D.height])}(this,this.style.map.terrain),function(D,k){const j=D.context,H=j.gl,J=D.transform,et=Eo.unblended,mt=new Hr(H.LEQUAL,Hr.ReadWrite,[0,1]),ut=k.getCoordsTexture(),St=k.tileManager.getRenderableTiles(),pt=D.useProgram("terrainCoords");j.bindFramebuffer.set(k.getFramebuffer("coords").framebuffer),j.viewport.set([0,0,D.width/devicePixelRatio,D.height/devicePixelRatio]),j.clear({color:i.bo.transparent,depth:1}),k.coordsIndex=[];for(const Et of St){const Kt=k.getTerrainMesh(Et.tileID),Xt=k.getTerrainData(Et.tileID);j.activeTexture.set(H.TEXTURE0),H.bindTexture(H.TEXTURE_2D,ut.texture);const ft={u_terrain_coords_id:(255-k.coordsIndex.length)/255,u_texture:0,u_ele_delta:k.getMeshFrameDelta(J.zoom)},_e=J.getProjectionData({overscaledTileID:Et.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});pt.draw(j,H.TRIANGLES,mt,Cn.disabled,et,Rn.backCCW,ft,Xt,_e,"terrain",Kt.vertexBuffer,Kt.indexBuffer,Kt.segments),k.coordsIndex.push(Et.tileID.key)}j.bindFramebuffer.set(null),j.viewport.set([0,0,D.width,D.height])}(this,this.style.map.terrain))}renderLayer(s,d,v,S,D){v.isHidden(this.transform.zoom)||(v.type==="background"||v.type==="custom"||(S||[]).length)&&(this.id=v.id,i.cl(v)?function(k,j,H,J,et,mt){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:ut}=mt,St=Cn.disabled,pt=k.colorModeForRenderPass();(H._unevaluatedLayout.hasValue("text-variable-anchor")||H._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(Et,Kt,Xt,ft,_e,ce,me,be,de){const De=Kt.transform,Qe=Kt.style.map.terrain,Xe=_e==="map",Je=ce==="map";for(const ii of Et){const Di=ft.getTile(ii),Fi=Di.getBucket(Xt);if(!Fi||!Fi.text||!Fi.text.segments.get().length)continue;const wi=i.ax(Fi.textSizeData,De.zoom),fr=i.aM(Di,1,Kt.transform.zoom),$r=se(Xe,Kt.transform,fr),Nr=Xt.layout.get("icon-text-fit")!=="none"&&Fi.hasIconData();if(wi){const co=Math.pow(2,De.zoom-Di.tileID.overscaledZ),No=Qe?(Jo,Vo)=>Qe.getElevation(ii,Jo,Vo):null;yp(Fi,Xe,Je,de,De,$r,co,wi,Nr,i.aN(De,Di,me,be),ii.toUnwrapped(),No)}}}(J,k,H,j,H.layout.get("text-rotation-alignment"),H.layout.get("text-pitch-alignment"),H.paint.get("text-translate"),H.paint.get("text-translate-anchor"),et),H.paint.get("icon-opacity").constantOr(1)!==0&&xp(k,j,H,J,!1,H.paint.get("icon-translate"),H.paint.get("icon-translate-anchor"),H.layout.get("icon-rotation-alignment"),H.layout.get("icon-pitch-alignment"),H.layout.get("icon-keep-upright"),St,pt,ut),H.paint.get("text-opacity").constantOr(1)!==0&&xp(k,j,H,J,!0,H.paint.get("text-translate"),H.paint.get("text-translate-anchor"),H.layout.get("text-rotation-alignment"),H.layout.get("text-pitch-alignment"),H.layout.get("text-keep-upright"),St,pt,ut),j.map.showCollisionBoxes&&(Xu(k,j,H,J,!0),Xu(k,j,H,J,!1))}(s,d,v,S,this.style.placement.variableOffsets,D):i.cm(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:mt}=et,ut=H.paint.get("circle-opacity"),St=H.paint.get("circle-stroke-width"),pt=H.paint.get("circle-stroke-opacity"),Et=!H.layout.get("circle-sort-key").isConstant();if(ut.constantOr(1)===0&&(St.constantOr(1)===0||pt.constantOr(1)===0))return;const Kt=k.context,Xt=Kt.gl,ft=k.transform,_e=k.getDepthModeForSublayer(0,Hr.ReadOnly),ce=Cn.disabled,me=k.colorModeForRenderPass(),be=[],de=ft.getCircleRadiusCorrection();for(let De=0;De<J.length;De++){const Qe=J[De],Xe=j.getTile(Qe),Je=Xe.getBucket(H);if(!Je)continue;const ii=H.paint.get("circle-translate"),Di=H.paint.get("circle-translate-anchor"),Fi=i.aN(ft,Xe,ii,Di),wi=Je.programConfigurations.get(H.id),fr=k.useProgram("circle",wi),$r=Je.layoutVertexBuffer,Nr=Je.indexBuffer,co=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Qe),No={programConfiguration:wi,program:fr,layoutVertexBuffer:$r,indexBuffer:Nr,uniformValues:ls(k,Xe,H,Fi,de),terrainData:co,projectionData:ft.getProjectionData({overscaledTileID:Qe,applyGlobeMatrix:!mt,applyTerrainMatrix:!0})};if(Et){const Jo=Je.segments.get();for(const Vo of Jo)be.push({segments:new i.aW([Vo]),sortKey:Vo.sortKey,state:No})}else be.push({segments:Je.segments,sortKey:0,state:No})}Et&&be.sort((De,Qe)=>De.sortKey-Qe.sortKey);for(const De of be){const{programConfiguration:Qe,program:Xe,layoutVertexBuffer:Je,indexBuffer:ii,uniformValues:Di,terrainData:Fi,projectionData:wi}=De.state;Xe.draw(Kt,Xt.TRIANGLES,_e,ce,me,Rn.backCCW,Di,Fi,wi,H.id,Je,ii,De.segments,H.paint,k.transform.zoom,Qe)}}(s,d,v,S,D):i.cn(v)?function(k,j,H,J,et){if(H.paint.get("heatmap-opacity")===0)return;const mt=k.context,{isRenderingToTexture:ut,isRenderingGlobe:St}=et;if(k.style.map.terrain){for(const pt of J){const Et=j.getTile(pt);j.hasRenderableParent(pt)||(k.renderPass==="offscreen"?Rd(k,Et,H,pt,St):k.renderPass==="translucent"&&Zf(k,H,pt,ut,St))}mt.viewport.set([0,0,k.width,k.height])}else k.renderPass==="offscreen"?function(pt,Et,Kt,Xt){const ft=pt.context,_e=ft.gl,ce=pt.transform,me=Cn.disabled,be=new Eo([_e.ONE,_e.ONE],i.bo.transparent,[!0,!0,!0,!0]);(function(de,De,Qe){const Xe=de.gl;de.activeTexture.set(Xe.TEXTURE1),de.viewport.set([0,0,De.width/4,De.height/4]);let Je=Qe.heatmapFbos.get(i.cc);Je?(Xe.bindTexture(Xe.TEXTURE_2D,Je.colorAttachment.get()),de.bindFramebuffer.set(Je.framebuffer)):(Je=kd(de,De.width/4,De.height/4),Qe.heatmapFbos.set(i.cc,Je))})(ft,pt,Kt),ft.clear({color:i.bo.transparent});for(let de=0;de<Xt.length;de++){const De=Xt[de];if(Et.hasRenderableParent(De))continue;const Qe=Et.getTile(De),Xe=Qe.getBucket(Kt);if(!Xe)continue;const Je=Xe.programConfigurations.get(Kt.id),ii=pt.useProgram("heatmap",Je),Di=ce.getProjectionData({overscaledTileID:De,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),Fi=ce.getCircleRadiusCorrection();ii.draw(ft,_e.TRIANGLES,Hr.disabled,me,be,Rn.backCCW,yr(Qe,ce.zoom,Kt.paint.get("heatmap-intensity"),Fi),null,Di,Kt.id,Xe.layoutVertexBuffer,Xe.indexBuffer,Xe.segments,Kt.paint,ce.zoom,Je)}ft.viewport.set([0,0,pt.width,pt.height])}(k,j,H,J):k.renderPass==="translucent"&&function(pt,Et){const Kt=pt.context,Xt=Kt.gl;Kt.setColorMode(pt.colorModeForRenderPass());const ft=Et.heatmapFbos.get(i.cc);ft&&(Kt.activeTexture.set(Xt.TEXTURE0),Xt.bindTexture(Xt.TEXTURE_2D,ft.colorAttachment.get()),Kt.activeTexture.set(Xt.TEXTURE1),kh(Kt,Et).bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE),pt.useProgram("heatmapTexture").draw(Kt,Xt.TRIANGLES,Hr.disabled,Cn.disabled,pt.colorModeForRenderPass(),Rn.disabled,zi(pt,Et,0,1),null,null,Et.id,pt.viewportBuffer,pt.quadTriangleIndexBuffer,pt.viewportSegments,Et.paint,pt.transform.zoom))}(k,H)}(s,d,v,S,D):i.co(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:mt}=et,ut=H.paint.get("line-opacity"),St=H.paint.get("line-width");if(ut.constantOr(1)===0||St.constantOr(1)===0)return;const pt=k.getDepthModeForSublayer(0,Hr.ReadOnly),Et=k.colorModeForRenderPass(),Kt=H.paint.get("line-dasharray"),Xt=Kt.constantOr(1),ft=H.paint.get("line-pattern"),_e=ft.constantOr(1),ce=H.paint.get("line-gradient"),me=H.getCrossfadeParameters();let be;be=_e?"linePattern":Xt&&ce?"lineGradientSDF":Xt?"lineSDF":ce?"lineGradient":"line";const de=k.context,De=de.gl,Qe=k.transform;let Xe=!0;for(const Je of J){const ii=j.getTile(Je);if(_e&&!ii.patternsLoaded())continue;const Di=ii.getBucket(H);if(!Di)continue;const Fi=Di.programConfigurations.get(H.id),wi=k.context.program.get(),fr=k.useProgram(be,Fi),$r=Xe||fr.program!==wi,Nr=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Je),co=ft.constantOr(null),No=Kt&&Kt.constantOr(null);if(co&&ii.imageAtlas){const $n=ii.imageAtlas,_s=$n.patternPositions[co.to.toString()],Qo=$n.patternPositions[co.from.toString()];_s&&Qo&&Fi.setConstantPatternPositions(_s,Qo)}else if(No){const $n=H.layout.get("line-cap")==="round",_s=k.lineAtlas.getDash(No.to,$n),Qo=k.lineAtlas.getDash(No.from,$n);Fi.setConstantDashPositions(_s,Qo)}const Jo=Qe.getProjectionData({overscaledTileID:Je,applyGlobeMatrix:!mt,applyTerrainMatrix:!0}),Vo=Qe.getPixelScale();let Es;_e?(Es=dp(k,ii,H,Vo,me),Fh(de,De,ii,Fi,me)):Xt&&ce?(Es=hc(k,ii,H,Vo,me,Di.lineClipsArray.length),Oh(k,j,de,De,H,Di,Je,Fi,me)):Xt?(Es=Nf(k,ii,H,Vo,me),mu(k,de,De,Fi,$r,me)):ce?(Es=th(k,ii,H,Vo,Di.lineClipsArray.length),Bh(k,j,de,De,H,Di,Je)):Es=Qi(k,ii,H,Vo);const Ko=k.stencilModeForClipping(Je);fr.draw(de,De.TRIANGLES,pt,Ko,Et,Rn.disabled,Es,Nr,Jo,H.id,Di.layoutVertexBuffer,Di.indexBuffer,Di.segments,H.paint,k.transform.zoom,Fi,Di.layoutVertexBuffer2),Xe=!1}}(s,d,v,S,D):i.cp(v)?function(k,j,H,J,et){const mt=H.paint.get("fill-color"),ut=H.paint.get("fill-opacity");if(ut.constantOr(1)===0)return;const{isRenderingToTexture:St}=et,pt=k.colorModeForRenderPass(),Et=H.paint.get("fill-pattern"),Kt=k.opaquePassEnabledForLayer()&&!Et.constantOr(1)&&mt.constantOr(i.bo.transparent).a===1&&ut.constantOr(0)===1?"opaque":"translucent";if(k.renderPass===Kt){const Xt=k.getDepthModeForSublayer(1,k.renderPass==="opaque"?Hr.ReadWrite:Hr.ReadOnly);Fd(k,j,H,J,Xt,pt,!1,St)}if(k.renderPass==="translucent"&&H.paint.get("fill-antialias")){const Xt=k.getDepthModeForSublayer(H.getPaintProperty("fill-outline-color")?2:0,Hr.ReadOnly);Fd(k,j,H,J,Xt,pt,!0,St)}}(s,d,v,S,D):i.cq(v)?function(k,j,H,J,et){const mt=H.paint.get("fill-extrusion-opacity");if(mt===0)return;const{isRenderingToTexture:ut}=et;if(k.renderPass==="translucent"){const St=new Hr(k.context.gl.LEQUAL,Hr.ReadWrite,k.depthRangeFor3D);if(mt!==1||H.paint.get("fill-extrusion-pattern").constantOr(1))Xo(k,j,H,J,St,Cn.disabled,Eo.disabled,ut),Xo(k,j,H,J,St,k.stencilModeFor3D(),k.colorModeForRenderPass(),ut);else{const pt=k.colorModeForRenderPass();Xo(k,j,H,J,St,Cn.disabled,pt,ut)}}}(s,d,v,S,D):i.cr(v)?function(k,j,H,J,et){if(k.renderPass!=="offscreen"&&k.renderPass!=="translucent")return;const{isRenderingToTexture:mt}=et,ut=k.context,St=k.style.projection.useSubdivision,pt=k.getDepthModeForSublayer(0,Hr.ReadOnly),Et=k.colorModeForRenderPass();if(k.renderPass==="offscreen")(function(Kt,Xt,ft,_e,ce,me,be){const de=Kt.context,De=de.gl;for(const Qe of ft){const Xe=Xt.getTile(Qe),Je=Xe.dem;if(!Je||!Je.data||!Xe.needsHillshadePrepare)continue;const ii=Je.dim,Di=Je.stride,Fi=Je.getPixels();if(de.activeTexture.set(De.TEXTURE1),de.pixelStoreUnpackPremultiplyAlpha.set(!1),Xe.demTexture=Xe.demTexture||Kt.getTileTexture(Di),Xe.demTexture){const fr=Xe.demTexture;fr.update(Fi,{premultiply:!1}),fr.bind(De.NEAREST,De.CLAMP_TO_EDGE)}else Xe.demTexture=new i.T(de,Fi,De.RGBA,{premultiply:!1}),Xe.demTexture.bind(De.NEAREST,De.CLAMP_TO_EDGE);de.activeTexture.set(De.TEXTURE0);let wi=Xe.fbo;if(!wi){const fr=new i.T(de,{width:ii,height:ii,data:null},De.RGBA);fr.bind(De.LINEAR,De.CLAMP_TO_EDGE),wi=Xe.fbo=de.createFramebuffer(ii,ii,!0,!1),wi.colorAttachment.set(fr.texture)}de.bindFramebuffer.set(wi.framebuffer),de.viewport.set([0,0,ii,ii]),Kt.useProgram("hillshadePrepare").draw(de,De.TRIANGLES,ce,me,be,Rn.disabled,sr(Xe.tileID,Je),null,null,_e.id,Kt.rasterBoundsBuffer,Kt.quadTriangleIndexBuffer,Kt.rasterBoundsSegments),Xe.needsHillshadePrepare=!1}})(k,j,J,H,pt,Cn.disabled,Et),ut.viewport.set([0,0,k.width,k.height]);else if(k.renderPass==="translucent")if(St){const[Kt,Xt,ft]=k.stencilConfigForOverlapTwoPass(J);ul(k,j,H,ft,Kt,pt,Et,!1,mt),ul(k,j,H,ft,Xt,pt,Et,!0,mt)}else{const[Kt,Xt]=k.getStencilConfigForOverlapAndUpdateStencilID(J);ul(k,j,H,Xt,Kt,pt,Et,!1,mt)}}(s,d,v,S,D):i.cs(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent"||!J.length)return;const{isRenderingToTexture:mt}=et,ut=k.style.projection.useSubdivision,St=k.getDepthModeForSublayer(0,Hr.ReadOnly),pt=k.colorModeForRenderPass();if(ut){const[Et,Kt,Xt]=k.stencilConfigForOverlapTwoPass(J);va(k,j,H,Xt,Et,St,pt,!1,mt),va(k,j,H,Xt,Kt,St,pt,!0,mt)}else{const[Et,Kt]=k.getStencilConfigForOverlapAndUpdateStencilID(J);va(k,j,H,Kt,Et,St,pt,!1,mt)}}(s,d,v,S,D):i.bT(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent"||H.paint.get("raster-opacity")===0||!J.length)return;const{isRenderingToTexture:mt}=et,ut=j.getSource(),St=k.style.projection.useSubdivision;if(ut instanceof Ss)rh(k,j,H,J,null,!1,!1,ut.tileCoords,ut.flippedWindingOrder,mt);else if(St){const[pt,Et,Kt]=k.stencilConfigForOverlapTwoPass(J);rh(k,j,H,Kt,pt,!1,!0,Nh,!1,mt),rh(k,j,H,Kt,Et,!0,!0,Nh,!1,mt)}else{const[pt,Et]=k.getStencilConfigForOverlapAndUpdateStencilID(J);rh(k,j,H,Et,pt,!1,!0,Nh,!1,mt)}}(s,d,v,S,D):i.ct(v)?function(k,j,H,J,et){const mt=H.paint.get("background-color"),ut=H.paint.get("background-opacity");if(ut===0)return;const{isRenderingToTexture:St}=et,pt=k.context,Et=pt.gl,Kt=k.style.projection,Xt=k.transform,ft=Xt.tileSize,_e=H.paint.get("background-pattern");if(k.isPatternMissing(_e))return;const ce=!_e&&mt.a===1&&ut===1&&k.opaquePassEnabledForLayer()?"opaque":"translucent";if(k.renderPass!==ce)return;const me=Cn.disabled,be=k.getDepthModeForSublayer(0,ce==="opaque"?Hr.ReadWrite:Hr.ReadOnly),de=k.colorModeForRenderPass(),De=k.useProgram(_e?"backgroundPattern":"background"),Qe=J||Ae(Xt,{tileSize:ft,terrain:k.style.map.terrain});_e&&(pt.activeTexture.set(Et.TEXTURE0),k.imageManager.bind(k.context));const Xe=H.getCrossfadeParameters();for(const Je of Qe){const ii=Xt.getProjectionData({overscaledTileID:Je,applyGlobeMatrix:!St,applyTerrainMatrix:!0}),Di=_e?hf(ut,k,_e,{tileID:Je,tileSize:ft},Xe):cf(ut,mt),Fi=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Je),wi=Kt.getMeshFromTileID(pt,Je.canonical,!1,!0,"raster");De.draw(pt,Et.TRIANGLES,be,me,de,Rn.backCCW,Di,Fi,ii,H.id,wi.vertexBuffer,wi.indexBuffer,wi.segments)}}(s,0,v,S,D):i.cu(v)&&function(k,j,H,J){const{isRenderingGlobe:et}=J,mt=k.context,ut=H.implementation,St=k.style.projection,pt=k.transform,Et=pt.getProjectionDataForCustomLayer(et),Kt={farZ:pt.farZ,nearZ:pt.nearZ,fov:pt.fov*Math.PI/180,modelViewProjectionMatrix:pt.modelViewProjectionMatrix,projectionMatrix:pt.projectionMatrix,shaderData:{variantName:St.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${St.shaderPreludeCode.vertexSource}`,define:St.shaderDefine},defaultProjectionData:Et},Xt=ut.renderingMode?ut.renderingMode:"2d";if(k.renderPass==="offscreen"){const ft=ut.prerender;ft&&(k.setCustomLayerDefaults(),mt.setColorMode(k.colorModeForRenderPass()),ft.call(ut,mt.gl,Kt),mt.setDirty(),k.setBaseState())}else if(k.renderPass==="translucent"){k.setCustomLayerDefaults(),mt.setColorMode(k.colorModeForRenderPass()),mt.setStencilMode(Cn.disabled);const ft=Xt==="3d"?k.getDepthModeFor3D():k.getDepthModeForSublayer(0,Hr.ReadOnly);mt.setDepthMode(ft),ut.render(mt.gl,Kt),mt.setDirty(),k.setBaseState(),mt.bindFramebuffer.set(null)}}(s,0,v,D))}saveTileTexture(s){const d=this._tileTextures[s.size[0]];d?d.push(s):this._tileTextures[s.size[0]]=[s]}getTileTexture(s){const d=this._tileTextures[s];return d&&d.length>0?d.pop():null}isPatternMissing(s){if(!s)return!1;if(!s.from||!s.to)return!0;const d=this.imageManager.getPattern(s.from.toString()),v=this.imageManager.getPattern(s.to.toString());return!d||!v}useProgram(s,d,v=!1,S=[]){this.cache=this.cache||{};const D=!!this.style.map.terrain,k=this.style.projection,j=v?ea.projectionMercator:k.shaderPreludeCode,H=v?as:k.shaderDefine,J=s+(d?d.cacheKey:"")+`/${v?ia:k.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(D?"/terrain":"")+(S?`/${S.join("/")}`:"");return this.cache[J]||(this.cache[J]=new lf(this.context,ea[s],d,Dc[s],this._showOverdrawInspector,D,j,H,S)),this.cache[J]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const s=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(s.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new i.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){var s,d;if(this._tileTextures){for(const v in this._tileTextures){const S=this._tileTextures[v];if(S)for(const D of S)D.destroy()}this._tileTextures={}}if(this.tileExtentBuffer&&this.tileExtentBuffer.destroy(),this.debugBuffer&&this.debugBuffer.destroy(),this.rasterBoundsBuffer&&this.rasterBoundsBuffer.destroy(),this.rasterBoundsBufferPosOnly&&this.rasterBoundsBufferPosOnly.destroy(),this.viewportBuffer&&this.viewportBuffer.destroy(),this.tileBorderIndexBuffer&&this.tileBorderIndexBuffer.destroy(),this.quadTriangleIndexBuffer&&this.quadTriangleIndexBuffer.destroy(),this.tileExtentMesh&&((s=this.tileExtentMesh.vertexBuffer)===null||s===void 0||s.destroy()),this.tileExtentMesh&&((d=this.tileExtentMesh.indexBuffer)===null||d===void 0||d.destroy()),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.cache){for(const v in this.cache){const S=this.cache[v];S&&S.program&&this.context.gl.deleteProgram(S.program)}this.cache={}}this.context&&this.context.setDefault()}overLimit(){const{drawingBufferWidth:s,drawingBufferHeight:d}=this.context.gl;return this.width!==s||this.height!==d}}function td(C,s){let d,v=!1,S=null,D=null;const k=()=>{S=null,v&&(C.apply(D,d),S=setTimeout(k,s),v=!1)};return(...j)=>(v=!0,D=this,d=j,S||k(),S)}class nh{constructor(s){this._getCurrentHash=()=>{const d=window.location.hash.replace("#","");if(this._hashName){let v;return d.split("&").map(S=>S.split("=")).forEach(S=>{S[0]===this._hashName&&(v=S)}),(v&&v[1]||"").split("/")}return d.split("/")},this._onHashChange=()=>{const d=this._getCurrentHash();if(!this._isValidHash(d))return!1;const v=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(d[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+d[2],+d[1]],zoom:+d[0],bearing:v,pitch:+(d[4]||0)}),!0},this._updateHashUnthrottled=()=>{const d=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,d)},this._removeHash=()=>{const d=this._getCurrentHash();if(d.length===0)return;const v=d.join("/");let S=v;S.split("&").length>0&&(S=S.split("&")[0]),this._hashName&&(S=`${this._hashName}=${v}`);let D=window.location.hash.replace(S,"");D.startsWith("#&")?D=D.slice(0,1)+D.slice(2):D==="#"&&(D="");let k=window.location.href.replace(/(#.+)?$/,D);k=k.replace("&&","&"),window.history.replaceState(window.history.state,null,k)},this._updateHash=td(this._updateHashUnthrottled,300),this._hashName=s&&encodeURIComponent(s)}addTo(s){return this._map=s,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(s){const d=this._map.getCenter(),v=Math.round(100*this._map.getZoom())/100,S=Math.ceil((v*Math.LN2+Math.log(512/360/.5))/Math.LN10),D=Math.pow(10,S),k=Math.round(d.lng*D)/D,j=Math.round(d.lat*D)/D,H=this._map.getBearing(),J=this._map.getPitch();let et="";if(et+=s?`/${k}/${j}/${v}`:`${v}/${j}/${k}`,(H||J)&&(et+="/"+Math.round(10*H)/10),J&&(et+=`/${Math.round(J)}`),this._hashName){const mt=this._hashName;let ut=!1;const St=window.location.hash.slice(1).split("&").map(pt=>{const Et=pt.split("=")[0];return Et===mt?(ut=!0,`${Et}=${et}`):pt}).filter(pt=>pt);return ut||St.push(`${mt}=${et}`),`#${St.join("&")}`}return`#${et}`}_isValidHash(s){if(s.length<3||s.some(isNaN))return!1;try{new i.V(+s[2],+s[1])}catch{return!1}const d=+s[0],v=+(s[3]||0),S=+(s[4]||0);return d>=this._map.getMinZoom()&&d<=this._map.getMaxZoom()&&v>=-180&&v<=180&&S>=this._map.getMinPitch()&&S<=this._map.getMaxPitch()}}const Vh={linearity:.3,easing:i.cv(0,0,.3,1)},pf=i.e({deceleration:2500,maxSpeed:1400},Vh),ed=i.e({deceleration:20,maxSpeed:1400},Vh),Uh=i.e({deceleration:1e3,maxSpeed:360},Vh),_u=i.e({deceleration:1e3,maxSpeed:90},Vh),dl=i.e({deceleration:1e3,maxSpeed:360},Vh);class pl{constructor(s){this._map=s,this.clear()}clear(){this._inertiaBuffer=[]}record(s){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:Ri(),settings:s})}_drainInertiaBuffer(){const s=this._inertiaBuffer,d=Ri();for(;s.length>0&&d-s[0].time>160;)s.shift()}_onMoveEnd(s){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const d={zoom:0,bearing:0,pitch:0,roll:0,pan:new i.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:D}of this._inertiaBuffer)d.zoom+=D.zoomDelta||0,d.bearing+=D.bearingDelta||0,d.pitch+=D.pitchDelta||0,d.roll+=D.rollDelta||0,D.panDelta&&d.pan._add(D.panDelta),D.around&&(d.around=D.around),D.pinchAround&&(d.pinchAround=D.pinchAround);const v=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,S={};if(d.pan.mag()){const D=kc(d.pan.mag(),v,i.e({},pf,s||{})),k=d.pan.mult(D.amount/d.pan.mag()),j=this._map.cameraHelper.handlePanInertia(k,this._map.transform);S.center=j.easingCenter,S.offset=j.easingOffset,qs(S,D)}if(d.zoom){const D=kc(d.zoom,v,ed);S.zoom=this._map.transform.zoom+D.amount,qs(S,D)}if(d.bearing){const D=kc(d.bearing,v,Uh);S.bearing=this._map.transform.bearing+i.an(D.amount,-179,179),qs(S,D)}if(d.pitch){const D=kc(d.pitch,v,_u);S.pitch=this._map.transform.pitch+D.amount,qs(S,D)}if(d.roll){const D=kc(d.roll,v,dl);S.roll=this._map.transform.roll+i.an(D.amount,-179,179),qs(S,D)}if(S.zoom||S.bearing){const D=d.pinchAround===void 0?d.around:d.pinchAround;S.around=D?this._map.unproject(D):this._map.getCenter()}return this.clear(),i.e(S,{noMoveStart:!0})}}function qs(C,s){(!C.duration||C.duration<s.duration)&&(C.duration=s.duration,C.easing=s.easing)}function kc(C,s,d){const{maxSpeed:v,linearity:S,deceleration:D}=d,k=i.an(C*S/(s/1e3),-v,v),j=Math.abs(k)/(D*S);return{easing:d.easing,duration:1e3*j,amount:k*(j/2)}}class Yo extends i.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,v,S={}){v=v instanceof MouseEvent?v:new MouseEvent(s,v);const D=Ve.mousePos(d.getCanvas(),v),k=d.unproject(D);super(s,i.e({point:D,lngLat:k,originalEvent:v},S)),this._defaultPrevented=!1,this.target=d}}class yu extends i.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,v){const S=s==="touchend"?v.changedTouches:v.touches,D=Ve.touchPos(d.getCanvasContainer(),S),k=D.map(H=>d.unproject(H)),j=D.reduce((H,J,et,mt)=>H.add(J.div(mt.length)),new i.P(0,0));super(s,{points:D,point:j,lngLats:k,lngLat:d.unproject(j),originalEvent:v}),this._defaultPrevented=!1}}class oh extends i.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,v){super(s,{originalEvent:v}),this._defaultPrevented=!1}}class Vd{constructor(s,d){this._map=s,this._clickTolerance=d.clickTolerance}reset(){delete this._mousedownPos}wheel(s){return this._firePreventable(new oh(s.type,this._map,s))}mousedown(s,d){return this._mousedownPos=d,this._firePreventable(new Yo(s.type,this._map,s))}mouseup(s){this._map.fire(new Yo(s.type,this._map,s))}click(s,d){this._mousedownPos&&this._mousedownPos.dist(d)>=this._clickTolerance||this._map.fire(new Yo(s.type,this._map,s))}dblclick(s){return this._firePreventable(new Yo(s.type,this._map,s))}mouseover(s){this._map.fire(new Yo(s.type,this._map,s))}mouseout(s){this._map.fire(new Yo(s.type,this._map,s))}touchstart(s){return this._firePreventable(new yu(s.type,this._map,s))}touchmove(s){this._map.fire(new yu(s.type,this._map,s))}touchend(s){this._map.fire(new yu(s.type,this._map,s))}touchcancel(s){this._map.fire(new yu(s.type,this._map,s))}_firePreventable(s){if(this._map.fire(s),s.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class wp{constructor(s){this._map=s}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(s){this._map.fire(new Yo(s.type,this._map,s))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Yo("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(s){this._delayContextMenu?this._contextMenuEvent=s:this._ignoreContextMenu||this._map.fire(new Yo(s.type,this._map,s)),this._map.listens("contextmenu")&&s.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Fc{constructor(s){this._map=s}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(s){return this.transform.screenPointToLocation(i.P.convert(s),this._map.terrain)}}class Ud{constructor(s,d){this._map=s,this._tr=new Fc(s),this._el=s.getCanvasContainer(),this._container=s.getContainer(),this._clickTolerance=d.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(s,d){this.isEnabled()&&s.shiftKey&&s.button===0&&(Ve.disableDrag(),this._startPos=this._lastPos=d,this._active=!0)}mousemoveWindow(s,d){if(!this._active)return;const v=d;if(this._lastPos.equals(v)||!this._box&&v.dist(this._startPos)<this._clickTolerance)return;const S=this._startPos;this._lastPos=v,this._box||(this._box=Ve.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",s));const D=Math.min(S.x,v.x),k=Math.max(S.x,v.x),j=Math.min(S.y,v.y),H=Math.max(S.y,v.y);Ve.setTransform(this._box,`translate(${D}px,${j}px)`),this._box.style.width=k-D+"px",this._box.style.height=H-j+"px"}mouseupWindow(s,d){if(!this._active||s.button!==0)return;const v=this._startPos,S=d;if(this.reset(),Ve.suppressClick(),v.x!==S.x||v.y!==S.y)return this._map.fire(new i.l("boxzoomend",{originalEvent:s})),{cameraAnimation:D=>D.fitScreenCoordinates(v,S,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",s)}keydown(s){this._active&&s.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",s))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(Ve.remove(this._box),this._box=null),Ve.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(s,d){return this._map.fire(new i.l(s,{originalEvent:d}))}}function xu(C,s){if(C.length!==s.length)throw new Error(`The number of touches and points are not equal - touches ${C.length}, points ${s.length}`);const d={};for(let v=0;v<C.length;v++)d[C[v].identifier]=s[v];return d}class id{constructor(s){this.reset(),this.numTouches=s.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(s,d,v){(this.centroid||v.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=s.timeStamp),v.length===this.numTouches&&(this.centroid=function(S){const D=new i.P(0,0);for(const k of S)D._add(k);return D.div(S.length)}(d),this.touches=xu(v,d)))}touchmove(s,d,v){if(this.aborted||!this.centroid)return;const S=xu(v,d);for(const D in this.touches){const k=S[D];(!k||k.dist(this.touches[D])>30)&&(this.aborted=!0)}}touchend(s,d,v){if((!this.centroid||s.timeStamp-this.startTime>500)&&(this.aborted=!0),v.length===0){const S=!this.aborted&&this.centroid;if(this.reset(),S)return S}}}class Yl{constructor(s){this.singleTap=new id(s),this.numTaps=s.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(s,d,v){this.singleTap.touchstart(s,d,v)}touchmove(s,d,v){this.singleTap.touchmove(s,d,v)}touchend(s,d,v){const S=this.singleTap.touchend(s,d,v);if(S){const D=s.timeStamp-this.lastTime<500,k=!this.lastTap||this.lastTap.dist(S)<30;if(D&&k||this.reset(),this.count++,this.lastTime=s.timeStamp,this.lastTap=S,this.count===this.numTaps)return this.reset(),S}}}class Ki{constructor(s){this._tr=new Fc(s),this._zoomIn=new Yl({numTouches:1,numTaps:2}),this._zoomOut=new Yl({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(s,d,v){this._zoomIn.touchstart(s,d,v),this._zoomOut.touchstart(s,d,v)}touchmove(s,d,v){this._zoomIn.touchmove(s,d,v),this._zoomOut.touchmove(s,d,v)}touchend(s,d,v){const S=this._zoomIn.touchend(s,d,v),D=this._zoomOut.touchend(s,d,v),k=this._tr;return S?(this._active=!0,s.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:j=>j.easeTo({duration:300,zoom:k.zoom+1,around:k.unproject(S)},{originalEvent:s})}):D?(this._active=!0,s.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:j=>j.easeTo({duration:300,zoom:k.zoom-1,around:k.unproject(D)},{originalEvent:s})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class vu{constructor(s){this._enabled=!!s.enable,this._moveStateManager=s.moveStateManager,this._clickTolerance=s.clickTolerance||1,this._moveFunction=s.move,this._activateOnStart=!!s.activateOnStart,s.assignEvents(this),this.reset()}reset(s){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(s)}_move(...s){const d=this._moveFunction(...s);if(d.bearingDelta||d.pitchDelta||d.rollDelta||d.around||d.panDelta)return this._active=!0,d}dragStart(s,d){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(s)&&(this._moveStateManager.startMove(s),this._lastPoint=Array.isArray(d)?d[0]:d,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(s,d){if(!this.isEnabled())return;const v=this._lastPoint;if(!v)return;if(s.preventDefault(),!this._moveStateManager.isValidMoveEvent(s))return void this.reset(s);const S=Array.isArray(d)?d[0]:d;return!this._moved&&S.dist(v)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=S,this._move(v,S))}dragEnd(s){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(s)&&(this._moved&&Ve.suppressClick(),this.reset(s))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const Tp=0,Wf=2,jd={[Tp]:1,[Wf]:2};class sh{constructor(s){this._correctEvent=s.checkCorrectEvent}startMove(s){const d=Ve.mouseButton(s);this._eventButton=d}endMove(s){delete this._eventButton}isValidStartEvent(s){return this._correctEvent(s)}isValidMoveEvent(s){return!function(d,v){const S=jd[v];return d.buttons===void 0||(d.buttons&S)!==S}(s,this._eventButton)}isValidEndEvent(s){return Ve.mouseButton(s)===this._eventButton}}class rd{constructor(){this._firstTouch=void 0}_isOneFingerTouch(s){return s.targetTouches.length===1}_isSameTouchEvent(s){return s.targetTouches[0].identifier===this._firstTouch}startMove(s){this._firstTouch=s.targetTouches[0].identifier}endMove(s){delete this._firstTouch}isValidStartEvent(s){return this._isOneFingerTouch(s)}isValidMoveEvent(s){return this._isOneFingerTouch(s)&&this._isSameTouchEvent(s)}isValidEndEvent(s){return this._isOneFingerTouch(s)&&this._isSameTouchEvent(s)}}class ff{constructor(s=new sh({checkCorrectEvent:()=>!0}),d=new rd){this.mouseMoveStateManager=s,this.oneFingerTouchMoveStateManager=d}_executeRelevantHandler(s,d,v){return s instanceof MouseEvent?d(s):typeof TouchEvent<"u"&&s instanceof TouchEvent?v(s):void 0}startMove(s){this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.startMove(d),d=>this.oneFingerTouchMoveStateManager.startMove(d))}endMove(s){this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.endMove(d),d=>this.oneFingerTouchMoveStateManager.endMove(d))}isValidStartEvent(s){return this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.isValidStartEvent(d),d=>this.oneFingerTouchMoveStateManager.isValidStartEvent(d))}isValidMoveEvent(s){return this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.isValidMoveEvent(d),d=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(d))}isValidEndEvent(s){return this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.isValidEndEvent(d),d=>this.oneFingerTouchMoveStateManager.isValidEndEvent(d))}}const jh=C=>{C.mousedown=C.dragStart,C.mousemoveWindow=C.dragMove,C.mouseup=C.dragEnd,C.contextmenu=s=>{s.preventDefault()}};class mf{constructor(s,d){this._clickTolerance=s.clickTolerance||1,this._map=d,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new i.P(0,0)}_shouldBePrevented(s){return s<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(s,d,v){return this._calculateTransform(s,d,v)}touchmove(s,d,v){if(this._active){if(!this._shouldBePrevented(v.length))return s.preventDefault(),this._calculateTransform(s,d,v);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",s)}}touchend(s,d,v){this._calculateTransform(s,d,v),this._active&&this._shouldBePrevented(v.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(s,d,v){v.length>0&&(this._active=!0);const S=xu(v,d),D=new i.P(0,0),k=new i.P(0,0);let j=0;for(const J in S){const et=S[J],mt=this._touches[J];mt&&(D._add(et),k._add(et.sub(mt)),j++,S[J]=et)}if(this._touches=S,this._shouldBePrevented(j)||!k.mag())return;const H=k.div(j);return this._sum._add(H),this._sum.mag()<this._clickTolerance?void 0:{around:D.div(j),panDelta:H}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Bc{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(s,d,v){this._firstTwoTouches||v.length<2||(this._firstTwoTouches=[v[0].identifier,v[1].identifier],this._start([d[0],d[1]]))}touchmove(s,d,v){if(!this._firstTwoTouches)return;s.preventDefault();const[S,D]=this._firstTwoTouches,k=nd(v,d,S),j=nd(v,d,D);if(!k||!j)return;const H=this._aroundCenter?null:k.add(j).div(2);return this._move([k,j],H,s)}touchend(s,d,v){if(!this._firstTwoTouches)return;const[S,D]=this._firstTwoTouches,k=nd(v,d,S),j=nd(v,d,D);k&&j||(this._active&&Ve.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(s){this._enabled=!0,this._aroundCenter=!!s&&s.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function nd(C,s,d){for(let v=0;v<C.length;v++)if(C[v].identifier===d)return s[v]}function Sp(C,s){return Math.log(C/s)/Math.LN2}class gf extends Bc{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(s){this._startDistance=this._distance=s[0].dist(s[1])}_move(s,d){const v=this._distance;if(this._distance=s[0].dist(s[1]),this._active||!(Math.abs(Sp(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Sp(this._distance,v),pinchAround:d}}}function Gd(C,s){return 180*C.angleWith(s)/Math.PI}class dc extends Bc{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(s){this._startVector=this._vector=s[0].sub(s[1]),this._minDiameter=s[0].dist(s[1])}_move(s,d,v){const S=this._vector;if(this._vector=s[0].sub(s[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Gd(this._vector,S),pinchAround:d}}_isBelowThreshold(s){this._minDiameter=Math.min(this._minDiameter,s.mag());const d=25/(Math.PI*this._minDiameter)*360,v=Gd(s,this._startVector);return Math.abs(v)<d}}function bu(C){return Math.abs(C.y)>Math.abs(C.x)}class od extends Bc{constructor(s){super(),this._currentTouchCount=0,this._map=s}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(s,d,v){super.touchstart(s,d,v),this._currentTouchCount=v.length}_start(s){this._lastPoints=s,bu(s[0].sub(s[1]))&&(this._valid=!1)}_move(s,d,v){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const S=s[0].sub(this._lastPoints[0]),D=s[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(S,D,v.timeStamp),this._valid?(this._lastPoints=s,this._active=!0,{pitchDelta:(S.y+D.y)/2*-.5}):void 0}gestureBeginsVertically(s,d,v){if(this._valid!==void 0)return this._valid;const S=s.mag()>=2,D=d.mag()>=2;if(!S&&!D)return;if(!S||!D)return this._firstMove===void 0&&(this._firstMove=v),v-this._firstMove<100&&void 0;const k=s.y>0==d.y>0;return bu(s)&&bu(d)&&k}}const wu={panStep:100,bearingStep:15,pitchStep:10};class ah{constructor(s){this._tr=new Fc(s);const d=wu;this._panStep=d.panStep,this._bearingStep=d.bearingStep,this._pitchStep=d.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(s){if(s.altKey||s.ctrlKey||s.metaKey)return;let d=0,v=0,S=0,D=0,k=0;switch(s.keyCode){case 61:case 107:case 171:case 187:d=1;break;case 189:case 109:case 173:d=-1;break;case 37:s.shiftKey?v=-1:(s.preventDefault(),D=-1);break;case 39:s.shiftKey?v=1:(s.preventDefault(),D=1);break;case 38:s.shiftKey?S=1:(s.preventDefault(),k=-1);break;case 40:s.shiftKey?S=-1:(s.preventDefault(),k=1);break;default:return}return this._rotationDisabled&&(v=0,S=0),{cameraAnimation:j=>{const H=this._tr;j.easeTo({duration:300,easeId:"keyboardHandler",easing:Oc,zoom:d?Math.round(H.zoom)+d*(s.shiftKey?2:1):H.zoom,bearing:H.bearing+v*this._bearingStep,pitch:H.pitch+S*this._pitchStep,offset:[-D*this._panStep,-k*this._panStep],center:H.center},{originalEvent:s})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Oc(C){return C*(2-C)}const uo=4.000244140625,_f=1/450;class Tu{constructor(s,d){this._onTimeout=v=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(v)},this._map=s,this._tr=new Fc(s),this._triggerRenderFrame=d,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=_f}setZoomRate(s){this._defaultZoomRate=s}setWheelZoomRate(s){this._wheelZoomRate=s}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(s){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!s&&s.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(s){return!!this._map.cooperativeGestures.isEnabled()&&!(s.ctrlKey||this._map.cooperativeGestures.isBypassed(s))}wheel(s){if(!this.isEnabled())return;if(this._shouldBePrevented(s))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",s);let d=s.deltaMode===WheelEvent.DOM_DELTA_LINE?40*s.deltaY:s.deltaY;const v=Ri(),S=v-(this._lastWheelEventTime||0);this._lastWheelEventTime=v,d!==0&&d%uo==0?this._type="wheel":d!==0&&Math.abs(d)<4?this._type="trackpad":S>400?(this._type=null,this._lastValue=d,this._timeout=setTimeout(this._onTimeout,40,s)):this._type||(this._type=Math.abs(S*d)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,d+=this._lastValue)),s.shiftKey&&d&&(d/=4),this._type&&(this._lastWheelEvent=s,this._delta-=d,this._active||this._start(s)),s.preventDefault()}_start(s){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const d=Ve.mousePos(this._map.getCanvas(),s),v=this._tr;this._aroundPoint=this._aroundCenter?v.transform.locationToScreenPoint(i.V.convert(v.center)):d,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const s=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const j=s.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=j),typeof this._targetZoom=="number"&&(this._targetZoom+=j)}if(this._delta!==0){const j=this._type==="wheel"&&Math.abs(this._delta)>uo?this._wheelZoomRate:this._defaultZoomRate;let H=2/(1+Math.exp(-Math.abs(this._delta*j)));this._delta<0&&H!==0&&(H=1/H);const J=typeof this._targetZoom!="number"?s.scale:i.aq(this._targetZoom);this._targetZoom=s.applyConstrain(s.getCameraLngLat(),i.at(J*H)).zoom,this._type==="wheel"&&(this._startZoom=s.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const d=typeof this._targetZoom!="number"?s.zoom:this._targetZoom,v=this._startZoom,S=this._easing;let D,k=!1;if(this._type==="wheel"&&v&&S){const j=Ri()-this._lastWheelEventTime,H=Math.min((j+5)/200,1),J=S(H);D=i.G.number(v,d,J),H<1?this._frameId||(this._frameId=!0):k=!0}else D=d,k=!0;return this._active=!0,k&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout},200)),this._lastExpectedZoom=D,{noInertia:!0,needsRenderFrame:!k,zoomDelta:D-s.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(s){let d=i.cx;if(this._prevEase){const v=this._prevEase,S=(Ri()-v.start)/v.duration,D=v.easing(S+.01)-v.easing(S),k=.27/Math.sqrt(D*D+1e-4)*.01,j=Math.sqrt(.0729-k*k);d=i.cv(k,j,.25,1)}return this._prevEase={start:Ri(),duration:s,easing:d},d}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Gh{constructor(s,d){this._clickZoom=s,this._tapZoom=d}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class sd{constructor(s){this._tr=new Fc(s),this.reset()}reset(){this._active=!1}dblclick(s,d){return s.preventDefault(),{cameraAnimation:v=>{v.easeTo({duration:300,zoom:this._tr.zoom+(s.shiftKey?-1:1),around:this._tr.unproject(d)},{originalEvent:s})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ip{constructor(){this._tap=new Yl({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(s,d,v){if(!this._swipePoint)if(this._tapTime){const S=d[0],D=s.timeStamp-this._tapTime<500,k=this._tapPoint.dist(S)<30;D&&k?v.length>0&&(this._swipePoint=S,this._swipeTouch=v[0].identifier):this.reset()}else this._tap.touchstart(s,d,v)}touchmove(s,d,v){if(this._tapTime){if(this._swipePoint){if(v[0].identifier!==this._swipeTouch)return;const S=d[0],D=S.y-this._swipePoint.y;return this._swipePoint=S,s.preventDefault(),this._active=!0,{zoomDelta:D/128}}}else this._tap.touchmove(s,d,v)}touchend(s,d,v){if(this._tapTime)this._swipePoint&&v.length===0&&this.reset();else{const S=this._tap.touchend(s,d,v);S&&(this._tapTime=s.timeStamp,this._tapPoint=S)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ad{constructor(s,d,v){this._el=s,this._mousePan=d,this._touchPan=v}enable(s){this._inertiaOptions=s||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class $h{constructor(s,d,v,S){this._pitchWithRotate=s.pitchWithRotate,this._rollEnabled=s.rollEnabled,this._mouseRotate=d,this._mousePitch=v,this._mouseRoll=S}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class Xf{constructor(s,d,v,S){this._el=s,this._touchZoom=d,this._touchRotate=v,this._tapDragZoom=S,this._rotationDisabled=!1,this._enabled=!0}enable(s){this._touchZoom.enable(s),this._rotationDisabled||this._touchRotate.enable(s),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class la{constructor(s,d){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=s,this._options=d,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const s=this._map.getCanvasContainer();s.classList.add("maplibregl-cooperative-gestures"),this._container=Ve.create("div","maplibregl-cooperative-gesture-screen",s);let d=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(d=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const v=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),S=document.createElement("div");S.className="maplibregl-desktop-message",S.textContent=d,this._container.appendChild(S);const D=document.createElement("div");D.className="maplibregl-mobile-message",D.textContent=v,this._container.appendChild(D),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(Ve.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(s){return s[this._bypassKey]}notifyGestureBlocked(s,d){this._enabled&&(this._map.fire(new i.l("cooperativegestureprevented",{gestureType:s,originalEvent:d})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const qh=C=>C.zoom||C.drag||C.roll||C.pitch||C.rotate;class xr extends i.l{}function zr(C){return C.panDelta&&C.panDelta.mag()||C.zoomDelta||C.bearingDelta||C.pitchDelta||C.rollDelta}class Zh{constructor(s,d){this.handleWindowEvent=S=>{this.handleEvent(S,`${S.type}Window`)},this.handleEvent=(S,D)=>{if(S.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const k=S.type==="renderFrame"?void 0:S,j={needsRenderFrame:!1},H={},J={};for(const{handlerName:ut,handler:St,allowed:pt}of this._handlers){if(!St.isEnabled())continue;let Et;if(this._blockedByActive(J,pt,ut))St.reset();else if(St[D||S.type]){if(i.cy(S,D||S.type)){const Kt=Ve.mousePos(this._map.getCanvas(),S);Et=St[D||S.type](S,Kt)}else if(i.cz(S,D||S.type)){const Kt=this._getMapTouches(S.touches),Xt=Ve.touchPos(this._map.getCanvas(),Kt);Et=St[D||S.type](S,Xt,Kt)}else i.cA(D||S.type)||(Et=St[D||S.type](S));this.mergeHandlerResult(j,H,Et,ut,k),Et&&Et.needsRenderFrame&&this._triggerRenderFrame()}(Et||St.isActive())&&(J[ut]=St)}const et={};for(const ut in this._previousActiveHandlers)J[ut]||(et[ut]=k);this._previousActiveHandlers=J,(Object.keys(et).length||zr(j))&&(this._changes.push([j,H,et]),this._triggerRenderFrame()),(Object.keys(J).length||zr(j))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:mt}=j;mt&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],mt(this._map))},this._map=s,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new pl(s),this._bearingSnap=d.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(d);const v=this._el;this._listeners=[[v,"touchstart",{passive:!0}],[v,"touchmove",{passive:!1}],[v,"touchend",void 0],[v,"touchcancel",void 0],[v,"mousedown",void 0],[v,"mousemove",void 0],[v,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[v,"mouseover",void 0],[v,"mouseout",void 0],[v,"dblclick",void 0],[v,"click",void 0],[v,"keydown",{capture:!1}],[v,"keyup",void 0],[v,"wheel",{passive:!1}],[v,"contextmenu",void 0],[window,"blur",void 0]];for(const[S,D,k]of this._listeners)Ve.addEventListener(S,D,S===document?this.handleWindowEvent:this.handleEvent,k)}destroy(){for(const[s,d,v]of this._listeners)Ve.removeEventListener(s,d,s===document?this.handleWindowEvent:this.handleEvent,v)}_addDefaultHandlers(s){const d=this._map,v=d.getCanvasContainer();this._add("mapEvent",new Vd(d,s));const S=d.boxZoom=new Ud(d,s);this._add("boxZoom",S),s.interactive&&s.boxZoom&&S.enable();const D=d.cooperativeGestures=new la(d,s.cooperativeGestures);this._add("cooperativeGestures",D),s.cooperativeGestures&&D.enable();const k=new Ki(d),j=new sd(d);d.doubleClickZoom=new Gh(j,k),this._add("tapZoom",k),this._add("clickZoom",j),s.interactive&&s.doubleClickZoom&&d.doubleClickZoom.enable();const H=new Ip;this._add("tapDragZoom",H);const J=d.touchPitch=new od(d);this._add("touchPitch",J),s.interactive&&s.touchPitch&&d.touchPitch.enable(s.touchPitch);const et=()=>d.project(d.getCenter()),mt=function({enable:ce,clickTolerance:me,aroundCenter:be=!0,minPixelCenterThreshold:de=100,rotateDegreesPerPixelMoved:De=.8},Qe){const Xe=new sh({checkCorrectEvent:Je=>Ve.mouseButton(Je)===0&&Je.ctrlKey||Ve.mouseButton(Je)===2&&!Je.ctrlKey});return new vu({clickTolerance:me,move:(Je,ii)=>{const Di=Qe();if(be&&Math.abs(Di.y-Je.y)>de)return{bearingDelta:i.cw(new i.P(Je.x,ii.y),ii,Di)};let Fi=(ii.x-Je.x)*De;return be&&ii.y<Di.y&&(Fi=-Fi),{bearingDelta:Fi}},moveStateManager:Xe,enable:ce,assignEvents:jh})}(s,et),ut=function({enable:ce,clickTolerance:me,pitchDegreesPerPixelMoved:be=-.5}){const de=new sh({checkCorrectEvent:De=>Ve.mouseButton(De)===0&&De.ctrlKey||Ve.mouseButton(De)===2});return new vu({clickTolerance:me,move:(De,Qe)=>({pitchDelta:(Qe.y-De.y)*be}),moveStateManager:de,enable:ce,assignEvents:jh})}(s),St=function({enable:ce,clickTolerance:me,rollDegreesPerPixelMoved:be=.3},de){const De=new sh({checkCorrectEvent:Qe=>Ve.mouseButton(Qe)===2&&Qe.ctrlKey});return new vu({clickTolerance:me,move:(Qe,Xe)=>{const Je=de();let ii=(Xe.x-Qe.x)*be;return Xe.y<Je.y&&(ii=-ii),{rollDelta:ii}},moveStateManager:De,enable:ce,assignEvents:jh})}(s,et);d.dragRotate=new $h(s,mt,ut,St),this._add("mouseRotate",mt,["mousePitch"]),this._add("mousePitch",ut,["mouseRotate","mouseRoll"]),this._add("mouseRoll",St,["mousePitch"]),s.interactive&&s.dragRotate&&d.dragRotate.enable();const pt=function({enable:ce,clickTolerance:me}){const be=new sh({checkCorrectEvent:de=>Ve.mouseButton(de)===0&&!de.ctrlKey});return new vu({clickTolerance:me,move:(de,De)=>({around:De,panDelta:De.sub(de)}),activateOnStart:!0,moveStateManager:be,enable:ce,assignEvents:jh})}(s),Et=new mf(s,d);d.dragPan=new ad(v,pt,Et),this._add("mousePan",pt),this._add("touchPan",Et,["touchZoom","touchRotate"]),s.interactive&&s.dragPan&&d.dragPan.enable(s.dragPan);const Kt=new dc,Xt=new gf;d.touchZoomRotate=new Xf(v,Xt,Kt,H),this._add("touchRotate",Kt,["touchPan","touchZoom"]),this._add("touchZoom",Xt,["touchPan","touchRotate"]),s.interactive&&s.touchZoomRotate&&d.touchZoomRotate.enable(s.touchZoomRotate),this._add("blockableMapEvent",new wp(d));const ft=d.scrollZoom=new Tu(d,()=>this._triggerRenderFrame());this._add("scrollZoom",ft,["mousePan"]),s.interactive&&s.scrollZoom&&d.scrollZoom.enable(s.scrollZoom);const _e=d.keyboard=new ah(d);this._add("keyboard",_e),s.interactive&&s.keyboard&&d.keyboard.enable()}_add(s,d,v){this._handlers.push({handlerName:s,handler:d,allowed:v}),this._handlersById[s]=d}stop(s){if(!this._updatingCamera){for(const{handler:d}of this._handlers)d.reset();this._inertia.clear(),this._fireEvents({},{},s),this._changes=[]}}isActive(){for(const{handler:s}of this._handlers)if(s.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!qh(this._eventsInProgress)||this.isZooming()}_blockedByActive(s,d,v){for(const S in s)if(S!==v&&(!d||d.indexOf(S)<0))return!0;return!1}_getMapTouches(s){const d=[];for(const v of s)this._el.contains(v.target)&&d.push(v);return d}mergeHandlerResult(s,d,v,S,D){if(!v)return;i.e(s,v);const k={handlerName:S,originalEvent:v.originalEvent||D};v.zoomDelta!==void 0&&(d.zoom=k),v.panDelta!==void 0&&(d.drag=k),v.rollDelta!==void 0&&(d.roll=k),v.pitchDelta!==void 0&&(d.pitch=k),v.bearingDelta!==void 0&&(d.rotate=k)}_applyChanges(){const s={},d={},v={};for(const[S,D,k]of this._changes)S.panDelta&&(s.panDelta=(s.panDelta||new i.P(0,0))._add(S.panDelta)),S.zoomDelta&&(s.zoomDelta=(s.zoomDelta||0)+S.zoomDelta),S.bearingDelta&&(s.bearingDelta=(s.bearingDelta||0)+S.bearingDelta),S.pitchDelta&&(s.pitchDelta=(s.pitchDelta||0)+S.pitchDelta),S.rollDelta&&(s.rollDelta=(s.rollDelta||0)+S.rollDelta),S.around!==void 0&&(s.around=S.around),S.pinchAround!==void 0&&(s.pinchAround=S.pinchAround),S.noInertia&&(s.noInertia=S.noInertia),i.e(d,D),i.e(v,k);this._updateMapTransform(s,d,v),this._changes=[]}_updateMapTransform(s,d,v){const S=this._map,D=S._getTransformForUpdate(),k=S.terrain;if(!(zr(s)||k&&this._terrainMovement))return this._fireEvents(d,v,!0);S._stop(!0);let{panDelta:j,zoomDelta:H,bearingDelta:J,pitchDelta:et,rollDelta:mt,around:ut,pinchAround:St}=s;St!==void 0&&(ut=St),ut=ut||S.transform.centerPoint,k&&!D.isPointOnMapSurface(ut)&&(ut=D.centerPoint);const pt={panDelta:j,zoomDelta:H,rollDelta:mt,pitchDelta:et,bearingDelta:J,around:ut};this._map.cameraHelper.useGlobeControls&&!D.isPointOnMapSurface(ut)&&(ut=D.centerPoint);const Et=ut.distSqr(D.centerPoint)<.01?D.center:D.screenPointToLocation(j?ut.sub(j):ut);this._handleMapControls({terrain:k,tr:D,deltasForHelper:pt,preZoomAroundLoc:Et,combinedEventsInProgress:d,panDelta:j}),S._applyUpdatedTransform(D),this._map._update(),s.noInertia||this._inertia.record(s),this._fireEvents(d,v,!0)}_handleMapControls({terrain:s,tr:d,deltasForHelper:v,preZoomAroundLoc:S,combinedEventsInProgress:D,panDelta:k}){const j=this._map.cameraHelper;if(j.handleMapControlsRollPitchBearingZoom(v,d),s)return j.useGlobeControls?(this._terrainMovement||!D.drag&&!D.zoom||(this._terrainMovement=!0,this._map._elevationFreeze=!0),void j.handleMapControlsPan(v,d,S)):this._terrainMovement||!D.drag&&!D.zoom?void(D.drag&&this._terrainMovement&&k?d.setCenter(d.screenPointToLocation(d.centerPoint.sub(k))):j.handleMapControlsPan(v,d,S)):(this._terrainMovement=!0,this._map._elevationFreeze=!0,void j.handleMapControlsPan(v,d,S));j.handleMapControlsPan(v,d,S)}_fireEvents(s,d,v){const S=qh(this._eventsInProgress),D=qh(s),k={};for(const mt in s){const{originalEvent:ut}=s[mt];this._eventsInProgress[mt]||(k[`${mt}start`]=ut),this._eventsInProgress[mt]=s[mt]}!S&&D&&this._fireEvent("movestart",D.originalEvent);for(const mt in k)this._fireEvent(mt,k[mt]);D&&this._fireEvent("move",D.originalEvent);for(const mt in s){const{originalEvent:ut}=s[mt];this._fireEvent(mt,ut)}const j={};let H;for(const mt in this._eventsInProgress){const{handlerName:ut,originalEvent:St}=this._eventsInProgress[mt];this._handlersById[ut].isActive()||(delete this._eventsInProgress[mt],H=d[ut]||St,j[`${mt}end`]=H)}for(const mt in j)this._fireEvent(mt,j[mt]);const J=qh(this._eventsInProgress),et=(S||D)&&!J;if(et&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const mt=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&mt.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(mt)}if(v&&et){this._updatingCamera=!0;const mt=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),ut=St=>St!==0&&-this._bearingSnap<St&&St<this._bearingSnap;!mt||!mt.essential&&Br.prefersReducedMotion?(this._map.fire(new i.l("moveend",{originalEvent:H})),ut(this._map.getBearing())&&this._map.resetNorth()):(ut(mt.bearing||this._map.getBearing())&&(mt.bearing=0),mt.freezeElevation=!0,this._map.easeTo(mt,{originalEvent:H})),this._updatingCamera=!1}}_fireEvent(s,d){this._map.fire(new i.l(s,d?{originalEvent:d}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(s=>{delete this._frameId,this.handleEvent(new xr("renderFrame",{timeStamp:s})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class pc extends i.E{constructor(s,d,v){super(),this._renderFrameCallback=()=>{const S=Math.min((Ri()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(S)),S<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=s,this._bearingSnap=v.bearingSnap,this.cameraHelper=d,this.on("moveend",()=>{delete this._requestedCameraState})}migrateProjection(s,d){s.apply(this.transform),this.transform=s,this.cameraHelper=d}getCenter(){return new i.V(this.transform.center.lng,this.transform.center.lat)}setCenter(s,d){return this.jumpTo({center:s},d)}getCenterElevation(){return this.transform.elevation}setCenterElevation(s,d){return this.jumpTo({elevation:s},d),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(s){this._centerClampedToGround=s}panBy(s,d,v){return s=i.P.convert(s).mult(-1),this.panTo(this.transform.center,i.e({offset:s},d),v)}panTo(s,d,v){return this.easeTo(i.e({center:s},d),v)}getZoom(){return this.transform.zoom}setZoom(s,d){return this.jumpTo({zoom:s},d),this}zoomTo(s,d,v){return this.easeTo(i.e({zoom:s},d),v)}zoomIn(s,d){return this.zoomTo(this.getZoom()+1,s,d),this}zoomOut(s,d){return this.zoomTo(this.getZoom()-1,s,d),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(s,d){return s!=this.transform.fov&&(this.transform.setFov(s),this.fire(new i.l("movestart",d)).fire(new i.l("move",d)).fire(new i.l("moveend",d))),this}getBearing(){return this.transform.bearing}setBearing(s,d){return this.jumpTo({bearing:s},d),this}getPadding(){return this.transform.padding}setPadding(s,d){return this.jumpTo({padding:s},d),this}rotateTo(s,d,v){return this.easeTo(i.e({bearing:s},d),v)}resetNorth(s,d){return this.rotateTo(0,i.e({duration:1e3},s),d),this}resetNorthPitch(s,d){return this.easeTo(i.e({bearing:0,pitch:0,roll:0,duration:1e3},s),d),this}snapToNorth(s,d){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(s,d):this}getPitch(){return this.transform.pitch}setPitch(s,d){return this.jumpTo({pitch:s},d),this}getRoll(){return this.transform.roll}setRoll(s,d){return this.jumpTo({roll:s},d),this}cameraForBounds(s,d){s=lo.convert(s).adjustAntiMeridian();const v=d&&d.bearing||0;return this._cameraForBoxAndBearing(s.getNorthWest(),s.getSouthEast(),v,d)}_cameraForBoxAndBearing(s,d,v,S){const D={top:0,bottom:0,right:0,left:0};if(typeof(S=i.e({padding:D,offset:[0,0],maxZoom:this.transform.maxZoom},S)).padding=="number"){const J=S.padding;S.padding={top:J,bottom:J,right:J,left:J}}const k=i.e(D,S.padding);S.padding=k;const j=this.transform,H=new lo(s,d);return this.cameraHelper.cameraForBoxAndBearing(S,k,H,v,j)}fitBounds(s,d,v){return this._fitInternal(this.cameraForBounds(s,d),d,v)}fitScreenCoordinates(s,d,v,S,D){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(i.P.convert(s)),this.transform.screenPointToLocation(i.P.convert(d)),v,S),S,D)}_fitInternal(s,d,v){return s?(delete(d=i.e(s,d)).padding,d.linear?this.easeTo(d,v):this.flyTo(d,v)):this}jumpTo(s,d){this.stop();const v=this._getTransformForUpdate();let S=!1,D=!1,k=!1;const j=v.zoom;this.cameraHelper.handleJumpToCenterZoom(v,s);const H=v.zoom!==j;return"elevation"in s&&v.elevation!==+s.elevation&&v.setElevation(+s.elevation),"bearing"in s&&v.bearing!==+s.bearing&&(S=!0,v.setBearing(+s.bearing)),"pitch"in s&&v.pitch!==+s.pitch&&(D=!0,v.setPitch(+s.pitch)),"roll"in s&&v.roll!==+s.roll&&(k=!0,v.setRoll(+s.roll)),s.padding==null||v.isPaddingEqual(s.padding)||v.setPadding(s.padding),this._applyUpdatedTransform(v),this.fire(new i.l("movestart",d)).fire(new i.l("move",d)),H&&this.fire(new i.l("zoomstart",d)).fire(new i.l("zoom",d)).fire(new i.l("zoomend",d)),S&&this.fire(new i.l("rotatestart",d)).fire(new i.l("rotate",d)).fire(new i.l("rotateend",d)),D&&this.fire(new i.l("pitchstart",d)).fire(new i.l("pitch",d)).fire(new i.l("pitchend",d)),k&&this.fire(new i.l("rollstart",d)).fire(new i.l("roll",d)).fire(new i.l("rollend",d)),this.fire(new i.l("moveend",d))}calculateCameraOptionsFromTo(s,d,v,S=0){const D=i.aa.fromLngLat(s,d),k=i.aa.fromLngLat(v,S),j=k.x-D.x,H=k.y-D.y,J=k.z-D.z,et=Math.hypot(j,H,J);if(et===0)throw new Error("Can't calculate camera options with same From and To");const mt=Math.hypot(j,H),ut=i.at(this.transform.cameraToCenterDistance/et/this.transform.tileSize),St=180*Math.atan2(j,-H)/Math.PI;let pt=180*Math.acos(mt/et)/Math.PI;return pt=J<0?90-pt:90+pt,{center:k.toLngLat(),elevation:S,zoom:ut,pitch:pt,bearing:St}}calculateCameraOptionsFromCameraLngLatAltRotation(s,d,v,S,D){const k=this.transform.calculateCenterFromCameraLngLatAlt(s,d,v,S);return{center:k.center,elevation:k.elevation,zoom:k.zoom,bearing:v,pitch:S,roll:D}}easeTo(s,d){this._stop(!1,s.easeId),((s=i.e({offset:[0,0],duration:500,easing:i.cx},s)).animate===!1||!s.essential&&Br.prefersReducedMotion)&&(s.duration=0);const v=this._getTransformForUpdate(),S=this.getBearing(),D=v.pitch,k=v.roll,j="bearing"in s?this._normalizeBearing(s.bearing,S):S,H="pitch"in s?+s.pitch:D,J="roll"in s?this._normalizeBearing(s.roll,k):k,et="padding"in s?s.padding:v.padding,mt=i.P.convert(s.offset);let ut,St;s.around&&(ut=i.V.convert(s.around),St=v.locationToScreenPoint(ut));const pt={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},Et=this.cameraHelper.handleEaseTo(v,{bearing:j,pitch:H,roll:J,padding:et,around:ut,aroundPoint:St,offsetAsPoint:mt,offset:s.offset,zoom:s.zoom,center:s.center});return this._rotating=this._rotating||S!==j,this._pitching=this._pitching||H!==D,this._rolling=this._rolling||J!==k,this._padding=!v.isPaddingEqual(et),this._zooming=this._zooming||Et.isZooming,this._easeId=s.easeId,this._prepareEase(d,s.noMoveStart,pt),this.terrain&&this._prepareElevation(Et.elevationCenter),this._ease(Kt=>{Et.easeFunc(Kt),this.terrain&&!s.freezeElevation&&this._updateElevation(Kt),this._applyUpdatedTransform(v),this._fireMoveEvents(d)},Kt=>{this.terrain&&s.freezeElevation&&this._finalizeElevation(),this._afterEase(d,Kt)},s),this}_prepareEase(s,d,v={}){this._moving=!0,d||v.moving||this.fire(new i.l("movestart",s)),this._zooming&&!v.zooming&&this.fire(new i.l("zoomstart",s)),this._rotating&&!v.rotating&&this.fire(new i.l("rotatestart",s)),this._pitching&&!v.pitching&&this.fire(new i.l("pitchstart",s)),this._rolling&&!v.rolling&&this.fire(new i.l("rollstart",s))}_prepareElevation(s){this._elevationCenter=s,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(s,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(s){this._elevationStart!==void 0&&this._elevationCenter!==void 0||this._prepareElevation(this.transform.center),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const d=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(s<1&&d!==this._elevationTarget){const v=this._elevationTarget-this._elevationStart;this._elevationStart+=s*(v-(d-(v*s+this._elevationStart))/(1-s)),this._elevationTarget=d}this.transform.setElevation(i.G.number(this._elevationStart,this._elevationTarget,s))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(s){if(!this.terrain&&s.elevation>=0&&s.pitch<=90)return{};const d=s.getCameraLngLat(),v=s.getCameraAltitude(),S=this.terrain?this.terrain.getElevationForLngLatZoom(d,s.zoom):0;if(v<S){const D=this.calculateCameraOptionsFromTo(d,S,s.center,s.elevation);return{pitch:D.pitch,zoom:D.zoom}}return{}}_applyUpdatedTransform(s){const d=[];if(d.push(S=>this._elevateCameraIfInsideTerrain(S)),this.transformCameraUpdate&&d.push(S=>this.transformCameraUpdate(S)),!d.length)return;const v=s.clone();for(const S of d){const D=v.clone(),{center:k,zoom:j,roll:H,pitch:J,bearing:et,elevation:mt}=S(D);k&&D.setCenter(k),mt!==void 0&&D.setElevation(mt),j!==void 0&&D.setZoom(j),H!==void 0&&D.setRoll(H),J!==void 0&&D.setPitch(J),et!==void 0&&D.setBearing(et),v.apply(D)}this.transform.apply(v)}_fireMoveEvents(s){this.fire(new i.l("move",s)),this._zooming&&this.fire(new i.l("zoom",s)),this._rotating&&this.fire(new i.l("rotate",s)),this._pitching&&this.fire(new i.l("pitch",s)),this._rolling&&this.fire(new i.l("roll",s))}_afterEase(s,d){if(this._easeId&&d&&this._easeId===d)return;delete this._easeId;const v=this._zooming,S=this._rotating,D=this._pitching,k=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,v&&this.fire(new i.l("zoomend",s)),S&&this.fire(new i.l("rotateend",s)),D&&this.fire(new i.l("pitchend",s)),k&&this.fire(new i.l("rollend",s)),this.fire(new i.l("moveend",s))}flyTo(s,d){if(!s.essential&&Br.prefersReducedMotion){const ii=i.U(s,["center","zoom","bearing","pitch","roll","elevation","padding"]);return this.jumpTo(ii,d)}this.stop(),s=i.e({offset:[0,0],speed:1.2,curve:1.42,easing:i.cx},s);const v=this._getTransformForUpdate(),S=v.bearing,D=v.pitch,k=v.roll,j=v.padding,H="bearing"in s?this._normalizeBearing(s.bearing,S):S,J="pitch"in s?+s.pitch:D,et="roll"in s?this._normalizeBearing(s.roll,k):k,mt="padding"in s?s.padding:v.padding,ut=i.P.convert(s.offset);let St=v.centerPoint.add(ut);const pt=v.screenPointToLocation(St),Et=this.cameraHelper.handleFlyTo(v,{bearing:H,pitch:J,roll:et,padding:mt,locationAtOffset:pt,offsetAsPoint:ut,center:s.center,minZoom:s.minZoom,zoom:s.zoom});let Kt=s.curve;const Xt=Math.max(v.width,v.height),ft=Xt/Et.scaleOfZoom,_e=Et.pixelPathLength;typeof Et.scaleOfMinZoom=="number"&&(Kt=Math.sqrt(Xt/Et.scaleOfMinZoom/_e*2));const ce=Kt*Kt;function me(ii){const Di=(ft*ft-Xt*Xt+(ii?-1:1)*ce*ce*_e*_e)/(2*(ii?ft:Xt)*ce*_e);return Math.log(Math.sqrt(Di*Di+1)-Di)}function be(ii){return(Math.exp(ii)-Math.exp(-ii))/2}function de(ii){return(Math.exp(ii)+Math.exp(-ii))/2}const De=me(!1);let Qe=function(ii){return de(De)/de(De+Kt*ii)},Xe=function(ii){return Xt*((de(De)*(be(Di=De+Kt*ii)/de(Di))-be(De))/ce)/_e;var Di},Je=(me(!0)-De)/Kt;if(Math.abs(_e)<2e-6||!isFinite(Je)){if(Math.abs(Xt-ft)<1e-6)return this.easeTo(s,d);const ii=ft<Xt?-1:1;Je=Math.abs(Math.log(ft/Xt))/Kt,Xe=()=>0,Qe=Di=>Math.exp(ii*Kt*Di)}return s.duration="duration"in s?+s.duration:1e3*Je/("screenSpeed"in s?+s.screenSpeed/Kt:+s.speed),s.maxDuration&&s.duration>s.maxDuration&&(s.duration=0),this._zooming=!0,this._rotating=S!==H,this._pitching=J!==D,this._rolling=et!==k,this._padding=!v.isPaddingEqual(mt),this._prepareEase(d,!1),this.terrain&&this._prepareElevation(Et.targetCenter),this._ease(ii=>{const Di=ii*Je,Fi=1/Qe(Di),wi=Xe(Di);this._rotating&&v.setBearing(i.G.number(S,H,ii)),this._pitching&&v.setPitch(i.G.number(D,J,ii)),this._rolling&&v.setRoll(i.G.number(k,et,ii)),this._padding&&(v.interpolatePadding(j,mt,ii),St=v.centerPoint.add(ut)),Et.easeFunc(ii,Fi,wi,St),this.terrain&&!s.freezeElevation&&this._updateElevation(ii),this._applyUpdatedTransform(v),this._fireMoveEvents(d)},()=>{this.terrain&&s.freezeElevation&&this._finalizeElevation(),this._afterEase(d)},s),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(s,d){var v;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const S=this._onEaseEnd;delete this._onEaseEnd,S.call(this,d)}return s||(v=this.handlers)===null||v===void 0||v.stop(!1),this}_ease(s,d,v){v.animate===!1||v.duration===0?(s(1),d()):(this._easeStart=Ri(),this._easeOptions=v,this._onEaseFrame=s,this._onEaseEnd=d,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(s,d){s=i.W(s,-180,180);const v=Math.abs(s-d);return Math.abs(s-360-d)<v&&(s-=360),Math.abs(s+360-d)<v&&(s+=360),s}queryTerrainElevation(s){return this.terrain?this.terrain.getElevationForLngLatZoom(i.V.convert(s),this.transform.tileZoom):null}}const lh={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class cs{constructor(s=lh){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=d=>{!d||d.sourceDataType!=="metadata"&&d.sourceDataType!=="visibility"&&d.dataType!=="style"&&d.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=s}getDefaultPosition(){return"bottom-right"}onAdd(s){return this._map=s,this._compact=this.options.compact,this._container=Ve.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=Ve.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=Ve.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){Ve.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(s,d){const v=this._map._getUIString(`AttributionControl.${d}`);s.title=v,s.setAttribute("aria-label",v)}_updateAttributions(){if(!this._map.style)return;let s=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?s=s.concat(this.options.customAttribution.map(S=>typeof S!="string"?"":S)):typeof this.options.customAttribution=="string"&&s.push(this.options.customAttribution)),this._map.style.stylesheet){const S=this._map.style.stylesheet;this.styleOwner=S.owner,this.styleId=S.id}const d=this._map.style.tileManagers;for(const S in d){const D=d[S];if(D.used||D.usedForTerrain){const k=D.getSource();k.attribution&&s.indexOf(k.attribution)<0&&s.push(k.attribution)}}s=s.filter(S=>String(S).trim()),s.sort((S,D)=>S.length-D.length),s=s.filter((S,D)=>{for(let k=D+1;k<s.length;k++)if(s[k].indexOf(S)>=0)return!1;return!0});const v=s.join(" | ");v!==this._attribHTML&&(this._attribHTML=v,s.length?(this._innerContainer.innerHTML=Ve.sanitize(v),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class fl{constructor(s={}){this._updateCompact=()=>{const d=this._container.children;if(d.length){const v=d[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&v.classList.add("maplibregl-compact"):v.classList.remove("maplibregl-compact")}},this.options=s}getDefaultPosition(){return"bottom-left"}onAdd(s){this._map=s,this._compact=this.options&&this.options.compact,this._container=Ve.create("div","maplibregl-ctrl");const d=Ve.create("a","maplibregl-ctrl-logo");return d.target="_blank",d.rel="noopener nofollow",d.href="https://maplibre.org/",d.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),d.setAttribute("rel","noopener nofollow"),this._container.appendChild(d),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){Ve.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class $d{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(s){const d=++this._id;return this._queue.push({callback:s,id:d,cancelled:!1}),d}remove(s){const d=this._currentlyRunning,v=d?this._queue.concat(d):this._queue;for(const S of v)if(S.id===s)return void(S.cancelled=!0)}run(s=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const d=this._currentlyRunning=this._queue;this._queue=[];for(const v of d)if(!v.cancelled&&(v.callback(s),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var Ep=i.aT([{name:"a_pos3d",type:"Int16",components:3}]);class qd extends i.E{constructor(s){super(),this._lastTilesetChange=Ri(),this.tileManager=s,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=s._source.tileSize*2**this.deltaZoom,s.usedForTerrain=!0,s.tileSize=this.tileSize}destruct(){this.tileManager.usedForTerrain=!1,this.tileManager.tileSize=null}getSource(){return this.tileManager._source}update(s,d){this.tileManager.update(s,d),this._renderableTilesKeys=[];const v={};for(const S of Ae(s,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:d,calculateTileZoom:this.tileManager._source.calculateTileZoom}))v[S.key]=!0,this._renderableTilesKeys.push(S.key),this._tiles[S.key]||(S.terrainRttPosMatrix32f=new Float64Array(16),i.c6(S.terrainRttPosMatrix32f,0,i.a4,i.a4,0,0,1),this._tiles[S.key]=new It(S,this.tileSize),this._lastTilesetChange=Ri());for(const S in this._tiles)v[S]||delete this._tiles[S]}freeRtt(s){for(const d in this._tiles){const v=this._tiles[d];(!s||v.tileID.equals(s)||v.tileID.isChildOf(s)||s.isChildOf(v.tileID))&&(v.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(s=>this.getTileByID(s))}getTileByID(s){return this._tiles[s]}getTerrainCoords(s,d){return d?this._getTerrainCoordsForTileRanges(s,d):this._getTerrainCoordsForRegularTile(s)}_getTerrainCoordsForRegularTile(s){const d={};for(const v of this._renderableTilesKeys){const S=this._tiles[v].tileID,D=s.clone(),k=i.bj();if(S.canonical.equals(s.canonical))i.c6(k,0,i.a4,i.a4,0,0,1);else if(S.canonical.isChildOf(s.canonical)){const j=S.canonical.z-s.canonical.z,H=S.canonical.x-(S.canonical.x>>j<<j),J=S.canonical.y-(S.canonical.y>>j<<j),et=i.a4>>j;i.c6(k,0,et,et,0,0,1),i.O(k,k,[-H*et,-J*et,0])}else{if(!s.canonical.isChildOf(S.canonical))continue;{const j=s.canonical.z-S.canonical.z,H=s.canonical.x-(s.canonical.x>>j<<j),J=s.canonical.y-(s.canonical.y>>j<<j),et=i.a4>>j;i.c6(k,0,i.a4,i.a4,0,0,1),i.O(k,k,[H*et,J*et,0]),i.Q(k,k,[1/2**j,1/2**j,0])}}D.terrainRttPosMatrix32f=new Float32Array(k),d[v]=D}return d}_getTerrainCoordsForTileRanges(s,d){const v={};for(const S of this._renderableTilesKeys){const D=this._tiles[S].tileID;if(!this._isWithinTileRanges(D,d))continue;const k=s.clone(),j=i.bj();if(D.canonical.z===s.canonical.z){const H=s.canonical.x-D.canonical.x,J=s.canonical.y-D.canonical.y;i.c6(j,0,i.a4,i.a4,0,0,1),i.O(j,j,[H*i.a4,J*i.a4,0])}else if(D.canonical.z>s.canonical.z){const H=D.canonical.z-s.canonical.z,J=D.canonical.x-(D.canonical.x>>H<<H),et=D.canonical.y-(D.canonical.y>>H<<H),mt=s.canonical.x-(D.canonical.x>>H),ut=s.canonical.y-(D.canonical.y>>H),St=i.a4>>H;i.c6(j,0,St,St,0,0,1),i.O(j,j,[-J*St+mt*i.a4,-et*St+ut*i.a4,0])}else{const H=s.canonical.z-D.canonical.z,J=s.canonical.x-(s.canonical.x>>H<<H),et=s.canonical.y-(s.canonical.y>>H<<H),mt=(s.canonical.x>>H)-D.canonical.x,ut=(s.canonical.y>>H)-D.canonical.y,St=i.a4<<H;i.c6(j,0,St,St,0,0,1),i.O(j,j,[J*i.a4+mt*St,et*i.a4+ut*St,0])}k.terrainRttPosMatrix32f=new Float32Array(j),v[S]=k}return v}getSourceTile(s,d){const v=this.tileManager._source;let S=s.overscaledZ-this.deltaZoom;if(S>v.maxzoom&&(S=v.maxzoom),S<v.minzoom)return null;this._sourceTileCache[s.key]||(this._sourceTileCache[s.key]=s.scaledTo(S).key);let D=this.tileManager.getTileByID(this._sourceTileCache[s.key]);if((!D||!D.dem)&&d)for(;S>=v.minzoom&&(!D||!D.dem);)D=this.tileManager.getTileByID(s.scaledTo(S--).key);return D}anyTilesAfterTime(s=Date.now()){return this._lastTilesetChange>=s}_isWithinTileRanges(s,d){return d[s.canonical.z]&&s.canonical.x>=d[s.canonical.z].minTileX&&s.canonical.x<=d[s.canonical.z].maxTileX&&s.canonical.y>=d[s.canonical.z].minTileY&&s.canonical.y<=d[s.canonical.z].maxTileY}}class Ap{constructor(s,d,v){this._meshCache={},this.painter=s,this.tileManager=new qd(d),this.options=v,this.exaggeration=typeof v.exaggeration=="number"?v.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(s,d,v,S=i.a4){var D;if(!(d>=0&&d<S&&v>=0&&v<S))return 0;const k=this.getTerrainData(s),j=(D=k.tile)===null||D===void 0?void 0:D.dem;if(!j)return 0;const H=i.cB([],[d/S*i.a4,v/S*i.a4],k.u_terrain_matrix),J=[H[0]*j.dim,H[1]*j.dim],et=Math.floor(J[0]),mt=Math.floor(J[1]),ut=J[0]-et,St=J[1]-mt;return j.get(et,mt)*(1-ut)*(1-St)+j.get(et+1,mt)*ut*(1-St)+j.get(et,mt+1)*(1-ut)*St+j.get(et+1,mt+1)*ut*St}getElevationForLngLatZoom(s,d){if(!i.cC(d,s.wrap()))return 0;const{tileID:v,mercatorX:S,mercatorY:D}=this._getOverscaledTileIDFromLngLatZoom(s,d);return this.getElevation(v,S%i.a4,D%i.a4,i.a4)}getElevation(s,d,v,S=i.a4){return this.getDEMElevation(s,d,v,S)*this.exaggeration}getTerrainData(s){if(!this._emptyDemTexture){const S=this.painter.context,D=new i.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new i.T(S,D,S.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new i.T(S,new i.R({width:1,height:1}),S.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(S.gl.NEAREST,S.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=i.ar([])}const d=this.tileManager.getSourceTile(s,!0);if(d&&d.dem&&(!d.demTexture||d.needsTerrainPrepare)){const S=this.painter.context;d.demTexture=this.painter.getTileTexture(d.dem.stride),d.demTexture?d.demTexture.update(d.dem.getPixels(),{premultiply:!1}):d.demTexture=new i.T(S,d.dem.getPixels(),S.gl.RGBA,{premultiply:!1}),d.demTexture.bind(S.gl.NEAREST,S.gl.CLAMP_TO_EDGE),d.needsTerrainPrepare=!1}const v=d&&d+d.tileID.key+s.key;if(v&&!this._demMatrixCache[v]){const S=this.tileManager.getSource().maxzoom;let D=s.canonical.z-d.tileID.canonical.z;s.overscaledZ>s.canonical.z&&(s.canonical.z>=S?D=s.canonical.z-S:i.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const k=s.canonical.x-(s.canonical.x>>D<<D),j=s.canonical.y-(s.canonical.y>>D<<D),H=i.cD(new Float64Array(16),[1/(i.a4<<D),1/(i.a4<<D),0]);i.O(H,H,[k*i.a4,j*i.a4,0]),this._demMatrixCache[s.key]={matrix:H,coord:s}}return{u_depth:2,u_terrain:3,u_terrain_dim:d&&d.dem&&d.dem.dim||1,u_terrain_matrix:v?this._demMatrixCache[s.key].matrix:this._emptyDemMatrix,u_terrain_unpack:d&&d.dem&&d.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(d&&d.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:d}}getFramebuffer(s){const d=this.painter,v=d.width/devicePixelRatio,S=d.height/devicePixelRatio;return!this._fbo||this._fbo.width===v&&this._fbo.height===S||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new i.T(d.context,{width:v,height:S,data:null},d.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(d.context.gl.NEAREST,d.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new i.T(d.context,{width:v,height:S,data:null},d.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(d.context.gl.NEAREST,d.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=d.context.createFramebuffer(v,S,!0,!1),this._fbo.depthAttachment.set(d.context.createRenderbuffer(d.context.gl.DEPTH_COMPONENT16,v,S))),this._fbo.colorAttachment.set(s==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const s=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const d=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let D=0,k=0;D<this._coordsTextureSize;D++)for(let j=0;j<this._coordsTextureSize;j++,k+=4)d[k+0]=255&j,d[k+1]=255&D,d[k+2]=j>>8<<4|D>>8,d[k+3]=0;const v=new i.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(d.buffer)),S=new i.T(s,v,s.gl.RGBA,{premultiply:!1});return S.bind(s.gl.NEAREST,s.gl.CLAMP_TO_EDGE),this._coordsTexture=S,S}pointCoordinate(s){this.painter.maybeDrawDepthAndCoords(!0);const d=new Uint8Array(4),v=this.painter.context,S=v.gl,D=Math.round(s.x*this.painter.pixelRatio/devicePixelRatio),k=Math.round(s.y*this.painter.pixelRatio/devicePixelRatio),j=Math.round(this.painter.height/devicePixelRatio);v.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),S.readPixels(D,j-k-1,1,1,S.RGBA,S.UNSIGNED_BYTE,d),v.bindFramebuffer.set(null);const H=d[0]+(d[2]>>4<<8),J=d[1]+((15&d[2])<<8),et=this.coordsIndex[255-d[3]],mt=et&&this.tileManager.getTileByID(et);if(!mt)return null;const ut=this._coordsTextureSize,St=(1<<mt.tileID.canonical.z)*ut;return new i.aa((mt.tileID.canonical.x*ut+H)/St+mt.tileID.wrap,(mt.tileID.canonical.y*ut+J)/St,this.getElevation(mt.tileID,H,J,ut))}depthAtPoint(s){const d=new Uint8Array(4),v=this.painter.context,S=v.gl;return v.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),S.readPixels(s.x,this.painter.height/devicePixelRatio-s.y-1,1,1,S.RGBA,S.UNSIGNED_BYTE,d),v.bindFramebuffer.set(null),(d[0]/16777216+d[1]/65536+d[2]/256+d[3])/256}getTerrainMesh(s){var d;const v=((d=this.painter.style.projection)===null||d===void 0?void 0:d.transitionState)>0,S=v&&s.canonical.y===0,D=v&&s.canonical.y===(1<<s.canonical.z)-1,k=`m_${S?"n":""}_${D?"s":""}`;if(this._meshCache[k])return this._meshCache[k];const j=this.painter.context,H=new i.cE,J=new i.aX,et=this.meshSize,mt=i.a4/et,ut=et*et;for(let de=0;de<=et;de++)for(let De=0;De<=et;De++)H.emplaceBack(De*mt,de*mt,0);for(let de=0;de<ut;de+=et+1)for(let De=0;De<et;De++)J.emplaceBack(De+de,et+De+de+1,et+De+de+2),J.emplaceBack(De+de,et+De+de+2,De+de+1);const St=H.length,pt=St+(et+1),Et=(et+1)*et,Kt=S?i.bq:0,Xt=S?0:1,ft=D?i.br:i.a4,_e=D?0:1;for(let de=0;de<=et;de++)H.emplaceBack(de*mt,Kt,Xt);for(let de=0;de<=et;de++)H.emplaceBack(de*mt,ft,_e);for(let de=0;de<et;de++)J.emplaceBack(Et+de,pt+de,pt+de+1),J.emplaceBack(Et+de,pt+de+1,Et+de+1),J.emplaceBack(0+de,St+de+1,St+de),J.emplaceBack(0+de,0+de+1,St+de+1);const ce=H.length,me=ce+2*(et+1);for(const de of[0,1])for(let De=0;De<=et;De++)for(const Qe of[0,1])H.emplaceBack(de*i.a4,De*mt,Qe);for(let de=0;de<2*et;de+=2)J.emplaceBack(ce+de,ce+de+1,ce+de+3),J.emplaceBack(ce+de,ce+de+3,ce+de+2),J.emplaceBack(me+de,me+de+3,me+de+1),J.emplaceBack(me+de,me+de+2,me+de+3);const be=new sc(j.createVertexBuffer(H,Ep.members),j.createIndexBuffer(J),i.aW.simpleSegment(0,0,H.length,J.length));return this._meshCache[k]=be,be}getMeshFrameDelta(s){return 2*Math.PI*i.bD/Math.pow(2,Math.max(s,0))/5}getMinTileElevationForLngLatZoom(s,d){var v;const{tileID:S}=this._getOverscaledTileIDFromLngLatZoom(s,d);return(v=this.getMinMaxElevation(S).minElevation)!==null&&v!==void 0?v:0}getMinMaxElevation(s){const d=this.getTerrainData(s).tile,v={minElevation:null,maxElevation:null};return d&&d.dem&&(v.minElevation=d.dem.min*this.exaggeration,v.maxElevation=d.dem.max*this.exaggeration),v}_getOverscaledTileIDFromLngLatZoom(s,d){const v=i.aa.fromLngLat(s.wrap()),S=(1<<d)*i.a4,D=v.x*S,k=v.y*S,j=Math.floor(D/i.a4),H=Math.floor(k/i.a4);return{tileID:new i.a1(d,0,d,j,H),mercatorX:D,mercatorY:k}}}class ld{constructor(s,d,v){this._context=s,this._size=d,this._tileSize=v,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const s of this._objects)s.texture.destroy(),s.fbo.destroy()}_createObject(s){const d=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),v=new i.T(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return v.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),d.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),d.colorAttachment.set(v.texture),{id:s,fbo:d,texture:v,stamp:-1,inUse:!1}}getObjectForId(s){return this._objects[s]}useObject(s){s.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(d=>s.id!==d),this._recentlyUsed.push(s.id)}stampObject(s){s.stamp=++this._stamp}getOrCreateFreeObject(){for(const d of this._recentlyUsed)if(!this._objects[d].inUse)return this._objects[d];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const s=this._createObject(this._objects.length);return this._objects.push(s),s}freeObject(s){s.inUse=!1}freeAllObjects(){for(const s of this._objects)this.freeObject(s)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(s=>!s.inUse)===!1}}const to={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0,"color-relief":!0};class Go{constructor(s,d){this.painter=s,this.terrain=d,this.pool=new ld(s.context,30,d.tileManager.tileSize*d.qualityFactor)}destruct(){this.pool.destruct()}getTexture(s){return this.pool.getObjectForId(s.rtt[this._stacks.length-1].id).texture}prepareForRender(s,d){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.tileManager.getRenderableTiles(),this._renderableLayerIds=s._order.filter(v=>!s._layers[v].isHidden(d)),this._coordsAscending={};for(const v in s.tileManagers){this._coordsAscending[v]={};const S=s.tileManagers[v].getVisibleCoordinates(),D=s.tileManagers[v].getSource(),k=D instanceof Ss?D.terrainTileRanges:null;for(const j of S){const H=this.terrain.tileManager.getTerrainCoords(j,k);for(const J in H)this._coordsAscending[v][J]||(this._coordsAscending[v][J]=[]),this._coordsAscending[v][J].push(H[J])}}this._coordsAscendingStr={};for(const v of s._order){const S=s._layers[v],D=S.source;if(to[S.type]&&!this._coordsAscendingStr[D]){this._coordsAscendingStr[D]={};for(const k in this._coordsAscending[D])this._coordsAscendingStr[D][k]=this._coordsAscending[D][k].map(j=>j.key).sort().join()}}for(const v of this._renderableTiles)for(const S in this._coordsAscendingStr){const D=this._coordsAscendingStr[S][v.tileID.key];D&&D!==v.rttCoords[S]&&(v.rtt=[])}}renderLayer(s,d){if(s.isHidden(this.painter.transform.zoom))return!1;const v=Object.assign(Object.assign({},d),{isRenderingToTexture:!0}),S=s.type,D=this.painter,k=this._renderableLayerIds[this._renderableLayerIds.length-1]===s.id;if(to[S]&&(this._prevType&&to[this._prevType]||this._stacks.push([]),this._prevType=S,this._stacks[this._stacks.length-1].push(s.id),!k))return!0;if(to[this._prevType]||to[S]&&k){this._prevType=S;const j=this._stacks.length-1,H=this._stacks[j]||[];for(const J of this._renderableTiles){if(this.pool.isFull()&&(Rc(this.painter,this.terrain,this._rttTiles,v),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(J),J.rtt[j]){const mt=this.pool.getObjectForId(J.rtt[j].id);if(mt.stamp===J.rtt[j].stamp){this.pool.useObject(mt);continue}}const et=this.pool.getOrCreateFreeObject();this.pool.useObject(et),this.pool.stampObject(et),J.rtt[j]={id:et.id,stamp:et.stamp},D.context.bindFramebuffer.set(et.fbo.framebuffer),D.context.clear({color:i.bo.transparent,stencil:0}),D.currentStencilSource=void 0;for(let mt=0;mt<H.length;mt++){const ut=D.style._layers[H[mt]],St=ut.source?this._coordsAscending[ut.source][J.tileID.key]:[J.tileID];D.context.viewport.set([0,0,et.fbo.width,et.fbo.height]),D._renderTileClippingMasks(ut,St,!0),D.renderLayer(D,D.style.tileManagers[ut.source],ut,St,v),ut.source&&(J.rttCoords[ut.source]=this._coordsAscendingStr[ut.source][J.tileID.key])}}return Rc(this.painter,this.terrain,this._rttTiles,v),this._rttTiles=[],this.pool.freeAllObjects(),to[S]}return!1}}const Si={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use  + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},Su=Pe,zl={hash:!1,interactive:!0,bearingSnap:7,attributionControl:lh,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:i.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,transformConstrain:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,reduceMotion:void 0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0,experimentalZoomLevelsToOverscale:void 0},Nc={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class Vc{constructor(s,d,v=!1){this.mousedown=D=>{this.startMove(D,Ve.mousePos(this.element,D)),Ve.addEventListener(window,"mousemove",this.mousemove),Ve.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=D=>{this.move(D,Ve.mousePos(this.element,D))},this.mouseup=D=>{this._rotatePitchHandler.dragEnd(D),this.offTemp()},this.touchstart=D=>{D.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Ve.touchPos(this.element,D.targetTouches)[0],this.startMove(D,this._startPos),Ve.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),Ve.addEventListener(window,"touchend",this.touchend))},this.touchmove=D=>{D.targetTouches.length!==1?this.reset():(this._lastPos=Ve.touchPos(this.element,D.targetTouches)[0],this.move(D,this._lastPos))},this.touchend=D=>{D.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHandler.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=d;const S=new ff;this._rotatePitchHandler=new vu({clickTolerance:3,move:(D,k)=>{const j=d.getBoundingClientRect(),H=new i.P((j.bottom-j.top)/2,(j.right-j.left)/2);return{bearingDelta:i.cw(new i.P(D.x,k.y),k,H),pitchDelta:v?-.5*(k.y-D.y):void 0}},moveStateManager:S,enable:!0,assignEvents:()=>{}}),this.map=s,Ve.addEventListener(d,"mousedown",this.mousedown),Ve.addEventListener(d,"touchstart",this.touchstart,{passive:!1}),Ve.addEventListener(d,"touchcancel",this.reset)}startMove(s,d){this._rotatePitchHandler.dragStart(s,d),Ve.disableDrag()}move(s,d){const v=this.map,{bearingDelta:S,pitchDelta:D}=this._rotatePitchHandler.dragMove(s,d)||{};S&&v.setBearing(v.getBearing()+S),D&&v.setPitch(v.getPitch()+D)}off(){const s=this.element;Ve.removeEventListener(s,"mousedown",this.mousedown),Ve.removeEventListener(s,"touchstart",this.touchstart,{passive:!1}),Ve.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Ve.removeEventListener(window,"touchend",this.touchend),Ve.removeEventListener(s,"touchcancel",this.reset),this.offTemp()}offTemp(){Ve.enableDrag(),Ve.removeEventListener(window,"mousemove",this.mousemove),Ve.removeEventListener(window,"mouseup",this.mouseup),Ve.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Ve.removeEventListener(window,"touchend",this.touchend)}}let $i;function Hh(C,s,d,v=!1){if(v||!d.getCoveringTilesDetailsProvider().allowWorldCopies())return C?.wrap();const S=new i.V(C.lng,C.lat);if(C=new i.V(C.lng,C.lat),s){const D=new i.V(C.lng-360,C.lat),k=new i.V(C.lng+360,C.lat),j=d.locationToScreenPoint(C).distSqr(s);d.locationToScreenPoint(D).distSqr(s)<j?C=D:d.locationToScreenPoint(k).distSqr(s)<j&&(C=k)}for(;Math.abs(C.lng-d.center.lng)>180;){const D=d.locationToScreenPoint(C);if(D.x>=0&&D.y>=0&&D.x<=d.width&&D.y<=d.height)break;C.lng>d.center.lng?C.lng-=360:C.lng+=360}return C.lng!==S.lng&&d.isPointOnMapSurface(d.locationToScreenPoint(C))?C:S}const cd={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Iu(C,s,d){const v=C.classList;for(const S in cd)v.remove(`maplibregl-${d}-anchor-${S}`);v.add(`maplibregl-${d}-anchor-${s}`)}class Wh extends i.E{constructor(s){if(super(),this._onKeyPress=d=>{const v=d.code,S=d.charCode||d.keyCode;v!=="Space"&&v!=="Enter"&&S!==32&&S!==13||this.togglePopup()},this._onMapClick=d=>{const v=d.originalEvent.target,S=this._element;this._popup&&(v===S||S.contains(v))&&this.togglePopup()},this._update=d=>{if(!this._map)return;const v=this._map.loaded()&&!this._map.isMoving();(d?.type==="terrain"||d?.type==="render"&&!v)&&this._map.once("render",this._update),this._lngLat=Hh(this._lngLat,this._flatPos,this._map.transform),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let S="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?S=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(S=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let D="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?D="rotateX(0deg)":this._pitchAlignment==="map"&&(D=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||d&&d.type!=="moveend"||(this._pos=this._pos.round()),Ve.setTransform(this._element,`${cd[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${D} ${S}`),Br.frameAsync(new AbortController).then(()=>{this._updateOpacity(d&&d.type==="moveend")}).catch(()=>{})},this._onMove=d=>{if(!this._isDragging){const v=this._clickTolerance||this._map._clickTolerance;this._isDragging=d.point.dist(this._pointerdownPos)>=v}this._isDragging&&(this._pos=d.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new i.l("dragstart"))),this.fire(new i.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new i.l("dragend")),this._state="inactive"},this._addDragHandler=d=>{this._element.contains(d.originalEvent.target)&&(d.preventDefault(),this._positionDelta=d.point.sub(this._pos).add(this._offset),this._pointerdownPos=d.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=s&&s.anchor||"center",this._color=s&&s.color||"#3FB1CE",this._scale=s&&s.scale||1,this._draggable=s&&s.draggable||!1,this._clickTolerance=s&&s.clickTolerance||0,this._subpixelPositioning=s&&s.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=s&&s.rotation||0,this._rotationAlignment=s&&s.rotationAlignment||"auto",this._pitchAlignment=s&&s.pitchAlignment&&s.pitchAlignment!=="auto"?s.pitchAlignment:this._rotationAlignment,this.setOpacity(s?.opacity,s?.opacityWhenCovered),s&&s.element)this._element=s.element,this._offset=i.P.convert(s&&s.offset||[0,0]);else{this._defaultMarker=!0,this._element=Ve.create("div");const d=Ve.createNS("http://www.w3.org/2000/svg","svg"),v=41,S=27;d.setAttributeNS(null,"display","block"),d.setAttributeNS(null,"height",`${v}px`),d.setAttributeNS(null,"width",`${S}px`),d.setAttributeNS(null,"viewBox",`0 0 ${S} ${v}`);const D=Ve.createNS("http://www.w3.org/2000/svg","g");D.setAttributeNS(null,"stroke","none"),D.setAttributeNS(null,"stroke-width","1"),D.setAttributeNS(null,"fill","none"),D.setAttributeNS(null,"fill-rule","evenodd");const k=Ve.createNS("http://www.w3.org/2000/svg","g");k.setAttributeNS(null,"fill-rule","nonzero");const j=Ve.createNS("http://www.w3.org/2000/svg","g");j.setAttributeNS(null,"transform","translate(3.0, 29.0)"),j.setAttributeNS(null,"fill","#000000");const H=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Xt of H){const ft=Ve.createNS("http://www.w3.org/2000/svg","ellipse");ft.setAttributeNS(null,"opacity","0.04"),ft.setAttributeNS(null,"cx","10.5"),ft.setAttributeNS(null,"cy","5.80029008"),ft.setAttributeNS(null,"rx",Xt.rx),ft.setAttributeNS(null,"ry",Xt.ry),j.appendChild(ft)}const J=Ve.createNS("http://www.w3.org/2000/svg","g");J.setAttributeNS(null,"fill",this._color);const et=Ve.createNS("http://www.w3.org/2000/svg","path");et.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),J.appendChild(et);const mt=Ve.createNS("http://www.w3.org/2000/svg","g");mt.setAttributeNS(null,"opacity","0.25"),mt.setAttributeNS(null,"fill","#000000");const ut=Ve.createNS("http://www.w3.org/2000/svg","path");ut.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),mt.appendChild(ut);const St=Ve.createNS("http://www.w3.org/2000/svg","g");St.setAttributeNS(null,"transform","translate(6.0, 7.0)"),St.setAttributeNS(null,"fill","#FFFFFF");const pt=Ve.createNS("http://www.w3.org/2000/svg","g");pt.setAttributeNS(null,"transform","translate(8.0, 8.0)");const Et=Ve.createNS("http://www.w3.org/2000/svg","circle");Et.setAttributeNS(null,"fill","#000000"),Et.setAttributeNS(null,"opacity","0.25"),Et.setAttributeNS(null,"cx","5.5"),Et.setAttributeNS(null,"cy","5.5"),Et.setAttributeNS(null,"r","5.4999962");const Kt=Ve.createNS("http://www.w3.org/2000/svg","circle");Kt.setAttributeNS(null,"fill","#FFFFFF"),Kt.setAttributeNS(null,"cx","5.5"),Kt.setAttributeNS(null,"cy","5.5"),Kt.setAttributeNS(null,"r","5.4999962"),pt.appendChild(Et),pt.appendChild(Kt),k.appendChild(j),k.appendChild(J),k.appendChild(mt),k.appendChild(St),k.appendChild(pt),d.appendChild(k),d.setAttributeNS(null,"height",v*this._scale+"px"),d.setAttributeNS(null,"width",S*this._scale+"px"),this._element.appendChild(d),this._offset=i.P.convert(s&&s.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",d=>{d.preventDefault()}),this._element.addEventListener("mousedown",d=>{d.preventDefault()}),Iu(this._element,this._anchor,"marker"),s&&s.className)for(const d of s.className.split(" "))this._element.classList.add(d);this._popup=null}addTo(s){return this.remove(),this._map=s,this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label",s._getUIString("Marker.Title")),this._element.hasAttribute("role")||this._element.setAttribute("role","button"),s.getCanvasContainer().appendChild(this._element),s.on("move",this._update),s.on("moveend",this._update),s.on("terrain",this._update),s.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),Ve.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(s){return this._lngLat=i.V.convert(s),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(s){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),s){if(!("offset"in s.options)){const S=Math.abs(13.5)/Math.SQRT2;s.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[S,-1*(38.1-13.5+S)],"bottom-right":[-S,-1*(38.1-13.5+S)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=s,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(s){return this._subpixelPositioning=s,this}getPopup(){return this._popup}togglePopup(){const s=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:s?(s.isOpen()?s.remove():(s.setLngLat(this._lngLat),s.addTo(this._map)),this):this}_updateOpacity(s=!1){var d,v;const S=(d=this._map)===null||d===void 0?void 0:d.terrain,D=this._map.transform.isLocationOccluded(this._lngLat);if(!S||D){const St=D?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==St&&(this._element.style.opacity=St))}if(s)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const k=this._map,j=k.terrain.depthAtPoint(this._pos),H=k.terrain.getElevationForLngLatZoom(this._lngLat,k.transform.tileZoom);if(k.transform.lngLatToCameraDepth(this._lngLat,H)-j<.006)return void(this._element.style.opacity=this._opacity);const J=-this._offset.y/k.transform.pixelsPerMeter,et=Math.sin(k.getPitch()*Math.PI/180)*J,mt=k.terrain.depthAtPoint(new i.P(this._pos.x,this._pos.y-this._offset.y)),ut=k.transform.lngLatToCameraDepth(this._lngLat,H+et)-mt>.006;!((v=this._popup)===null||v===void 0)&&v.isOpen()&&ut&&this._popup.remove(),this._element.style.opacity=ut?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(s){return this._offset=i.P.convert(s),this._update(),this}addClassName(s){this._element.classList.add(s)}removeClassName(s){this._element.classList.remove(s)}toggleClassName(s){return this._element.classList.toggle(s)}setDraggable(s){return this._draggable=!!s,this._map&&(s?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(s){return this._rotation=s||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(s){return this._rotationAlignment=s||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(s){return this._pitchAlignment=s&&s!=="auto"?s:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(s,d){return(this._opacity===void 0||s===void 0&&d===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),s!==void 0&&(this._opacity=s),d!==void 0&&(this._opacityWhenCovered=d),this._map&&this._updateOpacity(!0),this}}const Zd={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Xh=0,Yh=!1;const yf={maxWidth:100,unit:"metric"};function Pp(C,s,d){const v=d&&d.maxWidth||100,S=C._container.clientHeight/2,D=C._container.clientWidth/2,k=C.unproject([D-v/2,S]),j=C.unproject([D+v/2,S]),H=Math.round(C.project(j).x-C.project(k).x),J=Math.min(v,H,C._container.clientWidth),et=k.distanceTo(j);if(d&&d.unit==="imperial"){const mt=3.2808*et;mt>5280?ks(s,J,mt/5280,C._getUIString("ScaleControl.Miles")):ks(s,J,mt,C._getUIString("ScaleControl.Feet"))}else d&&d.unit==="nautical"?ks(s,J,et/1852,C._getUIString("ScaleControl.NauticalMiles")):et>=1e3?ks(s,J,et/1e3,C._getUIString("ScaleControl.Kilometers")):ks(s,J,et,C._getUIString("ScaleControl.Meters"))}function ks(C,s,d,v){const S=function(D){const k=Math.pow(10,`${Math.floor(D)}`.length-1);let j=D/k;return j=j>=10?10:j>=5?5:j>=3?3:j>=2?2:j>=1?1:function(H){const J=Math.pow(10,Math.ceil(-Math.log(H)/Math.LN10));return Math.round(H*J)/J}(j),k*j}(d);C.style.width=s*(S/d)+"px",C.innerHTML=`${S}&nbsp;${v}`}const hd={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},ca=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function fc(C){if(C){if(typeof C=="number"){const s=Math.round(Math.abs(C)/Math.SQRT2);return{center:new i.P(0,0),top:new i.P(0,C),"top-left":new i.P(s,s),"top-right":new i.P(-s,s),bottom:new i.P(0,-C),"bottom-left":new i.P(s,-s),"bottom-right":new i.P(-s,-s),left:new i.P(C,0),right:new i.P(-C,0)}}if(C instanceof i.P||Array.isArray(C)){const s=i.P.convert(C);return{center:s,top:s,"top-left":s,"top-right":s,bottom:s,"bottom-left":s,"bottom-right":s,left:s,right:s}}return{center:i.P.convert(C.center||[0,0]),top:i.P.convert(C.top||[0,0]),"top-left":i.P.convert(C["top-left"]||[0,0]),"top-right":i.P.convert(C["top-right"]||[0,0]),bottom:i.P.convert(C.bottom||[0,0]),"bottom-left":i.P.convert(C["bottom-left"]||[0,0]),"bottom-right":i.P.convert(C["bottom-right"]||[0,0]),left:i.P.convert(C.left||[0,0]),right:i.P.convert(C.right||[0,0])}}return fc(new i.P(0,0))}const Hd=Pe;it.AJAXError=i.cI,it.Event=i.l,it.Evented=i.E,it.LngLat=i.V,it.MercatorCoordinate=i.aa,it.Point=i.P,it.addProtocol=i.cJ,it.config=i.a,it.removeProtocol=i.cK,it.AttributionControl=cs,it.BoxZoomHandler=Ud,it.CanvasSource=Sl,it.CooperativeGesturesHandler=la,it.DoubleClickZoomHandler=Gh,it.DragPanHandler=ad,it.DragRotateHandler=$h,it.EdgeInsets=On,it.FullscreenControl=class extends i.E{constructor(C={}){super(),this._onFullscreenChange=()=>{var s;let d=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((s=d?.shadowRoot)===null||s===void 0)&&s.fullscreenElement;)d=d.shadowRoot.fullscreenElement;d===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,C&&C.container&&(C.container instanceof HTMLElement?this._container=C.container:i.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(C){return this._map=C,this._container||(this._container=this._map.getContainer()),this._controlContainer=Ve.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){Ve.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const C=this._fullscreenButton=Ve.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);Ve.create("span","maplibregl-ctrl-icon",C).setAttribute("aria-hidden","true"),C.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const C=this._getTitle();this._fullscreenButton.setAttribute("aria-label",C),this._fullscreenButton.title=C}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new i.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new i.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},it.GeoJSONSource=ds,it.GeolocateControl=class extends i.E{constructor(C){super(),this._onSuccess=s=>{if(this._map){if(this._isOutOfMapMaxBounds(s))return this._setErrorState(),this.fire(new i.l("outofmaxbounds",s)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=s,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(s),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(s),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new i.l("geolocate",s)),this._finish()}},this._updateCamera=s=>{const d=new i.V(s.coords.longitude,s.coords.latitude),v=s.coords.accuracy,S=this._map.getBearing(),D=i.e({bearing:S},this.options.fitBoundsOptions),k=lo.fromLngLat(d,v);this._map.fitBounds(k,D,{geolocateSource:!0})},this._updateMarker=s=>{if(s){const d=new i.V(s.coords.longitude,s.coords.latitude);this._accuracyCircleMarker.setLngLat(d).addTo(this._map),this._userLocationDotMarker.setLngLat(d).addTo(this._map),this._accuracy=s.coords.accuracy,this._updateCircleRadiusIfNeeded()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onUpdate=()=>{this._updateCircleRadiusIfNeeded()},this._onError=s=>{if(this._map){if(s.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const d=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(s.code===3&&Yh)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new i.l("error",s)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",s=>s.preventDefault()),this._geolocateButton=Ve.create("button","maplibregl-ctrl-geolocate",this._container),Ve.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=s=>{if(this._map){if(s===!1){i.w("Geolocation support is not available so the GeolocateControl will be disabled.");const d=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d)}else{const d=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Ve.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Wh({element:this._dotElement}),this._circleElement=Ve.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Wh({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onUpdate),this._map.on("move",this._onUpdate),this._map.on("rotate",this._onUpdate),this._map.on("pitch",this._onUpdate)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",d=>{const v=d?.[0]instanceof ResizeObserverEntry;d.geolocateSource||this._watchState!=="ACTIVE_LOCK"||v||this._map.isZooming()||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new i.l("trackuserlocationend")),this.fire(new i.l("userlocationlostfocus")))})}},this.options=i.e({},Zd,C)}onAdd(C){return this._map=C,this._container=Ve.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return i._(this,arguments,void 0,function*(s=!1){if($i!==void 0&&!s)return $i;if(window.navigator.permissions===void 0)return $i=!!window.navigator.geolocation,$i;try{$i=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{$i=!!window.navigator.geolocation}return $i})}().then(s=>this._finishSetupUI(s)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),Ve.remove(this._container),this._map.off("zoom",this._onUpdate),this._map.off("move",this._onUpdate),this._map.off("rotate",this._onUpdate),this._map.off("pitch",this._onUpdate),this._map=void 0,Xh=0,Yh=!1}_isOutOfMapMaxBounds(C){const s=this._map.getMaxBounds(),d=C.coords;return s&&(d.longitude<s.getWest()||d.longitude>s.getEast()||d.latitude<s.getSouth()||d.latitude>s.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":case"BACKGROUND_ERROR":case"OFF":case void 0:break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadiusIfNeeded(){const C=this._userLocationDotMarker.getLngLat();if(!(this.options.showUserLocation&&this.options.showAccuracyCircle&&this._accuracy&&C))return;const s=this._map.project(C),d=this._map.unproject([s.x+100,s.y]),v=C.distanceTo(d)/100,S=2*this._accuracy/v;this._circleElement.style.width=`${S.toFixed(2)}px`,this._circleElement.style.height=`${S.toFixed(2)}px`}trigger(){if(!this._setup)return i.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new i.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Xh--,Yh=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new i.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new i.l("trackuserlocationstart")),this.fire(new i.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let C;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Xh++,Xh>1?(C={maximumAge:6e5,timeout:0},Yh=!0):(C=this.options.positionOptions,Yh=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,C)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},it.GlobeControl=class{constructor(){this._toggleProjection=()=>{var C;const s=(C=this._map.getProjection())===null||C===void 0?void 0:C.type;this._map.setProjection(s!=="mercator"&&s?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var C;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((C=this._map.getProjection())===null||C===void 0?void 0:C.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(C){return this._map=C,this._container=Ve.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=Ve.create("button","maplibregl-ctrl-globe",this._container),Ve.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){Ve.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},it.Hash=nh,it.ImageSource=Ss,it.KeyboardHandler=ah,it.LngLatBounds=lo,it.LogoControl=fl,it.Map=class extends pc{constructor(C){var s,d;i.cF.mark(i.cG.create);const v=Object.assign(Object.assign(Object.assign({},zl),C),{canvasContextAttributes:Object.assign(Object.assign({},zl.canvasContextAttributes),C.canvasContextAttributes)});if(v.minZoom!=null&&v.maxZoom!=null&&v.minZoom>v.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(v.minPitch!=null&&v.maxPitch!=null&&v.minPitch>v.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(v.minPitch!=null&&v.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(v.maxPitch!=null&&v.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const S=new pr,D=new Ca;if(v.minZoom!==void 0&&S.setMinZoom(v.minZoom),v.maxZoom!==void 0&&S.setMaxZoom(v.maxZoom),v.minPitch!==void 0&&S.setMinPitch(v.minPitch),v.maxPitch!==void 0&&S.setMaxPitch(v.maxPitch),v.renderWorldCopies!==void 0&&S.setRenderWorldCopies(v.renderWorldCopies),v.transformConstrain!==null&&S.setConstrainOverride(v.transformConstrain),super(S,D,{bearingSnap:v.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new $d,this._controls=[],this._mapId=i.ag(),this._lostContextStyle={style:null,images:null},this._contextLost=j=>{j.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.painter.destroy();for(const H of Object.values(this.style._layers))if(H.type==="custom"&&console.warn(`Custom layer with id '${H.id}' cannot be restored after WebGL context loss. You will need to re-add it manually after context restoration.`),H._listeners)for(const[J]of Object.entries(H._listeners))console.warn(`Custom layer with id '${H.id}' had event listeners for event '${J}' which cannot be restored after WebGL context loss. You will need to re-add them manually after context restoration.`);this._lostContextStyle=this._getStyleAndImages(),this.style.destroy(),this.style=null,this.fire(new i.l("webglcontextlost",{originalEvent:j}))},this._contextRestored=j=>{this._lostContextStyle.style&&this.setStyle(this._lostContextStyle.style,{diff:!1}),this._lostContextStyle.images&&(this.style.imageManager.images=this._lostContextStyle.images),this._setupPainter(),this.resize(),this._update(),this.fire(new i.l("webglcontextrestored",{originalEvent:j}))},this._onMapScroll=j=>{if(j.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=v.interactive,this._maxTileCacheSize=v.maxTileCacheSize,this._maxTileCacheZoomLevels=v.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},v.canvasContextAttributes),this._trackResize=v.trackResize===!0,this._bearingSnap=v.bearingSnap,this._centerClampedToGround=v.centerClampedToGround,this._refreshExpiredTiles=v.refreshExpiredTiles===!0,this._fadeDuration=v.fadeDuration,this._crossSourceCollisions=v.crossSourceCollisions===!0,this._collectResourceTiming=v.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Si),v.locale),this._clickTolerance=v.clickTolerance,this._overridePixelRatio=v.pixelRatio,this._maxCanvasSize=v.maxCanvasSize,this._zoomLevelsToOverscale=v.experimentalZoomLevelsToOverscale,this.transformCameraUpdate=v.transformCameraUpdate,this.transformConstrain=v.transformConstrain,this.cancelPendingTileRequestsWhileZooming=v.cancelPendingTileRequestsWhileZooming===!0,v.reduceMotion!==void 0&&(Br.prefersReducedMotion=v.reduceMotion),this._imageQueueHandle=Do.addThrottleControl(()=>this.isMoving()),this._requestManager=new tl(v.transformRequest),typeof v.container=="string"){if(this._container=document.getElementById(v.container),!this._container)throw new Error(`Container '${v.container}' not found.`)}else{if(!(v.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=v.container}if(v.maxBounds&&this.setMaxBounds(v.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let j=!1;const H=td(J=>{this._trackResize&&!this._removed&&(this.resize(J),this.redraw())},50);this._resizeObserver=new ResizeObserver(J=>{j?H(J):j=!0}),this._resizeObserver.observe(this._container)}this.handlers=new Zh(this,v),this._hash=v.hash&&new nh(typeof v.hash=="string"&&v.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:v.center,elevation:v.elevation,zoom:v.zoom,bearing:v.bearing,pitch:v.pitch,roll:v.roll}),v.bounds&&(this.resize(),this.fitBounds(v.bounds,i.e({},v.fitBoundsOptions,{duration:0}))));const k=typeof v.style=="string"||((d=(s=v.style)===null||s===void 0?void 0:s.projection)===null||d===void 0?void 0:d.type)!=="globe";this.resize(null,k),this._localIdeographFontFamily=v.localIdeographFontFamily,this._validateStyle=v.validateStyle,v.style&&this.setStyle(v.style,{localIdeographFontFamily:v.localIdeographFontFamily}),v.attributionControl&&this.addControl(new cs(typeof v.attributionControl=="boolean"?void 0:v.attributionControl)),v.maplibreLogo&&this.addControl(new fl,v.logoPosition),this.on("style.load",()=>{if(k||this._resizeTransform(),this.transform.unmodified){const j=i.U(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(j)}}),this.on("data",j=>{this._update(j.dataType==="style"),this.fire(new i.l(`${j.dataType}data`,j))}),this.on("dataloading",j=>{this.fire(new i.l(`${j.dataType}dataloading`,j))}),this.on("dataabort",j=>{this.fire(new i.l("sourcedataabort",j))})}_getMapId(){return this._mapId}setGlobalStateProperty(C,s){return this.style.setGlobalStateProperty(C,s),this._update(!0)}getGlobalState(){return this.style.getGlobalState()}addControl(C,s){if(s===void 0&&(s=C.getDefaultPosition?C.getDefaultPosition():"top-right"),!C||!C.onAdd)return this.fire(new i.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const d=C.onAdd(this);this._controls.push(C);const v=this._controlPositions[s];return s.indexOf("bottom")!==-1?v.insertBefore(d,v.firstChild):v.appendChild(d),this}removeControl(C){if(!C||!C.onRemove)return this.fire(new i.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const s=this._controls.indexOf(C);return s>-1&&this._controls.splice(s,1),C.onRemove(this),this}hasControl(C){return this._controls.indexOf(C)>-1}coveringTiles(C){return Ae(this.transform,C)}calculateCameraOptionsFromTo(C,s,d,v){return v==null&&this.terrain&&(v=this.terrain.getElevationForLngLatZoom(d,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(C,s,d,v)}resize(C,s=!0){const[d,v]=this._containerDimensions(),S=this._getClampedPixelRatio(d,v);if(this._resizeCanvas(d,v,S),this.painter.resize(d,v,S),this.painter.overLimit()){const k=this.painter.context.gl;this._maxCanvasSize=[k.drawingBufferWidth,k.drawingBufferHeight];const j=this._getClampedPixelRatio(d,v);this._resizeCanvas(d,v,j),this.painter.resize(d,v,j)}this._resizeTransform(s);const D=!this._moving;return D&&(this.stop(),this.fire(new i.l("movestart",C)).fire(new i.l("move",C))),this.fire(new i.l("resize",C)),D&&this.fire(new i.l("moveend",C)),this}_resizeTransform(C=!0){var s;const[d,v]=this._containerDimensions();this.transform.resize(d,v,C),(s=this._requestedCameraState)===null||s===void 0||s.resize(d,v,C)}_getClampedPixelRatio(C,s){const{0:d,1:v}=this._maxCanvasSize,S=this.getPixelRatio(),D=C*S,k=s*S;return Math.min(D>d?d/D:1,k>v?v/k:1)*S}getPixelRatio(){var C;return(C=this._overridePixelRatio)!==null&&C!==void 0?C:devicePixelRatio}setPixelRatio(C){this._overridePixelRatio=C,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(C){return this.transform.setMaxBounds(lo.convert(C)),this._update()}setMinZoom(C){if((C=C??-2)>=-2&&C<=this.transform.maxZoom)return this.transform.setMinZoom(C),this._update(),this.getZoom()<C&&this.setZoom(C),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(C){if((C=C??22)>=this.transform.minZoom)return this.transform.setMaxZoom(C),this._update(),this.getZoom()>C&&this.setZoom(C),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(C){if((C=C??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(C>=0&&C<=this.transform.maxPitch)return this.transform.setMinPitch(C),this._update(),this.getPitch()<C&&this.setPitch(C),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(C){if((C=C??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(C>=this.transform.minPitch)return this.transform.setMaxPitch(C),this._update(),this.getPitch()>C&&this.setPitch(C),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(C){return this.transform.setRenderWorldCopies(C),this._update()}setTransformConstrain(C){return this.transform.setConstrainOverride(C),this._update()}project(C){return this.transform.locationToScreenPoint(i.V.convert(C),this.style&&this.terrain)}unproject(C){return this.transform.screenPointToLocation(i.P.convert(C),this.terrain)}isMoving(){var C;return this._moving||((C=this.handlers)===null||C===void 0?void 0:C.isMoving())}isZooming(){var C;return this._zooming||((C=this.handlers)===null||C===void 0?void 0:C.isZooming())}isRotating(){var C;return this._rotating||((C=this.handlers)===null||C===void 0?void 0:C.isRotating())}_createDelegatedListener(C,s,d){if(C==="mouseenter"||C==="mouseover"){let v=!1;return{layers:s,listener:d,delegates:{mousemove:D=>{const k=s.filter(H=>this.getLayer(H)),j=k.length!==0?this.queryRenderedFeatures(D.point,{layers:k}):[];j.length?v||(v=!0,d.call(this,new Yo(C,this,D.originalEvent,{features:j}))):v=!1},mouseout:()=>{v=!1}}}}if(C==="mouseleave"||C==="mouseout"){let v=!1;return{layers:s,listener:d,delegates:{mousemove:k=>{const j=s.filter(H=>this.getLayer(H));(j.length!==0?this.queryRenderedFeatures(k.point,{layers:j}):[]).length?v=!0:v&&(v=!1,d.call(this,new Yo(C,this,k.originalEvent)))},mouseout:k=>{v&&(v=!1,d.call(this,new Yo(C,this,k.originalEvent)))}}}}{const v=S=>{const D=s.filter(j=>this.getLayer(j)),k=D.length!==0?this.queryRenderedFeatures(S.point,{layers:D}):[];k.length&&(S.features=k,d.call(this,S),delete S.features)};return{layers:s,listener:d,delegates:{[C]:v}}}}_saveDelegatedListener(C,s){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[C]=this._delegatedListeners[C]||[],this._delegatedListeners[C].push(s)}_removeDelegatedListener(C,s,d){if(!this._delegatedListeners||!this._delegatedListeners[C])return;const v=this._delegatedListeners[C];for(let S=0;S<v.length;S++){const D=v[S];if(D.listener===d&&D.layers.length===s.length&&D.layers.every(k=>s.includes(k))){for(const k in D.delegates)this.off(k,D.delegates[k]);return void v.splice(S,1)}}}on(C,s,d){if(d===void 0)return super.on(C,s);const v=typeof s=="string"?[s]:s,S=this._createDelegatedListener(C,v,d);this._saveDelegatedListener(C,S);for(const D in S.delegates)this.on(D,S.delegates[D]);return{unsubscribe:()=>{this._removeDelegatedListener(C,v,d)}}}once(C,s,d){if(d===void 0)return super.once(C,s);const v=typeof s=="string"?[s]:s,S=this._createDelegatedListener(C,v,d);for(const D in S.delegates){const k=S.delegates[D];S.delegates[D]=(...j)=>{this._removeDelegatedListener(C,v,d),k(...j)}}this._saveDelegatedListener(C,S);for(const D in S.delegates)this.once(D,S.delegates[D]);return this}off(C,s,d){return d===void 0?super.off(C,s):(this._removeDelegatedListener(C,typeof s=="string"?[s]:s,d),this)}queryRenderedFeatures(C,s){if(!this.style)return[];let d;const v=C instanceof i.P||Array.isArray(C),S=v?C:[[0,0],[this.transform.width,this.transform.height]];if(s=s||(v?{}:C)||{},S instanceof i.P||typeof S[0]=="number")d=[i.P.convert(S)];else{const D=i.P.convert(S[0]),k=i.P.convert(S[1]);d=[D,new i.P(k.x,D.y),k,new i.P(D.x,k.y),D]}return this.style.queryRenderedFeatures(d,s,this.transform)}querySourceFeatures(C,s){return this.style.querySourceFeatures(C,s)}setStyle(C,s){return(s=i.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},s)).diff!==!1&&s.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&C?(this._diffStyle(C,s),this):(this._localIdeographFontFamily=s.localIdeographFontFamily,this._updateStyle(C,s))}setTransformRequest(C){return this._requestManager.setTransformRequest(C),this}_getUIString(C){const s=this._locale[C];if(s==null)throw new Error(`Missing UI string '${C}'`);return s}_updateStyle(C,s){var d,v;if(s.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(C,s));const S=this.style&&s.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!C)),C?(this.style=new Oo(this,s||{}),this.style.setEventedParent(this,{style:this.style}),typeof C=="string"?this.style.loadURL(C,s,S):this.style.loadJSON(C,s,S),this):((v=(d=this.style)===null||d===void 0?void 0:d.projection)===null||v===void 0||v.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new Oo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(C,s){if(typeof C=="string"){const d=this._requestManager.transformRequest(C,"Style");i.j(d,new AbortController).then(v=>{this._updateDiff(v.data,s)}).catch(v=>{v&&this.fire(new i.k(v))})}else typeof C=="object"&&this._updateDiff(C,s)}_updateDiff(C,s){try{this.style.setState(C,s)&&this._update(!0)}catch(d){i.w(`Unable to perform style diff: ${d.message||d.error||d}.  Rebuilding the style from scratch.`),this._updateStyle(C,s)}}getStyle(){if(this.style)return this.style.serialize()}_getStyleAndImages(){return this.style?{style:this.style.serialize(),images:this.style.imageManager.cloneImages()}:{style:null,images:{}}}isStyleLoaded(){return this.style?this.style.loaded():i.w("There is no style added to the map.")}addSource(C,s){return this._lazyInitEmptyStyle(),this.style.addSource(C,s),this._update(!0)}isSourceLoaded(C){const s=this.style&&this.style.tileManagers[C];if(s!==void 0)return s.loaded();this.fire(new i.k(new Error(`There is no tile manager with ID '${C}'`)))}setTerrain(C){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),C){const s=this.style.tileManagers[C.source];if(!s)throw new Error(`cannot load terrain, because there exists no source with ID: ${C.source}`);this.terrain===null&&s.reload();for(const d in this.style._layers){const v=this.style._layers[d];v.type==="hillshade"&&v.source===C.source&&i.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality."),v.type==="color-relief"&&v.source===C.source&&i.w("You are using the same source for a color-relief layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new Ap(this.painter,s,C),this.painter.renderToTexture=new Go(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=d=>{var v;d.dataType==="style"?this.terrain.tileManager.freeRtt():d.dataType==="source"&&d.tile&&(d.sourceId!==C.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),((v=d.source)===null||v===void 0?void 0:v.type)==="image"?this.terrain.tileManager.freeRtt():this.terrain.tileManager.freeRtt(d.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.tileManager.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new i.l("terrain",{terrain:C})),this}getTerrain(){var C,s;return(s=(C=this.terrain)===null||C===void 0?void 0:C.options)!==null&&s!==void 0?s:null}areTilesLoaded(){const C=this.style&&this.style.tileManagers;for(const s in C){const d=C[s]._tiles;for(const v in d){const S=d[v];if(S.state!=="loaded"&&S.state!=="errored")return!1}}return!0}removeSource(C){return this.style.removeSource(C),this._update(!0)}getSource(C){return this.style.getSource(C)}setSourceTileLodParams(C,s,d){if(d){const v=this.getSource(d);if(!v)throw new Error(`There is no source with ID "${d}", cannot set LOD parameters`);v.calculateTileZoom=ui(Math.max(1,C),Math.max(1,s))}else for(const v in this.style.tileManagers)this.style.tileManagers[v].getSource().calculateTileZoom=ui(Math.max(1,C),Math.max(1,s));return this._update(!0),this}refreshTiles(C,s){const d=this.style.tileManagers[C];if(!d)throw new Error(`There is no tile manager with ID "${C}", cannot refresh tile`);s===void 0?d.reload(!0):d.refreshTiles(s.map(v=>new i.ad(v.z,v.x,v.y)))}addImage(C,s,d={}){const{pixelRatio:v=1,sdf:S=!1,stretchX:D,stretchY:k,content:j,textFitWidth:H,textFitHeight:J}=d;if(this._lazyInitEmptyStyle(),!(s instanceof HTMLImageElement||i.b(s))){if(s.width===void 0||s.height===void 0)return this.fire(new i.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:et,height:mt,data:ut}=s,St=s;return this.style.addImage(C,{data:new i.R({width:et,height:mt},new Uint8Array(ut)),pixelRatio:v,stretchX:D,stretchY:k,content:j,textFitWidth:H,textFitHeight:J,sdf:S,version:0,userImage:St}),St.onAdd&&St.onAdd(this,C),this}}{const{width:et,height:mt,data:ut}=Br.getImageData(s);this.style.addImage(C,{data:new i.R({width:et,height:mt},ut),pixelRatio:v,stretchX:D,stretchY:k,content:j,textFitWidth:H,textFitHeight:J,sdf:S,version:0})}}updateImage(C,s){const d=this.style.getImage(C);if(!d)return this.fire(new i.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const v=s instanceof HTMLImageElement||i.b(s)?Br.getImageData(s):s,{width:S,height:D,data:k}=v;if(S===void 0||D===void 0)return this.fire(new i.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(S!==d.data.width||D!==d.data.height)return this.fire(new i.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const j=!(s instanceof HTMLImageElement||i.b(s));return d.data.replace(k,j),this.style.updateImage(C,d),this}getImage(C){return this.style.getImage(C)}hasImage(C){return C?!!this.style.getImage(C):(this.fire(new i.k(new Error("Missing required image id"))),!1)}removeImage(C){this.style.removeImage(C)}loadImage(C){return Do.getImage(this._requestManager.transformRequest(C,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(C,s){return this._lazyInitEmptyStyle(),this.style.addLayer(C,s),this._update(!0)}moveLayer(C,s){return this.style.moveLayer(C,s),this._update(!0)}removeLayer(C){return this.style.removeLayer(C),this._update(!0)}getLayer(C){return this.style.getLayer(C)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(C,s,d){return this.style.setLayerZoomRange(C,s,d),this._update(!0)}setFilter(C,s,d={}){return this.style.setFilter(C,s,d),this._update(!0)}getFilter(C){return this.style.getFilter(C)}setPaintProperty(C,s,d,v={}){return this.style.setPaintProperty(C,s,d,v),this._update(!0)}getPaintProperty(C,s){return this.style.getPaintProperty(C,s)}setLayoutProperty(C,s,d,v={}){return this.style.setLayoutProperty(C,s,d,v),this._update(!0)}getLayoutProperty(C,s){return this.style.getLayoutProperty(C,s)}setGlyphs(C,s={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(C,s),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(C,s,d={}){return this._lazyInitEmptyStyle(),this.style.addSprite(C,s,d,v=>{v||this._update(!0)}),this}removeSprite(C){return this._lazyInitEmptyStyle(),this.style.removeSprite(C),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(C,s={}){return this._lazyInitEmptyStyle(),this.style.setSprite(C,s,d=>{d||this._update(!0)}),this}setLight(C,s={}){return this._lazyInitEmptyStyle(),this.style.setLight(C,s),this._update(!0)}getLight(){return this.style.getLight()}setSky(C,s={}){return this._lazyInitEmptyStyle(),this.style.setSky(C,s),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(C,s){return this.style.setFeatureState(C,s),this._update()}removeFeatureState(C,s){return this.style.removeFeatureState(C,s),this._update()}getFeatureState(C){return this.style.getFeatureState(C)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let C=0,s=0;return this._container&&(C=this._container.clientWidth||400,s=this._container.clientHeight||300),[C,s]}_setupContainer(){const C=this._container;C.classList.add("maplibregl-map");const s=this._canvasContainer=Ve.create("div","maplibregl-canvas-container",C);this._interactive&&s.classList.add("maplibregl-interactive"),this._canvas=Ve.create("canvas","maplibregl-canvas",s),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const d=this._containerDimensions(),v=this._getClampedPixelRatio(d[0],d[1]);this._resizeCanvas(d[0],d[1],v);const S=this._controlContainer=Ve.create("div","maplibregl-control-container",C),D=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(k=>{D[k]=Ve.create("div",`maplibregl-ctrl-${k} `,S)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(C,s,d){this._canvas.width=Math.floor(d*C),this._canvas.height=Math.floor(d*s),this._canvas.style.width=`${C}px`,this._canvas.style.height=`${s}px`}_setupPainter(){const C=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let s=null;this._canvas.addEventListener("webglcontextcreationerror",v=>{s={requestedAttributes:C},v&&(s.statusMessage=v.statusMessage,s.type=v.type)},{once:!0});let d=null;if(d=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,C):this._canvas.getContext("webgl2",C)||this._canvas.getContext("webgl",C),!d){const v="Failed to initialize WebGL";throw s?(s.message=v,new Error(JSON.stringify(s))):new Error(v)}this.painter=new Nd(d,this.transform),Io.testSupport(d)}migrateProjection(C,s){super.migrateProjection(C,s),this.painter.transform=C,this.fire(new i.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(C){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||C,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(C){return this._update(),this._renderTaskQueue.add(C)}_cancelRenderFrame(C){this._renderTaskQueue.remove(C)}_render(C){var s,d,v,S,D;const k=this._idleTriggered?this._fadeDuration:0,j=((s=this.style.projection)===null||s===void 0?void 0:s.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(C),this._removed)return;let H=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const mt=this.transform.zoom,ut=Ri();this.style.zoomHistory.update(mt,ut);const St=new i.H(mt,{now:ut,fadeDuration:k,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),pt=St.crossFadingFactor();pt===1&&pt===this._crossFadingFactor||(H=!0,this._crossFadingFactor=pt),this.style.update(St)}const J=((d=this.style.projection)===null||d===void 0?void 0:d.transitionState)>0!==j;(v=this.style.projection)===null||v===void 0||v.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((S=this.style.projection)===null||S===void 0?void 0:S.transitionState,(D=this.style.projection)===null||D===void 0?void 0:D.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||J)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.tileManager.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,k,this._crossSourceCollisions,J),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:k,showPadding:this.showPadding}),this.fire(new i.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,i.cF.mark(i.cG.load),this.fire(new i.l("load"))),this.style&&(this.style.hasTransitions()||H)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const et=this._sourcesDirty||this._styleDirty||this._placementDirty;return et||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new i.l("idle")),!this._loaded||this._fullyLoaded||et||(this._fullyLoaded=!0,i.cF.mark(i.cG.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var C;this._hash&&this._hash.remove();for(const d of this._controls)d.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),Do.removeThrottleControl(this._imageQueueHandle),(C=this._resizeObserver)===null||C===void 0||C.disconnect();const s=this.painter.context.gl.getExtension("WEBGL_lose_context");s?.loseContext&&s.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),Ve.remove(this._canvasContainer),Ve.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),i.cF.clearMetrics(),this._removed=!0,this.fire(new i.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,Br.frame(this._frameRequest,C=>{i.cF.frame(C),this._frameRequest=null;try{this._render(C)}catch(s){if(!i.cH(s)&&!function(d){return d.message===pu}(s))throw s}},()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(C){this._showTileBoundaries!==C&&(this._showTileBoundaries=C,this._update())}get showPadding(){return!!this._showPadding}set showPadding(C){this._showPadding!==C&&(this._showPadding=C,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(C){this._showCollisionBoxes!==C&&(this._showCollisionBoxes=C,C?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(C){this._showOverdrawInspector!==C&&(this._showOverdrawInspector=C,this._update())}get repaint(){return!!this._repaint}set repaint(C){this._repaint!==C&&(this._repaint=C,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(C){this._vertices=C,this._update()}get version(){return Su}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(C){return this._lazyInitEmptyStyle(),this.style.setProjection(C),this._update(!0)}},it.MapMouseEvent=Yo,it.MapTouchEvent=yu,it.MapWheelEvent=oh,it.Marker=Wh,it.NavigationControl=class{constructor(C){this._updateZoomButtons=()=>{const s=this._map.getZoom(),d=s===this._map.getMaxZoom(),v=s===this._map.getMinZoom();this._zoomInButton.disabled=d,this._zoomOutButton.disabled=v,this._zoomInButton.setAttribute("aria-disabled",d.toString()),this._zoomOutButton.setAttribute("aria-disabled",v.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(s,d)=>{const v=this._map._getUIString(`NavigationControl.${d}`);s.title=v,s.setAttribute("aria-label",v)},this.options=i.e({},Nc,C),this._container=Ve.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",s=>s.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",s=>this._map.zoomIn({},{originalEvent:s})),Ve.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",s=>this._map.zoomOut({},{originalEvent:s})),Ve.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",s=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:s}):this._map.resetNorth({},{originalEvent:s})}),this._compassIcon=Ve.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(C){return this._map=C,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Vc(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){Ve.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(C,s){const d=Ve.create("button",C,this._container);return d.type="button",d.addEventListener("click",s),d}},it.Popup=class extends i.E{constructor(C){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:"")},this.remove=()=>(this._content&&Ve.remove(this._content),this._container&&(Ve.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new i.l("close"))),this),this._onMouseUp=s=>{this._update(s.point)},this._onMouseMove=s=>{this._update(s.point)},this._onDrag=s=>{this._update(s.point)},this._update=s=>{if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=Ve.create("div","maplibregl-popup",this._map.getContainer()),this._tip=Ve.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const k of this.options.className.split(" "))this._container.classList.add(k);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=Hh(this._lngLat,this._flatPos,this._map.transform,this._trackPointer),this._trackPointer&&!s)return;const d=this._flatPos=this._pos=this._trackPointer&&s?s:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&s?s:this._map.transform.locationToScreenPoint(this._lngLat));let v=this.options.anchor;const S=fc(this.options.offset);if(!v){const k=this._container.offsetWidth,j=this._container.offsetHeight;let H;H=d.y+S.bottom.y<j?["top"]:d.y>this._map.transform.height-j?["bottom"]:[],d.x<k/2?H.push("left"):d.x>this._map.transform.width-k/2&&H.push("right"),v=H.length===0?"bottom":H.join("-")}let D=d.add(S[v]);this.options.subpixelPositioning||(D=D.round()),Ve.setTransform(this._container,`${cd[v]} translate(${D.x}px,${D.y}px)`),Iu(this._container,v,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=i.e(Object.create(hd),C)}addTo(C){return this._map&&this.remove(),this._map=C,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new i.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(C){return this._lngLat=i.V.convert(C),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(C){return this.setDOMContent(document.createTextNode(C))}setHTML(C){const s=document.createDocumentFragment(),d=document.createElement("body");let v;for(d.innerHTML=C;v=d.firstChild,v;)s.appendChild(v);return this.setDOMContent(s)}getMaxWidth(){var C;return(C=this._container)===null||C===void 0?void 0:C.style.maxWidth}setMaxWidth(C){return this.options.maxWidth=C,this._update(),this}setDOMContent(C){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=Ve.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(C),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(C){return this._container&&this._container.classList.add(C),this}removeClassName(C){return this._container&&this._container.classList.remove(C),this}setOffset(C){return this.options.offset=C,this._update(),this}toggleClassName(C){if(this._container)return this._container.classList.toggle(C)}setSubpixelPositioning(C){this.options.subpixelPositioning=C}_createCloseButton(){this.options.closeButton&&(this._closeButton=Ve.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const C=this._container.querySelector(ca);C&&C.focus()}},it.RasterDEMTileSource=Ts,it.RasterTileSource=jl,it.ScaleControl=class{constructor(C){this._onMove=()=>{Pp(this._map,this._container,this.options)},this.setUnit=s=>{this.options.unit=s,Pp(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},yf),C)}getDefaultPosition(){return"bottom-left"}onAdd(C){return this._map=C,this._container=Ve.create("div","maplibregl-ctrl maplibregl-ctrl-scale",C.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){Ve.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},it.ScrollZoomHandler=Tu,it.Style=Oo,it.TerrainControl=class{constructor(C){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=C}onAdd(C){return this._map=C,this._container=Ve.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=Ve.create("button","maplibregl-ctrl-terrain",this._container),Ve.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){Ve.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},it.TwoFingersTouchPitchHandler=od,it.TwoFingersTouchRotateHandler=dc,it.TwoFingersTouchZoomHandler=gf,it.TwoFingersTouchZoomRotateHandler=Xf,it.VectorTileSource=el,it.VideoSource=il,it.addSourceType=(C,s)=>i._(void 0,void 0,void 0,function*(){if(zs(C))throw new Error(`A source type called "${C}" already exists.`);((d,v)=>{Il[d]=v})(C,s)}),it.clearPrewarmedResources=function(){const C=ja;C&&(C.isPreloaded()&&C.numActive()===1?(C.release(Ks),ja=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},it.createTileMesh=Xc,it.getMaxParallelImageRequests=function(){return i.a.MAX_PARALLEL_IMAGE_REQUESTS},it.getRTLTextPluginStatus=function(){return Aa().getRTLTextPluginStatus()},it.getVersion=function(){return Hd},it.getWorkerCount=function(){return Ul.workerCount},it.getWorkerUrl=function(){return i.a.WORKER_URL},it.importScriptInWorkers=function(C){return qo().broadcast("IS",C)},it.isTimeFrozen=function(){return Or.isFrozen()},it.now=Ri,it.prewarm=function(){bn().acquire(Ks)},it.restoreNow=function(){Or.restoreNow()},it.setMaxParallelImageRequests=function(C){i.a.MAX_PARALLEL_IMAGE_REQUESTS=C},it.setNow=function(C){Or.setNow(C)},it.setRTLTextPlugin=function(C,s){return Aa().setRTLTextPlugin(C,s)},it.setWorkerCount=function(C){Ul.workerCount=C},it.setWorkerUrl=function(C){i.a.WORKER_URL=C}});var Ft=vt;return Ft})})(Tb);var BT=Tb.exports;const iv=wb(BT);var Ib={exports:{}};(function($t,wt){(function(vt,Lt){$t.exports=Lt()})(bb,function(){var vt,Lt,Dt;function Ft(i,Pe){if(!vt)vt=Pe;else if(!Lt)Lt=Pe;else{var yi="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+vt+")(sharedChunk); ("+Lt+")(sharedChunk); self.onerror = null;",tr={};vt(tr),Dt=Pe(tr),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Dt.workerUrl=window.URL.createObjectURL(new Blob([yi],{type:"text/javascript"})))}}Ft(["exports"],function(i){var Pe=1e-6,yi=typeof Float32Array<"u"?Float32Array:Array;function tr(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=r*m-u*l;return _?(n[0]=m*(_=1/_),n[1]=-l*_,n[2]=-u*_,n[3]=r*_,n):null}function vn(){var n=new yi(9);return yi!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function on(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=t[4],b=t[5],E=t[6],P=t[7],R=t[8];return n[0]=_*R-b*P,n[1]=u*P-l*R,n[2]=l*b-u*_,n[3]=b*E-m*R,n[4]=r*R-u*E,n[5]=u*m-r*b,n[6]=m*P-_*E,n[7]=l*E-r*P,n[8]=r*_-l*m,n}function Br(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3],b=t[4],E=t[5],P=t[6],R=t[7],F=t[8],O=r[0],$=r[1],q=r[2],Y=r[3],rt=r[4],at=r[5],gt=r[6],yt=r[7],Pt=r[8];return n[0]=O*l+$*_+q*P,n[1]=O*u+$*b+q*R,n[2]=O*m+$*E+q*F,n[3]=Y*l+rt*_+at*P,n[4]=Y*u+rt*b+at*R,n[5]=Y*m+rt*E+at*F,n[6]=gt*l+yt*_+Pt*P,n[7]=gt*u+yt*b+Pt*R,n[8]=gt*m+yt*E+Pt*F,n}function Or(){var n=new yi(16);return yi!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function Ri(n){var t=new yi(16);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t}function Ve(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function Io(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=t[4],b=t[5],E=t[6],P=t[7],R=t[8],F=t[9],O=t[10],$=t[11],q=t[12],Y=t[13],rt=t[14],at=t[15],gt=r*b-l*_,yt=r*E-u*_,Pt=r*P-m*_,qt=l*E-u*b,Bt=l*P-m*b,Yt=u*P-m*E,ee=R*Y-F*q,ne=R*rt-O*q,Le=R*at-$*q,fe=F*rt-O*Y,ke=F*at-$*Y,Ue=O*at-$*rt,Ze=gt*Ue-yt*ke+Pt*fe+qt*Le-Bt*ne+Yt*ee;return Ze?(n[0]=(b*Ue-E*ke+P*fe)*(Ze=1/Ze),n[1]=(u*ke-l*Ue-m*fe)*Ze,n[2]=(Y*Yt-rt*Bt+at*qt)*Ze,n[3]=(O*Bt-F*Yt-$*qt)*Ze,n[4]=(E*Le-_*Ue-P*ne)*Ze,n[5]=(r*Ue-u*Le+m*ne)*Ze,n[6]=(rt*Pt-q*Yt-at*yt)*Ze,n[7]=(R*Yt-O*Pt+$*yt)*Ze,n[8]=(_*ke-b*Le+P*ee)*Ze,n[9]=(l*Le-r*ke-m*ee)*Ze,n[10]=(q*Bt-Y*Pt+at*gt)*Ze,n[11]=(F*Pt-R*Bt-$*gt)*Ze,n[12]=(b*ne-_*fe-E*ee)*Ze,n[13]=(r*fe-l*ne+u*ee)*Ze,n[14]=(Y*yt-q*qt-rt*gt)*Ze,n[15]=(R*qt-F*yt+O*gt)*Ze,n):null}function gr(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3],b=t[4],E=t[5],P=t[6],R=t[7],F=t[8],O=t[9],$=t[10],q=t[11],Y=t[12],rt=t[13],at=t[14],gt=t[15],yt=r[0],Pt=r[1],qt=r[2],Bt=r[3];return n[0]=yt*l+Pt*b+qt*F+Bt*Y,n[1]=yt*u+Pt*E+qt*O+Bt*rt,n[2]=yt*m+Pt*P+qt*$+Bt*at,n[3]=yt*_+Pt*R+qt*q+Bt*gt,n[4]=(yt=r[4])*l+(Pt=r[5])*b+(qt=r[6])*F+(Bt=r[7])*Y,n[5]=yt*u+Pt*E+qt*O+Bt*rt,n[6]=yt*m+Pt*P+qt*$+Bt*at,n[7]=yt*_+Pt*R+qt*q+Bt*gt,n[8]=(yt=r[8])*l+(Pt=r[9])*b+(qt=r[10])*F+(Bt=r[11])*Y,n[9]=yt*u+Pt*E+qt*O+Bt*rt,n[10]=yt*m+Pt*P+qt*$+Bt*at,n[11]=yt*_+Pt*R+qt*q+Bt*gt,n[12]=(yt=r[12])*l+(Pt=r[13])*b+(qt=r[14])*F+(Bt=r[15])*Y,n[13]=yt*u+Pt*E+qt*O+Bt*rt,n[14]=yt*m+Pt*P+qt*$+Bt*at,n[15]=yt*_+Pt*R+qt*q+Bt*gt,n}function Yr(n,t,r){var l,u,m,_,b,E,P,R,F,O,$,q,Y=r[0],rt=r[1],at=r[2];return t===n?(n[12]=t[0]*Y+t[4]*rt+t[8]*at+t[12],n[13]=t[1]*Y+t[5]*rt+t[9]*at+t[13],n[14]=t[2]*Y+t[6]*rt+t[10]*at+t[14],n[15]=t[3]*Y+t[7]*rt+t[11]*at+t[15]):(u=t[1],m=t[2],_=t[3],b=t[4],E=t[5],P=t[6],R=t[7],F=t[8],O=t[9],$=t[10],q=t[11],n[0]=l=t[0],n[1]=u,n[2]=m,n[3]=_,n[4]=b,n[5]=E,n[6]=P,n[7]=R,n[8]=F,n[9]=O,n[10]=$,n[11]=q,n[12]=l*Y+b*rt+F*at+t[12],n[13]=u*Y+E*rt+O*at+t[13],n[14]=m*Y+P*rt+$*at+t[14],n[15]=_*Y+R*rt+q*at+t[15]),n}function Fn(n,t,r){var l=r[0],u=r[1],m=r[2];return n[0]=t[0]*l,n[1]=t[1]*l,n[2]=t[2]*l,n[3]=t[3]*l,n[4]=t[4]*u,n[5]=t[5]*u,n[6]=t[6]*u,n[7]=t[7]*u,n[8]=t[8]*m,n[9]=t[9]*m,n[10]=t[10]*m,n[11]=t[11]*m,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function us(n,t,r){var l=Math.sin(r),u=Math.cos(r),m=t[4],_=t[5],b=t[6],E=t[7],P=t[8],R=t[9],F=t[10],O=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=m*u+P*l,n[5]=_*u+R*l,n[6]=b*u+F*l,n[7]=E*u+O*l,n[8]=P*u-m*l,n[9]=R*u-_*l,n[10]=F*u-b*l,n[11]=O*u-E*l,n}function ao(n,t,r){var l=Math.sin(r),u=Math.cos(r),m=t[0],_=t[1],b=t[2],E=t[3],P=t[8],R=t[9],F=t[10],O=t[11];return t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=m*u-P*l,n[1]=_*u-R*l,n[2]=b*u-F*l,n[3]=E*u-O*l,n[8]=m*l+P*u,n[9]=_*l+R*u,n[10]=b*l+F*u,n[11]=E*l+O*u,n}function Do(n,t,r){var l=Math.sin(r),u=Math.cos(r),m=t[0],_=t[1],b=t[2],E=t[3],P=t[4],R=t[5],F=t[6],O=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=m*u+P*l,n[1]=_*u+R*l,n[2]=b*u+F*l,n[3]=E*u+O*l,n[4]=P*u-m*l,n[5]=R*u-_*l,n[6]=F*u-b*l,n[7]=O*u-E*l,n}function tl(n,t){return n[0]=t[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=t[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=t[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function fa(n,t,r){var l,u,m,_=r[0],b=r[1],E=r[2],P=Math.sqrt(_*_+b*b+E*E);return P<Pe?null:(_*=P=1/P,b*=P,E*=P,l=Math.sin(t),u=Math.cos(t),n[0]=_*_*(m=1-u)+u,n[1]=b*_*m+E*l,n[2]=E*_*m-b*l,n[3]=0,n[4]=_*b*m-E*l,n[5]=b*b*m+u,n[6]=E*b*m+_*l,n[7]=0,n[8]=_*E*m+b*l,n[9]=b*E*m-_*l,n[10]=E*E*m+u,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function Nl(n,t){var r=t[0],l=t[1],u=t[2],m=t[4],_=t[5],b=t[6],E=t[8],P=t[9],R=t[10];return n[0]=Math.sqrt(r*r+l*l+u*u),n[1]=Math.sqrt(m*m+_*_+b*b),n[2]=Math.sqrt(E*E+P*P+R*R),n}function nc(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=r+r,b=l+l,E=u+u,P=r*_,R=l*_,F=l*b,O=u*_,$=u*b,q=u*E,Y=m*_,rt=m*b,at=m*E;return n[0]=1-F-q,n[1]=R+at,n[2]=O-rt,n[3]=0,n[4]=R-at,n[5]=1-P-q,n[6]=$+Y,n[7]=0,n[8]=O+rt,n[9]=$-Y,n[10]=1-P-F,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}var Vl=gr;function Zr(){var n=new yi(3);return yi!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function bh(n){var t=new yi(3);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function ws(n){var t=n[0],r=n[1],l=n[2];return Math.sqrt(t*t+r*r+l*l)}function so(n,t,r){var l=new yi(3);return l[0]=n,l[1]=t,l[2]=r,l}function dn(n,t,r,l){return n[0]=t,n[1]=r,n[2]=l,n}function Fo(n,t,r){return n[0]=t[0]+r[0],n[1]=t[1]+r[1],n[2]=t[2]+r[2],n}function Ln(n,t,r){return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],n}function Ea(n,t,r){return n[0]=t[0]*r[0],n[1]=t[1]*r[1],n[2]=t[2]*r[2],n}function js(n,t,r){return n[0]=Math.min(t[0],r[0]),n[1]=Math.min(t[1],r[1]),n[2]=Math.min(t[2],r[2]),n}function Js(n,t,r){return n[0]=Math.max(t[0],r[0]),n[1]=Math.max(t[1],r[1]),n[2]=Math.max(t[2],r[2]),n}function Jn(n,t,r){return n[0]=t[0]*r,n[1]=t[1]*r,n[2]=t[2]*r,n}function Ks(n,t,r,l){return n[0]=t[0]+r[0]*l,n[1]=t[1]+r[1]*l,n[2]=t[2]+r[2]*l,n}function Ul(n,t){var r=t[0]-n[0],l=t[1]-n[1],u=t[2]-n[2];return Math.sqrt(r*r+l*l+u*u)}function Qs(n,t){var r=t[0]-n[0],l=t[1]-n[1],u=t[2]-n[2];return r*r+l*l+u*u}function ja(n){var t=n[0],r=n[1],l=n[2];return t*t+r*r+l*l}function Wo(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}function bn(n,t){var r=t[0],l=t[1],u=t[2],m=r*r+l*l+u*u;return m>0&&(m=1/Math.sqrt(m)),n[0]=t[0]*m,n[1]=t[1]*m,n[2]=t[2]*m,n}function ho(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function qo(n,t,r){var l=t[0],u=t[1],m=t[2],_=r[0],b=r[1],E=r[2];return n[0]=u*E-m*b,n[1]=m*_-l*E,n[2]=l*b-u*_,n}function ma(n,t,r,l){var u=t[0],m=t[1],_=t[2];return n[0]=u+l*(r[0]-u),n[1]=m+l*(r[1]-m),n[2]=_+l*(r[2]-_),n}function Kn(n,t,r){var l=t[0],u=t[1],m=t[2],_=r[3]*l+r[7]*u+r[11]*m+r[15];return n[0]=(r[0]*l+r[4]*u+r[8]*m+r[12])/(_=_||1),n[1]=(r[1]*l+r[5]*u+r[9]*m+r[13])/_,n[2]=(r[2]*l+r[6]*u+r[10]*m+r[14])/_,n}function vo(n,t,r){var l=t[0],u=t[1],m=t[2];return n[0]=l*r[0]+u*r[3]+m*r[6],n[1]=l*r[1]+u*r[4]+m*r[7],n[2]=l*r[2]+u*r[5]+m*r[8],n}function ns(n,t,r){var l=r[0],u=r[1],m=r[2],_=r[3],b=t[0],E=t[1],P=t[2],R=u*P-m*E,F=m*b-l*P,O=l*E-u*b;return n[0]=b+_*(R+=R)+u*(O+=O)-m*(F+=F),n[1]=E+_*F+m*R-l*O,n[2]=P+_*O+l*F-u*R,n}function Ds(n){return n[0]=0,n[1]=0,n[2]=0,n}function lo(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]}var Zn=Ln,el=Ea,jl=ws;function Ts(){var n=new yi(4);return yi!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function ga(n,t,r){return n[0]=t[0]*r,n[1]=t[1]*r,n[2]=t[2]*r,n[3]=t[3]*r,n}function Gl(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=r*r+l*l+u*u+m*m;return _>0&&(_=1/Math.sqrt(_)),n[0]=r*_,n[1]=l*_,n[2]=u*_,n[3]=m*_,n}function ds(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3];return n[0]=r[0]*l+r[4]*u+r[8]*m+r[12]*_,n[1]=r[1]*l+r[5]*u+r[9]*m+r[13]*_,n[2]=r[2]*l+r[6]*u+r[10]*m+r[14]*_,n[3]=r[3]*l+r[7]*u+r[11]*m+r[15]*_,n}function Ss(){var n=new yi(4);return yi!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function il(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function Sl(n,t,r){r*=.5;var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E+_*b,n[1]=u*E+m*b,n[2]=m*E-u*b,n[3]=_*E-l*b,n}function Il(n,t,r){r*=.5;var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E-m*b,n[1]=u*E+_*b,n[2]=m*E+l*b,n[3]=_*E-u*b,n}Zr(),Ts();var zs,rl,Ga,$l=Gl,Aa=(zs=Zr(),rl=so(1,0,0),Ga=so(0,1,0),function(n,t,r){var l=ho(t,r);return l<-.999999?(qo(zs,rl,t),jl(zs)<1e-6&&qo(zs,Ga,t),bn(zs,zs),function(u,m,_){_*=.5;var b=Math.sin(_);u[0]=b*m[0],u[1]=b*m[1],u[2]=b*m[2],u[3]=Math.cos(_)}(n,zs,Math.PI),n):l>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(qo(zs,t,r),n[0]=zs[0],n[1]=zs[1],n[2]=zs[2],n[3]=1+l,$l(n,n))});function Hn(){var n=new yi(2);return yi!=Float32Array&&(n[0]=0,n[1]=0),n}function we(n,t){var r=new yi(2);return r[0]=n,r[1]=t,r}function It(n,t,r){return n[0]=t,n[1]=r,n}function Mt(n,t,r){return n[0]=t[0]+r[0],n[1]=t[1]+r[1],n}function Ut(n,t,r){return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n}function he(n,t,r){return n[0]=t[0]*r,n[1]=t[1]*r,n}function le(n){var t=n[0],r=n[1];return Math.sqrt(t*t+r*r)}function Re(n,t){var r=t[0],l=t[1],u=r*r+l*l;return u>0&&(u=1/Math.sqrt(u)),n[0]=t[0]*u,n[1]=t[1]*u,n}function te(n,t){return n[0]*t[0]+n[1]*t[1]}Ss(),Ss(),vn();var ze,We,ci=Ut;function ui(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}Hn();var or=function(){if(We)return ze;function n(t,r,l,u){this.cx=3*t,this.bx=3*(l-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*r,this.by=3*(u-r)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=r,this.p2x=l,this.p2y=u}return We=1,ze=n,n.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,r){if(r===void 0&&(r=1e-6),t<0)return 0;if(t>1)return 1;for(var l=t,u=0;u<8;u++){var m=this.sampleCurveX(l)-t;if(Math.abs(m)<r)return l;var _=this.sampleCurveDerivativeX(l);if(Math.abs(_)<1e-6)break;l-=m/_}var b=0,E=1;for(l=t,u=0;u<20&&(m=this.sampleCurveX(l),!(Math.abs(m-t)<r));u++)t>m?b=l:E=l,l=.5*(E-b)+b;return l},solve:function(t,r){return this.sampleCurveY(this.solveCurveX(t,r))}},ze}(),Ir=ui(or);function Ae(n,t){this.x=n,this.y=t}function bo(n,t){if(Array.isArray(n)){if(!Array.isArray(t)||n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(!bo(n[r],t[r]))return!1;return!0}if(typeof n=="object"&&n!==null&&t!==null){if(typeof t!="object"||Object.keys(n).length!==Object.keys(t).length)return!1;for(const r in n)if(!bo(n[r],t[r]))return!1;return!0}return n===t}Ae.prototype={clone(){return new Ae(this.x,this.y)},add(n){return this.clone()._add(n)},sub(n){return this.clone()._sub(n)},multByPoint(n){return this.clone()._multByPoint(n)},divByPoint(n){return this.clone()._divByPoint(n)},mult(n){return this.clone()._mult(n)},div(n){return this.clone()._div(n)},rotate(n){return this.clone()._rotate(n)},rotateAround(n,t){return this.clone()._rotateAround(n,t)},matMult(n){return this.clone()._matMult(n)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(n){return this.x===n.x&&this.y===n.y},dist(n){return Math.sqrt(this.distSqr(n))},distSqr(n){const t=n.x-this.x,r=n.y-this.y;return t*t+r*r},angle(){return Math.atan2(this.y,this.x)},angleTo(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith(n){return this.angleWithSep(n.x,n.y)},angleWithSep(n,t){return Math.atan2(this.x*t-this.y*n,this.x*n+this.y*t)},_matMult(n){const t=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=t,this},_add(n){return this.x+=n.x,this.y+=n.y,this},_sub(n){return this.x-=n.x,this.y-=n.y,this},_mult(n){return this.x*=n,this.y*=n,this},_div(n){return this.x/=n,this.y/=n,this},_multByPoint(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint(n){return this.x/=n.x,this.y/=n.y,this},_unit(){return this._div(this.mag()),this},_perp(){const n=this.y;return this.y=this.x,this.x=-n,this},_rotate(n){const t=Math.cos(n),r=Math.sin(n),l=r*this.x+t*this.y;return this.x=t*this.x-r*this.y,this.y=l,this},_rotateAround(n,t){const r=Math.cos(n),l=Math.sin(n),u=t.y+l*(this.x-t.x)+r*(this.y-t.y);return this.x=t.x+r*(this.x-t.x)-l*(this.y-t.y),this.y=u,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Ae},Ae.convert=function(n){if(n instanceof Ae)return n;if(Array.isArray(n))return new Ae(+n[0],+n[1]);if(n.x!==void 0&&n.y!==void 0)return new Ae(+n.x,+n.y);throw new Error("Expected [x, y] or {x, y} point format")};const _n=Math.PI/180,Un=180/Math.PI;function rr(n){return n*_n}function bi(n){return n*Un}const Bo=[[0,0],[1,0],[1,1],[0,1]];function wo(n){if(n<=0)return 0;if(n>=1)return 1;const t=n*n,r=t*n;return 4*(n<.5?r:3*(n-t)+r-.75)}function se(n,t,r,l){const u=new Ir(n,t,r,l);return function(m){return u.solve(m)}}const st=se(.25,.1,.25,1);function tt(n,t,r){return Math.min(r,Math.max(t,n))}function Tt(n,t,r){return(r=tt((r-n)/(t-n),0,1))*r*(3-2*r)}function Nt(n,t,r){const l=r-t,u=((n-t)%l+l)%l+t;return u===t?r:u}function Wt(n,t,r){if(!n.length)return r(null,[]);let l=n.length;const u=new Array(n.length);let m=null;n.forEach((_,b)=>{t(_,(E,P)=>{E&&(m=E),u[b]=P,--l==0&&r(m,u)})})}let oe=1;function ye(){return oe++}function Jt(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log2(n)))}function xe(n,t){n.forEach(r=>{t[r]&&(t[r]=t[r].bind(t))})}function ti(n,t,r){const l={};for(const u in n)l[u]=t.call(this,n[u],u,n);return l}function $e(n,t,r){const l={};for(const u in n)t.call(this,n[u],u,n)&&(l[u]=n[u]);return l}function Mi(n){return Array.isArray(n)?n.map(Mi):typeof n=="object"&&n?ti(n,Mi):n}function Ji(n,t){for(let r=0;r<n.length;r++)if(t.indexOf(n[r])>=0)return!0;return!1}const Xi={};function qi(n){Xi[n]||(typeof console<"u"&&console.warn(n),Xi[n]=!0)}function hr(n,t,r){return(r.y-n.y)*(t.x-n.x)>(t.y-n.y)*(r.x-n.x)}function Yi(n){let t=0;for(let r,l,u=0,m=n.length,_=m-1;u<m;_=u++)r=n[u],l=n[_],t+=(l.x-r.x)*(r.y+l.y);return t}function wn([n,t,r]){const l=rr(t+90),u=rr(r);return{x:n*Math.cos(l)*Math.sin(u),y:n*Math.sin(l)*Math.sin(u),z:n*Math.cos(u),azimuthal:t,polar:r}}function Pn(n){return(typeof self<"u"||n!==void 0)&&typeof WorkerGlobalScope<"u"&&(n!==void 0?n:self)instanceof WorkerGlobalScope}function zo(n){const t={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,l,u,m)=>{const _=u||m;return t[l]=!_||_.toLowerCase(),""}),t["max-age"]){const r=parseInt(t["max-age"],10);isNaN(r)?delete t["max-age"]:t["max-age"]=r}return t}let Gr=null;function Wn(n,t){return[n[4*t],n[4*t+1],n[4*t+2],n[4*t+3]]}function an(n,t,r,l){for(;t<r;){const u=t+r>>1;n[u]<l?t=u+1:r=u}return t}function Rr(n,t,r,l){for(;t<r;){const u=t+r>>1;n[u]<=l?t=u+1:r=u}return t}function Bn(n){return n>0?1/(1.001-n):1+n}function jn(n){return n>0?1-1/(1.001-n):-n}function Tn(n,t,r){return(n-t.min)*(r.max-r.min)/(t.max-t.min)+r.min}const Gn={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Gn.API_URL)return null;try{const n=new URL(Gn.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.3.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function os(n){return Gn.API_URL_REGEX.test(n)}function ta(n){return Gn.API_SPRITE_REGEX.test(n)}let El,wh,es,nl,_a,Al;function Pa(){return El==null&&(El=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),El}const $a={now:()=>nl!==void 0?nl:performance.now(),setNow(n){nl=n},restoreNow(){nl=void 0},frame(n){const t=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(t)}},getImageData(n,t=0){const{width:r,height:l}=n;_a||(_a=document.createElement("canvas"));const u=_a.getContext("2d",{willReadFrequently:!0});if(!u)throw new Error("failed to create canvas 2d context");return(r>_a.width||l>_a.height)&&(_a.width=r,_a.height=l),u.clearRect(-t,-t,r+2*t,l+2*t),u.drawImage(n,0,0,r,l),u.getImageData(-t,-t,r+2*t,l+2*t)},resolveURL:n=>(wh||(wh=document.createElement("a")),wh.href=n,wh.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(es==null&&(es=window.matchMedia("(prefers-reduced-motion: reduce)")),es.matches)},hasCanvasFingerprintNoise(){if(Al!==void 0)return Al;if(!Pa())return Al=!1,!1;const n=new OffscreenCanvas(85,1),t=n.getContext("2d",{willReadFrequently:!0});let r=0;for(let u=0;u<n.width;++u)t.fillStyle=`rgba(${r++},${r++},${r++}, 255)`,t.fillRect(u,0,1,1);const l=t.getImageData(0,0,n.width,n.height);r=0;for(let u=0;u<l.data.length;++u)if(u%4!=3&&r++!==l.data[u])return Al=!0,!0;return Al=!1,!1}};function ql(n,t){const r=n.indexOf("?");if(r<0)return`${n}?${new URLSearchParams(t).toString()}`;const l=new URLSearchParams(n.slice(r));for(const u in t)l.set(u,t[u]);return`${n.slice(0,r)}?${l.toString()}`}function Th(n,t={persistentParams:[]}){const r=n.indexOf("?");if(r<0)return n;const l=new URLSearchParams,u=new URLSearchParams(n.slice(r));for(const _ of t.persistentParams){const b=u.get(_);b&&l.set(_,b)}const m=l.toString();return`${n.slice(0,r)}${m.length>0?`?${m}`:""}`}const Ou="mapbox-tiles";let ol=500,Ma=50;const oc=["language","worldview","jobid"];let ss,Gs;function tn(){try{return caches}catch{}}function ea(){const n=tn();n&&ss==null&&(ss=n.open(Ou))}let Mn=1/0;const sc={supported:!1,testSupport:function(n){!ia&&as&&(Ls?Nu(n):Lo=n)}};let Lo,as,ia=!1,Ls=!1;const On=typeof self<"u"?self:{};function Nu(n){const t=n.createTexture();n.bindTexture(n.TEXTURE_2D,t);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,as),n.isContextLost())return;sc.supported=!0}catch{}n.deleteTexture(t),ia=!0}On.document&&(as=On.document.createElement("img"),as.onload=function(){Lo&&Nu(Lo),Lo=null,Ls=!0},as.onerror=function(){ia=!0,Lo=null},as.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Is={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Is);class Rs extends Error{constructor(t,r,l){r===401&&os(l)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=r,this.url=l}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const ra=Pn()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Vu=function(n,t){if(!(/^file:/.test(r=n.url)||/^file:/.test(ra())&&!/^\w+:/.test(r))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(l,u){const m=new AbortController,_=new Request(l.url,{method:l.method||"GET",body:l.body,credentials:l.credentials,headers:l.headers,referrer:ra(),referrerPolicy:l.referrerPolicy,signal:m.signal});let b=!1,E=!1;const P=(R=_.url).indexOf("sku=")>0&&os(R);var R;l.type==="json"&&_.headers.set("Accept","application/json");const F=($,q,Y)=>{if(E)return;if($&&$.message!=="SecurityError"&&qi($.toString()),q&&Y)return O(q);const rt=Date.now();fetch(_).then(at=>{if(at.ok){const gt=P?at.clone():null;return O(at,gt,rt)}return u(new Rs(at.statusText,at.status,l.url))}).catch(at=>{at.name!=="AbortError"&&u(new Error(`${at.message} ${l.url}`))})},O=($,q,Y)=>{(l.type==="arrayBuffer"?$.arrayBuffer():l.type==="json"?$.json():$.text()).then(rt=>{E||(q&&Y&&function(at,gt,yt){if(ea(),ss==null)return;const Pt=zo(gt.headers.get("Cache-Control")||"");if(Pt["no-store"])return;const qt={status:gt.status,statusText:gt.statusText,headers:new Headers};gt.headers.forEach((ee,ne)=>qt.headers.set(ne,ee)),Pt["max-age"]&&qt.headers.set("Expires",new Date(yt+1e3*Pt["max-age"]).toUTCString());const Bt=qt.headers.get("Expires");if(!Bt||new Date(Bt).getTime()-yt<42e4)return;let Yt=Th(at.url,{persistentParams:oc});if(gt.status===206){const ee=at.headers.get("Range");if(!ee)return;qt.status=200,Yt=ql(Yt,{range:ee})}(function(ee,ne){if(Gs===void 0)try{new Response(new ReadableStream),Gs=!0}catch{Gs=!1}Gs?ne(ee.body):ee.blob().then(ne).catch(Le=>qi(Le.message))})(gt,ee=>{const ne=new Response((Le=gt.status)!==200&&Le!==404&&[101,103,204,205,304].includes(Le)?null:ee,qt);var Le;ea(),ss?.then(fe=>fe.put(Yt,ne)).catch(fe=>qi(fe.message))})}(_,q,Y),b=!0,u(null,rt,$.headers))}).catch(rt=>{E||u(new Error(rt.message))})};return P?function($,q){if(ea(),ss==null)return q(null);ss.then(Y=>{let rt=Th($.url,{persistentParams:oc});const at=$.headers.get("Range");at&&(rt=ql(rt,{range:at})),Y.match(rt).then(gt=>{const yt=function(Pt){if(!Pt)return!1;const qt=new Date(Pt.headers.get("Expires")||0),Bt=zo(Pt.headers.get("Cache-Control")||"");return Number(qt)>Date.now()&&!Bt["no-cache"]}(gt);Y.delete(rt).catch(q),yt&&Y.put(rt,gt.clone()).catch(q),q(null,gt,yt)}).catch(q)}).catch(q)}(_,F):F(null,null),{cancel:()=>{E=!0,b||m.abort()}}}(n,t);if(Pn(self)&&self.worker.actor)return self.worker.actor.send("getResource",n,t,void 0,!0)}var r;return function(l,u){const m=new XMLHttpRequest;m.open(l.method||"GET",l.url,!0),l.type==="arrayBuffer"&&(m.responseType="arraybuffer");for(const _ in l.headers)m.setRequestHeader(_,l.headers[_]);return l.type==="json"&&(m.responseType="text",m.setRequestHeader("Accept","application/json")),m.withCredentials=l.credentials==="include",m.onerror=()=>{u(new Error(m.statusText))},m.onload=()=>{if((m.status>=200&&m.status<300||m.status===0)&&m.response!==null){let _=m.response;if(l.type==="json")try{_=JSON.parse(m.response)}catch(E){return u(E)}const b=new Headers;m.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(E=>{const P=E.split(": "),R=P.shift(),F=P.join(": ");b.append(R,F)}),u(null,_,b)}else u(new Rs(m.statusText,m.status,l.url))},m.send(l.body),{cancel:()=>m.abort()}}(n,t)},Pl=function(n,t){return Vu(Object.assign(n,{type:"arrayBuffer"}),t)};function pr(n){const t=document.createElement("a");return t.href=n,t.protocol===location.protocol&&t.host===location.host}const Sh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Zl,Wc;Zl=[],Wc=0;const Ca=function(n,t){if(sc.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),Wc>=Gn.MAX_PARALLEL_IMAGE_REQUESTS){const m={requestParameters:n,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return Zl.push(m),m}Wc++;let r=!1;const l=()=>{if(!r)for(r=!0,Wc--;Zl.length&&Wc<Gn.MAX_PARALLEL_IMAGE_REQUESTS;){const m=Zl.shift(),{requestParameters:_,callback:b,cancelled:E}=m;E||(m.cancel=Ca(_,b).cancel)}},u=Pl(n,(m,_,b)=>{l(),m?t(m):_&&(self.createImageBitmap?function(E,P){const R=new Blob([new Uint8Array(E)],{type:"image/png"});createImageBitmap(R).then(F=>{P(null,F)}).catch(F=>{P(new Error(`Could not load image because of ${F.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(_,(E,P)=>t(E,P,b)):function(E,P){const R=new Image;R.onload=()=>{P(null,R),URL.revokeObjectURL(R.src),R.onload=null,requestAnimationFrame(()=>{R.src=Sh})},R.onerror=()=>P(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const F=new Blob([new Uint8Array(E)],{type:"image/png"});R.src=E.byteLength?URL.createObjectURL(F):Sh}(_,(E,P)=>t(E,P,b)))});return{cancel:()=>{u.cancel(),l()}}};var Eo,sl,Rn,Hr={exports:{}},au={exports:{}},Cn={exports:{}},Uu=function(){if(Rn)return Hr.exports;Rn=1;var n=(Eo||(Eo=1,au.exports=function(r,l){var u,m,_,b,E,P,R,F;for(m=r.length-(u=3&r.length),_=l,E=3432918353,P=461845907,F=0;F<m;)R=255&r.charCodeAt(F)|(255&r.charCodeAt(++F))<<8|(255&r.charCodeAt(++F))<<16|(255&r.charCodeAt(++F))<<24,++F,_=27492+(65535&(b=5*(65535&(_=(_^=R=(65535&(R=(R=(65535&R)*E+(((R>>>16)*E&65535)<<16)&4294967295)<<15|R>>>17))*P+(((R>>>16)*P&65535)<<16)&4294967295)<<13|_>>>19))+((5*(_>>>16)&65535)<<16)&4294967295))+((58964+(b>>>16)&65535)<<16);switch(R=0,u){case 3:R^=(255&r.charCodeAt(F+2))<<16;case 2:R^=(255&r.charCodeAt(F+1))<<8;case 1:_^=R=(65535&(R=(R=(65535&(R^=255&r.charCodeAt(F)))*E+(((R>>>16)*E&65535)<<16)&4294967295)<<15|R>>>17))*P+(((R>>>16)*P&65535)<<16)&4294967295}return _^=r.length,_=2246822507*(65535&(_^=_>>>16))+((2246822507*(_>>>16)&65535)<<16)&4294967295,_=3266489909*(65535&(_^=_>>>13))+((3266489909*(_>>>16)&65535)<<16)&4294967295,(_^=_>>>16)>>>0}),au.exports),t=(sl||(sl=1,Cn.exports=function(r,l){for(var u,m=r.length,_=l^m,b=0;m>=4;)u=1540483477*(65535&(u=255&r.charCodeAt(b)|(255&r.charCodeAt(++b))<<8|(255&r.charCodeAt(++b))<<16|(255&r.charCodeAt(++b))<<24))+((1540483477*(u>>>16)&65535)<<16),_=1540483477*(65535&_)+((1540483477*(_>>>16)&65535)<<16)^(u=1540483477*(65535&(u^=u>>>24))+((1540483477*(u>>>16)&65535)<<16)),m-=4,++b;switch(m){case 3:_^=(255&r.charCodeAt(b+2))<<16;case 2:_^=(255&r.charCodeAt(b+1))<<8;case 1:_=1540483477*(65535&(_^=255&r.charCodeAt(b)))+((1540483477*(_>>>16)&65535)<<16)}return _=1540483477*(65535&(_^=_>>>13))+((1540483477*(_>>>16)&65535)<<16),(_^=_>>>15)>>>0}),Cn.exports);return Hr.exports=n,Hr.exports.murmur3=n,Hr.exports.murmur2=t,Hr.exports}(),qa=ui(Uu);class ya{constructor(t,...r){Object.assign(this,r[0]||{}),this.type=t}}class ac extends ya{constructor(t,r={}){super("error",Object.assign({error:t},r))}}function Xc(n,t,r){r[n]&&r[n].indexOf(t)!==-1||(r[n]=r[n]||[],r[n].push(t))}function Yc(n,t,r){if(r&&r[n]){const l=r[n].indexOf(t);l!==-1&&r[n].splice(l,1)}}class Ml{on(t,r){return this._listeners=this._listeners||{},Xc(t,r,this._listeners),this}off(t,r){return Yc(t,r,this._listeners),Yc(t,r,this._oneTimeListeners),this}once(t,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},Xc(t,r,this._oneTimeListeners),this):new Promise(l=>{this.once(t,l)})}fire(t,r){const l=typeof t=="string"?new ya(t,r):t,u=l.type;if(this.listens(u)){l.target=this;const m=this._listeners&&this._listeners[u]?this._listeners[u].slice():[];for(const E of m)E.call(this,l);const _=this._oneTimeListeners&&this._oneTimeListeners[u]?this._oneTimeListeners[u].slice():[];for(const E of _)Yc(u,E,this._oneTimeListeners),E.call(this,l);const b=this._eventedParent;if(b){const E=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(l,E),b.fire(l)}}else l instanceof ac&&console.error(l.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,r){return this._eventedParent=t,this._eventedParentData=r,this}}class Zo{constructor(t){typeof t=="string"?this.name=t:(this.name=t.name,this.iconsetId=t.iconsetId)}static from(t){return new Zo(t)}static toString(t){return t.iconsetId?`${t.name}${t.iconsetId}`:t.name}static parse(t){const[r,l]=t.split("");return new Zo({name:r,iconsetId:l})}static isEqual(t,r){return t.name===r.name&&t.iconsetId===r.iconsetId}toString(){return Zo.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Ih,up={},Hl=function(){if(Ih)return up;Ih=1;var n={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function t(m){return(m=Math.round(m))<0?0:m>255?255:m}function r(m){return t(m[m.length-1]==="%"?parseFloat(m)/100*255:parseInt(m))}function l(m){return(_=m[m.length-1]==="%"?parseFloat(m)/100:parseFloat(m))<0?0:_>1?1:_;var _}function u(m,_,b){return b<0?b+=1:b>1&&(b-=1),6*b<1?m+(_-m)*b*6:2*b<1?_:3*b<2?m+(_-m)*(2/3-b)*6:m}try{up.parseCSSColor=function(m){var _,b=m.replace(/ /g,"").toLowerCase();if(b in n)return n[b].slice();if(b[0]==="#")return b.length===4?(_=parseInt(b.substr(1),16))>=0&&_<=4095?[(3840&_)>>4|(3840&_)>>8,240&_|(240&_)>>4,15&_|(15&_)<<4,1]:null:b.length===7&&(_=parseInt(b.substr(1),16))>=0&&_<=16777215?[(16711680&_)>>16,(65280&_)>>8,255&_,1]:null;var E=b.indexOf("("),P=b.indexOf(")");if(E!==-1&&P+1===b.length){var R=b.substr(0,E),F=b.substr(E+1,P-(E+1)).split(","),O=1;switch(R){case"rgba":if(F.length!==4)return null;O=l(F.pop());case"rgb":return F.length!==3?null:[r(F[0]),r(F[1]),r(F[2]),O];case"hsla":if(F.length!==4)return null;O=l(F.pop());case"hsl":if(F.length!==3)return null;var $=(parseFloat(F[0])%360+360)%360/360,q=l(F[1]),Y=l(F[2]),rt=Y<=.5?Y*(q+1):Y+q-Y*q,at=2*Y-rt;return[t(255*u(at,rt,$+1/3)),t(255*u(at,rt,$)),t(255*u(at,rt,$-1/3)),O];default:return null}}return null}}catch{}return up}();class Dr{constructor(t,r,l,u=1){this.r=t,this.g=r,this.b=l,this.a=u}static parse(t){if(!t)return;if(t instanceof Dr)return t;if(typeof t!="string")return;const r=Hl.parseCSSColor(t);return r?new Dr(r[0]/255,r[1]/255,r[2]/255,r[3]):void 0}toString(){const[t,r,l,u]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*t)},${Math.round(255*r)},${Math.round(255*l)},${u})`}toNonPremultipliedRenderColor(t){const{r,g:l,b:u,a:m}=this;return new af(t,r,l,u,m)}toPremultipliedRenderColor(t){const{r,g:l,b:u,a:m}=this;return new na(t,r*m,l*m,u*m,m)}clone(){return new Dr(this.r,this.g,this.b,this.a)}}class ju{constructor(t,r,l,u,m,_=!1){if(this.premultiplied=!1,this.premultiplied=_,t){const b=t.image.height,E=b*b;this.premultiplied?(r=m===0?0:r/m*(b-1),l=m===0?0:l/m*(b-1),u=m===0?0:u/m*(b-1)):(r*=b-1,l*=b-1,u*=b-1);const P=Math.floor(r),R=Math.floor(l),F=Math.floor(u),O=Math.ceil(r),$=Math.ceil(l),q=Math.ceil(u),Y=r-P,rt=l-R,at=u-F,gt=t.image.data,yt=4*(P+R*E+F*b),Pt=4*(P+R*E+q*b),qt=4*(P+$*E+F*b),Bt=4*(P+$*E+q*b),Yt=4*(O+R*E+F*b),ee=4*(O+R*E+q*b),ne=4*(O+$*E+F*b),Le=4*(O+$*E+q*b);if(yt<0||Le>=gt.length)throw new Error("out of range");this.r=Vi(Vi(Vi(gt[yt],gt[Pt],at),Vi(gt[qt],gt[Bt],at),rt),Vi(Vi(gt[Yt],gt[ee],at),Vi(gt[ne],gt[Le],at),rt),Y)/255*(this.premultiplied?m:1),this.g=Vi(Vi(Vi(gt[yt+1],gt[Pt+1],at),Vi(gt[qt+1],gt[Bt+1],at),rt),Vi(Vi(gt[Yt+1],gt[ee+1],at),Vi(gt[ne+1],gt[Le+1],at),rt),Y)/255*(this.premultiplied?m:1),this.b=Vi(Vi(Vi(gt[yt+2],gt[Pt+2],at),Vi(gt[qt+2],gt[Bt+2],at),rt),Vi(Vi(gt[Yt+2],gt[ee+2],at),Vi(gt[ne+2],gt[Le+2],at),rt),Y)/255*(this.premultiplied?m:1),this.a=m}else this.r=r,this.g=l,this.b=u,this.a=m}toArray(){const{r:t,g:r,b:l,a:u}=this;return[255*t,255*r,255*l,u]}toHslaArray(){let{r:t,g:r,b:l,a:u}=this;if(this.premultiplied){if(u===0)return[0,0,0,0];const q=1/u;t*=q,r*=q,l*=q}const m=Math.min(Math.max(t,0),1),_=Math.min(Math.max(r,0),1),b=Math.min(Math.max(l,0),1),E=Math.min(m,_,b),P=Math.max(m,_,b),R=P-E,F=.5*(E+P);if(R===0)return[0,0,100*F,u];const O=F>.5?R/(2-P-E):R/(P+E);let $;switch(P){case m:$=60*((_-b)/R+(_<b?6:0));break;case _:$=60*((b-m)/R+2);break;default:$=60*((m-_)/R+4)}return[$,100*O,100*F,u]}toArray01(){const{r:t,g:r,b:l,a:u}=this;return[t,r,l,u]}toArray01Scaled(t){const{r,g:l,b:u}=this;return[r*t,l*t,u*t]}toArray01Linear(){const{r:t,g:r,b:l,a:u}=this;return[Math.pow(t,2.2),Math.pow(r,2.2),Math.pow(l,2.2),u]}}class af extends ju{constructor(t,r,l,u,m){super(t,r,l,u,m,!1)}}class na extends ju{constructor(t,r,l,u,m){super(t,r,l,u,m,!0)}}function Vi(n,t,r){return n*(1-r)+t*r}function Za(n,t,r){return n.map((l,u)=>Vi(l,t[u],r))}Dr.black=new Dr(0,0,0,1),Dr.white=new Dr(1,1,1,1),Dr.transparent=new Dr(0,0,0,0),Dr.red=new Dr(1,0,0,1),Dr.blue=new Dr(0,0,1,1);var al=Object.freeze({__proto__:null,array:Za,color:function(n,t,r){return new Dr(Vi(n.r,t.r,r),Vi(n.g,t.g,r),Vi(n.b,t.b,r),Vi(n.a,t.a,r))},number:Vi});class ll extends Error{constructor(t,r){super(r),this.message=r,this.key=t}}class Cl{constructor(t,r=[]){this.parent=t,this.bindings={};for(const[l,u]of r)this.bindings[l]=u}concat(t){return new Cl(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}const Da={kind:"null"},Oi={kind:"number"},Ur={kind:"string"},sn={kind:"boolean"},Ha={kind:"color"},Jc={kind:"object"},en={kind:"value"},oa={kind:"collator"},Ac={kind:"formatted"},lc={kind:"resolvedImage"};function ps(n,t){return{kind:"array",itemType:n,N:t}}function Oo(n){if(n.kind==="array"){const t=Oo(n.itemType);return typeof n.N=="number"?`array<${t}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${t}>`}return n.kind}const Pc=[Da,Oi,Ur,sn,Ha,Ac,Jc,ps(en),lc];function Ed(n,t){if(t.kind==="error")return null;if(n.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!Ed(n.itemType,t.itemType))&&(typeof n.N!="number"||n.N===t.N))return null}else{if(n.kind===t.kind)return null;if(n.kind==="value"){for(const r of Pc)if(!Ed(r,t))return null}}return`Expected ${Oo(n)} but found ${Oo(t)} instead.`}function Ad(n,t){return t.some(r=>r.kind===n.kind)}function Kc(n,t){return t.some(r=>r==="null"?n===null:r==="array"?Array.isArray(n):r==="object"?n&&!Array.isArray(n)&&typeof n=="object":r===typeof n)}function cc(n,t){return n.kind==="array"&&t.kind==="array"?n.N===t.N&&cc(n.itemType,t.itemType):n.kind===t.kind}class lf{constructor(t,r,l){this.sensitivity=t?r?"variant":"case":r?"accent":"base",this.locale=l,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,r){return this.collator.compare(t,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Qc{constructor(t,r,l,u,m){this.text=t.normalize?t.normalize():t,this.image=r,this.scale=l,this.fontStack=u,this.textColor=m}}class fs{constructor(t){this.sections=t}static fromString(t){return new fs([new Qc(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||!!t.image&&t.image.hasPrimary())}static factory(t){return t instanceof fs?t:fs.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const r of this.sections){if(r.image){const u=r.image.getPrimary().id.toString();t.push(["image",u]);continue}t.push(r.text);const l={};r.fontStack&&(l["text-font"]=["literal",r.fontStack.split(",")]),r.scale&&(l["font-scale"]=r.scale),r.textColor&&(l["text-color"]=["rgba"].concat(r.textColor.toNonPremultipliedRenderColor(null).toArray())),t.push(l)}return t}}class cl{constructor(t,r={}){if(this.id=Zo.from(t),this.options=Object.assign({},r),r.transform){const{a:l,b:u,c:m,d:_,e:b,f:E}=r.transform;this.options.transform=new DOMMatrix([l,u,m,_,b,E])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:t,b:r,c:l,d:u,e:m,f:_}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:t,b:r,c:l,d:u,e:m,f:_}})}static parse(t){let r,l,u,m;try{({name:r,iconsetId:l,params:u,transform:m}=JSON.parse(t)||{})}catch{return null}if(!r)return null;const{a:_,b,c:E,d:P,e:R,f:F}=m||{};return new cl({name:r,iconsetId:l},{params:u,transform:new DOMMatrix([_,b,E,P,R,F])})}scaleSelf(t,r){return this.options.transform.scaleSelf(t,r),this}}class za{constructor(t,r,l,u,m=!1){this.primaryId=Zo.from(t),this.primaryOptions=r,l&&(this.secondaryId=Zo.from(l)),this.secondaryOptions=u,this.available=m}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new cl(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new cl(this.secondaryId,this.secondaryOptions):null}static from(t){return typeof t=="string"?za.build({name:t}):t}static build(t,r,l,u){return!t||typeof t=="object"&&!("name"in t)?null:new za(t,l,r,u)}}function Pd(n,t,r,l){return typeof n=="number"&&n>=0&&n<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof r=="number"&&r>=0&&r<=255?l===void 0||typeof l=="number"&&l>=0&&l<=1?null:`Invalid rgba value [${[n,t,r,l].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof l=="number"?[n,t,r,l]:[n,t,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Gu(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof Dr||n instanceof lf||n instanceof fs||n instanceof za)return!0;if(Array.isArray(n)){for(const t of n)if(!Gu(t))return!1;return!0}if(typeof n=="object"){for(const t in n)if(!Gu(n[t]))return!1;return!0}return!1}function ls(n){if(n===null)return Da;if(typeof n=="string")return Ur;if(typeof n=="boolean")return sn;if(typeof n=="number")return Oi;if(n instanceof Dr)return Ha;if(n instanceof lf)return oa;if(n instanceof fs)return Ac;if(n instanceof za)return lc;if(Array.isArray(n)){const t=n.length;let r;for(const l of n){const u=ls(l);if(r){if(r===u)continue;r=en;break}r=u}return ps(r||en,t)}return Jc}function Wl(n){const t=typeof n;return n===null?"":t==="string"||t==="number"||t==="boolean"?String(n):n instanceof fs||n instanceof za||n instanceof Dr?n.toString():JSON.stringify(n)}class Mc{constructor(t,r){this.type=t,this.value=r}static parse(t,r){if(t.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Gu(t[1]))return r.error("invalid value");const l=t[1];let u=ls(l);const m=r.expectedType;return u.kind!=="array"||u.N!==0||!m||m.kind!=="array"||typeof m.N=="number"&&m.N!==0||(u=m),new Mc(u,l)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Dr?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof fs?this.value.serialize():this.value}}class Ao{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}}const yr={string:Ur,number:Oi,boolean:sn,object:Jc};class zi{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");let l,u=1;const m=t[0];if(m==="array"){let b,E;if(t.length>2){const P=t[1];if(typeof P!="string"||!(P in yr)||P==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);b=yr[P],u++}else b=en;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return r.error('The length argument to "array" must be a positive integer literal',2);E=t[2],u++}l=ps(b,E)}else l=yr[m];const _=[];for(;u<t.length;u++){const b=r.parse(t[u],u,en);if(!b)return null;_.push(b)}return new zi(l,_)}evaluate(t){for(let r=0;r<this.args.length;r++){const l=this.args[r].evaluate(t);if(!Ed(this.type,ls(l)))return l;if(r===this.args.length-1)throw new Ao(`The expression ${JSON.stringify(this.args[r].serialize())} evaluated to ${Oo(ls(l))} but was expected to be of type ${Oo(this.type)}.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,r=[t.kind];if(t.kind==="array"){const l=t.itemType;if(l.kind==="string"||l.kind==="number"||l.kind==="boolean"){r.push(l.kind);const u=t.N;(typeof u=="number"||this.args.length>1)&&r.push(u)}}return r.concat(this.args.map(l=>l.serialize()))}}class Dl{constructor(t){this.type=Ac,this.sections=t}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const l=t[1];if(!Array.isArray(l)&&typeof l=="object")return r.error("First argument must be an image or text section.");const u=[];let m=!1;for(let _=1;_<=t.length-1;++_){const b=t[_];if(m&&typeof b=="object"&&!Array.isArray(b)){m=!1;let E=null;if(b["font-scale"]&&(E=r.parseObjectValue(b["font-scale"],_,"font-scale",Oi),!E))return null;let P=null;if(b["text-font"]&&(P=r.parseObjectValue(b["text-font"],_,"text-font",ps(Ur)),!P))return null;let R=null;if(b["text-color"]&&(R=r.parseObjectValue(b["text-color"],_,"text-color",Ha),!R))return null;const F=u[u.length-1];F.scale=E,F.font=P,F.textColor=R}else{const E=r.parse(t[_],_,en);if(!E)return null;const P=E.type.kind;if(P!=="string"&&P!=="value"&&P!=="null"&&P!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");m=!0,u.push({content:E,scale:null,font:null,textColor:null})}}return new Dl(u)}evaluate(t){return new fs(this.sections.map(r=>{const l=r.content.evaluate(t);return cc(ls(l),lc)?new Qc("",l,null,null,null):new Qc(Wl(l),null,r.scale?r.scale.evaluate(t):null,r.font?r.font.evaluate(t).join(","):null,r.textColor?r.textColor.evaluate(t):null)}))}eachChild(t){for(const r of this.sections)t(r.content),r.scale&&t(r.scale),r.font&&t(r.font),r.textColor&&t(r.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const r of this.sections){t.push(r.content.serialize());const l={};r.scale&&(l["font-scale"]=r.scale.serialize()),r.font&&(l["text-font"]=r.font.serialize()),r.textColor&&(l["text-color"]=r.textColor.serialize()),t.push(l)}return t}}class sr{constructor(t,r,l,u){this._imageWarnHistory={},this.type=lc,this.namePrimary=t,this.nameSecondary=r,l&&(this.paramsPrimary=l.params,this.iconsetIdPrimary=l.iconset?l.iconset.id:void 0),u&&(this.paramsSecondary=u.params,this.iconsetIdSecondary=u.iconset?u.iconset.id:void 0)}static parse(t,r){if(t.length<2)return r.error("Expected two or more arguments.");let l=1;const u=[];function m(){if(l<t.length){const b=r.parse(t[l],l++,Ur);return b?(u.push({image:b,options:{}}),!0):(r.error(u.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function _(){if(l<t.length){const E=t[l];if((b=E)===null||typeof b!="object"||Array.isArray(b))return!0;const P=E.params,R=E.iconset,F=r.concat(l);if(!P&&!R)return l++,!0;if(P){if(typeof P!="object"||P.constructor!==Object)return F.error('Image options "params" should be an object'),!1;const O={},$=F.concat(void 0,"params");for(const q in P){if(!q)return $.error("Image parameter name should be non-empty"),!1;const Y=$.concat(void 0,q).parse(P[q],void 0,Ha,void 0,{typeAnnotation:"coerce"});if(!Y)return!1;O[q]=Y}u[u.length-1].options.params=O}if(R){if(typeof R!="object"||R.constructor!==Object)return F.error('Image options "iconset" should be an object'),!1;if(!R.id)return F.error('Image options "iconset" should have an "id" property'),!1;u[u.length-1].options.iconset=R}return l++,!0}var b;return!0}for(let b=0;b<2;b++)if(!m()||!_())return;return new sr(u[0].image,u[1]?u[1].image:void 0,u[0].options,u[1]?u[1].options:void 0)}evaluateParams(t,r){const l={};if(r){for(const u in r)if(r[u])try{l[u]=r[u].evaluate(t)}catch{continue}if(Object.keys(l).length!==0)return{params:l}}}evaluate(t){const r={name:this.namePrimary.evaluate(t),iconsetId:this.iconsetIdPrimary},l=this.nameSecondary?{name:this.nameSecondary.evaluate(t),iconsetId:this.iconsetIdSecondary}:void 0,u=za.build(r,l,this.paramsPrimary?this.evaluateParams(t,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(t,this.paramsSecondary):void 0);if(u&&t.availableImages){const m=u.getPrimary().id;if(u.available=t.availableImages.some(_=>Zo.isEqual(_,m)),u.available){const _=u.getSecondary()?u.getSecondary().id:null;_&&(u.available=t.availableImages.some(b=>Zo.isEqual(b,_)))}}return u}eachChild(t){if(t(this.namePrimary),this.paramsPrimary)for(const r in this.paramsPrimary)this.paramsPrimary[r]&&t(this.paramsPrimary[r]);if(this.nameSecondary&&(t(this.nameSecondary),this.paramsSecondary))for(const r in this.paramsSecondary)this.paramsSecondary[r]&&t(this.paramsSecondary[r])}outputDefined(){return!1}serializeOptions(t,r){const l={};if(r&&(l.iconset={id:r}),t){l.params={};for(const u in t)t[u]&&(l.params[u]=t[u].serialize())}return Object.keys(l).length>0?l:void 0}serialize(){const t=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const r=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);r&&t.push(r)}if(this.nameSecondary&&(t.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const r=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);r&&t.push(r)}return t}}function lu(n){return Qi(n)?"string":th(n)?"number":dp(n)?"boolean":Array.isArray(n)?"array":n===null?"null":Eh(n)?"object":typeof n}function Eh(n){return n!=null&&!Array.isArray(n)&&typeof n!="function"&&!(n instanceof String||n instanceof Number||n instanceof Boolean)&&typeof n=="object"}function Qi(n){return typeof n=="string"||n instanceof String}function th(n){return typeof n=="number"||n instanceof Number}function dp(n){return typeof n=="boolean"||n instanceof Boolean}const Nf={"to-boolean":sn,"to-color":Ha,"to-number":Oi,"to-string":Ur};class hc{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const l=t[0],u=[];let m=Da;if(l==="to-array"){if(!Array.isArray(t[1]))return null;const _=t[1].length;if(r.expectedType){if(r.expectedType.kind!=="array")return r.error(`Expected ${r.expectedType.kind} but found array.`);m=ps(r.expectedType.itemType,_)}else{if(!(_>0&&Gu(t[1][0])))return null;m=ps(ls(t[1][0]),_)}for(let b=0;b<_;b++){const E=t[1][b];let P;if(Array.isArray(E))P=r.parse(E,void 0,m.itemType);else{const R=lu(E);if(R!==m.itemType.kind)return r.error(`Expected ${m.itemType.kind} but found ${R}.`);P=r.registry.literal.parse(["literal",E===void 0?null:E],r)}if(!P)return null;u.push(P)}}else{if((l==="to-boolean"||l==="to-string")&&t.length!==2)return r.error("Expected one argument.");m=Nf[l];for(let _=1;_<t.length;_++){const b=r.parse(t[_],_,en);if(!b)return null;u.push(b)}}return new hc(m,u)}evaluate(t){if(this.type.kind==="boolean")return!!this.args[0].evaluate(t);if(this.type.kind==="color"){let r,l;for(const u of this.args){if(r=u.evaluate(t),l=null,r instanceof Dr)return r;if(typeof r=="string"){const m=t.parseColor(r);if(m)return m}else if(Array.isArray(r)&&(l=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:Pd(r[0],r[1],r[2],r[3]),!l))return new Dr(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new Ao(l||`Could not parse color from value '${typeof r=="string"?r:String(JSON.stringify(r))}'`)}if(this.type.kind==="number"){let r=null;for(const l of this.args){if(r=l.evaluate(t),r===null)return 0;const u=Number(r);if(!isNaN(u))return u}throw new Ao(`Could not convert ${JSON.stringify(r)} to number.`)}return this.type.kind==="formatted"?fs.fromString(Wl(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?za.build(Wl(this.args[0].evaluate(t))):this.type.kind==="array"?this.args.map(r=>r.evaluate(t)):Wl(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Dl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new sr(this.args[0]).serialize();const t=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(r=>{t.push(r.serialize())}),t}}const cu=["Unknown","Point","LineString","Polygon"];class ms{constructor(t,r,l){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=t,this.options=r,this.iconImageUseTheme=l}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?cu[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(t){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,r=this.featureDistanceData.scale,{x:l,y:u}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(l*r-t[0])+this.featureDistanceData.bearing[1]*(u*r-t[1])}return 0}parseColor(t){let r=this._parseColorCache[t];return r||(r=this._parseColorCache[t]=Dr.parse(t)),r}getConfig(t){return this.options?this.options.get(t):null}}class $s{constructor(t,r,l,u,m){this.name=t,this.type=r,this._evaluate=l,this.args=u,this._overloadIndex=m}evaluate(t){if(!this._evaluate){const r=$s.definitions[this.name];this._evaluate=Array.isArray(r)?r[2]:r.overloads[this._overloadIndex][1]}return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,r){const l=t[0],u=$s.definitions[l];if(!u)return r.error(`Unknown expression "${l}". If you wanted a literal array, use ["literal", [...]].`,0);const m=Array.isArray(u)?u[0]:u.type,_=Array.isArray(u)?[[u[1],u[2]]]:u.overloads,b=[];let E=null,P=-1;for(const[R,F]of _){if(Array.isArray(R)&&R.length!==t.length-1)continue;b.push(R),P++,E=new Nh(r.registry,r.path,null,r.scope,void 0,r._scope,r.options,r.iconImageUseTheme);const O=[];let $=!1;for(let q=1;q<t.length;q++){const Y=t[q],rt=Array.isArray(R)?R[q-1]:R.type,at=E.parse(Y,1+O.length,rt);if(!at){$=!0;break}O.push(at)}if(!$)if(Array.isArray(R)&&R.length!==O.length)E.error(`Expected ${R.length} arguments, but found ${O.length} instead.`);else{for(let q=0;q<O.length;q++){const Y=Array.isArray(R)?R[q]:R.type,rt=O[q];E.concat(q+1).checkSubtype(Y,rt.type)}if(E.errors.length===0)return new $s(l,m,F,O,P)}}if(b.length===1)r.errors.push(...E.errors);else{const R=(b.length?b:_.map(([O])=>O)).map(Ah).join(" | "),F=[];for(let O=1;O<t.length;O++){const $=r.parse(t[O],1+F.length);if(!$)return null;F.push(Oo($.type))}r.error(`Expected arguments of type ${R}, but found (${F.join(", ")}) instead.`)}return null}static register(t,r){$s.definitions=r;for(const l in r)t[l]=$s}}function Ah(n){return Array.isArray(n)?`(${n.map(Oo).join(", ")})`:`(${Oo(n.type)}...)`}class Cc{constructor(t,r,l){this.type=oa,this.locale=l,this.caseSensitive=t,this.diacriticSensitive=r}static parse(t,r){if(t.length!==2)return r.error("Expected one argument.");const l=t[1];if(typeof l!="object"||Array.isArray(l))return r.error("Collator options argument must be an object.");const u=l["case-sensitive"]===void 0?r.parse(!1,1,sn):r.parseObjectValue(l["case-sensitive"],1,"case-sensitive",sn);if(!u)return null;const m=l["diacritic-sensitive"]===void 0?r.parse(!1,1,sn):r.parseObjectValue(l["diacritic-sensitive"],1,"diacritic-sensitive",sn);if(!m)return null;let _=null;return l.locale&&(_=r.parseObjectValue(l.locale,1,"locale",Ur),!_)?null:new Cc(u,m,_)}evaluate(t){return new lf(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}function sa(n,t,r=0,l=n.length-1,u=cf){for(;l>r;){if(l-r>600){const E=l-r+1,P=t-r+1,R=Math.log(E),F=.5*Math.exp(2*R/3),O=.5*Math.sqrt(R*F*(E-F)/E)*(P-E/2<0?-1:1);sa(n,t,Math.max(r,Math.floor(t-P*F/E+O)),Math.min(l,Math.floor(t+(E-P)*F/E+O)),u)}const m=n[t];let _=r,b=l;for(gs(n,r,t),u(n[l],m)>0&&gs(n,r,l);_<b;){for(gs(n,_,b),_++,b--;u(n[_],m)<0;)_++;for(;u(n[b],m)>0;)b--}u(n[r],m)===0?gs(n,r,b):(b++,gs(n,b,l)),b<=t&&(r=b+1),t<=b&&(l=b-1)}}function gs(n,t,r){const l=n[t];n[t]=n[r],n[r]=l}function cf(n,t){return n<t?-1:n>t?1:0}function hf(n){let t=0;for(let r,l,u=0,m=n.length,_=m-1;u<m;_=u++)r=n[u],l=n[_],t+=(l.x-r.x)*(r.y+l.y);return t}function hu(n,t){n[0]=Math.min(n[0],t[0]),n[1]=Math.min(n[1],t[1]),n[2]=Math.max(n[2],t[0]),n[3]=Math.max(n[3],t[1])}function Dc(n,t){return!(n[0]<=t[0]||n[2]>=t[2]||n[1]<=t[1]||n[3]>=t[3])}function Ph(n,t,r){const l=n[0]-t[0],u=n[1]-t[1],m=n[0]-r[0],_=n[1]-r[1];return l*_-m*u==0&&l*m<=0&&u*_<=0}function hl(n,t,r=!1){let l=!1;for(let b=0,E=t.length;b<E;b++){const P=t[b];for(let R=0,F=P.length,O=F-1;R<F;O=R++){const $=P[O],q=P[R];if(Ph(n,$,q))return r;(m=$)[1]>(u=n)[1]!=(_=q)[1]>u[1]&&u[0]<(_[0]-m[0])*(u[1]-m[1])/(_[1]-m[1])+m[0]&&(l=!l)}}var u,m,_;return l}function Vf(n,t,r,l){const u=l[0]-r[0],m=l[1]-r[1],_=(n[0]-r[0])*m-u*(n[1]-r[1]),b=(t[0]-r[0])*m-u*(t[1]-r[1]);return _>0&&b<0||_<0&&b>0}function Qn(n,t,r,l){return(u=[l[0]-r[0],l[1]-r[1]])[0]*(m=[t[0]-n[0],t[1]-n[1]])[1]-u[1]*m[0]!=0&&!(!Vf(n,t,r,l)||!Vf(r,l,n,t));var u,m}function Md(n){const t=new Ae(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=new Ae(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const l of n[0])t.x>l.x&&(t.x=l.x),t.y>l.y&&(t.y=l.y),r.x<l.x&&(r.x=l.x),r.y<l.y&&(r.y=l.y);return{min:t,max:r}}const Mh=8192;function Uf(n,t){const r=(180+n[0])/360,l=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,u=Math.pow(2,t.z);return[Math.round(r*u*Mh),Math.round(l*u*Mh)]}function jf(n,t){for(let r=0;r<t.length;r++)if(hl(n,t[r]))return!0;return!1}function Gf(n,t,r){for(const l of r)for(let u=0,m=l.length,_=m-1;u<m;_=u++)if(Qn(n,t,l[_],l[u]))return!0;return!1}function uc(n,t){for(let r=0;r<n.length;++r)if(!hl(n[r],t))return!1;for(let r=0;r<n.length-1;++r)if(Gf(n[r],n[r+1],t))return!1;return!0}function pp(n,t){for(let r=0;r<t.length;r++)if(uc(n,t[r]))return!0;return!1}function $u(n,t,r){const l=[];for(let u=0;u<n.length;u++){const m=[];for(let _=0;_<n[u].length;_++){const b=Uf(n[u][_],r);hu(t,b),m.push(b)}l.push(m)}return l}function qu(n,t,r){const l=[];for(let u=0;u<n.length;u++){const m=$u(n[u],t,r);l.push(m)}return l}function eh(n,t,r,l){if(n[0]<r[0]||n[0]>r[2]){const u=.5*l;let m=n[0]-r[0]>u?-l:r[0]-n[0]>u?l:0;m===0&&(m=n[0]-r[2]>u?-l:r[2]-n[0]>u?l:0),n[0]+=m}hu(t,n)}function uu(n,t,r,l){const u=Math.pow(2,l.z)*Mh,m=[l.x*Mh,l.y*Mh],_=[];if(!n)return _;for(const b of n)for(const E of b){const P=[E.x+m[0],E.y+m[1]];eh(P,t,r,u),_.push(P)}return _}function xa(n,t,r,l){const u=Math.pow(2,l.z)*Mh,m=[l.x*Mh,l.y*Mh],_=[];if(!n)return _;for(const E of n){const P=[];for(const R of E){const F=[R.x+m[0],R.y+m[1]];hu(t,F),P.push(F)}_.push(P)}if(t[2]-t[0]<=u/2){(b=t)[0]=b[1]=1/0,b[2]=b[3]=-1/0;for(const E of _)for(const P of E)eh(P,t,r,u)}var b;return _}class aa{constructor(t,r){this.type=sn,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Gu(t[1])){const l=t[1];if(l.type==="FeatureCollection")for(let u=0;u<l.features.length;++u){const m=l.features[u].geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new aa(l,l.features[u].geometry)}else if(l.type==="Feature"){const u=l.geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new aa(l,l.geometry)}else if(l.type==="Polygon"||l.type==="MultiPolygon")return new aa(l,l)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(r,l){const u=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=r.canonicalID();if(!_)return!1;if(l.type==="Polygon"){const b=$u(l.coordinates,m,_),E=uu(r.geometry(),u,m,_);if(!Dc(u,m))return!1;for(const P of E)if(!hl(P,b))return!1}if(l.type==="MultiPolygon"){const b=qu(l.coordinates,m,_),E=uu(r.geometry(),u,m,_);if(!Dc(u,m))return!1;for(const P of E)if(!jf(P,b))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(r,l){const u=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=r.canonicalID();if(!_)return!1;if(l.type==="Polygon"){const b=$u(l.coordinates,m,_),E=xa(r.geometry(),u,m,_);if(!Dc(u,m))return!1;for(const P of E)if(!uc(P,b))return!1}if(l.type==="MultiPolygon"){const b=qu(l.coordinates,m,_),E=xa(r.geometry(),u,m,_);if(!Dc(u,m))return!1;for(const P of E)if(!pp(P,b))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Zu={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},fp=1/298.257223563,Cd=fp*(2-fp),Xl=Math.PI/180;class ih{static fromTile(t,r,l){const u=Math.PI*(1-2*(t+.5)/Math.pow(2,r)),m=Math.atan(.5*(Math.exp(u)-Math.exp(-u)))/Xl;return new ih(m,l)}static get units(){return Zu}constructor(t,r){if(t===void 0)throw new Error("No latitude given.");if(r&&!Zu[r])throw new Error(`Unknown unit ${r}. Use one of: ${Object.keys(Zu).join(", ")}`);const l=6378.137*Xl*(r?Zu[r]:1),u=Math.cos(t*Xl),m=1/(1-Cd*(1-u*u)),_=Math.sqrt(m);this.kx=l*_*u,this.ky=l*_*m*(1-Cd)}distance(t,r){const l=La(t[0]-r[0])*this.kx,u=(t[1]-r[1])*this.ky;return Math.sqrt(l*l+u*u)}bearing(t,r){const l=La(r[0]-t[0])*this.kx;return Math.atan2(l,(r[1]-t[1])*this.ky)/Xl}destination(t,r,l){const u=l*Xl;return this.offset(t,Math.sin(u)*r,Math.cos(u)*r)}offset(t,r,l){return[t[0]+r/this.kx,t[1]+l/this.ky]}lineDistance(t){let r=0;for(let l=0;l<t.length-1;l++)r+=this.distance(t[l],t[l+1]);return r}area(t){let r=0;for(let l=0;l<t.length;l++){const u=t[l];for(let m=0,_=u.length,b=_-1;m<_;b=m++)r+=La(u[m][0]-u[b][0])*(u[m][1]+u[b][1])*(l?-1:1)}return Math.abs(r)/2*this.kx*this.ky}along(t,r){let l=0;if(r<=0)return t[0];for(let u=0;u<t.length-1;u++){const m=t[u],_=t[u+1],b=this.distance(m,_);if(l+=b,l>r)return Ch(m,_,(r-(l-b))/b)}return t[t.length-1]}pointToSegmentDistance(t,r,l){let[u,m]=r,_=La(l[0]-u)*this.kx,b=(l[1]-m)*this.ky;if(_!==0||b!==0){const E=(La(t[0]-u)*this.kx*_+(t[1]-m)*this.ky*b)/(_*_+b*b);E>1?(u=l[0],m=l[1]):E>0&&(u+=_/this.kx*E,m+=b/this.ky*E)}return _=La(t[0]-u)*this.kx,b=(t[1]-m)*this.ky,Math.sqrt(_*_+b*b)}pointOnLine(t,r){let l=1/0,u=t[0][0],m=t[0][1],_=0,b=0;for(let E=0;E<t.length-1;E++){let P=t[E][0],R=t[E][1],F=La(t[E+1][0]-P)*this.kx,O=(t[E+1][1]-R)*this.ky,$=0;F===0&&O===0||($=(La(r[0]-P)*this.kx*F+(r[1]-R)*this.ky*O)/(F*F+O*O),$>1?(P=t[E+1][0],R=t[E+1][1]):$>0&&(P+=F/this.kx*$,R+=O/this.ky*$)),F=La(r[0]-P)*this.kx,O=(r[1]-R)*this.ky;const q=F*F+O*O;q<l&&(l=q,u=P,m=R,_=E,b=$)}return{point:[u,m],index:_,t:Math.max(0,Math.min(1,b))}}lineSlice(t,r,l){let u=this.pointOnLine(l,t),m=this.pointOnLine(l,r);if(u.index>m.index||u.index===m.index&&u.t>m.t){const P=u;u=m,m=P}const _=[u.point],b=u.index+1,E=m.index;!Hu(l[b],_[0])&&b<=E&&_.push(l[b]);for(let P=b+1;P<=E;P++)_.push(l[P]);return Hu(l[E],m.point)||_.push(m.point),_}lineSliceAlong(t,r,l){let u=0;const m=[];for(let _=0;_<l.length-1;_++){const b=l[_],E=l[_+1],P=this.distance(b,E);if(u+=P,u>t&&m.length===0&&m.push(Ch(b,E,(t-(u-P))/P)),u>=r)return m.push(Ch(b,E,(r-(u-P))/P)),m;u>t&&m.push(E)}return m}bufferPoint(t,r){const l=r/this.ky,u=r/this.kx;return[t[0]-u,t[1]-l,t[0]+u,t[1]+l]}bufferBBox(t,r){const l=r/this.ky,u=r/this.kx;return[t[0]-u,t[1]-l,t[2]+u,t[3]+l]}insideBBox(t,r){return La(t[0]-r[0])>=0&&La(t[0]-r[2])<=0&&t[1]>=r[1]&&t[1]<=r[3]}}function Hu(n,t){return n[0]===t[0]&&n[1]===t[1]}function Ch(n,t,r){const l=La(t[0]-n[0]);return[n[0]+l*r,n[1]+(t[1]-n[1])*r]}function La(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}class Dd{constructor(t=[],r=(l,u)=>l<u?-1:l>u?1:0){if(this.data=t,this.length=this.data.length,this.compare=r,this.length>0)for(let l=(this.length>>1)-1;l>=0;l--)this._down(l)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(this.length===0)return;const t=this.data[0],r=this.data.pop();return--this.length>0&&(this.data[0]=r,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:r,compare:l}=this,u=r[t];for(;t>0;){const m=t-1>>1,_=r[m];if(l(u,_)>=0)break;r[t]=_,t=m}r[t]=u}_down(t){const{data:r,compare:l}=this,u=this.length>>1,m=r[t];for(;t<u;){let _=1+(t<<1);const b=_+1;if(b<this.length&&l(r[b],r[_])<0&&(_=b),l(r[_],m)>=0)break;r[t]=r[_],t=_}r[t]=m}}var ri=8192;function Dh(n,t){return t.dist-n.dist}const du=100,zh=50;function yn(n){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==n[r])return!1;return!0}function Lh(n){return n[1]-n[0]+1}function zc(n,t){const r=n[1]>=n[0]&&n[1]<t;return r||console.warn("Distance Expression: Index is out of range"),r}function zd(n,t){if(n[0]>n[1])return[null,null];const r=Lh(n);if(t){if(r===2)return[n,null];const l=Math.floor(r/2);return[[n[0],n[0]+l],[n[0]+l,n[1]]]}{if(r===1)return[n,null];const l=Math.floor(r/2)-1;return[[n[0],n[0]+l],[n[0]+l+1,n[1]]]}}function Ra(n,t){const r=[1/0,1/0,-1/0,-1/0];if(!zc(t,n.length))return r;for(let l=t[0];l<=t[1];++l)hu(r,n[l]);return r}function kr(n){const t=[1/0,1/0,-1/0,-1/0];for(let r=0;r<n.length;++r)for(let l=0;l<n[r].length;++l)hu(t,n[r][l]);return t}function Wu(n,t,r){if(yn(n)||yn(t))return NaN;let l=0,u=0;return n[2]<t[0]&&(l=t[0]-n[2]),n[0]>t[2]&&(l=n[0]-t[2]),n[1]>t[3]&&(u=n[1]-t[3]),n[3]<t[1]&&(u=t[1]-n[3]),r.distance([0,0],[l,u])}function $f(n){return 360*n-180}function Mm(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function pu(n,t){const r=Math.pow(2,t.z),l=(n.y/ri+t.y)/r;return[$f((n.x/ri+t.x)/r),Mm(l)]}function mp(n,t){const r=[];for(let l=0;l<n.length;++l)r.push(pu(n[l],t));return r}function Xn(n,t,r){const l=r.pointOnLine(t,n).point;return r.distance(n,l)}function Rh(n,t,r,l,u){const m=r.slice(l[0],l[1]+1);let _=1/0;for(let b=t[0];b<=t[1];++b)if((_=Math.min(_,Xn(n[b],m,u)))===0)return 0;return _}function Xu(n,t,r,l,u){const m=Math.min(u.pointToSegmentDistance(n,r,l),u.pointToSegmentDistance(t,r,l)),_=Math.min(u.pointToSegmentDistance(r,n,t),u.pointToSegmentDistance(l,n,t));return Math.min(m,_)}function qf(n,t,r,l,u){if(!zc(t,n.length)||!zc(l,r.length))return NaN;let m=1/0;for(let _=t[0];_<t[1];++_)for(let b=l[0];b<l[1];++b){if(Qn(n[_],n[_+1],r[b],r[b+1]))return 0;m=Math.min(m,Xu(n[_],n[_+1],r[b],r[b+1],u))}return m}function gp(n,t,r,l,u){if(!zc(t,n.length)||!zc(l,r.length))return NaN;let m=1/0;for(let _=t[0];_<=t[1];++_)for(let b=l[0];b<=l[1];++b)if((m=Math.min(m,u.distance(n[_],r[b])))===0)return m;return m}function _p(n,t,r){if(hl(n,t,!0))return 0;let l=1/0;for(const u of t){const m=u.length;if(m<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(u[0]!==u[m-1]&&(l=Math.min(l,r.pointToSegmentDistance(n,u[m-1],u[0])))===0||(l=Math.min(l,Xn(n,u,r)))===0)return l}return l}function yp(n,t,r,l){if(!zc(t,n.length))return NaN;for(let m=t[0];m<=t[1];++m)if(hl(n[m],r,!0))return 0;let u=1/0;for(let m=t[0];m<t[1];++m)for(const _ of r)for(let b=0,E=_.length,P=E-1;b<E;P=b++){if(Qn(n[m],n[m+1],_[P],_[b]))return 0;u=Math.min(u,Xu(n[m],n[m+1],_[P],_[b],l))}return u}function fu(n,t){for(const r of n)for(let l=0;l<=r.length-1;++l)if(hl(r[l],t,!0))return!0;return!1}function xp(n,t,r,l=1/0){const u=kr(n),m=kr(t);if(l!==1/0&&Wu(u,m,r)>=l)return l;if(Dc(u,m)){if(fu(n,t))return 0}else if(fu(t,n))return 0;let _=l;for(const b of n)for(let E=0,P=b.length,R=P-1;E<P;R=E++)for(const F of t)for(let O=0,$=F.length,q=$-1;O<$;q=O++){if(Qn(b[R],b[E],F[q],F[O]))return 0;_=Math.min(_,Xu(b[R],b[E],F[q],F[O],r))}return _}function Ld(n,t,r,l,u,m,_){if(m===null||_===null)return;const b=Wu(Ra(l,m),Ra(u,_),r);b<t&&n.push({dist:b,range1:m,range2:_})}function Rd(n,t,r,l,u=1/0){let m=Math.min(l.distance(n[0],r[0][0]),u);if(m===0)return m;const _=new Dd([{dist:0,range1:[0,n.length-1],range2:[0,0]}],Dh),b=t?zh:du,E=kr(r);for(;_.length;){const P=_.pop();if(P.dist>=m)continue;const R=P.range1;if(Lh(R)<=b){if(!zc(R,n.length))return NaN;if(t){const F=yp(n,R,r,l);if((m=Math.min(m,F))===0)return m}else for(let F=R[0];F<=R[1];++F){const O=_p(n[F],r,l);if((m=Math.min(m,O))===0)return m}}else{const F=zd(R,t);if(F[0]!==null){const O=Wu(Ra(n,F[0]),E,l);O<m&&_.push({dist:O,range1:F[0],range2:[0,0]})}if(F[1]!==null){const O=Wu(Ra(n,F[1]),E,l);O<m&&_.push({dist:O,range1:F[1],range2:[0,0]})}}}return m}function Zf(n,t,r,l,u,m=1/0){let _=Math.min(m,u.distance(n[0],r[0]));if(_===0)return _;const b=new Dd([{dist:0,range1:[0,n.length-1],range2:[0,r.length-1]}],Dh),E=t?zh:du,P=l?zh:du;for(;b.length;){const R=b.pop();if(R.dist>=_)continue;const F=R.range1,O=R.range2;if(Lh(F)<=E&&Lh(O)<=P){if(!zc(F,n.length)||!zc(O,r.length))return NaN;if(t&&l?_=Math.min(_,qf(n,F,r,O,u)):t||l?t&&!l?_=Math.min(_,Rh(r,O,n,F,u)):!t&&l&&(_=Math.min(_,Rh(n,F,r,O,u))):_=Math.min(_,gp(n,F,r,O,u)),_===0)return _}else{const $=zd(F,t),q=zd(O,l);Ld(b,_,u,n,r,$[0],q[0]),Ld(b,_,u,n,r,$[0],q[1]),Ld(b,_,u,n,r,$[1],q[0]),Ld(b,_,u,n,r,$[1],q[1])}}return _}function kd(n,t,r,l,u=1/0){let m=u;const _=Ra(n,[0,n.length-1]);for(const b of r)if(!(m!==1/0&&Wu(_,Ra(b,[0,b.length-1]),l)>=m)&&(m=Math.min(m,Zf(n,t,b,!0,l,m)),m===0))return m;return m}function kh(n,t,r,l,u=1/0){let m=u;const _=Ra(n,[0,n.length-1]);for(const b of r){if(m!==1/0&&Wu(_,kr(b),l)>=m)continue;const E=Rd(n,t,b,l,m);if(isNaN(E))return E;if((m=Math.min(m,E))===0)return m}return m}function Yu(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class Fh{constructor(t,r){this.type=Oi,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'distance' expression requires either one argument, but found ' ${t.length-1} instead.`);if(Gu(t[1])){const l=t[1];if(l.type==="FeatureCollection"){for(let u=0;u<l.features.length;++u)if(Yu(l.features[u].geometry.type))return new Fh(l,l.features[u].geometry)}else if(l.type==="Feature"){if(Yu(l.geometry.type))return new Fh(l,l.geometry)}else if(Yu(l.type))return new Fh(l,l)}return r.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(t){const r=t.geometry(),l=t.canonicalID();if(r!=null&&l!=null){if(t.geometryType()==="Point")return function(u,m,_){const b=[];for(const P of u)for(const R of P)b.push(pu(R,m));const E=new ih(b[0][1],"meters");return _.type==="Point"||_.type==="MultiPoint"||_.type==="LineString"?Zf(b,!1,_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",E):_.type==="MultiLineString"?kd(b,!1,_.coordinates,E):_.type==="Polygon"||_.type==="MultiPolygon"?kh(b,!1,_.type==="Polygon"?[_.coordinates]:_.coordinates,E):null}(r,l,this.geometries);if(t.geometryType()==="LineString")return function(u,m,_){const b=[];for(const P of u){const R=[];for(const F of P)R.push(pu(F,m));b.push(R)}const E=new ih(b[0][0][1],"meters");if(_.type==="Point"||_.type==="MultiPoint"||_.type==="LineString")return kd(_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",b,E);if(_.type==="MultiLineString"){let P=1/0;for(let R=0;R<_.coordinates.length;R++){const F=kd(_.coordinates[R],!0,b,E,P);if(isNaN(F))return F;if((P=Math.min(P,F))===0)return P}return P}if(_.type==="Polygon"||_.type==="MultiPolygon"){let P=1/0;for(let R=0;R<b.length;R++){const F=kh(b[R],!0,_.type==="Polygon"?[_.coordinates]:_.coordinates,E,P);if(isNaN(F))return F;if((P=Math.min(P,F))===0)return P}return P}return null}(r,l,this.geometries);if(t.geometryType()==="Polygon")return function(u,m,_){const b=[];for(const P of function(R,F){const O=R.length;if(O<=1)return[R];const $=[];let q,Y;for(let rt=0;rt<O;rt++){const at=hf(R[rt]);at!==0&&(R[rt].area=Math.abs(at),Y===void 0&&(Y=at<0),Y===at<0?(q&&$.push(q),q=[R[rt]]):q.push(R[rt]))}return q&&$.push(q),$}(u)){const R=[];for(let F=0;F<P.length;++F)R.push(mp(P[F],m));b.push(R)}const E=new ih(b[0][0][0][1],"meters");if(_.type==="Point"||_.type==="MultiPoint"||_.type==="LineString")return kh(_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",b,E);if(_.type==="MultiLineString"){let P=1/0;for(let R=0;R<_.coordinates.length;R++){const F=kh(_.coordinates[R],!0,b,E,P);if(isNaN(F))return F;if((P=Math.min(P,F))===0)return P}return P}return _.type==="Polygon"||_.type==="MultiPolygon"?function(P,R,F){let O=1/0;for(const $ of P)for(const q of R){const Y=xp($,q,F,O);if(isNaN(Y))return Y;if((O=Math.min(O,Y))===0)return O}return O}(_.type==="Polygon"?[_.coordinates]:_.coordinates,b,E):null}(r,l,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function mu(n){if(n instanceof $s&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof aa||n instanceof Fh)return!1;if(n instanceof ul)return n.featureConstant;let t=!0;return n.eachChild(r=>{t&&!mu(r)&&(t=!1)}),t}function Bh(n){if(n instanceof $s&&n.name==="feature-state")return!1;let t=!0;return n.eachChild(r=>{t&&!Bh(r)&&(t=!1)}),t}function Oh(n,t){if(n instanceof $s&&t.indexOf(n.name)>=0)return!1;let r=!0;return n.eachChild(l=>{r&&!Oh(l,t)&&(r=!1)}),r}function uf(n,t,r){return[n,t,r].filter(Boolean).join("")}function Fd(n,t){switch(n){case"string":return Wl(t);case"number":return+t;case"boolean":return!!t;case"color":return Dr.parse(t);case"formatted":return fs.fromString(Wl(t));case"resolvedImage":return za.build(Wl(t))}return t}function Xo(n,t,r,l){return l!==void 0&&(n=l*Math.round(n/l)),t!==void 0&&n<t&&(n=t),r!==void 0&&n>r&&(n=r),n}class ul{constructor(t,r,l,u=!1){this.type=t,this.key=r,this.scope=l,this.featureConstant=u}static parse(t,r){let l=r.expectedType;if(l==null&&(l=en),t.length<2||t.length>3)return r.error("Invalid number of arguments for 'config' expression.");const u=r.parse(t[1],1);if(!(u instanceof Mc))return r.error("Key name of 'config' expression must be a string literal.");let m,_=!0;const b=Wl(u.value);if(t.length>=3){const E=r.parse(t[2],2);if(!(E instanceof Mc))return r.error("Scope of 'config' expression must be a string literal.");m=Wl(E.value)}if(r.options){const E=uf(b,m,r._scope),P=r.options.get(E);P&&(_=mu(P.value||P.default))}return new ul(l,b,m,_)}evaluate(t){const r=uf(this.key,this.scope,t.scope),l=t.getConfig(r);if(!l)return null;const{type:u,value:m,values:_,minValue:b,maxValue:E,stepValue:P}=l,R=l.default.evaluate(t);let F=R;if(m){const O=t.scope;t.scope=(O||"").split("").slice(1).join(""),F=m.evaluate(t),t.scope=O}return u&&(F=Fd(u,F)),F===void 0||b===void 0&&E===void 0&&P===void 0||(typeof F=="number"?F=Xo(F,b,E,P):Array.isArray(F)&&(F=F.map(O=>typeof O=="number"?Xo(O,b,E,P):O))),m!==void 0&&F!==void 0&&_&&!_.includes(F)&&(F=R,u&&(F=Fd(u,F))),(u&&u!==this.type||F!==void 0&&!cc(ls(F),this.type))&&(F=Fd(this.type.kind,F)),F}eachChild(){}outputDefined(){return!1}serialize(){const t=["config",this.key];return this.scope&&t.concat(this.scope),t}}class va{constructor(t,r){this.type=r.type,this.name=t,this.boundExpression=r}static parse(t,r){if(t.length!==2||typeof t[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const l=t[1];return r.scope.has(l)?new va(l,r.scope.get(l)):r.error(`Unknown variable "${l}". Make sure "${l}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Nh{constructor(t,r=[],l,u=new Cl,m=[],_,b,E){this.registry=t,this.path=r,this.key=r.map(P=>typeof P=="string"?`['${P}']`:`[${P}]`).join(""),this.scope=u,this.errors=m,this.expectedType=l,this._scope=_,this.options=b,this.iconImageUseTheme=E}parse(t,r,l,u,m={}){return r||l?this.concat(r,null,l,u)._parse(t,m):this._parse(t,m)}parseObjectValue(t,r,l,u,m,_={}){return this.concat(r,l,u,m)._parse(t,_)}_parse(t,r){function l(u,m,_){return _==="assert"?new zi(m,[u]):_==="coerce"?new hc(m,[u]):u}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const u=typeof t[0]=="string"?this.registry[t[0]]:void 0;if(u){let m=u.parse(t,this);if(!m)return null;if(this.expectedType){const _=this.expectedType,b=m.type;if(_.kind!=="string"&&_.kind!=="number"&&_.kind!=="boolean"&&_.kind!=="object"&&_.kind!=="array"||b.kind!=="value")if(_.kind!=="color"&&_.kind!=="formatted"&&_.kind!=="resolvedImage"||b.kind!=="value"&&b.kind!=="string"){if(this.checkSubtype(_,b))return null}else m=l(m,_,r.typeAnnotation||"coerce");else m=l(m,_,r.typeAnnotation||"assert")}if(!(m instanceof Mc)&&m.type.kind!=="resolvedImage"&&rh(m)){const _=new ms(this._scope,this.options,this.iconImageUseTheme);try{m=new Mc(m.type,m.evaluate(_))}catch(b){return this.error(b.message),null}}return m}return hc.parse(["to-array",t],this)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,r,l,u){let m=typeof t=="number"?this.path.concat(t):this.path;m=typeof r=="string"?m.concat(r):m;const _=u?this.scope.concat(u):this.scope;return new Nh(this.registry,m,l||null,_,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(t,...r){const l=`${this.key}${r.map(u=>`[${u}]`).join("")}`;this.errors.push(new ll(l,t))}checkSubtype(t,r){const l=Ed(t,r);return l&&this.error(l),l}}function rh(n){if(n instanceof va)return rh(n.boundExpression);if(n instanceof $s&&n.name==="error"||n instanceof Cc||n instanceof aa||n instanceof Fh||n instanceof ul)return!1;const t=n instanceof hc||n instanceof zi;let r=!0;return n.eachChild(l=>{r=t?r&&rh(l):r&&l instanceof Mc}),!!r&&mu(n)&&Oh(n,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Bd(n,t){const r=n.length-1;let l,u,m=0,_=r,b=0;for(;m<=_;)if(b=Math.floor((m+_)/2),l=n[b],u=n[b+1],l<=t){if(b===r||t<u)return b;m=b+1}else{if(!(l>t))throw new Ao("Input is not a number.");_=b-1}return 0}class Lc{constructor(t,r,l){this.type=t,this.input=r,this.labels=[],this.outputs=[];for(const[u,m]of l)this.labels.push(u),this.outputs.push(m)}static parse(t,r){if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");const l=r.parse(t[1],1,Oi);if(!l)return null;const u=[];let m=null;r.expectedType&&r.expectedType.kind!=="value"&&(m=r.expectedType);for(let _=1;_<t.length;_+=2){const b=_===1?-1/0:t[_],E=t[_+1],P=_,R=_+1;if(typeof b!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',P);if(u.length&&u[u.length-1][0]>=b)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',P);const F=r.parse(E,R,m);if(!F)return null;m=m||F.type,u.push([b,F])}return new Lc(m,l,u)}evaluate(t){const r=this.labels,l=this.outputs;if(r.length===1)return l[0].evaluate(t);const u=this.input.evaluate(t);if(u<=r[0])return l[0].evaluate(t);const m=r.length;return u>=r[m-1]?l[m-1].evaluate(t):l[Bd(r,u)].evaluate(t)}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let r=0;r<this.labels.length;r++)r>0&&t.push(this.labels[r]),t.push(this.outputs[r].serialize());return t}}const vp=.95047,Ju=1.08883,bp=4/29,gu=6/29,Ku=3*gu*gu,df=gu*gu*gu,Qu=Math.PI/180,Hf=180/Math.PI;function Rc(n){return n>df?Math.pow(n,1/3):n/Ku+bp}function Od(n){return n>gu?n*n*n:Ku*(n-bp)}function Nd(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function td(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function nh(n){const t=td(n.r),r=td(n.g),l=td(n.b),u=Rc((.4124564*t+.3575761*r+.1804375*l)/vp),m=Rc((.2126729*t+.7151522*r+.072175*l)/1);return{l:116*m-16,a:500*(u-m),b:200*(m-Rc((.0193339*t+.119192*r+.9503041*l)/Ju)),alpha:n.a}}function Vh(n){let t=(n.l+16)/116,r=isNaN(n.a)?t:t+n.a/500,l=isNaN(n.b)?t:t-n.b/200;return t=1*Od(t),r=vp*Od(r),l=Ju*Od(l),new Dr(Nd(3.2404542*r-1.5371385*t-.4985314*l),Nd(-.969266*r+1.8760108*t+.041556*l),Nd(.0556434*r-.2040259*t+1.0572252*l),n.alpha)}function pf(n,t,r){const l=t-n;return n+r*(l>180||l<-180?l-360*Math.round(l/360):l)}const ed={forward:nh,reverse:Vh,interpolate:function(n,t,r){return{l:Vi(n.l,t.l,r),a:Vi(n.a,t.a,r),b:Vi(n.b,t.b,r),alpha:Vi(n.alpha,t.alpha,r)}}},Uh={forward:function(n){const{l:t,a:r,b:l}=nh(n),u=Math.atan2(l,r)*Hf;return{h:u<0?u+360:u,c:Math.sqrt(r*r+l*l),l:t,alpha:n.a}},reverse:function(n){const t=n.h*Qu,r=n.c;return Vh({l:n.l,a:Math.cos(t)*r,b:Math.sin(t)*r,alpha:n.alpha})},interpolate:function(n,t,r){return{h:pf(n.h,t.h,r),c:Vi(n.c,t.c,r),l:Vi(n.l,t.l,r),alpha:Vi(n.alpha,t.alpha,r)}}};var _u=Object.freeze({__proto__:null,hcl:Uh,lab:ed});class dl{constructor(t,r,l,u,m){this.type=t,this.operator=r,this.interpolation=l,this.input=u,this.labels=[],this.outputs=[];for(const[_,b]of m)this.labels.push(_),this.outputs.push(b)}static interpolationFactor(t,r,l,u){let m=0;if(t.name==="exponential")m=pl(r,t.base,l,u);else if(t.name==="linear")m=pl(r,1,l,u);else if(t.name==="cubic-bezier"){const _=t.controlPoints;m=new Ir(_[0],_[1],_[2],_[3]).solve(pl(r,1,l,u))}return m}static parse(t,r){let[l,u,m,..._]=t;if(!Array.isArray(u)||u.length===0)return r.error("Expected an interpolation type expression.",1);if(u[0]==="linear")u={name:"linear"};else if(u[0]==="exponential"){const P=u[1];if(typeof P!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);u={name:"exponential",base:P}}else{if(u[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(u[0])}`,1,0);{const P=u.slice(1);if(P.length!==4||P.some(R=>typeof R!="number"||R<0||R>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);u={name:"cubic-bezier",controlPoints:P}}}if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length-1>3&&(t.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(m=r.parse(m,2,Oi),!m)return null;const b=[];let E=null;l==="interpolate-hcl"||l==="interpolate-lab"?E=Ha:r.expectedType&&r.expectedType.kind!=="value"&&(E=r.expectedType);for(let P=0;P<_.length;P+=2){const R=_[P],F=_[P+1],O=P+3,$=P+4;if(typeof R!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',O);if(b.length&&b[b.length-1][0]>=R)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',O);const q=r.parse(F,$,E);if(!q)return null;E=E||q.type,b.push([R,q])}return E.kind==="number"||E.kind==="color"||E.kind==="array"&&E.itemType.kind==="number"&&typeof E.N=="number"?new dl(E,l,u,m,b):r.error(`Type ${Oo(E)} is not interpolatable.`)}evaluate(t){const r=this.labels,l=this.outputs;if(r.length===1)return l[0].evaluate(t);const u=this.input.evaluate(t);if(u<=r[0])return l[0].evaluate(t);const m=r.length;if(u>=r[m-1])return l[m-1].evaluate(t);const _=Bd(r,u),b=dl.interpolationFactor(this.interpolation,u,r[_],r[_+1]),E=l[_].evaluate(t),P=l[_+1].evaluate(t);return this.operator==="interpolate"?al[this.type.kind.toLowerCase()](E,P,b):this.operator==="interpolate-hcl"?Uh.reverse(Uh.interpolate(Uh.forward(E),Uh.forward(P),b)):ed.reverse(ed.interpolate(ed.forward(E),ed.forward(P),b))}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const r=[this.operator,t,this.input.serialize()];for(let l=0;l<this.labels.length;l++)r.push(this.labels[l],this.outputs[l].serialize());return r}}function pl(n,t,r,l){const u=l-r,m=n-r;return u===0?0:t===1?m/u:(Math.pow(t,m)-1)/(Math.pow(t,u)-1)}class qs{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expectected at least one argument.");let l=null;const u=r.expectedType;u&&u.kind!=="value"&&(l=u);const m=[];for(const b of t.slice(1)){const E=r.parse(b,1+m.length,l,void 0,{typeAnnotation:"omit"});if(!E)return null;l=l||E.type,m.push(E)}const _=u&&m.some(b=>Ed(u,b.type));return new qs(_?en:l,m)}evaluate(t){let r,l=null,u=0;for(const m of this.args){if(u++,l=m.evaluate(t),l&&l instanceof za&&!l.available&&(r||(r=l),l=null,u===this.args.length))return r;if(l!==null)break}return l}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(r=>{t.push(r.serialize())}),t}}class kc{constructor(t,r){this.type=r.type,this.bindings=[].concat(t),this.result=r}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const r of this.bindings)t(r[1]);t(this.result)}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const l=[];for(let m=1;m<t.length-1;m+=2){const _=t[m];if(typeof _!="string")return r.error(`Expected string, but found ${typeof _} instead.`,m);if(/[^a-zA-Z0-9_]/.test(_))return r.error("Variable names must contain only alphanumeric characters or '_'.",m);const b=r.parse(t[m+1],m+1);if(!b)return null;l.push([_,b])}const u=r.parse(t[t.length-1],t.length-1,r.expectedType,l);return u?new kc(l,u):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[r,l]of this.bindings)t.push(r,l.serialize());return t.push(this.result.serialize()),t}}class Yo{constructor(t,r,l){this.type=t,this.index=r,this.input=l}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,Oi),u=r.parse(t[2],2,ps(r.expectedType||en));return l&&u?new Yo(u.type.itemType,l,u):null}evaluate(t){const r=this.index.evaluate(t),l=this.input.evaluate(t);if(r<0)throw new Ao("Array index out of bounds: negative index");if(r>=l.length)throw new Ao("Array index out of bounds: index exceeds array size");if(r!==Math.floor(r))throw new Ao("Array index must be an integer. Use at-interpolated for fractional indices");return l[r]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class yu{constructor(t,r,l){this.type=t,this.index=r,this.input=l}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,Oi),u=r.parse(t[2],2,ps(r.expectedType||en));return l&&u?new yu(u.type.itemType,l,u):null}evaluate(t){const r=this.index.evaluate(t),l=this.input.evaluate(t);if(r<0)throw new Ao(`Array index out of bounds: ${r} < 0.`);if(r>l.length-1)throw new Ao(`Array index out of bounds: ${r} > ${l.length-1}.`);if(r===Math.floor(r))return l[r];const u=Math.floor(r),m=Math.ceil(r),_=l[u],b=l[m];if(typeof _!="number"||typeof b!="number")throw new Ao(`Cannot interpolate between non-number values at index ${r}.`);const E=r-u;return _*(1-E)+b*E}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class oh{constructor(t,r){this.type=sn,this.needle=t,this.haystack=r}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,en),u=r.parse(t[2],2,en);return l&&u?Ad(l.type,[sn,Ur,Oi,Da,en])?new oh(l,u):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Oo(l.type)} instead`):null}evaluate(t){const r=this.needle.evaluate(t),l=this.haystack.evaluate(t);if(l==null)return!1;if(!Kc(r,["boolean","string","number","null"]))throw new Ao(`Expected first argument to be of type boolean, string, number or null, but found ${Oo(ls(r))} instead.`);if(!Kc(l,["string","array"]))throw new Ao(`Expected second argument to be of type array or string, but found ${Oo(ls(l))} instead.`);return l.indexOf(r)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Vd{constructor(t,r,l){this.type=Oi,this.needle=t,this.haystack=r,this.fromIndex=l}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,en),u=r.parse(t[2],2,en);if(!l||!u)return null;if(!Ad(l.type,[sn,Ur,Oi,Da,en]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Oo(l.type)} instead`);if(t.length===4){const m=r.parse(t[3],3,Oi);return m?new Vd(l,u,m):null}return new Vd(l,u)}evaluate(t){const r=this.needle.evaluate(t),l=this.haystack.evaluate(t);if(!Kc(r,["boolean","string","number","null"]))throw new Ao(`Expected first argument to be of type boolean, string, number or null, but found ${Oo(ls(r))} instead.`);if(!Kc(l,["string","array"]))throw new Ao(`Expected second argument to be of type array or string, but found ${Oo(ls(l))} instead.`);if(this.fromIndex){const u=this.fromIndex.evaluate(t);return l.indexOf(r,u)}return l.indexOf(r)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class wp{constructor(t,r,l,u,m,_){this.inputType=t,this.type=r,this.input=l,this.cases=u,this.outputs=m,this.otherwise=_}static parse(t,r){if(t.length<5)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return r.error("Expected an even number of arguments.");let l,u;r.expectedType&&r.expectedType.kind!=="value"&&(u=r.expectedType);const m={},_=[];for(let P=2;P<t.length-1;P+=2){let R=t[P];const F=t[P+1];Array.isArray(R)||(R=[R]);const O=r.concat(P);if(R.length===0)return O.error("Expected at least one branch label.");for(const q of R){if(typeof q!="number"&&typeof q!="string")return O.error("Branch labels must be numbers or strings.");if(typeof q=="number"&&Math.abs(q)>Number.MAX_SAFE_INTEGER)return O.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof q=="number"&&Math.floor(q)!==q)return O.error("Numeric branch labels must be integer values.");if(l){if(O.checkSubtype(l,ls(q)))return null}else l=ls(q);if(m[String(q)]!==void 0)return O.error("Branch labels must be unique.");m[String(q)]=_.length}const $=r.parse(F,P,u);if(!$)return null;u=u||$.type,_.push($)}const b=r.parse(t[1],1,en);if(!b)return null;const E=r.parse(t[t.length-1],t.length-1,u);return E?b.type.kind!=="value"&&r.concat(1).checkSubtype(l,b.type)?null:new wp(l,u,b,m,_,E):null}evaluate(t){const r=this.input.evaluate(t);return(cc(ls(r),this.inputType)&&this.outputs[this.cases[r]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],r=Object.keys(this.cases).sort(),l=[],u={};for(const _ of r){const b=u[this.cases[_]];b===void 0?(u[this.cases[_]]=l.length,l.push([this.cases[_],[_]])):l[b][1].push(_)}const m=_=>this.inputType.kind==="number"?Number(_):_;for(const[_,b]of l)t.push(b.length===1?m(b[0]):b.map(m)),t.push(this.outputs[_].serialize());return t.push(this.otherwise.serialize()),t}}class Fc{constructor(t,r,l){this.type=t,this.branches=r,this.otherwise=l}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return r.error("Expected an odd number of arguments.");let l;r.expectedType&&r.expectedType.kind!=="value"&&(l=r.expectedType);const u=[];for(let _=1;_<t.length-1;_+=2){const b=r.parse(t[_],_,sn);if(!b)return null;const E=r.parse(t[_+1],_+1,l);if(!E)return null;u.push([b,E]),l=l||E.type}const m=r.parse(t[t.length-1],t.length-1,l);return m?new Fc(l,u,m):null}evaluate(t){for(const[r,l]of this.branches)if(r.evaluate(t))return l.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[r,l]of this.branches)t(r),t(l);t(this.otherwise)}outputDefined(){return this.branches.every(([t,r])=>r.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(r=>{t.push(r.serialize())}),t}}class Ud{constructor(t,r,l,u){this.type=t,this.input=r,this.beginIndex=l,this.endIndex=u}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,en),u=r.parse(t[2],2,Oi);if(!l||!u)return null;if(!Ad(l.type,[ps(en),Ur,en]))return r.error(`Expected first argument to be of type array or string, but found ${Oo(l.type)} instead`);if(t.length===4){const m=r.parse(t[3],3,Oi);return m?new Ud(l.type,l,u,m):null}return new Ud(l.type,l,u)}evaluate(t){const r=this.input.evaluate(t),l=this.beginIndex.evaluate(t);if(!Kc(r,["string","array"]))throw new Ao(`Expected first argument to be of type array or string, but found ${Oo(ls(r))} instead.`);if(this.endIndex){const u=this.endIndex.evaluate(t);return r.slice(l,u)}return r.slice(l)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class xu{constructor(t,r){this.type=ps(Ur),this.str=t,this.delimiter=r}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,Ur),u=r.parse(t[2],2,Ur);return l&&u?new xu(l,u):void 0}evaluate(t){const r=this.str.evaluate(t),l=this.delimiter.evaluate(t);return r.split(l)}eachChild(t){t(this.str),t(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function id(n,t){return n==="=="||n==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function Yl(n,t,r,l){return l.compare(t,r)===0}function Ki(n,t,r){const l=n!=="=="&&n!=="!=";return class Eb{constructor(m,_,b){this.type=sn,this.lhs=m,this.rhs=_,this.collator=b,this.hasUntypedArgument=m.type.kind==="value"||_.type.kind==="value"}static parse(m,_){if(m.length!==3&&m.length!==4)return _.error("Expected two or three arguments.");const b=m[0];let E=_.parse(m[1],1,en);if(!E)return null;if(!id(b,E.type))return _.concat(1).error(`"${b}" comparisons are not supported for type '${Oo(E.type)}'.`);let P=_.parse(m[2],2,en);if(!P)return null;if(!id(b,P.type))return _.concat(2).error(`"${b}" comparisons are not supported for type '${Oo(P.type)}'.`);if(E.type.kind!==P.type.kind&&E.type.kind!=="value"&&P.type.kind!=="value")return _.error(`Cannot compare types '${Oo(E.type)}' and '${Oo(P.type)}'.`);l&&(E.type.kind==="value"&&P.type.kind!=="value"?E=new zi(P.type,[E]):E.type.kind!=="value"&&P.type.kind==="value"&&(P=new zi(E.type,[P])));let R=null;if(m.length===4){if(E.type.kind!=="string"&&P.type.kind!=="string"&&E.type.kind!=="value"&&P.type.kind!=="value")return _.error("Cannot use collator to compare non-string types.");if(R=_.parse(m[3],3,oa),!R)return null}return new Eb(E,P,R)}evaluate(m){const _=this.lhs.evaluate(m),b=this.rhs.evaluate(m);if(l&&this.hasUntypedArgument){const E=ls(_),P=ls(b);if(E.kind!==P.kind||E.kind!=="string"&&E.kind!=="number")throw new Ao(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${E.kind}, ${P.kind}) instead.`)}if(this.collator&&!l&&this.hasUntypedArgument){const E=ls(_),P=ls(b);if(E.kind!=="string"||P.kind!=="string")return t(m,_,b)}return this.collator?r(m,_,b,this.collator.evaluate(m)):t(m,_,b)}eachChild(m){m(this.lhs),m(this.rhs),this.collator&&m(this.collator)}outputDefined(){return!0}serialize(){const m=[n];return this.eachChild(_=>{m.push(_.serialize())}),m}}}const vu=Ki("==",function(n,t,r){return t===r},Yl),Tp=Ki("!=",function(n,t,r){return t!==r},function(n,t,r,l){return!Yl(0,t,r,l)}),Wf=Ki("<",function(n,t,r){return t<r},function(n,t,r,l){return l.compare(t,r)<0}),jd=Ki(">",function(n,t,r){return t>r},function(n,t,r,l){return l.compare(t,r)>0}),sh=Ki("<=",function(n,t,r){return t<=r},function(n,t,r,l){return l.compare(t,r)<=0}),rd=Ki(">=",function(n,t,r){return t>=r},function(n,t,r,l){return l.compare(t,r)>=0});class ff{constructor(t,r,l,u,m,_){this.type=Ur,this.number=t,this.locale=r,this.currency=l,this.unit=u,this.minFractionDigits=m,this.maxFractionDigits=_}static parse(t,r){if(t.length!==3)return r.error("Expected two arguments.");const l=r.parse(t[1],1,Oi);if(!l)return null;const u=t[2];if(typeof u!="object"||Array.isArray(u))return r.error("NumberFormat options argument must be an object.");let m=null;if(u.locale&&(m=r.parseObjectValue(u.locale,2,"locale",Ur),!m))return null;let _=null;if(u.currency&&(_=r.parseObjectValue(u.currency,2,"currency",Ur),!_))return null;let b=null;if(u.unit&&(b=r.parseObjectValue(u.unit,2,"unit",Ur),!b))return null;let E=null;if(u["min-fraction-digits"]&&(E=r.parseObjectValue(u["min-fraction-digits"],2,"min-fraction-digits",Oi),!E))return null;let P=null;return u["max-fraction-digits"]&&(P=r.parseObjectValue(u["max-fraction-digits"],2,"max-fraction-digits",Oi),!P)?null:new ff(l,m,_,b,E,P)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class jh{constructor(t){this.type=Oi,this.input=t}static parse(t,r){if(t.length!==2)return r.error(`Expected 1 argument, but found ${t.length-1} instead.`);const l=r.parse(t[1],1);return l?l.type.kind!=="array"&&l.type.kind!=="string"&&l.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${Oo(l.type)} instead.`):new jh(l):null}evaluate(t){const r=this.input.evaluate(t);if(typeof r=="string"||Array.isArray(r))return r.length;throw new Ao(`Expected value to be of type string or array, but found ${Oo(ls(r))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(r=>{t.push(r.serialize())}),t}}function mf(n){return function(){n=1831565813+(n|=0)|0;let t=Math.imul(n^n>>>15,1|n);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const Bc={"==":vu,"!=":Tp,">":jd,"<":Wf,">=":rd,"<=":sh,array:zi,at:Yo,"at-interpolated":yu,boolean:zi,case:Fc,coalesce:qs,collator:Cc,format:Dl,image:sr,in:oh,"index-of":Vd,interpolate:dl,"interpolate-hcl":dl,"interpolate-lab":dl,length:jh,let:kc,literal:Mc,match:wp,number:zi,"number-format":ff,object:zi,slice:Ud,step:Lc,string:zi,"to-boolean":hc,"to-color":hc,"to-number":hc,"to-string":hc,var:va,within:aa,distance:Fh,config:ul,split:xu};function nd(n,[t,r,l,u]){t=t.evaluate(n),r=r.evaluate(n),l=l.evaluate(n);const m=u?u.evaluate(n):1,_=Pd(t,r,l,m);if(_)throw new Ao(_);return new Dr(t/255,r/255,l/255,m)}function Sp(n,[t,r,l,u]){t=t.evaluate(n),r=r.evaluate(n),l=l.evaluate(n);const m=u?u.evaluate(n):1,_=function(P,R,F,O){return typeof P=="number"&&P>=0&&P<=360?typeof R=="number"&&R>=0&&R<=100&&typeof F=="number"&&F>=0&&F<=100?O===void 0||typeof O=="number"&&O>=0&&O<=1?null:`Invalid hsla value [${[P,R,F,O].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof O=="number"?[P,R,F,O]:[P,R,F]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof O=="number"?[P,R,F,O]:[P,R,F]).join(", ")}]: 'h' must be between 0 and 360.`}(t,r,l,m);if(_)throw new Ao(_);const b=`hsla(${t}, ${r}%, ${l}%, ${m})`,E=Dr.parse(b);if(!E)throw new Ao(`Failed to parse HSLA color: ${b}`);return E}function gf(n,t){return n in t}function Gd(n,t){const r=t[n];return r===void 0?null:r}function dc(n){return{type:n}}function bu(n){if(n instanceof ul)return new Set([n.key]);let t=new Set;return n.eachChild(r=>{t=new Set([...t,...bu(r)])}),t}function od(n){if(n instanceof $s&&n.name==="is-active-floor")return!0;let t=!1;return n.eachChild(r=>{!t&&od(r)&&(t=!0)}),t}function wu(n){return{result:"success",value:n}}function ah(n){return{result:"error",value:n}}function Oc(n,t){return!!n&&!!n.parameters&&n.parameters.indexOf(t)>-1}function uo(n){return n["property-type"]==="data-driven"}function _f(n){return Oc(n.expression,"measure-light")}function Tu(n){return Oc(n.expression,"zoom")}function Gh(n){return!!n.expression&&n.expression.interpolated}function sd(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function Ip(n){return n}function ad(n,t){const r=t.type==="color",l=n.stops&&typeof n.stops[0][0]=="object",u=l||!(l||n.property!==void 0),m=n.type||(Gh(t)?"exponential":"interval");if(r&&((n=Object.assign({},n)).stops&&(n.stops=n.stops.map(P=>[P[0],Dr.parse(P[1])])),n.default=Dr.parse(n.default?n.default:t.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!_u[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let _,b,E;if(m==="exponential")_=qh;else if(m==="interval")_=la;else if(m==="categorical"){_=Xf,b=Object.create(null);for(const P of n.stops)b[P[0]]=P[1];E=typeof n.stops[0][0]}else{if(m!=="identity")throw new Error(`Unknown function type "${m}"`);_=xr}if(l){const P={},R=[];for(let $=0;$<n.stops.length;$++){const q=n.stops[$],Y=q[0].zoom;P[Y]===void 0&&(P[Y]={zoom:Y,type:n.type,property:n.property,default:n.default,stops:[]},R.push(Y)),P[Y].stops.push([q[0].value,q[1]])}const F=[];for(const $ of R)F.push([P[$].zoom,ad(P[$],t)]);const O={name:"linear"};return{kind:"composite",interpolationType:O,interpolationFactor:dl.interpolationFactor.bind(void 0,O),zoomStops:F.map($=>$[0]),evaluate:({zoom:$},q)=>qh({stops:F,base:n.base},t,$).evaluate($,q)}}if(u){const P=m==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:P,interpolationFactor:dl.interpolationFactor.bind(void 0,P),zoomStops:n.stops.map(R=>R[0]),evaluate:({zoom:R})=>_(n,t,R,b,E)}}return{kind:"source",evaluate(P,R){const F=R&&R.properties?R.properties[n.property]:void 0;return F===void 0?$h(n.default,t.default):_(n,t,F,b,E)}}}function $h(n,t,r){return n!==void 0?n:t!==void 0?t:r!==void 0?r:void 0}function Xf(n,t,r,l,u){return $h(typeof r===u?l[r]:void 0,n.default,t.default)}function la(n,t,r){if(!th(r))return $h(n.default,t.default);const l=n.stops.length;if(l===1||r<=n.stops[0][0])return n.stops[0][1];if(r>=n.stops[l-1][0])return n.stops[l-1][1];const u=Bd(n.stops.map(m=>m[0]),r);return n.stops[u][1]}function qh(n,t,r){const l=n.base!==void 0?n.base:1;if(!th(r))return $h(n.default,t.default);const u=n.stops.length;if(u===1||r<=n.stops[0][0])return n.stops[0][1];if(r>=n.stops[u-1][0])return n.stops[u-1][1];const m=Bd(n.stops.map(R=>R[0]),r),_=function(R,F,O,$){const q=$-O,Y=R-O;return q===0?0:F===1?Y/q:(Math.pow(F,Y)-1)/(Math.pow(F,q)-1)}(r,l,n.stops[m][0],n.stops[m+1][0]),b=n.stops[m][1],E=n.stops[m+1][1];let P=al[t.type]||Ip;if(n.colorSpace&&n.colorSpace!=="rgb"){const R=_u[n.colorSpace];P=(F,O)=>R.reverse(R.interpolate(R.forward(F),R.forward(O),_))}return typeof b.evaluate=="function"?{evaluate(...R){const F=b.evaluate.apply(void 0,R),O=E.evaluate.apply(void 0,R);if(F!==void 0&&O!==void 0)return P(F,O,_)}}:P(b,E,_)}function xr(n,t,r){return t.type==="color"?r=Dr.parse(r):t.type==="formatted"?r=fs.fromString(r.toString()):t.type==="resolvedImage"?r=za.build(r.toString()):lu(r)===t.type||t.type==="enum"&&t.values[r]||(r=void 0),$h(r,n.default,t.default)}$s.register(Bc,{error:[{kind:"error"},[Ur],(n,[t])=>{throw new Ao(t.evaluate(n))}],typeof:[Ur,[en],(n,[t])=>Oo(ls(t.evaluate(n)))],"to-rgba":[ps(Oi,4),[Ha],(n,[t])=>t.evaluate(n).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[ps(Oi,4),[Ha],(n,[t])=>t.evaluate(n).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Ha,[Oi,Oi,Oi],nd],rgba:[Ha,[Oi,Oi,Oi,Oi],nd],hsl:[Ha,[Oi,Oi,Oi],Sp],hsla:[Ha,[Oi,Oi,Oi,Oi],Sp],has:{type:sn,overloads:[[[Ur],(n,[t])=>gf(t.evaluate(n),n.properties())],[[Ur,Jc],(n,[t,r])=>gf(t.evaluate(n),r.evaluate(n))]]},get:{type:en,overloads:[[[Ur],(n,[t])=>Gd(t.evaluate(n),n.properties())],[[Ur,Jc],(n,[t,r])=>Gd(t.evaluate(n),r.evaluate(n))]]},"feature-state":[en,[Ur],(n,[t])=>Gd(t.evaluate(n),n.featureState||{})],properties:[Jc,[],n=>n.properties()],"geometry-type":[Ur,[],n=>n.geometryType()],worldview:[Ur,[],n=>n.globals.worldview||""],"is-active-floor":[sn,dc(Ur),(n,t)=>{if(!(n.globals.activeFloors&&n.globals.activeFloors.size>0))return!1;const r=n.globals.activeFloors;return t.some(l=>{const u=l.evaluate(n);return r.has(u)})}],id:[en,[],n=>n.id()],zoom:[Oi,[],n=>n.globals.zoom],pitch:[Oi,[],n=>n.globals.pitch||0],"distance-from-center":[Oi,[],n=>n.distanceFromCenter()],"measure-light":[Oi,[Ur],(n,[t])=>n.measureLight(t.evaluate(n))],"heatmap-density":[Oi,[],n=>n.globals.heatmapDensity||0],"line-progress":[Oi,[],n=>n.globals.lineProgress||0],"raster-value":[Oi,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[Oi,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[Oi,[],n=>n.globals.skyRadialProgress||0],accumulated:[en,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[Oi,dc(Oi),(n,t)=>{let r=0;for(const l of t)r+=l.evaluate(n);return r}],"*":[Oi,dc(Oi),(n,t)=>{let r=1;for(const l of t)r*=l.evaluate(n);return r}],"-":{type:Oi,overloads:[[[Oi,Oi],(n,[t,r])=>t.evaluate(n)-r.evaluate(n)],[[Oi],(n,[t])=>-t.evaluate(n)]]},"/":[Oi,[Oi,Oi],(n,[t,r])=>t.evaluate(n)/r.evaluate(n)],"%":[Oi,[Oi,Oi],(n,[t,r])=>t.evaluate(n)%r.evaluate(n)],ln2:[Oi,[],()=>Math.LN2],pi:[Oi,[],()=>Math.PI],e:[Oi,[],()=>Math.E],"^":[Oi,[Oi,Oi],(n,[t,r])=>Math.pow(t.evaluate(n),r.evaluate(n))],sqrt:[Oi,[Oi],(n,[t])=>Math.sqrt(t.evaluate(n))],log10:[Oi,[Oi],(n,[t])=>Math.log(t.evaluate(n))/Math.LN10],ln:[Oi,[Oi],(n,[t])=>Math.log(t.evaluate(n))],log2:[Oi,[Oi],(n,[t])=>Math.log2(t.evaluate(n))],sin:[Oi,[Oi],(n,[t])=>Math.sin(t.evaluate(n))],cos:[Oi,[Oi],(n,[t])=>Math.cos(t.evaluate(n))],tan:[Oi,[Oi],(n,[t])=>Math.tan(t.evaluate(n))],asin:[Oi,[Oi],(n,[t])=>Math.asin(t.evaluate(n))],acos:[Oi,[Oi],(n,[t])=>Math.acos(t.evaluate(n))],atan:[Oi,[Oi],(n,[t])=>Math.atan(t.evaluate(n))],min:[Oi,dc(Oi),(n,t)=>Math.min(...t.map(r=>r.evaluate(n)))],max:[Oi,dc(Oi),(n,t)=>Math.max(...t.map(r=>r.evaluate(n)))],abs:[Oi,[Oi],(n,[t])=>Math.abs(t.evaluate(n))],round:[Oi,[Oi],(n,[t])=>{const r=t.evaluate(n);return r<0?-Math.round(-r):Math.round(r)}],floor:[Oi,[Oi],(n,[t])=>Math.floor(t.evaluate(n))],ceil:[Oi,[Oi],(n,[t])=>Math.ceil(t.evaluate(n))],"filter-==":[sn,[Ur,en],(n,[t,r])=>n.properties()[t.value]===r.value],"filter-id-==":[sn,[en],(n,[t])=>n.id()===t.value],"filter-type-==":[sn,[Ur],(n,[t])=>n.geometryType()===t.value],"filter-<":[sn,[Ur,en],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l<u}],"filter-id-<":[sn,[en],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r<l}],"filter->":[sn,[Ur,en],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l>u}],"filter-id->":[sn,[en],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r>l}],"filter-<=":[sn,[Ur,en],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l<=u}],"filter-id-<=":[sn,[en],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r<=l}],"filter->=":[sn,[Ur,en],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l>=u}],"filter-id->=":[sn,[en],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r>=l}],"filter-has":[sn,[en],(n,[t])=>t.value in n.properties()],"filter-has-id":[sn,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[sn,[ps(Ur)],(n,[t])=>t.value.indexOf(n.geometryType())>=0],"filter-id-in":[sn,[ps(en)],(n,[t])=>t.value.indexOf(n.id())>=0],"filter-in-small":[sn,[Ur,ps(en)],(n,[t,r])=>r.value.indexOf(n.properties()[t.value])>=0],"filter-in-large":[sn,[Ur,ps(en)],(n,[t,r])=>function(l,u,m,_){for(;m<=_;){const b=m+_>>1;if(u[b]===l)return!0;u[b]>l?_=b-1:m=b+1}return!1}(n.properties()[t.value],r.value,0,r.value.length-1)],all:{type:sn,overloads:[[[sn,sn],(n,[t,r])=>t.evaluate(n)&&r.evaluate(n)],[dc(sn),(n,t)=>{for(const r of t)if(!r.evaluate(n))return!1;return!0}]]},any:{type:sn,overloads:[[[sn,sn],(n,[t,r])=>t.evaluate(n)||r.evaluate(n)],[dc(sn),(n,t)=>{for(const r of t)if(r.evaluate(n))return!0;return!1}]]},"!":[sn,[sn],(n,[t])=>!t.evaluate(n)],"is-supported-script":[sn,[Ur],(n,[t])=>{const r=n.globals&&n.globals.isSupportedScript;return!r||r(t.evaluate(n))}],upcase:[Ur,[Ur],(n,[t])=>t.evaluate(n).toUpperCase()],downcase:[Ur,[Ur],(n,[t])=>t.evaluate(n).toLowerCase()],concat:[Ur,dc(en),(n,t)=>t.map(r=>Wl(r.evaluate(n))).join("")],"resolved-locale":[Ur,[oa],(n,[t])=>t.evaluate(n).resolvedLocale()],random:[Oi,[Oi,Oi,en],(n,t)=>{const[r,l,u]=t.map(_=>_.evaluate(n));if(r>l||r===l)return r;let m;if(typeof u=="string")m=function(_){let b=0;if(_.length===0)return b;for(let E=0;E<_.length;E++)b=(b<<5)-b+_.charCodeAt(E),b|=0;return b}(u);else{if(typeof u!="number")throw new Ao(`Invalid seed input: ${u}`);m=u}return r+mf(m)()*(l-r)}]});class zr{constructor(t,r,l,u,m){this.expression=t,this._warningHistory={},this._scope=l,this._options=u,this._iconImageUseTheme=m,this._evaluator=new ms(l,u,m),this._defaultValue=r?function(_){return _.type==="color"&&(sd(_.default)||Array.isArray(_.default))?new Dr(0,0,0,0):_.type==="color"?Dr.parse(_.default)||null:_.default===void 0?null:_.default}(r):null,this._enumValues=r&&r.type==="enum"?r.values:null,this.configDependencies=bu(t),this.isIndoorDependent=od(t)}evaluateWithoutErrorHandling(t,r,l,u,m,_,b,E){return this._evaluator.globals=t,this._evaluator.feature=r,this._evaluator.featureState=l,this._evaluator.canonical=u||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=E||null,this.expression.evaluate(this._evaluator)}evaluate(t,r,l,u,m,_,b,E,P){this._evaluator||(this._evaluator=new ms(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=t,this._evaluator.feature=r||null,this._evaluator.featureState=l||null,this._evaluator.canonical=u||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_||null,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=E||null,this._evaluator.iconImageUseTheme=P||null;try{const R=this.expression.evaluate(this._evaluator);if(R==null||typeof R=="number"&&R!=R)return this._defaultValue;if(this._enumValues&&!(R in this._enumValues))throw new Ao(`Expected value to be one of ${Object.keys(this._enumValues).map(F=>JSON.stringify(F)).join(", ")}, but found ${JSON.stringify(R)} instead.`);return R}catch(R){return this._warningHistory[R.message]||(this._warningHistory[R.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${R.message}`)),this._defaultValue}}}function Zh(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in Bc}function pc(n,t,r,l,u){const m=new Nh(Bc,[],t?function(b){const E={color:Ha,string:Ur,number:Oi,enum:Ur,boolean:sn,formatted:Ac,resolvedImage:lc};return b.type==="array"?ps(E[b.value]||en,b.length):E[b.type]}(t):void 0,void 0,void 0,r,l,u),_=m.parse(n,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return _?wu(new zr(_,t,r,l,u)):ah(m.errors)}class lh{constructor(t,r,l,u){this.kind=t,this._styleExpression=r,this.isLightConstant=l,this.isLineProgressConstant=u,this.isStateDependent=t!=="constant"&&!Bh(r.expression),this.configDependencies=bu(r.expression),this.isIndoorDependent=od(r.expression)}evaluateWithoutErrorHandling(t,r,l,u,m,_){return this._styleExpression.evaluateWithoutErrorHandling(t,r,l,u,m,_)}evaluate(t,r,l,u,m,_,b){return this._styleExpression.evaluate(t,r,l,u,m,_,void 0,void 0,b)}}class cs{constructor(t,r,l,u,m,_){this.kind=t,this.zoomStops=l,this._styleExpression=r,this.isStateDependent=t!=="camera"&&!Bh(r.expression),this.isIndoorDependent=od(r.expression),this.isLightConstant=m,this.isLineProgressConstant=_,this.configDependencies=bu(r.expression),this.interpolationType=u}evaluateWithoutErrorHandling(t,r,l,u,m,_){return this._styleExpression.evaluateWithoutErrorHandling(t,r,l,u,m,_)}evaluate(t,r,l,u,m,_){return this._styleExpression.evaluate(t,r,l,u,m,_)}interpolationFactor(t,r,l){return this.interpolationType?dl.interpolationFactor(this.interpolationType,t,r,l):0}}function fl(n,t,r,l,u){if((n=pc(n,t,r,l,u)).result==="error")return n;const m=n.value.expression,_=mu(m);if(!_&&!uo(t))return ah([new ll("","data expressions not supported")]);const b=Oh(m,["zoom","pitch","distance-from-center"]);if(!b&&!Tu(t))return ah([new ll("","zoom expressions not supported")]);const E=Oh(m,["measure-light"]);if(!E&&!_f(t))return ah([new ll("","measure-light expression not supported")]);const P=Oh(m,["line-progress"]);if(!P&&!function(O){return Oc(O.expression,"line-progress")}(t))return ah([new ll("","line-progress expression not supported")]);const R=t.expression&&t.expression.relaxZoomRestriction,F=Ep(m);return F||b||R?F instanceof ll?ah([F]):F instanceof dl&&!Gh(t)?ah([new ll("",'"interpolate" expressions cannot be used with this property')]):wu(F?new cs(_&&P?"camera":"composite",n.value,F.labels,F instanceof dl?F.interpolation:void 0,E,P):new lh(_&&P?"constant":"source",n.value,E,P)):ah([new ll("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class $d{constructor(t,r){this._parameters=t,this._specification=r,Object.assign(this,ad(this._parameters,this._specification))}static deserialize(t){return new $d(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Ep(n){let t=null;if(n instanceof kc)t=Ep(n.result);else if(n instanceof qs){for(const r of n.args)if(t=Ep(r),t)break}else(n instanceof Lc||n instanceof dl)&&n.input instanceof $s&&n.input.name==="zoom"&&(t=n);return t instanceof ll||n.eachChild(r=>{const l=Ep(r);l instanceof ll?t=l:t&&l&&t!==l&&(t=new ll("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}var qd,Ap,ld=function(){if(Ap)return qd;Ap=1,qd=t;var n=3;function t(r,l,u){var m=this.cells=[];if(r instanceof ArrayBuffer){this.arrayBuffer=r;var _=new Int32Array(this.arrayBuffer);r=_[0],this.d=(l=_[1])+2*(u=_[2]);for(var b=0;b<this.d*this.d;b++){var E=_[n+b],P=_[n+b+1];m.push(E===P?null:_.subarray(E,P))}var R=_[n+m.length+1];this.keys=_.subarray(_[n+m.length],R),this.bboxes=_.subarray(R),this.insert=this._insertReadonly}else{this.d=l+2*u;for(var F=0;F<this.d*this.d;F++)m.push([]);this.keys=[],this.bboxes=[]}this.n=l,this.extent=r,this.padding=u,this.scale=l/r,this.uid=0;var O=u/l*r;this.min=-O,this.max=r+O}return t.prototype.insert=function(r,l,u,m,_){this._forEachCell(l,u,m,_,this._insertCell,this.uid++),this.keys.push(r),this.bboxes.push(l),this.bboxes.push(u),this.bboxes.push(m),this.bboxes.push(_)},t.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},t.prototype._insertCell=function(r,l,u,m,_,b){this.cells[_].push(b)},t.prototype.query=function(r,l,u,m,_){var b=this.min,E=this.max;if(r<=b&&l<=b&&E<=u&&E<=m&&!_)return Array.prototype.slice.call(this.keys);var P=[];return this._forEachCell(r,l,u,m,this._queryCell,P,{},_),P},t.prototype._queryCell=function(r,l,u,m,_,b,E,P){var R=this.cells[_];if(R!==null)for(var F=this.keys,O=this.bboxes,$=0;$<R.length;$++){var q=R[$];if(E[q]===void 0){var Y=4*q;(P?P(O[Y+0],O[Y+1],O[Y+2],O[Y+3]):r<=O[Y+2]&&l<=O[Y+3]&&u>=O[Y+0]&&m>=O[Y+1])?(E[q]=!0,b.push(F[q])):E[q]=!1}}},t.prototype._forEachCell=function(r,l,u,m,_,b,E,P){for(var R=this._convertToCellCoord(r),F=this._convertToCellCoord(l),O=this._convertToCellCoord(u),$=this._convertToCellCoord(m),q=R;q<=O;q++)for(var Y=F;Y<=$;Y++){var rt=this.d*Y+q;if((!P||P(this._convertFromCellCoord(q),this._convertFromCellCoord(Y),this._convertFromCellCoord(q+1),this._convertFromCellCoord(Y+1)))&&_.call(this,r,l,u,m,rt,b,E,P))return}},t.prototype._convertFromCellCoord=function(r){return(r-this.padding)/this.scale},t.prototype._convertToCellCoord=function(r){return Math.max(0,Math.min(this.d-1,Math.floor(r*this.scale)+this.padding))},t.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var r=this.cells,l=n+this.cells.length+1+1,u=0,m=0;m<this.cells.length;m++)u+=this.cells[m].length;var _=new Int32Array(l+u+this.keys.length+this.bboxes.length);_[0]=this.extent,_[1]=this.n,_[2]=this.padding;for(var b=l,E=0;E<r.length;E++){var P=r[E];_[n+E]=b,_.set(P,b),b+=P.length}return _[n+r.length]=b,_.set(this.keys,b),_[n+r.length+1]=b+=this.keys.length,_.set(this.bboxes,b),b+=this.bboxes.length,_.buffer},qd}(),to=ui(ld);const Go={};function Si(n,t,r={}){Object.defineProperty(n,"_classRegistryKey",{value:t,writable:!1}),Go[t]={klass:n,omit:r.omit||[]}}Si(Object,"Object"),to.serialize=function(n,t){const r=n.toArrayBuffer();return t&&t.add(r),{buffer:r}},to.deserialize=function(n){return new to(n.buffer)},Object.defineProperty(to,"name",{value:"Grid"}),Si(to,"Grid"),delete Ae.prototype.constructor,typeof DOMMatrix<"u"&&Si(DOMMatrix,"DOMMatrix"),Si(Dr,"Color"),Si(Error,"Error"),Si(fs,"Formatted"),Si(Qc,"FormattedSection"),Si(Rs,"AJAXError"),Si(za,"ResolvedImage"),Si($d,"StylePropertyFunction"),Si(zr,"StyleExpression",{omit:["_evaluator"]}),Si(Zo,"ImageId"),Si(cl,"ImageVariant"),Si(cs,"ZoomDependentExpression"),Si(lh,"ZoomConstantExpression"),Si($s,"CompoundExpression",{omit:["_evaluate"]});for(const n in Bc)Go[Bc[n]._classRegistryKey]||Si(Bc[n],`Expression${n}`);function Su(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function zl(n){return self.ImageBitmap&&n instanceof ImageBitmap}function Nc(n,t){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(Su(n)||zl(n))return t&&t.add(n),n;if(ArrayBuffer.isView(n))return t&&t.add(n.buffer),n;if(n instanceof ImageData)return t&&t.add(n.data.buffer),n;if(Array.isArray(n)){const r=[];for(const l of n)r.push(Nc(l,t));return r}if(n instanceof Map){const r={$name:"Map",entries:[]};for(const[l,u]of n.entries())r.entries.push(Nc(l),Nc(u,t));return r}if(n instanceof Set){const r={$name:"Set"};let l=0;for(const u of n.values())r[++l]=Nc(u);return r}if(n instanceof DOMMatrix){const r={$name:"DOMMatrix"},l=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const u of l)r[u]=n[u];return r}if(typeof n=="bigint")return{$name:"BigInt",value:n.toString()};if(typeof n=="object"){const r=n.constructor,l=r._classRegistryKey;if(!l)throw new Error(`Can't serialize object of unregistered class "${r.name}".`);const u=r.serialize?r.serialize(n,t):{};if(!r.serialize){for(const m in n)n.hasOwnProperty(m)&&(Go[l].omit.indexOf(m)>=0||(u[m]=Nc(n[m],t)));n instanceof Error&&(u.message=n.message)}if(u.$name)throw new Error("$name property is reserved for worker serialization logic.");return l!=="Object"&&(u.$name=l),u}throw new Error("can't serialize object of type "+typeof n)}function Vc(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||Su(n)||zl(n)||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map(Vc);if(typeof n=="object"){const t=n.$name||"Object";if(t==="Map"){const u=n.entries||[],m=new Map;for(let _=0;_<u.length;_+=2)m.set(Vc(u[_]),Vc(u[_+1]));return m}if(t==="Set"){const u=new Set;for(const m of Object.keys(n))m!=="$name"&&u.add(Vc(n[m]));return u}if(t==="DOMMatrix"){let u;return u=n.is2D?[n.a,n.b,n.c,n.d,n.e,n.f]:[n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.m41,n.m42,n.m43,n.m44],new DOMMatrix(u)}if(t==="BigInt")return BigInt(n.value);const{klass:r}=Go[t];if(!r)throw new Error(`Can't deserialize unregistered class "${t}".`);if(r.deserialize)return r.deserialize(n);const l=Object.create(r.prototype);for(const u of Object.keys(n))u!=="$name"&&(l[u]=Vc(n[u]));return l}throw new Error("can't deserialize object of type "+typeof n)}const $i={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,Osage:n=>n>=66736&&n<=66815,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function Hh(n){for(const t of n)if(Wh(t.charCodeAt(0)))return!0;return!1}function cd(n){for(const t of n)if(!Iu(t.charCodeAt(0)))return!1;return!0}function Iu(n){return!($i.Arabic(n)||$i["Arabic Supplement"](n)||$i["Arabic Extended-A"](n)||$i["Arabic Presentation Forms-A"](n)||$i["Arabic Presentation Forms-B"](n))}function Wh(n){return!(n!==746&&n!==747&&(n<4352||!($i["Bopomofo Extended"](n)||$i.Bopomofo(n)||$i["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||$i["CJK Compatibility Ideographs"](n)||$i["CJK Compatibility"](n)||$i["CJK Radicals Supplement"](n)||$i["CJK Strokes"](n)||!(!$i["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||$i["CJK Unified Ideographs Extension A"](n)||$i["CJK Unified Ideographs"](n)||$i["Enclosed CJK Letters and Months"](n)||$i["Hangul Compatibility Jamo"](n)||$i["Hangul Jamo Extended-A"](n)||$i["Hangul Jamo Extended-B"](n)||$i["Hangul Jamo"](n)||$i["Hangul Syllables"](n)||$i.Hiragana(n)||$i["Ideographic Description Characters"](n)||$i.Kanbun(n)||$i["Kangxi Radicals"](n)||$i["Katakana Phonetic Extensions"](n)||$i.Katakana(n)&&n!==12540||!(!$i["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!$i["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||$i["Unified Canadian Aboriginal Syllabics"](n)||$i["Unified Canadian Aboriginal Syllabics Extended"](n)||$i["Vertical Forms"](n)||$i["Yijing Hexagram Symbols"](n)||$i["Yi Syllables"](n)||$i["Yi Radicals"](n))))}function Zd(n){return!(Wh(n)||function(t){return!!($i["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||$i["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||$i["Letterlike Symbols"](t)||$i["Number Forms"](t)||$i["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||$i["Control Pictures"](t)&&t!==9251||$i["Optical Character Recognition"](t)||$i["Enclosed Alphanumerics"](t)||$i["Geometric Shapes"](t)||$i["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||$i["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||$i["CJK Symbols and Punctuation"](t)||$i.Katakana(t)||$i["Private Use Area"](t)||$i["CJK Compatibility Forms"](t)||$i["Small Form Variants"](t)||$i["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(n))}function Xh(n){return $i.Arabic(n)||$i["Arabic Supplement"](n)||$i["Arabic Extended-A"](n)||$i["Arabic Presentation Forms-A"](n)||$i["Arabic Presentation Forms-B"](n)}function Yh(n){return n>=1424&&n<=2303||$i["Arabic Presentation Forms-A"](n)||$i["Arabic Presentation Forms-B"](n)}function yf(n,t){return!(!t&&Yh(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||$i.Khmer(n))}function Pp(n){for(const t of n)if(Yh(t.charCodeAt(0)))return!0;return!1}const ks={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let hd=null,ca=ks.unavailable,fc=null;const Hd=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&(ca=ks.error),hd&&hd(n)};function C(){s.fire(new ya("pluginStateChange",{pluginStatus:ca,pluginURL:fc}))}const s=new Ml,d=function(){return ca},v=function(){if(ca!==ks.deferred||!fc)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");ca=ks.loading,C(),fc&&Pl({url:fc},n=>{n?Hd(n):(ca=ks.loaded,C())})},S={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>ca===ks.loaded||S.applyArabicShaping!=null,isLoading:()=>ca===ks.loading,setState(n){ca=n.pluginStatus,fc=n.pluginURL},isParsing:()=>ca===ks.parsing,isParsed:()=>ca===ks.parsed,getPluginURL:()=>fc};class D{constructor(t,r){this.zoom=t,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.transition=r.transition,this.pitch=r.pitch,this.brightness=r.brightness,this.worldview=r.worldview,this.activeFloors=r.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(t){return function(r,l){for(const u of r)if(!yf(u.charCodeAt(0),l))return!1;return!0}(t,S.isLoaded())}}class k{constructor(t,r,l,u,m){this.property=t,this.value=r,this.expression=function(_,b,E,P,R){if(sd(_))return new $d(_,b);if(Zh(_)||Array.isArray(_)&&_.length>0){const F=fl(_,b,E,P,R);if(F.result==="error")throw new Error(F.value.map(O=>`${O.key}: ${O.message}`).join(", "));return F.value}{let F=_;return typeof _=="string"&&b.type==="color"&&(F=Dr.parse(_)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>F}}}(r===void 0?t.specification.default:r,t.specification,l,u,m)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,r,l,u){return this.property.possiblyEvaluate(this,t,r,l,u)}}class j{constructor(t,r,l,u){this.property=t,this.value=new k(t,void 0,r,l,u)}transitioned(t,r){return new J(this.property,this.value,r,Object.assign({},t.transition,this.transition),t.now)}untransitioned(){return new J(this.property,this.value,null,{},0)}}class H{constructor(t,r,l,u){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues),this._scope=r,this._options=l,this._iconImageUseTheme=u,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(t){return Mi(this._values[t].value.value)}setValue(t,r){this._values.hasOwnProperty(t)||(this._values[t]=new j(this._values[t].property,this._scope,this._options,this._iconImageUseTheme)),this._values[t].value=new k(this._values[t].property,r===null?void 0:Mi(r),this._scope,this._options,this._iconImageUseTheme),this._values[t].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[t].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[t].value.isIndoorDependent())}setTransitionOrValue(t,r){r&&(this._options=r);const l=this._properties.properties;if(t)for(const u in t){const m=t[u];if(u.endsWith("-transition")){const _=u.slice(0,-11);l[_]&&this.setTransition(_,m)}else l.hasOwnProperty(u)&&this.setValue(u,m)}}getTransition(t){return Mi(this._values[t].transition)}setTransition(t,r){this._values.hasOwnProperty(t)||(this._values[t]=new j(this._values[t].property)),this._values[t].transition=Mi(r)||void 0}serialize(){const t={};for(const r of Object.keys(this._values)){const l=this.getValue(r);l!==void 0&&(t[r]=l);const u=this.getTransition(r);u!==void 0&&(t[`${r}-transition`]=u)}return t}transitioned(t,r){const l=new et(this._properties);for(const u of Object.keys(this._values))l._values[u]=this._values[u].transitioned(t,r._values[u]);return l}untransitioned(){const t=new et(this._properties);for(const r of Object.keys(this._values))t._values[r]=this._values[r].untransitioned();return t}isIndoorDependent(){return this._isIndoorDependent}}class J{constructor(t,r,l,u,m){const _=u.delay||0,b=u.duration||0;m=m||0,this.property=t,this.value=r,this.begin=m+_,this.end=this.begin+b,t.specification.transition&&(u.delay||u.duration)&&(this.prior=l)}possiblyEvaluate(t,r,l){const u=t.now||0,m=this.value.possiblyEvaluate(t,r,l),_=this.prior;if(_){if(u>this.end)return this.prior=null,m;if(this.value.isDataDriven())return this.prior=null,m;if(u<this.begin)return _.possiblyEvaluate(t,r,l);{const b=(u-this.begin)/(this.end-this.begin);return this.property.interpolate(_.possiblyEvaluate(t,r,l),m,wo(b))}}return m}}class et{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,r,l){const u=new St(this._properties);for(const m of Object.keys(this._values))u._values[m]=this._values[m].possiblyEvaluate(t,r,l);return u}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class mt{constructor(t,r,l,u){this._properties=t,this._values=Object.create(t.defaultPropertyValues),this._scope=r,this._options=l,this._iconImageUseTheme=u,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(t){return Mi(this._values[t].value)}setValue(t,r){this._values[t]=new k(this._values[t].property,r===null?void 0:Mi(r),this._scope,this._options,this._iconImageUseTheme),this._values[t].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[t].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[t].isIndoorDependent())}serialize(){const t={};for(const r of Object.keys(this._values)){const l=this.getValue(r);l!==void 0&&(t[r]=l)}return t}possiblyEvaluate(t,r,l,u){const m=new St(this._properties);for(const _ of Object.keys(this._values))m._values[_]=this._values[_].possiblyEvaluate(t,r,l,u);return m}isIndoorDependent(){return this._isIndoorDependent}}class ut{constructor(t,r,l,u){this.property=t,this.value=r,this.parameters=l,this.iconImageUseTheme=u}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,r,l,u){return this.property.evaluate(this.value,this.parameters,t,r,l,u,this.iconImageUseTheme)}}class St{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class pt{constructor(t){this.specification=t}possiblyEvaluate(t,r){return t.expression.evaluate(r)}interpolate(t,r,l){const u=al[this.specification.type];return u?u(t,r,l):t}}class Et{constructor(t,r){this.specification=t,this.overrides=r}possiblyEvaluate(t,r,l,u,m){return t.expression.kind==="constant"||t.expression.kind==="camera"?new ut(this,{kind:"constant",value:t.expression.evaluate(r,null,{},l,u,void 0,m)},r):new ut(this,t.expression,r,m)}interpolate(t,r,l){if(t.value.kind!=="constant"||r.value.kind!=="constant")return t;if(t.value.value===void 0||r.value.value===void 0)return new ut(this,{kind:"constant",value:void 0},t.parameters);const u=al[this.specification.type];return u?new ut(this,{kind:"constant",value:u(t.value.value,r.value.value,l)},t.parameters):t}evaluate(t,r,l,u,m,_,b){return t.kind==="constant"?t.value:t.evaluate(r,l,u,m,_,void 0,b)}}class Kt{constructor(t){this.specification=t}possiblyEvaluate(t,r,l,u){return!!t.expression.evaluate(r,null,{},l,u)}interpolate(){return!1}}class Xt{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const r=new D(0,{});for(const l in t){const u=t[l];u.specification.overridable&&this.overridableProperties.push(l);const m=this.defaultPropertyValues[l]=new k(u,void 0),_=this.defaultTransitionablePropertyValues[l]=new j(u);this.defaultTransitioningPropertyValues[l]=_.untransitioned(),this.defaultPossiblyEvaluatedValues[l]=m.possiblyEvaluate(r)}}}Si(Et,"DataDrivenProperty"),Si(pt,"DataConstantProperty"),Si(Kt,"ColorRampProperty");var ft=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function _e(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function ce(n){if(Array.isArray(n))return n.map(ce);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){const t={};for(const r in n)t[r]=ce(n[r]);return t}return _e(n)}function me(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const t of n.slice(1))if(!me(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}function be(n,t="",r=null,l="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};me(n)||(n=Di(n));const u=n;let m=!0;try{m=function(R){if(!Qe(R))return R;let F=ce(R);return De(F),F=de(F),F}(u)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(u,null,2)}
        `)}let _=null,b=null;if(l!=="background"&&l!=="sky"&&l!=="slot"){b=ft[`filter_${l}`];const R=pc(m,b,t,r);if(R.result==="error")throw new Error(R.value.map(F=>`${F.key}: ${F.message}`).join(", "));_=(F,O,$)=>R.value.evaluate(F,O,{},$)}let E=null,P=null;if(m!==u){const R=pc(u,b,t,r);if(R.result==="error")throw new Error(R.value.map(F=>`${F.key}: ${F.message}`).join(", "));E=(F,O,$,q,Y)=>R.value.evaluate(F,O,{},$,void 0,void 0,q,Y),P=!mu(R.value.expression)}return{filter:_,dynamicFilter:E||void 0,needGeometry:ii(m),needFeature:!!P}}function de(n){if(!Array.isArray(n))return n;const t=function(r){if(Xe.has(r[0])){for(let l=1;l<r.length;l++)if(Qe(r[l]))return!0}return r}(n);return t===!0?t:t.map(r=>de(r))}function De(n){let t=!1;const r=[];if(n[0]==="case"){for(let l=1;l<n.length-1;l+=2)t=t||Qe(n[l]),r.push(n[l+1]);r.push(n[n.length-1])}else if(n[0]==="match"){t=t||Qe(n[1]);for(let l=2;l<n.length-1;l+=2)r.push(n[l+1]);r.push(n[n.length-1])}else if(n[0]==="step"){t=t||Qe(n[1]);for(let l=1;l<n.length-1;l+=2)r.push(n[l+1])}t&&(n.length=0,n.push("any",...r));for(let l=1;l<n.length;l++)De(n[l])}function Qe(n){if(!Array.isArray(n))return!1;if((t=n[0])==="pitch"||t==="distance-from-center")return!0;var t;for(let r=1;r<n.length;r++)if(Qe(n[r]))return!0;return!1}const Xe=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Je(n,t){return n<t?-1:n>t?1:0}function ii(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let t=1;t<n.length;t++)if(ii(n[t]))return!0;return!1}function Di(n){if(!n)return!0;const t=n[0];return n.length<=1?t!=="any":t==="=="?Fi(n[1],n[2],"=="):t==="!="?$r(Fi(n[1],n[2],"==")):t==="<"||t===">"||t==="<="||t===">="?Fi(n[1],n[2],t):t==="any"?(r=n.slice(1),["any"].concat(r.map(Di))):t==="all"?["all"].concat(n.slice(1).map(Di)):t==="none"?["all"].concat(n.slice(1).map(Di).map($r)):t==="in"?wi(n[1],n.slice(2)):t==="!in"?$r(wi(n[1],n.slice(2))):t==="has"?fr(n[1]):t!=="!has"||$r(fr(n[1]));var r}function Fi(n,t,r){switch(n){case"$type":return[`filter-type-${r}`,t];case"$id":return[`filter-id-${r}`,t];default:return[`filter-${r}`,n,t]}}function wi(n,t){if(t.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(r=>typeof r!=typeof t[0])?["filter-in-large",n,["literal",t.sort(Je)]]:["filter-in-small",n,["literal",t]]}}function fr(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function $r(n){return["!",n]}const Nr="";function co(n,t){return t?`${n}${Nr}${t}`:n}let No;const Jo=()=>No||(No=new Xt({"icon-size":new Et(ft.layout_symbol["icon-size"]),"icon-image":new Et(ft.layout_symbol["icon-image"]),"icon-rotate":new Et(ft.layout_symbol["icon-rotate"]),"icon-offset":new Et(ft.layout_symbol["icon-offset"])}));class Vo{constructor(t,r,l,u,m,_){this.cachedIconPrimary=null;const b=pc(t,ft.appearance.condition);if(b.result==="success"&&(this.condition=b.value),this.name=r,l){this.properties=new St(Jo()),this.unevaluatedLayout=new mt(Jo(),u,m,_);for(const E in l)this.unevaluatedLayout.setValue(E,l[E])}}hasCachedIconPrimary(){return this.cachedIconPrimary!==null}setCachedIconPrimary(t){this.cachedIconPrimary=t}getCachedIconPrimary(){return this.cachedIconPrimary}isActive(t){return!(this.condition||!t.isHidden||this.name!=="hidden")||this.condition.evaluate(t.globals,t.feature,t.featureState,t.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(t){return this.properties.get(t)}getUnevaluatedProperties(){return this.unevaluatedLayout}recalculate(t,r,l){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(t,void 0,r,l))}serialize(){const t={};return t.condition=this.condition.expression.serialize(),this.name&&(t.name=this.name),this.unevaluatedLayout&&(t.properties=this.unevaluatedLayout.serialize()),t}}const Es="-transition",Ko=new Set(["fill","line","background","hillshade","raster"]);class $n extends Ml{constructor(t,r,l,u,m,_){if(super(),this.id=t.id,this.fqid=co(this.id,l),this.type=t.type,this.scope=l,this.lut=u,this.options=m,this.iconImageUseTheme=_,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},t.type!=="custom"){if(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type&&t.type!=="background"&&t.type!=="sky"&&t.type!=="slot"){this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter;const b=pc(this.filter,ft[`filter_${t.type}`]);b.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...b.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||b.value.isIndoorDependent)}if(t.slot&&(this.slot=t.slot),t.appearances&&this.setAppearances(t.appearances),r.layout&&(this._unevaluatedLayout=new mt(r.layout,this.scope,m,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),r.paint){this._transitionablePaint=new H(r.paint,this.scope,m);for(const b in t.paint)this.setPaintProperty(b,t.paint[b]);for(const b in t.layout)this.setLayoutProperty(b,t.layout[b]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new St(r.paint)}}}onAdd(t){}onRemove(t){}isDraped(t){return!this.is3D(!0)&&Ko.has(this.type)}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,r){if(this.type==="custom"&&t==="visibility")return void(this.visibility=r);const l=this._unevaluatedLayout;l._properties.properties[t]&&(l.setValue(t,r),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...l.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||l.isIndoorDependent(),t==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(t){this.appearances=[],t.forEach(r=>{this.appearances.push(new Vo(r.condition,r.name,r.properties,this.scope,this.options,this.iconImageUseTheme))})}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(t){return t.endsWith(Es)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}isPaintProperty(t){return!!this._transitionablePaint._properties.properties[t]}setPaintProperty(t,r){const l=this._transitionablePaint,u=l._properties.properties;if(t.endsWith(Es)){const F=t.slice(0,-11);return u[F]&&l.setTransition(F,r||void 0),!1}if(!u[t])return!1;const m=l._values[t],_=m.value.isDataDriven(),b=m.value;l.setValue(t,r),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...l.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||l.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(t);const E=l._values[t].value,P=E.isDataDriven(),R=t.endsWith("pattern")||t==="line-dasharray";return P||_||R||this._handleOverridablePaintPropertyUpdate(t,b,E)}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getDefaultProgramParams(t,r,l){return null}_handleOverridablePaintPropertyUpdate(t,r,l){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,r){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,r,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,r)}serialize(){const t={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(t.appearances=this.appearances.map(r=>r.serialize())),$e(t,(r,l)=>!(r===void 0||l==="layout"&&!Object.keys(r).length||l==="paint"&&!Object.keys(r).length))}is3D(t){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const t in this.paint._values){const r=this.paint.get(t);if(r instanceof ut&&uo(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}for(const t of this.appearances)if(!Bh(t.condition.expression))return!0;return!1}compileFilter(t){this._filterCompiled||(this._featureFilter=be(this.filter,this.scope,t),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(t){this._stats&&(t.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(t,r,l){return{}}queryRadius(t){}queryIntersectsFeature(t,r,l,u,m,_,b,E,P){}}const _s={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Qo{constructor(t,r){this._structArray=t,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Jr{constructor(){this.capacity=-1,this.resize(0)}static serialize(t,r){return t._trim(),r&&r.add(t.arrayBuffer),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const r=Object.create(this.prototype);return r.arrayBuffer=t.arrayBuffer,r.length=t.length,r.capacity=t.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...t){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...t){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function vr(n,t=1){let r=0,l=0;return{members:n.map(u=>{const m=_s[u.type].BYTES_PER_ELEMENT,_=r=Jl(r,Math.max(t,m)),b=u.components||1;return l=Math.max(l,m),r+=m*b,{name:u.name,type:u.type,components:b,offset:_}}),size:Jl(r,Math.max(l,t)),alignment:t}}function Jl(n,t){return Math.ceil(n/t)*t}class ys extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r){const l=this.length;return this.resize(l+1),this.emplace(l,t,r)}emplace(t,r,l){const u=2*t;return this.int16[u+0]=r,this.int16[u+1]=l,t}}ys.prototype.bytesPerElement=4,Si(ys,"StructArrayLayout2i4");class ml extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=3*t;return this.int16[m+0]=r,this.int16[m+1]=l,this.int16[m+2]=u,t}}ml.prototype.bytesPerElement=6,Si(ml,"StructArrayLayout3i6");class Kl extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=4*t;return this.int16[_+0]=r,this.int16[_+1]=l,this.int16[_+2]=u,this.int16[_+3]=m,t}}Kl.prototype.bytesPerElement=8,Si(Kl,"StructArrayLayout4i8");class Fs extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.float32[1*t+0]=r,t}}Fs.prototype.bytesPerElement=4,Si(Fs,"StructArrayLayout1f4");class mc extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=4*t,_=2*t;return this.int16[m+0]=r,this.int16[m+1]=l,this.float32[_+1]=u,t}}mc.prototype.bytesPerElement=8,Si(mc,"StructArrayLayout2i1f8");class Wa extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=4*t;return this.int16[m+0]=r,this.int16[m+1]=l,this.int16[m+2]=u,t}}Wa.prototype.bytesPerElement=8,Si(Wa,"StructArrayLayout3i8");class Ql extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=5*t;return this.int16[b+0]=r,this.int16[b+1]=l,this.int16[b+2]=u,this.int16[b+3]=m,this.int16[b+4]=_,t}}Ql.prototype.bytesPerElement=10,Si(Ql,"StructArrayLayout5i10");class Uc extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=6*t,R=12*t,F=3*t;return this.int16[P+0]=r,this.int16[P+1]=l,this.uint8[R+4]=u,this.uint8[R+5]=m,this.uint8[R+6]=_,this.uint8[R+7]=b,this.float32[F+2]=E,t}}Uc.prototype.bytesPerElement=12,Si(Uc,"StructArrayLayout2i4ub1f12");class Zs extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=3*t;return this.float32[m+0]=r,this.float32[m+1]=l,this.float32[m+2]=u,t}}Zs.prototype.bytesPerElement=12,Si(Zs,"StructArrayLayout3f12");class Po extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=6*t,E=3*t;return this.uint16[b+0]=r,this.uint16[b+1]=l,this.uint16[b+2]=u,this.uint16[b+3]=m,this.float32[E+2]=_,t}}Po.prototype.bytesPerElement=12,Si(Po,"StructArrayLayout4ui1f12");class Mo extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=4*t;return this.uint16[_+0]=r,this.uint16[_+1]=l,this.uint16[_+2]=u,this.uint16[_+3]=m,t}}Mo.prototype.bytesPerElement=8,Si(Mo,"StructArrayLayout4ui8");class hs extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=6*t;return this.int16[E+0]=r,this.int16[E+1]=l,this.int16[E+2]=u,this.int16[E+3]=m,this.int16[E+4]=_,this.int16[E+5]=b,t}}hs.prototype.bytesPerElement=12,Si(hs,"StructArrayLayout6i12");class To extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O){const $=this.length;return this.resize($+1),this.emplace($,t,r,l,u,m,_,b,E,P,R,F,O)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$){const q=12*t;return this.int16[q+0]=r,this.int16[q+1]=l,this.int16[q+2]=u,this.int16[q+3]=m,this.uint16[q+4]=_,this.uint16[q+5]=b,this.uint16[q+6]=E,this.uint16[q+7]=P,this.int16[q+8]=R,this.int16[q+9]=F,this.int16[q+10]=O,this.int16[q+11]=$,t}}To.prototype.bytesPerElement=24,Si(To,"StructArrayLayout4i4ui4i24");class Ll extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=10*t,P=5*t;return this.int16[E+0]=r,this.int16[E+1]=l,this.int16[E+2]=u,this.float32[P+2]=m,this.float32[P+3]=_,this.float32[P+4]=b,t}}Ll.prototype.bytesPerElement=20,Si(Ll,"StructArrayLayout3i3f20");class ch extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=4*t;return this.float32[_+0]=r,this.float32[_+1]=l,this.float32[_+2]=u,this.float32[_+3]=m,t}}ch.prototype.bytesPerElement=16,Si(ch,"StructArrayLayout4f16");class Mp extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint32[1*t+0]=r,t}}Mp.prototype.bytesPerElement=4,Si(Mp,"StructArrayLayout1ul4");class Rl extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r){const l=this.length;return this.resize(l+1),this.emplace(l,t,r)}emplace(t,r,l){const u=2*t;return this.uint16[u+0]=r,this.uint16[u+1]=l,t}}Rl.prototype.bytesPerElement=4,Si(Rl,"StructArrayLayout2ui4");class hh extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$){const q=this.length;return this.resize(q+1),this.emplace(q,t,r,l,u,m,_,b,E,P,R,F,O,$)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q){const Y=20*t,rt=10*t;return this.int16[Y+0]=r,this.int16[Y+1]=l,this.int16[Y+2]=u,this.int16[Y+3]=m,this.int16[Y+4]=_,this.float32[rt+3]=b,this.float32[rt+4]=E,this.float32[rt+5]=P,this.float32[rt+6]=R,this.int16[Y+14]=F,this.uint32[rt+8]=O,this.uint16[Y+18]=$,this.uint16[Y+19]=q,t}}hh.prototype.bytesPerElement=40,Si(hh,"StructArrayLayout5i4f1i1ul2ui40");class Cp extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=8*t;return this.int16[P+0]=r,this.int16[P+1]=l,this.int16[P+2]=u,this.int16[P+4]=m,this.int16[P+5]=_,this.int16[P+6]=b,this.int16[P+7]=E,t}}Cp.prototype.bytesPerElement=16,Si(Cp,"StructArrayLayout3i2i2i16");class kl extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=4*t,E=8*t;return this.float32[b+0]=r,this.float32[b+1]=l,this.float32[b+2]=u,this.int16[E+6]=m,this.int16[E+7]=_,t}}kl.prototype.bytesPerElement=16,Si(kl,"StructArrayLayout2f1f2i16");class uh extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=20*t,P=5*t;return this.uint8[E+0]=r,this.uint8[E+1]=l,this.float32[P+1]=u,this.float32[P+2]=m,this.float32[P+3]=_,this.float32[P+4]=b,t}}uh.prototype.bytesPerElement=20,Si(uh,"StructArrayLayout2ub4f20");class qn extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=3*t;return this.uint16[m+0]=r,this.uint16[m+1]=l,this.uint16[m+2]=u,t}}qn.prototype.bytesPerElement=6,Si(qn,"StructArrayLayout3ui6");class Fl extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt,yt,Pt,qt){const Bt=this.length;return this.resize(Bt+1),this.emplace(Bt,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt,yt,Pt,qt)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt,yt,Pt,qt,Bt){const Yt=30*t,ee=15*t,ne=60*t;return this.int16[Yt+0]=r,this.int16[Yt+1]=l,this.int16[Yt+2]=u,this.float32[ee+2]=m,this.float32[ee+3]=_,this.uint16[Yt+8]=b,this.uint16[Yt+9]=E,this.uint32[ee+5]=P,this.uint32[ee+6]=R,this.uint32[ee+7]=F,this.uint16[Yt+16]=O,this.uint16[Yt+17]=$,this.uint16[Yt+18]=q,this.float32[ee+10]=Y,this.float32[ee+11]=rt,this.uint8[ne+48]=at,this.uint8[ne+49]=gt,this.uint8[ne+50]=yt,this.uint32[ee+13]=Pt,this.int16[Yt+28]=qt,this.uint8[ne+58]=Bt,t}}Fl.prototype.bytesPerElement=60,Si(Fl,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class gc extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt,yt,Pt,qt,Bt,Yt,ee,ne,Le,fe,ke,Ue,Ze,hi,Ke,je){const Ye=this.length;return this.resize(Ye+1),this.emplace(Ye,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt,yt,Pt,qt,Bt,Yt,ee,ne,Le,fe,ke,Ue,Ze,hi,Ke,je)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt,yt,Pt,qt,Bt,Yt,ee,ne,Le,fe,ke,Ue,Ze,hi,Ke,je,Ye){const Me=20*t,Ie=40*t,He=80*t;return this.float32[Me+0]=r,this.float32[Me+1]=l,this.int16[Ie+4]=u,this.int16[Ie+5]=m,this.int16[Ie+6]=_,this.int16[Ie+7]=b,this.int16[Ie+8]=E,this.int16[Ie+9]=P,this.int16[Ie+10]=R,this.int16[Ie+11]=F,this.int16[Ie+12]=O,this.uint16[Ie+13]=$,this.uint16[Ie+14]=q,this.uint16[Ie+15]=Y,this.uint16[Ie+16]=rt,this.uint16[Ie+17]=at,this.uint16[Ie+18]=gt,this.uint16[Ie+19]=yt,this.uint16[Ie+20]=Pt,this.uint16[Ie+21]=qt,this.uint16[Ie+22]=Bt,this.uint16[Ie+23]=Yt,this.uint16[Ie+24]=ee,this.uint16[Ie+25]=ne,this.uint16[Ie+26]=Le,this.uint16[Ie+27]=fe,this.uint32[Me+14]=ke,this.float32[Me+15]=Ue,this.float32[Me+16]=Ze,this.float32[Me+17]=hi,this.float32[Me+18]=Ke,this.uint8[He+76]=je,this.uint16[Ie+39]=Ye,t}}gc.prototype.bytesPerElement=80,Si(gc,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Wd extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=6*t;return this.float32[E+0]=r,this.float32[E+1]=l,this.float32[E+2]=u,this.float32[E+3]=m,this.float32[E+4]=_,this.float32[E+5]=b,t}}Wd.prototype.bytesPerElement=24,Si(Wd,"StructArrayLayout6f24");class dh extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=5*t;return this.float32[b+0]=r,this.float32[b+1]=l,this.float32[b+2]=u,this.float32[b+3]=m,this.float32[b+4]=_,t}}dh.prototype.bytesPerElement=20,Si(dh,"StructArrayLayout5f20");class xf extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=7*t;return this.float32[P+0]=r,this.float32[P+1]=l,this.float32[P+2]=u,this.float32[P+3]=m,this.float32[P+4]=_,this.float32[P+5]=b,this.float32[P+6]=E,t}}xf.prototype.bytesPerElement=28,Si(xf,"StructArrayLayout7f28");class Dp extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F){const O=this.length;return this.resize(O+1),this.emplace(O,t,r,l,u,m,_,b,E,P,R,F)}emplace(t,r,l,u,m,_,b,E,P,R,F,O){const $=11*t;return this.float32[$+0]=r,this.float32[$+1]=l,this.float32[$+2]=u,this.float32[$+3]=m,this.float32[$+4]=_,this.float32[$+5]=b,this.float32[$+6]=E,this.float32[$+7]=P,this.float32[$+8]=R,this.float32[$+9]=F,this.float32[$+10]=O,t}}Dp.prototype.bytesPerElement=44,Si(Dp,"StructArrayLayout11f44");class zp extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P){const R=this.length;return this.resize(R+1),this.emplace(R,t,r,l,u,m,_,b,E,P)}emplace(t,r,l,u,m,_,b,E,P,R){const F=9*t;return this.float32[F+0]=r,this.float32[F+1]=l,this.float32[F+2]=u,this.float32[F+3]=m,this.float32[F+4]=_,this.float32[F+5]=b,this.float32[F+6]=E,this.float32[F+7]=P,this.float32[F+8]=R,t}}zp.prototype.bytesPerElement=36,Si(zp,"StructArrayLayout9f36");class Eu extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r){const l=this.length;return this.resize(l+1),this.emplace(l,t,r)}emplace(t,r,l){const u=2*t;return this.float32[u+0]=r,this.float32[u+1]=l,t}}Eu.prototype.bytesPerElement=8,Si(Eu,"StructArrayLayout2f8");class Cm extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=6*t;return this.uint32[3*t+0]=r,this.uint16[_+2]=l,this.uint16[_+3]=u,this.uint16[_+4]=m,t}}Cm.prototype.bytesPerElement=12,Si(Cm,"StructArrayLayout1ul3ui12");class Lp extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint16[1*t+0]=r,t}}Lp.prototype.bytesPerElement=2,Si(Lp,"StructArrayLayout1ui2");class Yf extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt){const at=this.length;return this.resize(at+1),this.emplace(at,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at){const gt=16*t;return this.float32[gt+0]=r,this.float32[gt+1]=l,this.float32[gt+2]=u,this.float32[gt+3]=m,this.float32[gt+4]=_,this.float32[gt+5]=b,this.float32[gt+6]=E,this.float32[gt+7]=P,this.float32[gt+8]=R,this.float32[gt+9]=F,this.float32[gt+10]=O,this.float32[gt+11]=$,this.float32[gt+12]=q,this.float32[gt+13]=Y,this.float32[gt+14]=rt,this.float32[gt+15]=at,t}}Yf.prototype.bytesPerElement=64,Si(Yf,"StructArrayLayout16f64");class ud extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=10*t,R=5*t;return this.uint16[P+0]=r,this.uint16[P+1]=l,this.uint16[P+2]=u,this.uint16[P+3]=m,this.float32[R+2]=_,this.float32[R+3]=b,this.float32[R+4]=E,t}}ud.prototype.bytesPerElement=20,Si(ud,"StructArrayLayout4ui3f20");class Jf extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.int16[1*t+0]=r,t}}Jf.prototype.bytesPerElement=2,Si(Jf,"StructArrayLayout1i2");class vf extends Jr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint8[1*t+0]=r,t}}vf.prototype.bytesPerElement=1,Si(vf,"StructArrayLayout1ub1");class dd extends Qo{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}dd.prototype.size=40;class fg extends hh{get(t){return new dd(this,t)}}Si(fg,"CollisionBoxArray");class Au extends Qo{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}Au.prototype.size=60;class pd extends Fl{get(t){return new Au(this,t)}}Si(pd,"PlacedSymbolArray");class Rp extends Qo{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(t){this._structArray.uint32[this._pos4+14]=t}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(t){this._structArray.float32[this._pos4+18]=t}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Rp.prototype.size=80;class mg extends gc{get(t){return new Rp(this,t)}}Si(mg,"SymbolInstanceArray");class Dm extends Fs{getoffsetX(t){return this.float32[1*t+0]}}Si(Dm,"GlyphOffsetArray");class gg extends ys{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}Si(gg,"SymbolLineVertexArray");class Kf extends Qo{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Kf.prototype.size=12;class zm extends Cm{get(t){return new Kf(this,t)}}Si(zm,"FeatureIndexArray");class Qf extends Rl{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}Si(Qf,"FillExtrusionCentroidArray");class Lm extends Qo{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Lm.prototype.size=6;class Rm extends ml{get(t){return new Lm(this,t)}}Si(Rm,"FillExtrusionWallArray");const _g=vr([{name:"a_pos",components:2,type:"Int16"}],4),f_=vr([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),yg=vr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class po{constructor(t=[]){this.segments=t}_prepareSegment(t,r,l,u){let m=this.segments[this.segments.length-1];return t>po.MAX_VERTEX_ARRAY_LENGTH&&qi(`Max vertices per segment is ${po.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!m||m.vertexLength+t>po.MAX_VERTEX_ARRAY_LENGTH||m.sortKey!==u)&&(m={vertexOffset:r,primitiveOffset:l,vertexLength:0,primitiveLength:0},u!==void 0&&(m.sortKey=u),this.segments.push(m)),m}prepareSegment(t,r,l,u){return this._prepareSegment(t,r.length,l.length,u)}get(){return this.segments}destroy(){for(const t of this.segments)for(const r in t.vaos)t.vaos[r].destroy()}static simpleSegment(t,r,l,u){return new po([{vertexOffset:t,primitiveOffset:r,vertexLength:l,primitiveLength:u,vaos:{},sortKey:0}])}}function xg(n,t){return 256*(n=tt(Math.floor(n),0,255))+tt(Math.floor(t),0,255)}po.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Si(po,"SegmentVector");const km=vr([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),vg=vr([{name:"a_pattern_b",components:4,type:"Uint16"}]),Fm=vr([{name:"a_dash",components:4,type:"Uint16"}]);class Pu{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(t,r,l,u){this.ids.push(ba(t)),this.positions.push(r,l,u)}eachPosition(t,r){const l=ba(t);let u=0,m=this.ids.length-1;for(;u<m;){const _=u+m>>1;this.ids[_]>=l?m=_:u=_+1}for(;this.ids[u]===l;)r(this.positions[3*u],this.positions[3*u+1],this.positions[3*u+2]),u++}static serialize(t,r){const l=new Float64Array(t.ids),u=new Uint32Array(t.positions);return tm(l,u,0,l.length-1),r&&(r.add(l.buffer),r.add(u.buffer)),{ids:l,positions:u}}static deserialize(t){const r=new Pu;let l;r.ids=t.ids,r.positions=t.positions;for(const u of r.ids)u!==l&&r.uniqueIds.push(u),l=u;return r.indexed=!0,r}}function ba(n){const t=+n;return Number.isSafeInteger(t)?t:qa(String(n))}function tm(n,t,r,l){for(;r<l;){const u=n[r+l>>1];let m=r-1,_=l+1;for(;;){do m++;while(n[m]<u);do _--;while(n[_]>u);if(m>=_)break;kp(n,m,_),kp(t,3*m,3*_),kp(t,3*m+1,3*_+1),kp(t,3*m+2,3*_+2)}_-r<l-_?(tm(n,t,r,_),r=_+1):(tm(n,t,_+1,l),l=_)}}function kp(n,t,r){const l=n[t];n[t]=n[r],n[r]=l}Si(Pu,"FeaturePositionMap");class jc{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,r){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,r),this.initialized=!0),!!this.location}set(t,r,l){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class bf extends jc{constructor(t){super(t),this.current=0}set(t,r,l){this.fetchUniformLocation(t,r)&&this.current!==l&&(this.current=l,this.gl.uniform1i(this.location,l))}}class ts extends jc{constructor(t){super(t),this.current=0}set(t,r,l){this.fetchUniformLocation(t,r)&&this.current!==l&&(this.current=l,this.gl.uniform1f(this.location,l))}}class Jh extends jc{constructor(t){super(t),this.current=[0,0]}set(t,r,l){this.fetchUniformLocation(t,r)&&(l[0]===this.current[0]&&l[1]===this.current[1]||(this.current=l,this.gl.uniform2f(this.location,l[0],l[1])))}}class Xd extends jc{constructor(t){super(t),this.current=[0,0,0]}set(t,r,l){this.fetchUniformLocation(t,r)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]||(this.current=l,this.gl.uniform3f(this.location,l[0],l[1],l[2])))}}class wf extends jc{constructor(t){super(t),this.current=[0,0,0,0]}set(t,r,l){this.fetchUniformLocation(t,r)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]&&l[3]===this.current[3]||(this.current=l,this.gl.uniform4f(this.location,l[0],l[1],l[2],l[3])))}}class Tf extends jc{constructor(t){super(t),this.current=Dr.transparent.toPremultipliedRenderColor(null)}set(t,r,l){this.fetchUniformLocation(t,r)&&(l.r===this.current.r&&l.g===this.current.g&&l.b===this.current.b&&l.a===this.current.a||(this.current=l,this.gl.uniform4f(this.location,l.r,l.g,l.b,l.a)))}}const Bm=new Float32Array(16);class Fp extends jc{constructor(t){super(t),this.current=Bm}set(t,r,l){if(this.fetchUniformLocation(t,r)){if(l[12]!==this.current[12]||l[0]!==this.current[0])return this.current=l,void this.gl.uniformMatrix4fv(this.location,!1,l);for(let u=1;u<16;u++)if(l[u]!==this.current[u]){this.current=l,this.gl.uniformMatrix4fv(this.location,!1,l);break}}}}const m_=new Float32Array(9),bg=new Float32Array(4);class Om extends jc{constructor(t){super(t),this.current=bg}set(t,r,l){if(this.fetchUniformLocation(t,r)){for(let u=0;u<4;u++)if(l[u]!==this.current[u]){this.current=l,this.gl.uniformMatrix2fv(this.location,!1,l);break}}}}function Bp(n){return[xg(255*n.r,255*n.g),xg(255*n.b,255*n.a)]}function Op(n,t,r,l,u,m,_,b){return!!n&&(n.kind==="composite"||n.kind==="source"?n.evaluate(new D(0,{brightness:m,worldview:b}),t,r,u,l,_)==="none":n.value==="none")}class Sf{constructor(t,r,l,u){this.value=t,this.uniformNames=r.map(m=>`u_${m}`),this.type=l,this.context=u}setUniform(t,r,l,u,m){const _=u.constantOr(this.value);r.set(t,m,_ instanceof Dr?_.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):_)}getBinding(t,r){return this.type==="color"?new Tf(t):new ts(t)}}class ph{constructor(t,r){this.uniformNames=r.map(l=>`u_${l}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(t,r){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br),this.patternTransition=r?r.tl.concat(r.br):this.pattern}setUniform(t,r,l,u,m){let _=null;m!=="u_pattern"&&m!=="u_dash"||(_=this.pattern),m==="u_pattern_b"&&(_=this.patternTransition),m==="u_pixel_ratio"&&(_=this.pixelRatio),_&&r.set(t,m,_)}getBinding(t,r){return r==="u_pattern"||r==="u_pattern_b"||r==="u_dash"?new wf(t):new ts(t)}}class _c{constructor(t,r,l,u){this.expression=t,this.type=l,this.maxValue=0,this.paintVertexAttributes=r.map(m=>({name:`a_${m}`,type:"Float32",components:l==="color"?2:1,offset:0})),this.paintVertexArray=new u}populatePaintArray(t,r,l,u,m,_,b,E){const P=this.paintVertexArray.length,R=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new D(0,{brightness:_,worldview:E}),r,{},m,u,b):this.expression.kind==="constant"&&this.expression.value,F=Op(this.lutExpression,r,{},u,m,_,b,E);this.paintVertexArray.resize(t),this._setPaintValue(P,t,R,F?null:this.context.lut)}updatePaintArray(t,r,l,u,m,_,b,E){const P=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:b,worldview:E},l,u,void 0,m):this.expression.kind==="constant"&&this.expression.value,R=Op(this.lutExpression,l,u,m,void 0,b,void 0,E);this._setPaintValue(t,r,P,R?null:this.context.lut)}_setPaintValue(t,r,l,u){if(this.type==="color"){const m=Bp(l.toPremultipliedRenderColor(u));for(let _=t;_<r;_++)this.paintVertexArray.emplace(_,m[0],m[1])}else{for(let m=t;m<r;m++)this.paintVertexArray.emplace(m,l);this.maxValue=Math.max(this.maxValue,Math.abs(l))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class fh{constructor(t,r,l,u,m,_){this.expression=t,this.uniformNames=r.map(b=>`u_${b}_t`),this.type=l,this.useIntegerZoom=u,this.context=m,this.maxValue=0,this.paintVertexAttributes=r.map(b=>({name:`a_${b}`,type:"Float32",components:l==="color"?4:2,offset:0})),this.paintVertexArray=new _}populatePaintArray(t,r,l,u,m,_,b,E){const P=this.expression.evaluate(new D(this.context.zoom,{brightness:_,worldview:E}),r,{},m,u,b),R=this.expression.evaluate(new D(this.context.zoom+1,{brightness:_,worldview:E}),r,{},m,u,b),F=Op(this.lutExpression,r,{},u,m,_,b,E),O=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(O,t,P,R,F?null:this.context.lut)}updatePaintArray(t,r,l,u,m,_,b,E){const P=this.expression.evaluate({zoom:this.context.zoom,brightness:b,worldview:E},l,u,void 0,m),R=this.expression.evaluate({zoom:this.context.zoom+1,brightness:b,worldview:E},l,u,void 0,m),F=Op(this.lutExpression,l,u,m,void 0,b,void 0,E);this._setPaintValue(t,r,P,R,F?null:this.context.lut)}_setPaintValue(t,r,l,u,m){if(this.type==="color"){const _=Bp(l.toPremultipliedRenderColor(m)),b=Bp(l.toPremultipliedRenderColor(m));for(let E=t;E<r;E++)this.paintVertexArray.emplace(E,_[0],_[1],b[0],b[1])}else{for(let _=t;_<r;_++)this.paintVertexArray.emplace(_,l,u);this.maxValue=Math.max(this.maxValue,Math.abs(l),Math.abs(u))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,r,l,u,m){const _=this.useIntegerZoom?Math.floor(l.zoom):l.zoom,b=tt(this.expression.interpolationFactor(_,this.context.zoom,this.context.zoom+1),0,1);r.set(t,m,b)}getBinding(t,r){return new ts(t)}}class ka{constructor(t,r,l,u,m){this.expression=t,this.layerId=m,this.paintVertexAttributes=(l==="array"?Fm:km).members;for(let _=0;_<r.length;++_);this.paintVertexArray=new u,this.paintTransitionVertexArray=new Mo}populatePaintArray(t,r,l,u){const m=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(m,t,r.patterns&&r.patterns[this.layerId],l)}updatePaintArray(t,r,l,u,m,_,b){this._setPaintValues(t,r,l.patterns&&l.patterns[this.layerId],_)}_setPaintValues(t,r,l,u){if(!u||!l)return;const m=u[l[0]],_=u[l[1]];if(m){if(m){const{tl:b,br:E,pixelRatio:P}=m;for(let R=t;R<r;R++)this.paintVertexArray.emplace(R,b[0],b[1],E[0],E[1],P)}if(_){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:b,br:E}=_;for(let P=t;P<r;P++)this.paintTransitionVertexArray.emplace(P,b[0],b[1],E[0],E[1])}}}upload(t){const r=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,r)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=t.createVertexBuffer(this.paintTransitionVertexArray,vg.members,r))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Mu{constructor(t,r,l=()=>!0){this.binders={},this._buffers=[],this.context=r;const u=[];for(const m in t.paint._values){const _=t.paint.get(m);if(m.endsWith("-use-theme")||!l(m)||!(_ instanceof ut&&uo(_.property.specification)))continue;const b=__(m,t.type),E=_.value,P=_.property.specification.type,R=!!_.property.useIntegerZoom,F=m==="line-dasharray"||m.endsWith("pattern"),O=t.paint.get(`${m}-use-theme`),$=m==="line-dasharray"&&t.layout.get("line-cap").value.kind!=="constant"||O&&O.value.kind!=="constant";if(E.kind!=="constant"||$)if(E.kind==="source"||$||F){const q=Vm(m,P,"source");this.binders[m]=F?new ka(E,b,P,q,t.id):new _c(E,b,P,q),u.push(`/a_${m}`)}else{const q=Vm(m,P,"composite");this.binders[m]=new fh(E,b,P,R,r,q),u.push(`/z_${m}`)}else this.binders[m]=F?new ph(E.value,b):new Sf(E.value,b,P,r),u.push(`/u_${m}`);O&&(this.binders[m].lutExpression=O.value)}this.cacheKey=u.sort().join("")}getMaxValue(t){const r=this.binders[t];return r instanceof _c||r instanceof fh?r.maxValue:0}populatePaintArrays(t,r,l,u,m,_,b,E){for(const P in this.binders){const R=this.binders[P];R.context=this.context,(R instanceof _c||R instanceof fh||R instanceof ka)&&R.populatePaintArray(t,r,l,u,m,_,b,E)}}setConstantPatternPositions(t,r){for(const l in this.binders){const u=this.binders[l];u instanceof ph&&u.setConstantPatternPositions(t,r)}}getPatternTransitionVertexBuffer(t){const r=this.binders[t];return r instanceof ka?r.paintTransitionVertexBuffer:null}updatePaintArrays(t,r,l,u,m,_,b,E,P,R){let F=!1;const O=Object.keys(t),$=O.length!==0&&!E,q=$?O:r.uniqueIds;this.context.lut=m.lut;for(const Y in this.binders){const rt=this.binders[Y];if(rt.context=this.context,(rt instanceof _c||rt instanceof fh||rt instanceof ka)&&rt.expression&&rt.expression.kind&&rt.expression.kind!=="constant"&&(rt.expression.isStateDependent===!0||rt.expression.isLightConstant===!1)){const at=m.paint.get(Y);rt.expression=at.value;for(const gt of q){const yt=t[gt.toString()];r.eachPosition(gt,(Pt,qt,Bt)=>{const Yt=u.feature(Pt);rt.updatePaintArray(qt,Bt,Yt,yt,_,b,P,R)})}if(!$)for(const gt of l.uniqueIds){const yt=t[gt.toString()];l.eachPosition(gt,(Pt,qt,Bt)=>{const Yt=u.feature(Pt);rt.updatePaintArray(qt,Bt,Yt,yt,_,b,P,R)})}F=!0}}return F}defines(){const t=[];for(const r in this.binders){const l=this.binders[r];(l instanceof Sf||l instanceof ph)&&t.push(...l.uniformNames.map(u=>`#define HAS_UNIFORM_${u}`))}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const r=[];for(const l in this.binders){const u=this.binders[l];if(u instanceof Sf||u instanceof ph||u instanceof fh)for(const m of u.uniformNames)r.push({name:m,property:l,binding:u.getBinding(t,m)})}return r}setUniforms(t,r,l,u,m){for(const{name:_,property:b,binding:E}of l)this.binders[b].setUniform(t,E,m,u.get(b),_)}updatePaintBuffers(){this._buffers=[];for(const t in this.binders){const r=this.binders[t];(r instanceof _c||r instanceof fh||r instanceof ka)&&r.paintVertexBuffer&&this._buffers.push(r.paintVertexBuffer),r instanceof ka&&r.paintTransitionVertexBuffer&&this._buffers.push(r.paintTransitionVertexBuffer)}}upload(t){for(const r in this.binders){const l=this.binders[r];(l instanceof _c||l instanceof fh||l instanceof ka)&&l.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const r=this.binders[t];(r instanceof _c||r instanceof fh||r instanceof ka)&&r.destroy()}}}class mh{constructor(t,r,l=()=>!0){this.programConfigurations={};for(const u of t)this.programConfigurations[u.id]=new Mu(u,r,l);this.needsUpload=!1,this._featureMap=new Pu,this._featureMapWithoutIds=new Pu,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(t,r,l,u,m,_,b,E,P){for(const R in this.programConfigurations)this.programConfigurations[R].populatePaintArrays(t,r,u,m,_,b,E,P);r.id!==void 0?this._featureMap.add(r.id,l,this._bufferOffset,t):(this._featureMapWithoutIds.add(this._idlessCounter,l,this._bufferOffset,t),this._idlessCounter+=1),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,r,l,u,m,_,b,E){for(const P of l)this.needsUpload=this.programConfigurations[P.id].updatePaintArrays(t,this._featureMap,this._featureMapWithoutIds,r,P,u,m,_,b||0,E)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const g_={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function __(n,t){return g_[n]||[n.replace(`${t}-`,"").replace(/-/g,"_")]}const y_={"line-pattern":{source:Po,composite:Po},"fill-pattern":{source:Po,composite:Po},"fill-extrusion-pattern":{source:Po,composite:Po},"line-dasharray":{source:Mo,composite:Mo}},Nm={color:{source:Eu,composite:ch},number:{source:Fs,composite:Eu}};function Vm(n,t,r){const l=y_[n];return l&&l[r]||Nm[t][r]}Si(Sf,"ConstantBinder"),Si(ph,"PatternConstantBinder"),Si(_c,"SourceExpressionBinder"),Si(ka,"PatternCompositeBinder"),Si(fh,"CompositeExpressionBinder"),Si(Mu,"ProgramConfiguration",{omit:["_buffers"]}),Si(mh,"ProgramConfigurationSet");const gl=ri/Math.PI/2,p=5,e=6,a=16383,f=64,y=[f,32,16],w=-gl,I=gl;function M(n,t,r,l=gl){return r=rr(r),[n*Math.sin(r)*l,-t*l,n*Math.cos(r)*l]}function L(n,t,r){return M(Math.cos(rr(n)),Math.sin(rr(n)),t,r)}const N=63710088e-1,V=2*Math.PI*N;class Z{constructor(t,r){if(isNaN(t)||isNaN(r))throw new Error(`Invalid LngLat object: (${t}, ${r})`);if(this.lng=+t,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Z(Nt(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const r=Math.PI/180,l=this.lat*r,u=t.lat*r,m=Math.sin(l)*Math.sin(u)+Math.cos(l)*Math.cos(u)*Math.cos((t.lng-this.lng)*r);return N*Math.acos(Math.min(m,1))}toBounds(t=0){const r=360*t/40075017,l=r/Math.cos(Math.PI/180*this.lat);return new U({lng:this.lng-l,lat:this.lat-r},{lng:this.lng+l,lat:this.lat+r})}toEcef(t){return L(this.lat,this.lng,gl+t*gl/N)}static convert(t){if(t instanceof Z)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new Z(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new Z(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class U{constructor(t,r){t&&(r?this.setSouthWest(t).setNorthEast(r):Array.isArray(t)&&t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof Z?new Z(t.lng,t.lat):Z.convert(t),this}setSouthWest(t){return this._sw=t instanceof Z?new Z(t.lng,t.lat):Z.convert(t),this}extend(t){const r=this._sw,l=this._ne;let u,m;if(t instanceof Z)u=t,m=t;else{if(!(t instanceof U))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(U.convert(t)):this.extend(Z.convert(t)):typeof t=="object"&&t!==null&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(Z.convert(t)):this;if(u=t._sw,m=t._ne,!u||!m)return this}return r||l?(r.lng=Math.min(u.lng,r.lng),r.lat=Math.min(u.lat,r.lat),l.lng=Math.max(m.lng,l.lng),l.lat=Math.max(m.lat,l.lat)):(this._sw=new Z(u.lng,u.lat),this._ne=new Z(m.lng,m.lat)),this}getCenter(){return new Z((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Z(this.getWest(),this.getNorth())}getSouthEast(){return new Z(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:r,lat:l}=Z.convert(t);let u=this._sw.lng<=r&&r<=this._ne.lng;return this._sw.lng>this._ne.lng&&(u=this._sw.lng>=r&&r>=this._ne.lng),this._sw.lat<=l&&l<=this._ne.lat&&u}static convert(t){if(t)return t instanceof U?t:new U(t)}}const X=0,Q=25.5;function nt(n){return V*Math.cos(n*Math.PI/180)}function ht(n){return(180+n)/360}function lt(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function _t(n,t){return n/nt(t)}function Ct(n){return 360*n-180}function bt(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Gt(n,t){return n*nt(bt(t))}const zt=85.051129;function Zt(n){return Math.cos(rr(tt(n,-zt,zt)))}function Vt(n,t){const r=tt(t,X,Q),l=Math.pow(2,r);return Zt(n)*V/(512*l)}function kt(n){return 1/Math.cos(n*Math.PI/180)}function Ht(n,t=0){const r=Math.exp(Math.PI*(1-(n.y+t/ri)/(1<<n.z)*2));return 80150034*r/(r*r+1)/ri/(1<<n.z)}class pe{constructor(t,r,l=0){this.x=+t,this.y=+r,this.z=+l}static fromLngLat(t,r=0){const l=Z.convert(t);return new pe(ht(l.lng),lt(l.lat),_t(r,l.lat))}toLngLat(){return new Z(Ct(this.x),bt(this.y))}toAltitude(){return Gt(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/V*kt(bt(this.y))}}function ae(n,t,r,l,u,m,_,b,E){const P=(t+l)/2,R=(r+u)/2,F=new Ae(P,R);b(F),function(O,$,q,Y,rt,at){const gt=q-rt,yt=Y-at;return Math.abs((Y-$)*gt-(q-O)*yt)/Math.hypot(gt,yt)}(F.x,F.y,m.x,m.y,_.x,_.y)>=E?(ae(n,t,r,P,R,m,F,b,E),ae(n,P,R,l,u,F,_,b,E)):n.push(_)}function Ce(n,t,r){let l=n[0],u=l.x,m=l.y;t(l);const _=[l];for(let b=1;b<n.length;b++){const E=n[b],{x:P,y:R}=E;t(E),ae(_,u,m,P,R,l,E,t,r),u=P,m=R,l=E}return _}function ve(n,t,r,l){if(l(t,r)){const u=t.add(r)._mult(.5);ve(n,t,u,l),ve(n,u,r,l)}else n.push(r)}function Fe(n,t){let r=n[0];const l=[r];for(let u=1;u<n.length;u++){const m=n[u];ve(l,r,m,t),r=m}return l}const oi=Math.pow(2,14)-1,ge=-oi-1;function re(n,t){const r=Math.round(n.x*t),l=Math.round(n.y*t);return n.x=tt(r,ge,oi),n.y=tt(l,ge,oi),(r<n.x||r>n.x+1||l<n.y||l>n.y+1)&&qi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function Be(n,t,r){const l=n.loadGeometry(),u=n.extent,m=ri/u;if(t&&r&&r.projection.isReprojectedInTileSpace){const _=1<<t.z,{scale:b,x:E,y:P,projection:R}=r,F=O=>{const $=Ct((t.x+O.x/u)/_),q=bt((t.y+O.y/u)/_),Y=R.project($,q);O.x=(Y.x*b-E)*u,O.y=(Y.y*b-P)*u};for(let O=0;O<l.length;O++)if(n.type!==1)l[O]=Ce(l[O],F,1);else{const $=[];for(const q of l[O])q.x<0||q.x>=u||q.y<0||q.y>=u||(F(q),$.push(q));l[O]=$}}for(const _ of l)for(const b of _)re(b,m);return l}function Te(n,t){return{type:n.type,id:n.id,properties:n.properties,geometry:t?Be(n):[]}}class qe{constructor(t,r,l,u,m){this.properties={},this.extent=l,this.type=0,this.id=void 0,this._pbf=t,this._geometry=-1,this._keys=u,this._values=m,t.readFields(si,this,r)}loadGeometry(){const t=this._pbf;t.pos=this._geometry;const r=t.readVarint()+t.pos,l=[];let u,m=1,_=0,b=0,E=0;for(;t.pos<r;){if(_<=0){const P=t.readVarint();m=7&P,_=P>>3}if(_--,m===1||m===2)b+=t.readSVarint(),E+=t.readSVarint(),m===1&&(u&&l.push(u),u=[]),u&&u.push(new Ae(b,E));else{if(m!==7)throw new Error(`unknown command ${m}`);u&&u.push(u[0].clone())}}return u&&l.push(u),l}bbox(){const t=this._pbf;t.pos=this._geometry;const r=t.readVarint()+t.pos;let l=1,u=0,m=0,_=0,b=1/0,E=-1/0,P=1/0,R=-1/0;for(;t.pos<r;){if(u<=0){const F=t.readVarint();l=7&F,u=F>>3}if(u--,l===1||l===2)m+=t.readSVarint(),_+=t.readSVarint(),m<b&&(b=m),m>E&&(E=m),_<P&&(P=_),_>R&&(R=_);else if(l!==7)throw new Error(`unknown command ${l}`)}return[b,P,E,R]}toGeoJSON(t,r,l){const u=this.extent*Math.pow(2,l),m=this.extent*t,_=this.extent*r,b=this.loadGeometry();function E(O){return[360*(O.x+m)/u-180,360/Math.PI*Math.atan(Math.exp((1-2*(O.y+_)/u)*Math.PI))-90]}function P(O){return O.map(E)}let R;if(this.type===1){const O=[];for(const q of b)O.push(q[0]);const $=P(O);R=O.length===1?{type:"Point",coordinates:$[0]}:{type:"MultiPoint",coordinates:$}}else if(this.type===2){const O=b.map(P);R=O.length===1?{type:"LineString",coordinates:O[0]}:{type:"MultiLineString",coordinates:O}}else{if(this.type!==3)throw new Error("unknown feature type");{const O=function(q){const Y=q.length;if(Y<=1)return[q];const rt=[];let at,gt;for(let yt=0;yt<Y;yt++){const Pt=Ci(q[yt]);Pt!==0&&(gt===void 0&&(gt=Pt<0),gt===Pt<0?(at&&rt.push(at),at=[q[yt]]):at&&at.push(q[yt]))}return at&&rt.push(at),rt}(b),$=[];for(const q of O)$.push(q.map(P));R=$.length===1?{type:"Polygon",coordinates:$[0]}:{type:"MultiPolygon",coordinates:$}}}const F={type:"Feature",geometry:R,properties:this.properties};return this.id!=null&&(F.id=this.id),F}}function si(n,t,r){n===1?t.id=r.readVarint():n===2?function(l,u){const m=l.readVarint()+l.pos;for(;l.pos<m;){const _=u._keys[l.readVarint()],b=u._values[l.readVarint()];u.properties[_]=b}}(r,t):n===3?t.type=r.readVarint():n===4&&(t._geometry=r.pos)}function Ci(n){let t=0;for(let r,l,u=0,m=n.length,_=m-1;u<m;_=u++)r=n[u],l=n[_],t+=(l.x-r.x)*(r.y+l.y);return t}qe.types=["Unknown","Point","LineString","Polygon"];class ni{constructor(t,r){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(li,this,r),this.length=this._features.length}feature(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];const r=this._pbf.readVarint()+this._pbf.pos;return new qe(this._pbf,r,this.extent,this._keys,this._values)}}function li(n,t,r){n===15?t.version=r.readVarint():n===1?t.name=r.readString():n===5?t.extent=r.readVarint():n===2?t._features.push(r.pos):n===3?t._keys.push(r.readString()):n===4&&t._values.push(function(l){let u=null;const m=l.readVarint()+l.pos;for(;l.pos<m;){const _=l.readVarint()>>3;u=_===1?l.readString():_===2?l.readFloat():_===3?l.readDouble():_===4?l.readVarint64():_===5?l.readVarint():_===6?l.readSVarint():_===7?l.readBoolean():null}if(u==null)throw new Error("unknown feature value");return u}(r))}class Li{constructor(t,r){this.layers=t.readFields(Ti,{},r)}}function Ti(n,t,r){if(n===3){const l=new ni(r,r.readVarint()+r.pos);l.length&&(t[l.name]=l)}}const xi="3d_elevation_id",Ii="level";class Zi{constructor(){this._valid=!1}reset(t){return this.feature=t,this._valid=!0,this._geometry=t.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(t,r){return this._valid&&t(r(this._geometry)),this}require(t,r,l){return this.get(t,!0,r,l)}optional(t,r,l){return this.get(t,!1,r,l)}success(){return this._valid}get(t,r,l,u){const m=this.feature.properties.hasOwnProperty(t)?+this.feature.properties[t]:void 0;return this._valid&&m!==void 0&&!Number.isNaN(m)?l(u?u(m):m):r&&(this._valid=!1),this}}class Fr{constructor(t,r){this.featureFunc=t,this.vertexFunc=r}parseFeature(t,r,l){return this.featureFunc(t,r,l)}parseVertex(t,r,l){return this.vertexFunc(t,r,l)}}const qr=new Fr((n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).optional("fixed_height_relative",l=>{r.constantHeight=l},ar.decodeRelativeHeight).geometry(l=>{r.bounds=l},Md).success(),(n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).require("elevation_idx",l=>{r.idx=l}).require("extent",l=>{r.extent=l}).require("height_relative",l=>{r.height=l},ar.decodeRelativeHeight).geometry(l=>{r.position=l},ar.getPoint).success()),En=new Fr((n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).optional("fixed_height",l=>{r.constantHeight=l},ar.decodeMetricHeight).geometry(l=>{r.bounds=l},Md).success(),(n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).require("elevation_idx",l=>{r.idx=l}).require("extent",l=>{r.extent=l}).require("height",l=>{r.height=l},ar.decodeMetricHeight).geometry(l=>{r.position=l},ar.getPoint).success());class ar{static getPoint(t){return we(t[0][0].x,t[0][0].y)}static decodeRelativeHeight(t){return 1e-4*t*5}static decodeMetricHeight(t){return 1e-4*t}static getVersionSchema(t){return t?t==="1.0.1"?En:void 0:qr}static parse(t){const r=[],l=[],u=t.length,m=new Zi;for(let _=0;_<u;_++){const b=t.feature(_),E=b.properties.version,P=ar.getVersionSchema(E);if(P===void 0){qi(`Unknown elevation feature version number ${E||"(unknown)"}`);continue}const R=b.properties.type;if(!R)continue;const F=qe.types[b.type];if(F==="Point"&&R==="curve_point"){const O={};P.parseVertex(m,b,O)&&r.push(O)}else if(F==="Polygon"&&R==="curve_meta"){const O={};P.parseFeature(m,b,O)&&l.push(O)}}return{vertices:r,features:l}}}class jr{constructor(t,r){this.pos=t,this.dir=r}intersectsPlane(t,r,l){const u=te(r,this.dir);if(Math.abs(u)<1e-6)return!1;const m=((t[0]-this.pos[0])*r[0]+(t[1]-this.pos[1])*r[1])/u;return l[0]=this.pos[0]+this.dir[0]*m,l[1]=this.pos[1]+this.dir[1]*m,!0}}class br{constructor(t,r){this.pos=t,this.dir=r}intersectsPlane(t,r,l){const u=ho(r,this.dir);if(Math.abs(u)<1e-6)return!1;const m=((t[0]-this.pos[0])*r[0]+(t[1]-this.pos[1])*r[1]+(t[2]-this.pos[2])*r[2])/u;return l[0]=this.pos[0]+this.dir[0]*m,l[1]=this.pos[1]+this.dir[1]*m,l[2]=this.pos[2]+this.dir[2]*m,!0}closestPointOnSphere(t,r,l){if(function($,q){var Y=$[0],rt=$[1],at=$[2],gt=q[0],yt=q[1],Pt=q[2];return Math.abs(Y-gt)<=Pe*Math.max(1,Math.abs(Y),Math.abs(gt))&&Math.abs(rt-yt)<=Pe*Math.max(1,Math.abs(rt),Math.abs(yt))&&Math.abs(at-Pt)<=Pe*Math.max(1,Math.abs(at),Math.abs(Pt))}(this.pos,t)||r===0)return l[0]=l[1]=l[2]=0,!1;const[u,m,_]=this.dir,b=this.pos[0]-t[0],E=this.pos[1]-t[1],P=this.pos[2]-t[2],R=u*u+m*m+_*_,F=2*(b*u+E*m+P*_),O=F*F-4*R*(b*b+E*E+P*P-r*r);if(O<0){const $=Math.max(-F/2,0),q=b+u*$,Y=E+m*$,rt=P+_*$,at=Math.hypot(q,Y,rt);return l[0]=q*r/at,l[1]=Y*r/at,l[2]=rt*r/at,!1}{const $=(-F-Math.sqrt(O))/(2*R);if($<0){const q=Math.hypot(b,E,P);return l[0]=b*r/q,l[1]=E*r/q,l[2]=P*r/q,!1}return l[0]=b+u*$,l[1]=E+m*$,l[2]=P+_*$,!0}}}class xn{constructor(t,r,l,u,m){this.TL=t,this.TR=r,this.BR=l,this.BL=u,this.horizon=m}static fromInvProjectionMatrix(t,r,l){const u=[-1,1,1],m=[1,1,1],_=[1,-1,1],b=[-1,-1,1],E=Kn(u,u,t),P=Kn(m,m,t),R=Kn(_,_,t),F=Kn(b,b,t);return new xn(E,P,R,F,r/l)}}function Vr(n,t,r){let l=1/0,u=-1/0;const m=[];for(const _ of n){Zn(m,_,t);const b=ho(m,r);l=Math.min(l,b),u=Math.max(u,b)}return[l,u]}function kn(n,t){let r=!0;for(let l=0;l<n.planes.length;l++){const u=n.planes[l];let m=0;for(let _=0;_<t.length;_++)m+=+(ho(u,t[_])+u[3]>=0);if(m===0)return 0;m!==t.length&&(r=!1)}return r?2:1}function Kr(n,t){for(const r of n.projections){const l=Vr(t,n.points[0],r.axis);if(r.projection[1]<l[0]||r.projection[0]>l[1])return 0}return 1}function wr(n,t){let r=0;const l=[0,0,0,0];for(let _=0;_<n.length;_++)l[0]=n[_][0],l[1]=n[_][1],l[2]=n[_][2],l[3]=1,(u=l)[0]*(m=t)[0]+u[1]*m[1]+u[2]*m[2]+u[3]*m[3]>=0&&r++;var u,m;return r}class ln{constructor(t,r){this.points=t||new Array(8).fill([0,0,0]),this.planes=r||new Array(6).fill([0,0,0,0]),this.bounds=Er.fromPoints(this.points),this.projections=[],this.frustumEdges=[Zn([],this.points[2],this.points[3]),Zn([],this.points[0],this.points[3]),Zn([],this.points[4],this.points[0]),Zn([],this.points[5],this.points[1]),Zn([],this.points[6],this.points[2]),Zn([],this.points[7],this.points[3])];for(const l of this.frustumEdges){const u=[0,-l[2],l[1]],m=[l[2],0,-l[0]];this.projections.push({axis:u,projection:Vr(this.points,this.points[0],u)}),this.projections.push({axis:m,projection:Vr(this.points,this.points[0],m)})}}static fromInvProjectionMatrix(t,r,l,u){const m=Math.pow(2,l),_=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(P=>{const R=ds([],P,t),F=1/R[3]/r*m;return(O=R)[0]=($=R)[0]*(q=[F,F,u?1/R[3]:F,F])[0],O[1]=$[1]*q[1],O[2]=$[2]*q[2],O[3]=$[3]*q[3],O;var O,$,q}),b=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(P=>{const R=bn([],qo([],Zn([],_[P[0]],_[P[1]]),Zn([],_[P[2]],_[P[1]]))),F=-ho(R,_[P[1]]);return R.concat(F)}),E=[];for(let P=0;P<_.length;P++)E.push([_[P][0],_[P][1],_[P][2]]);return new ln(E,b)}intersectsPrecise(t,r,l){for(let u=0;u<r.length;u++)if(!wr(t,r[u]))return 0;for(let u=0;u<this.planes.length;u++)if(!wr(t,this.planes[u]))return 0;for(const u of l)for(const m of this.frustumEdges){const _=qo([],u,m),b=ws(_);if(b===0)continue;Jn(_,_,1/b);const E=Vr(this.points,this.points[0],_),P=Vr(t,this.points[0],_);if(E[0]>P[1]||P[0]>E[1])return 0}return 1}containsPoint(t){for(const r of this.planes){const l=r[3];if(ho([r[0],r[1],r[2]],t)+l<0)return!1}return!0}}class Er{static fromPoints(t){const r=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(const u of t)js(r,r,u),Js(l,l,u);return new Er(r,l)}static fromTileIdAndHeight(t,r,l){const u=1<<t.canonical.z,m=t.canonical.x,_=t.canonical.y;return new Er([m/u,_/u,r],[(m+1)/u,(_+1)/u,l])}static applyTransform(t,r){const l=t.getCorners();for(let u=0;u<l.length;++u)Kn(l[u],l[u],r);return Er.fromPoints(l)}static applyTransformFast(t,r){const l=[r[12],r[13],r[14]],u=[...l];for(let m=0;m<3;m++)for(let _=0;_<3;_++){const b=r[4*_+m],E=b*t.min[_],P=b*t.max[_];l[m]+=Math.min(E,P),u[m]+=Math.max(E,P)}return new Er(l,u)}static projectAabbCorners(t,r){const l=t.getCorners();for(let u=0;u<l.length;++u)Kn(l[u],l[u],r);return l}constructor(t,r){this.min=t,this.max=r,this.center=Jn([],Fo([],this.min,this.max),.5)}quadrant(t){const r=[t%2==0,t<2],l=bh(this.min),u=bh(this.max);for(let m=0;m<r.length;m++)l[m]=r[m]?this.min[m]:this.center[m],u[m]=r[m]?this.center[m]:this.max[m];return u[2]=this.max[2],new Er(l,u)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,r=this.max;return[[t[0],t[1],t[2]],[r[0],t[1],t[2]],[r[0],r[1],t[2]],[t[0],r[1],t[2]],[t[0],t[1],r[2]],[r[0],t[1],r[2]],[r[0],r[1],r[2]],[t[0],r[1],r[2]]]}intersects(t){return this.intersectsAabb(t.bounds)?kn(t,this.getCorners()):0}intersectsFlat(t){return this.intersectsAabb(t.bounds)?kn(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(t,r){return r||this.intersects(t)?Kr(t,this.getCorners()):0}intersectsPreciseFlat(t,r){return r||this.intersectsFlat(t)?Kr(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(t){for(let r=0;r<3;++r)if(this.min[r]>t.max[r]||t.min[r]>this.max[r])return!1;return!0}intersectsAabbXY(t){return!(this.min[0]>t.max[0]||t.min[0]>this.max[0]||this.min[1]>t.max[1]||t.min[1]>this.max[1])}encapsulate(t){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],t.min[r]),this.max[r]=Math.max(this.max[r],t.max[r])}encapsulatePoint(t){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],t[r]),this.max[r]=Math.max(this.max[r],t[r])}closestPoint(t){return[Math.max(Math.min(this.max[0],t[0]),this.min[0]),Math.max(Math.min(this.max[1],t[1]),this.min[1]),Math.max(Math.min(this.max[2],t[2]),this.min[2])]}}Si(Er,"Aabb");class eo{constructor(t,r){this.feature=t,this.metersToTile=r,this.index=0}get(){const t=this.feature.vertices[this.index],r=this.feature.vertexProps[this.index].dir,l=r[1],u=-r[0],m=(t.extent+1)*this.metersToTile;return[new Ae(Math.trunc(t.position[0]+l*m),Math.trunc(t.position[1]+u*m)),new Ae(Math.trunc(t.position[0]-l*m),Math.trunc(t.position[1]-u*m))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class cn{constructor(t,r,l,u,m,_){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[Hn(),Hn(),Hn(),Hn(),Hn(),Hn(),Hn()],this.id=t,this.heightRange={min:l,max:l},this.safeArea=r,this.constantHeight=l,this.constantHeight==null&&(this.constantHeight!=null||u.length!==0)){this.vertices=u,this.edges=m,this.edges=this.edges.filter(b=>{return b.a<this.vertices.length&&b.b<this.vertices.length&&!((E=this.vertices[b.a].position)[0]===(P=this.vertices[b.b].position)[0]&&E[1]===P[1]);var E,P}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const b of this.vertices)this.vertexProps.push({dir:we(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,b.height),this.heightRange.max=Math.max(this.heightRange.max,b.height);for(const b of this.edges){const E=this.vertices[b.a].position,P=this.vertices[b.b].position,R=Ut(Hn(),P,E),F=le(R),O=he(Hn(),R,1/F);this.edgeProps.push({vec:R,dir:O,len:F});const $=this.vertexProps[b.a].dir,q=this.vertexProps[b.b].dir;Mt($,$,O),Mt(q,q,O)}for(const b of this.vertexProps)b.dir[0]===0&&b.dir[1]===0||Re(b.dir,b.dir);this.tessellate(_)}}pointElevation(t){if(this.constantHeight!=null)return this.constantHeight;const r=this.getClosestEdge(t);if(r==null)return 0;const[l,u]=r;return Vi(this.vertices[this.edges[l].a].height,this.vertices[this.edges[l].b].height,u)}computeSlopeNormal(t,r){const l=this.getClosestEdge(t);if(!l)return so(0,0,1);const u=l[0],m=this.edges[u],_=this.edgeProps[u].vec,b=so(_[0],_[1],(this.vertices[m.b].height-this.vertices[m.a].height)*r),E=so(b[1],-b[0],0);qo(E,E,b);const P=ws(E);return P>0?Jn(E,E,1/P):dn(E,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(t){if(this.edges.length===0)return;let r=0,l=Number.POSITIVE_INFINITY,u=0;const[m,_,b,E,P,R,F]=this._tmpVec2;It(F,t.x,t.y);const O=new jr(F,null);for(let $=0;$<this.edges.length;$++){const q=this.edges[$],Y=this.edgeProps[$].dir;O.dir=Y;const rt=this.vertices[q.a].position,at=this.vertices[q.b].position,gt=O.intersectsPlane(rt,this.vertexProps[q.a].dir,m),yt=O.intersectsPlane(at,this.vertexProps[q.b].dir,_);if(!gt||!yt)continue;Ut(b,_,m),Ut(E,F,m);const Pt=te(b,b),qt=Pt>0?te(E,b)/Pt:0,Bt=tt(qt,0,1),Yt=Math.abs((qt-Bt)*this.edgeProps[$].len);Ut(P,F,rt),It(R,Y[1],-Y[0]);const ee=Yt+Math.abs(te(P,R));ee<l&&(r=$,l=ee,u=Bt)}return[r,u]}tessellate(t){const r=Zr(),l=Zr(),u=Zr(),m=Zr();for(let _=this.edges.length-1;_>=0;--_){const b=this.edges[_].a,E=this.edges[_].b,{position:P,height:R,extent:F}=this.vertices[b],{position:O,height:$,extent:q}=this.vertices[E],Y=this.vertexProps[b].dir,rt=this.vertexProps[E].dir;if(dn(r,P[0]/t,P[1]/t,R),dn(l,O[0]/t,O[1]/t,$),dn(u,Y[1],-Y[0],0),Jn(u,u,F),dn(m,rt[1],-rt[0],0),Jn(m,m,q),this.distSqLines(so(r[0]+.5*u[0],r[1]+.5*u[1],r[2]+.5*u[2]),so(l[0]-.5*m[0],l[1]-.5*m[1],l[2]-.5*m[2]),so(r[0]-.5*u[0],r[1]-.5*u[1],r[2]-.5*u[2]),so(l[0]+.5*m[0],l[1]+.5*m[1],l[2]+.5*m[2]))<=.0025000000000000005)continue;const at=this.vertices.length,gt=Mt(Hn(),P,O);this.vertices.push({position:he(gt,gt,.5),height:.5*(R+$),extent:.5*(F+q)});const yt=Mt(Hn(),Y,rt);this.vertexProps.push({dir:Re(yt,yt)}),this.edges.splice(_,1),this.edgeProps.splice(_,1),this.edges.push({a:b,b:at}),this.edges.push({a:at,b:E});const Pt=Ut(Hn(),this.vertices[at].position,P),qt=le(Pt),Bt={vec:Pt,dir:he(Hn(),Pt,1/qt),len:qt};this.edgeProps.push(Bt),this.edgeProps.push(Bt)}}distSqLines(t,r,l,u){const m=Ln(Zr(),r,t),_=Ln(Zr(),u,l),b=Ln(Zr(),t,l),E=ho(m,m),P=ho(m,_),R=ho(m,b),F=ho(_,_),O=ho(_,b),$=E*F-P*P;if($===0)return Qs(ma(m,l,u,ho(b,_)/ho(_,_)),t);const q=(E*O-P*R)/$;return Qs(ma(m,t,r,(P*O-R*F)/$),ma(_,l,u,q))}}class cr{static parseFrom(t,r){const l=ar.parse(t);if(!l)return[];let{vertices:u,features:m}=l;const _=1/Ht(r);m.sort((R,F)=>R.id-F.id),u.sort((R,F)=>R.id-F.id||R.idx-F.idx),u=u.filter((R,F,O)=>F===O.findIndex($=>$.id===R.id&&$.idx===R.idx));const b=new Array;let E=0;const P=u.length;for(const R of m){if(R.constantHeight){b.push(new cn(R.id,R.bounds,R.constantHeight));continue}for(;E!==P&&u[E].id<R.id;)E++;if(E===P||u[E].id!==R.id)continue;const F=new Array,O=new Array,$=E;for(;E!==P&&u[E].id===R.id;){const q=u[E];if(F.push({position:q.position,height:q.height,extent:q.extent}),E!==$&&u[E-1].idx===q.idx-1){const Y=E-$;O.push({a:Y-1,b:Y})}E++}b.push(new cn(R.id,R.bounds,void 0,F,O,_))}return b}static getElevationFeature(t,r){if(!r)return;const l=+t.properties[xi];return Number.isNaN(l)?void 0:r.find(u=>u.id===l)}}class Wr{constructor(t,r){this.zScale=1,this.xOffset=0,this.yOffset=0,t.equals(r)||(this.zScale=Math.pow(2,r.z-t.z),this.xOffset=(t.x*this.zScale-r.x)*ri,this.yOffset=(t.y*this.zScale-r.y)*ri)}constantElevation(t,r){if(t.constantHeight!=null)return this.computeBiasedHeight(t.constantHeight,r)}pointElevation(t,r,l){const u=this.constantElevation(r,l);return u??(t.x=t.x*this.zScale+this.xOffset,t.y=t.y*this.zScale+this.yOffset,this.computeBiasedHeight(r.pointElevation(t),l))}computeBiasedHeight(t,r){return r<=0?t:t+r*Tt(0,r,t>=0?t:Math.abs(.5*t))}}Si(cn,"ElevationFeature");class fo{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new ys,this.indexArray=new qn,this.segments=new po,this.programConfigurations=new mh(t.layers,{zoom:t.zoom,lut:t.lut}),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Fs),this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){const m=this.layers[0],_=[];let b=null;m.type==="circle"&&(b=m.layout.get("circle-sort-key"));for(const{feature:P,id:R,index:F,sourceLayerIndex:O}of t){const $=this.layers[0]._featureFilter.needGeometry,q=Te(P,$);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),q,l))continue;const Y=b?b.evaluate(q,{},l):void 0,rt={id:R,properties:P.properties,type:P.type,sourceLayerIndex:O,index:F,geometry:$?q.geometry:Be(P,l,u),patterns:{},sortKey:Y};_.push(rt)}b&&_.sort((P,R)=>P.sortKey-R.sortKey);let E=null;u.projection.name==="globe"&&(this.globeExtVertexArray=new hs,E=u.projection);for(const P of _){const{geometry:R,index:F,sourceLayerIndex:O}=P,$=t[F].feature;this.addFeature(P,R,F,r.availableImages,l,E,r.brightness,r.elevationFeatures),r.featureIndex.insert($,R,F,O,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(t,r,l,u,m,_,b){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,_g.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,yg.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=t.createVertexBuffer(this.elevatedLayoutVertexArray,f_.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(t,r,l,u,m,_,b,E){let P;this.elevationMode!=="none"&&(P=cr.getElevationFeature(t,E));for(const R of r)for(const F of R){const O=F.x,$=F.y;if(O<0||O>=ri||$<0||$>=ri)continue;if(_){const rt=_.projectTilePoint(O,$,m),at=_.upVector(m,O,$);this.addGlobeExtVertex(rt,at),this.addGlobeExtVertex(rt,at),this.addGlobeExtVertex(rt,at),this.addGlobeExtVertex(rt,at)}const q=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),Y=q.vertexLength;if(this.addCircleVertex(O,$,-1,-1),this.addCircleVertex(O,$,1,-1),this.addCircleVertex(O,$,1,1),this.addCircleVertex(O,$,-1,1),this.elevationMode!=="none"){const rt=P?P.pointElevation(new Ae(O,$)):0;this.hasElevation=this.hasElevation||rt!==0;for(let at=0;at<4;at++)this.elevatedLayoutVertexArray.emplaceBack(rt)}this.indexArray.emplaceBack(Y,Y+1,Y+2),this.indexArray.emplaceBack(Y,Y+2,Y+3),q.vertexLength+=4,q.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,l,{},u,m,b,void 0,this.worldview)}addCircleVertex(t,r,l,u){this.layoutVertexArray.emplaceBack(2*t+(l+1)/2,2*r+(u+1)/2)}addGlobeExtVertex(t,r){this.globeExtVertexArray.emplaceBack(t.x,t.y,t.z,r[0]*16384,r[1]*16384,r[2]*16384)}}function Uo(n,t){for(let r=0;r<n.length;r++)if(Bs(t,n[r]))return!0;for(let r=0;r<t.length;r++)if(Bs(n,t[r]))return!0;return!!ha(n,t)}function So(n,t,r){return!!Bs(n,t)||!!ua(t,n,r)}function Ro(n,t){if(n.length===1)return xc(t,n[0]);for(let r=0;r<t.length;r++){const l=t[r];for(let u=0;u<l.length;u++)if(Bs(n,l[u]))return!0}for(let r=0;r<n.length;r++)if(xc(t,n[r]))return!0;for(let r=0;r<t.length;r++)if(ha(n,t[r]))return!0;return!1}function mo(n,t,r){if(n.length>1){if(ha(n,t))return!0;for(let l=0;l<t.length;l++)if(ua(t[l],n,r))return!0}for(let l=0;l<n.length;l++)if(ua(n[l],t,r))return!0;return!1}function ha(n,t){if(n.length===0||t.length===0)return!1;for(let r=0;r<n.length-1;r++){const l=n[r],u=n[r+1];for(let m=0;m<t.length-1;m++)if(wa(l,u,t[m],t[m+1]))return!0}return!1}function wa(n,t,r,l){return hr(n,r,l)!==hr(t,r,l)&&hr(n,t,r)!==hr(n,t,l)}function Fa(n,t,r){return(n.x-r.x)*(t.y-r.y)-(n.y-r.y)*(t.x-r.x)}function tc(n,t,r,l){const u=Fa(n,t,l),m=Fa(n,t,r);if(Math.sign(u)===Math.sign(m))return;const _=Fa(r,l,n),b=_+m-u;return Math.sign(_)!==Math.sign(b)?[_/(_-b),m/(m-u)]:void 0}function ua(n,t,r){const l=r*r;if(t.length===1)return n.distSqr(t[0])<l;for(let u=1;u<t.length;u++)if(yc(n,t[u-1],t[u])<l)return!0;return!1}function yc(n,t,r){const l=t.distSqr(r);if(l===0)return n.distSqr(t);const u=((n.x-t.x)*(r.x-t.x)+(n.y-t.y)*(r.y-t.y))/l;return n.distSqr(u<0?t:u>1?r:r.sub(t)._mult(u)._add(t))}function xc(n,t){let r,l,u,m=!1;for(let _=0;_<n.length;_++){r=n[_];for(let b=0,E=r.length-1;b<r.length;E=b++)l=r[b],u=r[E],l.y>t.y!=u.y>t.y&&t.x<(u.x-l.x)*(t.y-l.y)/(u.y-l.y)+l.x&&(m=!m)}return m}function Bs(n,t){let r=!1;for(let l=0,u=n.length-1;l<n.length;u=l++){const m=n[l],_=n[u];m.y>t.y!=_.y>t.y&&t.x<(_.x-m.x)*(t.y-m.y)/(_.y-m.y)+m.x&&(r=!r)}return r}function io(n,t,r,l,u){for(const _ of n)if(t<=_.x&&r<=_.y&&l>=_.x&&u>=_.y)return!0;const m=[new Ae(t,r),new Ae(t,u),new Ae(l,u),new Ae(l,r)];if(n.length>2){for(const _ of m)if(Bs(n,_))return!0}for(let _=0;_<n.length-1;_++)if(ko(n[_],n[_+1],m))return!0;return!1}function ko(n,t,r){const l=r[0],u=r[2];if(n.x<l.x&&t.x<l.x||n.x>u.x&&t.x>u.x||n.y<l.y&&t.y<l.y||n.y>u.y&&t.y>u.y)return!1;const m=hr(n,t,r[0]);return m!==hr(n,t,r[1])||m!==hr(n,t,r[2])||m!==hr(n,t,r[3])}function Dn(n,t,r,l,u,m){let _=t.y-n.y,b=n.x-t.x;if(m=m||0){const E=_*_+b*b;if(E===0)return!0;const P=Math.sqrt(E);_/=P,b/=P}return!((r.x-n.x)*_+(r.y-n.y)*b-m<0||(l.x-n.x)*_+(l.y-n.y)*b-m<0||(u.x-n.x)*_+(u.y-n.y)*b-m<0)}function $o(n,t,r,l,u,m,_){return!(Dn(n,t,l,u,m,_)||Dn(t,r,l,u,m,_)||Dn(r,n,l,u,m,_)||Dn(l,u,n,t,r,_)||Dn(u,m,n,t,r,_)||Dn(m,l,n,t,r,_))}function As(n,t,r){const l=t.paint.get(n).value;return l.kind==="constant"?l.value:r.programConfigurations.get(t.id).getMaxValue(n)}function ro(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function ec(n,t,r,l,u){if(!t[0]&&!t[1])return n;const m=Ae.convert(t)._mult(u);r==="viewport"&&m._rotate(-l);const _=[];for(let b=0;b<n.length;b++)_.push(n[b].sub(m));return _}function Np(n,t,r,l){const u=Ae.convert(n)._mult(l);return t==="viewport"&&u._rotate(-r),u}let Cu,Vp;function Up(n,t,r){var l=2*Math.PI*6378137/256/Math.pow(2,r);return[n*l-2*Math.PI*6378137/2,t*l-2*Math.PI*6378137/2]}Si(fo,"CircleBucket",{omit:["layers"]});class vc{constructor(t,r,l){this.z=t,this.x=r,this.y=l,this.key=bc(0,t,t,r,l)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}isChildOf(t){const r=this.z-t.z;return t.z===0||t.z<this.z&&t.x===this.x>>r&&t.y===this.y>>r}url(t,r){const l=function(m,_,b){var E=Up(256*m,256*(_=Math.pow(2,b)-_-1),b),P=Up(256*(m+1),256*(_+1),b);return E[0]+","+E[1]+","+P[0]+","+P[1]}(this.x,this.y,this.z),u=function(m,_,b){let E,P="";for(let R=m;R>0;R--)E=1<<R-1,P+=(_&E?1:0)+(b&E?2:0);return P}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(r==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",u).replace("{bbox-epsg-3857}",l)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Kh{constructor(t,r){this.wrap=t,this.canonical=r,this.key=bc(t,r.z,r.z,r.x,r.y)}}class Os{constructor(t,r,l,u,m){this.overscaledZ=t,this.wrap=r,this.canonical=new vc(l,+u,+m),this.key=r===0&&t===l?this.canonical.key:bc(r,t,l,u,m)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const r=this.canonical.z-t;return t>this.canonical.z?new Os(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Os(t,this.wrap,t,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(t,r=!0){if(this.overscaledZ===t&&r)return this.key;if(t>this.canonical.z)return bc(this.wrap*+r,t,this.canonical.z,this.canonical.x,this.canonical.y);{const l=this.canonical.z-t;return bc(this.wrap*+r,t,t,this.canonical.x>>l,this.canonical.y>>l)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const r=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.z<this.canonical.z&&t.canonical.x===this.canonical.x>>r&&t.canonical.y===this.canonical.y>>r}children(t){if(this.overscaledZ>=t)return[new Os(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,l=2*this.canonical.x,u=2*this.canonical.y;return[new Os(r,this.wrap,r,l,u),new Os(r,this.wrap,r,l+1,u),new Os(r,this.wrap,r,l,u+1),new Os(r,this.wrap,r,l+1,u+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new Os(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new Os(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Kh(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function bc(n,t,r,l,u){const m=1<<Math.min(r,22);let _=m*(u%m)+l%m;return n&&r<22&&(_+=m*m*((n<0?-2*n-1:2*n)%(1<<2*(22-r)))),16*(32*_+r)+(t-r)}const Yd=[n=>{let t=n.canonical.x-1,r=n.wrap;return t<0&&(t=(1<<n.canonical.z)-1,r--),new Os(n.overscaledZ,r,n.canonical.z,t,n.canonical.y)},n=>{let t=n.canonical.x+1,r=n.wrap;return t===1<<n.canonical.z&&(t=0,r++),new Os(n.overscaledZ,r,n.canonical.z,t,n.canonical.y)},n=>new Os(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new Os(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];Si(vc,"CanonicalTileID"),Si(Os,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const wg=vr([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:em}=wg,ex=vr([{name:"a_pos_3",components:3,type:"Int16"}]);var x_=vr([{name:"a_pos",type:"Int16",components:2}]);function im(n){return n*gl/N}const Dy=[new Er([w,w,w],[I,I,I]),new Er([w,w,w],[0,0,I]),new Er([0,w,w],[I,0,I]),new Er([w,0,w],[0,I,I]),new Er([0,0,w],[I,I,I])];function Jd(n,t,r,l=!0){const u=Jn([],n._camera.position,n.worldSize),m=[t,r,1,1];ds(m,m,n.pixelMatrixInverse),ga(m,m,1/m[3]);const _=bn([],Zn([],m,u)),b=n.globeMatrix,E=[b[12],b[13],b[14]],P=Zn([],E,u),R=ws(P),F=bn([],P),O=n.worldSize/(2*Math.PI),$=ho(F,_),q=Math.asin(O/R);if(q<Math.acos($)){if(!l)return null;const Le=[],fe=[];Jn(Le,_,R/$),bn(fe,Zn(fe,Le,P)),bn(_,Fo(_,P,Jn(_,fe,Math.tan(q)*R)))}const Y=[];new br(u,_).closestPointOnSphere(E,O,Y);const rt=bn([],Wn(b,0)),at=bn([],Wn(b,1)),gt=bn([],Wn(b,2)),yt=ho(rt,Y),Pt=ho(at,Y),qt=ho(gt,Y),Bt=bi(Math.asin(-Pt/O));let Yt=bi(Math.atan2(yt,qt));Yt=n.center.lng+function(Le,fe){const ke=(fe-Le+180)%360-180;return ke<-180?ke+360:ke}(n.center.lng,Yt);const ee=ht(Yt),ne=tt(lt(Bt),0,1);return new pe(ee,ne)}class Tg{constructor(t,r,l){this.a=Zn([],t,l),this.b=Zn([],r,l),this.center=l;const u=bn([],this.a),m=bn([],this.b);this.angle=Math.acos(ho(u,m))}}function Um(n,t){if(n.angle===0)return null;let r;return r=n.a[t]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[t]/n.a[t]/Math.sin(n.angle)-1/Math.tan(n.angle)),r<0||r>1?null:function(l,u,m,_){const b=Math.sin(m);return l*(Math.sin((1-_)*m)/b)+u*(Math.sin(_*m)/b)}(n.a[t],n.b[t],n.angle,tt(r,0,1))+n.center[t]}function fd(n){if(n.z<=1)return Dy[n.z+2*n.y+n.x];const t=v_(Sg(n));return Er.fromPoints(t)}function md(n,t,r){return Jn(n,n,1-r),Ks(n,n,t,r)}function zy(n,t,r){for(const l of n)Kn(l,l,t),Jn(l,l,r)}function Ly(n,t,r,l){const u=t/n.worldSize,m=n.globeMatrix;if(r.z<=1){const ne=fd(r).getCorners();return zy(ne,m,u),Er.fromPoints(ne)}const _=Sg(r,l),b=v_(_,gl+im(n._tileCoverLift));zy(b,m,u);const E=Number.MAX_VALUE,P=[-E,-E,-E],R=[E,E,E];if(_.contains(n.center)){for(const fe of b)js(R,R,fe),Js(P,P,fe);P[2]=0;const ne=n.point,Le=[ne.x*u,ne.y*u,0];return js(R,R,Le),Js(P,P,Le),new Er(R,P)}if(n._tileCoverLift>0){for(const ne of b)js(R,R,ne),Js(P,P,ne);return new Er(R,P)}const F=[m[12]*u,m[13]*u,m[14]*u],O=_.getCenter(),$=tt(n.center.lat,-zt,zt),q=tt(O.lat,-zt,zt),Y=ht(n.center.lng),rt=lt($);let at=Y-ht(O.lng);const gt=rt-lt(q);at>.5?at-=1:at<-.5&&(at+=1);let yt=0;Math.abs(at)>Math.abs(gt)?yt=at>=0?1:3:(yt=gt>=0?0:2,Ks(F,F,[m[4]*u,m[5]*u,m[6]*u],-Math.sin(rr(gt>=0?_.getSouth():_.getNorth()))*gl));const Pt=b[yt],qt=b[(yt+1)%4],Bt=new Tg(Pt,qt,F),Yt=[Um(Bt,0)||Pt[0],Um(Bt,1)||Pt[1],Um(Bt,2)||Pt[2]],ee=Du(n.zoom);if(ee>0){const ne=function({x:fe,y:ke,z:Ue},Ze,hi,Ke,je){const Ye=1/(1<<Ue);let Me=fe*Ye,Ie=Me+Ye,He=ke*Ye,ai=He+Ye,Ge=0;const Pi=(Me+Ie)/2-Ke;return Pi>.5?Ge=-1:Pi<-.5&&(Ge=1),Me=((Me+Ge)*Ze-(Ke*=Ze))*hi+Ke,Ie=((Ie+Ge)*Ze-Ke)*hi+Ke,He=(He*Ze-(je*=Ze))*hi+je,ai=(ai*Ze-je)*hi+je,[[Me,ai,0],[Ie,ai,0],[Ie,He,0],[Me,He,0]]}(r,t,n._pixelsPerMercatorPixel,Y,rt);for(let fe=0;fe<b.length;fe++)md(b[fe],ne[fe],ee);const Le=Fo([],ne[yt],ne[(yt+1)%4]);Jn(Le,Le,.5),md(Yt,Le,ee)}for(const ne of b)js(R,R,ne),Js(P,P,ne);return R[2]=Math.min(Pt[2],qt[2]),js(R,R,Yt),Js(P,P,Yt),new Er(R,P)}function Sg({x:n,y:t,z:r},l=!1){const u=1/(1<<r),m=new Z(Ct(n*u),t===(1<<r)-1&&l?-90:bt((t+1)*u)),_=new Z(Ct((n+1)*u),t===0&&l?90:bt(t*u));return new U(m,_)}function v_(n,t=gl){const r=rr(n.getNorth()),l=rr(n.getSouth()),u=Math.cos(r),m=Math.cos(l),_=Math.sin(r),b=Math.sin(l),E=n.getWest(),P=n.getEast();return[M(m,b,E,t),M(m,b,P,t),M(u,_,P,t),M(u,_,E,t)]}function jm(n,t,r,l){const u=1<<r.z,m=(n/ri+r.x)/u;return L(bt((t/ri+r.y)/u),Ct(m),l)}function Gm({min:n,max:t}){return a/Math.max(t[0]-n[0],t[1]-n[1],t[2]-n[2])}const b_=new Float64Array(16);function Qh(n){const t=Gm(n),r=tl(b_,[t,t,t]);return Yr(r,r,Wo([],n.min))}function gd(n){const t=(l=n.min,(r=b_)[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=l[0],r[13]=l[1],r[14]=l[2],r[15]=1,r);var r,l;const u=1/Gm(n);return Fn(t,t,[u,u,u])}function Ig(n){const t=ri/(2*Math.PI);return n/(2*Math.PI)/t}function Eg(n,t){return ri/(512*Math.pow(2,n))*Gm(fd(t))}function Ry(n,t,r,l,u){const m=Ig(r),_=[n,t,-r/(2*Math.PI)],b=Ve(new Float64Array(16));return Yr(b,b,_),Fn(b,b,[m,m,m]),us(b,b,rr(-u)),ao(b,b,rr(-l)),b}function Du(n){return Tt(p,e,n)}function Ag(n,t){const r=L(t.lat,t.lng),l=function(q){const Y=L(q._center.lat,q._center.lng);let rt=qo([],so(0,1,0),Y);const at=fa([],-q.angle,Y);rt=Kn(rt,rt,at),fa(at,-q._pitch,rt);const gt=bn([],Y);return Jn(gt,gt,im(q.cameraToCenterDistance/q.pixelsPerMeter)),Kn(gt,gt,at),Fo([],Y,gt)}(n);return _=(u=Ln([],l,r))[0],b=u[1],E=u[2],P=(m=r)[0],R=m[1],F=m[2],$=(O=Math.sqrt((_*_+b*b+E*E)*(P*P+R*R+F*F)))&&ho(u,m)/O,Math.acos(Math.min(Math.max($,-1),1));var u,m,_,b,E,P,R,F,O,$}function w_(n,t){return Ag(n,t)>Math.PI/2*1.01}const Pg=rr(85),T_=Math.cos(Pg),rm=Math.sin(Pg),ky=Or(),S_=n=>{const t=[];return n.paint.get("circle-pitch-alignment")==="map"&&t.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&t.push("SCALE_WITH_MAP"),t};function Mg(n,t,r,l,u,m,_,b,E){if(m&&n.queryGeometry.isAboveHorizon)return!1;m&&(E*=n.pixelToTileUnitsFactor);const P=n.tileID.canonical,R=r.projection.upVectorScale(P,r.center.lat,r.worldSize).metersToTile;for(const F of t)for(const O of F){const $=O.add(b),q=u&&r.elevation?r.elevation.exaggeration()*u.getElevationAt($.x,$.y,!0):0,Y=r.projection.projectTilePoint($.x,$.y,P);if(q>0){const yt=r.projection.upVector(P,$.x,$.y);Y.x+=yt[0]*R*q,Y.y+=yt[1]*R*q,Y.z+=yt[2]*R*q}const rt=m?$:Fy(Y.x,Y.y,Y.z,l),at=m?n.tilespaceRays.map(yt=>ix(yt,q)):n.queryGeometry.screenGeometry,gt=ds([],[Y.x,Y.y,Y.z,1],l);if(!_&&m?E*=gt[3]/r.cameraToCenterDistance:_&&!m&&(E*=r.cameraToCenterDistance/gt[3]),m){const yt=bt((O.y/ri+P.y)/(1<<P.z));E/=r.projection.pixelsPerMeter(yt,1)/_t(1,yt)}if(So(at,rt,E))return!0}return!1}function Fy(n,t,r,l){const u=ds([],[n,t,r,1],l);return new Ae(u[0]/u[3],u[1]/u[3])}const $m=so(0,0,0),By=so(0,0,1);function ix(n,t){const r=Zr();return $m[2]=t,n.intersectsPlane($m,By,r),new Ae(r[0],r[1])}class Oy extends fo{}let Ny,Vy,Uy,Cg;function Kd(n,{width:t,height:r},l,u){if(u){if(u instanceof Uint8ClampedArray)u=new Uint8Array(u.buffer);else if(u.length!==t*r*l)throw new RangeError("mismatched image size")}else u=new Uint8Array(t*r*l);return n.width=t,n.height=r,n.data=u,n}function I_(n,t,r){const{width:l,height:u}=t;l===n.width&&u===n.height||(Dg(n,t,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,l),height:Math.min(n.height,u)},r,null),n.width=l,n.height=u,n.data=t.data)}function Dg(n,t,r,l,u,m,_,b){if(u.width===0||u.height===0)return t;if(u.width>n.width||u.height>n.height||r.x>n.width-u.width||r.y>n.height-u.height)throw new RangeError("out of range source coordinates for image copy");if(u.width>t.width||u.height>t.height||l.x>t.width-u.width||l.y>t.height-u.height)throw new RangeError("out of range destination coordinates for image copy");const E=n.data,P=t.data,R=m===4&&b;for(let F=0;F<u.height;F++){const O=((r.y+F)*n.width+r.x)*m,$=((l.y+F)*t.width+l.x)*m;if(R)for(let q=0;q<u.width;q++){const Y=O+q*m+3,rt=$+q*m;P[rt+0]=255,P[rt+1]=255,P[rt+2]=255,P[rt+3]=E[Y]}else if(_)for(let q=0;q<u.width;q++){const Y=O+q*m,rt=$+q*m,at=new Dr(E[Y+0]/255,E[Y+1]/255,E[Y+2]/255,E[Y+3]).toNonPremultipliedRenderColor(_).toArray();P[rt+0]=at[0],P[rt+1]=at[1],P[rt+2]=at[2],P[rt+3]=at[3]}else for(let q=0;q<u.width*m;q++)P[$+q]=E[O+q]}return t}Si(Oy,"HeatmapBucket",{omit:["layers"]});class Qd{constructor(t,r){Kd(this,t,1,r)}resize(t){I_(this,new Qd(t),1)}clone(){return new Qd({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,l,u,m){Dg(t,r,l,u,m,1,null)}}class Ta{constructor(t,r){Kd(this,t,4,r)}resize(t){I_(this,new Ta(t),4)}replace(t,r){r?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new Ta({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,l,u,m,_,b){Dg(t,r,l,u,m,4,_,b)}}class E_{constructor(t,r){this.width=t.width,this.height=t.height,this.data=r instanceof Uint8Array?new Float32Array(r.buffer):r}}function nm(n){const t={},r=n.resolution||256,l=n.clips?n.clips.length:1,u=n.image||new Ta({width:r,height:l}),m=(_,b,E)=>{t[n.evaluationKey]=E;const P=n.expression.evaluate(t),R=P?P.toNonPremultipliedRenderColor(null):null;R&&(u.data[_+b+0]=Math.floor(255*R.r),u.data[_+b+1]=Math.floor(255*R.g),u.data[_+b+2]=Math.floor(255*R.b),u.data[_+b+3]=Math.floor(255*R.a))};if(n.clips)for(let _=0,b=0;_<l;++_,b+=4*r)for(let E=0,P=0;E<r;E++,P+=4){const R=E/(r-1),{start:F,end:O}=n.clips[_];m(b,P,F*(1-R)+O*R)}else for(let _=0,b=0;_<r;_++,b+=4)m(0,b,_/(r-1));return u}Si(Qd,"AlphaImage"),Si(Ta,"RGBAImage");const zg=vr([{name:"a_pos",components:2,type:"Int16"}],4),jy=vr([{name:"a_road_z_offset",components:1,type:"Float32"}],4),qm=vr([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),Gy=vr([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function jp(n,t,r=2){const l=t&&t.length,u=l?t[0]*r:n.length;let m=A_(n,0,u,r,!0);const _=[];if(!m||m.next===m.prev)return _;let b,E,P;if(l&&(m=function(R,F,O,$){const q=[];for(let Y=0,rt=F.length;Y<rt;Y++){const at=A_(R,F[Y]*$,Y<rt-1?F[Y+1]*$:R.length,$,!1);at===at.next&&(at.steiner=!0),q.push(P_(at))}q.sort(Zy);for(let Y=0;Y<q.length;Y++)O=om(q[Y],O);return O}(n,t,m,r)),n.length>80*r){b=n[0],E=n[1];let R=b,F=E;for(let O=r;O<u;O+=r){const $=n[O],q=n[O+1];$<b&&(b=$),q<E&&(E=q),$>R&&(R=$),q>F&&(F=q)}P=Math.max(R-b,F-E),P=P!==0?32767/P:0}return _d(m,_,r,b,E,P,0),_}function A_(n,t,r,l,u){let m;if(u===function(_,b,E,P){let R=0;for(let F=b,O=E-P;F<E;F+=P)R+=(_[O]-_[F])*(_[F+1]+_[O+1]),O=F;return R}(n,t,r,l)>0)for(let _=t;_<r;_+=l)m=Tc(_/l|0,n[_],n[_+1],m);else for(let _=r-l;_>=t;_-=l)m=Tc(_/l|0,n[_],n[_+1],m);return m&&sm(m,m.next)&&(Ns(m),m=m.next),m}function Xa(n,t){if(!n)return n;t||(t=n);let r,l=n;do if(r=!1,l.steiner||!sm(l,l.next)&&Hs(l.prev,l,l.next)!==0)l=l.next;else{if(Ns(l),l=t=l.prev,l===l.next)break;r=!0}while(r||l!==t);return t}function _d(n,t,r,l,u,m,_){if(!n)return;!_&&m&&function(E,P,R,F){let O=E;do O.z===0&&(O.z=Hm(O.x,O.y,P,R,F)),O.prevZ=O.prev,O.nextZ=O.next,O=O.next;while(O!==E);O.prevZ.nextZ=null,O.prevZ=null,function($){let q,Y=1;do{let rt,at=$;$=null;let gt=null;for(q=0;at;){q++;let yt=at,Pt=0;for(let Bt=0;Bt<Y&&(Pt++,yt=yt.nextZ,yt);Bt++);let qt=Y;for(;Pt>0||qt>0&&yt;)Pt!==0&&(qt===0||!yt||at.z<=yt.z)?(rt=at,at=at.nextZ,Pt--):(rt=yt,yt=yt.nextZ,qt--),gt?gt.nextZ=rt:$=rt,rt.prevZ=gt,gt=rt;at=yt}gt.nextZ=null,Y*=2}while(q>1)}(O)}(n,l,u,m);let b=n;for(;n.prev!==n.next;){const E=n.prev,P=n.next;if(m?rx(n,l,u,m):Zm(n))t.push(E.i,n.i,P.i),Ns(n),n=P.next,b=P.next;else if((n=P)===b){_?_===1?_d(n=$y(Xa(n),t),t,r,l,u,m,2):_===2&&qy(n,t,r,l,u,m):_d(Xa(n),t,r,l,u,m,1);break}}}function Zm(n){const t=n.prev,r=n,l=n.next;if(Hs(t,r,l)>=0)return!1;const u=t.x,m=r.x,_=l.x,b=t.y,E=r.y,P=l.y,R=Math.min(u,m,_),F=Math.min(b,E,P),O=Math.max(u,m,_),$=Math.max(b,E,P);let q=l.next;for(;q!==t;){if(q.x>=R&&q.x<=O&&q.y>=F&&q.y<=$&&If(u,b,m,E,_,P,q.x,q.y)&&Hs(q.prev,q,q.next)>=0)return!1;q=q.next}return!0}function rx(n,t,r,l){const u=n.prev,m=n,_=n.next;if(Hs(u,m,_)>=0)return!1;const b=u.x,E=m.x,P=_.x,R=u.y,F=m.y,O=_.y,$=Math.min(b,E,P),q=Math.min(R,F,O),Y=Math.max(b,E,P),rt=Math.max(R,F,O),at=Hm($,q,t,r,l),gt=Hm(Y,rt,t,r,l);let yt=n.prevZ,Pt=n.nextZ;for(;yt&&yt.z>=at&&Pt&&Pt.z<=gt;){if(yt.x>=$&&yt.x<=Y&&yt.y>=q&&yt.y<=rt&&yt!==u&&yt!==_&&If(b,R,E,F,P,O,yt.x,yt.y)&&Hs(yt.prev,yt,yt.next)>=0||(yt=yt.prevZ,Pt.x>=$&&Pt.x<=Y&&Pt.y>=q&&Pt.y<=rt&&Pt!==u&&Pt!==_&&If(b,R,E,F,P,O,Pt.x,Pt.y)&&Hs(Pt.prev,Pt,Pt.next)>=0))return!1;Pt=Pt.nextZ}for(;yt&&yt.z>=at;){if(yt.x>=$&&yt.x<=Y&&yt.y>=q&&yt.y<=rt&&yt!==u&&yt!==_&&If(b,R,E,F,P,O,yt.x,yt.y)&&Hs(yt.prev,yt,yt.next)>=0)return!1;yt=yt.prevZ}for(;Pt&&Pt.z<=gt;){if(Pt.x>=$&&Pt.x<=Y&&Pt.y>=q&&Pt.y<=rt&&Pt!==u&&Pt!==_&&If(b,R,E,F,P,O,Pt.x,Pt.y)&&Hs(Pt.prev,Pt,Pt.next)>=0)return!1;Pt=Pt.nextZ}return!0}function $y(n,t){let r=n;do{const l=r.prev,u=r.next.next;!sm(l,u)&&Ya(l,r,r.next,u)&&wc(l,u)&&wc(u,l)&&(t.push(l.i,r.i,u.i),Ns(r),Ns(r.next),r=n=u),r=r.next}while(r!==n);return Xa(r)}function qy(n,t,r,l,u,m){let _=n;do{let b=_.next.next;for(;b!==_.prev;){if(_.i!==b.i&&C_(_,b)){let E=Gp(_,b);return _=Xa(_,_.next),E=Xa(E,E.next),_d(_,t,r,l,u,m,0),void _d(E,t,r,l,u,m,0)}b=b.next}_=_.next}while(_!==n)}function Zy(n,t){let r=n.x-t.x;return r===0&&(r=n.y-t.y,r===0)&&(r=(n.next.y-n.y)/(n.next.x-n.x)-(t.next.y-t.y)/(t.next.x-t.x)),r}function om(n,t){const r=function(u,m){let _=m;const b=u.x,E=u.y;let P,R=-1/0;if(sm(u,_))return _;do{if(sm(u,_.next))return _.next;if(E<=_.y&&E>=_.next.y&&_.next.y!==_.y){const Y=_.x+(E-_.y)*(_.next.x-_.x)/(_.next.y-_.y);if(Y<=b&&Y>R&&(R=Y,P=_.x<_.next.x?_:_.next,Y===b))return P}_=_.next}while(_!==m);if(!P)return null;const F=P,O=P.x,$=P.y;let q=1/0;_=P;do{if(b>=_.x&&_.x>=O&&b!==_.x&&M_(E<$?b:R,E,O,$,E<$?R:b,E,_.x,_.y)){const Y=Math.abs(E-_.y)/(b-_.x);wc(_,u)&&(Y<q||Y===q&&(_.x>P.x||_.x===P.x&&Lg(P,_)))&&(P=_,q=Y)}_=_.next}while(_!==F);return P}(n,t);if(!r)return t;const l=Gp(r,n);return Xa(l,l.next),Xa(r,r.next)}function Lg(n,t){return Hs(n.prev,n,t.prev)<0&&Hs(t.next,n,n.next)<0}function Hm(n,t,r,l,u){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*u|0)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-l)*u|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function P_(n){let t=n,r=n;do(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next;while(t!==n);return r}function M_(n,t,r,l,u,m,_,b){return(u-_)*(t-b)>=(n-_)*(m-b)&&(n-_)*(l-b)>=(r-_)*(t-b)&&(r-_)*(m-b)>=(u-_)*(l-b)}function If(n,t,r,l,u,m,_,b){return!(n===_&&t===b)&&M_(n,t,r,l,u,m,_,b)}function C_(n,t){return n.next.i!==t.i&&n.prev.i!==t.i&&!function(r,l){let u=r;do{if(u.i!==r.i&&u.next.i!==r.i&&u.i!==l.i&&u.next.i!==l.i&&Ya(u,u.next,r,l))return!0;u=u.next}while(u!==r);return!1}(n,t)&&(wc(n,t)&&wc(t,n)&&function(r,l){let u=r,m=!1;const _=(r.x+l.x)/2,b=(r.y+l.y)/2;do u.y>b!=u.next.y>b&&u.next.y!==u.y&&_<(u.next.x-u.x)*(b-u.y)/(u.next.y-u.y)+u.x&&(m=!m),u=u.next;while(u!==r);return m}(n,t)&&(Hs(n.prev,n,t.prev)||Hs(n,t.prev,t))||sm(n,t)&&Hs(n.prev,n,n.next)>0&&Hs(t.prev,t,t.next)>0)}function Hs(n,t,r){return(t.y-n.y)*(r.x-t.x)-(t.x-n.x)*(r.y-t.y)}function sm(n,t){return n.x===t.x&&n.y===t.y}function Ya(n,t,r,l){const u=tu(Hs(n,t,r)),m=tu(Hs(n,t,l)),_=tu(Hs(r,l,n)),b=tu(Hs(r,l,t));return u!==m&&_!==b||!(u!==0||!An(n,r,t))||!(m!==0||!An(n,l,t))||!(_!==0||!An(r,n,l))||!(b!==0||!An(r,t,l))}function An(n,t,r){return t.x<=Math.max(n.x,r.x)&&t.x>=Math.min(n.x,r.x)&&t.y<=Math.max(n.y,r.y)&&t.y>=Math.min(n.y,r.y)}function tu(n){return n>0?1:n<0?-1:0}function wc(n,t){return Hs(n.prev,n,n.next)<0?Hs(n,t,n.next)>=0&&Hs(n,n.prev,t)>=0:Hs(n,t,n.prev)<0||Hs(n,n.next,t)<0}function Gp(n,t){const r=da(n.i,n.x,n.y),l=da(t.i,t.x,t.y),u=n.next,m=t.prev;return n.next=t,t.prev=n,r.next=u,u.prev=r,l.next=r,r.prev=l,m.next=l,l.prev=m,l}function Tc(n,t,r,l){const u=da(n,t,r);return l?(u.next=l.next,u.prev=l,l.next.prev=u,l.next=u):(u.prev=u,u.next=u),u}function Ns(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function da(n,t,r){return{i:n,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function am(n,t){const r=n.length;if(r<=1)return[n];const l=[];let u,m;for(let _=0;_<r;_++){const b=Yi(n[_]);b!==0&&(n[_].area=Math.abs(b),m===void 0&&(m=b<0),m===b<0?(u&&l.push(u),u=[n[_]]):u.push(n[_]))}if(u&&l.push(u),t>1)for(let _=0;_<l.length;_++)l[_].length<=t||(sa(l[_],t,1,l[_].length-1,gh),l[_]=l[_].slice(0,t));return l}function gh(n,t){return t.area-n.area}function Rg(n,t,r=1){if(!n)return null;const l=typeof n=="string"?za.from(n).getPrimary():n.getPrimary(),u=typeof n=="string"?null:n.getSecondary();for(const m of[l,u]){if(!m)continue;const _=m.id.toString();t.has(_)||t.set(_,[]),m.scaleSelf(r),t.get(_).push(m)}return{primary:l.toString(),secondary:u?u.toString():null}}function Ws(n,t,r,l){const u=l.patternDependencies;let m=!1;for(const _ of t){const b=_.paint.get(`${n}-pattern`);b.isConstant()||(m=!0),Rg(b.constantOr(null),u,r)&&(m=!0)}return m}function lm(n,t,r,l,u,m){const _=m.patternDependencies;for(const b of t){const E=b.paint.get(`${n}-pattern`).value;if(E.kind!=="constant"){let P=E.evaluate({zoom:l},r,{},m.availableImages);P=P&&P.name?P.name:P;const R=Rg(P,_,u);if(!R)continue;const{primary:F,secondary:O}=R;F&&(r.patterns[b.id]=[F,O].filter(Boolean))}}return r}class Hy{constructor(){this.polygons=new Map}add(t,...r){const l=this.polygons.get(t);l?l.push(...r):this.polygons.set(t,r)}merge(t){for(const[r,l]of t.polygons)this.add(r,...l)}}class yd{constructor(){this.portals=[]}static isOnBorder(t,r){return t<=0&&r<=0||t>=ri&&r>=ri}static evaluate(t){if(t.length===0)return new yd;let r=[];for(const E of t)r.push(...E.portals);if(r.length===0)return new yd;for(const E of r){const P=E.va,R=E.vb;(yd.isOnBorder(P.x,R.x)||yd.isOnBorder(P.y,R.y))&&(E.type="border")}const l=r.filter(E=>E.type!=="unevaluated"),u=r.filter(E=>E.type==="unevaluated");if(u.length===0)return new yd;u.sort((E,P)=>E.hash===P.hash?E.isTunnel===P.isTunnel?0:E.isTunnel?-1:1:E.hash<P.hash?1:-1),r=l.concat(u);let m=l.length,_=m,b=m;do if(_++,_===r.length||r[m].hash!==r[_].hash){if(_-m==2){b<m&&(r[b]=r[m],r[m]=null);const E=r[b],P=r[_-1];E.type=E.isTunnel!==P.isTunnel?"tunnel":"polygon",E.connection={a:E.connection.a,b:P.connection.a},b++}m=_}while(m!==r.length);return r.splice(b),r.sort((E,P)=>E.hash<P.hash?1:-1),{portals:r}}}Si(yd,"ElevationPortalGraph"),Si(Hy,"ElevationPolygons");class Ef{constructor(t,r,l){this.outPositions=t,this.outNormals=r,this.outIndices=l,this.vertexLookup=new Map}addVertex(t,r,l){let u=t[2];l!=null&&(u*=l);const m=`${t[0]},${t[1]},${t[2]},${r[0]},${r[1]},${r[2]}`,_=this.vertexLookup.get(m);if(_!=null)return _;const b=this.outPositions.length;this.vertexLookup.set(m,b);const E=Math.trunc(16384*r[0]),P=Math.trunc(16384*r[1]),R=Math.trunc(16384*r[2]);return this.outPositions.emplaceBack(t[0],t[1],u),this.outNormals.emplaceBack(E,P,R),b}addTriangle(t,r,l){this.outIndices.emplaceBack(t,r,l)}addTriangles(t,r,l){if(t.length===0)return;const u=l.length===1,m=Zr(),_=Zr();for(let b=0;b<t.length;b+=3){const E=r[t[b+0]],P=r[t[b+1]],R=r[t[b+2]],F=u?l[0]:l[t[b+1]],O=u?l[0]:l[t[b+2]];dn(m,E.x,E.y,u?l[0]:l[t[b+0]]);const $=this.addVertex(m,_);dn(m,P.x,P.y,F);const q=this.addVertex(m,_);dn(m,R.x,R.y,O);const Y=this.addVertex(m,_);this.outIndices.emplaceBack($,q,Y)}}addQuad(t,r,l,u,m,_){const b=this.addVertex(t,m,_),E=this.addVertex(r,m,_),P=this.addVertex(l,m,_),R=this.addVertex(u,m,_);this.addTriangle(b,E,P),this.addTriangle(P,R,b)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class Ba{constructor(t,r,l,u){this.unevaluatedPortals=new yd,this.portalPolygons=new Hy,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new mc,this.vertexNormals=new Wa,this.indexArray=new qn,this.tileToMeters=Ht(t),this.bridgeProgramConfigurations=new mh(r,{zoom:l,lut:u},m=>m!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new mh(r,{zoom:l,lut:u},m=>m!=="fill-bridge-guard-rail-color")}addVertices(t,r){const l=this.unevalVertices.length;for(let u=0;u<t.length;u++)this.unevalVertices.push(t[u]),this.unevalHeights.push(r[u]);return l}addTriangles(t,r,l){const u=l?this.unevalTunnelTriangles:this.unevalTriangles;for(const m of t)u.push(m+r)}addRenderableRing(t,r,l,u,m,_){const b=[new Ae(m.min.x,m.min.y),new Ae(m.max.x,m.min.y),new Ae(m.max.x,m.max.y),new Ae(m.min.x,m.max.y)];for(let E=0;E<l-1;E++){const P=r+E,R=P+1,F=this.unevalVertices[P],O=this.unevalVertices[R];if(!(F.x>=m.min.x&&F.x<=m.max.x&&F.y>=m.min.y&&F.y<=m.max.y||O.x>=m.min.x&&O.x<=m.max.x&&O.y>=m.min.y&&O.y<=m.max.y||ko(F,O,b))||this.isOnBorder(F.x,O.x)||this.isOnBorder(F.y,O.y))continue;const $=Ba.computeEdgeHash(this.unevalVertices[P],this.unevalVertices[R]);let q,Y=this.vertexHashLookup.get(Ba.computePosHash(F));Y!=null?q=Y.next:(Y=this.vertexHashLookup.get(Ba.computePosHash(O)),q=Y!=null?Y.prev:$),this.unevalEdges.push({polygonIdx:t,a:P,b:R,hash:$,portalHash:q,isTunnel:u,type:"unevaluated",featureInfo:_})}}addPortalCandidates(t,r,l,u,m){if(r.length===0)return;this.portalPolygons.add(t,{geometry:r,zLevel:m});const _=r[0];this.vertexHashLookup.clear();let b=Ba.computeEdgeHash(_[_.length-2],_[_.length-1]);for(let E=0;E<_.length-1;E++){const P=_[E+0],R=_[E+1],F=we(R.x-P.x,R.y-P.y),O=le(F);if(O===0)continue;let $="unevaluated";const q=u.pointElevation(P),Y=u.pointElevation(R);Math.abs(q)<.01&&Math.abs(Y)<.01?$="entrance":(this.isOnBorder(P.x,R.x)||this.isOnBorder(P.y,R.y))&&($="border");const rt=Ba.computeEdgeHash(P,R);this.unevaluatedPortals.portals.push({connection:{a:t,b:void 0},va:P,vb:R,vab:F,length:O,hash:rt,isTunnel:l,type:$});const at=Ba.computePosHash(P);this.vertexHashLookup.set(at,{prev:b,next:rt}),b=rt}}construct(t){if(this.unevalVertices.length===0)return;const r=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),l=O=>{O.primitiveLength=this.indexArray.length-O.primitiveOffset},u=new Ef(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(t.portals,this.unevalEdges);const m=r(),_=r(),b=r(),E=(O,$)=>{O.sort((Y,rt)=>Y.type===$&&rt.type!==$?-1:Y.type!==$&&rt.type===$?1:0);const q=O.findIndex(Y=>Y.type!==$);return q>=0?q:O.length};let P=0;this.unevalEdges.length>0&&(P=E(this.unevalEdges,"none"),this.constructBridgeStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:P},this.tileToMeters)),l(b);const R=r(),F=r();if(this.unevalEdges.length>0){const O=this.unevalEdges.splice(P),$=E(O,"tunnel")+P;this.unevalEdges.push(...O),this.constructTunnelStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:P},{min:P,max:$})}l(R),u.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),l(F),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),l(_),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),l(m),this.maskSegments=po.simpleSegment(0,F.primitiveOffset,0,F.primitiveLength),this.depthSegments=po.simpleSegment(0,_.primitiveOffset,0,_.primitiveLength),this.renderableBridgeSegments=po.simpleSegment(0,b.primitiveOffset,0,b.primitiveLength),this.renderableTunnelSegments=po.simpleSegment(0,R.primitiveOffset,0,R.primitiveLength),this.shadowCasterSegments=po.simpleSegment(0,m.primitiveOffset,0,m.primitiveLength)}update(t,r,l,u,m,_,b,E){this.bridgeProgramConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E),this.tunnelProgramConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E)}upload(t){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=t.createVertexBuffer(this.vertexPositions,qm.members),this.vertexBufferNormal=t.createVertexBuffer(this.vertexNormals,Gy.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(t),this.tunnelProgramConfigurations.upload(t))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(t,r,l,u,m){const _=(b,E)=>{for(let P=0;P<E.length-1;P++){const R=E[P].featureIndex,F=E[P+1].vertexStart,O=t.feature(R);b.populatePaintArrays(F,O,R,{},l,r,u,void 0,m)}};_(this.bridgeProgramConfigurations,this.bridgeFeatureSections),_(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(t,r,l,u,m){const _=new Map;for(let b=u;b<m;b++){const E=l[b],P=E.a,R=E.b,F=Ba.computePosHash(t[P]),O=Ba.computePosHash(t[R]);let $=_.get(F);$||($={},_.set(F,$));let q=_.get(O);q||(q={},_.set(O,q)),r[P]<=0&&r[R]<=0||($.to=R,q.from=P)}return _}isTerminalVertex(t,r){const l=Ba.computePosHash(this.unevalVertices[t]),u=r.get(l);return!u||!u.from||!u.to}constructBridgeStructures(t,r,l,u,m,_){t.clearVertexLookup();const b=this.computeVertexConnections(r,l,u,m.min,m.max),E=1/_,P=.5*E,R=(hi,Ke)=>dn(hi,r[Ke].x,r[Ke].y,l[Ke]*E),F=Zr(),O=Zr(),$=Zr(),q=Zr(),Y=Zr(),rt=(hi,Ke)=>{const je=b.get(Ba.computePosHash(r[Ke])),Ye=je.from,Me=je.to;if(!Ye||!Me)return;R(F,Ye),R(O,Ke),R($,Me),Ds(q),lo(F,O)||(Zn(Y,O,F),bn(q,Y)),lo($,O)||(Zn(Y,$,O),Fo(q,q,bn(Y,Y)));const Ie=jl(q);return Ie>0?Jn(hi,q,1/Ie):void 0};let at=Number.POSITIVE_INFINITY;this.sortSubarray(u,m.min,m.max,(hi,Ke)=>hi.featureInfo.featureIndex-Ke.featureInfo.featureIndex);const gt=Zr(),yt=Zr(),Pt=Zr(),qt=Zr(),Bt=Zr(),Yt=Zr(),ee=Zr(),ne=Zr(),Le=Zr(),fe=[Zr(),Zr(),Zr(),Zr()],ke=[Zr(),Zr(),Zr(),Zr()],Ue=[{coord:new Ae(0,0),height:0},{coord:new Ae(0,0),height:0}],Ze=(hi,Ke)=>hi>Ke;for(let hi=m.min;hi<m.max;hi++){const Ke=u[hi];if(!Ke.featureInfo.guardRailEnabled||!this.prepareEdgePoints(Ue,r,l,Ke,Ze))continue;const[je,Ye]=Ue;if(dn(gt,je.coord.x,je.coord.y,E*je.height),dn(yt,Ye.coord.x,Ye.coord.y,E*Ye.height),lo(gt,yt))continue;Zn(Pt,yt,gt),bn(Pt,Pt);const Me=rt(ne,Ke.a)||Pt,Ie=rt(Le,Ke.b)||Pt;dn(qt,Me[1],-Me[0],0),bn(qt,qt),dn(Bt,Ie[1],-Ie[0],0),bn(Bt,Bt),qo(ne,qt,Me),bn(Yt,ne),qo(ne,Bt,Ie),bn(ee,ne),Fo(fe[0],gt,Jn(ne,Zn(ne,qt,Yt),P)),Fo(fe[1],gt,Jn(ne,Fo(ne,qt,Yt),P)),Fo(fe[2],gt,Jn(ne,Yt,P)),fe[3]=gt,Fo(ke[0],yt,Jn(ne,Zn(ne,Bt,ee),P)),Fo(ke[1],yt,Jn(ne,Fo(ne,Bt,ee),P)),Fo(ke[2],yt,Jn(ne,ee,P)),ke[3]=yt,at=this.addFeatureSection(Ke.featureInfo.featureIndex,at,this.bridgeFeatureSections,t);const He=t.addVertex(fe[0],qt,_),ai=t.addVertex(fe[1],qt,_),Ge=t.addVertex(ke[0],Bt,_),Pi=t.addVertex(ke[1],Bt,_);t.addTriangle(He,ai,Ge),t.addTriangle(ai,Pi,Ge);const ki=t.addVertex(fe[1],Yt,_),vi=t.addVertex(fe[2],Yt,_),pi=t.addVertex(ke[1],ee,_),dr=t.addVertex(ke[2],ee,_);t.addTriangle(ki,vi,pi),t.addTriangle(vi,dr,pi),Wo(qt,qt),Wo(Bt,Bt);const _i=t.addVertex(fe[2],qt,_),Wi=t.addVertex(fe[3],qt,_),mr=t.addVertex(ke[2],Bt,_),Lr=t.addVertex(ke[3],Bt,_);t.addTriangle(_i,Wi,mr),t.addTriangle(Wi,Lr,mr);const rn=this.isTerminalVertex(Ke.a,b),_r=this.isTerminalVertex(Ke.b,b);je.height<.01&&rn&&t.addQuad(fe[3],fe[2],fe[1],fe[0],Wo(Me,Me),_),Ye.height<.01&&_r&&t.addQuad(ke[0],ke[1],ke[2],ke[3],Ie,_)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:t.getVertexCount()})}constructTunnelStructures(t,r,l,u,m,_){t.clearVertexLookup();let b=Number.POSITIVE_INFINITY;const E=(at,gt)=>at.featureInfo.featureIndex-gt.featureInfo.featureIndex;this.sortSubarray(u,m.min,m.max,E),this.sortSubarray(u,_.min,_.max,E);const P=at=>bn(at,at),R=[{coord:new Ae(0,0),height:0},{coord:new Ae(0,0),height:0}],F=(at,gt)=>at<gt,O=Zr(),$=Zr(),q=Zr(),Y=Zr(),rt=Zr();for(let at=m.min;at<m.max;at++){if(!this.prepareEdgePoints(R,r,l,u[at],F))continue;const[gt,yt]=R,Pt=P(dn(rt,-(yt.coord.y-gt.coord.y),yt.coord.x-gt.coord.x,0));b=this.addFeatureSection(u[at].featureInfo.featureIndex,b,this.tunnelFeatureSections,t),t.addQuad(dn(O,gt.coord.x,gt.coord.y,gt.height),dn($,yt.coord.x,yt.coord.y,yt.height),dn(q,yt.coord.x,yt.coord.y,u[at].isTunnel?-.1:0),dn(Y,gt.coord.x,gt.coord.y,u[at].isTunnel?-.1:0),Pt)}for(let at=_.min;at<_.max;at++){const gt=u[at];gt.isTunnel&&([gt.a,gt.b]=[gt.b,gt.a]);const yt=r[gt.a],Pt=r[gt.b],qt=P(dn(rt,-(Pt.y-yt.y),Pt.x-yt.x,0));b=this.addFeatureSection(gt.featureInfo.featureIndex,b,this.tunnelFeatureSections,t),t.addQuad(dn(O,Pt.x,Pt.y,0),dn($,yt.x,yt.y,0),dn(q,yt.x,yt.y,l[gt.a]+4),dn(Y,Pt.x,Pt.y,l[gt.b]+4),qt),t.addQuad(dn(O,yt.x,yt.y,0),dn($,Pt.x,Pt.y,0),dn(q,Pt.x,Pt.y,l[gt.b]+4),dn(Y,yt.x,yt.y,l[gt.a]+4),qt)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:t.getVertexCount()})}setElevatedPoint(t,r,l,u){t.coord.x=r,t.coord.y=l,t.height=u}prepareEdgePoints(t,r,l,u,m){let _=r[u.a].x,b=r[u.a].y,E=r[u.b].x,P=r[u.b].y,R=l[u.a],F=l[u.b];const O=m(R,0),$=m(F,0);if(O&&$)return this.setElevatedPoint(t[0],_,b,R),this.setElevatedPoint(t[1],E,P,F),!0;if(!O&&!$)return!1;if(O){if(!$){const q=F/(F-R);E=Vi(E,_,q),P=Vi(P,b,q),F=Vi(F,R,q)}}else{const q=R/(R-F);_=Vi(_,E,q),b=Vi(b,P,q),R=Vi(R,F,q)}return this.setElevatedPoint(t[0],_,b,R),this.setElevatedPoint(t[1],E,P,F),!0}prepareEdges(t,r){if(r.length===0)return;r.sort((b,E)=>b.hash===E.hash?E.polygonIdx-b.polygonIdx:E.hash>b.hash?1:-1);let l=0,u=0,m=0,_=r[l].polygonIdx;do u++,(u===r.length||r[l].hash!==r[u].hash)&&((u-l==1||r[u-1].polygonIdx!==_)&&(m<l&&(r[m]=r[l],r[l]=null),r[m].type="none",m++),l=u,l!==r.length&&(_=r[l].polygonIdx));while(l!==r.length);if(r.splice(m),r.length!==0&&t.length!==0){r.sort((P,R)=>P.portalHash<R.portalHash?1:-1);let b=0,E=0;for(;b!==r.length&&E!==t.length;){const P=r[b],R=t[E];P.portalHash>R.hash?b++:R.hash>P.portalHash?E++:(P.type=R.type,b++)}}}isOnBorder(t,r){return t<=0&&r<=0||t>=ri&&r>=ri}addFeatureSection(t,r,l,u){return t!==r&&(r=t,l.push({featureIndex:t,vertexStart:u.getVertexCount()}),u.clearVertexLookup()),r}sortSubarray(t,r,l,u){const m=t.slice(r,l);m.sort(u),t.splice(r,m.length,...m)}static computeEdgeHash(t,r){return(t.y===r.y&&t.x>r.x||t.y>r.y)&&([t,r]=[r,t]),BigInt(Ba.computePosHash(t))<<32n|BigInt(Ba.computePosHash(r))}static computePosHash(t){return((65535&t.x)<<16|65535&t.y)>>>0}}var Wy,D_={exports:{}},z_=(Wy||(Wy=1,function(n,t){(function(r){function l(Ot,Rt){return Ot>Rt?1:Ot<Rt?-1:0}var u=function(Ot,Rt){Ot===void 0&&(Ot=l),Rt===void 0&&(Rt=!1),this._compare=Ot,this._root=null,this._size=0,this._noDuplicates=!!Rt},m={size:{configurable:!0}};function _(Ot,Rt,Oe,di,Ne){var fi=Ne-di;if(fi>0){var Gi=di+Math.floor(fi/2),Ni={key:Rt[Gi],data:Oe[Gi],parent:Ot};return Ni.left=_(Ni,Rt,Oe,di,Gi),Ni.right=_(Ni,Rt,Oe,Gi+1,Ne),Ni}return null}function b(Ot,Rt,Oe,di,Ne){if(!(Oe>=di)){for(var fi=Ot[Oe+di>>1],Gi=Oe-1,Ni=di+1;;){do Gi++;while(Ne(Ot[Gi],fi)<0);do Ni--;while(Ne(Ot[Ni],fi)>0);if(Gi>=Ni)break;var Tr=Ot[Gi];Ot[Gi]=Ot[Ni],Ot[Ni]=Tr,Tr=Rt[Gi],Rt[Gi]=Rt[Ni],Rt[Ni]=Tr}b(Ot,Rt,Oe,Ni,Ne),b(Ot,Rt,Ni+1,di,Ne)}}u.prototype.rotateLeft=function(Ot){var Rt=Ot.right;Rt&&(Ot.right=Rt.left,Rt.left&&(Rt.left.parent=Ot),Rt.parent=Ot.parent),Ot.parent?Ot===Ot.parent.left?Ot.parent.left=Rt:Ot.parent.right=Rt:this._root=Rt,Rt&&(Rt.left=Ot),Ot.parent=Rt},u.prototype.rotateRight=function(Ot){var Rt=Ot.left;Rt&&(Ot.left=Rt.right,Rt.right&&(Rt.right.parent=Ot),Rt.parent=Ot.parent),Ot.parent?Ot===Ot.parent.left?Ot.parent.left=Rt:Ot.parent.right=Rt:this._root=Rt,Rt&&(Rt.right=Ot),Ot.parent=Rt},u.prototype._splay=function(Ot){for(;Ot.parent;){var Rt=Ot.parent;Rt.parent?Rt.left===Ot&&Rt.parent.left===Rt?(this.rotateRight(Rt.parent),this.rotateRight(Rt)):Rt.right===Ot&&Rt.parent.right===Rt?(this.rotateLeft(Rt.parent),this.rotateLeft(Rt)):Rt.left===Ot&&Rt.parent.right===Rt?(this.rotateRight(Rt),this.rotateLeft(Rt)):(this.rotateLeft(Rt),this.rotateRight(Rt)):Rt.left===Ot?this.rotateRight(Rt):this.rotateLeft(Rt)}},u.prototype.splay=function(Ot){for(var Rt,Oe,di,Ne,fi;Ot.parent;)(Oe=(Rt=Ot.parent).parent)&&Oe.parent?((di=Oe.parent).left===Oe?di.left=Ot:di.right=Ot,Ot.parent=di):(Ot.parent=null,this._root=Ot),Ne=Ot.left,fi=Ot.right,Ot===Rt.left?(Oe&&(Oe.left===Rt?(Rt.right?(Oe.left=Rt.right,Oe.left.parent=Oe):Oe.left=null,Rt.right=Oe,Oe.parent=Rt):(Ne?(Oe.right=Ne,Ne.parent=Oe):Oe.right=null,Ot.left=Oe,Oe.parent=Ot)),fi?(Rt.left=fi,fi.parent=Rt):Rt.left=null,Ot.right=Rt,Rt.parent=Ot):(Oe&&(Oe.right===Rt?(Rt.left?(Oe.right=Rt.left,Oe.right.parent=Oe):Oe.right=null,Rt.left=Oe,Oe.parent=Rt):(fi?(Oe.left=fi,fi.parent=Oe):Oe.left=null,Ot.right=Oe,Oe.parent=Ot)),Ne?(Rt.right=Ne,Ne.parent=Rt):Rt.right=null,Ot.left=Rt,Rt.parent=Ot)},u.prototype.replace=function(Ot,Rt){Ot.parent?Ot===Ot.parent.left?Ot.parent.left=Rt:Ot.parent.right=Rt:this._root=Rt,Rt&&(Rt.parent=Ot.parent)},u.prototype.minNode=function(Ot){if(Ot===void 0&&(Ot=this._root),Ot)for(;Ot.left;)Ot=Ot.left;return Ot},u.prototype.maxNode=function(Ot){if(Ot===void 0&&(Ot=this._root),Ot)for(;Ot.right;)Ot=Ot.right;return Ot},u.prototype.insert=function(Ot,Rt){var Oe=this._root,di=null,Ne=this._compare;if(this._noDuplicates)for(;Oe;){if(di=Oe,Ne(Oe.key,Ot)===0)return;Oe=Ne(Oe.key,Ot)<0?Oe.right:Oe.left}else for(;Oe;)di=Oe,Oe=Ne(Oe.key,Ot)<0?Oe.right:Oe.left;return Oe={key:Ot,data:Rt,left:null,right:null,parent:di},di?Ne(di.key,Oe.key)<0?di.right=Oe:di.left=Oe:this._root=Oe,this.splay(Oe),this._size++,Oe},u.prototype.find=function(Ot){for(var Rt=this._root,Oe=this._compare;Rt;){var di=Oe(Rt.key,Ot);if(di<0)Rt=Rt.right;else{if(!(di>0))return Rt;Rt=Rt.left}}return null},u.prototype.contains=function(Ot){for(var Rt=this._root,Oe=this._compare;Rt;){var di=Oe(Ot,Rt.key);if(di===0)return!0;Rt=di<0?Rt.left:Rt.right}return!1},u.prototype.remove=function(Ot){var Rt=this.find(Ot);if(!Rt)return!1;if(this.splay(Rt),Rt.left)if(Rt.right){var Oe=this.minNode(Rt.right);Oe.parent!==Rt&&(this.replace(Oe,Oe.right),Oe.right=Rt.right,Oe.right.parent=Oe),this.replace(Rt,Oe),Oe.left=Rt.left,Oe.left.parent=Oe}else this.replace(Rt,Rt.left);else this.replace(Rt,Rt.right);return this._size--,!0},u.prototype.removeNode=function(Ot){if(!Ot)return!1;if(this.splay(Ot),Ot.left)if(Ot.right){var Rt=this.minNode(Ot.right);Rt.parent!==Ot&&(this.replace(Rt,Rt.right),Rt.right=Ot.right,Rt.right.parent=Rt),this.replace(Ot,Rt),Rt.left=Ot.left,Rt.left.parent=Rt}else this.replace(Ot,Ot.left);else this.replace(Ot,Ot.right);return this._size--,!0},u.prototype.erase=function(Ot){var Rt=this.find(Ot);if(Rt){this.splay(Rt);var Oe=Rt.left,di=Rt.right,Ne=null;Oe&&(Oe.parent=null,Ne=this.maxNode(Oe),this.splay(Ne),this._root=Ne),di&&(Oe?Ne.right=di:this._root=di,di.parent=Ne),this._size--}},u.prototype.pop=function(){var Ot=this._root,Rt=null;if(Ot){for(;Ot.left;)Ot=Ot.left;Rt={key:Ot.key,data:Ot.data},this.remove(Ot.key)}return Rt},u.prototype.next=function(Ot){var Rt=Ot;if(Rt)if(Rt.right)for(Rt=Rt.right;Rt&&Rt.left;)Rt=Rt.left;else for(Rt=Ot.parent;Rt&&Rt.right===Ot;)Ot=Rt,Rt=Rt.parent;return Rt},u.prototype.prev=function(Ot){var Rt=Ot;if(Rt)if(Rt.left)for(Rt=Rt.left;Rt&&Rt.right;)Rt=Rt.right;else for(Rt=Ot.parent;Rt&&Rt.left===Ot;)Ot=Rt,Rt=Rt.parent;return Rt},u.prototype.forEach=function(Ot){for(var Rt=this._root,Oe=[],di=!1,Ne=0;!di;)Rt?(Oe.push(Rt),Rt=Rt.left):Oe.length>0?(Ot(Rt=Oe.pop(),Ne++),Rt=Rt.right):di=!0;return this},u.prototype.range=function(Ot,Rt,Oe,di){for(var Ne=[],fi=this._compare,Gi=this._root;Ne.length!==0||Gi;)if(Gi)Ne.push(Gi),Gi=Gi.left;else{if(fi((Gi=Ne.pop()).key,Rt)>0)break;if(fi(Gi.key,Ot)>=0&&Oe.call(di,Gi))return this;Gi=Gi.right}return this},u.prototype.keys=function(){for(var Ot=this._root,Rt=[],Oe=[],di=!1;!di;)Ot?(Rt.push(Ot),Ot=Ot.left):Rt.length>0?(Ot=Rt.pop(),Oe.push(Ot.key),Ot=Ot.right):di=!0;return Oe},u.prototype.values=function(){for(var Ot=this._root,Rt=[],Oe=[],di=!1;!di;)Ot?(Rt.push(Ot),Ot=Ot.left):Rt.length>0?(Ot=Rt.pop(),Oe.push(Ot.data),Ot=Ot.right):di=!0;return Oe},u.prototype.at=function(Ot){for(var Rt=this._root,Oe=[],di=!1,Ne=0;!di;)if(Rt)Oe.push(Rt),Rt=Rt.left;else if(Oe.length>0){if(Rt=Oe.pop(),Ne===Ot)return Rt;Ne++,Rt=Rt.right}else di=!0;return null},u.prototype.load=function(Ot,Rt,Oe){if(Ot===void 0&&(Ot=[]),Rt===void 0&&(Rt=[]),Oe===void 0&&(Oe=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var di=Ot.length;return Oe&&b(Ot,Rt,0,di-1,this._compare),this._root=_(null,Ot,Rt,0,di),this._size=di,this},u.prototype.min=function(){var Ot=this.minNode(this._root);return Ot?Ot.key:null},u.prototype.max=function(){var Ot=this.maxNode(this._root);return Ot?Ot.key:null},u.prototype.isEmpty=function(){return this._root===null},m.size.get=function(){return this._size},u.createTree=function(Ot,Rt,Oe,di,Ne){return new u(Oe,Ne).load(Ot,Rt,di)},Object.defineProperties(u.prototype,m);var E=0,P=1,R=2,F=3,O=0,$=1,q=2,Y=3;function rt(Ot,Rt,Oe){Rt===null?(Ot.inOut=!1,Ot.otherInOut=!0):(Ot.isSubject===Rt.isSubject?(Ot.inOut=!Rt.inOut,Ot.otherInOut=Rt.otherInOut):(Ot.inOut=!Rt.otherInOut,Ot.otherInOut=Rt.isVertical()?!Rt.inOut:Rt.inOut),Rt&&(Ot.prevInResult=!at(Rt,Oe)||Rt.isVertical()?Rt.prevInResult:Rt));var di=at(Ot,Oe);Ot.resultTransition=di?function(Ne,fi){var Gi,Ni=!Ne.inOut,Tr=!Ne.otherInOut;switch(fi){case O:Gi=Ni&&Tr;break;case $:Gi=Ni||Tr;break;case Y:Gi=Ni^Tr;break;case q:Gi=Ne.isSubject?Ni&&!Tr:Tr&&!Ni}return Gi?1:-1}(Ot,Oe):0}function at(Ot,Rt){switch(Ot.type){case E:switch(Rt){case O:return!Ot.otherInOut;case $:return Ot.otherInOut;case q:return Ot.isSubject&&Ot.otherInOut||!Ot.isSubject&&!Ot.otherInOut;case Y:return!0}break;case R:return Rt===O||Rt===$;case F:return Rt===q;case P:return!1}return!1}var gt=function(Ot,Rt,Oe,di,Ne){this.left=Rt,this.point=Ot,this.otherEvent=Oe,this.isSubject=di,this.type=Ne||E,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},yt={inResult:{configurable:!0}};function Pt(Ot,Rt){return Ot[0]===Rt[0]&&Ot[1]===Rt[1]}gt.prototype.isBelow=function(Ot){var Rt=this.point,Oe=this.otherEvent.point;return this.left?(Rt[0]-Ot[0])*(Oe[1]-Ot[1])-(Oe[0]-Ot[0])*(Rt[1]-Ot[1])>0:(Oe[0]-Ot[0])*(Rt[1]-Ot[1])-(Rt[0]-Ot[0])*(Oe[1]-Ot[1])>0},gt.prototype.isAbove=function(Ot){return!this.isBelow(Ot)},gt.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},yt.inResult.get=function(){return this.resultTransition!==0},gt.prototype.clone=function(){var Ot=new gt(this.point,this.left,this.otherEvent,this.isSubject,this.type);return Ot.contourId=this.contourId,Ot.resultTransition=this.resultTransition,Ot.prevInResult=this.prevInResult,Ot.isExteriorRing=this.isExteriorRing,Ot.inOut=this.inOut,Ot.otherInOut=this.otherInOut,Ot},Object.defineProperties(gt.prototype,yt);var qt=11102230246251565e-32,Bt=134217729,Yt=(3+8*qt)*qt;function ee(Ot,Rt,Oe,di,Ne){var fi,Gi,Ni,Tr,er=Rt[0],Bi=di[0],un=0,Nn=0;Bi>er==Bi>-er?(fi=er,er=Rt[++un]):(fi=Bi,Bi=di[++Nn]);var nr=0;if(un<Ot&&Nn<Oe)for(Bi>er==Bi>-er?(Ni=fi-((Gi=er+fi)-er),er=Rt[++un]):(Ni=fi-((Gi=Bi+fi)-Bi),Bi=di[++Nn]),fi=Gi,Ni!==0&&(Ne[nr++]=Ni);un<Ot&&Nn<Oe;)Bi>er==Bi>-er?(Ni=fi-((Gi=fi+er)-(Tr=Gi-fi))+(er-Tr),er=Rt[++un]):(Ni=fi-((Gi=fi+Bi)-(Tr=Gi-fi))+(Bi-Tr),Bi=di[++Nn]),fi=Gi,Ni!==0&&(Ne[nr++]=Ni);for(;un<Ot;)Ni=fi-((Gi=fi+er)-(Tr=Gi-fi))+(er-Tr),er=Rt[++un],fi=Gi,Ni!==0&&(Ne[nr++]=Ni);for(;Nn<Oe;)Ni=fi-((Gi=fi+Bi)-(Tr=Gi-fi))+(Bi-Tr),Bi=di[++Nn],fi=Gi,Ni!==0&&(Ne[nr++]=Ni);return fi===0&&nr!==0||(Ne[nr++]=fi),nr}function ne(Ot){return new Float64Array(Ot)}var Le=33306690738754716e-32,fe=22204460492503146e-32,ke=11093356479670487e-47,Ue=ne(4),Ze=ne(8),hi=ne(12),Ke=ne(16),je=ne(4);function Ye(Ot,Rt,Oe){var di=function(Ne,fi,Gi,Ni,Tr,er){var Bi=(fi-er)*(Gi-Tr),un=(Ne-Tr)*(Ni-er),Nn=Bi-un;if(Bi===0||un===0||Bi>0!=un>0)return Nn;var nr=Math.abs(Bi+un);return Math.abs(Nn)>=Le*nr?Nn:-function(Qr,Vn,In,jo,go,no,zn){var mn,Sr,gn,oo,ir,nn,_o,Ho,rs,Us,yo,Ms,qc,Cs,yh,wl,ku,Zc,xh=Qr-go,Tl=In-go,vh=Vn-no,Fu=jo-no;Ue[0]=(yh=(Ho=xh-(_o=(nn=Bt*xh)-(nn-xh)))*(Us=Fu-(rs=(nn=Bt*Fu)-(nn-Fu)))-((Cs=xh*Fu)-_o*rs-Ho*rs-_o*Us))-((yo=yh-(ku=(Ho=vh-(_o=(nn=Bt*vh)-(nn-vh)))*(Us=Tl-(rs=(nn=Bt*Tl)-(nn-Tl)))-((wl=vh*Tl)-_o*rs-Ho*rs-_o*Us)))+(ir=yh-yo))+(ir-ku),Ue[1]=(qc=Cs-((Ms=Cs+yo)-(ir=Ms-Cs))+(yo-ir))-((yo=qc-wl)+(ir=qc-yo))+(ir-wl),Ue[2]=Ms-((Zc=Ms+yo)-(ir=Zc-Ms))+(yo-ir),Ue[3]=Zc;var Ua=function(Sm,ef){for(var Z0=ef[0],h_=1;h_<4;h_++)Z0+=ef[h_];return Z0}(0,Ue),ic=fe*zn;if(Ua>=ic||-Ua>=ic||(mn=Qr-(xh+(ir=Qr-xh))+(ir-go),gn=In-(Tl+(ir=In-Tl))+(ir-go),Sr=Vn-(vh+(ir=Vn-vh))+(ir-no),oo=jo-(Fu+(ir=jo-Fu))+(ir-no),mn===0&&Sr===0&&gn===0&&oo===0)||(ic=ke*zn+Yt*Math.abs(Ua),(Ua+=xh*oo+Fu*mn-(vh*gn+Tl*Sr))>=ic||-Ua>=ic))return Ua;je[0]=(yh=(Ho=mn-(_o=(nn=Bt*mn)-(nn-mn)))*(Us=Fu-(rs=(nn=Bt*Fu)-(nn-Fu)))-((Cs=mn*Fu)-_o*rs-Ho*rs-_o*Us))-((yo=yh-(ku=(Ho=Sr-(_o=(nn=Bt*Sr)-(nn-Sr)))*(Us=Tl-(rs=(nn=Bt*Tl)-(nn-Tl)))-((wl=Sr*Tl)-_o*rs-Ho*rs-_o*Us)))+(ir=yh-yo))+(ir-ku),je[1]=(qc=Cs-((Ms=Cs+yo)-(ir=Ms-Cs))+(yo-ir))-((yo=qc-wl)+(ir=qc-yo))+(ir-wl),je[2]=Ms-((Zc=Ms+yo)-(ir=Zc-Ms))+(yo-ir),je[3]=Zc;var tf=ee(4,Ue,4,je,Ze);je[0]=(yh=(Ho=xh-(_o=(nn=Bt*xh)-(nn-xh)))*(Us=oo-(rs=(nn=Bt*oo)-(nn-oo)))-((Cs=xh*oo)-_o*rs-Ho*rs-_o*Us))-((yo=yh-(ku=(Ho=vh-(_o=(nn=Bt*vh)-(nn-vh)))*(Us=gn-(rs=(nn=Bt*gn)-(nn-gn)))-((wl=vh*gn)-_o*rs-Ho*rs-_o*Us)))+(ir=yh-yo))+(ir-ku),je[1]=(qc=Cs-((Ms=Cs+yo)-(ir=Ms-Cs))+(yo-ir))-((yo=qc-wl)+(ir=qc-yo))+(ir-wl),je[2]=Ms-((Zc=Ms+yo)-(ir=Zc-Ms))+(yo-ir),je[3]=Zc;var Tm=ee(tf,Ze,4,je,hi);je[0]=(yh=(Ho=mn-(_o=(nn=Bt*mn)-(nn-mn)))*(Us=oo-(rs=(nn=Bt*oo)-(nn-oo)))-((Cs=mn*oo)-_o*rs-Ho*rs-_o*Us))-((yo=yh-(ku=(Ho=Sr-(_o=(nn=Bt*Sr)-(nn-Sr)))*(Us=gn-(rs=(nn=Bt*gn)-(nn-gn)))-((wl=Sr*gn)-_o*rs-Ho*rs-_o*Us)))+(ir=yh-yo))+(ir-ku),je[1]=(qc=Cs-((Ms=Cs+yo)-(ir=Ms-Cs))+(yo-ir))-((yo=qc-wl)+(ir=qc-yo))+(ir-wl),je[2]=Ms-((Zc=Ms+yo)-(ir=Zc-Ms))+(yo-ir),je[3]=Zc;var c_=ee(Tm,hi,4,je,Ke);return Ke[c_-1]}(Ne,fi,Gi,Ni,Tr,er,nr)}(Ot[0],Ot[1],Rt[0],Rt[1],Oe[0],Oe[1]);return di>0?-1:di<0?1:0}function Me(Ot,Rt){var Oe=Ot.point,di=Rt.point;return Oe[0]>di[0]?1:Oe[0]<di[0]?-1:Oe[1]!==di[1]?Oe[1]>di[1]?1:-1:function(Ne,fi,Gi,Ni){return Ne.left!==fi.left?Ne.left?1:-1:Ye(Gi,Ne.otherEvent.point,fi.otherEvent.point)!==0?Ne.isBelow(fi.otherEvent.point)?-1:1:!Ne.isSubject&&fi.isSubject?1:-1}(Ot,Rt,Oe)}function Ie(Ot,Rt,Oe){var di=new gt(Rt,!1,Ot,Ot.isSubject),Ne=new gt(Rt,!0,Ot.otherEvent,Ot.isSubject);return Pt(Ot.point,Ot.otherEvent.point)&&console.warn("what is that, a collapsed segment?",Ot),di.contourId=Ne.contourId=Ot.contourId,Me(Ne,Ot.otherEvent)>0&&(Ot.otherEvent.left=!0,Ne.left=!1),Ot.otherEvent.otherEvent=Ne,Ot.otherEvent=di,Oe.push(Ne),Oe.push(di),Oe}function He(Ot,Rt){return Ot[0]*Rt[1]-Ot[1]*Rt[0]}function ai(Ot,Rt){return Ot[0]*Rt[0]+Ot[1]*Rt[1]}function Ge(Ot,Rt,Oe){var di=function(Tr,er,Bi,un,Nn){var nr=[er[0]-Tr[0],er[1]-Tr[1]],Qr=[un[0]-Bi[0],un[1]-Bi[1]];function Vn(nn,_o,Ho){return[nn[0]+_o*Ho[0],nn[1]+_o*Ho[1]]}var In=[Bi[0]-Tr[0],Bi[1]-Tr[1]],jo=He(nr,Qr),go=jo*jo,no=ai(nr,nr);if(go>0){var zn=He(In,Qr)/jo;if(zn<0||zn>1)return null;var mn=He(In,nr)/jo;return mn<0||mn>1?null:zn===0||zn===1?[Vn(Tr,zn,nr)]:mn===0||mn===1?[Vn(Bi,mn,Qr)]:[Vn(Tr,zn,nr)]}if((go=(jo=He(In,nr))*jo)>0)return null;var Sr=ai(nr,In)/no,gn=Sr+ai(nr,Qr)/no,oo=Math.min(Sr,gn),ir=Math.max(Sr,gn);return oo<=1&&ir>=0?oo===1?[Vn(Tr,oo>0?oo:0,nr)]:ir===0?[Vn(Tr,ir<1?ir:1,nr)]:[Vn(Tr,oo>0?oo:0,nr),Vn(Tr,ir<1?ir:1,nr)]:null}(Ot.point,Ot.otherEvent.point,Rt.point,Rt.otherEvent.point),Ne=di?di.length:0;if(Ne===0||Ne===1&&(Pt(Ot.point,Rt.point)||Pt(Ot.otherEvent.point,Rt.otherEvent.point))||Ne===2&&Ot.isSubject===Rt.isSubject)return 0;if(Ne===1)return Pt(Ot.point,di[0])||Pt(Ot.otherEvent.point,di[0])||Ie(Ot,di[0],Oe),Pt(Rt.point,di[0])||Pt(Rt.otherEvent.point,di[0])||Ie(Rt,di[0],Oe),1;var fi=[],Gi=!1,Ni=!1;return Pt(Ot.point,Rt.point)?Gi=!0:Me(Ot,Rt)===1?fi.push(Rt,Ot):fi.push(Ot,Rt),Pt(Ot.otherEvent.point,Rt.otherEvent.point)?Ni=!0:Me(Ot.otherEvent,Rt.otherEvent)===1?fi.push(Rt.otherEvent,Ot.otherEvent):fi.push(Ot.otherEvent,Rt.otherEvent),Gi&&Ni||Gi?(Rt.type=P,Ot.type=Rt.inOut===Ot.inOut?R:F,Gi&&!Ni&&Ie(fi[1].otherEvent,fi[0].point,Oe),2):Ni?(Ie(fi[0],fi[1].point,Oe),3):fi[0]!==fi[3].otherEvent?(Ie(fi[0],fi[1].point,Oe),Ie(fi[1],fi[2].point,Oe),3):(Ie(fi[0],fi[1].point,Oe),Ie(fi[3].otherEvent,fi[2].point,Oe),3)}function Pi(Ot,Rt){if(Ot===Rt)return 0;if(Ye(Ot.point,Ot.otherEvent.point,Rt.point)!==0||Ye(Ot.point,Ot.otherEvent.point,Rt.otherEvent.point)!==0)return Pt(Ot.point,Rt.point)?Ot.isBelow(Rt.otherEvent.point)?-1:1:Ot.point[0]===Rt.point[0]?Ot.point[1]<Rt.point[1]?-1:1:Me(Ot,Rt)===1?Rt.isAbove(Ot.point)?-1:1:Ot.isBelow(Rt.point)?-1:1;if(Ot.isSubject!==Rt.isSubject)return Ot.isSubject?-1:1;var Oe=Ot.point,di=Rt.point;return Oe[0]===di[0]&&Oe[1]===di[1]?(Oe=Ot.otherEvent.point)[0]===(di=Rt.otherEvent.point)[0]&&Oe[1]===di[1]?0:Ot.contourId>Rt.contourId?1:-1:Me(Ot,Rt)===1?1:-1}var ki=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function vi(Ot,Rt,Oe,di){var Ne,fi=Ot+1,Gi=Rt[Ot].point,Ni=Rt.length;for(fi<Ni&&(Ne=Rt[fi].point);fi<Ni&&Ne[0]===Gi[0]&&Ne[1]===Gi[1];){if(!Oe[fi])return fi;++fi<Ni&&(Ne=Rt[fi].point)}for(fi=Ot-1;Oe[fi]&&fi>di;)fi--;return fi}ki.prototype.isExterior=function(){return this.holeOf==null};var pi=_i,dr=_i;function _i(Ot,Rt){if(!(this instanceof _i))return new _i(Ot,Rt);if(this.data=Ot||[],this.length=this.data.length,this.compare=Rt||Wi,this.length>0)for(var Oe=(this.length>>1)-1;Oe>=0;Oe--)this._down(Oe)}function Wi(Ot,Rt){return Ot<Rt?-1:Ot>Rt?1:0}_i.prototype={push:function(Ot){this.data.push(Ot),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var Ot=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),Ot}},peek:function(){return this.data[0]},_up:function(Ot){for(var Rt=this.data,Oe=this.compare,di=Rt[Ot];Ot>0;){var Ne=Ot-1>>1,fi=Rt[Ne];if(Oe(di,fi)>=0)break;Rt[Ot]=fi,Ot=Ne}Rt[Ot]=di},_down:function(Ot){for(var Rt=this.data,Oe=this.compare,di=this.length>>1,Ne=Rt[Ot];Ot<di;){var fi=1+(Ot<<1),Gi=fi+1,Ni=Rt[fi];if(Gi<this.length&&Oe(Rt[Gi],Ni)<0&&(fi=Gi,Ni=Rt[Gi]),Oe(Ni,Ne)>=0)break;Rt[Ot]=Ni,Ot=fi}Rt[Ot]=Ne}},pi.default=dr;var mr=Math.max,Lr=Math.min,rn=0;function _r(Ot,Rt,Oe,di,Ne,fi){var Gi,Ni,Tr,er,Bi,un;for(Gi=0,Ni=Ot.length-1;Gi<Ni;Gi++)if(er=Ot[Gi+1],Bi=new gt(Tr=Ot[Gi],!1,void 0,Rt),un=new gt(er,!1,Bi,Rt),Bi.otherEvent=un,Tr[0]!==er[0]||Tr[1]!==er[1]){Bi.contourId=un.contourId=Oe,fi||(Bi.isExteriorRing=!1,un.isExteriorRing=!1),Me(Bi,un)>0?un.left=!0:Bi.left=!0;var Nn=Tr[0],nr=Tr[1];Ne[0]=Lr(Ne[0],Nn),Ne[1]=Lr(Ne[1],nr),Ne[2]=mr(Ne[2],Nn),Ne[3]=mr(Ne[3],nr),di.push(Bi),di.push(un)}}var pn=[];function fn(Ot,Rt,Oe){typeof Ot[0][0][0]=="number"&&(Ot=[Ot]),typeof Rt[0][0][0]=="number"&&(Rt=[Rt]);var di=function(nr,Qr,Vn){var In=null;return nr.length*Qr.length==0&&(Vn===O?In=pn:Vn===q?In=nr:Vn!==$&&Vn!==Y||(In=nr.length===0?Qr:nr)),In}(Ot,Rt,Oe);if(di)return di===pn?null:di;var Ne=[1/0,1/0,-1/0,-1/0],fi=[1/0,1/0,-1/0,-1/0],Gi=function(nr,Qr,Vn,In,jo){var go,no,zn,mn,Sr,gn,oo=new pi(null,Me);for(zn=0,mn=nr.length;zn<mn;zn++)for(Sr=0,gn=(go=nr[zn]).length;Sr<gn;Sr++)(no=Sr===0)&&rn++,_r(go[Sr],!0,rn,oo,Vn,no);for(zn=0,mn=Qr.length;zn<mn;zn++)for(Sr=0,gn=(go=Qr[zn]).length;Sr<gn;Sr++)no=Sr===0,jo===q&&(no=!1),no&&rn++,_r(go[Sr],!1,rn,oo,In,no);return oo}(Ot,Rt,Ne,fi,Oe);if(di=function(nr,Qr,Vn,In,jo){var go=null;return(Vn[0]>In[2]||In[0]>Vn[2]||Vn[1]>In[3]||In[1]>Vn[3])&&(jo===O?go=pn:jo===q?go=nr:jo!==$&&jo!==Y||(go=nr.concat(Qr))),go}(Ot,Rt,Ne,fi,Oe))return di===pn?null:di;for(var Ni=function(nr){var Qr,Vn,In=function(zn){var mn,Sr,gn,oo,ir=[];for(Sr=0,gn=zn.length;Sr<gn;Sr++)((mn=zn[Sr]).left&&mn.inResult||!mn.left&&mn.otherEvent.inResult)&&ir.push(mn);for(var nn=!1;!nn;)for(nn=!0,Sr=0,gn=ir.length;Sr<gn;Sr++)Sr+1<gn&&Me(ir[Sr],ir[Sr+1])===1&&(oo=ir[Sr],ir[Sr]=ir[Sr+1],ir[Sr+1]=oo,nn=!1);for(Sr=0,gn=ir.length;Sr<gn;Sr++)(mn=ir[Sr]).otherPos=Sr;for(Sr=0,gn=ir.length;Sr<gn;Sr++)(mn=ir[Sr]).left||(oo=mn.otherPos,mn.otherPos=mn.otherEvent.otherPos,mn.otherEvent.otherPos=oo);return ir}(nr),jo={},go=[],no=function(){if(!jo[Qr]){var zn=go.length,mn=function(ir,nn,_o){var Ho=new ki;if(ir.prevInResult!=null){var rs=ir.prevInResult,Us=rs.outputContourId;if(rs.resultTransition>0){var yo=nn[Us];if(yo.holeOf!=null){var Ms=yo.holeOf;nn[Ms].holeIds.push(_o),Ho.holeOf=Ms,Ho.depth=nn[Us].depth}else nn[Us].holeIds.push(_o),Ho.holeOf=Us,Ho.depth=nn[Us].depth+1}else Ho.holeOf=null,Ho.depth=nn[Us].depth}else Ho.holeOf=null,Ho.depth=0;return Ho}(In[Qr],go,zn),Sr=function(ir){jo[ir]=!0,ir<In.length&&In[ir]&&(In[ir].outputContourId=zn)},gn=Qr,oo=Qr;for(mn.points.push(In[Qr].point);Sr(gn),Sr(gn=In[gn].otherPos),mn.points.push(In[gn].point),!((gn=vi(gn,In,jo,oo))==oo||gn>=In.length)&&In[gn];);go.push(mn)}};for(Qr=0,Vn=In.length;Qr<Vn;Qr++)no();return go}(function(nr,Qr,Vn,In,jo,go){for(var no,zn,mn,Sr=new u(Pi),gn=[],oo=Math.min(In[2],jo[2]);nr.length!==0;){var ir=nr.pop();if(gn.push(ir),go===O&&ir.point[0]>oo||go===q&&ir.point[0]>In[2])break;if(ir.left){zn=no=Sr.insert(ir),no=no!==(mn=Sr.minNode())?Sr.prev(no):null,zn=Sr.next(zn);var nn=no?no.key:null;if(rt(ir,nn,go),zn&&Ge(ir,zn.key,nr)===2&&(rt(ir,nn,go),rt(zn.key,ir,go)),no&&Ge(no.key,ir,nr)===2){var _o=no;rt(nn,(_o=_o!==mn?Sr.prev(_o):null)?_o.key:null,go),rt(ir,nn,go)}}else zn=no=Sr.find(ir=ir.otherEvent),no&&zn&&(no=no!==mn?Sr.prev(no):null,zn=Sr.next(zn),Sr.remove(ir),zn&&no&&Ge(no.key,zn.key,nr))}return gn}(Gi,0,0,Ne,fi,Oe)),Tr=[],er=0;er<Ni.length;er++){var Bi=Ni[er];if(Bi.isExterior()){for(var un=[Bi.points],Nn=0;Nn<Bi.holeIds.length;Nn++)un.push(Ni[Bi.holeIds[Nn]].points);Tr.push(un)}}return Tr}var Co={UNION:$,DIFFERENCE:q,INTERSECTION:O,XOR:Y};r.diff=function(Ot,Rt){return fn(Ot,Rt,q)},r.intersection=function(Ot,Rt){return fn(Ot,Rt,O)},r.operations=Co,r.union=function(Ot,Rt){return fn(Ot,Rt,$)},r.xor=function(Ot,Rt){return fn(Ot,Rt,Y)},Object.defineProperty(r,"__esModule",{value:!0})})(t)}(0,D_.exports)),D_.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function Wm(n,t,r,l){const u=[],m=l===0?(_,b,E,P,R,F)=>{_.push(new Ae(F,E+(F-b)/(P-b)*(R-E)))}:(_,b,E,P,R,F)=>{_.push(new Ae(b+(F-E)/(R-E)*(P-b),F))};for(const _ of n){const b=[];for(const E of _){if(E.length<=2)continue;const P=[];for(let O=0;O<E.length-1;O++){const $=E[O].x,q=E[O].y,Y=E[O+1].x,rt=E[O+1].y,at=l===0?$:q,gt=l===0?Y:rt;at<t?gt>t&&m(P,$,q,Y,rt,t):at>r?gt<r&&m(P,$,q,Y,rt,r):P.push(E[O]),gt<t&&at>=t&&m(P,$,q,Y,rt,t),gt>r&&at<=r&&m(P,$,q,Y,rt,r)}let R=E[E.length-1];const F=l===0?R.x:R.y;F>=t&&F<=r&&P.push(R),P.length&&(R=P[P.length-1],P[0].x===R.x&&P[0].y===R.y||P.push(P[0]),b.push(P))}b.length&&u.push(b)}return u}function L_(n,t){const r=xd(n),l=xd([t]),u=z_.intersection(r,l);return u==null?[]:$p(u)}function Xy(n,t){let l=xd(n,65536);const u=[];for(;t.valid();t.next()){const[m,_]=t.get(),b=m.x*65536,E=m.y*65536,P=_.x*65536,R=_.y*65536,F=P-b,O=R-E,$=Math.hypot(F,O);if($===0)continue;const q=Math.trunc(O/$*3),Y=-Math.trunc(F/$*3);u.push([[[b,E],[P,R],[P+q,R+Y],[b+q,E+Y],[b,E]]])}return u.length>0&&(l=z_.diff(l,u)),$p(l,1/65536)}function xd(n,t=1){return[n.map(r=>r.map(l=>[l.x*t,l.y*t]))]}function $p(n,t=1){return n.map(r=>r.map((l,u)=>{const m=l.map(_=>new Ae(_[0]*t,_[1]*t).round());return u>0&&m.reverse(),m}))}class cm{constructor(t,r){this.layoutVertexArray=new ys,this.indexArray=new qn,this.lineIndexArray=new Rl,this.triangleSegments=new po,this.lineSegments=new po,this.programConfigurations=new mh(t.layers,{zoom:t.zoom,lut:t.lut}),this.uploaded=!1,r&&(this.elevatedLayoutVertexArray=new Fs)}update(t,r,l,u,m,_,b,E){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,zg.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.lineIndexBuffer=t.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=t.createVertexBuffer(this.elevatedLayoutVertexArray,jy.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(t,r,l,u,m,_,b){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,l,u,m,_,void 0,b)}}class Af{constructor(t){this.zoom=t.zoom,this.pixelRatio=t.pixelRatio,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=t.lut,this.bufferData=new cm(t,!1),this.elevationBufferData=new cm(t,!0),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.projection=t.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=t.sourceLayerIndex,this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.hasPattern=Ws("fill",this.layers,this.pixelRatio,r);const m=this.layers[0].layout.get("fill-sort-key"),_=[];for(const{feature:b,id:E,index:P,sourceLayerIndex:R}of t){const F=this.layers[0]._featureFilter.needGeometry,O=Te(b,F);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),O,l))continue;const $=m?m.evaluate(O,{},l,r.availableImages):void 0,q={id:E,properties:b.properties,type:b.type,sourceLayerIndex:R,index:P,geometry:F?O.geometry:Be(b,l,u),patterns:{},sortKey:$};_.push(q)}m&&_.sort((b,E)=>b.sortKey-E.sortKey);for(const b of _){const{geometry:E,index:P,sourceLayerIndex:R}=b;if(this.hasPattern){const F=lm("fill",this.layers,b,this.zoom,this.pixelRatio,r);this.patternFeatures.push(F)}else this.addFeature(b,E,P,l,{},r.availableImages,r.brightness,r.elevationFeatures);r.featureIndex.insert(t[P].feature,E,P,R,this.index)}}update(t,r,l,u,m,_,b){this.bufferData.update(t,r,l,u,m,_,b,this.worldview),this.elevationBufferData.update(t,r,l,u,m,_,b,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(t,r,l,u,m,_,b,this.worldview)}addFeatures(t,r,l,u,m,_){for(const b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,r,l,u,_,t.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(t){this.bufferData.upload(t),this.elevationBufferData.upload(t),this.elevatedStructures&&this.elevatedStructures.upload(t)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(t,r,l,u,m,_=[],b,E){const P=am(r,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(t,P,u,l,E):this.addGeometry(P,this.bufferData),this.bufferData.populatePaintArrays(t,l,m,_,u,b,this.worldview),this.elevationBufferData.populatePaintArrays(t,l,m,_,u,b,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(t,r,l,u,m){this.elevatedStructures&&(this.elevatedStructures.construct(t),this.elevatedStructures.populatePaintArrays(r,l,u,m,this.worldview))}addElevatedRoadFeature(t,r,l,u,m){const _=new Array,b=cr.getElevationFeature(t,m);if(!b)return void this.addGeometry(r,this.bufferData);{const P=this.clipPolygonsToTile(r,1);P.length>0&&_.push({polygons:P,elevationFeature:b,elevationTileID:l})}const E={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(t,{},l),featureIndex:u};for(const P of _)if(P.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Ba(P.elevationTileID,this.layers,this.zoom,this.lut));const F=P.elevationFeature.isTunnel();let O=0;t.properties.hasOwnProperty(Ii)&&(O=+t.properties[Ii]);for(const $ of P.polygons)this.elevatedStructures.addPortalCandidates(P.elevationFeature.id,$,F,P.elevationFeature,O)}P.elevationFeature.constantHeight==null&&(P.polygons=this.prepareElevatedPolygons(P.polygons,P.elevationFeature,P.elevationTileID));const R=new Wr(l,P.elevationTileID);this.addElevatedGeometry(P.polygons,R,P.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,u,E)}}addElevatedGeometry(t,r,l,u,m,_){const b={elevation:l,elevationSampler:r,bias:u,index:m,featureInfo:_},[E,P]=this.addGeometry(t,this.elevationBufferData,b);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:E,max:P}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,E),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,P))}addGeometry(t,r,l){let u=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,_=null;l&&(_=l.elevationSampler.constantElevation(l.elevation,l.bias),_!=null&&(u=_,m=_));const b=(E,P,R)=>{if(l!=null)if(P.push(E),_!=null)r.elevatedLayoutVertexArray.emplaceBack(_),R.push(_);else{const F=l.elevationSampler.pointElevation(E,l.elevation,l.bias);r.elevatedLayoutVertexArray.emplaceBack(F),R.push(F),u=Math.min(u,F),m=Math.max(m,F)}};for(const E of t){let P=0;for(const yt of E)P+=yt.length;const R=r.triangleSegments.prepareSegment(P,r.layoutVertexArray,r.indexArray),F=R.vertexLength,O=[],$=[],q=[],Y=[],rt=[],at=r.layoutVertexArray.length;for(const yt of E){if(yt.length===0)continue;yt!==E[0]&&$.push(O.length/2);const Pt=r.lineSegments.prepareSegment(yt.length,r.layoutVertexArray,r.lineIndexArray),qt=Pt.vertexLength;l&&rt.push(r.layoutVertexArray.length-at),b(yt[0],q,Y),r.layoutVertexArray.emplaceBack(yt[0].x,yt[0].y),r.lineIndexArray.emplaceBack(qt+yt.length-1,qt),O.push(yt[0].x),O.push(yt[0].y);for(let Bt=1;Bt<yt.length;Bt++)b(yt[Bt],q,Y),r.layoutVertexArray.emplaceBack(yt[Bt].x,yt[Bt].y),r.lineIndexArray.emplaceBack(qt+Bt-1,qt+Bt),O.push(yt[Bt].x),O.push(yt[Bt].y);Pt.vertexLength+=yt.length,Pt.primitiveLength+=yt.length}const gt=jp(O,$);for(let yt=0;yt<gt.length;yt+=3)r.indexArray.emplaceBack(F+gt[yt],F+gt[yt+1],F+gt[yt+2]);if(gt.length>0&&l&&this.elevationMode==="hd-road-base"){const yt=l.elevation.isTunnel(),Pt=l.elevation.safeArea,qt=this.elevatedStructures.addVertices(q,Y);this.elevatedStructures.addTriangles(gt,qt,yt);const Bt=rt.length;if(Bt>0){for(let Yt=0;Yt<Bt-1;Yt++)this.elevatedStructures.addRenderableRing(l.index,rt[Yt]+qt,rt[Yt+1]-rt[Yt],yt,Pt,l.featureInfo);this.elevatedStructures.addRenderableRing(l.index,rt[Bt-1]+qt,q.length-rt[Bt-1],yt,Pt,l.featureInfo)}}R.vertexLength+=P,R.primitiveLength+=gt.length/3}return[u,m]}prepareElevatedPolygons(t,r,l){const u=1/Ht(l),m=[];for(const _ of t){const b=Xy(_,new eo(r,u));m.push(...b)}return m}clipPolygonsToTile(t,r){const l=-r,u=-r,m=ri+r,_=ri+r;let b=0;const E=[],P=[];for(;b<t.length;b++){const O=t[b],$=Md(O);($.min.x>=l&&$.max.x<=m&&$.min.y>=u&&$.max.y<=_?E:P).push(O)}if(E.length===t.length)return t;const R=[new Ae(l,u),new Ae(m,u),new Ae(m,_),new Ae(l,_),new Ae(l,u)],F=E;for(const O of P)F.push(...L_(O,R));return F}}let _l,eu,hn,R_;Si(Af,"FillBucket",{omit:["layers","patternFeatures"]}),Si(cm,"FillBufferData"),Si(Ba,"ElevatedStructures");class Xm{constructor(t,r,l,u){if(this.triangleCount=r.length/3,this.min=new Ae(0,0),this.max=new Ae(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||t.length===0)return;const[m,_]=[t[0].clone(),t[0].clone()];for(let F=1;F<t.length;++F){const O=t[F];m.x=Math.min(m.x,O.x),m.y=Math.min(m.y,O.y),_.x=Math.max(_.x,O.x),_.y=Math.max(_.y,O.y)}if(u){const F=Math.ceil(Math.max(_.x-m.x,_.y-m.y)/u);l=Math.max(l,F)}if(l===0)return;this.min=m,this.max=_;const b=this.max.sub(this.min);b.x=Math.max(b.x,1),b.y=Math.max(b.y,1);const E=Math.max(b.x,b.y)/l;this.cellsX=Math.max(1,Math.ceil(b.x/E)),this.cellsY=Math.max(1,Math.ceil(b.y/E)),this.xScale=1/E,this.yScale=1/E;const P=[];for(let F=0;F<this.triangleCount;F++){const O=t[r[3*F+0]].sub(this.min),$=t[r[3*F+1]].sub(this.min),q=t[r[3*F+2]].sub(this.min),Y=Sc(Math.floor(Math.min(O.x,$.x,q.x)),this.xScale,this.cellsX),rt=Sc(Math.floor(Math.max(O.x,$.x,q.x)),this.xScale,this.cellsX),at=Sc(Math.floor(Math.min(O.y,$.y,q.y)),this.yScale,this.cellsY),gt=Sc(Math.floor(Math.max(O.y,$.y,q.y)),this.yScale,this.cellsY),yt=new Ae(0,0),Pt=new Ae(0,0),qt=new Ae(0,0),Bt=new Ae(0,0);for(let Yt=at;Yt<=gt;++Yt){yt.y=Pt.y=Yt*E,qt.y=Bt.y=(Yt+1)*E;for(let ee=Y;ee<=rt;++ee)yt.x=qt.x=ee*E,Pt.x=Bt.x=(ee+1)*E,($o(O,$,q,yt,Pt,Bt)||$o(O,$,q,yt,Bt,qt))&&P.push({cellIdx:Yt*this.cellsX+ee,triIdx:F})}}if(P.length===0)return;P.sort((F,O)=>F.cellIdx-O.cellIdx||F.triIdx-O.triIdx);let R=0;for(;R<P.length;){const F=P[R].cellIdx,O={start:this.payload.length,len:0};for(;R<P.length&&P[R].cellIdx===F;)++O.len,this.payload.push(P[R++].triIdx);this.cells[F]=O}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(t,r){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>t.x||t.y>this.max.y||this.min.y>t.y)return;const l=Sc(t.x-this.min.x,this.xScale,this.cellsX),u=Sc(t.y-this.min.y,this.yScale,this.cellsY),m=this.cells[u*this.cellsX+l];if(m){this._lazyInitLookup();for(let _=0;_<m.len;_++){const b=this.payload[m.start+_],E=Math.floor(b/8),P=1<<b%8;if(!(this.lookup[E]&P)&&(this.lookup[E]|=P,r.push(b),r.length===this.triangleCount))return}}}query(t,r,l){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>r.x||t.y>this.max.y||this.min.y>r.y)return;this._lazyInitLookup();const u=Sc(t.x-this.min.x,this.xScale,this.cellsX),m=Sc(r.x-this.min.x,this.xScale,this.cellsX),_=Sc(t.y-this.min.y,this.yScale,this.cellsY),b=Sc(r.y-this.min.y,this.yScale,this.cellsY);for(let E=_;E<=b;E++)for(let P=u;P<=m;P++){const R=this.cells[E*this.cellsX+P];if(R)for(let F=0;F<R.len;F++){const O=this.payload[R.start+F],$=Math.floor(O/8),q=1<<O%8;if(!(this.lookup[$]&q)&&(this.lookup[$]|=q,l.push(O),l.length===this.triangleCount))return}}}}function Sc(n,t,r){return Math.max(0,Math.min(r-1,Math.floor(n*t)))}Si(Xm,"TriangleGridIndex");class Yy{constructor(t){this.zoom=t.zoom,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.footprints=[],this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){for(const l of this.footprints)r.push({footprint:l,id:t})}updateAppearances(t,r,l,u){}populate(t,r,l,u){const m=[];for(const{feature:_,id:b,index:E,sourceLayerIndex:P}of t){const R=this.layers[0]._featureFilter.needGeometry,F=Te(_,R);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),F,l))continue;const O={id:b,properties:_.properties,type:_.type,sourceLayerIndex:P,index:E,geometry:R?F.geometry:Be(_,l,u),patterns:{}};m.push(O)}for(const _ of m){const{geometry:b,index:E,sourceLayerIndex:P}=_;this.addFeature(_,b,E,l,{},r.availableImages,r.brightness),r.featureIndex.insert(t[E].feature,b,E,P,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(t){}update(t,r,l,u,m,_,b){}destroy(){}addFeature(t,r,l,u,m,_=[],b){for(const E of am(r,2)){const P=[],R=[],F=[],O=new Ae(1/0,1/0),$=new Ae(-1/0,-1/0);for(const rt of E)if(rt.length!==0){rt!==E[0]&&F.push(R.length/2);for(let at=0;at<rt.length;at++)R.push(rt[at].x),R.push(rt[at].y),P.push(rt[at]),O.x=Math.min(O.x,rt[at].x),O.y=Math.min(O.y,rt[at].y),$.x=Math.max($.x,rt[at].x),$.y=Math.max($.y,rt[at].y)}const q=jp(R,F),Y=new Xm(P,q,8,256);this.footprints.push({vertices:P,indices:q,grid:Y,min:O,max:$})}}}Si(Yy,"ClipBucket",{omit:["layers"]});const hm=vr([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),nx=vr([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Jy=vr([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),kg=vr([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Fg=vr([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Bg=vr([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),k_=vr([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:F_}=hm,Pf=Number.MAX_SAFE_INTEGER,B_=Pf-1;function um(n,t,r,l){return n.order<t||n.order===Pf||!(n.clipMask&r)||function(u,m){return m.length!==0&&m.find(_=>_===u)===void 0}(l,n.clipScope)}function qp(n,t){return n.x-t.x||n.y-t.y}function O_(n,t){return qp(n.min,t.min)===0&&qp(n.max,t.max)===0}function dm(n,t){return!(n.min.x>t.max.x||n.max.x<t.min.x||n.min.y>t.max.y||n.max.y<t.min.y)}function Mf(n,t){if(n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(n[r].sourceId!==t[r].sourceId||!O_(n[r],t[r])||n[r].order!==t[r].order||n[r].clipMask!==t[r].clipMask||!bo(n[r].clipScope,t[r].clipScope))return!1;return!0}function Ky(n,t,r){const l=1/ri,u=1/(1<<r.canonical.z),m=(t.x*l+r.canonical.x)*u+r.wrap,_=(t.y*l+r.canonical.y)*u;return{min:new Ae((n.x*l+r.canonical.x)*u+r.wrap,(n.y*l+r.canonical.y)*u),max:new Ae(m,_)}}function N_(n,t,r){const l=1<<r.canonical.z,u=((t.x-r.wrap)*l-r.canonical.x)*ri,m=(t.y*l-r.canonical.y)*ri;return{min:new Ae(((n.x-r.wrap)*l-r.canonical.x)*ri,(n.y*l-r.canonical.y)*ri),max:new Ae(u,m)}}function Og(n,t,r,l,u,m,_){const b=n.indices,E=n.vertices,P=[];for(let R=l;R<l+u;R+=3){const F=t[r[R+0]+m],O=t[r[R+1]+m],$=t[r[R+2]+m],q=Math.min(F.x,O.x,$.x),Y=Math.max(F.x,O.x,$.x),rt=Math.min(F.y,O.y,$.y),at=Math.max(F.y,O.y,$.y);P.length=0,n.grid.query(new Ae(q,rt),new Ae(Y,at),P);for(let gt=0;gt<P.length;gt++){const yt=P[gt];if($o(E[b[3*yt+0]],E[b[3*yt+1]],E[b[3*yt+2]],F,O,$,_))return!0}}return!1}function Qy(n,t,r,l){if(!n||!r)return!1;let u=n.vertices;if(!t.canonical.equals(l.canonical)||t.wrap!==l.wrap){if(r.vertices.length<n.vertices.length)return Qy(r,l,n,t);const m=t.canonical,_=l.canonical,b=Math.pow(2,_.z-m.z);u=n.vertices.map(E=>new Ae((E.x+m.x*ri)*b-_.x*ri,(E.y+m.y*ri)*b-_.y*ri))}return Og(r,u,n.indices,0,n.indices.length,0,0)}function t0(n,t,r,l){const u=Math.pow(2,l.z-r.z);return new Ae((n+r.x*ri)*u-l.x*ri,(t+r.y*ri)*u-l.y*ri)}function Ng(n,t){const r=[];t.grid.queryPoint(n,r);const l=t.indices,u=t.vertices;for(let m=0;m<r.length;m++){const _=r[m];if(Bs([u[l[3*_+0]],u[l[3*_+1]],u[l[3*_+2]]],n))return!0}return!1}const V_=[new Ae(0,0),new Ae(ri,0),new Ae(ri,ri),new Ae(0,ri)];function pm(n,t){const r=[];let l=[];if(!t||n.length<2)return[n];if(n.length===2)return ko(n[0],n[1],V_)?[n]:[];for(let u=0;u<n.length+2;u++){const m=n[u%n.length],_=n[(u+1)%n.length],b=ko(u===0?n[n.length-1]:n[(u-1)%n.length],m,V_),E=ko(m,_,V_),P=b||E;P&&l.push(m),P&&E||l.length>0&&(l.length>1&&r.push(l),l=[])}return l.length>1&&r.push(l),r}const Vg=qe.types,ox=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],U_=["fill-extrusion-flood-light-ground-radius"],j_=Math.pow(2,13),e0=Math.pow(2,15)-1,Cf=new Ae(0,1),tp=2147483648,fm=7,i0=450;function ep(n,t,r,l,u,m,_,b){n.emplaceBack((t<<1)+_,(r<<1)+m,(Math.floor(l*j_)<<1)+u,Math.round(b))}function Zp(n,t,r){n.emplaceBack(t.x*ri,t.y*ri,r?1:0)}function Ug(n,t,r,l,u,m){n.emplaceBack(t.x,t.y,(r.x<<1)+l,(r.y<<1)+u,m)}function mm(n,t,r){n.emplaceBack(t.x,t.y,t.z,r[0]*16384,r[1]*16384,r[2]*16384)}class G_{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class r0{constructor(){this.centroidXY=new Ae(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Ae(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Ae(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Ae(this.max.x-this.min.x,this.max.y-this.min.y)}}class n0{constructor(){this.acc=new Ae(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(t,r){t.min.x===Number.MAX_VALUE&&(t.min.x=t.max.x=r.x,t.min.y=t.max.y=r.y)}appendEdge(t,r,l){this.accCount++,this.acc._add(r);let u=!!this.borders;r.x<t.min.x?(t.min.x=r.x,u=!0):r.x>t.max.x&&(t.max.x=r.x,u=!0),r.y<t.min.y?(t.min.y=r.y,u=!0):r.y>t.max.y&&(t.max.y=r.y,u=!0),((r.x===0||r.x===ri)&&r.x===l.x)!=((r.y===0||r.y===ri)&&r.y===l.y)&&this.processBorderOverlap(r,l),u&&this.checkBorderIntersection(r,l)}checkBorderIntersection(t,r){r.x<0!=t.x<0&&this.addBorderIntersection(0,Vi(r.y,t.y,(0-r.x)/(t.x-r.x))),r.x>ri!=t.x>ri&&this.addBorderIntersection(1,Vi(r.y,t.y,(ri-r.x)/(t.x-r.x))),r.y<0!=t.y<0&&this.addBorderIntersection(2,Vi(r.x,t.x,(0-r.y)/(t.y-r.y))),r.y>ri!=t.y>ri&&this.addBorderIntersection(3,Vi(r.x,t.x,(ri-r.y)/(t.y-r.y)))}addBorderIntersection(t,r){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const l=this.borders[t];r<l[0]&&(l[0]=r),r>l[1]&&(l[1]=r)}processBorderOverlap(t,r){if(t.x===r.x){if(t.y===r.y)return;const l=t.x===0?0:1;this.addBorderIntersection(l,r.y),this.addBorderIntersection(l,t.y)}else{const l=t.y===0?2:3;this.addBorderIntersection(l,r.x),this.addBorderIntersection(l,t.x)}}centroid(){return this.accCount===0?new Ae(0,0):new Ae(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((t,r)=>t+ +(r[0]!==Number.MAX_VALUE),0):0}}function o0(n,t){const r=n.add(t)._unit(),l=tt(n.x*r.x+n.y*r.y,-1,1);var u,m,_;return u=Math.acos(l),Math.min(4,Math.max(-4,Math.tan(u)))/4*e0*((m=n).x*(_=t).y-m.y*_.x<0?-1:1)}const sx=[n=>n.x<0,n=>n.x>ri,n=>n.y<0,n=>n.y>ri];function ax(n,t,r,l){const u=[4];if(l===0)return u;r._mult(l);const m=n.sub(r),_=t.sub(r),b=[n,t,m,_];for(let E=0;E<4;E++)for(const P of b)if(sx[E](P)){u.push(E);break}return u}class jg{constructor(t){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new Ql,this.indexArray=new qn,this.programConfigurations=new mh(t.layers,{zoom:t.zoom,lut:t.lut},r=>U_.includes(r)),this._segments=new po,this.hiddenByLandmarkVertexArray=new vf,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new po}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(t,r,l,u=!1){const m=t.length;if(m>2){let _=Math.max(0,this._segments.get().length-1);const b=this._segments._prepareSegment(4*m,this.vertexArray.length,2*this._segmentToGroundQuads[_].length);let E;_!==this._segments.get().length-1&&(_++,this._segmentToGroundQuads[_]=[],this._segmentToRegionTriCounts[_]=[0,0,0,0,0]);{const P=t[0],R=t[1];E=o0(P.sub(t[m-1])._perp()._unit(),R.sub(P)._perp()._unit())}for(let P=0;P<m;P++){const R=P===m-1?0:P+1,F=t[P],O=t[R],$=t[R===m-1?0:R+1],q=O.sub(F)._perp()._unit(),Y=o0(q,$.sub(O)._perp()._unit()),rt=E,at=Y;if(q_(F,O,r)||u&&Z_(F,r)&&Z_(O,r)){E=Y;continue}const gt=b.vertexLength;Ug(this.vertexArray,F,O,1,1,rt),Ug(this.vertexArray,F,O,1,0,rt),Ug(this.vertexArray,F,O,0,1,at),Ug(this.vertexArray,F,O,0,0,at),b.vertexLength+=4;const yt=ax(F,O,q,l);for(const Pt of yt)this._segmentToGroundQuads[_].push({id:gt,region:Pt}),this._segmentToRegionTriCounts[_][Pt]+=2,b.primitiveLength+=2;E=Y}}}prepareBorderSegments(){if(!this.hasData())return;const t=this._segments.get(),r=t.length;for(let l=0;l<r;l++)this._segmentToGroundQuads[l].sort((u,m)=>u.region-m.region);for(let l=0;l<r;l++){const u=this._segmentToGroundQuads[l],m=t[l],_=this._segmentToRegionTriCounts[l];_.reduce((E,P)=>E+P,0);let b=0;for(let E=0;E<=4;E++){const P=_[E];if(P!==0){let R=this.regionSegments[E];R||(R=this.regionSegments[E]=new po);const F={vertexOffset:m.vertexOffset,primitiveOffset:m.primitiveOffset+b,vertexLength:m.vertexLength,primitiveLength:P};R.get().push(F)}b+=P}for(let E=0;E<u.length;E++){const P=u[E].id;this.indexArray.emplaceBack(P,P+1,P+3),this.indexArray.emplaceBack(P,P+3,P+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(t,r,l,u,m,_,b){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,t,r,l,u,m,_,void 0,b)}upload(t){this.hasData()&&(this.vertexBuffer=t.createVertexBuffer(this.vertexArray,nx.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=t.createVertexBuffer(this.groundRadiusArray,Jy.members)))}uploadPaintProperties(t){this.hasData()&&this.programConfigurations.upload(t)}update(t,r,l,u,m,_,b,E){this.hasData()&&this.programConfigurations.updatePaintArrays(t,r,l,u,m,_,b,E)}updateHiddenByLandmark(t){this.updateHiddenByLandmarkRange(t.groundVertexArrayOffset,t.groundVertexCount,!!(t.flags&tp))}updateHiddenByLandmarkRange(t,r,l){if(!this.hasData())return;const u=r+t;if(r!==0){for(let m=t;m<u;++m)this.hiddenByLandmarkVertexArray.emplace(m,l?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(t){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=t.createVertexBuffer(this.hiddenByLandmarkVertexArray,Bg.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let t=0;t<=4;t++){const r=this.regionSegments[t];r&&r.destroy()}}}}class vd{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.pixelRatio=t.pixelRatio,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new qn,this.footprintVertices=new ys,this.footprintSegments=[],this.layoutVertexArray=new Kl,this.centroidVertexArray=new Qf,this.wallVertexArray=new Rm,this.indexArray=new qn,this.programConfigurations=new mh(t.layers,{zoom:t.zoom,lut:t.lut},r=>ox.includes(r)),this.segments=new po,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.groundEffect=new jg(t),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.features=[],this.hasPattern=Ws("fill-extrusion",this.layers,this.pixelRatio,r),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Ht(l),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:m,id:_,index:b,sourceLayerIndex:E}of t){const P=this.layers[0]._featureFilter.needGeometry,R=Te(m,P);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),R,l))continue;const F={id:_,sourceLayerIndex:E,index:b,geometry:P?R.geometry:Be(m,l,u),properties:m.properties,type:m.type,patterns:{}},O=this.layoutVertexArray.length,$=Vg[F.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:m.id,feature:lm("fill-extrusion",this.layers,F,this.zoom,this.pixelRatio,r)});else if(this.wallMode)for(const q of F.geometry)for(const Y of pm(q,$))this.addFeature(m.id,F,[Y],b,l,{},r.availableImages,u,r.brightness);else this.addFeature(m.id,F,F.geometry,b,l,{},r.availableImages,u,r.brightness);r.featureIndex.insert(m,F.geometry,b,E,this.index,O)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(t,r,l,u,m,_){for(const{featureId:b,feature:E}of this.features){const P=Vg[E.type]==="Polygon",{geometry:R}=E;if(this.wallMode)for(const F of R)for(const O of pm(F,P))this.addFeature(b,E,[O],E.index,r,l,u,m,_);else this.addFeature(b,E,R,E.index,r,l,u,m,_)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(t,r,l,u,m,_,b){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview),this.groundEffect.update(t,r,m,l,u,_,b,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,F_),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.wallVertexBuffer=t.createVertexBuffer(this.wallVertexArray,Fg.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,k_.members,!0)),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.groundEffect.uploadHiddenByLandmark(t),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,kg.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,r,l,u,m,_,b,E,P){const R=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(r,{})/this.tileToMeter,F=[new Ae(0,0),new Ae(ri,ri)],O=E.projection,$=O.name==="globe",q=this.wallMode||Vg[r.type]==="Polygon",Y=new n0;Y.centroidDataIndex=this.centroidData.length;const rt=new r0;rt.buildingId=t,r.properties&&r.properties.hasOwnProperty("building_id")&&(rt.buildingId=r.properties.building_id);const at=this.layers[0].paint.get("fill-extrusion-base").evaluate(r,{},m)<=0,gt=this.layers[0].paint.get("fill-extrusion-height").evaluate(r,{},m);let yt;if(rt.height=gt,rt.vertexArrayOffset=this.layoutVertexArray.length,rt.groundVertexArrayOffset=this.groundEffect.vertexArray.length,$&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new hs),this.wallMode){if($)return void qi("Non zero fill-extrusion-line-width is not yet supported on globe.");if(l.length!==1)return;yt=function(fe){const ke=fe[0].x===fe[fe.length-1].x&&fe[0].y===fe[fe.length-1].y;(function(vi){let pi=0;const dr=vi.length;for(let _i=0;_i<dr;_i++)pi+=(vi[(_i+1)%dr].x-vi[_i].x)*(vi[(_i+1)%dr].y+vi[_i].y);return pi>=0})(fe)||(fe=fe.reverse());const Ze={geometry:[],joinNormals:[],indices:[]},hi=[],Ke=[],je=[];let Ye=fe.length;for(;Ye>=2&&fe[Ye-1].equals(fe[Ye-2]);)Ye--;if(Ye<(ke?3:2))return Ze;let Me,Ie,He,ai,Ge,Pi=0;for(;Pi<Ye-1&&fe[Pi].equals(fe[Pi+1]);)Pi++;ke&&(Me=fe[Ye-2],Ge=fe[Pi].sub(Me)._unit()._perp());for(let vi=Pi;vi<Ye;vi++){if(He=vi===Ye-1?ke?fe[Pi+1]:void 0:fe[vi+1],He&&fe[vi].equals(He))continue;Ge&&(ai=Ge),Me&&(Ie=Me),Me=fe[vi],Ge=He?He.sub(Me)._unit()._perp():ai,ai=ai||Ge;let pi=ai.add(Ge);pi.x===0&&pi.y===0||pi._unit();const dr=pi.x*Ge.x+pi.y*Ge.y,_i=dr!==0?1/dr:1/0,Wi=ai.x*Ge.y-ai.y*Ge.x>0;let mr="miter";const Lr=2;mr==="miter"&&_i>Lr&&(mr="bevel"),mr==="bevel"&&(_i>100&&(mr="flipbevel"),_i<Lr&&(mr="miter"));const rn=(_r,pn,fn,Co)=>{const Ot=new Ae(_r.x,_r.y),Rt=new Ae(_r.x,_r.y);Ot.x+=pn.x*Co,Ot.y+=pn.y*Co,Rt.x-=pn.x*Math.max(fn,1),Rt.y-=pn.y*Math.max(fn,1),je.push(pn),hi.push(Ot),Ke.push(Rt)};if(mr==="miter")pi._mult(_i),rn(Me,pi,0,0);else if(mr==="flipbevel")pi=Ge.mult(-1),rn(Me,pi,0,0),rn(Me,pi.mult(-1),0,0);else{const _r=-Math.sqrt(_i*_i-1),pn=Wi?_r:0,fn=Wi?0:_r;Ie&&rn(Me,ai,pn,fn),He&&rn(Me,Ge,pn,fn)}}Ze.geometry=[...hi,...Ke.reverse(),hi[0]],Ze.joinNormals=[...je,...je.reverse(),je[je.length-1]];const ki=Ze.geometry.length-1;for(let vi=0;vi<ki/2;vi++)if(vi+1<ki/2){let pi=vi,dr=vi+1,_i=ki-1-vi,Wi=ki-2-vi;pi=pi===0?ki-1:pi-1,dr=dr===0?ki-1:dr-1,_i=_i===0?ki-1:_i-1,Wi=Wi===0?ki-1:Wi-1,Ze.indices.push(_i),Ze.indices.push(dr),Ze.indices.push(pi),Ze.indices.push(_i),Ze.indices.push(Wi),Ze.indices.push(dr)}return Ze}(l[0]),l=[yt.geometry]}const Pt=(fe,ke)=>fe<(ke.length-1)/2||fe===ke.length-1,qt=this.wallMode?[l]:am(l,500);for(let fe=qt.length-1;fe>=0;fe--){const ke=qt[fe];(ke.length===0||(Bt=ke[0]).every(Ue=>Ue.x<=0)||Bt.every(Ue=>Ue.x>=ri)||Bt.every(Ue=>Ue.y<=0)||Bt.every(Ue=>Ue.y>=ri))&&qt.splice(fe,1)}var Bt;let Yt;if($)Yt=l0(qt,F,m);else{Yt=[];for(const fe of qt)Yt.push({polygon:fe,bounds:F})}const ee=q?this.edgeRadius:0,ne=ee>0&&this.zoom<17,Le=(fe,ke)=>{if(fe.length===0)return!1;const Ue=fe[fe.length-1];return ke.x===Ue.x&&ke.y===Ue.y};for(const{polygon:fe,bounds:ke}of Yt){let Ue=0,Ze=0;for(const Ye of fe)q&&!Ye[0].equals(Ye[Ye.length-1])&&Ye.push(Ye[0]),Ze+=q?Ye.length-1:Ye.length;const hi=this.segments.prepareSegment((q?5:4)*Ze,this.layoutVertexArray,this.indexArray);rt.footprintSegIdx<0&&(rt.footprintSegIdx=this.footprintSegments.length),rt.polygonSegIdx<0&&(rt.polygonSegIdx=this.polygonSegments.length);const Ke={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},je=new G_;if(je.vertexOffset=this.footprintVertices.length,je.indexOffset=3*this.footprintIndices.length,je.ringIndices=[],q){const Ye=[],Me=[];Ue=hi.vertexLength;for(let He=0;He<fe.length;He++){const ai=fe[He];ai.length&&He!==0&&Me.push(Ye.length/2);const Ge=[];let Pi,ki;Pi=ai[1].sub(ai[0])._perp()._unit(),je.ringIndices.push(ai.length-1);for(let vi=1;vi<ai.length;vi++){const pi=ai[vi],dr=ai[vi===ai.length-1?1:vi+1],_i=pi.clone();if(ee){ki=dr.sub(pi)._perp()._unit();const Wi=Pi.add(ki)._unit(),mr=ee*Math.min(4,1/(Pi.x*Wi.x+Pi.y*Wi.y));_i.x+=mr*Wi.x,_i.y+=mr*Wi.y,_i.x=Math.round(_i.x),_i.y=Math.round(_i.y),Pi=ki}if(!at||ee!==0&&!ne||Le(Ge,_i)||Ge.push(_i),ep(this.layoutVertexArray,_i.x,_i.y,0,0,1,1,0),this.wallMode){const Wi=Pt(vi,ai);Zp(this.wallVertexArray,yt.joinNormals[vi],!Wi)}hi.vertexLength++,this.footprintVertices.emplaceBack(pi.x,pi.y),Ye.push(pi.x,pi.y),$&&mm(this.layoutVertexExtArray,O.projectTilePoint(_i.x,_i.y,m),O.upVector(m,_i.x,_i.y))}at&&(ee===0||ne)&&(Ge.length!==0&&Le(Ge,Ge[0])&&Ge.pop(),this.groundEffect.addData(Ge,ke,R))}const Ie=this.wallMode?yt.indices:jp(Ye,Me);for(let He=0;He<Ie.length;He+=3)this.footprintIndices.emplaceBack(je.vertexOffset+Ie[He+0],je.vertexOffset+Ie[He+1],je.vertexOffset+Ie[He+2]),this.indexArray.emplaceBack(Ue+Ie[He],Ue+Ie[He+2],Ue+Ie[He+1]),hi.primitiveLength++;je.indexCount+=Ie.length,je.vertexCount+=this.footprintVertices.length-je.vertexOffset}for(let Ye=0;Ye<fe.length;Ye++){const Me=fe[Ye];Y.startRing(rt,Me[0]);let Ie=Me.length>4&&H_(Me[Me.length-2],Me[0],Me[1]),He=ee?s0(Me[Me.length-2],Me[0],Me[1],ee):0;const ai=[];let Ge,Pi,ki;Pi=Me[1].sub(Me[0])._perp()._unit();let vi=!0;for(let pi=1,dr=0;pi<Me.length;pi++){let _i=Me[pi-1],Wi=Me[pi];const mr=Me[pi===Me.length-1?1:pi+1];if(Y.appendEdge(rt,Wi,_i),q_(Wi,_i,ke)){ee&&(Pi=mr.sub(Wi)._perp()._unit(),vi=!vi);continue}const Lr=Wi.sub(_i)._perp(),rn=Lr.x/(Math.abs(Lr.x)+Math.abs(Lr.y)),_r=Lr.y>0?1:0,pn=_i.dist(Wi);if(dr+pn>32768&&(dr=0),ee){ki=mr.sub(Wi)._perp()._unit();let Rt=$_(_i,Wi,mr,Gg(Pi,ki),ee);isNaN(Rt)&&(Rt=0);const Oe=Wi.sub(_i)._unit();_i=_i.add(Oe.mult(He))._round(),Wi=Wi.add(Oe.mult(-Rt))._round(),He=Rt,Pi=ki,at&&this.zoom>=17&&(Le(ai,_i)||ai.push(_i),Le(ai,Wi)||ai.push(Wi))}const fn=hi.vertexLength,Co=Me.length>4&&H_(_i,Wi,mr);let Ot=a0(dr,Ie,vi);if(ep(this.layoutVertexArray,_i.x,_i.y,rn,_r,0,0,Ot),ep(this.layoutVertexArray,_i.x,_i.y,rn,_r,0,1,Ot),this.wallMode){const Rt=Pt(pi-1,Me),Oe=yt.joinNormals[pi-1];Zp(this.wallVertexArray,Oe,Rt),Zp(this.wallVertexArray,Oe,Rt)}if(dr+=pn,Ot=a0(dr,Co,!vi),Ie=Co,ep(this.layoutVertexArray,Wi.x,Wi.y,rn,_r,0,0,Ot),ep(this.layoutVertexArray,Wi.x,Wi.y,rn,_r,0,1,Ot),this.wallMode){const Rt=Pt(pi,Me),Oe=yt.joinNormals[pi];Zp(this.wallVertexArray,Oe,Rt),Zp(this.wallVertexArray,Oe,Rt)}if(hi.vertexLength+=4,this.indexArray.emplaceBack(fn+0,fn+1,fn+2),this.indexArray.emplaceBack(fn+1,fn+3,fn+2),hi.primitiveLength+=2,ee){const Rt=Ue+(pi===1?Me.length-2:pi-2),Oe=pi===1?Ue:Rt+1;if(this.indexArray.emplaceBack(fn+1,Rt,fn+3),this.indexArray.emplaceBack(Rt,Oe,fn+3),hi.primitiveLength+=2,Ge===void 0&&(Ge=fn),!q_(mr,Me[pi],ke)){const di=pi===Me.length-1?Ge:hi.vertexLength;this.indexArray.emplaceBack(fn+2,fn+3,di),this.indexArray.emplaceBack(fn+3,di+1,di),this.indexArray.emplaceBack(fn+3,Oe,di+1),hi.primitiveLength+=3}vi=!vi}if($){const Rt=this.layoutVertexExtArray,Oe=O.projectTilePoint(_i.x,_i.y,m),di=O.projectTilePoint(Wi.x,Wi.y,m),Ne=O.upVector(m,_i.x,_i.y),fi=O.upVector(m,Wi.x,Wi.y);mm(Rt,Oe,Ne),mm(Rt,Oe,Ne),mm(Rt,di,fi),mm(Rt,di,fi)}}q&&(Ue+=Me.length-1),at&&ee&&this.zoom>=17&&(ai.length!==0&&Le(ai,ai[0])&&ai.pop(),this.groundEffect.addData(ai,ke,R,ee>0))}this.footprintSegments.push(je),Ke.triangleCount=this.indexArray.length-Ke.triangleArrayOffset,this.polygonSegments.push(Ke),++rt.footprintSegLen,++rt.polygonSegLen}if(rt.vertexCount=this.layoutVertexArray.length-rt.vertexArrayOffset,rt.groundVertexCount=this.groundEffect.vertexArray.length-rt.groundVertexArrayOffset,rt.vertexCount!==0){if(rt.centroidXY=Y.borders?Cf:this.encodeCentroid(Y,rt),this.centroidData.push(rt),Y.borders){this.featuresOnBorder.push(Y);const fe=this.featuresOnBorder.length-1;for(let ke=0;ke<Y.borders.length;ke++)Y.borders[ke][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ke].push(fe)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,r,u,_,b,m,P,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(r,u,_,b,m,P,this.worldview),this.maxHeight=Math.max(this.maxHeight,gt)}}sortBorders(){for(let t=0;t<this.borderFeatureIndices.length;t++)this.borderFeatureIndices[t].sort((r,l)=>this.featuresOnBorder[r].borders[t][0]-this.featuresOnBorder[l].borders[t][0])}splitToSubtiles(){const t=[];for(let b=0;b<this.centroidData.length;b++){const E=this.centroidData[b],P=+(E.min.y+E.max.y>ri),R=2*P+(+(E.min.x+E.max.x>ri)^P);for(let F=0;F<E.polygonSegLen;F++){const O=E.polygonSegIdx+F;t.push({centroidIdx:b,subtile:R,polygonSegmentIdx:O,triangleSegmentIdx:this.polygonSegments[O].triangleSegIdx})}}const r=new qn;t.sort((b,E)=>b.triangleSegmentIdx===E.triangleSegmentIdx?b.subtile-E.subtile:b.triangleSegmentIdx-E.triangleSegmentIdx);let l=0,u=0,m=0;for(const b of t){if(b.triangleSegmentIdx!==l)break;m++}const _=t.length;for(;u!==t.length;){l=t[u].triangleSegmentIdx;let b=0,E=u,P=u;for(let R=E;R<m&&t[R].subtile===b;R++)P++;for(;E!==m;){const R=t[E];b=R.subtile;const F=this.centroidData[R.centroidIdx].min.clone(),O=this.centroidData[R.centroidIdx].max.clone(),$={vertexOffset:this.segments.segments[l].vertexOffset,primitiveOffset:r.length,vertexLength:this.segments.segments[l].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let q=E;q<P;q++){const Y=t[q],rt=this.polygonSegments[Y.polygonSegmentIdx],at=this.centroidData[Y.centroidIdx].min,gt=this.centroidData[Y.centroidIdx].max,yt=this.indexArray.uint16;for(let Pt=rt.triangleArrayOffset;Pt<rt.triangleArrayOffset+rt.triangleCount;Pt++)r.emplaceBack(yt[3*Pt],yt[3*Pt+1],yt[3*Pt+2]);$.primitiveLength+=rt.triangleCount,F.x=Math.min(F.x,at.x),F.y=Math.min(F.y,at.y),O.x=Math.max(O.x,gt.x),O.y=Math.max(O.y,gt.y)}$.primitiveLength>0&&this.triangleSubSegments.push({segment:$,min:F,max:O}),E=P;for(let q=E;q<m&&t[q].subtile===t[E].subtile;q++)P++}u=m;for(let R=u;R<_&&t[R].triangleSegmentIdx===t[u].triangleSegmentIdx;R++)m++}r._trim(),this.indexArray=r}getVisibleSegments(t,r,l){const u=new po;if(this.wallMode){for(const Y of this.triangleSubSegments)u.segments.push(Y.segment);return u}let m=0,_=0;const b=1<<t.canonical.z;if(r){const Y=r.getMinMaxForTile(t);Y&&(m=Y.min,_=Y.max)}_+=this.maxHeight;const E=t.toUnwrapped();let P;const R=[E.canonical.x/b+E.wrap,E.canonical.y/b],F=[(E.canonical.x+1)/b+E.wrap,(E.canonical.y+1)/b],O=(Y,rt,at)=>[Y[0]*(1-at[0])+rt[0]*at[0],Y[1]*(1-at[1])+rt[1]*at[1]],$=[],q=[];for(const Y of this.triangleSubSegments){$[0]=Y.min.x/ri,$[1]=Y.min.y/ri,q[0]=Y.max.x/ri,q[1]=Y.max.y/ri;const rt=O(R,F,$),at=O(R,F,q);if(new Er([rt[0],rt[1],m],[at[0],at[1],_]).intersectsPrecise(l)===0){P&&(u.segments.push(P),P=void 0);continue}const gt=Y.segment;P&&P.vertexOffset!==gt.vertexOffset&&(u.segments.push(P),P=void 0),P?(P.vertexLength+=gt.vertexLength,P.primitiveLength+=gt.primitiveLength):P={vertexOffset:gt.vertexOffset,primitiveLength:gt.primitiveLength,vertexLength:gt.vertexLength,primitiveOffset:gt.primitiveOffset,sortKey:void 0,vaos:{}}}return P&&u.segments.push(P),u}encodeCentroid(t,r){const l=t.centroid(),u=r.span(),m=Math.min(7,Math.round(u.x*this.tileToMeter/10)),_=Math.min(7,Math.round(u.y*this.tileToMeter/10));return new Ae(tt(l.x,1,ri-1)<<3|m,tt(l.y,1,ri-1)<<3|_)}encodeBorderCentroid(t){if(!t.borders)return new Ae(0,0);const r=t.borders,l=Number.MAX_VALUE;if(r[0][0]!==l||r[1][0]!==l){const u=r[0][0]!==l?0:1;return new Ae(6|(r[0][0]!==l?0:65528),(r[u][0]+r[u][1])/2<<3|6)}{const u=r[2][0]!==l?2:3;return new Ae((r[u][0]+r[u][1])/2<<3|6,6|(r[2][0]!==l?0:65528))}}showCentroid(t){const r=this.centroidData[t.centroidDataIndex];r.flags&=2147483647,r.centroidXY.x=0,r.centroidXY.y=0,this.writeCentroidToBuffer(r)}writeCentroidToBuffer(t){this.groundEffect.updateHiddenByLandmark(t);const r=t.vertexArrayOffset,l=t.vertexCount+t.vertexArrayOffset,u=t.flags&tp?Cf:t.centroidXY,m=this.centroidVertexArray.geta_centroid_pos0(r);if(this.centroidVertexArray.geta_centroid_pos1(r)!==u.y||m!==u.x){for(let _=r;_<l;++_)this.centroidVertexArray.emplace(_,u.x,u.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of this.centroidData)this.writeCentroidToBuffer(t)}updateReplacement(t,r,l){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const u=r.getReplacementRegionsForTile(t.toUnwrapped());if(Mf(this.activeReplacements,u))return;if(this.activeReplacements=u,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const _ of this.centroidData)_.flags&=2147483647;const m=[];for(const _ of this.activeReplacements){if(_.order<l)continue;const b=Math.max(1,Math.pow(2,_.footprintTileId.canonical.z-t.canonical.z));if(_.footprint.buildingId){const E=_.footprint.buildingId;for(const P of this.centroidData)P.buildingId===E&&(P.flags|=tp)}else for(const E of this.centroidData)if(!(E.flags&tp||_.min.x>E.max.x||E.min.x>_.max.x||_.min.y>E.max.y||E.min.y>_.max.y))for(let P=0;P<E.footprintSegLen;P++){const R=this.footprintSegments[E.footprintSegIdx+P];if(m.length=0,lx(this.footprintVertices,R.vertexOffset,R.vertexCount,_.footprintTileId.canonical,t.canonical,m),Og(_.footprint,m,this.footprintIndices.uint16,R.indexOffset,R.indexCount,-R.vertexOffset,-b)){E.flags|=tp;break}}}for(const _ of this.centroidData)this.writeCentroidToBuffer(_);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(t,r,l){let u=!1;for(let m=0;m<l.footprintSegLen;m++){const _=this.footprintSegments[l.footprintSegIdx+m];let b=0;for(const E of _.ringIndices){for(let P=b,R=E+b-1;P<E+b;R=P++){const F=this.footprintVertices.int16[2*(P+_.vertexOffset)+0],O=this.footprintVertices.int16[2*(P+_.vertexOffset)+1],$=this.footprintVertices.int16[2*(R+_.vertexOffset)+1];O>r!=$>r&&t<(this.footprintVertices.int16[2*(R+_.vertexOffset)+0]-F)*(r-O)/($-O)+F&&(u=!u)}b=E}}return u}getHeightAtTileCoord(t,r){let l=Number.NEGATIVE_INFINITY,u=!0;const m=4*(t+ri)*ri+(r+ri);if(this.partLookup.hasOwnProperty(m)){const _=this.partLookup[m];return _?{height:_.height,hidden:!!(_.flags&tp)}:void 0}for(const _ of this.centroidData)t>_.max.x||_.min.x>t||r>_.max.y||_.min.y>r||_.height<=l||this.footprintContainsPoint(t,r,_)&&(l=_.height,this.partLookup[m]=_,u=!!(_.flags&tp));if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:u};this.partLookup[m]=void 0}}function Gg(n,t){const r=n.add(t)._unit();return n.x*r.x+n.y*r.y}function s0(n,t,r,l){const u=t.sub(n)._perp()._unit(),m=r.sub(t)._perp()._unit();return $_(n,t,r,Gg(u,m),l)}function $_(n,t,r,l,u){const m=Math.sqrt(1-l*l);return Math.min(n.dist(t)/3,t.dist(r)/3,u*m/l)}function q_(n,t,r){return n.x<r[0].x&&t.x<r[0].x||n.x>r[1].x&&t.x>r[1].x||n.y<r[0].y&&t.y<r[0].y||n.y>r[1].y&&t.y>r[1].y}function Z_(n,t){return n.x<t[0].x||n.x>t[1].x||n.y<t[0].y||n.y>t[1].y}function H_(n,t,r){if(n.x<0||n.x>=ri||t.x<0||t.x>=ri||r.x<0||r.x>=ri)return!1;const l=r.sub(t),u=l.perp(),m=n.sub(t);return(l.x*m.x+l.y*m.y)/Math.sqrt((l.x*l.x+l.y*l.y)*(m.x*m.x+m.y*m.y))>-.866&&u.x*m.x+u.y*m.y<0}function a0(n,t,r){const l=t?2|n:-3&n;return r?1|l:-2&l}function W_(){const n=Math.PI/32,t=Math.tan(n),r=N;return r*Math.sqrt(1+2*t*t)-r}function l0(n,t,r){const l=1<<r.z,u=Ct(r.x/l),m=Ct((r.x+1)/l),_=bt(r.y/l),b=bt((r.y+1)/l);return function(E,P,R,F,O=0,$){const q=[];if(!E.length||!R||!F)return q;const Y=(Bt,Yt)=>{for(const ee of Bt)q.push({polygon:ee,bounds:Yt})},rt=Math.ceil(Math.log2(R)),at=Math.ceil(Math.log2(F)),gt=rt-at,yt=[];for(let Bt=0;Bt<Math.abs(gt);Bt++)yt.push(gt>0?0:1);for(let Bt=0;Bt<Math.min(rt,at);Bt++)yt.push(0),yt.push(1);let Pt=E;if(Pt=Wm(Pt,P[0].y-O,P[1].y+O,1),Pt=Wm(Pt,P[0].x-O,P[1].x+O,0),!Pt.length)return q;const qt=[];for(yt.length?qt.push({polygons:Pt,bounds:P,depth:0}):Y(Pt,P);qt.length;){const Bt=qt.pop(),Yt=Bt.depth,ee=yt[Yt],ne=Bt.bounds[0],Le=Bt.bounds[1],fe=ee===0?ne.x:ne.y,ke=ee===0?Le.x:Le.y,Ue=$(ee,fe,ke),Ze=Wm(Bt.polygons,fe-O,Ue+O,ee),hi=Wm(Bt.polygons,Ue-O,ke+O,ee);if(Ze.length){const Ke=[ne,new Ae(ee===0?Ue:Le.x,ee===1?Ue:Le.y)];yt.length>Yt+1?qt.push({polygons:Ze,bounds:Ke,depth:Yt+1}):Y(Ze,Ke)}if(hi.length){const Ke=[new Ae(ee===0?Ue:ne.x,ee===1?Ue:ne.y),Le];yt.length>Yt+1?qt.push({polygons:hi,bounds:Ke,depth:Yt+1}):Y(hi,Ke)}}return q}(n,t,Math.ceil((m-u)/11.25),Math.ceil((_-b)/11.25),1,(E,P,R)=>{if(E===0)return .5*(P+R);{const F=bt((r.y+P/ri)/l);return(lt(.5*(bt((r.y+R/ri)/l)+F))*l-r.y)*ri}})}function lx(n,t,r,l,u,m){const _=Math.pow(2,l.z-u.z);for(let b=0;b<r;b++){let E=n.int16[2*(b+t)+0],P=n.int16[2*(b+t)+1];E=(E+u.x*ri)*_-l.x*ri,P=(P+u.y*ri)*_-l.y*ri,m.push(new Ae(E,P))}}let ip,X_;Si(vd,"FillExtrusionBucket",{omit:["layers","features"]}),Si(r0,"PartData"),Si(G_,"FootprintSegment"),Si(n0,"BorderCentroidData"),Si(jg,"GroundEffect");class Hp extends Ae{constructor(t,r,l){super(t,r),this.z=l}}class Y_ extends Hp{constructor(t,r,l,u){super(t,r,l),this.w=u}}function J_(n,t,r,l){const u=r==="x"?"y":"x",m=(l-n[r])/(t[r]-n[r]);n[u]=Math.round(n[u]+(t[u]-n[u])*m),n[r]=l,n.hasOwnProperty("z")&&(n.z=Vi(n.z,t.z,m)),n.hasOwnProperty("w")&&(n.w=Vi(n.w,t.w,m))}function c0(n,t,r,l){const u=r,m=l;for(const _ of["x","y"]){let b=n,E=t;b[_]>=E[_]&&(b=t,E=n),b[_]<u&&E[_]>u&&J_(b,E,_,u),b[_]<m&&E[_]>m&&J_(E,b,_,m)}}function $g(n,t,r,l,u,m){const _=[];for(let b=0;b<n.length;b++){const E=n[b];let P;const R=_.length;let F=0;for(let O=0;O<E.length-1;O++){let $=E[O],q=E[O+1],Y=0;const rt=F;let at,gt;m&&(Y=Math.hypot(q.x-$.x,q.y-$.y),F+=Y,at=$,gt=q),$.x<t&&q.x<t||($.x<t?$=new Ae(t,$.y+(t-$.x)/(q.x-$.x)*(q.y-$.y))._round():q.x<t&&(q=new Ae(t,$.y+(t-$.x)/(q.x-$.x)*(q.y-$.y))._round()),$.y<r&&q.y<r||($.y<r?$=new Ae($.x+(r-$.y)/(q.y-$.y)*(q.x-$.x),r)._round():q.y<r&&(q=new Ae($.x+(r-$.y)/(q.y-$.y)*(q.x-$.x),r)._round()),$.x>=l&&q.x>=l||($.x>=l?$=new Ae(l,$.y+(l-$.x)/(q.x-$.x)*(q.y-$.y))._round():q.x>=l&&(q=new Ae(l,$.y+(l-$.x)/(q.x-$.x)*(q.y-$.y))._round()),$.y>=u&&q.y>=u||($.y>=u?$=new Ae($.x+(u-$.y)/(q.y-$.y)*(q.x-$.x),u)._round():q.y>=u&&(q=new Ae($.x+(u-$.y)/(q.y-$.y)*(q.x-$.x),u)._round()),P&&$.equals(P[P.length-1])||(P=[$],_.push(P),m&&m.push({progress:{min:rt+K_(at,gt,$)*Y,max:1},parentIndex:b,prevPoint:at,nextPoint:gt})),P.push(q),m&&(m[m.length-1].progress.max=rt+K_(at,gt,q)*Y,m[m.length-1].nextPoint=gt)))))}if(m&&F>0)for(let O=R;O<_.length;O++)m[O].progress.min/=F,m[O].progress.max/=F}return _}function h0(n,t,r,l,u){if(n.length<2)return void l.push(n);const m=[];for(;t.valid();){const[P,R]=t.get();for(let F=0;F<n.length-1;F++){const O=n[F],$=n[F+1],q=tc(O,$,P,R);if(q){const[Y]=q,rt=new Ae(Vi(O.x,$.x,Y),Vi(O.y,$.y,Y));m.push({t:F+Y,distance:0,point:rt})}}t.next()}if(m.length===0)return void l.push(n);m.sort((P,R)=>P.t-R.t);let _=0,b=0,E=[];for(l.push(E);_!==n.length;){if(b===m.length){for(;_!==n.length;)E.length!==0&&E[E.length-1].equals(n[_])||E.push(n[_]),_++;break}m[b].t<=_?(E.length!==0&&E[E.length-1].equals(m[b].point)||E.push(m[b].point),Math.trunc(m[b].t),b++):(E.length!==0&&E[E.length-1].equals(n[_])||E.push(n[_]),_++)}}function K_(n,t,r){return n.x!==t.x?(r.x-n.x)/(t.x-n.x):n.y!==t.y?(r.y-n.y)/(t.y-n.y):0}function Wp(n,t){return n.x*t.x+n.y*t.y}function Q_(n,t){if(n.length===1){let r=0;const l=t[r++];let u;for(;!u||l.equals(u);)if(u=t[r++],!u)return 1/0;for(;r<t.length;r++){const m=t[r],_=n[0],b=u.sub(l),E=m.sub(l),P=_.sub(l),R=Wp(b,b),F=Wp(b,E),O=Wp(E,E),$=Wp(P,b),q=Wp(P,E),Y=R*O-F*F,rt=(O*$-F*q)/Y,at=(R*q-F*$)/Y,gt=l.z*(1-rt-at)+u.z*rt+m.z*at;if(isFinite(gt))return gt}return 1/0}{let r=1/0;for(const l of t)r=Math.min(r,l.z);return r}}function Ym(n,t,r){let l=1/0;Ro(r,t)&&(l=Q_(r,t[0]));for(let u=0;u<t.length;u++){const m=t[u],_=n[u];for(let b=0;b<m.length-1;b++){const E=m[b],P=[E,m[b+1],_[b+1],_[b],E];Uo(r,P)&&(l=Math.min(l,Q_(r,P)))}}return l!==1/0&&l}function Jm(n,t,r,l,u,m,_,b,E,P,R){return n.projection.name==="globe"?function(F,O,$,q,Y,rt,at,gt,yt,Pt,qt){const Bt=[],Yt=[],ee=F.projection.upVectorScale(qt,F.center.lat,F.worldSize).metersToTile,ne=[0,0,0,1],Le=[0,0,0,1],fe=(Ue,Ze,hi,Ke)=>{Ue[0]=Ze,Ue[1]=hi,Ue[2]=Ke,Ue[3]=1},ke=W_();$>0&&($+=ke),q+=ke;for(const Ue of O){const Ze=[],hi=[];for(const Ke of Ue){const je=Ke.x+Y.x,Ye=Ke.y+Y.y,Me=F.projection.projectTilePoint(je,Ye,qt),Ie=F.projection.upVector(qt,Ke.x,Ke.y);let He=$,ai=q;if(at){const Ge=Km(je,Ye,$,q,at,gt,yt,Pt);He+=Ge.base,ai+=Ge.top}$!==0?fe(ne,Me.x+Ie[0]*ee*He,Me.y+Ie[1]*ee*He,Me.z+Ie[2]*ee*He):fe(ne,Me.x,Me.y,Me.z),fe(Le,Me.x+Ie[0]*ee*ai,Me.y+Ie[1]*ee*ai,Me.z+Ie[2]*ee*ai),Kn(ne,ne,rt),Kn(Le,Le,rt),Ze.push(new Hp(ne[0],ne[1],ne[2])),hi.push(new Hp(Le[0],Le[1],Le[2]))}Bt.push(Ze),Yt.push(hi)}return[Bt,Yt]}(n,t,r,l,u,m,_,b,E,P,R):_?function(F,O,$,q,Y,rt,at,gt,yt){const Pt=[],qt=[],Bt=[0,0,0,1];for(const Yt of F){const ee=[],ne=[];for(const Le of Yt){const fe=Le.x+q.x,ke=Le.y+q.y,Ue=Km(fe,ke,O,$,rt,at,gt,yt);Bt[0]=fe,Bt[1]=ke,Bt[2]=Ue.base,Bt[3]=1,ds(Bt,Bt,Y),Bt[3]=Math.max(Bt[3],1e-5);const Ze=new Hp(Bt[0]/Bt[3],Bt[1]/Bt[3],Bt[2]/Bt[3]);Bt[0]=fe,Bt[1]=ke,Bt[2]=Ue.top,Bt[3]=1,ds(Bt,Bt,Y),Bt[3]=Math.max(Bt[3],1e-5);const hi=new Hp(Bt[0]/Bt[3],Bt[1]/Bt[3],Bt[2]/Bt[3]);ee.push(Ze),ne.push(hi)}Pt.push(ee),qt.push(ne)}return[Pt,qt]}(t,r,l,u,m,_,b,E,P):function(F,O,$,q,Y){const rt=[],at=[],gt=Y[8]*O,yt=Y[9]*O,Pt=Y[10]*O,qt=Y[11]*O,Bt=Y[8]*$,Yt=Y[9]*$,ee=Y[10]*$,ne=Y[11]*$;for(const Le of F){const fe=[],ke=[];for(const Ue of Le){const Ze=Ue.x+q.x,hi=Ue.y+q.y,Ke=Y[0]*Ze+Y[4]*hi+Y[12],je=Y[1]*Ze+Y[5]*hi+Y[13],Ye=Y[2]*Ze+Y[6]*hi+Y[14],Me=Y[3]*Ze+Y[7]*hi+Y[15],Ie=Ke+gt,He=je+yt,ai=Ye+Pt,Ge=Math.max(Me+qt,1e-5),Pi=Ke+Bt,ki=je+Yt,vi=Ye+ee,pi=Math.max(Me+ne,1e-5);fe.push(new Hp(Ie/Ge,He/Ge,ai/Ge)),ke.push(new Hp(Pi/pi,ki/pi,vi/pi))}rt.push(fe),at.push(ke)}return[rt,at]}(t,r,l,u,m)}function Km(n,t,r,l,u,m,_,b){const E=_*u.getElevationAt(n,t,!0,!0),P=m[0]!==0,R=P?m[1]===0?_*(m[0]/fm-i0):_*function(F,O,$){const q=Math.floor(O[0]/8),Y=Math.floor(O[1]/8),rt=10*(O[0]-8*q),at=10*(O[1]-8*Y),gt=F.getElevationAt(q,Y,!0,!0),yt=F.getMeterToDEM($),Pt=Math.floor(.5*(rt*yt-1)),qt=Math.floor(.5*(at*yt-1)),Bt=F.tileCoordToPixel(q,Y),Yt=2*Pt+1,ee=2*qt+1,ne=function(hi,Ke,je,Ye,Me){return[hi.getElevationAtPixel(Ke,je,!0),hi.getElevationAtPixel(Ke+Me,je,!0),hi.getElevationAtPixel(Ke,je+Me,!0),hi.getElevationAtPixel(Ke+Ye,je+Me,!0)]}(F,Bt.x-Pt,Bt.y-qt,Yt,ee),Le=Math.abs(ne[0]-ne[1]),fe=Math.abs(ne[2]-ne[3]),ke=Math.abs(ne[0]-ne[2])+Math.abs(ne[1]-ne[3]),Ue=Math.min(.25,.5*yt*(Le+fe)/Yt),Ze=Math.min(.25,.5*yt*ke/ee);return gt+Math.max(Ue*rt,Ze*at)}(u,m,b):E;return{base:E+(r===0?-1:r),top:P?Math.max(R+l,E+r+2):E+l}}class cx{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class hx{constructor(){this.tasks={},this.taskQueue=[],xe(["process"],this),this.invoker=new cx(this.process),this.nextId=0}add(t,r){const l=this.nextId++,u=function({type:m,isSymbolTile:_,zoom:b}){return b=b||0,m==="message"?0:m!=="maybePrepare"||_?m!=="parseTile"||_?m==="parseTile"&&_?300-b:m==="maybePrepare"&&_?400-b:500:200-b:100-b}(r);if(u===0){try{t()}finally{}return null}return this.tasks[l]={fn:t,metadata:r,priority:u,id:l},this.taskQueue.push(l),this.invoker.trigger(),{cancel:()=>{delete this.tasks[l]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(l=>!!this.tasks[l]),!this.taskQueue.length)return;const t=this.pick();if(t===null)return;const r=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!r)return;r.fn()}finally{}}pick(){let t=null,r=1/0;for(let u=0;u<this.taskQueue.length;u++){const m=this.tasks[this.taskQueue[u]];m.priority<r&&(r=m.priority,t=u)}if(t===null)return null;const l=this.taskQueue[t];return this.taskQueue.splice(t,1),l}remove(){this.invoker.remove()}}class u0{constructor(t,r,l){this.target=t,this.parent=r,this.mapId=l,this.callbacks={},this.cancelCallbacks={},xe(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new hx}send(t,r,l,u,m=!1,_){const b=Math.round(1e18*Math.random()).toString(36).substring(0,10);l&&(l.metadata=_,this.callbacks[b]=l);const E=new Set;return this.target.postMessage({id:b,type:t,hasCallback:!!l,targetMapId:u,mustQueue:m,sourceMapId:this.mapId,data:Nc(r,E)},E),{cancel:()=>{l&&delete this.callbacks[b],this.target.postMessage({id:b,type:"<cancel>",targetMapId:u,sourceMapId:this.mapId})}}}receive(t){const r=t.data;if(!r)return;const l=r.id;if(l&&(!r.targetMapId||this.mapId===r.targetMapId))if(r.type==="<cancel>"){const u=this.cancelCallbacks[l];delete this.cancelCallbacks[l],u&&u.cancel()}else if(r.mustQueue||Pn(self)){const u=this.callbacks[l],m=this.scheduler.add(()=>this.processTask(l,r),u&&u.metadata||{type:"message"});m&&(this.cancelCallbacks[l]=m)}else this.processTask(l,r)}processTask(t,r){if(delete this.cancelCallbacks[t],r.type==="<response>"){const l=this.callbacks[t];delete this.callbacks[t],l&&(r.error?l(Vc(r.error)):l(null,Vc(r.data)))}else{const l=new Set,u=r.hasCallback?(_,b)=>{this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:_?Nc(_):null,data:Nc(b,l)},l)}:()=>{},m=Vc(r.data);if(this.parent[r.type])this.parent[r.type](r.sourceMapId,m,u);else if(this.parent.getWorkerSource){const _=r.type.split("."),{source:b,scope:E}=m;this.parent.getWorkerSource(r.sourceMapId,_[0],b,E)[_[1]](m,u)}else u(new Error(`Could not find function ${r.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var bd={workerUrl:"",workerClass:null,workerParams:void 0};const Oa="mapboxgl_preloaded_worker_pool";class rp{constructor(){this.active={}}acquire(t,r=rp.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<r;)this.workers.push(bd.workerClass!=null?new bd.workerClass:new self.Worker(bd.workerUrl,bd.workerParams));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.workers&&this.numActive()===0&&(this.workers.forEach(r=>{r.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Oa]}numActive(){return Object.keys(this.active).length}}rp.workerCount=2;class Df{constructor(t,r,l="Worker",u=rp.workerCount){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=ye();const m=this.workerPool.acquire(this.id,u);for(let _=0;_<m.length;_++){const b=new Df.Actor(m[_],r,this.id);b.name=`${l} ${_}`,this.actors.push(b)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(t,r,l){Wt(this.actors,(u,m)=>{u.send(t,r,m)},l=l||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(t=>{t.remove()}),this.actors=[],this.workerPool.release(this.id)}}let gm,Qm;function qg(){return gm||(gm=new rp),gm}Df.Actor=u0;class d0{constructor(t){this.module=t}createIntArray(t){const r=new Int32Array(t),l=this.module.malloc(r.length*r.BYTES_PER_ELEMENT);return this.module.heap32.set(r,l/r.BYTES_PER_ELEMENT),l}createFloatArray(t){const r=new Float32Array(t),l=this.module.malloc(r.length*r.BYTES_PER_ELEMENT);return this.module.heapF32.set(r,l/r.BYTES_PER_ELEMENT),l}createStringBuffer(t){const r=this.module.malloc(t.length+1);for(let l=0;l<t.length;++l)this.module.heapU8[r+l]=t.charCodeAt(l);return this.module.heapU8[r+t.length]=0,r}readStringBuffer(t){let r="";for(;this.module.heapU8[t]!==0;)r+=String.fromCharCode(this.module.heapU8[t]),++t;return r}setStyle(t){const r=t.entranceColorRgb,l=t.facadeGlazingColorRgb,u=t.roofColorRgb,m=t.wallColorRgb,_=t.normalScale;this.module.setStyle(r[0],r[1],r[2],l[0],l[1],l[2],u[0],u[1],u[2],m[0],m[1],m[2],_[0],_[1],_[2],t.tileToMeters)}setAOOptions(t,r){this.module.setAOOptions(t?1:0,r)}setMetricOptions(t,r){this.module.setMetricOptions(t?1:0,r)}setStructuralOptions(t){this.module.setStructuralOptions(t?1:0)}setFacadeOptions(t,r){this.module.setFacadeOptions(t,r?1:0)}setFauxFacadeOptions(t,r,l){this.module.setFauxFacadeOptions(t?1:0,r?1:0,l)}setFacadeClassifierOptions(t){this.module.setFacadeClassifierOptions(t)}generateMesh(t,r){for(const b of t){const E=this.createStringBuffer(b.roofType),P=[0],R=[];for(const $ of b.coordinates)if(Array.isArray($)){for(const q of $)R.push(q.x),R.push(q.y);P.push(R.length)}const F=this.createIntArray(P),O=this.createFloatArray(R);this.module.addFeature(b.id,b.sourceId,b.minHeight,b.height,E,b.roofType.length,O,F,P.length-1),this.module.free(E),this.module.free(F),this.module.free(O)}for(const b of r){let E;E=b.entrances?JSON.parse(b.entrances):[];const P=this.createFloatArray(E),R=[];for(const O of b.coordinates)R.push(O.x),R.push(O.y);const F=this.createFloatArray(R);this.module.addFacade(b.sourceId,b.crossPerc,b.distanceToRoad,P,E.length,F,R.length),this.module.free(P),this.module.free(F)}if(!this.module.generateMesh()){const b=this.module.getLastError();return this.readStringBuffer(b)}const l=this.module.getMeshCount(),u=new Array(l);for(let b=0;b<l;b++){const E=this.module.getPositionsPtr(b),P=this.module.getPositionsLength(b),R=new Float32Array(this.module.heapF32.buffer,E,P),F=this.module.getNormalsPtr(b),O=this.module.getNormalsLength(b),$=new Float32Array(this.module.heapF32.buffer,F,O),q=this.module.getColorsPtr(b),Y=this.module.getColorsLength(b),rt=new Uint8Array(this.module.heapU8.buffer,q,Y),at=this.module.getAOPtr(b),gt=this.module.getAOLength(b),yt=new Float32Array(this.module.heapF32.buffer,at,gt),Pt=this.module.getUVPtr(b),qt=this.module.getUVLength(b),Bt=new Float32Array(this.module.heapF32.buffer,Pt,qt),Yt=this.module.getFauxFacadePtr(b),ee=this.module.getFauxFacadeLength(b),ne=new Uint8Array(this.module.heapU8.buffer,Yt,ee),Le=this.module.getIndicesPtr(b),fe=this.module.getIndicesLength(b),ke=new Int32Array(this.module.heap32.buffer,Le,fe),Ue=this.module.getBuildingPart(b),Ze=this.readStringBuffer(Ue);u[b]={positions:R,normals:$,colors:rt,ao:yt,uv:Bt,isFauxFacade:ne,indices:ke,buildingPart:Ze}}const m=this.module.getRingCount(),_=[];for(let b=0;b<m;b++){const E=this.module.getRingPtr(b),P=this.module.getRingLength(b),R=new Float32Array(this.module.heapF32.buffer,E,P);_.push(R)}return{meshes:u,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:_}}}let _m,ty,iu,Xp,tg,zf=null,wd=null,Zg=null,eg=null;function Hg(){return Pn(self)&&self.worker.dracoUrl?self.worker.dracoUrl:ty||Gn.DRACO_URL}function ig(){if(Pn(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Xp)return Xp;const n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Xp=WebAssembly.validate(n)?Gn.MESHOPT_SIMD_URL:Gn.MESHOPT_URL,Xp}function rg(){return eg}const ym={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ey={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Lf={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function p0(n,t,r){const l=r.json.bufferViews.length,u=r.buffers.length;t.bufferView=l,r.json.bufferViews[l]={buffer:u,byteLength:n.byteLength},r.buffers[u]=n}const h="KHR_draco_mesh_compression";function o(n,t){const r=n.extensions&&n.extensions[h];if(!r)return;const l=new iu.Decoder,u=B(t,r.bufferView),m=new iu.Mesh;if(!l.DecodeArrayToMesh(u,u.byteLength,m))throw new Error("Failed to decode Draco mesh");const _=t.json.accessors[n.indices],b=ym[_.componentType],E=_.count*b.BYTES_PER_ELEMENT,P=iu._malloc(E);b===Uint16Array?l.GetTrianglesUInt16Array(m,E,P):l.GetTrianglesUInt32Array(m,E,P),p0(iu.memory.buffer.slice(P,P+E),_,t),iu._free(P);for(const R of Object.keys(r.attributes)){const F=l.GetAttributeByUniqueId(m,r.attributes[R]),O=t.json.accessors[n.attributes[R]],$=ey[O.componentType],q=O.count*Lf[O.type]*ym[O.componentType].BYTES_PER_ELEMENT,Y=iu._malloc(q);l.GetAttributeDataArrayForAllPoints(m,F,iu[$],q,Y),p0(iu.memory.buffer.slice(Y,Y+q),O,t),iu._free(Y)}l.destroy(),m.destroy(),delete n.extensions[h]}const c="EXT_meshopt_compression";function g(n,t){if(!n.extensions||!n.extensions[c])return;const r=n.extensions[c],l=new Uint8Array(t.buffers[r.buffer],r.byteOffset||0,r.byteLength||0),u=new Uint8Array(r.count*r.byteStride);tg.decodeGltfBuffer(u,r.count,r.byteStride,l,r.mode,r.filter),n.buffer=t.buffers.length,n.byteOffset=0,t.buffers[n.buffer]=u.buffer,delete n.extensions[c]}const x=1179937895,T=new TextDecoder("utf8");function A(n,t){return new URL(n,t).href}function z(n,t,r,l){return fetch(A(n.uri,l)).then(u=>u.arrayBuffer()).then(u=>{t.buffers[r]=u})}function B(n,t){const r=n.json.bufferViews[t];return new Uint8Array(n.buffers[r.buffer],r.byteOffset||0,r.byteLength)}function G(n,t,r,l){if(n.uri){const u=A(n.uri,l);return fetch(u).then(m=>m.blob()).then(m=>createImageBitmap(m)).then(m=>{t.images[r]=m})}if(n.bufferView!==void 0){const u=B(t,n.bufferView),m=new Blob([u],{type:n.mimeType});return createImageBitmap(m).then(_=>{t.images[r]=_})}}function W(n,t=0,r){const l={json:null,images:[],buffers:[]};if(new Uint32Array(n,t,1)[0]===x){const R=new Uint32Array(n,t);let F=2;const O=(R[F++]>>2)-3,$=R[F++]>>2;if(F++,l.json=JSON.parse(T.decode(R.subarray(F,F+$))),F+=$,F<O){const q=R[F++];F++;const Y=t+(F<<2);l.buffers[0]=n.slice(Y,Y+q)}}else l.json=JSON.parse(T.decode(new Uint8Array(n,t)));const{buffers:u,images:m,meshes:_,extensionsUsed:b,bufferViews:E}=l.json;let P=Promise.resolve();if(u){const R=[];for(let F=0;F<u.length;F++){const O=u[F];O.uri?R.push(z(O,l,F,r)):l.buffers[F]||(l.buffers[F]=null)}P=Promise.all(R)}return P.then(()=>{const R=[],F=b&&b.includes(h),O=b&&b.includes(c);if(F&&R.push(function(){if(!iu)return _m??(_m=function($){let q,Y=null;function rt(){q=new Uint8Array(Y.buffer)}function at(){throw new Error("Unexpected Draco error.")}const gt={a:{a:at,d:function(yt,Pt,qt){return q.copyWithin(yt,Pt,Pt+qt)},c:function(yt){const Pt=q.length,qt=Math.max(yt>>>0,Math.ceil(1.2*Pt)),Bt=Math.ceil((qt-Pt)/65536);try{return Y.grow(Bt),rt(),!0}catch{return!1}},b:at}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming($,gt):$.then(yt=>yt.arrayBuffer()).then(yt=>WebAssembly.instantiate(yt,gt))).then(yt=>{const{Rb:Pt,Qb:qt,P:Bt,T:Yt,X:ee,Ja:ne,La:Le,Qa:fe,Va:ke,Wa:Ue,eb:Ze,jb:hi,f:Ke,e:je,yb:Ye,zb:Me,Ab:Ie,Bb:He,Db:ai,Gb:Ge}=yt.instance.exports;Y=je;const Pi=(()=>{let ki=0,vi=0,pi=0,dr=0;return _i=>{pi&&(Pt(dr),Pt(ki),vi+=pi,pi=ki=0),ki||(vi+=128,ki=qt(vi));const Wi=_i.length+7&-8;let mr=ki;Wi>=vi&&(pi=Wi,mr=dr=qt(Wi));for(let Lr=0;Lr<_i.length;Lr++)q[mr+Lr]=_i[Lr];return mr}})();return rt(),Ke(),{memory:je,_free:Pt,_malloc:qt,Mesh:class{constructor(){this.ptr=Bt()}destroy(){Yt(this.ptr)}},Decoder:class{constructor(){this.ptr=ne()}destroy(){hi(this.ptr)}DecodeArrayToMesh(ki,vi,pi){const dr=Pi(ki),_i=Le(this.ptr,dr,vi,pi.ptr);return!!ee(_i)}GetAttributeByUniqueId(ki,vi){return{ptr:fe(this.ptr,ki.ptr,vi)}}GetTrianglesUInt16Array(ki,vi,pi){ke(this.ptr,ki.ptr,vi,pi)}GetTrianglesUInt32Array(ki,vi,pi){Ue(this.ptr,ki.ptr,vi,pi)}GetAttributeDataArrayForAllPoints(ki,vi,pi,dr,_i){Ze(this.ptr,ki.ptr,vi.ptr,pi,dr,_i)}},DT_INT8:Ye(),DT_UINT8:Me(),DT_INT16:Ie(),DT_UINT16:He(),DT_UINT32:ai(),DT_FLOAT32:Ge()}})}(fetch(Hg())),_m.then($=>{iu=$,_m=void 0}))}()),O&&R.push(function(){if(tg)return;const $=function(q){let Y;const rt=WebAssembly.instantiateStreaming(q,{}).then(yt=>{Y=yt.instance,Y.exports.__wasm_call_ctors()}),at={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},gt={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:rt,supported:!0,decodeGltfBuffer(yt,Pt,qt,Bt,Yt,ee){(function(ne,Le,fe,ke,Ue,Ze,hi){const Ke=ne.exports.sbrk,je=ke+3&-4,Ye=Ke(je*Ue),Me=Ke(Ze.length),Ie=new Uint8Array(ne.exports.memory.buffer);Ie.set(Ze,Me);const He=Le(Ye,ke,Ue,Me,Ze.length);if(He===0&&hi&&hi(Ye,je,Ue),fe.set(Ie.subarray(Ye,Ye+ke*Ue)),Ke(Ye-Ke(0)),He!==0)throw new Error(`Malformed buffer data: ${He}`)})(Y,Y.exports[gt[Yt]],yt,Pt,qt,Bt,Y.exports[at[ee]])}}}(fetch(ig()));return $.ready.then(()=>{tg=$})}()),m)for(let $=0;$<m.length;$++)R.push(G(m[$],l,$,r));return(R.length?Promise.all(R):Promise.resolve()).then(()=>{if(F&&_)for(const{primitives:$}of _)for(const q of $)o(q,l);if(O&&_&&E)for(const $ of E)g($,l);return l})})}function K(n){return fetch(n).then(t=>t.arrayBuffer()).then(t=>W(t,0,n))}function ot(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function ct(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class dt{constructor(t,r,l,u){this.context=t,this.format=l,this.useMipmap=u&&u.useMipmap,this.texture=t.gl.createTexture(),this.update(r,{premultiply:u&&u.premultiply})}update(t,r){const l=t&&t instanceof HTMLVideoElement&&t.width===0?t.videoWidth:t.width,u=t&&t instanceof HTMLVideoElement&&t.height===0?t.videoHeight:t.height,{context:m}=this,{gl:_}=m,{x:b,y:E}=r&&r.position?r.position:{x:0,y:0},P=b+l,R=E+u;!this.size||this.size[0]===P&&this.size[1]===R||(_.bindTexture(_.TEXTURE_2D,null),_.deleteTexture(this.texture),this.texture=_.createTexture(),this.size=null),_.bindTexture(_.TEXTURE_2D,this.texture),m.pixelStoreUnpackFlipY.set(!1),m.pixelStoreUnpack.set(1),m.pixelStoreUnpackPremultiplyAlpha.set(this.format===_.RGBA8&&(!r||r.premultiply!==!1));const F=t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||ImageBitmap&&t instanceof ImageBitmap;if(!this.size&&P>0&&R>0){const O=this.useMipmap?Math.floor(Math.log2(Math.max(P,R)))+1:1;_.texStorage2D(_.TEXTURE_2D,O,this.format,P,R),this.size=[P,R]}this.size&&(F?_.texSubImage2D(_.TEXTURE_2D,0,b,E,ot(this.format),ct(this.format),t):"data"in t&&t.data&&_.texSubImage2D(_.TEXTURE_2D,0,b,E,l,u,ot(this.format),ct(this.format),t.data)),this.useMipmap&&_.generateMipmap(_.TEXTURE_2D)}bind(t,r,l=!1){const{context:u}=this,{gl:m}=u;m.bindTexture(m.TEXTURE_2D,this.texture),t!==this.minFilter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,t),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap&&!l?t===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_LINEAR:t),this.minFilter=t),r!==this.wrapS&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,r),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,r),this.wrapS=r)}bindExtraParam(t,r,l,u,m){const{context:_}=this,{gl:b}=_;b.bindTexture(b.TEXTURE_2D,this.texture),r!==this.magFilter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,r),this.magFilter=r),t!==this.minFilter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,this.useMipmap?t===b.NEAREST?b.NEAREST_MIPMAP_NEAREST:b.LINEAR_MIPMAP_LINEAR:t),this.minFilter=t),l!==this.wrapS&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,l),this.wrapS=l),u!==this.wrapT&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,u),this.wrapT=u),m!==this.compareMode&&(m?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_COMPARE_MODE,b.COMPARE_REF_TO_TEXTURE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_COMPARE_FUNC,m)):b.texParameteri(b.TEXTURE_2D,b.TEXTURE_COMPARE_MODE,b.NONE),this.compareMode=m)}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class xt{constructor(t,r){this.context=t,this.texture=r}bind(t,r){const{context:l}=this,{gl:u}=l;u.bindTexture(u.TEXTURE_2D,this.texture),t!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,t),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,t),this.minFilter=t),r!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,r),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,r),this.wrapS=r)}}const At=vr([{name:"a_pos_3f",components:3,type:"Float32"}]),jt=vr([{name:"a_color_3f",components:3,type:"Float32"}]),ue=vr([{name:"a_color_4f",components:4,type:"Float32"}]),Qt=vr([{name:"a_uv_2f",components:2,type:"Float32"}]),ie=vr([{name:"a_normal_3f",components:3,type:"Float32"}]),Se=vr([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Ee=vr([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function ei(n,t){const r=mi(n.projection,n.zoom,n.width,n.height),l=function(m,_,b,E,P){const R=new Z(b.lng-180*Ei,b.lat),F=new Z(b.lng+180*Ei,b.lat),O=m.project(R.lng,R.lat),$=m.project(F.lng,F.lat),q=-Math.atan2($.y-O.y,$.x-O.x),Y=pe.fromLngLat(b);Y.y=tt(Y.y,-1+Ei,1-Ei);const rt=Y.toLngLat(),at=m.project(rt.lng,rt.lat),gt=pe.fromLngLat(rt);gt.x+=Ei;const yt=gt.toLngLat(),Pt=m.project(yt.lng,yt.lat),qt=Ui(Pt.x-at.x,Pt.y-at.y,q),Bt=pe.fromLngLat(rt);Bt.y+=Ei;const Yt=Bt.toLngLat(),ee=m.project(Yt.lng,Yt.lat),ne=Ui(ee.x-at.x,ee.y-at.y,q),Le=Math.abs(qt.x)/Math.abs(ne.y),fe=Ve([]);Do(fe,fe,-q*(1-(P?0:E)));const ke=Ve([]);return Fn(ke,ke,[1,1-(1-Le)*E,1]),ke[4]=-ne.x/ne.y*E,Do(ke,ke,q),gr(ke,fe,ke),ke}(n.projection,0,n.center,r,t),u=Ai(n);return Fn(l,l,[u,u,1]),l}function Ai(n){const t=n.projection,r=mi(n.projection,n.zoom,n.width,n.height),l=Hi(t,n.center),u=Hi(t,Z.convert(t.center));return Math.pow(2,l*r+(1-r)*u)}function mi(n,t,r,l,u=1/0){const m=n.range;if(!m)return 0;const _=Math.min(u,Math.max(r,l)),b=Math.log2(_/1024);return Tt(m[0]+b,m[1]+b,t)}const Ei=1/4e4;function Hi(n,t){const r=tt(t.lat,-zt,zt),l=new Z(t.lng-180*Ei,r),u=new Z(t.lng+180*Ei,r),m=n.project(l.lng,r),_=n.project(u.lng,r),b=pe.fromLngLat(l),E=pe.fromLngLat(u),P=_.x-m.x,R=_.y-m.y,F=E.x-b.x,O=E.y-b.y,$=Math.sqrt((F*F+O*O)/(P*P+R*R));return Math.log2($)}function Ui(n,t,r){const l=Math.cos(r),u=Math.sin(r);return{x:n*l-t*u,y:n*u+t*l}}function ji(n,t,r){Ve(n),Do(n,n,rr(t[2])),us(n,n,rr(t[0])),ao(n,n,rr(t[1])),Fn(n,n,r),gr(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function gi(n,t,r,l,u,m,_,b){const E=[r[0]-t[0],r[1]-t[1],0],P=[l[0]-t[0],l[1]-t[1],0];if(ws(E)<1e-12||ws(P)<1e-12)return il(n);const R=qo([],E,P);bn(R,R),Ln(P,l,t),E[2]=(m-u)*b,P[2]=(_-u)*b;const F=E;return qo(F,E,P),bn(F,F),Aa(n,R,F)}function Ar(n,t,r=!1){const l=Du(t.zoom),u=function(m,_,b){const E=_.worldSize,P=[m[12],m[13],m[14]],R=bt(P[1]/E),F=Ct(P[0]/E),O=Ve([]),$=_t(1,R)*E,q=_t(1,0)*E*Vt(R,_.zoom),Y=1/Ig(E);let rt=q*Y;if(b){const Pt=mi(_.projection,_.zoom,_.width,_.height,1024);rt=Y*_.projection.pixelSpaceConversion(_.center.lat,E,Pt)}const at=L(R,F);Fo(at,at,Jn([],bn([],at),$*rt*P[2]));const gt=function(Pt){const qt=[Pt[0],Pt[1],Pt[2]];let Bt=[0,1,0];const Yt=qo([],Bt,qt);return qo(Bt,qt,Yt),ja(Bt)===0&&(Bt=[0,1,0],qo(Yt,qt,Bt)),bn(Yt,Yt),bn(Bt,Bt),bn(qt,qt),[Yt[0],Yt[1],Yt[2],0,Bt[0],Bt[1],Bt[2],0,qt[0],qt[1],qt[2],0,Pt[0],Pt[1],Pt[2],1]}(at);Fn(O,O,[rt,rt,rt*$]),Yr(O,O,[-P[0],-P[1],-P[2]]);const yt=gr([],_.globeMatrix,gt);return gr(yt,yt,O),gr(yt,yt,m),yt}(n,t,r);if(l>0){const m=function(_,b){const E=b.worldSize,P=_t(1,0)*E*Vt(b.center.lat,b.zoom)/Ig(E),R=_t(1,b.center.lat)*E,F=Ve([]);ao(F,F,rr(b.center.lng)),us(F,F,rr(b.center.lat)),Yr(F,F,[0,0,gl]),Fn(F,F,[P,P,P*R]);const O=b.point;return Yr(F,F,[-O.x,-O.y,0]),gr(F,F,_),gr(F,b.globeMatrix,F)}(n,t);return function(_,b,E){const P=(q,Y,rt)=>{const at=ws(q),gt=ws(Y),yt=md(q,Y,rt);return Jn(yt,yt,1/ws(yt)*Vi(at,gt,rt))},R=P([_[0],_[1],_[2]],[b[0],b[1],b[2]],E),F=P([_[4],_[5],_[6]],[b[4],b[5],b[6]],E),O=P([_[8],_[9],_[10]],[b[8],b[9],b[10]],E),$=md([_[12],_[13],_[14]],[b[12],b[13],b[14]],E);return[R[0],R[1],R[2],0,F[0],F[1],F[2],0,O[0],O[1],O[2],0,$[0],$[1],$[2],1]}(u,m,l)}return u}function Pr(n,t,r,l){const u=Er.projectAabbCorners(l,r);let m=Number.MAX_VALUE;for(let b=0;b<u.length;++b){const E=u[b];E[0]=(.5*E[0]+.5)*t.width,E[1]=(.5-.5*E[1])*t.height,E[2]<m&&(m=E[2])}const _=function(b){const E=[];let P=0;for(let $=1;$<b.length;$++)(b[$][0]<b[P][0]||b[$][0]===b[P][0]&&b[$][1]<b[P][1])&&(P=$);let R,F=P;const O=new Uint8Array(b.length);do{if(O[F])break;E.push(new Ae(b[F][0],b[F][1])),O[F]=1,R=(F+1)%b.length;for(let $=0;$<b.length;$++){if(b[$][0]===b[R][0]&&b[$][1]===b[R][1]||b[$][0]===b[F][0]&&b[$][1]===b[F][1])continue;const q=[b[$][0]-b[F][0],b[$][1]-b[F][1]],Y=[b[R][0]-b[F][0],b[R][1]-b[F][1]],rt=q[0]*Y[1]-q[1]*Y[0];(rt>0||rt===0&&q[0]*Y[0]+q[1]*Y[1]>=0&&q[0]*q[0]+q[1]*q[1]>Y[0]*Y[0]+Y[1]*Y[1])&&(R=$)}F=R}while(F!==P);return E.length>0&&E.push(E[0]),E}(u);if(Uo(n,_))return m}const Mr=64,ur={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Sn(n,t,r,l,u,m,_,b,E,P=!1){const R=r.zoom,F=r.project(l),O=Vt(l.lat,R),$=1/O;Ve(n),Yr(n,n,[F.x+_[0]*$,F.y+_[1]*$,_[2]]);let q=1,Y=1;const rt=r.worldSize;if(P){if(r.projection.name==="mercator"){let Pt=0;r.elevation&&(Pt=r.elevation.getAtPointOrZero(new pe(F.x/rt,F.y/rt),0));const qt=ds([],[F.x,F.y,Pt,1],r.projMatrix)[3]/r.cameraToCenterDistance;q=qt,Y=qt*Vt(r.center.lat,R)}else if(r.projection.name==="globe"){const Pt=Ar(n,r),qt=[0,0,0,1];ds(qt,qt,gr([],r.projMatrix,Pt));const Bt=qt[3]/r.cameraToCenterDistance,Yt=Du(R),ee=r.projection.pixelsPerMeter(l.lat,rt)*Vt(l.lat,R),ne=r.projection.pixelsPerMeter(r.center.lat,rt)*Vt(r.center.lat,R);q=Bt/Vi(ee,Zt(r.center.lat),Yt),Y=Bt*O/ee,q*=ne,Y*=ne}}else q=$;Fn(n,n,[q,q,Y]);const at=[...n],gt=t.orientation,yt=[];if(ji(yt,[gt[0]+(u?u[0]:0),gt[1]+(u?u[1]:0),gt[2]+(u?u[2]:0)],m),gr(n,at,yt),b&&r.elevation){let Pt=0;const qt=[];if(E&&r.elevation){Pt=function(Yt,ee,ne,Le,fe){const ke=ee.elevation;if(!ke)return 0;const Ue=Er.projectAabbCorners(ne,Le),Ze=_t(1,fe.lat)*ee.worldSize,hi=function(vi,pi){const dr=[0,0,1],_i=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Wi of _i){const mr=vi[Wi.corners[0]],Lr=vi[Wi.corners[1]],rn=vi[Wi.corners[2]],_r=[Lr[0]-mr[0],Lr[1]-mr[1],pi*(Lr[2]-mr[2])],pn=qo(_r,_r,[rn[0]-mr[0],rn[1]-mr[1],pi*(rn[2]-mr[2])]);bn(pn,pn),Wi.dotProductWithUp=ho(pn,dr)}return _i.sort((Wi,mr)=>Wi.dotProductWithUp-mr.dotProductWithUp),_i[0].corners}(Ue,Ze),Ke=Ue[hi[0]],je=Ue[hi[1]],Ye=Ue[hi[2]],Me=Ue[hi[3]],Ie=ke.getAtPointOrZero(new pe(Ke[0]/ee.worldSize,Ke[1]/ee.worldSize),0),He=ke.getAtPointOrZero(new pe(je[0]/ee.worldSize,je[1]/ee.worldSize),0),ai=ke.getAtPointOrZero(new pe(Ye[0]/ee.worldSize,Ye[1]/ee.worldSize),0),Ge=ke.getAtPointOrZero(new pe(Me[0]/ee.worldSize,Me[1]/ee.worldSize),0),Pi=(Ie+Ge)/2,ki=(He+ai)/2;return Pi>ki?He<ai?gi(Yt,je,Me,Ke,He,Ge,Ie,Ze):gi(Yt,Ye,Ke,Me,ai,Ie,Ge,Ze):Ie<Ge?gi(Yt,Ke,je,Ye,Ie,He,ai,Ze):gi(Yt,Me,Ye,je,Ge,ai,He,Ze),Math.max(Pi,ki)}(qt,r,t.aabb,n,l);const Bt=gr([],nc([],qt),yt);gr(n,at,Bt)}else Pt=r.elevation.getAtPointOrZero(new pe(F.x/rt,F.y/rt),0);Pt!==0&&(n[14]+=Pt)}}class is{constructor(t,r,l,u,m){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=t,this.uri=r,this.position=l!=null?new Z(l[0],l[1]):new Z(0,0),this.orientation=u??[0,0,0],this.nodes=m,this.uploaded=!1,this.aabb=new Er([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,r){gr(t.globalMatrix,r,t.localMatrix);const l=this.nodeOverrides.get(t.name);if(l!==void 0){const _=[];m=l.orientation,Ve(u=_),ao(u,u,rr(m[1])),Do(u,u,rr(m[2])),us(u,u,rr(m[0])),gr(t.globalMatrix,t.globalMatrix,_)}var u,m;if(t.meshes)for(const _ of t.meshes){const b=Er.applyTransformFast(_.aabb,t.globalMatrix);this.aabb.encapsulate(b)}if(t.children)for(const _ of t.children)this._applyTransformations(_,t.globalMatrix)}computeBoundsAndApplyParent(){const t=Ve([]);this.aabb=new Er([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const r of this.nodes)this._applyTransformations(r,t)}computeModelMatrix(t,r,l,u,m,_,b=!1){Sn(this.matrix,this,t.transform,this.position,r,l,u,m,_,b)}upload(t){if(!this.uploaded){for(const r of this.nodes)Gc(r,t);for(const r of this.nodes)Ja(r);this.uploaded=!0}}destroy(){for(const t of this.nodes)Sa(t)}}function xs(n,t,r=!1){n.uploaded||(n.gfxTexture=new dt(t,n.image,r?t.gl.R8:t.gl.RGBA8,{useMipmap:n.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function yl(n,t,r){n.indexBuffer=t.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=t.createVertexBuffer(n.vertexArray,At.members,!1,!0),n.normalArray&&(n.normalBuffer=t.createVertexBuffer(n.normalArray,ie.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=t.createVertexBuffer(n.texcoordArray,Qt.members,!1,!0)),n.colorArray&&(n.colorBuffer=t.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?jt:ue).members,!1,!0)),n.featureArray&&(n.pbrBuffer=t.createVertexBuffer(n.featureArray,Ee.members,!0)),n.segments=po.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);const l=n.material;l.pbrMetallicRoughness.baseColorTexture&&xs(l.pbrMetallicRoughness.baseColorTexture,t),l.pbrMetallicRoughness.metallicRoughnessTexture&&xs(l.pbrMetallicRoughness.metallicRoughnessTexture,t),l.normalTexture&&xs(l.normalTexture,t),l.occlusionTexture&&xs(l.occlusionTexture,t,r),l.emissionTexture&&xs(l.emissionTexture,t)}function Gc(n,t,r){if(n.meshes)for(const l of n.meshes)yl(l,t,r);if(n.children)for(const l of n.children)Gc(l,t,r)}function Ja(n){if(n.meshes)for(const t of n.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(n.children)for(const t of n.children)Ja(t)}function Sa(n){if(n.meshes)for(const r of n.meshes)r.vertexBuffer&&(r.vertexBuffer.destroy(),r.indexBuffer.destroy(),r.normalBuffer&&r.normalBuffer.destroy(),r.texcoordBuffer&&r.texcoordBuffer.destroy(),r.colorBuffer&&r.colorBuffer.destroy(),r.pbrBuffer&&r.pbrBuffer.destroy(),r.segments.destroy(),r.material&&((t=r.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(n.children)for(const r of n.children)Sa(r)}function Vs(n,t){const r=n.json.bufferViews[t.bufferView],l=ym[t.componentType];return new l(n.buffers[r.buffer],(t.byteOffset||0)+(r.byteOffset||0),t.count*(r.byteStride&&r.byteStride!==Lf[t.type]*l.BYTES_PER_ELEMENT?r.byteStride/l.BYTES_PER_ELEMENT:Lf[t.type]))}function vs(n,t,r,l){const u=ym[t.componentType],m=function(R){switch(R){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(u),_=n.json.bufferViews[t.bufferView],b=_.byteStride?_.byteStride/u.BYTES_PER_ELEMENT:Lf[t.type],E=r.float32,P=E.length/r.capacity;for(let R=0,F=0;R<t.count*b;R+=b,F+=P)for(let O=0;O<P;O++)E[F+O]=l[R+O]*m;r._trim()}function Ka(n,t,r){const l=n.indices,u=n.attributes,m={};m.indexArray=new qn;const _=t.json.accessors[l],b=_.count/3;m.indexArray.reserve(b);const E=Vs(t,_);for(let O=0;O<b;O++)m.indexArray.emplaceBack(E[3*O],E[3*O+1],E[3*O+2]);m.indexArray._trim(),m.vertexArray=new Zs;const P=t.json.accessors[u.POSITION];m.vertexArray.reserve(P.count);const R=Vs(t,P);for(let O=0;O<P.count;O++)m.vertexArray.emplaceBack(R[3*O],R[3*O+1],R[3*O+2]);if(m.vertexArray._trim(),m.aabb=new Er(P.min,P.max),m.centroid=function(O,$){const q=[0,0,0],Y=O.length;if(Y>0){for(let rt=0;rt<Y;rt++){const at=3*O[rt];q[0]+=$[at],q[1]+=$[at+1],q[2]+=$[at+2]}q[0]/=Y,q[1]/=Y,q[2]/=Y}return q}(E,R),u.COLOR_0!==void 0){const O=t.json.accessors[u.COLOR_0],$=Lf[O.type],q=Vs(t,O);m.colorArray=$===3?new Zs:new ch,m.colorArray.resize(O.count),vs(t,O,m.colorArray,q)}if(u.NORMAL!==void 0){m.normalArray=new Zs;const O=t.json.accessors[u.NORMAL];m.normalArray.resize(O.count);const $=Vs(t,O);vs(t,O,m.normalArray,$)}if(u.TEXCOORD_0!==void 0&&r.length>0){m.texcoordArray=new Eu;const O=t.json.accessors[u.TEXCOORD_0];m.texcoordArray.resize(O.count);const $=Vs(t,O);vs(t,O,m.texcoordArray,$)}if(u._FEATURE_ID_RGBA4444!==void 0){const O=t.json.accessors[u._FEATURE_ID_RGBA4444];t.json.extensionsUsed&&t.json.extensionsUsed.includes("EXT_meshopt_compression")&&(m.featureData=Vs(t,O))}u._FEATURE_RGBA4444!==void 0&&(m.featureData=new Uint32Array(Vs(t,t.json.accessors[u._FEATURE_RGBA4444]).buffer));const F=n.material;return m.material=function(O,$){const{emissiveFactor:q=[0,0,0],alphaMode:Y="OPAQUE",alphaCutoff:rt=.5,normalTexture:at,occlusionTexture:gt,emissiveTexture:yt,doubleSided:Pt,name:qt}=O,{baseColorFactor:Bt=[1,1,1,1],metallicFactor:Yt=1,roughnessFactor:ee=1,baseColorTexture:ne,metallicRoughnessTexture:Le}=O.pbrMetallicRoughness||{},fe=gt?$[gt.index]:void 0;if(gt&&gt.extensions&&gt.extensions.KHR_texture_transform&&fe){const ke=gt.extensions.KHR_texture_transform;fe.offsetScale=[ke.offset[0],ke.offset[1],ke.scale[0],ke.scale[1]]}return{name:qt,pbrMetallicRoughness:{baseColorFactor:new Dr(...Bt),metallicFactor:Yt,roughnessFactor:ee,baseColorTexture:ne?$[ne.index]:void 0,metallicRoughnessTexture:Le?$[Le.index]:void 0},doubleSided:Pt,emissiveFactor:new Dr(...q),alphaMode:Y,alphaCutoff:rt,normalTexture:at?$[at.index]:void 0,occlusionTexture:fe,emissionTexture:yt?$[yt.index]:void 0,defined:O.defined===void 0}}(F!==void 0?t.json.materials[F]:{defined:!1},r),m}function xl(n,t,r){const{matrix:l,rotation:u,translation:m,scale:_,mesh:b,extras:E,children:P,name:R}=n,F={};if(F.name=R,F.localMatrix=l||function(O,$,q,Y){var rt=$[0],at=$[1],gt=$[2],yt=$[3],Pt=rt+rt,qt=at+at,Bt=gt+gt,Yt=rt*Pt,ee=rt*qt,ne=rt*Bt,Le=at*qt,fe=at*Bt,ke=gt*Bt,Ue=yt*Pt,Ze=yt*qt,hi=yt*Bt,Ke=Y[0],je=Y[1],Ye=Y[2];return O[0]=(1-(Le+ke))*Ke,O[1]=(ee+hi)*Ke,O[2]=(ne-Ze)*Ke,O[3]=0,O[4]=(ee-hi)*je,O[5]=(1-(Yt+ke))*je,O[6]=(fe+Ue)*je,O[7]=0,O[8]=(ne+Ze)*Ye,O[9]=(fe-Ue)*Ye,O[10]=(1-(Yt+Le))*Ye,O[11]=0,O[12]=q[0],O[13]=q[1],O[14]=q[2],O[15]=1,O}([],u||[0,0,0,1],m||[0,0,0],_||[1,1,1]),F.globalMatrix=Ri(F.localMatrix),b!==void 0){F.meshes=r[b];const O=F.anchor=[0,0];for(const $ of F.meshes){const{min:q,max:Y}=$.aabb;O[0]+=q[0]+Y[0],O[1]+=q[1]+Y[1]}O[0]=Math.floor(O[0]/F.meshes.length/2),O[1]=Math.floor(O[1]/F.meshes.length/2)}if(E&&(E.id&&(F.id=E.id),E.lights&&(F.lights=function(O){if(!O.length)return[];const $=function(gt){const yt=atob(gt),Pt=new Uint8Array(yt.length);for(let qt=0;qt<yt.length;qt++)Pt[qt]=yt.codePointAt(qt);return Pt}(O),q=[],Y=$.length/24,rt=new Uint16Array($.buffer),at=new Float32Array($.buffer);for(let gt=0;gt<Y;gt++){const yt=rt[2*gt*6]/30,Pt=rt[2*gt*6+1]/30,qt=rt[2*gt*6+10]/100,Bt=at[6*gt+1],Yt=at[6*gt+2],ee=at[6*gt+3],ne=at[6*gt+4],Le=ee-Bt,fe=ne-Yt,ke=Math.hypot(Le,fe);q.push({pos:[Bt+.5*Le,Yt+.5*fe,Pt],normal:[fe/ke,-Le/ke,0],width:ke,height:yt,depth:qt,points:[Bt,Yt,ee,ne]})}return q}(E.lights)),E.MAPBOX_geometry_bloom&&(F.isGeometryBloom=E.MAPBOX_geometry_bloom)),P){const O=[];for(const $ of P)O.push(xl(t.json.nodes[$],t,r));F.children=O}return F}function Bl(n){if(n.vertices.length===0||n.indices.length===0)return null;const t=new Xm(n.vertices,n.indices,8,256),[r,l]=[t.min.clone(),t.max.clone()];return{vertices:n.vertices,indices:n.indices,grid:t,min:r,max:l}}function Ic(n){if(!n.extras||!n.extras.ground)return null;const t=n.extras.ground;if(!t||!Array.isArray(t)||t.length===0)return null;const r=t[0];if(!r||!Array.isArray(r)||r.length===0)return null;const l=[];for(const _ of r){if(!Array.isArray(_)||_.length!==2)continue;const b=_[0],E=_[1];typeof b=="number"&&typeof E=="number"&&l.push(new Ae(b,E))}if(l.length<3)return null;l.length>1&&l[l.length-1].equals(l[0])&&l.pop();let u=0;for(let _=0;_<l.length;_++){const b=l[_],E=l[(_+1)%l.length],P=l[(_+2)%l.length];u+=(b.x-E.x)*(P.y-E.y)-(P.x-E.x)*(b.y-E.y)}u>0&&l.reverse();const m=jp(l.flatMap(_=>[_.x,_.y]),[]);return m.length===0?null:{vertices:l,indices:m}}function vl(n,t){const r=[],l=[];let u=0;const m=[];for(const _ of n){u=r.length;const b=_.vertexArray.float32,E=_.indexArray.uint16;for(let P=0;P<_.vertexArray.length;P++)m[0]=b[3*P+0],m[1]=b[3*P+1],m[2]=b[3*P+2],Kn(m,m,t),r.push(new Ae(m[0],m[1]));for(let P=0;P<3*_.indexArray.length;P++)l.push(E[P]+u)}if(l.length%3!=0)return null;for(let _=0;_<l.length;_+=3){const b=r[l[_+0]],E=r[l[_+1]],P=r[l[_+2]];(b.x-E.x)*(P.y-E.y)-(P.x-E.x)*(b.y-E.y)>0&&([l[_+1],l[_+2]]=[l[_+2],l[_+1]])}return{vertices:r,indices:l}}function Ol(n){const t=function(E,P){const R=[],F=WebGL2RenderingContext;if(E.json.textures)for(const O of E.json.textures){const $={magFilter:F.LINEAR,minFilter:F.NEAREST,wrapS:F.REPEAT,wrapT:F.REPEAT};O.sampler!==void 0&&Object.assign($,E.json.samplers[O.sampler]),R.push({image:P[O.source],sampler:$,uploaded:!1})}return R}(n,n.images),r=function(E,P){const R=[];for(const F of E.json.meshes){const O=[];for(const $ of F.primitives)O.push(Ka($,E,P));R.push(O)}return R}(n,t),{scenes:l,scene:u,nodes:m}=n.json,_=l?l[u||0].nodes:[...m.keys()],b=[];for(const E of _)b.push(xl(m[E],n,r));return function(E,P,R){const F={},O=new Set;for(let $=0;$<E.length;$++){const q=R[P[$]];if(!q.extras)continue;const Y=q.extras["mapbox:footprint:version"],rt=q.extras["mapbox:footprint:id"];(Y||rt)&&O.add($),Y==="1.0.0"&&rt&&(F[rt]=$)}for(let $=0;$<E.length;$++){if(O.has($))continue;const q=E[$],Y=R[P[$]];if(!Y.extras)continue;let rt=null;q.id in F&&(rt=vl(E[F[q.id]].meshes,q.localMatrix)),rt||(rt=Ic(Y)),rt&&(q.footprint=Bl(rt))}if(O.size>0){const $=Array.from(O.values()).sort((q,Y)=>q-Y);for(let q=$.length-1;q>=0;q--)E.splice($[q],1)}}(b,_,n.json.nodes),b}function ru(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);const t=n.vertexArray.float32,r=n.aabb.min[0]-1,l=n.aabb.min[1]-1,u=Mr/(n.aabb.max[0]-r+2),m=Mr/(n.aabb.max[1]-l+2);for(let _=0;_<t.length;_+=3){const b=t[_+2],E=(t[_+0]-r)*u|0,P=(t[_+1]-l)*m|0;b>n.heightmap[P*Mr+E]&&(n.heightmap[P*Mr+E]=b)}}function Ia(n,t,r,l,u){r.reserve(r.length+4*n.length),l.reserve(l.length+10*n.length),u.reserve(u.length+10*n.length);let m=l.length;for(const _ of n){const b=Math.min(10,Math.max(4,1.3*_.height))*t,E=[-_.normal[1],_.normal[0],0],P=Math.min(.29,.1*_.width/_.depth),R=_.width-2*_.depth*t*(P+.01),F=Ks([],_.pos,E,R/2),O=Ks([],_.pos,E,-R/2),$=[F[0],F[1],F[2]+_.height],q=[O[0],O[1],O[2]+_.height],Y=Ks([],_.normal,E,P);Jn(Y,Y,b);const rt=Ks([],_.normal,E,-P);Jn(rt,rt,b),Fo(Y,F,Y),Fo(rt,O,rt),F[2]+=.1,O[2]+=.1,l.emplaceBack(Y[0],Y[1],Y[2]),l.emplaceBack(rt[0],rt[1],rt[2]),l.emplaceBack(F[0],F[1],F[2]),l.emplaceBack(O[0],O[1],O[2]),l.emplaceBack($[0],$[1],$[2]),l.emplaceBack(q[0],q[1],q[2]),l.emplaceBack(F[0],F[1],F[2]),l.emplaceBack(O[0],O[1],O[2]),l.emplaceBack(Y[0],Y[1],Y[2]),l.emplaceBack(rt[0],rt[1],rt[2]);const at=R/b/2;u.emplaceBack(-at-P,-1,at,.8),u.emplaceBack(at+P,-1,at,.8),u.emplaceBack(-at,0,at,1.3),u.emplaceBack(at,0,at,1.3),u.emplaceBack(at+P,-.8,at,.7),u.emplaceBack(at+P,-.8,at,.7),u.emplaceBack(0,0,at,1.3),u.emplaceBack(0,0,at,1.3),u.emplaceBack(at+P,-1.2,at,.8),u.emplaceBack(at+P,-1.2,at,.8),r.emplaceBack(6+m,4+m,8+m),r.emplaceBack(7+m,9+m,5+m),r.emplaceBack(0+m,1+m,2+m),r.emplaceBack(1+m,3+m,2+m),m+=10}}function bs(n,t){const r={};r.indexArray=new qn,r.vertexArray=new Zs,r.colorArray=new ch,Ia(n,t,r.indexArray,r.vertexArray,r.colorArray);const l={defined:!0};l.emissiveFactor=Dr.black;const u={};return u.baseColorFactor=Dr.white,l.pbrMetallicRoughness=u,r.material=l,r.aabb=new Er([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),r}const Xs=vr([{name:"a_pos_3f",components:3,type:"Float32"}]),Ps=vr([{name:"a_normal_3",components:3,type:"Int16"}]),Na=vr([{name:"a_centroid_3",components:3,type:"Int16"}]),Td=vr([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),zu=vr([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),ng=vr([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),Yp=vr([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),Rf=vr([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),xm=vr([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),kf=qe.types,np=32767;function f0(n,t){const r=ri+t;for(const l of n)for(const u of l)if(u.x<-t||u.x>r||u.y<-t||u.y>r)return!1;return!0}class iy{constructor(){this.layoutVertexArray=new Zs,this.layoutAttenuationArray=new ch,this.layoutColorArray=new Rl,this.indexArray=new qn,this.indexArrayForConflation=new qn,this.segmentsBucket=new po}}class Wg{constructor(){this.layoutVertexArray=new Zs,this.layoutNormalArray=new ml,this.layoutCentroidArray=new ml,this.layoutColorArray=new Rl,this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.layoutFloodLightDataArray=new Lp,this.layoutAOArray=new Fs,this.indexArray=new qn,this.indexArrayForConflation=new qn,this.segmentsBucket=new po,this.entranceBloom=new iy}}class ry{constructor(t){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.buildingWithoutFacade=new Wg,this.buildingWithFacade=new Wg,this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.footprintLookup={},this.zoom=t.zoom,this.canonical=t.canonical,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.worldview=t.worldview,this.lut=t.lut,this.buildingWithFacade.layoutFacadePaintArray=new Rl,this.buildingWithFacade.layoutFacadeDataArray=new Mo,this.buildingWithFacade.layoutFacadeVerticalRangeArray=new Rl,this.programConfigurations=new mh(t.layers,{zoom:t.zoom,lut:t.lut}),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.projection=t.projection,this.groundEffect=new jg(t),this.groundEffect.groundRadiusArray=new Fs,this.hasAppearances=null}updateFootprints(t,r){for(const l of this.footprints)r.push({footprint:l,id:t})}updateAppearances(t,r,l,u){}prepare(){return function(){if(eg!=null||Zg!=null)return null;if(wd!=null)return wd;const t=fetch(Gn.BUILDING_GEN_URL);return wd=function(r){let l,u,m,_;function b(){l=new Uint8Array(_.buffer),u=new Int32Array(_.buffer),m=new Float32Array(_.buffer)}function E(){throw new Error("Unexpected BuildingGen error.")}const P=()=>{},R={a:{a:E,f:function(F){const O=l.length,$=Math.max(F>>>0,Math.ceil(1.2*O)),q=Math.ceil(($-O)/65536);try{return _.grow(q),b(),!0}catch{return!1}},g:E,b:P,c:P,d:P,e:P}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(r,R):r.then(F=>F.arrayBuffer()).then(F=>WebAssembly.instantiate(F,R))).then(F=>{const O=F.instance.exports;return(0,O.g)(),_=O.f,b(),new d0({setStyle:O.h,setAOOptions:O.i,setMetricOptions:O.j,setStructuralOptions:O.k,setFacadeOptions:O.l,setFauxFacadeOptions:O.m,setFacadeClassifierOptions:O.n,addFeature:O.o,addFacade:O.p,generateMesh:O.q,getLastError:O.r,getOuterRingLength:O.s,getMeshCount:O.t,getPositionsPtr:O.u,getPositionsLength:O.v,getNormalsPtr:O.w,getNormalsLength:O.x,getColorsPtr:O.y,getColorsLength:O.z,getAOPtr:O.A,getAOLength:O.B,getUVPtr:O.C,getUVLength:O.D,getFauxFacadePtr:O.E,getFauxFacadeLength:O.F,getIndicesPtr:O.G,getIndicesLength:O.H,getBuildingPart:O.I,getRingCount:O.J,getRingPtr:O.K,getRingLength:O.L,free:O.M,malloc:O.N,heapU8:l,heap32:u,heapF32:m})})}(t).then(r=>(wd=null,eg=r,eg)).catch(r=>{qi("Could not load building-gen"),wd=null,Zg=r}),wd}()}populate(t,r,l,u){const m=rg();if(!m)return;const _=Ht(l);this.tileToMeter=_,this.brightness=r.brightness,m.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,_],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:_,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),m.setAOOptions(!1,.3),m.setMetricOptions(!1,16),m.setStructuralOptions(!0),m.setFacadeClassifierOptions(3);const b=new Map,E=new Map;for(const{feature:P}of t){if(kf[P.type]!=="LineString"){b.set(P.id,P.properties.source_id);continue}const R=this.layers[0]._featureFilter.needGeometry,F=Te(P,R);if(!this.layers[0]._featureFilter.filter(new D(this.zoom),F,l))continue;const O=R?F.geometry:Be(P,l,u),$=[];for(const at of O)for(const gt of at)$.push({x:gt.x,y:gt.y});const q={coordinates:$,crossPerc:P.properties.cross_perc,distanceToRoad:P.properties.distance_to_road,entrances:P.properties.entrances,sourceId:0},Y=P.properties.source_id;let rt=E.get(Y);rt||(rt=[],E.set(Y,rt)),rt.push(q)}this.maxHeight=0;for(const{feature:P,id:R,index:F,sourceLayerIndex:O}of t){if(kf[P.type]==="LineString")continue;const $=this.layers[0]._featureFilter.needGeometry,q=Te(P,$);if(!this.layers[0]._featureFilter.filter(new D(this.zoom),q,l))continue;const Y=$?q.geometry:Be(P,l,u),rt=am(Y,500);if(!f0(Y,163))continue;const at=this.layers[0],gt=at.layout.get("building-roof-shape").evaluate(P,{},l);if(gt==="flat")continue;const yt=at.layout.get("building-base").evaluate(P,{},l),Pt=at.layout.get("building-height").evaluate(P,{},l),qt=at.layout.get("building-flood-light-ground-radius").evaluate(P,{},l),Bt=at.paint.get("building-ambient-occlusion-intensity"),Yt=qt/this.tileToMeter;let ee=at.layout.get("building-flood-light-wall-radius").evaluate(P,{},l);ee=tt(ee,0,2048);const ne=ee/2048*np,Le=b.get(R);let fe;fe=E.has(Le)?E.get(Le):[];const ke=fe.length!==0&&at.layout.get("building-facade").evaluate(P,{},l);m.setFacadeOptions(4,!0),m.setFauxFacadeOptions(ke,!1,1);let Ue=0,Ze=0,hi=0,Ke=0,je=0,Ye=0;if(ke){let Ne=Math.round(at.layout.get("building-facade-floors").evaluate(P,{},l));if(yt===0){Ne=Math.max(1,Ne-(fe.length>0?1:0));let Gi=4;if(Pt>100){const Ni=[10,13,15];Gi=Ni[P.id?P.id%Ni.length:0],m.setFacadeOptions(Gi,!0)}je=1.6803*Gi/_}else je=yt/_;Ye=Pt/_,je=Math.min(je,Ye),hi=at.layout.get("building-facade-unit-width").evaluate(P,{},l)/_,Ke=(Ye-je)/Ne,m.setFauxFacadeOptions(!0,!0,hi);const fi=at.layout.get("building-facade-window").evaluate(P,{},l);Ue=fi[0],Ze=fi[1]}const Me=[],Ie=new Ae(1/0,1/0),He=new Ae(-1/0,-1/0),ai=new Ae(0,0);let Ge=0;for(const Ne of rt)if(Ne.length>0){const fi=[];for(const Gi of Ne){const Ni=[];for(let Tr=Gi.length-1;Tr>=0;Tr--){const er=Gi[Tr];Ni.push({x:er.x,y:er.y}),Ie.x=Math.min(Ie.x,er.x),Ie.y=Math.min(Ie.y,er.y),He.x=Math.max(He.x,er.x),He.y=Math.max(He.y,er.y),ai.x+=er.x,ai.y+=er.y,Ge++}fi.push(Ni)}Me.push({id:P.id?P.id:0,height:Pt,minHeight:yt,sourceId:0,roofType:gt,coordinates:fi})}ai.x/=Ge||1,ai.y/=Ge||1;const Pi=m.generateMesh(Me,fe);if(typeof Pi=="string"){qi(`Unable to generate building ${P.id}: ${Pi}`);continue}if(Pi.meshes.length===0||Pi.modifiedPolygonRings.length===0)continue;let ki=0;for(const Ne of Pi.meshes)ki+=Ne.positions.length/3;const vi=ke?this.buildingWithFacade:this.buildingWithoutFacade,pi=vi.segmentsBucket.prepareSegment(ki,vi.layoutVertexArray,vi.indexArray),dr=[];let _i=null,Wi=0,mr=-1;const Lr=vi.layoutVertexArray.length,rn=vi.indexArray.length;let _r=0;for(const Ne of Pi.meshes){const fi=vi.layoutVertexArray.length;if(Ne.buildingPart==="entrance"){const Bi=new Array;for(let Qr=0;Qr<Ne.positions.length;Qr+=12){const Vn=Ne.positions[Qr+0],In=Ne.positions[Qr+1],jo=Ne.positions[Qr+3],go=Ne.positions[Qr+4],no=Ne.positions[Qr+2],zn=Ne.positions[Qr+8]-no,mn=1,Sr=jo-Vn,gn=go-In,oo=Math.hypot(Sr,gn);Bi.push({pos:[Vn+.5*Sr,In+.5*gn,no],normal:[gn/oo,-Sr/oo,0],width:oo,height:zn,depth:mn,points:[Vn,In,jo,go]})}const un=vi.entranceBloom.segmentsBucket.prepareSegment(10*Bi.length,vi.entranceBloom.layoutVertexArray,vi.entranceBloom.indexArray),Nn=vi.entranceBloom.layoutVertexArray.length;Wi=vi.entranceBloom.indexArray.length,Ia(Bi,.5/this.tileToMeter,vi.entranceBloom.indexArray,vi.entranceBloom.layoutVertexArray,vi.entranceBloom.layoutAttenuationArray);const nr=vi.entranceBloom.layoutVertexArray.length-Nn;mr=vi.entranceBloom.indexArray.length-Wi;for(let Qr=0;Qr<nr;Qr++)vi.entranceBloom.layoutColorArray.emplaceBack(65535,65535);un.vertexLength+=nr,un.primitiveLength+=mr,_i={part:Ne.buildingPart,vertexOffset:Nn,vertexLength:nr}}for(let Bi=0;Bi<Ne.positions.length;Bi+=3)_r=Math.max(_r,Ne.positions[Bi+2]),vi.layoutVertexArray.emplaceBack(Ne.positions[Bi],Ne.positions[Bi+1],Ne.positions[Bi+2]);const Gi=Math.floor(ai.x),Ni=Math.floor(ai.y),Tr=Math.floor(_r);for(let Bi=0;Bi<Ne.positions.length;Bi+=3)vi.layoutCentroidArray.emplaceBack(Gi,Ni,Tr),vi.layoutFloodLightDataArray.emplaceBack(Ne.buildingPart==="wall"?ne:0);for(let Bi=0;Bi<Ne.normals.length;Bi+=3)vi.layoutNormalArray.emplaceBack(Ne.normals[Bi+0]*np,Ne.normals[Bi+1]*np,Ne.normals[Bi+2]*np);for(let Bi=0;Bi<Ne.ao.length;Bi++)vi.layoutAOArray.emplaceBack(Ne.ao[Bi]);for(let Bi=0;Bi<Ne.colors.length;Bi+=3){const un=1+(Ne.ao[Bi/3]-1)*Bt;vi.layoutColorArray.emplaceBack(Ne.colors[Bi]*un<<8|Ne.colors[Bi+1]*un,Ne.colors[Bi+2]*un<<8)}if(ke){for(let Bi=0;Bi<Ne.positions.length;Bi+=3)vi.layoutFacadePaintArray.emplaceBack(65535,255);for(let Bi=0;Bi<Ne.isFauxFacade.length;Bi++)if(Ne.isFauxFacade[Bi]){const un=1|Math.min(65535,Math.floor(Ne.uv[2*Bi]*Pi.outerRingLength)),Nn=Math.floor(255*Ue)<<8|Math.floor(255*Ze),nr=Math.floor(65535*Math.min(1,hi/ri)),Qr=Math.floor(65535*Math.min(1,Ke/ri));vi.layoutFacadeDataArray.emplaceBack(un,Nn,nr,Qr);const Vn=Math.floor(65535*Math.min(1,je/ri)),In=Math.floor(65535*Math.min(1,Ye/ri));vi.layoutFacadeVerticalRangeArray.emplaceBack(Vn,In)}else vi.layoutFacadeDataArray.emplaceBack(0,0,0,0),vi.layoutFacadeVerticalRangeArray.emplaceBack(0,0)}const er=pi.vertexLength;for(let Bi=0;Bi<Ne.indices.length;Bi+=3)vi.indexArray.emplaceBack(er+Ne.indices[Bi],er+Ne.indices[Bi+1],er+Ne.indices[Bi+2]);pi.vertexLength+=Ne.positions.length/3,pi.primitiveLength+=Ne.indices.length/3,(Ne.buildingPart==="roof"||Ne.buildingPart==="wall"||Ne.buildingPart==="facade_glazing"||Ne.buildingPart==="entrance")&&dr.push({part:Ne.buildingPart,vertexOffset:fi,vertexLength:Ne.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,_r),this.buildingFeatures.push({promoteId:R,feature:q,hasFauxFacade:ke,segment:pi,parts:dr,buildingBloom:_i});const pn=vi.indexArray.length-rn,fn=[],Co=[],Ot=new Ae(1/0,1/0),Rt=new Ae(-1/0,-1/0),Oe=this.groundEffect.vertexArray.length;for(const Ne of Pi.modifiedPolygonRings){const fi=[],Gi=new Ae(1/0,1/0),Ni=new Ae(-1/0,-1/0);for(let Tr=0;Tr<Ne.length;Tr+=2){const er=Ne.length-Tr-2;Gi.x=Math.min(Gi.x,Ne[er]),Gi.y=Math.min(Gi.y,Ne[er+1]),Ni.x=Math.max(Ni.x,Ne[er]),Ni.y=Math.max(Ni.y,Ne[er+1]);const Bi=new Ae(Ne[er],Ne[er+1]);fi.push(Bi),fn.push(Bi.x,Bi.y),Co.push(Bi.clone())}Ot.x=Math.min(Ot.x,Gi.x),Ot.y=Math.min(Ot.y,Gi.y),Rt.x=Math.max(Rt.x,Ni.x),Rt.y=Math.max(Rt.y,Ni.y),this.groundEffect.addData(fi,[Gi,Ni],Yt)}const di=this.groundEffect.vertexArray.length-Oe;for(let Ne=0;Ne<di;Ne++)this.groundEffect.groundRadiusArray.emplaceBack(qt);(Ie.x<0||He.x>ri||Ie.y<0||He.y>ri)&&this.featuresOnBorder.push({featureId:P.id,footprintIndex:this.footprints.length});{const Ne=jp(fn,null,2),fi=new Xm(Co,Ne,8,256);let Gi=P.id;P.properties&&P.properties.hasOwnProperty("building_id")&&(Gi=P.properties.building_id);const Ni={vertices:Co,indices:Ne,grid:fi,min:Ot,max:Rt,buildingId:Gi,hiddenFlags:0,indicesOffset:rn,indicesLength:pn,bloomIndicesOffset:Wi,bloomIndicesLength:mr,groundEffectVertexOffset:Oe,groundEffectVertexLength:di,hasFauxFacade:ke,segment:pi,height:_r};P.id!==void 0&&this.featureFootprintLookup.set(P.id,this.footprints.length),this.footprints.push(Ni)}this.programConfigurations.populatePaintArrays(vi.layoutVertexArray.length,P,F,{},r.availableImages,l,r.brightness),this.groundEffect.addPaintPropertiesData(P,F,{},r.availableImages,l,r.brightness),r.featureIndex.insert(P,Y,F,O,this.index,Lr)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0],{})}update(t,r,l,u,m,_,b){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b),this.groundEffect.update(t,r,m,l,u,_,b),this.evaluate(this.layers[0],t),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){const r=l=>{l.layoutVertexBuffer=t.createVertexBuffer(l.layoutVertexArray,Xs.members),l.layoutNormalBuffer=t.createVertexBuffer(l.layoutNormalArray,Ps.members),l.layoutCentroidBuffer=t.createVertexBuffer(l.layoutCentroidArray,Na.members),l.layoutFloodLightDataBuffer=t.createVertexBuffer(l.layoutFloodLightDataArray,xm.members),l.layoutFacadeDataArray&&l.layoutFacadeDataArray.length&&(l.layoutFacadeDataBuffer=t.createVertexBuffer(l.layoutFacadeDataArray,ng.members)),l.layoutFacadeVerticalRangeArray&&l.layoutFacadeVerticalRangeArray.length&&(l.layoutFacadeVerticalRangeBuffer=t.createVertexBuffer(l.layoutFacadeVerticalRangeArray,Yp.members)),l.entranceBloom.layoutVertexArray.length&&(l.entranceBloom.layoutVertexBuffer=t.createVertexBuffer(l.entranceBloom.layoutVertexArray,Xs.members),l.entranceBloom.layoutAttenuationBuffer=t.createVertexBuffer(l.entranceBloom.layoutAttenuationArray,Rf.members)),this.uploadUpdatedColorBuffer(t),this.uploadUpdatedIndexBuffer(t)};this.uploaded||(r(this.buildingWithoutFacade),r(this.buildingWithFacade),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){const t=r=>{r.layoutVertexBuffer&&(r.layoutVertexBuffer.destroy(),r.layoutNormalBuffer.destroy(),r.layoutColorBuffer.destroy(),r.segmentsBucket.destroy(),r.indexBuffer&&r.indexBuffer.destroy(),r.entranceBloom.layoutVertexBuffer&&(r.entranceBloom.layoutVertexBuffer.destroy(),r.entranceBloom.layoutColorBuffer.destroy(),r.entranceBloom.layoutAttenuationBuffer.destroy(),r.entranceBloom.indexBuffer.destroy(),r.entranceBloom.segmentsBucket.destroy()))};t(this.buildingWithoutFacade),t(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(t,r,l=!0){let u=!1;const m=l?r:0,_=0|(l?-1:~r);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const b of t){const E=this.footprints[b],P=E.hiddenFlags&_|m;E.hiddenFlags!==P&&(E.hiddenFlags=P,u=!0,this.groundEffect.updateHiddenByLandmarkRange(E.groundEffectVertexOffset,E.groundEffectVertexLength,E.hiddenFlags!==0))}return u&&(this.indexArrayForConflationUploaded=!1),u}uploadUpdatedIndexBuffer(t){if(this.groundEffect.uploadHiddenByLandmark(t),this.indexArrayForConflationUploaded)return;const r=u=>{u.indexArray.length!==0&&(u.indexArrayForConflation.resize(u.indexArray.length),u.indexArrayForConflation.uint16.set(u.indexArray.uint16),u.entranceBloom.indexArrayForConflation.resize(u.entranceBloom.indexArray.length),u.entranceBloom.indexArrayForConflation.uint16.set(u.entranceBloom.indexArray.uint16))};r(this.buildingWithoutFacade),r(this.buildingWithFacade);for(const u of this.footprints){const m=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,_=u.indicesOffset+u.indicesLength;if(u.hiddenFlags!==0){for(let E=u.indicesOffset;E<_;E++)m.indexArrayForConflation.uint16[3*E+0]=0,m.indexArrayForConflation.uint16[3*E+1]=0,m.indexArrayForConflation.uint16[3*E+2]=0;const b=u.bloomIndicesOffset+u.bloomIndicesLength;for(let E=u.bloomIndicesOffset;E<b;E++)m.entranceBloom.indexArrayForConflation.uint16[3*E+0]=0,m.entranceBloom.indexArrayForConflation.uint16[3*E+1]=0,m.entranceBloom.indexArrayForConflation.uint16[3*E+2]=0}}const l=u=>{u.indexArray.length!==0&&(u.indexBuffer?u.indexBuffer.updateData(u.indexArrayForConflation):u.indexBuffer=t.createIndexBuffer(u.indexArrayForConflation,!0),u.entranceBloom.indexBuffer?u.entranceBloom.indexBuffer.updateData(u.entranceBloom.indexArrayForConflation):u.entranceBloom.indexBuffer=t.createIndexBuffer(u.entranceBloom.indexArrayForConflation,!0))};l(this.buildingWithoutFacade),l(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(t){const r=l=>{l.layoutColorBuffer?l.layoutColorBuffer.updateData(l.layoutColorArray):l.layoutColorBuffer=t.createVertexBuffer(l.layoutColorArray,Td.members,!0),l.layoutFacadePaintArray&&(l.layoutFacadePaintBuffer?l.layoutFacadePaintBuffer.updateData(l.layoutFacadePaintArray):l.layoutFacadePaintBuffer=t.createVertexBuffer(l.layoutFacadePaintArray,zu.members,!0)),l.entranceBloom.layoutColorBuffer?l.entranceBloom.layoutColorBuffer.updateData(l.entranceBloom.layoutColorArray):l.entranceBloom.layoutColorBuffer=t.createVertexBuffer(l.entranceBloom.layoutColorArray,Td.members,!0)};r(this.buildingWithoutFacade),r(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(t,r){const l=t.paint.get("building-ambient-occlusion-intensity");for(const u of this.buildingFeatures){const m=r[u.promoteId],_=u.feature;_.properties["building-part"]="roof";const b=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),E=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical);_.properties["building-part"]="wall";const P=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),R=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical);_.properties["building-part"]="window";const F=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),O=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical);_.properties["building-part"]="door";const $=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),q=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical),Y=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const at of u.parts){let gt,yt=b;at.part==="roof"?(yt=b,gt=E):at.part==="wall"?(yt=P,gt=R):at.part==="facade_glazing"?(yt=F,gt=O):at.part==="entrance"&&(yt=$,gt=q),gt=tt(gt,0,1);for(let Pt=0;Pt<at.vertexLength;Pt++){const qt=at.vertexOffset+Pt,Bt=1+(Y.layoutAOArray.float32[qt]-1)*l;Y.layoutColorArray.emplace(qt,yt.r*Bt*255<<8|yt.g*Bt*255,yt.b*Bt*255<<8|255*gt),u.hasFauxFacade&&Y.layoutFacadePaintArray.emplace(qt,255*F.r<<8|255*F.g,255*F.b<<8|255*O)}}const rt=u.buildingBloom;if(rt)for(let at=0;at<rt.vertexLength;at++)Y.entranceBloom.layoutColorArray.emplace(rt.vertexOffset+at,255*$.r<<8|255*$.g,255*$.b<<8|51*q)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(t,r,l){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const u=r.getReplacementRegionsForTile(t.toUnwrapped());if(Mf(this.activeReplacements,u))return;this.activeReplacements=u;for(const _ of this.footprints)_.hiddenFlags&=-2;const m=[];for(const _ of this.activeReplacements){if(_.order<=B_)continue;const b=Math.max(1,Math.pow(2,_.footprintTileId.canonical.z-t.canonical.z));for(const E of this.footprints)E.min.x>_.max.x||E.max.x<_.min.x||E.min.y>_.max.y||E.max.y<_.min.y||(m.length=0,ny(E.vertices,0,E.vertices.length,_.footprintTileId.canonical,t.canonical,m),Og(_.footprint,m,E.indices,0,E.indices.length,0,-b)&&(E.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const _ of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(_.groundEffectVertexOffset,_.groundEffectVertexLength,_.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(t){if(t.id!==void 0){const r=this.featureFootprintLookup.get(t.id);return this.footprints[r]}return null}getHeightAtTileCoord(t,r){let l=Number.NEGATIVE_INFINITY,u=!0;const m=4*(t+ri)*ri+(r+ri);if(this.footprintLookup.hasOwnProperty(m)){const b=this.footprintLookup[m];return b?{height:b.height,hidden:b.hiddenFlags!==0}:void 0}const _=new Ae(t,r);for(const b of this.footprints)t>b.max.x||b.min.x>t||r>b.max.y||b.min.y>r||b.height<=l||Ng(_,b)&&(l=b.height,this.footprintLookup[m]=b,u=b.hiddenFlags!==0);if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:u};this.footprintLookup[m]=void 0}}function ny(n,t,r,l,u,m){const _=Math.pow(2,l.z-u.z);for(let b=0;b<r;b++){let E=n[b+t].x,P=n[b+t].y;E=(E+u.x*ri)*_-l.x*ri,P=(P+u.y*ri)*_-l.y*ri,m.push(new Ae(E,P))}}let Xg,Sd;Si(ry,"BuildingBucket",{omit:["layers"]}),Si(Wg,"BuildingGeometry"),Si(iy,"BuildingBloomGeometry");const m0=vr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),g0=vr([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:ux}=m0,dx=vr([{name:"a_packed",components:3,type:"Float32"}]),{members:px}=dx,fx=vr([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:mx}=fx;class _0{constructor(t,r){this.width=t,this.height=r,this.nextRow=0,this.image=new Qd({width:t,height:r}),this.positions={},this.uploaded=!1}getDash(t,r){const l=this.getKey(t,r);return this.positions[l]}trim(){const t=this.width,r=this.height=Jt(this.nextRow);this.image.resize({width:t,height:r})}getKey(t,r){return t.join(",")+r}getDashRanges(t,r,l){const u=[];let m=t.length%2==1?-t[t.length-1]*l:0,_=t[0]*l,b=!0;u.push({left:m,right:_,isDash:b,zeroLength:t[0]===0});let E=t[0];for(let P=1;P<t.length;P++){b=!b;const R=t[P];m=E*l,E+=R,_=E*l,u.push({left:m,right:_,isDash:b,zeroLength:R===0})}return u}addRoundDash(t,r,l){const u=r/2;for(let m=-l;m<=l;m++){const _=this.width*(this.nextRow+l+m);let b=0,E=t[b];for(let P=0;P<this.width;P++){P/E.right>1&&(E=t[++b]);const R=Math.abs(P-E.left),F=Math.abs(P-E.right),O=Math.min(R,F);let $;const q=m/l*(u+1);if(E.isDash){const Y=u-Math.abs(q);$=Math.sqrt(O*O+Y*Y)}else $=u-Math.sqrt(O*O+q*q);this.image.data[_+P]=Math.max(0,Math.min(255,$+128))}}}addRegularDash(t,r){for(let E=t.length-1;E>=0;--E){const P=t[E],R=t[E+1];P.zeroLength?t.splice(E,1):R&&R.isDash===P.isDash&&(R.left=P.left,t.splice(E,1))}const l=t[0],u=t[t.length-1];l.isDash===u.isDash&&(l.left=u.left-this.width,u.right=l.right+this.width);const m=this.width*this.nextRow;let _=0,b=t[_];for(let E=0;E<this.width;E++){E/b.right>1&&(b=t[++_]);const P=Math.abs(E-b.left),R=Math.abs(E-b.right),F=Math.min(P,R);this.image.data[m+E]=Math.max(0,Math.min(255,(b.isDash?F:-F)+r+128))}}addDash(t,r){const l=this.getKey(t,r);if(this.positions[l])return this.positions[l];const u=r==="round",m=u?7:0,_=2*m+1;if(this.nextRow+_>this.height)return qi("LineAtlas out of space"),null;t.length===0&&t.push(1);let b=0;for(let R=0;R<t.length;R++)t[R]<0&&(qi("Negative value is found in line dasharray, replacing values with 0"),t[R]=0),b+=t[R];if(b!==0){const R=this.width/b,F=this.getDashRanges(t,this.width,R);u?this.addRoundDash(F,R,m):this.addRegularDash(F,r==="square"?.5*R:0)}const E=this.nextRow+m;this.nextRow+=_;const P={tl:[E,m],br:[b,0]};return this.positions[l]=P,P}}Si(_0,"LineAtlas");const gx=qe.types,_x=Math.cos(Math.PI/180*37.5),Lu=Math.cos(Math.PI/180*5);class vm{constructor(t){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=t.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=t.overscaling,this.pixelRatio=t.pixelRatio,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new Uc,this.layoutVertexArray2=new Zs,this.patternVertexArray=new Zs,this.indexArray=new qn,this.programConfigurations=new mh(t.layers,{zoom:t.zoom,lut:t.lut}),this.segments=new po,this.maxLineLength=0,this.zOffsetVertexArray=new Zs,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.tessellationStep=t.tessellationStep?t.tessellationStep:ri/64,this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.hasPattern=Ws("line",this.layers,this.pixelRatio,r);const m=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Ht(l);const _=this.layers[0].layout.get("line-elevation-reference");if(_==="hd-road-markup")this.elevationType="road";else{const O=this.layers[0].layout.get("line-z-offset"),$=O.isConstant()&&!O.constantOr(0);this.elevationType=_!=="sea"&&_!=="ground"&&$?"none":"offset",this.elevationType==="offset"&&_==="none"&&qi(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const b=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&b!==void 0;const E=[];for(const{feature:O,id:$,index:q,sourceLayerIndex:Y}of t){const rt=this.layers[0]._featureFilter.needGeometry,at=Te(O,rt);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),at,l))continue;const gt=m?m.evaluate(at,{},l):void 0,yt={id:$,properties:O.properties,type:O.type,sourceLayerIndex:Y,index:q,geometry:rt?at.geometry:Be(O,l,u),patterns:{},sortKey:gt};E.push(yt)}m&&E.sort((O,$)=>O.sortKey-$.sortKey);const{lineAtlas:P,featureIndex:R}=r,F=this.addConstantDashes(P);for(const O of E){const{geometry:$,index:q,sourceLayerIndex:Y}=O;if(F&&this.addFeatureDashes(O,P),this.hasPattern){const rt=lm("line",this.layers,O,this.zoom,this.pixelRatio,r);this.patternFeatures.push(rt)}else this.addFeature(O,$,q,l,P.positions,r.availableImages,r.brightness,r.elevationFeatures);R.insert(t[q].feature,$,q,Y,this.index)}}addConstantDashes(t){let r=!1;for(const l of this.layers){const u=l.paint.get("line-dasharray").value,m=l.layout.get("line-cap").value;if(u.kind!=="constant"||m.kind!=="constant")r=!0;else{const _=m.value,b=u.value;if(!b)continue;t.addDash(b,_)}}return r}addFeatureDashes(t,r){const l=this.zoom;for(const u of this.layers){const m=u.paint.get("line-dasharray").value,_=u.layout.get("line-cap").value;if(m.kind==="constant"&&_.kind==="constant")continue;let b,E;if(m.kind==="constant"){if(b=m.value,!b)continue}else b=m.evaluate({zoom:l},t);E=_.kind==="constant"?_.value:_.evaluate({zoom:l},t),r.addDash(b,E),t.patterns[u.id]=[r.getKey(b,E)]}}update(t,r,l,u,m,_,b,E){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E)}addFeatures(t,r,l,u,m,_){for(const b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,r,l,u,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,px)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=t.createVertexBuffer(this.patternVertexArray,mx)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,g0.members,!0)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ux),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t,r){let l,u;if(r&&r>0?(l=`mapbox_clip_start_${r}`,u=`mapbox_clip_end_${r}`):(l="mapbox_clip_start",u="mapbox_clip_end"),t.properties&&t.properties.hasOwnProperty(l)&&t.properties.hasOwnProperty(u))return{start:+t.properties[l],end:+t.properties[u]}}addFeature(t,r,l,u,m,_,b,E){const P=this.layers[0].layout,R=P.get("line-join").evaluate(t,{}),F=P.get("line-cap").evaluate(t,{}),O=P.get("line-miter-limit"),$=P.get("line-round-limit");this.lineClips=this.lineFeatureClips(t),this.lineFeature=t;const q=!(!t.properties||!t.properties.hasOwnProperty("mapbox_line_metrics"))&&t.properties.mapbox_line_metrics;this.zOffsetValue=P.get("line-z-offset").value;const Y=this.layers[0].paint.get("line-width").value;if(Y.kind!=="constant"&&Y.isLineProgressConstant===!1&&(this.variableWidthValue=Y),this.elevationType==="road"){const rt=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(t,r,u,E,R,F,O,$)){const[at,gt]=this.clipRuntimeLinesToTile(r,1);for(let yt=0;yt<at.length;yt++){const Pt=at[yt],qt=gt[yt],Bt={progress:{min:qt.progress.min,max:qt.progress.max},nextDir:this.computeSegNextDir(qt,Pt),prevDir:this.computeSegPrevDir(qt,Pt)};this.addLine(Pt,t,u,R,F,O,$,Bt,q&&qt.parentIndex>0?qt.parentIndex:null)}this.fillNonElevatedRoadSegment(rt)}}else for(let rt=0;rt<r.length;rt++)this.addLine(r[rt],t,u,R,F,O,$,void 0,q&&rt>0?rt:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,l,m,_,u,b,void 0,this.worldview)}computeSegNextDir(t,r){return t.nextPoint.sub(r.at(-2)).unit()}computeSegPrevDir(t,r){return r[1].sub(t.prevPoint).unit()}clipLinesToTile(t,r){return $g(t,-r,-r,ri+r,ri+r)}clipRuntimeLinesToTile(t,r){const l=[];return[$g(t,-r,-r,ri+r,ri+r,l),l]}addElevatedRoadFeature(t,r,l,u,m,_,b,E){const P=[],R=cr.getElevationFeature(t,u);if(R){const F=this.clipLinesToTile(r,1),O=this.prepareElevatedLines(F,R,l);for(const $ of O)P.push({geometry:$,elevation:R,elevationTileID:l,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(P.length===0)return!1;for(const F of P){const O=this.layoutVertexArray.length;this.addLine(F.geometry,t,l,m,_,b,E);const $=new Wr(l,F.elevationTileID);if(F.elevation)for(let q=O;q<this.layoutVertexArray.length;q++){const Y=new Ae(this.layoutVertexArray.int16[6*q]>>1,this.layoutVertexArray.int16[6*q+1]>>1),rt=$.pointElevation(Y,F.elevation,.05);this.updateHeightRange(rt),this.zOffsetVertexArray.emplaceBack(rt,0,0)}else this.fillNonElevatedRoadSegment(O)}return!0}prepareElevatedLines(t,r,l){if(r.constantHeight!=null)return t;const u=[],m=1/Ht(l);for(const _ of t)h0(_,new eo(r,m),0,u);return u}fillNonElevatedRoadSegment(t){for(let r=t;r<this.layoutVertexArray.length;r++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(t){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,t),this.heightRange.max=Math.max(this.heightRange.max,t)):this.heightRange={min:t,max:t}}addLine(t,r,l,u,m,_,b,E,P){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=P?this.lineFeatureClips(r,P):this.lineClips;const R=u==="none";this.patternJoinNone=this.hasPattern&&R,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const F=E&&E.progress.min>0,O=E&&E.progress.max<1;if(this.lineClips){let ne={min:this.lineClips.start,max:this.lineClips.end},Le=1;if(E){const Ue=this.lineClips.end-this.lineClips.start;ne=function(Ze,hi,Ke){return{min:Tn(Ze.min,hi,Ke),max:Tn(Ze.max,hi,Ke)}}(E.progress,{min:0,max:1},ne),Ue>0&&(Le=(ne.max-ne.min)/Ue)}const fe=+r.properties.mapbox_clip_feature_len,ke=+r.properties.mapbox_clip_seg_len;if(Number.isNaN(fe)||Number.isNaN(ke)){for(let Ze=0;Ze<t.length-1;Ze++)this.totalDistance+=t[Ze].dist(t[Ze+1]);const Ue=this.totalDistance/(ne.max-ne.min);this.totalFeatureLength=Number.isFinite(Ue)?Ue:0,this.lineClips.start=ne.min,this.lineClips.end=ne.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=fe,this.distance=ke*Le,this.lineClips.start=ne.min,this.lineClips.end=ne.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const $=gx[r.type]==="Polygon";let q=t.length;for(;q>=2&&t[q-1].equals(t[q-2]);)q--;let Y=0;for(;Y<q-1&&t[Y].equals(t[Y+1]);)Y++;if(q<($?3:2))return;u==="bevel"&&(_=1.05);const rt=this.segments.prepareSegment(10*q,this.layoutVertexArray,this.indexArray);let at,gt,yt,Pt,qt,Bt,Yt,ee;E&&E.prevDir&&(Bt=E.prevDir.perp()),E&&E.nextDir&&(Yt=E.nextDir.perp()),this.e1=this.e2=-1,$&&(at=t[q-2],qt=t[Y].sub(at)._unit()._perp());for(let ne=Y;ne<q;ne++){if(yt=ne===q-1?$?t[Y+1]:void 0:t[ne+1],yt&&t[ne].equals(yt))continue;qt&&(Pt=qt),at&&(gt=at),at=t[ne],ee=this.evaluateLineProgressFeatures(gt?gt.dist(at):0),qt=yt?yt.sub(at)._unit()._perp():Pt,Pt=Pt||qt;const Le=gt&&yt;let fe=Le?u:$||R?"butt":m;const ke=Pt.x*qt.x+Pt.y*qt.y;if(R){const Ie=function(He){if(He.patternJoinNone){const ai=He.segmentPoints.length/2,Ge=He.lineSoFar-He.segmentStart;for(let Pi=0;Pi<ai;++Pi){const ki=He.segmentPoints[2*Pi+1],vi=Math.round(He.segmentPoints[2*Pi])+.5+.25*ki;He.patternVertexArray.emplaceBack(vi,Ge,He.segmentStart),He.patternVertexArray.emplaceBack(vi,Ge,He.segmentStart)}He.segmentPoints.length=0}He.e1=He.e2=-1};if(Le&&ke<Lu){this.updateDistance(gt,at),this.addCurrentVertex(at,Pt,1,1,rt,ee),Ie(this),this.addCurrentVertex(at,qt,-1,-1,rt,ee);continue}if(gt){if(!yt){this.updateDistance(gt,at),this.addCurrentVertex(at,Pt,1,1,rt,ee),Ie(this);continue}fe="miter"}}let Ue=Pt.add(qt);Ue.x===0&&Ue.y===0||Ue._unit();const Ze=Ue.x*qt.x+Ue.y*qt.y,hi=Ze!==0?1/Ze:1/0,Ke=2*Math.sqrt(2-2*Ze),je=Ze<_x&&gt&&yt,Ye=Pt.x*qt.y-Pt.y*qt.x>0,Me=this.overscaling<=16?15*ri/(512*this.overscaling):0;if(Le&&fe==="round"){if(hi<b)fe="miter";else if(hi<=2){const Ie=Yg(at,-10,ri+10);fe=this.elevationType==="offset"&&(Ie||this.hasCrossSlope)?"miter":"fakeround"}}if(fe==="miter"&&hi>_&&(fe="bevel"),fe==="bevel"&&(hi>2&&(fe="flipbevel"),hi<_&&(fe="miter")),gt&&!(fe==="miter"&&je)&&this.updateDistance(gt,at),fe==="miter")if(je){const Ie=at.dist(gt);if(Ie>2*Me){const ai=at.sub(at.sub(gt)._mult(Me/Ie)._round());this.updateDistance(gt,ai),this.addCurrentVertex(ai,Pt,0,0,rt,ee),gt=ai}this.updateDistance(gt,at),Ue._mult(hi),this.addCurrentVertex(at,Ue,0,0,rt,ee);const He=at.dist(yt);if(He>2*Me){const ai=at.add(yt.sub(at)._mult(Me/He)._round());this.updateDistance(at,ai),this.addCurrentVertex(ai,qt,0,0,rt,ee),at=ai}}else Ue._mult(hi),this.addCurrentVertex(at,Ue,0,0,rt,ee);else if(fe==="flipbevel"){if(hi>100)Ue=qt.mult(-1);else{const Ie=hi*Pt.add(qt).mag()/Pt.sub(qt).mag();Ue._perp()._mult(Ie*(Ye?-1:1))}this.addCurrentVertex(at,Ue,0,0,rt,ee),this.addCurrentVertex(at,Ue.mult(-1),0,0,rt,ee)}else if(fe==="bevel"||fe==="fakeround"){ee!=null&&gt&&this.addCurrentVertex(at,Yt||Pt,-1,-1,rt,ee);const Ie=at.dist(gt)<=2*Me&&fe!=="bevel",He=Ue.mult(Ye?1:-1);He._mult(hi);const ai=qt.mult(Ye?-1:1),Ge=Pt.mult(Ye?-1:1),Pi=this.evaluateLineProgressFeatures(this.distance);if(ee==null&&(this.addHalfVertex(at,He.x,He.y,!1,!Ye,0,rt,Pi),Ie||this.addHalfVertex(at,He.x+2*Ge.x,He.y+2*Ge.y,!1,Ye,0,rt,Pi)),fe==="fakeround"){const ki=Math.round(180*Ke/Math.PI/20);this.addHalfVertex(at,Ge.x,Ge.y,!1,Ye,0,rt,Pi);for(let vi=0;vi<ki;vi++){let pi=vi/ki;if(pi!==.5){const _i=pi-.5;pi+=pi*_i*(pi-1)*((1.0904+ke*(ke*(3.55645-1.43519*ke)-3.2452))*_i*_i+(.848013+ke*(.215638*ke-1.06021)))}const dr=ai.sub(Ge)._mult(pi)._add(Ge)._unit();this.addHalfVertex(at,dr.x,dr.y,!1,Ye,0,rt,Pi)}this.addHalfVertex(at,ai.x,ai.y,!1,Ye,0,rt,Pi)}Ie||ee!=null||this.addHalfVertex(at,He.x+2*ai.x,He.y+2*ai.y,!1,Ye,0,rt,Pi),ee!=null&&yt&&this.addCurrentVertex(at,Bt||qt,1,1,rt,ee)}else if(fe==="butt")this.addCurrentVertex(at,Ue,0,0,rt,ee);else if(fe==="square"){if(!gt){const Ie=F?0:-1;this.addCurrentVertex(at,Ue,Ie,Ie,rt,ee)}if(this.addCurrentVertex(at,Ue,0,0,rt,ee),gt){const Ie=O?0:1;this.addCurrentVertex(at,Ue,Ie,Ie,rt,ee)}}else if(fe==="round"){if(gt){const Ie=!Le&&Yt?Yt:Pt;this.addCurrentVertex(at,Ie,0,0,rt,ee),!Le&&O||this.addCurrentVertex(at,Ie,1,1,rt,ee,!0)}if(yt){const Ie=!Le&&Bt?Bt:qt;!Le&&F||this.addCurrentVertex(at,Ie,-1,-1,rt,ee,!0),this.addCurrentVertex(at,Ie,0,0,rt,ee)}}}}addVerticesTo(t,r,l,u,m,_,b,E,P,R){const F=(r.w-t.w)/this.tessellationStep|0;let O=0;const $=this.scaledDistance;if(F>1){this.lineSoFar=t.w;const Y=(r.x-t.x)/F,rt=(r.y-t.y)/F,at=(r.z-t.z)/F,gt=(r.w-t.w)/F;for(let yt=1;yt<F;++yt){t.x+=Y,t.y+=rt,t.z+=at,this.lineSoFar+=gt,O+=gt;const Pt=this.evaluateLineProgressFeatures(this.prevDistance+O);this.scaledDistance=(this.prevDistance+O)/this.totalDistance,this.addHalfVertex(t,l,u,R,!1,b,P,Pt),this.addHalfVertex(t,m,_,R,!0,-E,P,Pt)}}this.lineSoFar=r.w,this.scaledDistance=$;const q=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(r,l,u,R,!1,b,P,q),this.addHalfVertex(r,m,_,R,!0,-E,P,q)}evaluateLineProgressFeatures(t){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+t)/this.totalFeatureLength):qi(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let r=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(r=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:r}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:r}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:r}}addCurrentVertex(t,r,l,u,m,_,b=!1){const E=r.x+r.y*l,P=r.y-r.x*l,R=r.y*u-r.x,F=-r.y-r.x*u;if(_!=null){const O=this.elevationType==="offset",$=-10,q=ri+10,Y=_.zOffset,rt=new Y_(t.x,t.y,Y,this.lineSoFar),at=!!O&&Yg(t,$,q),gt=this.lineSoFar,yt=this.distance;if(this.currentVertex)if(at){const Pt=this.currentVertexIsOutside,qt=this.currentVertex,Bt=new Y_(t.x,t.y,Y,this.lineSoFar);if(c0(qt,Bt,$,q),!Yg(Bt,$,q)){if(Pt){this.e1=this.e2=-1,this.distance-=qt.dist(rt),this.lineSoFar=qt.w;const Yt=this.evaluateLineProgressFeatures(qt.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(qt,E,P,b,!1,l,m,Yt),this.addHalfVertex(qt,R,F,b,!0,-u,m,Yt),this.prevDistance=this.distance}this.distance=this.prevDistance+qt.dist(Bt),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(qt,Bt,E,P,R,F,l,u,m,b),this.distance=yt,this.scaledDistance=this.distance/this.totalDistance}}else{const Pt=this.currentVertex;if(this.currentVertexIsOutside){c0(Pt,rt,$,q),this.e1=this.e2=-1,this.distance-=Pt.dist(rt),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=Pt.w;const qt=this.evaluateLineProgressFeatures(Pt.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(Pt,E,P,b,!1,l,m,qt),this.addHalfVertex(Pt,R,F,b,!0,-u,m,qt),this.prevDistance=this.distance,this.distance=yt,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(Pt,rt,E,P,R,F,l,u,m,b)}else at||(this.addHalfVertex(t,E,P,b,!1,l,m,_),this.addHalfVertex(t,R,F,b,!0,-u,m,_));this.currentVertex=rt,this.currentVertexIsOutside=at,this.lineSoFar=gt}else this.addHalfVertex(t,E,P,b,!1,l,m,_),this.addHalfVertex(t,R,F,b,!0,-u,m,_)}addHalfVertex({x:t,y:r},l,u,m,_,b,E,P){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),_||this.segmentPoints.push(this.lineSoFar-this.segmentStart,b)),this.layoutVertexArray.emplaceBack((t<<1)+(m?1:0),(r<<1)+(_?1:0),Math.round(63*l)+128,Math.round(63*u)+128,1+(b===0?0:b<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const F=Vi(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,F)}const R=E.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,R),E.primitiveLength++),_?this.e2=R:this.e1=R,P!=null&&this.zOffsetVertexArray.emplaceBack(P.zOffset,P.variableWidth,P.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(t,r){this.prevDistance=this.distance,this.distance+=t.dist(r),this.updateScaledDistance()}}function Yg(n,t,r){return n.x<t||n.x>r||n.y<t||n.y>r}let y0,x0;function v0(n,t,r){return t*(ri/(n.tileSize*Math.pow(2,r-n.tileID.overscaledZ)))}Si(vm,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const bl=(n,t,r)=>(1-r)*n+r*t;function $c(n,t){return 1/v0(n,1,t.tileZoom)}function Jp(n,t,r,l){return n.translatePosMatrix(l||t.tileID.projMatrix,t,r.paint.get("line-translate"),r.paint.get("line-translate-anchor"))}const nu=n=>{const t=[];Kp(n)&&t.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const r=n.paint.get("line-trim-offset");r[0]===0&&r[1]===0||t.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&t.push("RENDER_LINE_BORDER");const l=n.layout.get("line-join").constantOr("miter")==="none",u=!!n.paint.get("line-pattern").constantOr(1);return l&&u&&t.push("LINE_JOIN_NONE"),t};function Kp(n){const t=n.paint.get("line-dasharray").value;return t.kind!=="constant"||t.value}let ou;const av=()=>ou||(ou={layout:y0||(y0=new Xt({"line-cap":new Et(ft.layout_line["line-cap"]),"line-join":new Et(ft.layout_line["line-join"]),"line-miter-limit":new pt(ft.layout_line["line-miter-limit"]),"line-round-limit":new pt(ft.layout_line["line-round-limit"]),"line-sort-key":new Et(ft.layout_line["line-sort-key"]),"line-z-offset":new Et(ft.layout_line["line-z-offset"]),"line-elevation-reference":new pt(ft.layout_line["line-elevation-reference"]),"line-cross-slope":new pt(ft.layout_line["line-cross-slope"]),visibility:new pt(ft.layout_line.visibility),"line-width-unit":new pt(ft.layout_line["line-width-unit"])})),paint:x0||(x0=new Xt({"line-opacity":new Et(ft.paint_line["line-opacity"]),"line-color":new Et(ft.paint_line["line-color"]),"line-translate":new pt(ft.paint_line["line-translate"]),"line-translate-anchor":new pt(ft.paint_line["line-translate-anchor"]),"line-width":new Et(ft.paint_line["line-width"]),"line-gap-width":new Et(ft.paint_line["line-gap-width"]),"line-offset":new Et(ft.paint_line["line-offset"]),"line-blur":new Et(ft.paint_line["line-blur"]),"line-dasharray":new Et(ft.paint_line["line-dasharray"]),"line-pattern":new Et(ft.paint_line["line-pattern"]),"line-pattern-cross-fade":new pt(ft.paint_line["line-pattern-cross-fade"]),"line-gradient":new Kt(ft.paint_line["line-gradient"]),"line-trim-offset":new pt(ft.paint_line["line-trim-offset"]),"line-trim-fade-range":new pt(ft.paint_line["line-trim-fade-range"]),"line-trim-color":new pt(ft.paint_line["line-trim-color"]),"line-emissive-strength":new pt(ft.paint_line["line-emissive-strength"]),"line-border-width":new Et(ft.paint_line["line-border-width"]),"line-border-color":new Et(ft.paint_line["line-border-color"]),"line-occlusion-opacity":new pt(ft.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},ou);class Db extends Et{possiblyEvaluate(t,r){return r=new D(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,transition:r.transition,worldview:r.worldview}),super.possiblyEvaluate(t,r)}evaluate(t,r,l,u){return r=Object.assign({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(t,r,l,u)}}let oy;function lv(n,t){return t>0?t+2*n:n}const zb=vr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Lb=vr([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Rb=vr([{name:"a_projected_pos",components:4,type:"Float32"}],4);vr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const kb=vr([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Fb=vr([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),Bb=vr([{name:"a_texb",components:2,type:"Uint16"}]),Ob=vr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Nb=vr([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);vr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const cv=vr([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Vb=vr([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);vr([{name:"triangle",components:3,type:"Uint16"}]),vr([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),vr([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),vr([{type:"Float32",name:"offsetX"}]),vr([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Va=24;function Ub(n,t,r){return n.sections.forEach(l=>{l.text=function(u,m,_){const b=m.layout.get("text-transform").evaluate(_,{});return b==="uppercase"?u=u.toLocaleUpperCase():b==="lowercase"&&(u=u.toLocaleLowerCase()),S.applyArabicShaping&&(u=S.applyArabicShaping(u)),u}(l.text,t,r)}),n}const sy={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function jb(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}function Gb(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}const yx=4294967296,hv=1/yx,uv=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let b0=class{constructor(n=new Uint8Array(16)){this.buf=ArrayBuffer.isView(n)?n:new Uint8Array(n),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(n,t,r=this.length){for(;this.pos<r;){const l=this.readVarint(),u=l>>3,m=this.pos;this.type=7&l,n(u,t,this),this.pos===m&&this.skip(l)}return t}readMessage(n,t){return this.readFields(n,t,this.readVarint()+this.pos)}readFixed32(){const n=this.dataView.getUint32(this.pos,!0);return this.pos+=4,n}readSFixed32(){const n=this.dataView.getInt32(this.pos,!0);return this.pos+=4,n}readFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*yx;return this.pos+=8,n}readSFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*yx;return this.pos+=8,n}readFloat(){const n=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,n}readDouble(){const n=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,n}readVarint(n){const t=this.buf;let r,l;return l=t[this.pos++],r=127&l,l<128?r:(l=t[this.pos++],r|=(127&l)<<7,l<128?r:(l=t[this.pos++],r|=(127&l)<<14,l<128?r:(l=t[this.pos++],r|=(127&l)<<21,l<128?r:(l=t[this.pos],r|=(15&l)<<28,function(u,m,_){const b=_.buf;let E,P;if(P=b[_.pos++],E=(112&P)>>4,P<128||(P=b[_.pos++],E|=(127&P)<<3,P<128)||(P=b[_.pos++],E|=(127&P)<<10,P<128)||(P=b[_.pos++],E|=(127&P)<<17,P<128)||(P=b[_.pos++],E|=(127&P)<<24,P<128)||(P=b[_.pos++],E|=(1&P)<<31,P<128))return Jg(u,E,m);throw new Error("Expected varint not more than 10 bytes")}(r,n,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const n=this.readVarint();return n%2==1?(n+1)/-2:n/2}readBoolean(){return!!this.readVarint()}readString(){const n=this.readVarint()+this.pos,t=this.pos;return this.pos=n,n-t>=12&&uv?uv.decode(this.buf.subarray(t,n)):function(r,l,u){let m="",_=l;for(;_<u;){const b=r[_];let E,P,R,F=null,O=b>239?4:b>223?3:b>191?2:1;if(_+O>u)break;O===1?b<128&&(F=b):O===2?(E=r[_+1],(192&E)==128&&(F=(31&b)<<6|63&E,F<=127&&(F=null))):O===3?(E=r[_+1],P=r[_+2],(192&E)==128&&(192&P)==128&&(F=(15&b)<<12|(63&E)<<6|63&P,(F<=2047||F>=55296&&F<=57343)&&(F=null))):O===4&&(E=r[_+1],P=r[_+2],R=r[_+3],(192&E)==128&&(192&P)==128&&(192&R)==128&&(F=(15&b)<<18|(63&E)<<12|(63&P)<<6|63&R,(F<=65535||F>=1114112)&&(F=null))),F===null?(F=65533,O=1):F>65535&&(F-=65536,m+=String.fromCharCode(F>>>10&1023|55296),F=56320|1023&F),m+=String.fromCharCode(F),_+=O}return m}(this.buf,t,n)}readBytes(){const n=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,n);return this.pos=n,t}readPackedVarint(n=[],t){const r=this.readPackedEnd();for(;this.pos<r;)n.push(this.readVarint(t));return n}readPackedSVarint(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readSVarint());return n}readPackedBoolean(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readBoolean());return n}readPackedFloat(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readFloat());return n}readPackedDouble(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readDouble());return n}readPackedFixed32(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readFixed32());return n}readPackedSFixed32(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readSFixed32());return n}readPackedFixed64(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readFixed64());return n}readPackedSFixed64(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readSFixed64());return n}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(n){const t=7&n;if(t===0)for(;this.buf[this.pos++]>127;);else if(t===2)this.pos=this.readVarint()+this.pos;else if(t===5)this.pos+=4;else{if(t!==1)throw new Error(`Unimplemented type: ${t}`);this.pos+=8}}writeTag(n,t){this.writeVarint(n<<3|t)}realloc(n){let t=this.length||16;for(;t<this.pos+n;)t*=2;if(t!==this.length){const r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.dataView=new DataView(r.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeSFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*hv),!0),this.pos+=8}writeSFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*hv),!0),this.pos+=8}writeVarint(n){(n=+n||0)>268435455||n<0?function(t,r){let l,u;if(t>=0?(l=t%4294967296|0,u=t/4294967296|0):(l=~(-t%4294967296),u=~(-t/4294967296),4294967295^l?l=l+1|0:(l=0,u=u+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(m,_,b){b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,b.buf[b.pos]=127&(m>>>=7)}(l,0,r),function(m,_){const b=(7&m)<<4;_.buf[_.pos++]|=b|((m>>>=3)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m)))))}(u,r)}(n,this):(this.realloc(4),this.buf[this.pos++]=127&n|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=n>>>7&127))))}writeSVarint(n){this.writeVarint(n<0?2*-n-1:2*n)}writeBoolean(n){this.writeVarint(+n)}writeString(n){n=String(n),this.realloc(4*n.length),this.pos++;const t=this.pos;this.pos=function(l,u,m){for(let _,b,E=0;E<u.length;E++){if(_=u.charCodeAt(E),_>55295&&_<57344){if(!b){_>56319||E+1===u.length?(l[m++]=239,l[m++]=191,l[m++]=189):b=_;continue}if(_<56320){l[m++]=239,l[m++]=191,l[m++]=189,b=_;continue}_=b-55296<<10|_-56320|65536,b=null}else b&&(l[m++]=239,l[m++]=191,l[m++]=189,b=null);_<128?l[m++]=_:(_<2048?l[m++]=_>>6|192:(_<65536?l[m++]=_>>12|224:(l[m++]=_>>18|240,l[m++]=_>>12&63|128),l[m++]=_>>6&63|128),l[m++]=63&_|128)}return m}(this.buf,n,this.pos);const r=this.pos-t;r>=128&&dv(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r}writeFloat(n){this.realloc(4),this.dataView.setFloat32(this.pos,n,!0),this.pos+=4}writeDouble(n){this.realloc(8),this.dataView.setFloat64(this.pos,n,!0),this.pos+=8}writeBytes(n){const t=n.length;this.writeVarint(t),this.realloc(t);for(let r=0;r<t;r++)this.buf[this.pos++]=n[r]}writeRawMessage(n,t){this.pos++;const r=this.pos;n(t,this);const l=this.pos-r;l>=128&&dv(r,l,this),this.pos=r-1,this.writeVarint(l),this.pos+=l}writeMessage(n,t,r){this.writeTag(n,2),this.writeRawMessage(t,r)}writePackedVarint(n,t){t.length&&this.writeMessage(n,$b,t)}writePackedSVarint(n,t){t.length&&this.writeMessage(n,qb,t)}writePackedBoolean(n,t){t.length&&this.writeMessage(n,Wb,t)}writePackedFloat(n,t){t.length&&this.writeMessage(n,Zb,t)}writePackedDouble(n,t){t.length&&this.writeMessage(n,Hb,t)}writePackedFixed32(n,t){t.length&&this.writeMessage(n,Xb,t)}writePackedSFixed32(n,t){t.length&&this.writeMessage(n,Yb,t)}writePackedFixed64(n,t){t.length&&this.writeMessage(n,Jb,t)}writePackedSFixed64(n,t){t.length&&this.writeMessage(n,Kb,t)}writeBytesField(n,t){this.writeTag(n,2),this.writeBytes(t)}writeFixed32Field(n,t){this.writeTag(n,5),this.writeFixed32(t)}writeSFixed32Field(n,t){this.writeTag(n,5),this.writeSFixed32(t)}writeFixed64Field(n,t){this.writeTag(n,1),this.writeFixed64(t)}writeSFixed64Field(n,t){this.writeTag(n,1),this.writeSFixed64(t)}writeVarintField(n,t){this.writeTag(n,0),this.writeVarint(t)}writeSVarintField(n,t){this.writeTag(n,0),this.writeSVarint(t)}writeStringField(n,t){this.writeTag(n,2),this.writeString(t)}writeFloatField(n,t){this.writeTag(n,5),this.writeFloat(t)}writeDoubleField(n,t){this.writeTag(n,1),this.writeDouble(t)}writeBooleanField(n,t){this.writeVarintField(n,+t)}};function Jg(n,t,r){return r?4294967296*t+(n>>>0):4294967296*(t>>>0)+(n>>>0)}function dv(n,t,r){const l=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(l);for(let u=r.pos-1;u>=n;u--)r.buf[u+l]=r.buf[u]}function $b(n,t){for(let r=0;r<n.length;r++)t.writeVarint(n[r])}function qb(n,t){for(let r=0;r<n.length;r++)t.writeSVarint(n[r])}function Zb(n,t){for(let r=0;r<n.length;r++)t.writeFloat(n[r])}function Hb(n,t){for(let r=0;r<n.length;r++)t.writeDouble(n[r])}function Wb(n,t){for(let r=0;r<n.length;r++)t.writeBoolean(n[r])}function Xb(n,t){for(let r=0;r<n.length;r++)t.writeFixed32(n[r])}function Yb(n,t){for(let r=0;r<n.length;r++)t.writeSFixed32(n[r])}function Jb(n,t){for(let r=0;r<n.length;r++)t.writeFixed64(n[r])}function Kb(n,t){for(let r=0;r<n.length;r++)t.writeSFixed64(n[r])}const xx=3;function Qb(n,t,r){t.glyphs=[],n===1&&r.readMessage(tw,t)}function tw(n,t,r){if(n===3){const{id:l,bitmap:u,width:m,height:_,left:b,top:E,advance:P}=r.readMessage(ew,{});t.glyphs.push({id:l,bitmap:new Qd({width:m+2*xx,height:_+2*xx},u),metrics:{width:m,height:_,left:b,top:E,advance:P}})}else n===4?t.ascender=r.readSVarint():n===5&&(t.descender=r.readSVarint())}function ew(n,t,r){n===1?t.id=r.readVarint():n===2?t.bitmap=r.readBytes():n===3?t.width=r.readVarint():n===4?t.height=r.readVarint():n===5?t.left=r.readSVarint():n===6?t.top=r.readSVarint():n===7&&(t.advance=r.readVarint())}const pv=xx,_h={horizontal:1,vertical:2,horizontalOnly:3};class ay{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(t,r){const l=new ay;return l.scale=t||1,l.fontStack=r,l}static forImage(t){const r=new ay;return r.image=t,r}}class Kg{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,r,l){const u=new Kg;for(let m=0;m<t.sections.length;m++){const _=t.sections[m];_.image?u.addImageSection(_,l):u.addTextSection(_,r)}return u}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCodePoint(t){return this.text.codePointAt(t)}verticalizePunctuation(t){this.text=function(r,l){let u="";for(let m=0;m<r.length;m++){const _=r.charCodeAt(m+1)||null,b=r.charCodeAt(m-1)||null;u+=!l&&(_&&Zd(_)&&!sy[r[m+1]]||b&&Zd(b)&&!sy[r[m-1]])||!sy[r[m]]?r[m]:sy[r[m]]}return u}(this.text,t)}trim(){let t=0;for(let l=0;l<this.text.length&&w0[this.text.charCodeAt(l)];l++)t++;let r=this.text.length;for(let l=this.text.length-1;l>=0&&l>=t&&w0[this.text.charCodeAt(l)];l--)r--;this.text=this.text.substring(t,r),this.sectionIndex=this.sectionIndex.slice(t,r)}substring(t,r){const l=new Kg;return l.text=this.text.substring(t,r),l.sectionIndex=this.sectionIndex.slice(t,r),l.sections=this.sections,l}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,r)=>Math.max(t,this.sections[r].scale),0)}addTextSection(t,r){this.text+=t.text,this.sections.push(ay.forText(t.scale,t.fontStack||r));const l=this.sections.length-1;for(let u=0;u<t.text.length;++u)this.sectionIndex.push(l)}addImageSection(t,r){const l=t.image?t.image.getPrimary():null;if(!l)return void qi("Can't add FormattedSection with an empty image.");l.scaleSelf(r);const u=this.getNextImageSectionCharCode();u?(this.text+=String.fromCodePoint(u),this.sections.push(ay.forImage(l)),this.sectionIndex.push(this.sections.length-1)):qi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function vx(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y=1){const rt=Kg.fromFeature(n,u,Y);F===_h.vertical&&rt.verticalizePunctuation(O);let at=[];const gt=function(Yt,ee,ne,Le,fe,ke){if(!Yt)return[];const Ue=[],Ze=function(Ye,Me,Ie,He,ai,Ge){let Pi=0;for(let ki=0;ki<Ye.length();ki++){const vi=Ye.getSection(ki);Pi+=fv(Ye.getCodePoint(ki),vi,He,ai,Me,Ge)}return Pi/Math.max(1,Math.ceil(Pi/Ie))}(Yt,ee,ne,Le,fe,ke),hi=Yt.text.indexOf("")>=0;let Ke=0;for(let Ye=0;Ye<Yt.length();Ye++){const Me=Yt.getSection(Ye),Ie=Yt.getCodePoint(Ye);if(w0[Ie]||(Ke+=fv(Ie,Me,Le,fe,ee,ke)),Ye<Yt.length()-1){const He=!((je=Ie)<11904||!($i["Bopomofo Extended"](je)||$i.Bopomofo(je)||$i["CJK Compatibility Forms"](je)||$i["CJK Compatibility Ideographs"](je)||$i["CJK Compatibility"](je)||$i["CJK Radicals Supplement"](je)||$i["CJK Strokes"](je)||$i["CJK Symbols and Punctuation"](je)||$i["CJK Unified Ideographs Extension A"](je)||$i["CJK Unified Ideographs"](je)||$i["Enclosed CJK Letters and Months"](je)||$i["Halfwidth and Fullwidth Forms"](je)||$i.Hiragana(je)||$i["Ideographic Description Characters"](je)||$i["Kangxi Radicals"](je)||$i["Katakana Phonetic Extensions"](je)||$i.Katakana(je)||$i["Vertical Forms"](je)||$i["Yi Radicals"](je)||$i["Yi Syllables"](je)));(iw[Ie]||He||Me.image)&&Ue.push(gv(Ye+1,Ke,Ze,Ue,rw(Ie,Yt.getCodePoint(Ye+1),He&&hi),!1))}}var je;return _v(gv(Yt.length(),Ke,Ze,Ue,0,!0))}(rt,P,m,t,l,$),{processBidirectionalText:yt,processStyledBidirectionalText:Pt}=S;if(yt&&rt.sections.length===1){const Yt=yt(rt.toString(),gt);for(const ee of Yt){const ne=new Kg;ne.text=ee,ne.sections=rt.sections;for(let Le=0;Le<ee.length;Le++)ne.sectionIndex.push(0);at.push(ne)}}else if(Pt){const Yt=Pt(rt.text,rt.sectionIndex,gt);for(const ee of Yt){const ne=new Kg;ne.text=ee[0],ne.sectionIndex=ee[1],ne.sections=rt.sections,at.push(ne)}}else at=function(Yt,ee){const ne=[],Le=Yt.text;let fe=0;for(const ke of ee)ne.push(Yt.substring(fe,ke)),fe=ke;return fe<Le.length&&ne.push(Yt.substring(fe,Le.length)),ne}(rt,gt);const qt=[],Bt={positionedLines:qt,text:rt.toString(),top:R[1],bottom:R[1],left:R[0],right:R[0],writingMode:F,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(Yt,ee,ne,Le,fe,ke,Ue,Ze,hi,Ke,je,Ye){let Me=0,Ie=0,He=0;const ai=Ze==="right"?1:Ze==="left"?0:.5;let Ge=!1;for(const _i of fe){const Wi=_i.getSections();for(const mr of Wi){if(mr.image)continue;const Lr=ee[mr.fontStack];if(Lr&&(Ge=Lr.ascender!==void 0&&Lr.descender!==void 0,!Ge))break}if(!Ge)break}let Pi=0;for(const _i of fe){_i.trim();const Wi=_i.getMaxScale(),mr=(Wi-1)*Va,Lr={positionedGlyphs:[],lineOffset:0};Yt.positionedLines[Pi]=Lr;const rn=Lr.positionedGlyphs;let _r=0;if(!_i.length()){Ie+=ke,++Pi;continue}let pn=0,fn=0;for(let Ot=0;Ot<_i.length();Ot++){const Rt=_i.getSection(Ot),Oe=_i.getSectionIndex(Ot),di=_i.getCodePoint(Ot);let Ne=Rt.scale,fi=null,Gi=null,Ni=null,Tr=Va,er=0,Bi=hi;Bi===_h.vertical&&((ki=di)===12312||ki===12313||ki===12316||ki===12540||ki===12448)&&(Bi=_h.horizontal);const un=!(Bi===_h.horizontal||!je&&!Wh(di)||je&&(w0[di]||Xh(di)));if(Rt.image){const Nn=Le.get(Rt.image.toString());if(!Nn)continue;Ni=Rt.image,Yt.iconsInText=Yt.iconsInText||!0,Gi=Nn.paddedRect;const nr=Nn.displaySize;Ne=Ne*Va/Ye,fi={width:nr[0],height:nr[1],left:0,top:-pv,advance:un?nr[1]:nr[0],localGlyph:!1},er=Ge?-fi.height*Ne:Wi*Va-17-nr[1]*Ne,Tr=fi.advance;const Qr=(un?nr[0]:nr[1])*Ne-Va*Wi;Qr>0&&Qr>_r&&(_r=Qr)}else{const Nn=ne[Rt.fontStack];if(!Nn)continue;Nn[di]&&(Gi=Nn[di]);const nr=ee[Rt.fontStack];if(!nr)continue;const Qr=nr.glyphs[di];if(!Qr)continue;if(fi=Qr.metrics,Tr=di!==8203?Va:0,Ge){const Vn=nr.ascender!==void 0?Math.abs(nr.ascender):0,In=nr.descender!==void 0?Math.abs(nr.descender):0,jo=(Vn+In)*Ne;pn<jo&&(pn=jo,fn=(Vn-In)/2*Ne),er=-Vn*Ne}else er=(Wi-Ne)*Va-17}un?(Yt.verticalizable=!0,rn.push({glyph:di,image:Ni,x:Me,y:Ie+er,vertical:un,scale:Ne,localGlyph:fi.localGlyph,fontStack:Rt.fontStack,sectionIndex:Oe,metrics:fi,rect:Gi}),Me+=Tr*Ne+Ke):(rn.push({glyph:di,image:Ni,x:Me,y:Ie+er,vertical:un,scale:Ne,localGlyph:fi.localGlyph,fontStack:Rt.fontStack,sectionIndex:Oe,metrics:fi,rect:Gi}),Me+=fi.advance*Ne+Ke)}rn.length!==0&&(He=Math.max(Me-Ke,He),Ge?yv(rn,ai,_r,fn,ke*Wi/2):yv(rn,ai,_r,0,ke/2)),Me=0;const Co=ke*Wi+_r;Lr.lineOffset=Math.max(_r,mr),Ie+=Co,++Pi}var ki;const vi=Ie,{horizontalAlign:pi,verticalAlign:dr}=bx(Ue);(function(_i,Wi,mr,Lr,rn,_r){const pn=(Wi-mr)*rn,fn=-_r*Lr;for(const Co of _i)for(const Ot of Co.positionedGlyphs)Ot.x+=pn,Ot.y+=fn})(Yt.positionedLines,ai,pi,dr,He,vi),Yt.top+=-dr*vi,Yt.bottom=Yt.top+vi,Yt.left+=-pi*He,Yt.right=Yt.left+He,Yt.hasBaseline=Ge}(Bt,t,r,l,at,_,b,E,F,P,O,q),!function(Yt){for(const ee of Yt)if(ee.positionedGlyphs.length!==0)return!1;return!0}(qt))return Bt}const w0={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},iw={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function fv(n,t,r,l,u,m){if(t.image){const _=l.get(t.image.toString());return _?_.displaySize[0]*t.scale*Va/m+u:0}{const _=r[t.fontStack],b=_&&_.glyphs[n];return b?b.metrics.advance*t.scale+u:0}}function mv(n,t,r,l){const u=Math.pow(n-t,2);return l?n<t?u/2:2*u:u+Math.abs(r)*r}function rw(n,t,r){let l=0;return n===10&&(l-=1e4),r&&(l+=150),n!==40&&n!==65288||(l+=50),t!==41&&t!==65289||(l+=50),l}function gv(n,t,r,l,u,m){let _=null,b=mv(t,r,u,m);for(const E of l){const P=mv(t-E.x,r,u,m)+E.badness;P<=b&&(_=E,b=P)}return{index:n,x:t,priorBreak:_,badness:b}}function _v(n){return n?_v(n.priorBreak).concat(n.index):[]}function bx(n){let t=.5,r=.5;switch(n){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:t,verticalAlign:r}}function yv(n,t,r,l,u){if(!(t||r||l||u))return;const m=n.length-1,_=n[m],b=(_.x+_.metrics.advance*_.scale)*t;for(let E=0;E<=m;E++)n[E].x-=b,n[E].y+=r+l+u}function xv(n){return n.imagePrimary!==void 0&&n.top!==void 0&&n.bottom!==void 0&&n.left!==void 0&&n.right!==void 0}function T0(n,t,r,l){const{horizontalAlign:u,verticalAlign:m}=bx(l),_=r[0]-n.displaySize[0]*u,b=r[1]-n.displaySize[1]*m;return{imagePrimary:n,imageSecondary:t,top:b,bottom:b+n.displaySize[1],left:_,right:_+n.displaySize[0]}}function wx(n,t,r,l,u,m){const _=n.imagePrimary;let b;if(_.content){const rt=_.content,at=_.pixelRatio||1;b=[rt[0]/at,rt[1]/at,_.displaySize[0]-rt[2]/at,_.displaySize[1]-rt[3]/at]}const E=t.left*m,P=t.right*m;let R,F,O,$;r==="width"||r==="both"?($=u[0]+E-l[3],F=u[0]+P+l[1]):($=u[0]+(E+P-_.displaySize[0])/2,F=$+_.displaySize[0]);const q=t.top*m,Y=t.bottom*m;return r==="height"||r==="both"?(R=u[1]+q-l[0],O=u[1]+Y+l[2]):(R=u[1]+(q+Y-_.displaySize[1])/2,O=R+_.displaySize[1]),{imagePrimary:_,imageSecondary:void 0,top:R,right:F,bottom:O,left:$,collisionPadding:b}}function vv(n){return!n.imagePrimary.stretchX}function bv(n){return!n.imagePrimary.stretchY}function wv(n){return{width:n.right-n.left,height:n.bottom-n.top}}const op=128;function Qg(n,t,r){const{expression:l}=t;if(l.kind==="constant")return{kind:"constant",layoutSize:l.evaluate(new D(n+1,{worldview:r}))};if(l.kind==="source")return{kind:"source"};{const{zoomStops:u,interpolationType:m}=l;let _=0;for(;_<u.length&&u[_]<=n;)_++;_=Math.max(0,_-1);let b=_;for(;b<u.length&&u[b]<n+1;)b++;b=Math.min(u.length-1,b);const E=u[_],P=u[b];return l.kind==="composite"?{kind:"composite",minZoom:E,maxZoom:P,interpolationType:m}:{kind:"camera",minZoom:E,maxZoom:P,minSize:l.evaluate(new D(E,{worldview:r})),maxSize:l.evaluate(new D(P,{worldview:r})),interpolationType:m}}}function Tx(n,{uSize:t,uSizeT:r},{lowerSize:l,upperSize:u}){return n.kind==="source"?l/op:n.kind==="composite"?Vi(l/op,u/op,r):t}function t_(n,t,r=1){let l=0,u=0;if(n.kind==="constant")u=n.layoutSize*r;else if(n.kind!=="source"){const{interpolationType:m,minZoom:_,maxZoom:b}=n,E=m?tt(dl.interpolationFactor(m,t,_,b),0,1):0;n.kind==="camera"?u=Vi(n.minSize,n.maxSize,E)*r:l=E*r}return{uSizeT:l,uSize:u}}class Ff extends Ae{constructor(t,r,l,u,m){super(t,r),this.angle=u,this.z=l,m!==void 0&&(this.segment=m)}clone(){return new Ff(this.x,this.y,this.z,this.angle,this.segment)}}function Tv(n,t,r,l,u){if(t.segment===void 0)return!0;let m=t,_=t.segment+1,b=0;for(;b>-r/2;){if(_--,_<0)return!1;b-=n[_].dist(m),m=n[_]}b+=n[_].dist(n[_+1]),_++;const E=[];let P=0;for(;b<r/2;){const R=n[_],F=n[_+1];if(!F)return!1;let O=n[_-1].angleTo(R)-R.angleTo(F);for(O=Math.abs((O+3*Math.PI)%(2*Math.PI)-Math.PI),E.push({distance:b,angleDelta:O}),P+=O;b-E[0].distance>l;)P-=E.shift().angleDelta;if(P>u)return!1;_++,b+=R.dist(F)}return!0}function Sv(n){let t=0;for(let r=0;r<n.length-1;r++)t+=n[r].dist(n[r+1]);return t}function Iv(n,t,r){return n?.6*t*r:0}function Ev(n,t){return Math.max(n?n.right-n.left:0,t?t.right-t.left:0)}function nw(n,t,r,l,u,m){const _=Iv(r,u,m),b=Ev(r,l)*m;let E=0;const P=Sv(n)/2;for(let R=0;R<n.length-1;R++){const F=n[R],O=n[R+1],$=F.dist(O);if(E+$>P){const q=(P-E)/$,Y=Vi(F.x,O.x,q),rt=Vi(F.y,O.y,q),at=new Ff(Y,rt,0,O.angleTo(F),R);return!_||Tv(n,at,b,_,t)?at:void 0}E+=$}}function ow(n,t,r,l,u,m,_,b,E){const P=Iv(l,m,_),R=Ev(l,u),F=R*_,O=n[0].x===0||n[0].x===E||n[0].y===0||n[0].y===E;return t-F<t/4&&(t=F+t/4),Av(n,O?t/2*b%t:(R/2+2*m)*_*b%t,t,P,r,F,O,!1,E)}function Av(n,t,r,l,u,m,_,b,E){const P=m/2,R=Sv(n);let F=0,O=t-r,$=[];for(let q=0;q<n.length-1;q++){const Y=n[q],rt=n[q+1],at=Y.dist(rt),gt=rt.angleTo(Y);for(;O+r<F+at;){O+=r;const yt=(O-F)/at,Pt=Vi(Y.x,rt.x,yt),qt=Vi(Y.y,rt.y,yt);if(Pt>=0&&Pt<E&&qt>=0&&qt<E&&O-P>=0&&O+P<=R){const Bt=new Ff(Pt,qt,0,gt,q);l&&!Tv(n,Bt,m,l,u)||$.push(Bt)}}F+=at}return b||$.length||_||($=Av(n,F/2,r,l,u,m,_,!0,E)),$}function Pv(n){let t=0,r=0;for(const _ of n)t+=_.w*_.h,r=Math.max(r,_.w);n.sort((_,b)=>b.h-_.h);const l=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),r),h:1/0}];let u=0,m=0;for(const _ of n)for(let b=l.length-1;b>=0;b--){const E=l[b];if(!(_.w>E.w||_.h>E.h)){if(_.x=E.x,_.y=E.y,m=Math.max(m,_.y+_.h),u=Math.max(u,_.x+_.w),_.w===E.w&&_.h===E.h){const P=l.pop();P&&b<l.length&&(l[b]=P)}else _.h===E.h?(E.x+=_.w,E.w-=_.w):_.w===E.w?(E.y+=_.h,E.h-=_.h):(l.push({x:E.x+_.w,y:E.y,w:E.w-_.w,h:_.h}),E.y+=_.h,E.h-=_.h);break}}return{w:u,h:m,fill:t/(u*m)||0}}Si(Ff,"Anchor");const og=1;class ly{static getImagePositionScale(t,r,l){if(r&&t&&t.options&&t.options.transform){const u=t.options.transform;return{x:u.a,y:u.d}}return{x:l,y:l}}constructor(t,r,l,u){this.paddedRect=t;const{pixelRatio:m,version:_,stretchX:b,stretchY:E,content:P,sdf:R,usvg:F}=r;this.pixelRatio=m,this.stretchX=b,this.stretchY=E,this.content=P,this.version=_,this.padding=l,this.sdf=R,this.usvg=F,this.scale=ly.getImagePositionScale(u,F,m)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function Sx(n,t,r){const l=cl.parse(n),u=function(m,_,b=[1,1]){return{x:0,y:0,w:(m.data?m.data.width:m.width*b[0])+2*_,h:(m.data?m.data.height:m.height*b[1])+2*_}}(t,r,[l.options.transform.a,l.options.transform.d]);return{bin:u,imagePosition:new ly(u,t,r,l),imageVariant:l}}class Mv{constructor(t,r,l){const u=new Map,m=new Map;this.haveRenderCallbacks=[];const _=[];this.addImages(t,u,og,_),this.addImages(r,m,2,_);const{w:b,h:E}=Pv(_),P=new Ta({width:b||1,height:E||1});for(const[R,F]of t.entries()){const O=u.get(R).paddedRect;Ta.copy(F.data,P,{x:0,y:0},{x:O.x+og,y:O.y+og},F.data,null,F.sdf)}for(const[R,F]of r.entries()){const O=m.get(R),$=O.paddedRect;let q=O.padding;const Y=$.x+q,rt=$.y+q,at=F.data.width,gt=F.data.height;q=q>1?q-1:q,Ta.copy(F.data,P,{x:0,y:0},{x:Y,y:rt},F.data,l),Ta.copy(F.data,P,{x:0,y:gt-q},{x:Y,y:rt-q},{width:at,height:q},l),Ta.copy(F.data,P,{x:0,y:0},{x:Y,y:rt+gt},{width:at,height:q},l),Ta.copy(F.data,P,{x:at-q,y:0},{x:Y-q,y:rt},{width:q,height:gt},l),Ta.copy(F.data,P,{x:0,y:0},{x:Y+at,y:rt},{width:q,height:gt},l),Ta.copy(F.data,P,{x:at-q,y:gt-q},{x:Y-q,y:rt-q},{width:q,height:q},l),Ta.copy(F.data,P,{x:0,y:gt-q},{x:Y+at,y:rt-q},{width:q,height:q},l),Ta.copy(F.data,P,{x:0,y:0},{x:Y+at,y:rt+gt},{width:q,height:q},l),Ta.copy(F.data,P,{x:at-q,y:0},{x:Y-q,y:rt+gt},{width:q,height:q},l)}this.lut=l,this.image=P,this.iconPositions=u,this.patternPositions=m}addImages(t,r,l,u){for(const[m,_]of t.entries()){const{bin:b,imagePosition:E,imageVariant:P}=Sx(m,_,l);r.set(m,E),u.push(b),_.hasRenderCallback&&this.haveRenderCallbacks.push(P.id)}}patchUpdatedImages(t,r,l){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(u=>t.hasImage(u,l)),t.dispatchRenderCallbacks(this.haveRenderCallbacks,l);for(const u of t.getUpdatedImages(l)){for(const m of this.iconPositions.keys()){const _=cl.parse(m);if(Zo.isEqual(_.id,u)){const b=t.getImage(u,l);this.patchUpdatedImage(this.iconPositions.get(m),b,r,null)}}for(const m of this.patternPositions.keys()){const _=cl.parse(m);if(Zo.isEqual(_.id,u)){const b=t.getImage(u,l);this.patchUpdatedImage(this.patternPositions.get(m),b,r,this.lut)}}}}patchUpdatedImage(t,r,l,u=null){if(!t||!r||t.version===r.version)return;t.version=r.version;const[m,_]=t.tl,b=t.sdf;if(this.lut||b){const E={width:r.data.width,height:r.data.height},P=new Ta(E);Ta.copy(r.data,P,{x:0,y:0},{x:0,y:0},E,u,b),l.update(P,{position:{x:m,y:_}})}else l.update(r.data,{position:{x:m,y:_}})}}Si(ly,"ImagePosition"),Si(Mv,"ImageAtlas");const cy=1e20;function Cv(n,t,r,l,u,m,_,b,E){for(let P=t;P<t+l;P++)Dv(n,r*m+P,m,u,_,b,E);for(let P=r;P<r+u;P++)Dv(n,P*m+t,1,l,_,b,E)}function Dv(n,t,r,l,u,m,_){m[0]=0,_[0]=-cy,_[1]=cy,u[0]=n[t];for(let b=1,E=0,P=0;b<l;b++){u[b]=n[t+b*r];const R=b*b;do{const F=m[E];P=(u[b]-u[F]+R-F*F)/(b-F)/2}while(P<=_[E]&&--E>-1);E++,m[E]=b,_[E]=P,_[E+1]=cy}for(let b=0,E=0;b<l;b++){for(;_[E+1]<b;)E++;const P=m[E],R=b-P;n[t+b*r]=u[P]+R*R}}const sp=2,Ix={none:0,ideographs:1,all:2};class e_{constructor(t,r,l){this.requestManager=t,this.localGlyphMode=r,this.localFontFamily=l,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t){this.url=t}getGlyphs(t,r){const l=[],u=this.url||Gn.GLYPHS_URL;for(const m in t)for(const _ of t[m])l.push({stack:m,id:_});Wt(l,({stack:m,id:_},b)=>{let E=this.entries[m];E||(E=this.entries[m]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let P=E.glyphs[_];if(P!==void 0)return void b(null,{stack:m,id:_,glyph:P});if(P=this._tinySDF(E,m,_),P)return E.glyphs[_]=P,void b(null,{stack:m,id:_,glyph:P});const R=Math.floor(_/256);if(256*R>65535)return qi("glyphs > 65535 not supported"),void b(null,{stack:m,id:_,glyph:P});if(E.ranges[R])return void b(null,{stack:m,id:_,glyph:P});let F=E.requests[R];F||(F=E.requests[R]=[],e_.loadGlyphRange(m,R,u,this.requestManager,(O,$)=>{if($){E.ascender=$.ascender,E.descender=$.descender;for(const q in $.glyphs)this._doesCharSupportLocalGlyph(+q)||(E.glyphs[+q]=$.glyphs[+q]);E.ranges[R]=!0}for(const q of F)q(O,$);delete E.requests[R]})),F.push((O,$)=>{O?b(O):$&&b(null,{stack:m,id:_,glyph:$.glyphs[_]||null})})},(m,_)=>{if(m)r(m);else if(_){const b={};for(const{stack:E,id:P,glyph:R}of _)b[E]===void 0&&(b[E]={}),b[E].glyphs===void 0&&(b[E].glyphs={}),b[E].glyphs[P]=R&&{id:R.id,bitmap:R.bitmap.clone(),metrics:R.metrics},b[E].ascender=this.entries[E].ascender,b[E].descender=this.entries[E].descender;r(null,b)}})}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==Ix.none&&(this.localGlyphMode===Ix.all?!!this.localFontFamily:!!this.localFontFamily&&($i["CJK Unified Ideographs"](t)||$i["Hangul Syllables"](t)||$i.Hiragana(t)||$i.Katakana(t)||$i["CJK Symbols and Punctuation"](t)||$i["CJK Unified Ideographs Extension A"](t)||$i["CJK Unified Ideographs Extension B"](t)||$i.Osage(t)))}_tinySDF(t,r,l){const u=this.localFontFamily;if(!u||!this._doesCharSupportLocalGlyph(l))return;let m=t.tinySDF;if(!m){let Y="400";/bold/i.test(r)?Y="900":/medium/i.test(r)?Y="500":/light/i.test(r)&&(Y="200"),m=t.tinySDF=new e_.TinySDF({fontFamily:u,fontWeight:Y,fontSize:24*sp,buffer:3*sp,radius:8*sp}),m.fontWeight=Y}if(this.localGlyphs[m.fontWeight][l])return this.localGlyphs[m.fontWeight][l];const _=String.fromCodePoint(l),{data:b,width:E,height:P,glyphWidth:R,glyphHeight:F,glyphLeft:O,glyphTop:$,glyphAdvance:q}=m.draw(_);return this.localGlyphs[m.fontWeight][l]={id:l,bitmap:new Qd({width:E,height:P},b),metrics:{width:R/sp,height:F/sp,left:O/sp,top:$/sp-27,advance:q/sp,localGlyph:!0}}}}e_.loadGlyphRange=function(n,t,r,l,u){const m=256*t,_=m+255,b=l.transformRequest(l.normalizeGlyphsURL(r).replace("{fontstack}",n).replace("{range}",`${m}-${_}`),Is.Glyphs);Pl(b,(E,P)=>{if(E)u(E);else if(P){const R={},F=function(O){return new b0(O).readFields(Qb,{})}(P);for(const O of F.glyphs)R[O.id]=O;u(null,{glyphs:R,ascender:F.ascender,descender:F.descender})}})},e_.TinySDF=class{constructor({fontSize:n=24,buffer:t=3,radius:r=8,cutoff:l=.25,fontFamily:u="sans-serif",fontWeight:m="normal",fontStyle:_="normal",lang:b=null}={}){this.buffer=t,this.cutoff=l,this.radius=r,this.lang=b;const E=this.size=n+4*t,P=this._createCanvas(E),R=this.ctx=P.getContext("2d",{willReadFrequently:!0});R.font=`${_} ${m} ${n}px ${u}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(E*E),this.gridInner=new Float64Array(E*E),this.f=new Float64Array(E),this.z=new Float64Array(E+1),this.v=new Uint16Array(E)}_createCanvas(n){const t=document.createElement("canvas");return t.width=t.height=n,t}draw(n){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:l,actualBoundingBoxLeft:u,actualBoundingBoxRight:m}=this.ctx.measureText(n),_=Math.ceil(r),b=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(m-u))),E=Math.min(this.size-this.buffer,_+Math.ceil(l)),P=b+2*this.buffer,R=E+2*this.buffer,F=Math.max(P*R,0),O=new Uint8ClampedArray(F),$={data:O,width:P,height:R,glyphWidth:b,glyphHeight:E,glyphTop:_,glyphLeft:0,glyphAdvance:t};if(b===0||E===0)return $;const{ctx:q,buffer:Y,gridInner:rt,gridOuter:at}=this;this.lang&&(q.lang=this.lang),q.clearRect(Y,Y,b,E),q.fillText(n,Y,Y+_);const gt=q.getImageData(Y,Y,b,E);at.fill(cy,0,F),rt.fill(0,0,F);for(let yt=0;yt<E;yt++)for(let Pt=0;Pt<b;Pt++){const qt=gt.data[4*(yt*b+Pt)+3]/255;if(qt===0)continue;const Bt=(yt+Y)*P+Pt+Y;if(qt===1)at[Bt]=0,rt[Bt]=cy;else{const Yt=.5-qt;at[Bt]=Yt>0?Yt*Yt:0,rt[Bt]=Yt<0?Yt*Yt:0}}Cv(at,0,0,P,R,P,this.f,this.v,this.z),Cv(rt,Y,Y,b,E,P,this.f,this.v,this.z);for(let yt=0;yt<F;yt++){const Pt=Math.sqrt(at[yt])-Math.sqrt(rt[yt]);O[yt]=Math.round(255-255*(Pt/this.radius+this.cutoff))}return $}};const Qp=og;function zv(n,t){return n+t[1]-t[0]}function Ex(n,t,r,l,u=1){const m=[],_=n.imagePrimary,b=_.pixelRatio,E=_.paddedRect.w-2*Qp,P=_.paddedRect.h-2*Qp,R=(n.right-n.left)*u,F=(n.bottom-n.top)*u,O=_.stretchX||[[0,E]],$=_.stretchY||[[0,P]],q=O.reduce(zv,0),Y=$.reduce(zv,0),rt=E-q,at=P-Y;let gt=0,yt=q,Pt=0,qt=Y,Bt=0,Yt=rt,ee=0,ne=at;if(_.content&&l){const fe=_.content;gt=S0(O,0,fe[0]),Pt=S0($,0,fe[1]),yt=S0(O,fe[0],fe[2]),qt=S0($,fe[1],fe[3]),Bt=fe[0]-gt,ee=fe[1]-Pt,Yt=fe[2]-fe[0]-yt,ne=fe[3]-fe[1]-qt}const Le=(fe,ke,Ue,Ze)=>{const hi=I0(fe.stretch-gt,yt,R,n.left*u),Ke=E0(fe.fixed-Bt,Yt,fe.stretch,q),je=I0(ke.stretch-Pt,qt,F,n.top*u),Ye=E0(ke.fixed-ee,ne,ke.stretch,Y),Me=I0(Ue.stretch-gt,yt,R,n.left*u),Ie=E0(Ue.fixed-Bt,Yt,Ue.stretch,q),He=I0(Ze.stretch-Pt,qt,F,n.top*u),ai=E0(Ze.fixed-ee,ne,Ze.stretch,Y),Ge=new Ae(hi,je),Pi=new Ae(Me,je),ki=new Ae(Me,He),vi=new Ae(hi,He),pi=new Ae(Ke/b,Ye/b),dr=new Ae(Ie/b,ai/b),_i=t*Math.PI/180;if(_i){const pn=Math.sin(_i),fn=Math.cos(_i),Co=[fn,-pn,pn,fn];Ge._matMult(Co),Pi._matMult(Co),vi._matMult(Co),ki._matMult(Co)}const Wi=fe.stretch+fe.fixed,mr=Ue.stretch+Ue.fixed,Lr=ke.stretch+ke.fixed,rn=Ze.stretch+Ze.fixed,_r=n.imageSecondary;return{tl:Ge,tr:Pi,bl:vi,br:ki,texPrimary:{x:_.paddedRect.x+Qp+Wi,y:_.paddedRect.y+Qp+Lr,w:mr-Wi,h:rn-Lr},texSecondary:_r?{x:_r.paddedRect.x+Qp+Wi,y:_r.paddedRect.y+Qp+Lr,w:mr-Wi,h:rn-Lr}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:pi,pixelOffsetBR:dr,minFontScaleX:Yt/b/R,minFontScaleY:ne/b/F,isSDF:r}};if(l&&(_.stretchX||_.stretchY)){const fe=Lv(O,rt,q),ke=Lv($,at,Y);for(let Ue=0;Ue<fe.length-1;Ue++){const Ze=fe[Ue],hi=fe[Ue+1];for(let Ke=0;Ke<ke.length-1;Ke++)m.push(Le(Ze,ke[Ke],hi,ke[Ke+1]))}}else m.push(Le({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:E+1},{fixed:0,stretch:P+1}));return m}function sw(n,t){const r=n.stretchY||[[0,n.paddedRect.h-2*Qp]];return t&&(n.stretchX||n.stretchY)?Rv(n.stretchX||[[0,n.paddedRect.w-2*Qp]])*Rv(r):1}function S0(n,t,r){let l=0;for(const u of n)l+=Math.max(t,Math.min(r,u[1]))-Math.max(t,Math.min(r,u[0]));return l}function Lv(n,t,r){const l=[{fixed:-Qp,stretch:0}];for(const[u,m]of n){const _=l[l.length-1];l.push({fixed:u-_.stretch,stretch:_.stretch}),l.push({fixed:u-_.stretch,stretch:_.stretch+(m-u)})}return l.push({fixed:t+Qp,stretch:r}),l}function Rv(n){return 2*n.length+1}function I0(n,t,r,l){return n/t*r+l}function E0(n,t,r,l){return n-t*r/l}function aw(n,t,r,l){const u=t+n.positionedLines[l].lineOffset;return l===0?r+u/2:r+(u+(t+n.positionedLines[l-1].lineOffset))/2}function lw(n,t=1,r=!1){let l=1/0,u=1/0,m=-1/0,_=-1/0;const b=n[0];for(let $=0;$<b.length;$++){const q=b[$];(!$||q.x<l)&&(l=q.x),(!$||q.y<u)&&(u=q.y),(!$||q.x>m)&&(m=q.x),(!$||q.y>_)&&(_=q.y)}const E=Math.min(m-l,_-u);let P=E/2;const R=new Dd([],cw);if(E===0)return new Ae(l,u);for(let $=l;$<m;$+=E)for(let q=u;q<_;q+=E)R.push(new i_($+P,q+P,P,n));let F=function($){let q=0,Y=0,rt=0;const at=$[0];for(let gt=0,yt=at.length,Pt=yt-1;gt<yt;Pt=gt++){const qt=at[gt],Bt=at[Pt],Yt=qt.x*Bt.y-Bt.x*qt.y;Y+=(qt.x+Bt.x)*Yt,rt+=(qt.y+Bt.y)*Yt,q+=3*Yt}return new i_(Y/q,rt/q,0,$)}(n),O=R.length;for(;R.length;){const $=R.pop();($.d>F.d||!F.d)&&(F=$,r&&console.log("found best %d after %d probes",Math.round(1e4*$.d)/1e4,O)),$.max-F.d<=t||(P=$.h/2,R.push(new i_($.p.x-P,$.p.y-P,P,n)),R.push(new i_($.p.x+P,$.p.y-P,P,n)),R.push(new i_($.p.x-P,$.p.y+P,P,n)),R.push(new i_($.p.x+P,$.p.y+P,P,n)),O+=4)}return r&&(console.log(`num probes: ${O}`),console.log(`best distance: ${F.d}`)),F.p}function cw(n,t){return t.max-n.max}class i_{constructor(t,r,l,u){this.p=new Ae(t,r),this.h=l,this.d=function(m,_){let b=!1,E=1/0;for(let P=0;P<_.length;P++){const R=_[P];for(let F=0,O=R.length,$=O-1;F<O;$=F++){const q=R[F],Y=R[$];q.y>m.y!=Y.y>m.y&&m.x<(Y.x-q.x)*(m.y-q.y)/(Y.y-q.y)+q.x&&(b=!b),E=Math.min(E,yc(m,q,Y))}}return(b?1:-1)*Math.sqrt(E)}(this.p,u),this.max=this.d+this.h*Math.SQRT2}}const hw=Object.keys,Ax=Number.POSITIVE_INFINITY,uw=Math.sqrt(2);function A0(n,t,r,l){const u=n.collisionPadding||[0,0,0,0],m={top:n.top-u[1],bottom:n.bottom+u[3],left:n.left-u[0],right:n.right+u[2],scaled:!1};return l!==void 0&&function(_,b){_.top*=b,_.bottom*=b,_.left*=b,_.right*=b,_.scaled=!0}(m,l),r&&function(_,b){if(!b)return;const E=rr(b),P=new Ae(_.left,_.top),R=new Ae(_.right,_.top),F=new Ae(_.left,_.bottom),O=new Ae(_.right,_.bottom);P._rotateAround(E,new Ae(0,0)),R._rotateAround(E,new Ae(0,0)),F._rotateAround(E,new Ae(0,0)),O._rotateAround(E,new Ae(0,0)),_.left=Math.min(P.x,R.x,F.x,O.x),_.right=Math.max(P.x,R.x,F.x,O.x),_.top=Math.min(P.y,R.y,F.y,O.y),_.bottom=Math.max(P.y,R.y,F.y,O.y)}(m,r),t?{top:Math.min(t.top,m.top),bottom:Math.max(t.bottom,m.bottom),left:Math.min(t.left,m.left),right:Math.max(t.right,m.right),scaled:t.scaled||m.scaled}:m}function kv(n,[t,r]){let l=0,u=0;if(r===Ax){t<0&&(t=0);const m=t/uw;switch(n){case"top-right":case"top-left":u=m-7;break;case"bottom-right":case"bottom-left":u=7-m;break;case"bottom":u=7-t;break;case"top":u=t-7}switch(n){case"top-right":case"bottom-right":l=-m;break;case"top-left":case"bottom-left":l=m;break;case"left":l=t;break;case"right":l=-t}}else{switch(t=Math.abs(t),r=Math.abs(r),n){case"top-right":case"top-left":case"top":u=r-7;break;case"bottom-right":case"bottom-left":case"bottom":u=7-r}switch(n){case"top-right":case"bottom-right":case"right":l=-t;break;case"top-left":case"bottom-left":case"left":l=t}}return[l,u]}function dw(n,t,r,l,u,m,_,b,E,P,R){const F=n.layers[0],O=F.appearances;if(O.length===0)return{iconBBox:null,iconVerticalBBox:null};let $=null,q=null;const Y=l.get("icon-rotate").evaluate(u,{},m);t&&($=A0(t,$,Y,_),r)&&(q=A0(r,q,Y+90,_));const[rt,at]=l.get("icon-size-scale-range"),gt=tt(1,rt,at);for(const yt of O){const Pt=yt.getUnevaluatedProperties(),qt=Pt._values["icon-image"].value!==void 0,Bt=Pt._values["icon-size"].value!==void 0,Yt=Pt._values["icon-offset"].value!==void 0,ee=Pt._values["icon-rotate"].value!==void 0;if(qt||Bt||Yt||ee){const ne=Yt?F.getAppearanceValueAndResolveTokens(yt,"icon-offset",u,m,[]):null,Le=ne&&Array.isArray(ne)?ne:b,fe=ee?F.getAppearanceValueAndResolveTokens(yt,"icon-rotate",u,m,[]):null,ke=typeof fe=="number"?fe:Y,Ue=Bt?F.getAppearanceValueAndResolveTokens(yt,"icon-size",u,m,[]):null,Ze=typeof Ue=="number"?Ue*E.iconScaleFactor:_;let hi=null,Ke=null,je=null;if(qt){const Ye=F.getAppearanceValueAndResolveTokens(yt,"icon-image",u,m,[]);if(Ye){const Me=n.getResolvedImageFromTokens(Ye),Ie=Pt._values["icon-size"],He=hy(Me,Qg(n.zoom,Ie,n.worldview),Ie,m,n.zoom,u,n.pixelRatio,gt,n.worldview);je=P.get(He.iconPrimary.toString())}}else t&&(je=t.imagePrimary);je&&(hi=T0(je,null,Le,R),n.allowVerticalPlacement&&(Ke=T0(je,null,Le,R))),hi&&($=A0(hi,$,ke,Ze)),Ke&&(q=A0(Ke,q,ke+90,Ze))}}return{iconBBox:$,iconVerticalBBox:q}}function P0(n,t,r,l,u,m,_,b,E){if(!t||!t.usvg)return;const P=wv(l),R=wv(u),F=m!=="both"&&m!=="width"||!vv(l)?1:R.width/P.width,O=m!=="both"&&m!=="height"||!bv(l)?1:R.height/P.height;r.scaleSelf(F,O);const $=r.toString();_.set($,r),b.set($,t);const{imagePosition:q}=Sx($,t,og);E.set($,q)}function Fv(n,t,r,l,u,m,_,b,E){if(!n)return;const P=function(R,F,O,$,q,Y){if(R.kind==="camera")return R.maxSize;if(R.kind==="composite"){const rt=F.possiblyEvaluate(new D(R.maxZoom,{worldview:Y}),O).evaluate(q,{},O),at=F.possiblyEvaluate(new D(R.minZoom,{worldview:Y}),O).evaluate(q,{},O);return Math.max(rt,at)}return F.possiblyEvaluate(new D($,{worldview:Y})).evaluate(q,{},O)}(t,r,l,u,m,E);return n.scaleSelf(P*b*_)}function hy(n,t,r,l,u,m,_,b,E){return{iconPrimary:Fv(n.getPrimary(),t,r,l,u,m,_,b,E),iconSecondary:Fv(n.getSecondary(),t,r,l,u,m,_,b,E)}}function pw(n,t,r){if(!t)return;const l=r.get(n.toString()),u=r.get(t.toString());l&&u&&(l.paddedRect.w===u.paddedRect.w&&l.paddedRect.h===u.paddedRect.h||qi(`Mismatch in icon variant sizes: ${n.toString()} and ${t.toString()}`),l.usvg!==u.usvg&&qi(`Mismatch in icon variant image types: ${n.id} and ${t.id}`))}function Bv(n,t,r,l){if(!n)return;const u=t.get(r.toString());if(n.imagePrimary=u,l){const m=t.get(l.toString());n.imageSecondary=m}}function fw(n,t){for(const r in n.horizontal)Ov(n.horizontal[r],t);Ov(n.vertical,t)}function Ov(n,t){if(n){for(const r of n.positionedLines)for(const l of r.positionedGlyphs)if(l.image!==null){const u=l.image.toString();l.rect=t.get(u).paddedRect}}}function Px(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function mw(n,t,r,l,u,m,_,b,E){const P=Mx(m.horizontal)||m.vertical,R=r.get("icon-text-fit-padding").evaluate(l,{},u);let F,O=t;return t&&E!=="none"&&(n.allowVerticalPlacement&&m.vertical&&(F=wx(t,m.vertical,E,R,b,_)),P&&(O=wx(t,P,E,R,b,_))),{defaultShapedIcon:O,verticallyShapedIcon:F}}function gw(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt,yt,Pt,qt){let Bt=_.textMaxSize.evaluate(t,{},O);Bt===void 0?Bt=b*_.textScaleFactor:Bt*=_.textScaleFactor;const Yt=n.layers[0].layout,ee=Va,ne=b*_.textScaleFactor/ee,Le=Mx(r.horizontal)||r.vertical;if(rt!=="none"&&n.appearanceFeatureData&&t.index<n.appearanceFeatureData.length){const Ge=n.appearanceFeatureData[t.index];Ge&&(Ge.textShaping=Le,Ge.iconTextFitPadding=Yt.get("icon-text-fit-padding").evaluate(t,{},O),Ge.fontScale=ne)}const fe=$.name==="globe",ke=n.tilePixelRatio*Bt/ee,Ue=(Me=n.overscaling,n.zoom>18&&Me>2&&(Me>>=1),Math.max(ri/(512*Me),1)*Yt.get("symbol-spacing")),Ze=Yt.get("text-padding")*n.tilePixelRatio,hi=Yt.get("icon-padding")*n.tilePixelRatio,Ke=rr(Yt.get("text-max-angle")),je=Yt.get("icon-rotation-alignment")==="map"&&yt!=="point",Ye=Ue/2;var Me;n.hasAnyIconTextFit===!1&&rt!=="none"&&(n.hasAnyIconTextFit=!0);const Ie=t.properties?+t.properties[xi]:null,He=Ie&&n.elevationFeatureIdToIndex?n.elevationFeatureIdToIndex.get(Ie):65535,ai=(Ge,Pi,ki)=>{if(Pi.x<0||Pi.x>=ri||Pi.y<0||Pi.y>=ri)return;let vi=null;if(fe){const{x:pi,y:dr,z:_i}=$.projectTilePoint(Pi.x,Pi.y,ki);vi={anchor:new Ff(pi,dr,_i,0,void 0),up:$.upVector(ki,Pi.x,Pi.y)}}(function(pi,dr,_i,Wi,mr,Lr,rn,_r,pn,fn,Co,Ot,Rt,Oe,di,Ne,fi,Gi,Ni,Tr,er,Bi,un,Nn,nr,Qr,Vn,In,jo,go,no){const zn=pi.addToLineVertexArray(dr,Wi);let mn,Sr,gn,oo,ir,nn,_o,Ho=0,rs=0,Us=0,yo=0,Ms=-1,qc=-1;const Cs={};let yh=qa("");const wl=_i?_i.anchor:dr,ku=In!=="none";let Zc=0,xh=0;if(pn._unevaluatedLayout.getValue("text-radial-offset")===void 0){const Ua=pn.layout.get("text-offset").evaluate(er,{},nr);Zc=Ua[0]*Va,xh=Ua[1]*Va}else Zc=pn.layout.get("text-radial-offset").evaluate(er,{},nr)*Va,xh=Ax;if(pi.allowVerticalPlacement&&mr.vertical){const Ua=mr.vertical;if(di)nn=Cx(Ua),_r&&(_o=Cx(_r));else{const ic=pn.layout.get("text-rotate").evaluate(er,{},nr)+90;gn=M0(fn,wl,dr,Co,Ot,Rt,Ua,Oe,ic,Ne),_r&&(oo=M0(fn,wl,dr,Co,Ot,Rt,_r,Gi,ic,null,no))}}if(Lr){const Ua=pi.iconSizeData,ic=pn.layout.get("icon-rotate").evaluate(er,{},nr),tf=Ex(Lr,ic,un,ku,Bi.iconScaleFactor),Tm=_r?Ex(_r,ic,un,ku,Bi.iconScaleFactor):void 0;Sr=M0(fn,wl,dr,Co,Ot,Rt,Lr,Gi,ic,null,go);const c_=function(ef,Z0,h_,MT,rb,nb,CT,DT){const ob=ef.layers[0],sb=ob.appearances;let u_=Z0.length;if(h_&&(u_=Math.max(u_,h_.length)),sb.length===0)return u_;const[zT,LT]=MT.get("icon-size-scale-range"),RT=tt(1,zT,LT);for(const ab of sb){const lb=ab.getUnevaluatedProperties();if(lb._values["icon-image"].value!==void 0){const cb=ob.getAppearanceValueAndResolveTokens(ab,"icon-image",rb,nb,[]);if(cb){const hb=ef.getResolvedImageFromTokens(cb);if(hb){const ub=lb._values["icon-size"],kT=hy(hb,Qg(ef.zoom,ub,ef.worldview),ub,nb,ef.zoom,rb,ef.pixelRatio,RT,ef.worldview),FT=CT.get(kT.iconPrimary.toString());u_=Math.max(u_,sw(FT,DT))}}}}return u_}(pi,tf,Tm,pn.layout,er,nr,pi.iconAtlasPositions,ku);Ho=4*c_;let Sm=null;Ua.kind==="source"?(Sm=[op*pn.layout.get("icon-size").evaluate(er,{},nr)*Bi.iconScaleFactor],Sm[0]>Bf&&qi(`${pi.layerIds[0]}: Value for "icon-size" is >= ${uy}. Reduce your "icon-size".`)):Ua.kind==="composite"&&(Sm=[op*Bi.compositeIconSizes[0].evaluate(er,{},nr)*Bi.iconScaleFactor,op*Bi.compositeIconSizes[1].evaluate(er,{},nr)*Bi.iconScaleFactor],(Sm[0]>Bf||Sm[1]>Bf)&&qi(`${pi.layerIds[0]}: Value for "icon-size" is >= ${uy}. Reduce your "icon-size".`)),pi.addSymbols(pi.icon,tf,Sm,Tr,Ni,er,void 0,_i,dr,zn.lineStartIndex,zn.lineLength,-1,Nn,nr,Qr,Vn,pi.symbolInstances.length,c_),Ms=pi.icon.placedSymbolArray.length-1,Tm&&(rs=4*c_,pi.addSymbols(pi.icon,Tm,Sm,Tr,Ni,er,_h.vertical,_i,dr,zn.lineStartIndex,zn.lineLength,-1,Nn,nr,Qr,Vn,pi.symbolInstances.length,c_),qc=pi.icon.placedSymbolArray.length-1)}for(const Ua in mr.horizontal){const ic=Ua,tf=mr.horizontal[ic];mn||(yh=qa(tf.text),di?ir=Cx(tf):mn=M0(fn,wl,dr,Co,Ot,Rt,tf,Oe,pn.layout.get("text-rotate").evaluate(er,{},nr),Ne));const Tm=tf.positionedLines.length===1;if(Us+=Nv(pi,_i,dr,tf,rn,pn,di,er,Ne,zn,mr.vertical?_h.horizontal:_h.horizontalOnly,Tm?hw(mr.horizontal):[ic],Cs,Ms,Bi,Nn,nr,pi.symbolInstances.length,Qr),Tm)break}mr.vertical&&(yo+=Nv(pi,_i,dr,mr.vertical,rn,pn,di,er,Ne,zn,_h.vertical,["vertical"],Cs,qc,Bi,Nn,nr,pi.symbolInstances.length,Qr));let Tl=-1;const vh=(Ua,ic)=>Ua?Math.max(Ua,ic):ic;Tl=vh(ir,Tl),Tl=vh(nn,Tl),Tl=vh(_o,Tl);const Fu=Tl>-1?1:0;pi.glyphOffsetArray.length>=65535&&qi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),er.sortKey!==void 0&&pi.addToSortKeyRanges(pi.symbolInstances.length,er.sortKey),pi.symbolInstances.emplaceBack(dr.x,dr.y,wl.x,wl.y,wl.z,Cs.right>=0?Cs.right:-1,Cs.center>=0?Cs.center:-1,Cs.left>=0?Cs.left:-1,Cs.vertical>=0?Cs.vertical:-1,Ms,qc,yh,mn!==void 0?mn:pi.collisionBoxArray.length,mn!==void 0?mn+1:pi.collisionBoxArray.length,gn!==void 0?gn:pi.collisionBoxArray.length,gn!==void 0?gn+1:pi.collisionBoxArray.length,Sr!==void 0?Sr:pi.collisionBoxArray.length,Sr!==void 0?Sr+1:pi.collisionBoxArray.length,oo||pi.collisionBoxArray.length,oo?oo+1:pi.collisionBoxArray.length,Co,Us,yo,Ho,rs,Fu,0,Zc,xh,Tl,0,ku?1:0,jo)})(n,Pi,vi,Ge,r,l,m,u,n.layers[0],n.collisionBoxArray,t.index,t.sourceLayerIndex,n.index,Ze,gt,P,0,hi,je,at,t,_,R,F,O,q,Y,rt,He,Pt,qt)};if(yt==="line")for(const Ge of $g(t.geometry,0,0,ri,ri)){const Pi=ow(Ge,Ue,Ke,r.vertical||Le,l,ee,ke,n.overscaling,ri);for(const ki of Pi)Le&&_w(n,Le.text,Ye,ki)||ai(Ge,ki,O)}else if(yt==="line-center"){for(const Ge of t.geometry)if(Ge.length>1){const Pi=nw(Ge,Ke,r.vertical||Le,l,ee,ke);Pi&&ai(Ge,Pi,O)}}else if(t.type==="Polygon")for(const Ge of am(t.geometry,0)){const Pi=lw(Ge,16);ai(Ge[0],new Ff(Pi.x,Pi.y,0,0,void 0),O)}else if(t.type==="LineString")for(const Ge of t.geometry)ai(Ge,new Ff(Ge[0].x,Ge[0].y,0,0,void 0),O);else if(t.type==="Point")for(const Ge of t.geometry)for(const Pi of Ge)ai([Pi],new Ff(Pi.x,Pi.y,0,0,void 0),O)}const uy=255,Bf=uy*op;function Nv(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt){const yt=function(Bt,Yt,ee,ne,Le,fe,ke,Ue){const Ze=[];if(Yt.positionedLines.length===0)return Ze;const hi=ne.layout.get("text-rotate").evaluate(fe,{})*Math.PI/180,Ke=function(He){const ai=He[0],Ge=He[1],Pi=ai*Ge;return Pi>0?[ai,-Ge]:Pi<0?[-ai,Ge]:ai===0?[Ge,ai]:[Ge,-ai]}(ee);let je=Math.abs(Yt.top-Yt.bottom);for(const He of Yt.positionedLines)je-=He.lineOffset;const Ye=Yt.positionedLines.length,Me=je/Ye;let Ie=Yt.top-ee[1];for(let He=0;He<Ye;++He){const ai=Yt.positionedLines[He];Ie=aw(Yt,Me,Ie,He);for(const Ge of ai.positionedGlyphs){if(!Ge.rect)continue;const Pi=Ge.rect||{};let ki=pv+1,vi=!0,pi=1,dr=0;if(Ge.image){const Ni=ke.get(Ge.image.toString());if(!Ni)continue;if(Ni.sdf){qi("SDF images are not supported in formatted text and will be ignored.");continue}vi=!1,pi=Ni.pixelRatio,ki=og/pi}const _i=(Le||Ue)&&Ge.vertical,Wi=Ge.metrics.advance*Ge.scale/2,mr=Ge.metrics,Lr=Ge.rect;if(Lr===null)continue;Ue&&Yt.verticalizable&&(dr=Ge.image?Wi-Ge.metrics.width*Ge.scale/2:0);const rn=Le?[Ge.x+Wi,Ge.y]:[0,0];let _r=[0,0],pn=[0,0],fn=!1;Le||(_i?(pn=[Ge.x+Wi+Ke[0],Ge.y+Ke[1]-dr],fn=!0):_r=[Ge.x+Wi+ee[0],Ge.y+ee[1]-dr]);const Co=Lr.w*Ge.scale/(pi*(Ge.localGlyph?sp:1)),Ot=Lr.h*Ge.scale/(pi*(Ge.localGlyph?sp:1));let Rt,Oe,di,Ne;if(_i){const Ni=Ge.y-Ie,Tr=new Ae(-Wi,Wi-Ni),er=-Math.PI/2,Bi=new Ae(...pn);Rt=new Ae(-Wi+_r[0],_r[1]),Rt._rotateAround(er,Tr)._add(Bi),Rt.x+=-Ni+Wi,Rt.y-=(mr.left-ki)*Ge.scale;const un=Ge.image?mr.advance*Ge.scale:Va*Ge.scale,Nn=String.fromCodePoint(Ge.glyph);jb(Nn)?Rt.x+=(1-ki)*Ge.scale:Gb(Nn)?Rt.x+=un-mr.height*Ge.scale+(-ki-1)*Ge.scale:Rt.x+=Ge.image||mr.width+2*ki===Lr.w&&mr.height+2*ki===Lr.h?(un-Ot)/2:(un-(mr.height+2*ki)*Ge.scale)/2,Oe=new Ae(Rt.x,Rt.y-Co),di=new Ae(Rt.x+Ot,Rt.y),Ne=new Ae(Rt.x+Ot,Rt.y-Co)}else{const Ni=(mr.left-ki)*Ge.scale-Wi+_r[0],Tr=(-mr.top-ki)*Ge.scale+_r[1],er=Ni+Co,Bi=Tr+Ot;Rt=new Ae(Ni,Tr),Oe=new Ae(er,Tr),di=new Ae(Ni,Bi),Ne=new Ae(er,Bi)}if(hi){let Ni;Ni=Le?new Ae(0,0):fn?new Ae(Ke[0],Ke[1]):new Ae(ee[0],ee[1]),Rt._rotateAround(hi,Ni),Oe._rotateAround(hi,Ni),di._rotateAround(hi,Ni),Ne._rotateAround(hi,Ni)}const fi=new Ae(0,0),Gi=new Ae(0,0);Ze.push({tl:Rt,tr:Oe,bl:di,br:Ne,texPrimary:Pi,texSecondary:void 0,writingMode:Yt.writingMode,glyphOffset:rn,sectionIndex:Ge.sectionIndex,isSDF:vi,pixelOffsetTL:fi,pixelOffsetBR:Gi,minFontScaleX:0,minFontScaleY:0})}}return Ze}(0,l,E,m,_,b,u,n.allowVerticalPlacement),Pt=n.textSizeData;let qt=null;Pt.kind==="source"?(qt=[op*m.layout.get("text-size").evaluate(b,{},rt)*q.textScaleFactor],qt[0]>Bf&&qi(`${n.layerIds[0]}: Value for "text-size" is >= ${uy}. Reduce your "text-size".`)):Pt.kind==="composite"&&(qt=[op*q.compositeTextSizes[0].evaluate(b,{},rt)*q.textScaleFactor,op*q.compositeTextSizes[1].evaluate(b,{},rt)*q.textScaleFactor],(qt[0]>Bf||qt[1]>Bf)&&qi(`${n.layerIds[0]}: Value for "text-size" is >= ${uy}. Reduce your "text-size".`)),n.addSymbols(n.text,yt,qt,E,_,b,R,t,r,P.lineStartIndex,P.lineLength,$,Y,rt,gt,!1,at,yt.length);for(const Bt of F)O[Bt]=n.text.placedSymbolArray.length-1;return 4*yt.length}function Mx(n){for(const t in n)return n[t];return null}function M0(n,t,r,l,u,m,_,b,E,P,R){let F,O,$,q;if(F=R?R.top:_.top,O=R?R.bottom:_.bottom,$=R?R.left:_.left,q=R?R.right:_.right,xv(_)&&_.collisionPadding){const Y=_.collisionPadding;$-=Y[0],F-=Y[1],q+=Y[2],O+=Y[3]}if(E){const Y=new Ae($,F),rt=new Ae(q,F),at=new Ae($,O),gt=new Ae(q,O),yt=rr(E);let Pt=new Ae(0,0);P&&(Pt=new Ae(P[0],P[1])),Y._rotateAround(yt,Pt),rt._rotateAround(yt,Pt),at._rotateAround(yt,Pt),gt._rotateAround(yt,Pt),$=Math.min(Y.x,rt.x,at.x,gt.x),q=Math.max(Y.x,rt.x,at.x,gt.x),F=Math.min(Y.y,rt.y,at.y,gt.y),O=Math.max(Y.y,rt.y,at.y,gt.y)}return n.emplaceBack(t.x,t.y,t.z,r.x,r.y,$,F,q,O,b,l,u,m),n.length-1}function Cx(n){xv(n)&&n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);const t=n.bottom-n.top;return t>0?Math.max(10,t):null}function _w(n,t,r,l){const u=n.compareText;if(t in u){const m=u[t];for(let _=m.length-1;_>=0;_--)if(l.dist(m[_])<r)return!0}else u[t]=[];return u[t].push(l),!1}function Vv(n,t){const r=n.fovAboveCenter,l=n.elevation?n.elevation.getMinElevationBelowMSL()*t:0,u=(n._camera.position[2]*n.worldSize-l)/Math.cos(n._pitch),m=Math.sin(r)*u/Math.sin(Math.max(Math.PI/2-n._pitch-r,.01));let _=Math.sin(n._pitch)*m+u;const b=u*(1/n._horizonShift);if(!n.elevation||n.elevation.exaggeration()===0){let E=Math.max(n.zoom-17,0);n.isOrthographic&&(E/=10),_*=1+E}return Math.min(1.01*_,b)}function dy(n,t){if(!t.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:t};const r=Math.pow(2,-n.z),l=n.x*r,u=(n.x+1)*r,m=n.y*r,_=(n.y+1)*r,b=Ct(l),E=Ct(u),P=bt(m),R=bt(_),F=t.project(b,P),O=t.project(E,P),$=t.project(E,R),q=t.project(b,R);let Y=Math.min(F.x,O.x,$.x,q.x),rt=Math.min(F.y,O.y,$.y,q.y),at=Math.max(F.x,O.x,$.x,q.x),gt=Math.max(F.y,O.y,$.y,q.y);const yt=r/16;function Pt(Bt,Yt,ee,ne,Le,fe){const ke=(ee+Le)/2,Ue=(ne+fe)/2,Ze=t.project(Ct(ke),bt(Ue)),hi=Math.max(0,Y-Ze.x,rt-Ze.y,Ze.x-at,Ze.y-gt);Y=Math.min(Y,Ze.x),at=Math.max(at,Ze.x),rt=Math.min(rt,Ze.y),gt=Math.max(gt,Ze.y),hi>yt&&(Pt(Bt,Ze,ee,ne,ke,Ue),Pt(Ze,Yt,ke,Ue,Le,fe))}Pt(F,O,l,m,u,m),Pt(O,$,u,m,u,_),Pt($,q,u,_,l,_),Pt(q,F,l,_,l,m),Y-=yt,rt-=yt,at+=yt,gt+=yt;const qt=1/Math.max(at-Y,gt-rt);return{scale:qt,x:Y*qt,y:rt*qt,x2:at*qt,y2:gt*qt,projection:t}}function Uv(n,{x:t,y:r},l=0){return new Ae(((t-l)*n.scale-n.x)*ri,(r*n.scale-n.y)*ri)}const yw=Ve(new Float32Array(16));class bm{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,r){return{x:0,y:0,z:0}}unproject(t,r){return new Z(0,0)}projectTilePoint(t,r,l){return{x:t,y:r,z:0}}locationPoint(t,r,l,u=!0){return t._coordinatePoint(t.locationCoordinate(r,l),u)}pixelsPerMeter(t,r){return _t(1,t)*r}pixelSpaceConversion(t,r,l){return 1}farthestPixelDistance(t){return Vv(t,t.pixelsPerMeter)}pointCoordinate(t,r,l,u){const m=t.horizonLineFromTop(!1),_=new Ae(r,Math.max(m,l));return t.rayIntersectionCoordinate(t.pointRayIntersection(_,u))}pointCoordinate3D(t,r,l){const u=new Ae(r,l);if(t.elevation)return t.elevation.pointCoordinate(u);{const m=this.pointCoordinate(t,u.x,u.y,0);return[m.x,m.y,m.z]}}isPointAboveHorizon(t,r){if(t.elevation&&t.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(t,r.x,r.y);const l=t.horizonLineFromTop();return r.y<l}createInversionMatrix(t,r){return yw}createTileMatrix(t,r,l){let u,m,_;const b=l.canonical,E=Ve(new Float64Array(16));if(this.isReprojectedInTileSpace){const P=dy(b,this);u=1,m=P.x+l.wrap*P.scale,_=P.y,Fn(E,E,[u/P.scale,u/P.scale,t.pixelsPerMeter/r])}else u=r/t.zoomScale(b.z),m=(b.x+Math.pow(2,b.z)*l.wrap)*u,_=b.y*u;return Yr(E,E,[m,_,0]),Fn(E,E,[u/ri,u/ri,1]),E}upVector(t,r,l){return[0,0,1]}upVectorScale(t,r,l){return{metersToTile:1}}}class xw extends bm{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[r,l]=this.parallels=t.parallels||[29.5,45.5],u=Math.sin(rr(r));this.n=(u+Math.sin(rr(l)))/2,this.c=1+u*(2*this.n-u),this.r0=Math.sqrt(this.c)/this.n}project(t,r){const{n:l,c:u,r0:m}=this,_=rr(t-this.center[0]),b=rr(r),E=Math.sqrt(u-2*l*Math.sin(b))/l;return{x:E*Math.sin(_*l),y:E*Math.cos(_*l)-m,z:0}}unproject(t,r){const{n:l,c:u,r0:m}=this,_=m+r;let b=Math.atan2(t,Math.abs(_))*Math.sign(_);_*l<0&&(b-=Math.PI*Math.sign(t)*Math.sign(_));const E=rr(this.center[0])*l;b=Nt(b,-Math.PI-E,Math.PI-E);const P=tt(bi(b/l)+this.center[0],-180,180),R=Math.asin(tt((u-(t*t+_*_)*l*l)/(2*l),-1,1)),F=tt(bi(R),-zt,zt);return new Z(P,F)}}const py=1.340264,fy=-.081106,my=893e-6,gy=.003796,C0=Math.sqrt(3)/2;class vw extends bm{project(t,r){r=r/180*Math.PI,t=t/180*Math.PI;const l=Math.asin(C0*Math.sin(r)),u=l*l,m=u*u*u;return{x:.5*(t*Math.cos(l)/(C0*(py+3*fy*u+m*(7*my+9*gy*u)))/Math.PI+.5),y:1-.5*(l*(py+fy*u+m*(my+gy*u))/Math.PI+1),z:0}}unproject(t,r){t=(2*t-.5)*Math.PI;let l=r=(2*(1-r)-1)*Math.PI,u=l*l,m=u*u*u;for(let R,F,O,$=0;$<12&&(F=l*(py+fy*u+m*(my+gy*u))-r,O=py+3*fy*u+m*(7*my+9*gy*u),R=F/O,l=tt(l-R,-Math.PI/3,Math.PI/3),u=l*l,m=u*u*u,!(Math.abs(R)<1e-12));++$);const _=C0*t*(py+3*fy*u+m*(7*my+9*gy*u))/Math.cos(l),b=Math.asin(Math.sin(l)/C0),E=tt(180*_/Math.PI,-180,180),P=tt(180*b/Math.PI,-zt,zt);return new Z(E,P)}}class bw extends bm{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,r){return{x:.5+t/360,y:.5-r/360,z:0}}unproject(t,r){const l=360*(t-.5),u=tt(360*(.5-r),-zt,zt);return new Z(l,u)}}const r_=Math.PI/2;function D0(n){return Math.tan((r_+n)/2)}class ww extends bm{constructor(t){super(t),this.center=t.center||[0,30];const[r,l]=this.parallels=t.parallels||[30,30];let u=rr(r),m=rr(l);this.southernCenter=u+m<0,this.southernCenter&&(u=-u,m=-m);const _=Math.cos(u),b=D0(u);this.n=u===m?Math.sin(u):Math.log(_/Math.cos(m))/Math.log(D0(m)/b),this.f=_*Math.pow(D0(u),this.n)/this.n}project(t,r){r=rr(r),this.southernCenter&&(r=-r),t=rr(t-this.center[0]);const l=1e-6,{n:u,f:m}=this;m>0?r<-r_+l&&(r=-r_+l):r>r_-l&&(r=r_-l);const _=m/Math.pow(D0(r),u);let b=_*Math.sin(u*t),E=m-_*Math.cos(u*t);return b=.5*(b/Math.PI+.5),E=.5*(E/Math.PI+.5),{x:b,y:this.southernCenter?E:1-E,z:0}}unproject(t,r){t=(2*t-.5)*Math.PI,this.southernCenter&&(r=1-r),r=(2*(1-r)-.5)*Math.PI;const{n:l,f:u}=this,m=u-r,_=Math.sign(m),b=Math.sign(l)*Math.sqrt(t*t+m*m);let E=Math.atan2(t,Math.abs(m))*_;m*l<0&&(E-=Math.PI*Math.sign(t)*_);const P=tt(bi(E/l)+this.center[0],-180,180),R=tt(bi(2*Math.atan(Math.pow(u/b,1/l))-r_),-zt,zt);return new Z(P,this.southernCenter?-R:R)}}class jv extends bm{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,r){return{x:ht(t),y:lt(r),z:0}}unproject(t,r){const l=Ct(t),u=bt(r);return new Z(l,u)}}const Gv=rr(zt);class Tw extends bm{project(t,r){const l=(r=rr(r))*r,u=l*l;return{x:.5*((t=rr(t))*(.8707-.131979*l+u*(u*(.003971*l-.001529*u)-.013791))/Math.PI+.5),y:1-.5*(r*(1.007226+l*(.015085+u*(.028874*l-.044475-.005916*u)))/Math.PI+1),z:0}}unproject(t,r){t=(2*t-.5)*Math.PI;let l=r=(2*(1-r)-1)*Math.PI,u=25,m=0,_=l*l;do{_=l*l;const P=_*_;m=(l*(1.007226+_*(.015085+P*(.028874*_-.044475-.005916*P)))-r)/(1.007226+_*(.045255+P*(.259866*_-.311325-.005916*11*P))),l=tt(l-m,-Gv,Gv)}while(Math.abs(m)>1e-6&&--u>0);_=l*l;const b=tt(bi(t/(.8707+_*(_*(_*_*_*(.003971-.001529*_)-.013791)-.131979))),-180,180),E=bi(l);return new Z(b,E)}}const $v=rr(zt);class Sw extends bm{project(t,r){r=rr(r),t=rr(t);const l=Math.cos(r),u=2/Math.PI,m=Math.acos(l*Math.cos(t/2)),_=Math.sin(m)/m,b=.5*(t*u+2*l*Math.sin(t/2)/_)||0,E=.5*(r+Math.sin(r)/_)||0;return{x:.5*(b/Math.PI+.5),y:1-.5*(E/Math.PI+1),z:0}}unproject(t,r){let l=t=(2*t-.5)*Math.PI,u=r=(2*(1-r)-1)*Math.PI,m=25;const _=1e-6;let b=0,E=0;do{const P=Math.cos(u),R=Math.sin(u),F=2*R*P,O=R*R,$=P*P,q=Math.cos(l/2),Y=Math.sin(l/2),rt=2*q*Y,at=Y*Y,gt=1-$*q*q,yt=gt?1/gt:0,Pt=gt?Math.acos(P*q)*Math.sqrt(1/gt):0,qt=.5*(2*Pt*P*Y+2*l/Math.PI)-t,Bt=.5*(Pt*R+u)-r,Yt=.5*yt*($*at+Pt*P*q*O)+1/Math.PI,ee=yt*(rt*F/4-Pt*R*Y),ne=.125*yt*(F*Y-Pt*R*$*rt),Le=.5*yt*(O*q+Pt*at*P)+.5,fe=ee*ne-Le*Yt;b=(Bt*ee-qt*Le)/fe,E=(qt*ne-Bt*Yt)/fe,l=tt(l-b,-Math.PI,Math.PI),u=tt(u-E,-$v,$v)}while((Math.abs(b)>_||Math.abs(E)>_)&&--m>0);return new Z(bi(l),bi(u))}}class qv extends bm{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(rr(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,r){const{scale:l,cosPhi:u}=this;return{x:rr(t)*u*l+.5,y:-Math.sin(rr(r))/u*l+.5,z:0}}unproject(t,r){const{scale:l,cosPhi:u}=this,m=-(r-.5)/l,_=tt(bi((t-.5)/l)/u,-180,180),b=Math.asin(tt(m*u,-1,1)),E=tt(bi(b),-zt,zt);return new Z(_,E)}}class Iw extends jv{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,r,l){const u=jm(t,r,l);return Kn(u,u,Qh(fd(l))),{x:u[0],y:u[1],z:u[2]}}locationPoint(t,r,l){const u=L(r.lat,r.lng),m=bn([],u),_=l?t._centerAltitude+l:t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(r),t._centerAltitude):t._centerAltitude;Ks(u,u,m,_t(1,0)*ri*_);const b=Ve(new Float64Array(16));return gr(b,t.pixelMatrix,t.globeMatrix),Kn(u,u,b),new Ae(u[0],u[1])}pixelsPerMeter(t,r){return _t(1,0)*r}pixelSpaceConversion(t,r,l){const u=_t(1,t)*r,m=Vi(_t(1,45)*r,u,l);return this.pixelsPerMeter(t,r)/m}createTileMatrix(t,r,l){const u=gd(fd(l.canonical));return gr(new Float64Array(16),t.globeMatrix,u)}createInversionMatrix(t,r){const{center:l}=t,u=Qh(fd(r));return ao(u,u,rr(l.lng)),us(u,u,rr(l.lat)),Fn(u,u,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(u)}pointCoordinate(t,r,l,u){return Jd(t,r,l,!0)||new pe(0,0)}pointCoordinate3D(t,r,l){const u=this.pointCoordinate(t,r,l,0);return[u.x,u.y,u.z]}isPointAboveHorizon(t,r){return!Jd(t,r.x,r.y,!1)}farthestPixelDistance(t){const r=function(u,m){const _=u.cameraToCenterDistance,b=u._centerAltitude*m,E=u._camera,P=u._camera.forward(),R=Fo([],Jn([],P,-_),[0,0,b]),F=u.worldSize/(2*Math.PI),O=[0,0,-F],$=u.width/u.height,q=Math.tan(u.fovAboveCenter),Y=Jn([],E.up(),q),rt=Jn([],E.right(),q*$),at=bn([],Fo([],Fo([],P,Y),rt)),gt=[];let yt;if(new br(R,at).closestPointOnSphere(O,F,gt)){const Pt=Fo([],gt,O),qt=Zn([],Pt,R);yt=Math.cos(u.fovAboveCenter)*ws(qt)}else{const Pt=Zn([],R,O),qt=Zn([],O,R);bn(qt,qt);const Bt=ws(Pt)-F;yt=Math.sqrt(Bt*(Bt+2*F));const Yt=Math.acos(yt/(F+Bt))-Math.acos(ho(P,qt));yt*=Math.cos(Yt)}return 1.01*yt}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),l=Du(t.zoom);if(l>0){const u=Vv(t,_t(1,t.center.lat)*t.worldSize),m=t.worldSize/(2*Math.PI),_=Math.max(t.width,t.height)/t.worldSize*Math.PI;return Vi(r,u+m*(1-Math.cos(_)),Math.pow(l,10))}return r}upVector(t,r,l){return jm(r,l,t,1)}upVectorScale(t){return{metersToTile:im(Gm(fd(t)))}}}function Zv(n){const t=n.parallels,r=!!t&&Math.abs(t[0]+t[1])<.01;switch(n.name){case"mercator":return new jv(n);case"equirectangular":return new bw(n);case"naturalEarth":return new Tw(n);case"equalEarth":return new vw(n);case"winkelTripel":return new Sw(n);case"albers":return r?new qv(n):new xw(n);case"lambertConformalConic":return r?new qv(n):new ww(n);case"globe":return new Iw(n)}throw new Error(`Invalid projection name: ${n.name}`)}const Ew=qe.types,Aw=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function _y(n,t,r,l,u,m,_,b,E,P,R,F,O){const $=b?Math.min(Bf,Math.round(b[0])):0,q=b?Math.min(Bf,Math.round(b[1])):0;n.emplaceBack(t,r,Math.round(32*l),Math.round(32*u),m,_,($<<1)+(E?1:0),0+(q<<1),16*P,16*R,256*F,256*O)}function yy(n,t,r){n.emplaceBack(t,r)}function xy(n,t,r,l,u,m,_){n.emplaceBack(t,r,l,u,m,_)}const z0=(n,t,r,l)=>{for(let u=0;u<t;u++)n.emplaceBack(r[0],r[1],r[2],l[0],l[1],l[2])};function n_(n,t,r,l,u){n.emplaceBack(t,r,l,u),n.emplaceBack(t,r,l,u),n.emplaceBack(t,r,l,u),n.emplaceBack(t,r,l,u)}function Pw(n){for(const t of n.sections)if(Pp(t.text))return!0;return!1}class Dx{constructor(t){this.layoutVertexArray=new To,this.indexArray=new qn,this.programConfigurations=t,this.segments=new po,this.dynamicLayoutVertexArray=new ch,this.opacityVertexArray=new Mp,this.placedSymbolArray=new pd,this.iconTransitioningVertexArray=new Rl,this.globeExtVertexArray=new Ll,this.zOffsetVertexArray=new Fs,this.orientationVertexArray=new Wd,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getIconVertexData(t,r){const l=[],u=this.layoutVertexArray.uint16;for(let m=0;m<r;++m){const _=12*(t+m);l.push(...u.slice(_,_+12))}return l}updateIconVertexData(t,r,l,u,m,_,b,E,P,R,F,O,$){const q=this.layoutVertexArray.uint16,Y=12*t;q[Y]=r,q[Y+1]=l,q[Y+2]=u,q[Y+3]=m,q[Y+4]=_,q[Y+5]=b,q[Y+6]=E,q[Y+7]=P,q[Y+8]=R,q[Y+9]=F,q[Y+10]=O,q[Y+11]=$}upload(t,r,l,u,m,_){this.isEmpty()||(l&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,zb.members,!!_),this.indexBuffer=t.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,Rb.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,Aw,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=t.createVertexBuffer(this.iconTransitioningVertexArray,Bb.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,Lb.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||m)&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,kb.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=t.createVertexBuffer(this.orientationVertexArray,Fb.members,!0)),this.opacityVertexBuffer.itemSize=1),(l||u)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Si(Dx,"SymbolBuffers");class zx{constructor(t,r,l){this.layoutVertexArray=new t,this.layoutAttributes=r,this.indexArray=new l,this.segments=new po,this.collisionVertexArray=new uh,this.collisionVertexArrayExt=new ch}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,Ob.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,Nb.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Si(zx,"CollisionBuffers");class L0{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(_=>_.fqid),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Ve([]),this.placementViewportMatrix=Ve([]);const r=this.layers[0]._unevaluatedLayout._values;this.worldview=t.worldview,this.textSizeData=Qg(this.zoom,r["text-size"],this.worldview),this.iconSizeData=Qg(this.zoom,r["icon-size"],this.worldview);const l=this.layers[0].layout,u=l.get("symbol-sort-key"),m=l.get("symbol-z-order");this.lut=t.lut,this.canOverlap=l.get("text-allow-overlap")||l.get("icon-allow-overlap")||l.get("text-ignore-placement")||l.get("icon-ignore-placement"),this.sortFeaturesByKey=m!=="viewport-y"&&u.constantOr(1)!==void 0,this.sortFeaturesByY=(m==="viewport-y"||m==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=l.get("text-writing-mode").map(_=>_h[_]),this.stateDependentLayerIds=this.layers.filter(_=>_.isStateDependent()).map(_=>_.id),this.sourceID=t.sourceID,this.projection=t.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null}hasAnyAppearanceProperty(t){const r=this.layers[0].getAppearances();return!(!r||r.length===0)&&r.some(l=>l.getProperty(t)!=null)}createArrays(){this.text=new Dx(new mh(this.layers,{zoom:this.zoom,lut:this.lut},t=>t.startsWith("text")||t.startsWith("symbol"))),this.icon=new Dx(new mh(this.layers,{zoom:this.zoom,lut:this.lut},t=>t.startsWith("icon")||t.startsWith("symbol"))),this.glyphOffsetArray=new Dm,this.lineVertexArray=new gg,this.symbolInstances=new mg}calculateGlyphDependencies(t,r,l,u,m){for(const _ of t){const b=_.codePointAt(0);if(b===void 0)break;if(r[b]=!0,u&&m&&b<=65535){const E=sy[_];E&&(r[E.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(t,r,l,u,m,_){let b=1;const E=t.getUnevaluatedProperties()._values["icon-size"],P=Qg(this.zoom,E,this.worldview),R=t_(P,r);if(P.kind!=="constant"&&P.kind!=="camera"||(b=R.uSize),P.kind==="composite"){const{minZoom:F,maxZoom:O}=P,$=E.possiblyEvaluate(new D(F,{worldview:this.worldview}),u),q=E.possiblyEvaluate(new D(O,{worldview:this.worldview}),u),Y=$.evaluate(l,{},u,m);b=Y+(q.evaluate(l,{},u,m)-Y)*R.uSizeT}return P.kind==="source"&&(b=E.possiblyEvaluate(new D(this.zoom,{worldview:this.worldview}),u).evaluate(l,{},u,m)),b*_}updateFootprints(t,r){}updateReplacement(t,r){if(r.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=r.updateTime;const l=r.getReplacementRegionsForTile(t.toUnwrapped(),!0);return!Mf(this.activeReplacements,l)&&(this.activeReplacements=l,!0)}getResolvedImageFromTokens(t){return typeof t=="string"?za.build(t):t}populate(t,r,l,u){const m=this.layers[0],_=m.layout,b=this.projection.name==="globe",E=_.get("text-font"),P=_.get("text-field"),R=_.get("icon-image"),[F,O]=_.get("icon-size-scale-range"),$=tt(r.scaleFactor||1,F,O),q=(P.value.kind!=="constant"||P.value.value instanceof fs&&!P.value.value.isEmpty()||P.value.value.toString().length>0)&&(E.value.kind!=="constant"||E.value.value.length>0),Y=R.value.kind!=="constant"||!!R.value.value||Object.keys(R.parameters).length>0,rt=this.hasAnyAppearanceProperty("icon-image"),at=_.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!q&&!Y&&!rt)return;const gt=r.iconDependencies,yt=r.glyphDependencies,Pt=r.availableImages,qt=new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),Bt=Yt=>{const ee=Yt.id.toString();gt.has(ee)?gt.get(ee).push(Yt):gt.set(ee,[Yt])};for(const Yt of t){const{feature:ee,id:ne,index:Le,sourceLayerIndex:fe}=Yt,ke=m._featureFilter.needGeometry,Ue=Te(ee,ke);if(!m._featureFilter.filter(qt,Ue,l))continue;if(ke||(Ue.geometry=Be(ee,l,u)),b&&ee.type!==1&&l.z<=5){const He=Ue.geometry,ai=.98078528056,Ge=(Pi,ki)=>ho(jm(Pi.x,Pi.y,l,1),jm(ki.x,ki.y,l,1))<ai;for(let Pi=0;Pi<He.length;Pi++)He[Pi]=Fe(He[Pi],Ge)}let Ze,hi;if(q){const He=m.getValueAndResolveTokens("text-field",Ue,l,Pt),ai=fs.factory(He);Pw(ai)&&(this.hasRTLText=!0),(!this.hasRTLText||d()==="unavailable"||this.hasRTLText&&S.isParsed())&&(Ze=Ub(ai,m,Ue))}if(Y){const He=m.getValueAndResolveTokens("icon-image",Ue,l,Pt);hi=this.getResolvedImageFromTokens(He)}const Ke=this.layers[0];let je=!1;if(!hi&&rt){const He=Ke.getAppearances();for(const ai of He)if(ai.getProperty("icon-image")){const Ge=Ke.getAppearanceValueAndResolveTokens(ai,"icon-image",Ue,l,Pt);if(Ge){hi=this.getResolvedImageFromTokens(Ge),je=!0;break}}}if(!Ze&&!hi)continue;const Ye=this.sortFeaturesByKey?at.evaluate(Ue,{},l):void 0,Me={id:ne,text:Ze,icon:hi,index:Le,sourceLayerIndex:fe,geometry:Ue.geometry,properties:ee.properties,type:Ew[ee.type],sortKey:Ye};if(this.features.push(Me),this.appearanceFeatureData.push({id:ne,properties:ee.properties,usesAppearanceIconAsPlaceholder:je,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),hi){const He=Ke._unevaluatedLayout._values,{iconPrimary:ai,iconSecondary:Ge}=hy(hi,this.iconSizeData,He["icon-size"],l,this.zoom,Me,this.pixelRatio,$,this.worldview);Bt(ai),Ge&&(this.hasAnySecondaryIcon=!0,Bt(Ge))}const Ie=Ke.getAppearances();if(Ie.length!==0&&Ie.forEach(He=>{if(!He.getProperty("icon-image"))return;const ai=this.getCombinedIconPrimary(He,Ke,Ue,l,Pt,Me,$);ai&&Bt(ai)}),Ze){const He=E.evaluate(Ue,{},l).join(","),ai=_.get("text-rotation-alignment")==="map"&&_.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(_h.vertical)>=0;for(const Ge of Ze.sections)if(Ge.image){const Pi=Ge.image.getPrimary().scaleSelf(this.pixelRatio),ki=Pi.id.toString(),vi=gt.get(ki)||[];vi.push(Pi),gt.set(ki,vi)}else{const Pi=Hh(Ze.toString()),ki=Ge.fontStack||He,vi=yt[ki]=yt[ki]||{};this.calculateGlyphDependencies(Ge.text,vi,ai,this.allowVerticalPlacement,Pi)}}}if(_.get("symbol-placement")==="line"&&(this.features=function(Yt){const ee={},ne={},Le=[];let fe=0;function ke(Ke){Le.push(Yt[Ke]),fe++}function Ue(Ke,je,Ye){const Me=ne[Ke];return delete ne[Ke],ne[je]=Me,Le[Me].geometry[0].pop(),Le[Me].geometry[0]=Le[Me].geometry[0].concat(Ye[0]),Me}function Ze(Ke,je,Ye){const Me=ee[je];return delete ee[je],ee[Ke]=Me,Le[Me].geometry[0].shift(),Le[Me].geometry[0]=Ye[0].concat(Le[Me].geometry[0]),Me}function hi(Ke,je,Ye){const Me=Ye?je[0][je[0].length-1]:je[0][0];return`${Ke}:${Me.x}:${Me.y}`}for(let Ke=0;Ke<Yt.length;Ke++){const je=Yt[Ke],Ye=je.geometry,Me=je.text?je.text.toString():null;if(!Me){ke(Ke);continue}const Ie=hi(Me,Ye),He=hi(Me,Ye,!0);if(Ie in ne&&He in ee&&ne[Ie]!==ee[He]){const ai=Ze(Ie,He,Ye),Ge=Ue(Ie,He,Le[ai].geometry);delete ee[Ie],delete ne[He],ne[hi(Me,Le[Ge].geometry,!0)]=Ge,Le[ai].geometry=null}else Ie in ne?Ue(Ie,He,Ye):He in ee?Ze(Ie,He,Ye):(ke(Ke),ee[Ie]=fe-1,ne[He]=fe-1)}return Le.filter(Ke=>Ke.geometry)}(this.features)),_.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",r.elevationFeatures){!this.elevationFeatures&&r.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const Yt of r.elevationFeatures)this.elevationFeatureIdToIndex.set(Yt.id,this.elevationFeatures.length),this.elevationFeatures.push(Yt)}}else _.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((Yt,ee)=>Yt.sortKey-ee.sortKey)}getCombinedIconPrimary(t,r,l,u,m,_,b){let E,P;const R=t.getUnevaluatedProperties();if(R._values["icon-image"].value!==void 0){const F=r.getAppearanceValueAndResolveTokens(t,"icon-image",l,u,m);E=this.getResolvedImageFromTokens(F)}else{const F=r.getValueAndResolveTokens("icon-image",l,u,m);E=this.getResolvedImageFromTokens(F)}if(E){const F=R._values["icon-size"]||r._unevaluatedLayout._values["icon-size"];P=hy(E,Qg(this.zoom,F,this.worldview),F,u,this.zoom,_,this.pixelRatio,b,this.worldview).iconPrimary}return P}updateAppearanceBasedIconTextures(t,r,l,u){if(!this.appearanceFeatureData||!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)return!1;const m=this.layers[0];let _=!1,b=0;const E=m.layout,[P,R]=E.get("icon-size-scale-range"),F=tt(1,P,R);for(let O=0;O<this.symbolInstances.length;O++){const $=this.symbolInstances.get(O),q=this.appearanceFeatureData[$.featureIndex];if(q&&$.placedIconSymbolIndex>=0){const Y=q.id,rt=r&&Y!==void 0?r[String(Y)]:void 0,at={type:"Point",id:q.id,properties:q.properties,geometry:[]},gt=this.layers[0].appearances&&this.layers[0].appearances.find(yt=>yt.isActive({globals:u,feature:at,canonical:t,featureState:rt}));if(q.activeAppearance===gt)continue;if(gt){q.activeAppearance=gt;const yt={sortKey:void 0,text:void 0,icon:null,index:$.featureIndex,sourceLayerIndex:$.featureIndex,geometry:[],properties:q.properties,type:"Point",id:q.id};if(!gt.hasCachedIconPrimary()){const Yt=this.getCombinedIconPrimary(gt,m,at,t,l,yt,F);gt.setCachedIconPrimary(Yt)}const Pt=gt.getCachedIconPrimary();if(!Pt)continue;const qt=Pt.toString(),Bt=this.iconAtlasPositions&&this.iconAtlasPositions.get(qt);if(Bt){const Yt=m.getAppearanceValueAndResolveTokens(gt,"icon-offset",at,t,l),ee=Yt&&Array.isArray(Yt)?Yt:[0,0];let ne=T0(Bt,void 0,ee,m.layout.get("icon-anchor").evaluate(at,{},t));const Le=m.getAppearanceValueAndResolveTokens(gt,"icon-rotate",at,t,l),fe=typeof Le=="number"?Le:0,ke=Bt.sdf,Ue=m.layout.get("icon-text-fit").constantOr("none");Ue!=="none"&&q.textShaping&&q.iconTextFitPadding&&q.fontScale&&(ne=wx(ne,q.textShaping,Ue,q.iconTextFitPadding,ee,q.fontScale));const Ze=this.calculateEffectiveAppearanceIconSize(gt,u.zoom,at,t,l,F),hi=0,Ke=1+(Math.min(Bf,Math.round(Ze*op))<<1),je=Ex(ne,fe,ke,Ue!=="none",F);q.isUsingAppearanceVertexData||(q.isUsingAppearanceVertexData=!0,q.layoutBasedVertexData=this.icon.getIconVertexData(b,$.numIconVertices));for(let Me=0;Me<je.length;++Me){const Ie=je[Me],He=q.layoutBasedVertexData[0]||$.tileAnchorX,ai=q.layoutBasedVertexData[1]||$.tileAnchorY,Ge=16*Ie.pixelOffsetTL.x,Pi=16*Ie.pixelOffsetTL.y,ki=16*Ie.pixelOffsetBR.x,vi=16*Ie.pixelOffsetBR.y,pi=16*Ie.minFontScaleX,dr=16*Ie.minFontScaleY;this.icon.updateIconVertexData(b,He,ai,Math.round(32*Ie.tl.x),Math.round(32*Ie.tl.y),Ie.texPrimary.x,Ie.texPrimary.y,hi,Ke,Ge,Pi,pi,dr),this.icon.updateIconVertexData(b+1,He,ai,Math.round(32*Ie.tr.x),Math.round(32*Ie.tr.y),Ie.texPrimary.x+Ie.texPrimary.w,Ie.texPrimary.y,hi,Ke,ki,Pi,pi,dr),this.icon.updateIconVertexData(b+2,He,ai,Math.round(32*Ie.bl.x),Math.round(32*Ie.bl.y),Ie.texPrimary.x,Ie.texPrimary.y+Ie.texPrimary.h,hi,Ke,Ge,vi,pi,dr),this.icon.updateIconVertexData(b+3,He,ai,Math.round(32*Ie.br.x),Math.round(32*Ie.br.y),Ie.texPrimary.x+Ie.texPrimary.w,Ie.texPrimary.y+Ie.texPrimary.h,hi,Ke,ki,vi,pi,dr),b+=4}const Ye=$.numIconVertices-4*je.length;for(let Me=0;Me<Ye;++Me)this.icon.updateIconVertexData(b+Me,0,0,0,0,0,0,0,0,0,0,0,0);_=!0}else b+=$.numIconVertices}else if(q.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(b,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(b+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(b+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(b+3,0,0,0,0,0,0,0,0,0,0,0,0),_=!0),b+=$.numIconVertices,q.activeAppearance=null;else if(q.isUsingAppearanceVertexData){const Pt=q.layoutBasedVertexData.length/12;for(let qt=0;qt<Pt;++qt){const Bt=qt*12;this.icon.updateIconVertexData(b+qt,q.layoutBasedVertexData[Bt+0],q.layoutBasedVertexData[Bt+1],q.layoutBasedVertexData[Bt+2],q.layoutBasedVertexData[Bt+3],q.layoutBasedVertexData[Bt+4],q.layoutBasedVertexData[Bt+5],q.layoutBasedVertexData[Bt+6],q.layoutBasedVertexData[Bt+7],q.layoutBasedVertexData[Bt+8],q.layoutBasedVertexData[Bt+9],q.layoutBasedVertexData[Bt+10],q.layoutBasedVertexData[Bt+11])}b+=Pt,q.isUsingAppearanceVertexData=!1,q.activeAppearance=null,_=!0}else b+=$.numIconVertices,q.activeAppearance=null}}return _}update(t,r,l,u,m,_,b){this.text.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview),this.icon.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview)}updateRoadElevation(t){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let r=!1;const l=Ht(t),u=1/l;let m=!1,_=!1;for(let b=0;b<this.symbolInstances.length;b++){const E=this.symbolInstances.get(b),P=so(1,0,0),R=so(0,1,0),{numHorizontalGlyphVertices:F,numVerticalGlyphVertices:O,numIconVertices:$,numVerticalIconVertices:q}=E,Y=F>0||O>0,rt=$>0,at=this.elevationFeatures[E.elevationFeatureIndex];if(at){const gt=new Ae(E.tileAnchorX,E.tileAnchorY),yt=.075+at.pointElevation(gt);E.zOffset!==yt&&(r=!0,E.zOffset=yt),yt!==0&&(this.hasAnyZOffset=!0);const Pt=at.computeSlopeNormal(gt,u),qt=Aa(Ss(),so(0,0,1),Pt);ns(P,P,qt),ns(R,R,qt),P[2]*=l,R[2]*=l,P[0]===1&&P[1]===0&&P[2]===0&&R[0]===0&&R[1]===1&&R[2]===0||(m=m||Y,_=_||rt)}if(Y&&(z0(this.text.orientationVertexArray,F,P,R),z0(this.text.orientationVertexArray,O,P,R)),rt){const{placedIconSymbolIndex:gt,verticalPlacedIconSymbolIndex:yt}=E;gt>=0&&z0(this.icon.orientationVertexArray,$,P,R),yt>=0&&z0(this.icon.orientationVertexArray,q,P,R)}}m||(this.text.orientationVertexArray=void 0),_||(this.icon.orientationVertexArray=void 0),r&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const t=(m,_,b)=>{l+=_,l>m.length&&m.resize(l);for(let E=-_;E<0;E++)m.emplace(E+l,b)},r=(m,_,b)=>{u+=_,u>m.length&&m.resize(u);for(let E=-_;E<0;E++)m.emplace(E+u,b)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let l=0,u=0;for(let m=0;m<this.symbolInstances.length;m++){const _=this.symbolInstances.get(m),{numHorizontalGlyphVertices:b,numVerticalGlyphVertices:E,numIconVertices:P}=_,R=_.zOffset,F=P>0;if((b>0||E>0)&&(t(this.text.zOffsetVertexArray,b,R),t(this.text.zOffsetVertexArray,E,R)),F){const{placedIconSymbolIndex:O,verticalPlacedIconSymbolIndex:$}=_;O>=0&&r(this.icon.zOffsetVertexArray,P,R),$>=0&&r(this.icon.zOffsetVertexArray,_.numVerticalIconVertices,R)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t,r,l,u,m){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),this.hasAppearances===null&&(this.hasAppearances=this.layers.some(_=>_.appearances&&_.appearances.length>0)),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(t,r,l,u){return!!(t&&r&&l)&&!(!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(t,r,l,u)&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Zv(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,r){const l=this.lineVertexArray.length;if(t.segment!==void 0)for(const{x:u,y:m}of r)this.lineVertexArray.emplaceBack(u,m);return{lineStartIndex:l,lineLength:this.lineVertexArray.length-l}}addSymbols(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,rt,at,gt){const yt=t.indexArray,Pt=t.layoutVertexArray,qt=t.globeExtVertexArray,Bt=t.segments.prepareSegment(4*gt,Pt,yt,this.canOverlap?_.sortKey:void 0),Yt=this.glyphOffsetArray.length,ee=Bt.vertexLength,ne=this.allowVerticalPlacement&&b===_h.vertical?Math.PI/2:0,Le=_.text&&_.text.sections;for(let Ue=0;Ue<r.length;Ue++){const{tl:Ze,tr:hi,bl:Ke,br:je,texPrimary:Ye,texSecondary:Me,pixelOffsetTL:Ie,pixelOffsetBR:He,minFontScaleX:ai,minFontScaleY:Ge,glyphOffset:Pi,isSDF:ki,sectionIndex:vi}=r[Ue],pi=Bt.vertexLength,dr=Pi[1];if(_y(Pt,P.x,P.y,Ze.x,dr+Ze.y,Ye.x,Ye.y,l,ki,Ie.x,Ie.y,ai,Ge),_y(Pt,P.x,P.y,hi.x,dr+hi.y,Ye.x+Ye.w,Ye.y,l,ki,He.x,Ie.y,ai,Ge),_y(Pt,P.x,P.y,Ke.x,dr+Ke.y,Ye.x,Ye.y+Ye.h,l,ki,Ie.x,He.y,ai,Ge),_y(Pt,P.x,P.y,je.x,dr+je.y,Ye.x+Ye.w,Ye.y+Ye.h,l,ki,He.x,He.y,ai,Ge),E){const{x:_i,y:Wi,z:mr}=E.anchor,[Lr,rn,_r]=E.up;xy(qt,_i,Wi,mr,Lr,rn,_r),xy(qt,_i,Wi,mr,Lr,rn,_r),xy(qt,_i,Wi,mr,Lr,rn,_r),xy(qt,_i,Wi,mr,Lr,rn,_r),n_(t.dynamicLayoutVertexArray,_i,Wi,mr,ne)}else n_(t.dynamicLayoutVertexArray,P.x,P.y,P.z,ne);if(rt){const _i=Me||Ye;yy(t.iconTransitioningVertexArray,_i.x,_i.y),yy(t.iconTransitioningVertexArray,_i.x+_i.w,_i.y),yy(t.iconTransitioningVertexArray,_i.x,_i.y+_i.h),yy(t.iconTransitioningVertexArray,_i.x+_i.w,_i.y+_i.h)}yt.emplaceBack(pi,pi+1,pi+2),yt.emplaceBack(pi+1,pi+2,pi+3),Bt.vertexLength+=4,Bt.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Pi[0]),Ue!==r.length-1&&vi===r[Ue+1].sectionIndex||t.programConfigurations.populatePaintArrays(Pt.length,_,_.index,{},$,q,Y,Le&&Le[vi],this.worldview)}const fe=gt-r.length;fe!==0&&this._addNullVertices(fe,Pt,l,E,qt,t,rt,Bt,yt);const ke=E?E.anchor:P;t.placedSymbolArray.emplaceBack(ke.x,ke.y,ke.z,P.x,P.y,Yt,this.glyphOffsetArray.length-Yt,ee,R,F,P.segment,l?l[0]:0,l?l[1]:0,u[0],u[1],b,0,0,0,O,0),t.symbolInstanceIndices.push(at)}_addNullVertices(t,r,l,u,m,_,b,E,P){for(let R=0;R<t;R++){for(let O=0;O<4;O++)_y(r,0,0,0,0,0,0,l,!1,0,0,0,0),u&&xy(m,0,0,0,0,0,0),n_(_.dynamicLayoutVertexArray,0,0,0,0),b&&yy(_.iconTransitioningVertexArray,0,0);const F=E.vertexLength;P.emplaceBack(F,F+1,F+2),P.emplaceBack(F+1,F+2,F+3),E.vertexLength+=4,E.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(t,r,l,u,m,_,b){t.emplaceBack(r,l,u,m,_,Math.round(b.x),Math.round(b.y))}_addCollisionDebugVertices(t,r,l,u,m,_,b){const E=l.segments.prepareSegment(4,l.layoutVertexArray,l.indexArray),P=E.vertexLength,R=b.tileAnchorX,F=b.tileAnchorY;for(let $=0;$<4;$++)l.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(l.collisionVertexArrayExt,r,t.padding,b.zOffset),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x1,t.y1)),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x2,t.y1)),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x2,t.y2)),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x1,t.y2)),E.vertexLength+=4;const O=l.indexArray;O.emplaceBack(P,P+1),O.emplaceBack(P+1,P+2),O.emplaceBack(P+2,P+3),O.emplaceBack(P+3,P),E.primitiveLength+=4}_addTextDebugCollisionBoxes(t,r,l,u,m,_){for(let b=u;b<m;b++){const E=l.get(b),P=this.getSymbolInstanceTextSize(t,_,r,b);this._addCollisionDebugVertices(E,P,this.textCollisionBox,E.projectedAnchorX,E.projectedAnchorY,E.projectedAnchorZ,_)}}_addIconDebugCollisionBoxes(t,r,l,u,m,_){for(let b=u;b<m;b++){const E=l.get(b),P=this.getSymbolInstanceIconSize(t,r,_.placedIconSymbolIndex);this._addCollisionDebugVertices(E,P,this.iconCollisionBox,E.projectedAnchorX,E.projectedAnchorY,E.projectedAnchorZ,_)}}generateCollisionDebugBuffers(t,r,l){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new zx(Cp,cv.members,Rl),this.iconCollisionBox=new zx(Cp,cv.members,Rl);const u=t_(this.iconSizeData,t),m=t_(this.textSizeData,t,l);for(let _=0;_<this.symbolInstances.length;_++){const b=this.symbolInstances.get(_);this._addTextDebugCollisionBoxes(m,t,r,b.textBoxStartIndex,b.textBoxEndIndex,b),this._addTextDebugCollisionBoxes(m,t,r,b.verticalTextBoxStartIndex,b.verticalTextBoxEndIndex,b),this._addIconDebugCollisionBoxes(u,t,r,b.iconBoxStartIndex,b.iconBoxEndIndex,b),this._addIconDebugCollisionBoxes(u,t,r,b.verticalIconBoxStartIndex,b.verticalIconBoxEndIndex,b)}}getSymbolInstanceTextSize(t,r,l,u){const m=this.text.placedSymbolArray.get(r.rightJustifiedTextSymbolIndex>=0?r.rightJustifiedTextSymbolIndex:r.centerJustifiedTextSymbolIndex>=0?r.centerJustifiedTextSymbolIndex:r.leftJustifiedTextSymbolIndex>=0?r.leftJustifiedTextSymbolIndex:r.verticalPlacedTextSymbolIndex>=0?r.verticalPlacedTextSymbolIndex:u),_=Tx(this.textSizeData,t,m)/Va;return this.tilePixelRatio*_}getSymbolInstanceIconSize(t,r,l){const u=this.icon.placedSymbolArray.get(l),m=Tx(this.iconSizeData,t,u);return this.tilePixelRatio*m}_commitDebugCollisionVertexUpdate(t,r,l,u){t.emplaceBack(r,-l,-l,u),t.emplaceBack(r,l,-l,u),t.emplaceBack(r,l,l,u),t.emplaceBack(r,-l,l,u)}_updateTextDebugCollisionBoxes(t,r,l,u,m,_,b){for(let E=u;E<m;E++){const P=l.get(E),R=this.getSymbolInstanceTextSize(t,_,r,E);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,R,P.padding,_.zOffset)}}_updateIconDebugCollisionBoxes(t,r,l,u,m,_,b){for(let E=u;E<m;E++){const P=l.get(E),R=this.getSymbolInstanceIconSize(t,r,_.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,R,P.padding,_.zOffset)}}updateCollisionDebugBuffers(t,r,l,u){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const m=t_(this.iconSizeData,t,u),_=t_(this.textSizeData,t,l);for(let b=0;b<this.symbolInstances.length;b++){const E=this.symbolInstances.get(b);this._updateTextDebugCollisionBoxes(_,t,r,E.textBoxStartIndex,E.textBoxEndIndex,E,l),this._updateTextDebugCollisionBoxes(_,t,r,E.verticalTextBoxStartIndex,E.verticalTextBoxEndIndex,E,l),this._updateIconDebugCollisionBoxes(m,t,r,E.iconBoxStartIndex,E.iconBoxEndIndex,E,u),this._updateIconDebugCollisionBoxes(m,t,r,E.verticalIconBoxStartIndex,E.verticalIconBoxEndIndex,E,u)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,r,l,u,m,_,b,E,P){const R={};if(r<l){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt,featureIndex:qt}=t.get(r);R.textBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt},R.textFeatureIndex=qt}if(u<m){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt,featureIndex:qt}=t.get(u);R.verticalTextBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt},R.verticalTextFeatureIndex=qt}if(_<b){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt,featureIndex:qt}=t.get(_);R.iconBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt},R.iconFeatureIndex=qt}if(E<P){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt,featureIndex:qt}=t.get(E);R.verticalIconBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:rt,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:Pt},R.verticalIconFeatureIndex=qt}return R}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const l=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,l.textBoxStartIndex,l.textBoxEndIndex,l.verticalTextBoxStartIndex,l.verticalTextBoxEndIndex,l.iconBoxStartIndex,l.iconBoxEndIndex,l.verticalIconBoxStartIndex,l.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(t,r){const l=t.placedSymbolArray.get(r),u=l.vertexStartIndex+4*l.numGlyphs;for(let m=l.vertexStartIndex;m<u;m+=4)t.indexArray.emplaceBack(m,m+1,m+2),t.indexArray.emplaceBack(m+1,m+2,m+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(t),l=Math.cos(t),u=[],m=[],_=[];for(let b=0;b<this.symbolInstances.length;++b){_.push(b);const E=this.symbolInstances.get(b);u.push(0|Math.round(r*E.tileAnchorX+l*E.tileAnchorY)),m.push(E.featureIndex)}return _.sort((b,E)=>u[b]-u[E]||m[E]-m[b]),_}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let t=0;t<this.symbolInstances.length;++t)this.symbolInstanceIndexesSortedZOffset.push(t)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((t,r)=>this.symbolInstances.get(r).zOffset-this.symbolInstances.get(t).zOffset)}addToSortKeyRanges(t,r){const l=this.sortKeyRanges[this.sortKeyRanges.length-1];l&&l.sortKey===r?l.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const l=this.symbolInstances.get(r);this.featureSortOrder.push(l.featureIndex);const{rightJustifiedTextSymbolIndex:u,centerJustifiedTextSymbolIndex:m,leftJustifiedTextSymbolIndex:_,verticalPlacedTextSymbolIndex:b,placedIconSymbolIndex:E,verticalPlacedIconSymbolIndex:P}=l;u>=0&&this.addIndicesForPlacedSymbol(this.text,u),m>=0&&m!==u&&this.addIndicesForPlacedSymbol(this.text,m),_>=0&&_!==m&&_!==u&&this.addIndicesForPlacedSymbol(this.text,_),b>=0&&this.addIndicesForPlacedSymbol(this.text,b),E>=0&&this.addIndicesForPlacedSymbol(this.icon,E),P>=0&&this.addIndicesForPlacedSymbol(this.icon,P)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(t){const r=this.symbolInstances.get(this.text.symbolInstanceIndices[t]).elevationFeatureIndex;let l;return this.elevationFeatures&&r<this.elevationFeatures.length&&(l=this.elevationFeatures[r]),l}}function Hv(n,t){return t.replace(/{([^{}]+)}/g,(r,l)=>l in n?String(n[l]):"")}let Wv,Xv,Lx;Si(L0,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),L0.addDynamicAttributes=n_;class Yv{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:Da,this.defaultValue=t}evaluate(t){if(t.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(t.formattedSection))return r.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Si(Yv,"FormatSectionOverride",{omit:["defaultValue"]});const Rx=()=>Lx||(Lx={layout:Wv||(Wv=new Xt({"symbol-placement":new pt(ft.layout_symbol["symbol-placement"]),"symbol-spacing":new pt(ft.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new pt(ft.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Et(ft.layout_symbol["symbol-sort-key"]),"symbol-z-order":new pt(ft.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new pt(ft.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new pt(ft.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new pt(ft.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new pt(ft.layout_symbol["icon-ignore-placement"]),"icon-optional":new pt(ft.layout_symbol["icon-optional"]),"icon-rotation-alignment":new pt(ft.layout_symbol["icon-rotation-alignment"]),"icon-size":new Et(ft.layout_symbol["icon-size"]),"icon-size-scale-range":new pt(ft.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Et(ft.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Et(ft.layout_symbol["icon-text-fit-padding"]),"icon-image":new Et(ft.layout_symbol["icon-image"]),"icon-image-use-theme":new pt({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new Et(ft.layout_symbol["icon-rotate"]),"icon-padding":new pt(ft.layout_symbol["icon-padding"]),"icon-keep-upright":new pt(ft.layout_symbol["icon-keep-upright"]),"icon-offset":new Et(ft.layout_symbol["icon-offset"]),"icon-anchor":new Et(ft.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new pt(ft.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new pt(ft.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new pt(ft.layout_symbol["text-rotation-alignment"]),"text-field":new Et(ft.layout_symbol["text-field"]),"text-font":new Et(ft.layout_symbol["text-font"]),"text-size":new Et(ft.layout_symbol["text-size"]),"text-size-scale-range":new pt(ft.layout_symbol["text-size-scale-range"]),"text-max-width":new Et(ft.layout_symbol["text-max-width"]),"text-line-height":new Et(ft.layout_symbol["text-line-height"]),"text-letter-spacing":new Et(ft.layout_symbol["text-letter-spacing"]),"text-justify":new Et(ft.layout_symbol["text-justify"]),"text-radial-offset":new Et(ft.layout_symbol["text-radial-offset"]),"text-variable-anchor":new pt(ft.layout_symbol["text-variable-anchor"]),"text-anchor":new Et(ft.layout_symbol["text-anchor"]),"text-max-angle":new pt(ft.layout_symbol["text-max-angle"]),"text-writing-mode":new pt(ft.layout_symbol["text-writing-mode"]),"text-rotate":new Et(ft.layout_symbol["text-rotate"]),"text-padding":new pt(ft.layout_symbol["text-padding"]),"text-keep-upright":new pt(ft.layout_symbol["text-keep-upright"]),"text-transform":new Et(ft.layout_symbol["text-transform"]),"text-offset":new Et(ft.layout_symbol["text-offset"]),"text-allow-overlap":new pt(ft.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new pt(ft.layout_symbol["text-ignore-placement"]),"text-optional":new pt(ft.layout_symbol["text-optional"]),visibility:new pt(ft.layout_symbol.visibility)})),paint:Xv||(Xv=new Xt({"icon-opacity":new Et(ft.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Et(ft.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Et(ft.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Et(ft.paint_symbol["text-emissive-strength"]),"icon-color":new Et(ft.paint_symbol["icon-color"]),"icon-halo-color":new Et(ft.paint_symbol["icon-halo-color"]),"icon-halo-width":new Et(ft.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Et(ft.paint_symbol["icon-halo-blur"]),"icon-translate":new pt(ft.paint_symbol["icon-translate"]),"icon-translate-anchor":new pt(ft.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new pt(ft.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Et(ft.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Et(ft.paint_symbol["text-occlusion-opacity"]),"text-color":new Et(ft.paint_symbol["text-color"],{runtimeType:Ha,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new Et(ft.paint_symbol["text-halo-color"]),"text-halo-width":new Et(ft.paint_symbol["text-halo-width"]),"text-halo-blur":new Et(ft.paint_symbol["text-halo-blur"]),"text-translate":new pt(ft.paint_symbol["text-translate"]),"text-translate-anchor":new pt(ft.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new pt(ft.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new pt(ft.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new pt(ft.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new pt(ft.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Et(ft.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},Lx);class R0 extends $n{constructor(t,r,l,u){super(t,Rx(),r,l,u,t.layout?t.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=Ve([]),this.hasOcclusionOpacityProperties=t.paint!==void 0&&("icon-occlusion-opacity"in t.paint||"text-occlusion-opacity"in t.paint)}_handleSpecialPaintPropertyUpdate(t){t!=="icon-occlusion-opacity"&&t!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(t,r){super.recalculate(t,r),this.appearances&&this.appearances.forEach(u=>{u.recalculate(t,r,this.iconImageUseTheme)}),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const l=this.layout.get("text-writing-mode");if(l){const u=[];for(const m of l)u.indexOf(m)<0&&u.push(m);this.layout._values["text-writing-mode"]=u}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(t,r,l,u){return this._saturation===t&&this._contrast===r&&this._brightnessMin===l&&this._brightnessMax===u||(this._colorAdjustmentMatrix=function(m,_,b,E){m=jn(m),_=Bn(_);const P=Or(),R=m/3,F=1-2*R,O=[F,R,R,0,R,F,R,0,R,R,F,0,0,0,0,1],$=.5-.5*_,q=E-b;return gr(P,[q,0,0,0,0,q,0,0,0,0,q,0,b,b,b,1],[_,0,0,0,0,_,0,0,0,0,_,0,$,$,$,1]),gr(P,P,O),P}(t,r,l,u),this._saturation=t,this._contrast=r,this._brightnessMin=l,this._brightnessMax=u),this._colorAdjustmentMatrix}getValueAndResolveTokens(t,r,l,u){const m=this.layout.get(t).evaluate(r,{},l,u),_=this._unevaluatedLayout._values[t];return _.isDataDriven()||Zh(_.value)||!m?m:Hv(r.properties,m)}getAppearanceValueAndResolveTokens(t,r,l,u,m){const _=t.getProperty(r);if(!_)return;const b=_.evaluate(l,{},u,m),E=t.getUnevaluatedProperties()._values[r];return E.isDataDriven()||Zh(E.value)||!b||typeof b!="string"?b:Hv(l.properties,b)}createBucket(t){return new L0(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of Rx().paint.overridableProperties){if(!R0.hasPaintOverride(this.layout,t))continue;const r=this.paint.get(t),l=new Yv(r),u=new zr(l,r.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let m=null;m=r.value.kind==="constant"||r.value.kind==="source"?new lh("source",u):new cs("composite",u,r.value.zoomStops,r.value.interpolationType),this.paint._values[t]=new ut(r.property,m,r.parameters)}}_handleOverridablePaintPropertyUpdate(t,r,l){return!(!this.layout||r.isDataDriven()||l.isDataDriven())&&R0.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,r){const l=t.get("text-field"),u=Rx().paint.properties[r];let m=!1;const _=b=>{for(const E of b)if(u.overrides&&u.overrides.hasOverride(E))return void(m=!0)};if(l.value.kind==="constant"&&l.value.value instanceof fs)_(l.value.value.sections);else if(l.value.kind==="source"){const b=P=>{m||(P instanceof Mc&&ls(P.value)===Ac?_(P.value.sections):P instanceof Dl?_(P.sections):P.eachChild(b))},E=l.value;E._styleExpression&&b(E._styleExpression.expression)}return m}getProgramIds(){return["symbol"]}getDefaultProgramParams(t,r,l){return{config:new Mu(this,{zoom:r,lut:l}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let Jv,Kv,Qv,t1;var kx=vr([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function k0(n,t,r,l,u,m,_,b){const E=[n,t,1,r,l,1,u,m,1],P=[_,b,1],R=on([],E),[F,O,$]=vo(P,P,R);return Br(E,E,[F,0,0,0,O,0,0,0,$])}function e1(n,t,r,l,u,m,_,b){const E=function(P,R,F,O,$,q,Y,rt){const at=k0(0,0,1,0,1,1,0,1),gt=k0(P,R,F,O,$,q,Y,rt);return Br(gt,gt,on([],at))}(n,t,r,l,u,m,_,b);return[E[2]/E[8]/ri,E[5]/E[8]/ri]}function F0(n){return[n[0],Math.min(Math.max(n[1],-zt),zt)]}class i1 extends Ml{constructor(t,r,l,u){super(),this.id=t,this.dispatcher=l,this.coordinates=r.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(u),this.options=r,this._dirty=!1}load(t,r){if(this._loaded=r||!1,this.fire(new ya("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return t&&(this.coordinates=t),this._loaded=!0,void this._finishLoading();this._imageRequest=Ca(this.map._requestManager.transformRequest(this.url,Is.Image),(l,u)=>{this._imageRequest=null,this._loaded=!0,l?this.fire(new ac(l)):u&&(this.image=u instanceof HTMLImageElement?$a.getImageData(u):u,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),this._finishLoading())})}loaded(){return this._loaded}updateImage(t){return t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}setTexture(t){if(!(t.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new xt(this.map.painter.context,t.handle),this.width=t.dimensions[0],this.height=t.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new ya("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(t){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof xt||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(t){if(this.coordinates=t,this._boundsArray=void 0,this._unsupportedCoords=!1,!t.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let r=t[0][1],l=t[0][1];for(const m of t)m[1]>l&&(l=m[1]),m[1]<r&&(r=m[1]);const u=(l+r)/2;if(u>zt?this.onNorthPole=!0:u<-zt&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const m=t.map(pe.fromLngLat);this.tileID=function(_){let b=1/0,E=1/0,P=-1/0,R=-1/0;for(const Y of _)b=Math.min(b,Y.x),E=Math.min(E,Y.y),P=Math.max(P,Y.x),R=Math.max(R,Y.y);const F=Math.max(P-b,R-E),O=Math.max(0,Math.floor(-Math.log2(F))),$=Math.pow(2,O);let q=Math.floor((b+P)/2*$);return q>1&&(q-=1),new vc(O,q,Math.floor((E+R)/2*$))}(m),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new ya("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof xt||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(t){for(const at in this.tiles){const gt=this.tiles[at];gt.state!=="loaded"&&(gt.state="loaded",gt.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const r=dy(new vc(0,0,0),this.map.transform.projection),l=[r.projection.project(this.coordinates[0][0],this.coordinates[0][1]),r.projection.project(this.coordinates[1][0],this.coordinates[1][1]),r.projection.project(this.coordinates[2][0],this.coordinates[2][1]),r.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(at){const gt=at[1].x-at[0].x,yt=at[1].y-at[0].y,Pt=at[2].x-at[1].x,qt=at[2].y-at[1].y,Bt=at[3].x-at[2].x,Yt=at[3].y-at[2].y,ee=at[0].x-at[3].x,ne=at[0].y-at[3].y,Le=gt*qt-Pt*yt,fe=Pt*Yt-Bt*qt,ke=Bt*ne-ee*Yt,Ue=ee*yt-gt*ne;return Le>0&&fe>0&&ke>0&&Ue>0||Le<0&&fe<0&&ke<0&&Ue<0}(l))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const u=dy(this.tileID,this.map.transform.projection),[m,_,b,E]=this.coordinates.map(at=>{const gt=u.projection.project(at[0],at[1]);return Uv(u,gt)._round()});this.perspectiveTransform=e1(m.x,m.y,_.x,_.y,b.x,b.y,E.x,E.y);const P=this._boundsArray=new Kl;P.emplaceBack(m.x,m.y,0,0),P.emplaceBack(_.x,_.y,ri,0),P.emplaceBack(E.x,E.y,0,ri),P.emplaceBack(b.x,b.y,ri,ri),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=t.createVertexBuffer(P,kx.members),this.boundsSegments=po.simpleSegment(0,0,4,2);const R=[],F=[F0((O=this.coordinates)[0]),F0(O[1]),F0(O[2]),F0(O[3])];var O;const[$,q,Y,rt]=function(at){let gt=at[0][0],yt=gt,Pt=at[0][1],qt=Pt;for(let Bt=1;Bt<at.length;Bt++)at[Bt][0]<gt?gt=at[Bt][0]:at[Bt][0]>yt&&(yt=at[Bt][0]),at[Bt][1]<Pt?Pt=at[Bt][1]:at[Bt][1]>qt&&(qt=at[Bt][1]);return[gt,Pt,yt-gt,qt-Pt]}(F);{const at=new Kl,[gt,yt,Pt,qt]=function(je){let Ye=je[0].x,Me=Ye,Ie=je[0].y,He=Ie;for(let ai=1;ai<je.length;ai++)je[ai].x<Ye?Ye=je[ai].x:je[ai].x>Me&&(Me=je[ai].x),je[ai].y<Ie?Ie=je[ai].y:je[ai].y>He&&(He=je[ai].y);return[Ye,Ie,Me-Ye,He-Ie]}(l),Bt=je=>[(je.x-gt)/Pt,(je.y-yt)/qt],[Yt,ee,ne,Le]=l.map(Bt),fe=function(je,Ye,Me,Ie,He,ai,Ge,Pi){const ki=k0(0,0,1,0,1,1,0,1);return Br(ki,ki,on([],k0(je,Ye,Me,Ie,He,ai,Ge,Pi)))}(Yt[0],Yt[1],ee[0],ee[1],ne[0],ne[1],Le[0],Le[1]);this.elevatedGlobePerspectiveTransform=e1(Yt[0],Yt[1],ee[0],ee[1],ne[0],ne[1],Le[0],Le[1]);const ke=(je,Ye)=>{R.push(je.lng);const Me=Math.round((je.lng-$)/Y*ri),Ie=Math.round((je.lat-q)/rt*ri),He=Bt(Ye),ai=vo([],[He[0],He[1],1],fe),Ge=Math.round(ai[0]/ai[2]*ri),Pi=Math.round(ai[1]/ai[2]*ri);at.emplaceBack(Me,Ie,Ge,Pi)},Ue=l[3].x-l[0].x,Ze=l[3].y-l[0].y,hi=l[2].x-l[1].x,Ke=l[2].y-l[1].y;for(let je=0;je<65;je++){const Ye=je/64,Me=[l[0].x+Ye*Ue,l[0].y+Ye*Ze],Ie=[l[1].x+Ye*hi,l[1].y+Ye*Ke],He=Ie[0]-Me[0],ai=Ie[1]-Me[1];for(let Ge=0;Ge<65;Ge++){const Pi=Ge/64,ki={x:Me[0]+He*Pi,y:Me[1]+ai*Pi};ke(r.projection.unproject(ki.x,ki.y),ki)}}this.elevatedGlobeVertexBuffer=t.createVertexBuffer(at,kx.members)}{this.maxLongitudeTriangleSize=0;let at=[],gt=new qn;const yt=(Pt,qt,Bt)=>{gt.emplaceBack(Pt,qt,Bt);const Yt=R[Pt],ee=R[qt],ne=R[Bt],Le=Math.min(Math.min(Yt,ee),ne),fe=Math.max(Math.max(Yt,ee),ne)-Le;fe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=fe),at.push(Le+fe/2)};for(let Pt=0;Pt<64;Pt++)for(let qt=0;qt<64;qt++){const Bt=65*Pt+qt,Yt=Bt+1,ee=Bt+65,ne=ee+1;yt(Bt,ee,Yt),yt(Yt,ee,ne)}[at,gt]=function(Pt,qt){const Bt=Array.from({length:Pt.length},(ne,Le)=>Le);Bt.sort((ne,Le)=>Pt[ne]-Pt[Le]);const Yt=[],ee=new qn;for(let ne=0;ne<Bt.length;ne++){const Le=Bt[ne];Yt.push(Pt[Le]);const fe=3*Le,ke=fe+1;ee.emplaceBack(qt.uint16[fe],qt.uint16[ke],qt.uint16[ke+1])}return[Yt,ee]}(at,gt),this.elevatedGlobeTrianglesCenterLongitudes=at,this.elevatedGlobeIndexBuffer=t.createIndexBuffer(gt)}this.elevatedGlobeSegments=po.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,Y/ri,0,rt/ri,0,0,q,$,0])}prepare(){const t=Object.keys(this.tiles).length!==0;if(this.tileID&&!t)return;const r=this.map.painter.context,l=r.gl;!this._dirty||this.texture instanceof xt||(this.texture?this.texture.update(this.image):(this.texture=new dt(r,this.image,l.RGBA8),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE)),this._dirty=!1),t&&this._prepareData(r)}loadTile(t,r){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},r(null)):(t.state="errored",r(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(t){const r=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!r)return null;const l=this.elevatedGlobeTrianglesCenterLongitudes;let u=(m=t+180)+360*Math.round((l[0]-m)/360);var m;const _=new po,b=(F,O)=>{_.segments.push({vertexOffset:0,primitiveOffset:F,vertexLength:r.segments[0].vertexLength,primitiveLength:O,sortKey:void 0,vaos:{}})},E=.51*this.maxLongitudeTriangleSize;if(Math.abs(l[0]-u)<=E){const F=Rr(l,0,l.length,u+E);return F===l.length||b(F,an(l,F+1,l.length,u+360-E)-F),_}u<l[0]&&(u+=360);const P=an(l,0,l.length,u-E);if(P===l.length)return b(0,l.length),_;b(0,P-0);const R=Rr(l,P+1,l.length,u+E);return R!==l.length&&b(R,l.length-R),_}}const Mw=(Math.pow(256,2)-1)/16907520;class r1 extends $n{constructor(t,r,l,u){super(t,{layout:Qv||(Qv=new Xt({visibility:new pt(ft.layout_raster.visibility)})),paint:t1||(t1=new Xt({"raster-opacity":new pt(ft.paint_raster["raster-opacity"]),"raster-color":new Kt(ft.paint_raster["raster-color"]),"raster-color-mix":new pt(ft.paint_raster["raster-color-mix"]),"raster-color-range":new pt(ft.paint_raster["raster-color-range"]),"raster-hue-rotate":new pt(ft.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new pt(ft.paint_raster["raster-brightness-min"]),"raster-brightness-max":new pt(ft.paint_raster["raster-brightness-max"]),"raster-saturation":new pt(ft.paint_raster["raster-saturation"]),"raster-contrast":new pt(ft.paint_raster["raster-contrast"]),"raster-resampling":new pt(ft.paint_raster["raster-resampling"]),"raster-fade-duration":new pt(ft.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new pt(ft.paint_raster["raster-emissive-strength"]),"raster-array-band":new pt(ft.paint_raster["raster-array-band"]),"raster-elevation":new pt(ft.paint_raster["raster-elevation"]),"raster-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},r,l,u),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(t){return!(t&&t._source instanceof i1&&(t._source.onNorthPole||t._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(t){t!=="raster-color"&&t!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(t){if(!this.hasColorMap()||!this._curRampRange)return;const r=this._transitionablePaint._values["raster-color"].value.expression,[l,u]=t||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(l)&&isNaN(u)||l===this._curRampRange[0]&&u===this._curRampRange[1]||(this.colorRamp=nm({expression:r,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:l,end:u}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[l,u])}}let n1,o1,s1,a1,l1;class c1 extends $n{constructor(t,r,l,u){super(t,{layout:n1||(n1=new Xt({visibility:new pt(ft["layout_raster-particle"].visibility)})),paint:o1||(o1=new Xt({"raster-particle-array-band":new pt(ft["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new pt(ft["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Kt(ft["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new pt(ft["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new pt(ft["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new pt(ft["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new pt(ft["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new pt(ft["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},r,l,u),this._updateColorRamp(),this.lastInvalidatedAt=$a.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(t){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(t){return!1}_handleSpecialPaintPropertyUpdate(t){t!=="raster-particle-color"&&t!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),t==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const t=this._transitionablePaint._values["raster-particle-color"].value.expression,r=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=nm({expression:t,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:r}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=$a.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class Cw extends $n{constructor(t,r){super(t,{},r,null),this.implementation=t,t.slot&&(this.slot=t.slot)}is3D(t){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(t){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}function Fx(n,t,r){const l=[0,0,1],u=il([]);return Il(u,u,r?-rr(n)+Math.PI:rr(n)),Sl(u,u,-rr(t)),ns(l,l,u),bn(l,l)}const h1={None:0,Model:1,Symbol:2,FillExtrusion:4};class B0{constructor(t,r,l,u){this.message=(t?`${t}: `:"")+l,u&&(this.identifier=u),r!=null&&r.__line__&&(this.line=r.__line__)}}function Bx(n,t){const r=n.indexOf("://")===-1;try{return new URL(n,r&&t?"http://example.com":void 0),!0}catch{return!1}}class u1{constructor(t,r){this.feature=t,this.instancedDataOffset=r,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class d1{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new Yf,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(t){const r=16*t,l=this.instancedDataArray.float32;let u=Math.floor(l[r+2]);const m=1.05*(l[r+2]-u);return u/=100,[l[r]%1*1.05,l[r+1]%1*1.05,m,u]}tileCoordinatesForInstance(t){const r=16*t,l=this.instancedDataArray.float32;let u=l[r+0];return u=u>ri?u-ri:u,new Ae(Math.trunc(u),Math.trunc(l[r+1]))}translationForInstance(t){const r=16*t,l=this.instancedDataArray.float32;return[l[r+4],l[r+5],l[r+6]]}rotationScaleForInstance(t){const r=16*t,l=this.instancedDataArray.float32;return[l[r+7],l[r+8],l[r+9],l[r+10],l[r+11],l[r+12],l[r+13],l[r+14],l[r+15]]}transformForInstance(t){const r=16*t,l=this.instancedDataArray.float32;return[l[r+7],l[r+8],l[r+9],l[r+4],l[r+10],l[r+11],l[r+12],l[r+5],l[r+13],l[r+14],l[r+15],l[r+6],0,0,0,1]}}class Ox{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaledZ=this.canonical.z+Math.log2(t.overscaling),this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.projection=t.projection,this.index=t.index,this.worldview=t.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=t.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.tileToMeter=Ht(l);const m=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:_,id:b,index:E,sourceLayerIndex:P}of t){const R=b??(_.properties&&_.properties.hasOwnProperty("id")?_.properties.id:void 0),F=Te(_,m);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),F,l))continue;const O={id:R,sourceLayerIndex:P,index:E,geometry:m?F.geometry:Be(_,l,u),properties:_.properties,type:_.type,patterns:{}},$=this.addFeature(O,O.geometry,F);$&&r.featureIndex.insert(_,O.geometry,E,P,this.index,this.instancesPerModel[$].instancedDataArray.length,ri/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const t=this.layers[0].modelManager,r=this.layers[0].scope;let l=0;for(const u of this.modelUris){const m=t.getModel(u,r);if(!m)continue;const _=this.instancesPerModel[u];if(_){const b=.5*Ul(m.aabb.max,m.aabb.min)*_.maxScale+_.maxXYTranslationDistance,E=Math.min(ri,Math.max(b/this.tileToMeter,ri/32));l=Math.max(E,l)}}return l}update(t,r,l,u){for(const m in this.instancesPerModel){const _=this.instancesPerModel[m];for(const b in t)_.idToFeaturesIndex.hasOwnProperty(b)&&(this.evaluate(_.features[_.idToFeaturesIndex[b]],t[b],_,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let t=!1;for(const r in this.instancesPerModel){const l=this.instancesPerModel[r];for(const u of l.features){const m=this.layers[0],_=u.feature,b=this.canonical,E=m.paint.get("model-rotation").evaluate(_,{},b),P=m.paint.get("model-scale").evaluate(_,{},b),R=m.paint.get("model-translation").evaluate(_,{},b);lo(u.rotation,E)&&lo(u.scale,P)&&lo(u.translation,R)||(this.evaluate(u,u.featureStates,l,!0),t=!0)}}return t}updateReplacement(t,r,l,u){if(r.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=r.updateTime;const m=r.getReplacementRegionsForTile(t.toUnwrapped(),!0);if(Mf(this.activeReplacements,m))return!1;this.activeReplacements=m;let _=!1;for(const b in this.instancesPerModel){const E=this.instancesPerModel[b],P=E.instancedDataArray;for(const R of E.features){const F=R.instancedDataOffset,O=R.instancedDataCount;for(let $=0;$<O;$++){const q=16*($+F);let Y=P.float32[q+0];const rt=Y>ri;Y=rt?Y-ri:Y;const at=Math.floor(Y),gt=Math.floor(P.float32[q+1]);let yt=!1;for(const Pt of this.activeReplacements)if(!um(Pt,l,h1.Model,u)&&!(Pt.min.x>at||at>Pt.max.x||Pt.min.y>gt||gt>Pt.max.y)&&(yt=Ng(t0(at,gt,t.canonical,Pt.footprintTileId.canonical),Pt.footprint),yt))break;P.float32[q]=yt?Y+ri:Y,_=_||yt!==rt}}}return _}isEmpty(){for(const t in this.instancesPerModel)if(this.instancesPerModel[t].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(t){if(!this.uploaded)for(const r in this.instancesPerModel){const l=this.instancesPerModel[r];l.instancedDataArray.length<0||l.instancedDataArray.length===0||(l.instancedDataBuffer?l.instancedDataBuffer.updateData(l.instancedDataArray):l.instancedDataBuffer=t.createVertexBuffer(l.instancedDataArray,Se.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const r in this.instancesPerModel){const l=this.instancesPerModel[r];l.instancedDataArray.length!==0&&l.instancedDataBuffer&&l.instancedDataBuffer.destroy()}const t=this.layers[0].modelManager;if(t&&this.modelUris&&this.modelsRequested)for(const r of this.modelUris)t.removeModel(r,"",!0)}addFeature(t,r,l){const u=this.layers[0],m=u.layout.get("model-id").evaluate(l,{},this.canonical);if(!m)return qi(`modelId is not evaluated for layer ${u.id} and it is not going to get rendered.`),m;(Bx(m,!1)||this.styleDefinedModelURLs[m]!==void 0)&&(this.modelUris.includes(m)||this.modelUris.push(m)),this.instancesPerModel[m]||(this.instancesPerModel[m]=new d1);const _=this.instancesPerModel[m],b=_.instancedDataArray,E=new u1(l,b.length);for(const P of r)for(const R of P){if(R.x<0||R.x>=ri||R.y<0||R.y>=ri)continue;if(this.lookupDim!==0){const O=(this.lookupDim-1)/ri,$=this.lookupDim*(R.y*O|0)+R.x*O|0;if(this.lookup){if(this.lookup[$]!==0)continue;this.lookup[$]=1}}this.instanceCount++;const F=b.length;b.resize(F+1),_.instancesEvaluatedElevation.push(0),b.float32[16*F]=R.x,b.float32[16*F+1]=R.y}return E.instancedDataCount=_.instancedDataArray.length-E.instancedDataOffset,E.instancedDataCount>0&&(t.id&&(_.idToFeaturesIndex[t.id]=_.features.length),_.features.push(E),this.evaluate(E,{},_,!1)),m}getModelUris(){return this.modelUris}evaluate(t,r,l,u){const m=this.layers[0],_=t.feature,b=this.canonical,E=t.rotation=m.paint.get("model-rotation").evaluate(_,r,b),P=t.scale=m.paint.get("model-scale").evaluate(_,r,b),R=t.translation=m.paint.get("model-translation").evaluate(_,r,b),F=Object.assign({},m.paint.get("model-color").evaluate(_,r,b));F.a=m.paint.get("model-color-mix-intensity").evaluate(_,r,b);const O=[];this.maxVerticalOffset<R[2]&&(this.maxVerticalOffset=R[2]);const $=R[0]*R[0]+R[1]*R[1],q=$>0?Math.sqrt($):0;l.maxScale=Math.max(Math.max(l.maxScale,P[0]),Math.max(P[1],P[2])),l.maxXYTranslationDistance=Math.max(l.maxXYTranslationDistance,q),this.maxScale=Math.max(Math.max(this.maxScale,P[0]),Math.max(P[1],P[2])),ji(O,E,P);const Y=Math.round(100*F.a)+F.b/1.05;for(let rt=0;rt<t.instancedDataCount;++rt){const at=t.instancedDataOffset+rt,gt=16*at,yt=l.instancedDataArray.float32;let Pt=0;u&&(Pt=yt[gt+6]-l.instancesEvaluatedElevation[at]);const qt=0|yt[gt+1];yt[gt]=(0|yt[gt])+F.r/1.05,yt[gt+1]=qt+F.g/1.05,yt[gt+2]=Y,yt[gt+3]=1/(b.z>10?this.tileToMeter:Ht(b,qt)),yt[gt+4]=R[0],yt[gt+5]=R[1],yt[gt+6]=R[2]+Pt,yt[gt+7]=O[0],yt[gt+8]=O[1],yt[gt+9]=O[2],yt[gt+10]=O[4],yt[gt+11]=O[5],yt[gt+12]=O[6],yt[gt+13]=O[8],yt[gt+14]=O[9],yt[gt+15]=O[10],l.instancesEvaluatedElevation[at]=R[2]}}}let p1,f1;Si(Ox,"ModelBucket",{omit:["layers"]}),Si(d1,"PerModelAttributes"),Si(u1,"ModelFeature");class o_{constructor(t,r,l){this._demTile=t,this._dem=this._demTile.dem,this._scale=r,this._offset=l}static create(t,r,l){const u=l||t.findDEMTileFor(r);if(!u||!u.dem)return;const m=u.dem,_=u.tileID,b=1<<r.canonical.z-_.canonical.z;return new o_(u,m.dim/ri/b,[(r.canonical.x/b-_.canonical.x)*m.dim,(r.canonical.y/b-_.canonical.y)*m.dim])}tileCoordToPixel(t,r){const l=r*this._scale+this._offset[1];return new Ae(Math.floor(t*this._scale+this._offset[0]),Math.floor(l))}getElevationAt(t,r,l,u){const m=t*this._scale+this._offset[0],_=r*this._scale+this._offset[1],b=Math.floor(m),E=Math.floor(_),P=this._dem;return u=!!u,l?Vi(Vi(P.get(b,E,u),P.get(b,E+1,u),_-E),Vi(P.get(b+1,E,u),P.get(b+1,E+1,u),_-E),m-b):P.get(b,E,u)}getElevationAtPixel(t,r,l){return this._dem.get(t,r,!!l)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*_t(1,t)*this._dem.stride}}const Nx=new Float32Array(262144),sg=new Uint8Array(262144);function m1(n){let t=0;if(n.meshes)for(const r of n.meshes)t=Math.max(t,r.aabb.max[2]);if(n.children)for(const r of n.children)t=Math.max(t,m1(r));return t}function g1(n,t,r){if(n.meshes)for(const l of n.meshes){if(l.aabb.min[0]===1/0)continue;const u=Er.applyTransform(l.aabb,n.globalMatrix);r.insert(t,u.min[0],u.min[1],u.max[0],u.max[1])}if(n.children)for(const l of n.children)g1(l,t,r)}const _1=["","wall","door","roof","window","lamp","logo"];class y1{constructor(t){this.node=t,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:t.id,geometry:[],properties:{height:m1(t)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Er([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let t=0;const r=new Er([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const l of this.node.meshes)this.node.lightMeshIndex!==t&&(l.transformedAabb=Er.applyTransformFast(l.aabb,this.node.globalMatrix),r.encapsulate(l.transformedAabb)),t++;this.aabb=r}return this.aabb}}class O0{constructor(t,r,l,u,m,_,b,E){this.id=l,this.layers=t,this.layerIds=this.layers.map(P=>P.fqid),this.stateDependentLayerIds=this.layers.filter(P=>P.isStateDependent()).map(P=>P.id),this.modelTraits|=ur.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,u&&(this.modelTraits|=ur.HasMapboxMeshFeatures),m&&(this.modelTraits|=ur.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=_,this.worldview=E,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const P of r)this.nodesInfo.push(new y1(P)),g1(P,b.featureIndexArray.length,b.grid),b.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,b.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(t,r){for(const l of this.getNodesInfo()){const u=l.node;u.footprint&&r.push({footprint:u.footprint,id:t})}}updateAppearances(t,r,l,u){}update(t){const r=Object.keys(t).length!==0;if(r&&!this.stateDependentLayers.length)return;const l=r?this.stateDependentLayers:this.layers;if(!bo(t,this.states))for(const u of l)this.evaluate(u,t);this.states=structuredClone(t)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(t){if(!this.needsUpload)return;const r=this.getNodesInfo();for(const l of r){const u=l.node;this.uploaded?this.updatePbrBuffer(u):Gc(u,t,!0)}for(const l of r)Ja(l.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(t){let r=!1;if(!t.meshes)return r;for(const l of t.meshes)l.pbrBuffer&&(l.pbrBuffer.updateData(l.featureArray),r=!0);return r}needsReEvaluation(t,r,l){const u=t.transform.projectionOptions,m=t.style.getBrightness(),_=this.brightness!==m;if(!this.uploaded||this.dirty||u.name!==this.projection.name||vy(l.paint.get("model-color").value,_)||vy(l.paint.get("model-color-mix-intensity").value,_)||vy(l.paint.get("model-roughness").value,_)||vy(l.paint.get("model-emissive-strength").value,_)||vy(l.paint.get("model-height-based-emissive-strength-multiplier").value,_)){this.projection=u,this.brightness=m;const b=this.getNodesInfo();for(const E of b)E.state=null;return!0}return!1}evaluateTransform(t,r){if(t.transform.zoom===this.zoom)return;this.zoom=t.transform.zoom;const l=this.getNodesInfo(),u=this.id.canonical;for(const m of l){const _=m.feature;m.evaluatedTranslation=r.paint.get("model-translation").evaluate(_,{},u),m.evaluatedScale=r.paint.get("model-scale").evaluate(_,{},u)}}evaluate(t,r){const l=this.getNodesInfo();for(const u of l){if(!u.node.meshes)continue;const m=u.feature,_=r&&r[m.id];if(bo(_,u.state))continue;u.state=structuredClone(_);const b=u.node.meshes&&u.node.meshes[0].featureData,E=u.evaluatedColor[2],P=u.evaluatedRMEA[2],R=this.id.canonical;if(u.hasTranslucentParts=!1,b){for(let F=0;F<_1.length;F++){const O=_1[F];O.length&&(m.properties.part=O);const $=t.paint.get("model-color").evaluate(m,_,R).toPremultipliedRenderColor(null),q=t.paint.get("model-color-mix-intensity").evaluate(m,_,R);u.evaluatedColor[F]=[$.r,$.g,$.b,q],u.evaluatedRMEA[F][0]=t.paint.get("model-roughness").evaluate(m,_,R),u.evaluatedRMEA[F][2]=t.paint.get("model-emissive-strength").evaluate(m,_,R),u.evaluatedRMEA[F][3]=$.a,u.emissionHeightBasedParams[F]=t.paint.get("model-height-based-emissive-strength-multiplier").evaluate(m,_,R),!u.hasTranslucentParts&&$.a<1&&(u.hasTranslucentParts=!0)}delete m.properties.part,zw(u,E!==u.evaluatedColor[2]||P!==u.evaluatedRMEA[2],this.modelTraits)}else u.evaluatedRMEA[0][2]=t.paint.get("model-emissive-strength").evaluate(m,_,R);u.evaluatedTranslation=t.paint.get("model-translation").evaluate(m,_,R),u.evaluatedScale=t.paint.get("model-scale").evaluate(m,_,R),this.updatePbrBuffer(u.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(t,r,l,u){const m=t.findDEMTileFor(l);if(m&&(m.tileID.canonical!==this.terrainTile||r!==this.terrainExaggeration)){if(m.dem&&m.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=m.tileID.overscaledZ;const _=o_.create(t,l,m);if(!_)return;this.modelTraits&ur.HasMapboxMeshFeatures&&this.updateDEM(t,_,l,u);for(const b of this.getNodesInfo()){const E=b.node;if(!E.footprint||!E.footprint.vertices||!E.footprint.vertices.length)continue;const P=E.footprint.vertices;let R=_.getElevationAt(P[0].x,P[0].y,!0,!0);for(let F=1;F<P.length;F++)R=Math.min(R,_.getElevationAt(P[F].x,P[F].y,!0,!0));E.elevation=R}}this.terrainTile=m.tileID.canonical,this.terrainExaggeration=r}}updateDEM(t,r,l,u){let m=r._dem._modifiedForSources[u];if(m===void 0&&(r._dem._modifiedForSources[u]=[],m=r._dem._modifiedForSources[u]),m.includes(l.canonical))return;const _=r._dem.dim;m.push(l.canonical);let b=!1;for(const E of this.getNodesInfo()){const P=E.node;if(!P.footprint||!P.footprint.grid)continue;const R=P.footprint.grid,F=r.tileCoordToPixel(R.min.x,R.min.y),O=r.tileCoordToPixel(R.max.x,R.max.y),$=Math.min(Math.min(_-O.y,F.x),Math.min(F.y,_-O.x));if($<0)continue;const q=tt($,2,5);let Y=Math.max(0,F.x-q),rt=Math.max(0,F.y-q),at=Math.min(O.x+q,_-1),gt=Math.min(O.y+q,_-1);for(let Bt=rt;Bt<=gt;++Bt)for(let Yt=Y;Yt<=at;++Yt)sg[Bt*_+Yt]=255;let yt=0,Pt=0;for(let Bt=0;Bt<R.cellsY;++Bt)for(let Yt=0;Yt<R.cellsX;++Yt){if(!R.cells[Bt*R.cellsX+Yt])continue;const ee=r.tileCoordToPixel(R.min.x+Yt/R.xScale,R.min.y+Bt/R.yScale),ne=r.tileCoordToPixel(R.min.x+(Yt+1)/R.xScale,R.min.y+(Bt+1)/R.yScale);for(let Le=ee.y;Le<=Math.min(ne.y+1,_-1);++Le)for(let fe=ee.x;fe<=Math.min(ne.x+1,_-1);++fe)sg[Le*_+fe]===255&&(sg[Le*_+fe]=0,yt+=r.getElevationAtPixel(fe,Le),Pt++)}const qt=yt/Pt;Y=Math.max(1,F.x-q),rt=Math.max(1,F.y-q),at=Math.min(O.x+q,_-2),gt=Math.min(O.y+q,_-2),b=!0;for(let Bt=rt;Bt<=gt;++Bt)for(let Yt=Y;Yt<=at;++Yt)sg[Bt*_+Yt]===0&&(Nx[Bt*_+Yt]=r._dem.set(Yt,Bt,qt));for(let Bt=1;Bt<q;++Bt){Y=Math.max(1,F.x-Bt),rt=Math.max(1,F.y-Bt),at=Math.min(O.x+Bt,_-2),gt=Math.min(O.y+Bt,_-2);for(let Yt=rt;Yt<=gt;++Yt)for(let ee=Y;ee<=at;++ee){const ne=Yt*_+ee;if(sg[ne]===255){let Le=0,fe=0,ke=-1,Ue=-1;for(let Ze=-1;Ze<=1;++Ze)for(let hi=-1;hi<=1;++hi){const Ke=(Yt+Ze)*_+ee+hi;if(sg[Ke]>=Bt)continue;const je=Nx[Ke],Ye=Math.abs(je);Ye>fe&&(Le=je,fe=Ye,ke=hi,Ue=Ze)}if(fe>.1){const Ze=1-(Bt+.5*Math.abs(ke*Ue))/q;let hi=r._dem.get(ee,Yt)+Le*Ze;const Ke=r._dem.get(ee+ke,Yt+Ue),je=r._dem.get(ee-ke,Yt-Ue,!0);(hi-Ke)*(hi-je)>0&&(hi=(Ke+je)/2),Nx[ne]=r._dem.set(ee,Yt,hi),sg[ne]=Bt}}}}}b&&(r._demTile.needsDEMTextureUpload=!0,r._dem._timestamp=$a.now())}setFilter(t){this.filter=t?be(t):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(t=>this.filter.filter(new D(this.id.overscaledZ,{worldview:this.worldview}),t.feature,this.id.canonical)):this.nodesInfo}destroy(){const t=this.getNodesInfo();for(const r of t)Ja(r.node),Sa(r.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(t,r){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const l=r.getReplacementRegionsForTile(t.toUnwrapped());for(const u of this.getNodesInfo()){const m=u.node.footprint;u.hiddenByReplacement=!!m&&!l.find(_=>_.footprint===m)}}getHeightAtTileCoord(t,r){const l=[],u=[0,0,0],m=Ve([]);for(const _ of this.getNodesInfo()){const b=_.node.meshes[0],E=b.transformedAabb;if(t<E.min[0]||r<E.min[1]||t>E.max[0]||r>E.max[1])continue;if(_.node.hidden===!0)return{height:1/0,maxHeight:_.feature.properties.height,hidden:!1,verticalScale:_.evaluatedScale[2]};Io(m,_.node.globalMatrix),u[0]=t,u[1]=r,Kn(u,u,m);const P=(u[0]-b.aabb.min[0])/(b.aabb.max[0]-b.aabb.min[0])*Mr|0,R=Math.min(63,(u[1]-b.aabb.min[1])/(b.aabb.max[1]-b.aabb.min[1])*Mr|0)*Mr+Math.min(63,P),F=b.heightmap[R];if(!(F<0&&_.node.footprint))return _.hiddenByReplacement?void 0:{height:F,maxHeight:_.feature.properties.height,hidden:!1,verticalScale:_.evaluatedScale[2]};if(_.node.footprint.grid.query(new Ae(t,r),new Ae(t,r),l),l.length>0)return{height:void 0,maxHeight:_.feature.properties.height,hidden:_.hiddenByReplacement,verticalScale:_.evaluatedScale[2]}}}}function vy(n,t){return n instanceof lh&&!n.isLightConstant&&t}function Dw(n,t,r,l,u,m,_,b){let E=(61440&t|(61440&t)>>4)>>8,P=(3840&t|(3840&t)>>4)>>4,R=240&t|(240&t)>>4;r[3]>0&&(E=Vi(E,255*r[0],r[3]),P=Vi(P,255*r[1],r[3]),R=Vi(R,255*r[2],r[3]));const F=E<<8|P,O=R<<8|Math.floor(255*l[3]),$=function(Bt){const Yt=tt(Bt,0,2);return Math.min(Math.round(.5*Yt*255),255)}(l[2])<<8|15*l[0]<<4|15*l[1],q=tt(u[0],0,1),Y=tt(u[1],0,1),rt=tt(u[2],0,1),at=tt(u[3],0,1);let gt,yt,Pt,qt;if(q!==Y&&_!==m&&Y!==q){const Bt=_-m;yt=1/(Bt*(Y-q)),Pt=-(m+Bt*q)/(Bt*(Y-q));const Yt=tt(u[4],-1,1);qt=Math.pow(10,Yt),gt=255*rt<<8|255*at}else gt=65535,yt=0,Pt=1,qt=1;if(n.emplaceBack(F,O,$,gt,yt,Pt,qt),b){const Bt=b.length;b.clear();for(let Yt=0;Yt<Bt;Yt++)b.emplaceBack(F,O,$,gt,yt,Pt,qt)}}function zw(n,t,r){const l=n.node;let u=0;const m=r&ur.HasMeshoptCompression;for(const _ of l.meshes){if(l.lights&&l.lightMeshIndex===u||!_.featureData)continue;_.featureArray=new ud,_.featureArray.reserve(_.featureData.length);let b=t;for(const E of _.featureData){const P=m?65535&E:E>>16&65535,R=m?E>>16&65535:65535&E,F=(15&R)<8?15&R:0,O=n.evaluatedRMEA[F],$=n.evaluatedColor[F],q=n.emissionHeightBasedParams[F];let Y;if(b&&F===2&&l.lights&&(Y=new ud,Y.resize(10*l.lights.length)),Dw(_.featureArray,P,$,O,q,_.aabb.min[2],_.aabb.max[2],Y),Y&&b){b=!1;const rt=l.meshes[l.lightMeshIndex];rt.featureArray=Y,rt.featureArray._trim()}}_.featureArray._trim(),u++}}Si(O0,"Tiled3dModelBucket",{omit:["layers"]}),Si(y1,"Tiled3dModelFeature");const Lw=["id","tile","layer","source","sourceLayer","state"];class ag{constructor(t,r,l,u,m){this.type="Feature",this._vectorTileFeature=t,this._z=r,this._x=l,this._y=u,this.properties=t?t.properties:{},this.id=m}clone(){const t=new ag(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(t.state=Object.assign({},this.state)),this.layer&&(t.layer=Object.assign({},this.layer)),this.source&&(t.source=this.source),this.sourceLayer&&(t.sourceLayer=this.sourceLayer),t}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const r of Lw)this[r]!==void 0&&(t[r]=this[r]);return t}}class lg extends Ml{constructor(t,r,l,u){super(),this.id=t,this.type="model",this.models=[],this._loaded=!1,this._options=r,this._modelsInfo=new Map}load(){const t=[];for(const r in this._options.models){const l=this._options.models[r],u=this._modelsInfo.get(r);if(u){const m=u.model;m.position=l.position!=null?new Z(l.position[0],l.position[1]):new Z(0,0),m.orientation=l.orientation!=null?l.orientation:[0,0,0],u.modelSpec=l,lg.applyModelSpecification(m,l),m.computeBoundsAndApplyParent(),this.models.push(m)}else{const m=K(this.map._requestManager.transformRequest(l.uri,Is.Model).url).then(_=>{if(!_)return;const b=Ol(_),E=new is(r,l.uri,l.position,l.orientation,b);lg.applyModelSpecification(E,l),E.computeBoundsAndApplyParent(),this.models.push(E),this._modelsInfo.set(r,{modelSpec:l,model:E})}).catch(_=>{this.fire(new ac(new Error(`Could not load model ${r} from ${l.uri}: ${_.message}`)))});t.push(m)}}Promise.allSettled(t).then(()=>{this._loaded=!0,this.fire(new ya("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(r=>{this._loaded=!0,this.fire(new ac(new Error(`Could not load models: ${r.message}`)))})}static applyModelSpecification(t,r){r.nodeOverrides&&lg.convertNodeOverrides(t,r.nodeOverrides),r.materialOverrides&&lg.convertMaterialOverrides(t,r.materialOverrides),r.nodeOverrideNames&&(t.nodeOverrideNames=[...r.nodeOverrideNames]),r.materialOverrideNames&&(t.materialOverrideNames=[...r.materialOverrideNames]),r.featureProperties&&(t.featureProperties=r.featureProperties)}static convertNodeOverrides(t,r){if(Array.isArray(r)&&r.every(l=>typeof l=="string")){t.nodeOverrideNames=[];for(const l of r)t.nodeOverrideNames.push(l)}else Object.entries(r).forEach(([l,u])=>{const m={orientation:[0,0,0]};if(u.hasOwnProperty("orientation")){const _=u.orientation;_&&(m.orientation=_)}t.nodeOverrides.set(l,m)})}static convertMaterialOverrides(t,r){if(Array.isArray(r)&&r.every(l=>typeof l=="string")){t.materialOverrideNames=[];for(const l of r)t.materialOverrideNames.push(l)}else Object.entries(r).forEach(([l,u])=>{const m={color:new Dr(1,1,1),colorMix:0,emissionStrength:0,opacity:1},_=u["model-color"];_!==void 0&&(m.color.r=_[0],m.color.g=_[1],m.color.b=_[2]);const b=u["model-color-mix-intensity"];b!==void 0&&(m.colorMix=b);const E=u["model-emissive-strength"];E!==void 0&&(m.emissionStrength=E);const P=u["model-opacity"];P!==void 0&&(m.opacity=P),t.materialOverrides.set(l,m)})}onAdd(t){this.map=t,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(t,r){}serialize(){return this._options}setProperty(t,r){return!1}reload(){const t=co(this.id,this.scope);this.map.style.clearSource(t),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(t){this.models=[];const r=new Map;for(const l in t){const u=t[l];if(this._modelsInfo.has(l)){const m=this._modelsInfo.get(l);m&&m.modelSpec.uri===u.uri&&r.set(l,m)}}this._modelsInfo=r,this._options.models=t,this._loaded=!1,this.load()}}function Vx(n,t,r,l){const u=1<<n.z;t.lat=bt((l/ri+n.y)/u),t.lng=Ct((r/ri+n.x)/u)}function Rw(n,t,r,l){const u=n.getNodesInfo()[t];if(!u||u.hiddenByReplacement||!u.node.meshes)return;let m=Number.MAX_VALUE;const _=u.node,b=r.tile,E=l.calculatePosMatrix(b.tileID.toUnwrapped(),l.worldSize),P=u.evaluatedScale;let R=0;l.elevation&&_.elevation&&(R=_.elevation*l.elevation.exaggeration()),Yr(E,E,[(_.anchor?_.anchor[0]:0)*(P[0]-1),(_.anchor?_.anchor[1]:0)*(P[1]-1),R]),Fn(E,E,P);const F=r.queryGeometry,O=F.isPointQuery()?F.screenBounds:F.screenGeometry,$=function(Y){const rt=gr([],E,Y.globalMatrix);gr(rt,l.expandedFarZProjMatrix,rt);for(let at=0;at<Y.meshes.length;++at){const gt=Y.meshes[at];if(at===Y.lightMeshIndex)continue;const yt=Pr(O,l,rt,gt.aabb);yt!=null&&(m=Math.min(yt,m))}if(Y.children)for(const at of Y.children)$(at)};if($(_),m===Number.MAX_VALUE)return;const q=new Z(0,0);return Vx(b.tileID.canonical,q,u.node.anchor[0],u.node.anchor[1]),{intersectionZ:m,position:q,feature:u.feature}}const kw={circle:class extends $n{constructor(n,t,r,l){super(n,{layout:Cu||(Cu=new Xt({"circle-sort-key":new Et(ft.layout_circle["circle-sort-key"]),"circle-elevation-reference":new pt(ft.layout_circle["circle-elevation-reference"]),visibility:new pt(ft.layout_circle.visibility)})),paint:Vp||(Vp=new Xt({"circle-radius":new Et(ft.paint_circle["circle-radius"]),"circle-color":new Et(ft.paint_circle["circle-color"]),"circle-blur":new Et(ft.paint_circle["circle-blur"]),"circle-opacity":new Et(ft.paint_circle["circle-opacity"]),"circle-translate":new pt(ft.paint_circle["circle-translate"]),"circle-translate-anchor":new pt(ft.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new pt(ft.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new pt(ft.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Et(ft.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Et(ft.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Et(ft.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new pt(ft.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}createBucket(n){return new fo(n)}queryRadius(n){const t=n;return As("circle-radius",this,t)+As("circle-stroke-width",this,t)+ro(this.paint.get("circle-translate"))}queryIntersectsFeature(n,t,r,l,u,m,_,b){const E=Np(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),P=this.paint.get("circle-radius").evaluate(t,r)+this.paint.get("circle-stroke-width").evaluate(t,r);return Mg(n,l,m,_,b,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",E,P)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,t,r){const l=S_(this);return{config:new Mu(this,{zoom:t,lut:r}),defines:l,overrideFog:!1}}is3D(n){return!n&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends $n{createBucket(n){return new Oy(n)}constructor(n,t,r,l){super(n,{layout:Ny||(Ny=new Xt({visibility:new pt(ft.layout_heatmap.visibility)})),paint:Vy||(Vy=new Xt({"heatmap-radius":new Et(ft.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Et(ft.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new pt(ft.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Kt(ft.paint_heatmap["heatmap-color"]),"heatmap-opacity":new pt(ft.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=nm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(n){return As("heatmap-radius",this,n)}queryIntersectsFeature(n,t,r,l,u,m,_,b){const E=this.paint.get("heatmap-radius").evaluate(t,r);return Mg(n,l,m,_,b,!0,!0,new Ae(0,0),E)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,t,r){return n==="heatmap"?{config:new Mu(this,{zoom:t,lut:r}),overrideFog:!1}:{}}},hillshade:class extends $n{constructor(n,t,r,l){super(n,{layout:Uy||(Uy=new Xt({visibility:new pt(ft.layout_hillshade.visibility)})),paint:Cg||(Cg=new Xt({"hillshade-illumination-direction":new pt(ft.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new pt(ft.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new pt(ft.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new pt(ft.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new pt(ft.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new pt(ft.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new pt(ft.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,t,r){return{overrideFog:!1}}},fill:class extends $n{constructor(n,t,r,l){super(n,{layout:_l||(_l=new Xt({"fill-sort-key":new Et(ft.layout_fill["fill-sort-key"]),visibility:new pt(ft.layout_fill.visibility),"fill-elevation-reference":new pt(ft.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Et(ft.layout_fill["fill-construct-bridge-guard-rail"])})),paint:eu||(eu=new Xt({"fill-antialias":new pt(ft.paint_fill["fill-antialias"]),"fill-opacity":new Et(ft.paint_fill["fill-opacity"]),"fill-color":new Et(ft.paint_fill["fill-color"]),"fill-outline-color":new Et(ft.paint_fill["fill-outline-color"]),"fill-translate":new pt(ft.paint_fill["fill-translate"]),"fill-translate-anchor":new pt(ft.paint_fill["fill-translate-anchor"]),"fill-pattern":new Et(ft.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new pt(ft.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new pt(ft.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Et(ft.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Et(ft.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Et(ft.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}getProgramIds(){const n=this.paint.get("fill-pattern"),t=n&&n.constantOr(1),r=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&r.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),r}getDefaultProgramParams(n,t,r){return{config:new Mu(this,{zoom:t,lut:r}),overrideFog:!1}}recalculate(n,t){super.recalculate(n,t);const r=this.paint._values["fill-outline-color"];r.value.kind==="constant"&&r.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new Af(n)}queryRadius(){return ro(this.paint.get("fill-translate"))}queryIntersectsFeature(n,t,r,l,u,m){return!n.queryGeometry.isAboveHorizon&&Ro(ec(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),l)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(n){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const t=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return n!=null?t&&!n:t}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends $n{constructor(n,t,r,l){super(n,{layout:ip||(ip=new Xt({visibility:new pt(ft["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new pt(ft["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:X_||(X_=new Xt({"fill-extrusion-opacity":new pt(ft["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Et(ft["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new pt(ft["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new pt(ft["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Et(ft["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new pt(ft["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new Et(ft["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Et(ft["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new pt(ft["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new pt(ft["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new pt(ft["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new pt(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new pt(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Et(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Et(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new pt(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new pt(ft["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new pt(ft["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new pt(ft["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Et(ft["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Et(ft["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new pt(ft["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new vd(n)}queryRadius(){return ro(this.paint.get("fill-extrusion-translate"))}is3D(n){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,t,r,l,u,m,_,b,E){const P=Np(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),R=this.paint.get("fill-extrusion-height").evaluate(t,r),F=this.paint.get("fill-extrusion-base").evaluate(t,r),O=[0,0],$=b&&m.elevation,q=m.elevation?m.elevation.exaggeration():1,Y=n.tile.getBucket(this);if($&&Y instanceof vd){const Pt=Y.centroidVertexArray,qt=E+1;qt<Pt.length&&(O[0]=Pt.geta_centroid_pos0(qt),O[1]=Pt.geta_centroid_pos1(qt))}if(O[0]===0&&O[1]===1)return!1;m.projection.name==="globe"&&(l=l0([l],[new Ae(0,0),new Ae(ri,ri)],n.tileID.canonical).map(Pt=>Pt.polygon).flat());const rt=$?b:null,[at,gt]=Jm(m,l,F,R,P,_,rt,O,q,m.center.lat,n.tileID.canonical),yt=n.queryGeometry;return Ym(at,gt,yt.isPointQuery()?yt.screenBounds:yt.screenGeometry)}},building:class extends $n{constructor(n,t,r,l){super(n,{layout:Xg||(Xg=new Xt({visibility:new pt(ft.layout_building.visibility),"building-facade":new Et(ft.layout_building["building-facade"]),"building-facade-floors":new Et(ft.layout_building["building-facade-floors"]),"building-facade-unit-width":new Et(ft.layout_building["building-facade-unit-width"]),"building-facade-window":new Et(ft.layout_building["building-facade-window"]),"building-roof-shape":new Et(ft.layout_building["building-roof-shape"]),"building-height":new Et(ft.layout_building["building-height"]),"building-base":new Et(ft.layout_building["building-base"]),"building-flood-light-wall-radius":new Et(ft.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new Et(ft.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new Et(ft.layout_building["building-flip-roof-orientation"])})),paint:Sd||(Sd=new Xt({"building-opacity":new pt(ft.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new pt(ft.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new pt(ft.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new pt(ft.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new pt(ft.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new pt(ft.paint_building["building-vertical-scale"]),"building-cast-shadows":new pt(ft.paint_building["building-cast-shadows"]),"building-color":new Et(ft.paint_building["building-color"]),"building-emissive-strength":new Et(ft.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new pt(ft.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new pt(ft.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new pt(ft.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new pt(ft.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new pt(ft.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new ry(n)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(n){return!0}queryRadius(n){return 0}queryIntersectsFeature(n,t,r,l,u,m,_,b,E){let P=this.layout.get("building-height").evaluate(t,r);const R=this.layout.get("building-base").evaluate(t,r),F=n.tile.getBucket(this).getFootprint(t);if(F){if(F.hiddenFlags!==0)return!1;P=F.height}const[O,$]=Jm(m,l,R,P,new Ae(0,0),_,null,[0,0],1,m.center.lat,n.tileID.canonical),q=n.queryGeometry;return Ym(O,$,q.isPointQuery()?q.screenBounds:q.screenGeometry)}},line:class extends $n{constructor(n,t,r,l){const u=av();super(n,u,t,r,l),u.layout&&(this.layout=new St(u.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof Lc,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(n,t){super.recalculate(n,t),this.paint._values["line-floorwidth"]=(()=>{if(oy)return oy;const r=av();return oy=new Db(r.paint.properties["line-width"].specification),oy.useIntegerZoom=!0,oy})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new vm(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,t,r){const l=nu(this);return{config:new Mu(this,{zoom:t,lut:r}),defines:l,overrideFog:!1}}queryRadius(n){const t=n,r=lv(As("line-width",this,t),As("line-gap-width",this,t)),l=As("line-offset",this,t);return r/2+Math.abs(l)+ro(this.paint.get("line-translate"))}queryIntersectsFeature(n,t,r,l,u,m){if(n.queryGeometry.isAboveHorizon)return!1;const _=ec(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),b=n.pixelToTileUnitsFactor/2*lv(this.paint.get("line-width").evaluate(t,r),this.paint.get("line-gap-width").evaluate(t,r)),E=this.paint.get("line-offset").evaluate(t,r);return E&&(l=function(P,R){const F=[],O=new Ae(0,0);for(let $=0;$<P.length;$++){const q=P[$],Y=[];for(let rt=0;rt<q.length;rt++){const at=q[rt],gt=q[rt+1],yt=rt===0?O:at.sub(q[rt-1])._unit()._perp(),Pt=rt===q.length-1?O:gt.sub(at)._unit()._perp(),qt=yt._add(Pt)._unit();qt._mult(1/(qt.x*Pt.x+qt.y*Pt.y)),Y.push(qt._mult(R)._add(at))}F.push(Y)}return F}(l,E*n.pixelToTileUnitsFactor)),function(P,R,F){for(let O=0;O<R.length;O++){const $=R[O];if(P.length>=3){for(let q=0;q<$.length;q++)if(Bs(P,$[q]))return!0}if(mo(P,$,F))return!0}return!1}(_,l,b)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(n){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:R0,background:class extends $n{constructor(n,t,r,l){super(n,{layout:Jv||(Jv=new Xt({visibility:new pt(ft.layout_background.visibility)})),paint:Kv||(Kv=new Xt({"background-pitch-alignment":new pt(ft.paint_background["background-pitch-alignment"]),"background-color":new pt(ft.paint_background["background-color"]),"background-pattern":new pt(ft.paint_background["background-pattern"]),"background-opacity":new pt(ft.paint_background["background-opacity"]),"background-emissive-strength":new pt(ft.paint_background["background-emissive-strength"]),"background-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,t,r){return{overrideFog:!1}}is3D(n){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:r1,"raster-particle":c1,sky:class extends $n{constructor(n,t,r,l){super(n,{layout:s1||(s1=new Xt({visibility:new pt(ft.layout_sky.visibility)})),paint:a1||(a1=new Xt({"sky-type":new pt(ft.paint_sky["sky-type"]),"sky-atmosphere-sun":new pt(ft.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new pt(ft.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new pt(ft.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new pt(ft.paint_sky["sky-gradient-radius"]),"sky-gradient":new Kt(ft.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new pt(ft.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new pt(ft.paint_sky["sky-atmosphere-color"]),"sky-opacity":new pt(ft.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=nm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(n,t){if(this.paint.get("sky-type")==="atmosphere"){const l=this.paint.get("sky-atmosphere-sun"),u=!l,m=n.style.light,_=m.properties.get("position");return u&&m.properties.get("anchor")==="viewport"&&qi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),u?Fx(_.azimuthal,90-_.polar,t):Fx(l[0],90-l[1],t)}const r=this.paint.get("sky-gradient-center");return Fx(r[0],90-r[1],t)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends $n{constructor(n,t,r,l){super(n,{paint:l1||(l1=new Xt({}))},t,null)}},model:class extends $n{constructor(n,t,r,l){super(n,{layout:p1||(p1=new Xt({visibility:new pt(ft.layout_model.visibility),"model-id":new Et(ft.layout_model["model-id"])})),paint:f1||(f1=new Xt({"model-opacity":new Et(ft.paint_model["model-opacity"]),"model-rotation":new Et(ft.paint_model["model-rotation"]),"model-scale":new Et(ft.paint_model["model-scale"]),"model-translation":new Et(ft.paint_model["model-translation"]),"model-color":new Et(ft.paint_model["model-color"]),"model-color-mix-intensity":new Et(ft.paint_model["model-color-mix-intensity"]),"model-type":new pt(ft.paint_model["model-type"]),"model-cast-shadows":new pt(ft.paint_model["model-cast-shadows"]),"model-receive-shadows":new pt(ft.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new pt(ft.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Et(ft.paint_model["model-emissive-strength"]),"model-roughness":new Et(ft.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Et(ft.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new pt(ft.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new pt(ft.paint_model["model-front-cutoff"]),"model-elevation-reference":new pt(ft.paint_model["model-elevation-reference"]),"model-color-use-theme":new Et({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this.layer=n,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new Ox(n)}getProgramIds(){return["model"]}is3D(n){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof O0?ri-1:0}queryRenderedFeatures(n,t,r){const l=t.getSource();if(!(l&&l instanceof lg))return{};const u=l,m={};m[this.id]=[];const _=m[this.id];let b=0;for(const E of u.models){const P=t.getFeatureState(this.sourceLayer,E.id),R={type:"Unknown",id:E.id,properties:E.featureProperties},F=this.paint.get("model-rotation").evaluate(R,P),O=this.paint.get("model-scale").evaluate(R,P),$=this.paint.get("model-translation").evaluate(R,P),q=this.paint.get("model-elevation-reference");let Y=[];Sn(Y,E,r,E.position,F,O,$,q==="ground",q==="ground",!1),r.projection.name==="globe"&&(Y=Ar(Y,r));const rt=gr([],r.projMatrix,Y),at=Pr(n.isPointQuery()?n.screenBounds:n.screenGeometry,r,rt,E.aabb);if(at!=null){const gt=new ag(void 0,0,0,0,E.id);gt.layer=this.layer,gt.properties=structuredClone(E.featureProperties),gt.properties.layer=this.id,gt.properties.uri=E.uri,gt.properties.orientation=E.orientation,gt.sourceLayer=this.sourceLayer,gt.geometry={type:"Point",coordinates:[E.position.lng,E.position.lat]},gt.state=P,gt.source=this.source,_.push({featureIndex:b,feature:gt,intersectionZ:at})}++b}return m}queryIntersectsFeature(n,t,r,l,u,m){if(!this.modelManager)return!1;const _=this.modelManager,b=n.tile.getBucket(this);if(!(b&&b instanceof Ox))return!1;for(const E in b.instancesPerModel){const P=b.instancesPerModel[E],R=t.id!==void 0?t.id:t.properties&&t.properties.hasOwnProperty("id")?t.properties.id:void 0;if(P.idToFeaturesIndex.hasOwnProperty(R)){const F=P.features[P.idToFeaturesIndex[R]],O=_.getModel(E,this.scope);if(!O)return!1;let $=[];const q=new Z(0,0),Y=b.canonical;let rt=Number.MAX_VALUE;for(let at=0;at<F.instancedDataCount;++at){const gt=16*(F.instancedDataOffset+at),yt=P.instancedDataArray.float32,Pt=[yt[gt+4],yt[gt+5],yt[gt+6]];Vx(Y,q,Math.floor(yt[gt]),Math.floor(yt[gt+1])),Sn($,O,m,q,F.rotation,F.scale,Pt,!1,!1,!1),m.projection.name==="globe"&&($=Ar($,m));const qt=gr([],m.projMatrix,$),Bt=n.queryGeometry,Yt=Pr(Bt.isPointQuery()?Bt.screenBounds:Bt.screenGeometry,m,qt,O.aabb);Yt!=null&&(rt=Math.min(Yt,rt))}return rt!==Number.MAX_VALUE&&rt}}return!1}_handleOverridablePaintPropertyUpdate(n,t,r){return!(!this.layout||t.isDataDriven()||r.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){const t=this._transitionablePaint._values[n];return t!=null&&t.value!=null&&t.value.expression!=null&&t.value.expression instanceof cs}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends $n{constructor(n,t,r,l){super(n,{layout:hn||(hn=new Xt({"clip-layer-types":new pt(ft.layout_clip["clip-layer-types"]),"clip-layer-scope":new pt(ft.layout_clip["clip-layer-scope"])})),paint:R_||(R_=new Xt({}))},t,r,l)}recalculate(n,t){super.recalculate(n,t)}createBucket(n){return new Yy(n)}is3D(n){return!0}}},Ux=new Dr(0,0,0),jx={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Gx={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},N0={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},Fw={PAINT_ORDER_FILL_AND_STROKE:1},by={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},x1={MASK_TYPE_LUMINANCE:1};function Bw(n,t,r){n===1&&t.icons.push(function(l,u){return function(m){if(m.usvg_tree.height||(m.usvg_tree.height=m.usvg_tree.width),!m.metadata)return m;const{metadata:_}=m;if(_.content_area){const{content_area:b}=_;b.left==null&&(b.left=0),b.top==null&&(b.top=b.left),b.width==null&&(b.width=m.usvg_tree.width),b.height==null&&(b.height=b.width)}if(_.text_placeholder){const{text_placeholder:b}=_;b.top==null&&(b.top=b.left),b.height==null&&(b.height=b.width)}return _.stretch_x&&_.stretch_x.length&&v1(_,"x"),_.stretch_y&&_.stretch_y.length&&v1(_,"y"),m}(l.readFields(Ow,{name:void 0},u))}(r,r.readVarint()+r.pos))}function v1(n,t){const r=[],l=n[`stretch_${t}`];let u=null;for(let m=0;m<l.length;m++)u===null?u=r.length===0?l[0]:r[r.length-1][1]+l[m]:(r.push([u,u+l[m]]),u=null);n[`stretch_${t}_areas`]=r}function Ow(n,t,r){n===1?t.name=r.readString():n===2?t.metadata=function(l,u){return l.readFields(Nw,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},u)}(r,r.readVarint()+r.pos):n===3&&(t.usvg_tree=function(l,u){return l.readFields(jw,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},u)}(r,r.readVarint()+r.pos),t.data="usvg_tree")}function Nw(n,t,r){n===1?t.stretch_x=r.readPackedVarint():n===2?t.stretch_y=r.readPackedVarint():n===3?t.content_area=b1(r,r.readVarint()+r.pos):n===4?t.variables.push(function(l,u){return l.readFields(Uw,{name:void 0},u)}(r,r.readVarint()+r.pos)):n===5&&(t.text_placeholder=b1(r,r.readVarint()+r.pos))}function b1(n,t){return n.readFields(Vw,{},t)}function Vw(n,t,r){n===1?t.left=r.readVarint():n===2?t.width=r.readVarint():n===3?t.top=r.readVarint():n===4&&(t.height=r.readVarint())}function Uw(n,t,r){n===1?t.name=r.readString():n===2&&(t.rgb_color=j0(r.readVarint()),t.value="rgb_color")}function jw(n,t,r){n===1?t.width=t.height=r.readVarint():n===2?t.height=r.readVarint():n===3?t.children.push(V0(r,r.readVarint()+r.pos)):n===4?t.linear_gradients.push(function(l,u){return l.readFields(Xw,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},u)}(r,r.readVarint()+r.pos)):n===5?t.radial_gradients.push(function(l,u){return l.readFields(Jw,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},u)}(r,r.readVarint()+r.pos)):n===7?t.clip_paths.push(function(l,u){return l.readFields(Kw,{children:[]},u)}(r,r.readVarint()+r.pos)):n===8&&t.masks.push(function(l,u){const m=l.readFields(Qw,{left:0,width:20,mask_type:x1.MASK_TYPE_LUMINANCE,children:[]},u);return m.height==null&&(m.height=m.width),m.top==null&&(m.top=m.left),m}(r,r.readVarint()+r.pos))}function V0(n,t){return n.readFields(Gw,{},t)}function Gw(n,t,r){n===1?(t.group=function(l,u){return l.readFields($w,{opacity:255,children:[]},u)}(r,r.readVarint()+r.pos),t.node="group"):n===2&&(t.path=function(l,u){return l.readFields(Zw,{paint_order:1,commands:[],step:1,diffs:[],rule:jx.PATH_RULE_NON_ZERO},u)}(r,r.readVarint()+r.pos),t.node="path")}function $w(n,t,r){n===1?t.transform=U0(r,r.readVarint()+r.pos):n===2?t.opacity=r.readVarint():n===5?t.clip_path_idx=r.readVarint():n===6?t.mask_idx=r.readVarint():n===7&&t.children.push(V0(r,r.readVarint()+r.pos))}function U0(n,t){return n.readFields(qw,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},t)}function qw(n,t,r){n===1?t.sx=r.readFloat():n===2?t.ky=r.readFloat():n===3?t.kx=r.readFloat():n===4?t.sy=r.readFloat():n===5?t.tx=r.readFloat():n===6&&(t.ty=r.readFloat())}function Zw(n,t,r){n===1?t.fill=function(l,u){return l.readFields(Hw,{rgb_color:Ux,paint:"rgb_color",opacity:255},u)}(r,r.readVarint()+r.pos):n===2?t.stroke=function(l,u){return l.readFields(Ww,{rgb_color:Ux,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},u)}(r,r.readVarint()+r.pos):n===3?t.paint_order=r.readVarint():n===5?r.readPackedVarint(t.commands):n===6?t.step=r.readFloat():n===7?r.readPackedSVarint(t.diffs):n===8&&(t.rule=r.readVarint())}function Hw(n,t,r){n===1?(t.rgb_color=j0(r.readVarint()),t.paint="rgb_color"):n===2?(t.linear_gradient_idx=r.readVarint(),t.paint="linear_gradient_idx"):n===3?(t.radial_gradient_idx=r.readVarint(),t.paint="radial_gradient_idx"):n===5&&(t.opacity=r.readVarint())}function j0(n){return new Dr((n>>16&255)/255,(n>>8&255)/255,(255&n)/255,1)}function Ww(n,t,r){n===1?(t.rgb_color=j0(r.readVarint()),t.paint="rgb_color"):n===2?(t.linear_gradient_idx=r.readVarint(),t.paint="linear_gradient_idx"):n===3?(t.radial_gradient_idx=r.readVarint(),t.paint="radial_gradient_idx"):n===5?r.readPackedFloat(t.dasharray):n===6?t.dashoffset=r.readFloat():n===7?t.miterlimit=r.readFloat():n===8?t.opacity=r.readVarint():n===9?t.width=r.readFloat():n===10?t.linecap=r.readVarint():n===11&&(t.linejoin=r.readVarint())}function Xw(n,t,r){n===1?t.transform=U0(r,r.readVarint()+r.pos):n===2?t.spread_method=r.readVarint():n===3?t.stops.push(w1(r,r.readVarint()+r.pos)):n===4?t.x1=r.readFloat():n===5?t.y1=r.readFloat():n===6?t.x2=r.readFloat():n===7&&(t.y2=r.readFloat())}function w1(n,t){return n.readFields(Yw,{offset:0,opacity:255,rgb_color:Ux},t)}function Yw(n,t,r){n===1?t.offset=r.readFloat():n===2?t.opacity=r.readVarint():n===3&&(t.rgb_color=j0(r.readVarint()))}function Jw(n,t,r){n===1?t.transform=U0(r,r.readVarint()+r.pos):n===2?t.spread_method=r.readVarint():n===3?t.stops.push(w1(r,r.readVarint()+r.pos)):n===4?t.cx=r.readFloat():n===5?t.cy=r.readFloat():n===6?t.r=r.readFloat():n===7?t.fx=r.readFloat():n===8?t.fy=r.readFloat():n===9&&(t.fr=r.readFloat())}function Kw(n,t,r){n===1?t.transform=U0(r,r.readVarint()+r.pos):n===2?t.clip_path_idx=r.readVarint():n===3&&t.children.push(V0(r,r.readVarint()+r.pos))}function Qw(n,t,r){n===1?t.left=t.top=r.readFloat():n===2?t.width=t.height=r.readFloat():n===3?t.top=r.readFloat():n===4?t.height=r.readFloat():n===5?t.mask_type=r.readVarint():n===6?t.mask_idx=r.readVarint():n===7&&t.children.push(V0(r,r.readVarint()+r.pos))}class tT{static calculate(t={},r=[]){const l=new Map,u=new Map;if(Object.keys(t).length===0)return l;r.forEach(m=>{u.set(m.name,m.rgb_color||new Dr(0,0,0))});for(const[m,_]of Object.entries(t))u.has(m)?l.set(u.get(m).toString(),_):console.warn(`Ignoring unknown image variable "${m}"`);return l}}function s_(n,t=255,r){const l=t/255,u=n.toString(),m=r.has(u)?r.get(u).clone():n.clone();return m.a*=l,m.toString()}function wy(n,t){if(!Pa()){const r=document.createElement("canvas");return r.width=n,r.height=t,r}return new OffscreenCanvas(n,t)}function eT(n,t){const r=tT.calculate(t.params,n.metadata?n.metadata.variables:[]),l=n.usvg_tree,u=l.width,m=l.height,_=t.transform?t.transform:new DOMMatrix,b=Math.max(1,Math.round(u*_.a)),E=Math.max(1,Math.round(m*_.d)),P=new DOMMatrix([b/u,0,0,E/m,0,0]),R=wy(b,E).getContext("2d");return $x(R,P,l,l,r),R.getImageData(0,0,b,E)}function $x(n,t,r,l,u){for(const m of l.children)T1(n,t,r,m,u)}function T1(n,t,r,l,u){l.group?(n.save(),function(m,_,b,E,P){const R=E.mask_idx!=null?b.masks[E.mask_idx]:null,F=E.clip_path_idx!=null?b.clip_paths[E.clip_path_idx]:null;if(E.transform&&(_=a_(E.transform).preMultiplySelf(_)),!function(q,Y,rt){return q.opacity!==255||Y||rt}(E,F!=null,R!=null))return void $x(m,_,b,E,P);const O=wy(m.canvas.width,m.canvas.height),$=O.getContext("2d");$x($,_,b,E,P),F&&C1($,_,b,F),R&&D1($,_,b,R,P),m.globalAlpha=E.opacity/255,m.drawImage(O,0,0)}(n,t,r,l.group,u),n.restore()):l.path&&(n.save(),function(m,_,b,E,P){m.setTransform(_),E.paint_order===Fw.PAINT_ORDER_FILL_AND_STROKE?(S1(m,b,E,P),E1(m,b,E,P)):(E1(m,b,E,P),S1(m,b,E,P))}(n,t,r,l.path,u),n.restore())}function S1(n,t,r,l){const u=r.fill;if(!u)return;const m=u.opacity/255;switch(n.save(),n.beginPath(),z1(r,n),u.paint){case"rgb_color":n.fillStyle=s_(u.rgb_color,u.opacity,l);break;case"linear_gradient_idx":{const _=t.linear_gradients[u.linear_gradient_idx];_.transform&&n.setTransform(a_(_.transform).preMultiplySelf(n.getTransform())),n.fillStyle=A1(n,_,m,l);break}case"radial_gradient_idx":{const _=t.radial_gradients[u.radial_gradient_idx];_.transform&&n.setTransform(a_(_.transform).preMultiplySelf(n.getTransform())),n.fillStyle=P1(n,_,m,l)}}n.fill(I1(r)),n.restore()}function I1(n){return n.rule===jx.PATH_RULE_NON_ZERO?"nonzero":n.rule===jx.PATH_RULE_EVEN_ODD?"evenodd":void 0}function E1(n,t,r,l){const u=r.stroke;if(!u)return;const m=L1(r);n.lineWidth=u.width,n.miterLimit=u.miterlimit,n.setLineDash(u.dasharray),n.lineDashOffset=u.dashoffset;const _=u.opacity/255;switch(u.paint){case"rgb_color":n.strokeStyle=s_(u.rgb_color,u.opacity,l);break;case"linear_gradient_idx":n.strokeStyle=A1(n,t.linear_gradients[u.linear_gradient_idx],_,l,!0);break;case"radial_gradient_idx":n.strokeStyle=P1(n,t.radial_gradients[u.radial_gradient_idx],_,l,!0)}switch(u.linejoin){case N0.LINE_JOIN_MITER_CLIP:case N0.LINE_JOIN_MITER:n.lineJoin="miter";break;case N0.LINE_JOIN_ROUND:n.lineJoin="round";break;case N0.LINE_JOIN_BEVEL:n.lineJoin="bevel"}switch(u.linecap){case Gx.LINE_CAP_BUTT:n.lineCap="butt";break;case Gx.LINE_CAP_ROUND:n.lineCap="round";break;case Gx.LINE_CAP_SQUARE:n.lineCap="square"}n.stroke(m)}function A1(n,t,r,l,u=!1){if(t.stops.length===1){const O=t.stops[0];return s_(O.rgb_color,O.opacity*r,l)}const{x1:m,y1:_,x2:b,y2:E}=t;let P=new DOMPoint(m,_),R=new DOMPoint(b,E);if(u){const O=a_(t.transform);P=O.transformPoint(P),R=O.transformPoint(R)}const F=n.createLinearGradient(P.x,P.y,R.x,R.y);for(const O of t.stops)F.addColorStop(O.offset,s_(O.rgb_color,O.opacity*r,l));return F}function P1(n,t,r,l,u=!1){if(t.stops.length===1){const at=t.stops[0];return s_(at.rgb_color,at.opacity*r,l)}const m=a_(t.transform),{fx:_,fy:b,fr:E,cx:P,cy:R,r:F}=t;let O=new DOMPoint(_,b),$=new DOMPoint(P,R),q=E,Y=F;if(u){O=m.transformPoint(O),$=m.transformPoint($);const at=(m.a+m.d)/2;q=E*at,Y=t.r*at}const rt=n.createRadialGradient(O.x,O.y,q,$.x,$.y,Y);for(const at of t.stops)rt.addColorStop(at.offset,s_(at.rgb_color,at.opacity*r,l));return rt}function M1(n,t,r,l){const u=l.transform?a_(l.transform).preMultiplySelf(t):t,m=wy(n.canvas.width,n.canvas.height),_=m.getContext("2d");for(const E of l.children)if(E.group)M1(_,u,r,E.group);else if(E.path){const P=E.path,R=new Path2D;R.addPath(L1(P),u),_.fill(R,I1(P))}const b=l.clip_path_idx!=null?r.clip_paths[l.clip_path_idx]:null;b&&C1(_,u,r,b),n.globalCompositeOperation="source-over",n.drawImage(m,0,0)}function C1(n,t,r,l){const u=wy(n.canvas.width,n.canvas.height);M1(u.getContext("2d"),t,r,l),n.globalCompositeOperation="destination-in",n.drawImage(u,0,0)}function D1(n,t,r,l,u){if(l.children.length===0)return;const m=l.mask_idx!=null?r.masks[l.mask_idx]:null;m&&D1(n,t,r,m,u);const _=n.canvas.width,b=n.canvas.height,E=wy(_,b),P=E.getContext("2d"),R=l.width,F=l.height,O=l.left,$=l.top,q=new Path2D,Y=new Path2D;Y.rect(O,$,R,F),q.addPath(Y,t),P.clip(q);for(const gt of l.children)T1(P,t,r,gt,u);const rt=P.getImageData(0,0,_,b),at=rt.data;if(l.mask_type===x1.MASK_TYPE_LUMINANCE)for(let gt=0;gt<at.length;gt+=4)at[gt+3]=at[gt+3]/255*(.2126*at[gt]+.7152*at[gt+1]+.0722*at[gt+2]);P.putImageData(rt,0,0),n.globalCompositeOperation="destination-in",n.drawImage(E,0,0)}function a_(n){return n?new DOMMatrix([n.sx,n.ky,n.kx,n.sy,n.tx,n.ty]):new DOMMatrix}function z1(n,t){const r=n.step;let l=n.diffs[0]*r,u=n.diffs[1]*r;t.moveTo(l,u);for(let m=0,_=2;m<n.commands.length;m++)switch(n.commands[m]){case by.PATH_COMMAND_MOVE:l+=n.diffs[_++]*r,u+=n.diffs[_++]*r,t.moveTo(l,u);break;case by.PATH_COMMAND_LINE:l+=n.diffs[_++]*r,u+=n.diffs[_++]*r,t.lineTo(l,u);break;case by.PATH_COMMAND_QUAD:{const b=l+n.diffs[_++]*r,E=u+n.diffs[_++]*r;l=b+n.diffs[_++]*r,u=E+n.diffs[_++]*r,t.quadraticCurveTo(b,E,l,u);break}case by.PATH_COMMAND_CUBIC:{const b=l+n.diffs[_++]*r,E=u+n.diffs[_++]*r,P=b+n.diffs[_++]*r,R=E+n.diffs[_++]*r;l=P+n.diffs[_++]*r,u=R+n.diffs[_++]*r,t.bezierCurveTo(b,E,P,R,l,u);break}case by.PATH_COMMAND_CLOSE:t.closePath()}return t}function L1(n){return z1(n,new Path2D)}class G0{constructor(t){this.capacity=t,this.cache=new Map}get(t){if(!this.cache.has(t))return;const r=this.cache.get(t);return this.cache.delete(t),this.cache.set(t,r),r}put(t,r){this.cache.has(t)?this.cache.delete(t):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(t,r)}delete(t){this.cache.delete(t)}}Si(G0,"LRUCache");class qx{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(t){return new Ta(t,t.data)}getFromCache(t,r,l){return this.cacheMap.has(l)||this.cacheMap.set(l,new G0(150)),this.cacheMap.get(l).get(co(t.toString(),r))}setInCache(t,r,l,u){this.cacheDependenciesMap.has(u)||this.cacheDependenciesMap.set(u,new Map),this.cacheMap.has(u)||this.cacheMap.set(u,new G0(150));const m=this.cacheDependenciesMap.get(u),_=co(t.id.toString(),l);m.get(_)||m.set(_,new Set);const b=this.cacheMap.get(u),E=t.toString();m.get(_).add(E),b.put(co(t.toString(),l),r)}removeImagesFromCacheByIds(t,r,l=0){if(!this.cacheMap.has(l)||!this.cacheDependenciesMap.has(l))return;const u=this.cacheMap.get(l),m=this.cacheDependenciesMap.get(l);for(const _ of t){const b=co(_.toString(),r);if(m.has(b)){for(const E of m.get(b))u.delete(E);m.delete(b)}}}rasterize(t,r,l,u,m=eT){const _=this.getFromCache(t,l,u);if(_)return _.clone();const b=m(r.icon,t.options),E=qx._getImage(b);return this.setInCache(t,E,l,u),E.clone()}}class R1{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,r){const l=this.toIdx(t,r);return{min:this.minimums[l],max:this.maximums[l]}}isLeaf(t,r){return this.leaves[this.toIdx(t,r)]}toIdx(t,r){return r*this.size+t}}function k1(n,t,r,l){let u=0,m=Number.MAX_VALUE;for(let _=0;_<3;_++)if(Math.abs(l[_])<1e-15){if(r[_]<n[_]||r[_]>t[_])return null}else{const b=1/l[_];let E=(n[_]-r[_])*b,P=(t[_]-r[_])*b;if(E>P){const R=E;E=P,P=R}if(E>u&&(u=E),P<m&&(m=P),u>m)return null}return u}function F1(n,t,r,l,u,m,_,b,E,P,R){const F=l-n,O=u-t,$=m-r,q=_-n,Y=b-t,rt=E-r,at=R[1]*rt-R[2]*Y,gt=R[2]*q-R[0]*rt,yt=R[0]*Y-R[1]*q,Pt=F*at+O*gt+$*yt;if(Math.abs(Pt)<1e-15)return null;const qt=1/Pt,Bt=P[0]-n,Yt=P[1]-t,ee=P[2]-r,ne=(Bt*at+Yt*gt+ee*yt)*qt;if(ne<0||ne>1)return null;const Le=Yt*$-ee*O,fe=ee*F-Bt*$,ke=Bt*O-Yt*F,Ue=(R[0]*Le+R[1]*fe+R[2]*ke)*qt;return Ue<0||ne+Ue>1?null:(q*Le+Y*fe+rt*ke)*qt}function B1(n,t,r){return(n-t)/(r-t)}function O1(n,t,r,l,u,m,_,b,E){const P=1<<r,R=m-l,F=_-u,O=(n+1)/P*R+l,$=(t+0)/P*F+u,q=(t+1)/P*F+u;b[0]=(n+0)/P*R+l,b[1]=$,E[0]=O,E[1]=q}class N1{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const r=function(m){const _=Math.ceil(Math.log2(m.dim/8)),b=[];let E=Math.ceil(Math.pow(2,_));const P=1/E,R=($,q,Y,rt,at)=>{const gt=rt?1:0,yt=($+1)*Y-gt,Pt=q*Y,qt=(q+1)*Y-gt;at[0]=$*Y,at[1]=Pt,at[2]=yt,at[3]=qt};let F=new R1(E);const O=[];for(let $=0;$<E*E;$++){R($%E,Math.floor($/E),P,!1,O);const q=wm(O[0],O[1],m),Y=wm(O[2],O[1],m),rt=wm(O[2],O[3],m),at=wm(O[0],O[3],m);F.minimums.push(Math.min(q,Y,rt,at)),F.maximums.push(Math.max(q,Y,rt,at)),F.leaves.push(1)}for(b.push(F),E/=2;E>=1;E/=2){const $=b[b.length-1];F=new R1(E);for(let q=0;q<E*E;q++){R(q%E,Math.floor(q/E),2,!0,O);const Y=$.getElevation(O[0],O[1]),rt=$.getElevation(O[2],O[1]),at=$.getElevation(O[2],O[3]),gt=$.getElevation(O[0],O[3]),yt=$.isLeaf(O[0],O[1]),Pt=$.isLeaf(O[2],O[1]),qt=$.isLeaf(O[2],O[3]),Bt=$.isLeaf(O[0],O[3]),Yt=Math.min(Y.min,rt.min,at.min,gt.min),ee=Math.max(Y.max,rt.max,at.max,gt.max),ne=yt&&Pt&&qt&&Bt;F.maximums.push(ee),F.minimums.push(Yt),F.leaves.push(ee-Yt<=5&&ne?1:0)}b.push(F)}return b}(this.dem),l=r.length-1,u=r[l];this._addNode(u.minimums[0],u.maximums[0],u.leaves[0]),this._construct(r,0,0,l,0)}raycastRoot(t,r,l,u,m,_,b=1){return k1([t,r,-100],[l,u,this.maximums[0]*b],m,_)}raycast(t,r,l,u,m,_,b=1){if(!this.nodeCount)return null;const E=this.raycastRoot(t,r,l,u,m,_,b);if(E==null)return null;const P=[],R=[],F=[],O=[],$=[{idx:0,t:E,nodex:0,nodey:0,depth:0}];for(;$.length>0;){const{idx:q,t:Y,nodex:rt,nodey:at,depth:gt}=$.pop();if(this.leaves[q]){O1(rt,at,gt,t,r,l,u,F,O);const Pt=1<<gt,qt=(rt+0)/Pt,Bt=(rt+1)/Pt,Yt=(at+0)/Pt,ee=(at+1)/Pt,ne=wm(qt,Yt,this.dem)*b,Le=wm(Bt,Yt,this.dem)*b,fe=wm(Bt,ee,this.dem)*b,ke=wm(qt,ee,this.dem)*b,Ue=F1(F[0],F[1],ne,O[0],F[1],Le,O[0],O[1],fe,m,_),Ze=F1(O[0],O[1],fe,F[0],O[1],ke,F[0],F[1],ne,m,_),hi=Math.min(Ue!==null?Ue:Number.MAX_VALUE,Ze!==null?Ze:Number.MAX_VALUE);if(hi!==Number.MAX_VALUE)return hi;{const Ke=Ks([],m,_,Y);if(V1(ne,Le,ke,fe,B1(Ke[0],F[0],O[0]),B1(Ke[1],F[1],O[1]))>=Ke[2])return Y}continue}let yt=0;for(let Pt=0;Pt<this._siblingOffset.length;Pt++){O1((rt<<1)+this._siblingOffset[Pt][0],(at<<1)+this._siblingOffset[Pt][1],gt+1,t,r,l,u,F,O),F[2]=-100,O[2]=this.maximums[this.childOffsets[q]+Pt]*b;const qt=k1(F,O,m,_);if(qt!=null){const Bt=qt;P[Pt]=Bt;let Yt=!1;for(let ee=0;ee<yt&&!Yt;ee++)Bt>=P[R[ee]]&&(R.splice(ee,0,Pt),Yt=!0);Yt||(R[yt]=Pt),yt++}}for(let Pt=0;Pt<yt;Pt++){const qt=R[Pt];$.push({idx:this.childOffsets[q]+qt,t:P[qt],nodex:(rt<<1)+this._siblingOffset[qt][0],nodey:(at<<1)+this._siblingOffset[qt][1],depth:gt+1})}}return null}_addNode(t,r,l){return this.minimums.push(t),this.maximums.push(r),this.leaves.push(l),this.childOffsets.push(0),this.nodeCount++}_construct(t,r,l,u,m){if(t[u].isLeaf(r,l)===1)return;this.childOffsets[m]||(this.childOffsets[m]=this.nodeCount);const _=u-1,b=t[_];let E=0,P=0;for(let R=0;R<this._siblingOffset.length;R++){const F=2*r+this._siblingOffset[R][0],O=2*l+this._siblingOffset[R][1],$=b.getElevation(F,O),q=b.isLeaf(F,O),Y=this._addNode($.min,$.max,q);q&&(E|=1<<R),P||(P=Y)}for(let R=0;R<this._siblingOffset.length;R++)E&1<<R||this._construct(t,2*r+this._siblingOffset[R][0],2*l+this._siblingOffset[R][1],_,P+R)}}function V1(n,t,r,l,u,m){return Vi(Vi(n,r,m),Vi(t,l,m),u)}function wm(n,t,r){const l=r.dim,u=tt(n*l-.5,0,l-1),m=tt(t*l-.5,0,l-1),_=Math.floor(u),b=Math.floor(m),E=Math.min(_+1,l-1),P=Math.min(b+1,l-1);return V1(r.get(_,b),r.get(E,b),r.get(_,P),r.get(E,P),u-_,m-b)}const iT={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function rT(n,t,r){return(256*n*256+256*t+r)/10-1e4}function nT(n,t,r){return 256*n+t+r/256-32768}class $0{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,r,l,u=!1){if(this.uid=t,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(l&&l!=="mapbox"&&l!=="terrarium")return void qi(`"${l}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=r.height;const m=this.dim=r.height-2,_=new Uint32Array(r.data.buffer);if(this.pixels=new Uint8Array(r.data.buffer),this.floatView=new Float32Array(r.data.buffer),this.borderReady=u,this._modifiedForSources={},!u){for(let E=0;E<m;E++)_[this._idx(-1,E)]=_[this._idx(0,E)],_[this._idx(m,E)]=_[this._idx(m-1,E)],_[this._idx(E,-1)]=_[this._idx(E,0)],_[this._idx(E,m)]=_[this._idx(E,m-1)];_[this._idx(-1,-1)]=_[this._idx(0,0)],_[this._idx(m,-1)]=_[this._idx(m-1,0)],_[this._idx(-1,m)]=_[this._idx(0,m-1)],_[this._idx(m,m)]=_[this._idx(m-1,m-1)]}const b=l==="terrarium"?nT:rT;for(let E=0;E<_.length;++E){const P=4*E;this.floatView[E]=b(this.pixels[P],this.pixels[P+1],this.pixels[P+2])}this._timestamp=$a.now()}_buildQuadTree(){this._tree=new N1(this)}get(t,r,l=!1){l&&(t=tt(t,-1,this.dim),r=tt(r,-1,this.dim));const u=this._idx(t,r);return this.floatView[u]}set(t,r,l){const u=this._idx(t,r),m=this.floatView[u];return this.floatView[u]=l,l-m}static getUnpackVector(t){return iT[t]}_idx(t,r){if(t<-1||t>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(t+1)}static pack(t,r){const l=[0,0,0,0],u=$0.getUnpackVector(r);let m=Math.floor((t+u[3])/u[2]);return l[2]=m%256,m=Math.floor(m/256),l[1]=m%256,m=Math.floor(m/256),l[0]=m,l}getPixels(){return new E_({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,r,l){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let u=r*this.dim,m=r*this.dim+this.dim,_=l*this.dim,b=l*this.dim+this.dim;switch(r){case-1:u=m-1;break;case 1:m=u+1}switch(l){case-1:_=b-1;break;case 1:b=_+1}const E=-r*this.dim,P=-l*this.dim;for(let R=_;R<b;R++)for(let F=u;F<m;F++){const O=4*this._idx(F,R),$=4*this._idx(F+E,R+P);this.pixels[O+0]=t.pixels[$+0],this.pixels[O+1]=t.pixels[$+1],this.pixels[O+2]=t.pixels[$+2],this.pixels[O+3]=t.pixels[$+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function oT(n,t,r){n===1?t.headerLength=r.readFixed32():n===2?t.x=r.readVarint():n===3?t.y=r.readVarint():n===4?t.z=r.readVarint():n===5&&t.layers.push(function(l,u){return l.readFields(hT,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},u)}(r,r.readVarint()+r.pos))}function sT(n,t,r){n===1?(t.delta_filter=function(l,u){return l.readFields(aT,{blockSize:0},u)}(r,r.readVarint()+r.pos),t.filter="delta_filter"):n===2?(r.readVarint(),t.filter="zigzag_filter"):n===3?(r.readVarint(),t.filter="bitshuffle_filter"):n===4&&(r.readVarint(),t.filter="byteshuffle_filter")}function aT(n,t,r){n===1&&(t.blockSize=r.readVarint())}function lT(n,t,r){n===1?(r.readVarint(),t.codec="gzip_data"):n===2?(r.readVarint(),t.codec="jpeg_image"):n===3?(r.readVarint(),t.codec="webp_image"):n===4&&(r.readVarint(),t.codec="png_image")}function cT(n,t,r){let l=0,u=0;n===1?t.firstByte=r.readFixed64():n===2?t.lastByte=r.readFixed64():n===3?t.filters.push(function(m,_){return m.readFields(sT,{},_)}(r,r.readVarint()+r.pos)):n===4?t.codec=function(m,_){return m.readFields(lT,{},_)}(r,r.readVarint()+r.pos):n===5?u=r.readFloat():n===6?l=r.readFloat():n===7?t.bands.push(r.readString()):n===8?t.offset=r.readDouble():n===9&&(t.scale=r.readDouble()),t.offset===0&&(t.offset=u),t.scale===0&&(t.scale=l)}function hT(n,t,r){n===1?t.version=r.readVarint():n===2?t.name=r.readString():n===3?t.units=r.readString():n===4?t.tileSize=r.readVarint():n===5?t.buffer=r.readVarint():n===6?t.pixelFormat=r.readVarint():n===7&&t.dataIndex.push(function(l,u){return l.readFields(cT,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},u)}(r,r.readVarint()+r.pos))}function uT(n,t,r){if(n===2)(function(l,u,m){l.readFields(dT,m,u)})(r,r.readVarint()+r.pos,t);else if(n===3)throw new Error("Not implemented")}function dT(n,t,r){if(n===1){let l=0;const u=r.readVarint()+r.pos;for(;r.pos<u;)t[l++]=r.readVarint()}}function pT(n,t){if(t.length!==4)throw new Error(`Expected data of dimension 4 but got ${t.length}.`);let r=t[3];for(let l=2;l>=1;l--){const u=l===1?1:0,m=l===2?1:0;for(let _=0;_<t[0];_++){const b=t[1]*_;for(let E=u;E<t[1];E++){const P=t[2]*(E+b);for(let R=m;R<t[2];R++){const F=t[3]*(R+P);for(let O=0;O<t[3];O++){const $=F+O;n[$]+=n[$-r]}}}}r*=t[l]}return n}function fT(n){for(let t=0,r=n.length;t<r;t++)n[t]=n[t]>>>1^-(1&n[t]);return n}function mT(n,t){switch(t){case"uint32":return n;case"uint16":for(let r=0;r<n.length;r+=2){const l=n[r],u=n[r+1];n[r]=(240&l)>>4|(61440&l)>>8|(240&u)<<4|61440&u,n[r+1]=15&l|(3840&l)>>4|(15&u)<<8|(3840&u)<<4}return n;case"uint8":for(let r=0;r<n.length;r+=4){const l=n[r],u=n[r+1],m=n[r+2],_=n[r+3];n[r+0]=(192&l)>>6|(192&u)>>4|(192&m)>>2|192&_,n[r+1]=(48&l)>>4|(48&u)>>2|48&m|(48&_)<<2,n[r+2]=(12&l)>>2|12&u|(12&m)<<2|(12&_)<<4,n[r+3]=3&l|(3&u)<<2|(3&m)<<4|(3&_)<<6}return n;default:throw new Error(`Invalid pixel format, "${t}"`)}}Si($0,"DEMData"),Si(N1,"DemMinMaxQuadTree",{omit:["dem"]});var Ru=Uint8Array,Ty=Uint16Array,gT=Int32Array,U1=new Ru([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),j1=new Ru([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),_T=new Ru([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),G1=function(n,t){for(var r=new Ty(31),l=0;l<31;++l)r[l]=t+=1<<n[l-1];var u=new gT(r[30]);for(l=1;l<30;++l)for(var m=r[l];m<r[l+1];++m)u[m]=m-r[l]<<5|l;return{b:r,r:u}},$1=G1(U1,2),q1=$1.b,yT=$1.r;q1[28]=258,yT[258]=28;for(var xT=G1(j1,0).b,Z1=new Ty(32768),Ys=0;Ys<32768;++Ys){var l_=(43690&Ys)>>1|(21845&Ys)<<1;Z1[Ys]=((65280&(l_=(61680&(l_=(52428&l_)>>2|(13107&l_)<<2))>>4|(3855&l_)<<4))>>8|(255&l_)<<8)>>1}var Sy=function(n,t,r){for(var l=n.length,u=0,m=new Ty(t);u<l;++u)n[u]&&++m[n[u]-1];var _,b=new Ty(t);for(u=1;u<t;++u)b[u]=b[u-1]+m[u-1]<<1;_=new Ty(1<<t);var E=15-t;for(u=0;u<l;++u)if(n[u])for(var P=u<<4|n[u],R=t-n[u],F=b[n[u]-1]++<<R,O=F|(1<<R)-1;F<=O;++F)_[Z1[F]>>E]=P;return _},Iy=new Ru(288);for(Ys=0;Ys<144;++Ys)Iy[Ys]=8;for(Ys=144;Ys<256;++Ys)Iy[Ys]=9;for(Ys=256;Ys<280;++Ys)Iy[Ys]=7;for(Ys=280;Ys<288;++Ys)Iy[Ys]=8;var H1=new Ru(32);for(Ys=0;Ys<32;++Ys)H1[Ys]=5;var vT=Sy(Iy,9),bT=Sy(H1,5),Zx=function(n){for(var t=n[0],r=1;r<n.length;++r)n[r]>t&&(t=n[r]);return t},ap=function(n,t,r){var l=t/8|0;return(n[l]|n[l+1]<<8)>>(7&t)&r},Hx=function(n,t){var r=t/8|0;return(n[r]|n[r+1]<<8|n[r+2]<<16)>>(7&t)},wT=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],lp=function(n,t,r){var l=new Error(t||wT[n]);if(l.code=n,Error.captureStackTrace&&Error.captureStackTrace(l,lp),!r)throw l;return l},TT=new Ru(0),ST=typeof TextDecoder<"u"&&new TextDecoder;try{ST.decode(TT,{stream:!0})}catch{}const IT={gzip_data:"gzip"};class Id extends Error{constructor(t){super(t),this.name="MRTError"}}const ET={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},W1={uint32:1,uint16:2,uint8:4},AT={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Wx;class q0{constructor(t=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=t}getLayer(t){const r=this.layers[t];if(!r)throw new Id(`Layer '${t}' not found`);return r}getHeaderLength(t){const r=new Uint8Array(t),l=new DataView(t);if(r[0]!==13)throw new Id("File is not a valid MRT.");return l.getUint32(1,!0)}parseHeader(t){const r=new Uint8Array(t),l=this.getHeaderLength(t);if(r.length<l)throw new Id(`Expected header with length >= ${l} but got buffer of length ${r.length}`);const u=new Wx(r.subarray(0,l)).readFields(oT,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==u.x||this.y!==u.y||this.z!==u.z))throw new Id(`Invalid attempt to parse header ${u.z}/${u.x}/${u.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=u.x,this.y=u.y,this.z=u.z;for(const m of u.layers)this.layers[m.name]=new X1(m,{cacheSize:this._cacheSize});return this}createDecodingTask(t){const r=[],l=this.getLayer(t.layerName);for(let u of t.blockIndices){const m=l.dataIndex[u],_=m.firstByte-t.firstByte,b=m.lastByte-t.firstByte;if(l._blocksInProgress.has(u))continue;const E={layerName:l.name,firstByte:_,lastByte:b,pixelFormat:l.pixelFormat,blockIndex:u,blockShape:[m.bands.length].concat(l.bandShape),buffer:l.buffer,codec:m.codec.codec,filters:m.filters.map(P=>P.filter)};l._blocksInProgress.add(u),r.push(E)}return new Y1(r,()=>{r.forEach(u=>l._blocksInProgress.delete(u.blockIndex))},(u,m)=>{if(r.forEach(_=>l._blocksInProgress.delete(_.blockIndex)),u)throw u;m.forEach(_=>{this.getLayer(_.layerName).processDecodedData(_)})})}}class X1{constructor({version:t,name:r,units:l,tileSize:u,pixelFormat:m,buffer:_,dataIndex:b},E){if(this.version=t,this.version!==1)throw new Id(`Cannot parse raster layer encoded with MRT version ${t}`);this.name=r,this.units=l,this.tileSize=u,this.buffer=_,this.pixelFormat=ET[m],this.dataIndex=b,this.bandShape=[u+2*_,u+2*_,W1[this.pixelFormat]],this._decodedBlocks=new G0(E?E.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return W1[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:t})=>t).flat()}processDecodedData(t){const r=t.blockIndex.toString();this._decodedBlocks.get(r)||this._decodedBlocks.put(r,t.data)}getBlockForBand(t){let r=0;switch(typeof t){case"string":for(const[l,u]of this.dataIndex.entries()){for(const[m,_]of u.bands.entries())if(_===t)return{bandIndex:r+m,blockIndex:l,blockBandIndex:m};r+=u.bands.length}break;case"number":for(const[l,u]of this.dataIndex.entries()){if(t>=r&&t<r+u.bands.length)return{bandIndex:t,blockIndex:l,blockBandIndex:t-r};r+=u.bands.length}break;default:throw new Id(`Invalid band \`${JSON.stringify(t)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(t){let r=1/0,l=-1/0;const u=[],m=new Set;for(const _ of t){const{blockIndex:b}=this.getBlockForBand(_);if(b<0)throw new Id(`Invalid band: ${JSON.stringify(_)}`);const E=this.dataIndex[b];u.includes(b)||u.push(b),m.add(b),r=Math.min(r,E.firstByte),l=Math.max(l,E.lastByte)}if(m.size>this.cacheSize)throw new Id(`Number of blocks to decode (${m.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:r,lastByte:l,blockIndices:u}}hasBand(t){const{blockIndex:r}=this.getBlockForBand(t);return r>=0}hasDataForBand(t){const{blockIndex:r}=this.getBlockForBand(t);return r>=0&&!!this._decodedBlocks.get(r.toString())}getBandView(t){const{blockIndex:r,blockBandIndex:l}=this.getBlockForBand(t);if(r<0)throw new Id(`Band not found: ${JSON.stringify(t)}`);const u=this._decodedBlocks.get(r.toString());if(!u)throw new Id(`Data for band ${JSON.stringify(t)} of layer "${this.name}" not decoded.`);const m=this.dataIndex[r],_=this.bandShape.reduce((P,R)=>P*R,1),b=l*_,E=u.subarray(b,b+_);return{data:E,bytes:new Uint8Array(E.buffer).subarray(E.byteOffset,E.byteOffset+E.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:m.offset,scale:m.scale}}}q0.setPbf=function(n){Wx=n};class Y1{constructor(t,r,l){this.tasks=t,this._onCancel=r,this._onComplete=l,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(t,r){this._finalized||(this._onComplete(t,r),this._finalized=!0)}}q0.performDecoding=function(n,t){const r=new Uint8Array(n);return Promise.all(t.tasks.map(l=>{const{layerName:u,firstByte:m,lastByte:_,pixelFormat:b,blockShape:E,blockIndex:P,filters:R,codec:F}=l,O=r.subarray(m,_+1),$=new Uint32Array(E[0]*E[1]*E[2]);let q;if(F!=="gzip_data")throw new Id(`Unhandled codec: ${F}`);return q=function(Y,rt){if(!globalThis.DecompressionStream&&rt==="gzip_data")return Promise.resolve(((Pt=function(Yt){Yt[0]==31&&Yt[1]==139&&Yt[2]==8||lp(6,"invalid gzip data");var ee=Yt[3],ne=10;4&ee&&(ne+=2+(Yt[10]|Yt[11]<<8));for(var Le=(ee>>3&1)+(ee>>4&1);Le>0;Le-=!Yt[ne++]);return ne+(2&ee)}(yt=Y))+8>yt.length&&lp(6,"invalid gzip data"),function(Yt,ee,ne,Le){var fe=Yt.length;if(!fe||ee.f&&!ee.l)return ne||new Ru(0);var ke=!ne,Ue=ke||ee.i!=2,Ze=ee.i;ke&&(ne=new Ru(3*fe));var hi,Ke,je=function(jo){var go=ne.length;if(jo>go){var no=new Ru(Math.max(2*go,jo));no.set(ne),ne=no}},Ye=ee.f||0,Me=ee.p||0,Ie=ee.b||0,He=ee.l,ai=ee.d,Ge=ee.m,Pi=ee.n,ki=8*fe;do{if(!He){Ye=ap(Yt,Me,1);var vi=ap(Yt,Me+1,3);if(Me+=3,!vi){var pi=Yt[(Ot=4+((Me+7)/8|0))-4]|Yt[Ot-3]<<8,dr=Ot+pi;if(dr>fe){Ze&&lp(0);break}Ue&&je(Ie+pi),ne.set(Yt.subarray(Ot,dr),Ie),ee.b=Ie+=pi,ee.p=Me=8*dr,ee.f=Ye;continue}if(vi==1)He=vT,ai=bT,Ge=9,Pi=5;else if(vi==2){var _i=ap(Yt,Me,31)+257,Wi=ap(Yt,Me+10,15)+4,mr=_i+ap(Yt,Me+5,31)+1;Me+=14;for(var Lr=new Ru(mr),rn=new Ru(19),_r=0;_r<Wi;++_r)rn[_T[_r]]=ap(Yt,Me+3*_r,7);Me+=3*Wi;var pn=Zx(rn),fn=(1<<pn)-1,Co=Sy(rn,pn);for(_r=0;_r<mr;){var Ot,Rt=Co[ap(Yt,Me,fn)];if(Me+=15&Rt,(Ot=Rt>>4)<16)Lr[_r++]=Ot;else{var Oe=0,di=0;for(Ot==16?(di=3+ap(Yt,Me,3),Me+=2,Oe=Lr[_r-1]):Ot==17?(di=3+ap(Yt,Me,7),Me+=3):Ot==18&&(di=11+ap(Yt,Me,127),Me+=7);di--;)Lr[_r++]=Oe}}var Ne=Lr.subarray(0,_i),fi=Lr.subarray(_i);Ge=Zx(Ne),Pi=Zx(fi),He=Sy(Ne,Ge),ai=Sy(fi,Pi)}else lp(1);if(Me>ki){Ze&&lp(0);break}}Ue&&je(Ie+131072);for(var Gi=(1<<Ge)-1,Ni=(1<<Pi)-1,Tr=Me;;Tr=Me){var er=(Oe=He[Hx(Yt,Me)&Gi])>>4;if((Me+=15&Oe)>ki){Ze&&lp(0);break}if(Oe||lp(2),er<256)ne[Ie++]=er;else{if(er==256){Tr=Me,He=null;break}var Bi=er-254;er>264&&(Bi=ap(Yt,Me,(1<<(nr=U1[_r=er-257]))-1)+q1[_r],Me+=nr);var un=ai[Hx(Yt,Me)&Ni],Nn=un>>4;if(un||lp(3),Me+=15&un,fi=xT[Nn],Nn>3){var nr=j1[Nn];fi+=Hx(Yt,Me)&(1<<nr)-1,Me+=nr}if(Me>ki){Ze&&lp(0);break}Ue&&je(Ie+131072);var Qr=Ie+Bi;if(Ie<fi){var Vn=0-fi,In=Math.min(fi,Qr);for(Vn+Ie<0&&lp(3);Ie<In;++Ie)ne[Ie]=(void 0)[Vn+Ie]}for(;Ie<Qr;++Ie)ne[Ie]=ne[Ie-fi]}}ee.l=He,ee.p=Tr,ee.b=Ie,ee.f=Ye,He&&(Ye=1,ee.m=Ge,ee.d=ai,ee.n=Pi)}while(!Ye);return Ie!=ne.length&&ke?(hi=ne,((Ke=Ie)==null||Ke>hi.length)&&(Ke=hi.length),new Ru(hi.subarray(0,Ke))):ne.subarray(0,Ie)}(yt.subarray(Pt,-8),{i:2},new Ru(((at=yt)[(gt=at.length)-4]|at[gt-3]<<8|at[gt-2]<<16|at[gt-1]<<24)>>>0))));var at,gt,yt,Pt;const qt=IT[rt];if(!qt)throw new Error(`Unhandled codec: ${rt}`);const Bt=new globalThis.DecompressionStream(qt);return new Response(new Blob([Y]).stream().pipeThrough(Bt)).arrayBuffer().then(Yt=>new Uint8Array(Yt))}(O,F).then(Y=>(function(rt,at){rt.readFields(uT,at)}(new Wx(Y),$),new AT[b]($.buffer))),q.then(Y=>{for(let rt=R.length-1;rt>=0;rt--)switch(R[rt]){case"delta_filter":pT(Y,E);break;case"zigzag_filter":fT(Y);break;case"bitshuffle_filter":mT(Y,b);break;default:throw new Id(`Unhandled filter "${R[rt]}"`)}return{layerName:u,blockIndex:P,data:Y}}).catch(Y=>{throw Y})}))},Si(Y1,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Si(q0,"MapboxRasterTile"),Si(X1,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class J1{constructor(t){this._stringToNumber={},this._numberToString=[];for(let r=0;r<t.length;r++){const l=t[r];this._stringToNumber[l]=r,this._numberToString[r]=l}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}class K1{constructor(t,r){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new to(ri,16,0),this.featureIndexArray=new zm,this.promoteId=r,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(t,r,l,u,m,_=0,b=0){const E=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(l,u,m,_);const P=this.grid;for(let R=0;R<r.length;R++){const F=r[R],O=[1/0,1/0,-1/0,-1/0];for(let $=0;$<F.length;$++){const q=F[$];O[0]=Math.min(O[0],q.x),O[1]=Math.min(O[1],q.y),O[2]=Math.max(O[2],q.x),O[3]=Math.max(O[3],q.y)}b!==0&&(O[0]-=b,O[1]-=b,O[2]+=b,O[3]+=b),O[0]<ri&&O[1]<ri&&O[2]>=0&&O[3]>=0&&P.insert(E,O[0],O[1],O[2],O[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Li(new b0(this.rawTileData)).layers,this.sourceLayerCoder=new J1(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,r){const{tilespaceGeometry:l,transform:u,tileTransform:m,pixelPosMatrix:_,availableImages:b,worldview:E}=r;this.loadVTLayers(),this.serializedLayersCache.clear();const P=r.queryRadius?r.queryRadius:0,R=l.bufferedTilespaceBounds,F=this.grid.query(R.min.x,R.min.y,R.max.x,R.max.y,(Y,rt,at,gt)=>io(l.bufferedTilespaceGeometry,Y-P,rt-P,at+P,gt+P));F.sort(PT);let O=null;u.elevation&&F.length>0&&(O=o_.create(u.elevation,this.tileID));const $={};let q;for(let Y=0;Y<F.length;Y++){const rt=F[Y];if(rt===q)continue;q=rt;const at=this.featureIndexArray.get(rt);let gt=null;this.is3DTile?this.loadMatchingModelFeature($,at,t,l,u,E):this.loadMatchingFeature($,at,t,b,E,(yt,Pt,qt,Bt=0)=>(gt||(gt=Be(yt,this.tileID.canonical,m)),Pt.queryIntersectsFeature(l,yt,qt,gt,this.z,u,_,O,Bt)))}return $}loadMatchingFeature(t,r,l,u,m,_){const{featureIndex:b,bucketIndex:E,sourceLayerIndex:P,layoutVertexArrayOffset:R}=r,F=this.bucketLayerIDs[E],O=l.layers,$=Object.keys(O);if($.length&&!Ji($,F))return;const q=l.sourceCache,Y=this.sourceLayerCoder.decode(P),rt=this.vtLayers[Y].feature(b),at=this.getId(rt,Y);for(let gt=0;gt<F.length;gt++){const yt=F[gt];if(!O[yt])continue;const{styleLayer:Pt,targets:qt}=O[yt];let Bt={};at!==void 0&&(Bt=q.getFeatureState(Pt.sourceLayer,at));const Yt=!_||_(rt,Pt,Bt,R);if(!Yt)continue;const ee=new ag(rt,this.z,this.x,this.y,at);ee.tile=this.tileID.canonical,ee.state=Bt;let ne=this.serializedLayersCache.get(yt);ne||(ne=Pt.serialize(),ne.id=yt,this.serializedLayersCache.set(yt,ne)),ee.source=ne.source,ee.sourceLayer=ne["source-layer"],ee.layer=Object.assign({},ne),ee.layer.paint=Q1(ne.paint,Pt.paint,rt,Bt,u),ee.layer.layout=Q1(ne.layout,Pt.layout,rt,Bt,u);let Le=!1;for(const fe of qt){this.updateFeatureProperties(ee,fe);const{filter:ke}=fe;if(ke){if(rt.properties=ee.properties,ke.needGeometry){const Ue=Te(rt,!0);if(!ke.filter(new D(this.tileID.overscaledZ,{worldview:m}),Ue,this.tileID.canonical))continue}else if(!ke.filter(new D(this.tileID.overscaledZ,{worldview:m}),rt))continue}Le=!0,fe.targetId&&this.addFeatureVariant(ee,fe)}Le&&this.appendToResult(t,yt,b,ee,Yt)}}loadMatchingModelFeature(t,r,l,u,m,_){const{featureIndex:b,bucketIndex:E}=r,P=this.bucketLayerIDs[E],R=l.layers,F=Object.keys(R);if(!F.length||Ji(F,P))for(let O=0;O<P.length;O++){const $=P[O],{styleLayer:q,targets:Y}=R[$];if(q.type!=="model")continue;const rt=u.tile,at=rt.getBucket(q);if(!(at&&at instanceof O0))continue;const gt=Rw(at,b,u,m);if(!gt)continue;const{z:yt,x:Pt,y:qt}=rt.tileID.canonical,{feature:Bt,intersectionZ:Yt,position:ee}=gt;let ne={};Bt.id!==void 0&&(ne=l.sourceCache.getFeatureState(q.sourceLayer,Bt.id));const Le=new ag({},yt,Pt,qt,Bt.id);Le.tile=this.tileID.canonical,Le.state=ne,Le.properties=Bt.properties,Le.geometry={type:"Point",coordinates:[ee.lng,ee.lat]};let fe=this.serializedLayersCache.get($);fe||(fe=q.serialize(),fe.id=$,this.serializedLayersCache.set($,fe)),Le.source=fe.source,Le.sourceLayer=fe["source-layer"],Le.layer=Object.assign({},fe);let ke=!1;for(const Ue of Y){this.updateFeatureProperties(Le,Ue);const{filter:Ze}=Ue;if(Ze){if(Bt.properties=Le.properties,Ze.needGeometry){if(!Ze.filter(new D(this.tileID.overscaledZ,{worldview:_}),Bt,this.tileID.canonical))continue}else if(!Ze.filter(new D(this.tileID.overscaledZ,{worldview:_}),Bt))continue}ke=!0,Ue.targetId&&this.addFeatureVariant(Le,Ue)}ke&&this.appendToResult(t,$,b,Le,Yt)}}updateFeatureProperties(t,r,l){if(r.properties){const u={};for(const m in r.properties){const _=r.properties[m].evaluate({zoom:this.z},t._vectorTileFeature,t.state,t.tile,l);_!=null&&(u[m]=_)}t.properties=u}}addFeatureVariant(t,r,l){const u={target:r.target,namespace:r.namespace,uniqueFeatureID:r.uniqueFeatureID};r.properties&&(u.properties=t.properties),t.variants=t.variants||{},t.variants[r.targetId]=t.variants[r.targetId]||[],t.variants[r.targetId].push(u)}appendToResult(t,r,l,u,m){let _=t[r];_===void 0&&(_=t[r]=[]),_.push({featureIndex:l,feature:u,intersectionZ:m})}lookupSymbolFeatures(t,r,l,u,m,_){const b={};this.loadVTLayers();for(const E of t)this.loadMatchingFeature(b,{bucketIndex:r,sourceLayerIndex:l,featureIndex:E,layoutVertexArrayOffset:0},u,m,_);return b}loadFeature(t){const{featureIndex:r,sourceLayerIndex:l}=t;this.loadVTLayers();const u=this.sourceLayerCoder.decode(l),m=this.vtFeatures[u];if(m[r])return m[r];const _=this.vtLayers[u].feature(r);return m[r]=_,_}hasLayer(t){for(const r of this.bucketLayerIDs)for(const l of r)if(t===l)return!0;return!1}getId(t,r){let l=t.id;if(this.promoteId){const u=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[r];if(u!=null)if(Array.isArray(u)){if(!this.promoteIdExpression){const m=pc(u);if(m.result!=="success"){const _=m.value.map(b=>`${b.key}: ${b.message}`).join(", ");return void qi(`Failed to create expression for promoteId: ${_}`)}this.promoteIdExpression=m.value}l=this.promoteIdExpression.evaluate({zoom:0},t)}else l=t.properties[u];typeof l=="boolean"&&(l=Number(l))}return l}}function Q1(n,t,r,l,u){return ti(n,(m,_)=>{const b=t instanceof St?t.get(_):null;return b&&b.evaluate?b.evaluate(r,l,void 0,u):b})}function PT(n,t){return t-n}Si(K1,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const tb=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Xx{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,l]=new Uint8Array(t,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const u=l>>4;if(u!==1)throw new Error(`Got v${u} data when expected v1.`);const m=tb[15&l];if(!m)throw new Error("Unrecognized array type.");const[_]=new Uint16Array(t,2,1),[b]=new Uint32Array(t,4,1);return new Xx(b,_,m,t)}constructor(t,r=64,l=Float64Array,u){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=l,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const m=tb.indexOf(this.ArrayType),_=2*t*this.ArrayType.BYTES_PER_ELEMENT,b=t*this.IndexArrayType.BYTES_PER_ELEMENT,E=(8-b%8)%8;if(m<0)throw new Error(`Unexpected typed array class: ${l}.`);u&&u instanceof ArrayBuffer?(this.data=u,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+b+E,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+_+b+E),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+b+E,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+m]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=t)}add(t,r){const l=this._pos>>1;return this.ids[l]=l,this.coords[this._pos++]=t,this.coords[this._pos++]=r,l}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Yx(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,r,l,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:_,nodeSize:b}=this,E=[0,m.length-1,0],P=[];for(;E.length;){const R=E.pop()||0,F=E.pop()||0,O=E.pop()||0;if(F-O<=b){for(let rt=O;rt<=F;rt++){const at=_[2*rt],gt=_[2*rt+1];at>=t&&at<=l&&gt>=r&&gt<=u&&P.push(m[rt])}continue}const $=O+F>>1,q=_[2*$],Y=_[2*$+1];q>=t&&q<=l&&Y>=r&&Y<=u&&P.push(m[$]),(R===0?t<=q:r<=Y)&&(E.push(O),E.push($-1),E.push(1-R)),(R===0?l>=q:u>=Y)&&(E.push($+1),E.push(F),E.push(1-R))}return P}within(t,r,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:m,nodeSize:_}=this,b=[0,u.length-1,0],E=[],P=l*l;for(;b.length;){const R=b.pop()||0,F=b.pop()||0,O=b.pop()||0;if(F-O<=_){for(let rt=O;rt<=F;rt++)ib(m[2*rt],m[2*rt+1],t,r)<=P&&E.push(u[rt]);continue}const $=O+F>>1,q=m[2*$],Y=m[2*$+1];ib(q,Y,t,r)<=P&&E.push(u[$]),(R===0?t-l<=q:r-l<=Y)&&(b.push(O),b.push($-1),b.push(1-R)),(R===0?t+l>=q:r+l>=Y)&&(b.push($+1),b.push(F),b.push(1-R))}return E}}function Yx(n,t,r,l,u,m){if(u-l<=r)return;const _=l+u>>1;eb(n,t,_,l,u,m),Yx(n,t,r,l,_-1,1-m),Yx(n,t,r,_+1,u,1-m)}function eb(n,t,r,l,u,m){for(;u>l;){if(u-l>600){const P=u-l+1,R=r-l+1,F=Math.log(P),O=.5*Math.exp(2*F/3),$=.5*Math.sqrt(F*O*(P-O)/P)*(R-P/2<0?-1:1);eb(n,t,r,Math.max(l,Math.floor(r-R*O/P+$)),Math.min(u,Math.floor(r+(P-R)*O/P+$)),m)}const _=t[2*r+m];let b=l,E=u;for(Ey(n,t,l,r),t[2*u+m]>_&&Ey(n,t,l,u);b<E;){for(Ey(n,t,b,E),b++,E--;t[2*b+m]<_;)b++;for(;t[2*E+m]>_;)E--}t[2*l+m]===_?Ey(n,t,l,E):(E++,Ey(n,t,E,u)),E<=r&&(l=E+1),r<=E&&(u=E-1)}}function Ey(n,t,r,l){Jx(n,r,l),Jx(t,2*r,2*l),Jx(t,2*r+1,2*l+1)}function Jx(n,t,r){const l=n[t];n[t]=n[r],n[r]=l}function ib(n,t,r,l){const u=n-r,m=t-l;return u*u+m*m}i.$=dp,i.A=cl,i.B=co,i.C=2,i.D=Df,i.E=Ml,i.F=ly,i.G=Pv,i.H=Eh,i.I=Zo,i.J=_e,i.K=lu,i.L=th,i.M=Gh,i.N=uo,i.O=Tu,i.P=Ae,i.Q=Zh,i.R=Is,i.S=ce,i.T=dt,i.U=pc,i.V=B0,i.W=fl,i.X=Oh,i.Y=mu,i.Z=Bh,i._=$s,i.a=function(n){return Gn.API_CDN_URL_REGEX.test(n)},i.a$=Kl,i.a0=Qi,i.a1=Hl,i.a2=me,i.a3=class extends B0{},i.a4=sd,i.a5=_f,i.a6=ft,i.a7=function(n){const t=n.value;return t?Qi(t)?Bx(t,!0)?[]:[new B0(n.key,t,`invalid url "${t}"`)]:[new B0(n.key,t,`string expected, "${lu(t)}" found`)]:[]},i.a8=H,i.a9=Xt,i.aA=tt,i.aB=gr,i.aC=ds,i.aD=gl,i.aE=Bs,i.aF=ht,i.aG=Ce,i.aH=function(n,t){const r={};for(let l=0;l<t.length;l++){const u=t[l];u in n&&(r[u]=n[u])}return r},i.aI=U,i.aJ=lt,i.aK=class{constructor(n){this.entries={},this.scheduler=n}request(n,t,r,l){const u=this.entries[n]=this.entries[n]||{callbacks:[]};if(u.result){const[m,_]=u.result;return this.scheduler?this.scheduler.add(()=>{l(m,_)},t):l(m,_),()=>{}}return u.callbacks.push(l),u.cancel||(u.cancel=r((m,_)=>{u.result=[m,_];for(const b of u.callbacks)this.scheduler?this.scheduler.add(()=>{b(m,_)},t):b(m,_);setTimeout(()=>delete this.entries[n],3e3)})),()=>{u.result||(u.callbacks=u.callbacks.filter(m=>m!==l),u.callbacks.length||(u.cancel(),delete this.entries[n]))}}},i.aL=function(n,t,r){const l=JSON.stringify(n.request);return n.data&&(this.deduped.entries[l]={result:[null,n.data]}),this.deduped.request(l,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},u=>{const m=Pl(n.request,(_,b,E)=>{_?u(_):b&&u(null,{vectorTile:r?void 0:new Li(new b0(b)),rawData:b,responseHeaders:new Map(E.entries())})});return()=>{m.cancel(),u()}},t)},i.aM=function(n){return n?{cacheControl:n.get("Cache-Control"),expires:n.get("Expires")}:{cacheControl:void 0,expires:void 0}},i.aN=function(n){Mn++,Mn>Ma&&(n.getActor().send("enforceCacheSizeLimit",ol),Mn=0)},i.aO=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log2(n)))},i.aP=Os,i.aQ=r1,i.aR=c1,i.aS=Z,i.aT=i1,i.aU=function(n,t){const r=document.createElement("video");r.muted=!0,r.onloadstart=function(){t(null,r)};for(let l=0;l<n.length;l++){const u=document.createElement("source");pr(n[l])||(r.crossOrigin="Anonymous"),u.src=n[l],r.appendChild(u)}return{cancel:()=>{}}},i.aV=xt,i.aW=lg,i.aX=xe,i.aY=dy,i.aZ=Ct,i.a_=bt,i.aa=pt,i.ab=class{constructor(n){this.specification=n}possiblyEvaluate(n,t){return wn(n.expression.evaluate(t))}interpolate(n,t,r){return{x:Vi(n.x,t.x,r),y:Vi(n.y,t.y,r),z:Vi(n.z,t.z,r),azimuthal:Vi(n.azimuthal,t.azimuthal,r),polar:Vi(n.polar,t.polar,r)}}},i.ac=D,i.ad=cs,i.ae=pe,i.af=Kn,i.ag=ws,i.ah=Tt,i.ai=St,i.aj=Du,i.ak=Vi,i.al=ri,i.am=Za,i.an=rr,i.ao=Dr,i.ap=class{constructor(n){this.specification=n}possiblyEvaluate(n,t){return function([r,l]){const u=wn([1,r,l]);return{x:u.x,y:u.y,z:u.z}}(n.expression.evaluate(t))}interpolate(n,t,r){return{x:Vi(n.x,t.x,r),y:Vi(n.y,t.y,r),z:Vi(n.z,t.z,r)}}},i.aq=function(n,t,r=0,l=!0){const u=new Ae(r,r),m=n.sub(u),_=t.add(u),b=[m,new Ae(_.x,m.y),_,new Ae(m.x,_.y)];return l&&b.push(m.clone()),b},i.ar=function(n,t){const r=[];for(let l=0;l<n.length;l++){const u=Nt(l-1,-1,n.length-1),m=Nt(l+1,-1,n.length-1),_=n[l],b=n[m],E=n[u].sub(_).unit(),P=b.sub(_).unit(),R=P.angleWithSep(E.x,E.y),F=E.add(P).unit().mult(-1*t/Math.sin(R/2));r.push(_.add(F))}return r},i.as=Uv,i.at=io,i.au=function(n,t,r=0){return so(((t.x-r)*n.scale-n.x)*ri,(t.y*n.scale-n.y)*ri,Gt(t.z,t.y))},i.av=Zn,i.aw=bn,i.ax=br,i.ay=v0,i.az=function(n){let t=1/0,r=1/0,l=-1/0,u=-1/0;for(const m of n)t=Math.min(t,m.x),r=Math.min(r,m.y),l=Math.max(l,m.x),u=Math.max(u,m.y);return{min:new Ae(t,r),max:new Ae(l,u)}},i.b=function(n){return Gn.API_FONTS_REGEX.test(n)},i.b$=Ng,i.b0=qn,i.b1=ye,i.b2=fg,i.b3=L0,i.b4=function(){S.isLoading()||S.isLoaded()||d()!=="deferred"||v()},i.b5=be,i.b6=Te,i.b7=ag,i.b8=zo,i.b9=vm,i.bA=Do,i.bB=Or,i.bC=function(n,t){const{x:r,y:l}=n.point,u=Ry(r,l,n.worldSize/n._pixelsPerMercatorPixel,0,0);return gr(u,u,gd(fd(t)))},i.bD=tr,i.bE=Ds,i.bF=Ul,i.bG=Ks,i.bH=qo,i.bI=ho,i.bJ=t_,i.bK=_h,i.bL=Tx,i.bM=function(n,t,r,l,u){const m=5*t+2;n.float32[m+0]=r,n.float32[m+1]=l,n.float32[m+2]=u},i.bN=n_,i.bO=we,i.bP=he,i.bQ=Mt,i.bR=ci,i.bS=Nt,i.bT=function(n,t,r,l){var u=new yi(4);return u[0]=n,u[1]=t,u[2]=r,u[3]=l,u},i.bU=class{isDataAvailableAtPoint(n){const t=this._source();if(this.isUsingMockSource()||!t||n.y<0||n.y>1)return!1;const r=t.getSource().maxzoom,l=1<<r,u=Math.floor(n.x),m=Math.floor((n.x-u)*l),_=Math.floor(n.y*l),b=this.findDEMTileFor(new Os(r,u,r,m,_));return!(!b||!b.dem)}getAtPointOrZero(n,t=0){return this.getAtPoint(n,t)||0}getAtPoint(n,t,r=!0){if(this.isUsingMockSource())return null;t==null&&(t=null);const l=this._source();if(!l||n.y<0||n.y>1)return t;const u=l.getSource().maxzoom,m=1<<u,_=Math.floor(n.x),b=n.x-_,E=new Os(u,_,u,Math.floor(b*m),Math.floor(n.y*m)),P=this.findDEMTileFor(E);if(!P||!P.dem)return t;const R=P.dem,F=1<<P.tileID.canonical.z,O=(b*F-P.tileID.canonical.x)*R.dim,$=(n.y*F-P.tileID.canonical.y)*R.dim,q=Math.floor(O),Y=Math.floor($);return(r?this.exaggeration():1)*Vi(Vi(R.get(q,Y),R.get(q,Y+1),$-Y),Vi(R.get(q+1,Y),R.get(q+1,Y+1),$-Y),O-q)}static getAtTileOffset(n,t,r,l){const u=1<<n.canonical.z;return l?l.pointElevation(t):r?r.getAtPointOrZero(new pe(n.wrap+(n.canonical.x+t.x/ri)/u,(n.canonical.y+t.y/ri)/u)):0}static getAtTileOffsetFunc(n,t,r,l){return(u,m,_)=>{const b=this.getAtTileOffset(n,u,m,_),E=l.upVector(n.canonical,u.x,u.y);return Jn(E,E,b*l.upVectorScale(n.canonical,t,r).metersToTile),E}}getForTilePoints(n,t,r,l){if(this.isUsingMockSource())return!1;const u=o_.create(this,n,l);return!!u&&(t.forEach(m=>{m[2]=this.exaggeration()*u.getElevationAt(m[0],m[1],r)}),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;const t=this.findDEMTileFor(n);if(!t||!t.dem)return null;const r=t.dem.tree,l=t.tileID,u=1<<n.canonical.z-l.canonical.z;let m=n.canonical.x/u-l.canonical.x,_=n.canonical.y/u-l.canonical.y,b=0;for(let E=0;E<n.canonical.z-l.canonical.z&&!r.leaves[b];E++){m*=2,_*=2;const P=2*Math.floor(_)+Math.floor(m);b=r.childOffsets[b]+P,m%=1,_%=1}return{min:this.exaggeration()*r.minimums[b],max:this.exaggeration()*r.maximums[b]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,t,r){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const n=this.visibleDemTiles;if(n.length===0)return null;let t=!1,r=Number.MAX_VALUE,l=Number.MIN_VALUE;for(const u of n){const m=this.getMinMaxForTile(u.tileID);m&&(r=Math.min(r,m.min),l=Math.max(l,m.max),t=!0)}return t?{min:r,max:l}:null}},i.bV=$g,i.bW=Uo,i.bX=Va,i.bY=um,i.bZ=h1,i.b_=t0,i.ba=Af,i.bb=Be,i.bc=ys,i.bd=Lp,i.be=x_,i.bf=po,i.bg=jp,i.bh=kx,i.bi=function(n,t){const r=Du(t.zoom);if(r===0)return fd(n);const l=Sg(n),u=v_(l),m=ht(l.getWest())*t.worldSize,_=ht(l.getEast())*t.worldSize,b=lt(l.getNorth())*t.worldSize,E=lt(l.getSouth())*t.worldSize,P=[m,b,0],R=[_,b,0],F=[m,E,0],O=[_,E,0],$=Io([],t.globeMatrix);return Kn(P,P,$),Kn(R,R,$),Kn(F,F,$),Kn(O,O,$),u[0]=md(u[0],F,r),u[1]=md(u[1],O,r),u[2]=md(u[2],R,r),u[3]=md(u[3],P,r),Er.fromPoints(u)},i.bj=Qh,i.bk=Io,i.bl=jm,i.bm=md,i.bn=ml,i.bo=ex,i.bp=tl,i.bq=Yr,i.br=q0,i.bs=b0,i.bt=Pl,i.bu=function(n,t){const r=[];for(const l in n)l in t||r.push(l);return r},i.bv=Wt,i.bw=["type","source","source-layer","minzoom","maxzoom","filter","layout"],i.bx=bo,i.by=Ri,i.bz=Ve,i.c=ta,i.c$=function(n){return n*n*n*n*n},i.c0=bx,i.c1=kv,i.c2=Px,i.c3=Xx,i.c4=Jn,i.c5=jl,i.c6=il,i.c7=function(n,t,r){r*=.5;var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E+u*b,n[1]=u*E-l*b,n[2]=m*E+_*b,n[3]=_*E-m*b,n},i.c8=Sl,i.c9=Wn,i.cA=ln,i.cB=Ai,i.cC=vc,i.cD=Ly,i.cE=function(n,t,r,l,u,m,_,b,E){if(E.name==="globe")return Ly(n,t,new vc(r,l,u),!1);const P=dy({z:r,x:l,y:u},E);return new Er([(m+P.x/P.scale)*t,t*(P.y/P.scale),_],[(m+P.x2/P.scale)*t,t*(P.y2/P.scale),b])},i.cF=function(n,t,r){return n[0]=Math.min(t[0],r[0]),n[1]=Math.min(t[1],r[1]),n[2]=Math.min(t[2],r[2]),n[3]=Math.min(t[3],r[3]),n},i.cG=function(n,t,r){return n[0]=Math.max(t[0],r[0]),n[1]=Math.max(t[1],r[1]),n[2]=Math.max(t[2],r[2]),n[3]=Math.max(t[3],r[3]),n},i.cH=function(n){const t=Math.round((n+45+360)%360/90)%4;return Bo[t]},i.cI=zt,i.cJ=ga,i.cK=e,i.cL=function(n){const t=Ve(new Float64Array(16));gr(t,n.pixelMatrix,n.globeMatrix);const r=[0,w,0],l=[0,I,0];return Kn(r,r,t),Kn(l,l,t),[r[0]>0&&r[0]<=n.width&&r[1]>0&&r[1]<=n.height&&!w_(n,new Z(n.center.lat,90)),l[0]>0&&l[0]<=n.width&&l[1]>0&&l[1]<=n.height&&!w_(n,new Z(n.center.lat,-90))]},i.cM=function(n,t){const{scale:r}=n.tileTransform,l=r*ri/(n.tileSize*Math.pow(2,t.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return function(u,m,_){var b=m[1],E=m[2],P=m[3],R=_[0],F=_[1];return u[0]=m[0]*R,u[1]=b*R,u[2]=E*F,u[3]=P*F,u}(new Float32Array(4),t.inverseAdjustmentMatrix,[l,l])},i.cN=mi,i.cO=Vl,i.cP=ei,i.cQ=function(n){const t=ei(n,!0);return tr([],[t[0],t[1],t[4],t[5]])},i.cR=Fn,i.cS=xn,i.cT=us,i.cU=function(n){const{x:t,y:r}=n.point,{lng:l,lat:u}=n._center;return Ry(t,r,n.worldSize,l,u)},i.cV=Ea,i.cW=bi,i.cX=bc,i.cY=ko,i.cZ=p,i.c_=function(n,t,r){let l=0;for(let u=0;u<2;++u)n[u]>0&&(l+=(n[u]-0)*(n[u]-0)),t[u]<0&&(l+=(0-t[u])*(0-t[u]));return l},i.ca=function(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n[3]=t[3],n},i.cb=nc,i.cc=function(n,t,r,l,u){var m=1/Math.tan(t/2);if(n[0]=m/r,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=m,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,u!=null&&u!==1/0){var _=1/(l-u);n[10]=(u+l)*_,n[14]=2*u*l*_}else n[10]=-1,n[14]=-2*l;return n},i.cd=function(n,t,r,l,u,m,_){var b=1/(t-r),E=1/(l-u),P=1/(m-_);return n[0]=-2*b,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*E,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*P,n[11]=0,n[12]=(t+r)*b,n[13]=(u+l)*E,n[14]=(_+m)*P,n[15]=1,n},i.ce=_t,i.cf=function(n,t,r){n[4*t+0]=r[0],n[4*t+1]=r[1],n[4*t+2]=r[2],n[4*t+3]=r[3]},i.cg=bf,i.ch=Xd,i.ci=ts,i.cj=Jh,i.ck=Fp,i.cl=Zv,i.cm=function(){var n=new yi(4);return yi!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n},i.cn=function(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E+m*b,n[1]=u*E+_*b,n[2]=l*-b+m*E,n[3]=u*-b+_*E,n},i.co=function(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]},i.cp=lo,i.cq=function(n){var t=n[0],r=n[1],l=n[2],u=n[3];return Math.sqrt(t*t+r*r+l*l+u*u)},i.cr=$l,i.cs=ns,i.ct=Kh,i.cu=3,i.cv=2,i.cw=7,i.cx=6,i.cy=ma,i.cz=Zr,i.d=function(n){return Gn.API_TILEJSON_REGEX.test(n)},i.d$=S_,i.d0=nt,i.d1=45,i.d2=wf,i.d3=function(n,t,r){const l=Math.sqrt(n*n+t*t+r*r),u=l>0?Math.acos(r/l)*Un:0;let m=n!==0||t!==0?Math.atan2(-t,-n)*Un+90:0;return m<0&&(m+=360),[l,m,u]},i.d4=so,i.d5=wn,i.d6=Ht,i.d7=Fo,i.d8=Er,i.d9=Ln,i.dA=Tf,i.dB=class extends jc{constructor(n){super(n),this.current=m_}set(n,t,r){if(this.fetchUniformLocation(n,t)){for(let l=0;l<9;l++)if(r[l]!==this.current[l]){this.current=r,this.gl.uniformMatrix3fv(this.location,!1,r);break}}}},i.dC=wo,i.dD=function(n,t,r){const l=Du(r.zoom),u=n.style.map._antialias,m=n.terrain&&n.terrain.exaggeration()>0;return l===0&&!u&&!m},i.dE=function(n){const t=n.pixelsPerMeter,r=t/_t(1,n.center.lat),l=Ve(new Float64Array(16));return Yr(l,l,[n.point.x,n.point.y,0]),Fn(l,l,[r,r,t]),Float32Array.from(l)},i.dF=Sg,i.dG=function(n){const t=zt-5;n=tt(n,-t,t)/t*90;const r=Math.pow(Math.abs(Math.sin(rr(n))),3);return Math.round(r*(y.length-1))},i.dH=function(n,t,r,l){const u=t.getNorth(),m=t.getSouth(),_=t.getWest(),b=t.getEast(),E=1<<n.z,P=b-_,R=u-m,F=P/f,O=-R/y[r],$=[0,F,0,O,0,0,u,_,0];if(n.z>0){const q=180/l;Br($,$,[q/P+1,0,0,0,q/R+1,0,-.5*q/F,.5*q/O,1])}return $[2]=E,$[5]=n.x,$[8]=n.y,$},i.dI=fd,i.dJ=function(n,t,r){const l=Ve(new Float64Array(16)),u=(t/(1<<n)-.5)*Math.PI*2;return ao(l,r.globeMatrix,u),Float32Array.from(l)},i.dK=E_,i.dL=im,i.dM=function(n,t){return[Math.pow(n[0],2.2)*t,Math.pow(n[1],2.2)*t,Math.pow(n[2],2.2)*t]},i.dN=vn,i.dO=function(n,t){var r=Math.sin(t),l=Math.cos(t);return n[0]=l,n[1]=r,n[2]=0,n[3]=-r,n[4]=l,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},i.dP=vo,i.dQ=Eg,i.dR=Bn,i.dS=jn,i.dT=256,i.dU=function(n,t){const r=[0,0,0];return Kn(r,r,Qh(fd(t.canonical))),Kn(r,r,n),r},i.dV=n=>({u_matrix:new Fp(n),u_texsize:new Jh(n),u_pixels_to_tile_units:new Om(n),u_device_pixel_ratio:new ts(n),u_width_scale:new ts(n),u_floor_width_scale:new ts(n),u_image:new bf(n),u_units_to_pixels:new Jh(n),u_tile_units_to_pixels:new ts(n),u_alpha_discard_threshold:new ts(n),u_trim_offset:new Jh(n),u_trim_fade_range:new Jh(n),u_trim_color:new wf(n),u_emissive_strength:new ts(n),u_zbias_factor:new ts(n),u_tile_to_meter:new ts(n),u_ground_shadow_factor:new Xd(n),u_pattern_transition:new ts(n)}),i.dW=n=>({u_matrix:new Fp(n),u_pixels_to_tile_units:new Om(n),u_device_pixel_ratio:new ts(n),u_width_scale:new ts(n),u_floor_width_scale:new ts(n),u_units_to_pixels:new Jh(n),u_dash_image:new bf(n),u_gradient_image:new bf(n),u_image_height:new ts(n),u_texsize:new Jh(n),u_tile_units_to_pixels:new ts(n),u_alpha_discard_threshold:new ts(n),u_trim_offset:new Jh(n),u_trim_fade_range:new Jh(n),u_trim_color:new wf(n),u_emissive_strength:new ts(n),u_zbias_factor:new ts(n),u_tile_to_meter:new ts(n),u_ground_shadow_factor:new Xd(n)}),i.dX=n=>({u_camera_to_center_distance:new ts(n),u_extrude_scale:new Om(n),u_device_pixel_ratio:new ts(n),u_matrix:new Fp(n),u_inv_rot_matrix:new Fp(n),u_merc_center:new Jh(n),u_tile_id:new Xd(n),u_zoom_transition:new ts(n),u_up_dir:new Xd(n),u_emissive_strength:new ts(n)}),i.dY=kl,i.dZ=Vb,i.d_=class{constructor(n,t,r,l){this.context=n,this.format=l,this.size=r,this.texture=n.gl.createTexture();const[u,m,_]=this.size,{gl:b}=n;b.bindTexture(b.TEXTURE_3D,this.texture),n.pixelStoreUnpackFlipY.set(!1),n.pixelStoreUnpack.set(1),n.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in t&&t.data&&b.texImage3D(b.TEXTURE_3D,0,this.format,u,m,_,0,ot(this.format),ct(this.format),t.data)}bind(n,t){const{context:r}=this,{gl:l}=r;l.bindTexture(l.TEXTURE_3D,this.texture),n!==this.minFilter&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MAG_FILTER,n),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MIN_FILTER,n),this.minFilter=n),t!==this.wrapS&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_S,t),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_T,t),this.wrapS=t)}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}},i.da=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},i.db=K,i.dc=Ol,i.dd=is,i.de=Bx,i.df=function(n,t){return n.readFields(Bw,{icons:[]},t)},i.dg=qg,i.dh=e_,i.di=Ix,i.dj=ra,i.dk=Hd,i.dl=Th,i.dm=qa,i.dn=Mi,i.dp=function(n){const t=n.indexOf(Nr);return t>=0?n.slice(0,t):n},i.dq=function(n){return n.indexOf(Nr)>=0},i.dr=function(n){const t=n.lastIndexOf(Nr);return t>=0?n.slice(t+1):""},i.ds=function(n){const t=[],r=n.id;return r===void 0&&t.push({message:`layers.${r}: missing required property "id"`}),n.render===void 0&&t.push({message:`layers.${r}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&t.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),t},i.dt=function(n,t,r,l){return n.type==="custom"?new Cw(n,t):new kw[n.type](n,t,r,l)},i.du=$e,i.dv=function(n){const t=n.indexOf(Nr);return t>=0?n.slice(t+1):""},i.dw=class extends ag{constructor(n,t){super(n._vectorTileFeature,n._z,n._x,n._y,n.id),n.state&&(this.state=Object.assign({},n.state)),this.target=t.target,this.namespace=t.namespace,t.properties&&(this.properties=t.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=n.source,this.sourceLayer=n.sourceLayer,this.layer=n.layer)}toJSON(){const n=super.toJSON();return n.target=this.target,n.namespace=this.namespace,n}},i.dx=s,i.dy=Vu,i.dz=function(n){return n({pluginStatus:ca,pluginURL:fc}),s.on("pluginStateChange",n),n},i.e=Gn,i.e$=function([n,t,r]){const l=Math.hypot(n,t,r),u=Math.atan2(n,r),m=.5*Math.PI-Math.acos(-t/l);return new Z(bi(u),bi(m))},i.e0=(n,t,r,l,u,m)=>{const _=n.transform,b=_.projection.name==="globe";let E;if(m.paint.get("circle-pitch-alignment")==="map")if(b){const R=Eg(_.zoom,t.canonical)*_._pixelsPerMercatorPixel;E=Float32Array.from([R,0,0,R])}else E=_.calculatePixelsToTileUnitsMatrix(r);else E=new Float32Array([_.pixelsToGLUnits[0],0,0,_.pixelsToGLUnits[1]]);const P={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(_.projection),u_matrix:n.translatePosMatrix(t.projMatrix,r,m.paint.get("circle-translate"),m.paint.get("circle-translate-anchor")),u_device_pixel_ratio:$a.devicePixelRatio,u_extrude_scale:E,u_inv_rot_matrix:ky,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:m.paint.get("circle-emissive-strength")};if(b){P.u_inv_rot_matrix=l,P.u_merc_center=u,P.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],P.u_zoom_transition=Du(_.zoom);const R=u[0]*ri,F=u[1]*ri;P.u_up_dir=_.projection.upVector(new vc(0,0,0),R,F)}return P},i.e1=nu,i.e2=za,i.e3=(n,t,r,l,u,m,_,b,E,P)=>{const R=n.transform,F=R.pitch<15?bl(.07,.7,tt((14-R.zoom)/5,0,1)):.07,O=r.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:Jp(n,t,r,l),u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:R.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:u,u_width_scale:m,u_floor_width_scale:_,u_image:0,u_tile_units_to_pixels:$c(t,R),u_units_to_pixels:[1/R.pixelsToGLUnits[0],1/R.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:b,u_trim_fade_range:r.paint.get("line-trim-fade-range"),u_trim_color:r.paint.get("line-trim-color").toPremultipliedRenderColor(O?null:r.lut).toArray01(),u_emissive_strength:r.paint.get("line-emissive-strength"),u_zbias_factor:F,u_tile_to_meter:Ht(t.tileID.canonical,0),u_ground_shadow_factor:E,u_pattern_transition:P}},i.e4=(n,t,r,l,u,m,_,b,E,P)=>{const R=n.transform,F=R.calculatePixelsToTileUnitsMatrix(t),O=r.paint.get("line-trim-color-use-theme").constantOr("default")==="none",$=R.pitch<15?bl(.07,.7,tt((14-R.zoom)/5,0,1)):.07;return{u_matrix:Jp(n,t,r,l),u_pixels_to_tile_units:F,u_device_pixel_ratio:m,u_width_scale:_,u_floor_width_scale:b,u_units_to_pixels:[1/R.pixelsToGLUnits[0],1/R.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:u,u_texsize:Kp(r)&&t.lineAtlasTexture?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:$c(t,n.transform),u_alpha_discard_threshold:0,u_trim_offset:E,u_trim_fade_range:r.paint.get("line-trim-fade-range"),u_trim_color:r.paint.get("line-trim-color").toPremultipliedRenderColor(O?null:r.lut).toArray01(),u_emissive_strength:r.paint.get("line-emissive-strength"),u_zbias_factor:$,u_tile_to_meter:Ht(t.tileID.canonical,0),u_ground_shadow_factor:P}},i.e5=Jt,i.e6=nm,i.e7=Gt,i.e8=Yd,i.e9=vd,i.eA=Vx,i.eB=Sn,i.eC=Ar,i.eD=[1,1,1],i.eE=o_,i.eF=Ts,i.eG=function(n,t,r,l){var u=t[0],m=t[1],_=t[2],b=t[3];return n[0]=u+l*(r[0]-u),n[1]=m+l*(r[1]-m),n[2]=_+l*(r[2]-_),n[3]=b+l*(r[3]-b),n},i.eH=ur,i.eI=Rl,i.eJ=Eu,i.eK=function(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y){var rt=new yi(16);return rt[0]=n,rt[1]=t,rt[2]=r,rt[3]=l,rt[4]=u,rt[5]=m,rt[6]=_,rt[7]=b,rt[8]=E,rt[9]=P,rt[10]=R,rt[11]=F,rt[12]=O,rt[13]=$,rt[14]=q,rt[15]=Y,rt},i.eL=N,i.eM=zp,i.eN=Dp,i.eO=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Ae(1/0,1/0),max:new Ae(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n,t=!1){const r=Ky(new Ae(0,0),new Ae(ri,ri),n),l=[];if(t&&!dm(r,this._globalClipBounds))return l;for(const u of this._activeRegions){if(u.hiddenByOverlap||!dm(r,u))continue;const m=N_(u.min,u.max,n);l.push({min:m.min,max:m.max,sourceId:this._sourceIds[u.priority],footprint:u.footprint,footprintTileId:u.tileId,order:u.order,clipMask:u.clipMask,clipScope:u.clipScope})}return l}setSources(n){this._setSources(n.map(t=>({getSourceId:()=>t.cache.id,getFootprints:()=>{const r=[];for(const l of t.cache.getVisibleCoordinates()){const u=t.cache.getTile(l).buckets[t.layer];u&&u.updateFootprints(l.toUnwrapped(),r)}return r},getOrder:()=>t.order,getClipMask:()=>t.clipMask,getClipScope:()=>t.clipScope})))}_addSource(n){const t=n.getFootprints();if(t.length===0)return;const r=n.getOrder(),l=n.getClipMask(),u=n.getClipScope();for(const m of t){if(!m.footprint)continue;const _=Ky(m.footprint.min,m.footprint.max,m.id);this._activeRegions.push({min:_.min,max:_.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:m.id,footprint:m.footprint,order:r,clipMask:l,clipScope:u})}this._sourceIds.push(n.getSourceId())}_computeReplacement(){this._activeRegions.sort((t,r)=>t.priority-r.priority||qp(t.min,r.min)||qp(t.max,r.max)||t.order-r.order||t.clipMask-r.clipMask||function(l,u){const m=(_,b)=>_+b;return l.length-u.length||l.reduce(m,"").localeCompare(u.reduce(m,""))}(t.clipScope,r.clipScope));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let t=0;for(;!n&&t!==this._activeRegions.length;){const r=this._activeRegions[t],l=this._prevRegions[t];n=r.priority!==l.priority||!O_(r,l)||r.order!==l.order||r.clipMask!==l.clipMask||!bo(r.clipScope,l.clipScope),this._activeRegions[t].hiddenByOverlap=l.hiddenByOverlap,++t}}if(n){++this._updateTime;for(const r of this._activeRegions)r.order!==Pf&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,r.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,r.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,r.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,r.max.y));const t=r=>{const l=this._activeRegions;if(r>=l.length)return r;const u=l[r].priority;for(;r<l.length&&l[r].priority===u;)++r;return r};if(this._sourceIds.length>1){let r=0,l=t(r);for(;r!==l;){let u=r;const m=r;for(;u!==l;){const _=this._activeRegions[u];_.hiddenByOverlap=!1;for(let b=0;b<m;b++){const E=this._activeRegions[b];if(!E.hiddenByOverlap&&_.order===Pf&&dm(_,E)&&(_.hiddenByOverlap=Qy(_.footprint,_.tileId,E.footprint,E.tileId),_.hiddenByOverlap))break}++u}r=l,l=t(r)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let t=n.length-1;t>=0;t--)this._addSource(n[t]);this._computeReplacement()}},i.eP=Pf,i.eQ=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const n of this._poleSegments)n.destroy();for(const n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,t){const r=new ys,l=new qn,u=[],m=n+1+2,_=t[0]+1,b=t[0]+1+(1+t.length),E=(P,R,F)=>{let O=P===m-1?P-2:P===0?P:P-1;return O+=F?24575:0,[O,R]};for(let P=0;P<m;++P)r.emplaceBack(...E(P,0,!0));for(let P=0;P<_;++P)for(let R=0;R<m;++R)r.emplaceBack(...E(R,P,(R===0||R===m-1)&&!0));for(let P=0;P<t.length;++P){const R=t[P];for(let F=0;F<m;++F)r.emplaceBack(...E(F,R,!0))}for(let P=0;P<t.length;++P){const R=l.length,F=t[P]+1+2,O=new qn;for(let Y=0;Y<F-1;Y++){const rt=Y===F-2,at=rt?m*(b-t.length+P-Y):m;for(let gt=0;gt<m-1;gt++){const yt=Y*m+gt;Y===0||rt||gt===0||gt===m-2?(O.emplaceBack(yt+1,yt,yt+at),O.emplaceBack(yt+at,yt+at+1,yt+1)):(l.emplaceBack(yt+1,yt,yt+at),l.emplaceBack(yt+at,yt+at+1,yt+1))}}const $=po.simpleSegment(0,R,r.length,l.length-R);for(let Y=0;Y<O.uint16.length;Y+=3)l.emplaceBack(O.uint16[Y],O.uint16[Y+1],O.uint16[Y+2]);const q=po.simpleSegment(0,R,r.length,l.length-R);u.push({withoutSkirts:$,withSkirts:q})}return{vertices:r,indices:l,segments:u}}_createGrid(n){const t=this._fillGridMeshWithLods(f,y);this._gridSegments=t.segments,this._gridBuffer=n.createVertexBuffer(t.vertices,x_.members),this._gridIndexBuffer=n.createIndexBuffer(t.indices,!0)}_createPoles(n){const t=new qn;for(let _=0;_<=f;_++)t.emplaceBack(0,_+1,_+2);this._poleIndexBuffer=n.createIndexBuffer(t,!0);const r=new dh,l=new dh,u=new dh,m=new dh;this._poleSegments=[];for(let _=0,b=0;_<p;_++){const E=360/(1<<_);r.emplaceBack(0,-gl,0,.5,0),l.emplaceBack(0,-gl,0,.5,1),u.emplaceBack(0,-gl,0,.5,.5),m.emplaceBack(0,-gl,0,.5,.5);for(let P=0;P<=f;P++){let R=P/f,F=0;const O=Vi(0,E,R),[$,q,Y]=M(T_,rm,O,gl);r.emplaceBack($,q,Y,R,F),l.emplaceBack($,q,Y,R,1-F);const rt=rr(O);R=.5+.5*Math.sin(rt),F=.5+.5*Math.cos(rt),u.emplaceBack($,q,Y,R,F),m.emplaceBack($,q,Y,R,1-F)}this._poleSegments.push(po.simpleSegment(b,0,66,64)),b+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(r,em,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(l,em,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(u,em,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(m,em,!1)}getGridBuffers(n,t){return[this._gridBuffer,this._gridIndexBuffer,t?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,t){return[t?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,t?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},i.eR=B_,i.eS=se,i.eT=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},i.eU=st,i.eV=kt,i.eW=function(n,t,r){return n[0]=t[0]/r[0],n[1]=t[1]/r[1],n[2]=t[2]/r[2],n},i.eX=el,i.eY=L,i.eZ=ja,i.e_=dn,i.ea=W_,i.eb=tp,i.ec=i0,i.ed=fm,i.ee=Vt,i.ef=function(n,t){if(n===t){var r=t[1],l=t[2],u=t[3],m=t[6],_=t[7],b=t[11];n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=r,n[6]=t[9],n[7]=t[13],n[8]=l,n[9]=m,n[11]=t[14],n[12]=u,n[13]=_,n[14]=b}else n[0]=t[0],n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=t[1],n[5]=t[5],n[6]=t[9],n[7]=t[13],n[8]=t[2],n[9]=t[6],n[10]=t[10],n[11]=t[14],n[12]=t[3],n[13]=t[7],n[14]=t[11],n[15]=t[15];return n},i.eg=Mw,i.eh=vr,i.ei=Jf,i.ej=256,i.ek=gd,i.el=Zs,i.em=ao,i.en=function(n,t){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],n},i.eo=dh,i.ep=xf,i.eq=mf,i.er=function(n,t,r,l,u){return tt((n-t)/(r-t)*(u-l)+l,l,u)},i.es=Il,i.et=function(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=t[4],b=t[5],E=t[6],P=t[7],R=t[8],F=R*_-b*P,O=-R*m+b*E,$=P*m-_*E,q=r*F+l*O+u*$;return q?(n[0]=F*(q=1/q),n[1]=(-R*l+u*P)*q,n[2]=(b*l-u*_)*q,n[3]=O*q,n[4]=(R*r-u*E)*q,n[5]=(-b*r+u*m)*q,n[6]=$*q,n[7]=(-P*r+l*E)*q,n[8]=(_*r-l*m)*q,n):null},i.eu=2,i.ev=Wo,i.ew=Ss,i.ex=Nl,i.ey=function(n,t){var r=new yi(3);Nl(r,t);var l=1/r[0],u=1/r[1],m=1/r[2],_=t[0]*l,b=t[1]*u,E=t[2]*m,P=t[4]*l,R=t[5]*u,F=t[6]*m,O=t[8]*l,$=t[9]*u,q=t[10]*m,Y=_+R+q,rt=0;return Y>0?(rt=2*Math.sqrt(Y+1),n[3]=.25*rt,n[0]=(F-$)/rt,n[1]=(O-E)/rt,n[2]=(b-P)/rt):_>R&&_>q?(rt=2*Math.sqrt(1+_-R-q),n[3]=(F-$)/rt,n[0]=.25*rt,n[1]=(b+P)/rt,n[2]=(O+E)/rt):R>q?(rt=2*Math.sqrt(1+R-_-q),n[3]=(O-E)/rt,n[0]=(b+P)/rt,n[1]=.25*rt,n[2]=(F+$)/rt):(rt=2*Math.sqrt(1+q-_-R),n[3]=(b-P)/rt,n[0]=(O+E)/rt,n[1]=(F+$)/rt,n[2]=.25*rt),n},i.ez=function(n,t){var r=2*Math.acos(t[3]),l=Math.sin(r/2);return l>Pe?(n[0]=t[0]/l,n[1]=t[1]/l,n[2]=t[2]/l):(n[0]=1,n[1]=0,n[2]=0),r},i.f=function(n){return btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,(t,r)=>String.fromCharCode(+("0x"+r))))},i.f0=Gl,i.f1=Hi,i.f2=function(n){const t=n.navigator?n.navigator.userAgent:null;return!!function(r){if(Gr==null){const l=r.navigator?r.navigator.userAgent:null;Gr=!!r.safari||!(!l||!(/\b(iPad|iPhone|iPod)\b/.test(l)||l.match("Safari")&&!l.match("Chrome")))}return Gr}(n)&&!(!t||!(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},i.f3=function(n,t){ol=n,Ma=t},i.f4=w_,i.f5=Ag,i.f6=function(n){const t=[0,0,0],r=Ve(new Float64Array(16));return gr(r,n.pixelMatrix,n.globeMatrix),Kn(t,t,r),new Ae(t[0],t[1])},i.f7=function(){const n=gm;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(Oa),gm=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},i.f8=function(){qg().acquire(Oa)},i.f9=d,i.fA=qe,i.fB=function(n){let t=0;if(new Uint32Array(n,0,1)[0]!==x){const r=new Uint32Array(n,0,7),[,,l,u,m,_]=r;t=r.byteLength+u+m+_+m,(l!==n.byteLength||t>=n.byteLength)&&qi("Invalid b3dm header information.")}return W(n,t)},i.fC=function(n,t){const r=Ol(n);for(const l of r){for(const u of l.meshes)ru(u);l.lights&&(l.lightMeshIndex=l.meshes.length,l.meshes.push(bs(l.lights,t)))}return r},i.fD=O0,i.fE=Pn,i.fF=u0,i.fG=S,i.fH=ks,i.fI=function(n){ea(),ss?.then(t=>{t.keys().then(r=>{for(let l=0;l<r.length-n;l++)t.delete(r[l]).catch(u=>qi(u.message))}).catch(r=>qi(r.message))}).catch(t=>qi(t.message))},i.fa=function(n,t,r=!1){if(ca===ks.deferred||ca===ks.loading||ca===ks.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");fc=$a.resolveURL(n),ca=ks.deferred,hd=t,C(),r||v()},i.fb=function(n){Xp=$a.resolveURL(n),zf||(zf=new Df(qg(),new Ml)),zf.broadcast("setMeshoptUrl",Xp)},i.fc=ig,i.fd=function(n){ty=$a.resolveURL(n),zf||(zf=new Df(qg(),new Ml)),zf.broadcast("setDracoUrl",ty)},i.fe=Hg,i.ff=bd,i.fg=function(n){const t=tn();if(!t)return;const r=t.delete(Ou);n&&r.then(()=>n()).catch(n)},i.fh=rp,i.fi=Si,i.fj=Qd,i.fk=sp,i.fl=J1,i.fm=K1,i.fn=_0,i.fo=xi,i.fp="hd_road_elevation",i.fq=cr,i.fr=ti,i.fs=yd,i.ft=Sx,i.fu=og,i.fv=function(n,t,r,l,u,m,_,b=1,E,P,R){n.createArrays(),n.tilePixelRatio=ri/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;const F=n.layers[0].layout,O=n.layers[0]._unevaluatedLayout._values,$={};$.scaleFactor=b,$.textSizeScaleRange=F.get("text-size-scale-range"),$.iconSizeScaleRange=F.get("icon-size-scale-range");const[q,Y]=$.textSizeScaleRange,[rt,at]=$.iconSizeScaleRange;$.textScaleFactor=tt($.scaleFactor,q,Y),$.iconScaleFactor=tt($.scaleFactor,rt,at);const gt=O["text-size"],yt=O["icon-size"];if(n.textSizeData.kind==="composite"){const{minZoom:ne,maxZoom:Le}=n.textSizeData;$.compositeTextSizes=[gt.possiblyEvaluate(new D(ne,{worldview:R}),m),gt.possiblyEvaluate(new D(Le,{worldview:R}),m)]}if(n.iconSizeData.kind==="composite"){const{minZoom:ne,maxZoom:Le}=n.iconSizeData;$.compositeIconSizes=[yt.possiblyEvaluate(new D(ne,{worldview:R}),m),yt.possiblyEvaluate(new D(Le,{worldview:R}),m)]}$.layoutTextSize=gt.possiblyEvaluate(new D(_+1,{worldview:R}),m),$.layoutIconSize=yt.possiblyEvaluate(new D(_+1,{worldview:R}),m),$.textMaxSize=gt.possiblyEvaluate(new D(18,{worldview:R}),m);const Pt=F.get("symbol-placement"),qt=F.get("text-rotation-alignment")==="map"&&Pt!=="point",Bt=F.get("text-size");let Yt=!1;const ee=[];for(const ne of n.features){const Le=F.get("text-font").evaluate(ne,{},m).join(","),fe=Bt.evaluate(ne,{},m)*$.textScaleFactor,ke=$.layoutTextSize.evaluate(ne,{},m)*$.textScaleFactor,Ue=$.layoutIconSize.evaluate(ne,{},m)*$.iconScaleFactor,Ze={horizontal:{},vertical:void 0},hi=ne.text;let Ke,je=[0,0];if(hi){const Lr=hi.toString(),rn=F.get("text-letter-spacing").evaluate(ne,{},m)*Va,_r=F.get("text-line-height").evaluate(ne,{},m)*Va,pn=cd(Lr)?rn:0,fn=F.get("text-anchor").evaluate(ne,{},m),Co=F.get("text-variable-anchor");if(!Co){const Ne=F.get("text-radial-offset").evaluate(ne,{},m);if(Ne)je=kv(fn,[Ne*Va,Ax]);else{const fi=F.get("text-offset").evaluate(ne,{},m);je=[fi[0]*Va,fi[1]*Va]}}let Ot=qt?"center":F.get("text-justify").evaluate(ne,{},m);const Rt=Pt==="point",Oe=Rt?F.get("text-max-width").evaluate(ne,{},m)*Va:1/0,di=Ne=>{n.allowVerticalPlacement&&Hh(Lr)&&(Ze.vertical=vx(hi,t,r,u,Le,Oe,_r,fn,Ne,pn,je,_h.vertical,!0,ke,fe,E))};if(!qt&&Co){const Ne=Ot==="auto"?Co.map(Gi=>Px(Gi)):[Ot];let fi=!1;for(let Gi=0;Gi<Ne.length;Gi++){const Ni=Ne[Gi];if(!Ze.horizontal[Ni])if(fi)Ze.horizontal[Ni]=Ze.horizontal[0];else{const Tr=vx(hi,t,r,u,Le,Oe,_r,"center",Ni,pn,je,_h.horizontal,!1,ke,fe,E);Tr&&(Ze.horizontal[Ni]=Tr,fi=Tr.positionedLines.length===1)}}di("left")}else{if(Ot==="auto"&&(Ot=Px(fn)),Rt||F.get("text-writing-mode").indexOf("horizontal")>=0||!Hh(Lr)){const Ne=vx(hi,t,r,u,Le,Oe,_r,fn,Ot,pn,je,_h.horizontal,!1,ke,fe,E);Ne&&(Ze.horizontal[Ot]=Ne)}di(Rt?"left":Ot)}}let Ye,Me,Ie,He,ai,Ge,Pi=!1;const ki=F.get("icon-text-fit").evaluate(ne,{},m);if(ne.icon&&ne.icon.hasPrimary()){const Lr=hy(ne.icon,n.iconSizeData,O["icon-size"],m,n.zoom,ne,E,$.iconScaleFactor,R);Ye=Lr.iconPrimary,Ie=Lr.iconSecondary;const rn=Ye.toString();if(Me=l.get(rn),Me&&(ai=F.get("icon-offset").evaluate(ne,{},m),Ge=F.get("icon-anchor").evaluate(ne,{},m),Ke=T0(u.get(rn),Ie?u.get(Ie.toString()):void 0,ai,Ge),Pi=Me.sdf,n.sdfIcons===void 0?n.sdfIcons=Me.sdf:n.sdfIcons!==Me.sdf&&qi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Me.pixelRatio!==n.pixelRatio||F.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0)),Ie){const _r=Ie.toString();He=l.get(_r)}}Yt=Yt||!(!ne.icon||!ne.icon.hasSecondary());const vi=Mx(Ze.horizontal)||Ze.vertical;n.iconsInText||(n.iconsInText=!!vi&&vi.iconsInText);const pi=ke*$.textScaleFactor/Va,{defaultShapedIcon:dr,verticallyShapedIcon:_i}=mw(n,Ke,F,ne,m,Ze,pi,ai,ki);ki!=="none"&&Ke&&(vv(Ke)||bv(Ke))&&(P0(0,Me,Ye,Ke,dr,ki,P,l,u),P0(0,He,Ie,Ke,dr,ki,P,l,u),_i&&(P0(0,Me,Ye,Ke,_i,ki,P,l,u),P0(0,He,Ie,Ke,_i,ki,P,l,u))),Ke=dr;const{iconBBox:Wi,iconVerticalBBox:mr}=dw(n,Ke,_i,F,ne,m,Ue,ai,$,u,Ge);ee.push({feature:ne,shapedTextOrientations:Ze,shapedText:vi,shapedIcon:Ke,iconPrimary:Ye,iconSecondary:Ie,iconOffset:ai,iconAnchor:Ge,verticallyShapedIcon:_i,layoutTextSize:ke,layoutIconSize:Ue,textOffset:je,isSDFIcon:Pi,iconTextFit:ki,iconCollisionBounds:Wi,iconVerticalCollisionBounds:mr})}return{featureData:ee,sizes:$,hasAnySecondaryIcon:Yt,textAlongLine:qt,symbolPlacement:Pt}},i.fw=Mv,i.fx=function(n,t,r,l,u,m,_,b,E,P){n.iconAtlasPositions=P.iconPositions;const{featureData:R,hasAnySecondaryIcon:F,sizes:O,textAlongLine:$,symbolPlacement:q}=t;for(const Y of R){const{shapedIcon:rt,verticallyShapedIcon:at,feature:gt,shapedTextOrientations:yt,shapedText:Pt,layoutTextSize:qt,textOffset:Bt,isSDFIcon:Yt,iconPrimary:ee,iconSecondary:ne,iconTextFit:Le,iconOffset:fe,iconCollisionBounds:ke,iconVerticalCollisionBounds:Ue}=Y;Bv(rt,P.iconPositions,ee,ne),Bv(at,P.iconPositions,ee,ne),fw(yt,P.iconPositions),pw(ee,ne,P.iconPositions),(Pt||rt)&&gw(n,gt,yt,rt,at,E,O,qt,0,Bt,Yt,l,u,_,b,F,Le,fe,$,q,ke,Ue)}r&&n.generateCollisionDebugBuffers(m,n.collisionBoxArray,O.textScaleFactor)},i.fy=Li,i.fz=$0,i.g=function(n,t){return Vu(Object.assign(n,{method:"GET"}),t)},i.h=function(n){return n.indexOf("mapbox:")===0},i.i=function(n){return Gn.API_STYLE_REGEX.test(n)&&!ta(n)},i.j=os,i.k=sc,i.l=function(n){return decodeURIComponent(atob(n).split("").map(t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)).join(""))},i.m=function(n,t){return Vu(Object.assign(n,{type:"json"}),t)},i.n=Ca,i.o=$a,i.p=function(n,t){return Vu(Object.assign(n,{method:"POST"}),t)},i.q=Ta,i.r=Pa,i.s=function(n){try{const t=self[n];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}},i.t=function(){return Qm||(Qm=new rp),Qm},i.u=function(){return function n(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)}()},i.v=function(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)},i.w=qi,i.x=qx,i.y=ac,i.z=ya}),Ft(["./shared"],function(i){function Pe(se){const st=se?se.url.toString():void 0;return st?performance.getEntriesByName(st):[]}function yi(se){if(typeof se=="number"||typeof se=="boolean"||typeof se=="string"||se==null)return JSON.stringify(se);if(Array.isArray(se)){let tt="[";for(const Tt of se)tt+=`${yi(Tt)},`;return`${tt}]`}let st="{";for(const tt of Object.keys(se).sort())st+=`${tt}:${yi(se[tt])},`;return`${st}}`}function tr(se){let st="";for(const tt of i.bw)st+=`/${yi(se[tt])}`;return st}class vn{constructor(st){this.keyCache={},this._layers={},this._layerConfigs={},st&&this.replace(st)}replace(st,tt){this._layerConfigs={},this._layers={},this.update(st,[],tt)}update(st,tt,Tt){this._options=Tt;for(const Wt of st)this._layerConfigs[Wt.id]=Wt,(this._layers[Wt.id]=i.dt(Wt,this.scope,null,this._options)).compileFilter(Tt),this.keyCache[Wt.id]&&delete this.keyCache[Wt.id];for(const Wt of tt)delete this.keyCache[Wt],delete this._layerConfigs[Wt],delete this._layers[Wt];this.familiesBySource={};const Nt=function(Wt,oe){const ye={};for(let xe=0;xe<Wt.length;xe++){const ti=Wt[xe];let $e=oe&&oe[ti.id];$e||(ti.type==="symbol"?$e=ti.id:($e=tr(ti),ti.type==="line"&&ti.paint&&function Ji(Xi){return typeof Xi=="string"&&Xi==="line-progress"||(Array.isArray(Xi)?Xi.some(Ji):!(!Xi||typeof Xi!="object")&&Object.values(Xi).some(Ji))}(ti.paint["line-width"])&&($e+=`/${yi(ti.paint["line-width"])}`))),oe&&(oe[ti.id]=$e);let Mi=ye[$e];Mi||(Mi=ye[$e]=[]),Mi.push(ti)}const Jt=[];for(const xe in ye)Jt.push(ye[xe]);return Jt}(Object.values(this._layerConfigs),this.keyCache);for(const Wt of Nt){const oe=Wt.map(Mi=>this._layers[Mi.id]),ye=oe[0];if(ye.visibility==="none")continue;const Jt=ye.source||"";let xe=this.familiesBySource[Jt];xe||(xe=this.familiesBySource[Jt]={});const ti=ye.sourceLayer||"_geojsonTileLayer";let $e=xe[ti];$e||($e=xe[ti]=[]),$e.push(oe)}}}const on=1*i.fk;class Br{constructor(st){const tt={},Tt=[];for(const ye in st){const Jt=st[ye],xe=tt[ye]={};for(const ti in Jt.glyphs){const $e=Jt.glyphs[+ti];if(!$e||$e.bitmap.width===0||$e.bitmap.height===0)continue;const Mi=$e.metrics.localGlyph?on:1,Ji={x:0,y:0,w:$e.bitmap.width+2*Mi,h:$e.bitmap.height+2*Mi};Tt.push(Ji),xe[ti]=Ji}}const{w:Nt,h:Wt}=i.G(Tt),oe=new i.fj({width:Nt||1,height:Wt||1});for(const ye in st){const Jt=st[ye];for(const xe in Jt.glyphs){const ti=Jt.glyphs[+xe];if(!ti||ti.bitmap.width===0||ti.bitmap.height===0)continue;const $e=tt[ye][xe],Mi=ti.metrics.localGlyph?on:1;i.fj.copy(ti.bitmap,oe,{x:0,y:0},{x:$e.x+Mi,y:$e.y+Mi},ti.bitmap)}}this.image=oe,this.positions=tt}}function Or(se,st,tt){se[st]?tt&&(se[st].center=tt):se[st]={floorIds:new Set,center:tt||[0,0],floors:{}}}function Ri(se,st,tt,Tt){for(const Nt of st)Or(se,Nt),se[Nt].floors[tt]=Tt,se[Nt].floorIds.add(tt)}function Ve(se){return{id:se.properties.id.toString(),center:se.properties.center.toString().split(";").map(Number)}}function Io(se){return{id:se.properties.id.toString(),isDefault:!!se.properties.is_default&&se.properties.is_default,connections:se.properties.connected_floor_ids?new Set(se.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:se.properties.conflicted_floor_ids?new Set(se.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:se.properties.building_ids?new Set(se.properties.building_ids.toString().split(";")):new Set,name:se.properties.name.toString(),zIndex:se.properties.z_index}}function gr(se,st){return st.every(tt=>se.properties&&se.properties[tt]!=null)}function Yr(se){return gr(se,["type","id","name"])&&se.properties.type==="building"}function Fn(se){return gr(se,["type","id","name","z_index"])&&se.properties.type==="floor"}i.fi(Br,"GlyphAtlas");class us{constructor(st){this.tileID=new i.aP(st.tileID.overscaledZ,st.tileID.wrap,st.tileID.canonical.z,st.tileID.canonical.x,st.tileID.canonical.y),this.tileZoom=st.tileZoom,this.uid=st.uid,this.zoom=st.zoom,this.lut=st.lut,this.canonical=st.tileID.canonical,this.pixelRatio=st.pixelRatio,this.tileSize=st.tileSize,this.source=st.source,this.scope=st.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=st.showCollisionBoxes,this.collectResourceTiming=!!st.request&&st.request.collectResourceTiming,this.promoteId=st.promoteId,this.isSymbolTile=st.isSymbolTile,this.tileTransform=i.aY(st.tileID.canonical,st.projection),this.projection=st.projection,this.worldview=st.worldview,this.localizableLayerIds=st.localizableLayerIds,this.brightness=st.brightness,this.extraShadowCaster=!!st.extraShadowCaster,this.tessellationStep=st.tessellationStep,this.scaleFactor=st.scaleFactor,this.worldview=st.worldview,this.indoor=st.indoor}parse(st,tt,Tt,Nt,Wt,oe){this.status="parsing",this.data=st,this.collisionBoxArray=new i.b2;const ye=new i.fl(Object.keys(st.layers).sort()),Jt=new i.fm(this.tileID,this.promoteId);Jt.bucketLayerIDs=[];const xe={},ti=new i.fn(256,256),$e={featureIndex:Jt,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:ti,availableImages:Tt,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const qi=this.indoor.indoorState.activeFloorsVisible,hr=function(Yi,wn,Pn){const zo=function(an,Rr){if(!an)return i.w("No source layers defined in indoor specification"),Rr;if(an.size===0)return Rr;const Bn=an.difference(Rr);for(const jn of Bn)i.w(`Missing source layer required in indoor specification: ${jn}`);return Rr.intersection(Rr)}(wn.sourceLayers,new Set(Object.keys(Yi.layers))),Gr=wn.indoorState,Wn=function(an,Rr,Bn,jn){const Tn=new Set,Gn=new Set,os=new Set,ta=new Map,El={},wh=es=>{const nl=ta.get(es)||new Set;for(const _a of Tn)if((ta.get(_a)||new Set).has(es)||nl.has(_a))return!0;return!1};for(const es of Rr){const nl=an.layers[es];if(nl)for(let _a=0;_a<nl.length;_a++){const Al=nl.feature(_a);if(Yr(Al)){const{id:Pa,center:$a}=Ve(Al);Or(El,Pa,$a),Tn.add(Pa)}else if(Fn(Al)){const{id:Pa,isDefault:$a,connections:ql,conflicts:Th,buildings:Ou,name:ol,zIndex:Ma}=Io(Al);Ri(El,Ou,Pa,{name:ol,zIndex:Ma}),ta.set(Pa,Th),(Pa===jn||ql.has(jn))&&Tn.add(Pa),Gn.add(Pa),$a&&os.add(Pa)}}else i.w(`indoor source layer not found: ${es}`)}if(Bn)for(const es of Bn)Gn.has(es)&&(wh(es)||Tn.add(es));for(const es of os)Tn.has(es)||wh(es)||Tn.add(es);return{buildings:El,activeFloors:Tn}}(Yi,zo,Gr.lastActiveFloors,Gr.selectedFloorId);return Pn.send("setIndoorData",Wn),Wn}(st,this.indoor,Wt);$e.activeFloors=qi?hr.activeFloors:void 0}const Mi=[],Ji=tt.familiesBySource[this.source];for(const qi in Ji){const hr=st.layers[qi];if(!hr)continue;let Yi=!1,wn=!1,Pn=!1;for(const an of Ji[qi])an[0].type==="symbol"?Yi=!0:wn=!0,an[0].is3D()&&an[0].type!=="model"&&(Pn=!0);if(this.extraShadowCaster&&!Pn||this.isSymbolTile===!0&&!Yi||this.isSymbolTile===!1&&!wn)continue;hr.version===1&&i.w(`Vector tile source "${this.source}" layer "${qi}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const zo=ye.encode(qi),Gr=[];let Wn=!1;for(let an=0,Rr=0;an<hr.length;an++){const Bn=hr.feature(an),jn=Jt.getId(Bn,qi);if(this.localizableLayerIds&&this.localizableLayerIds.has(qi)){const Tn=Bn.properties?Bn.properties.worldview:null;if(this.worldview&&typeof Tn=="string")if(Tn==="all")Bn.properties.$localized=!0;else{if(!Tn.split(",").includes(this.worldview))continue;Bn.properties.$localized=!0,Bn.properties.worldview=this.worldview}}!Wn&&Bn.properties&&Bn.properties.hasOwnProperty(i.fo)&&(Wn=!0),Gr.push({feature:Bn,id:jn,index:Rr,sourceLayerIndex:zo}),Rr++}Wn&&!$e.elevationFeatures&&st.layers.hasOwnProperty(i.fp)&&($e.elevationFeatures=i.fq.parseFrom(st.layers[i.fp],this.canonical));for(const an of Ji[qi]){const Rr=an[0];if(this.extraShadowCaster&&(!Rr.is3D()||Rr.type==="model")||this.isSymbolTile!==void 0&&Rr.type==="symbol"!==this.isSymbolTile||Rr.minzoom&&this.zoom<Math.floor(Rr.minzoom)||Rr.maxzoom&&this.zoom>=Rr.maxzoom||Rr.visibility==="none")continue;ao(an,this.zoom,$e.brightness,Tt,this.worldview);const Bn=xe[Rr.id]=Rr.createBucket({index:Jt.bucketLayerIDs.length,layers:an,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:zo,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:Nt,worldview:this.worldview});Jt.bucketLayerIDs.push(an.map(Tn=>i.B(Tn.id,Tn.scope)));let jn=Bn.prepare?Bn.prepare():null;jn!=null?(jn=jn.then(()=>Bn.populate(Gr,$e,this.tileID.canonical,this.tileTransform)),Mi.push(jn)):Bn.populate(Gr,$e,this.tileID.canonical,this.tileTransform)}}const Xi=()=>{let qi,hr,Yi,wn,Pn,zo;ti.trim();const Gr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Wn=()=>{if(qi)return this.status="done",oe(qi);if(this.extraShadowCaster)this.status="done",oe(null,{buckets:Object.values(xe).filter(Rr=>!Rr.isEmpty()),featureIndex:Jt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:$e.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(hr&&Yi&&wn){const Rr=new Br(hr),Bn=new Map;for(const[Gn,os]of Yi.entries()){const{imagePosition:ta}=i.ft(Gn,os,i.fu);Bn.set(Gn,ta)}const jn={};for(const Gn in xe){const os=xe[Gn];os instanceof i.b3&&(ao(os.layers,this.zoom,$e.brightness,Tt,this.worldview),jn[Gn]=i.fv(os,hr,Rr.positions,Yi,Bn,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Pn,this.worldview))}const Tn={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(Wt,Yi,Pn,()=>{Tn.iconsPending=!1,an(jn,Rr,Tn)}),this.rasterizeIfNeeded(Wt,wn,zo,()=>{Tn.patternsPending=!1,an(jn,Rr,Tn)})}},an=(Rr,Bn,jn,Tn)=>{if(jn.iconsPending||jn.patternsPending)return;const Gn=new i.fw(Yi,wn,this.lut);for(const os in xe){const ta=xe[os];if(os in Rr)i.fx(ta,Rr[os],this.showCollisionBoxes,Tt,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Yi,Gn);else if(ta.hasPattern&&(ta instanceof i.b9||ta instanceof i.ba||ta instanceof i.e9)){ao(ta.layers,this.zoom,$e.brightness,Tt,this.worldview);const El=Object.fromEntries(Gn.patternPositions);ta.addFeatures($e,this.tileID.canonical,El,Tt,this.tileTransform,this.brightness)}}this.status="done",oe(null,{buckets:Object.values(xe).filter(os=>!os.isEmpty()),featureIndex:Jt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Bn.image,lineAtlas:ti,imageAtlas:Gn,brightness:$e.brightness})};if(!this.extraShadowCaster){const Rr=i.fr($e.glyphDependencies,Tn=>Object.keys(Tn).map(Number));Object.keys(Rr).length?Wt.send("getGlyphs",{uid:this.uid,stacks:Rr},(Tn,Gn)=>{qi||(qi=Tn,hr=Gn,Wn())},void 0,!1,Gr):hr={};const Bn=Array.from($e.iconDependencies.keys()).map(Tn=>i.I.parse(Tn));Bn.length?Wt.send("getImages",{images:Bn,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Tn,Gn)=>{qi||(qi=Tn,Yi=new Map,Pn=this.updateImageMapAndGetImageTaskQueue(Yi,Gn,$e.iconDependencies),Wn())},void 0,!1,Gr):(Yi=new Map,Pn=new Map);const jn=Array.from($e.patternDependencies.keys()).map(Tn=>i.I.parse(Tn));jn.length?Wt.send("getImages",{images:jn,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Tn,Gn)=>{qi||(qi=Tn,wn=new Map,zo=this.updateImageMapAndGetImageTaskQueue(wn,Gn,$e.patternDependencies),Wn())},void 0,!1,Gr):(wn=new Map,zo=new Map)}if($e.elevationFeatures&&$e.elevationFeatures.length>0){const Rr=[];for(const jn of Object.values(xe))if(jn instanceof i.ba){const Tn=jn.getUnevaluatedPortalGraph();Tn&&Rr.push(Tn)}const Bn=i.fs.evaluate(Rr);for(const jn of Object.values(xe))if(jn instanceof i.ba){const Tn=st.layers[ye.decode(jn.sourceLayerIndex)];jn.setEvaluatedPortalGraph(Bn,Tn,this.tileID.canonical,$e.availableImages,$e.brightness)}}Wn()};Mi.length>0?Promise.allSettled(Mi).then(Xi).catch(oe):Xi()}updateParameters(st){this.scaleFactor=st.scaleFactor,this.showCollisionBoxes=st.showCollisionBoxes,this.projection=st.projection,this.brightness=st.brightness,this.tileTransform=i.aY(st.tileID.canonical,st.projection),this.extraShadowCaster=st.extraShadowCaster,this.lut=st.lut,this.worldview=st.worldview,this.indoor=st.indoor}rasterizeIfNeeded(st,tt,Tt,Nt){Array.from(tt.values()).some(Wt=>Wt.usvg)?this.rasterize(st,tt,Tt,Nt):Nt()}updateImageMapAndGetImageTaskQueue(st,tt,Tt){const Nt=new Map;for(const Wt of tt.keys()){const oe=Tt.get(Wt)||[];for(const ye of oe){const Jt=ye.toString(),xe=tt.get(ye.id.toString());xe.usvg?Nt.has(Jt)||(Nt.set(Jt,ye),st.set(Jt,Object.assign({},xe))):st.set(Jt,xe)}}return Nt}rasterize(st,tt,Tt,Nt){this.rasterizeTask=st.send("rasterizeImages",{scope:this.scope,tasks:Tt},(Wt,oe)=>{if(!Wt)for(const[ye,Jt]of oe.entries()){const xe=Object.assign(tt.get(ye),{data:Jt});tt.set(ye,xe)}Nt()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function ao(se,st,tt,Tt,Nt){const Wt=new i.ac(st,{brightness:tt,worldview:Nt});for(const oe of se)oe.recalculate(Wt,Tt)}class Do extends i.E{constructor(st,tt,Tt,Nt,Wt,oe,ye){super(),this.actor=st,this.layerIndex=tt,this.availableImages=Tt,this.availableModels=Nt,this.loadVectorData=oe||i.aL,this.loading={},this.loaded={},this.deduped=new i.aK(st.scheduler),this.isSpriteLoaded=Wt,this.scheduler=st.scheduler,this.brightness=ye}loadTile(st,tt){const Tt=st.uid,Nt=st&&st.request,Wt=Nt&&Nt.collectResourceTiming,oe=this.loading[Tt]=new us(st);oe.abort=this.loadVectorData(st,(ye,Jt)=>{const xe=!this.loading[Tt];if(delete this.loading[Tt],oe.cancelRasterize(),xe||ye||!Jt)return oe.status="done",xe||(this.loaded[Tt]=oe),tt(ye);const ti=Jt.rawData,$e={},Mi=i.aM(Jt.responseHeaders);Mi&&Mi.expires&&($e.expires=Mi.expires),Mi&&Mi.cacheControl&&($e.cacheControl=Mi.cacheControl),oe.vectorTile=Jt.vectorTile||new i.fy(new i.bs(ti));const Ji=()=>{oe.parse(oe.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Xi,qi)=>{if(Xi||!qi)return tt(Xi);const hr={};if(Wt){const Yi=Pe(Nt);Yi.length>0&&(hr.resourceTiming=JSON.parse(JSON.stringify(Yi)))}tt(null,Object.assign({rawTileData:ti.slice(0),responseHeaders:Jt.responseHeaders},qi,$e,hr))})};this.isSpriteLoaded?Ji():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Ji,{type:"parseTile",isSymbolTile:st.isSymbolTile,zoom:st.tileZoom}):Ji()}),this.loaded=this.loaded||{},this.loaded[Tt]=oe})}reloadTile(st,tt){const Tt=this.loaded,Nt=st.uid;if(Tt&&Tt[Nt]){const Wt=Tt[Nt];Wt.updateParameters(st);const oe=(ye,Jt)=>{const xe=Wt.reloadCallback;xe&&(delete Wt.reloadCallback,Wt.parse(Wt.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,xe)),tt(ye,Jt)};Wt.status==="parsing"?Wt.reloadCallback=oe:Wt.status==="done"&&(Wt.vectorTile?Wt.parse(Wt.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,oe):oe())}else tt(null,void 0)}abortTile(st,tt){const Tt=st.uid,Nt=this.loading[Tt];Nt&&(Nt.abort&&Nt.abort(),delete this.loading[Tt]),tt()}removeTile(st,tt){const Tt=this.loaded,Nt=st.uid;Tt&&Tt[Nt]&&delete Tt[Nt],tt()}}class tl{loadTile(st,tt){const{uid:Tt,encoding:Nt,rawImageData:Wt,padding:oe}=st,ye=ImageBitmap&&Wt instanceof ImageBitmap?this.getImageData(Wt,oe):Wt;tt(null,new i.fz(Tt,ye,Nt,oe<1))}reloadTile(st,tt){tt(null,null)}abortTile(st,tt){tt()}removeTile(st,tt){tt()}getImageData(st,tt){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(st.width,st.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=st.width,this.offscreenCanvas.height=st.height,this.offscreenCanvasContext.drawImage(st,0,0,st.width,st.height);const Tt=this.offscreenCanvasContext.getImageData(-tt,-tt,st.width+2*tt,st.height+2*tt);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Tt}}i.br.setPbf(i.bs);class fa{constructor(st){this._mrt=new i.br(st.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=st.uid,this.tileID=st.tileID,this.source=st.source}parse(st,tt){const Tt=this._mrt;this.status="parsing",this._entireBuffer=st;try{Tt.parseHeader(st),this._isHeaderLoaded=!0;const Nt=[];for(const Wt in Tt.layers){const oe=Tt.getLayer(Wt),ye=oe.getDataRange(oe.getBandList()),Jt=Tt.createDecodingTask(ye),xe=st.slice(ye.firstByte,ye.lastByte+1),ti=i.br.performDecoding(xe,Jt).then($e=>Jt.complete(null,$e)).catch($e=>Jt.complete($e,null));Nt.push(ti)}Promise.allSettled(Nt).then(()=>tt(null,Tt)).catch(Wt=>tt(Wt))}catch(Nt){tt(Nt)}}}class Nl{constructor(st){this.actor=st,this.loading={},this.loaded={}}loadTile(st,tt){const Tt=st.uid,Nt=st.request,Wt=this.loading[Tt]=new fa(st),{cancel:oe}=i.bt(Nt,(ye,Jt,xe)=>{const ti=!this.loading[Tt];if(delete this.loading[Tt],ti||ye||!Jt)return Wt.status="done",ti||(this.loaded[Tt]=Wt),tt(ye);Wt.parse(Jt,($e,Mi)=>{if($e||!Mi)return tt($e);tt(null,Mi,xe)}),this.loaded[Tt]=Wt});Wt.abort=oe}reloadTile(st,tt){tt(null,void 0)}abortTile(st,tt){const Tt=st.uid,Nt=this.loading[Tt];Nt&&(Nt.abort&&Nt.abort(),delete this.loading[Tt]),tt()}removeTile(st,tt){const Tt=st.uid;this.loaded[Tt]&&delete this.loaded[Tt],tt()}decodeRasterArray(st,tt){i.br.performDecoding(st.buffer,st.task).then(Tt=>tt(null,Tt)).catch(Tt=>tt(Tt))}}const nc=i.fA.prototype.toGeoJSON;class Vl{constructor(st){this._feature=st,this.extent=i.al,this.type=st.type,this.properties=st.tags,"id"in st&&!isNaN(st.id)&&(this.id=parseInt(st.id,10))}loadGeometry(){if(this._feature.type===1){const st=[];for(const tt of this._feature.geometry)st.push([new i.P(tt[0],tt[1])]);return st}{const st=[];for(const tt of this._feature.geometry){const Tt=[];for(const Nt of tt)Tt.push(new i.P(Nt[0],Nt[1]));st.push(Tt)}return st}}toGeoJSON(st,tt,Tt){return nc.call(this,st,tt,Tt)}}class Zr{constructor(st,tt){this.name=st,this.extent=i.al,this.length=tt.length,this._jsonFeatures=tt}feature(st){return new Vl(this._jsonFeatures[st])}}class bh{constructor(st){this.layers={},this.extent=i.al;for(const tt of Object.keys(st))this.layers[tt]=new Zr(tt,st[tt])}}const ws=64/4096,so=128;class dn{constructor(){this.features=new Map}clear(){this.features.clear()}load(st=[],tt){for(const Tt of st){const Nt=Tt.id;if(Nt==null)continue;let Wt=this.features.get(Nt);Wt&&this.updateCache(Wt,tt),Tt.geometry?(Wt=Ln(Tt),this.updateCache(Wt,tt),this.features.set(Nt,Wt)):this.features.delete(Nt),this.updateCache(Wt,tt)}}updateCache(st,tt){for(const{canonical:Tt,uid:Nt}of Object.values(tt)){const{z:Wt,x:oe,y:ye}=Tt;Fo(st,Math.pow(2,Wt),oe,ye)&&delete tt[Nt]}}getTile(st,tt,Tt){const Nt=Math.pow(2,st),Wt=[];for(const oe of this.features.values())Fo(oe,Nt,tt,Tt)&&Wt.push(Jn(oe,Nt,tt,Tt));return{features:Wt}}getFeatures(){return[...this.features.values()]}}function Fo({minX:se,minY:st,maxX:tt,maxY:Tt},Nt,Wt,oe){return se<(Wt+1+ws)/Nt&&st<(oe+1+ws)/Nt&&tt>(Wt-ws)/Nt&&Tt>(oe-ws)/Nt}function Ln(se){const{id:st,geometry:tt,properties:Tt}=se;if(!tt)return;if(tt.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Nt,coordinates:Wt}=tt,oe={id:st,type:1,geometry:[],tags:Tt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},ye=oe.geometry;if(Nt==="Point")Ea(Wt,ye,oe);else if(Nt==="MultiPoint")for(const Jt of Wt)Ea(Jt,ye,oe);else if(Nt==="LineString")oe.type=2,js(Wt,ye,oe);else if(Nt==="MultiLineString")oe.type=2,Js(Wt,ye,oe);else if(Nt==="Polygon")oe.type=3,Js(Wt,ye,oe,!0);else{if(Nt!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");oe.type=3;for(const Jt of Wt)Js(Jt,ye,oe,!0)}return oe}function Ea([se,st],tt,Tt){const Nt=i.aF(se);let Wt=i.aJ(st);Wt=Wt<0?0:Wt>1?1:Wt,tt.push(Nt,Wt),Tt.minX=Math.min(Tt.minX,Nt),Tt.minY=Math.min(Tt.minY,Wt),Tt.maxX=Math.max(Tt.maxX,Nt),Tt.maxY=Math.max(Tt.maxY,Wt)}function js(se,st,tt,Tt=!1,Nt=!1){const Wt=[];for(const oe of se)Ea(oe,Wt,tt);st.push(Wt),Tt&&function(oe,ye){let Jt=0;for(let xe=0,ti=oe.length,$e=ti-2;xe<ti;$e=xe,xe+=2)Jt+=(oe[xe]-oe[$e])*(oe[xe+1]+oe[$e+1]);if(Jt>0===ye)for(let xe=0,ti=oe.length;xe<ti/2;xe+=2){const $e=oe[xe],Mi=oe[xe+1];oe[xe]=oe[ti-2-xe],oe[xe+1]=oe[ti-1-xe],oe[ti-2-xe]=$e,oe[ti-1-xe]=Mi}}(Wt,Nt)}function Js(se,st,tt,Tt=!1){for(let Nt=0;Nt<se.length;Nt++)js(se[Nt],st,tt,Tt,Nt===0)}function Jn(se,st,tt,Tt){const{id:Nt,type:Wt,geometry:oe,tags:ye}=se,Jt=[];if(Wt===1)(function(xe,ti,$e,Mi,Ji){for(let Xi=0;Xi<xe.length;Xi+=2){const qi=Math.round(i.al*(xe[Xi+0]*ti-$e)),hr=Math.round(i.al*(xe[Xi+1]*ti-Mi));Ji.push([qi,hr])}})(oe,st,tt,Tt,Jt);else for(const xe of oe)Ks(xe,st,tt,Tt,Jt);return{id:Nt,type:Wt,geometry:Jt,tags:ye}}function Ks(se,st,tt,Tt,Nt){const Wt=-so,oe=i.al+so;let ye;for(let Jt=0;Jt<se.length-2;Jt+=2){let xe=Math.round(i.al*(se[Jt+0]*st-tt)),ti=Math.round(i.al*(se[Jt+1]*st-Tt)),$e=Math.round(i.al*(se[Jt+2]*st-tt)),Mi=Math.round(i.al*(se[Jt+3]*st-Tt));const Ji=$e-xe,Xi=Mi-ti;xe<Wt&&$e<Wt||(xe<Wt?(ti+=Math.round(Xi*((Wt-xe)/Ji)),xe=Wt):$e<Wt&&(Mi=ti+Math.round(Xi*((Wt-xe)/Ji)),$e=Wt),ti<Wt&&Mi<Wt||(ti<Wt?(xe+=Math.round(Ji*((Wt-ti)/Xi)),ti=Wt):Mi<Wt&&($e=xe+Math.round(Ji*((Wt-ti)/Xi)),Mi=Wt),xe>=oe&&$e>=oe||(xe>=oe?(ti+=Math.round(Xi*((oe-xe)/Ji)),xe=oe):$e>=oe&&(Mi=ti+Math.round(Xi*((oe-xe)/Ji)),$e=oe),ti>=oe&&Mi>=oe||(ti>=oe?(xe+=Math.round(Ji*((oe-ti)/Xi)),ti=oe):Mi>=oe&&($e=xe+Math.round(Ji*((oe-ti)/Xi)),Mi=oe),ye&&xe===ye[ye.length-1][0]&&ti===ye[ye.length-1][1]||(ye=[[xe,ti]],Nt.push(ye)),ye.push([$e,Mi])))))}}function Ul({name:se,features:st},tt){tt.writeStringField(1,se),tt.writeVarintField(5,i.al);const Tt=new Map,Nt=new Map,Wt={keys:Tt,values:Nt,feature:null};for(const oe of st)Wt.feature=oe,tt.writeMessage(2,Qs,Wt);for(const oe of Tt.keys())tt.writeStringField(3,oe);for(const oe of Nt.keys())tt.writeMessage(4,qo,oe)}function Qs(se,st){const tt=se.feature;tt.id!==void 0&&Number.isSafeInteger(+tt.id)&&st.writeVarintField(1,+tt.id),tt.tags&&st.writeMessage(2,ja,se),st.writeVarintField(3,tt.type),st.writeMessage(4,ho,tt)}function ja({keys:se,values:st,feature:tt},Tt){for(const Nt of Object.keys(tt.tags)){let Wt=tt.tags[Nt];if(Wt===null)continue;let oe=se.get(Nt);oe===void 0&&(oe=se.size,se.set(Nt,oe)),Tt.writeVarint(oe);const ye=typeof Wt;ye!=="string"&&ye!=="boolean"&&ye!=="number"&&(Wt=JSON.stringify(Wt));let Jt=st.get(Wt);Jt===void 0&&(Jt=st.size,st.set(Wt,Jt)),Tt.writeVarint(Jt)}}function Wo(se,st){return(st<<3)+(7&se)}function bn(se){return se<<1^se>>31}function ho(se,st){const{geometry:tt,type:Tt}=se;let Nt=0,Wt=0;if(Tt===1){st.writeVarint(Wo(1,tt.length));for(const oe of tt){const ye=oe[0]-Nt,Jt=oe[1]-Wt;st.writeVarint(bn(ye)),st.writeVarint(bn(Jt)),Nt+=ye,Wt+=Jt}}else for(const oe of tt){st.writeVarint(Wo(1,1));const ye=oe.length-(Tt===3?1:0);for(let Jt=0;Jt<ye;Jt++){Jt===1&&st.writeVarint(Wo(2,ye-1));const xe=oe[Jt][0]-Nt,ti=oe[Jt][1]-Wt;st.writeVarint(bn(xe)),st.writeVarint(bn(ti)),Nt+=xe,Wt+=ti}Tt===3&&st.writeVarint(Wo(7,1))}}function qo(se,st){const tt=typeof se;tt==="string"?st.writeStringField(1,se):tt==="boolean"?st.writeBooleanField(7,se):tt==="number"&&(se%1!=0?st.writeDoubleField(3,se):se<0?st.writeSVarintField(6,se):st.writeVarintField(5,se))}const ma={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:se=>se},Kn=Math.fround||(vo=new Float32Array(1),se=>(vo[0]=+se,vo[0]));var vo;const ns=3,Ds=5,lo=6;class Zn{constructor(st){this.options=Object.assign(Object.create(ma),st),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(st){const{log:tt,minZoom:Tt,maxZoom:Nt}=this.options;tt&&console.time("total time");const Wt=`prepare ${st.length} points`;tt&&console.time(Wt),this.points=st;const oe=[];for(let Jt=0;Jt<st.length;Jt++){const xe=st[Jt];if(!xe.geometry)continue;const[ti,$e]=xe.geometry.coordinates,Mi=Kn(Ts(ti)),Ji=Kn(ga($e));oe.push(Mi,Ji,1/0,Jt,-1,1),this.options.reduce&&oe.push(0)}let ye=this.trees[Nt+1]=this._createTree(oe);tt&&console.timeEnd(Wt);for(let Jt=Nt;Jt>=Tt;Jt--){const xe=+Date.now();ye=this.trees[Jt]=this._createTree(this._cluster(ye,Jt)),tt&&console.log("z%d: %d clusters in %dms",Jt,ye.numItems,+Date.now()-xe)}return tt&&console.timeEnd("total time"),this}getClusters(st,tt){let Tt=((st[0]+180)%360+360)%360-180;const Nt=Math.max(-90,Math.min(90,st[1]));let Wt=st[2]===180?180:((st[2]+180)%360+360)%360-180;const oe=Math.max(-90,Math.min(90,st[3]));if(st[2]-st[0]>=360)Tt=-180,Wt=180;else if(Tt>Wt){const $e=this.getClusters([Tt,Nt,180,oe],tt),Mi=this.getClusters([-180,Nt,Wt,oe],tt);return $e.concat(Mi)}const ye=this.trees[this._limitZoom(tt)],Jt=ye.range(Ts(Tt),ga(oe),Ts(Wt),ga(Nt)),xe=ye.data,ti=[];for(const $e of Jt){const Mi=this.stride*$e;ti.push(xe[Mi+Ds]>1?el(xe,Mi,this.clusterProps):this.points[xe[Mi+ns]])}return ti}getChildren(st){const tt=this._getOriginId(st),Tt=this._getOriginZoom(st),Nt="No cluster with the specified id.",Wt=this.trees[Tt];if(!Wt)throw new Error(Nt);const oe=Wt.data;if(tt*this.stride>=oe.length)throw new Error(Nt);const ye=this.options.radius/(this.options.extent*Math.pow(2,Tt-1)),Jt=Wt.within(oe[tt*this.stride],oe[tt*this.stride+1],ye),xe=[];for(const ti of Jt){const $e=ti*this.stride;oe[$e+4]===st&&xe.push(oe[$e+Ds]>1?el(oe,$e,this.clusterProps):this.points[oe[$e+ns]])}if(xe.length===0)throw new Error(Nt);return xe}getLeaves(st,tt,Tt){const Nt=[];return this._appendLeaves(Nt,st,tt=tt||10,Tt=Tt||0,0),Nt}getTile(st,tt,Tt){const Nt=this.trees[this._limitZoom(st)],Wt=Math.pow(2,st),{extent:oe,radius:ye}=this.options,Jt=ye/oe,xe=(Tt-Jt)/Wt,ti=(Tt+1+Jt)/Wt,$e={features:[]};return this._addTileFeatures(Nt.range((tt-Jt)/Wt,xe,(tt+1+Jt)/Wt,ti),Nt.data,tt,Tt,Wt,$e),tt===0&&this._addTileFeatures(Nt.range(1-Jt/Wt,xe,1,ti),Nt.data,Wt,Tt,Wt,$e),tt===Wt-1&&this._addTileFeatures(Nt.range(0,xe,Jt/Wt,ti),Nt.data,-1,Tt,Wt,$e),$e.features.length?$e:null}getClusterExpansionZoom(st){let tt=this._getOriginZoom(st)-1;for(;tt<=this.options.maxZoom;){const Tt=this.getChildren(st);if(tt++,Tt.length!==1)break;st=Tt[0].properties.cluster_id}return tt}_appendLeaves(st,tt,Tt,Nt,Wt){const oe=this.getChildren(tt);for(const ye of oe){const Jt=ye.properties;if(Jt&&Jt.cluster?Wt+Jt.point_count<=Nt?Wt+=Jt.point_count:Wt=this._appendLeaves(st,Jt.cluster_id,Tt,Nt,Wt):Wt<Nt?Wt++:st.push(ye),st.length===Tt)break}return Wt}_createTree(st){const tt=new i.c3(st.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Tt=0;Tt<st.length;Tt+=this.stride)tt.add(st[Tt],st[Tt+1]);return tt.finish(),tt.data=st,tt}_addTileFeatures(st,tt,Tt,Nt,Wt,oe){for(const ye of st){const Jt=ye*this.stride,xe=tt[Jt+Ds]>1;let ti,$e,Mi;if(xe)ti=jl(tt,Jt,this.clusterProps),$e=tt[Jt],Mi=tt[Jt+1];else{const qi=this.points[tt[Jt+ns]];ti=qi.properties;const[hr,Yi]=qi.geometry.coordinates;$e=Ts(hr),Mi=ga(Yi)}const Ji={type:1,geometry:[[Math.round(this.options.extent*($e*Wt-Tt)),Math.round(this.options.extent*(Mi*Wt-Nt))]],tags:ti};let Xi;Xi=xe||this.options.generateId?tt[Jt+ns]:this.points[tt[Jt+ns]].id,Xi!==void 0&&(Ji.id=Xi),oe.features.push(Ji)}}_limitZoom(st){return Math.max(this.options.minZoom,Math.min(Math.floor(+st),this.options.maxZoom+1))}_cluster(st,tt){const{radius:Tt,extent:Nt,reduce:Wt,minPoints:oe}=this.options,ye=Tt/(Nt*Math.pow(2,tt)),Jt=st.data,xe=[],ti=this.stride;for(let $e=0;$e<Jt.length;$e+=ti){if(Jt[$e+2]<=tt)continue;Jt[$e+2]=tt;const Mi=Jt[$e],Ji=Jt[$e+1],Xi=st.within(Jt[$e],Jt[$e+1],ye),qi=Jt[$e+Ds];let hr=qi;for(const Yi of Xi){const wn=Yi*ti;Jt[wn+2]>tt&&(hr+=Jt[wn+Ds])}if(hr>qi&&hr>=oe){let Yi,wn=Mi*qi,Pn=Ji*qi,zo=-1;const Gr=($e/ti<<5)+(tt+1)+this.points.length;for(const Wn of Xi){const an=Wn*ti;if(Jt[an+2]<=tt)continue;Jt[an+2]=tt;const Rr=Jt[an+Ds];wn+=Jt[an]*Rr,Pn+=Jt[an+1]*Rr,Jt[an+4]=Gr,Wt&&(Yi||(Yi=this._map(Jt,$e,!0),zo=this.clusterProps.length,this.clusterProps.push(Yi)),Wt(Yi,this._map(Jt,an)))}Jt[$e+4]=Gr,xe.push(wn/hr,Pn/hr,1/0,Gr,-1,hr),Wt&&xe.push(zo)}else{for(let Yi=0;Yi<ti;Yi++)xe.push(Jt[$e+Yi]);if(hr>1)for(const Yi of Xi){const wn=Yi*ti;if(!(Jt[wn+2]<=tt)){Jt[wn+2]=tt;for(let Pn=0;Pn<ti;Pn++)xe.push(Jt[wn+Pn])}}}}return xe}_getOriginId(st){return st-this.points.length>>5}_getOriginZoom(st){return(st-this.points.length)%32}_map(st,tt,Tt){if(st[tt+Ds]>1){const oe=this.clusterProps[st[tt+lo]];return Tt?Object.assign({},oe):oe}const Nt=this.points[st[tt+ns]].properties,Wt=this.options.map(Nt);return Tt&&Wt===Nt?Object.assign({},Wt):Wt}}function el(se,st,tt){return{type:"Feature",id:se[st+ns],properties:jl(se,st,tt),geometry:{type:"Point",coordinates:[(Tt=se[st],360*(Tt-.5)),Gl(se[st+1])]}};var Tt}function jl(se,st,tt){const Tt=se[st+Ds],Nt=Tt>=1e4?`${Math.round(Tt/1e3)}k`:Tt>=1e3?Math.round(Tt/100)/10+"k":Tt,Wt=se[st+lo],oe=Wt===-1?{}:Object.assign({},tt[Wt]);return Object.assign(oe,{cluster:!0,cluster_id:se[st+ns],point_count:Tt,point_count_abbreviated:Nt})}function Ts(se){return se/360+.5}function ga(se){const st=Math.sin(se*Math.PI/180),tt=.5-.25*Math.log((1+st)/(1-st))/Math.PI;return tt<0?0:tt>1?1:tt}function Gl(se){const st=(180-360*se)*Math.PI/180;return 360*Math.atan(Math.exp(st))/Math.PI-90}function ds(se,st,tt,Tt){let Nt=Tt;const Wt=st+(tt-st>>1);let oe,ye=tt-st;const Jt=se[st],xe=se[st+1],ti=se[tt],$e=se[tt+1];for(let Mi=st+3;Mi<tt;Mi+=3){const Ji=Ss(se[Mi],se[Mi+1],Jt,xe,ti,$e);if(Ji>Nt)oe=Mi,Nt=Ji;else if(Ji===Nt){const Xi=Math.abs(Mi-Wt);Xi<ye&&(oe=Mi,ye=Xi)}}Nt>Tt&&(oe-st>3&&ds(se,st,oe,Tt),se[oe+2]=Nt,tt-oe>3&&ds(se,oe,tt,Tt))}function Ss(se,st,tt,Tt,Nt,Wt){let oe=Nt-tt,ye=Wt-Tt;if(oe!==0||ye!==0){const Jt=((se-tt)*oe+(st-Tt)*ye)/(oe*oe+ye*ye);Jt>1?(tt=Nt,Tt=Wt):Jt>0&&(tt+=oe*Jt,Tt+=ye*Jt)}return oe=se-tt,ye=st-Tt,oe*oe+ye*ye}function il(se,st,tt,Tt){const Nt={id:se??null,type:st,geometry:tt,tags:Tt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(st==="Point"||st==="MultiPoint"||st==="LineString")Sl(Nt,tt);else if(st==="Polygon")Sl(Nt,tt[0]);else if(st==="MultiLineString")for(const Wt of tt)Sl(Nt,Wt);else if(st==="MultiPolygon")for(const Wt of tt)Sl(Nt,Wt[0]);return Nt}function Sl(se,st){for(let tt=0;tt<st.length;tt+=3)se.minX=Math.min(se.minX,st[tt]),se.minY=Math.min(se.minY,st[tt+1]),se.maxX=Math.max(se.maxX,st[tt]),se.maxY=Math.max(se.maxY,st[tt+1])}function Il(se,st,tt,Tt){if(!st.geometry)return;const Nt=st.geometry.coordinates;if(Nt&&Nt.length===0)return;const Wt=st.geometry.type,oe=Math.pow(tt.tolerance/((1<<tt.maxZoom)*tt.extent),2);let ye=[],Jt=st.id;if(tt.promoteId?Jt=st.properties[tt.promoteId]:tt.generateId&&(Jt=Tt||0),Wt==="Point")zs(Nt,ye);else if(Wt==="MultiPoint")for(const xe of Nt)zs(xe,ye);else if(Wt==="LineString")rl(Nt,ye,oe,!1);else if(Wt==="MultiLineString"){if(tt.lineMetrics){for(const xe of Nt)ye=[],rl(xe,ye,oe,!1),se.push(il(Jt,"LineString",ye,st.properties));return}Ga(Nt,ye,oe,!1)}else if(Wt==="Polygon")Ga(Nt,ye,oe,!0);else{if(Wt!=="MultiPolygon"){if(Wt==="GeometryCollection"){for(const xe of st.geometry.geometries)Il(se,{id:Jt,geometry:xe,properties:st.properties},tt,Tt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const xe of Nt){const ti=[];Ga(xe,ti,oe,!0),ye.push(ti)}}se.push(il(Jt,Wt,ye,st.properties))}function zs(se,st){st.push($l(se[0]),Aa(se[1]),0)}function rl(se,st,tt,Tt){let Nt,Wt,oe=0;for(let Jt=0;Jt<se.length;Jt++){const xe=$l(se[Jt][0]),ti=Aa(se[Jt][1]);st.push(xe,ti,0),Jt>0&&(oe+=Tt?(Nt*ti-xe*Wt)/2:Math.sqrt(Math.pow(xe-Nt,2)+Math.pow(ti-Wt,2))),Nt=xe,Wt=ti}const ye=st.length-3;st[2]=1,ds(st,0,ye,tt),st[ye+2]=1,st.size=Math.abs(oe),st.start=0,st.end=st.size}function Ga(se,st,tt,Tt){for(let Nt=0;Nt<se.length;Nt++){const Wt=[];rl(se[Nt],Wt,tt,Tt),st.push(Wt)}}function $l(se){return se/360+.5}function Aa(se){const st=Math.sin(se*Math.PI/180),tt=.5-.25*Math.log((1+st)/(1-st))/Math.PI;return tt<0?0:tt>1?1:tt}function Hn(se,st,tt,Tt,Nt,Wt,oe,ye){if(Tt/=st,Wt>=(tt/=st)&&oe<Tt)return se;if(oe<tt||Wt>=Tt)return null;const Jt=[];for(const xe of se){const ti=xe.geometry;let $e=xe.type;const Mi=Nt===0?xe.minX:xe.minY,Ji=Nt===0?xe.maxX:xe.maxY;if(Mi>=tt&&Ji<Tt){Jt.push(xe);continue}if(Ji<tt||Mi>=Tt)continue;let Xi=[];if($e==="Point"||$e==="MultiPoint")we(ti,Xi,tt,Tt,Nt);else if($e==="LineString")It(ti,Xi,tt,Tt,Nt,!1,ye.lineMetrics);else if($e==="MultiLineString")Ut(ti,Xi,tt,Tt,Nt,!1);else if($e==="Polygon")Ut(ti,Xi,tt,Tt,Nt,!0);else if($e==="MultiPolygon")for(const qi of ti){const hr=[];Ut(qi,hr,tt,Tt,Nt,!0),hr.length&&Xi.push(hr)}if(Xi.length){if(ye.lineMetrics&&$e==="LineString"){for(const qi of Xi)Jt.push(il(xe.id,$e,qi,xe.tags));continue}$e!=="LineString"&&$e!=="MultiLineString"||(Xi.length===1?($e="LineString",Xi=Xi[0]):$e="MultiLineString"),$e!=="Point"&&$e!=="MultiPoint"||($e=Xi.length===3?"Point":"MultiPoint"),Jt.push(il(xe.id,$e,Xi,xe.tags))}}return Jt.length?Jt:null}function we(se,st,tt,Tt,Nt){for(let Wt=0;Wt<se.length;Wt+=3){const oe=se[Wt+Nt];oe>=tt&&oe<=Tt&&he(st,se[Wt],se[Wt+1],se[Wt+2])}}function It(se,st,tt,Tt,Nt,Wt,oe){let ye=Mt(se);const Jt=Nt===0?le:Re;let xe,ti,$e=se.start;for(let hr=0;hr<se.length-3;hr+=3){const Yi=se[hr],wn=se[hr+1],Pn=se[hr+2],zo=se[hr+3],Gr=se[hr+4],Wn=Nt===0?Yi:wn,an=Nt===0?zo:Gr;let Rr=!1;oe&&(xe=Math.sqrt(Math.pow(Yi-zo,2)+Math.pow(wn-Gr,2))),Wn<tt?an>tt&&(ti=Jt(ye,Yi,wn,zo,Gr,tt),oe&&(ye.start=$e+xe*ti)):Wn>Tt?an<Tt&&(ti=Jt(ye,Yi,wn,zo,Gr,Tt),oe&&(ye.start=$e+xe*ti)):he(ye,Yi,wn,Pn),an<tt&&Wn>=tt&&(ti=Jt(ye,Yi,wn,zo,Gr,tt),Rr=!0),an>Tt&&Wn<=Tt&&(ti=Jt(ye,Yi,wn,zo,Gr,Tt),Rr=!0),!Wt&&Rr&&(oe&&(ye.end=$e+xe*ti),st.push(ye),ye=Mt(se)),oe&&($e+=xe)}let Mi=se.length-3;const Ji=se[Mi],Xi=se[Mi+1],qi=Nt===0?Ji:Xi;qi>=tt&&qi<=Tt&&he(ye,Ji,Xi,se[Mi+2]),Mi=ye.length-3,Wt&&Mi>=3&&(ye[Mi]!==ye[0]||ye[Mi+1]!==ye[1])&&he(ye,ye[0],ye[1],ye[2]),ye.length&&st.push(ye)}function Mt(se){const st=[];return st.size=se.size,st.start=se.start,st.end=se.end,st}function Ut(se,st,tt,Tt,Nt,Wt){for(const oe of se)It(oe,st,tt,Tt,Nt,Wt,!1)}function he(se,st,tt,Tt){se.push(st,tt,Tt)}function le(se,st,tt,Tt,Nt,Wt){const oe=(Wt-st)/(Tt-st);return he(se,Wt,tt+(Nt-tt)*oe,1),oe}function Re(se,st,tt,Tt,Nt,Wt){const oe=(Wt-tt)/(Nt-tt);return he(se,st+(Tt-st)*oe,Wt,1),oe}function te(se,st){const tt=[];for(let Tt=0;Tt<se.length;Tt++){const Nt=se[Tt],Wt=Nt.type;let oe;if(Wt==="Point"||Wt==="MultiPoint"||Wt==="LineString")oe=ze(Nt.geometry,st);else if(Wt==="MultiLineString"||Wt==="Polygon"){oe=[];for(const ye of Nt.geometry)oe.push(ze(ye,st))}else if(Wt==="MultiPolygon"){oe=[];for(const ye of Nt.geometry){const Jt=[];for(const xe of ye)Jt.push(ze(xe,st));oe.push(Jt)}}tt.push(il(Nt.id,Wt,oe,Nt.tags))}return tt}function ze(se,st){const tt=[];tt.size=se.size,se.start!==void 0&&(tt.start=se.start,tt.end=se.end);for(let Tt=0;Tt<se.length;Tt+=3)tt.push(se[Tt]+st,se[Tt+1],se[Tt+2]);return tt}function We(se,st){if(se.transformed)return se;const tt=1<<se.z,Tt=se.x,Nt=se.y;for(const Wt of se.features){const oe=Wt.geometry,ye=Wt.type;if(Wt.geometry=[],ye===1)for(let Jt=0;Jt<oe.length;Jt+=2)Wt.geometry.push(ci(oe[Jt],oe[Jt+1],st,tt,Tt,Nt));else for(let Jt=0;Jt<oe.length;Jt++){const xe=[];for(let ti=0;ti<oe[Jt].length;ti+=2)xe.push(ci(oe[Jt][ti],oe[Jt][ti+1],st,tt,Tt,Nt));Wt.geometry.push(xe)}}return se.transformed=!0,se}function ci(se,st,tt,Tt,Nt,Wt){return[Math.round(tt*(se*Tt-Nt)),Math.round(tt*(st*Tt-Wt))]}function ui(se,st,tt,Tt,Nt){const Wt=st===Nt.maxZoom?0:Nt.tolerance/((1<<st)*Nt.extent),oe={features:[],numPoints:0,numSimplified:0,numFeatures:se.length,source:null,x:tt,y:Tt,z:st,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ye of se)or(oe,ye,Wt,Nt);return oe}function or(se,st,tt,Tt){const Nt=st.geometry,Wt=st.type,oe=[];if(se.minX=Math.min(se.minX,st.minX),se.minY=Math.min(se.minY,st.minY),se.maxX=Math.max(se.maxX,st.maxX),se.maxY=Math.max(se.maxY,st.maxY),Wt==="Point"||Wt==="MultiPoint")for(let ye=0;ye<Nt.length;ye+=3)oe.push(Nt[ye],Nt[ye+1]),se.numPoints++,se.numSimplified++;else if(Wt==="LineString")Ir(oe,Nt,se,tt,!1,!1);else if(Wt==="MultiLineString"||Wt==="Polygon")for(let ye=0;ye<Nt.length;ye++)Ir(oe,Nt[ye],se,tt,Wt==="Polygon",ye===0);else if(Wt==="MultiPolygon")for(let ye=0;ye<Nt.length;ye++){const Jt=Nt[ye];for(let xe=0;xe<Jt.length;xe++)Ir(oe,Jt[xe],se,tt,!0,xe===0)}if(oe.length){let ye=st.tags||null;if(Wt==="LineString"&&Tt.lineMetrics){ye={};for(const xe in st.tags)ye[xe]=st.tags[xe];ye.mapbox_clip_start=Nt.start/Nt.size,ye.mapbox_clip_end=Nt.end/Nt.size}const Jt={geometry:oe,type:Wt==="Polygon"||Wt==="MultiPolygon"?3:Wt==="LineString"||Wt==="MultiLineString"?2:1,tags:ye};st.id!==null&&(Jt.id=st.id),se.features.push(Jt)}}function Ir(se,st,tt,Tt,Nt,Wt){const oe=Tt*Tt;if(Tt>0&&st.size<(Nt?oe:Tt))return void(tt.numPoints+=st.length/3);const ye=[];for(let Jt=0;Jt<st.length;Jt+=3)(Tt===0||st[Jt+2]>oe)&&(tt.numSimplified++,ye.push(st[Jt],st[Jt+1])),tt.numPoints++;Nt&&function(Jt,xe){let ti=0;for(let $e=0,Mi=Jt.length,Ji=Mi-2;$e<Mi;Ji=$e,$e+=2)ti+=(Jt[$e]-Jt[Ji])*(Jt[$e+1]+Jt[Ji+1]);if(ti>0===xe)for(let $e=0,Mi=Jt.length;$e<Mi/2;$e+=2){const Ji=Jt[$e],Xi=Jt[$e+1];Jt[$e]=Jt[Mi-2-$e],Jt[$e+1]=Jt[Mi-1-$e],Jt[Mi-2-$e]=Ji,Jt[Mi-1-$e]=Xi}}(ye,Wt),se.push(ye)}const Ae={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class bo{constructor(st,tt){const Tt=(tt=this.options=function(Wt,oe){for(const ye in oe)Wt[ye]=oe[ye];return Wt}(Object.create(Ae),tt)).debug;if(Tt&&console.time("preprocess data"),tt.maxZoom<0||tt.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(tt.promoteId&&tt.generateId)throw new Error("promoteId and generateId cannot be used together.");let Nt=function(Wt,oe){const ye=[];if(Wt.type==="FeatureCollection")for(let Jt=0;Jt<Wt.features.length;Jt++)Il(ye,Wt.features[Jt],oe,Jt);else Il(ye,Wt.type==="Feature"?Wt:{geometry:Wt},oe);return ye}(st,tt);this.tiles={},this.tileCoords=[],Tt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",tt.indexMaxZoom,tt.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Nt=function(Wt,oe){const ye=oe.buffer/oe.extent;let Jt=Wt;const xe=Hn(Wt,1,-1-ye,ye,0,-1,2,oe),ti=Hn(Wt,1,1-ye,2+ye,0,-1,2,oe);return(xe||ti)&&(Jt=Hn(Wt,1,-ye,1+ye,0,-1,2,oe)||[],xe&&(Jt=te(xe,1).concat(Jt)),ti&&(Jt=Jt.concat(te(ti,-1)))),Jt}(Nt,tt),Nt.length&&this.splitTile(Nt,0,0,0),Tt&&(Nt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(st,tt,Tt,Nt,Wt,oe,ye){const Jt=[st,tt,Tt,Nt],xe=this.options,ti=xe.debug;for(;Jt.length;){Nt=Jt.pop(),Tt=Jt.pop(),tt=Jt.pop(),st=Jt.pop();const $e=1<<tt,Mi=_n(tt,Tt,Nt);let Ji=this.tiles[Mi];if(!Ji&&(ti>1&&console.time("creation"),Ji=this.tiles[Mi]=ui(st,tt,Tt,Nt,xe),this.tileCoords.push({z:tt,x:Tt,y:Nt}),ti)){ti>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",tt,Tt,Nt,Ji.numFeatures,Ji.numPoints,Ji.numSimplified),console.timeEnd("creation"));const Rr=`z${tt}`;this.stats[Rr]=(this.stats[Rr]||0)+1,this.total++}if(Ji.source=st,Wt==null){if(tt===xe.indexMaxZoom||Ji.numPoints<=xe.indexMaxPoints)continue}else{if(tt===xe.maxZoom||tt===Wt)continue;if(Wt!=null){const Rr=Wt-tt;if(Tt!==oe>>Rr||Nt!==ye>>Rr)continue}}if(Ji.source=null,st.length===0)continue;ti>1&&console.time("clipping");const Xi=.5*xe.buffer/xe.extent,qi=.5-Xi,hr=.5+Xi,Yi=1+Xi;let wn=null,Pn=null,zo=null,Gr=null,Wn=Hn(st,$e,Tt-Xi,Tt+hr,0,Ji.minX,Ji.maxX,xe),an=Hn(st,$e,Tt+qi,Tt+Yi,0,Ji.minX,Ji.maxX,xe);st=null,Wn&&(wn=Hn(Wn,$e,Nt-Xi,Nt+hr,1,Ji.minY,Ji.maxY,xe),Pn=Hn(Wn,$e,Nt+qi,Nt+Yi,1,Ji.minY,Ji.maxY,xe),Wn=null),an&&(zo=Hn(an,$e,Nt-Xi,Nt+hr,1,Ji.minY,Ji.maxY,xe),Gr=Hn(an,$e,Nt+qi,Nt+Yi,1,Ji.minY,Ji.maxY,xe),an=null),ti>1&&console.timeEnd("clipping"),Jt.push(wn||[],tt+1,2*Tt,2*Nt),Jt.push(Pn||[],tt+1,2*Tt,2*Nt+1),Jt.push(zo||[],tt+1,2*Tt+1,2*Nt),Jt.push(Gr||[],tt+1,2*Tt+1,2*Nt+1)}}getTile(st,tt,Tt){st=+st,tt=+tt,Tt=+Tt;const Nt=this.options,{extent:Wt,debug:oe}=Nt;if(st<0||st>24)return null;const ye=1<<st,Jt=_n(st,tt=tt+ye&ye-1,Tt);if(this.tiles[Jt])return We(this.tiles[Jt],Wt);oe>1&&console.log("drilling down to z%d-%d-%d",st,tt,Tt);let xe,ti=st,$e=tt,Mi=Tt;for(;!xe&&ti>0;)ti--,$e>>=1,Mi>>=1,xe=this.tiles[_n(ti,$e,Mi)];return xe&&xe.source?(oe>1&&(console.log("found parent tile z%d-%d-%d",ti,$e,Mi),console.time("drilling down")),this.splitTile(xe.source,ti,$e,Mi,st,tt,Tt),oe>1&&console.timeEnd("drilling down"),this.tiles[Jt]?We(this.tiles[Jt],Wt):null):null}}function _n(se,st,tt){return 32*((1<<se)*tt+st)+se}function Un(se,st){const tt=se.tileID.canonical;if(!this._geoJSONIndex)return void st(null,null);const Tt=this._geoJSONIndex.getTile(tt.z,tt.x,tt.y);if(!Tt)return void st(null,null);const Nt=xe=>xe.tags&&"3d_elevation_id"in xe.tags&&"source"in xe.tags&&xe.tags.source==="elevation",Wt=Tt.features.filter(xe=>Nt(xe));let oe={_geojsonTileLayer:Tt.features};Wt.length>0&&(oe={_geojsonTileLayer:Tt.features.filter(xe=>!Nt(xe)),hd_road_elevation:Wt});const ye=new bh(oe),Jt=function(xe){const ti=new i.bs;for(const $e of Object.keys(xe))ti.writeMessage(3,Ul,{name:$e,features:xe[$e]});return ti.finish()}(oe).buffer;st(null,{vectorTile:ye,rawData:Jt})}class rr extends Do{constructor(st,tt,Tt,Nt,Wt,oe,ye){super(st,tt,Tt,Nt,Wt,Un,ye),oe&&(this.loadGeoJSON=oe),this._dynamicIndex=new dn}loadData(st,tt){const Tt=st&&st.request,Nt=Tt&&Tt.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(st,(Wt,oe)=>{if(Wt||!oe)return tt(Wt);if(typeof oe!="object")return tt(new Error(`Input data given to '${st.source}' is not a valid GeoJSON object.`));{try{if(st.filter){const Jt=i.U(st.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Jt.result==="error")throw new Error(Jt.value.map(xe=>`${xe.key}: ${xe.message}`).join(", "));oe.features=oe.features.filter(xe=>Jt.value.evaluate({zoom:0},xe))}st.dynamic?(oe.type==="Feature"&&(oe={type:"FeatureCollection",features:[oe]}),st.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(oe.features,this.loaded),st.cluster&&(oe.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=st.cluster?new Zn(function({superclusterOptions:Jt,clusterProperties:xe}){if(!xe||!Jt)return Jt;const ti={},$e={},Mi={accumulated:null,zoom:0},Ji={properties:null},Xi=Object.keys(xe);for(const qi of Xi){const[hr,Yi]=xe[qi],wn=i.U(Yi),Pn=i.U(typeof hr=="string"?[hr,["accumulated"],["get",qi]]:hr);ti[qi]=wn.value,$e[qi]=Pn.value}return Jt.map=qi=>{Ji.properties=qi;const hr={};for(const Yi of Xi)hr[Yi]=ti[Yi].evaluate(Mi,Ji);return hr},Jt.reduce=(qi,hr)=>{Ji.properties=hr;for(const Yi of Xi)Mi.accumulated=qi[Yi],qi[Yi]=$e[Yi].evaluate(Mi,Ji)},Jt}(st)).load(oe.features):st.dynamic?this._dynamicIndex:function(Jt,xe){return new bo(Jt,xe)}(oe,st.geojsonVtOptions)}catch(Jt){return tt(Jt)}const ye={};if(Nt){const Jt=Pe(Tt);Jt&&(ye.resourceTiming={},ye.resourceTiming[st.source]=JSON.parse(JSON.stringify(Jt)))}tt(null,ye)}})}reloadTile(st,tt){const Tt=this.loaded;return Tt&&Tt[st.uid]?st.partial?tt(null,void 0):super.reloadTile(st,tt):this.loadTile(st,tt)}loadGeoJSON(st,tt){if(st.request)i.m(st.request,tt);else{if(typeof st.data!="string")return tt(new Error(`Input data given to '${st.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return tt(null,JSON.parse(st.data))}catch{return tt(new Error(`Input data given to '${st.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(st,tt){try{tt(null,this._geoJSONIndex.getClusterExpansionZoom(st.clusterId))}catch(Tt){tt(Tt)}}getClusterChildren(st,tt){try{tt(null,this._geoJSONIndex.getChildren(st.clusterId))}catch(Tt){tt(Tt)}}getClusterLeaves(st,tt){try{tt(null,this._geoJSONIndex.getLeaves(st.clusterId,st.limit,st.offset))}catch(Tt){tt(Tt)}}}class bi{constructor(st,tt,Tt){this.tileID=new i.aP(st.tileID.overscaledZ,st.tileID.wrap,st.tileID.canonical.z,st.tileID.canonical.x,st.tileID.canonical.y),this.tileZoom=st.tileZoom,this.uid=st.uid,this.zoom=st.zoom,this.canonical=st.tileID.canonical,this.pixelRatio=st.pixelRatio,this.tileSize=st.tileSize,this.source=st.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=st.projection,this.brightness=tt,this.worldview=Tt}parse(st,tt,Tt,Nt){this.status="parsing";const Wt=new i.aP(Tt.tileID.overscaledZ,Tt.tileID.wrap,Tt.tileID.canonical.z,Tt.tileID.canonical.x,Tt.tileID.canonical.y),oe=[],ye=tt.familiesBySource[Tt.source],Jt=new i.fm(Wt,Tt.promoteId);Jt.bucketLayerIDs=[],Jt.is3DTile=!0,i.fB(st).then(xe=>{if(!xe)return Nt(new Error("Could not parse tile"));const ti=xe.json.extensionsUsed&&xe.json.extensionsUsed.includes("MAPBOX_mesh_features")||xe.json.asset.extras&&xe.json.asset.extras.MAPBOX_mesh_features,$e=xe.json.extensionsUsed&&xe.json.extensionsUsed.includes("EXT_meshopt_compression"),Mi=new i.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const Ji in ye)for(const Xi of ye[Ji]){const qi=Xi[0];Jt.bucketLayerIDs.push(Xi.map(wn=>i.B(wn.id,wn.scope))),qi.recalculate(Mi,[]);const hr=i.fC(xe,1/i.d6(Tt.tileID.canonical)),Yi=new i.fD(Xi,hr,Wt,ti,$e,this.brightness,Jt,this.worldview);ti||(Yi.needsUpload=!0),oe.push(Yi),Yi.evaluate(qi)}this.status="done",Nt(null,{buckets:oe,featureIndex:Jt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(xe=>Nt(new Error(xe.message)))}}class Bo{constructor(st,tt,Tt,Nt,Wt,oe,ye,Jt){this.actor=st,this.layerIndex=tt,this.availableImages=Tt,this.availableModels=Nt,this.brightness=ye,this.loading={},this.loaded={},this.worldview=Jt}loadTile(st,tt){const Tt=st.uid,Nt=this.loading[Tt]=new bi(st,this.brightness,this.worldview);i.bt(st.request,(Wt,oe)=>{const ye=!this.loading[Tt];return delete this.loading[Tt],ye||Wt?(Nt.status="done",ye||(this.loaded[Tt]=Nt),tt(Wt)):oe&&oe.byteLength!==0?void Nt.parse(oe,this.layerIndex,st,(Jt,xe)=>{Nt.status="done",this.loaded=this.loaded||{},this.loaded[Tt]=Nt,Jt||!xe?tt(Jt):tt(null,xe)}):(Nt.status="done",this.loaded[Tt]=Nt,tt())})}reloadTile(st,tt){const Tt=this.loaded,Nt=st.uid;if(Tt&&Tt[Nt]){const Wt=Tt[Nt];Wt.projection=st.projection,Wt.brightness=st.brightness;const oe=(ye,Jt)=>{Wt.reloadCallback&&(delete Wt.reloadCallback,this.loadTile(st,tt)),tt(ye,Jt)};Wt.status==="parsing"?Wt.reloadCallback=oe:Wt.status==="done"&&this.loadTile(st,tt)}}abortTile(st,tt){const Tt=st.uid;this.loading[Tt]&&delete this.loading[Tt],tt()}removeTile(st,tt){const Tt=this.loaded,Nt=st.uid;Tt&&Tt[Nt]&&delete Tt[Nt],tt()}}class wo{constructor(st){this.self=st,this.actor=new i.fF(st,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new i.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=i.cl({name:"mercator"}),this.workerSourceTypes={vector:Do,geojson:rr,"raster-dem":tl,"raster-array":Nl,"batched-model":Bo},this.workerSources={},this.self.registerWorkerSource=(tt,Tt)=>{if(this.workerSourceTypes[tt])throw new Error(`Worker source with name "${tt}" already registered.`);this.workerSourceTypes[tt]=Tt},this.self.registerRTLTextPlugin=tt=>{if(i.fG.isParsed())throw new Error("RTL text plugin already registered.");i.fG.setState({pluginStatus:i.fH.parsed,pluginURL:i.fG.getPluginURL()}),i.fG.applyArabicShaping=tt.applyArabicShaping,i.fG.processBidirectionalText=tt.processBidirectionalText,i.fG.processStyledBidirectionalText=tt.processStyledBidirectionalText;for(const Tt of this.rtlPluginParsingListeners)Tt(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(st,tt,Tt){delete this.layerIndexes[st],delete this.availableImages[st],delete this.availableModels[st],delete this.workerSources[st],Tt()}checkIfReady(st,tt,Tt){Tt()}setReferrer(st,tt){this.referrer=tt}spriteLoaded(st,tt){this.isSpriteLoaded[st]||(this.isSpriteLoaded[st]={});const{scope:Tt,isLoaded:Nt}=tt;if(this.isSpriteLoaded[st][Tt]=Nt,this.workerSources[st]&&this.workerSources[st][Tt])for(const Wt in this.workerSources[st][Tt]){const oe=this.workerSources[st][Tt][Wt];for(const ye in oe){const Jt=oe[ye];Jt instanceof Do&&(Jt.isSpriteLoaded=Nt,Jt.fire(new i.z("isSpriteLoaded")))}}}setImages(st,tt,Tt){this.availableImages[st]||(this.availableImages[st]={});const{scope:Nt,images:Wt}=tt;if(this.availableImages[st][Nt]=Wt,this.workerSources[st]&&this.workerSources[st][Nt]){for(const oe in this.workerSources[st][Nt]){const ye=this.workerSources[st][Nt][oe];for(const Jt in ye)ye[Jt].availableImages=Wt}Tt()}else Tt()}setModels(st,{scope:tt,models:Tt},Nt){if(this.availableModels[st]||(this.availableModels[st]={}),this.availableModels[st][tt]=Tt,this.workerSources[st]&&this.workerSources[st][tt]){for(const Wt in this.workerSources[st][tt]){const oe=this.workerSources[st][tt][Wt];for(const ye in oe)oe[ye].availableModels=Tt}Nt()}else Nt()}setProjection(st,tt){this.projections[st]=i.cl(tt)}setBrightness(st,tt,Tt){this.brightness=tt,Tt()}setWorldview(st,tt,Tt){this.worldview=tt,Tt()}setLayers(st,tt,Tt){this.getLayerIndex(st,tt.scope).replace(tt.layers,tt.options),Tt()}updateLayers(st,tt,Tt){this.getLayerIndex(st,tt.scope).update(tt.layers,tt.removedIds,tt.options),Tt()}loadTile(st,tt,Tt){tt.projection=this.projections[st]||this.defaultProjection,this.getWorkerSource(st,tt.type,tt.source,tt.scope).loadTile(tt,Tt)}decodeRasterArray(st,tt,Tt){this.getWorkerSource(st,tt.type,tt.source,tt.scope).decodeRasterArray(tt,Tt)}reloadTile(st,tt,Tt){tt.projection=this.projections[st]||this.defaultProjection,this.getWorkerSource(st,tt.type,tt.source,tt.scope).reloadTile(tt,Tt)}abortTile(st,tt,Tt){this.getWorkerSource(st,tt.type,tt.source,tt.scope).abortTile(tt,Tt)}removeTile(st,tt,Tt){this.getWorkerSource(st,tt.type,tt.source,tt.scope).removeTile(tt,Tt)}removeSource(st,tt,Tt){if(!(this.workerSources[st]&&this.workerSources[st][tt.scope]&&this.workerSources[st][tt.scope][tt.type]&&this.workerSources[st][tt.scope][tt.type][tt.source]))return;const Nt=this.workerSources[st][tt.scope][tt.type][tt.source];delete this.workerSources[st][tt.scope][tt.type][tt.source],Nt.removeSource!==void 0?Nt.removeSource(tt,Tt):Tt()}loadWorkerSource(st,tt,Tt){try{this.self.importScripts(tt.url),Tt()}catch(Nt){Tt(Nt.toString())}}syncRTLPluginState(st,tt,Tt){if(i.fG.isParsed())Tt(null,!0);else if(i.fG.isParsing())this.rtlPluginParsingListeners.push(Tt);else try{i.fG.setState(tt);const Nt=i.fG.getPluginURL();!i.fG.isLoaded()||i.fG.isParsed()||i.fG.isParsing()||Nt==null||(i.fG.setState({pluginStatus:i.fH.parsing,pluginURL:i.fG.getPluginURL()}),this.self.importScripts(Nt),i.fG.isParsed()?Tt(null,!0):this.rtlPluginParsingListeners.push(Tt))}catch(Nt){Tt(Nt.toString())}}setDracoUrl(st,tt){this.dracoUrl=tt}getAvailableImages(st,tt){this.availableImages[st]||(this.availableImages[st]={});let Tt=this.availableImages[st][tt];return Tt||(Tt=[]),Tt}getAvailableModels(st,tt){this.availableModels[st]||(this.availableModels[st]={});let Tt=this.availableModels[st][tt];return Tt||(Tt={}),Tt}getLayerIndex(st,tt){this.layerIndexes[st]||(this.layerIndexes[st]={});let Tt=this.layerIndexes[st][tt];return Tt||(Tt=this.layerIndexes[st][tt]=new vn,Tt.scope=tt),Tt}getWorkerSource(st,tt,Tt,Nt){const Wt=this.workerSources;return Wt[st]||(Wt[st]={}),Wt[st][Nt]||(Wt[st][Nt]={}),Wt[st][Nt][tt]||(Wt[st][Nt][tt]={}),this.isSpriteLoaded[st]||(this.isSpriteLoaded[st]={}),Wt[st][Nt][tt][Tt]||(Wt[st][Nt][tt][Tt]=new this.workerSourceTypes[tt]({send:(oe,ye,Jt,xe,ti,$e)=>this.actor.send(oe,ye,Jt,st,ti,$e),scheduler:this.actor.scheduler},this.getLayerIndex(st,Nt),this.getAvailableImages(st,Nt),this.getAvailableModels(st,Nt),this.isSpriteLoaded[st][Nt],void 0,this.brightness,this.worldview)),Wt[st][Nt][tt][Tt]}rasterizeImagesWorker(st,tt,Tt){const Nt=new Map;for(const[Wt,{image:oe,imageVariant:ye}]of tt.tasks.entries()){const Jt=this.imageRasterizer.rasterize(ye,oe,tt.scope,st);Nt.set(Wt,Jt)}Tt(void 0,Nt)}removeRasterizedImages(st,tt,Tt){this.imageRasterizer.removeImagesFromCacheByIds(tt.imageIds,tt.scope,st),Tt()}enforceCacheSizeLimit(st,tt){i.fI(tt)}getWorkerPerformanceMetrics(st,tt,Tt){Tt(void 0,void 0)}}return i.fE(self)&&(self.worker=new wo(self)),wo}),Ft(["./shared"],function(i){var Pe="3.16.0";const yi={create:"create",load:"load",fullLoad:"fullLoad"},tr={mark(p){performance.mark(p)},measure(p,e,a){performance.measure(p,e,a)}};function vn(p){const e=p.name.split("?")[0];return i.a(e)&&e.includes("mapbox-gl.js")?"javascript":i.a(e)&&e.includes("mapbox-gl.css")?"css":i.b(e)?"fontRange":i.c(e)?"sprite":i.i(e)?"style":i.d(e)?"tilejson":"other"}var on,Br={},Or=function(){if(on)return Br;function p(f){return!e(f)}function e(f){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var w,I,M=new Blob([""],{type:"text/javascript"}),L=URL.createObjectURL(M);try{I=new Worker(L),w=!0}catch{w=!1}return I&&I.terminate(),URL.revokeObjectURL(L),w}()?function(){var w=document.createElement("canvas");w.width=w.height=1;var I=w.getContext("2d");if(!I)return!1;var M=I.getImageData(0,0,1,1);return M&&M.width===w.width}()?(a[y=f&&f.failIfMajorPerformanceCaveat]===void 0&&(a[y]=function(w){var I,M=function(L){var N=document.createElement("canvas"),V=Object.create(p.webGLContextAttributes);return V.failIfMajorPerformanceCaveat=L,N.getContext("webgl2",V)}(w);if(!M)return!1;try{I=M.createShader(M.VERTEX_SHADER)}catch{return!1}return!(!I||M.isContextLost())&&(M.shaderSource(I,"void main() {}"),M.compileShader(I),M.getShaderParameter(I,M.COMPILE_STATUS)===!0)}(y)),a[y]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var y}on=1,Br.supported=p,Br.notSupportedReason=e;var a={};return p.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Br}();function Ri(p,e,a){const f=document.createElement(p);return e!=null&&(f.className=e),a&&a.appendChild(f),f}function Ve(p,e,a){const f=document.createElementNS("http://www.w3.org/2000/svg",p);for(const y of Object.keys(e))f.setAttributeNS(null,y,String(e[y]));return a&&a.appendChild(f),f}const Io=typeof document<"u"?document.documentElement&&document.documentElement.style:null,gr=Io&&Io.userSelect!==void 0?"userSelect":"WebkitUserSelect";let Yr;function Fn(){Io&&gr&&(Yr=Io[gr],Io[gr]="none")}function us(){Io&&gr&&(Io[gr]=Yr)}function ao(p){p.preventDefault(),p.stopPropagation(),window.removeEventListener("click",ao,!0)}function Do(){window.addEventListener("click",ao,!0),window.setTimeout(()=>{window.removeEventListener("click",ao,!0)},0)}function tl(p,e){const a=p.getBoundingClientRect();return nc(p,a,e)}function fa(p,e){const a=p.getBoundingClientRect(),f=[];for(let y=0;y<e.length;y++)f.push(nc(p,a,e[y]));return f}function Nl(p){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&p.button===2&&p.ctrlKey?0:p.button}function nc(p,e,a){const f=p.offsetWidth===e.width?1:p.offsetWidth/e.width;return new i.P((a.clientX-e.left)*f,(a.clientY-e.top)*f)}const Vl="01",Zr="NO_ACCESS_TOKEN";class bh{constructor(e,a,f){this._transformRequestFn=e,this._customAccessToken=a,this._silenceAuthErrors=!!f,this._createSkuToken()}_createSkuToken(){const e=function(){let a="";for(let f=0;f<10;f++)a+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Vl,a].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=e.token,this._skuTokenExpiresAt=e.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(e,a){return this._transformRequestFn&&this._transformRequestFn(e,a)||{url:e}}normalizeStyleURL(e,a){if(!i.h(e))return e;const f=so(e);return f.params.push(`sdk=js-${Pe}`),f.path=`/styles/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeGlyphsURL(e,a){if(!i.h(e))return e;const f=so(e);return f.path=`/fonts/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeModelURL(e,a){if(!i.h(e))return e;const f=so(e);return f.path=`/models/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeSourceURL(e,a,f,y){if(!i.h(e))return e;const w=so(e);return w.path=`/v4/${w.authority}.json`,w.params.push("secure"),f&&w.params.push(`language=${f}`),y&&w.params.push(`worldview=${y}`),this._makeAPIURL(w,this._customAccessToken||a)}normalizeIconsetURL(e,a){const f=so(e);return i.h(e)?(f.path=`/styles/v1${f.path}/iconset.pbf`,this._makeAPIURL(f,this._customAccessToken||a)):dn(f)}normalizeSpriteURL(e,a,f,y){const w=so(e);return i.h(e)?(w.path=`/styles/v1${w.path}/sprite${a}${f}`,this._makeAPIURL(w,this._customAccessToken||y)):(w.path+=`${a}${f}`,dn(w))}normalizeTileURL(e,a,f){if(this._isSkuTokenExpired()&&this._createSkuToken(),e&&!i.h(e))return e;const y=so(e);y.path=y.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${a||f&&y.authority!=="raster"&&f===512?"@2x":""}${i.k.supported?".webp":"$1"}`),y.authority==="raster"?y.path=`/${i.e.RASTER_URL_PREFIX}${y.path}`:y.authority==="rasterarrays"?y.path=`/${i.e.RASTERARRAYS_URL_PREFIX}${y.path}`:y.authority==="3dtiles"?y.path=`/${i.e.TILES3D_URL_PREFIX}${y.path}`:(y.path=y.path.replace(/^.+\/v4\//,"/"),y.path=`/${i.e.TILE_URL_VERSION}${y.path}`);const w=this._customAccessToken||function(I){for(const M of I){const L=M.match(/^access_token=(.*)$/);if(L)return L[1]}return null}(y.params)||i.e.ACCESS_TOKEN;return i.e.REQUIRE_ACCESS_TOKEN&&w&&this._skuToken&&y.params.push(`sku=${this._skuToken}`),this._makeAPIURL(y,w)}canonicalizeTileURL(e,a){const f=so(e);if(!f.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!f.path.match(/\.[\w]+$/))return e;let y="mapbox://";f.path.match(/^\/raster\/v1\//)?y+=`raster/${f.path.replace(`/${i.e.RASTER_URL_PREFIX}/`,"")}`:f.path.match(/^\/rasterarrays\/v1\//)?y+=`rasterarrays/${f.path.replace(`/${i.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:y+=`tiles/${f.path.replace(`/${i.e.TILE_URL_VERSION}/`,"")}`;let w=f.params;return a&&(w=w.filter(I=>!I.match(/^access_token=/))),w.length&&(y+=`?${w.join("&")}`),y}canonicalizeTileset(e,a){const f=!!a&&i.h(a),y=[];for(const w of e.tiles||[])i.j(w)?y.push(this.canonicalizeTileURL(w,f)):y.push(w);return y}_makeAPIURL(e,a){const f="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",y=so(i.e.API_URL);if(e.protocol=y.protocol,e.authority=y.authority,e.protocol==="http"){const w=e.params.indexOf("secure");w>=0&&e.params.splice(w,1)}if(y.path!=="/"&&(e.path=`${y.path}${e.path}`),!i.e.REQUIRE_ACCESS_TOKEN)return dn(e);if(a=a||i.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!a)throw new Error(`An API access token is required to use Mapbox GL. ${f}`);if(a[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${f}`)}return e.params=e.params.filter(w=>w.indexOf("access_token")===-1),e.params.push(`access_token=${a||""}`),dn(e)}}const ws=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function so(p){const e=p.match(ws);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function dn(p){const e=p.params.length?`?${p.params.join("&")}`:"";return`${p.protocol}://${p.authority}${p.path}${e}`}const Fo="mapbox.eventData";function Ln(p){if(!p)return null;const e=p.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(i.l(e[1]))}catch{return null}}class Ea{constructor(e){this.type=e,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const a=Ln(i.e.ACCESS_TOKEN);let f="";return f=a&&a.u?i.f(a.u):i.e.ACCESS_TOKEN||"",e?`${Fo}.${e}:${f}`:`${Fo}:${f}`}fetchEventData(){const e=i.s("localStorage"),a=this.getStorageKey(),f=this.getStorageKey("uuid"),y=this.getStorageKey("uuidTimestamp");if(e)try{const w=localStorage.getItem(a);w&&(this.eventData=JSON.parse(w));const I=localStorage.getItem(f);I&&(this.anonId=I);const M=localStorage.getItem(y);M&&(this.anonIdTimestamp=Number(M));const L=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<L)&&this.refreshUUID()}catch{i.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=i.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const e=i.s("localStorage"),a=this.getStorageKey(),f=this.getStorageKey("uuid"),y=this.getStorageKey("uuidTimestamp"),w=this.anonId,I=this.anonIdTimestamp;if(e&&w)try{localStorage.setItem(f,w),Object.keys(this.eventData).length>=1&&localStorage.setItem(a,JSON.stringify(this.eventData)),I&&localStorage.setItem(y,I.toString())}catch{i.w("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,a,f,y){if(!i.e.EVENTS_URL)return;const w=so(i.e.EVENTS_URL);w.params.push(`access_token=${y||i.e.ACCESS_TOKEN||""}`);const I={event:this.type,created:new Date(e).toISOString()},M=a?Object.assign(I,a):I,L={url:dn(w),headers:{"Content-Type":"text/plain"},body:JSON.stringify([M])};this.pendingRequest=i.p(L,N=>{this.pendingRequest=null,f(N),this.saveEventData(),this.processRequests(y)})}queueRequest(e,a){this.queue.push(e),this.processRequests(a)}}const js=new class extends Ea{constructor(p){super("appUserTurnstile"),this._customAccessToken=p}postTurnstileEvent(p,e){i.e.EVENTS_URL&&i.e.ACCESS_TOKEN&&Array.isArray(p)&&p.some(a=>i.h(a)||i.j(a))&&this.queueRequest(Date.now(),e)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=Ln(i.e.ACCESS_TOKEN),a=e?e.u:i.e.ACCESS_TOKEN;let f=a!==this.eventData.tokenU;i.v(this.anonId)||(this.refreshUUID(),f=!0);const y=this.queue.shift();if(this.eventData.lastSuccess){const w=new Date(this.eventData.lastSuccess),I=new Date(y),M=(y-this.eventData.lastSuccess)/864e5;f=f||M>=1||M<-1||w.getDate()!==I.getDate()}else f=!0;f?this.postEvent(y,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Pe,skuId:Vl,"enabled.telemetry":!1,userId:this.anonId},w=>{w||(this.eventData.lastSuccess=y,this.eventData.tokenU=a)},p):this.processRequests()}},Js=js.postTurnstileEvent.bind(js),Jn=new class extends Ea{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(p,e,a,f){this.skuToken=e,this.errorCb=f,i.e.EVENTS_URL&&(a||i.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},a):this.errorCb(new Error(Zr)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:a}=this.queue.shift();e&&this.success[e]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),i.v(this.anonId)||this.refreshUUID(),this.postEvent(a,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Pe,skuId:Vl,skuToken:this.skuToken,userId:this.anonId},f=>{f?this.errorCb(f):e&&(this.success[e]=!0)},p))}remove(){this.errorCb=null}},Ks=Jn.postMapLoadEvent.bind(Jn),Ul=new class extends Ea{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(p){let e=this.mapInstanceIdMap.get(p);return e||(e=i.u(),this.mapInstanceIdMap.set(p,e)),e}getEventId(p){const e=this.eventIdPerMapInstanceMap.get(p)||0;return this.eventIdPerMapInstanceMap.set(p,e+1),e}postStyleLoadEvent(p,e){const{map:a,style:f,importedStyles:y}=e;if(!i.e.EVENTS_URL||!p&&!i.e.ACCESS_TOKEN)return;const w=this.getMapInstanceId(a),I={mapInstanceId:w,eventId:this.getEventId(w),style:f};y.length&&(I.importedStyles=y),this.queueRequest({timestamp:Date.now(),payload:I},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,payload:a}=this.queue.shift();this.postEvent(e,a,()=>{},p)}},Qs=Ul.postStyleLoadEvent.bind(Ul),ja=new class extends Ea{constructor(p){super("metrics"),p&&(this.data=p)}postMetricsEvent(p){if(!i.e.EVENTS_URL||!p&&!i.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),i.v(this.anonId)||this.refreshUUID();const e=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:e},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,payload:a}=this.queue.shift();this.postEvent(e,a,()=>{},p)}}({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),Wo=ja.postMetricsEvent.bind(ja),bn=new class extends Ea{constructor(){super("gljs.performance")}postPerformanceEvent(p,e){i.e.EVENTS_URL&&(p||i.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:e},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,performanceData:a}=this.queue.shift(),f=function(y){const w=performance.getEntriesByType("resource"),I=performance.getEntriesByType("mark"),M=function(X){const Q={};if(X){for(const nt in X)if(nt!=="other")for(const ht of X[nt]){const lt=`${nt}ResolveRangeMin`,_t=`${nt}ResolveRangeMax`,Ct=`${nt}RequestCount`,bt=`${nt}RequestCachedCount`;Q[lt]=Math.min(Q[lt]||1/0,ht.startTime),Q[_t]=Math.max(Q[_t]||-1/0,ht.responseEnd);const Gt=zt=>{Q[zt]===void 0&&(Q[zt]=0),++Q[zt]};ht.transferSize!==void 0&&ht.transferSize===0&&Gt(bt),Gt(Ct)}}return Q}(function(X,Q){const nt={};if(X)for(const ht of X){const lt=Q(ht);nt[lt]===void 0&&(nt[lt]=[]),nt[lt].push(ht)}return nt}(w,vn)),L=window.devicePixelRatio,N=navigator.connection||navigator.mozConnection||navigator.webkitConnection,V=N?N.effectiveType:void 0,Z={counters:[],metadata:[],attributes:[]},U=(X,Q,nt)=>{nt!=null&&X.push({name:Q,value:nt.toString()})};for(const X in M)U(Z.counters,X,M[X]);if(y.interactionRange[0]!==1/0&&y.interactionRange[1]!==-1/0&&(U(Z.counters,"interactionRangeMin",y.interactionRange[0]),U(Z.counters,"interactionRangeMax",y.interactionRange[1])),I)for(const X of Object.values(yi)){const Q=I.find(nt=>nt.name===X);Q&&U(Z.counters,X,Q.startTime)}return U(Z.counters,"visibilityHidden",y.visibilityHidden),U(Z.attributes,"style",function(X){if(X)for(const Q of X){const nt=Q.name.split("?")[0];if(i.i(nt)){const ht=nt.split("/").slice(-2);if(ht.length===2)return`mapbox://styles/${ht[0]}/${ht[1]}`}}}(w)),U(Z.attributes,"terrainEnabled",y.terrainEnabled?"true":"false"),U(Z.attributes,"fogEnabled",y.fogEnabled?"true":"false"),U(Z.attributes,"projection",y.projection),U(Z.attributes,"zoom",y.zoom),U(Z.metadata,"devicePixelRatio",L),U(Z.metadata,"connectionEffectiveType",V),U(Z.metadata,"navigatorUserAgent",navigator.userAgent),U(Z.metadata,"screenWidth",window.screen.width),U(Z.metadata,"screenHeight",window.screen.height),U(Z.metadata,"windowWidth",window.innerWidth),U(Z.metadata,"windowHeight",window.innerHeight),U(Z.metadata,"mapWidth",y.width/L),U(Z.metadata,"mapHeight",y.height/L),U(Z.metadata,"webglRenderer",y.renderer),U(Z.metadata,"webglVendor",y.vendor),U(Z.metadata,"sdkVersion",Pe),U(Z.metadata,"sdkIdentifier","mapbox-gl-js"),Z}(a);for(const y of f.metadata);for(const y of f.counters);for(const y of f.attributes);this.postEvent(e,f,()=>{},p)}},ho=bn.postPerformanceEvent.bind(bn),qo=new class extends Ea{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(p,e,a,f){if(!i.e.API_URL||!i.e.SESSION_PATH)return;const y=so(i.e.API_URL+i.e.SESSION_PATH);y.params.push(`sku=${e||""}`),y.params.push(`access_token=${f||i.e.ACCESS_TOKEN||""}`);const w={url:dn(y),headers:{"Content-Type":"text/plain"}};this.pendingRequest=i.g(w,I=>{this.pendingRequest=null,a(I),this.saveEventData(),this.processRequests(f)})}getSessionAPI(p,e,a,f){this.skuToken=e,this.errorCb=f,i.e.SESSION_PATH&&i.e.API_URL&&(a||i.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},a):this.errorCb(new Error(Zr)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:a}=this.queue.shift();e&&this.success[e]||this.getSession(a,this.skuToken,f=>{f?this.errorCb(f):e&&(this.success[e]=!0)},p)}remove(){this.errorCb=null}},ma=qo.getSessionAPI.bind(qo),Kn=new Set;function vo(p,e){e?Kn.add(p):Kn.delete(p)}class ns{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(e,a){this._updatedSourceCaches[e]=a,this.setDirty()}discardSourceCacheUpdate(e){delete this._updatedSourceCaches[e]}updateLayer(e){const a=e.scope;this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._updatedLayers[a].add(e.id),this.setDirty()}removeLayer(e){const a=e.scope;this._removedLayers[a]=this._removedLayers[a]||{},this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._removedLayers[a][e.id]=e,this._updatedLayers[a].delete(e.id),this._updatedPaintProps.delete(e.fqid),this.setDirty()}getRemovedLayer(e){return this._removedLayers[e.scope]?this._removedLayers[e.scope][e.id]:null}discardLayerRemoval(e){this._removedLayers[e.scope]&&delete this._removedLayers[e.scope][e.id]}getLayerUpdatesByScope(){const e={};for(const a in this._updatedLayers)e[a]=e[a]||{},e[a].updatedIds=Array.from(this._updatedLayers[a].values());for(const a in this._removedLayers)e[a]=e[a]||{},e[a].removedIds=Object.keys(this._removedLayers[a]);return e}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(e){this._updatedPaintProps.add(e.fqid),this.setDirty()}getUpdatedImages(e){return this._updatedImages[e]?Array.from(this._updatedImages[e].values()):[]}updateImage(e,a){this._updatedImages[a]=this._updatedImages[a]||new Set,this._updatedImages[a].add(i.I.toString(e)),this.setDirty()}resetUpdatedImages(e){this._updatedImages[e]&&this._updatedImages[e].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Ds(p){const{userImage:e}=p;return!!(e&&e.render&&e.render())&&(p.data.replace(new Uint8Array(e.data.buffer)),!0)}class lo extends i.E{constructor(e){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=e,e!=="raster"&&i.r()&&(this.imageRasterizerDispatcher=new i.D(i.t(),this,"Image Rasterizer Worker",1))}addScope(e){this.loaded.set(e,!1),this.imageProviders.set(e,new Map),this.images.set(e,new Map),this.updatedImages.set(e,new Set),this.callbackDispatchedThisFrame.set(e,new Set),this.patterns.set(e,new Map),this.atlasImage.set(e,new i.q({width:1,height:1}))}removeScope(e){this.loaded.delete(e),this.imageProviders.delete(e),this.images.delete(e),this.updatedImages.delete(e),this.callbackDispatchedThisFrame.delete(e),this.patterns.delete(e),this.atlasImage.delete(e);const a=this.atlasTexture.get(e);a&&(a.destroy(),this.atlasTexture.delete(e))}addImageProvider(e,a){this.imageProviders.has(a)||this.imageProviders.set(a,new Map),this.imageProviders.get(a).set(e.id,e)}removeImageProvider(e,a){this.imageProviders.has(a)&&this.imageProviders.get(a).delete(e)}getPendingImageProviders(){const e=[];for(const a of this.imageProviders.values())for(const f of a.values())f.hasPendingRequests()&&e.push(f);return e}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new i.x),this._imageRasterizer}isLoaded(){for(const e of this.loaded.keys())if(!this.loaded.get(e))return!1;return!0}setLoaded(e,a){if(this.loaded.get(a)!==e&&(this.loaded.set(a,e),e)){for(const{ids:f,callback:y}of this.requestors)this._notify(f,a,y);this.requestors=[]}}hasImage(e,a){return!!this.getImage(e,a)}getImage(e,a){return this.images.get(a).get(e.toString())}addImage(e,a,f){this._validate(e,f)&&this.images.get(a).set(e.toString(),f)}_validate(e,a){let f=!0;return this._validateStretch(a.stretchX,a.data&&a.data.width)||(this.fire(new i.y(new Error(`Image "${e.name}" has invalid "stretchX" value`))),f=!1),this._validateStretch(a.stretchY,a.data&&a.data.height)||(this.fire(new i.y(new Error(`Image "${e.name}" has invalid "stretchY" value`))),f=!1),this._validateContent(a.content,a)||(this.fire(new i.y(new Error(`Image "${e.name}" has invalid "content" value`))),f=!1),f}_validateStretch(e,a){if(!e)return!0;let f=0;for(const y of e){if(y[0]<f||y[1]<y[0]||a<y[1])return!1;f=y[1]}return!0}_validateContent(e,a){return e?e.length!==4||!a.usvg&&(e[0]<0||a.data.width<e[0]||e[1]<0||a.data.height<e[1]||e[2]<0||a.data.width<e[2]||e[3]<0||a.data.height<e[3])?!1:!(e[2]<e[0]||e[3]<e[1]):!0}updateImage(e,a,f){const y=this.images.get(a).get(e.toString());f.version=y.version+1,this.images.get(a).set(e.toString(),f),this.updatedImages.get(a).add(e),this.removeFromImageRasterizerCache(e,a)}clearUpdatedImages(e){this.updatedImages.get(e).clear()}removeFromImageRasterizerCache(e,a){this.spriteFormat!=="raster"&&(i.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[e],scope:a}):this.imageRasterizer.removeImagesFromCacheByIds([e],a))}removeImage(e,a){const f=this.images.get(a),y=f.get(e.toString());f.delete(e.toString()),this.patterns.get(a).delete(e.toString()),this.removeFromImageRasterizerCache(e,a),y.userImage&&y.userImage.onRemove&&y.userImage.onRemove()}listImages(e){return Array.from(this.images.get(e).keys()).map(a=>i.I.from(a))}getImages(e,a,f){const y=[],w=[],I=this.imageProviders.get(a);for(const V of e){if(!V.iconsetId){y.push(V);continue}const Z=I.get(V.iconsetId);Z&&(this.getImage(V,a)?w.push(V):Z.addPendingRequest(V))}if(y.length===0)return void this._notify(w,a,f);let M=!0;const L=!!this.loaded.get(a),N=this.images.get(a);if(!L)for(const V of y)N.has(V.toString())||(M=!1);L||M?this._notify(y,a,f):this.requestors.push({ids:y,scope:a,callback:f})}rasterizeImages(e,a){const f=new Map,{tasks:y,scope:w}=e;for(const[I,M]of y.entries()){const L=this.getImage(M.id,w);L&&f.set(I,{image:L,imageVariant:M})}this._rasterizeImages(w,f,a)}_rasterizeImages(e,a,f){if(i.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:a,scope:e},f);else{const y=new Map;for(const[w,{image:I,imageVariant:M}]of a.entries())y.set(w,this.imageRasterizer.rasterize(M,I,e,0));f(void 0,y)}}getUpdatedImages(e){return this.updatedImages.get(e)||new Set}_notify(e,a,f){const y=this.images.get(a),w=new Map;for(const I of e){if(!y.get(I.toString())){if(I.iconsetId)continue;this.fire(new i.z("styleimagemissing",{id:I.name}))}const M=y.get(I.toString());if(!M){i.w(`Image "${I.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const L={data:M.usvg?null:M.data.clone(),pixelRatio:M.pixelRatio,sdf:M.sdf,usvg:M.usvg,version:M.version,stretchX:M.stretchX,stretchY:M.stretchY,content:M.content,hasRenderCallback:!!(M.userImage&&M.userImage.render)};M.usvg&&Object.assign(L,{width:M.icon.usvg_tree.width,height:M.icon.usvg_tree.height}),w.set(i.I.toString(I),L)}f(null,w)}getPixelSize(e){const{width:a,height:f}=this.atlasImage.get(e);return{width:a,height:f}}getPattern(e,a,f){const y=e.toString(),w=this.patterns.get(a),I=w.get(y),M=this.getImage(e,a);if(!M)return null;if(I){if(I.position.version===M.version)return I.position;I.position.version=M.version}else{if(M.usvg&&!M.data){const L=this.getPatternInFlightId(y,a);if(this.patternsInFlight.has(L))return null;this.patternsInFlight.add(L);const N=new i.A(e).scaleSelf(i.o.devicePixelRatio),V=new Map([[N.toString(),{image:M,imageVariant:N}]]);return this._rasterizeImages(a,V,(Z,U)=>this.storePatternImage(N,a,M,f,U)),null}this.storePattern(e,a,M)}return this._updatePatternAtlas(a,f),w.get(y).position}getPatternInFlightId(e,a){return i.B(e,a)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(e,a,f,y,w){const I=e.toString(),M=w?w.get(I):void 0;M&&(f.data=M,this.storePattern(e.id,a,f),this._updatePatternAtlas(a,y),this.patternsInFlight.delete(this.getPatternInFlightId(e.id.toString(),a)))}storePattern(e,a,f){const y={w:f.data.width+2*i.C,h:f.data.height+2*i.C,x:0,y:0},w=new i.F(y,f,i.C);this.patterns.get(a).set(e.toString(),{bin:y,position:w})}destroyAtlasTextures(){for(const e of this.atlasTexture.values())e&&e.destroy();this.atlasTexture.clear()}bind(e,a){const f=e.gl;let y=this.atlasTexture.get(a);y?this.dirty&&(y.update(this.atlasImage.get(a)),this.dirty=!1):(y=new i.T(e,this.atlasImage.get(a),f.RGBA8),this.atlasTexture.set(a,y)),y.bind(f.LINEAR,f.CLAMP_TO_EDGE)}_updatePatternAtlas(e,a){const f=this.patterns.get(e),y=Array.from(f.values()).map(({bin:N})=>N),{w,h:I}=i.G(y),M=this.atlasImage.get(e);M.resize({width:w||1,height:I||1});const L=this.images.get(e);for(const[N,{bin:V,position:Z}]of f.entries()){let U=Z.padding;const X=V.x+U,Q=V.y+U,nt=L.get(N).data,ht=nt.width,lt=nt.height;U=U>1?U-1:U,i.q.copy(nt,M,{x:0,y:0},{x:X,y:Q},{width:ht,height:lt},a),i.q.copy(nt,M,{x:0,y:lt-U},{x:X,y:Q-U},{width:ht,height:U},a),i.q.copy(nt,M,{x:0,y:0},{x:X,y:Q+lt},{width:ht,height:U},a),i.q.copy(nt,M,{x:ht-U,y:0},{x:X-U,y:Q},{width:U,height:lt},a),i.q.copy(nt,M,{x:0,y:0},{x:X+ht,y:Q},{width:U,height:lt},a),i.q.copy(nt,M,{x:ht-U,y:lt-U},{x:X-U,y:Q-U},{width:U,height:U},a),i.q.copy(nt,M,{x:0,y:lt-U},{x:X+ht,y:Q-U},{width:U,height:U},a),i.q.copy(nt,M,{x:0,y:0},{x:X+ht,y:Q+lt},{width:U,height:U},a),i.q.copy(nt,M,{x:ht-U,y:0},{x:X-U,y:Q+lt},{width:U,height:U},a)}this.dirty=!0}beginFrame(){for(const e of this.images.keys())this.callbackDispatchedThisFrame.set(e,new Set)}dispatchRenderCallbacks(e,a){const f=this.images.get(a);for(const y of e){if(this.callbackDispatchedThisFrame.get(a).has(y.toString()))continue;this.callbackDispatchedThisFrame.get(a).add(y.toString());const w=f.get(y.toString());Ds(w)&&this.updateImage(y,a,w)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Zn(p){const e=p.value,a=p.valueSpec,f=p.style,y=p.styleSpec,w=p.key,I=p.arrayElementValidator||le;if(!Array.isArray(e))return[new i.V(w,e,`array expected, ${i.K(e)} found`)];if(a.length&&e.length!==a.length)return[new i.V(w,e,`array length ${a.length} expected, length ${e.length} found`)];if(a["min-length"]&&e.length<a["min-length"])return[new i.V(w,e,`array length at least ${a["min-length"]} expected, length ${e.length} found`)];let M={type:a.value,values:a.values,minimum:a.minimum,maximum:a.maximum,function:void 0};y.$version<7&&(M.function=a.function),i.H(a.value)&&(M=a.value);let L=[];for(let N=0;N<e.length;N++)L=L.concat(I({array:e,arrayIndex:N,value:e[N],valueSpec:M,style:f,styleSpec:y,key:`${w}[${N}]`},!0));return L}function el(p){const e=p.key,a=p.value,f=p.valueSpec;if(!i.L(a))return[new i.V(e,a,`number expected, ${i.K(a)} found`)];if(a!=a)return[new i.V(e,a,"number expected, NaN found")];if("minimum"in f){let y=f.minimum;if(Array.isArray(f.minimum)&&(y=f.minimum[p.arrayIndex]),a<y)return[new i.V(e,a,`${a} is less than the minimum value ${y}`)]}if("maximum"in f){let y=f.maximum;if(Array.isArray(f.maximum)&&(y=f.maximum[p.arrayIndex]),a>y)return[new i.V(e,a,`${a} is greater than the maximum value ${y}`)]}return[]}function jl(p){const e=p.key,a=p.value;if(!i.H(a))return[new i.V(e,a,`object expected, ${i.K(a)} found`)];const f=p.valueSpec,y=i.J(a.type);let w,I,M,L={};const N=y!=="categorical"&&a.property===void 0,V=!N,Z=function(nt){const ht=nt.stops;return Array.isArray(ht)&&Array.isArray(ht[0])&&i.H(ht[0][0])}(a),U=Re({key:p.key,value:p.value,valueSpec:p.styleSpec.function,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{stops:function(nt){if(y==="identity")return[new i.V(nt.key,nt.value,'identity function may not have a "stops" property')];let ht=[];const lt=nt.value;return ht=ht.concat(Zn({key:nt.key,value:lt,valueSpec:nt.valueSpec,style:nt.style,styleSpec:nt.styleSpec,arrayElementValidator:X})),Array.isArray(lt)&&lt.length===0&&ht.push(new i.V(nt.key,lt,"array must have at least one stop")),ht},default:function(nt){return le({key:nt.key,value:nt.value,valueSpec:f,style:nt.style,styleSpec:nt.styleSpec})}}});return y==="identity"&&N&&U.push(new i.V(p.key,p.value,'missing required property "property"')),y==="identity"||a.stops||U.push(new i.V(p.key,p.value,'missing required property "stops"')),y==="exponential"&&f.expression&&!i.M(f)&&U.push(new i.V(p.key,p.value,"exponential functions not supported")),p.styleSpec.$version>=8&&(V&&!i.N(f)?U.push(new i.V(p.key,p.value,"property functions not supported")):N&&!i.O(f)&&U.push(new i.V(p.key,p.value,"zoom functions not supported"))),y!=="categorical"&&!Z||a.property!==void 0||U.push(new i.V(p.key,p.value,'"property" property is required')),U;function X(nt){let ht=[];const lt=nt.value,_t=nt.key;if(!Array.isArray(lt))return[new i.V(_t,lt,`array expected, ${i.K(lt)} found`)];if(lt.length!==2)return[new i.V(_t,lt,`array length 2 expected, length ${lt.length} found`)];if(Z){if(!i.H(lt[0]))return[new i.V(_t,lt,`object expected, ${i.K(lt[0])} found`)];const Ct=lt[0];if(Ct.zoom===void 0)return[new i.V(_t,lt,"object stop key must have zoom")];if(Ct.value===void 0)return[new i.V(_t,lt,"object stop key must have value")];const bt=i.J(Ct.zoom);if(typeof bt!="number")return[new i.V(_t,Ct.zoom,"stop zoom values must be numbers")];if(M&&M>bt)return[new i.V(_t,Ct.zoom,"stop zoom values must appear in ascending order")];bt!==M&&(M=bt,I=void 0,L={}),ht=ht.concat(Re({key:`${_t}[0]`,value:lt[0],valueSpec:{zoom:{}},style:nt.style,styleSpec:nt.styleSpec,objectElementValidators:{zoom:el,value:Q}}))}else ht=ht.concat(Q({key:`${_t}[0]`,value:lt[0],style:nt.style,styleSpec:nt.styleSpec},lt));return i.Q(i.S(lt[1]))?ht.concat([new i.V(`${_t}[1]`,lt[1],"expressions are not allowed in function stops.")]):ht.concat(le({key:`${_t}[1]`,value:lt[1],valueSpec:f,style:nt.style,styleSpec:nt.styleSpec}))}function Q(nt,ht){const lt=i.K(nt.value),_t=i.J(nt.value),Ct=nt.value!==null?nt.value:ht;if(w){if(lt!==w)return[new i.V(nt.key,Ct,`${lt} stop domain type must match previous stop domain type ${w}`)]}else w=lt;if(lt!=="number"&&lt!=="string"&&lt!=="boolean"&&typeof _t!="number"&&typeof _t!="string"&&typeof _t!="boolean")return[new i.V(nt.key,Ct,"stop domain value must be a number, string, or boolean")];if(lt!=="number"&&y!=="categorical"){let bt=`number expected, ${lt} found`;return i.N(f)&&y===void 0&&(bt+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new i.V(nt.key,Ct,bt)]}return y!=="categorical"||lt!=="number"||typeof _t=="number"&&isFinite(_t)&&Math.floor(_t)===_t?y!=="categorical"&&lt==="number"&&typeof _t=="number"&&typeof I=="number"&&I!==void 0&&_t<I?[new i.V(nt.key,Ct,"stop domain values must appear in ascending order")]:(I=_t,y==="categorical"&&_t in L?[new i.V(nt.key,Ct,"stop domain values must be unique")]:(L[_t]=!0,[])):[new i.V(nt.key,Ct,`integer expected, found ${String(_t)}`)]}}function Ts(p){const e=(p.expressionContext==="property"?i.W:i.U)(i.S(p.value),p.valueSpec);if(e.result==="error")return e.value.map(f=>new i.V(`${p.key}${f.key}`,p.value,f.message));const a=e.value.expression||e.value._styleExpression.expression;if(p.expressionContext==="property"&&p.propertyKey==="text-font"&&!a.outputDefined())return[new i.V(p.key,p.value,`Invalid data expression for "${p.propertyKey}". Output values must be contained as literals within the expression.`)];if(p.expressionContext==="property"&&p.propertyType==="layout"&&!i.Z(a))return[new i.V(p.key,p.value,'"feature-state" data expressions are not supported with layout properties.')];if(p.expressionContext==="filter")return ga(a,p);if(p.expressionContext==="appearance")return Gl(a,p);if(p.expressionContext&&p.expressionContext.indexOf("cluster")===0){if(!i.X(a,["zoom","feature-state"]))return[new i.V(p.key,p.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(p.expressionContext==="cluster-initial"&&!i.Y(a))return[new i.V(p.key,p.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ga(p,e){const a=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(e.valueSpec&&e.valueSpec.expression)for(const y of e.valueSpec.expression.parameters)a.delete(y);if(a.size===0)return[];const f=[];return p instanceof i._&&a.has(p.name)?[new i.V(e.key,e.value,`["${p.name}"] expression is not supported in a filter for a ${e.object.type} layer with id: ${e.object.id}`)]:(p.eachChild(y=>{f.push(...ga(y,e))}),f)}function Gl(p,e){const a=new Set;if(e.valueSpec&&e.valueSpec.expression)for(const y of e.valueSpec.expression.parameters)a.add(y);if(a.size===0)return[];const f=[];return p instanceof i._&&!a.has(p.name)?[new i.V(e.key,e.value,`["${p.name}"] is not an allowed parameter`)]:(p.eachChild(y=>{f.push(...Gl(y,e))}),f)}function ds(p){const e=p.key,a=p.value,f=p.valueSpec,y=[];return Array.isArray(f.values)?f.values.indexOf(i.J(a))===-1&&y.push(new i.V(e,a,`expected one of [${f.values.join(", ")}], ${JSON.stringify(a)} found`)):Object.keys(f.values).indexOf(i.J(a))===-1&&y.push(new i.V(e,a,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(a)} found`)),y}function Ss(p){return i.a2(i.S(p.value))?Ts(Object.assign({},p,{expressionContext:"filter",valueSpec:p.styleSpec[`filter_${p.layerType||"fill"}`]})):il(p)}function il(p){const e=p.value,a=p.key;if(!Array.isArray(e))return[new i.V(a,e,`array expected, ${i.K(e)} found`)];if(e.length<1)return[new i.V(a,e,"filter array must have at least 1 element")];const f=p.styleSpec;let y=ds({key:`${a}[0]`,value:e[0],valueSpec:f.filter_operator});switch(i.J(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&i.J(e[1])==="$type"&&y.push(new i.V(a,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&y.push(new i.V(a,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(i.a0(e[1])||y.push(new i.V(`${a}[1]`,e[1],`string expected, ${i.K(e[1])} found`)));for(let w=2;w<e.length;w++)i.J(e[1])==="$type"?y=y.concat(ds({key:`${a}[${w}]`,value:e[w],valueSpec:f.geometry_type})):i.a0(e[w])||i.L(e[w])||i.$(e[w])||y.push(new i.V(`${a}[${w}]`,e[w],`string, number, or boolean expected, ${i.K(e[w])} found.`));break;case"any":case"all":case"none":for(let w=1;w<e.length;w++)y=y.concat(il({key:`${a}[${w}]`,value:e[w],style:p.style,styleSpec:p.styleSpec}));break;case"has":case"!has":e.length!==2?y.push(new i.V(a,e,`filter array for "${e[0]}" operator must have 2 elements`)):i.a0(e[1])||y.push(new i.V(`${a}[1]`,e[1],`string expected, ${i.K(e[1])} found`))}return y}function Sl(p,e){const a=p.key,f=p.style,y=p.layer,w=p.styleSpec,I=p.value,M=p.objectKey,L=w[`${e}_${p.layerType}`];if(!L)return[];const N=M.match(/^(.*)-use-theme$/);if(N&&L[N[1]])return i.Q(i.S(I))?[].concat(le({key:a,value:I,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:f,styleSpec:w,expressionContext:"property",propertyType:e,propertyKey:M})):le({key:a,value:I,valueSpec:{type:"string"},style:f,styleSpec:w});const V=M.match(/^(.*)-transition$/);if(e==="paint"&&V&&L[V[1]]&&L[V[1]].transition)return le({key:a,value:I,valueSpec:w.transition,style:f,styleSpec:w});const Z=p.valueSpec||L[M];if(!Z)return[new i.a3(a,I,`unknown property "${M}"`)];let U;if(i.a0(I)&&i.N(Z)&&!Z.tokens&&(U=/^{([^}]+)}$/.exec(I))){const Q=`\`{ "type": "identity", "property": ${U?JSON.stringify(U[1]):'"_"'} }\``;return[new i.V(a,I,`"${M}" does not support interpolation syntax
Use an identity property function instead: ${Q}.`)]}const X=[];if(p.layerType==="symbol")M!=="text-field"||!f||f.glyphs||f.imports||X.push(new i.V(a,I,'use of "text-field" requires a style "glyphs" property')),M==="text-font"&&i.a4(i.S(I))&&i.J(I.type)==="identity"&&X.push(new i.V(a,I,'"text-font" does not support identity functions'));else if(p.layerType==="model"&&e==="paint"&&y&&y.layout&&y.layout.hasOwnProperty("model-id")&&i.N(Z)&&(i.a5(Z)||i.O(Z))){const Q=i.W(i.S(I),Z).value,nt="expression"in Q&&Q.expression||"_styleExpression"in Q&&Q._styleExpression&&Q._styleExpression.expression;nt&&!i.X(nt,["measure-light"])&&(M==="model-emissive-strength"&&i.Y(nt)&&i.Z(nt)||X.push(new i.V(a,I,`${M} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return X.concat(le({key:p.key,value:I,valueSpec:Z,style:f,styleSpec:w,expressionContext:"property",propertyType:e,propertyKey:M}))}function Il(p){return Sl(p,"paint")}function zs(p){return Sl(p,"layout")}function rl(p){let e=[];const a=p.value,f=p.key,y=p.style,w=p.styleSpec;if(!i.H(a))return[new i.V(f,a,"object expected")];a.type||a.ref||e.push(new i.V(f,a,'either "type" or "ref" is required'));let I=i.J(a.type);const M=i.J(a.ref);if(a.id){const L=i.J(a.id);for(let N=0;N<p.arrayIndex;N++){const V=y.layers[N];i.J(V.id)===L&&e.push(new i.V(f,a.id,`duplicate layer id "${L}", previously used at line ${V.id.__line__}`))}}if("ref"in a){let L;["type","source","source-layer","filter","layout"].forEach(N=>{N in a&&e.push(new i.V(f,a[N],`"${N}" is prohibited for ref layers`))}),y.layers.forEach(N=>{i.J(N.id)===M&&(L=N)}),L?L.ref?e.push(new i.V(f,a.ref,"ref cannot reference another ref layer")):I=i.J(L.type):typeof M=="string"&&e.push(new i.V(f,a.ref,`ref layer "${M}" not found`))}else if(I!=="background"&&I!=="sky"&&I!=="slot")if(a.source)if(i.a0(a.source)){const L=y.sources&&y.sources[a.source],N=L&&i.J(L.type);L?N==="vector"&&I==="raster"?e.push(new i.V(f,a.source,`layer "${a.id}" requires a raster source`)):N==="raster"&&I!=="raster"?e.push(new i.V(f,a.source,`layer "${a.id}" requires a vector source`)):N!=="vector"||a["source-layer"]?N==="raster-dem"&&I!=="hillshade"?e.push(new i.V(f,a.source,"raster-dem source can only be used with layer type 'hillshade'.")):N!=="raster-array"||["raster","raster-particle"].includes(I)?I==="line"&&a.paint&&(a.paint["line-gradient"]||a.paint["line-trim-offset"])&&N==="geojson"&&!L.lineMetrics?e.push(new i.V(f,a,`layer "${a.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):I==="raster-particle"&&N!=="raster-array"&&e.push(new i.V(f,a.source,`layer "${a.id}" requires a 'raster-array' source.`)):e.push(new i.V(f,a.source,"raster-array source can only be used with layer type 'raster'.")):e.push(new i.V(f,a,`layer "${a.id}" must specify a "source-layer"`)):e.push(new i.V(f,a.source,`source "${a.source}" not found`))}else e.push(new i.V(`${f}.source`,a.source,'"source" must be a string'));else e.push(new i.V(f,a,'missing required property "source"'));return e=e.concat(Re({key:f,value:a,valueSpec:w.layer,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{"*":()=>[],type:()=>le({key:`${f}.type`,value:a.type,valueSpec:w.layer.type,style:p.style,styleSpec:p.styleSpec,object:a,objectKey:"type"}),filter:L=>Ss(Object.assign({layerType:I},L)),layout:L=>Re({layer:a,key:L.key,value:L.value,valueSpec:{},style:L.style,styleSpec:L.styleSpec,objectElementValidators:{"*":N=>zs(Object.assign({layerType:I},N))}}),paint:L=>Re({layer:a,key:L.key,value:L.value,valueSpec:{},style:L.style,styleSpec:L.styleSpec,objectElementValidators:{"*":N=>Il(Object.assign({layerType:I,layer:a},N))}}),appearances(L){const N=Zn({key:L.key,value:L.value,valueSpec:L.valueSpec,style:L.style,styleSpec:L.styleSpec,arrayElementValidator:U=>function(X){const{key:Q,layer:nt,layerType:ht}=X,lt=i.J(X.value),_t=i.J(lt.name),Ct=i.J(lt.condition),bt=Re({key:Q,value:lt,valueSpec:X.styleSpec.appearance,style:X.style,styleSpec:X.styleSpec,objectElementValidators:{condition:Gt=>function(zt){const Zt=[];return Zt.push(...Ts({key:zt.key,value:zt.object.condition,valueSpec:i.a6.appearance.condition,expressionContext:"appearance"})),Zt}(Object.assign({layer:nt,layerType:ht},Gt)),properties:Gt=>function(zt){const Zt=[],{styleSpec:Vt,layer:kt,layerType:Ht}=zt,pe=Vt[`paint_${Ht}`],ae=Vt[`layout_${Ht}`],Ce=zt.object[zt.objectKey];for(const ve in Ce){const Fe=ve in pe?"paint":ve in ae?"layout":void 0;if(!Fe){Zt.push(new i.V(zt.key,ve,`unknown property "${ve}" for layer type "${Ht}"`));continue}const oi=Object.assign({},zt,{key:`${zt.key}.${ve}`,object:Ce,objectKey:ve,layer:kt,layerType:Ht,value:Ce[ve],valueSpec:Fe==="paint"?pe[ve]:ae[ve]});Zt.push(...Sl(oi,Fe))}return Zt}(Object.assign({layer:nt,layerType:ht},Gt))}});return _t!=="hidden"&&Ct===void 0&&bt.push(new i.V(X.key,"name",'Appearance with name different than "hidden" must have a condition')),bt}(Object.assign({layerType:I,layer:a},U))}),V=Array.isArray(L.value)?L.value:[],Z=new Set;return V.forEach((U,X)=>{const Q=i.J(U.name);if(Q)if(Z.has(Q)){const nt=i.J(a.id);N.push(new i.V(L.key,Q,`Duplicated appearance name "${Q}" for layer "${nt}"`))}else Z.add(Q)}),N}}})),e}function Ga({key:p,value:e}){return i.a0(e)?[]:[new i.V(p,e,`string expected, ${i.K(e)} found`)]}const $l={promoteId:function p({key:e,value:a}){if(i.a0(a))return Ga({key:e,value:a});if(Array.isArray(a)){const y=[],w=i.S(a),I=i.U(w);return I.result==="error"&&I.value.forEach(M=>{y.push(new i.V(`${e}${M.key}`,null,`${M.message}`))}),i.X(I.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||y.push(new i.V(`${e}`,null,"promoteId expression should be only feature dependent")),y}if(!i.H(a))return[new i.V(e,a,`string, expression or object expected, "${i.K(a)}" found`)];const f=[];for(const y in a)f.push(...p({key:`${e}.${y}`,value:a[y]}));return f}};function Aa(p){const e=p.value,a=p.key,f=p.styleSpec,y=p.style;if(!i.H(e))return[new i.V(a,e,`object expected, ${i.K(e)} found`)];if(!("type"in e))return[new i.V(a,e,'"type" is required')];const w=i.J(e.type);let I=[];switch(["vector","raster","raster-dem","raster-array"].includes(w)&&("url"in e||"tiles"in e||I.push(new i.a3(a,e,'Either "url" or "tiles" is required.'))),w){case"vector":case"raster":case"raster-dem":case"raster-array":return I=I.concat(Re({key:a,value:e,valueSpec:f[`source_${w.replace("-","_")}`],style:p.style,styleSpec:f,objectElementValidators:$l})),I;case"geojson":if(I=Re({key:a,value:e,valueSpec:f.source_geojson,style:y,styleSpec:f,objectElementValidators:$l}),"cluster"in e&&"clusterProperties"in e){if(!i.H(e.clusterProperties))return[new i.V(`${a}.clusterProperties`,e,`object expected, ${i.K(e)} found`)];for(const M in e.clusterProperties){const L=e.clusterProperties[M];if(!Array.isArray(L))return[new i.V(`${a}.clusterProperties.${M}`,L,"array expected")];const[N,V]=L,Z=typeof N=="string"?[N,["accumulated"],["get",M]]:N;I.push(...Ts({key:`${a}.${M}.map`,value:V,expressionContext:"cluster-map"})),I.push(...Ts({key:`${a}.${M}.reduce`,value:Z,expressionContext:"cluster-reduce"}))}}return I;case"video":return Re({key:a,value:e,valueSpec:f.source_video,style:y,styleSpec:f});case"image":return Re({key:a,value:e,valueSpec:f.source_image,style:y,styleSpec:f});case"canvas":return[new i.V(a,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ds({key:`${a}.type`,value:e.type,valueSpec:{values:Hn(f)}})}}function Hn(p){return p.source.reduce((e,a)=>{const f=p[a];return f.type.type==="enum"&&(e=e.concat(Object.keys(f.type.values||{}))),e},[])}function we(p){const e=p.value,a=p.styleSpec,f=a.light,y=p.style;if(e===void 0)return[];if(!i.H(e))return[new i.V("light",e,`object expected, ${i.K(e)} found`)];let w=[];for(const I in e){const M=I.match(/^(.*)-transition$/),L=I.match(/^(.*)-use-theme$/);w=w.concat(L&&f[L[1]]?le({key:I,value:e[I],valueSpec:{type:"string"},style:y,styleSpec:a}):M&&f[M[1]]&&f[M[1]].transition?le({key:I,value:e[I],valueSpec:a.transition,style:y,styleSpec:a}):f[I]?le({key:I,value:e[I],valueSpec:f[I],style:y,styleSpec:a}):[new i.V(I,e[I],`unknown property "${I}"`)])}return w}function It(p){const e=p.value;if(!e)return[];const a=p.key;if(!i.H(e))return[new i.V(a,e,`object expected, ${i.K(e)} found`)];let f=[];const y=p.styleSpec,w=y["light-3d"],I=p.style,M=p.style.lights;for(const V of["type","id"])if(!(V in e))return f=f.concat([new i.V(a,e,`missing property "${V}"`)]),f;if(!i.a0(e.type))return f=f.concat([new i.V(`${a}.type`,e.type,"string expected")]),f;if(M)for(let V=0;V<p.arrayIndex;V++){const Z=i.J(e.type),U=M[V];i.J(U.type)===Z&&f.push(new i.V(a,e.id,`duplicate light type "${e.type}", previously defined at line ${U.id.__line__}`))}const L=`properties_light_${e.type}`;if(!(L in y))return f=f.concat([new i.V(`${a}.type`,e,`Invalid light type ${e.type}`)]),f;const N=y[L];for(const V in e)if(V==="properties"){const Z=e[V];if(!i.H(Z))return f=f.concat([new i.V("properties",Z,`object expected, ${i.K(Z)} found`)]),f;for(const U in Z){const X=U.match(/^(.*)-transition$/),Q=U.match(/^(.*)-use-theme$/);f=f.concat(Q&&N[Q[1]]?le({key:V,value:Z[U],valueSpec:{type:"string"},style:I,styleSpec:y}):X&&N[X[1]]&&N[X[1]].transition?le({key:V,value:e[V],valueSpec:y.transition,style:I,styleSpec:y}):N[U]?le({key:U,value:Z[U],valueSpec:N[U],style:I,styleSpec:y}):[new i.a3(p.key,Z[U],`unknown property "${U}"`)])}}else f=f.concat(w[V]?le({key:V,value:e[V],valueSpec:w[V],style:I,styleSpec:y}):[new i.a3(V,e[V],`unknown property "${V}"`)]);return f}function Mt(p){const e=p.value,a=p.key,f=p.style,y=p.styleSpec,w=y.terrain;if(e==null)return[];if(!i.H(e))return[new i.V("terrain",e,`object expected, ${i.K(e)} found`)];let I=[];for(const M in e){const L=M.match(/^(.*)-transition$/),N=M.match(/^(.*)-use-theme$/);I=I.concat(N&&w[N[1]]?le({key:M,value:e[M],valueSpec:{type:"string"},style:f,styleSpec:y}):L&&w[L[1]]&&w[L[1]].transition?le({key:M,value:e[M],valueSpec:y.transition,style:f,styleSpec:y}):w[M]?le({key:M,value:e[M],valueSpec:w[M],style:f,styleSpec:y}):[new i.a3(M,e[M],`unknown property "${M}"`)])}if(e.source)if(i.a0(e.source)){const M=f.sources&&f.sources[e.source],L=M&&i.J(M.type);M?L!=="raster-dem"&&I.push(new i.V(`${a}.source`,e.source,`terrain cannot be used with a source of type ${L}, it only be used with a "raster-dem" source type`)):I.push(new i.V(`${a}.source`,e.source,`source "${e.source}" not found`))}else I.push(new i.V(`${a}.source`,e.source,"source must be a string"));else I.push(new i.V(a,e,'terrain is missing required property "source"'));return I}function Ut(p){const e=p.value,a=p.style,f=p.styleSpec,y=f.fog;if(e===void 0)return[];if(!i.H(e))return[new i.V("fog",e,`object expected, ${i.K(e)} found`)];let w=[];for(const I in e){const M=I.match(/^(.*)-transition$/),L=I.match(/^(.*)-use-theme$/);w=w.concat(L&&y[L[1]]?le({key:I,value:e[I],valueSpec:{type:"string"},style:a,styleSpec:f}):M&&y[M[1]]&&y[M[1]].transition?le({key:I,value:e[I],valueSpec:f.transition,style:a,styleSpec:f}):y[I]?le({key:I,value:e[I],valueSpec:y[I],style:a,styleSpec:f}):[new i.a3(I,e[I],`unknown property "${I}"`)])}return w}const he={"*":()=>[],array:Zn,boolean:function(p){const e=p.value,a=p.key;return i.$(e)?[]:[new i.V(a,e,`boolean expected, ${i.K(e)} found`)]},number:el,color:function({key:p,value:e}){return i.a0(e)?i.a1.parseCSSColor(e)===null?[new i.V(p,e,`color expected, "${e}" found`)]:[]:[new i.V(p,e,`color expected, ${i.K(e)} found`)]},enum:ds,filter:Ss,function:jl,layer:rl,object:Re,source:Aa,model:i.a7,light:we,"light-3d":It,terrain:Mt,fog:Ut,string:Ga,formatted:function(p){return Ga(p).length===0?[]:Ts(p)},resolvedImage:function(p){return Ga(p).length===0?[]:Ts(p)},projection:function(p){const e=p.value,a=p.styleSpec,f=a.projection,y=p.style;if(i.H(e)){let w=[];for(const I in e)w=w.concat(le({key:I,value:e[I],valueSpec:f[I],style:y,styleSpec:a}));return w}return i.a0(e)?[]:[new i.V("projection",e,`object or string expected, ${i.K(e)} found`)]},import:function(p){const e=p.key,{value:a,styleSpec:f}=p;if(!i.H(a))return[new i.V(e,a,"import must be an object")];const{data:y,...w}=a;Object.defineProperty(w,"__line__",{value:a.__line__,enumerable:!1});let I=Re(Object.assign({},p,{value:w,valueSpec:f.import}));return i.J(w.id)===""&&I.push(new i.V(`${p.key}.id`,w,"import id can't be an empty string")),y&&(I=I.concat(ze(y,f,{key:`${p.key}.data`}))),I},iconset:function(p){const e=p.value,a=p.key,f=p.styleSpec,y=p.style;if(!i.H(e))return[new i.V(a,e,"object expected")];if(!e.type)return[new i.V(a,e,'"type" is required')];const w=i.J(e.type);let I=[];if(I=I.concat(Re({key:a,value:e,valueSpec:f[`iconset_${w}`],style:y,styleSpec:f})),function(M,L){return!(M!=="source"||!L.source)}(w,e)){const M=y.sources&&y.sources[e.source],L=M&&i.J(M.type);M?L!=="raster-array"&&I.push(new i.V(a,e.source,`iconset cannot be used with a source of type ${String(L)}, it only be used with a "raster-array" source type`)):I.push(new i.V(a,e.source,`source "${e.source}" not found`))}return I}};function le(p,e=!1){const a=p.value,f=p.valueSpec,y=p.styleSpec;if(f.expression){if(i.a4(i.J(a)))return jl(p);if(i.Q(i.S(a)))return Ts(p)}if(f.type&&he[f.type]){const w=he[f.type](p);return e===!0&&w.length>0&&Array.isArray(p.value)?Ts(p):w}return Re(Object.assign({},p,{valueSpec:f.type?y[f.type]:f}))}function Re(p){const e=p.key,a=p.value,f=p.valueSpec||{},y=p.objectElementValidators||{},w=p.style,I=p.styleSpec;if(!i.H(a))return[new i.V(e,a,`object expected, ${i.K(a)} found`)];let M=[];for(const L in a){const N=L.split(".")[0];let V;y[N]?V=y[N]:f[N]?V=le:y["*"]?V=y["*"]:f["*"]&&(V=le),V?M=M.concat(V({key:(e&&`${e}.`)+L,value:a[L],valueSpec:f[N]||f["*"],style:w,styleSpec:I,object:a,objectKey:L},a)):M.push(new i.a3(e,a[L],`unknown property "${L}"`))}for(const L in f){if(y[L])continue;const N=f[L];N.required&&N.default===void 0&&a[L]===void 0&&M.push(new i.V(e,a,`missing required property "${L}"`))}return M}function te({key:p,value:e}){const a=Ga({key:p,value:e});if(a.length)return a;const f=e;return f.indexOf("{fontstack}")===-1&&a.push(new i.V(p,e,'"glyphs" url must include a "{fontstack}" token')),f.indexOf("{range}")===-1&&a.push(new i.V(p,e,'"glyphs" url must include a "{range}" token')),a}function ze(p,e=i.a6,a={}){return Re({key:a.key||"",value:p,valueSpec:Object.assign(e.$root,{"*":{type:"*"}}),styleSpec:e,style:p,objectElementValidators:{glyphs:te}})}function We(p,e=i.a6){return se(ze(p,e))}const ci=p=>se(Aa(p)),ui=p=>se(we(p)),or=p=>se(It(p)),Ir=p=>se(Mt(p)),Ae=p=>se(Ut(p)),bo=p=>se(function(e){const a=e.value,f=e.style,y=e.styleSpec,w=y.snow;if(a===void 0)return[];if(!i.H(a))return[new i.V("snow",a,`object expected, ${i.K(a)} found`)];let I=[];for(const M in a){const L=M.match(/^(.*)-transition$/);I=I.concat(L&&w[L[1]]&&w[L[1]].transition?le({key:M,value:a[M],valueSpec:y.transition,style:f,styleSpec:y}):w[M]?le({key:M,value:a[M],valueSpec:w[M],style:f,styleSpec:y}):[new i.a3(M,a[M],`unknown property "${M}"`)])}return I}(p)),_n=p=>se(function(e){const a=e.value,f=e.style,y=e.styleSpec,w=y.rain;if(a===void 0)return[];if(!i.H(a))return[new i.V("rain",a,`object expected, ${i.K(a)} found`)];let I=[];for(const M in a){const L=M.match(/^(.*)-transition$/);I=I.concat(L&&w[L[1]]&&w[L[1]].transition?le({key:M,value:a[M],valueSpec:y.transition,style:f,styleSpec:y}):w[M]?le({key:M,value:a[M],valueSpec:w[M],style:f,styleSpec:y}):[new i.a3(M,a[M],`unknown property "${M}"`)])}return I}(p)),Un=p=>se(rl(p)),rr=p=>se(Ss(p)),bi=p=>se(Il(p)),Bo=p=>se(zs(p)),wo=p=>se(i.a7(p));function se(p){return p.slice().sort((e,a)=>e.line&&a.line?e.line-a.line:0)}function st(p,e){let a=!1;if(e&&e.length)for(const f of e)f instanceof i.a3?i.w(f.message):(p.fire(new i.y(new Error(f.message))),a=!0);return a}const tt=i.a6.light;let Tt;class Nt extends i.E{constructor(e,a="flat"){super(),this._transitionable=new i.a8(Tt||(Tt=new i.a9({anchor:new i.aa(tt.anchor),position:new i.ab(tt.position),color:new i.aa(tt.color),intensity:new i.aa(tt.intensity)}))),this.setLight(e,a),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,a,f={}){this._validate(ui,e,f)||(this._transitionable.setTransitionOrValue(e),this.id=a)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,a,f){return(!f||f.validate!==!1)&&st(this,e.call(We,Object.assign({value:a,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}}const Wt=i.a6.terrain;let oe=class extends i.E{constructor(p,e,a,f,y){super(),this.scope=a,this._transitionable=new i.a8(new i.a9({source:new i.aa(Wt.source),exaggeration:new i.aa(Wt.exaggeration)}),a,f),this._transitionable.setTransitionOrValue(p,f),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=e,this.worldview=y}get(){return this._transitionable.serialize()}set(p,e){this._transitionable.setTransitionOrValue(p,e)}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}getExaggeration(p){return this._transitioning.possiblyEvaluate(new i.ac(p,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const p=this._transitionable._values.exaggeration;if(!p)return null;const e=p.value.expression;if(!e)return null;let a=-1,f=-1,y=1;for(const w of e.zoomStops)y=e.evaluate(new i.ac(w,{worldview:this.worldview})),y>.01?(a=w,f=-1):f=w;return y<.01&&a>0&&f>a?[a,f]:null}isZoomDependent(){const p=this._transitionable._values.exaggeration;return p!=null&&p.value!=null&&p.value.expression!=null&&p.value.expression instanceof i.ad}};const ye=45,Jt=65,xe=.05;function ti(p,e,a,f){const y=i.ah(ye,Jt,a),[w,I]=$e(p,f);let M=1-Math.min(1,Math.exp((e-w)/(I-w)*-6));return M*=M*M,M=Math.min(1,1.00747*M),M*y*p.alpha}function $e(p,e){const a=.5/Math.tan(.5*e);return[p.range[0]+a,p.range[1]+a]}function Mi(p,e,a,f,y){const w=i.af([],[e,a,f],y.mercatorFogMatrix);return ti(p,i.ag(w),y.pitch,y._fov)}function Ji(p,e,a,f,y,w,I){const M=[[a,f,0],[y,f,0],[y,w,0],[a,w,0]];let L=Number.MAX_VALUE,N=-Number.MAX_VALUE;for(const V of M){const Z=i.af([],V,e),U=i.ag(Z);L=Math.min(L,U),N=Math.max(N,U)}return[ti(p,L,I.pitch,I._fov),ti(p,N,I.pitch,I._fov)]}const Xi=i.a6.fog;class qi extends i.E{constructor(e,a,f,y){super();const w=new i.a9({range:new i.aa(Xi.range),color:new i.aa(Xi.color),"color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new i.aa(Xi["high-color"]),"high-color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new i.aa(Xi["space-color"]),"space-color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new i.aa(Xi["horizon-blend"]),"star-intensity":new i.aa(Xi["star-intensity"]),"vertical-range":new i.aa(Xi["vertical-range"])});this._transitionable=new i.a8(w,f,new Map(y)),this.set(e,y),this._transitioning=this._transitionable.untransitioned(),this._transform=a,this.properties=new i.ai(w),this.scope=f}get state(){const e=this._transform,a=e.projection.name==="globe",f=i.aj(e.zoom),y=this.properties.get("range"),w=[.5,3];return{range:a?[i.ak(w[0],y[0],f),i.ak(w[1],y[1],f)]:y,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(e,a,f={}){if(this._validate(Ae,e,f))return;const y=Object.assign({},e);for(const w of Object.keys(Xi))y[w]===void 0&&(y[w]=Xi[w].default);this._options=y,this._transitionable.setTransitionOrValue(this._options,a)}getOpacity(e){if(!this._transform.projection.supportsFog)return 0;const a=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:i.ah(ye,Jt,e))*a.a}getOpacityAtLatLng(e,a){return this._transform.projection.supportsFog?function(f,y,w){const I=i.ae.fromLngLat(y),M=w.elevation?w.elevation.getAtPointOrZero(I):0;return Mi(f,I.x,I.y,M,w)}(this.state,e,a):0}getOpacityForTile(e){if(!this._transform.projection.supportsFog)return[1,1];const a=this._transform.calculateFogTileMatrix(e.toUnwrapped());return Ji(this.state,a,0,0,i.al,i.al,this._transform)}getOpacityForBounds(e,a,f,y,w){return this._transform.projection.supportsFog?Ji(this.state,e,a,f,y,w,this._transform):[1,1]}getFovAdjustedRange(e){return this._transform.projection.supportsFog?$e(this.state,e):[0,1]}isVisibleOnFrustum(e){if(!this._transform.projection.supportsFog)return!1;const a=[4,5,6,7];for(const f of a){const y=e.points[f];let w;if(y[2]>=0)w=y;else{const I=e.points[f-4];w=i.am(I,y,I[2]/(I[2]-y[2]))}if(Mi(this.state,w[0],w[1],0,this._transform)>=xe)return!0}return!1}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,a,f){return(!f||f.validate!==!1)&&st(this,e.call(We,Object.assign({value:a,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}}let hr,Yi,wn,Pn,zo=class extends i.E{constructor(p,e,a,f){super();const y=hr||(hr=new i.a9({density:new i.aa(i.a6.snow.density),intensity:new i.aa(i.a6.snow.intensity),color:new i.aa(i.a6.snow.color),opacity:new i.aa(i.a6.snow.opacity),vignette:new i.aa(i.a6.snow.vignette),"vignette-color":new i.aa(i.a6.snow["vignette-color"]),"center-thinning":new i.aa(i.a6.snow["center-thinning"]),direction:new i.aa(i.a6.snow.direction),"flake-size":new i.aa(i.a6.snow["flake-size"])}));this._transitionable=new i.a8(y,a,new Map(f)),this.set(p,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ai(y),this.scope=a}get state(){const p=this.properties.get("opacity"),e=this.properties.get("color"),a=this.properties.get("direction"),f=i.an(a[0]),y=-Math.max(i.an(a[1]),.01),w=[Math.cos(f)*Math.cos(y),Math.sin(f)*Math.cos(y),Math.sin(y)],I=this.properties.get("vignette"),M=this.properties.get("vignette-color");return M.a=I,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.ao(e.r,e.g,e.b,e.a*p),direction:w,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:M}}get(){return this._transitionable.serialize()}set(p,e,a={}){if(this._validate(bo,p,a))return;const f=Object.assign({},p),y=i.a6.snow;for(const w of Object.keys(y))f[w]===void 0&&(f[w]=y[w].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,e)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,e,a){return(!a||a.validate!==!1)&&st(this,p.call(We,Object.assign({value:e,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}},Gr=class extends i.E{constructor(p,e,a,f){super();const y=Yi||(Yi=new i.a9({density:new i.aa(i.a6.rain.density),intensity:new i.aa(i.a6.rain.intensity),color:new i.aa(i.a6.rain.color),opacity:new i.aa(i.a6.rain.opacity),vignette:new i.aa(i.a6.rain.vignette),"vignette-color":new i.aa(i.a6.rain["vignette-color"]),"center-thinning":new i.aa(i.a6.rain["center-thinning"]),direction:new i.aa(i.a6.rain.direction),"droplet-size":new i.aa(i.a6.rain["droplet-size"]),"distortion-strength":new i.aa(i.a6.rain["distortion-strength"])}));this._transitionable=new i.a8(y,a,new Map(f)),this.set(p,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ai(y),this.scope=a}get state(){const p=this.properties.get("opacity"),e=this.properties.get("color"),a=this.properties.get("direction"),f=i.an(a[0]),y=-Math.max(i.an(a[1]),.01),w=[Math.cos(f)*Math.cos(y),Math.sin(f)*Math.cos(y),Math.sin(y)],I=this.properties.get("vignette-color");return I.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.ao(e.r,e.g,e.b,e.a*p),direction:w,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:I}}get(){return this._transitionable.serialize()}set(p,e,a={}){if(this._validate(_n,p,a))return;const f=Object.assign({},p),y=i.a6.rain;for(const w of Object.keys(y))f[w]===void 0&&(f[w]=y[w].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,e)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,e,a){return(!a||a.validate!==!1)&&st(this,p.call(We,Object.assign({value:e,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}};class Wn extends i.E{constructor(e,a,f,y){super(),this.scope=f,this._options=e,this.properties=new i.ai(a),this._transitionable=new i.a8(a,f,new Map(y)),this._transitionable.setTransitionOrValue(e.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(e){this._transitionable.setTransitionOrValue(this._options.properties,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(e,a){this._options=e,this._transitionable.setTransitionOrValue(e.properties,a)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class an{constructor(e,a,f){this.screenBounds=e,this.cameraPoint=f.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=a,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,f)}static createFromScreenPoints(e,a){let f,y;if(e instanceof i.P||typeof e[0]=="number"){const w=i.P.convert(e);f=[w],y=a.isPointAboveHorizon(w)}else{const w=i.P.convert(e[0]),I=i.P.convert(e[1]),M=w.add(I)._div(2);f=[w,I],y=i.aq(w,I).every(L=>a.isPointAboveHorizon(L))&&a.isPointAboveHorizon(M)}return new an(f,y,a)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(e){return i.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],e)}bufferedCameraGeometry(e){const a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],y=i.aq(a,f,0,!1);return this.cameraPoint.y>f.y&&(this.cameraPoint.x>a.x&&this.cameraPoint.x<f.x?y.splice(3,0,this.cameraPoint):this.cameraPoint.x>=f.x?y[2]=this.cameraPoint:this.cameraPoint.x<=a.x&&(y[3]=this.cameraPoint)),i.ar(y,e)}bufferedCameraGeometryGlobe(e){const a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],y=i.aq(a,f,e),w=this.cameraPoint.clone();switch(3*((w.y>a.y)+(w.y>f.y))+((w.x>a.x)+(w.x>f.x))){case 0:y[0]=w,y[4]=w.clone();break;case 1:y.splice(1,0,w);break;case 2:y[1]=w;break;case 3:y.splice(4,0,w);break;case 5:y.splice(2,0,w);break;case 6:y[3]=w;break;case 7:y.splice(3,0,w);break;case 8:y[2]=w}return y}containsTile(e,a,f,y=0){const w=Math.max(e.queryPadding,e.evaluateQueryRenderedFeaturePadding())/a._pixelsPerMercatorPixel+1,I=f?this._bufferedCameraMercator(w,a):this._bufferedScreenMercator(w,a);let M=e.tileID.wrap+(I.unwrapped?y:0);const L=I.polygon.map(ht=>i.as(e.tileTransform,ht,M));if(!i.at(L,0,0,i.al,i.al))return;M=e.tileID.wrap+(this.screenGeometryMercator.unwrapped?y:0);const N=this.screenGeometryMercator.polygon.map(ht=>i.au(e.tileTransform,ht,M)),V=N.map(ht=>new i.P(ht[0],ht[1])),Z=a.getFreeCameraOptions().position||new i.ae(0,0,0),U=i.au(e.tileTransform,Z,M),X=N.map(ht=>{const lt=i.av(ht,ht,U);return i.aw(lt,lt),new i.ax(U,lt)}),Q=i.ay(e,1,a.zoom)*a._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:V,tilespaceRays:X,bufferedTilespaceGeometry:L,bufferedTilespaceBounds:(nt=i.az(L),nt.min.x=i.aA(nt.min.x,0,i.al),nt.min.y=i.aA(nt.min.y,0,i.al),nt.max.x=i.aA(nt.max.x,0,i.al),nt.max.y=i.aA(nt.max.y,0,i.al),nt),tile:e,tileID:e.tileID,pixelToTileUnitsFactor:Q};var nt}_bufferedScreenMercator(e,a){const f=jn(e);if(this._screenRaycastCache[f])return this._screenRaycastCache[f];{let y;return y=a.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(e),a):{polygon:this.bufferedScreenGeometry(e).map(w=>a.pointCoordinate3D(w)),unwrapped:!0},this._screenRaycastCache[f]=y,y}}_bufferedCameraMercator(e,a){const f=jn(e);if(this._cameraRaycastCache[f])return this._cameraRaycastCache[f];{let y;return y=a.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(e),a):{polygon:this.bufferedCameraGeometry(e).map(w=>a.pointCoordinate3D(w)),unwrapped:!0},this._cameraRaycastCache[f]=y,y}}_projectAndResample(e,a){const f=function(w,I){const M=i.aB([],I.pixelMatrix,I.globeMatrix),L=[0,-i.aD,0,1],N=[0,i.aD,0,1],V=[0,0,0,1];i.aC(L,L,M),i.aC(N,N,M),i.aC(V,V,M);const Z=new i.P(L[0]/L[3],L[1]/L[3]),U=new i.P(N[0]/N[3],N[1]/N[3]),X=i.aE(w,Z)&&L[3]<V[3],Q=i.aE(w,U)&&N[3]<V[3];if(!X&&!Q)return null;const nt=function(Zt,Vt,kt){for(let Ht=1;Ht<Zt.length;Ht++){const pe=Bn(Vt.pointCoordinate3D(Zt[Ht-1]).x),ae=Bn(Vt.pointCoordinate3D(Zt[Ht]).x);if(kt<0){if(pe<ae)return{idx:Ht,t:-pe/(ae-1-pe)}}else if(ae<pe)return{idx:Ht,t:(1-pe)/(ae+1-pe)}}return null}(w,I,X?-1:1);if(!nt)return null;const{idx:ht,t:lt}=nt;let _t=ht>1?Rr(w.slice(0,ht),I):[],Ct=ht<w.length?Rr(w.slice(ht),I):[];_t=_t.map(Zt=>new i.P(Bn(Zt.x),Zt.y)),Ct=Ct.map(Zt=>new i.P(Bn(Zt.x),Zt.y));const bt=[..._t];bt.length===0&&bt.push(Ct[Ct.length-1]);const Gt=i.ak(bt[bt.length-1].y,(Ct.length===0?_t[0]:Ct[0]).y,lt);let zt;return zt=X?[new i.P(0,Gt),new i.P(0,0),new i.P(1,0),new i.P(1,Gt)]:[new i.P(1,Gt),new i.P(1,1),new i.P(0,1),new i.P(0,Gt)],bt.push(...zt),Ct.length===0?bt.push(_t[0]):bt.push(...Ct),{polygon:bt.map(Zt=>new i.ae(Zt.x,Zt.y)),unwrapped:!1}}(e,a);if(f)return f;const y=function(w,I){let M=!1,L=-1/0,N=0;for(let Z=0;Z<w.length-1;Z++)w[Z].x>L&&(L=w[Z].x,N=Z);for(let Z=0;Z<w.length-1;Z++){const U=(N+Z)%(w.length-1),X=w[U],Q=w[U+1];Math.abs(X.x-Q.x)>.5&&(X.x<Q.x?(X.x+=1,U===0&&(w[w.length-1].x+=1)):(Q.x+=1,U+1===w.length-1&&(w[0].x+=1)),M=!0)}const V=i.aF(I.center.lng);return M&&V<Math.abs(V-1)&&w.forEach(Z=>{Z.x-=1}),{polygon:w,unwrapped:M}}(Rr(e,a).map(w=>new i.P(Bn(w.x),w.y)),a);return{polygon:y.polygon.map(w=>new i.ae(w.x,w.y)),unwrapped:y.unwrapped}}}function Rr(p,e){return i.aG(p,a=>{const f=e.pointCoordinate3D(a);a.x=f.x,a.y=f.y},1/256)}function Bn(p){return p<0?1+p%1:p%1}function jn(p){return 100*p|0}function Tn(p,e,a,f,y){const w=function(M,L){if(M)return y(M);if(L){if(p.url&&L.tiles&&p.tiles&&delete p.tiles,L.variants){if(!Array.isArray(L.variants))return y(new Error("variants must be an array"));for(const V of L.variants){if(V==null||typeof V!="object"||V.constructor!==Object)return y(new Error("variant must be an object"));if(!Array.isArray(V.capabilities))return y(new Error("capabilities must be an array"));if(V.capabilities.length===1&&V.capabilities[0]==="meshopt"){L=Object.assign(L,V);break}}}const N=i.aH(Object.assign({},L,p),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);N.tiles=e.canonicalizeTileset(N,p.url),y(null,N)}},I=function(M,L,N){if(!M)return null;if(!L&&!N)return M;N=N||M.worldview_default;const V=Object.values(M.language||{});if(V.length===0)return null;const Z=Object.values(M.worldview||{});if(Z.length===0)return null;const U=V.every(Q=>Q===L),X=Z.every(Q=>Q===N);return U&&X?M:L in(M.language_options||{})||N in(M.worldview_options||{})?null:M.language_options&&M.worldview_options?M:null}(p.data,a,f);return I?i.o.frame(()=>w(null,I)):p.url?i.m(e.transformRequest(e.normalizeSourceURL(p.url,null,a,f),i.R.Source),w):i.o.frame(()=>{const{data:M,...L}=p;w(null,L)})}function Gn(p,e){const a=Math.pow(2,e.z),f=Math.floor(i.aF(p.getWest())*a),y=Math.floor(i.aJ(p.getNorth())*a),w=Math.ceil(i.aF(p.getEast())*a),I=Math.ceil(i.aJ(p.getSouth())*a);return e.x>=f&&e.x<w&&e.y>=y&&e.y<I}class os{constructor(e,a,f){this.bounds=e?i.aI.convert(this.validateBounds(e)):null,this.minzoom=a||0,this.maxzoom=f||24}validateBounds(e){return Array.isArray(e)&&e.length===4?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}addExtraBounds(e){if(e){this.extraBounds||(this.extraBounds=[]);for(const a of e)this.extraBounds.push(i.aI.convert(this.validateBounds(a)))}}contains(e){if(e.z>this.maxzoom||e.z<this.minzoom||this.bounds&&!Gn(this.bounds,e))return!1;if(!this.extraBounds)return!0;for(const a of this.extraBounds)if(Gn(a,e))return!0;return!1}static fromTileJSON(e){if(!e.bounds&&!e.extra_bounds)return null;const a=new os(e.bounds,e.minzoom,e.maxzoom);return a.addExtraBounds(e.extra_bounds),a}}class ta extends i.E{constructor(e,a,f,y){if(super(),this.id=e,this.dispatcher=f,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,i.aH(a,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},a),this._collectResourceTiming=!!a.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(y),this._tileWorkers={},this._deduped=new i.aK}load(e){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));const a=Array.isArray(this.map._language)?this.map._language.join():this.map._language,f=this.map.getWorldview();this._tileJSONRequest=Tn(this._options,this.map._requestManager,a,f,(y,w)=>{if(this._tileJSONRequest=null,this._loaded=!0,y)a&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${a}`),f&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${f}`),this.fire(new i.y(y));else if(w){if(Object.assign(this,w),this.hasWorldviews=!!w.worldview_options,w.worldview_default&&(this.worldviewDefault=w.worldview_default),w.vector_layers){this.vectorLayers=w.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const I of w.vector_layers)this.vectorLayerIds.push(I.id),w.worldview&&w.worldview[I.source]&&this.localizableLayerIds.add(I.id)}this.tileBounds=os.fromTileJSON(w),Js(w.tiles,this.map._requestManager._customAccessToken),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}e&&e(y)})}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const e=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(e))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(e,a){const f=e.tileID.canonical.url(this.tiles,this.scheme),y=this.map._requestManager.normalizeTileURL(f),w=this.map._requestManager.transformRequest(y,i.R.Tile),I=this.map.style?this.map.style.getLut(this.scope):null,M=I?{image:I.image.clone()}:null,L={request:w,data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,lut:M,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:i.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:e.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:e.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&i.h(f)&&(L.localizableLayerIds=this.localizableLayerIds),L.request.collectResourceTiming=this._collectResourceTiming,e.actor&&e.state!=="expired")e.state==="loading"?e.reloadCallback=a:e.request=e.actor.send("reloadTile",L,N.bind(this));else if(e.actor=this._tileWorkers[y]=this._tileWorkers[y]||this.dispatcher.getActor(),this.dispatcher.ready)e.request=e.actor.send("loadTile",L,N.bind(this),void 0,!0);else{const V=i.aL.call({deduped:this._deduped},L,(Z,U)=>{if(Z||!U)N.call(this,Z);else{const X=i.aM(U.responseHeaders);L.data={cacheControl:X.cacheControl,expires:X.expires,rawData:U.rawData.slice(0)},e.actor&&e.actor.send("loadTile",L,N.bind(this),void 0,!0)}},!0);e.request={cancel:V}}function N(V,Z){return delete e.request,e.aborted?a(null):V&&V.status!==404?a(V):(Z&&Z.resourceTiming&&(e.resourceTiming=Z.resourceTiming),this.map._refreshExpiredTiles&&Z&&e.setExpiryData(Z),e.loadVectorData(Z,this.map.painter),i.aN(this.dispatcher),a(null,Z),void(e.reloadCallback&&(this.loadTile(e,e.reloadCallback),e.reloadCallback=null)))}}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,a){e.actor&&e.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class El extends i.E{constructor(e,a,f,y){super(),this.id=e,this.dispatcher=f,this.setEventedParent(y),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},a),Object.assign(this,i.aH(a,["url","scheme","tileSize"]))}load(e){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));const a=this.map.getWorldview();this._tileJSONRequest=Tn(this._options,this.map._requestManager,null,a,(f,y)=>{this._tileJSONRequest=null,this._loaded=!0,f?this.fire(new i.y(f)):y&&(Object.assign(this,y),y.raster_layers&&(this.rasterLayers=y.raster_layers,this.rasterLayerIds=this.rasterLayers.map(w=>w.id)),this.tileBounds=os.fromTileJSON(y),Js(y.tiles),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))),e&&e(f)})}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const e=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(e))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,a){const f=i.o.devicePixelRatio>=2,y=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),f,this.tileSize);e.request=i.n(this.map._requestManager.transformRequest(y,i.R.Tile),(w,I,M)=>{if(delete e.request,e.aborted)return e.state="unloaded",a(null);if(w)return e.state="errored",a(w);if(!I)return a(null);const L=i.aM(M);this.map._refreshExpiredTiles&&e.setExpiryData(L),e.setTexture(I,this.map.painter),e.state="loaded",i.aN(this.dispatcher),a(null)})}abortTile(e,a){e.request&&(e.request.cancel(),delete e.request),a&&a()}unloadTile(e,a){e.texture&&e.texture instanceof i.T?(e.destroy(!0),e.texture&&e.texture instanceof i.T&&this.map.painter.saveTileTexture(e.texture)):e.destroy(),a&&a()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function wh([p,e],a,f,{scaled:y=!0}={}){const{tileSize:w,buffer:I}=f,{x:M,y:L,z:N}=a;if(!isFinite(M)||!isFinite(L)||!isFinite(N))throw new Error("Invalid MRT header");const V=2**N,Z=V*i.aF(p),U=V*i.aJ(e);return function([X,Q],nt,{scaled:ht=!0}={}){if(!nt)throw new Error("bandView is undefined");const{data:lt,tileSize:_t,buffer:Ct,offset:bt,scale:Gt,dimension:zt}=nt;if(X<-Ct||X>_t+Ct||Q<-Ct||Q>_t+Ct)throw new Error(`Point (${X}, ${Q}) out of bounds for tileSize=${_t}, buffer=${Ct}`);const Zt=(Q+Ct)*(_t+2*Ct)+(X+Ct);if(new Uint32Array(lt.buffer)[Zt]===4294967295)return null;let Vt=[];Vt=ht?[]:new nt.data.constructor(zt);for(let kt=0;kt<zt;kt++)Vt[kt]=Math.round(1e12*(lt[zt*Zt+kt]*Gt+bt))/1e12;return Vt}([Math.min(Math.max(-I,Math.floor((Z-M)*w)),w-1+I),Math.min(Math.max(-I,Math.floor((U-L)*w)),w-1+I)],f,{scaled:y})}class es extends El{constructor(e,a,f,y){super(e,a,f,y),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},a)}triggerRepaint(e){const a=this.map.painter._terrain,f=this.map.style.getSourceCache(this.id);a&&a.enabled&&f&&a._clearRenderCacheForTile(f.id,e.tileID),this.map.triggerRepaint()}loadTile(e,a){const f=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),y=this.map._requestManager.transformRequest(f,i.R.Tile),w={request:y,uid:e.uid,tileID:e.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};e.source=this.id,e.scope=this.scope,e.requestParams=y,e.actor||(e.actor=this.dispatcher.getActor());const I=(M,L,N)=>{if(delete e.request,e.aborted)return e.state="unloaded",a(null);if(M)return M.name==="AbortError"?void 0:(e.state="errored",a(M));if(this.map._refreshExpiredTiles&&L){const V=i.aM(N);e.setExpiryData(V)}if(this.partial&&e.state!=="expired")e.state="empty";else if(!this.partial){if(!L)return a(null);e.state="loaded",e._isHeaderLoaded=!0,e._mrt=L}a(null)};e.request=this.partial?e.fetchHeader(void 0,I.bind(this)):e.actor.send("loadTile",w,I.bind(this),void 0,!0)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,a){const f=e.texturePerLayer;if(e.flushAllQueues(),f.size){e.destroy(!0);for(const y of f.values())this.map.painter.saveTileTexture(y)}else e.destroy()}prepareTile(e,a,f,y){e._isHeaderLoaded&&(e.state!=="empty"&&(e.state="reloading"),e.fetchBandForRender(a,f,y,(w,I)=>{if(w)return e.state="errored",this.fire(new i.y(w)),void this.triggerRepaint(e);I&&(e._isHeaderLoaded=!0,e.setTexturePerLayer(f,I,this.map.painter),e.state="loaded",this.triggerRepaint(e))}))}getInitialBand(e){if(!this.rasterLayers)return 0;const a=this.rasterLayers.find(({id:w})=>w===e),f=a&&a.fields,y=f&&f.bands&&f.bands;return y?y[0]:0}getTextureDescriptor(e,a,f){if(!e)return;const y=a.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!y)return;let w=null;a instanceof i.aQ?w=a.paint.get("raster-array-band"):a instanceof i.aR&&(w=a.paint.get("raster-particle-array-band"));const I=w||this.getInitialBand(y);if(I==null)return;if(!e.textureDescriptorPerLayer.get(a.id))return void this.prepareTile(e,y,a.id,I);if(e.updateNeeded(a.id,I)&&!f)return;const M=e.textureDescriptorPerLayer.get(a.id);return Object.assign({},M,{texture:e.texturePerLayer.get(a.id)})}getImages(e,a){const f=new Map;for(const y of e)for(const w of a){const[I,M]=w.split("/"),L=y.getLayer(I);if(!L||!L.hasBand(M)||!L.hasDataForBand(M))continue;const{bytes:N,tileSize:V,buffer:Z}=L.getBandView(M),U=V+2*Z,X={data:new i.q({width:U,height:U},N),pixelRatio:2,sdf:!1,usvg:!1,version:0};f.set(w,X)}return f}queryRasterArrayValueByBandId(e,a,f){const y=a._mrt;return new Promise(w=>{const I={},M=new Set;for(const[L,N]of Object.entries(y.layers)){if(f.layerName&&L!==f.layerName)continue;const V={};I[L]=V;for(const{bands:Z}of N.dataIndex)for(const U of Z)f.bands&&!f.bands.includes(U)||(M.add(i.B(L,U)),a.fetchBand(L,null,U,X=>{i.o.frame(()=>{V[U]=X?null:wh([e.lng,e.lat],y,N.getBandView(U)),M.delete(i.B(L,U)),M.size===0&&w(I)})},!1))}M.size===0&&w(I)})}_loadTileForQuery(e,a){if(this._loadTileLoaded[e.uid])return void a(null,e._mrt);if(this._loadTilePending[e.uid])return void this._loadTilePending[e.uid].push(a);this._loadTilePending[e.uid]=[a];const f=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),y=this.map._requestManager.transformRequest(f,i.R.Tile);e.actor.send("loadTile",{request:y,uid:e.uid,tileID:e.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},(w,I,M)=>{if(w)return this._loadTilePending[e.uid].forEach(L=>L(w,null)),void delete this._loadTilePending[e.uid];if(!I)return this._loadTilePending[e.uid].forEach(L=>L(null,null)),void delete this._loadTilePending[e.uid];if(this.map._refreshExpiredTiles&&I){const L=i.aM(M);e.setExpiryData(L)}e._mrt=I,e._isHeaderLoaded=!0,e.state="loaded",this._loadTilePending[e.uid].forEach(L=>L(null,I)),this._loadTileLoaded[e.uid]=!0,delete this._loadTilePending[e.uid]},void 0,!0)}queryRasterArrayValueByAllBands(e,a,f){return new Promise((y,w)=>{this._loadTileForQuery(a,(I,M)=>{I?w(I):y(M?this.queryRasterArrayValueByBandId(e,a,f):null)})})}queryRasterArrayValue(e,a){const f=i.aS.convert(e),y=this.findLoadedParent(f);return y&&y._mrt?a.bands||!this.partial?this.queryRasterArrayValueByBandId(f,y,a):this.queryRasterArrayValueByAllBands(f,y,a):Promise.resolve(null)}findLoadedParent(e){const a=i.ae.fromLngLat(e,this.map.transform.tileSize),f=this.maxzoom+1,y=1<<f,w=Math.floor(a.x),I=Math.floor((a.x-w)*y),M=Math.floor(a.y*y),L=this.map.style.getSourceCache(this.id),N=new i.aP(f,w,f,I,M);return L.findLoadedParent(N,this.minzoom)}}const nl={vector:ta,raster:El,"raster-dem":class extends El{constructor(p,e,a,f){super(p,e,a,f),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},e),this.encoding=e.encoding||"mapbox"}loadTile(p,e){const a=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function f(y,w){y&&(p.state="errored",e(y)),w&&(p.dem=w,p.dem.onDeserialize(),p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0,p.state="loaded",e(null))}p.request=i.n(this.map._requestManager.transformRequest(a,i.R.Tile),function(y,w,I){if(delete p.request,p.aborted)p.state="unloaded",e(null);else if(y)p.state="errored",e(y);else if(w){const M=i.aM(I);this.map._refreshExpiredTiles&&p.setExpiryData(M);const L=ImageBitmap&&w instanceof ImageBitmap&&i.r(),N=1-(w.width-i.aO(w.width))/2;N<1||p.neighboringTiles||(p.neighboringTiles=this._getNeighboringTiles(p.tileID));const V=L?w:i.o.getImageData(w,N),Z={uid:p.uid,tileID:p.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:V,encoding:this.encoding,padding:N};p.actor&&p.state!=="expired"||(p.actor=this.dispatcher.getActor(),p.actor.send("loadTile",Z,f.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(p){const e=p.canonical,a=Math.pow(2,e.z),f=(e.x-1+a)%a,y=e.x===0?p.wrap-1:p.wrap,w=(e.x+1+a)%a,I=e.x+1===a?p.wrap+1:p.wrap,M={};return M[new i.aP(p.overscaledZ,y,e.z,f,e.y).key]={backfilled:!1},M[new i.aP(p.overscaledZ,I,e.z,w,e.y).key]={backfilled:!1},e.y>0&&(M[new i.aP(p.overscaledZ,y,e.z,f,e.y-1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,p.wrap,e.z,e.x,e.y-1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,I,e.z,w,e.y-1).key]={backfilled:!1}),e.y+1<a&&(M[new i.aP(p.overscaledZ,y,e.z,f,e.y+1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,p.wrap,e.z,e.x,e.y+1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,I,e.z,w,e.y+1).key]={backfilled:!1}),M}},"raster-array":es,geojson:class extends i.E{constructor(p,e,a,f){super(),this.id=p,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=a.getActor(),this.setEventedParent(f),this._data=e.data,this._options=Object.assign({},e),this._collectResourceTiming=e.collectResourceTiming,e.maxzoom!==void 0&&(this.maxzoom=e.maxzoom),e.minzoom!==void 0&&(this.minzoom=e.minzoom),e.type&&(this.type=e.type),e.attribution&&(this.attribution=e.attribution),this.promoteId=e.promoteId;const y=i.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:e.cluster||!1,geojsonVtOptions:{buffer:(e.buffer!==void 0?e.buffer:128)*y,tolerance:(e.tolerance!==void 0?e.tolerance:.375)*y,extent:i.al,maxZoom:this.maxzoom,lineMetrics:e.lineMetrics||!1,generateId:e.generateId||!1},superclusterOptions:{maxZoom:e.clusterMaxZoom!==void 0?e.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,e.clusterMinPoints||2),extent:i.al,radius:(e.clusterRadius!==void 0?e.clusterRadius:50)*y,log:!1,generateId:e.generateId||!1},clusterProperties:e.clusterProperties,filter:e.filter,dynamic:e.dynamic},e.workerOptions)}onAdd(p){this.map=p,this.setData(this._data)}setData(p){return this._data=p,this._updateWorkerData(),this}updateData(p){if(!this._options.dynamic)return this.fire(new i.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof p!="string"&&(p.type==="Feature"&&(p={type:"FeatureCollection",features:[p]}),p.type!=="FeatureCollection"))return this.fire(new i.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof p!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const e=new Map;for(const a of this._data.features)e.set(a.id,a);for(const a of p.features)e.set(a.id,a);this._data.features=[...e.values()]}else this._data=p;return this._updateWorkerData(!0),this}getClusterExpansionZoom(p,e){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:p,source:this.id,scope:this.scope},e),this}getClusterChildren(p,e){return this.actor.send("geojson.getClusterChildren",{clusterId:p,source:this.id,scope:this.scope},e),this}getClusterLeaves(p,e,a,f){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:p,limit:e,offset:a},f),this}_updateWorkerData(p=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new i.z("dataloading",{dataType:"source"})),this._loaded=!1;const e=Object.assign({append:p},this.workerOptions);e.scope=this.scope;const a=this._data;typeof a=="string"?(e.request=this.map._requestManager.transformRequest(i.o.resolveURL(a),i.R.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(a),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,(f,y)=>{if(this._loaded=!0,this._pendingLoad=null,f)this.fire(new i.y(f));else{const w={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&y&&y.resourceTiming&&y.resourceTiming[this.id]&&(w.resourceTiming=y.resourceTiming[this.id]),p&&(this._partialReload=!0),this.fire(new i.z("data",w)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(p),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const p=i.B(this.id,this.scope);this.map.style.clearSource(p),this._updateWorkerData()}loadTile(p,e){const a=p.actor?"reloadTile":"loadTile";p.actor=this.actor;const f=this.map.style?this.map.style.getLut(this.scope):null,y=f?{image:f.image.clone()}:null,w=this._partialReload,I={type:this.type,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:y,scope:this.scope,pixelRatio:i.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:p.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:w,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};p.request=this.actor.send(a,I,(M,L)=>w&&!L?(p.state="loaded",e(null)):(delete p.request,p.destroy(),p.aborted?e(null):M?e(M):(p.loadVectorData(L,this.map.painter,a==="reloadTile"),e(null))),void 0,a==="loadTile")}abortTile(p){p.request&&(p.request.cancel(),delete p.request),p.aborted=!0}unloadTile(p,e){this.actor.send("removeTile",{uid:p.uid,type:this.type,source:this.id,scope:this.scope}),p.destroy()}onRemove(p){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends i.aT{constructor(p,e,a,f){super(p,e,a,f),this.roundZoom=!0,this.type="video",this.options=e}load(){this._loaded=!1;const p=this.options;this.urls=[];for(const e of p.urls)this.urls.push(this.map._requestManager.transformRequest(e,i.R.Source).url);i.aU(this.urls,(e,a)=>{this._loaded=!0,e?this.fire(new i.y(e)):a&&(this.video=a,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(p){if(this.video){const e=this.video.seekable;p<e.start(0)||p>e.end(0)?this.fire(new i.y(new i.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${e.start(0)} and ${e.end(0)}-second mark.`))):this.video.currentTime=p}}getVideo(){return this.video}onAdd(p){this.map||(this.map=p,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const p=this.map.painter.context,e=p.gl;this.texture?this.video.paused||(this.texture.bind(e.LINEAR,e.CLAMP_TO_EDGE),e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,this.video)):(this.texture=new i.T(p,this.video,e.RGBA8),this.texture.bind(e.LINEAR,e.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(p)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:i.aT,model:i.aW,"batched-model":class extends i.E{constructor(p,e,a,f){super(),this.type="batched-model",this.id=p,this.tileSize=512,this._options=e,this.tiles=this._options.tiles,this.maxzoom=e.maxzoom||19,this.minzoom=e.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=a,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(f)}onAdd(p){this.map=p,this.load()}reload(){this.cancelTileJSONRequest();const p=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(p))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(p){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));const e=Array.isArray(this.map._language)?this.map._language.join():this.map._language,a=this.map.getWorldview();this._tileJSONRequest=Tn(this._options,this.map._requestManager,e,a,(f,y)=>{this._tileJSONRequest=null,this._loaded=!0,f?(e&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${e}`),a&&a.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${a}`),this.fire(new i.y(f))):y&&(Object.assign(this,y),y.bounds&&(this.tileBounds=new os(y.bounds,this.minzoom,this.maxzoom)),Js(y.tiles,this.map._requestManager._customAccessToken),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))),p&&p(f)})}hasTransition(){return!1}hasTile(p){return!this.tileBounds||this.tileBounds.contains(p.canonical)}loaded(){return this._loaded}loadTile(p,e){const a=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme)),f={request:this.map._requestManager.transformRequest(a,i.R.Tile),data:void 0,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,tileSize:this.tileSize*p.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:p.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:i.o.devicePixelRatio,promoteId:this.promoteId};if(p.actor&&p.state!=="expired")if(p.state==="loading")p.reloadCallback=e;else{if(p.buckets){const w=Object.values(p.buckets);for(const I of w)I.dirty=!0;return void(p.state="loaded")}p.request=p.actor.send("reloadTile",f,y.bind(this))}else p.actor=this.dispatcher.getActor(),p.request=p.actor.send("loadTile",f,y.bind(this),void 0,!0);function y(w,I){return p.aborted?e(null):w&&w.status!==404?e(w):(this.map._refreshExpiredTiles&&I&&p.setExpiryData(I),p.loadModelData(I,this.map.painter),p.state="loaded",void e(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends i.aT{constructor(p,e,a,f){super(p,e,a,f),e.coordinates?Array.isArray(e.coordinates)&&e.coordinates.length===4&&!e.coordinates.some(y=>!Array.isArray(y)||y.length!==2||y.some(w=>typeof w!="number"))||this.fire(new i.y(new i.V(`sources.${p}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new i.y(new i.V(`sources.${p}`,null,'missing required property "coordinates"'))),e.animate&&typeof e.animate!="boolean"&&this.fire(new i.y(new i.V(`sources.${p}`,null,'optional "animate" property must be a boolean value'))),e.canvas?typeof e.canvas=="string"||e.canvas instanceof HTMLCanvasElement||this.fire(new i.y(new i.V(`sources.${p}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new i.y(new i.V(`sources.${p}`,null,'missing required property "canvas"'))),this.options=e,this.animate=e.animate===void 0||e.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new i.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(p){this.map=p,this.load(),this.canvas&&this.animate&&this.play()}onRemove(p){this.pause()}prepare(){let p=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,p=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,p=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const e=this.map.painter.context;this.texture?!p&&!this._playing||this.texture instanceof i.aV||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new i.T(e,this.canvas,e.gl.RGBA8,{premultiply:!0}),this._prepareData(e)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const p of[this.canvas.width,this.canvas.height])if(isNaN(p)||p<=0)return!0;return!1}},custom:class extends i.E{constructor(p,e,a,f){super(),this.id=p,this.type="custom",this._dataType="raster",this._dispatcher=a,this._implementation=e,this.setEventedParent(f),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new i.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new i.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new os(this._implementation.bounds,this.minzoom,this.maxzoom)),e.update=this._update.bind(this),e.clearTiles=this._clearTiles.bind(this),e.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,i.aH(e,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return i.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(p){this.map=p,this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(p),this.load()}onRemove(p){this._implementation.onRemove&&this._implementation.onRemove(p)}hasTile(p){if(this._implementation.hasTile){const{x:e,y:a,z:f}=p.canonical;return this._implementation.hasTile({x:e,y:a,z:f})}return!this.tileBounds||this.tileBounds.contains(p.canonical)}loadTile(p,e){const{x:a,y:f,z:y}=p.tileID.canonical,w=new AbortController;p.request=Promise.resolve(this._implementation.loadTile({x:a,y:f,z:y},{signal:w.signal})).then(function(I){return delete p.request,p.aborted?(p.state="unloaded",e(null)):I===void 0?(p.state="errored",e(null)):I===null?(this.loadTileData(p,{width:this.tileSize,height:this.tileSize,data:null}),p.state="loaded",e(null)):function(M){return M instanceof ImageData||M instanceof HTMLCanvasElement||M instanceof ImageBitmap||M instanceof HTMLImageElement}(I)?(this.loadTileData(p,I),p.state="loaded",void e(null)):(p.state="errored",e(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch(I=>{I.name!=="AbortError"&&(p.state="errored",e(I))}),p.request.cancel=()=>w.abort()}loadTileData(p,e){p.setTexture(e,this.map.painter)}unloadTile(p,e){if(p.texture&&p.texture instanceof i.T?(p.destroy(!0),p.texture&&p.texture instanceof i.T&&this.map.painter.saveTileTexture(p.texture)):p.destroy(),this._implementation.unloadTile){const{x:a,y:f,z:y}=p.tileID.canonical;this._implementation.unloadTile({x:a,y:f,z:y})}e&&e()}abortTile(p,e){p.request&&p.request.cancel&&(p.request.cancel(),delete p.request),e&&e()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(p=>({x:p.canonical.x,y:p.canonical.y,z:p.canonical.z}))}_clearTiles(){const p=i.B(this.id,this.scope);this.map.style.clearSource(p)}_update(){this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}}},_a=function(p,e,a,f){const y=new nl[e.type](p,e,a,f);if(y.id!==p)throw new Error(`Expected Source id to be ${p} instead of ${y.id}`);return i.aX(["load","abort","unload","serialize","prepare"],y),y};function Al(p,e,a=""){return`${a}:${e.id||""}:${e.layer.id}:${function(f){if("layerId"in f)return`layer:${f.layerId}`;{const{featuresetId:y,importId:w}=f;return`featureset:${y}${w?`:import:${w}`:""}`}}(p.target)}`}function Pa(p,e,a,f=""){if(p.uniqueFeatureID){const y=Al(p,e,f);if(a.has(y))return!0;a.add(y)}return!1}function $a(p,e,a,f,y=!1){const w=e.sourceCache.transform,I=e.sourceCache.tilesIn(p,e.has3DLayers,y);I.sort(Ou);const M=[];for(const L of I){const N=L.tile.queryRenderedFeatures(e,L,a,f,w,y);Object.keys(N).length&&M.push({wrappedTileID:L.tile.tileID.wrapped().key,queryResults:N})}for(const L in e.layers){const N=e.layers[L];if(N.styleLayer){const V=N.styleLayer.queryRenderedFeatures(p,e.sourceCache,f);Object.keys(V).length&&M.push({wrappedTileID:0,queryResults:V})}}return M.length===0?{}:function(L){const N={},V={};for(const Z of L){const U=Z.queryResults,X=Z.wrappedTileID,Q=V[X]=V[X]||{};for(const nt in U){const ht=U[nt],lt=Q[nt]=Q[nt]||{},_t=N[nt]=N[nt]||[];for(const Ct of ht)lt[Ct.featureIndex]||(lt[Ct.featureIndex]=!0,_t.push(Ct))}}return N}(M)}function ql(p,e,a,f,y,w){const I={},M=f.queryRenderedSymbols(p),L=[];for(const N of Object.keys(M).map(Number))L.push(y[N]);L.sort(Ou);for(const N of L){const V=N.featureIndex.lookupSymbolFeatures(M[N.bucketInstanceId],N.bucketIndex,N.sourceLayerIndex,e,a,w);for(const Z in V){const U=I[Z]=I[Z]||[],X=V[Z];X.sort((Q,nt)=>{const ht=N.featureSortOrder;if(ht){const lt=ht.indexOf(Q.featureIndex);return ht.indexOf(nt.featureIndex)-lt}return nt.featureIndex-Q.featureIndex});for(const Q of X)U.push(Q)}}return I}function Th(p,e){const a=p.getRenderableIds().map(w=>p.getTileByID(w)),f=[],y={};for(let w=0;w<a.length;w++){const I=a[w],M=I.tileID.canonical.key;y[M]||(y[M]=!0,I.querySourceFeatures(f,e))}return f}function Ou(p,e){const a=p.tileID,f=e.tileID;return a.overscaledZ-f.overscaledZ||a.canonical.y-f.canonical.y||a.wrap-f.wrap||a.canonical.x-f.canonical.x}function ol(p,e){const a={};if(!e)return a;for(const f of p){const y=f.layerIds.map(w=>e.getLayer(w)).filter(Boolean);if(y.length!==0){f.layers=y,f.stateDependentLayerIds&&(f.stateDependentLayers=f.stateDependentLayerIds.map(w=>y.filter(I=>I.id===w)[0]));for(const w of y)a[w.fqid]=f}}return a}const Ma=32,oc=33,ss=new Uint16Array(8184);for(let p=0;p<2046;p++){let e=p+2,a=0,f=0,y=0,w=0,I=0,M=0;for(1&e?y=w=I=Ma:a=f=M=Ma;(e>>=1)>1;){const N=a+y>>1,V=f+w>>1;1&e?(y=a,w=f,a=I,f=M):(a=y,f=w,y=I,w=M),I=N,M=V}const L=4*p;ss[L+0]=a,ss[L+1]=f,ss[L+2]=y,ss[L+3]=w}const Gs=new Uint16Array(2178),tn=new Uint8Array(1089),ea=new Uint16Array(1089);function Mn(p){return p===0?-.03125:p===32?.03125:0}const sc={type:2,extent:i.al,loadGeometry:()=>[[new i.P(0,0),new i.P(i.al+1,0),new i.P(i.al+1,i.al+1),new i.P(0,i.al+1),new i.P(0,0)]]};class Lo{constructor(e,a,f,y,w,I){this.tileID=e,this.uid=i.b1(),this.uses=0,this.tileSize=a,this.tileZoom=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=w,y&&y.style&&(this._lastUpdatedBrightness=y.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",y&&y.transform&&(this.projection=y.transform.projection),this.worldview=I,this._hasAppearances=null}registerFadeDuration(e){const a=e+this.timeAdded;a<i.o.now()||this.fadeEndTime&&a<this.fadeEndTime||(this.fadeEndTime=a)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=i.aY(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(e,a,f){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=ol(e.buckets,a.style),this.hasSymbolBuckets=!1;for(const y in this.buckets){const w=this.buckets[y];if(w instanceof i.b3){if(this.hasSymbolBuckets=!0,!f)break;w.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const y in this.buckets){const w=this.buckets[y];if(w instanceof i.b3&&w.hasRTLText){this.hasRTLText=!0,i.b4();break}}this.queryPadding=0;for(const y in this.buckets){const w=this.buckets[y],I=a.style.getOwnLayer(y);if(!I)continue;const M=I.queryRadius(w);this.queryPadding=Math.max(this.queryPadding,M)}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas),this._lastUpdatedBrightness=e.brightness}else this.collisionBoxArray=new i.b2}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(e,a,f){e&&(e.resourceTiming&&(this.resourceTiming=e.resourceTiming),this.buckets=Object.assign({},this.buckets,ol(e.buckets,a.style)),e.featureIndex&&(this.latestFeatureIndex=e.featureIndex))}getBucket(e){return this.buckets[e.fqid]}upload(e,a){for(const w in this.buckets){const I=this.buckets[w];if(I.uploadPending()){let M={},L=[],N={zoom:0,pitch:0,brightness:0,worldview:""};if(a){if(a.style){L=a.style.listImages();const V=I.layers[0],Z=V.sourceLayer||"_geojsonTileLayer",U=a.style.getLayerSourceCache(V);U&&(M=U._state.getState(Z,void 0))}N={zoom:a.transform.zoom||0,pitch:a.transform.pitch||0,brightness:a.style.getBrightness()||0,worldview:a.worldview||""}}I.upload(e,this.tileID.canonical,M,L,N)}}const f=e.gl,y=this.imageAtlas;y&&!y.uploaded&&(this.imageAtlasTexture=new i.T(e,y.image,f.RGBA8,{useMipmap:!!y.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new i.T(e,this.glyphAtlasImage,f.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new i.T(e,this.lineAtlas.image,f.R8),this.lineAtlas.uploaded=!0)}prepare(e,a,f){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture,f),!a||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const y=a.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(a)),(this._lastUpdatedBrightness||y||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&y&&Math.abs(this._lastUpdatedBrightness-y)<.001||(this.updateBuckets(a,this._lastUpdatedBrightness!==y),this._lastUpdatedBrightness=y))}evaluateQueryRenderedFeaturePadding(){let e=0;for(const a in this.buckets){const f=this.buckets[a];f.evaluateQueryRenderedFeaturePadding&&(e=Math.max(e,f.evaluateQueryRenderedFeaturePadding()))}return e}queryRenderedFeatures(e,a,f,y,w,I){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const M=this.evaluateQueryRenderedFeaturePadding(),L=function(N,V){const Z=i.bp([],[.5*N.width,.5*-N.height,1]);return i.bq(Z,Z,[1,-1,0]),i.aB(Z,Z,N.calculateProjMatrix(V.toUnwrapped())),Float32Array.from(Z)}(w,this.tileID);return this.latestFeatureIndex.query(e,{tilespaceGeometry:a,pixelPosMatrix:L,transform:y,availableImages:f,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:M})}querySourceFeatures(e,a){const f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;const y=f.loadVTLayers(),w=a?a.sourceLayer:"",I=y._geojsonTileLayer||y[w];if(!I)return;const M=i.b5(a&&a.filter),{z:L,x:N,y:V}=this.tileID.canonical,Z={z:L,x:N,y:V};for(let U=0;U<I.length;U++){const X=I.feature(U);if(M.needGeometry){const ht=i.b6(X,!0);if(!M.filter(new i.ac(this.tileID.overscaledZ,{worldview:this.worldview}),ht,this.tileID.canonical))continue}else if(!M.filter(new i.ac(this.tileID.overscaledZ,{worldview:this.worldview}),X))continue;const Q=f.getId(X,w),nt=new i.b7(X,L,N,V,Q);nt.tile=Z,e.push(nt)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(e){const a=this.expirationTime;if(e.cacheControl){const f=i.b8(e.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const f=Date.now();let y=!1;if(this.expirationTime>f)y=!1;else if(a)if(this.expirationTime<a)y=!0;else{const w=this.expirationTime-a;w?this.expirationTime=f+Math.max(w,3e4):y=!0}else y=!0;y?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(e){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&e&&this.updateBuckets(e)}hasAppearances(e){for(const a in this.buckets)if(e.style.hasLayer(a)&&this.buckets[a].layers.some(f=>f.appearances&&f.appearances.length>0))return!0;return!1}updateBuckets(e,a){if(!this.latestFeatureIndex||!e.style)return;const f=this.latestFeatureIndex.loadVTLayers(),y=e.style.listImages(),w=e.style.getBrightness();for(const I in this.buckets){if(!e.style.hasLayer(I))continue;const M=this.buckets[I],L=M.layers[0],N=L.sourceLayer||"_geojsonTileLayer",V=f[N],Z=e.style.getLayerSourceCache(L);let U={};Z&&(U=Z._state.getState(N,void 0));const X=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},Q=Object.keys(U).length>0&&!a;if(M.hasAppearances=M.layers.some(ht=>ht.appearances&&ht.appearances.length>0),(Q&&M.stateDependentLayers.length!==0||a)&&M.update(U,V,y,X,Q?M.stateDependentLayers:M.layers,a,w),Q&&M.stateDependentLayers.length!==0||a||M.hasAppearances){const ht={zoom:e.transform.zoom,pitch:e.transform.pitch,brightness:e.style.getBrightness()||0,worldview:e.worldview};M.updateAppearances(this.tileID.canonical,U,y,ht)}(M instanceof i.b9||M instanceof i.ba)&&e._terrain&&e._terrain.enabled&&Z&&M.uploadPending()&&e._terrain._clearRenderCacheForTile(Z.id,this.tileID);const nt=e&&e.style&&e.style.getOwnLayer(I);nt&&(this.queryPadding=Math.max(this.queryPadding,nt.queryRadius(M)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<i.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=i.o.now()+e}setTexture(e,a){const f=a.context,y=f.gl;this.texture=this.texture||a.getTileTexture(e.width),this.texture&&this.texture instanceof i.T?this.texture.update(e):(this.texture=new i.T(f,e,y.RGBA8,{useMipmap:!0}),this.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE))}setDependencies(e,a){const f={};for(const y of a)f[y]=!0;this.dependencies[e]=f}hasDependency(e,a){for(const f of e){const y=this.dependencies[f];if(y){for(const w of a)if(y[w])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,a){if(!a||a.name==="mercator"||this._tileDebugBuffer)return;const f=i.bb(sc,this.tileID.canonical,this.tileTransform)[0],y=new i.bc,w=new i.bd;for(let I=0;I<f.length;I++){const{x:M,y:L}=f[I];y.emplaceBack(M,L),w.emplaceBack(I)}w.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(w),this._tileDebugBuffer=e.createVertexBuffer(y,i.be.members),this._tileDebugSegments=i.bf.simpleSegment(0,0,y.length,w.length)}_makeTileBoundsBuffers(e,a){if(this._tileBoundsBuffer||!a||a.name==="mercator")return;const f=i.bb(sc,this.tileID.canonical,this.tileTransform)[0];let y,w;if(this.isRaster){const I=function(M,L){const N=i.aY(M,L),V=Math.pow(2,M.z);for(let ht=0;ht<oc;ht++)for(let lt=0;lt<oc;lt++){const _t=i.aZ((M.x+(lt+Mn(lt))/Ma)/V),Ct=i.a_((M.y+(ht+Mn(ht))/Ma)/V),bt=L.project(_t,Ct),Gt=ht*oc+lt;Gs[2*Gt+0]=Math.round((bt.x*N.scale-N.x)*i.al),Gs[2*Gt+1]=Math.round((bt.y*N.scale-N.y)*i.al)}tn.fill(0),ea.fill(0);for(let ht=2045;ht>=0;ht--){const lt=4*ht,_t=ss[lt+0],Ct=ss[lt+1],bt=ss[lt+2],Gt=ss[lt+3],zt=_t+bt>>1,Zt=Ct+Gt>>1,Vt=zt+Zt-Ct,kt=Zt+_t-zt,Ht=Ct*oc+_t,pe=Gt*oc+bt,ae=Zt*oc+zt,Ce=Math.hypot((Gs[2*Ht+0]+Gs[2*pe+0])/2-Gs[2*ae+0],(Gs[2*Ht+1]+Gs[2*pe+1])/2-Gs[2*ae+1])>=16;tn[ae]=tn[ae]||(Ce?1:0),ht<1022&&(tn[ae]=tn[ae]||tn[(Ct+kt>>1)*oc+(_t+Vt>>1)]||tn[(Gt+kt>>1)*oc+(bt+Vt>>1)])}const Z=new i.a$,U=new i.b0;let X=0;function Q(ht,lt){const _t=lt*oc+ht;return ea[_t]===0&&(Z.emplaceBack(Gs[2*_t+0],Gs[2*_t+1],ht*i.al/Ma,lt*i.al/Ma),ea[_t]=++X),ea[_t]-1}function nt(ht,lt,_t,Ct,bt,Gt){const zt=ht+_t>>1,Zt=lt+Ct>>1;if(Math.abs(ht-bt)+Math.abs(lt-Gt)>1&&tn[Zt*oc+zt])nt(bt,Gt,ht,lt,zt,Zt),nt(_t,Ct,bt,Gt,zt,Zt);else{const Vt=Q(ht,lt),kt=Q(_t,Ct),Ht=Q(bt,Gt);U.emplaceBack(Vt,kt,Ht)}}return nt(0,0,Ma,Ma,Ma,0),nt(Ma,Ma,0,0,0,Ma),{vertices:Z,indices:U}}(this.tileID.canonical,a);y=I.vertices,w=I.indices}else{y=new i.a$,w=new i.b0;for(const{x:M,y:L}of f)y.emplaceBack(M,L,0,0);const I=i.bg(y.int16.subarray(0,4*y.length),void 0,4);for(let M=0;M<I.length;M+=3)w.emplaceBack(I[M],I[M+1],I[M+2])}this._tileBoundsBuffer=e.createVertexBuffer(y,i.bh.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(w),this._tileBoundsSegments=i.bf.simpleSegment(0,0,y.length,w.length)}_makeGlobeTileDebugBuffers(e,a){const f=a.projection;if(!f||f.name!=="globe"||a.freezeTileCoverage)return;const y=this.tileID.canonical,w=i.bi(y,a),I=i.bj(w),M=i.aj(a.zoom);let L;M>0&&(L=i.bk(new Float64Array(16),a.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(e,y,a,I,L,M),this._makeGlobeTileDebugTextBuffer(e,y,a,I,L,M)}_globePoint(e,a,f,y,w,I,M){let L=i.bl(e,a,f);if(I){const N=1<<f.z,V=i.aF(y.center.lng),Z=i.aJ(y.center.lat),U=(f.x+.5)/N-V;let X=0;U>.5?X=-1:U<-.5&&(X=1);let Q=(e/i.al+f.x)/N+X,nt=(a/i.al+f.y)/N;Q=(Q-V)*y._pixelsPerMercatorPixel+V,nt=(nt-Z)*y._pixelsPerMercatorPixel+Z;const ht=[Q*y.worldSize,nt*y.worldSize,0];i.af(ht,ht,I),L=i.bm(L,ht,M)}return i.af(L,L,w)}_makeGlobeTileDebugBorderBuffer(e,a,f,y,w,I){const M=new i.bc,L=new i.bd,N=new i.bn,V=(U,X,Q,nt,ht)=>{const lt=(Q-U)/(ht-1),_t=(nt-X)/(ht-1),Ct=M.length;for(let bt=0;bt<ht;bt++){const Gt=U+bt*lt,zt=X+bt*_t;M.emplaceBack(Gt,zt);const Zt=this._globePoint(Gt,zt,a,f,y,w,I);N.emplaceBack(Zt[0],Zt[1],Zt[2]),L.emplaceBack(Ct+bt)}},Z=i.al;V(0,0,Z,0,16),V(Z,0,Z,Z,16),V(Z,Z,0,Z,16),V(0,Z,0,0,16),this._tileDebugIndexBuffer=e.createIndexBuffer(L),this._tileDebugBuffer=e.createVertexBuffer(M,i.be.members),this._globeTileDebugBorderBuffer=e.createVertexBuffer(N,i.bo.members),this._tileDebugSegments=i.bf.simpleSegment(0,0,M.length,L.length)}_makeGlobeTileDebugTextBuffer(e,a,f,y,w,I){const M=i.al/4,L=new i.bc,N=new i.b0,V=new i.bn,Z=25;N.reserve(32),L.reserve(Z),V.reserve(Z);const U=(X,Q)=>Z*X+Q;for(let X=0;X<Z;X++){const Q=X*M;for(let nt=0;nt<Z;nt++){const ht=nt*M;L.emplaceBack(ht,Q);const lt=this._globePoint(ht,Q,a,f,y,w,I);V.emplaceBack(lt[0],lt[1],lt[2])}}for(let X=0;X<4;X++)for(let Q=0;Q<4;Q++){const nt=U(X,Q),ht=U(X,Q+1),lt=U(X+1,Q),_t=U(X+1,Q+1);N.emplaceBack(nt,ht,lt),N.emplaceBack(lt,ht,_t)}this._tileDebugTextIndexBuffer=e.createIndexBuffer(N),this._tileDebugTextBuffer=e.createVertexBuffer(L,i.be.members),this._globeTileDebugTextBuffer=e.createVertexBuffer(V,i.bo.members),this._tileDebugTextSegments=i.bf.simpleSegment(0,0,Z,32)}destroy(e=!1){for(const a in this.buckets)this.buckets[a].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!e&&this.texture&&this.texture instanceof i.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}i.br.setPbf(i.bs);class as extends Lo{constructor(e,a,f,y,w){super(e,a,f,y,w),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(e){return this._mrt&&this._mrt.getLayer(e)}setTexturePerLayer(e,a,f){const y=f.context,w=y.gl;let I=this.texturePerLayer.get(e)||f.getTileTexture(a.width);I&&I instanceof i.T?I.update(a,{premultiply:!1}):I=new i.T(y,a,w.RGBA8,{premultiply:!1}),this.texturePerLayer.has(e)||this.texturePerLayer.set(e,I)}flushQueues(e){const a=this._workQueuePerLayer.get(e)||[],f=this._fetchQueuePerLayer.get(e)||[];for(;a.length;)a.pop()();for(;f.length;)f.pop()()}flushAllQueues(){for(const e of this._workQueuePerLayer.keys()){const a=this._workQueuePerLayer.get(e)||[];for(;a.length;)a.pop()()}for(const e of this._fetchQueuePerLayer.keys()){const a=this._fetchQueuePerLayer.get(e)||[];for(;a.length;)a.pop()()}}fetchHeader(e=16384,a){const f=this._mrt=new i.br(30),y=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(e-1)}});return this.entireBuffer=null,this.request=i.bt(y,(w,I,M)=>{if(w)a(w);else try{const L=f.getHeaderLength(I);if(L>e)return void(this.request=this.fetchHeader(L,a));f.parseHeader(I),this._isHeaderLoaded=!0;let N=0;for(const V of Object.values(f.layers))N=Math.max(N,V.dataIndex[V.dataIndex.length-1].lastByte);I.byteLength>=N&&(this.entireBuffer=I),a(null,this.entireBuffer||I,M)}catch(L){a(L)}}),this.request}fetchBandForRender(e,a,f,y){this.fetchBand(e,a,f,w=>{if(w)return void y(w);this.updateTextureDescriptor(e,a,f);const I=this.textureDescriptorPerLayer.get(a);y(null,I?I.img:null)})}fetchBand(e,a,f,y,w=!0){const I=this._mrt;if(!this._isHeaderLoaded||!I)return void y(new Error("Tile header is not ready"));const M=this.actor;if(!M)return void y(new Error("Can't fetch tile band without an actor"));let L;const N=i.B(String(f),i.B(this.tileID.key,e));let V=this._taskQueue.get(N);V?V.add(y):(V=new Set,V.add(y),this._taskQueue.set(N,V));const Z=(nt,ht)=>{L.complete(nt,ht),nt?y(nt):(V.values().forEach(lt=>lt(null,ht)),this._taskQueue.delete(N))},U=(nt,ht)=>{if(nt)return y(nt);const lt=M.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:ht,task:L},Z,void 0,!0);if(a!==null){const _t=this._workQueuePerLayer.get(a)||[];_t.push(()=>{lt&&lt.cancel(),L.cancel()}),this._workQueuePerLayer.has(a)||this._workQueuePerLayer.set(a,_t)}};let X;try{X=I.getLayer(e)}catch(nt){if(this.state==="reloading")return;throw nt}if(!X)return void y(new Error(`Unknown sourceLayer "${e}"`));if(X.hasDataForBand(f))return V.values().forEach(nt=>nt(null,null)),void this._taskQueue.delete(N);const Q=X.getDataRange([f]);if(L=I.createDecodingTask(Q),!L||L.tasks.length)if(a!==null&&this.flushQueues(a),this.entireBuffer)U(null,this.entireBuffer.slice(Q.firstByte,Q.lastByte+1));else{const nt=Object.assign({},this.requestParams,{headers:{Range:`bytes=${Q.firstByte}-${Q.lastByte}`}}),ht=i.bt(nt,U);if(a!==null){const lt=this._fetchQueuePerLayer.get(a)||[];lt.push(()=>{ht.cancel(),L.cancel()}),this._fetchQueuePerLayer.has(a)||this._fetchQueuePerLayer.set(a,lt)}}}updateNeeded(e,a){return(!this.textureDescriptorPerLayer.get(e)||this.textureDescriptorPerLayer.get(e).band!==a||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(e,a,f){if(!this._mrt)return;const y=this._mrt.getLayer(e);if(!y||!y.hasBand(f)||!y.hasDataForBand(f))return;const{bytes:w,tileSize:I,buffer:M,offset:L,scale:N}=y.getBandView(f),V=I+2*M,Z=new i.q({width:V,height:V},w),U=this.texturePerLayer.get(a);U&&U instanceof i.T&&U.update(Z,{premultiply:!1}),this.textureDescriptorPerLayer.set(a,{layer:e,band:f,img:Z,buffer:M,offset:L,tileSize:I,format:y.pixelFormat,mix:[N,256*N,65536*N,16777216*N]})}destroy(e=!1){if(super.destroy(e),delete this._mrt,!e)for(const a of this.texturePerLayer.values())a&&a instanceof i.T&&a.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class ia{constructor(e,a){this.max=e,this.onRemove=a,this.reset()}reset(){for(const e in this.data)for(const a of this.data[e])a.timeout&&clearTimeout(a.timeout),this.onRemove(a.value);return this.data={},this.order=[],this}add(e,a,f){const y=e.wrapped().key;this.data[y]===void 0&&(this.data[y]=[]);const w={value:a,timeout:void 0};if(f!==void 0&&(w.timeout=setTimeout(()=>{this.remove(e,w)},f)),this.data[y].push(w),this.order.push(y),this.order.length>this.max){const I=this._getAndRemoveByKey(this.order[0]);I&&this.onRemove(I)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const a=this.data[e].shift();return a.timeout&&clearTimeout(a.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),a.value}getByKey(e){const a=this.data[e];return a?a[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,a){if(!this.has(e))return this;const f=e.wrapped().key,y=a===void 0?0:this.data[f].indexOf(a),w=this.data[f][y];return this.data[f].splice(y,1),w.timeout&&clearTimeout(w.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(w.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}filter(e){const a=[];for(const f in this.data)for(const y of this.data[f])e(y.value)||a.push(y);for(const f of a)this.remove(f.value.tileID,f)}}class Ls{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,a,f){const y=String(a);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][y]=this.stateChanges[e][y]||{},Object.assign(this.stateChanges[e][y],f),this.deletedStates[e]===null){this.deletedStates[e]={};for(const w in this.state[e])w!==y&&(this.deletedStates[e][w]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][y]===null){this.deletedStates[e][y]={};for(const w in this.state[e][y])f[w]||(this.deletedStates[e][y][w]=null)}else for(const w in f)this.deletedStates[e]&&this.deletedStates[e][y]&&this.deletedStates[e][y][w]===null&&delete this.deletedStates[e][y][w]}removeFeatureState(e,a,f){if(this.deletedStates[e]===null)return;const y=String(a);if(this.deletedStates[e]=this.deletedStates[e]||{},f&&a!==void 0)this.deletedStates[e][y]!==null&&(this.deletedStates[e][y]=this.deletedStates[e][y]||{},this.deletedStates[e][y][f]=null);else if(a!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][y])for(f in this.deletedStates[e][y]={},this.stateChanges[e][y])this.deletedStates[e][y][f]=null;else this.deletedStates[e][y]=null;else this.deletedStates[e]=null}getState(e,a){const f=this.state[e]||{},y=this.stateChanges[e]||{},w=this.deletedStates[e];if(w===null)return{};if(a!==void 0){const M=String(a),L=Object.assign({},f[M],y[M]);if(w){const N=w[a];if(N===null)return{};for(const V in N)delete L[V]}return L}const I=Object.assign({},f,y);if(w)for(const M in w)delete I[M];return I}initializeTileState(e,a){e.refreshFeatureState(a)}coalesceChanges(e,a){const f={};for(const y in this.stateChanges){this.state[y]=this.state[y]||{};const w={};for(const I in this.stateChanges[y])this.state[y][I]||(this.state[y][I]={}),Object.assign(this.state[y][I],this.stateChanges[y][I]),w[I]=this.state[y][I];f[y]=w}for(const y in this.deletedStates){this.state[y]=this.state[y]||{};const w={};if(this.deletedStates[y]===null)for(const I in this.state[y])w[I]={},this.state[y][I]={};else for(const I in this.deletedStates[y]){if(this.deletedStates[y][I]===null)this.state[y][I]={};else if(this.state[y][I])for(const M of Object.keys(this.deletedStates[y][I]))delete this.state[y][I][M];w[I]=this.state[y][I]}f[y]=f[y]||{},Object.assign(f[y],w)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(const y in e)e[y].refreshFeatureState(a)}}class On extends i.E{constructor(e,a,f){super(),this.id=e,this._onlySymbols=f,a.on("data",y=>{y.dataType==="source"&&y.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&y.dataType==="source"&&y.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),a.on("error",()=>{this._sourceErrored=!0}),this._source=a,this._tiles={},this._cache=new ia(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=a.minTileCacheSize,this._maxTileCacheSize=a.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Ls,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(e){this.map=e,this._minTileCacheSize=this._minTileCacheSize===void 0&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const e in this._tiles)if(!this._tiles[e].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,a){return e.isSymbolTile=this._onlySymbols,e.isExtraShadowCaster=this._shadowCasterTiles[e.tileID.key],this._source.loadTile(e,a)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e)}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e)}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const a in this._tiles){const f=this._tiles[a];f.upload(e,this.map?this.map.painter:void 0),f.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(e=>e.tileID).sort(Nu).map(e=>e.key)}getRenderableIds(e,a){const f=[];for(const y in this._tiles)this._isIdRenderable(+y,e,a)&&f.push(this._tiles[y]);return e?f.sort((y,w)=>{const I=y.tileID,M=w.tileID,L=new i.P(I.canonical.x,I.canonical.y)._rotate(this.transform.angle),N=new i.P(M.canonical.x,M.canonical.y)._rotate(this.transform.angle);return I.overscaledZ-M.overscaledZ||N.y-L.y||N.x-L.x}).map(y=>y.tileID.key):f.map(y=>y.tileID).sort(Nu).map(y=>y.key)}hasRenderableParent(e){const a=this.findLoadedParent(e,0);return!!a&&this._isIdRenderable(a.tileID.key)}_isIdRenderable(e,a,f){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(a||!this._tiles[e].holdingForFade())&&(f||!this._shadowCasterTiles[e])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(+e,"reloading")}}_reloadTile(e,a){const f=this._tiles[e];f&&(f.state!=="loading"&&(f.state=a),this._loadTile(f,this._tileLoaded.bind(this,f,e,a)))}_tileLoaded(e,a,f,y,w){if(y){if(e.state="errored",y.status!==404)this._source.fire(new i.y(y,{tile:e}));else{if(this._source.fire(new i.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:e})),!(e.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const M=this.map.painter.terrain;this.update(this.transform,M.getScaledDemTileSize(),!0),M.resetTileLookupCache(this.id)}else this.update(this.transform)}return}e.timeAdded=i.o.now(),f==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(a,e),this._source.type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null);let I=new Map;w&&w.responseHeaders&&(I=w.responseHeaders),this._source.fire(new i.z("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id,responseHeaders:I}))}_backfillDEM(e){const a=this.getRenderableIds();for(let y=0;y<a.length;y++){const w=a[y];if(e.neighboringTiles&&e.neighboringTiles[w]){const I=this.getTileByID(w);f(e,I),f(I,e)}}function f(y,w){if(!y.dem||y.dem.borderReady)return;y.needsHillshadePrepare=!0,y.needsDEMTextureUpload=!0;let I=w.tileID.canonical.x-y.tileID.canonical.x;const M=w.tileID.canonical.y-y.tileID.canonical.y,L=Math.pow(2,y.tileID.canonical.z),N=w.tileID.key;I===0&&M===0||Math.abs(M)>1||(Math.abs(I)>1&&(Math.abs(I+L)===1?I+=L:Math.abs(I-L)===1&&(I-=L)),w.dem&&y.dem&&(y.dem.backfillBorder(w.dem,I,M),y.neighboringTiles&&y.neighboringTiles[N]&&(y.neighboringTiles[N].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,a,f,y){for(const w in this._tiles){let I=this._tiles[w];if(y[w]||!I.hasData()||I.tileID.overscaledZ<=a||I.tileID.overscaledZ>f)continue;let M=I.tileID;for(;I&&I.tileID.overscaledZ>a+1;){const N=I.tileID.scaledTo(I.tileID.overscaledZ-1);I=this._tiles[N.key],I&&I.hasData()&&(M=N)}let L=M;for(;L.overscaledZ>a;)if(L=L.scaledTo(L.overscaledZ-1),e[L.key]){y[M.key]=M;break}}}findLoadedParent(e,a){if(e.key in this._loadedParentTiles){const f=this._loadedParentTiles[e.key];return f&&f.tileID.overscaledZ>=a?f:null}for(let f=e.overscaledZ-1;f>=a;f--){const y=e.scaledTo(f),w=this._getLoadedTile(y);if(w)return w}}_getLoadedTile(e){const a=this._tiles[e.key];return a&&a.hasData()?a:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,a){a=a||this._source.tileSize;const f=Math.ceil(e.width/a)+1,y=Math.ceil(e.height/a)+1,w=Math.floor(f*y*5),I=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,w):w,M=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,I):I;this._cache.setMaxSize(M)}handleWrapJump(e){const a=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,a){const f={};for(const y in this._tiles){const w=this._tiles[y];w.tileID=w.tileID.unwrapTo(w.tileID.wrap+a),f[w.tileID.key]=w}this._tiles=f;for(const y in this._timers)clearTimeout(this._timers[y]),delete this._timers[y];for(const y in this._tiles)this._setTileReloadTimer(+y,this._tiles[y])}}update(e,a,f,y,w){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!f)return;this.updateCacheSize(e,a),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const I=this._source.type==="batched-model";let M,L=this._source.maxzoom;const N=this.map&&this.map.painter?this.map.painter._terrain:null;if(N&&N.sourceCache===this&&N.attenuationRange()){const U=N.attenuationRange()[0],X=Math.floor(U)-Math.log2(N.getDemUpscale());L>X&&(L=X)}if(this.used||this.usedForTerrain){if(this._source.tileID)M=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(U=>new i.aP(U.canonical.z,U.wrap,U.canonical.z,U.canonical.x,U.canonical.y));else if(this.tileCoverLift!==0){const U=e.clone();U.tileCoverLift=this.tileCoverLift,M=U.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:L,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:I}),this._source.minzoom<=1&&e.projection.name==="globe"&&(M.push(new i.aP(1,0,1,0,0)),M.push(new i.aP(1,0,1,1,0)),M.push(new i.aP(1,0,1,0,1)),M.push(new i.aP(1,0,1,1,1)))}else if(M=e.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:L,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:I}),this._source.hasTile){const U=this._source.hasTile.bind(this._source);M=M.filter(X=>U(X))}}else M=[];if(M.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Is(this._source.type)){const U=e.coveringZoomLevel({tileSize:a||this._source.tileSize,roundZoom:this._source.roundZoom&&!f}),X=Math.min(U,this._source.maxzoom);if(I){const Q=e.extendTileCover(M,X);for(const nt of Q)M.push(nt)}else if(w){const Q=e.extendTileCoverToNearPlane(M,this.transform.getFrustum(X),X);for(const nt of Q)M.push(nt)}else if(this.castsShadows&&y){const Q=e.extendTileCover(M,X,y);for(const nt of Q)this._shadowCasterTiles[nt.key]=!0,M.push(nt)}}const V=this._updateRetainedTiles(M);if(Is(this._source.type)&&M.length!==0){const U={},X={},Q=Object.keys(V);for(const ht of Q){const lt=V[ht],_t=this._tiles[ht];if(!_t||_t.fadeEndTime&&_t.fadeEndTime<=i.o.now())continue;const Ct=this.findLoadedParent(lt,Math.max(lt.overscaledZ-On.maxOverzooming,this._source.minzoom));Ct&&(this._addTile(Ct.tileID),U[Ct.tileID.key]=Ct.tileID),X[ht]=lt}const nt=M[M.length-1].overscaledZ;for(const ht in this._tiles){const lt=this._tiles[ht];if(V[ht]||!lt.hasData())continue;let _t=lt.tileID;for(;_t.overscaledZ>nt;){_t=_t.scaledTo(_t.overscaledZ-1);const Ct=this._tiles[_t.key];if(Ct&&Ct.hasData()&&X[_t.key]){V[ht]=lt.tileID;break}}}for(const ht in U)V[ht]||(this._coveredTiles[ht]=!0,V[ht]=U[ht])}for(const U in V)this._tiles[U].clearFadeHold();const Z=i.bu(this._tiles,V);for(const U of Z){const X=this._tiles[U];X.hasSymbolBuckets&&!X.holdingForFade()?X.setHoldDuration(this.map._fadeDuration):X.hasSymbolBuckets&&!X.symbolFadeFinished()||this._removeTile(+U)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const a={};if(e.length===0)return a;const f={},y=e.reduce((N,V)=>Math.min(N,V.overscaledZ),1/0),w=e[0].overscaledZ,I=Math.max(w-On.maxOverzooming,this._source.minzoom),M=Math.max(w+On.maxUnderzooming,this._source.minzoom),L={};for(const N of e){const V=this._addTile(N);a[N.key]=N,V.hasData()||y<this._source.maxzoom&&(L[N.key]=N)}this._retainLoadedChildren(L,y,M,a);for(const N of e){let V=this._tiles[N.key];if(V.hasData())continue;if(N.canonical.z>=this._source.maxzoom){const U=N.children(this._source.maxzoom)[0],X=this.getTile(U);if(X&&X.hasData()){a[U.key]=U;continue}}else{const U=N.children(this._source.maxzoom);if(a[U[0].key]&&a[U[1].key]&&a[U[2].key]&&a[U[3].key])continue}let Z=V.wasRequested();for(let U=N.overscaledZ-1;U>=I;--U){const X=N.scaledTo(U);if(f[X.key]||(f[X.key]=!0,V=this.getTile(X),!V&&Z&&(V=this._addTile(X)),V&&(a[X.key]=X,Z=V.wasRequested(),V.hasData())))break}}return a}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const a=[];let f,y=this._tiles[e].tileID;for(;y.overscaledZ>0;){if(y.key in this._loadedParentTiles){f=this._loadedParentTiles[y.key];break}a.push(y.key);const w=y.scaledTo(y.overscaledZ-1);if(f=this._getLoadedTile(w),f)break;y=w}for(const w of a)this._loadedParentTiles[w]=f}}_addTile(e){let a=this._tiles[e.key];if(a)return a.isExtraShadowCaster!==!0||this._shadowCasterTiles[e.key]||this._reloadTile(e.key,"reloading"),a;a=this._cache.getAndRemove(e),a&&(this._setTileReloadTimer(e.key,a),a.tileID=e,this._state.initializeTileState(a,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,a)));const f=!!a;if(!f){const y=this.map?this.map.painter:null,w=this._source.tileSize*e.overscaleFactor();a=this._source.type==="raster-array"?new as(e,w,this.transform.tileZoom,y,this._isRaster):new Lo(e,w,this.transform.tileZoom,y,this._isRaster,this._source.worldview),this._loadTile(a,this._tileLoaded.bind(this,a,e.key,a.state))}return a.uses++,this._tiles[e.key]=a,f||this._source.fire(new i.z("dataloading",{tile:a,coord:a.tileID,dataType:"source"})),a}_setTileReloadTimer(e,a){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const f=a.getExpiryTimeout();f&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},f))}_removeTile(e){const a=this._tiles[e];a&&(a.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),a.uses>0||(a.hasData()&&a.state!=="reloading"||a.state==="empty"?this._cache.add(a.tileID,a,a.getExpiryTimeout()):(a.aborted=!0,this._abortTile(a),this._unloadTile(a))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(e,a,f){const y=[],w=this.transform;if(!w)return y;const I=w.projection.name==="globe",M=i.aF(w.center.lng);for(const L in this._tiles){const N=this._tiles[L];if(f&&N.clearQueryDebugViz(),N.holdingForFade())continue;let V;if(I){const Z=N.tileID.canonical;if(Z.z===0){const U=[Math.abs(i.aA(M,...Rs(Z,-1))-M),Math.abs(i.aA(M,...Rs(Z,1))-M)];V=[0,2*U.indexOf(Math.min(...U))-1]}else{const U=[Math.abs(i.aA(M,...Rs(Z,-1))-M),Math.abs(i.aA(M,...Rs(Z,0))-M),Math.abs(i.aA(M,...Rs(Z,1))-M)];V=[U.indexOf(Math.min(...U))-1]}}else V=[0];for(const Z of V){const U=e.containsTile(N,w,a,Z);U&&y.push(U)}}return y}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(e){return this._getRenderableCoordinates(e)}_getRenderableCoordinates(e,a){const f=this.getRenderableIds(e,a).map(w=>this._tiles[w].tileID),y=this.transform.projection.name==="globe";for(const w of f)w.projMatrix=this.transform.calculateProjMatrix(w.toUnwrapped()),w.expandedProjMatrix=y?this.transform.calculateProjMatrix(w.toUnwrapped(),!1,!0):w.projMatrix;return f}sortCoordinatesByDistance(e){const a=e.slice(),f=this.transform._camera.position,y=this.transform._camera.forward(),w={};for(const I of a){const M=1/(1<<I.canonical.z);w[I.key]=((I.canonical.x+.5)*M+I.wrap-f[0])*y[0]+((I.canonical.y+.5)*M-f[1])*y[1]-f[2]*y[2]}return a.sort((I,M)=>w[I.key]-w[M.key]),a}hasTransition(){if(this._source.hasTransition())return!0;if(Is(this._source.type))for(const e in this._tiles){const a=this._tiles[e];if(a.fadeEndTime!==void 0&&a.fadeEndTime>=i.o.now())return!0}return!1}setFeatureState(e,a,f){this._state.updateState(e=e||"_geojsonTileLayer",a,f)}removeFeatureState(e,a,f){this._state.removeFeatureState(e=e||"_geojsonTileLayer",a,f)}getFeatureState(e,a){return this._state.getState(e=e||"_geojsonTileLayer",a)}setDependencies(e,a,f){const y=this._tiles[e];y&&y.setDependencies(a,f)}reloadTilesForDependencies(e,a){for(const f in this._tiles)this._tiles[f].hasDependency(e,a)&&this._reloadTile(+f,"reloading");this._cache.filter(f=>!f.hasDependency(e,a))}_preloadTiles(e,a){if(!this._sourceLoaded){const L=()=>{this._sourceLoaded&&(this._source.off("data",L),this._preloadTiles(e,a))};return void this._source.on("data",L)}const f=new Map,y=Array.isArray(e)?e:[e],w=this.map.painter.terrain,I=this.usedForTerrain&&w?w.getScaledDemTileSize():this._source.tileSize;for(const L of y){const N=L.coveringTiles({tileSize:I,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const V of N)f.set(V.key,V);this.usedForTerrain&&L.updateElevation(!1)}const M=Array.from(f.values());i.bv(M,(L,N)=>{const V=new Lo(L,this._source.tileSize*L.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(V,Z=>{this._source.type==="raster-dem"&&V.dem&&this._backfillDEM(V),N(Z,V)})},a)}}function Nu(p,e){const a=Math.abs(2*p.wrap)-+(p.wrap<0),f=Math.abs(2*e.wrap)-+(e.wrap<0);return p.overscaledZ-e.overscaledZ||f-a||e.canonical.y-p.canonical.y||e.canonical.x-p.canonical.x}function Is(p){return p==="raster"||p==="image"||p==="video"||p==="custom"}function Rs(p,e){const a=1<<p.z;return[p.x/a+e,(p.x+1)/a+e]}On.maxOverzooming=10,On.maxUnderzooming=3;class ra{constructor(e){this.style=e,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const e=!1,a=!1;for(const f in this.style._mergedLayers){const y=this.style._mergedLayers[f];if(y.type==="fill-extrusion"||y.type==="building")this.layers.push({layer:y,visible:e,visibilityChanged:a});else if(y.type==="model"){const w=this.style.getLayerSource(y);w&&w.type==="batched-model"&&this.layers.push({layer:y,visible:e,visibilityChanged:a})}}}onNewFrame(e){this.layersGotHidden=!1;for(const a of this.layers){const f=a.layer;let y=!1;f.type==="fill-extrusion"?y=!f.isHidden(e)&&f.paint.get("fill-extrusion-opacity")>0:f.type==="building"?y=!f.isHidden(e)&&f.paint.get("building-opacity")>0:f.type==="model"&&(y=!f.isHidden(e)&&f.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!y&&a.visible,a.visible=y}}updateZOffset(e,a){this.currentBuildingBuckets=[];for(const y of this.layers){const w=y.layer,I=this.style.getLayerSourceCache(w);let M=1;w.type==="fill-extrusion"?M=y.visible?w.paint.get("fill-extrusion-vertical-scale"):0:w.type==="building"&&(M=y.visible?w.paint.get("building-vertical-scale"):0);let L=I?I.getTile(a):null;if(!L&&I)for(const N in I._tiles){const V=I._tiles[N];if(a.canonical.isChildOf(V.tileID.canonical)){L=V;break}}this.currentBuildingBuckets.push({bucket:L?L.getBucket(w):null,tileID:L?L.tileID:a,verticalScale:M})}e.hasAnyZOffset=!1;let f=!1;for(let y=0;y<e.symbolInstances.length;y++){const w=e.symbolInstances.get(y),I=w.zOffset,M=this._getHeightAtTileOffset(a,w.tileAnchorX,w.tileAnchorY);w.zOffset=M!==Number.NEGATIVE_INFINITY?M:I,f||I===w.zOffset||(f=!0),e.hasAnyZOffset||w.zOffset===0||(e.hasAnyZOffset=!0)}f&&(e.zOffsetBuffersNeedUpload=!0,e.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(e,a,f,y){let w=a,I=f;if(e.canonical.z!==y.canonical.z){const M=y.canonical,L=1/(1<<e.canonical.z-M.z);w=(a+e.canonical.x*i.al)*L-M.x*i.al|0,I=(f+e.canonical.y*i.al)*L-M.y*i.al|0}return{tileX:w,tileY:I}}_getHeightAtTileOffset(e,a,f){let y,w;for(let I=0;I<this.layers.length;++I){const M=this.layers[I].layer;if(M.type!=="fill-extrusion"&&M.type!=="building")continue;const{bucket:L,tileID:N,verticalScale:V}=this.currentBuildingBuckets[I];if(!L)continue;const{tileX:Z,tileY:U}=this._mapCoordToOverlappingTile(e,a,f,N),X=L.getHeightAtTileCoord(Z,U);X&&X.height!==void 0&&(X.hidden?y=X.height:w=Math.max(X.height*V,w||0))}if(w!==void 0)return w;for(let I=0;I<this.layers.length;++I){const M=this.layers[I];if(M.layer.type!=="model"||!M.visible)continue;const{bucket:L,tileID:N}=this.currentBuildingBuckets[I];if(!L)continue;const{tileX:V,tileY:Z}=this._mapCoordToOverlappingTile(e,a,f,N),U=L.getHeightAtTileCoord(V,Z);if(U&&!U.hidden)return U.height===void 0&&y!==void 0?Math.min(U.maxHeight,y)*U.verticalScale:U.height?U.height*U.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Vu(p,e){const a={};for(const f in p)f!=="ref"&&(a[f]=p[f]);return i.bw.forEach(f=>{f in e&&(a[f]=e[f])}),a}function Pl(p){p=p.slice();const e=Object.create(null);for(let a=0;a<p.length;a++)e[p[a].id]=p[a];for(let a=0;a<p.length;a++)"ref"in p[a]&&(p[a]=Vu(p[a],e[p[a].ref]));return p}const pr={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Sh(p,e,a){a.push({command:pr.addSource,args:[p,e[p]]})}function Zl(p,e,a){e.push({command:pr.removeSource,args:[p]}),a[p]=!0}function Wc(p,e,a,f){Zl(p,a,f),Sh(p,e,a)}function Ca(p,e,a){let f;for(f in p[a])if(p[a].hasOwnProperty(f)&&f!=="data"&&!i.bx(p[a][f],e[a][f]))return!1;for(f in e[a])if(e[a].hasOwnProperty(f)&&f!=="data"&&!i.bx(p[a][f],e[a][f]))return!1;return!0}function Eo(p,e,a,f,y,w){let I;for(I in e=e||{},p=p||{})p.hasOwnProperty(I)&&(i.bx(p[I],e[I])||a.push({command:w,args:[f,I,e[I],y]}));for(I in e)e.hasOwnProperty(I)&&!p.hasOwnProperty(I)&&(i.bx(p[I],e[I])||a.push({command:w,args:[f,I,e[I],y]}))}function sl(p){return p.id}function Rn(p,e){return p[e.id]=e,p}function Hr(p,e,a){const f=e.createTileMatrix(p,p.worldSize,a.toUnwrapped());return i.aB(new Float32Array(16),p.projMatrix,f)}function au(p,e,a){if(e.projection.name===a.projection.name)return p.projMatrix;const f=a.clone();return f.setProjection(e.projection),Hr(f,e.getProjection(),p)}function Cn(p,e,a){return e.name===a.projection.name?p.projMatrix:Hr(a,e,p)}class Uu{constructor(e,a){this.reset(e,a)}reset(e,a){this.points=e||[],this._distances=[0];for(let f=1;f<this.points.length;f++)this._distances[f]=this._distances[f-1]+this.points[f].dist(this.points[f-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(a||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(this.points.length===1)return this.points[0];e=i.aA(e,0,1);let a=1,f=this._distances[a];const y=e*this.paddedLength+this.padding;for(;f<y&&a<this._distances.length;)f=this._distances[++a];const w=a-1,I=this._distances[w],M=f-I,L=M>0?(y-I)/M:0;return this.points[w].mult(1-L).add(this.points[a].mult(L))}}class qa{constructor(e,a,f){const y=this.boxCells=[],w=this.circleCells=[];this.xCellCount=Math.ceil(e/f),this.yCellCount=Math.ceil(a/f);for(let I=0;I<this.xCellCount*this.yCellCount;I++)y.push([]),w.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=a,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/a,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,a,f,y,w){this._forEachCell(a,f,y,w,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(a),this.bboxes.push(f),this.bboxes.push(y),this.bboxes.push(w)}insertCircle(e,a,f,y){this._forEachCell(a-y,f-y,a+y,f+y,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(a),this.circles.push(f),this.circles.push(y)}_insertBoxCell(e,a,f,y,w,I){this.boxCells[w].push(I)}_insertCircleCell(e,a,f,y,w,I){this.circleCells[w].push(I)}_query(e,a,f,y,w,I){if(f<0||e>this.width||y<0||a>this.height)return!w&&[];const M=[];if(e<=0&&a<=0&&this.width<=f&&this.height<=y){if(w)return!0;for(let L=0;L<this.boxKeys.length;L++)M.push({key:this.boxKeys[L],x1:this.bboxes[4*L],y1:this.bboxes[4*L+1],x2:this.bboxes[4*L+2],y2:this.bboxes[4*L+3]});for(let L=0;L<this.circleKeys.length;L++){const N=this.circles[3*L],V=this.circles[3*L+1],Z=this.circles[3*L+2];M.push({key:this.circleKeys[L],x1:N-Z,y1:V-Z,x2:N+Z,y2:V+Z})}return I?M.filter(I):M}return this._forEachCell(e,a,f,y,this._queryCell,M,{hitTest:w,seenUids:{box:{},circle:{}}},I),w?M.length>0:M}_queryCircle(e,a,f,y,w){const I=e-f,M=e+f,L=a-f,N=a+f;if(M<0||I>this.width||N<0||L>this.height)return!y&&[];const V=[];return this._forEachCell(I,L,M,N,this._queryCellCircle,V,{hitTest:y,circle:{x:e,y:a,radius:f},seenUids:{box:{},circle:{}}},w),y?V.length>0:V}query(e,a,f,y,w){return this._query(e,a,f,y,!1,w)}hitTest(e,a,f,y,w){return this._query(e,a,f,y,!0,w)}hitTestCircle(e,a,f,y){return this._queryCircle(e,a,f,!0,y)}_queryCell(e,a,f,y,w,I,M,L){const N=M.seenUids,V=this.boxCells[w];if(V!==null){const U=this.bboxes;for(const X of V)if(!N.box[X]){N.box[X]=!0;const Q=4*X;if(e<=U[Q+2]&&a<=U[Q+3]&&f>=U[Q+0]&&y>=U[Q+1]&&(!L||L(this.boxKeys[X]))){if(M.hitTest)return I.push(!0),!0;I.push({key:this.boxKeys[X],x1:U[Q],y1:U[Q+1],x2:U[Q+2],y2:U[Q+3]})}}}const Z=this.circleCells[w];if(Z!==null){const U=this.circles;for(const X of Z)if(!N.circle[X]){N.circle[X]=!0;const Q=3*X;if(this._circleAndRectCollide(U[Q],U[Q+1],U[Q+2],e,a,f,y)&&(!L||L(this.circleKeys[X]))){if(M.hitTest)return I.push(!0),!0;{const nt=U[Q],ht=U[Q+1],lt=U[Q+2];I.push({key:this.circleKeys[X],x1:nt-lt,y1:ht-lt,x2:nt+lt,y2:ht+lt})}}}}}_queryCellCircle(e,a,f,y,w,I,M,L){const N=M.circle,V=M.seenUids,Z=this.boxCells[w];if(Z!==null){const X=this.bboxes;for(const Q of Z)if(!V.box[Q]){V.box[Q]=!0;const nt=4*Q;if(this._circleAndRectCollide(N.x,N.y,N.radius,X[nt+0],X[nt+1],X[nt+2],X[nt+3])&&(!L||L(this.boxKeys[Q])))return I.push(!0),!0}}const U=this.circleCells[w];if(U!==null){const X=this.circles;for(const Q of U)if(!V.circle[Q]){V.circle[Q]=!0;const nt=3*Q;if(this._circlesCollide(X[nt],X[nt+1],X[nt+2],N.x,N.y,N.radius)&&(!L||L(this.circleKeys[Q])))return I.push(!0),!0}}}_forEachCell(e,a,f,y,w,I,M,L){const N=this._convertToXCellCoord(e),V=this._convertToYCellCoord(a),Z=this._convertToXCellCoord(f),U=this._convertToYCellCoord(y);for(let X=N;X<=Z;X++)for(let Q=V;Q<=U;Q++)if(w.call(this,e,a,f,y,this.xCellCount*Q+X,I,M,L))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,a,f,y,w,I){const M=y-e,L=w-a,N=f+I;return N*N>M*M+L*L}_circleAndRectCollide(e,a,f,y,w,I,M){const L=(I-y)/2,N=Math.abs(e-(y+L));if(N>L+f)return!1;const V=(M-w)/2,Z=Math.abs(a-(w+V));if(Z>V+f)return!1;if(N<=L||Z<=V)return!0;const U=N-L,X=Z-V;return U*U+X*X<=f*f}}const ya={unknown:0,flipRequired:1,flipNotRequired:2},ac=Math.tan(85*Math.PI/180);function Xc(p,e,a,f,y,w,I){const M=i.bB();if(a)if(w.name==="globe"){const L=i.bC(y,e);i.aB(M,M,L)}else{const L=i.bD([],I);M[0]=L[0],M[1]=L[1],M[4]=L[2],M[5]=L[3],f||i.bA(M,M,y.angle)}else i.aB(M,y.labelPlaneMatrix,p);return M}function Yc(p,e,a,f,y,w,I){const M=Xc(p,e,a,f,y,w,I);return w.name==="globe"&&a||(M[2]=M[6]=M[10]=M[14]=0),M}function Ml(p,e,a,f,y,w,I){if(a){if(w.name==="globe"){const M=Xc(p,e,a,f,y,w,I);return i.bk(M,M),i.aB(M,p,M),M}{const M=i.by(p),L=i.bz([]);return L[0]=I[0],L[1]=I[1],L[4]=I[2],L[5]=I[3],i.aB(M,M,L),f||i.bA(M,M,-y.angle),M}}return y.glCoordMatrix}function Zo(p,e,a,f){const y=[p,e,a,1];a?i.aC(y,y,f):ll(y,y,f);const w=y[3];return y[0]/=w,y[1]/=w,y[2]/=w,y}function Ih(p,e){return Math.min(.5+p/e*.5,1.5)}function up(p,e){const a=p[0]/p[3],f=p[1]/p[3];return a>=-e[0]&&a<=e[0]&&f>=-e[1]&&f<=e[1]}function Hl(p,e,a,f,y,w,I,M,L,N,V=1){const Z=a.transform,U=f?p.textSizeData:p.iconSizeData,X=i.bJ(U,a.transform.zoom,V),Q=Z.projection.name==="globe",nt=[256/a.width*2+1,256/a.height*2+1],ht=f?p.text.dynamicLayoutVertexArray:p.icon.dynamicLayoutVertexArray;ht.clear();let lt=null;Q&&(lt=f?p.text.globeExtVertexArray:p.icon.globeExtVertexArray);const _t=p.lineVertexArray,Ct=f?p.text.placedSymbolArray:p.icon.placedSymbolArray,bt=a.transform.width/a.transform.height;let Gt,zt=!1;for(let Zt=0;Zt<Ct.length;Zt++){const Vt=Ct.get(Zt),{numGlyphs:kt,writingMode:Ht}=Vt;if(Ht!==i.bK.vertical||zt||Gt===i.bK.horizontal||(zt=!0),Gt=Ht,(Vt.hidden||Ht===i.bK.vertical)&&!zt){al(kt,ht);continue}zt=!1;const pe=new i.P(Vt.tileAnchorX,Vt.tileAnchorY),ae=p.elevationType==="road",Ce=!!Z.elevation||ae;let{x:ve,y:Fe,z:oi}=Z.projection.projectTilePoint(pe.x,pe.y,N.canonical),ge=null;if(Ce){const Ii=ae?p.getElevationFeatureForText(Zt):null;ge={getElevation:L,elevation:Z.elevation,elevationFeature:Ii};const[Zi,Fr,qr]=L(pe,Z.elevation,Ii);ve+=Zi,Fe+=Fr,oi+=qr}const re=[ve,Fe,oi,1];if(i.aC(re,re,e),!up(re,nt)){al(kt,ht);continue}const Be=re[3],Te=Ih(a.transform.getCameraToCenterDistance(Z.projection),Be),qe=i.bL(U,X,Vt),si=I?qe/Te:qe*Te,Ci=Zo(ve,Fe,oi,y);if(Ci[3]<=0){al(kt,ht);continue}let ni={};const li=i.an(p.layers[0].layout.get("text-max-angle")),Li=Math.cos(li),Ti=I?null:ge,xi=af(Vt,si,!1,M,e,y,w,p.glyphOffsetArray,_t,ht,lt,Ci,pe,ni,bt,Ti,Z.projection,N,I,Li);zt=xi.useVertical,Ti&&xi.needsFlipping&&(ni={}),(xi.notEnoughRoom||zt||xi.needsFlipping&&af(Vt,si,!0,M,e,y,w,p.glyphOffsetArray,_t,ht,lt,Ci,pe,ni,bt,Ti,Z.projection,N,I,Li).notEnoughRoom)&&al(kt,ht)}f?(p.text.dynamicLayoutVertexBuffer.updateData(ht),lt&&p.text.globeExtVertexBuffer&&p.text.globeExtVertexBuffer.updateData(lt)):(p.icon.dynamicLayoutVertexBuffer.updateData(ht),lt&&p.icon.globeExtVertexBuffer&&p.icon.globeExtVertexBuffer.updateData(lt))}function Dr(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht){const{lineStartIndex:lt,glyphStartIndex:_t,segment:Ct}=M,bt=_t+M.numGlyphs,Gt=lt+M.lineLength,zt=e.getoffsetX(_t),Zt=e.getoffsetX(bt-1),Vt=Za(p*zt,a,f,y,w,I,Ct,lt,Gt,L,N,V,Z,U,!0,X,Q,nt,ht);if(!Vt)return null;const kt=Za(p*Zt,a,f,y,w,I,Ct,lt,Gt,L,N,V,Z,U,!0,X,Q,nt,ht);return kt?{first:Vt,last:kt}:null}function ju(p,e,a,f){return p===i.bK.horizontal&&Math.abs(f)>Math.abs(a)?{useVertical:!0}:p===i.bK.vertical?f>0?{needsFlipping:!0}:null:e!==ya.unknown&&function(y,w){return y===0||Math.abs(w/y)>ac}(a,f)?e===ya.flipRequired?{needsFlipping:!0}:null:a<0?{needsFlipping:!0}:null}function af(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt,_t,Ct){const bt=e/24,Gt=p.lineOffsetX*bt,zt=p.lineOffsetY*bt,{lineStartIndex:Zt,glyphStartIndex:Vt,numGlyphs:kt,segment:Ht,writingMode:pe,flipState:ae}=p,Ce=Zt+p.lineLength,ve=Fe=>{if(V){const[Be,Te,qe]=Fe.up,si=N.length;i.bM(V,si+0,Be,Te,qe),i.bM(V,si+1,Be,Te,qe),i.bM(V,si+2,Be,Te,qe),i.bM(V,si+3,Be,Te,qe)}const[oi,ge,re]=Fe.point;i.bN(N,oi,ge,re,Fe.angle)};if(kt>1){const Fe=Dr(bt,M,Gt,zt,a,Z,U,p,L,w,X,nt,!1,ht,lt,_t,Ct);if(!Fe)return{notEnoughRoom:!0};if(f&&!a){let[oi,ge,re]=Fe.first.point,[Be,Te,qe]=Fe.last.point;[oi,ge]=Zo(oi,ge,re,I),[Be,Te]=Zo(Be,Te,qe,I);const si=ju(pe,ae,(Be-oi)*Q,Te-ge);if(p.flipState=si&&si.needsFlipping?ya.flipRequired:ya.flipNotRequired,si)return si}ve(Fe.first);for(let oi=Vt+1;oi<Vt+kt-1;oi++){const ge=Za(bt*M.getoffsetX(oi),Gt,zt,a,Z,U,Ht,Zt,Ce,L,w,X,nt,!1,!1,ht,lt,_t,Ct);if(!ge)return N.length-=4*(oi-Vt),{notEnoughRoom:!0};ve(ge)}ve(Fe.last)}else{if(f&&!a){const oi=Zo(U.x,U.y,0,y),ge=Zt+Ht+1,re=new i.P(L.getx(ge),L.gety(ge)),Be=Zo(re.x,re.y,0,y),Te=Be[3]>0?Be:Vi(U,re,oi,1,y,void 0,ht,lt.canonical),qe=ju(pe,ae,(Te[0]-oi[0])*Q,Te[1]-oi[1]);if(p.flipState=qe&&qe.needsFlipping?ya.flipRequired:ya.flipNotRequired,qe)return qe}const Fe=Za(bt*M.getoffsetX(Vt),Gt,zt,a,Z,U,Ht,Zt,Ce,L,w,X,nt,!1,!1,ht,lt,_t,Ct);if(!Fe)return{notEnoughRoom:!0};ve(Fe)}return{}}function na(p,e,a,f,y){const{x:w,y:I,z:M}=f.projectTilePoint(p.x,p.y,e);if(!y)return Zo(w,I,M,a);const[L,N,V]=y.getElevation(p,y.elevation,y.elevationFeature);return Zo(w+L,I+N,M+V,a)}function Vi(p,e,a,f,y,w,I,M){const L=na(p.sub(e)._unit()._add(p),M,y,I,w);return i.av(L,a,L),i.aw(L,L),i.bG(L,a,L,f)}function Za(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt,_t){const Ct=f?p-e:p+e;let bt=Ct>0?1:-1,Gt=0;f&&(bt*=-1,Gt=Math.PI),bt<0&&(Gt+=Math.PI);let zt=M+I+(bt>0?0:1)|0,Zt=y,Vt=y,kt=0,Ht=0;const pe=Math.abs(Ct),ae=[],Ce=[];let ve=w,Fe=ve,oi=i.bE([]);const ge=()=>Vi(Fe,ve,Vt,pe-kt+1,V,U,nt,ht.canonical);for(;kt+Ht<=pe;){if(zt+=bt,zt<M||zt>=L)return null;if(Vt=Zt,Fe=ve,ae.push(Vt),X&&Ce.push(Fe),ve=new i.P(N.getx(zt),N.gety(zt)),Zt=Z[zt],!Zt){const Ti=na(ve,ht.canonical,V,nt,U);Zt=Ti[3]>0?Z[zt]=Ti:ge()}kt+=Ht;const li=i.av([],Zt,Vt),Li=i.bF(Vt,Zt);if(a&&Li>0&&Ht>0&&i.bI(oi,li)/(Ht*Li)<_t)return null;Ht=Li,oi=li}Q&&U&&(Z[zt]&&(Zt=ge(),Ht=i.bF(Vt,Zt),oi=i.av([],Zt,Vt)),Z[zt]=Zt);const re=(pe-kt)/Ht,Be=ve.sub(Fe)._mult(re)._add(Fe),Te=i.bG([],Vt,oi,re);let qe=[0,0,1],si=oi[0],Ci=oi[1];if(lt&&(qe=nt.upVector(ht.canonical,Be.x,Be.y),qe[0]!==0||qe[1]!==0||qe[2]!==1)){const li=[qe[2],0,-qe[0]],Li=i.bH([],qe,li);i.aw(li,li),i.aw(Li,Li),si=i.bI(oi,li),Ci=i.bI(oi,Li)}if(a){const li=i.bH([],qe,oi);i.aw(li,li),i.bG(Te,Te,li,a*bt)}const ni=Gt+Math.atan2(Ci,si);return ae.push(Te),X&&Ce.push(Be),{point:Te,angle:ni,path:ae,tilePath:Ce,up:qe}}function al(p,e){const a=e.length,f=a+4*p;e.resize(f),e.float32.fill(-1/0,4*a,4*f)}function ll(p,e,a){const f=e[0],y=e[1];return p[0]=a[0]*f+a[4]*y+a[12],p[1]=a[1]*f+a[5]*y+a[13],p[3]=a[3]*f+a[7]*y+a[15],p}const Cl=100;class Da{constructor(e,a,f=new qa(e.width+200,e.height+200,25),y=new qa(e.width+200,e.height+200,25)){this.transform=e,this.grid=f,this.ignoredGrid=y,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+Cl,this.screenBottomBoundary=e.height+Cl,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.fogState=a}placeCollisionBox(e,a,f,y,w,I,M,L,N,V,Z){let U=f.projectedAnchorX,X=f.projectedAnchorY,Q=f.projectedAnchorZ;const nt=f.tileAnchorX,ht=f.tileAnchorY,lt=f.elevation,_t=f.tileID,Ct=e.getProjection();if(lt&&_t){const[Ce,ve,Fe]=Ct.upVector(_t.canonical,f.tileAnchorX,f.tileAnchorY),oi=Ct.upVectorScale(_t.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;U+=Ce*lt*oi,X+=ve*lt*oi,Q+=Fe*lt*oi}const bt=e.projection.name==="globe",Gt=e.projection.name==="globe"?i.aj(this.transform.zoom):0;if(_t&&bt&&Gt<1&&!I){const Ce=1<<_t.canonical.z,ve=i.bO(nt,ht);i.bP(ve,ve,1/i.al),i.bQ(ve,ve,i.bO(_t.canonical.x,_t.canonical.y)),i.bP(ve,ve,1/Ce),i.bR(ve,ve,i.bO(y[0],y[1])),ve[0]=i.bS(ve[0],-.5,.5),i.bP(ve,ve,i.al);const Fe=i.bT(ve[0],ve[1],i.al/(2*Math.PI),1);i.aC(Fe,Fe,w),U=i.ak(U,Fe[0],Gt),X=i.ak(X,Fe[1],Gt),Q=i.ak(Q,Fe[2],Gt)}const zt=this.projectAndGetPerspectiveRatio(V,U,X,Q,f.tileID,Ct.name==="globe"||!!lt||this.transform.pitch>0,Ct),Zt=N*zt.perspectiveRatio,Vt=(f.x1*a+M.x-f.padding)*Zt+zt.point.x,kt=(f.y1*a+M.y-f.padding)*Zt+zt.point.y,Ht=(f.x2*a+M.x+f.padding)*Zt+zt.point.x,pe=(f.y2*a+M.y+f.padding)*Zt+zt.point.y,ae=zt.perspectiveRatio<=.55||zt.occluded;return!this.isInsideGrid(Vt,kt,Ht,pe)||!L&&this.grid.hitTest(Vt,kt,Ht,pe,Z)||ae?{box:[],offscreen:!1,occluded:zt.occluded}:{box:[Vt,kt,Ht,pe],offscreen:this.isOffscreen(Vt,kt,Ht,pe),occluded:!1}}placeCollisionCircles(e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht){const lt=[],_t=this.transform.elevation,Ct=e.getProjection(),bt=e.elevationType==="road",Gt=!!_t||bt,zt=i.bU.getAtTileOffsetFunc(ht,this.transform.center.lat,this.transform.worldSize,Ct),Zt=new i.P(f.tileAnchorX,f.tileAnchorY),Vt=new i.P(f.tileAnchorX,f.tileAnchorY);let{x:kt,y:Ht,z:pe}=Ct.projectTilePoint(Vt.x,Vt.y,ht.canonical),ae=null;if(Gt){const Li=bt?e.getElevationFeatureForText(y):null;ae={getElevation:zt,elevation:_t,elevationFeature:Li};const[Ti,xi,Ii]=zt(Zt,_t,Li);kt+=Ti,Ht+=xi,pe+=Ii}const Ce=Ct.name==="globe",ve=this.projectAndGetPerspectiveRatio(L,kt,Ht,pe,ht,Ce||!!_t||this.transform.pitch>0,Ct),{perspectiveRatio:Fe}=ve,oi=(U?M/Fe:M*Fe)/i.bX,ge=Zo(kt,Ht,pe,N),re=f.lineOffsetX*oi,Be=f.lineOffsetY*oi,Te=i.an(e.layers[0].layout.get("text-max-angle")),qe=Math.cos(Te),si=ve.signedDistanceFromCamera>0?Dr(oi,I,re,Be,bt&&f.flipState===1,ge,Vt,f,w,N,{},Gt&&!U?ae:null,U&&Gt,Ct,ht,U,qe):null;let Ci=!1,ni=!1,li=!0;if(si&&!ve.occluded){const Li=.5*Q*Fe+nt,Ti=new i.P(-100,-100),xi=new i.P(this.screenRightBoundary,this.screenBottomBoundary),Ii=new Uu,{first:Zi,last:Fr}=si,qr=Zi.path.length;let En=[];for(let br=qr-1;br>=1;br--)En.push(Zi.path[br]);for(let br=1;br<Fr.path.length;br++)En.push(Fr.path[br]);const ar=2.5*Li;V&&(En=En.map(([br,xn,Vr],kn)=>(Gt&&!Ce&&(Vr=zt(kn<qr-1?Zi.tilePath[qr-1-kn]:Fr.tilePath[kn-qr+2],_t,ae.elevationFeature)[2]),Zo(br,xn,Vr,V))),En.some(br=>br[3]<=0)&&(En=[]));let jr=[];if(En.length>0){let br=1/0,xn=-1/0,Vr=1/0,kn=-1/0;for(const Kr of En)br=Math.min(br,Kr[0]),Vr=Math.min(Vr,Kr[1]),xn=Math.max(xn,Kr[0]),kn=Math.max(kn,Kr[1]);xn>=Ti.x&&br<=xi.x&&kn>=Ti.y&&Vr<=xi.y&&(jr=[En.map(Kr=>new i.P(Kr[0],Kr[1]))],(br<Ti.x||xn>xi.x||Vr<Ti.y||kn>xi.y)&&(jr=i.bV(jr,Ti.x,Ti.y,xi.x,xi.y)))}for(const br of jr){Ii.reset(br,.25*Li);let xn=0;xn=Ii.length<=.5*Li?1:Math.ceil(Ii.paddedLength/ar)+1;for(let Vr=0;Vr<xn;Vr++){const kn=Vr/Math.max(xn-1,1),Kr=Ii.lerp(kn),wr=Kr.x+Cl,ln=Kr.y+Cl;lt.push(wr,ln,Li,0);const Er=wr-Li,eo=ln-Li,cn=wr+Li,cr=ln+Li;if(li=li&&this.isOffscreen(Er,eo,cn,cr),ni=ni||this.isInsideGrid(Er,eo,cn,cr),!a&&this.grid.hitTestCircle(wr,ln,Li,X)&&(Ci=!0,!Z))return{circles:[],offscreen:!1,collisionDetected:Ci,occluded:!1}}}}return{circles:!Z&&Ci||!ni?[]:lt,offscreen:li,collisionDetected:Ci,occluded:ve.occluded}}queryRenderedSymbols(e){if(e.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const a=[];let f=1/0,y=1/0,w=-1/0,I=-1/0;for(const V of e){const Z=new i.P(V.x+Cl,V.y+Cl);f=Math.min(f,Z.x),y=Math.min(y,Z.y),w=Math.max(w,Z.x),I=Math.max(I,Z.y),a.push(Z)}const M=this.grid.query(f,y,w,I).concat(this.ignoredGrid.query(f,y,w,I)),L={},N={};for(const V of M){const Z=V.key;if(L[Z.bucketInstanceId]===void 0&&(L[Z.bucketInstanceId]={}),L[Z.bucketInstanceId][Z.featureIndex])continue;const U=[new i.P(V.x1,V.y1),new i.P(V.x2,V.y1),new i.P(V.x2,V.y2),new i.P(V.x1,V.y2)];i.bW(a,U)&&(L[Z.bucketInstanceId][Z.featureIndex]=!0,N[Z.bucketInstanceId]===void 0&&(N[Z.bucketInstanceId]=[]),N[Z.bucketInstanceId].push(Z.featureIndex))}return N}insertCollisionBox(e,a,f,y,w){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:f,featureIndex:y,collisionGroupID:w},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,a,f,y,w){const I=a?this.ignoredGrid:this.grid,M={bucketInstanceId:f,featureIndex:y,collisionGroupID:w};for(let L=0;L<e.length;L+=4)I.insertCircle(M,e[L],e[L+1],e[L+2])}projectAndGetPerspectiveRatio(e,a,f,y,w,I,M){const L=[a,f,y,1];let N=!1;y||this.transform.pitch>0?(i.aC(L,L,e),this.fogState&&w&&M.name!=="globe"&&(N=function(U,X,Q,nt,ht,lt){const _t=lt.calculateFogTileMatrix(ht),Ct=[X,Q,nt];return i.af(Ct,Ct,_t),ti(U,i.ag(Ct),lt.pitch,lt._fov)}(this.fogState,a,f,y,w.toUnwrapped(),this.transform)>.9)):ll(L,L,e);const V=L[3];return{point:new i.P((L[0]/V+1)/2*this.transform.width+Cl,(-L[1]/V+1)/2*this.transform.height+Cl),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(M)/V*.5,1.5),signedDistanceFromCamera:V,occluded:I&&L[2]>V||N}}isOffscreen(e,a,f,y){return f<Cl||e>=this.screenRightBoundary||y<Cl||a>this.screenBottomBoundary}isInsideGrid(e,a,f,y){return f>=0&&e<this.gridRightBoundary&&y>=0&&a<this.gridBottomBoundary}getViewportMatrix(){const e=i.bz([]);return i.bq(e,e,[-100,-100,0]),e}}class Oi{constructor(e,a,f,y){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?a:-a))):y&&f?1:0,this.placed=f}isHidden(){return this.opacity===0&&!this.placed}}class Ur{constructor(e,a,f,y,w,I=!1){this.text=new Oi(e?e.text:null,a,f,w),this.icon=new Oi(e?e.icon:null,a,y,w),this.clipped=I}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class sn{constructor(e,a,f,y=!1){this.text=e,this.icon=a,this.skipFade=f,this.clipped=y}}class Ha{constructor(){this.invProjMatrix=i.bB(),this.viewportMatrix=i.bB(),this.circles=[]}}class Jc{constructor(e,a,f,y,w){this.bucketInstanceId=e,this.featureIndex=a,this.sourceLayerIndex=f,this.bucketIndex=y,this.tileID=w}}class en{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const a=++this.maxGroupID;this.collisionGroups[e]={ID:a,predicate:f=>f.collisionGroupID===a}}return this.collisionGroups[e]}}function oa(p,e,a,f,y){const{horizontalAlign:w,verticalAlign:I}=i.c0(p),M=-(w-.5)*e,L=-(I-.5)*a,N=i.c1(p,f);return new i.P(M+N[0]*y,L+N[1]*y)}function Ac(p,e,a,f,y){const w=new i.P(p,e);return a&&w._rotate(f?y:-y),w}class lc{constructor(e,a,f,y,w,I){this.transform=e.clone(),this.projection=e.projection.name,this.collisionIndex=new Da(this.transform,w),this.buildingIndex=I,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=a,this.retainedQueryData={},this.collisionGroups=new en(f),this.collisionCircleArrays={},this.prevPlacement=y,y&&(y.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(e,a,f,y,w=1){const I=f.getBucket(a),M=f.latestFeatureIndex;if(!I||!M||a.fqid!==I.layerIds[0])return;const L=I.layers[0].layout,N=I.layers[0].paint,V=f.collisionBoxArray,Z=Math.pow(2,this.transform.zoom-f.tileID.overscaledZ),U=f.tileSize/i.al,X=f.tileID.toUnwrapped();this.transform.setProjection(I.projection);const Q=(nt=f.tileID,ht=I.getProjection(),lt=this.transform,ht.name===this.projection?lt.calculateProjMatrix(nt.toUnwrapped()):Hr(lt,ht,nt));var nt,ht,lt;const _t=L.get("text-pitch-alignment")==="map",Ct=L.get("text-rotation-alignment")==="map";a.compileFilter(a.options);const bt=a.dynamicFilter(),Gt=a.dynamicFilterNeedsFeature(),zt=this.transform.calculatePixelsToTileUnitsMatrix(f),Zt=Yc(Q,f.tileID.canonical,_t,Ct,this.transform,I.getProjection(),zt);let Vt=null;const kt=I.getProjection().createInversionMatrix(this.transform,f.tileID.canonical);if(_t){const re=Ml(Q,f.tileID.canonical,_t,Ct,this.transform,I.getProjection(),zt);Vt=i.aB([],this.transform.labelPlaneMatrix,re)}let Ht=null;bt&&f.latestFeatureIndex&&(Ht={unwrappedTileID:X,dynamicFilter:bt,dynamicFilterNeedsFeature:Gt}),this.retainedQueryData[I.bucketInstanceId]=new Jc(I.bucketInstanceId,M,I.sourceLayerIndex,I.index,f.tileID);const[pe,ae]=I.layers[0].layout.get("text-size-scale-range"),Ce=i.aA(w,pe,ae),[ve,Fe]=L.get("icon-size-scale-range"),oi=i.aA(w,ve,Fe),ge={bucket:I,layout:L,paint:N,posMatrix:Q,invMatrix:kt,mercatorCenter:[i.aF(this.transform.center.lng),i.aJ(this.transform.center.lat)],textLabelPlaneMatrix:Zt,labelToScreenMatrix:Vt,clippingData:Ht,scale:Z,textPixelRatio:U,holdingForFade:f.holdingForFade(),collisionBoxArray:V,partiallyEvaluatedTextSize:i.bJ(I.textSizeData,this.transform.zoom,Ce),partiallyEvaluatedIconSize:i.bJ(I.iconSizeData,this.transform.zoom,oi),collisionGroup:this.collisionGroups.get(I.sourceID),latestFeatureIndex:f.latestFeatureIndex};if(y)for(const re of I.sortKeyRanges){const{sortKey:Be,symbolInstanceStart:Te,symbolInstanceEnd:qe}=re;e.push({sortKey:Be,symbolInstanceStart:Te,symbolInstanceEnd:qe,parameters:ge})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:I.symbolInstances.length,parameters:ge})}attemptAnchorPlacement(e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt,_t,Ct,bt,Gt){const{textOffset0:zt,textOffset1:Zt,crossTileID:Vt}=nt,kt=[zt,Zt],Ht=oa(e,I,M,kt,L),pe=this.collisionIndex.placeCollisionBox(lt,L,a,f,y,w,Ac(Ht.x,Ht.y,N,V,this.transform.angle),Q,Z,U,X.predicate);if(Ct){const ae=lt.getSymbolInstanceIconSize(Gt,this.transform.zoom,nt.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(lt,ae,Ct,f,y,w,Ac(Ht.x,Ht.y,N,V,this.transform.angle),Q,Z,U,X.predicate).box.length===0)return}if(pe.box.length>0){let ae;return this.prevPlacement&&this.prevPlacement.variableOffsets[Vt]&&this.prevPlacement.placements[Vt]&&this.prevPlacement.placements[Vt].text&&(ae=this.prevPlacement.variableOffsets[Vt].anchor),this.variableOffsets[Vt]={textOffset:kt,width:I,height:M,anchor:e,textScale:L,prevAnchor:ae},this.markUsedJustification(lt,e,nt,_t),lt.allowVerticalPlacement&&(this.markUsedOrientation(lt,_t,nt),this.placedOrientations[Vt]=_t),{shift:Ht,placedGlyphBoxes:pe}}}placeLayerBucketPart(e,a,f,y,w=1){const{bucket:I,layout:M,paint:L,posMatrix:N,textLabelPlaneMatrix:V,labelToScreenMatrix:Z,clippingData:U,textPixelRatio:X,mercatorCenter:Q,invMatrix:nt,holdingForFade:ht,collisionBoxArray:lt,partiallyEvaluatedTextSize:_t,partiallyEvaluatedIconSize:Ct,collisionGroup:bt,latestFeatureIndex:Gt}=e.parameters,zt=M.get("text-optional"),Zt=M.get("icon-optional"),Vt=M.get("text-allow-overlap"),kt=M.get("icon-allow-overlap"),Ht=M.get("text-rotation-alignment")==="map",pe=M.get("icon-rotation-alignment")==="map",ae=M.get("text-pitch-alignment")==="map",Ce=L.get("symbol-z-offset"),ve=M.get("symbol-elevation-reference")==="sea",Fe=M.get("symbol-placement"),[oi,ge]=M.get("text-size-scale-range"),[re,Be]=M.get("icon-size-scale-range"),Te=i.aA(w,oi,ge),qe=i.aA(w,re,Be),si=M.get("text-variable-anchor"),Ci=Ht&&Fe!=="point",ni=pe&&Fe!=="point",li=si&&I.hasTextData(),Li=I.hasIconTextFit()&&li&&I.hasIconData();this.transform.setProjection(I.projection);const Ti=li||Ci,xi=ni||Li;let Ii=Vt&&(kt||!I.hasIconData()||Zt),Zi=kt&&(Vt||!I.hasTextData()||zt);const Fr=!Ce.isConstant();!I.collisionArrays&&lt&&I.deserializeCollisionBoxes(lt),f&&y&&I.updateCollisionDebugBuffers(this.transform.zoom,lt,Te,qe);const qr=(ar,jr,br)=>{const{crossTileID:xn,numVerticalGlyphVertices:Vr}=ar;let kn=null;if(U&&U.dynamicFilterNeedsFeature||Fr){const io=this.retainedQueryData[I.bucketInstanceId];kn=Gt.loadFeature({featureIndex:ar.featureIndex,bucketIndex:io.bucketIndex,sourceLayerIndex:io.sourceLayerIndex,layoutVertexArrayOffset:0})}if(U&&!(0,U.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:I.worldview},kn,this.retainedQueryData[I.bucketInstanceId].tileID.canonical,new i.P(ar.tileAnchorX,ar.tileAnchorY),this.transform.calculateDistanceTileData(U.unwrappedTileID)))return this.placements[xn]=new sn(!1,!1,!1,!0),void a.add(xn);const Kr=Ce.evaluate(kn,{});if(a.has(xn))return;if(ht)return void(this.placements[xn]=new sn(!1,!1,!1));let wr=!1,ln=!1,Er=!0,eo=!1,cn=!1,cr=null,Wr={box:null,offscreen:null,occluded:null},fo={box:null},Uo=null,So=null,Ro=null,mo=0,ha=0,wa=0;br.textFeatureIndex?mo=br.textFeatureIndex:ar.useRuntimeCollisionCircles&&(mo=ar.featureIndex),br.verticalTextFeatureIndex&&(ha=br.verticalTextFeatureIndex);const Fa=I.elevationFeatures?I.elevationFeatures[ar.elevationFeatureIndex]:void 0,tc=io=>{io.tileID=this.retainedQueryData[I.bucketInstanceId].tileID;const ko=this.transform.elevation;io.elevation=ve?Kr:Kr+i.bU.getAtTileOffset(io.tileID,new i.P(io.tileAnchorX,io.tileAnchorY),ko,Fa),io.elevation+=ar.zOffset},ua=br.textBox;if(ua){tc(ua);const io=Dn=>{let $o=i.bK.horizontal;if(I.allowVerticalPlacement&&!Dn&&this.prevPlacement){const As=this.prevPlacement.placedOrientations[xn];As&&(this.placedOrientations[xn]=As,$o=As,this.markUsedOrientation(I,$o,ar))}return $o},ko=(Dn,$o)=>{if(I.allowVerticalPlacement&&Vr>0&&br.verticalTextBox){for(const As of I.writingModes)if(As===i.bK.vertical?(Wr=$o(),fo=Wr):Wr=Dn(),Wr&&Wr.box&&Wr.box.length)break}else Wr=Dn()};if(si){let Dn=si;if(this.prevPlacement&&this.prevPlacement.variableOffsets[xn]){const ro=this.prevPlacement.variableOffsets[xn];Dn.indexOf(ro.anchor)>0&&(Dn=Dn.filter(ec=>ec!==ro.anchor),Dn.unshift(ro.anchor))}const $o=(ro,ec,Np)=>{const Cu=I.getSymbolInstanceTextSize(_t,ar,this.transform.zoom,jr),Vp=(ro.x2-ro.x1)*Cu+2*ro.padding,Up=(ro.y2-ro.y1)*Cu+2*ro.padding,vc=ar.hasIconTextFit&&!kt?ec:null;vc&&tc(vc);let Kh={box:[],offscreen:!1,occluded:!1};const Os=Vt?2*Dn.length:Dn.length;for(let bc=0;bc<Os;++bc){const Yd=this.attemptAnchorPlacement(Dn[bc%Dn.length],ro,Q,nt,Ti,Vp,Up,Cu,Ht,ae,X,N,bt,bc>=Dn.length,ar,jr,I,Np,vc,_t,Ct);if(Yd&&(Kh=Yd.placedGlyphBoxes,Kh&&Kh.box&&Kh.box.length)){wr=!0,cr=Yd.shift;break}}return Kh};ko(()=>$o(ua,br.iconBox,i.bK.horizontal),()=>{const ro=br.verticalTextBox;return ro&&tc(ro),I.allowVerticalPlacement&&!(Wr&&Wr.box&&Wr.box.length)&&Vr>0&&ro?$o(ro,br.verticalIconBox,i.bK.vertical):{box:null,offscreen:null,occluded:null}}),Wr&&(wr=Wr.box,Er=Wr.offscreen,eo=Wr.occluded);const As=io(!(!Wr||!Wr.box));if(!wr&&this.prevPlacement){const ro=this.prevPlacement.variableOffsets[xn];ro&&(this.variableOffsets[xn]=ro,this.markUsedJustification(I,ro.anchor,ar,As))}}else{const Dn=($o,As)=>{const ro=I.getSymbolInstanceTextSize(_t,ar,this.transform.zoom,jr),ec=this.collisionIndex.placeCollisionBox(I,ro,$o,Q,nt,Ti,new i.P(0,0),Vt,X,N,bt.predicate);return ec&&ec.box&&ec.box.length&&(this.markUsedOrientation(I,As,ar),this.placedOrientations[xn]=As),ec};ko(()=>Dn(ua,i.bK.horizontal),()=>{const $o=br.verticalTextBox;return I.allowVerticalPlacement&&Vr>0&&$o?(tc($o),Dn($o,i.bK.vertical)):{box:null,offscreen:null,occluded:null}}),io(!!(Wr&&Wr.box&&Wr.box.length))}}if(Uo=Wr,wr=Uo&&Uo.box&&Uo.box.length>0,Er=Uo&&Uo.offscreen,eo=Uo&&Uo.occluded,ar.useRuntimeCollisionCircles){const io=ar.centerJustifiedTextSymbolIndex>=0?ar.centerJustifiedTextSymbolIndex:ar.verticalPlacedTextSymbolIndex,ko=I.text.placedSymbolArray.get(io),Dn=i.bL(I.textSizeData,_t,ko),$o=M.get("text-padding");So=this.collisionIndex.placeCollisionCircles(I,Vt,ko,io,I.lineVertexArray,I.glyphOffsetArray,Dn,N,V,Z,f,ae,bt.predicate,ar.collisionCircleDiameter*Dn/i.bX,$o,this.retainedQueryData[I.bucketInstanceId].tileID),wr=Vt||So.circles.length>0&&!So.collisionDetected,Er=Er&&So.offscreen,eo=So.occluded}if(br.iconFeatureIndex&&(wa=br.iconFeatureIndex),br.iconBox){const io=ko=>{tc(ko);const Dn=ar.hasIconTextFit&&cr?Ac(cr.x,cr.y,Ht,ae,this.transform.angle):new i.P(0,0),$o=I.getSymbolInstanceIconSize(Ct,this.transform.zoom,ar.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(I,$o,ko,Q,nt,xi,Dn,kt,X,N,bt.predicate)};fo&&fo.box&&fo.box.length&&br.verticalIconBox?(Ro=io(br.verticalIconBox),ln=Ro.box.length>0):(Ro=io(br.iconBox),ln=Ro.box.length>0),Er=Er&&Ro.offscreen,cn=Ro.occluded}const yc=zt||ar.numHorizontalGlyphVertices===0&&Vr===0,xc=Zt||ar.numIconVertices===0;if(yc||xc?xc?yc||(ln=ln&&wr):wr=ln&&wr:ln=wr=ln&&wr,wr&&Uo&&Uo.box&&this.collisionIndex.insertCollisionBox(Uo.box,M.get("text-ignore-placement"),I.bucketInstanceId,fo&&fo.box&&ha?ha:mo,bt.ID),ln&&Ro&&this.collisionIndex.insertCollisionBox(Ro.box,M.get("icon-ignore-placement"),I.bucketInstanceId,wa,bt.ID),So&&(wr&&this.collisionIndex.insertCollisionCircles(So.circles,M.get("text-ignore-placement"),I.bucketInstanceId,mo,bt.ID),f)){const io=I.bucketInstanceId;let ko=this.collisionCircleArrays[io];ko===void 0&&(ko=this.collisionCircleArrays[io]=new Ha);for(let Dn=0;Dn<So.circles.length;Dn+=4)ko.circles.push(So.circles[Dn+0]),ko.circles.push(So.circles[Dn+1]),ko.circles.push(So.circles[Dn+2]),ko.circles.push(So.collisionDetected?1:0)}const Bs=I.projection.name!=="globe";Ii=Ii&&(Bs||!eo),Zi=Zi&&(Bs||!cn),this.placements[xn]=new sn(wr||Ii,ln||Zi,Er||I.justReloaded),a.add(xn)},En=this.retainedQueryData[I.bucketInstanceId].tileID;if(I.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(I,En),I.elevationType==="road"&&I.updateRoadElevation(En.canonical),I.updateZOffset(),I.sortFeaturesByY){const ar=I.getSortedSymbolIndexes(this.transform.angle);for(let jr=ar.length-1;jr>=0;--jr){const br=ar[jr];qr(I.symbolInstances.get(br),br,I.collisionArrays[br])}I.hasAnyZOffset&&i.w(`${I.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(I.hasAnyZOffset){const ar=I.getSortedIndexesByZOffset();for(let jr=0;jr<ar.length;++jr){const br=ar[jr];qr(I.symbolInstances.get(br),br,I.collisionArrays[br])}}else for(let ar=e.symbolInstanceStart;ar<e.symbolInstanceEnd;ar++)qr(I.symbolInstances.get(ar),ar,I.collisionArrays[ar]);if(f&&I.bucketInstanceId in this.collisionCircleArrays){const ar=this.collisionCircleArrays[I.bucketInstanceId];i.bk(ar.invProjMatrix,N),ar.viewportMatrix=this.collisionIndex.getViewportMatrix()}I.justReloaded=!1}markUsedJustification(e,a,f,y){const{leftJustifiedTextSymbolIndex:w,centerJustifiedTextSymbolIndex:I,rightJustifiedTextSymbolIndex:M,verticalPlacedTextSymbolIndex:L,crossTileID:N}=f,V=i.c2(a),Z=y===i.bK.vertical?L:V==="left"?w:V==="center"?I:V==="right"?M:-1;w>=0&&(e.text.placedSymbolArray.get(w).crossTileID=Z>=0&&w!==Z?0:N),I>=0&&(e.text.placedSymbolArray.get(I).crossTileID=Z>=0&&I!==Z?0:N),M>=0&&(e.text.placedSymbolArray.get(M).crossTileID=Z>=0&&M!==Z?0:N),L>=0&&(e.text.placedSymbolArray.get(L).crossTileID=Z>=0&&L!==Z?0:N)}markUsedOrientation(e,a,f){const y=a===i.bK.horizontal||a===i.bK.horizontalOnly?a:0,w=a===i.bK.vertical?a:0,{leftJustifiedTextSymbolIndex:I,centerJustifiedTextSymbolIndex:M,rightJustifiedTextSymbolIndex:L,verticalPlacedTextSymbolIndex:N}=f,V=e.text.placedSymbolArray;I>=0&&(V.get(I).placedOrientation=y),M>=0&&(V.get(M).placedOrientation=y),L>=0&&(V.get(L).placedOrientation=y),N>=0&&(V.get(N).placedOrientation=w)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const a=this.prevPlacement;let f=!1;this.prevZoomAdjustment=a?a.zoomAdjustment(this.transform.zoom):0;const y=a?a.symbolFadeChange(e):1,w=a?a.opacities:{},I=a?a.variableOffsets:{},M=a?a.placedOrientations:{};for(const L in this.placements){const N=this.placements[L],V=w[L];V?(this.opacities[L]=new Ur(V,y,N.text,N.icon,null,N.clipped),f=f||N.text!==V.text.placed||N.icon!==V.icon.placed):(this.opacities[L]=new Ur(null,y,N.text,N.icon,N.skipFade,N.clipped),f=f||N.text||N.icon)}for(const L in w){const N=w[L];if(!this.opacities[L]){const V=new Ur(N,y,!1,!1);V.isHidden()||(this.opacities[L]=V,f=f||N.text.placed||N.icon.placed)}}for(const L in I)this.variableOffsets[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.variableOffsets[L]=I[L]);for(const L in M)this.placedOrientations[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.placedOrientations[L]=M[L]);f?this.lastPlacementChangeTime=e:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=a?a.lastPlacementChangeTime:e)}updateLayerOpacities(e,a,f,y){const w=new Set;for(const I of a){const M=I.getBucket(e);M&&I.latestFeatureIndex&&e.fqid===M.layerIds[0]&&(this.updateBucketOpacities(M,w,I,I.collisionBoxArray,f,y,I.tileID,e.scope),M.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(M,I.tileID),M.elevationType==="road"&&M.updateRoadElevation(I.tileID.canonical),M.updateZOffset())}}updateBucketOpacities(e,a,f,y,w,I,M,L){e.hasTextData()&&e.text.opacityVertexArray.clear(),e.hasIconData()&&e.icon.opacityVertexArray.clear(),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();const N=e.layers[0].layout,V=e.layers[0].paint,Z=!!e.layers[0].dynamicFilter(),U=new Ur(null,0,!1,!1,!0),X=N.get("text-allow-overlap"),Q=N.get("icon-allow-overlap"),nt=N.get("text-variable-anchor"),ht=N.get("text-rotation-alignment")==="map",lt=N.get("text-pitch-alignment")==="map",_t=V.get("symbol-z-offset"),Ct=N.get("symbol-elevation-reference")==="sea",bt=!_t.isConstant(),Gt=new Ur(null,0,X&&(Q||!e.hasIconData()||N.get("icon-optional")),Q&&(X||!e.hasTextData()||N.get("text-optional")),!0);!e.collisionArrays&&y&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(y);const zt=(Vt,kt,Ht)=>{for(let pe=0;pe<kt/4;pe++)Vt.opacityVertexArray.emplaceBack(Ht)};let Zt=0;I&&e.updateReplacement(M,I);for(let Vt=0;Vt<e.symbolInstances.length;Vt++){const kt=e.symbolInstances.get(Vt),{numHorizontalGlyphVertices:Ht,numVerticalGlyphVertices:pe,crossTileID:ae,numIconVertices:Ce,tileAnchorX:ve,tileAnchorY:Fe}=kt;let oi=null;const ge=this.retainedQueryData[e.bucketInstanceId];bt&&kt&&ge&&(oi=f.latestFeatureIndex.loadFeature({featureIndex:kt.featureIndex,bucketIndex:ge.bucketIndex,sourceLayerIndex:ge.sourceLayerIndex,layoutVertexArrayOffset:0}));const re=_t.evaluate(oi,{}),Be=a.has(ae);let Te=this.opacities[ae];Be?Te=U:Te||(Te=Gt,this.opacities[ae]=Te),a.add(ae);const qe=Ht>0||pe>0,si=Ce>0,Ci=this.placedOrientations[ae],ni=Ci===i.bK.vertical,li=Ci===i.bK.horizontal||Ci===i.bK.horizontalOnly;!qe&&!si||Te.isHidden()||Zt++;let Li=!1;if((qe||si)&&I)for(const Ti of e.activeReplacements){if(i.bY(Ti,w,i.bZ.Symbol,L)||Ti.min.x>ve||ve>Ti.max.x||Ti.min.y>Fe||Fe>Ti.max.y)continue;const xi=i.b_(ve,Fe,M.canonical,Ti.footprintTileId.canonical);if(Li=i.b$(xi,Ti.footprint),Li)break}if(qe){const Ti=Li?fs:Qc(Te.text);zt(e.text,Ht,ni?fs:Ti),zt(e.text,pe,li?fs:Ti);const xi=Te.text.isHidden(),{leftJustifiedTextSymbolIndex:Ii,centerJustifiedTextSymbolIndex:Zi,rightJustifiedTextSymbolIndex:Fr,verticalPlacedTextSymbolIndex:qr}=kt,En=e.text.placedSymbolArray,ar=xi||ni?1:0;Ii>=0&&(En.get(Ii).hidden=ar),Zi>=0&&(En.get(Zi).hidden=ar),Fr>=0&&(En.get(Fr).hidden=ar),qr>=0&&(En.get(qr).hidden=xi||li?1:0);const jr=this.variableOffsets[ae];jr&&this.markUsedJustification(e,jr.anchor,kt,Ci);const br=this.placedOrientations[ae];br&&(this.markUsedJustification(e,"left",kt,br),this.markUsedOrientation(e,br,kt))}if(si){const Ti=Li?fs:Qc(Te.icon),{placedIconSymbolIndex:xi,verticalPlacedIconSymbolIndex:Ii}=kt,Zi=e.icon.placedSymbolArray,Fr=Te.icon.isHidden()?1:0;xi>=0&&(zt(e.icon,Ce,ni?fs:Ti),Zi.get(xi).hidden=Fr),Ii>=0&&(zt(e.icon,kt.numVerticalIconVertices,li?fs:Ti),Zi.get(Ii).hidden=Fr)}if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){const Ti=e.collisionArrays[Vt];if(Ti){let xi=new i.P(0,0),Ii=!0;if(Ti.textBox||Ti.verticalTextBox){if(nt){const Fr=this.variableOffsets[ae];Fr?(xi=oa(Fr.anchor,Fr.width,Fr.height,Fr.textOffset,Fr.textScale),ht&&xi._rotate(lt?this.transform.angle:-this.transform.angle)):Ii=!1}Z&&(Ii=!Te.clipped),Ti.textBox&&ps(e.textCollisionBox.collisionVertexArray,Te.text.placed,!Ii||ni,re,Ct,xi.x,xi.y),Ti.verticalTextBox&&ps(e.textCollisionBox.collisionVertexArray,Te.text.placed,!Ii||li,re,Ct,xi.x,xi.y)}const Zi=Ii&&!!(!li&&Ti.verticalIconBox);Ti.iconBox&&ps(e.iconCollisionBox.collisionVertexArray,Te.icon.placed,Zi,re,Ct,kt.hasIconTextFit?xi.x:0,kt.hasIconTextFit?xi.y:0),Ti.verticalIconBox&&ps(e.iconCollisionBox.collisionVertexArray,Te.icon.placed,!Zi,re,Ct,kt.hasIconTextFit?xi.x:0,kt.hasIconTextFit?xi.y:0)}}}if(e.fullyClipped=Zt===0,e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.bucketInstanceId in this.collisionCircleArrays){const Vt=this.collisionCircleArrays[e.bucketInstanceId];e.placementInvProjMatrix=Vt.invProjMatrix,e.placementViewportMatrix=Vt.viewportMatrix,e.collisionCircleArray=Vt.circles,delete this.collisionCircleArrays[e.bucketInstanceId]}}symbolFadeChange(e){return this.fadeDuration===0?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,a){const f=this.zoomAtLastRecencyCheck===a?1-this.zoomAdjustment(a):1;return this.zoomAtLastRecencyCheck=a,this.commitTime+this.fadeDuration*f>e}setStale(){this.stale=!0}}function ps(p,e,a,f,y,w,I){p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0),p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0),p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0),p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0)}const Oo=Math.pow(2,25),Pc=Math.pow(2,24),Ed=Math.pow(2,17),Ad=Math.pow(2,16),Kc=Math.pow(2,9),cc=Math.pow(2,8),lf=Math.pow(2,1);function Qc(p){if(p.opacity===0&&!p.placed)return 0;if(p.opacity===1&&p.placed)return 4294967295;const e=p.placed?1:0,a=Math.floor(127*p.opacity);return a*Oo+e*Pc+a*Ed+e*Ad+a*Kc+e*cc+a*lf+e}const fs=0;class cl{constructor(e){this._sortAcrossTiles=e.layout.get("symbol-z-order")!=="viewport-y"&&e.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(e,a,f,y,w,I){const M=this._bucketParts;for(;this._currentTileIndex<e.length;)if(a.getBucketParts(M,y,e[this._currentTileIndex],this._sortAcrossTiles,I),this._currentTileIndex++,w())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,M.sort((L,N)=>L.sortKey-N.sortKey));this._currentPartIndex<M.length;){const L=M[this._currentPartIndex];if(a.placeLayerBucketPart(L,this._seenCrossTileIDs,f,L.symbolInstanceStart===0,I),this._currentPartIndex++,w())return!0}return!1}}class za{constructor(e,a,f,y,w,I,M,L,N){this.placement=new lc(e,w,I,M,L,N),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=f,this._showCollisionBoxes=y,this._done=!1}isDone(){return this._done}continuePlacement(e,a,f,y,w){const I=i.o.now(),M=()=>{const L=i.o.now()-I;return!this._forceFullPlacement&&L>2};for(;this._currentPlacementIndex>=0;){const L=a[e[this._currentPlacementIndex]],N=this.placement.collisionIndex.transform.zoom;if(L.type==="symbol"&&(!L.minzoom||L.minzoom<=N)&&(!L.maxzoom||L.maxzoom>N)){const V=L,Z=V.layout.get("symbol-z-elevate"),U=V.layout.get("symbol-sort-key").constantOr(1)!==void 0,X=V.layout.get("symbol-z-order"),Q=X==="viewport-y"||X==="auto"&&!(X!=="viewport-y"&&U),nt=V.layout.get("text-allow-overlap")||V.layout.get("icon-allow-overlap")||V.layout.get("text-ignore-placement")||V.layout.get("icon-ignore-placement"),ht=Q&&nt,lt=this._inProgressLayer=this._inProgressLayer||new cl(V),_t=i.B(L.source,L.scope);if(lt.continuePlacement(Z||ht?y[_t]:f[_t],this.placement,this._showCollisionBoxes,L,M,w))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const Pd=512/i.al/2;class Gu{constructor(e,a,f){this.tileID=e,this.bucketInstanceId=f,this.index=new i.c3(a.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const y=e.canonical.x*i.al,w=e.canonical.y*i.al;for(let I=0;I<a.length;I++){const{key:M,crossTileID:L,tileAnchorX:N,tileAnchorY:V}=a.get(I),Z=Math.floor((y+N)*Pd),U=Math.floor((w+V)*Pd);this.index.add(Z,U),this.keys.push(M),this.crossTileIDs.push(L)}this.index.finish()}findMatches(e,a,f){const y=this.tileID.canonical.z<a.canonical.z?1:Math.pow(2,this.tileID.canonical.z-a.canonical.z),w=Pd/Math.pow(2,a.canonical.z-this.tileID.canonical.z),I=a.canonical.x*i.al,M=a.canonical.y*i.al;for(let L=0;L<e.length;L++){const N=e.get(L);if(N.crossTileID)continue;const{key:V,tileAnchorX:Z,tileAnchorY:U}=N,X=Math.floor((I+Z)*w),Q=Math.floor((M+U)*w),nt=this.index.range(X-y,Q-y,X+y,Q+y).sort((ht,lt)=>ht-lt);for(const ht of nt){const lt=this.crossTileIDs[ht];if(this.keys[ht]===V&&!f.has(lt)){f.add(lt),N.crossTileID=lt;break}}}}}class ls{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Wl{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const a=Math.round((e-this.lng)/360);if(a!==0)for(const f in this.indexes){const y=this.indexes[f],w={};for(const I in y){const M=y[I];M.tileID=M.tileID.unwrapTo(M.tileID.wrap+a),w[M.tileID.key]=M}this.indexes[f]=w}this.lng=e}addBucket(e,a,f){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===a.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let w=0;w<a.symbolInstances.length;w++)a.symbolInstances.get(w).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]=new Set);const y=this.usedCrossTileIDs[e.overscaledZ];for(const w in this.indexes){const I=this.indexes[w];if(Number(w)>e.overscaledZ)for(const M in I){const L=I[M];L.tileID.isChildOf(e)&&L.findMatches(a.symbolInstances,e,y)}else{const M=I[e.scaledTo(Number(w)).key];M&&M.findMatches(a.symbolInstances,e,y)}}for(let w=0;w<a.symbolInstances.length;w++){const I=a.symbolInstances.get(w);I.crossTileID||(I.crossTileID=f.generate(),y.add(I.crossTileID))}return this.indexes[e.overscaledZ]===void 0&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new Gu(e,a.symbolInstances,a.bucketInstanceId),!0}removeBucketCrossTileIDs(e,a){for(const f of a.crossTileIDs)this.usedCrossTileIDs[e].delete(f)}removeStaleBuckets(e){let a=!1;for(const f in this.indexes){const y=this.indexes[f];for(const w in y)e[y[w].bucketInstanceId]||(this.removeBucketCrossTileIDs(f,y[w]),delete y[w],a=!0)}return a}}class Mc{constructor(){this.layerIndexes={},this.crossTileIDs=new ls,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,a,f,y){let w=this.layerIndexes[e.fqid];w===void 0&&(w=this.layerIndexes[e.fqid]=new Wl);let I=!1;const M={};y.name!=="globe"&&w.handleWrapJump(f);for(const L of a){const N=L.getBucket(e);N&&e.fqid===N.layerIds[0]&&(N.bucketInstanceId||(N.bucketInstanceId=++this.maxBucketInstanceId),w.addBucket(L.tileID,N,this.crossTileIDs)&&(I=!0),M[N.bucketInstanceId]=!0)}return w.removeStaleBuckets(M)&&(I=!0),I}pruneUnusedLayers(e){const a={};e.forEach(f=>{a[f]=!0});for(const f in this.layerIndexes)a[f]||delete this.layerIndexes[f]}}const Ao=771;class yr{constructor(e,a,f,y){this.blendFunction=e,this.blendColor=a.toNonPremultipliedRenderColor(null),this.mask=f,this.blendEquation=y}}yr.Replace=[1,0,1,0],yr.disabled=new yr(yr.Replace,i.ao.transparent,[!1,!1,!1,!1]),yr.unblended=new yr(yr.Replace,i.ao.transparent,[!0,!0,!0,!0]),yr.alphaBlended=new yr([1,Ao,1,Ao],i.ao.transparent,[!0,!0,!0,!0]),yr.alphaBlendedNonPremultiplied=new yr([770,Ao,770,Ao],i.ao.transparent,[!0,!0,!0,!0]),yr.multiply=new yr([774,0,774,0],i.ao.transparent,[!0,!0,!0,!0]),yr.additive=new yr([1,1,1,1],i.ao.transparent,[!0,!0,!0,!0]);class zi{constructor(e,a,f){this.func=e,this.mask=a,this.range=f}}zi.ReadOnly=!1,zi.ReadWrite=!0,zi.disabled=new zi(519,zi.ReadOnly,[0,1]);const Dl=7680;class sr{constructor(e,a,f,y,w,I){this.test=e,this.ref=a,this.mask=f,this.fail=y,this.depthFail=w,this.pass=I}}sr.disabled=new sr({func:519,mask:0},0,0,Dl,Dl,Dl);const lu=1029,Eh=2305;class Qi{constructor(e,a,f){this.enable=e,this.mode=a,this.frontFace=f}}function th(p,e){const a=i.c9(p,3);i.cb(p,e),i.cf(p,3,a)}function dp(p,e){const a=i.c6([]);return i.c7(a,a,-e),i.c8(a,a,-p),a}function Nf(p,e){const a=[p[0],p[1],0],f=[e[0],e[1],0];if(i.ag(a)>=1e-15){const I=i.aw([],a);i.c4(f,I,i.bI(f,I)),e[0]=f[0],e[1]=f[1]}const y=i.bH([],e,p);if(i.c5(y)<1e-15)return null;const w=Math.atan2(-y[1],y[0]);return dp(Math.atan2(Math.sqrt(p[0]*p[0]+p[1]*p[1]),-p[2]),w)}Qi.disabled=new Qi(!1,lu,Eh),Qi.backCCW=new Qi(!0,lu,Eh),Qi.backCW=new Qi(!0,lu,2304),Qi.frontCW=new Qi(!0,1028,2304),Qi.frontCCW=new Qi(!0,1028,Eh);class hc{constructor(e,a){this.position=e,this.orientation=a}get position(){return this._position}set position(e){if(e){const a=e instanceof i.ae?e:new i.ae(e[0],e[1],e[2]);this._renderWorldCopies&&(a.x=i.bS(a.x,0,1)),this._position=a}else this._position=null}lookAtPoint(e,a,f){if(this.orientation=null,!this.position)return;const y=this.position,w=f||(this._elevation?this._elevation.getAtPointOrZero(i.ae.fromLngLat(e)):0),I=i.ae.fromLngLat(e,w),M=[I.x-y.x,I.y-y.y,I.z-y.z];a||(a=[0,0,1]),a[2]=Math.abs(a[2]),this.orientation=Nf(M,a)}setPitchBearing(e,a){this.orientation=dp(i.an(e),i.an(-a))}}class cu{constructor(e,a){this._transform=i.bz([]),this.orientation=a,this.position=e}get mercatorPosition(){const e=this.position;return new i.ae(e[0],e[1],e[2])}get position(){const e=i.c9(this._transform,3);return[e[0],e[1],e[2]]}set position(e){var a;e&&i.cf(this._transform,3,[(a=e)[0],a[1],a[2],1])}get orientation(){return this._orientation}set orientation(e){this._orientation=e||i.c6([]),e&&th(this._transform,this._orientation)}getPitchBearing(){const e=this.forward(),a=this.right();return{bearing:Math.atan2(-a[1],a[0]),pitch:Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2])}}setPitchBearing(e,a){this._orientation=dp(e,a),th(this._transform,this._orientation)}forward(){const e=i.c9(this._transform,2);return[-e[0],-e[1],-e[2]]}up(){const e=i.c9(this._transform,1);return[-e[0],-e[1],-e[2]]}right(){const e=i.c9(this._transform,0);return[e[0],e[1],e[2]]}getCameraToWorld(e,a){const f=new Float64Array(16);return i.bk(f,this.getWorldToCamera(e,a)),f}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(e,a,f){const y=this.position;i.c4(y,y,-e);const w=new Float64Array(16);return i.bp(w,[f,f,f]),i.bq(w,w,y),w[10]*=a,w}getWorldToCamera(e,a){const f=new Float64Array(16),y=new Float64Array(4),w=this.position;return i.ca(y,this._orientation),i.c4(w,w,-e),i.cb(f,y),i.bq(f,f,w),f[1]*=-1,f[5]*=-1,f[9]*=-1,f[13]*=-1,f[8]*=a,f[9]*=a,f[10]*=a,f[11]*=a,f}getCameraToClipPerspective(e,a,f,y){const w=new Float64Array(16);return i.cc(w,e,a,f,y),w}getCameraToClipOrthographic(e,a,f,y,w,I){const M=new Float64Array(16);return i.cd(M,e,a,f,y,w,I),M}getDistanceToElevation(e,a=!1){const f=e===0?0:i.ce(e,a?i.a_(this.position[1]):this.position[1]),y=this.forward();return(f-this.position[2])/y[2]}clone(){return new cu([...this.position],[...this.orientation])}}const ms={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class $s{constructor(e=0,a=0,f=0,y=0){if(isNaN(e)||e<0||isNaN(a)||a<0||isNaN(f)||f<0||isNaN(y)||y<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=a,this.left=f,this.right=y}interpolate(e,a,f){return a.top!=null&&e.top!=null&&(this.top=i.ak(e.top,a.top,f)),a.bottom!=null&&e.bottom!=null&&(this.bottom=i.ak(e.bottom,a.bottom,f)),a.left!=null&&e.left!=null&&(this.left=i.ak(e.left,a.left,f)),a.right!=null&&e.right!=null&&(this.right=i.ak(e.right,a.right,f)),this}getCenter(e,a){const f=i.aA((this.left+e-this.right)/2,0,e),y=i.aA((this.top+a-this.bottom)/2,0,a);return new i.P(f,y)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new $s(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Ah=15;class Cc{constructor(e,a,f,y,w,I,M){this.tileSize=512,this._renderWorldCopies=w===void 0||w,this._minZoom=e||0,this._maxZoom=a||22,this._minPitch=f??0,this._maxPitch=y??60,this.setProjection(I),this.setMaxBounds(M),this.width=0,this.height=0,this._center=new i.aS(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new $s,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new cu,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const e=new Cc(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return e._elevation=this._elevation,e._centerAltitude=this._centerAltitude,e._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,e.tileSize=this.tileSize,e.mercatorFromTransition=this.mercatorFromTransition,e.width=this.width,e.height=this.height,e.cameraElevationReference=this.cameraElevationReference,e._center=this._center,e._setZoom(this.zoom),e._seaLevelZoom=this._seaLevelZoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._nearZ=this._nearZ,e._farZ=this._farZ,e._averageElevation=this._averageElevation,e._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,e._unmodified=this._unmodified,e._edgeInsets=this._edgeInsets.clone(),e._camera=this._camera.clone(),e._calcMatrices(),e.freezeTileCoverage=this.freezeTileCoverage,e.frustumCorners=this.frustumCorners,e._allowWorldUnderZoom=this._allowWorldUnderZoom,e}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Ah}get elevation(){return this._elevation}set elevation(e){this._elevation!==e&&(this._elevation=e,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(e,a=!1){const f=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||f)&&this._updateCameraOnTerrain(),(e||f)&&this._constrainCamera(a),this._calcMatrices()}getProjection(){return i.aH(this.projection,["name","center","parallels"])}setProjection(e){this.projectionOptions=e||{name:"mercator"};const a=this.projection?this.getProjection():void 0;this.projection=i.cl(this.projectionOptions);const f=this.getProjection(),y=!i.bx(a,f);return y&&this._calcMatrices(),this.mercatorFromTransition=!1,y}setOrthographicProjectionAtLowPitch(e){return this._orthographicProjectionAtLowPitch!==e&&(this._orthographicProjectionAtLowPitch=e,this._calcMatrices(),!0)}setMercatorFromTransition(){const e=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=i.cl({name:"mercator"});const a=e!==this.projection.name;return a&&this._calcMatrices(),a}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(e){e===void 0?e=!0:e===null&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get cameraWorldSize(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return i.ce(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new i.P(this.width,this.height)}get bearing(){return i.bS(this.rotation,-180,180)}set bearing(e){this.rotation=e}get rotation(){return-this.angle/Math.PI*180}set rotation(e){const a=-e*Math.PI/180;this.angle!==a&&(this._unmodified=!1,this.angle=a,this._calcMatrices(),this.rotationMatrix=i.cm(),i.cn(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(e){const a=i.aA(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==a&&(this._unmodified=!1,this._pitch=a,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=i.an(e),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const e=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/e)}get averageElevation(){return this._averageElevation}set averageElevation(e){this._averageElevation=e,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(e){const a=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==a&&(this._unmodified=!1,this._setZoom(a),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(e){this._zoom=e,this.scale=this.zoomScale(e),this.tileZoom=Math.floor(e),this.zoomFraction=e-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(e){this._tileCoverLift!==e&&(this._tileCoverLift=e)}_updateCameraOnTerrain(){const e=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,a=this.elevation&&e===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||e===Number.NEGATIVE_INFINITY&&(!a||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const f=this._elevation;a||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&f.exaggeration()&&this._centerAltitudeValidForExaggeration!==f.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*f.exaggeration(),this._centerAltitudeValidForExaggeration=f.exaggeration()):(this._centerAltitude=e||0,this._centerAltitudeValidForExaggeration=f.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const e=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(e)}sampleAverageElevation(){if(!this._elevation)return 0;const e=this._elevation,a=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],f=this.horizonLineFromTop();let y=0,w=0;for(let I=0;I<a.length;I++){const M=new i.P(a[I][0]*this.width,f+a[I][1]*(this.height-f)),L=e.pointCoordinate(M);if(!L)continue;const N=1/Math.hypot(L[0]-this._camera.position[0],L[1]-this._camera.position[1]);y+=L[3]*N,w+=N}return w===0?NaN:y/w}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const e=this._seaLevelZoom,a=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),f=this.pixelsPerMeter/this.worldSize*a,y=this._mercatorZfromZoom(e),w=this._mercatorZfromZoom(this._maxZoom),I=Math.max(y-f,w);this._setZoom(this._zoomFromMercatorZ(I))}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}computeZoomRelativeTo(e){const a=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,e.toAltitude()));let f;f=e.z<this._camera.position[2]?[a.x,a.y,a.z]:[e.x,e.y,e.z];const y=i.ag(i.av([],this._camera.position,f));return i.aA(this._zoomFromMercatorZ(y),this._minZoom,this._maxZoom)}setFreeCameraOptions(e){if(!this.height||!e.position&&!e.orientation)return;this._updateCameraState();let a=!1;if(e.orientation&&!i.co(e.orientation,this._camera.orientation)&&(a=this._setCameraOrientation(e.orientation)),e.position){const f=[e.position.x,e.position.y,e.position.z];i.cp(f,this._camera.position)||(this._setCameraPosition(f),a=!0)}a&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const e=this._camera.position,a=new hc;return a.position=new i.ae(e[0],e[1],e[2]),a.orientation=this._camera.orientation,a._elevation=this.elevation,a._renderWorldCopies=this.renderWorldCopies,a}_setCameraOrientation(e){if(!i.cq(e))return!1;i.cr(e,e);const a=i.cs([],[0,0,-1],e),f=i.cs([],[0,-1,0],e);if(f[2]<0)return!1;const y=Nf(a,f);return!!y&&(this._camera.orientation=y,!0)}_setCameraPosition(e){const a=this.zoomScale(this.minZoom)*this.tileSize,f=this.zoomScale(this.maxZoom)*this.tileSize,y=this.cameraToCenterDistance;e[2]=i.aA(e[2],y/f,y/a),this._camera.position=e}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,a,f){this._unmodified=!1,this._edgeInsets.interpolate(e,a,f),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){const a=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,a)}getVisibleUnwrappedCoordinates(e){const a=[new i.ct(0,e)];if(this.renderWorldCopies){const f=this.pointCoordinate(new i.P(0,0)),y=this.pointCoordinate(new i.P(this.width,0)),w=this.pointCoordinate(new i.P(this.width,this.height)),I=this.pointCoordinate(new i.P(0,this.height)),M=Math.floor(Math.min(f.x,y.x,w.x,I.x)),L=Math.floor(Math.max(f.x,y.x,w.x,I.x)),N=1;for(let V=M-N;V<=L+N;V++)V!==0&&a.push(new i.ct(V,e))}return a}isLODDisabled(e){return(!e||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(e,a,f){let y=[];const w=f!=null,I=!w;if(I&&this.zoom<a||w&&f[0]===0&&f[1]===0)return y;const M=new Set,L=(V,Z,U,X,Q)=>{const nt=i.cX(Z,V,U,X,Q);M.has(nt)||(y.push(new i.aP(V,Z,U,X,Q)),M.add(nt))};for(let V=0;V<e.length;V++){const Z=e[V];if(I&&Z.canonical.z!==a)continue;const U=Z.canonical,X=Z.overscaledZ,Q=Z.wrap,nt=1<<U.z,ht=U.x+1<nt,lt=U.x>0,_t=U.y+1<nt,Ct=U.y>0,bt=Z.wrap-(lt?0:1),Gt=Z.wrap+(ht?0:1),zt=lt?U.x-1:nt-1,Zt=ht?U.x+1:0;if(w)f[0]<0?(L(X,Gt,U.z,Zt,U.y),f[1]<0&&_t&&(L(X,Q,U.z,U.x,U.y+1),L(X,Gt,U.z,Zt,U.y+1)),f[1]>0&&Ct&&(L(X,Q,U.z,U.x,U.y-1),L(X,Gt,U.z,Zt,U.y-1))):f[0]>0?(L(X,bt,U.z,zt,U.y),f[1]<0&&_t&&(L(X,Q,U.z,U.x,U.y+1),L(X,bt,U.z,zt,U.y+1)),f[1]>0&&Ct&&(L(X,Q,U.z,U.x,U.y-1),L(X,bt,U.z,zt,U.y-1))):f[1]<0&&_t?L(X,Q,U.z,U.x,U.y+1):Ct&&L(X,Q,U.z,U.x,U.y-1);else{const Vt=Z.visibleQuadrants;1&Vt&&(L(X,bt,U.z,zt,U.y),Ct&&(L(X,Q,U.z,U.x,U.y-1),L(X,bt,U.z,zt,U.y-1))),2&Vt&&(L(X,Gt,U.z,Zt,U.y),Ct&&(L(X,Q,U.z,U.x,U.y-1),L(X,Gt,U.z,Zt,U.y-1))),4&Vt&&(L(X,bt,U.z,zt,U.y),_t&&(L(X,Q,U.z,U.x,U.y+1),L(X,bt,U.z,zt,U.y+1))),8&Vt&&(L(X,Gt,U.z,Zt,U.y),_t&&(L(X,Q,U.z,U.x,U.y+1),L(X,Gt,U.z,Zt,U.y+1)))}}const N=[];for(const V of y)y.some(Z=>V.isChildOf(Z))||N.push(V);if(y=N.filter(V=>!e.some(Z=>!!(V.overscaledZ<a&&Z.isChildOf(V))||V.equals(Z)||V.isChildOf(Z))),I){const V=1<<a,Z=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),U=[V*Z.x,V*Z.y],X=4,Q=X*X;y=y.filter(nt=>{const ht=nt.canonical.x+.5-U[0],lt=nt.canonical.y+.5-U[1];return ht*ht+lt*lt<Q})}return y}extendTileCoverToNearPlane(e,a,f){const y=[],w=new Set;for(const _t of e)w.add(_t.key);const I=(_t,Ct,bt,Gt,zt)=>{const Zt=i.cX(Ct,_t,bt,Gt,zt);w.has(Zt)||(y.push(new i.aP(_t,Ct,bt,Gt,zt)),w.add(Zt))},M=e.reduce((_t,Ct)=>Math.max(_t,Ct.overscaledZ),f),L=1<<f,N=[new i.P(0,0),new i.P(i.al,0),new i.P(i.al,i.al),new i.P(0,i.al)],V=new i.P(0,0),Z=new i.P(0,0),U=(_t,Ct)=>{const bt=Math.floor(_t[0]),Gt=Math.floor(_t[1]),zt=(_t[0]-bt)*i.al,Zt=(_t[1]-Gt)*i.al,Vt=Math.floor(Ct[0]),kt=Math.floor(Ct[1]),Ht=(Ct[0]-Vt)*i.al,pe=(Ct[1]-kt)*i.al;for(let ae=-1;ae<=1;ae++){const Ce=bt+ae;if(!(Ce<0||Ce>=L)){V.x=zt-ae*i.al,Z.x=Ht-(Ce-Vt)*i.al;for(let ve=-1;ve<=1;ve++){const Fe=Gt+ve;V.y=Zt-ve*i.al,Z.y=pe-(Fe-kt)*i.al,i.cY(V,Z,N)&&I(M,0,f,Ce,Fe)}}}},X=a.points,Q=X[i.cu],nt=X[i.cv],ht=this._projectToGround(Q,X[i.cw]),lt=this._projectToGround(nt,X[i.cx]);return U(Q,ht),U(nt,lt),y}_projectToGround(e,a){return i.cy(i.cz(),e,a,e[2]/(e[2]-a[2]))}coveringTiles(e){let a=this.coveringZoomLevel(e);const f=a,y=this.elevation&&this.elevation.exaggeration(),w=y&&!e.isTerrainDEM,I=this.projection.name==="mercator";if(e.minzoom!==void 0&&a<e.minzoom)return[];e.maxzoom!==void 0&&a>e.maxzoom&&(a=e.maxzoom);const M=this.locationCoordinate(this.center),L=this.center.lat,N=1<<a,V=[N*M.x,N*M.y,0],Z=this.projection.name==="globe",U=!Z,X=i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,a,U),Q=Z?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),nt=N*i.ce(1,this.center.lat),ht=this._camera.position[2]/i.ce(1,this.center.lat),lt=[N*Q.x,N*Q.y,ht*(U?1:nt)],_t=Z||y,Ct=this.cameraToCenterDistance/e.tileSize*(e.roundZoom?1:.502),bt=this.isLODDisabled(!0)?a:0;let Gt;if(this._elevation&&e.isTerrainDEM)Gt=1e4*this._elevation.exaggeration();else if(this._elevation){const re=this._elevation.getMinMaxForVisibleTiles();Gt=re?re.max:this._centerAltitude}else Gt=this._centerAltitude;const zt=e.isTerrainDEM?-Gt:this._elevation?this._elevation.getMinElevationBelowMSL():0,Zt=this.projection.isReprojectedInTileSpace?i.cB(this):1,Vt=re=>{const Te=new i.ae(re.x+25e-6,re.y,re.z),qe=new i.ae(re.x,re.y+25e-6,re.z),si=re.toLngLat(),Ci=Te.toLngLat(),ni=qe.toLngLat(),li=this.locationCoordinate(si),Li=this.locationCoordinate(Ci),Ti=this.locationCoordinate(ni),xi=Math.hypot(Li.x-li.x,Li.y-li.y),Ii=Math.hypot(Ti.x-li.x,Ti.y-li.y);return Math.sqrt(xi*Ii)*Zt/25e-6},kt=re=>{const Be=Gt,Te=zt;return{aabb:i.cE(this,N,0,0,0,re,Te,Be,this.projection),zoom:0,x:0,y:0,minZ:Te,maxZ:Be,wrap:re,fullyVisible:!1}},Ht=[];let pe=[];const ae=a,Ce=e.reparseOverscaled?f:a,ve=(ht-this._centerAltitude)*nt,Fe=re=>{if(!this._elevation||!re.tileID||!I)return;const Be=this._elevation.getMinMaxForTile(re.tileID),Te=re.aabb;Be?(Te.min[2]=Be.min,Te.max[2]=Be.max,Te.center[2]=(Te.min[2]+Te.max[2])/2):(re.shouldSplit=ge(re),re.shouldSplit||(Te.min[2]=Te.max[2]=Te.center[2]=this._centerAltitude))},oi=(re,Be)=>{if(.707*Be<re)return 1;const Te=Be/re;return Te/(1.4144271570014144+(Math.pow(1.1,Te-1.4144271570014144+1)-1)/(1.1-1)-1)},ge=re=>{if(re.zoom<bt)return!0;if(re.zoom===ae)return!1;if(re.shouldSplit!=null)return re.shouldSplit;const Be=re.aabb.distanceX(lt),Te=re.aabb.distanceY(lt);let qe=ve,si=1;if(Z){qe=re.aabb.distanceZ(lt);const Ii=Math.pow(2,re.zoom),Zi=i.a_((re.y+1)/Ii),Fr=i.a_(re.y/Ii),qr=Math.min(Math.max(L,Zi),Fr),En=i.d0(qr)/i.d0(L);if(si=qr===L?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,En/this._mercatorScaleRatio),this.zoom<=i.cZ&&re.zoom===ae-1&&En>=.9)return!0}else if(w&&(qe=re.aabb.distanceZ(lt)*nt),this.projection.isReprojectedInTileSpace&&f<=5){const Ii=Math.pow(2,re.zoom),Zi=Vt(new i.ae((re.x+.5)/Ii,(re.y+.5)/Ii));si=Zi>.85?1:Zi}if(!I&&!Z){const Ii=Math.sqrt(Be*Be+Te*Te+qe*qe);let Zi=(1<<ae-re.zoom)*Ct*si;return Zi*=oi(Math.max(qe,ve),Ii),Ii<Zi}let Ci=Number.MAX_VALUE,ni=0;const li=re.aabb.getCorners(),Li=[];for(const Ii of li){i.av(Li,Ii,lt),Z||(w?Li[2]*=nt:Li[2]=ve);const Zi=i.bI(Li,this._camera.forward());Zi<Ci&&(Ci=Zi,ni=Math.abs(Li[2]))}let Ti=(1<<ae-re.zoom)*Ct*si;if(Ti*=oi(Math.max(ni,ve),Ci),Ci<Ti)return!0;const xi=re.aabb.closestPoint(V);return xi[0]===V[0]&&xi[1]===V[1]};if(this.renderWorldCopies)for(let re=1;re<=3;re++)Ht.push(kt(-re)),Ht.push(kt(re));for(Ht.push(kt(0));Ht.length>0;){const re=Ht.pop(),Be=re.x,Te=re.y;let qe=re.fullyVisible;const si=()=>this.projection.name==="globe"&&(re.y===0||re.y===(1<<re.zoom)-1);if(!qe){let Ci=_t?re.aabb.intersects(X):re.aabb.intersectsFlat(X);if(Ci===0&&si()){const ni=new i.cC(re.zoom,Be,Te);Ci=i.cD(this,N,ni,!0).intersects(X)}if(Ci===0)continue;qe=Ci===2}if(re.zoom!==ae&&ge(re))for(let Ci=0;Ci<4;Ci++){const ni=(Be<<1)+Ci%2,li=(Te<<1)+(Ci>>1),Li={aabb:I?re.aabb.quadrant(Ci):i.cE(this,N,re.zoom+1,ni,li,re.wrap,re.minZ,re.maxZ,this.projection),zoom:re.zoom+1,x:ni,y:li,wrap:re.wrap,fullyVisible:qe,tileID:void 0,shouldSplit:void 0,minZ:re.minZ,maxZ:re.maxZ};w&&!Z&&(Li.tileID=new i.aP(re.zoom+1===ae?Ce:re.zoom+1,re.wrap,re.zoom+1,ni,li),Fe(Li)),Ht.push(Li)}else{const Ci=re.zoom===ae?Ce:re.zoom;if(e.minzoom&&e.minzoom>Ci)continue;let ni=0;if(!qe){let xi=_t?re.aabb.intersectsPrecise(X):re.aabb.intersectsPreciseFlat(X);if(xi===0&&si()){const Ii=new i.cC(re.zoom,Be,Te);xi=i.cD(this,N,Ii,!0).intersectsPrecise(X)}if(xi===0)continue;if(e.calculateQuadrantVisibility)if(X.containsPoint(re.aabb.center))ni=15;else for(let Ii=0;Ii<4;Ii++)re.aabb.quadrant(Ii).intersects(X)!==0&&(ni|=1<<Ii)}const li=V[0]-(.5+Be+(re.wrap<<re.zoom))*(1<<a-re.zoom),Li=V[1]-.5-Te,Ti=re.tileID?re.tileID:new i.aP(Ci,re.wrap,re.zoom,Be,Te);e.calculateQuadrantVisibility&&(Ti.visibleQuadrants=ni),pe.push({tileID:Ti,distanceSq:li*li+Li*Li})}}if(this.fogCullDistSq){const re=this.fogCullDistSq,Be=this.horizonLineFromTop();pe=pe.filter(Te=>{const qe=[0,0,0,1],si=[i.al,i.al,0,1],Ci=this.calculateFogTileMatrix(Te.tileID.toUnwrapped());i.aC(qe,qe,Ci),i.aC(si,si,Ci);const ni=i.cF([],qe,si),li=i.cG([],qe,si),Li=i.c_(ni,li);if(Li===0)return!0;let Ti=!1;const xi=this._elevation;if(xi&&Li>re&&Be!==0){const Ii=this.calculateProjMatrix(Te.tileID.toUnwrapped());let Zi;e.isTerrainDEM||(Zi=xi.getMinMaxForTile(Te.tileID)),Zi||(Zi={min:zt,max:Gt});const Fr=i.cH(this.rotation),qr=[Fr[0]*i.al,Fr[1]*i.al,Zi.max];i.af(qr,qr,Ii),Ti=(1-qr[1])*this.height*.5<Be}return Li<re||Ti})}return pe.sort((re,Be)=>re.distanceSq-Be.distanceSq).map(re=>re.tileID)}resize(e,a){this.width=e,this.height=a,this.pixelsToGLUnits=[2/e,-2/a],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log2(e)}project(e){const a=i.aA(e.lat,-i.cI,i.cI),f=this.projection.project(e.lng,a);return new i.P(f.x*this.worldSize,f.y*this.worldSize)}unproject(e){return this.projection.unproject(e.x/this.worldSize,e.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/i.ce(1,this.center.lat)/this.worldSize}setLocationAtPoint(e,a){let f,y;const w=this.centerPoint;if(this.projection.name==="globe"){const M=this.worldSize;f=(a.x-w.x)/M,y=(a.y-w.y)/M}else{const M=this.pointCoordinate(a),L=this.pointCoordinate(w);f=M.x-L.x,y=M.y-L.y}const I=this.locationCoordinate(e);this.setLocation(new i.ae(I.x-f,I.y-y))}setLocation(e){this.center=this.coordinateLocation(e),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(e,a){return this.projection.locationPoint(this,e,a)}locationPoint3D(e,a){return this.projection.locationPoint(this,e,a,!0)}pointLocation(e){return this.coordinateLocation(this.pointCoordinate(e))}pointLocation3D(e,a){return this.coordinateLocation(this.pointCoordinate3D(e,a))}locationCoordinate(e,a){const f=a?i.ce(a,e.lat):void 0,y=this.projection.project(e.lng,e.lat);return new i.ae(y.x,y.y,f)}coordinateLocation(e){return this.projection.unproject(e.x,e.y)}pointRayIntersection(e,a){const f=a??this._centerAltitude,y=[e.x,e.y,0,1],w=[e.x,e.y,1,1];i.aC(y,y,this.pixelMatrixInverse),i.aC(w,w,this.pixelMatrixInverse);const I=w[3];i.cJ(y,y,1/y[3]),i.cJ(w,w,1/I);const M=y[2],L=w[2];return{p0:y,p1:w,t:M===L?0:(f-M)/(L-M)}}screenPointToMercatorRay(e){const a=[e.x,e.y,0,1],f=[e.x,e.y,1,1];return i.aC(a,a,this.pixelMatrixInverse),i.aC(f,f,this.pixelMatrixInverse),i.cJ(a,a,1/a[3]),i.cJ(f,f,1/f[3]),a[2]=i.ce(a[2],this._center.lat)*this.worldSize,f[2]=i.ce(f[2],this._center.lat)*this.worldSize,i.cJ(a,a,1/this.worldSize),i.cJ(f,f,1/this.worldSize),new i.ax([a[0],a[1],a[2]],i.aw([],i.av([],f,a)))}rayIntersectionCoordinate(e){const{p0:a,p1:f,t:y}=e,w=i.ce(a[2],this._center.lat),I=i.ce(f[2],this._center.lat);return new i.ae(i.ak(a[0],f[0],y)/this.worldSize,i.ak(a[1],f[1],y)/this.worldSize,i.ak(w,I,y))}pointCoordinate(e,a=this._centerAltitude){return this.projection.pointCoordinate(this,e.x,e.y,a)}pointCoordinate3D(e,a){if(!this.elevation)return this.pointCoordinate(e,a);let f=this.projection.pointCoordinate3D(this,e.x,e.y);if(f)return new i.ae(f[0],f[1],f[2]);let y=0,w=this.horizonLineFromTop();if(e.y>w)return this.pointCoordinate(e,a);const I=.02*w,M=e.clone();for(let L=0;L<10&&w-y>I;L++){M.y=i.ak(y,w,.66);const N=this.projection.pointCoordinate3D(this,M.x,M.y);N?(w=M.y,f=N):y=M.y}return f?new i.ae(f[0],f[1],f[2]):this.pointCoordinate(e)}isPointAboveHorizon(e){return this.projection.isPointAboveHorizon(this,e)}isPointOnSurface(e){if(e.y<0||e.y>this.height||e.x<0||e.x>this.width)return!1;if(this.elevation||this.zoom>=i.cK)return!this.isPointAboveHorizon(e);const a=this.pointCoordinate(e);return a.y>=0&&a.y<=1}_coordinatePoint(e,a){const f=a&&this.elevation?this.elevation.getAtPointOrZero(e,this._centerAltitude):this._centerAltitude,y=[e.x*this.worldSize,e.y*this.worldSize,f+e.toAltitude(),1];return i.aC(y,y,this.pixelMatrix),y[3]>0?new i.P(y[0]/y[3],y[1]/y[3]):new i.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:e,left:a}=this._edgeInsets,f=this.height-this._edgeInsets.bottom,y=this.width-this._edgeInsets.right,w=this.pointLocation3D(new i.P(a,e)),I=this.pointLocation3D(new i.P(y,e)),M=this.pointLocation3D(new i.P(y,f)),L=this.pointLocation3D(new i.P(a,f));let N=Math.min(w.lng,I.lng,M.lng,L.lng),V=Math.max(w.lng,I.lng,M.lng,L.lng),Z=Math.min(w.lat,I.lat,M.lat,L.lat),U=Math.max(w.lat,I.lat,M.lat,L.lat);const X=Math.pow(2,-this.zoom)/16*270,Q=this.projection.name==="globe"?1:4,nt=(ht,lt,_t,Ct,bt)=>{const Gt=(ht+_t)/2,zt=(lt+Ct)/2,Zt=new i.P(Gt,zt),{lng:Vt,lat:kt}=this.pointLocation3D(Zt),Ht=Math.max(0,N-Vt,Z-kt,Vt-V,kt-U);N=Math.min(N,Vt),V=Math.max(V,Vt),Z=Math.min(Z,kt),U=Math.max(U,kt),(bt<Q||Ht>X)&&(nt(ht,lt,Gt,zt,bt+1),nt(Gt,zt,_t,Ct,bt+1))};if(nt(a,e,y,e,1),nt(y,e,y,f,1),nt(y,f,a,f,1),nt(a,f,a,e,1),this.projection.name==="globe"){const[ht,lt]=i.cL(this);ht?(U=90,V=180,N=-180):lt&&(Z=-90,V=180,N=-180)}return new i.aI(new i.aS(N,Z),new i.aS(V,U))}_getBoundsRectangular(e,a){const{top:f,left:y}=this._edgeInsets,w=this.height-this._edgeInsets.bottom,I=this.width-this._edgeInsets.right,M=new i.P(y,f),L=new i.P(I,f),N=new i.P(I,w),V=new i.P(y,w);let Z=this.pointCoordinate(M,e),U=this.pointCoordinate(L,e);const X=this.pointCoordinate(N,a),Q=this.pointCoordinate(V,a),nt=(ht,lt)=>(lt.y-ht.y)/(lt.x-ht.x);return Z.y>1&&U.y>=0?Z=new i.ae((1-Q.y)/nt(Q,Z)+Q.x,1):Z.y<0&&U.y<=1&&(Z=new i.ae(-Q.y/nt(Q,Z)+Q.x,0)),U.y>1&&Z.y>=0?U=new i.ae((1-X.y)/nt(X,U)+X.x,1):U.y<0&&Z.y<=1&&(U=new i.ae(-X.y/nt(X,U)+X.x,0)),new i.aI().extend(this.coordinateLocation(Z)).extend(this.coordinateLocation(U)).extend(this.coordinateLocation(Q)).extend(this.coordinateLocation(X))}_getBoundsRectangularTerrain(){const e=this.elevation;if(!e.visibleDemTiles.length||e.isUsingMockSource())return this._getBoundsRectangular(0,0);const a=e.visibleDemTiles.reduce((f,y)=>{if(y.dem){const w=y.dem.tree;f.min=Math.min(f.min,w.minimums[0]),f.max=Math.max(f.max,w.maximums[0])}return f},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(a.min*e.exaggeration(),a.max*e.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(e=!0){const a=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,f=this.height/2-a*(1-this._horizonShift);return e?Math.max(0,f):f}getMaxBounds(){return this.maxBounds}setMaxBounds(e){this.maxBounds=e,this.minLat=-i.cI,this.maxLat=i.cI,this.minLng=-180,this.maxLng=180,e&&(this.minLat=e.getSouth(),this.maxLat=e.getNorth(),this.minLng=e.getWest(),this.maxLng=e.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=i.aF(this.minLng)*this.tileSize,this.worldMaxX=i.aF(this.maxLng)*this.tileSize,this.worldMinY=i.aJ(this.maxLat)*this.tileSize,this.worldMaxY=i.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(e,a){return this.projection.createTileMatrix(this,a,e)}calculateDistanceTileData(e){const a=e.key,f=this._distanceTileDataCache;if(f[a])return f[a];const y=e.canonical,w=1/this.height,I=this.cameraWorldSize,M=I/this.zoomScale(y.z),L=(y.x+Math.pow(2,y.z)*e.wrap)*M,N=y.y*M,V=this.point;V.x*=I/this.worldSize,V.y*=I/this.worldSize;const Z=this.angle,U=Math.sin(-Z),X=-Math.cos(-Z);return f[a]={bearing:[U,X],center:[(V.x-L)*w,(V.y-N)*w],scale:M/i.al*w},f[a]}calculateFogTileMatrix(e){const a=e.key,f=this._fogTileMatrixCache;if(f[a])return f[a];const y=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,e);return i.aB(y,this.worldToFogMatrix,y),f[a]=new Float32Array(y),f[a]}calculateProjMatrix(e,a=!1,f=!1){const y=e.key;let w;if(w=f?this._expandedProjMatrixCache:a?this._alignedProjMatrixCache:this._projMatrixCache,w[y])return w[y];const I=this.calculatePosMatrix(e,this.worldSize);let M;return M=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:f?this.expandedFarZProjMatrix:a?this.alignedProjMatrix:this.projMatrix,i.aB(I,M,I),w[y]=new Float32Array(I),w[y]}calculatePixelsToTileUnitsMatrix(e){const a=e.tileID.key,f=this._pixelsToTileUnitsCache;if(f[a])return f[a];const y=i.cM(e,this);return f[a]=y,f[a]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const e=1/this.worldSize,a=i.bp([],[e,e,e]);return i.aB(a,a,this.globeMatrix),a}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const e=this._elevation;this._updateCameraState();const a=i.ce(1,this._center.lat)*this.worldSize,f=this._computeCameraPosition(a),y=this._camera.forward(),w=i.ce(1,this._center.lat);f[2]/=w,y[2]/=w,i.aw(y,y);const I=e.raycast(f,y,e.exaggeration());if(I){const M=i.bG([],f,y,I),L=new i.ae(M[0],M[1],i.ce(M[2],i.a_(M[1]))),N=(L.z+i.ag([L.x-f[0],L.y-f[1],L.z-f[2]*w]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(N),this._centerAltitude=L.toAltitude(),this._center=this.coordinateLocation(L),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(e=!1){if(!this._elevation)return;const a=this._elevation,f=i.ce(1,this._center.lat)*this.worldSize,y=this._computeCameraPosition(f),w=a.getAtPointOrZero(new i.ae(...y)),I=this.pixelsPerMeter/this.worldSize*w,M=this._minimumHeightOverTerrain(),L=y[2]-I;if(L<=M)if(L<0||e){const N=this.locationCoordinate(this._center,this._centerAltitude),V=[y[0],y[1],N.z-y[2]],Z=i.ag(V);V[2]-=(M-L)/this._pixelsPerMercatorPixel;const U=i.ag(V);if(U===0)return;i.c4(V,V,Z/U*this._pixelsPerMercatorPixel),this._camera.position=[y[0],y[1],N.z*this._pixelsPerMercatorPixel-V[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const e=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||e){const U=this.center;return U.lat=i.aA(U.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!e)&&(U.lng=i.aA(U.lng,this.minLng,this.maxLng)),this.center=U,void(this._constraining=!1)}const a=this._unmodified,{x:f,y}=this.point;let w=0,I=f,M=y;const L=this.width/2,N=this.height/2,V=this.worldMinY*this.scale,Z=this.worldMaxY*this.scale;if(y-N<V&&(M=V+N),y+N>Z&&(M=Z-N),Z-V<this.height&&(w=Math.max(w,this.height/(Z-V)),M=(Z+V)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const U=this.worldMinX*this.scale,X=this.worldMaxX*this.scale,Q=this.worldSize/2-(U+X)/2;I=(f+Q+this.worldSize)%this.worldSize-Q,I-L<U&&(I=U+L),I+L>X&&(I=X-L),X-U<this.width&&(w=Math.max(w,this.width/(X-U)),I=(X+U)/2)}I===f&&M===y||this._allowWorldUnderZoom||(this.center=this.unproject(new i.P(I,M))),w&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(w)),this._constrainCamera(),this._unmodified=a,this._constraining=!1}_minZoomForBounds(){let e=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(e=Math.max(e,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),e}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const e=this.centerOffset,a=this.projection.name==="globe",f=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=i.ce(1,this.center.lat)/i.ce(1,i.d1));const y=i.cN(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,y),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const w=this.projection.zAxisUnit==="meters"?f:1,I=this._camera.getWorldToCamera(this.worldSize,w);let M;const L=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(L[8]=2*-e.x/this.width,L[9]=2*e.y/this.height,this.isOrthographic){let kt=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Ht=kt*this.aspect,pe=-Ht,ae=-kt;Ht-=e.x,pe-=e.x,kt+=e.y,ae+=e.y,M=this._camera.getCameraToClipOrthographic(pe,Ht,ae,kt,this._nearZ,this._farZ),((Ce,ve,Fe,oi)=>{for(let ge=0;ge<16;ge++)Ce[ge]=i.ak(ve[ge],Fe[ge],oi)})(M,M,L,i.c$(this.pitch>=Ah?1:this.pitch/Ah))}else M=L;const N=i.cO([],L,I);let V=i.cO([],M,I);if(this.projection.isReprojectedInTileSpace){const kt=this.locationCoordinate(this.center),Ht=i.bz([]);i.bq(Ht,Ht,[kt.x*this.worldSize,kt.y*this.worldSize,0]),i.aB(Ht,Ht,i.cP(this)),i.bq(Ht,Ht,[-kt.x*this.worldSize,-kt.y*this.worldSize,0]),i.aB(V,V,Ht),i.aB(N,N,Ht),this.inverseAdjustmentMatrix=i.cQ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=i.cR([],V,[this.worldSize,this.worldSize,this.worldSize/w,1]),this.projMatrix=V,this.invProjMatrix=i.bk(new Float64Array(16),this.projMatrix),a){const kt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);kt[8]=2*-e.x/this.width,kt[9]=2*e.y/this.height,this.expandedFarZProjMatrix=i.cO([],kt,I)}else this.expandedFarZProjMatrix=this.projMatrix;const Z=i.bk([],M);this.frustumCorners=i.cS.fromInvProjectionMatrix(Z,this.horizonLineFromTop(),this.height),this.cameraFrustum=i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!a);const U=new Float32Array(16);i.bz(U),i.cR(U,U,[1,-1,1]),i.cT(U,U,this._pitch),i.bA(U,U,this.angle);const X=i.cc(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=i.by(X);const Q=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;X[8]=2*-e.x/this.width,X[9]=2*(e.y+Q)/this.height,this.skyboxMatrix=i.aB(U,X,U);const nt=this.point,ht=nt.x,lt=nt.y,_t=this.width%2/2,Ct=this.height%2/2,bt=Math.cos(this.angle),Gt=Math.sin(this.angle),zt=ht-Math.round(ht)+bt*_t+Gt*Ct,Zt=lt-Math.round(lt)+bt*Ct+Gt*_t,Vt=new Float64Array(V);if(i.bq(Vt,Vt,[zt>.5?zt-1:zt,Zt>.5?Zt-1:Zt,0]),this.alignedProjMatrix=Vt,V=i.bB(),i.cR(V,V,[this.width/2,-this.height/2,1]),i.bq(V,V,[1,-1,0]),this.labelPlaneMatrix=V,V=i.bB(),i.cR(V,V,[1,-1,1]),i.bq(V,V,[-1,-1,0]),i.cR(V,V,[2/this.width,2/this.height,1]),this.glCoordMatrix=V,this.pixelMatrix=i.aB(new Float64Array(16),this.labelPlaneMatrix,N),this._calcFogMatrices(),this._distanceTileDataCache={},V=i.bk(new Float64Array(16),this.pixelMatrix),!V)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=V,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=i.cU(this);const kt=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=i.af(kt,kt,I),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=V;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const e=this.cameraWorldSizeForFog,a=this.cameraPixelsPerMeter,f=this._camera.position,y=1/this.height/this._pixelsPerMercatorPixel,w=[e,e,a];i.c4(w,w,y),i.c4(f,f,-1),i.cV(f,f,w);const I=i.bB();i.bq(I,I,f),i.cR(I,I,w),this.mercatorFogMatrix=I,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(e,a,y)}_computeCameraPosition(e){const a=(e=e||this.pixelsPerMeter)/this.pixelsPerMeter,f=this._camera.forward(),y=this.point,w=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*a-e/this.worldSize*this._centerAltitude;return[y.x/this.worldSize-f[0]*w,y.y/this.worldSize-f[1]*w,e/this.worldSize*this._centerAltitude-f[2]*w]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(e){const a=this._maxCameraBoundsDistance()*Math.cos(this._pitch),f=this._camera.position[2],y=e[2];let w=1;this.projection.wrap&&(this.center=this.center.wrap()),y>0&&(w=Math.min((a-f)/y,1)),this._camera.position=i.bG([],this._camera.position,e,w),this._updateStateFromCamera()}_updateStateFromCamera(){const e=this._camera.position,a=this._camera.forward(),{pitch:f,bearing:y}=this._camera.getPitchBearing(),w=i.ce(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,I=this._mercatorZfromZoom(this._maxZoom)*Math.cos(i.an(this._maxPitch)),M=Math.max((e[2]-w)/Math.cos(f),I),L=this._zoomFromMercatorZ(M);i.bG(e,e,a,M),this._pitch=i.aA(f,i.an(this.minPitch),i.an(this.maxPitch)),this.angle=i.bS(y,-Math.PI,Math.PI),this._setZoom(i.aA(L,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new i.ae(e[0],e[1],e[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(e){return Math.pow(2,e)*this.tileSize}_mercatorZfromZoom(e){return this.cameraToCenterDistance/this._worldSizeFromZoom(e)}_minimumHeightOverTerrain(){const e=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(e)}_zoomFromMercatorZ(e){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,e)*this.tileSize))}zoomFromMercatorZAdjusted(e){let a=0,f=i.cK,y=0,w=1/0;for(;f-a>1e-6&&f>a;){const I=a+.5*(f-a),M=this.tileSize*Math.pow(2,I),L=this.getCameraToCenterDistance(this.projection,I,M),N=this.scaleZoom(L/(Math.max(0,e)*this.tileSize)),V=Math.abs(I-N);V<w&&(w=V,y=I),I<N?a=I:f=I}return y}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(i.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(e,a){const f=Math.min(e.x,a.x),y=Math.max(e.x,a.x),w=Math.min(e.y,a.y),I=Math.max(e.y,a.y);if(w<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const M=[new i.P(f,w),new i.P(y,I),new i.P(f,I),new i.P(y,w)],L=this.renderWorldCopies?-3:0,N=this.renderWorldCopies?4:1;for(const V of M){const Z=this.pointRayIntersection(V);if(Z.t<0)return!0;const U=this.rayIntersectionCoordinate(Z);if(U.x<L||U.y<0||U.x>N||U.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+i.cW(this.fovAboveCenter)>88||this.anyCornerOffEdge(new i.P(0,0),new i.P(this.width,this.height))}zoomDeltaToMovement(e,a){const f=i.ag(i.av([],this._camera.position,e)),y=this._zoomFromMercatorZ(f)+a;return f-this._mercatorZfromZoom(y)}getCameraPoint(){if(this.projection.name==="globe"){const e=function([a,f,y],w){const I=[a,f,y,1];i.aC(I,I,w);const M=I[3]=Math.max(I[3],1e-6);return I[0]/=M,I[1]/=M,I[2]/=M,I}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new i.P(e[0],e[1])}{const e=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new i.P(0,e))}}getCameraToCenterDistance(e,a=this.zoom,f=this.worldSize){const y=i.cN(e,a,this.width,this.height,1024),w=e.pixelSpaceConversion(this.center.lat,f,y);let I=.5/Math.tan(.5*this._fov)*this.height*w;return this.isOrthographic&&(I=i.ak(1,I,i.c$(this.pitch>=Ah?1:this.pitch/Ah))),I}getWorldToCameraMatrix(){const e=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&i.aB(e,e,this.globeMatrix),e}getFrustum(e){return i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,e,this.projection.zAxisUnit==="meters")}}const sa=(p,e)=>{if(e>0&&p.terrain&&i.w("Cutoff is currently disabled on terrain"),e<=0||p.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const a=p.transform,f=Math.max(Math.abs(a._zoom-(p.minCutoffZoom-1)),1),y=a.isLODDisabled(!1)?i.ah(60,45,a.pitch):i.ah(30,15,a.pitch),w=a._farZ-a._nearZ,I=e*a.height,M=((1-(L=y))*a.cameraToCenterDistance+L*(a._farZ+I))*f;var L;return{shouldRenderCutoff:y<1,uniformValues:{u_cutoff_params:[a._nearZ,a._farZ,(M-a._nearZ)/w,(M-I-a._nearZ)/w]}}},gs={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class cf{constructor(e,a){this.aabb=e,this.lastCascade=a}}class hf{add(e,a){const f=this.receivers[e.key];f!==void 0?(f.aabb.min[0]=Math.min(f.aabb.min[0],a.min[0]),f.aabb.min[1]=Math.min(f.aabb.min[1],a.min[1]),f.aabb.min[2]=Math.min(f.aabb.min[2],a.min[2]),f.aabb.max[0]=Math.max(f.aabb.max[0],a.max[0]),f.aabb.max[1]=Math.max(f.aabb.max[1],a.max[1]),f.aabb.max[2]=Math.max(f.aabb.max[2],a.max[2])):this.receivers[e.key]=new cf(a,null)}clear(){this.receivers={}}get(e){return this.receivers[e.key]}computeRequiredCascades(e,a,f){const y=i.d8.fromPoints(e.points);let w=0;for(const I in this.receivers){const M=this.receivers[I];if(!M||!y.intersectsAabb(M.aabb))continue;M.aabb.min=y.closestPoint(M.aabb.min),M.aabb.max=y.closestPoint(M.aabb.max);const L=M.aabb.getCorners();for(let N=0;N<f.length;N++){let V=!0;for(const Z of L){const U=[Z[0]*a,Z[1]*a,Z[2]];if(i.af(U,U,f[N].matrix),U[0]<-1||U[0]>1||U[1]<-1||U[1]>1){V=!1;break}}if(M.lastCascade=N,w=Math.max(w,N),V)break}}return w+1}}class hu{constructor(e){this.painter=e,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new hf,this._depthMode=new zi(e.context.gl.LEQUAL,zi.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,e.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),e.tp.registerParameter(gs,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),e.tp.registerParameter(gs,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),e.tp.registerParameter(gs,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),e.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const e of this._cascades)e.texture.destroy(),e.framebuffer.destroy();this._cascades=[]}updateShadowParameters(e,a){const f=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!a||!a.properties)return;const y=a.properties.get("shadow-intensity");if(!a.shadowsEnabled()||y<=0||(this._shadowLayerCount=f.style.order.reduce((Q,nt)=>{const ht=f.style._mergedLayers[nt];return Q+(ht.hasShadowPass()&&!ht.isHidden(e.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const w=f.context,I=gs.shadowMapResolution,M=gs.shadowMapResolution;if(this._cascades.length===0||gs.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let Q=0;Q<gs.cascadeCount;++Q){const nt=f._shadowMapDebug,ht=w.gl,lt=w.createFramebuffer(I,M,nt,"texture"),_t=new i.T(w,{width:I,height:M,data:null},ht.DEPTH_COMPONENT16);if(lt.depthAttachment.set(_t.texture),nt){const Ct=new i.T(w,{width:I,height:M,data:null},ht.RGBA8);lt.colorAttachment.set(Ct.texture)}this._cascades.push({framebuffer:lt,texture:_t,matrix:[],far:0,boundingSphereRadius:0,frustum:new i.cA,scale:0})}}this.shadowDirection=Ph(a);let L=0;if(e.elevation){const Q=e.elevation,nt=[1e4,-1e4];Q.visibleDemTiles.filter(ht=>ht.dem).forEach(ht=>{const lt=ht.dem.tree;nt[0]=Math.min(nt[0],lt.minimums[0]),nt[1]=Math.max(nt[1],lt.maximums[0])}),nt[0]!==1e4&&(L=(nt[1]-nt[0])*Q.exaggeration())}const N=1.5*e.cameraToCenterDistance,V=3*N,Z=new Float64Array(16);for(let Q=0;Q<this._cascades.length;++Q){const nt=this._cascades[Q];let ht=e.height/50,lt=1;gs.cascadeCount===1?lt=V:Q===0?lt=N:(ht=N,lt=V);const[_t,Ct]=Vf(e,this.shadowDirection,ht,lt,gs.shadowMapResolution,L);nt.scale=e.scale,nt.matrix=_t,nt.boundingSphereRadius=Ct,i.bk(Z,nt.matrix),nt.frustum=i.cA.fromInvProjectionMatrix(Z,1,0,!0),nt.far=lt}const U=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[U].far,this._cascades[U].far],this._uniformValues.u_shadow_intensity=y,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/gs.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=gs.shadowMapResolution,this._uniformValues.u_shadowmap_0=ms.ShadowMap0,this._uniformValues.u_shadowmap_1=ms.ShadowMap0+1,this._groundShadowTiles=f.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const X=f.transform.elevation;for(const Q of this._groundShadowTiles){let nt={min:0,max:0};if(X){const ht=X.getMinMaxForTile(Q);ht&&(nt=ht)}this.addShadowReceiver(Q.toUnwrapped(),nt.min,nt.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(e){this._enabled=e}drawShadowPass(e,a){if(!this.enabled)return;const f=this.painter,y=f.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(f.transform.getFrustum(0),f.transform.worldSize,this._cascades),y.viewport.set([0,0,gs.shadowMapResolution,gs.shadowMapResolution]);for(let w=0;w<this._numCascadesToRender;++w){f.currentShadowCascade=w,y.bindFramebuffer.set(this._cascades[w].framebuffer.framebuffer),y.clear({color:i.ao.white,depth:1});for(const I of e.order){const M=e._mergedLayers[I];if(!M.hasShadowPass()||M.isHidden(f.transform.zoom))continue;const L=e.getLayerSourceCache(M),N=L?a[L.id]:void 0;(M.type==="model"||N&&N.length)&&f.renderLayer(f,L,M,N)}}f.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const e=this.painter,a=e.style,f=e.context,y=f.gl,w=a.directionalLight,I=a.ambientLight;if(!w||!I)return;const M=[],L=sa(e,e.longestCutoffRange);L.shouldRenderCutoff&&M.push("RENDER_CUTOFF"),M.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&M.push("NORMAL_OFFSET");const N=hl(a,w,I),V=new zi(y.LEQUAL,zi.ReadOnly,e.depthRangeFor3D),Z=new sr({func:y.EQUAL,mask:255},0,255,y.KEEP,y.KEEP,y.KEEP);for(const U of this._groundShadowTiles){const X=U.toUnwrapped(),Q=e.isTileAffectedByFog(U),nt=e.getOrCreateProgram("groundShadow",{defines:M,overrideFog:Q});this.setupShadows(X,nt),e.uploadCommonUniforms(f,nt,X,null,L);const ht={u_matrix:e.transform.calculateProjMatrix(X),u_ground_shadow_factor:N};nt.draw(e,y.TRIANGLES,V,Z,yr.multiply,Qi.disabled,ht,"ground_shadow",e.tileExtentBuffer,e.quadTriangleIndexBuffer,e.tileExtentSegments,null,e.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?yr.unblended:yr.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(e){const a=this.painter.transform,f=a.calculatePosMatrix(e,a.worldSize);return i.aB(f,this._cascades[this.painter.currentShadowCascade].matrix,f),Float32Array.from(f)}calculateShadowPassMatrixFromMatrix(e){const a=i.by(e);return i.aB(a,this._cascades[this.painter.currentShadowCascade].matrix,e),a}setupShadows(e,a,f){if(!this.enabled)return;const y=this.painter.transform,w=this.painter.context,I=w.gl,M=this._uniformValues,L=new Float64Array(16),N=y.calculatePosMatrix(e,y.worldSize);for(let V=0;V<this._cascades.length;V++)i.aB(L,this._cascades[V].matrix,N),M[V===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(L),w.activeTexture.set(I.TEXTURE0+ms.ShadowMap0+V),this._cascades[V].texture.bindExtraParam(I.LINEAR,I.LINEAR,I.CLAMP_TO_EDGE,I.CLAMP_TO_EDGE,I.GREATER);if(this.useNormalOffset=!!f,this.useNormalOffset){const V=i.d6(e.canonical),Z=2/y.tileSize*i.al/gs.shadowMapResolution,U=Z*this._cascades[0].boundingSphereRadius,X=Z*this._cascades[this._cascades.length-1].boundingSphereRadius,Q=(f==="vector-tile"?1:3)*function(nt,ht,lt,_t,Ct){const bt=i.aA((nt-22)/-22,0,1);return .125*(1-bt)+4*bt}(y.zoom);M.u_shadow_normal_offset=[V,U*Q,X*Q],M.u_shadow_bias=[1e-4,.0012,.012]}else M.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(w,M)}setupShadowsFromMatrix(e,a,f=!1){if(!this.enabled)return;const y=this.painter.context,w=y.gl,I=this._uniformValues,M=new Float64Array(16);for(let L=0;L<gs.cascadeCount;L++)i.aB(M,this._cascades[L].matrix,e),I[L===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(M),y.activeTexture.set(w.TEXTURE0+ms.ShadowMap0+L),this._cascades[L].texture.bindExtraParam(w.LINEAR,w.LINEAR,w.CLAMP_TO_EDGE,w.CLAMP_TO_EDGE,w.GREATER);if(this.useNormalOffset=f,f){const L=gs.normalOffset;I.u_shadow_normal_offset=[1,L,L],I.u_shadow_bias=[6e-5,.0012,.012]}else I.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(y,I)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(e,a,f,y){if(y[2]>=0)return{};const w=function(L,N,V){const Z=V/(1<<L.canonical.z);return new i.d8([L.canonical.x*Z+L.wrap*V,L.canonical.y*Z+L.wrap*V,0],[(L.canonical.x+1)*Z+L.wrap*V,(L.canonical.y+1)*Z+L.wrap*V,N])}(e,a,f).getCorners(),I=a/-y[2];y[0]<0?(i.d7(w[0],w[0],[y[0]*I,0,0]),i.d7(w[3],w[3],[y[0]*I,0,0])):y[0]>0&&(i.d7(w[1],w[1],[y[0]*I,0,0]),i.d7(w[2],w[2],[y[0]*I,0,0])),y[1]<0?(i.d7(w[0],w[0],[0,y[1]*I,0]),i.d7(w[1],w[1],[0,y[1]*I,0])):y[1]>0&&(i.d7(w[2],w[2],[0,y[1]*I,0]),i.d7(w[3],w[3],[0,y[1]*I,0]));const M={};return M.vertices=w,M.planes=[Dc(w[1],w[0],w[4]),Dc(w[2],w[1],w[5]),Dc(w[3],w[2],w[6]),Dc(w[0],w[3],w[7])],M}addShadowReceiver(e,a,f){this._receivers.add(e,i.d8.fromTileIdAndHeight(e,a,f))}getMaxCascadeForTile(e){const a=this._receivers.get(e);return a&&a.lastCascade?a.lastCascade:0}}function Dc(p,e,a){const f=i.av([],a,e),y=i.av([],p,e),w=i.bH([],f,y),I=i.ag(w);return I===0?[0,0,1,0]:(i.c4(w,w,1/I),[w[0],w[1],w[2],-i.bI(w,e)])}function Ph(p){const e=p.properties.get("direction"),a=i.d3(e.x,e.y,e.z);a[2]=i.aA(a[2],0,75);const f=i.d5([a[0],a[1],a[2]]);return i.d4(f.x,f.y,f.z)}function hl(p,e,a){const f=e.properties.get("color-use-theme")==="none",y=e.properties.get("color"),w=e.properties.get("intensity"),I=e.properties.get("direction"),M=[I.x,I.y,I.z],L=a.properties.get("color-use-theme")==="none",N=a.properties.get("color"),V=a.properties.get("intensity"),Z=Math.max(i.bI([0,0,1],M),0),U=[0,0,0];i.c4(U,N.toPremultipliedRenderColor(L?null:p.getLut(e.scope)).toArray01Linear().slice(0,3),V);const X=[0,0,0];return i.c4(X,y.toPremultipliedRenderColor(f?null:p.getLut(a.scope)).toArray01Linear().slice(0,3),Z*w),i.da([U[0]>0?U[0]/(U[0]+X[0]):0,U[1]>0?U[1]/(U[1]+X[1]):0,U[2]>0?U[2]/(U[2]+X[2]):0])}function Vf(p,e,a,f,y,w){const I=p.zoom,M=p.scale,L=p.worldSize,N=1/L,V=p.aspect,Z=Math.sqrt(1+V*V)*Math.tan(.5*p.fovX),U=Z*Z,X=f-a,Q=f+a;let nt,ht;U>X/Q?(nt=f,ht=f*Z):(nt=.5*Q*(1+U),ht=.5*Math.sqrt(X*X+2*(f*f+a*a)*U+Q*Q*U*U));const lt=p.projection.pixelsPerMeter(p.center.lat,L),_t=p._camera.getCameraToWorldMercator(),Ct=[0,0,-nt*N];i.af(Ct,Ct,_t);let bt=ht*N;const Gt=p._edgeInsets;if(!(Gt.left===0&&Gt.top===0&&Gt.right===0&&Gt.bottom===0||Gt.left===Gt.right&&Gt.top===Gt.bottom)){const qe=p._camera.getWorldToCamera(p.worldSize,p.projection.zAxisUnit==="meters"?lt:1),si=p._camera.getCameraToClipPerspective(p._fov,p.width/p.height,a,f);si[8]=2*-p.centerOffset.x/p.width,si[9]=2*p.centerOffset.y/p.height;const Ci=new Float64Array(16);i.cO(Ci,si,qe);const ni=new Float64Array(16);i.bk(ni,Ci);const li=i.cA.fromInvProjectionMatrix(ni,L,I,!0);for(const Li of li.points){const Ti=((zt=Li)[0]/=M,zt[1]/=M,zt[2]=i.ce(zt[2],p._center.lat),zt);bt=Math.max(bt,i.c5(i.d9([],Ct,Ti)))}}var zt;bt*=y/(y-1);const Zt=Math.acos(e[2]),Vt=Math.atan2(-e[0],-e[1]),kt=new cu;kt.position=Ct,kt.setPitchBearing(Zt,Vt);const Ht=kt.getWorldToCamera(L,lt),pe=bt*L,ae=Math.min(p._mercatorZfromZoom(17)*L*-2,-2*pe),Ce=kt.getCameraToClipOrthographic(-pe,pe,-pe,pe,ae,(pe+w*lt)/e[2]),ve=new Float64Array(16);i.aB(ve,Ce,Ht);const Fe=i.d4(Math.floor(1e6*Ct[0])/1e6*L,Math.floor(1e6*Ct[1])/1e6*L,0),oi=.5*y,ge=[0,0,0];i.af(ge,Fe,ve),i.c4(ge,ge,oi);const re=[Math.floor(ge[0]),Math.floor(ge[1]),Math.floor(ge[2])],Be=[0,0,0];i.av(Be,ge,re),i.c4(Be,Be,-1/oi);const Te=new Float64Array(16);return i.bz(Te),i.bq(Te,Te,Be),i.aB(ve,Te,ve),[ve,pe]}class Qn extends i.E{constructor(e){super(),this.requestManager=e,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(e,a){return i.db(this.requestManager.transformRequest(a,i.R.Model).url).then(f=>{if(!f)return;const y=i.dc(f),w=new i.dd(e,a,void 0,void 0,y);return w.computeBoundsAndApplyParent(),w}).catch(f=>{if(f&&f.status===404)return null;this.fire(new i.y(new Error(`Could not load model ${e} from ${a}: ${f.message}`)))})}load(e,a,f={forceReload:!1}){this.models[a]||(this.models[a]={});const y=Object.keys(e),w=[],I=[];for(const M of y){const L=e[M];this.hasURLBeenRequested(L)&&!f.forceReload||(this.modelByURL[L]={modelId:M,scope:a},w.push(this.loadModel(M,L)),I.push(M)),this.models[a][M]||(this.models[a][M]={model:null,numReferences:1})}this.numModelsLoading[a]=(this.numModelsLoading[a]||0)+I.length,Promise.allSettled(w).then(M=>{for(let L=0;L<M.length;L++){const{status:N}=M[L];if(N==="rejected")continue;const{value:V}=M[L];this.models[a][I[L]]||(this.models[a][I[L]]={model:null,numReferences:1}),this.models[a][I[L]].model=V}this.numModelsLoading[a]-=I.length,this.fire(new i.z("data",{dataType:"style"}))}).catch(M=>{this.fire(new i.y(new Error(`Could not load models: ${M.message}`)))})}isLoaded(){for(const e in this.numModelsLoading)if(this.numModelsLoading[e]>0)return!1;return!0}hasModel(e,a,f={exactIdMatch:!1}){return!!(f.exactIdMatch?this.getModel(e,a):this.getModelByURL(this.modelUris[a][e]))}getModel(e,a){return this.models[a]||(this.models[a]={}),this.models[a][e]?this.models[a][e].model:void 0}getModelByURL(e){if(!e)return null;const a=this.modelByURL[e];return a?this.models[a.scope][a.modelId].model:null}hasModelBeenAdded(e,a){return this.models[a]&&this.models[a][e]!==void 0}getModelURIs(e){return this.modelUris[e]||{}}addModel(e,a,f){this.models[f]||(this.models[f]={}),this.modelUris[f]||(this.modelUris[f]={});const y=this.requestManager.normalizeModelURL(a);if((this.hasModel(e,f,{exactIdMatch:!0})||this.hasModelBeenAdded(e,f))&&this.modelUris[f][e]===y)this.models[f][e].numReferences++;else if(this.hasURLBeenRequested(y)){const{scope:w,modelId:I}=this.modelByURL[y];this.models[w][I].numReferences++}else this.modelUris[f][e]=y,this.load({[e]:this.modelUris[f][e]},f)}addModelURLs(e,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});const f=this.modelUris[a];for(const y in e)f[y]=this.requestManager.normalizeModelURL(e[y])}reloadModels(e){this.load(this.modelUris[e],e,{forceReload:!0})}addModelsFromBucket(e,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});const f={};for(const y of e)this.hasModel(y,a,{exactIdMatch:!0})||this.hasURLBeenRequested(y)?this.models[a][y].numReferences++:this.modelUris[a][y]&&!this.hasURLBeenRequested(y)?f[y]=this.modelUris[a][y]:!this.hasURLBeenRequested(y)&&i.de(y,!1)&&(this.modelUris[a][y]=this.requestManager.normalizeModelURL(y),f[y]=this.modelUris[a][y]);this.load(f,a)}hasURLBeenRequested(e){return this.modelByURL[e]!==void 0}removeModel(e,a,f=!1,y=!1){if(this.models[a]&&this.models[a][e]&&(this.models[a][e].numReferences--,this.models[a][e].numReferences===0||y)){const w=this.modelUris[a][e];f||delete this.modelUris[a][e],delete this.modelByURL[w];const I=this.models[a][e].model;if(!I)return;delete this.models[a][e],I.destroy()}}destroy(){for(const e of Object.keys(this.models))for(const a of Object.keys(this.models[e])){const f=this.models[e][a].model;delete this.models[e][a],f&&f.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(e){return this.models[e]||(this.models[e]={}),Object.keys(this.models[e])}upload(e,a){this.models[a]||(this.models[a]={});for(const f in this.models[a])this.models[a][f].model&&this.models[a][f].model.upload(e.context)}}const Md=i.a6.colorTheme,Mh=new i.a9({data:new i.aa(Md.data)});function Uf(p){if(!p.metadata||!p.metadata.content_area)return;const e=i.o.devicePixelRatio,{left:a,top:f,width:y,height:w}=p.metadata.content_area,I=a*e,M=f*e;return[I,M,I+y*e,M+w*e]}function jf(p){if(p)return p.map(([e,a])=>[e*i.o.devicePixelRatio,a*i.o.devicePixelRatio])}class Gf{constructor(e,a,f){this.id=e,this.scope=a,this.sourceCache=f,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(e){this.missingRequests.has(e.name)||this.pendingRequests.has(e.name)||this.pendingRequests.add(e.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const e=new Map;if(!this.sourceCache.loaded())return e;const a=this.sourceCache.getVisibleCoordinates();if(a.length===0)return e;const f=this.sourceCache.getSource();if(!(f instanceof es))return e;const y=a.map(I=>this.sourceCache.getTile(I)),w=f.getImages(y,Array.from(this.pendingRequests));for(const[I,M]of w)e.set(i.I.from({name:I,iconsetId:this.id}),M),this.pendingRequests.delete(I);for(const I of this.pendingRequests)this.missingRequests.add(I);return this.pendingRequests.clear(),e}}const uc=(p,e)=>st(p,e&&e.filter(a=>a.identifier!=="source.canvas")),pp=i.aH(pr,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),$u=i.aH(pr,["setCenter","setZoom","setBearing","setPitch"]),qu=new Set(["background","sky","slot","custom"]),eh={version:8,layers:[],sources:{}},uu={duration:300,delay:0};class xa extends i.E{constructor(e,a={}){super(),this.map=e,this.scope=a.scope||"",this.globalId=null,this.fragments=[],this.importDepth=a.importDepth||0,this.importsCache=a.importsCache||new Map,this.resolvedImports=a.resolvedImports||new Set,this.transition=Object.assign({},uu),this._buildingIndex=new ra(this),this.crossTileSymbolIndex=new Mc,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=a.styleChanges||new ns,this.dispatcher=a.dispatcher?a.dispatcher:new i.D(i.dg(),this),a.imageManager?this.imageManager=a.imageManager:(this.imageManager=new lo(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=a.glyphManager?a.glyphManager:new i.dh(e._requestManager,a.localFontFamily?i.di.all:a.localIdeographFontFamily?i.di.ideographs:i.di.none,a.localFontFamily||a.localIdeographFontFamily),a.modelManager?this.modelManager=a.modelManager:(this.modelManager=new Qn(e._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=a.configOptions?a.configOptions:new Map,this._configDependentLayers=a.configDependentLayers?a.configDependentLayers:new Set,this._indoorDependentLayers=a.indoorDependentLayers?a.indoorDependentLayers:new Set,this._config=a.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:a.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=a.initialConfig,this.dispatcher.broadcast("setReferrer",i.dj());const f=this;this._rtlTextPluginCallback=xa.registerForPluginStateChange(y=>{f.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:y.pluginStatus,pluginURL:y.pluginURL},(w,I)=>{if(i.dk(w),I&&I.every(M=>M))for(const M in f._sourceCaches){const L=f._sourceCaches[M],N=L.getSource().type;N!=="vector"&&N!=="geojson"||L.reload()}})}),this.on("data",y=>{if(y.dataType!=="source"||y.sourceDataType!=="metadata")return;const w=this.getOwnSource(y.sourceId);if(w&&w.vectorLayerIds)for(const I in this._layers){const M=this._layers[I];M.source===w.id&&this._validateLayer(M)}})}load(e){return e?(typeof e=="string"?this.loadURL(e):this.loadJSON(e),this):this}_getGlobalId(e){if(!e)return null;if(typeof e=="string"){if(i.h(e))return e;const a=i.dl(e);if(!a.startsWith("http"))try{return new URL(a,location.href).toString()}catch{return a}return a}return`json://${i.dm(JSON.stringify(e))}`}_diffStyle(e,a,f){this.globalId=this._getGlobalId(e);const y=(w,I)=>{try{I(null,this.setState(w,f))}catch(M){I(M,!1)}};if(typeof e=="string"){const w=this.map._requestManager.normalizeStyleURL(e),I=this.map._requestManager.transformRequest(w,i.R.Style);i.m(I,(M,L)=>{M?this.fire(new i.y(M)):L&&y(L,a)})}else typeof e=="object"&&y(e,a)}loadURL(e,a={}){this.fire(new i.z("dataloading",{dataType:"style"}));const f=typeof a.validate=="boolean"?a.validate:!i.h(e);this.globalId=this._getGlobalId(e),e=this.map._requestManager.normalizeStyleURL(e,a.accessToken),this.resolvedImports.add(e);const y=this.importsCache.get(e);if(y)return this._load(y,f);const w=this.map._requestManager.transformRequest(e,i.R.Style);this._request=i.m(w,(I,M)=>{if(this._request=null,I)this.fire(new i.y(I));else if(M)return this.importsCache.set(e,M),this._load(M,f)})}loadJSON(e,a={}){this.fire(new i.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(e),this._request=i.o.frame(()=>{this._request=null,this._load(e,a.validate!==!1)})}loadEmpty(){this.fire(new i.z("dataloading",{dataType:"style"})),this._load(eh,!1)}_loadImports(e,a,f){if(this.importDepth>=4)return i.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const y=[];for(const w of e){const I=this._createFragmentStyle(w),M=new Promise(V=>{I.once("style.import.load",V),I.once("error",V)}).then(()=>this.mergeAll());if(y.push(M),this.resolvedImports.has(w.url)){I.loadEmpty();continue}const L=w.data||this.importsCache.get(w.url);L?(I.loadJSON(L,{validate:a}),this._isInternalStyle(L)&&(I.globalId=null)):w.url?I.loadURL(w.url,{validate:a}):I.loadEmpty();const N={style:I,id:w.id,config:w.config};if(f){const V=this.fragments.findIndex(({id:Z})=>Z===f);this.fragments=this.fragments.slice(0,V).concat(N).concat(this.fragments.slice(V))}else this.fragments.push(N)}return Promise.allSettled(y)}getImportGlobalIds(e=this,a=new Set){for(const f of e.fragments)f.style.globalId&&a.add(f.style.globalId),this.getImportGlobalIds(f.style,a);return[...a.values()]}_createFragmentStyle(e){const a=this.scope?i.B(e.id,this.scope):e.id;let f;const y=this._initialConfig&&this._initialConfig[a];(e.config||y)&&(f=Object.assign({},e.config,y));const w=new xa(this.map,{scope:a,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:f,configOptions:this.options,colorThemeOverride:e["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return w.setEventedParent(this.map,{style:w}),w}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(e){return this.isRootStyle()&&(e.fragment||!!e.schema&&e.fragment!==!1)}_load(e,a){if(this._isInternalStyle(e)){const w=Object.assign({},eh,{imports:[{id:"basemap",data:e,url:""}]},e.center?{center:e.center}:{},e.bearing?{bearing:e.bearing}:{},e.pitch?{pitch:e.pitch}:{},e.zoom?{zoom:e.zoom}:{},e.light?{light:e.light}:{});return this._importedAsBasemap=!0,void this._load(w,a)}if(this.updateConfig(this._config,e.schema),a&&uc(this,We(e)))return;this._loaded=!0,this.stylesheet=i.dn(e);const f=()=>{for(const L in e.sources)this.addSource(L,e.sources[L],{validate:!1,isInitialLoad:!0});if(e.iconsets)for(const L in e.iconsets)this.addIconset(L,e.iconsets[L]);e.sprite?this._loadIconset(e.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&e.glyphs&&this.glyphManager.setURL(e.glyphs);const w=Pl(this.stylesheet.layers);if(this._order=w.map(L=>L.id),this.stylesheet.light&&i.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const L=this.stylesheet.lights[0];this.light=new Nt(L.properties,L.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Nt(this.stylesheet.light)),this._layers={};for(const L of w){const N=i.dt(L,this.scope,this._styleColorTheme.lut,this.options);N.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(N.fqid),N.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(N.fqid),this._hasAppearances=this._hasAppearances||N.getAppearances().length!==0,N.setEventedParent(this,{layer:{id:N.id}}),this._layers[N.id]=N;const V=this.getOwnLayerSourceCache(N),Z=!!this.directionalLight&&this.directionalLight.shadowsEnabled();V&&N.canCastShadows()&&Z&&(V.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const I=this.stylesheet.terrain;I&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(I,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new i.z("data",{dataType:"style"}));const M=this.isRootStyle();e.imports?this._loadImports(e.imports,a).then(()=>{this._reloadImports(),this.fire(new i.z(M?"style.load":"style.import.load"))}).catch(L=>{this.fire(new i.y(new Error("Failed to load imports",L))),this.fire(new i.z(M?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new i.z(M?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const y=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(y){const w=this._evaluateColorThemeData(y);this._loadColorTheme(w).then(()=>{f()}).catch(I=>{i.w(`Couldn't load color theme from the stylesheet: ${I}`),f()})}else this._styleColorTheme.lut=null,f()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances}mergeAll(){let e,a,f,y,w,I,M,L,N,V;const Z={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(U=>{if(U.stylesheet){if(U.light!=null&&(e=U.light),U.stylesheet.lights)for(const X of U.stylesheet.lights)X.type==="ambient"&&U.ambientLight!=null&&(a=U.ambientLight),X.type==="directional"&&U.directionalLight!=null&&(f=U.directionalLight);y=this._prioritizeTerrain(y,U.terrain,U.stylesheet.terrain),U.stylesheet.fog&&U.fog!=null&&(w=U.fog),U.stylesheet.snow&&U.snow!=null&&(I=U.snow),U.stylesheet.rain&&U.rain!=null&&(M=U.rain),U.stylesheet.camera!=null&&(V=U.stylesheet.camera),U.stylesheet.projection!=null&&(L=U.stylesheet.projection),U.stylesheet.transition!=null&&(N=U.stylesheet.transition),Z[U.scope]=U._styleColorTheme}}),this.light=e,this.ambientLight=a,this.directionalLight=f,this.fog=w,this.snow=I,this.rain=M,this._styleColorThemeForScope=Z,y===null?delete this.terrain:this.terrain=y,this.camera=V||{"camera-projection":"perspective"},this.projection=L||{name:"mercator"},this.transition=Object.assign({},uu,N),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(e){const a=f=>{for(const y of f.fragments)a(y.style);e(f)};a(this)}_prioritizeTerrain(e,a,f){const y=e&&e.drapeRenderMode===0;return f===null?a&&a.drapeRenderMode===0?a:y?e:null:a!=null&&(!e||y||a&&a.drapeRenderMode===1)?a:e}mergeTerrain(){let e;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(a=>{e=this._prioritizeTerrain(e,a.terrain,a.stylesheet.terrain)}),e===null?delete this.terrain:this.terrain=e}mergeProjection(){let e;this.forEachFragmentStyle(a=>{a.stylesheet.projection!=null&&(e=a.stylesheet.projection)}),this.projection=e||{name:"mercator"}}mergeSources(){const e={},a={},f={};this.forEachFragmentStyle(y=>{for(const w in y._sourceCaches){const I=i.B(w,y.scope);e[I]=y._sourceCaches[w]}for(const w in y._otherSourceCaches){const I=i.B(w,y.scope);a[I]=y._otherSourceCaches[w]}for(const w in y._symbolSourceCaches){const I=i.B(w,y.scope);f[I]=y._symbolSourceCaches[w]}}),this._mergedSourceCaches=e,this._mergedOtherSourceCaches=a,this._mergedSymbolSourceCaches=f}mergeIndoor(){this.forEachFragmentStyle(e=>{if(e.stylesheet&&e.stylesheet.indoor)for(const a of Object.values(e.stylesheet.indoor)){const f=a,y=i.B(f.sourceId,e.scope);this._mergedIndoor[y]=new Set(f.sourceLayers||[])}})}mergeLayers(){const e={},a=[],f={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(I=>{for(const M of I._order){const L=I._layers[M];if(L.type==="slot"){const N=i.dp(M);if(e[N])continue;e[N]=[]}L.slot&&e[L.slot]?e[L.slot].push(L):a.push(L)}}),this._mergedOrder=[];let y=-1;const w=(I=[])=>{for(const M of I)if(M.type==="slot"){const L=i.dp(M.id);e[L]&&w(e[L]),this._mergedSlots.push(L)}else{const L=i.B(M.id,M.scope);this._mergedOrder.push(L),f[L]=M,M.is3D(!!this.terrain)&&(this._has3DLayers=!0,y=this._mergedOrder.length-1),M.type==="circle"&&(this._hasCircleLayers=!0),M.type==="symbol"&&(this._hasSymbolLayers=!0),M.type==="clip"&&(this._clipLayerPresent=!0)}};if(w(a),this._has3DLayers){const I={};for(let M=0;M<this._mergedOrder.length;++M){const L=this._mergedOrder[M];I[L]=M===y?1:M<y?f[L].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort((M,L)=>I[M]-I[L])}this._mergedLayers=f,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(e){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,e),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(e){return e.data?function(a,f,y,w){const I=Object.assign({},f);for(const L of Object.keys(Md))I[L]===void 0&&(I[L]=Md[L].default);const M=new i.a8(Mh,a,new Map(y));return M.setTransitionOrValue(I,y),M.untransitioned().possiblyEvaluate(new i.ac(0,{worldview:void 0}))}(this.scope,e,this.options).get("data"):null}_loadColorTheme(e){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const a=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((f,y)=>{const w="data:image/png;base64,";if(!e||e.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void f();let I=e;I.startsWith(w)||(I=w+I);const M=i.I.from("mapbox-reserved-lut"),L=new Image;L.src=I,L.onerror=()=>{this._styleColorTheme.lutLoading=!1,y(new Error("Failed to load image data"))},L.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==a)return void f();this._styleColorTheme.lutLoading=!1;const{width:N,height:V,data:Z}=i.o.getImageData(L);if(V>32)return void y(new Error("The height of the image must be less than or equal to 32 pixels."));if(N!==V*V)return void y(new Error("The width of the image must be equal to the height squared."));this.getImage(M)&&this.removeImage(M),this.addImage(M,{data:new i.q({width:N,height:V},Z),pixelRatio:1,sdf:!1,usvg:!1,version:0});const U=this.imageManager.getImage(M,this.scope);U?(this._styleColorTheme.lut={image:U.data,data:e},f()):y(new Error("Missing LUT image."))}})}getLut(e){const a=this._styleColorThemeForScope[e];return a?a.lut:null}setProjection(e){e?this.stylesheet.projection=e:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(e){this._spriteRequest=function(a,f,y){let w,I,M;const L=i.o.devicePixelRatio>1?"@2x":"";let N=i.m(f.transformRequest(f.normalizeSpriteURL(a,L,".json"),i.R.SpriteJSON),(U,X)=>{N=null,M||(M=U,w=X,Z())}),V=i.n(f.transformRequest(f.normalizeSpriteURL(a,L,".png"),i.R.SpriteImage),(U,X)=>{V=null,M||(M=U,I=X,Z())});function Z(){if(M)y(M);else if(w&&I){const U=i.o.getImageData(I),X={};for(const Q in w){const{width:nt,height:ht,x:lt,y:_t,sdf:Ct,pixelRatio:bt,stretchX:Gt,stretchY:zt,content:Zt}=w[Q],Vt=new i.q({width:nt,height:ht});i.q.copy(U,Vt,{x:lt,y:_t},{x:0,y:0},{width:nt,height:ht},null),X[Q]={data:Vt,pixelRatio:bt!==void 0?bt:1,sdf:Ct!==void 0&&Ct,stretchX:Gt,stretchY:zt,content:Zt,usvg:!1,version:0}}y(null,X)}}return{cancel(){N&&(N.cancel(),N=null),V&&(V.cancel(),V=null)}}}(e,this.map._requestManager,(a,f)=>{if(this._spriteRequest=null,a)this.fire(new i.y(a));else if(f){const y=new Map;for(const w in f)y.set(i.I.from(w),f[w]);this.addImages(y)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.z("data",{dataType:"style"}))})}addIconset(e,a){if(a.type==="sprite")return void this._loadSprite(a.url);const f=this.getOwnSourceCache(a.source);if(!f)return void this.fire(new i.y(new Error(`Source "${a.source}" as specified by iconset "${e}" does not exist and cannot be used as an iconset source`)));const y=f.getSource();if(y.type!=="raster-array")return void this.fire(new i.y(new Error(`Source "${a.source}" as specified by iconset "${e}" is not a "raster-array" source and cannot be used as an iconset source`)));y.partial=!1;const w=new Gf(e,this.scope,f);this.imageManager.addImageProvider(w,this.scope)}removeIconset(e){this.imageManager.removeImageProvider(e,this.scope)}_loadIconset(e){if(!i.h(e)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(e);const a=this.map._spriteFormat==="auto";var f,y;this._spriteRequest=(y=(w,I)=>{if(this._spriteRequest=null,w)a?this._loadSprite(e):this.fire(new i.y(w));else if(I){const M=new Map;for(const L in I)M.set(i.I.from(L),I[L]);this.addImages(M)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.z("data",{dataType:"style"}))},i.bt((f=this.map._requestManager).transformRequest(f.normalizeIconsetURL(e),i.R.Iconset),(w,I)=>{if(w)return void y(w);const M={},L=i.df(new i.bs(I));for(const N of L.icons){const V={version:1,pixelRatio:i.o.devicePixelRatio,content:Uf(N),stretchX:N.metadata?jf(N.metadata.stretch_x_areas):void 0,stretchY:N.metadata?jf(N.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:N};M[N.name]=V}y(null,M)}))}_validateLayer(e){const a=this.getOwnSource(e.source);if(!a)return;const f=e.sourceLayer;f&&(a.type==="geojson"||a.vectorLayerIds&&a.vectorLayerIds.indexOf(f)===-1)&&this.fire(new i.y(new Error(`Source layer "${f}" does not exist on source "${a.id}" as specified by style layer "${e.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const e in this._sourceCaches)if(!this._sourceCaches[e].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:e}of this.fragments)if(!e.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((e,a)=>{const f=this.fragments[a];return f&&f.style&&(e.data=f.style.serialize()),e})}_serializeSources(){const e={};for(const a in this._sourceCaches){const f=this._sourceCaches[a].getSource();e[f.id]||(e[f.id]=f.serialize())}return e}_serializeLayers(e){const a=[];for(const f of e){const y=this._layers[f];y&&y.type!=="custom"&&a.push(y.serialize())}return a}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const e in this._sourceCaches)if(this._sourceCaches[e].hasTransition())return!0;for(const e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(e){return e?this.order:this._mergedOrder}isLayerDraped(e){return!!this.terrain&&e.isDraped(this.getLayerSourceCache(e))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(e){const a=this.getOwnLayer(e);if(a)return a;this.fire(new i.y(new Error(`The layer '${e}' does not exist in the map's style.`)))}_checkSource(e){const a=this.getOwnSource(e);if(a)return a;this.fire(new i.y(new Error(`The source '${e}' does not exist in the map's style.`)))}precompilePrograms(e,a){const f=this.map.painter;if(f)for(let y=e.minzoom||0;y<(e.maxzoom||25.5);y++){const w=e.getProgramIds();if(w)for(const I of w){const M=e.getDefaultProgramParams(I,a.zoom,this._styleColorTheme.lut);M&&(f.style=this,this.fog&&(f._fogVisible=!0,M.overrideFog=!0,f.getOrCreateProgram(I,M)),f._fogVisible=!1,M.overrideFog=!1,f.getOrCreateProgram(I,M),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(M.overrideRtt=!0,f.getOrCreateProgram(I,M)))}}}update(e){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(e),this.directionalLight&&this.directionalLight.recalculate(e);const a=this.calculateLightsBrightness();e.brightness=a||0,a!==this._brightness&&(this._brightness=a,this.dispatcher.broadcast("setBrightness",a)),e.worldview!==this._worldview&&(this._worldview=e.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const f=this._changes.isDirty();let y=!1;if(this._changes.isDirty()){const M=this._changes.getLayerUpdatesByScope();for(const L in M){const{updatedIds:N,removedIds:V}=M[L];(N||V)&&(this._updateWorkerLayers(L,N,V),y=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(e),this.light&&this.light.updateTransitions(e),this.ambientLight&&this.ambientLight.updateTransitions(e),this.directionalLight&&this.directionalLight.updateTransitions(e),this.fog&&this.fog.updateTransitions(e),this.snow&&this.snow.updateTransitions(e),this.rain&&this.rain.updateTransitions(e),this._changes.reset()}const w={};for(const M in this._mergedSourceCaches){const L=this._mergedSourceCaches[M];w[M]=L.used,L.used=!1,L.tileCoverLift=0}for(const M of this._mergedOrder){const L=this._mergedLayers[M];if(L.recalculate(e,this._availableImages),!L.isHidden(e.zoom)){const N=this.getLayerSourceCache(L);N&&(N.used=!0,N.tileCoverLift=Math.max(N.tileCoverLift,L.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(L,e)}):this.precompilePrograms(L,e))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&y&&this.mergeLayers();const I=this.imageManager.getPendingImageProviders();for(const M of I)M.sourceCache.used=!0;for(const M in w){const L=this._mergedSourceCaches[M];w[M]!==L.used&&L.getSource().fire(new i.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:L.getSource().id}))}this.light&&this.light.recalculate(e),this.terrain&&this.terrain.recalculate(e),this.fog&&this.fog.recalculate(e),this.snow&&this.snow.recalculate(e),this.rain&&this.rain.recalculate(e),this.z=e.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),f&&this.fire(new i.z("data",{dataType:"style"}))}updateImageProviders(){const e=this.imageManager.getPendingImageProviders();for(const a of e){const f=a.resolvePendingRequests(),y=this.getFragmentStyle(a.scope);y&&y.addImages(f)}}_updateTilesForChangedImages(){const e={};for(const a in this._mergedSourceCaches){const f=this._mergedSourceCaches[a].getSource().scope;e[f]=e[f]||this._changes.getUpdatedImages(f),e[f].length!==0&&this._mergedSourceCaches[a].reloadTilesForDependencies(["icons","patterns"],e[f])}for(const a in e)this._changes.resetUpdatedImages(a)}_updateWorkerLayers(e,a,f){const y=this.getFragmentStyle(e);y&&this.dispatcher.broadcast("updateLayers",{layers:a?y._serializeLayers(a):[],scope:e,removedIds:f||[],options:y.options})}setState(e,a){if(this._checkLoaded(),uc(this,We(e)))return!1;(e=i.dn(e)).layers=Pl(e.layers);const f=function(I,M){if(!I)return[{command:pr.setStyle,args:[M]}];let L=[];try{if(!i.bx(I.version,M.version))return[{command:pr.setStyle,args:[M]}];if(i.bx(I.center,M.center)||L.push({command:pr.setCenter,args:[M.center]}),i.bx(I.zoom,M.zoom)||L.push({command:pr.setZoom,args:[M.zoom]}),i.bx(I.bearing,M.bearing)||L.push({command:pr.setBearing,args:[M.bearing]}),i.bx(I.pitch,M.pitch)||L.push({command:pr.setPitch,args:[M.pitch]}),i.bx(I.sprite,M.sprite)||L.push({command:pr.setSprite,args:[M.sprite]}),i.bx(I.glyphs,M.glyphs)||L.push({command:pr.setGlyphs,args:[M.glyphs]}),i.bx(I.imports,M.imports)||function(X=[],Q=[],nt){Q=Q||[];const ht=(X=X||[]).map(sl),lt=Q.map(sl),_t=X.reduce(Rn,{}),Ct=Q.reduce(Rn,{}),bt=ht.slice();let Gt,zt,Zt,Vt;for(Gt=0,zt=0;Gt<ht.length;Gt++)Zt=ht[Gt],Ct.hasOwnProperty(Zt)?zt++:(nt.push({command:pr.removeImport,args:[Zt]}),bt.splice(bt.indexOf(Zt,zt),1));for(Gt=0,zt=0;Gt<lt.length;Gt++)Zt=lt[lt.length-1-Gt],bt[bt.length-1-Gt]!==Zt&&(_t.hasOwnProperty(Zt)?(nt.push({command:pr.removeImport,args:[Zt]}),bt.splice(bt.lastIndexOf(Zt,bt.length-zt),1)):zt++,Vt=bt[bt.length-Gt],nt.push({command:pr.addImport,args:[Ct[Zt],Vt]}),bt.splice(bt.length-Gt,0,Zt));for(const kt of Q){const Ht=_t[kt.id];Ht&&(delete Ht.data,i.bx(Ht,kt)||nt.push({command:pr.updateImport,args:[kt.id,kt]}))}}(I.imports,M.imports,L),i.bx(I.transition,M.transition)||L.push({command:pr.setTransition,args:[M.transition]}),i.bx(I.light,M.light)||L.push({command:pr.setLight,args:[M.light]}),i.bx(I.fog,M.fog)||L.push({command:pr.setFog,args:[M.fog]}),i.bx(I.snow,M.snow)||L.push({command:pr.setSnow,args:[M.snow]}),i.bx(I.rain,M.rain)||L.push({command:pr.setRain,args:[M.rain]}),i.bx(I.projection,M.projection)||L.push({command:pr.setProjection,args:[M.projection]}),i.bx(I.lights,M.lights)||L.push({command:pr.setLights,args:[M.lights]}),i.bx(I.camera,M.camera)||L.push({command:pr.setCamera,args:[M.camera]}),i.bx(I.iconsets,M.iconsets)||function(X,Q,nt){let ht;for(ht in Q=Q||{},X=X||{})X.hasOwnProperty(ht)&&(Q.hasOwnProperty(ht)||nt.push({command:pr.removeIconset,args:[ht]}));for(ht in Q){if(!Q.hasOwnProperty(ht))continue;const lt=Q[ht];X.hasOwnProperty(ht)?i.bx(X[ht],lt)||(nt.push({command:pr.removeIconset,args:[ht]}),nt.push({command:pr.addIconset,args:[ht,lt]})):nt.push({command:pr.addIconset,args:[ht,lt]})}}(I.iconsets,M.iconsets,L),!i.bx(I["color-theme"],M["color-theme"]))return[{command:pr.setStyle,args:[M]}];const N={},V=[];(function(X,Q,nt,ht){let lt;for(lt in Q=Q||{},X=X||{})X.hasOwnProperty(lt)&&(Q.hasOwnProperty(lt)||Zl(lt,nt,ht));for(lt in Q){if(!Q.hasOwnProperty(lt))continue;const _t=Q[lt];X.hasOwnProperty(lt)?i.bx(X[lt],_t)||(X[lt].type==="geojson"&&_t.type==="geojson"&&Ca(X,Q,lt)?nt.push({command:pr.setGeoJSONSourceData,args:[lt,_t.data]}):Wc(lt,Q,nt,ht)):Sh(lt,Q,nt)}})(I.sources,M.sources,V,N);const Z=[];I.layers&&I.layers.forEach(X=>{X.source&&N[X.source]?L.push({command:pr.removeLayer,args:[X.id]}):Z.push(X)});let U=I.terrain;U&&N[U.source]&&(L.push({command:pr.setTerrain,args:[void 0]}),U=void 0),L=L.concat(V),i.bx(U,M.terrain)||L.push({command:pr.setTerrain,args:[M.terrain]}),function(X,Q,nt){Q=Q||[];const ht=(X=X||[]).map(sl),lt=Q.map(sl),_t=X.reduce(Rn,{}),Ct=Q.reduce(Rn,{}),bt=ht.slice(),Gt=Object.create(null);let zt,Zt,Vt,kt,Ht,pe,ae;for(zt=0,Zt=0;zt<ht.length;zt++)Vt=ht[zt],Ct.hasOwnProperty(Vt)?Zt++:(nt.push({command:pr.removeLayer,args:[Vt]}),bt.splice(bt.indexOf(Vt,Zt),1));for(zt=0,Zt=0;zt<lt.length;zt++)Vt=lt[lt.length-1-zt],bt[bt.length-1-zt]!==Vt&&(_t.hasOwnProperty(Vt)?(nt.push({command:pr.removeLayer,args:[Vt]}),bt.splice(bt.lastIndexOf(Vt,bt.length-Zt),1)):Zt++,pe=bt[bt.length-zt],nt.push({command:pr.addLayer,args:[Ct[Vt],pe]}),bt.splice(bt.length-zt,0,Vt),Gt[Vt]=!0);for(zt=0;zt<lt.length;zt++)if(Vt=lt[zt],kt=_t[Vt],Ht=Ct[Vt],!Gt[Vt]&&!i.bx(kt,Ht))if(i.bx(kt.source,Ht.source)&&i.bx(kt["source-layer"],Ht["source-layer"])&&i.bx(kt.type,Ht.type)){for(ae in Eo(kt.layout,Ht.layout,nt,Vt,null,pr.setLayoutProperty),Eo(kt.paint,Ht.paint,nt,Vt,null,pr.setPaintProperty),i.bx(kt.slot,Ht.slot)||nt.push({command:pr.setSlot,args:[Vt,Ht.slot]}),i.bx(kt.filter,Ht.filter)||nt.push({command:pr.setFilter,args:[Vt,Ht.filter]}),i.bx(kt.minzoom,Ht.minzoom)&&i.bx(kt.maxzoom,Ht.maxzoom)||nt.push({command:pr.setLayerZoomRange,args:[Vt,Ht.minzoom,Ht.maxzoom]}),kt)kt.hasOwnProperty(ae)&&ae!=="layout"&&ae!=="paint"&&ae!=="filter"&&ae!=="metadata"&&ae!=="minzoom"&&ae!=="maxzoom"&&ae!=="slot"&&(ae.indexOf("paint.")===0?Eo(kt[ae],Ht[ae],nt,Vt,ae.slice(6),pr.setPaintProperty):i.bx(kt[ae],Ht[ae])||nt.push({command:pr.setLayerProperty,args:[Vt,ae,Ht[ae]]}));for(ae in Ht)Ht.hasOwnProperty(ae)&&!kt.hasOwnProperty(ae)&&ae!=="layout"&&ae!=="paint"&&ae!=="filter"&&ae!=="metadata"&&ae!=="minzoom"&&ae!=="maxzoom"&&ae!=="slot"&&(ae.indexOf("paint.")===0?Eo(kt[ae],Ht[ae],nt,Vt,ae.slice(6),pr.setPaintProperty):i.bx(kt[ae],Ht[ae])||nt.push({command:pr.setLayerProperty,args:[Vt,ae,Ht[ae]]}))}else nt.push({command:pr.removeLayer,args:[Vt]}),pe=bt[bt.lastIndexOf(Vt)+1],nt.push({command:pr.addLayer,args:[Ht,pe]})}(Z,M.layers,L)}catch(N){console.warn("Unable to compute style diff:",N),L=[{command:pr.setStyle,args:[M]}]}return L}(this.serialize(),e).filter(I=>!(I.command in $u));if(f.length===0)return!1;const y=f.filter(I=>!(I.command in pp));if(y.length>0)throw new Error(`Unimplemented: ${y.map(I=>I.command).join(", ")}.`);const w=[];return f.forEach(I=>{w.push(this[I.command](...I.args))}),a&&Promise.all(w).then(a).catch(a),this.stylesheet=e,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(e){if(e.size===0)return this;for(const[a,f]of e.entries()){if(this.getImage(a))return this.fire(new i.y(new Error(`An image with the name "${a.name}" already exists.`)));this.imageManager.addImage(a,this.scope,f),this._changes.updateImage(a,this.scope)}return this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this}addImage(e,a){return this.getImage(e)?this.fire(new i.y(new Error(`An image with the name "${e.name}" already exists.`))):(this.imageManager.addImage(e,this.scope,a),this._changes.updateImage(e,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this)}updateImage(e,a,f=!1){this.imageManager.updateImage(e,this.scope,a),f&&(this._changes.updateImage(e,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})))}getImage(e){return this.imageManager.getImage(e,this.scope)}removeImage(e){return this.getImage(e)?(this.imageManager.removeImage(e,this.scope),this._changes.updateImage(e,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this):this.fire(new i.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(e){return this.modelManager.addModelURLs(e,this.scope),this._updateWorkerModels(),this.fire(new i.z("data",{dataType:"style"})),this}addModel(e,a,f={}){return this._checkLoaded(),this._validate(wo,`models.${e}`,a,null,f)||(this.modelManager.addModel(e,a,this.scope),this.fire(new i.z("data",{dataType:"style"}))),this}hasModel(e){return this.modelManager.hasModel(e,this.scope)}removeModel(e){return this.hasModel(e)?(this.modelManager.removeModel(e,this.scope,!1,!0),this.fire(new i.z("data",{dataType:"style"})),this):this.fire(new i.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(e,a,f={}){if(this._checkLoaded(),this.getOwnSource(e)!==void 0)throw new Error(`There is already a source with ID "${e}".`);if(!a.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(a).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(a.type)>=0&&this._validate(ci,`sources.${e}`,a,null,f))return;this.map&&this.map._collectResourceTiming&&(a.collectResourceTiming=!0);const y=_a(e,a,this.dispatcher,this);y.scope=this.scope,y.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(y.id),source:y.serialize(),sourceId:y.id}));const w=I=>{const M=(I?"symbol:":"other:")+y.id,L=i.B(M,this.scope),N=this._sourceCaches[M]=new On(L,y,I);(I?this._symbolSourceCaches:this._otherSourceCaches)[y.id]=N,N.onAdd(this.map)};w(!1),a.type!=="vector"&&a.type!=="geojson"||w(!0),y.onAdd&&y.onAdd(this.map),f.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(e){this._checkLoaded();const a=this.getOwnSource(e);if(!a)throw new Error("There is no source with this ID");for(const y in this._layers)if(this._layers[y].source===e)return this.fire(new i.y(new Error(`Source "${e}" cannot be removed while layer "${y}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===e)return this.fire(new i.y(new Error(`Source "${e}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const y=Object.entries(this.stylesheet.iconsets).find(([w,I])=>I.type==="source"&&I.source===e);if(y)return this.fire(new i.y(new Error(`Source "${e}" cannot be removed while iconset "${y[0]}" is using it.`)))}const f=this.getOwnSourceCaches(e);for(const y of f){const w=i.dp(y.id);delete this._sourceCaches[w],this._changes.discardSourceCacheUpdate(y.id),y.fire(new i.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:y.getSource().id})),y.setEventedParent(null),y.clearTiles()}return delete this._otherSourceCaches[e],delete this._symbolSourceCaches[e],this.mergeSources(),a.setEventedParent(null),a.onRemove&&a.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(e,a){this._checkLoaded(),this.getOwnSource(e).setData(a),this._changes.setDirty()}getOwnSource(e){const a=this.getOwnSourceCache(e);return a&&a.getSource()}getOwnSources(){const e=[];for(const a in this._otherSourceCaches){const f=this.getOwnSourceCache(a);f&&e.push(f.getSource())}return e}areTilesLoaded(){const e=this._mergedSourceCaches;for(const a in e){const f=e[a]._tiles;for(const y in f){const w=f[y];if(w.state!=="loaded"&&w.state!=="errored")return!1}}return!0}setLights(e){if(this._checkLoaded(),!e)return delete this.ambientLight,void delete this.directionalLight;const a=this._getTransitionParameters();for(const w of e){if(this._validate(or,"lights",w))return;switch(w.type){case"ambient":if(this.ambientLight){const I=this.ambientLight;I.set(w),I.updateTransitions(a)}else this.ambientLight=new Wn(w,wn||(wn=new i.a9({color:new i.aa(i.a6.properties_light_ambient.color),"color-use-theme":new i.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.aa(i.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const I=this.directionalLight;I.set(w),I.updateTransitions(a)}else this.directionalLight=new Wn(w,Pn||(Pn=new i.a9({direction:new i.ap(i.a6.properties_light_directional.direction),color:new i.aa(i.a6.properties_light_directional.color),"color-use-theme":new i.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.aa(i.a6.properties_light_directional.intensity),"cast-shadows":new i.aa(i.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new i.aa(i.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new i.aa(i.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const f=Object.assign(a,{worldview:this.map.getWorldview()}),y=new i.ac(this.z||0,f);this.ambientLight&&this.ambientLight.recalculate(y),this.directionalLight&&this.directionalLight.recalculate(y),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const e=this.directionalLight,a=this.ambientLight;if(!e||!a)return;const f=U=>.2126*(U[0]<=.03928?U[0]/12.92:Math.pow((U[0]+.055)/1.055,2.4))+.7152*(U[1]<=.03928?U[1]/12.92:Math.pow((U[1]+.055)/1.055,2.4))+.0722*(U[2]<=.03928?U[2]/12.92:Math.pow((U[2]+.055)/1.055,2.4)),y=e.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),w=e.properties.get("intensity"),I=e.properties.get("direction"),M=1-i.d3(I.x,I.y,I.z)[2]/90,L=f(y)*w*M,N=a.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),V=a.properties.get("intensity"),Z=f(N)*V;return Number(((L+Z)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const e=[];return this.directionalLight&&e.push(this.directionalLight.get()),this.ambientLight&&e.push(this.ambientLight.get()),e}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(e){if(e==null||e===""&&this.isRootStyle())return this;if(i.dq(e)){const a=i.dr(e),f=this.fragments.find(({id:w})=>w===a);if(!f)return;const y=i.dp(e);return f.style.getFragmentStyle(y)}{const a=this.fragments.find(({id:f})=>f===e);return a?a.style:void 0}}setFeaturesetSelectors(e){if(!e)return;const a={},f=(y,w="")=>`${y}::${w}`;this._featuresetSelectors={};for(const y in e){const w=this._featuresetSelectors[y]=[];for(const I of e[y].selectors){if(I.featureNamespace){const L=this.getOwnLayer(I.layer);if(!L){i.w(`Layer is undefined for selector: ${I.layer}`);continue}const N=f(L.source,L.sourceLayer);if(N in a&&a[N]!==I.featureNamespace){i.w(`"featureNamespace ${I.featureNamespace} of featureset ${y}'s selector is not associated to the same source, skip this selector`);continue}a[N]=I.featureNamespace}let M;if(I.properties)for(const L in I.properties){const N=i.U(I.properties[L]);N.result==="success"&&(M=M||{},M[L]=N.value)}w.push({layerId:I.layer,namespace:I.featureNamespace,properties:M,uniqueFeatureID:I._uniqueFeatureID})}}}getFeaturesetDescriptors(e){const a=this.getFragmentStyle(e);if(!a||!a.stylesheet.featuresets)return[];const f=[];for(const y in a.stylesheet.featuresets)f.push({featuresetId:y,importId:a.scope?a.scope:void 0});return f}getFeaturesetLayers(e,a){const f=this.getFragmentStyle(a),y=f.stylesheet.featuresets;if(!y||!y[e])return this.fire(new i.y(new Error(`The featureset '${e}' does not exist in the map's style and cannot be queried.`))),[];const w=[];for(const I of y[e].selectors){const M=f.getOwnLayer(I.layer);M&&w.push(M)}return w}getConfigProperty(e,a){const f=this.getFragmentStyle(e);if(!f)return null;const y=i.B(a,f.scope),w=f.options.get(y),I=w?w.value||w.default:null;return I?I.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(e,a){const f=i.B(e,a);return this._mergedIndoor[f]}setIndoorData(e,a){this.map.indoor.setIndoorData(a)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(e,a,f){const y=this.getFragmentStyle(e);if(!y)return;const w=y.stylesheet.schema;if(!w||!w[a])return;const I=i.U(f);if(I.result!=="success")return void uc(this,I.value);const M=I.value.expression,L=i.B(a,y.scope),N=y.options.get(L);if(!N)return;let V;const{minValue:Z,maxValue:U,stepValue:X,type:Q,values:nt}=w[a],ht=i.U(w[a].default);ht.result==="success"&&(V=ht.value.expression),V?(this.options.set(L,Object.assign({},N,{value:M,default:V,minValue:Z,maxValue:U,stepValue:X,type:Q,values:nt})),this.updateConfigDependencies(a)):this.fire(new i.y(new Error(`No schema defined for the config option "${a}" in the "${e}" fragment.`)))}getConfig(e){const a=this.getFragmentStyle(e);if(!a)return null;const f=a.stylesheet.schema;if(!f)return null;const y={};for(const w in f){const I=i.B(w,a.scope),M=a.options.get(I),L=M?M.value||M.default:null;y[w]=L?L.serialize():null}return y}setConfig(e,a){const f=this.getFragmentStyle(e);f&&(f.updateConfig(a,f.stylesheet.schema),this.updateConfigDependencies())}getSchema(e){const a=this.getFragmentStyle(e);return a?a.stylesheet.schema:null}setSchema(e,a){const f=this.getFragmentStyle(e);f&&(f.stylesheet.schema=a,f.updateConfig(f._config,a),this.updateConfigDependencies())}updateConfig(e,a){if(this._config=e,e||a)if(a)for(const f in a){let y,w;const I=i.U(a[f].default);if(I.result==="success"&&(y=I.value.expression),e&&e[f]!==void 0){const U=i.U(e[f]);U.result==="success"&&(w=U.value.expression)}const{minValue:M,maxValue:L,stepValue:N,type:V,values:Z}=a[f];if(y){const U=i.B(f,this.scope);this.options.set(U,{default:y,value:w,minValue:M,maxValue:L,stepValue:N,type:V,values:Z})}else this.fire(new i.y(new Error(`No schema defined for config option "${f}".`)))}else this.fire(new i.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(e,a=()=>!0){for(const f of e){const y=this.getLayer(f);y&&a(y)&&(y.possiblyEvaluateVisibility(),this._updateLayer(y),this._changes.setDirty())}}updateConfigDependencies(e){this._updateLayers(this._configDependentLayers,a=>!e||a.expressionDependencies.configDependencies.has(e)),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(a=>{const f=a._styleColorTheme.colorThemeOverride?a._styleColorTheme.colorThemeOverride:a._styleColorTheme.colorTheme;if(f){const y=a._evaluateColorThemeData(f);(!a._styleColorTheme.lut&&y!==""||a._styleColorTheme.lut&&y!==a._styleColorTheme.lut.data)&&a.setColorTheme(f)}}),this._changes.setDirty()}addLayer(e,a,f={}){this._checkLoaded();const y=e.id;if(this._layers[y])return void this.fire(new i.y(new Error(`Layer with id "${y}" already exists on this map`)));let w;if(e.type==="custom"){if(uc(this,i.ds(e)))return;w=i.dt(e,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof e.source=="object"&&(this.addSource(y,e.source),e=i.dn(e),e=Object.assign(e,{source:y})),this._validate(Un,`layers.${y}`,e,{arrayIndex:-1},f))return;w=i.dt(e,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(w),w.setEventedParent(this,{layer:{id:y}})}const I=i.B(w.source,w.scope);w.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(I),w.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(I);let M=this._order.length;if(a){const Z=this._order.indexOf(a);if(Z===-1)return void this.fire(new i.y(new Error(`Layer with id "${a}" does not exist on this map.`)));w.slot===this._layers[a].slot?M=Z:i.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(M,0,y),this._layerOrderChanged=!0,this._layers[y]=w;const L=this.getOwnLayerSourceCache(w),N=!!this.directionalLight&&this.directionalLight.shadowsEnabled();L&&w.canCastShadows()&&N&&(L.castsShadows=!0);const V=this._changes.getRemovedLayer(w);if(V&&w.source&&L&&w.type!=="custom"){this._changes.discardLayerRemoval(w);const Z=i.B(w.source,w.scope);V.type!==w.type?this._changes.updateSourceCache(Z,"clear"):(this._changes.updateSourceCache(Z,"reload"),L.pause())}this._updateLayer(w),w.onAdd&&w.onAdd(this.map),w.scope=this.scope,this.mergeLayers()}moveLayer(e,a){this._checkLoaded();const f=this._checkLayer(e);if(!f||e===a)return;const y=this._order.indexOf(e);this._order.splice(y,1);let w=this._order.length;if(a){const I=this._order.indexOf(a);if(I===-1)return void this.fire(new i.y(new Error(`Layer with id "${a}" does not exist on this map.`)));f.slot===this._layers[a].slot?w=I:i.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(w,0,e),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(e){this._checkLoaded();const a=this._checkLayer(e);if(!a)return;a.setEventedParent(null);const f=this._order.indexOf(e);this._order.splice(f,1),delete this._layers[e],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(a.fqid),this._indoorDependentLayers.delete(a.fqid),this._changes.removeLayer(a);const y=this.getOwnLayerSourceCache(a);if(y&&y.castsShadows){let w=!1;for(const I in this._layers)if(this._layers[I].source===a.source&&this._layers[I].canCastShadows()){w=!0;break}y.castsShadows=w}a.onRemove&&a.onRemove(this.map),this.mergeLayers()}getOwnLayer(e){return this._layers[e]}hasLayer(e){return e in this._mergedLayers}hasLayerType(e){for(const a in this._layers)if(this._layers[a].type===e)return!0;return!1}setLayerZoomRange(e,a,f){this._checkLoaded();const y=this._checkLayer(e);y&&(y.minzoom===a&&y.maxzoom===f||(a!=null&&(y.minzoom=a),f!=null&&(y.maxzoom=f),this._updateLayer(y)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(e,a){this._checkLoaded();const f=this._checkLayer(e);f&&f.slot!==a&&(f.slot=a,this._updateLayer(f))}setFilter(e,a,f={}){this._checkLoaded();const y=this._checkLayer(e);if(y&&!i.bx(y.filter,a))return a==null?(y.filter=void 0,void this._updateLayer(y)):void(this._validate(rr,`layers.${y.id}.filter`,a,{layerType:y.type},f)||(y.filter=i.dn(a),this._updateLayer(y)))}getFilter(e){const a=this._checkLayer(e);if(a)return i.dn(a.filter)}setLayoutProperty(e,a,f,y={}){this._checkLoaded();const w=this._checkLayer(e);if(w&&!i.bx(w.getLayoutProperty(a),f)){if(f!=null&&(!y||y.validate!==!1)&&uc(w,Bo.call(We,{key:`layers.${e}.layout.${a}`,layerType:w.type,objectKey:a,value:f,styleSpec:i.a6,style:{glyphs:!0,sprite:!0}})))return;w.setLayoutProperty(a,f),w.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(w.fqid),w.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(w.fqid),this._updateLayer(w)}}setLayerProperty(e,a,f,y={}){this._checkLoaded();const w=this._checkLayer(e);w&&(a==="appearances"?(w.setAppearances(f),this._changes.setDirty()):w.isPaintProperty(a)?this.setPaintProperty(e,a,f,y):this.setLayoutProperty(e,a,f,y))}getLayoutProperty(e,a){const f=this._checkLayer(e);if(f)return f.getLayoutProperty(a)}setPaintProperty(e,a,f,y={}){this._checkLoaded();const w=this._checkLayer(e);if(!w||i.bx(w.getPaintProperty(a),f)||f!=null&&(!y||y.validate!==!1)&&uc(w,bi.call(We,{key:`layers.${e}.paint.${a}`,layerType:w.type,objectKey:a,value:f,styleSpec:i.a6})))return;const I=w.setPaintProperty(a,f);w.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(w.fqid),w.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(w.fqid),I&&this._updateLayer(w),this._changes.updatePaintProperties(w)}getPaintProperty(e,a){const f=this._checkLayer(e);if(f)return f.getPaintProperty(a)}setFeatureState(e,a){if(this._checkLoaded(),"target"in e){if("featuresetId"in e.target){const{featuresetId:L,importId:N}=e.target,V=this.getFragmentStyle(N),Z=V.getFeaturesetLayers(L);for(const{source:U,sourceLayer:X}of Z)V.setFeatureState({id:e.id,source:U,sourceLayer:X},a)}else if("layerId"in e.target){const{layerId:L}=e.target,N=this.getLayer(L);this.setFeatureState({id:e.id,source:N.source,sourceLayer:N.sourceLayer},a)}return}const f=e.source,y=e.sourceLayer,w=this._checkSource(f);if(!w)return;const I=w.type;if(I==="geojson"&&y)return void this.fire(new i.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(I==="vector"&&!y)return void this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")));e.id===void 0&&this.fire(new i.y(new Error("The feature id parameter must be provided.")));const M=this.getOwnSourceCaches(f);for(const L of M)L.setFeatureState(y,e.id,a)}removeFeatureState(e,a){if(this._checkLoaded(),"target"in e){if("featuresetId"in e.target){const{featuresetId:L,importId:N}=e.target,V=this.getFragmentStyle(N),Z=V.getFeaturesetLayers(L);for(const{source:U,sourceLayer:X}of Z)V.removeFeatureState({id:e.id,source:U,sourceLayer:X},a)}else if("layerId"in e.target){const{layerId:L}=e.target,N=this.getLayer(L);this.removeFeatureState({id:e.id,source:N.source,sourceLayer:N.sourceLayer},a)}return}const f=e.source,y=this._checkSource(f);if(!y)return;const w=y.type,I=w==="vector"?e.sourceLayer:void 0;if(w==="vector"&&!I)return void this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(a&&typeof e.id!="string"&&typeof e.id!="number")return void this.fire(new i.y(new Error("A feature id is required to remove its specific state property.")));const M=this.getOwnSourceCaches(f);for(const L of M)L.removeFeatureState(I,e.id,a)}getFeatureState(e){if(this._checkLoaded(),"target"in e){let w;if("featuresetId"in e.target){const{featuresetId:I,importId:M}=e.target,L=this.getFragmentStyle(M),N=L.getFeaturesetLayers(I);for(const{source:V,sourceLayer:Z}of N){const U=L.getFeatureState({id:e.id,source:V,sourceLayer:Z});if(U&&!w)w=U;else if(!i.bx(w,U))return void this.fire(new i.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in e.target){const{layerId:I}=e.target,M=this.getLayer(I);w=this.getFeatureState({id:e.id,source:M.source,sourceLayer:M.sourceLayer})}return w}const a=e.source,f=e.sourceLayer,y=this._checkSource(a);if(y){if(y.type!=="vector"||f)return e.id===void 0&&this.fire(new i.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(a)[0].getFeatureState(f,e.id);this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(e){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,e),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const e=this.getTerrain(),a=e&&this.terrain&&this.terrain.scope===this.scope?e:this.stylesheet.terrain;return i.du({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:a,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},f=>f!==void 0)}_updateFilteredLayers(e){for(const a of Object.values(this._mergedLayers))e(a)&&this._updateLayer(a)}_updateLayer(e){this._changes.updateLayer(e);const a=this.getLayerSourceCache(e),f=i.B(e.source,e.scope),y=this._changes.getUpdatedSourceCaches();e.source&&!y[f]&&a&&a.getSource().type!=="raster"&&(this._changes.updateSourceCache(f,"reload"),a.pause()),e.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(e){const a=M=>this._mergedLayers[M].is3D(!!this.terrain),f=this.order,y={},w=[];for(let M=f.length-1;M>=0;M--){const L=f[M];if(a(L)){y[L]=M;for(const N of e){const V=N[L];if(V)for(const Z of V)w.push(Z)}}}w.sort((M,L)=>L.intersectionZ-M.intersectionZ);const I=[];for(let M=f.length-1;M>=0;M--){const L=f[M];if(a(L))for(let N=w.length-1;N>=0;N--){const V=w[N].feature;if(V.layer&&y[V.layer.id]<M)break;I.push(V),w.pop()}else for(const N of e){const V=N[L];if(V)for(const Z of V)I.push(Z.feature)}}return I}queryRasterValue(e,a,f){const y=this.getOwnSource(e);return y?y.type!=="raster-array"?(this.fire(new i.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):y.queryRasterArrayValue(a,f):(this.fire(new i.y(new Error(`Source with id "${e}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(e,a,f){let y;a&&!Array.isArray(a)&&a.filter&&(this._validate(rr,"queryRenderedFeatures.filter",a.filter,null,a),y=i.b5(a.filter));const w={},I=V=>{if(qu.has(V.type))return;const Z=this.getOwnLayerSourceCache(V),U=w[Z.id]=w[Z.id]||{sourceCache:Z,layers:{},has3DLayers:!1};V.is3D(!!this.terrain)&&(U.has3DLayers=!0),U.layers[V.fqid]=U.layers[V.fqid]||{styleLayer:V,targets:[]},U.layers[V.fqid].targets.push({filter:y})};if(a&&a.layers){if(!Array.isArray(a.layers))return this.fire(new i.y(new Error("parameters.layers must be an Array."))),[];for(const V of a.layers){const Z=this._layers[V];if(!Z)return this.fire(new i.y(new Error(`The layer '${V}' does not exist in the map's style and cannot be queried for features.`))),[];I(Z)}}else for(const V in this._layers)I(this._layers[V]);const M=this._queryRenderedFeatures(e,w,f),L=this._flattenAndSortRenderedFeatures(M),N=[];for(const V of L)i.dv(V.layer.id)===this.scope&&N.push(V);return N}queryRenderedFeatureset(e,a,f){let y;a&&!Array.isArray(a)&&a.filter&&(this._validate(rr,"queryRenderedFeatures.filter",a.filter,null,a),y=i.b5(a.filter));const w="mock",I=[];if(a&&a.target)I.push(Object.assign({},a,{targetId:w,filter:y}));else{const V=this.getFeaturesetDescriptors();for(const Z of V)I.push({targetId:w,filter:y,target:Z});for(const{style:Z}of this.fragments){const U=Z.getFeaturesetDescriptors();for(const X of U)I.push({targetId:w,filter:y,target:X})}}const M=this.queryRenderedTargets(e,I,f),L=[],N=new Set;for(const V of M)for(const Z of V.variants[w])Pa(Z,V,N)||L.push(new i.dw(V,Z));return L}queryRenderedTargets(e,a,f){const y={},w=(M,L,N,V)=>{const Z=y[L.id]=y[L.id]||{sourceCache:L,layers:{},has3DLayers:!1};if(Z.layers[M.fqid]=Z.layers[M.fqid]||{styleLayer:M,targets:[]},M.is3D(!!this.terrain)&&(Z.has3DLayers=!0),!V)return N.uniqueFeatureID=!1,void Z.layers[M.fqid].targets.push(N);Z.layers[M.fqid].targets.push(Object.assign({},N,{namespace:V.namespace,properties:V.properties,uniqueFeatureID:V.uniqueFeatureID}))};for(const M of a)if("featuresetId"in M.target){const{featuresetId:L,importId:N}=M.target,V=this.getFragmentStyle(N);if(!V||!V._featuresetSelectors)continue;const Z=V._featuresetSelectors[L];if(!Z){this.fire(new i.y(new Error(`The featureset '${L}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const U of Z){const X=V.getOwnLayer(U.layerId);X&&!qu.has(X.type)&&w(X,V.getOwnLayerSourceCache(X),M,U)}}else if("layerId"in M.target){const{layerId:L}=M.target,N=this.getLayer(L);if(!N||qu.has(N.type))continue;w(N,this.getLayerSourceCache(N),M)}const I=this._queryRenderedFeatures(e,y,f);return this._flattenAndSortRenderedFeatures(I)}_queryRenderedFeatures(e,a,f){const y=[],w=!!this.map._showQueryGeometry,I=an.createFromScreenPoints(e,f);for(const M in a){const L=$a(I,a[M],this._availableImages,f,w);Object.keys(L).length&&y.push(L)}if(this.placement)for(const M in a){if(!a[M].sourceCache._onlySymbols)continue;const L=ql(I.screenGeometry,a[M],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(L).length&&y.push(L)}return y}querySourceFeatures(e,a){const f=a&&a.filter;f&&this._validate(rr,"querySourceFeatures.filter",f,null,a);let y=[];const w=this.getOwnSourceCaches(e);for(const I of w)y=y.concat(Th(I,a));return y}addSourceType(e,a,f){return xa.getSourceType(e)?f(new Error(`A source type called "${e}" already exists.`)):(xa.setSourceType(e,a),a.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:a.workerSourceURL},f):f(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(e,a,f={}){this._checkLoaded();const y=this.light.getLight();let w=!1;for(const M in e)if(!i.bx(e[M],y[M])){w=!0;break}if(!w)return;const I=this._getTransitionParameters();this.light.setLight(e,a,f),this.light.updateTransitions(I)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=i.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&i.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(e,a=1){if(this._checkLoaded(),!e)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),a===0&&delete this.terrain,e===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let f=e;const y=e.source==null;if(a===1){if(this.disableElevatedTerrain)return;if(typeof f.source=="object"){const M="terrain-dem-src";this.addSource(M,f.source),f=i.dn(f),f=Object.assign(f,{source:M})}const w=Object.assign({},f),I={};if(this.terrain&&y){w.source=this.terrain.get().source;const M=this.terrain?this.getFragmentStyle(this.terrain.scope):null;M&&(I.style=M.serialize())}if(this._validate(Ir,"terrain",w,I))return}if(!this.terrain||this.terrain.scope!==this.scope&&!y||this.terrain&&a!==this.terrain.drapeRenderMode){if(!f)return;this._createTerrain(f,a),this.fire(new i.z("data",{dataType:"style"}))}else{const w=this.terrain,I=w.get();for(const M of Object.keys(i.a6.terrain))!f.hasOwnProperty(M)&&i.a6.terrain[M].default&&(f[M]=i.a6.terrain[M].default);for(const M in e)if(!i.bx(e[M],I[M])){w.set(e,this.options),this.stylesheet.terrain=e;const L=this._getTransitionParameters({duration:0});w.updateTransitions(L),this.fire(new i.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(e){const a=this.fog=new qi(e,this.map.transform,this.scope,this.options);this.stylesheet.fog=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_createSnow(e){const a=this.snow=new zo(e,this.map.transform,this.scope,this.options);this.stylesheet.snow=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_createRain(e){const a=this.rain=new Gr(e,this.map.transform,this.scope,this.options);this.stylesheet.rain=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const e of this.map._markers)e._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(e){if(this._checkLoaded(),!e)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const a=this.fog;if(!i.bx(a.get(),e)){a.set(e,this.options),this.stylesheet.fog=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createFog(e);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(e){if(this._checkLoaded(),!e)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const a=this.snow;if(!i.bx(a.get(),e)){a.set(e,this.options),this.stylesheet.snow=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createSnow(e);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(e){if(this._checkLoaded(),!e)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const a=this.rain;if(!i.bx(a.get(),e)){a.set(e,this.options),this.stylesheet.rain=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createRain(e);this._markersNeedUpdate=!0}_reloadColorTheme(){const e=()=>{for(const y in this._layers)this._layers[y].lut=this._styleColorTheme.lut;for(const y in this._sourceCaches)this._sourceCaches[y].clearTiles()},a=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!a)return this._styleColorTheme.lut=null,void e();const f=this._evaluateColorThemeData(a);this._loadColorTheme(f).then(()=>{this.fire(new i.z("colorthemeset")),e()}).catch(y=>{i.w(`Couldn't set color theme: ${y}`)})}setColorTheme(e){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&i.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=e,this._reloadColorTheme()}setImportColorTheme(e,a){const f=this.getFragmentStyle(e);f&&(f._styleColorTheme.colorThemeOverride=a,f._reloadColorTheme())}_getTransitionParameters(e){return{now:i.o.now(),transition:Object.assign(this.transition,e)}}updateDrapeFirstLayers(){if(!this.terrain)return;const e=[],a=[];for(const f of this._mergedOrder)this.isLayerDraped(this._mergedLayers[f])?e.push(f):a.push(f);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...e),this._drapedFirstOrder.push(...a)}_createTerrain(e,a){const f=this.terrain=new oe(e,a,this.scope,this.options,this.map.getWorldview());a===1&&(this.stylesheet.terrain=e),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const y=this._getTransitionParameters({duration:0});f.updateTransitions(y)}_force3DLayerUpdate(){for(const e in this._layers){const a=this._layers[e];a.type==="fill-extrusion"&&this._updateLayer(a)}}_forceSymbolLayerUpdate(){for(const e in this._layers){const a=this._layers[e];a.type==="symbol"&&this._updateLayer(a)}}_validate(e,a,f,y,w={}){if(w&&w.validate===!1)return!1;const I=Object.assign({},this.serialize());return uc(this,e.call(We,Object.assign({key:a,style:I,value:f,styleSpec:i.a6},y)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),i.dx.off("pluginStateChange",this._rtlTextPluginCallback);for(const e in this._mergedLayers)this._mergedLayers[e].setEventedParent(null);for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles(),this._mergedSourceCaches[e].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(e){const a=this.getSourceCaches(e);for(const f of a)f.clearTiles()}clearSources(){for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles()}clearLayers(){for(const e in this._mergedLayers){const a=this._mergedLayers[e];a._clear&&a._clear()}}reloadSource(e){const a=this.getSourceCaches(e);for(const f of a)f.resume(),f.reload()}reloadSources(){for(const e of this.getSources())e.reload&&e.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(e=>{e.modelManager.reloadModels(e.scope)})}updateSources(e){let a;this.directionalLight&&(a=Ph(this.directionalLight));const f=new Set;for(const y in this._mergedLayers){const w=this._mergedLayers[y];w.hasElevation()&&!f.has(w.source)&&f.add(w.source)}for(const y in this._mergedSourceCaches){const w=this._mergedSourceCaches[y],I=f.has(w._source.id);w.update(e,void 0,void 0,a,I)}}_generateCollisionBoxes(){for(const e in this._sourceCaches){const a=this._sourceCaches[e];a.resume(),a.reload()}}_updatePlacement(e,a,f,y,w,I,M=!1){let L=!1,N=!1;const V={},Z={};for(const U of this._mergedOrder){const X=this._mergedLayers[U];if(X.type!=="symbol")continue;const Q=i.B(X.source,X.scope);let nt=V[Q];if(!nt){const lt=this.getLayerSourceCache(X);if(!lt)continue;const _t=lt.getRenderableIds(!0).map(Ct=>lt.getTileByID(Ct));Z[Q]=_t.slice(),nt=V[Q]=_t.sort((Ct,bt)=>bt.tileID.overscaledZ-Ct.tileID.overscaledZ||(Ct.tileID.isLessThan(bt.tileID)?-1:1))}const ht=this.crossTileSymbolIndex.addLayer(X,nt,a.center.lng,a.projection);L=L||ht}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),M=M||this._layerOrderChanged||y===0,this._layerOrderChanged&&this.fire(new i.z("neworder")),(M||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(i.o.now(),a.zoom))&&(this.pauseablePlacement=new za(a,this._mergedOrder,M,f,y,w,this.placement,this.fog&&a.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,V,Z,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(i.o.now()),N=!0),L&&this.pauseablePlacement.placement.setStale()),N||L){this._buildingIndex.onNewFrame(a.zoom);for(let U=0;U<this._mergedOrder.length;U++){const X=this._mergedLayers[this._mergedOrder[U]];if(X.type!=="symbol")continue;const Q=this.isLayerClipped(X);this.placement.updateLayerOpacities(X,V[i.B(X.source,X.scope)],U,Q?I:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(i.o.now())}}_releaseSymbolFadeTiles(){for(const e in this._sourceCaches)this._sourceCaches[e].releaseSymbolFadeTiles()}addImport(e,a){this._checkLoaded();const f=this.stylesheet.imports=this.stylesheet.imports||[];if(f.findIndex(({id:w})=>w===e.id)!==-1)return void this.fire(new i.y(new Error(`Import with id '${e.id}' already exists in the map's style.`)));if(!a)return f.push(e),this._loadImports([e],!0);const y=f.findIndex(({id:w})=>w===a);return y===-1&&this.fire(new i.y(new Error(`Import with id "${a}" does not exist on this map.`))),this.stylesheet.imports=f.slice(0,y).concat(e).concat(f.slice(y)),this._loadImports([e],!0,a)}updateImport(e,a){this._checkLoaded();const f=this.stylesheet.imports||[],y=this.getImportIndex(e);return y===-1?this:typeof a=="string"?(this.setImportUrl(e,a),this):(a.url&&a.url!==f[y].url&&this.setImportUrl(e,a.url),i.bx(a.config,f[y].config)||this.setImportConfig(e,a.config,a.data.schema),i.bx(a.data,f[y].data)||this.setImportData(e,a.data),this)}moveImport(e,a){this._checkLoaded();let f=this.stylesheet.imports||[];const y=this.getImportIndex(e);if(y===-1)return this;const w=this.getImportIndex(a);if(w===-1)return this;const I=f[y],M=this.fragments[y];return f=f.filter(({id:L})=>L!==e),this.fragments=this.fragments.filter(({id:L})=>L!==e),this.stylesheet.imports=f.slice(0,w).concat(I).concat(f.slice(w)),this.fragments=this.fragments.slice(0,w).concat(M).concat(this.fragments.slice(w)),this.mergeLayers(),this}setImportUrl(e,a){this._checkLoaded();const f=this.stylesheet.imports||[],y=this.getImportIndex(e);if(y===-1)return this;f[y].url=a;const w=this.fragments[y];return w.style=this._createFragmentStyle(f[y]),w.style.on("style.import.load",()=>this.mergeAll()),w.style.loadURL(a),this}setImportData(e,a){this._checkLoaded();const f=this.getImportIndex(e),y=this.stylesheet.imports||[];return f===-1?this:a?(this.fragments[f].style.setState(a),this._reloadImports(),this):(delete y[f].data,this.setImportUrl(e,y[f].url))}setImportConfig(e,a,f){this._checkLoaded();const y=this.getImportIndex(e),w=this.stylesheet.imports||[];if(y===-1)return this;a?w[y].config=a:delete w[y].config;const I=this.fragments[y];f&&I.style.stylesheet&&(I.style.stylesheet.schema=f);const M=I.style.stylesheet&&I.style.stylesheet.schema;return I.config=a,I.style.updateConfig(a,M),this.updateConfigDependencies(),this}removeImport(e){this._checkLoaded();const a=this.stylesheet.imports||[],f=this.getImportIndex(e);f!==-1&&(a.splice(f,1),this.fragments[f].style._remove(),this.fragments.splice(f,1),this._reloadImports())}getImportIndex(e){const a=(this.stylesheet.imports||[]).findIndex(f=>f.id===e);return a===-1&&this.fire(new i.y(new Error(`Import '${e}' does not exist in the map's style and cannot be updated.`))),a}getLayer(e){return this._mergedLayers[e]}getSources(){const e=[];for(const a in this._mergedOtherSourceCaches){const f=this._mergedOtherSourceCaches[a];f&&e.push(f.getSource())}return e}getSource(e,a){const f=this.getSourceCache(e,a);return f&&f.getSource()}getLayerSource(e){const a=this.getLayerSourceCache(e);return a&&a.getSource()}getSourceCache(e,a){const f=i.B(e,a);return this._mergedOtherSourceCaches[f]}getLayerSourceCache(e){const a=i.B(e.source,e.scope);return e.type==="symbol"?this._mergedSymbolSourceCaches[a]:this._mergedOtherSourceCaches[a]}getSourceCaches(e){if(e==null)return Object.values(this._mergedSourceCaches);const a=[];return this._mergedOtherSourceCaches[e]&&a.push(this._mergedOtherSourceCaches[e]),this._mergedSymbolSourceCaches[e]&&a.push(this._mergedSymbolSourceCaches[e]),a}updateSourceCaches(){const e=this._changes.getUpdatedSourceCaches();for(const a in e){const f=e[a];f==="reload"?this.reloadSource(a):f==="clear"&&this.clearSource(a)}}updateLayers(e){const a=this._changes.getUpdatedPaintProperties();for(const f of a){const y=this.getLayer(f);y&&y.updateTransitions(e)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(e){this.stylesheet.glyphs=e,this.glyphManager.setURL(e)}getImages(e,a,f){this.imageManager.getImages(a.images,a.scope,f),this._updateTilesForChangedImages();const y=I=>{if(I){const M=a.images.map(L=>i.I.toString(L));I.setDependencies(a.tileID.key,a.type,M)}},w=i.B(a.source,a.scope);y(this._mergedOtherSourceCaches[w]),y(this._mergedSymbolSourceCaches[w]),a.images.some(I=>I.iconsetId)&&this.fire(new i.z("data",{dataType:"style"}))}rasterizeImages(e,a,f){this.imageManager.rasterizeImages(a,f)}getGlyphs(e,a,f){this.glyphManager.getGlyphs(a.stacks,f)}getResource(e,a,f){return i.dy(a,f)}getOwnSourceCache(e){return this._otherSourceCaches[e]}getOwnLayerSourceCache(e){return e.type==="symbol"?this._symbolSourceCaches[e.source]:this._otherSourceCaches[e.source]}getOwnSourceCaches(e){const a=[];return this._otherSourceCaches[e]&&a.push(this._otherSourceCaches[e]),this._symbolSourceCaches[e]&&a.push(this._symbolSourceCaches[e]),a}_isSourceCacheLoaded(e){const a=this.getOwnSourceCaches(e);return a.length===0?(this.fire(new i.y(new Error(`There is no source with ID '${e}'`))),!1):a.every(f=>f.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(e,a){if(!this._clipLayerPresent&&e.type!=="fill-extrusion"&&e.type!=="building")return!1;const f=e.type==="fill-extrusion"&&(e.sourceLayer==="building"||e.sourceLayer==="procedural_buildings"),y=e.type==="building";if(e.is3D(!!this.terrain)){if(f||y||a&&a.type==="batched-model"||e.type==="model")return!0}else if(e.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(e=>{e.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}xa.getSourceType=function(p){return nl[p]},xa.setSourceType=function(p,e){nl[p]=e},xa.registerForPluginStateChange=i.dz;class aa extends i.E{constructor(e){super(),this._style=e,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},i.aX(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(e){e===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=e,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(e){this._activeFloorsVisible=e,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(e){for(const[a,f]of Object.entries(e.buildings))if(this._buildings[a])for(const y of f.floorIds)this._buildings[a].floors[y]||(this._buildings[a].floors[y]=f.floors[y]);else this._buildings[a]=f;for(const a of e.activeFloors)this._activeFloors.add(a);this._updateIndoorSelector()}getIndoorTileOptions(e,a){const f=this._style.getIndoorSourceLayers(e,a);return f&&this._indoorState?{sourceLayers:f,indoorState:this._indoorState}:null}_updateUI(e,a,f){const y=function(w,I,M,L){let N=null,V=Number.MAX_SAFE_INTEGER;if(L<16)return null;for(const[Z,U]of Object.entries(w)){const X=U.center;if(X){const Q=I.distanceTo(i.aS.convert(X));Q<V&&M.contains(X)&&(V=Q,N=Z)}}return N}(this._buildings,a,f,e);y!==this._closestBuildingId&&(this._closestBuildingId=y,this._updateIndoorSelector())}_updateIndoorSelector(){const e=this._buildings,a=this._closestBuildingId,f=a&&e?e[a]:void 0;if(!f)return void this.fire(new i.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let y=null;for(const I of f.floorIds)if(this._activeFloors&&this._activeFloors.has(I)){y=I;break}const w=Array.from(f.floorIds).map(I=>({id:I,name:f.floors[I].name,zIndex:f.floors[I].zIndex})).sort((I,M)=>M.zIndex-I.zIndex);this.fire(new i.z("selector-update",{selectedFloorId:y,activeFloorsVisible:this._activeFloorsVisible,floors:w}))}_updateActiveFloors(){const e=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:e,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var Zu=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,fp=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Cd=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib
#define DECLARE_MATERIAL_TABLE_INFO
#endif`,Xl="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",ih=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Hu=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Ch=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,La=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Dd=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,ri=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Dh=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const du=[];Ra(Zu,du),Ra(Cd,du),Ra(fp,du);const zh={"_prelude_fog.vertex.glsl":Hu,"_prelude_terrain.vertex.glsl":ih,"_prelude_shadow.vertex.glsl":ri,"_prelude_material_table.vertex.glsl":`#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define MATERIAL_TABLE_DEBUG 0
uniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;
#if MATERIAL_TABLE_DEBUG
vec4 colorDebug;
#endif
};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { 
if (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; 
}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { 
iRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;
#if MATERIAL_TABLE_DEBUG
const vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;
#endif
uint offset=0u;
#if MATERIAL_TABLE_DEBUG
bool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}
#endif
offset++;
#if MATERIAL_TABLE_DEBUG
uint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}
#endif
offset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);
#if MATERIAL_TABLE_DEBUG
if(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}
#endif
uint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);
#if MATERIAL_TABLE_DEBUG
if(keepFinding)
{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}
#endif
offset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;
#if MATERIAL_TABLE_DEBUG
if(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}
#endif
info.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)
{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)
#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));
#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;
#endif`,"_prelude_fog.fragment.glsl":Ch,"_prelude_shadow.fragment.glsl":Dh,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":La,"_prelude_raster_particle.glsl":Dd},yn={};kr("",ih),kr(Ch,Hu),kr(Dh,ri),kr(La,""),kr(Dd,"");const Lh=kr(fp,Cd),zc=Zu;var zd={background:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef FLOOD_LIGHT
in highp float v_flood_radius;in float v_has_flood_light;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);
#ifdef FLOOD_LIGHT
float flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);
#endif
color.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
#ifdef FLOOD_LIGHT
out highp float v_flood_radius;out float v_has_flood_light;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
#ifdef FLOOD_LIGHT
v_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);
#endif
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:kr(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:kr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:kr("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:kr(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:kr(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:kr("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:kr("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:kr("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:kr(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:kr(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#else
#ifdef FEATURE_CUTOUT
apply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);
#endif
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:kr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:kr(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:kr(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:kr(`precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:kr("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:kr("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:kr(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:kr(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#define APPEARANCE_ICON 1.0
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
#ifdef Z_TEST_OCCLUSION
out_fade_opacity*=occlusion_opacity;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:kr("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:kr(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Xl),skyboxGradient:kr(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Xl),skyboxCapture:kr(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:kr(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:kr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef FLIP_Y
coord.y=1.0-coord.y;
#endif
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#ifdef CLIP_ZERO_TO_ONE
v_depth=-1.0+2.0*v_depth; 
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:kr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:kr(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:kr("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:kr("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:kr("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:kr("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Ra(p,e){const a=p.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let f of a)if(f=f.trim(),f[0]==="#"&&f.includes("if")&&!f.includes("endif")){f=f.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const y=f.split(" ");for(const w of y)e.includes(w)||e.push(w)}}function kr(p,e){const a=/#include\s+"([^"]+)"/g,f=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,y={},w=[],I=[];if(p=p.replace(a,(L,N)=>(I.push(N),"")),(e=e.replace(a,(L,N)=>(w.push(N),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let M=[...du];Ra(p,M),Ra(e,M);for(const L of[...w,...I])zh[L]||console.error(`Undefined include: ${L}`),yn[L]||(yn[L]=[],Ra(zh[L],yn[L])),M=[...M,...yn[L]];return{fragmentSource:p=p.replace(f,(L,N,V,Z,U)=>(y[U]=!0,N==="define"?`
#ifndef HAS_UNIFORM_u_${U}
in ${V} ${Z} ${U};
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="initialize"?`
#ifdef HAS_UNIFORM_u_${U}
    ${V} ${Z} ${U} = u_${U};
#endif
`:N==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${V} ${Z} ${U};
#endif
`:N==="initialize-attribute"?"":void 0)),vertexSource:e=e.replace(f,(L,N,V,Z,U)=>{const X=`MATERIAL_ATTRIBUTE_OFFSET_${U}`,Q=Z==="float"?"vec2":Z,nt=`GET_ATTRIBUTE_${Q}(a_${U}, materialInfo, ${X})`,ht=U.match(/color/)?"color":Q;return N==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${U}
in ${V} ${Z} a_${U};
#endif
`:y[U]?N==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
    #if !defined(${X})
        in ${V} ${Q} a_${U};
    #endif
out ${V} ${Z} ${U};
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="initialize"?ht==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    ${U} = a_${U};
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`:`
#if !defined(HAS_UNIFORM_u_${U}) 
    #ifdef ${X}
        ${U} = unpack_mix_${ht}(${nt}, u_${U}_t);
    #else
        ${U} = unpack_mix_${ht}(a_${U}, u_${U}_t);
    #endif
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`:N==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${V} ${Z} a_${U};
    out ${V} ${Z} ${U};
#endif
`:N==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${U} = a_${U};
#endif
`:void 0:N==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
    #if !defined(${X})
        in ${V} ${Q} a_${U};
    #endif  
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="define-instanced"?ht==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${U}0;
in vec4 a_${U}1;
in vec4 a_${U}2;
in vec4 a_${U}3;
#else
uniform ${V} ${Z} u_${U};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${V} ${Q} a_${U};
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${V} ${Z} ${U} = a_${U};
#endif
`:ht==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    #ifdef ${X}
        ${V} ${Z} ${U} = ${nt};
    #else
        ${V} ${Z} ${U} = a_${U};
    #endif
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`:`
#ifndef HAS_UNIFORM_u_${U}
    #ifdef ${X}
        ${V} ${Z} ${U} = unpack_mix_${ht}(${nt}, u_${U}_t);
    #else
        ${V} ${Z} ${U} = unpack_mix_${ht}(a_${U}, u_${U}_t);
    #endif
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`}),usedDefines:M,vertexIncludes:w,fragmentIncludes:I}}class Wu{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(e,a,f,y,w,I,M,L){this.context=e;let N=this.boundPaintVertexBuffers.length!==y.length;for(let Z=0;!N&&Z<y.length;Z++)this.boundPaintVertexBuffers[Z]!==y[Z]&&(N=!0);let V=this.boundDynamicVertexBuffers.length!==M.length;for(let Z=0;!V&&Z<M.length;Z++)this.boundDynamicVertexBuffers[Z]!==M[Z]&&(V=!0);if(!this.vao||this.boundProgram!==a||this.boundLayoutVertexBuffer!==f||N||V||this.boundIndexBuffer!==w||this.boundVertexOffset!==I)this.freshBind(a,f,y,w,I,M,L);else{e.bindVertexArrayOES.set(this.vao);for(const Z of M)Z&&(Z.bind(),L&&Z.instanceCount&&Z.setVertexAttribDivisor(e.gl,a,L));w&&w.dynamicDraw&&w.bind()}}freshBind(e,a,f,y,w,I,M){const L=this.context,N=L.gl;this.vao&&this.destroy(),this.vao=L.gl.createVertexArray(),L.bindVertexArrayOES.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=a,this.boundPaintVertexBuffers=f,this.boundIndexBuffer=y,this.boundVertexOffset=w,this.boundDynamicVertexBuffers=I,a.enableAttributes(N,e),a.bind(),a.setVertexAttribPointers(N,e,w);for(const V of f)V.enableAttributes(N,e),V.bind(),V.setVertexAttribPointers(N,e,w);for(const V of I)V&&(V.enableAttributes(N,e),V.bind(),V.setVertexAttribPointers(N,e,w),M&&V.instanceCount&&V.setVertexAttribDivisor(N,e,M));y&&y.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function $f(p,e){const a=Math.pow(2,e.canonical.z),f=e.canonical.y;return[new i.ae(0,f/a).toLngLat().lat,new i.ae(0,(f+1)/a).toLngLat().lat]}function Mm(p,e,a,f,y,w,I){const M=p.context,L=M.gl,N=a.hillshadeFBO;if(!N)return;p.prepareDrawTile();const V=p.isTileAffectedByFog(e),Z=p.getOrCreateProgram("hillshade",{overrideFog:V});M.activeTexture.set(L.TEXTURE0),L.bindTexture(L.TEXTURE_2D,N.colorAttachment.get());const U=((ht,lt,_t,Ct)=>{const bt=_t.paint.get("hillshade-shadow-color"),Gt=_t.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",zt=_t.paint.get("hillshade-highlight-color"),Zt=_t.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",Vt=_t.paint.get("hillshade-accent-color"),kt=_t.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Ht=_t.paint.get("hillshade-emissive-strength");let pe=i.an(_t.paint.get("hillshade-illumination-direction"));if(_t.paint.get("hillshade-illumination-anchor")==="viewport")pe-=ht.transform.angle;else if(ht.style&&ht.style.enable3dLights()&&ht.style.directionalLight){const Ce=ht.style.directionalLight.properties.get("direction"),ve=i.d3(Ce.x,Ce.y,Ce.z);pe=i.an(ve[1])}const ae=!ht.options.moving;return{u_matrix:Ct||ht.transform.calculateProjMatrix(lt.tileID.toUnwrapped(),ae),u_image:0,u_latrange:$f(0,lt.tileID),u_light:[_t.paint.get("hillshade-exaggeration"),pe],u_shadow:bt.toPremultipliedRenderColor(Gt?null:_t.lut),u_highlight:zt.toPremultipliedRenderColor(Zt?null:_t.lut),u_emissive_strength:Ht,u_accent:Vt.toPremultipliedRenderColor(kt?null:_t.lut)}})(p,a,f,p.terrain?e.projMatrix:null);p.uploadCommonUniforms(M,Z,e.toUnwrapped());const{tileBoundsBuffer:X,tileBoundsIndexBuffer:Q,tileBoundsSegments:nt}=p.getTileBoundsBuffers(a);Z.draw(p,L.TRIANGLES,y,w,I,Qi.disabled,U,f.id,X,Q,nt)}function pu(p,e,a){if(!e.needsDEMTextureUpload)return;const f=p.context,y=f.gl;f.pixelStoreUnpackPremultiplyAlpha.set(!1),e.demTexture=e.demTexture||p.getTileTexture(a.stride);const w=a.getPixels();e.demTexture?e.demTexture.update(w,{premultiply:!1}):e.demTexture=new i.T(f,w,y.R32F,{premultiply:!1}),e.needsDEMTextureUpload=!1}function mp(p,e,a){const f=p.context,y=f.gl;if(!e.dem)return;const w=e.dem;if(f.activeTexture.set(y.TEXTURE1),pu(p,e,w),!e.demTexture)return;e.demTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE);const I=w.dim;f.activeTexture.set(y.TEXTURE0);let M=e.hillshadeFBO;if(!M){const U=new i.T(f,{width:I,height:I,data:null},y.RGBA8);U.bind(y.LINEAR,y.CLAMP_TO_EDGE),M=e.hillshadeFBO=f.createFramebuffer(I,I,!0,"renderbuffer"),M.colorAttachment.set(U.texture)}f.bindFramebuffer.set(M.framebuffer),f.viewport.set([0,0,I,I]);const{tileBoundsBuffer:L,tileBoundsIndexBuffer:N,tileBoundsSegments:V}=p.getMercatorTileBoundsBuffers(),Z=[];p.linearFloatFilteringSupported()&&Z.push("TERRAIN_DEM_FLOAT_FORMAT"),p.getOrCreateProgram("hillshadePrepare",{defines:Z}).draw(p,y.TRIANGLES,zi.disabled,sr.disabled,yr.unblended,Qi.disabled,((U,X)=>{const Q=X.stride,nt=i.bB();return i.cd(nt,0,i.al,-i.al,0,0,1),i.bq(nt,nt,[0,-i.al,0]),{u_matrix:nt,u_image:1,u_dimension:[Q,Q],u_zoom:U.overscaledZ}})(e.tileID,w),a.id,L,N,V),e.needsHillshadePrepare=!1}class Xn{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Rh extends Xn{getDefault(){return i.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const a=this.current;(e.r!==a.r||e.g!==a.g||e.b!==a.b||e.a!==a.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class Xu extends Xn{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class qf extends Xn{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class gp extends Xn{getDefault(){return[!0,!0,!0,!0]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class _p extends Xn{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class yp extends Xn{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class fu extends Xn{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const a=this.current;(e.func!==a.func||e.ref!==a.ref||e.mask!==a.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class xp extends Xn{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class Ld extends Xn{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),this.current=e,this.dirty=!1}}class Rd extends Xn{getDefault(){return[0,1]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class Zf extends Xn{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.current=e,this.dirty=!1}}class kd extends Xn{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class kh extends Xn{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.BLEND):a.disable(a.BLEND),this.current=e,this.dirty=!1}}class Yu extends Xn{getDefault(){const e=this.gl;return[e.ONE,e.ZERO,e.ONE,e.ZERO]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.blendFuncSeparate(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Fh extends Xn{getDefault(){return i.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const a=this.current;(e.r!==a.r||e.g!==a.g||e.b!==a.b||e.a!==a.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class mu extends Xn{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(e,e),this.current=e,this.dirty=!1)}}class Bh extends Xn{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),this.current=e,this.dirty=!1}}class Oh extends Xn{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class uf extends Xn{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}let Fd=class extends Xn{getDefault(){return null}set(p){(p!==this.current||this.dirty)&&(this.gl.useProgram(p),this.current=p,this.dirty=!1)}};class Xo extends Xn{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class ul extends Xn{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class va extends Xn{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class Nh extends Xn{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindRenderbuffer(a.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class rh extends Xn{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindTexture(a.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class Bd extends Xn{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindBuffer(a.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Lc extends Xn{getDefault(){return null}set(e){const a=this.gl;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class vp extends Xn{getDefault(){return null}set(e){this.gl&&(e!==this.current||this.dirty)&&(this.gl.bindVertexArray(e),this.current=e,this.dirty=!1)}}class Ju extends Xn{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class bp extends Xn{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class gu extends Xn{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class Ku extends Xn{constructor(e,a){super(e),this.context=e,this.parent=a}getDefault(){return null}}class df extends Ku{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Qu extends Ku{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferRenderbuffer(a.FRAMEBUFFER,this.attachment(),a.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class Hf extends Ku{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment(),a.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Rc extends Qu{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Od=(p,e,a)=>({u_matrix:p,u_image0:0,u_skirt_height:e,u_ground_shadow_factor:a}),Nd=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt)=>({u_proj_matrix:Float32Array.from(p),u_globe_matrix:e,u_normalize_matrix:Float32Array.from(f),u_merc_matrix:a,u_zoom_transition:y,u_merc_center:w,u_image0:0,u_frustum_tl:I,u_frustum_tr:M,u_frustum_br:L,u_frustum_bl:N,u_globe_pos:V,u_globe_radius:Z,u_viewport:U,u_grid_matrix:nt?Float32Array.from(nt):new Float32Array(9),u_skirt_height:X,u_far_z_cutoff:Q});function td(p,e){return p!=null&&e!=null&&!(!p.hasData()||!e.hasData())&&p.demTexture!=null&&e.demTexture!=null&&p.tileID.key!==e.tileID.key}const nh=new class{constructor(){this.operations={}}newMorphing(p,e,a,f,y){if(p in this.operations){const w=this.operations[p];w.to.tileID.key!==a.tileID.key&&(w.queued=a)}else this.operations[p]={startTime:f,phase:0,duration:y,from:e,to:a,queued:null}}getMorphValuesForProxy(p){if(!(p in this.operations))return null;const e=this.operations[p];return{from:e.from,to:e.to,phase:e.phase}}update(p){for(const e in this.operations){const a=this.operations[e];for(a.phase=(p-a.startTime)/a.duration;a.phase>=1||!this._validOp(a);)if(!this._nextOp(a,p)){delete this.operations[e];break}}}_nextOp(p,e){return!!p.queued&&(p.from=p.to,p.to=p.queued,p.queued=null,p.phase=0,p.startTime=e,!0)}_validOp(p){return p.from.hasData()&&p.to.hasData()}},Vh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function pf(p,e,a){if(e===0)return 0;const f=e<1&&a===514?.25/e:1;return 6*Math.pow(1.5,22-p)*Math.max(e,1)*f}function ed(p,e){const a=1<<p.z;return!e&&(p.x===0||p.x===a-1)||p.y===0||p.y===a-1}const Uh=p=>({u_matrix:p});function _u(p,e,a,f,y){if(y>0){const w=i.o.now(),I=(w-p.timeAdded)/y,M=e?(w-e.timeAdded)/y:-1,L=a.getSource(),N=f.coveringZoomLevel({tileSize:L.tileSize,roundZoom:L.roundZoom}),V=!e||Math.abs(e.tileID.overscaledZ-N)>Math.abs(p.tileID.overscaledZ-N),Z=V&&p.refreshedUponExpiration?1:i.aA(V?I:1-M,0,1);return e?{opacity:1,mix:1-Z,isFading:I<1}:{opacity:Z,mix:0,isFading:I<1}}return{opacity:1,mix:0,isFading:!1}}class dl extends On{constructor(e){const a=_a("mock-dem",{type:"raster-dem",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("mock-dem",a,!1),a.setEventedParent(this),this._sourceLoaded=!0}_loadTile(e,a){e.state="loaded",a(null)}}class pl extends On{constructor(e){const a=_a("proxy",{type:"geojson",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("proxy",a,!1),a.setEventedParent(this),this.map=this.getSource().map=e,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(e,a,f){if(e.freezeTileCoverage)return;this.transform=e;const y=e.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((w,I)=>{if(w[I.key]="",!this._tiles[I.key]){const M=new Lo(I,this._source.tileSize*I.overscaleFactor(),e.tileZoom,void 0,void 0,this._source.worldview);M.state="loaded",this._tiles[I.key]=M}return w},{});for(const w in this._tiles)w in y||(this.freeFBO(w),this._tiles[w].unloadVectorData(),delete this._tiles[w])}freeFBO(e){const a=this.proxyCachedFBO[e];if(a!==void 0){const f=Object.values(a);this.renderCachePool.push(...f),delete this.proxyCachedFBO[e]}}deallocRenderCache(){this.renderCache.forEach(e=>e.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class qs extends i.aP{constructor(e,a,f){super(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y),this.proxyTileKey=a,this.projMatrix=f}}class kc extends i.bU{constructor(e,a){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},e.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),e.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),e.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=e,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[f,y,w]=function(L){const N=new i.bc,V=new i.b0,Z=131;N.reserve(17161),V.reserve(33800);const U=i.al/128,X=i.al+U/2,Q=X+U;for(let ht=-U;ht<Q;ht+=U)for(let lt=-U;lt<Q;lt+=U){const _t=lt<0||lt>X||ht<0||ht>X?24575:0,Ct=i.aA(Math.round(lt),0,i.al),bt=i.aA(Math.round(ht),0,i.al);N.emplaceBack(Ct+_t,bt)}const nt=(ht,lt)=>{const _t=lt*Z+ht;V.emplaceBack(_t+1,_t,_t+Z),V.emplaceBack(_t+Z,_t+Z+1,_t+1)};for(let ht=1;ht<129;ht++)for(let lt=1;lt<129;lt++)nt(lt,ht);return[0,129].forEach(ht=>{for(let lt=0;lt<130;lt++)nt(lt,ht),nt(ht,lt)}),[N,V,32768]}(),I=e.context;this.gridBuffer=I.createVertexBuffer(f,i.be.members),this.gridIndexBuffer=I.createIndexBuffer(y),this.gridSegments=i.bf.simpleSegment(0,0,f.length,y.length),this.gridNoSkirtSegments=i.bf.simpleSegment(0,0,f.length,w),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new pl(a.map),this.orthoMatrix=i.bB(),i.cd(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,i.al,0,i.al,0,1);const M=I.gl;this._overlapStencilMode=new sr({func:M.GEQUAL,mask:255},0,255,M.KEEP,M.KEEP,M.REPLACE),this._previousZoom=e.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=a,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new dl(a.map),this._pendingGroundEffectLayers=[]}set style(e){e.on("data",this._onStyleDataEvent.bind(this)),this._style=e,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(e,a,f){if(e&&e.terrain){this._style!==e&&(this.style=e,this._evaluationZoom=void 0);const y=e.terrain.properties,w=e.terrain.drapeRenderMode===0,I=e.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=i.o.now();const M=e.terrain&&e.terrain.scope,L=y.get("source"),N=w?this._mockSourceCache:e.getSourceCache(L,M);if(!N)return void i.w(`Couldn't find terrain source "${L}".`);if(this.sourceCache=N,this._attenuationRange=e.terrain.getAttenuationRange(),this._exaggeration=I?this.calculateExaggeration(a):y.get("exaggeration"),!a.projection.requiresDraping&&I&&this._exaggeration===0)return void this._disable();this.enabled=!0;const V=()=>{this.sourceCache.used&&i.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const Z=this.getScaledDemTileSize();this.sourceCache.update(a,Z,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,V(),this._initializing=!0),V(),a.updateElevation(!0,f),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(a),this._emptyDEMTextureDirty=!0,this._previousZoom=a.zoom}else this._disable()}calculateExaggeration(e){if(this._attenuationRange&&e.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(e.zoom);const a=this._previousCameraAltitude,f=e.getFreeCameraOptions().position.z/e.pixelsPerMeter*e.worldSize;this._previousCameraAltitude=f;const y=a!=null?f-a:Number.MAX_VALUE;if(Math.abs(y)<2)return this._exaggeration;const w=e.zoom,I=this._style.terrain;if(!this._previousUpdateTimestamp)return I.getExaggeration(w);let M=w-this._previousZoom;const L=this._previousUpdateTimestamp;let N=w;this._evaluationZoom!=null&&(N=this._evaluationZoom,Math.abs(w-N)>.5&&(M=.5*(w-N+M)),M*y<0&&(N+=M)),this._evaluationZoom=N;const V=I.getExaggeration(N),Z=V===I.getExaggeration(Math.max(0,N-.1));if(Z&&Math.abs(V-this._exaggeration)<.01)return V;let U=Math.min(.1,.00375*(this._updateTimestamp-L));return(Z||V<.1||Math.abs(M)<1e-4)&&(U=Math.min(.2,4*U)),i.ak(this._exaggeration,V,U)}resetTileLookupCache(e){this._findCoveringTileCache[e]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(e){e.dataType==="source"&&e.coord?this._clearRenderCacheForTile(e.sourceCacheId,e.coord):e.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const e in this._style._mergedSourceCaches)this._style._mergedSourceCaches[e].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(e=>e.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const e=2*this.proxySourceCache.getSource().tileSize;return[e,e]}set useVertexMorphing(e){this._useVertexMorphing=e}updateTileBinding(e){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const a=this.proxySourceCache,f=this.painter.transform;this._initializing&&(this._initializing=f._centerAltitude===0&&this.getAtPointOrZero(i.ae.fromLngLat(f.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const y=this.proxyCoords=a.getIds().map(L=>{const N=a.getTileByID(L).tileID;return N.projMatrix=f.calculateProjMatrix(N.toUnwrapped()),N});(function(L,N){const V=N.transform.pointCoordinate(N.transform.getCameraPoint()),Z=new i.P(V.x,V.y);L.sort((U,X)=>{if(X.overscaledZ-U.overscaledZ)return X.overscaledZ-U.overscaledZ;const Q=new i.P(U.canonical.x+(1<<U.canonical.z)*U.wrap,U.canonical.y),nt=new i.P(X.canonical.x+(1<<X.canonical.z)*X.wrap,X.canonical.y),ht=Z.mult(1<<U.canonical.z);return ht.x-=.5,ht.y-=.5,ht.distSqr(Q)-ht.distSqr(nt)})})(y,this.painter);const w=this.proxyToSource||{};this.proxyToSource={},y.forEach(L=>{this.proxyToSource[L.key]={}}),this.terrainTileForTile={};const I=this._style._mergedSourceCaches;for(const L in I){const N=I[L];if(!N.used||(N!==this.sourceCache&&this.resetTileLookupCache(N.id),this._setupProxiedCoordsForOrtho(N,e[L],w),N.usedForTerrain))continue;const V=e[L];N.getSource().reparseOverscaled&&this._assignTerrainTiles(V)}this.proxiedCoords[a.id]=y.map(L=>new qs(L,L.key,this.orthoMatrix)),this._assignTerrainTiles(y),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(w),this.renderingToTexture=!1;const M={};this._visibleDemTiles=[];for(const L of this.proxyCoords){const N=this.terrainTileForTile[L.key];if(!N)continue;const V=N.tileID.key;V in M||(this._visibleDemTiles.push(N),M[V]=V)}}_assignTerrainTiles(e){this._initializing||e.forEach(a=>{if(this.terrainTileForTile[a.key])return;const f=this._findTileCoveringTileID(a,this.sourceCache);f&&(this.terrainTileForTile[a.key]=f)})}_prepareDEMTextures(){const e=this.painter.context,a=e.gl;for(const f in this.terrainTileForTile){const y=this.terrainTileForTile[f],w=y.dem;!w||y.demTexture&&!y.needsDEMTextureUpload||(e.activeTexture.set(a.TEXTURE1),pu(this.painter,y,w))}}_prepareDemTileUniforms(e,a,f,y){if(!a||a.demTexture==null)return!1;const w=e.tileID.canonical,I=Math.pow(2,a.tileID.canonical.z-w.z),M=y||"";return f[`u_dem_tl${M}`]=[w.x*I%1,w.y*I%1],f[`u_dem_scale${M}`]=I,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let e=0;const a=this._visibleDemTiles.reduce((f,y)=>{if(!y.dem)return f;const w=y.dem.tree.minimums[0];return w>0&&e++,f+w},0);return e?a/e:0}_updateEmptyDEMTexture(){const e=this.painter.context,a=e.gl;e.activeTexture.set(a.TEXTURE2);const f=this._getLoadedAreaMinimum(),y=new i.dK({width:1,height:1},new Float32Array([f]));this._emptyDEMTextureDirty=!1;let w=this._emptyDEMTexture;return w?w.update(y,{premultiply:!1}):w=this._emptyDEMTexture=new i.T(e,y,a.R32F,{premultiply:!1}),w}setupElevationDraw(e,a,f){const y=this.painter.context,w=y.gl,I={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};I.u_exaggeration=this.exaggeration();let M=null,L=null,N=1;if(f&&f.morphing&&this._useVertexMorphing){const X=f.morphing.srcDemTile,Q=f.morphing.dstDemTile;N=f.morphing.phase,X&&Q&&(this._prepareDemTileUniforms(e,X,I,"_prev")&&(L=X),this._prepareDemTileUniforms(e,Q,I)&&(M=Q))}const V=X=>X&&X.demTexture&&this.painter.linearFloatFilteringSupported()?w.LINEAR:w.NEAREST;let Z=null;var U;if(this.enabled?L&&M?(Z=M.demTexture,y.activeTexture.set(w.TEXTURE4),L.demTexture.bind(V(L),w.CLAMP_TO_EDGE),I.u_dem_lerp=N):(M=this.terrainTileForTile[e.tileID.key],Z=this._prepareDemTileUniforms(e,M,I)?M.demTexture:this.emptyDEMTexture):Z=this.emptyDEMTexture,y.activeTexture.set(w.TEXTURE2),Z&&(I.u_dem_size=(U=Z).size[0]===1?1:U.size[0]-2,Z.bind(V(M),w.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(f&&f.useDepthForOcclusion,a,I),f&&f.useMeterToDem&&M){const X=(1<<M.tileID.canonical.z)*i.ce(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;I.u_meter_to_dem=X}if(f&&f.labelPlaneMatrixInv&&(I.u_label_plane_matrix_inv=f.labelPlaneMatrixInv),a.setTerrainUniformValues(y,I),this.painter.transform.projection.name==="globe"){const X=this.globeUniformValues(this.painter.transform,e.tileID.canonical,f&&f.useDenormalizedUpVectorScale);a.setGlobeUniformValues(y,X)}}globeUniformValues(e,a,f){const y=e.projection;return{u_tile_tl_up:y.upVector(a,0,0),u_tile_tr_up:y.upVector(a,i.al,0),u_tile_br_up:y.upVector(a,i.al,i.al),u_tile_bl_up:y.upVector(a,0,i.al),u_tile_up_scale:f?i.dL(1):y.upVectorScale(a,e.center.lat,e.worldSize).metersToTile}}renderToBackBuffer(e){const a=this.painter,f=this.painter.context;e.length!==0&&(f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),a.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(y,w,I,M,L){if(y.transform.projection.name==="globe")(function(N,V,Z,U,X){const Q=N.context,nt=Q.gl;let ht,lt;const _t=N.transform,Ct=i.dD(N,Q,_t),bt=(Ce,ve)=>{if(lt===ve)return;const Fe=[Vh[ve],"PROJECTION_GLOBE_VIEW"];Ct&&Fe.push("CUSTOM_ANTIALIASING");const oi=N.isTileAffectedByFog(Ce);ht=N.getOrCreateProgram("globeRaster",{defines:Fe,overrideFog:oi}),lt=ve},Gt=N.colorModeForRenderPass(),zt=new zi(nt.LEQUAL,zi.ReadWrite,N.depthRangeFor3D);nh.update(X);const Zt=i.dE(_t),Vt=[i.aF(_t.center.lng),i.aJ(_t.center.lat)],kt=N.globeSharedBuffers,Ht=[_t.width*i.o.devicePixelRatio,_t.height*i.o.devicePixelRatio],pe=Float32Array.from(_t.globeMatrix),ae={useDenormalizedUpVectorScale:!0};{const Ce=N.transform,ve=pf(Ce.zoom,V.exaggeration(),V.sourceCache._source.tileSize);lt=-1;const Fe=nt.TRIANGLES;for(const oi of U){const ge=Z.getTile(oi),re=sr.disabled,Be=V.prevTerrainTileForTile[oi.key],Te=V.terrainTileForTile[oi.key];td(Be,Te)&&nh.newMorphing(oi.key,Be,Te,X,250),Q.activeTexture.set(nt.TEXTURE0),ge.texture&&ge.texture.bind(nt.LINEAR,nt.CLAMP_TO_EDGE);const qe=nh.getMorphValuesForProxy(oi.key),si=qe?1:0;qe&&Object.assign(ae,{morphing:{srcDemTile:qe.from,dstDemTile:qe.to,phase:i.dC(qe.phase)}});const Ci=i.dF(oi.canonical),ni=i.dG(Ci.getCenter().lat),li=i.dH(oi.canonical,Ci,ni,Ce.worldSize/Ce._pixelsPerMercatorPixel),Li=i.bj(i.dI(oi.canonical)),Ti=Nd(Ce.expandedFarZProjMatrix,pe,Zt,Li,i.aj(Ce.zoom),Vt,Ce.frustumCorners.TL,Ce.frustumCorners.TR,Ce.frustumCorners.BR,Ce.frustumCorners.BL,Ce.globeCenterInViewSpace,Ce.globeRadius,Ht,ve,Ce._farZ,li);if(bt(oi,si),ht&&(V.setupElevationDraw(ge,ht,ae),N.uploadCommonUniforms(Q,ht,oi.toUnwrapped()),kt)){const[xi,Ii,Zi]=kt.getGridBuffers(ni,ve!==0);ht.draw(N,Fe,zt,re,Gt,Qi.backCCW,Ti,"globe_raster",xi,Ii,Zi)}}}if(kt&&(N.renderDefaultNorthPole||N.renderDefaultSouthPole)){const Ce=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Ct&&Ce.push("CUSTOM_ANTIALIASING"),ht=N.getOrCreateProgram("globeRaster",{defines:Ce});for(const ve of U){const{x:Fe,y:oi,z:ge}=ve.canonical,re=oi===0,Be=oi===(1<<ge)-1,[Te,qe,si,Ci]=kt.getPoleBuffers(ge,!1);if(Ci&&(re||Be)){const ni=Z.getTile(ve);Q.activeTexture.set(nt.TEXTURE0),ni.texture&&ni.texture.bind(nt.LINEAR,nt.CLAMP_TO_EDGE);let li=i.dJ(ge,Fe,_t);const Li=i.bj(i.dI(ve.canonical)),Ti=(xi,Ii)=>xi.draw(N,nt.TRIANGLES,zt,sr.disabled,Gt,Qi.disabled,Nd(_t.expandedFarZProjMatrix,li,li,Li,0,Vt,_t.frustumCorners.TL,_t.frustumCorners.TR,_t.frustumCorners.BR,_t.frustumCorners.BL,_t.globeCenterInViewSpace,_t.globeRadius,Ht,0,_t._farZ),"globe_pole_raster",Ii,si,Ci);V.setupElevationDraw(ni,ht,ae),N.uploadCommonUniforms(Q,ht,ve.toUnwrapped()),re&&N.renderDefaultNorthPole&&Ti(ht,Te),Be&&N.renderDefaultSouthPole&&(li=i.cR(i.bB(),li,[1,-1,1]),Ti(ht,qe))}}}})(y,w,I,M,L);else{const N=y.context,V=N.gl;let Z,U;const X=y.shadowRenderer,Q=sa(y,y.longestCutoffRange),nt=Gt=>{if(U===Gt)return;const zt=[];zt.push(Vh[Gt]),Q.shouldRenderCutoff&&zt.push("RENDER_CUTOFF"),X&&(zt.push("RENDER_SHADOWS","DEPTH_TEXTURE"),X.useNormalOffset&&zt.push("NORMAL_OFFSET")),Z=y.getOrCreateProgram("terrainRaster",{defines:zt}),U=Gt},ht=y.colorModeForRenderPass(),lt=new zi(V.LEQUAL,zi.ReadWrite,y.depthRangeFor3D);nh.update(L);const _t=y.transform,Ct=pf(_t.zoom,w.exaggeration(),w.sourceCache._source.tileSize);let bt=[0,0,0];if(X){const Gt=y.style.directionalLight,zt=y.style.ambientLight;Gt&&zt&&(bt=hl(y.style,Gt,zt))}{U=-1;const Gt=V.TRIANGLES,[zt,Zt]=[w.gridIndexBuffer,w.gridSegments];for(const Vt of M){const kt=I.getTile(Vt),Ht=sr.disabled,pe=w.prevTerrainTileForTile[Vt.key],ae=w.terrainTileForTile[Vt.key];td(pe,ae)&&nh.newMorphing(Vt.key,pe,ae,L,250),N.activeTexture.set(V.TEXTURE0),kt.texture&&kt.texture.bind(V.LINEAR,V.CLAMP_TO_EDGE);const Ce=nh.getMorphValuesForProxy(Vt.key),ve=Ce?1:0;let Fe;Ce&&(Fe={morphing:{srcDemTile:Ce.from,dstDemTile:Ce.to,phase:i.dC(Ce.phase)}});const oi=Od(Vt.projMatrix,ed(Vt.canonical,_t.renderWorldCopies)?Ct/10:Ct,bt);if(nt(ve),!Z)continue;w.setupElevationDraw(kt,Z,Fe);const ge=Vt.toUnwrapped();X&&X.setupShadows(ge,Z),y.uploadCommonUniforms(N,Z,ge,null,Q),Z.draw(y,Gt,lt,Ht,ht,Qi.backCCW,oi,"terrain_raster",w.gridBuffer,zt,Zt)}}}}(a,this,this.proxySourceCache,e,this._updateTimestamp),this.renderingToTexture=!0,a.gpuTimingDeferredRenderEnd(),e.splice(0,e.length))}renderBatch(e){if(this._drapedRenderBatches.length===0)return e+1;this.renderingToTexture=!0;const a=this.painter,f=this.painter.context,y=this.proxySourceCache,w=this.proxiedCoords[y.id],I=this._drapedRenderBatches.shift(),M=a.style.order,L=[];let N=0;for(const V of w){const Z=y.getTileByID(V.proxyTileKey),U=y.proxyCachedFBO[V.key]?y.proxyCachedFBO[V.key][e]:void 0,X=U!==void 0?y.renderCache[U]:this.pool[N++],Q=U!==void 0;if(Z.texture=X.tex,Q&&!X.dirty){L.push(Z.tileID);continue}let nt;f.bindFramebuffer.set(X.fb.framebuffer),this.renderedToTile=!1,X.dirty&&(f.clear({color:i.ao.transparent,stencil:0}),X.dirty=!1);for(let ht=I.start;ht<=I.end;++ht){const lt=a.style._mergedLayers[M[ht]];if(lt.isHidden(a.transform.zoom))continue;const _t=a.style.getLayerSourceCache(lt),Ct=_t?this.proxyToSource[V.key][_t.id]:[V];if(!Ct)continue;const bt=Ct;f.viewport.set([0,0,X.fb.width,X.fb.height]),nt!==(_t?_t.id:null)&&(this._setupStencil(X,Ct,lt,_t),nt=_t?_t.id:null),a.renderLayer(a,_t,lt,bt)}if(this._drapedRenderBatches.length===0)for(const ht of this._pendingGroundEffectLayers){const lt=a.style._mergedLayers[M[ht]];if(lt.isHidden(a.transform.zoom))continue;const _t=a.style.getLayerSourceCache(lt),Ct=_t?this.proxyToSource[V.key][_t.id]:[V];if(!Ct)continue;const bt=Ct;f.viewport.set([0,0,X.fb.width,X.fb.height]),nt!==(_t?_t.id:null)&&(this._setupStencil(X,Ct,lt,_t),nt=_t?_t.id:null),a.renderLayer(a,_t,lt,bt)}this.renderedToTile?(X.dirty=!0,L.push(Z.tileID)):Q||--N,N===5&&(N=0,this.renderToBackBuffer(L))}return this.renderToBackBuffer(L),this.renderingToTexture=!1,f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),I.end+1}postRender(){}isLayerOrderingCorrect(e){const a=e.order.length;let f=-1,y=a;for(let w=0;w<a;++w)this._style.isLayerDraped(e._mergedLayers[e.order[w]])?f=Math.max(f,w):y=Math.min(y,w);return y>f}getMinElevationBelowMSL(){let e=0;return this._visibleDemTiles.filter(a=>a.dem).forEach(a=>{e=Math.min(e,a.dem.tree.minimums[0])}),e===0?e:(e-30)*this._exaggeration}raycast(e,a,f){if(!this._visibleDemTiles)return null;const y=this._visibleDemTiles.filter(w=>w.dem).map(w=>{const I=w.tileID,M=1<<I.overscaledZ,{x:L,y:N}=I.canonical,V=L/M,Z=(L+1)/M,U=N/M,X=(N+1)/M;return{minx:V,miny:U,maxx:Z,maxy:X,t:w.dem.tree.raycastRoot(V,U,Z,X,e,a,f),tile:w}});y.sort((w,I)=>(w.t!==null?w.t:Number.MAX_VALUE)-(I.t!==null?I.t:Number.MAX_VALUE));for(const w of y){if(w.t==null)return null;const I=w.tile.dem.tree.raycast(w.minx,w.miny,w.maxx,w.maxy,e,a,f);if(I!=null)return I}return null}_createFBO(){const e=this.painter.context,a=e.gl,f=this.drapeBufferSize;e.activeTexture.set(a.TEXTURE0);const y=new i.T(e,{width:f[0],height:f[1],data:null},a.RGBA8);y.bind(a.LINEAR,a.CLAMP_TO_EDGE);const w=e.createFramebuffer(f[0],f[1],!0,null);return w.colorAttachment.set(y.texture),w.depthAttachment=new Rc(e,w.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=e.createRenderbuffer(e.gl.DEPTH_STENCIL,f[0],f[1]),this._stencilRef=0,w.depthAttachment.set(this._sharedDepthStencil),e.clear({stencil:0})):w.depthAttachment.set(this._sharedDepthStencil),e.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,e.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.extTextureFilterAnisotropicMax),{fb:w,tex:y,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const e in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[e].hasTransition())return!0;return this._style.order.some(e=>{const a=this._style._mergedLayers[e],f=a.isHidden(this.painter.transform.zoom);return a.type==="hillshade"||a.type==="custom"?!f&&a.shouldRedrape():!f&&a.hasTransition()})}_clearLineLayersFromRenderCache(){let e=!1;for(const f of this._style.getSources())if(f instanceof ta){e=!0;break}if(!e)return;const a={};for(let f=0;f<this._style.order.length;++f){const y=this._style._mergedLayers[this._style.order[f]],w=this._style.getLayerSourceCache(y);if(w&&!a[w.id]&&!y.isHidden(this.painter.transform.zoom)&&y.type==="line"&&y.widthExpression()instanceof i.ad){a[w.id]=!0;for(const I of this.proxyCoords){const M=this.proxyToSource[I.key][w.id];if(M)for(const L of M)this._clearRenderCacheForTile(w.id,L)}}}}_clearRasterLayersFromRenderCache(){let e=!1;for(const f in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[f]._source instanceof El){e=!0;break}if(!e)return;const a={};for(let f=0;f<this._style.order.length;++f){const y=this._style._mergedLayers[this._style.order[f]],w=this._style.getLayerSourceCache(y);if(!w||a[w.id]||y.isHidden(this.painter.transform.zoom)||y.type!=="raster")continue;const I=y.paint.get("raster-fade-duration");for(const M of this.proxyCoords){const L=this.proxyToSource[M.key][w.id];if(L)for(const N of L){const V=_u(w.getTile(N),w.findLoadedParent(N,0),w,this.painter.transform,I);(V.opacity!==1||V.mix!==0)&&this._clearRenderCacheForTile(w.id,N)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const e=this._style.order,a=e.length;if(a===0)return;const f=[];this._pendingGroundEffectLayers=[];let y,w=0,I=this._style._mergedLayers[e[w]];for(;!this._style.isLayerDraped(I)&&I.isHidden(this.painter.transform.zoom)&&++w<a;)I=this._style._mergedLayers[e[w]];for(;w<a;++w){const M=this._style._mergedLayers[e[w]];M.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(M)?y===void 0&&(y=w):(M.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(w),y!==void 0&&(f.push({start:y,end:w-1}),y=void 0)))}if(y!==void 0&&f.push({start:y,end:w-1}),f.length!==0){const M=f[f.length-1];this._pendingGroundEffectLayers.every(L=>L>M.end)||i.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=f}_setupRenderCache(e){const a=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,a.renderCache.length>a.renderCachePool.length){const I=Object.values(a.proxyCachedFBO);a.proxyCachedFBO={};for(let M=0;M<I.length;++M){const L=Object.values(I[M]);a.renderCachePool.push(...L)}}return}this._clearRasterLayersFromRenderCache();const f=this.proxyCoords,y=this._tilesDirty;for(let I=f.length-1;I>=0;I--){const M=f[I];if(a.getTileByID(M.key),a.proxyCachedFBO[M.key]!==void 0){const L=e[M.key],N=this.proxyToSource[M.key];let V=0;for(const Z in N){const U=N[Z],X=L[Z];if(!X||X.length!==U.length||U.some((Q,nt)=>Q!==X[nt]||y[Z]&&y[Z].hasOwnProperty(Q.key))){V=-1;break}++V}for(const Z in a.proxyCachedFBO[M.key])a.renderCache[a.proxyCachedFBO[M.key][Z]].dirty=V<0||V!==Object.values(L).length}}const w=[...this._drapedRenderBatches];w.sort((I,M)=>M.end-M.start-(I.end-I.start));for(const I of w)for(const M of f){if(a.proxyCachedFBO[M.key])continue;let L=a.renderCachePool.pop();L===void 0&&a.renderCache.length<50&&(L=a.renderCache.length,a.renderCache.push(this._createFBO())),L!==void 0&&(a.proxyCachedFBO[M.key]={},a.proxyCachedFBO[M.key][I.start]=L,a.renderCache[L].dirty=!0)}this._tilesDirty={}}_setupStencil(e,a,f,y){if(!y||!this._sourceTilesOverlap[y.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const w=this.painter.context,I=w.gl;if(a.length<=1)return void(this._overlapStencilType=!1);let M;if(f.isTileClipped())M=a.length,this._overlapStencilMode.test={func:I.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(a[0].overscaledZ>a[a.length-1].overscaledZ))return void(this._overlapStencilType=!1);M=1,this._overlapStencilMode.test={func:I.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+M>255&&(w.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=M,this._overlapStencilMode.ref=this._stencilRef,f.isTileClipped()&&this._renderTileClippingMasks(a,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(e){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[e.key]),this._overlapStencilMode):sr.disabled}_renderTileClippingMasks(e,a){const f=this.painter,y=this.painter.context,w=y.gl;f._tileClippingMaskIDs={},y.setColorMode(yr.disabled),y.setDepthMode(zi.disabled);const I=f.getOrCreateProgram("clippingMask");for(const M of e){const L=f._tileClippingMaskIDs[M.key]=--a;I.draw(f,w.TRIANGLES,zi.disabled,new sr({func:w.ALWAYS,mask:0},L,255,w.KEEP,w.KEEP,w.REPLACE),yr.disabled,Qi.disabled,Uh(M.projMatrix),"$clipping",f.tileExtentBuffer,f.quadTriangleIndexBuffer,f.tileExtentSegments)}}pointCoordinate(e){const a=this.painter.transform;if(e.x<0||e.x>a.width||e.y<0||e.y>a.height)return null;const f=[e.x,e.y,1,1];i.aC(f,f,a.pixelMatrixInverse),i.cJ(f,f,1/f[3]),f[0]/=a.worldSize,f[1]/=a.worldSize;const y=a._camera.position,w=i.ce(1,a.center.lat),I=[y[0],y[1],y[2]/w,0],M=i.d9([],f.slice(0,3),I);i.aw(M,M);const L=this.raycast(I,M,this._exaggeration);return L!==null&&L?(i.bG(I,I,M,L),I[3]=I[2],I[2]*=w,I):null}_setupProxiedCoordsForOrtho(e,a,f){if(e.getSource()instanceof i.aT)return this._setupProxiedCoordsForImageSource(e,a,f);this._findCoveringTileCache[e.id]=this._findCoveringTileCache[e.id]||{};const y=this.proxiedCoords[e.id]=[],w=this.proxyCoords;for(let L=0;L<w.length;L++){const N=w[L],V=this._findTileCoveringTileID(N,e);if(V){const Z=this._createProxiedId(N,V,f[N.key]&&f[N.key][e.id]);y.push(Z),this.proxyToSource[N.key][e.id]=[Z]}}let I=!1;const M=new Set;for(let L=0;L<a.length;L++){const N=e.getTile(a[L]);if(!N||!N.hasData())continue;const V=this._findTileCoveringTileID(N.tileID,this.proxySourceCache);if(V&&V.tileID.canonical.z!==N.tileID.canonical.z){const Z=this.proxyToSource[V.tileID.key][e.id],U=this._createProxiedId(V.tileID,N,f[V.tileID.key]&&f[V.tileID.key][e.id]);Z?Z.splice(Z.length-1,0,U):this.proxyToSource[V.tileID.key][e.id]=[U];const X=this.proxyToSource[V.tileID.key][e.id];M.has(X)||M.add(X),y.push(U),I=!0}}if(this._sourceTilesOverlap[e.id]=I,I&&this._debugParams.sortTilesHiZFirst)for(const L of M)L.sort((N,V)=>V.overscaledZ-N.overscaledZ)}_setupProxiedCoordsForImageSource(e,a,f){if(!e.getSource().loaded())return;const y=this.proxiedCoords[e.id]=[],w=this.proxyCoords,I=e.getSource(),M=I.tileID;if(!M)return;const L=new i.P(M.x,M.y)._div(1<<M.z),N=I.coordinates.map(i.ae.fromLngLat).reduce((Z,U)=>(Z.min.x=Math.min(Z.min.x,U.x-L.x),Z.min.y=Math.min(Z.min.y,U.y-L.y),Z.max.x=Math.max(Z.max.x,U.x-L.x),Z.max.y=Math.max(Z.max.y,U.y-L.y),Z),{min:new i.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new i.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),V=(Z,U)=>{const X=Z.wrap+Z.canonical.x/(1<<Z.canonical.z),Q=Z.canonical.y/(1<<Z.canonical.z),nt=i.al/(1<<Z.canonical.z),ht=U.wrap+U.canonical.x/(1<<U.canonical.z),lt=U.canonical.y/(1<<U.canonical.z);return X+nt<ht+N.min.x||X>ht+N.max.x||Q+nt<lt+N.min.y||Q>lt+N.max.y};for(let Z=0;Z<w.length;Z++){const U=w[Z];for(let X=0;X<a.length;X++){const Q=e.getTile(a[X]);if(!Q||!Q.hasData()||V(U,Q.tileID))continue;const nt=this._createProxiedId(U,Q,f[U.key]&&f[U.key][e.id]),ht=this.proxyToSource[U.key][e.id];ht?ht.push(nt):this.proxyToSource[U.key][e.id]=[nt],y.push(nt)}}}_createProxiedId(e,a,f){let y=this.orthoMatrix;if(f){const w=f.find(I=>I.key===a.tileID.key);if(w)return w}if(a.tileID.key!==e.key){const w=e.canonical.z-a.tileID.canonical.z;let I,M,L;y=i.bB();const N=a.tileID.wrap-e.wrap<<e.overscaledZ;w>0?(I=i.al>>w,M=I*((a.tileID.canonical.x<<w)-e.canonical.x+N),L=I*((a.tileID.canonical.y<<w)-e.canonical.y)):(I=i.al<<-w,M=i.al*(a.tileID.canonical.x-(e.canonical.x+N<<-w)),L=i.al*(a.tileID.canonical.y-(e.canonical.y<<-w))),i.cd(y,0,I,0,I,0,1),i.bq(y,y,[M,L,0])}return new qs(a.tileID,e.key,y)}_findTileCoveringTileID(e,a){let f=a.getTile(e);if(f&&f.hasData())return f;const y=this._findCoveringTileCache[a.id],w=y[e.key];if(f=w?a.getTileByID(w):null,f&&f.hasData()||w===null)return f;let I=f?f.tileID:e,M=I.overscaledZ;const L=a.getSource().minzoom,N=[];if(!w){const Z=a.getSource().maxzoom;if(e.canonical.z>=Z){const U=e.canonical.z-Z;a.getSource().reparseOverscaled?(M=Math.max(e.canonical.z+2,a.transform.tileZoom),I=new i.aP(M,e.wrap,Z,e.canonical.x>>U,e.canonical.y>>U)):U!==0&&(M=Z,I=new i.aP(M,e.wrap,Z,e.canonical.x>>U,e.canonical.y>>U))}I.key!==e.key&&(N.push(I.key),f=a.getTile(I))}const V=Z=>{N.forEach(U=>{y[U]=Z}),N.length=0};for(M-=1;M>=L&&(!f||!f.hasData());M--){f&&V(f.tileID.key);const Z=I.calculateScaledKey(M);if(f=a.getTileByID(Z),f&&f.hasData())break;const U=y[Z];if(U===null)break;U===void 0?N.push(Z):f=a.getTileByID(U)}return V(f?f.tileID.key:null),f&&f.hasData()?f:null}findDEMTileFor(e){return this.enabled?this._findTileCoveringTileID(e,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(e,a){let f=this._tilesDirty[e];f||(f=this._tilesDirty[e]={}),f[a.key]=!0}}function Yo(p,e,a){const f=function(M,L,N){const V=i.bI(L,M),Z=i.bI(N,[.2126,.7152,.0722]),U=(Q,nt,ht)=>(1-ht)*Q+ht*nt,X=U(1-.3*Math.min(Z,1),1,Math.min(V+1,1));return U(.92,1,Math.asin(i.aA(L[2],-1,1))/Math.PI+.5)*X}(p,[0,0,1],e),y=[0,0,0];i.c4(y,a.slice(0,3),f);const w=[0,0,0];i.c4(w,e.slice(0,3),p[2]);const I=[0,0,0];return i.d7(I,y,w),i.da(I)}const yu=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],oh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Vd{static cacheKey(e,a,f,y){let w=`${a}${y?y.cacheKey:""}`;for(const I of f)e.usedDefines.includes(I)&&(w+=`/${I}`);return w}constructor(e,a,f,y,w,I){const M=e.gl;this.program=M.createProgram(),this.configuration=y,this.name=a,this.fixedDefines=[...I];let L=y?y.defines():[];L=L.concat(I.map(Q=>`#define ${Q}`));const N=`#version 300 es
`;let V=N+L.concat("precision mediump float;",zc,Lh.fragmentSource).join(`
`);for(const Q of f.fragmentIncludes)V+=`
${zh[Q]}`;V+=`
${f.fragmentSource}`;let Z=N+L.concat("precision highp float;",zc,Lh.vertexSource).join(`
`);for(const Q of f.vertexIncludes)Z+=`
${zh[Q]}`;this.forceManualRenderingForInstanceIDShaders=e.forceManualRenderingForInstanceIDShaders&&f.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(Z+=`
uniform int u_instanceID;
`),Z+=`
${f.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(Z=Z.replaceAll("gl_InstanceID","u_instanceID"));const U=M.createShader(M.FRAGMENT_SHADER);if(M.isContextLost())return void(this.failedToCreate=!0);M.shaderSource(U,V),M.compileShader(U),M.attachShader(this.program,U);const X=M.createShader(M.VERTEX_SHADER);M.isContextLost()?this.failedToCreate=!0:(M.shaderSource(X,Z),M.compileShader(X),M.attachShader(this.program,X),this.attributes={},M.linkProgram(this.program),M.deleteShader(X),M.deleteShader(U),this.fixedUniforms=w(e),this.binderUniforms=y?y.getUniforms(e):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(Q=>({u_instanceID:new i.cg(Q)}))(e)),(I.includes("TERRAIN")||a.indexOf("symbol")!==-1||a.indexOf("circle")!==-1)&&(this.terrainUniforms=(Q=>({u_dem:new i.cg(Q),u_dem_prev:new i.cg(Q),u_dem_tl:new i.cj(Q),u_dem_scale:new i.ci(Q),u_dem_tl_prev:new i.cj(Q),u_dem_scale_prev:new i.ci(Q),u_dem_size:new i.ci(Q),u_dem_lerp:new i.ci(Q),u_exaggeration:new i.ci(Q),u_depth:new i.cg(Q),u_depth_size_inv:new i.cj(Q),u_depth_range_unpack:new i.cj(Q),u_occluder_half_size:new i.ci(Q),u_occlusion_depth_offset:new i.ci(Q),u_meter_to_dem:new i.ci(Q),u_label_plane_matrix_inv:new i.ck(Q)}))(e)),I.includes("GLOBE")&&(this.globeUniforms=(Q=>({u_tile_tl_up:new i.ch(Q),u_tile_tr_up:new i.ch(Q),u_tile_br_up:new i.ch(Q),u_tile_bl_up:new i.ch(Q),u_tile_up_scale:new i.ci(Q)}))(e)),I.includes("FOG")&&(this.fogUniforms=(Q=>({u_fog_matrix:new i.ck(Q),u_fog_range:new i.cj(Q),u_fog_color:new i.d2(Q),u_fog_horizon_blend:new i.ci(Q),u_fog_vertical_limit:new i.cj(Q),u_fog_temporal_offset:new i.ci(Q),u_frustum_tl:new i.ch(Q),u_frustum_tr:new i.ch(Q),u_frustum_br:new i.ch(Q),u_frustum_bl:new i.ch(Q),u_globe_pos:new i.ch(Q),u_globe_radius:new i.ci(Q),u_globe_transition:new i.ci(Q),u_is_globe:new i.cg(Q),u_viewport:new i.cj(Q)}))(e)),I.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(Q=>({u_cutoff_params:new i.d2(Q)}))(e)),I.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(Q=>({u_lighting_ambient_color:new i.ch(Q),u_lighting_directional_dir:new i.ch(Q),u_lighting_directional_color:new i.ch(Q),u_ground_radiance:new i.ch(Q)}))(e)),I.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(Q=>({u_light_matrix_0:new i.ck(Q),u_light_matrix_1:new i.ck(Q),u_fade_range:new i.cj(Q),u_shadow_normal_offset:new i.ch(Q),u_shadow_intensity:new i.ci(Q),u_shadow_texel_size:new i.ci(Q),u_shadow_map_resolution:new i.ci(Q),u_shadow_direction:new i.ch(Q),u_shadow_bias:new i.ch(Q),u_shadowmap_0:new i.cg(Q),u_shadowmap_1:new i.cg(Q)}))(e)))}getAttributeLocation(e,a){let f=this.attributes[a];return f===void 0&&(f=this.attributes[a]=e.getAttribLocation(this.program,a)),f}setTerrainUniformValues(e,a){if(!this.terrainUniforms)return;const f=this.terrainUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y]&&f[y].set(this.program,y,a[y])}}setGlobeUniformValues(e,a){if(!this.globeUniforms)return;const f=this.globeUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y]&&f[y].set(this.program,y,a[y])}}setFogUniformValues(e,a){if(!this.fogUniforms)return;const f=this.fogUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}}setCutoffUniformValues(e,a){if(!this.cutoffUniforms)return;const f=this.cutoffUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}}setLightsUniformValues(e,a){if(!this.lightsUniforms)return;const f=this.lightsUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}}setShadowUniformValues(e,a){if(this.failedToCreate||!this.shadowUniforms)return;const f=this.shadowUniforms;e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}_drawDebugWireframe(e,a,f,y,w,I,M,L,N,V){const Z=e.options.wireframe;if(Z.terrain===!1&&Z.layers2D===!1&&Z.layers3D===!1)return;const U=e.context;if(!(!(!Z.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!Z.layers2D||e._terrain&&e._terrain.renderingToTexture||!yu.includes(this.name))||!(!Z.layers3D||!oh.includes(this.name))))return;const X=U.gl,Q=e.wireframeDebugCache.getLinesFromTrianglesBuffer(e.frameCounter,w,U);if(!Q)return;const nt=[...this.fixedDefines];nt.push("DEBUG_WIREFRAME");const ht=e.getOrCreateProgram(this.name,{config:this.configuration,defines:nt});U.program.set(ht.program);const lt=(bt,Gt,zt)=>{if(Gt[bt]&&zt[bt])for(const Zt in Gt[bt])zt[bt][Zt]&&zt[bt][Zt].set(zt.program,Zt,Gt[bt][Zt].current)};N&&N.setUniforms(ht.program,U,ht.binderUniforms,M,{zoom:L}),lt("fixedUniforms",this,ht),lt("terrainUniforms",this,ht),lt("globeUniforms",this,ht),lt("fogUniforms",this,ht),lt("lightsUniforms",this,ht),lt("shadowUniforms",this,ht),Q.bind(),U.setColorMode(new yr([X.ONE,X.ONE_MINUS_SRC_ALPHA,X.ZERO,X.ONE],i.ao.transparent,[!0,!0,!0,!1])),U.setDepthMode(new zi(a.func===X.LESS?X.LEQUAL:a.func,zi.ReadOnly,a.range)),U.setStencilMode(sr.disabled);const _t=3*I.primitiveLength*2,Ct=3*I.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const bt=V||1;for(let Gt=0;Gt<bt;++Gt)ht.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Gt),X.drawElements(X.LINES,_t,X.UNSIGNED_SHORT,Ct)}else V&&V>1?X.drawElementsInstanced(X.LINES,_t,X.UNSIGNED_SHORT,Ct,V):X.drawElements(X.LINES,_t,X.UNSIGNED_SHORT,Ct);w.bind(),U.program.set(this.program),U.setDepthMode(a),U.setStencilMode(f),U.setColorMode(y)}checkUniforms(e,a,f){if(this.fixedDefines.includes(a)){for(const y of Object.keys(f))if(!f[y].initialized)throw new Error(`Program '${this.name}', from draw '${e}': uniform ${y} not set but required by ${a} being defined`)}}draw(e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht){const lt=e.context,_t=lt.gl;if(this.failedToCreate)return;lt.program.set(this.program),lt.setDepthMode(f),lt.setStencilMode(y),lt.setColorMode(w),lt.setCullFace(I);for(const Gt of Object.keys(this.fixedUniforms))this.fixedUniforms[Gt].set(this.program,Gt,M[Gt]);Q&&Q.setUniforms(this.program,lt,this.binderUniforms,U,{zoom:X});const Ct={[_t.POINTS]:1,[_t.LINES]:2,[_t.TRIANGLES]:3,[_t.LINE_STRIP]:1}[a];this.checkUniforms(L,"RENDER_SHADOWS",this.shadowUniforms);const bt=ht&&ht>0?1:void 0;for(const Gt of Z.get()){const zt=Gt.vaos||(Gt.vaos={});if((zt[L]||(zt[L]=new Wu)).bind(lt,this,N,Q?Q.getPaintVertexBuffers():[],V,Gt.vertexOffset,nt||[],bt),this.forceManualRenderingForInstanceIDShaders){const Zt=ht||1;for(let Vt=0;Vt<Zt;++Vt)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Vt),V?_t.drawElements(a,Gt.primitiveLength*Ct,_t.UNSIGNED_SHORT,Gt.primitiveOffset*Ct*2):_t.drawArrays(a,Gt.vertexOffset,Gt.vertexLength)}else ht&&ht>1?_t.drawElementsInstanced(a,Gt.primitiveLength*Ct,_t.UNSIGNED_SHORT,Gt.primitiveOffset*Ct*2,ht):V?_t.drawElements(a,Gt.primitiveLength*Ct,_t.UNSIGNED_SHORT,Gt.primitiveOffset*Ct*2):_t.drawArrays(a,Gt.vertexOffset,Gt.vertexLength);a===_t.TRIANGLES&&V&&this._drawDebugWireframe(e,f,y,w,V,Gt,U,X,Q,ht)}}}function wp(p,e,a=0){const f=Math.pow(2,e.tileID.overscaledZ),y=e.tileSize*Math.pow(2,p.transform.tileZoom)/f,w=y*(e.tileID.canonical.x+e.tileID.wrap*f),I=y*e.tileID.canonical.y;return{u_image:0,u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/i.ay(e,1,p.transform.tileZoom),u_pixel_coord_upper:[w>>16,I>>16],u_pixel_coord_lower:[65535&w,65535&I],u_pattern_transition:a}}const Fc={terrain:0,flat:1},Ud=i.bB(),xu=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt)=>{const _t=e.style.light,Ct=_t.properties.get("position"),bt=[Ct.x,Ct.y,Ct.z],Gt=i.dN();_t.properties.get("anchor")==="viewport"&&(i.dO(Gt,-e.transform.angle),i.dP(bt,bt,Gt));const zt=_t.properties.get("color").toPremultipliedRenderColor(null),Zt=e.transform,Vt={u_matrix:p,u_lightpos:bt,u_lightintensity:_t.properties.get("intensity"),u_lightcolor:[zt.r,zt.g,zt.b],u_vertical_gradient:+a,u_opacity:f,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Ud,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Fc[N],u_base_type:Fc[V],u_ao:y,u_edge_radius:w,u_width_scale:I,u_flood_light_color:Q,u_vertical_scale:nt,u_flood_light_intensity:ht,u_ground_shadow_factor:lt};return Zt.projection.name==="globe"&&(Vt.u_tile_id=[M.canonical.x,M.canonical.y,1<<M.canonical.z],Vt.u_zoom_transition=Z,Vt.u_inv_rot_matrix=X,Vt.u_merc_center=U,Vt.u_up_dir=Zt.projection.upVector(new i.cC(0,0,0),U[0]*i.al,U[1]*i.al),Vt.u_height_lift=L),Vt},id=(p,e,a,f,y,w)=>({u_matrix:p,u_edge_radius:e,u_width_scale:a,u_vertical_scale:f,u_height_type:Fc[y],u_base_type:Fc[w]}),Yl=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt)=>{const _t=xu(p,e,a,f,y,w,I,M,N,V,Z,U,X,Q,nt,ht,1,[0,0,0]),Ct={u_height_factor:-Math.pow(2,M.overscaledZ)/L.tileSize/8};return Object.assign(_t,wp(e,L,lt),Ct)},Ki=(p,e,a,f,y,w,I,M,L,N,V)=>({u_matrix:e,u_opacity:a,u_ao_pass:f?1:0,u_meter_to_tile:y,u_ao:w,u_flood_light_intensity:I,u_flood_light_color:M,u_attenuation:L,u_edge_radius:N,u_fb:0,u_fb_size:V,u_dynamic_offset:1}),vu=(p,e,a)=>({u_matrix:p,u_emissive_strength:e,u_ground_shadow_factor:a}),Tp=(p,e,a,f,y,w=0)=>Object.assign(vu(p,e,y),wp(a,f,w)),Wf=(p,e,a,f)=>({u_matrix:p,u_world:a,u_emissive_strength:e,u_ground_shadow_factor:f}),jd=(p,e,a,f,y,w,I=0)=>Object.assign(Tp(p,e,a,f,w,I),{u_world:y}),sh=(p,e)=>({u_matrix:p,u_ground_shadow_factor:e}),rd=(p,e,a,f,y)=>({u_matrix:p,u_camera_pos:[e[0],e[1],e[2]],u_depth_bias:a,u_height_scale:f,u_reset_depth:y}),ff=(p,e,a,f,y,w,I,M,L)=>({u_matrix:p,u_normal_matrix:e,u_opacity:a,u_faux_facade_ao_intensity:f,u_camera_pos:y,u_tile_to_meter:w,u_facade_emissive_chance:I,u_flood_light_color:M,u_flood_light_intensity:L}),jh=p=>({u_matrix:p}),mf=p=>({u_matrix:p}),Bc=(p,e,a,f,y,w,I,M)=>{const L=i.al/w.tileSize;return{u_matrix:p,u_inv_rot_matrix:e,u_camera_to_center_distance:a.getCameraToCenterDistance(M),u_extrude_scale:[a.pixelsToGLUnits[0]/L,a.pixelsToGLUnits[1]/L],u_zoom_transition:f,u_tile_id:I,u_merc_center:y}},nd=(p,e,a=1)=>({u_matrix:p,u_color:e,u_overlay:0,u_overlay_scale:a}),Sp=i.bB(),gf=(p,e,a,f,y,w,I)=>{const M=p.transform,L=M.projection.name==="globe",N=L?i.dQ(M.zoom,e.canonical)*M._pixelsPerMercatorPixel:i.ay(a,1,w),V={u_matrix:e.projMatrix,u_extrude_scale:N,u_intensity:I,u_inv_rot_matrix:Sp,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(L){V.u_inv_rot_matrix=f,V.u_merc_center=y,V.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],V.u_zoom_transition=i.aj(M.zoom);const Z=y[0]*i.al,U=y[1]*i.al;V.u_up_dir=M.projection.upVector(new i.cC(0,0,0),Z,U)}return V};function Gd(p,[e,a,f,y],[w,I]){if(w===I)return[0,0,0,0];const M=255*(p-1)/(p*(I-w));return[e*M,a*M,f*M,y*M]}function dc(p,e,[a,f]){return a===f?0:.5/p+(e-a)*(p-1)/(p*(f-a))}const bu=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt,_t,Ct,bt)=>({u_matrix:p,u_normalize_matrix:e,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:y,u_tl_parent:w,u_scale_parent:N,u_fade_t:V.mix,u_opacity:V.opacity*Z.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:Z.paint.get("raster-brightness-min"),u_brightness_high:Z.paint.get("raster-brightness-max"),u_saturation_factor:i.dS(Z.paint.get("raster-saturation")),u_contrast_factor:i.dR(Z.paint.get("raster-contrast")),u_spin_weights:od(Z.paint.get("raster-hue-rotate")),u_perspective_transform:U,u_raster_elevation:X,u_zoom_transition:I,u_merc_center:M,u_cutoff_params:L,u_colorization_mix:Gd(i.dT,nt,lt),u_colorization_offset:dc(i.dT,ht,lt),u_color_ramp:Q,u_texture_offset:[Ct/(_t+2*Ct),_t/(_t+2*Ct)],u_texture_res:[_t+2*Ct,_t+2*Ct],u_emissive_strength:bt});function od(p){p*=Math.PI/180;const e=Math.sin(p),a=Math.cos(p);return[(2*a+1)/3,(-Math.sqrt(3)*e-a+1)/3,(Math.sqrt(3)*e-a+1)/3]}const wu=.05,ah=(p,e,a,f,y,w,I,M,L,N,V,Z)=>({u_matrix:p,u_normalize_matrix:e,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:y,u_tl_parent:w,u_scale_parent:N,u_fade_t:V.mix,u_opacity:V.opacity,u_image0:0,u_image1:1,u_raster_elevation:Z,u_zoom_transition:I,u_merc_center:M,u_cutoff_params:L}),Oc=(p,e,a,f,y,w,I,M,L,N)=>({u_particle_texture:p,u_particle_texture_side_len:e,u_tile_offset:a,u_velocity:f,u_color_ramp:w,u_velocity_res:y,u_max_speed:I,u_uv_offset:M,u_data_scale:[255*L[0],255*L[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[wu,wu]}),uo=(p,e,a,f,y,w,I,M,L,N)=>({u_particle_texture:p,u_particle_texture_side_len:e,u_velocity:a,u_velocity_res:f,u_max_speed:y,u_speed_factor:w,u_reset_rate:I,u_rand_seed:Math.random(),u_uv_offset:M,u_data_scale:[255*L[0],255*L[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[wu,wu]}),_f=i.bB(),Tu=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt,_t,Ct,bt,Gt,zt,Zt)=>{const Vt=y.transform,kt={u_is_size_zoom_constant:+(p==="constant"||p==="source"),u_is_size_feature_constant:+(p==="constant"||p==="camera"),u_size_t:e?e.uSizeT:0,u_size:e?e.uSize:0,u_camera_to_center_distance:Vt.getCameraToCenterDistance(_t),u_rotate_symbol:+a,u_aspect_ratio:Vt.width/Vt.height,u_fade_change:y.options.fadeDuration?y.symbolFadeChange:1,u_matrix:w,u_label_plane_matrix:I,u_coord_matrix:M,u_is_text:+N,u_elevation_from_sea:L?1:0,u_pitch_with_map:+f,u_texsize:V,u_texsize_icon:Z,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:_f,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:_f,u_up_vector:[0,-1,0],u_color_adj_mat:Gt,u_icon_transition:zt||0,u_gamma_scale:f?y.transform.getCameraToCenterDistance(_t)*Math.cos(y.terrain?0:y.transform._pitch):1,u_device_pixel_ratio:i.o.devicePixelRatio,u_is_halo:1,u_scale_factor:Zt||1,u_ground_shadow_factor:Ct,u_inv_matrix:i.bk(i.bB(),I),u_normal_scale:bt,u_lutTexture:ms.LUT};return _t.name==="globe"&&(kt.u_tile_id=[X.canonical.x,X.canonical.y,1<<X.canonical.z],kt.u_zoom_transition=Q,kt.u_inv_rot_matrix=ht,kt.u_merc_center=nt,kt.u_camera_forward=Vt._camera.forward(),kt.u_ecef_origin=i.dU(Vt.globeMatrix,X.toUnwrapped()),kt.u_tile_matrix=Float32Array.from(Vt.globeMatrix),kt.u_up_vector=lt),kt},Gh=(p,e,a,f)=>({u_matrix:p,u_emissive_strength:e,u_opacity:a,u_color:f}),sd=(p,e,a,f,y,w,I,M,L)=>Object.assign(function(N,V,Z,U,X,Q){const{width:nt,height:ht}=U.imageManager.getPixelSize(V),lt=Math.pow(2,Q.tileID.overscaledZ),_t=Q.tileSize*Math.pow(2,U.transform.tileZoom)/lt,Ct=_t*(Q.tileID.canonical.x+Q.tileID.wrap*lt),bt=_t*Q.tileID.canonical.y;return{u_image:0,u_pattern_tl:Z.tl,u_pattern_br:Z.br,u_texsize:[nt,ht],u_pattern_size:Z.displaySize,u_pattern_units_to_pixels:X?[U.transform.width,-1*U.transform.height]:[1/i.ay(Q,1,U.transform.tileZoom),1/i.ay(Q,1,U.transform.tileZoom)],u_pixel_coord_upper:[Ct>>16,bt>>16],u_pixel_coord_lower:[65535&Ct,65535&bt]}}(0,w,I,f,M,L),{u_matrix:p,u_emissive_strength:e,u_opacity:a}),Ip=new Float32Array(i.bz([])),ad=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X=[0,0,0],Q,nt,ht)=>{const lt=y.style.light,_t=lt.properties.get("position"),Ct=[-_t.x,-_t.y,_t.z],bt=i.dN();lt.properties.get("anchor")==="viewport"&&(i.dO(bt,-y.transform.angle),i.dP(Ct,Ct,bt));const Gt=V.alphaMode==="MASK",zt=lt.properties.get("color").toNonPremultipliedRenderColor(null),Zt=U.paint.get("model-ambient-occlusion-intensity"),Vt=U.paint.get("model-color").constantOr(i.ao.white).toNonPremultipliedRenderColor(null);return Vt.a=U.paint.get("model-color-mix-intensity").constantOr(0),ht&&(Vt.r=ht[0],Vt.g=ht[1],Vt.b=ht[2],Vt.a=ht[3]),nt&&(Vt.r=nt.color.r,Vt.g=nt.color.g,Vt.b=nt.color.b,Vt.a=nt.colorMix,Z=nt.emissionStrength,w=nt.opacity),{u_matrix:p,u_lighting_matrix:e,u_normal_matrix:a,u_node_matrix:f||Ip,u_lightpos:Ct,u_lightintensity:lt.properties.get("intensity"),u_lightcolor:[zt.r,zt.g,zt.b],u_camera_pos:X,u_opacity:w,u_baseTextureIsAlpha:0,u_alphaMask:+Gt,u_alphaCutoff:V.alphaCutoff,u_baseColorFactor:I.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:M.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:L,u_roughnessFactor:N,u_baseColorTexture:ms.BaseColor,u_metallicRoughnessTexture:ms.MetallicRoughness,u_normalTexture:ms.Normal,u_occlusionTexture:ms.Occlusion,u_emissionTexture:ms.Emission,u_lutTexture:ms.LUT,u_color_mix:Vt.toArray01(),u_aoIntensity:Zt,u_emissive_strength:Z,u_occlusionTextureTransform:Q||[0,0,0,0]}},$h=(p,e=Ip,a=Ip)=>({u_matrix:p,u_instance:e,u_node_matrix:a}),Xf={fillExtrusion:p=>({u_matrix:new i.ck(p),u_lightpos:new i.ch(p),u_lightintensity:new i.ci(p),u_lightcolor:new i.ch(p),u_vertical_gradient:new i.ci(p),u_opacity:new i.ci(p),u_edge_radius:new i.ci(p),u_width_scale:new i.ci(p),u_ao:new i.cj(p),u_height_type:new i.cg(p),u_base_type:new i.cg(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_up_dir:new i.ch(p),u_height_lift:new i.ci(p),u_flood_light_color:new i.ch(p),u_vertical_scale:new i.ci(p),u_flood_light_intensity:new i.ci(p),u_ground_shadow_factor:new i.ch(p)}),fillExtrusionDepth:p=>({u_matrix:new i.ck(p),u_edge_radius:new i.ci(p),u_width_scale:new i.ci(p),u_vertical_scale:new i.ci(p),u_height_type:new i.cg(p),u_base_type:new i.cg(p)}),fillExtrusionPattern:p=>({u_matrix:new i.ck(p),u_lightpos:new i.ch(p),u_lightintensity:new i.ci(p),u_lightcolor:new i.ch(p),u_vertical_gradient:new i.ci(p),u_height_factor:new i.ci(p),u_edge_radius:new i.ci(p),u_width_scale:new i.ci(p),u_ao:new i.cj(p),u_height_type:new i.cg(p),u_base_type:new i.cg(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_up_dir:new i.ch(p),u_height_lift:new i.ci(p),u_image:new i.cg(p),u_texsize:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_tile_units_to_pixels:new i.ci(p),u_opacity:new i.ci(p),u_pattern_transition:new i.ci(p)}),fillExtrusionGroundEffect:p=>({u_matrix:new i.ck(p),u_opacity:new i.ci(p),u_ao_pass:new i.ci(p),u_meter_to_tile:new i.ci(p),u_ao:new i.cj(p),u_flood_light_intensity:new i.ci(p),u_flood_light_color:new i.ch(p),u_attenuation:new i.ci(p),u_edge_radius:new i.ci(p),u_fb:new i.cg(p),u_fb_size:new i.ci(p),u_dynamic_offset:new i.ci(p)}),fill:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_ground_shadow_factor:new i.ch(p)}),fillPattern:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_image:new i.cg(p),u_texsize:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_tile_units_to_pixels:new i.ci(p),u_ground_shadow_factor:new i.ch(p),u_pattern_transition:new i.ci(p)}),fillOutline:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_world:new i.cj(p),u_ground_shadow_factor:new i.ch(p)}),fillOutlinePattern:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_world:new i.cj(p),u_image:new i.cg(p),u_texsize:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_tile_units_to_pixels:new i.ci(p),u_ground_shadow_factor:new i.ch(p),u_pattern_transition:new i.ci(p)}),building:p=>({u_matrix:new i.ck(p),u_normal_matrix:new i.ck(p),u_opacity:new i.ci(p),u_faux_facade_ao_intensity:new i.ci(p),u_camera_pos:new i.ch(p),u_tile_to_meter:new i.ci(p),u_facade_emissive_chance:new i.ci(p),u_flood_light_color:new i.ch(p),u_flood_light_intensity:new i.ci(p)}),buildingBloom:p=>({u_matrix:new i.ck(p)}),buildingDepth:p=>({u_matrix:new i.ck(p)}),elevatedStructuresDepth:p=>({u_matrix:new i.ck(p),u_depth_bias:new i.ci(p)}),elevatedStructures:p=>({u_matrix:new i.ck(p),u_ground_shadow_factor:new i.ch(p)}),elevatedStructuresDepthReconstruct:p=>({u_matrix:new i.ck(p),u_camera_pos:new i.ch(p),u_depth_bias:new i.ci(p),u_height_scale:new i.ci(p),u_reset_depth:new i.ci(p)}),circle:i.dX,collisionBox:p=>({u_matrix:new i.ck(p),u_inv_rot_matrix:new i.ck(p),u_camera_to_center_distance:new i.ci(p),u_extrude_scale:new i.cj(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_tile_id:new i.ch(p)}),collisionCircle:p=>({u_matrix:new i.ck(p),u_inv_matrix:new i.ck(p),u_camera_to_center_distance:new i.ci(p),u_viewport_size:new i.cj(p)}),debug:p=>({u_color:new i.dA(p),u_matrix:new i.ck(p),u_overlay:new i.cg(p),u_overlay_scale:new i.ci(p)}),clippingMask:p=>({u_matrix:new i.ck(p)}),heatmap:p=>({u_extrude_scale:new i.ci(p),u_intensity:new i.ci(p),u_matrix:new i.ck(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_up_dir:new i.ch(p)}),heatmapTexture:p=>({u_image:new i.cg(p),u_color_ramp:new i.cg(p),u_opacity:new i.ci(p)}),hillshade:p=>({u_matrix:new i.ck(p),u_image:new i.cg(p),u_latrange:new i.cj(p),u_light:new i.cj(p),u_shadow:new i.dA(p),u_highlight:new i.dA(p),u_emissive_strength:new i.ci(p),u_accent:new i.dA(p)}),hillshadePrepare:p=>({u_matrix:new i.ck(p),u_image:new i.cg(p),u_dimension:new i.cj(p),u_zoom:new i.ci(p)}),line:i.dW,linePattern:i.dV,raster:p=>({u_matrix:new i.ck(p),u_normalize_matrix:new i.ck(p),u_globe_matrix:new i.ck(p),u_merc_matrix:new i.ck(p),u_grid_matrix:new i.dB(p),u_tl_parent:new i.cj(p),u_scale_parent:new i.ci(p),u_fade_t:new i.ci(p),u_opacity:new i.ci(p),u_image0:new i.cg(p),u_image1:new i.cg(p),u_brightness_low:new i.ci(p),u_brightness_high:new i.ci(p),u_saturation_factor:new i.ci(p),u_contrast_factor:new i.ci(p),u_spin_weights:new i.ch(p),u_perspective_transform:new i.cj(p),u_raster_elevation:new i.ci(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_cutoff_params:new i.d2(p),u_colorization_mix:new i.d2(p),u_colorization_offset:new i.ci(p),u_color_ramp:new i.cg(p),u_texture_offset:new i.cj(p),u_texture_res:new i.cj(p),u_emissive_strength:new i.ci(p)}),rasterParticle:p=>({u_matrix:new i.ck(p),u_normalize_matrix:new i.ck(p),u_globe_matrix:new i.ck(p),u_merc_matrix:new i.ck(p),u_grid_matrix:new i.dB(p),u_tl_parent:new i.cj(p),u_scale_parent:new i.ci(p),u_fade_t:new i.ci(p),u_opacity:new i.ci(p),u_image0:new i.cg(p),u_image1:new i.cg(p),u_raster_elevation:new i.ci(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_cutoff_params:new i.d2(p)}),rasterParticleTexture:p=>({u_texture:new i.cg(p),u_opacity:new i.ci(p)}),rasterParticleDraw:p=>({u_particle_texture:new i.cg(p),u_particle_texture_side_len:new i.ci(p),u_tile_offset:new i.cj(p),u_velocity:new i.cg(p),u_color_ramp:new i.cg(p),u_velocity_res:new i.cj(p),u_max_speed:new i.ci(p),u_uv_offset:new i.cj(p),u_data_scale:new i.cj(p),u_data_offset:new i.ci(p),u_particle_pos_scale:new i.ci(p),u_particle_pos_offset:new i.cj(p)}),rasterParticleUpdate:p=>({u_particle_texture:new i.cg(p),u_particle_texture_side_len:new i.ci(p),u_velocity:new i.cg(p),u_velocity_res:new i.cj(p),u_max_speed:new i.ci(p),u_speed_factor:new i.ci(p),u_reset_rate:new i.ci(p),u_rand_seed:new i.ci(p),u_uv_offset:new i.cj(p),u_data_scale:new i.cj(p),u_data_offset:new i.ci(p),u_particle_pos_scale:new i.ci(p),u_particle_pos_offset:new i.cj(p)}),symbol:p=>({u_is_size_zoom_constant:new i.cg(p),u_is_size_feature_constant:new i.cg(p),u_size_t:new i.ci(p),u_size:new i.ci(p),u_camera_to_center_distance:new i.ci(p),u_rotate_symbol:new i.cg(p),u_aspect_ratio:new i.ci(p),u_fade_change:new i.ci(p),u_matrix:new i.ck(p),u_label_plane_matrix:new i.ck(p),u_coord_matrix:new i.ck(p),u_is_text:new i.cg(p),u_elevation_from_sea:new i.cg(p),u_pitch_with_map:new i.cg(p),u_texsize:new i.cj(p),u_texsize_icon:new i.cj(p),u_texture:new i.cg(p),u_texture_icon:new i.cg(p),u_gamma_scale:new i.ci(p),u_device_pixel_ratio:new i.ci(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_camera_forward:new i.ch(p),u_tile_matrix:new i.ck(p),u_up_vector:new i.ch(p),u_ecef_origin:new i.ch(p),u_is_halo:new i.cg(p),u_icon_transition:new i.ci(p),u_color_adj_mat:new i.ck(p),u_scale_factor:new i.ci(p),u_ground_shadow_factor:new i.ch(p),u_inv_matrix:new i.ck(p),u_normal_scale:new i.ci(p),u_lutTexture:new i.cg(p)}),background:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_opacity:new i.ci(p),u_color:new i.dA(p)}),backgroundPattern:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_opacity:new i.ci(p),u_image:new i.cg(p),u_pattern_tl:new i.cj(p),u_pattern_br:new i.cj(p),u_texsize:new i.cj(p),u_pattern_size:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_pattern_units_to_pixels:new i.cj(p)}),terrainRaster:p=>({u_matrix:new i.ck(p),u_image0:new i.cg(p),u_skirt_height:new i.ci(p),u_ground_shadow_factor:new i.ch(p)}),skybox:p=>({u_matrix:new i.ck(p),u_sun_direction:new i.ch(p),u_cubemap:new i.cg(p),u_opacity:new i.ci(p),u_temporal_offset:new i.ci(p)}),skyboxGradient:p=>({u_matrix:new i.ck(p),u_color_ramp:new i.cg(p),u_center_direction:new i.ch(p),u_radius:new i.ci(p),u_opacity:new i.ci(p),u_temporal_offset:new i.ci(p)}),skyboxCapture:p=>({u_matrix_3f:new i.dB(p),u_sun_direction:new i.ch(p),u_sun_intensity:new i.ci(p),u_color_tint_r:new i.d2(p),u_color_tint_m:new i.d2(p),u_luminance:new i.ci(p)}),globeRaster:p=>({u_proj_matrix:new i.ck(p),u_globe_matrix:new i.ck(p),u_normalize_matrix:new i.ck(p),u_merc_matrix:new i.ck(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_image0:new i.cg(p),u_grid_matrix:new i.dB(p),u_skirt_height:new i.ci(p),u_far_z_cutoff:new i.ci(p),u_frustum_tl:new i.ch(p),u_frustum_tr:new i.ch(p),u_frustum_br:new i.ch(p),u_frustum_bl:new i.ch(p),u_globe_pos:new i.ch(p),u_globe_radius:new i.ci(p),u_viewport:new i.cj(p)}),globeAtmosphere:p=>({u_frustum_tl:new i.ch(p),u_frustum_tr:new i.ch(p),u_frustum_br:new i.ch(p),u_frustum_bl:new i.ch(p),u_horizon:new i.ci(p),u_transition:new i.ci(p),u_fadeout_range:new i.ci(p),u_atmosphere_fog_color:new i.d2(p),u_high_color:new i.d2(p),u_space_color:new i.d2(p),u_temporal_offset:new i.ci(p),u_horizon_angle:new i.ci(p)}),model:p=>({u_matrix:new i.ck(p),u_lighting_matrix:new i.ck(p),u_normal_matrix:new i.ck(p),u_node_matrix:new i.ck(p),u_lightpos:new i.ch(p),u_lightintensity:new i.ci(p),u_lightcolor:new i.ch(p),u_camera_pos:new i.ch(p),u_opacity:new i.ci(p),u_baseColorFactor:new i.d2(p),u_emissiveFactor:new i.d2(p),u_metallicFactor:new i.ci(p),u_roughnessFactor:new i.ci(p),u_baseTextureIsAlpha:new i.cg(p),u_alphaMask:new i.cg(p),u_alphaCutoff:new i.ci(p),u_baseColorTexture:new i.cg(p),u_metallicRoughnessTexture:new i.cg(p),u_normalTexture:new i.cg(p),u_occlusionTexture:new i.cg(p),u_emissionTexture:new i.cg(p),u_lutTexture:new i.cg(p),u_color_mix:new i.d2(p),u_aoIntensity:new i.ci(p),u_emissive_strength:new i.ci(p),u_occlusionTextureTransform:new i.d2(p)}),modelDepth:p=>({u_matrix:new i.ck(p),u_instance:new i.ck(p),u_node_matrix:new i.ck(p)}),groundShadow:p=>({u_matrix:new i.ck(p),u_ground_shadow_factor:new i.ch(p)}),stars:p=>({u_matrix:new i.ck(p),u_up:new i.ch(p),u_right:new i.ch(p),u_intensity_multiplier:new i.ci(p)}),snowParticle:p=>({u_modelview:new i.ck(p),u_projection:new i.ck(p),u_time:new i.ci(p),u_cam_pos:new i.ch(p),u_velocityConeAperture:new i.ci(p),u_velocity:new i.ci(p),u_horizontalOscillationRadius:new i.ci(p),u_horizontalOscillationRate:new i.ci(p),u_boxSize:new i.ci(p),u_billboardSize:new i.ci(p),u_simpleShapeParameters:new i.cj(p),u_screenSize:new i.cj(p),u_thinningCenterPos:new i.cj(p),u_thinningShape:new i.ch(p),u_thinningAffectedRatio:new i.ci(p),u_thinningParticleOffset:new i.ci(p),u_particleColor:new i.d2(p),u_direction:new i.ch(p)}),rainParticle:p=>({u_modelview:new i.ck(p),u_projection:new i.ck(p),u_time:new i.ci(p),u_cam_pos:new i.ch(p),u_texScreen:new i.cg(p),u_velocityConeAperture:new i.ci(p),u_velocity:new i.ci(p),u_boxSize:new i.ci(p),u_rainDropletSize:new i.cj(p),u_distortionStrength:new i.ci(p),u_rainDirection:new i.ch(p),u_color:new i.d2(p),u_screenSize:new i.cj(p),u_thinningCenterPos:new i.cj(p),u_thinningShape:new i.ch(p),u_thinningAffectedRatio:new i.ci(p),u_thinningParticleOffset:new i.ci(p),u_shapeDirectionalPower:new i.ci(p),u_shapeNormalPower:new i.ci(p),u_mode:new i.ci(p)}),vignette:p=>({u_vignetteShape:new i.ch(p),u_vignetteColor:new i.d2(p)}),occlusion:p=>({u_matrix:new i.ck(p),u_anchorPos:new i.ch(p),u_screenSizePx:new i.cj(p),u_occluderSizePx:new i.cj(p),u_color:new i.d2(p)})};class la{constructor(e,a,f,y){this.id=la.uniqueIdxCounter,la.uniqueIdxCounter++,this.context=e;const w=e.gl;this.buffer=w.createBuffer(),this.dynamicDraw=!!f,this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),w.bufferData(w.ELEMENT_ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?w.DYNAMIC_DRAW:w.STATIC_DRAW),this.dynamicDraw||y||a.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){this.id=la.uniqueIdxCounter,la.uniqueIdxCounter++;const a=this.context.gl;this.context.unbindVAO(),this.bind(),a.bufferSubData(a.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}la.uniqueIdxCounter=0;const qh={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class xr{constructor(e,a,f,y,w,I){this.length=a.length,this.attributes=f,this.itemSize=a.bytesPerElement,this.dynamicDraw=y,this.instanceCount=I,this.context=e;const M=e.gl;this.buffer=M.createBuffer(),e.bindVertexBuffer.set(this.buffer),M.bufferData(M.ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?M.DYNAMIC_DRAW:M.STATIC_DRAW),this.dynamicDraw||w||a.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){const a=this.context.gl;this.bind(),a.bufferSubData(a.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,a){for(let f=0;f<this.attributes.length;f++){const y=a.getAttributeLocation(e,this.attributes[f].name);y!==-1&&e.enableVertexAttribArray(y)}}setVertexAttribPointers(e,a,f){for(let y=0;y<this.attributes.length;y++){const w=this.attributes[y],I=a.getAttributeLocation(e,w.name);I!==-1&&e.vertexAttribPointer(I,w.components,e[qh[w.type]],!1,this.itemSize,w.offset+this.itemSize*(f||0))}}setVertexAttribDivisor(e,a,f){for(let y=0;y<this.attributes.length;y++){const w=a.getAttributeLocation(e,this.attributes[y].name);w!==-1&&this.instanceCount&&this.instanceCount>0&&e.vertexAttribDivisor(w,f)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class zr{constructor(e,a,f,y,w){this.context=e,this.width=a,this.height=f;const I=this.framebuffer=e.gl.createFramebuffer();y&&(this.colorAttachment=new df(e,I)),w&&(this.depthAttachmentType=w,this.depthAttachment=w==="renderbuffer"?new Qu(e,I):new Hf(e,I))}destroy(){const e=this.context.gl;if(this.colorAttachment){const a=this.colorAttachment.get();a&&e.deleteTexture(a)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const a=this.depthAttachment.get();a&&e.deleteRenderbuffer(a)}else{const a=this.depthAttachment.get();a&&e.deleteTexture(a)}e.deleteFramebuffer(this.framebuffer)}}class Zh{constructor(e,a){this.gl=e,this.clearColor=new Rh(this),this.clearDepth=new Xu(this),this.clearStencil=new qf(this),this.colorMask=new gp(this),this.depthMask=new _p(this),this.stencilMask=new yp(this),this.stencilFunc=new fu(this),this.stencilOp=new xp(this),this.stencilTest=new Ld(this),this.depthRange=new Rd(this),this.depthTest=new Zf(this),this.depthFunc=new kd(this),this.blend=new kh(this),this.blendFunc=new Yu(this),this.blendColor=new Fh(this),this.blendEquation=new mu(this),this.cullFace=new Bh(this),this.cullFaceSide=new Oh(this),this.frontFace=new uf(this),this.program=new Fd(this),this.activeTexture=new Xo(this),this.viewport=new ul(this),this.bindFramebuffer=new va(this),this.bindRenderbuffer=new Nh(this),this.bindTexture=new rh(this),this.bindVertexBuffer=new Bd(this),this.bindElementBuffer=new Lc(this),this.bindVertexArrayOES=new vp(this),this.pixelStoreUnpack=new Ju(this),this.pixelStoreUnpackPremultiplyAlpha=new bp(this),this.pixelStoreUnpackFlipY=new gu(this),this.options=a?Object.assign({},a):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=e.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=e.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=e.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=a&&!!a.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=e.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=e.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=e.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPointSize=e.getParameter(e.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,a,f){return new la(this,e,a,f)}createVertexBuffer(e,a,f,y,w){return new xr(this,e,a,f,y,w)}createRenderbuffer(e,a,f){const y=this.gl,w=y.createRenderbuffer();return this.bindRenderbuffer.set(w),y.renderbufferStorage(y.RENDERBUFFER,e,a,f),this.bindRenderbuffer.set(null),w}createFramebuffer(e,a,f,y){return new zr(this,e,a,f,y)}clear({color:e,depth:a,stencil:f,colorMask:y}){const w=this.gl;let I=0;e&&(I|=w.COLOR_BUFFER_BIT,this.clearColor.set(e.toNonPremultipliedRenderColor(null)),this.colorMask.set(y||[!0,!0,!0,!0])),a!==void 0&&(I|=w.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(a),this.depthMask.set(!0)),f!==void 0&&(I|=w.STENCIL_BUFFER_BIT,this.clearStencil.set(f),this.stencilMask.set(255)),w.clear(I)}setCullFace(e){e.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(e){i.bx(e.blendFunction,yr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor),e.blendEquation?this.blendEquation.set(e.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(e.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let pc;function lh(p,e,a,f,y,w,I){const M=p.context,L=M.gl,N=p.transform,V=[i.aF(N.center.lng),i.aJ(N.center.lat)],Z=a.layout.get("symbol-placement"),U=a.layout.get("text-variable-anchor"),X=a.layout.get("icon-rotation-alignment")==="map",Q=a.layout.get("text-rotation-alignment")==="map",nt=Z!=="point",ht=[];let lt=0,_t=0;for(let kt=0;kt<f.length;kt++){const Ht=f[kt],pe=e.getTile(Ht),ae=pe.getBucket(a);if(!ae)continue;const Ce=ae.getProjection().createInversionMatrix(N,Ht.canonical),ve=[],Fe=au(Ht,ae,N),oi=!I&&X&&nt,ge=I&&Q&&nt,re=U&&ae.hasTextData(),Be=ae.hasIconTextFit()&&re&&ae.hasIconData(),Te=oi||ge||I&&re||Be,qe=ae.projection.name==="globe",si=qe?i.aj(N.zoom):0;qe&&(ve.push("PROJECTION_GLOBE_VIEW"),Te&&ve.push("PROJECTED_POS_ON_VIEWPORT"));const Ci=p.getOrCreateProgram("collisionBox",{defines:ve});let ni=Fe;y[0]===0&&y[1]===0||(ni=p.translatePosMatrix(Fe,pe,y,w));const li=I?ae.textCollisionBox:ae.iconCollisionBox,Li=ae.collisionCircleArray;if(Li.length>0){const xi=i.bB(),Ii=ni;i.cO(xi,ae.placementInvProjMatrix,N.glCoordMatrix),i.cO(xi,xi,ae.placementViewportMatrix),ht.push({circleArray:Li,circleOffset:_t,transform:Ii,invTransform:xi,projection:ae.getProjection()}),lt+=Li.length/4,_t=lt}if(!li)continue;p.terrain&&p.terrain.setupElevationDraw(pe,Ci);const Ti=qe?[Ht.canonical.x,Ht.canonical.y,1<<Ht.canonical.z]:[0,0,0];Ci.draw(p,L.LINES,zi.disabled,sr.disabled,p.colorModeForRenderPass(),Qi.disabled,Bc(ni,Ce,N,si,V,pe,Ti,ae.getProjection()),a.id,li.layoutVertexBuffer,li.indexBuffer,li.segments,null,N.zoom,null,[li.collisionVertexBuffer,li.collisionVertexBufferExt])}if(!I||!ht.length)return;const Ct=p.getOrCreateProgram("collisionCircle"),bt=new i.dY;bt.resize(4*lt),bt._trim();let Gt=0;for(const kt of ht)for(let Ht=0;Ht<kt.circleArray.length/4;Ht++){const pe=4*Ht,ae=kt.circleArray[pe+0],Ce=kt.circleArray[pe+1],ve=kt.circleArray[pe+2],Fe=kt.circleArray[pe+3];bt.emplace(Gt++,ae,Ce,ve,Fe,0),bt.emplace(Gt++,ae,Ce,ve,Fe,1),bt.emplace(Gt++,ae,Ce,ve,Fe,2),bt.emplace(Gt++,ae,Ce,ve,Fe,3)}(!pc||pc.length<2*lt)&&(pc=function(kt){const Ht=2*kt,pe=new i.b0;pe.resize(Ht),pe._trim();for(let ae=0;ae<Ht;ae++){const Ce=6*ae;pe.uint16[Ce+0]=4*ae+0,pe.uint16[Ce+1]=4*ae+1,pe.uint16[Ce+2]=4*ae+2,pe.uint16[Ce+3]=4*ae+2,pe.uint16[Ce+4]=4*ae+3,pe.uint16[Ce+5]=4*ae+0}return pe}(lt));const zt=M.createIndexBuffer(pc,!0),Zt=M.createVertexBuffer(bt,i.dZ.members,!0);for(const kt of ht){const Ht={u_matrix:kt.transform,u_inv_matrix:kt.invTransform,u_camera_to_center_distance:(Vt=N).getCameraToCenterDistance(kt.projection),u_viewport_size:[Vt.width,Vt.height]};Ct.draw(p,L.TRIANGLES,zi.disabled,sr.disabled,p.colorModeForRenderPass(),Qi.disabled,Ht,a.id,Zt,zt,i.bf.simpleSegment(0,2*kt.circleOffset,kt.circleArray.length,kt.circleArray.length/2),null,N.zoom)}var Vt;Zt.destroy(),zt.destroy()}const cs=i.bB();function fl(p){const e=p._camera.getWorldToCamera(p.worldSize,1),a=i.aB([],e,p.globeMatrix);i.bk(a,a);const f=[0,0,0],y=[0,1,0,0];return i.aC(y,y,a),f[0]=y[0],f[1]=y[1],f[2]=y[2],i.aw(f,f),f}function $d({width:p,height:e,anchor:a,textOffset:f,textScale:y},w){const{horizontalAlign:I,verticalAlign:M}=i.c0(a),L=-(I-.5)*p,N=-(M-.5)*e,V=i.c1(a,f);return new i.P((L/y+V[0])*w,(N/y+V[1])*w)}function Ep(p,e,a,f,y,w,I,M,L,N){const V=p.text.placedSymbolArray,Z=p.text.dynamicLayoutVertexArray,U=p.icon.dynamicLayoutVertexArray,X={},Q=p.getProjection(),nt=Cn(I,Q,y),ht=y.elevation,lt=Q.upVectorScale(I.canonical,y.center.lat,y.worldSize).metersToTile;Z.clear();for(let _t=0;_t<V.length;_t++){const Ct=V.get(_t),{tileAnchorX:bt,tileAnchorY:Gt,numGlyphs:zt}=Ct,Zt=Ct.hidden||!Ct.crossTileID||p.allowVerticalPlacement&&!Ct.placedOrientation?null:f[Ct.crossTileID];if(Zt){let Vt=0,kt=0,Ht=0;const pe=p.elevationType==="road";if(ht||pe){const Te=pe?p.getElevationFeatureForText(_t):null,qe=i.bU.getAtTileOffset(I,new i.P(bt,Gt),ht,Te),[si,Ci,ni]=Q.upVector(I.canonical,bt,Gt);Vt=qe*si*lt,kt=qe*Ci*lt,Ht=qe*ni*lt}let[ae,Ce,ve,Fe]=Zo(Ct.projectedAnchorX+Vt,Ct.projectedAnchorY+kt,Ct.projectedAnchorZ+Ht,a?nt:w);const oi=Ih(y.getCameraToCenterDistance(Q),Fe);let ge=i.bL(p.textSizeData,L,Ct)*oi/i.bX;a&&(ge*=p.tilePixelRatio/M);const re=$d(Zt,ge);a?({x:ae,y:Ce,z:ve}=Q.projectTilePoint(bt+re.x,Gt+re.y,I.canonical),[ae,Ce,ve]=Zo(ae+Vt,Ce+kt,ve+Ht,w)):(e&&re._rotate(-y.angle),ae+=re.x,Ce+=re.y,ve=0);const Be=p.allowVerticalPlacement&&Ct.placedOrientation===i.bK.vertical?Math.PI/2:0;for(let Te=0;Te<zt;Te++)i.bN(Z,ae,Ce,ve,Be);N&&Ct.associatedIconIndex>=0&&(X[Ct.associatedIconIndex]={x:ae,y:Ce,z:ve,angle:Be})}else al(zt,Z)}if(N){U.clear();const _t=p.icon.placedSymbolArray;for(let Ct=0;Ct<_t.length;Ct++){const bt=_t.get(Ct),{numGlyphs:Gt}=bt,zt=X[Ct];if(bt.hidden||!zt)al(Gt,U);else{const{x:Zt,y:Vt,z:kt,angle:Ht}=zt;for(let pe=0;pe<Gt;pe++)i.bN(U,Zt,Vt,kt,Ht)}}p.icon.dynamicLayoutVertexBuffer.updateData(U)}p.text.dynamicLayoutVertexBuffer.updateData(Z)}function qd(p,e,a,f,y,w,I={}){const M=a.paint.get("icon-translate"),L=a.paint.get("text-translate"),N=a.paint.get("icon-translate-anchor"),V=a.paint.get("text-translate-anchor"),Z=a.layout.get("icon-rotation-alignment"),U=a.layout.get("text-rotation-alignment"),X=a.layout.get("icon-pitch-alignment"),Q=a.layout.get("text-pitch-alignment"),nt=a.layout.get("icon-keep-upright"),ht=a.layout.get("text-keep-upright"),lt=a.paint.get("icon-color-saturation"),_t=a.paint.get("icon-color-contrast"),Ct=a.paint.get("icon-color-brightness-min"),bt=a.paint.get("icon-color-brightness-max"),Gt=a.layout.get("symbol-elevation-reference")==="sea",zt=a.layout.get("icon-image-use-theme")==="none",Zt=p.context,Vt=Zt.gl,kt=p.transform,Ht=Z==="map",pe=U==="map",ae=X==="map",Ce=Q==="map",ve=a.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Fe=!1;const oi=p.depthModeForSublayer(0,zi.ReadOnly),ge=new zi(p.context.gl.LEQUAL,zi.ReadOnly,p.depthRangeFor3D),re=[i.aF(kt.center.lng),i.aJ(kt.center.lat)],Be=a.layout.get("text-variable-anchor"),Te=kt.projection.name==="globe",qe=[],si=[0,-1,0];for(const Ci of f){const ni=e.getTile(Ci),li=ni.getBucket(a);if(!li||li.projection.name==="mercator"&&Te||li.fullyClipped)continue;const Li=li.projection.name==="globe",Ti=Li?i.aj(kt.zoom):0,xi=Cn(Ci,li.getProjection(),kt),Ii=kt.calculatePixelsToTileUnitsMatrix(ni),Zi=Be&&li.hasTextData(),Fr=li.hasIconTextFit()&&Zi&&li.hasIconData(),qr=li.getProjection().createInversionMatrix(kt,Ci.canonical),En=(1<<ni.tileID.canonical.z)*i.al/p.transform.worldSize,ar=cn=>{let cr=[0,0,0];if(cn){const Wr=p.style.directionalLight,fo=p.style.ambientLight;Wr&&fo&&(cr=hl(p.style,Wr,fo))}return cr},jr=cn=>{kt.depthOcclusionForSymbolsAndCircles&&(a.hasOcclusionOpacityProperties||p.terrain)&&(cn.push("DEPTH_D24"),cn.push("DEPTH_OCCLUSION"))},br=cn=>{a.lut&&!zt&&(a.lut.texture||(a.lut.texture=new i.d_(p.context,a.lut.image,[a.lut.image.height,a.lut.image.height,a.lut.image.height],Zt.gl.RGBA8)),Zt.activeTexture.set(Zt.gl.TEXTURE0+ms.LUT),a.lut.texture&&a.lut.texture.bind(Zt.gl.LINEAR,Zt.gl.CLAMP_TO_EDGE),cn.push("APPLY_LUT_ON_GPU"))},xn=()=>{const cn=Ht&&a.layout.get("symbol-placement")!=="point",cr=[];jr(cr),br(cr);const Wr=cn||Fr,fo=li.elevationType==="road",Uo=p.shadowRenderer,So=fo&&ae&&!!Uo&&Uo.enabled,Ro=ar(So),mo=fo&&ae&&!p.terrain?ge:oi,ha=a.paint.get("icon-image-cross-fade");p.terrainRenderModeElevated()&&ae&&cr.push("PITCH_WITH_MAP_TERRAIN"),Li&&(cr.push("PROJECTION_GLOBE_VIEW"),Wr&&cr.push("PROJECTED_POS_ON_VIEWPORT")),ha>0&&li.hasAnySecondaryIcon&&cr.push("ICON_TRANSITION"),!li.icon.zOffsetVertexBuffer||fo&&p.terrain||cr.push("Z_OFFSET"),lt===0&&_t===0&&Ct===0&&bt===1||cr.push("COLOR_ADJUSTMENT"),li.sdfIcons&&cr.push("RENDER_SDF"),So&&cr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),fo&&ae&&!p.terrain&&li.icon.orientationVertexBuffer&&cr.push("ELEVATED_ROADS");const wa=li.icon.programConfigurations.get(a.id),Fa=p.getOrCreateProgram("symbol",{config:wa,defines:cr}),tc=ni.imageAtlasTexture?ni.imageAtlasTexture.size:[0,0],ua=li.iconSizeData,yc=i.bJ(ua,kt.zoom),xc=ae||!kt.isOrthographic,Bs=Xc(xi,ni.tileID.canonical,ae,Ht,kt,li.getProjection(),Ii),io=Ml(xi,ni.tileID.canonical,ae,Ht,kt,li.getProjection(),Ii),ko=p.translatePosMatrix(io,ni,M,N,!0),Dn=p.translatePosMatrix(xi,ni,M,N),$o=Wr?cs:Bs,As=Ht&&!ae&&!cn;let ro=si;!Te&&!kt.mercatorFromTransition||Ht||(ro=fl(kt));const ec=Li?ro:si,Np=a.getColorAdjustmentMatrix(lt,_t,Ct,bt),Cu=Tu(ua.kind,yc,As,ae,p,Dn,$o,ko,Gt,!1,tc,[0,0],0,Ci,Ti,re,qr,ec,li.getProjection(),Ro,En,Np,ha,null),Vp=ni.imageAtlasTexture?ni.imageAtlasTexture:null,Up=a.layout.get("icon-size").constantOr(0)!==1||li.iconsNeedLinear,vc=li.sdfIcons||p.options.rotating||p.options.zooming||Up||xc?Vt.LINEAR:Vt.NEAREST,Kh=li.sdfIcons&&a.paint.get("icon-halo-width").constantOr(1)!==0,Os=p.terrain&&ae&&cn?i.bk(i.bB(),Bs):cs;if(cn&&li.icon){const bc=i.bU.getAtTileOffsetFunc(Ci,kt.center.lat,kt.worldSize,li.getProjection()),Yd=Yc(xi,ni.tileID.canonical,ae,Ht,kt,li.getProjection(),Ii),wg=a.layout.get("icon-size-scale-range"),em=i.aA(p.scaleFactor,wg[0],wg[1]);Hl(li,xi,p,!1,Yd,io,ae,nt,bc,Ci,em)}return{program:Fa,buffers:li.icon,uniformValues:Cu,atlasTexture:Vp,atlasTextureIcon:null,atlasInterpolation:vc,atlasInterpolationIcon:null,isSDF:li.sdfIcons,hasHalo:Kh,depthMode:mo,tile:ni,renderWithShadows:So,labelPlaneMatrixInv:Os}},Vr=()=>{const cn=pe&&a.layout.get("symbol-placement")!=="point",cr=[],Wr=cn||Be||Fr,fo=li.elevationType==="road",Uo=p.shadowRenderer,So=fo&&Ce&&!!Uo&&Uo.enabled,Ro=ar(So),mo=fo&&Ce&&!p.terrain?ge:oi;p.terrainRenderModeElevated()&&Ce&&cr.push("PITCH_WITH_MAP_TERRAIN"),Li&&(cr.push("PROJECTION_GLOBE_VIEW"),Wr&&cr.push("PROJECTED_POS_ON_VIEWPORT")),!li.text.zOffsetVertexBuffer||fo&&p.terrain||cr.push("Z_OFFSET"),li.iconsInText&&cr.push("RENDER_TEXT_AND_SYMBOL"),cr.push("RENDER_SDF"),So&&cr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),fo&&Ce&&!p.terrain&&li.text.orientationVertexBuffer&&cr.push("ELEVATED_ROADS"),jr(cr);const ha=li.text.programConfigurations.get(a.id),wa=p.getOrCreateProgram("symbol",{config:ha,defines:cr});let Fa,tc=[0,0],ua=null;const yc=li.textSizeData;li.iconsInText&&(tc=ni.imageAtlasTexture?ni.imageAtlasTexture.size:[0,0],ua=ni.imageAtlasTexture?ni.imageAtlasTexture:null,Fa=Ce||!kt.isOrthographic||p.options.rotating||p.options.zooming||yc.kind==="composite"||yc.kind==="camera"?Vt.LINEAR:Vt.NEAREST);const xc=ni.glyphAtlasTexture?ni.glyphAtlasTexture.size:[0,0],Bs=a.layout.get("text-size-scale-range"),io=i.aA(p.scaleFactor,Bs[0],Bs[1]),ko=i.bJ(yc,kt.zoom,io),Dn=Xc(xi,ni.tileID.canonical,Ce,pe,kt,li.getProjection(),Ii),$o=Ml(xi,ni.tileID.canonical,Ce,pe,kt,li.getProjection(),Ii),As=p.translatePosMatrix($o,ni,L,V,!0),ro=p.translatePosMatrix(xi,ni,L,V),ec=Wr?cs:Dn,Np=pe&&!Ce&&!cn;let Cu=si;!Te&&!kt.mercatorFromTransition||pe||(Cu=fl(kt));const Vp=Tu(yc.kind,ko,Np,Ce,p,ro,ec,As,Gt,!0,xc,tc,0,Ci,Ti,re,qr,Li?Cu:si,li.getProjection(),Ro,En,null,null,io),Up=ni.glyphAtlasTexture?ni.glyphAtlasTexture:null,vc=Vt.LINEAR,Kh=a.paint.get("text-halo-width").constantOr(1)!==0,Os=p.terrain&&Ce&&cn?i.bk(i.bB(),Dn):cs;if(cn&&li.text){const bc=i.bU.getAtTileOffsetFunc(Ci,kt.center.lat,kt.worldSize,li.getProjection()),Yd=Yc(xi,ni.tileID.canonical,Ce,pe,kt,li.getProjection(),Ii);Hl(li,xi,p,!0,Yd,$o,Ce,ht,bc,Ci,io)}return{program:wa,buffers:li.text,uniformValues:Vp,atlasTexture:Up,atlasTextureIcon:ua,atlasInterpolation:vc,atlasInterpolationIcon:Fa,isSDF:!0,hasHalo:Kh,depthMode:mo,tile:ni,renderWithShadows:So,labelPlaneMatrixInv:Os}},kn=li.icon.segments.get().length,Kr=li.text.segments.get().length,wr=kn&&!I.onlyText?xn():null,ln=Kr&&!I.onlyIcons?Vr():null,Er=a.paint.get("icon-opacity").constantOr(1),eo=a.paint.get("text-opacity").constantOr(1);if(ve&&li.canOverlap){Fe=!0;const cn=Er&&!I.onlyText?li.icon.segments.get():[],cr=eo&&!I.onlyIcons?li.text.segments.get():[];for(const Wr of cn)qe.push({segments:new i.bf([Wr]),sortKey:Wr.sortKey,state:wr});for(const Wr of cr)qe.push({segments:new i.bf([Wr]),sortKey:Wr.sortKey,state:ln})}else I.onlyText||qe.push({segments:Er?li.icon.segments:new i.bf([]),sortKey:0,state:wr}),I.onlyIcons||qe.push({segments:eo?li.text.segments:new i.bf([]),sortKey:0,state:ln})}Fe&&qe.sort((Ci,ni)=>Ci.sortKey-ni.sortKey);for(const Ci of qe){const ni=Ci.state;if(ni)if(p.terrain?p.terrain.setupElevationDraw(ni.tile,ni.program,{useDepthForOcclusion:kt.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ni.labelPlaneMatrixInv}):p.setupDepthForOcclusion(kt.depthOcclusionForSymbolsAndCircles,ni.program),Zt.activeTexture.set(Vt.TEXTURE0),ni.atlasTexture&&ni.atlasTexture.bind(ni.atlasInterpolation,Vt.CLAMP_TO_EDGE,!0),ni.atlasTextureIcon&&(Zt.activeTexture.set(Vt.TEXTURE1),ni.atlasTextureIcon&&ni.atlasTextureIcon.bind(ni.atlasInterpolationIcon,Vt.CLAMP_TO_EDGE,!0)),ni.renderWithShadows&&p.shadowRenderer.setupShadows(ni.tile.tileID.toUnwrapped(),ni.program,"vector-tile"),p.uploadCommonLightUniforms(p.context,ni.program),ni.hasHalo){const li=ni.uniformValues;li.u_is_halo=1,Ap(ni.buffers,Ci.segments,a,p,ni.program,ni.depthMode,y,w,li,2),li.u_is_halo=0}else{if(ni.isSDF){const li=ni.uniformValues;ni.hasHalo&&(li.u_is_halo=1,Ap(ni.buffers,Ci.segments,a,p,ni.program,ni.depthMode,y,w,li,1)),li.u_is_halo=0}Ap(ni.buffers,Ci.segments,a,p,ni.program,ni.depthMode,y,w,ni.uniformValues,1)}}}function Ap(p,e,a,f,y,w,I,M,L,N){const V=[p.dynamicLayoutVertexBuffer,p.opacityVertexBuffer,p.iconTransitioningVertexBuffer,p.globeExtVertexBuffer,p.zOffsetVertexBuffer,p.orientationVertexBuffer];y.draw(f,f.context.gl.TRIANGLES,w,I,M,Qi.disabled,L,a.id,p.layoutVertexBuffer,p.indexBuffer,e,a.paint,f.transform.zoom,p.programConfigurations.get(a.id),V,N)}function ld(p,e){const a=1<<p.canonical.z,f=(e.x*a-p.canonical.x-p.wrap*a)*i.al,y=(e.y*a-p.canonical.y)*i.al,w=i.e7(e.z,e.y);return i.d4(f,y,w)}function to(p,e,a,f,y){if(!a.layout||a.layout.get("fill-elevation-reference")==="none"||a.paint.get("fill-opacity").constantOr(1)===0)return;const w=p.context.gl,I=new zi(p.context.gl.LEQUAL,zi.ReadWrite,p.depthRangeFor3D),M=new zi(p.context.gl.GREATER,zi.ReadWrite,p.depthRangeFor3D),L=function(X){let Q=.01;return X.isOrthographic&&(Q=i.ak(1e-4,Q,i.c$(X.pitch>=Ah?1:X.pitch/Ah))),2*Q}(p.transform),N=p.transform.getFreeCameraOptions().position,V="elevatedStructuresDepthReconstruct",Z=p.getOrCreateProgram(V,{defines:["DEPTH_RECONSTRUCTION"]}),U=p.getOrCreateProgram(V);for(const X of f){const Q=e.getTile(X),nt=Q.getBucket(a);if(!nt)continue;const ht=nt.elevatedStructures;if(!ht)continue;const lt=nt.elevationBufferData.heightRange,_t=ld(X.toUnwrapped(),N),Ct=p.translatePosMatrix(X.projMatrix,Q,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor"));let bt,Gt,zt,Zt;if(y==="initialize"){if(!lt||lt.min>=1||ht.depthSegments.segments[0].primitiveLength===0)continue;bt=rd(Ct,_t,L,1,0),Gt=I,zt=ht.depthSegments,Zt=Z}else if(y==="reset"){if(!lt||lt.min>=0||ht.maskSegments.segments[0].primitiveLength===0)continue;bt=rd(Ct,_t,0,0,1),Gt=M,zt=ht.maskSegments,Zt=Z}else if(y==="geometry"){if(ht.depthSegments.segments[0].primitiveLength===0)continue;bt=rd(Ct,_t,L,1,0),Gt=I,zt=ht.depthSegments,Zt=U}Zt.draw(p,w.TRIANGLES,Gt,sr.disabled,yr.disabled,Qi.disabled,bt,a.id,ht.vertexBuffer,ht.indexBuffer,zt,a.paint,p.transform.zoom)}}function Go(p,e,a){const{painter:f,sourceCache:y,layer:w,coords:I,colorMode:M,elevationType:L,terrainEnabled:N,pass:V}=p,Z=f.context.gl,U=w.paint.get("fill-pattern"),X=w.paint.get("fill-pattern-cross-fade"),Q=U.constantOr(null);let nt=L;L!=="road"||e&&!N||(nt="none");const ht=nt==="road",lt=p.painter.shadowRenderer,_t=ht&&!!lt&&lt.enabled,Ct=new zi(f.context.gl.LEQUAL,zi.ReadOnly,f.depthRangeFor3D);let bt=[0,0,0];if(_t){const Zt=f.style.directionalLight,Vt=f.style.ambientLight;Zt&&Vt&&(bt=hl(f.style,Zt,Vt))}const Gt=U&&U.constantOr(1),zt=(Zt,Vt)=>{let kt,Ht,pe,ae,Ce;Vt?(kt=Gt&&!w.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",pe=Z.LINES):(kt=Gt?"fillPattern":"fill",pe=Z.TRIANGLES);for(const ve of I){const Fe=y.getTile(ve);if(Gt&&!Fe.patternsLoaded())continue;const oi=Fe.getBucket(w);if(!oi)continue;const ge=e?oi.elevationBufferData:oi.bufferData;if(ge.isEmpty())continue;f.prepareDrawTile();const re=ge.programConfigurations.get(w.id),Be=f.isTileAffectedByFog(ve),Te=[],qe=[];ht&&(Te.push("ELEVATED_ROADS"),qe.push(ge.elevatedLayoutVertexBuffer)),_t&&Te.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Gt&&(f.context.activeTexture.set(Z.TEXTURE0),Fe.imageAtlasTexture&&Fe.imageAtlasTexture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE),re.updatePaintBuffers());let si=!1;if(Q&&Fe.imageAtlas){const Ti=Fe.imageAtlas,xi=i.e2.from(Q),Ii=xi.getPrimary().scaleSelf(i.o.devicePixelRatio).toString(),Zi=xi.getSecondary(),Fr=Ti.patternPositions.get(Ii),qr=Zi?Ti.patternPositions.get(Zi.scaleSelf(i.o.devicePixelRatio).toString()):null;si=!!Fr&&!!qr,Fr&&re.setConstantPatternPositions(Fr,qr)}X>0&&(si||re.getPatternTransitionVertexBuffer("fill-pattern"))&&Te.push("FILL_PATTERN_TRANSITION");const Ci=f.getOrCreateProgram(kt,{config:re,overrideFog:Be,defines:Te}),ni=f.translatePosMatrix(ve.projMatrix,Fe,w.paint.get("fill-translate"),w.paint.get("fill-translate-anchor"));_t&&lt.setupShadows(Fe.tileID.toUnwrapped(),Ci,"vector-tile");const li=w.paint.get("fill-emissive-strength");if(Vt){ae=ge.lineIndexBuffer,Ce=ge.lineSegments;const Ti=f.terrain&&f.terrain.renderingToTexture?f.terrain.drapeBufferSize:[Z.drawingBufferWidth,Z.drawingBufferHeight];Ht=kt==="fillOutlinePattern"&&Gt?jd(ni,li,f,Fe,Ti,bt,X):Wf(ni,li,Ti,bt)}else ae=ge.indexBuffer,Ce=ge.triangleSegments,Ht=Gt?Tp(ni,li,f,Fe,bt,X):vu(ni,li,bt);f.uploadCommonUniforms(f.context,Ci,ve.toUnwrapped());let Li=Zt;(L==="road"&&!N||L==="offset")&&(Li=Ct),Ci.draw(f,pe,Li,a||f.stencilModeForClipping(ve),M,Qi.disabled,Ht,w.id,ge.layoutVertexBuffer,ae,Ce,w.paint,f.transform.zoom,re,qe)}};f.renderPass===V&&zt(f.depthModeForSublayer(1,f.renderPass==="opaque"?zi.ReadWrite:zi.ReadOnly),!1),nt==="none"&&f.renderPass==="translucent"&&w.paint.get("fill-antialias")&&zt(f.depthModeForSublayer(w.getPaintProperty("fill-outline-color")?2:0,zi.ReadOnly),!0)}function Si(p,e,a,f,y,w,I,M){a.resetLayerRenderingStats(p);const L=p.context,N=L.gl,V=p.transform,Z=a.paint.get("fill-extrusion-pattern"),U=a.paint.get("fill-extrusion-pattern-cross-fade"),X=Z.constantOr(null),Q=Z.constantOr(1),nt=a.paint.get("fill-extrusion-opacity"),ht=p.style.enable3dLights(),lt=a.paint.get(ht&&!Q?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),_t=[a.paint.get("fill-extrusion-ambient-occlusion-intensity"),lt],Ct=a.layout.get("fill-extrusion-edge-radius"),bt=Ct>0&&!a.paint.get("fill-extrusion-rounded-roof"),Gt=bt?0:Ct,zt=V.projection.name==="globe"?i.ea():0,Zt=V.projection.name==="globe",Vt=Zt?i.aj(V.zoom):0,kt=[i.aF(V.center.lng),i.aJ(V.center.lat)],Ht=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",pe=a.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(Ht?null:a.lut).toArray01().slice(0,3),ae=a.paint.get("fill-extrusion-flood-light-intensity"),Ce=a.paint.get("fill-extrusion-vertical-scale"),ve=a.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Fe=a.paint.get("fill-extrusion-height-alignment"),oi=a.paint.get("fill-extrusion-base-alignment"),ge=sa(p,a.paint.get("fill-extrusion-cutoff-fade-range")),re=[];let Be;Zt&&re.push("PROJECTION_GLOBE_VIEW"),_t[0]>0&&re.push("FAUX_AO"),bt&&re.push("ZERO_ROOF_RADIUS"),M&&re.push("HAS_CENTROID"),ae>0&&re.push("FLOOD_LIGHT"),ge.shouldRenderCutoff&&re.push("RENDER_CUTOFF"),ve&&re.push("RENDER_WALL_MODE");const Te=p.renderPass==="shadow",qe=p.shadowRenderer,si=Te&&!!qe,Ci=Te?Qi.disabled:Qi.backCCW;p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!0);let ni=[0,0,0];if(qe){const Ti=p.style.directionalLight,xi=p.style.ambientLight;Ti&&xi&&(ni=hl(p.style,Ti,xi)),Te||(re.push("RENDER_SHADOWS","DEPTH_TEXTURE"),qe.useNormalOffset&&re.push("NORMAL_OFFSET")),Be=re.concat(["SHADOWS_SINGLE_CASCADE"])}const li=si?"fillExtrusionDepth":Q?"fillExtrusionPattern":"fillExtrusion",Li=a.getLayerRenderingStats();for(const Ti of f){const xi=e.getTile(Ti),Ii=xi.getBucket(a);if(!Ii||Ii.projection.name!==V.projection.name)continue;let Zi=!1;qe&&(Zi=qe.getMaxCascadeForTile(Ti.toUnwrapped())===0);const Fr=p.isTileAffectedByFog(Ti),qr=Ii.programConfigurations.get(a.id);let En=!1;if(X&&xi.imageAtlas){const Kr=xi.imageAtlas,wr=i.e2.from(X),ln=wr.getPrimary().scaleSelf(i.o.devicePixelRatio).toString(),Er=wr.getSecondary(),eo=Kr.patternPositions.get(ln),cn=Er?Kr.patternPositions.get(Er.scaleSelf(i.o.devicePixelRatio).toString()):null;En=!!eo&&!!cn,eo&&qr.setConstantPatternPositions(eo,cn)}U>0&&(En||qr.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&re.push("FILL_EXTRUSION_PATTERN_TRANSITION");const ar=p.getOrCreateProgram(li,{config:qr,defines:Zi?Be:re,overrideFog:Fr});if(p.terrain&&p.terrain.setupElevationDraw(xi,ar,{useMeterToDem:!0}),!Ii.centroidVertexBuffer){const Kr=ar.getAttributeLocation(N,"a_centroid_pos");Kr!==-1&&N.vertexAttrib2f(Kr,0,0)}!Te&&qe&&qe.setupShadows(xi.tileID.toUnwrapped(),ar,"vector-tile"),Q&&(p.context.activeTexture.set(N.TEXTURE0),xi.imageAtlasTexture&&xi.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),qr.updatePaintBuffers());const jr=a.paint.get("fill-extrusion-vertical-gradient"),br=1/Ii.tileToMeter;let xn;if(Te&&qe){if(cd(xi.tileID,Ii.maxHeight,p))continue;const Kr=qe.calculateShadowPassMatrixFromTile(xi.tileID.toUnwrapped());xn=id(Kr,Gt,br,Ce,Fe,oi)}else{const Kr=p.translatePosMatrix(Ti.expandedProjMatrix,xi,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),wr=V.projection.createInversionMatrix(V,Ti.canonical);xn=Q?Yl(Kr,p,jr,nt,_t,Gt,br,Ti,xi,zt,Fe,oi,Vt,kt,wr,pe,Ce,U):xu(Kr,p,jr,nt,_t,Gt,br,Ti,zt,Fe,oi,Vt,kt,wr,pe,Ce,ae,ni)}p.uploadCommonUniforms(L,ar,Ti.toUnwrapped(),null,ge);let Vr=Ii.segments;if(V.projection.name==="mercator"&&!Te&&(Vr=Ii.getVisibleSegments(xi.tileID,p.terrain,p.transform.getFrustum(0)),!Vr.get().length))continue;if(Li)if(Te)for(const Kr of Vr.get())Li.numRenderedVerticesInShadowPass+=Kr.primitiveLength;else for(const Kr of Vr.get())Li.numRenderedVerticesInTransparentPass+=Kr.primitiveLength;const kn=[];(p.terrain||M)&&kn.push(Ii.centroidVertexBuffer),Zt&&kn.push(Ii.layoutVertexExtBuffer),ve&&kn.push(Ii.wallVertexBuffer),ar.draw(p,L.gl.TRIANGLES,y,w,I,Ci,xn,a.id,Ii.layoutVertexBuffer,Ii.indexBuffer,Vr,a.paint,p.transform.zoom,qr,kn)}p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!1)}class Su{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function zl(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,Q,nt,ht,lt,_t,Ct){const bt=e.context,Gt=bt.gl,zt=e.transform,Zt=e.transform.zoom,Vt=[],kt=p.translate,Ht=p.translateAnchor,pe=p.edgeRadius,ae=sa(e,p.cutoffFadeRange);V==="clear"?(Vt.push("CLEAR_SUBPASS"),Ct&&(Vt.push("CLEAR_FROM_TEXTURE"),bt.activeTexture.set(Gt.TEXTURE0),Ct.bind(Gt.LINEAR,Gt.CLAMP_TO_EDGE))):V==="sdf"&&Vt.push("SDF_SUBPASS"),lt&&Vt.push("HAS_CENTROID"),ae.shouldRenderCutoff&&Vt.push("RENDER_CUTOFF");const Ce=(ve,Fe,oi,ge,re)=>{let Be=Vt;Fe.groundRadiusBuffer!=null&&(Be=Vt.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const Te=Fe.programConfigurations.get(f.id),qe=e.isTileAffectedByFog(ve),si=e.getOrCreateProgram("fillExtrusionGroundEffect",{config:Te,defines:Be,overrideFog:qe}),Ci=Ki(e,ge,Z,N,re,[U,X*re],Q,nt,ht,Zt>=17?0:pe*re,Ct?Ct.size[0]:0),ni=[];lt&&ni.push(Fe.hiddenByLandmarkVertexBuffer),Fe.groundRadiusBuffer!=null&&ni.push(Fe.groundRadiusBuffer),e.uploadCommonUniforms(bt,si,ve.toUnwrapped(),null,ae),si.draw(e,bt.gl.TRIANGLES,w,I,M,L,Ci,f.id,Fe.vertexBuffer,Fe.indexBuffer,oi,f.paint,Zt,Te,ni)};for(const ve of y){const Fe=a.getTile(ve),oi=Fe.getBucket(f);if(!oi||oi.projection.name!==zt.projection.name||!oi.groundEffect||oi.groundEffect&&!oi.groundEffect.hasData())continue;const ge=oi.groundEffect,re=1/oi.tileToMeter;{const Be=e.translatePosMatrix(ve.projMatrix,Fe,kt,Ht),Te=ge.getDefaultSegment();Ce(ve,ge,Te,Be,re)}if(_t)for(let Be=0;Be<4;Be++){const Te=i.e8[Be](ve),qe=a.getTile(Te);if(!qe)continue;const si=qe.getBucket(f);if(!si||si.projection.name!==zt.projection.name||!si.groundEffect||si.groundEffect&&!si.groundEffect.hasData())continue;const Ci=si.groundEffect;let ni,li;Be===0?(ni=[-i.al,0,0],li=1):Be===1?(ni=[i.al,0,0],li=0):Be===2?(ni=[0,-i.al,0],li=3):(ni=[0,i.al,0],li=2);const Li=Ci.regionSegments[li];if(!Li)continue;const Ti=new Float32Array(16);i.bq(Ti,ve.projMatrix,ni),Ce(ve,Ci,Li,e.translatePosMatrix(Ti,Fe,kt,Ht),re)}}}function Nc(p,e,a,f,y,w,I){f.centroidVertexArray.length===0&&f.createCentroidsBuffer();const M=w?w.findDEMTileFor(a):null;if(!(M&&M.dem||I))return;w&&M&&M.dem&&f.selfDEMTileTimestamp!==M.dem._timestamp&&(f.borderDoneWithNeighborZ=[-1,-1,-1,-1],f.selfDEMTileTimestamp=M.dem._timestamp);const L=lt=>new i.P(Math.ceil((lt+i.ec)*i.ed),0),N=lt=>{const _t=e.getSource().minzoom,Ct=Gt=>{const zt=e.getTileByID(Gt);if(zt&&zt.hasData())return zt.getBucket(y)},bt=[0,-1,1];for(const Gt of bt){if(lt.overscaledZ+Gt<_t)continue;const zt=Ct(lt.calculateScaledKey(lt.overscaledZ+Gt));if(zt)return zt}},V=[0,0,0],Z=(lt,_t)=>(V[0]=Math.min(lt.min.y,_t.min.y),V[1]=Math.max(lt.max.y,_t.max.y),V[2]=i.al-_t.min.x>lt.max.x?_t.min.x-i.al:lt.max.x,V),U=(lt,_t)=>(V[0]=Math.min(lt.min.x,_t.min.x),V[1]=Math.max(lt.max.x,_t.max.x),V[2]=i.al-_t.min.y>lt.max.y?_t.min.y-i.al:lt.max.y,V),X=[(lt,_t)=>Z(lt,_t),(lt,_t)=>Z(_t,lt),(lt,_t)=>U(lt,_t),(lt,_t)=>U(_t,lt)],Q=(lt,_t,Ct,bt,Gt,zt,Zt)=>{if(!w)return 0;const Vt=[[zt?Ct:lt,zt?lt:Ct,0],[zt?Ct:_t,zt?_t:Ct,0]],kt=Zt<0?i.al+Zt:Zt,Ht=[zt?kt:(lt+_t)/2,zt?(lt+_t)/2:kt,0];return Ct===0&&Zt<0||Ct!==0&&Zt>0?w.getForTilePoints(Gt,[Ht],!0,bt):Vt.push(Ht),w.getForTilePoints(a,Vt,!0,M),Math.max(Vt[0][2],Vt[1][2],Ht[2])/w.exaggeration()};for(let lt=0;lt<4;lt++){const _t=f.borderFeatureIndices[lt];if(_t.length===0)continue;const Ct=i.e8[lt](a),bt=N(Ct);if(!(bt&&bt instanceof i.e9))continue;const Gt=w?w.findDEMTileFor(Ct):null;if(!(Gt&&Gt.dem||I)||(w&&Gt&&Gt.dem&&f.borderDEMTileTimestamp[lt]!==Gt.dem._timestamp&&(f.borderDoneWithNeighborZ[lt]=-1,f.borderDEMTileTimestamp[lt]=Gt.dem._timestamp),f.borderDoneWithNeighborZ[lt]===bt.canonical.z))continue;bt.centroidVertexArray.length===0&&bt.createCentroidsBuffer();const zt=(lt<2?1:5)-lt,Zt=bt.borderDoneWithNeighborZ[zt]!==f.canonical.z,Vt=bt.borderFeatureIndices[zt];let kt=0;if(f.canonical.z!==bt.canonical.z){for(const Ht of _t)f.showCentroid(f.featuresOnBorder[Ht]);if(Zt)for(const Ht of Vt)bt.showCentroid(bt.featuresOnBorder[Ht]);f.borderDoneWithNeighborZ[lt]=bt.canonical.z,bt.borderDoneWithNeighborZ[zt]=f.canonical.z}for(const Ht of _t){const pe=f.featuresOnBorder[Ht],ae=f.centroidData[pe.centroidDataIndex],Ce=pe.borders[lt];let ve;for(;kt<Vt.length;){ve=bt.featuresOnBorder[Vt[kt]];const Fe=ve.borders[zt];if(Fe[1]>Ce[0]+3||Fe[0]>Ce[0]-3)break;bt.showCentroid(ve),kt++}if(ve&&kt<Vt.length){const Fe=kt;let oi=0;for(;!(ve.borders[zt][0]>Ce[1]-3)&&(oi++,++kt!==Vt.length);)ve=bt.featuresOnBorder[Vt[kt]];ve=bt.featuresOnBorder[Vt[Fe]];let ge=!1;if(oi>=1){const Te=ve.borders[zt];Math.abs(Ce[0]-Te[0])<3&&Math.abs(Ce[1]-Te[1])<3&&(oi=1,ge=!0,kt=Fe+1)}else if(oi===0){f.showCentroid(pe);continue}const re=bt.centroidData[ve.centroidDataIndex];I&&ge&&(((nt=ae).flags|(ht=re).flags)&i.eb?(nt.flags|=i.eb,ht.flags|=i.eb):(nt.flags&=~i.eb,ht.flags&=~i.eb));const Be=pe.intersectsCount()>1||ve.intersectsCount()>1;if(oi>1)kt=Fe,ae.centroidXY=re.centroidXY=new i.P(0,0);else if(Gt&&Gt.dem&&!Be){const Te=X[lt](ae,re),qe=lt%2?i.al-1:0,si=Q(Te[0],Math.min(i.al-1,Te[1]),qe,Gt,Ct,lt<2,Te[2]);ae.centroidXY=re.centroidXY=L(si)}else Be?ae.centroidXY=re.centroidXY=new i.P(0,0):(ae.centroidXY=f.encodeBorderCentroid(pe),re.centroidXY=bt.encodeBorderCentroid(ve));f.writeCentroidToBuffer(ae),bt.writeCentroidToBuffer(re)}else f.showCentroid(pe)}f.borderDoneWithNeighborZ[lt]=bt.canonical.z,bt.borderDoneWithNeighborZ[zt]=f.canonical.z}var nt,ht;(f.needsCentroidUpdate||!f.centroidVertexBuffer&&f.centroidVertexArray.length!==0)&&f.uploadCentroid(p)}const Vc=[1,0,0],$i=[0,1,0],Hh=[0,0,1];function cd(p,e,a){const f=a.transform,y=a.shadowRenderer;if(!y)return!0;const w=p.toUnwrapped(),I=f.tileSize*y._cascades[a.currentShadowCascade].scale;let M=e;if(f.elevation){const nt=f.elevation.getMinMaxForTile(p);nt&&(M+=nt.max)}const L=[...y.shadowDirection];L[2]=-L[2];const N=y.computeSimplifiedTileShadowVolume(w,M,I,L);if(!N)return!1;const V=[Vc,$i,Hh,L,[L[0],0,L[2]],[0,L[1],L[2]]],Z=f.projection.name==="globe",U=f.scaleZoom(I),X=i.cA.fromInvProjectionMatrix(f.invProjMatrix,f.worldSize,U,!Z),Q=y.getCurrentCascadeFrustum();return X.intersectsPrecise(N.vertices,N.planes,V)===0||Q.intersectsPrecise(N.vertices,N.planes,V)===0}function Iu(p){const{painter:e,source:a,layer:f,coords:y}=p;let w=p.defines;const I=e.context,M=e.renderPass==="shadow",L=e.renderPass==="light-beam",N=e.shadowRenderer,V=i.ee(e.transform.center.lat,e.transform.zoom),Z=sa(e,f.paint.get("building-cutoff-fade-range"));Z.shouldRenderCutoff&&(w=w.concat("RENDER_CUTOFF")),p.floodLightIntensity>0&&(w=w.concat("FLOOD_LIGHT"));for(const U of y){const X=a.getTile(U),Q=X.getBucket(f);if(!Q)continue;N&&N.getMaxCascadeForTile(U.toUnwrapped())===0&&(w=w.concat("SHADOWS_SINGLE_CASCADE"));const nt=Q.programConfigurations.get(f.id);let ht,lt,_t,Ct=e.translatePosMatrix(U.expandedProjMatrix,X,[0,0],"map");if(Ct=i.cR(i.bB(),Ct,[1,1,p.verticalScale]),M&&N){if(cd(X.tileID,Q.maxHeight*V,e))continue;let Gt=N.calculateShadowPassMatrixFromTile(X.tileID.toUnwrapped());Gt=i.cR(i.bB(),Gt,[1,1,p.verticalScale]),_t=mf(Gt),ht=lt=e.getOrCreateProgram("buildingDepth",{config:nt,defines:w,overrideFog:!1})}else if(L)ht=lt=e.getOrCreateProgram("buildingBloom",{config:nt,defines:w,overrideFog:!1}),_t=jh(Ct);else{const Gt=e.transform.calculatePosMatrix(U.toUnwrapped(),e.transform.worldSize);i.cR(Gt,Gt,[1,1,p.verticalScale]);const zt=i.bB();i.cR(zt,Gt,[1,-1,1/V]),i.bk(zt,zt),i.ef(zt,zt);const Zt=e.transform.getFreeCameraOptions().position,Vt=1<<U.canonical.z;if(_t=ff(Ct,zt,p.opacity,p.facadeAOIntensity,[((Zt.x-U.wrap)*Vt-U.canonical.x)*i.al,(Zt.y*Vt-U.canonical.y)*i.al,Zt.z*Vt*i.al],Q.tileToMeter,p.facadeEmissiveChance,p.floodLightColor,p.floodLightIntensity),lt=e.getOrCreateProgram("building",{config:nt,defines:w,overrideFog:!1}),p.depthOnly===!0)ht=lt;else{const kt=w.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);ht=e.getOrCreateProgram("building",{config:nt,defines:kt,overrideFog:!1})}N&&(N.setupShadowsFromMatrix(Gt,lt,!0),ht!==lt&&N.setupShadowsFromMatrix(Gt,ht,!0))}const bt=(Gt,zt)=>{if(L){const Zt=Gt.entranceBloom;zt.draw(e,I.gl.TRIANGLES,p.depthMode,sr.disabled,p.blendMode,Qi.disabled,_t,f.id,Zt.layoutVertexBuffer,Zt.indexBuffer,Zt.segmentsBucket,f.paint,e.transform.zoom,nt,[Zt.layoutAttenuationBuffer,Zt.layoutColorBuffer])}else{const Zt=Gt.segmentsBucket;let Vt=[Gt.layoutNormalBuffer,Gt.layoutCentroidBuffer,Gt.layoutColorBuffer,Gt.layoutFloodLightDataBuffer];Gt.layoutFacadePaintBuffer&&(Vt=Vt.concat([Gt.layoutFacadeDataBuffer,Gt.layoutFacadeVerticalRangeBuffer,Gt.layoutFacadePaintBuffer])),zt.draw(e,I.gl.TRIANGLES,p.depthMode,sr.disabled,p.blendMode,M?Qi.disabled:Qi.backCW,_t,f.id,Gt.layoutVertexBuffer,Gt.indexBuffer,Zt,f.paint,e.transform.zoom,nt,Vt)}};e.uploadCommonUniforms(I,lt,U.toUnwrapped(),null,Z),Q.buildingWithoutFacade&&bt(Q.buildingWithoutFacade,lt),Q.buildingWithFacade&&(ht!==lt&&e.uploadCommonUniforms(I,ht,U.toUnwrapped(),null,Z),bt(Q.buildingWithFacade,ht))}}function Wh(p,e,a,f,y,w,I,M,L,N,V,Z,U){const X=p.context.gl,Q=p.depthModeForSublayer(1,zi.ReadOnly,X.LEQUAL,!0),nt=.1*(1-(ht=V))+3*ht;var ht;const lt=p._showOverdrawInspector,_t=Z,Ct=new Su;lt||zl(Ct,p,e,a,f,Q,new sr({func:X.ALWAYS,mask:255},255,255,X.KEEP,X.KEEP,X.REPLACE),new yr([X.ONE,X.ONE,X.ONE,X.ONE],i.ao.transparent,[!1,!1,!1,!0],X.MIN),Qi.disabled,y,"sdf",w,I,M,L,N,nt,_t,!1);{const bt=lt?sr.disabled:new sr({func:X.EQUAL,mask:255},255,255,X.KEEP,X.DECR,X.DECR),Gt=lt?p.colorModeForRenderPass():new yr([X.ONE_MINUS_DST_ALPHA,X.DST_ALPHA,X.ONE,X.ONE],i.ao.transparent,[!0,!0,!0,!0]);zl(Ct,p,e,a,f,Q,bt,Gt,Qi.disabled,y,"color",w,I,M,L,N,nt,_t,!1)}}function Zd(p){return[p[0]*i.eg,p[1]*i.eg,p[2]*i.eg,0]}function Xh(p,e,a,f,y,w,I,M,L){const N=f.getSource(),V=a.globeSharedBuffers;if(!V)return;let Z,U,X;if(e&&(Z=f.getTile(e)),N instanceof i.aT?(U=N.texture,X=i.dJ(0,0,a.transform)):Z&&e&&(U=Z.texture,X=i.dJ(e.canonical.z,e.canonical.x,a.transform)),!U||!X)return;p||(X=i.cR(i.bB(),X,[1,-1,1]));const Q=a.context,nt=Q.gl,ht=y.paint.get("raster-resampling")==="nearest"?nt.NEAREST:nt.LINEAR,lt=a.colorModeForDrapableLayerRenderPass(w),_t=I.defines;_t.push("GLOBE_POLES");const Ct=new zi(nt.LEQUAL,zi.ReadWrite,a.depthRangeFor3D),bt=Float32Array.from(a.transform.expandedFarZProjMatrix),Gt=Float32Array.from(i.bj(i.dI(new i.cC(0,0,0))));a.terrain&&a.terrain.prepareDrawTile(),Q.activeTexture.set(nt.TEXTURE0),U.bind(ht,nt.CLAMP_TO_EDGE),Q.activeTexture.set(nt.TEXTURE1),U.bind(ht,nt.CLAMP_TO_EDGE),"useMipmap"in U&&Q.extTextureFilterAnisotropic&&a.transform.pitch>20&&nt.texParameterf(nt.TEXTURE_2D,Q.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Q.extTextureFilterAnisotropicMax);const[zt,Zt,Vt,kt]=e?V.getPoleBuffers(e.canonical.z,!1):V.getPoleBuffers(0,!0),Ht=y.paint.get("raster-elevation");let pe;p?(pe=zt,a.renderDefaultNorthPole=Ht!==0):(pe=Zt,a.renderDefaultSouthPole=Ht!==0);const ae=Zd(I.mix),Ce=((Fe,oi,ge,re,Be,Te,qe,si,Ci,ni,li,Li,Ti)=>bu(Fe,oi,ge,new Float32Array(16),new Float32Array(9),[0,0],re,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Te,[0,0],si,2,ni,li,Li,1,0,Ti))(bt,Gt,X,i.aj(a.transform.zoom),0,y,0,Ht,0,ae,I.offset,I.range,w),ve=a.getOrCreateProgram("raster",{defines:_t});a.uploadCommonUniforms(Q,ve,null),ve.draw(a,nt.TRIANGLES,Ct,L,lt,M,Ce,y.id,pe,Vt,kt)}function Yh(p){const e=p._nearZ,a=p.projection.farthestPixelDistance(p),f=a-e,y=.2*p.height,w=e+y;return[e,a,(w-y-e)/f,(w-e)/f]}function yf(p,e,a,f){if(p)return e instanceof es&&p instanceof as?e.getTextureDescriptor(p,a,!0):{texture:p.texture,mix:Zd(f.mix),offset:f.offset,buffer:0,tileSize:1}}var Pp=i.eh([{name:"a_index",type:"Int16",components:1}]);class ks{constructor(e,a,f,y){const w={width:f[0],height:f[1],data:null},I=e.gl;this.targetColorTexture=new i.T(e,w,I.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new i.T(e,w,I.RGBA8,{useMipmap:!1}),this.context=e,this.updateParticleTexture(a,y),this.lastInvalidatedAt=0}updateParticleTexture(e,a){if(this.particleTextureDimension===a.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const f=this.context.gl,y=a.width*a.height;this.particleTexture0=new i.T(this.context,a,f.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new i.T(this.context,a,f.RGBA8,{premultiply:!1,useMipmap:!1});const w=new i.ei;w.reserve(y);for(let I=0;I<y;I++)w.emplaceBack(I);this.particleIndexBuffer=this.context.createVertexBuffer(w,Pp.members,!0),this.particleSegment=i.bf.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=a.width}update(e){return!(this.lastInvalidatedAt<e&&(this.lastInvalidatedAt=i.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function hd(p,e,a){if(!p)return null;const f=e.getTextureDescriptor(p,a,!0);if(!f)return null;let{texture:y,mix:w,offset:I,tileSize:M,buffer:L,format:N}=f;if(!y||!N)return null;let V=!1;return N==="uint32"&&(V=!0,w[3]=0,w=Gd(i.ej,w,[0,a.paint.get("raster-particle-max-speed")]),I=dc(i.ej,I,[0,a.paint.get("raster-particle-max-speed")])),{texture:y,textureOffset:[L/(M+2*L),M/(M+2*L)],tileSize:M,scalarData:V,scale:w,offset:I,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[N]]}}function ca(p){const e=p._nearZ,a=p.projection.farthestPixelDistance(p),f=a-e,y=.2*p.height,w=e+y;return[e,a,(w-y-e)/f,(w-e)/f]}const fc=new i.ao(1,0,0,1),Hd=new i.ao(0,1,0,1),C=new i.ao(0,0,1,1),s=new i.ao(1,0,1,1),d=new i.ao(0,1,1,1);function v(p,e,a,f,y,w){for(let I=0;I<a.length;I++)if(y){const N=new i.ao(f.r*.8,f.g*.8,f.b*.8,1);S(p,e,a[I],f,-1,-1,w),S(p,e,a[I],f,-1,1,w),S(p,e,a[I],f,1,1,w),S(p,e,a[I],f,1,-1,w),S(p,e,a[I],N,0,0,w)}else S(p,e,a[I],f,0,0,w)}function S(p,e,a,f,y,w,I){const M=p.context,L=p.transform,N=M.gl,V=L.projection.name==="globe",Z=V?["PROJECTION_GLOBE_VIEW"]:[];let U=i.by(a.projMatrix);if(V&&i.aj(L.zoom)>0){const ae=i.bi(a.canonical,L),Ce=i.ek(ae);U=i.aB(new Float32Array(16),L.globeMatrix,Ce),i.aB(U,L.projMatrix,U)}const X=i.bB();X[12]+=2*y/(i.o.devicePixelRatio*L.width),X[13]+=2*w/(i.o.devicePixelRatio*L.height),i.aB(U,X,U);const Q=p.getOrCreateProgram("debug",{defines:Z}),nt=e.getTileByID(a.key);p.terrain&&p.terrain.setupElevationDraw(nt,Q);const ht=zi.disabled,lt=sr.disabled,_t=p.colorModeForRenderPass(),Ct="$debug";M.activeTexture.set(N.TEXTURE0),p.emptyTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),V?nt._makeGlobeTileDebugBuffers(p.context,L):nt._makeDebugTileBoundsBuffers(p.context,L.projection);const bt=nt._tileDebugBuffer||p.debugBuffer,Gt=nt._tileDebugIndexBuffer||p.debugIndexBuffer,zt=nt._tileDebugSegments||p.debugSegments;if(Q.draw(p,N.LINE_STRIP,ht,lt,_t,Qi.disabled,nd(U,f.toPremultipliedRenderColor(null)),Ct,bt,Gt,zt,null,null,null,[nt._globeTileDebugBorderBuffer]),I){const ae=nt.latestRawTileData,Ce=Math.floor((ae&&ae.byteLength||0)/1024);let ve=a.canonical.toString();a.overscaledZ!==a.canonical.z&&(ve+=` => ${a.overscaledZ}`),ve+=` ${nt.state}`,ve+=` ${Ce}kb`,function(Fe,oi){Fe.initDebugOverlayCanvas();const ge=Fe.debugOverlayCanvas,re=Fe.context.gl,Be=Fe.debugOverlayCanvas.getContext("2d");Be.clearRect(0,0,ge.width,ge.height),Be.shadowColor="white",Be.shadowBlur=2,Be.lineWidth=1.5,Be.strokeStyle="white",Be.textBaseline="top",Be.font="bold 36px Open Sans, sans-serif",Be.fillText(oi,5,5),Be.strokeText(oi,5,5),Fe.debugOverlayTexture.update(ge),Fe.debugOverlayTexture.bind(re.LINEAR,re.CLAMP_TO_EDGE)}(p,ve)}const Zt=e.getTile(a).tileSize,Vt=512/Math.min(Zt,512)*(a.overscaledZ/L.zoom)*.5,kt=nt._tileDebugTextBuffer||p.debugBuffer,Ht=nt._tileDebugTextIndexBuffer||p.quadTriangleIndexBuffer,pe=nt._tileDebugTextSegments||p.debugSegments;Q.draw(p,N.TRIANGLES,ht,lt,yr.alphaBlended,Qi.disabled,nd(U,i.ao.transparent.toPremultipliedRenderColor(null),Vt),Ct,kt,Ht,pe,null,null,null,[nt._globeTileDebugTextBuffer])}function D(p,e,a,f){j(p,0,e+a/2,p.transform.width,a,f)}function k(p,e,a,f){j(p,e-a/2,0,a,p.transform.height,f)}function j(p,e,a,f,y,w){const I=p.context,M=I.gl;M.enable(M.SCISSOR_TEST),M.scissor(e*i.o.devicePixelRatio,a*i.o.devicePixelRatio,f*i.o.devicePixelRatio,y*i.o.devicePixelRatio),I.clear({color:w}),M.disable(M.SCISSOR_TEST)}const H=i.eh([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:J}=H;function et(p,e,a,f){p.emplaceBack(e,a,f)}class mt{constructor(e){this.vertexArray=new i.el,this.indices=new i.b0,et(this.vertexArray,-1,-1,1),et(this.vertexArray,1,-1,1),et(this.vertexArray,-1,1,1),et(this.vertexArray,1,1,1),et(this.vertexArray,-1,-1,-1),et(this.vertexArray,1,-1,-1),et(this.vertexArray,-1,1,-1),et(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=e.createVertexBuffer(this.vertexArray,J),this.indexBuffer=e.createIndexBuffer(this.indices),this.segment=i.bf.simpleSegment(0,0,36,12)}}function ut(p,e,a,f,y,w){const I=p.context.gl,M=e.paint.get("sky-atmosphere-color"),L=e.paint.get("sky-atmosphere-halo-color"),N=e.paint.get("sky-atmosphere-sun-intensity"),V=((Z,U,X,Q,nt)=>({u_matrix_3f:Z,u_sun_direction:U,u_sun_intensity:X,u_color_tint_r:[Q.r,Q.g,Q.b,Q.a],u_color_tint_m:[nt.r,nt.g,nt.b,nt.a],u_luminance:5e-5}))(i.en(i.dN(),f),y,N,M.toPremultipliedRenderColor(null),L.toPremultipliedRenderColor(null));I.framebufferTexture2D(I.FRAMEBUFFER,I.COLOR_ATTACHMENT0,I.TEXTURE_CUBE_MAP_POSITIVE_X+w,e.skyboxTexture,0),a.draw(p,I.TRIANGLES,zi.disabled,sr.disabled,yr.unblended,Qi.frontCW,V,"skyboxCapture",e.skyboxGeometry.vertexBuffer,e.skyboxGeometry.indexBuffer,e.skyboxGeometry.segment)}const St=i.eh([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class pt{constructor(e){const a=new i.eo;a.emplaceBack(-1,1,1,0,0),a.emplaceBack(1,1,1,1,0),a.emplaceBack(1,-1,1,1,1),a.emplaceBack(-1,-1,1,0,1);const f=new i.b0;f.emplaceBack(0,1,2),f.emplaceBack(2,3,0),this.vertexBuffer=e.createVertexBuffer(a,St.members),this.indexBuffer=e.createIndexBuffer(f),this.segments=i.bf.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Et=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Kt{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Xt{constructor(e){this.colorModeAlphaBlendedWriteRGB=new yr([1,Ao,1,Ao],i.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new yr([1,0,1,0],i.ao.transparent,[!1,!1,!1,!0]),this.params=new Kt,this.updateNeeded=!0,e.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),e.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),e.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),e.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(e){const a=e.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new pt(a);const f=this.params.sizeRange,y=this.params.intensityRange,w=function(V){const Z=i.eq(30),U=[];for(let X=0;X<V;++X){const Q=2*Math.PI*Z(),nt=Math.acos(1-2*Z())-.5*Math.PI;U.push(i.d4(Math.cos(nt)*Math.cos(Q),Math.cos(nt)*Math.sin(Q),Math.sin(nt)))}return U}(this.params.starsCount),I=i.eq(300),M=new i.ep,L=new i.b0;let N=0;for(let V=0;V<w.length;++V){const Z=i.c4([],w[V],200),U=Math.max(0,1+.01*f*(1*I()-.5)),X=Math.max(0,1+.01*y*(1*I()-.5));M.emplaceBack(Z[0],Z[1],Z[2],-1,-1,U,X),M.emplaceBack(Z[0],Z[1],Z[2],1,-1,U,X),M.emplaceBack(Z[0],Z[1],Z[2],1,1,U,X),M.emplaceBack(Z[0],Z[1],Z[2],-1,1,U,X),L.emplaceBack(N+0,N+1,N+2),L.emplaceBack(N+0,N+2,N+3),N+=4}this.starsVx=a.createVertexBuffer(M,Et.members),this.starsIdx=a.createIndexBuffer(L),this.starsSegments=i.bf.simpleSegment(0,0,M.length,L.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(e,a){const f=e.context,y=f.gl,w=e.transform,I=new zi(y.LEQUAL,zi.ReadOnly,[0,1]),M=i.aj(w.zoom),L=e.style.getLut(a.scope),N=a.properties.get("color-use-theme")==="none",V=a.properties.get("color").toNonPremultipliedRenderColor(N?null:L),Z=a.properties.get("high-color-use-theme")==="none",U=a.properties.get("high-color").toNonPremultipliedRenderColor(Z?null:L),X=a.properties.get("space-color-use-theme")==="none",Q=a.properties.get("space-color").toNonPremultipliedRenderColor(X?null:L),nt=5e-4,ht=i.er(a.properties.get("horizon-blend"),0,1,nt,.25),lt=i.dD(e,f,w)&&ht===nt?w.worldSize/(2*Math.PI*1.025)-1:w.globeRadius,_t=e.frameCounter/1e3%1,Ct=i.ag(w.globeCenterInViewSpace),bt=Math.sqrt(Math.pow(Ct,2)-Math.pow(lt,2)),Gt=Math.acos(bt/Ct),zt=Zt=>{const Vt=w.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];Zt&&Vt.push("ALPHA_PASS");const kt=e.getOrCreateProgram("globeAtmosphere",{defines:Vt}),Ht=((ae,Ce,ve,Fe,oi,ge,re,Be,Te,qe,si,Ci)=>({u_frustum_tl:ae,u_frustum_tr:Ce,u_frustum_br:ve,u_frustum_bl:Fe,u_horizon:oi,u_transition:ge,u_fadeout_range:re,u_atmosphere_fog_color:Be.toArray01(),u_high_color:Te.toArray01(),u_space_color:qe.toArray01(),u_temporal_offset:si,u_horizon_angle:Ci}))(w.frustumCorners.TL,w.frustumCorners.TR,w.frustumCorners.BR,w.frustumCorners.BL,w.frustumCorners.horizon,M,ht,V,U,Q,_t,Gt);e.uploadCommonUniforms(f,kt);const pe=this.atmosphereBuffer;pe&&kt.draw(e,y.TRIANGLES,I,sr.disabled,Zt?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Qi.backCW,Ht,Zt?"atmosphere_glow_alpha":"atmosphere_glow",pe.vertexBuffer,pe.indexBuffer,pe.segments)};zt(!1),zt(!0)}drawStars(e,a){const f=i.aA(a.properties.get("star-intensity"),0,1);if(f===0)return;const y=e.context,w=y.gl,I=e.transform,M=e.getOrCreateProgram("stars"),L=i.c6([]);i.c8(L,L,-I._pitch),i.c7(L,L,-I.angle),i.c8(L,L,i.an(I._center.lat)),i.es(L,L,-i.an(I._center.lng));const N=i.cb(new Float32Array(16),L),V=i.aB([],I.starsProjMatrix,N),Z=i.en([],N),U=i.et([],Z),X=[0,1,0];i.dP(X,X,U),i.c4(X,X,this.params.sizeMultiplier);const Q=[1,0,0];i.dP(Q,Q,U),i.c4(Q,Q,this.params.sizeMultiplier);const nt=(ht=X,lt=Q,_t=f,{u_matrix:Float32Array.from(V),u_up:ht,u_right:lt,u_intensity_multiplier:_t});var ht,lt,_t;e.uploadCommonUniforms(y,M),this.starsVx&&this.starsIdx&&M.draw(e,w.TRIANGLES,zi.disabled,sr.disabled,this.colorModeAlphaBlendedWriteRGB,Qi.disabled,nt,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class ft{constructor(){this.visibleTiles=[]}updateBorders(e,a){const f=[],y=[],w=e._getRenderableCoordinates(!1,!0);for(const L of w){const N=e.getTile(L);if(!N.hasData())continue;const V=N.getBucket(a);V&&(V.isEmpty()||(f.push(L.key),y.push({bucket:V,tileID:L.canonical})))}let I=f.length!==this.visibleTiles.length;if(!I){f.sort();for(let L=0;L<f.length;L++)if(f[L]!==this.visibleTiles[L]){I=!0;break}}if(!I)return;const M=new Set;this.visibleTiles=f,y.sort((L,N)=>L.tileID.z-N.tileID.z||L.tileID.x-N.tileID.x||L.tileID.y-N.tileID.y);for(const L of y){const N=new Array,V=new Array,Z=L.bucket;for(const U of Z.featuresOnBorder)M.has(U.featureId)?V.push(U.footprintIndex):(M.add(U.featureId),N.push(U.footprintIndex));Z.updateFootprintHiddenFlags(N,i.eu,!1),Z.updateFootprintHiddenFlags(V,i.eu,!0)}}}function _e(p,e){const a=[...p],f=e.cameraWorldSizeForFog/e.worldSize,y=i.bz([]);return i.cR(y,y,[f,f,1]),i.aB(a,y,a),i.aB(a,e.worldToFogMatrix,a),a}function ce(p,e,a,f,y){const w=a.material,I=f.context,{baseColorTexture:M,metallicRoughnessTexture:L}=w.pbrMetallicRoughness,{normalTexture:N,occlusionTexture:V,emissionTexture:Z}=w;function U(Q,nt,ht){if(Q&&(p.push(nt),I.activeTexture.set(I.gl.TEXTURE0+ht),Q.gfxTexture)){const{minFilter:lt,magFilter:_t,wrapS:Ct,wrapT:bt}=Q.sampler;Q.gfxTexture.bindExtraParam(lt,_t,Ct,bt)}}U(M,"HAS_TEXTURE_u_baseColorTexture",ms.BaseColor),U(L,"HAS_TEXTURE_u_metallicRoughnessTexture",ms.MetallicRoughness),U(N,"HAS_TEXTURE_u_normalTexture",ms.Normal),U(V,"HAS_TEXTURE_u_occlusionTexture",ms.Occlusion),U(Z,"HAS_TEXTURE_u_emissionTexture",ms.Emission),y&&(y.texture||(y.texture=new i.d_(f.context,y.image,[y.image.height,y.image.height,y.image.height],I.gl.RGBA8)),I.activeTexture.set(I.gl.TEXTURE0+ms.LUT),y.texture&&y.texture.bind(I.gl.LINEAR,I.gl.CLAMP_TO_EDGE),p.push("APPLY_LUT_ON_GPU")),a.texcoordBuffer&&(p.push("HAS_ATTRIBUTE_a_uv_2f"),e.push(a.texcoordBuffer)),a.colorBuffer&&(p.push(a.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),e.push(a.colorBuffer)),a.normalBuffer&&(p.push("HAS_ATTRIBUTE_a_normal_3f"),e.push(a.normalBuffer)),a.pbrBuffer&&(p.push("HAS_ATTRIBUTE_a_pbr"),p.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),e.push(a.pbrBuffer)),w.alphaMode!=="OPAQUE"&&w.alphaMode!=="MASK"||p.push("UNPREMULT_TEXTURE_IN_SHADER"),w.defined||p.push("DIFFUSE_SHADED");const X=f.shadowRenderer;X&&(p.push("RENDER_SHADOWS","DEPTH_TEXTURE"),X.useNormalOffset&&p.push("NORMAL_OFFSET"))}function me(p,e,a,f,y,w){const I=a.paint.get("model-opacity").constantOr(1),M=e.context,L=new zi(e.context.gl.LEQUAL,p.isLightMesh?zi.ReadOnly:zi.ReadWrite,e.depthRangeFor3D),N=e.transform,V=p.mesh,Z=V.material,U=Z.pbrMetallicRoughness,X=e.style.fog;let Q;Q=e.transform.projection.zAxisUnit==="pixels"?[...p.nodeModelMatrix]:i.aB([],f.zScaleMatrix,p.nodeModelMatrix),i.aB(Q,f.negCameraPosMatrix,Q);const nt=i.bk([],Q);i.ef(nt,nt);const ht=a.paint.get("model-color-use-theme").constantOr("default")==="none",lt=a.paint.get("model-emissive-strength").constantOr(0),_t=ad(new Float32Array(p.worldViewProjection),new Float32Array(Q),new Float32Array(nt),null,e,I,U.baseColorFactor,Z.emissiveFactor,U.metallicFactor,U.roughnessFactor,Z,lt,a,void 0,void 0,p.materialOverride,p.modelColor),Ct={defines:[]},bt=[],Gt=e.shadowRenderer;Gt&&(Gt.useNormalOffset=!1),ce(Ct.defines,bt,V,e,ht?null:a.lut);let zt=null;if(X){const kt=_e(p.nodeModelMatrix,e.transform);if(zt=new Float32Array(kt),N.projection.name!=="globe"){const Ht=V.aabb.min,pe=V.aabb.max,[ae,Ce]=X.getOpacityForBounds(kt,Ht[0],Ht[1],pe[0],pe[1]);Ct.overrideFog=ae>=xe||Ce>=xe}}const Zt=sa(e,a.paint.get("model-cutoff-fade-range"));Zt.shouldRenderCutoff&&Ct.defines.push("RENDER_CUTOFF");const Vt=e.getOrCreateProgram("model",Ct);e.uploadCommonUniforms(M,Vt,null,zt,Zt),e.renderPass!=="shadow"&&Gt&&Gt.setupShadowsFromMatrix(p.nodeModelMatrix,Vt),Vt.draw(e,M.gl.TRIANGLES,L,y,w,V.material.doubleSided?Qi.disabled:Qi.backCCW,_t,a.id,V.vertexBuffer,V.indexBuffer,V.segments,a.paint,e.transform.zoom,void 0,bt)}function be(p,e,a){return p.type==="vector"?e.scope:a?"basemap":""}function de(p,e,a,f,y,w,I,M,L){const N=p.transform,V=!!e.isGeometryBloom&&e.isGeometryBloom;if(V&&p.renderPass==="shadow")return;const Z=N.projection.name==="globe"?i.eC(a,N):[...a];i.aB(Z,Z,e.globalMatrix);const U=i.aB([],f,Z);if(e.meshes)for(const X of e.meshes){const Q=M.get(X.material.name);if(Q&&Q.opacity<=0)continue;if(X.material.alphaMode!=="BLEND"){I.push({mesh:X,depth:0,modelIndex:y,worldViewProjection:U,nodeModelMatrix:Z,isLightMesh:V,materialOverride:Q,modelColor:L});continue}const nt=i.af([],X.centroid,U);!N.isOrthographic&&nt[2]<=0||w.push({mesh:X,depth:nt[2],modelIndex:y,worldViewProjection:U,nodeModelMatrix:Z,isLightMesh:V,materialOverride:Q,modelColor:L})}if(e.children)for(const X of e.children)de(p,X,a,f,y,w,I,M,L)}function De(p,e,a,f){const y=a.shadowRenderer;if(!y)return;const w=y.getShadowPassDepthMode(),I=y.getShadowPassColorMode(),M=y.calculateShadowPassMatrixFromMatrix(e),L=$h(M);a.getOrCreateProgram("modelDepth",{defines:a._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(a,a.context.gl.TRIANGLES,w,sr.disabled,I,Qi.disabled,L,f.id,p.vertexBuffer,p.indexBuffer,p.segments,f.paint,a.transform.zoom,void 0,void 0)}function Qe(p,e,a,f,y,w){for(const I of y){const M=Object.assign({},f);M.part=I;const L={type:"Unknown",id:e,properties:M},N={orientation:p.paint.get("model-rotation").evaluate(L,a)};w.set(I,N)}}function Xe(p,e,a,f,y,w){for(const I of y){const M=Object.assign({},f);M.part=I;const L={type:"Unknown",id:e,properties:M},N={color:p.paint.get("model-color").evaluate(L,a),colorMix:p.paint.get("model-color-mix-intensity").evaluate(L,a),opacity:p.paint.get("model-opacity").evaluate(L,a),emissionStrength:p.paint.get("model-emissive-strength").evaluate(L,a)};w.set(I,N)}}function Je(p,e,a,f,y,w){if(a===1)for(const M of y)me(M,p,e,w[M.modelIndex],sr.disabled,p.colorModeForRenderPass());else{for(const M of y)me(M,p,e,w[M.modelIndex],sr.disabled,yr.disabled);for(const M of y)me(M,p,e,w[M.modelIndex],p.stencilModeFor3D(),p.colorModeForRenderPass());p.resetStencilClippingMasks()}const I=yr.additive;for(const M of f)me(M,p,e,w[M.modelIndex],sr.disabled,M.isLightMesh?I:p.colorModeForRenderPass())}function ii(p,e,a){const f=e.updateZoomBasedPaintProperties(),y=function(w,I,M){let L,N,V,Z=w.terrain?w.terrain.exaggeration():0;if(w.terrain&&Z>0){const U=w.terrain,X=U.findDEMTileFor(M);X&&X.dem?L=i.eE.create(U,M,X):Z=0}if(Z===0&&(I.terrainElevationMin=0,I.terrainElevationMax=0),Z===I.validForExaggeration&&(Z===0||L&&L._demTile&&L._demTile.tileID===I.validForDEMTile.id&&L._dem._timestamp===I.validForDEMTile.timestamp))return!1;for(const U in I.instancesPerModel){const X=I.instancesPerModel[U];for(let Q=0;Q<X.instancedDataArray.length;++Q){const nt=(L?Z*L.getElevationAt(0|X.instancedDataArray.float32[16*Q],0|X.instancedDataArray.float32[16*Q+1],!0,!0):0)+X.instancesEvaluatedElevation[Q];X.instancedDataArray.float32[16*Q+6]=nt,N=N?Math.min(I.terrainElevationMin,nt):nt,V=V?Math.max(I.terrainElevationMax,nt):nt}}return I.terrainElevationMin=N||0,I.terrainElevationMax=V||0,I.validForExaggeration=Z,I.validForDEMTile=L&&L._demTile?{id:L._demTile.tileID,timestamp:L._dem._timestamp}:{id:void 0,timestamp:0},!0}(p,e,a);(f||y)&&(e.uploaded=!1,e.upload(p.context))}const Di={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new i.d8([0,0,0],[i.al,i.al,0])};function Fi(p,e){const a=1<<p.canonical.z,f=e.getFreeCameraOptions().position,y=e.elevation,w=p.canonical.x/a,I=(p.canonical.x+1)/a,M=p.canonical.y/a,L=(p.canonical.y+1)/a;let N=e._centerAltitude;if(y){const X=y.getMinMaxForTile(p);X&&X.max>N&&(N=X.max)}const V=i.aA(f.x,w,I)-f.x,Z=i.aA(f.y,M,L)-f.y,U=i.ce(N,e.center.lat)-f.z;return e._zoomFromMercatorZ(Math.sqrt(V*V+Z*Z+U*U))}function wi(p,e,a,f,y,w,I){const M=p.context,L=p.renderPass==="shadow",N=p.shadowRenderer,V=L&&N?N.getShadowPassDepthMode():new zi(M.gl.LEQUAL,zi.ReadWrite,p.depthRangeFor3D),Z=p.isTileAffectedByFog(w),U=p.transform.projection.name==="globe";if(a.meshes)for(const X of a.meshes){const Q=U?[]:["MODEL_POSITION_ON_GPU"],nt=[];let ht,lt,_t;const Ct=!U&&f.instancedDataArray.length>20;Ct&&Q.push("INSTANCED_ARRAYS");const bt=sa(p,e.paint.get("model-cutoff-fade-range"));if(bt.shouldRenderCutoff&&Q.push("RENDER_CUTOFF"),L&&N)ht=p.getOrCreateProgram("modelDepth",{defines:Q}),lt=$h(I.shadowTileMatrix,I.shadowTileMatrix,Float32Array.from(a.globalMatrix)),_t=N.getShadowPassColorMode();else{ce(Q,nt,X,p,e.paint.get("model-color-use-theme").constantOr("default")==="none"?null:e.lut),ht=p.getOrCreateProgram("model",{defines:Q,overrideFog:Z});const zt=X.material,Zt=zt.pbrMetallicRoughness,Vt=e.paint.get("model-opacity").constantOr(1),kt=e.paint.get("model-emissive-strength").constantOr(0);lt=ad(w.expandedProjMatrix,Float32Array.from(a.globalMatrix),new Float32Array(16),null,p,Vt,Zt.baseColorFactor,zt.emissiveFactor,Zt.metallicFactor,Zt.roughnessFactor,zt,kt,e,y),N&&(I.shadowUniformsInitialized?ht.setShadowUniformValues(M,N.getShadowUniformValues()):(N.setupShadows(w.toUnwrapped(),ht,"model-tile"),I.shadowUniformsInitialized=!0)),_t=bt.shouldRenderCutoff||Vt<1||zt.alphaMode!=="OPAQUE"?yr.alphaBlended:yr.unblended}p.uploadCommonUniforms(M,ht,w.toUnwrapped(),null,bt);const Gt=X.material.doubleSided?Qi.disabled:Qi.backCCW;if(Ct)nt.push(f.instancedDataBuffer),ht.draw(p,M.gl.TRIANGLES,V,sr.disabled,_t,Gt,lt,e.id,X.vertexBuffer,X.indexBuffer,X.segments,e.paint,p.transform.zoom,void 0,nt,f.instancedDataArray.length);else{const zt=L?"u_instance":"u_normal_matrix";for(let Zt=0;Zt<f.instancedDataArray.length;++Zt)lt[zt]=new Float32Array(f.instancedDataArray.arrayBuffer,64*Zt,16),ht.draw(p,M.gl.TRIANGLES,V,sr.disabled,_t,Gt,lt,e.id,X.vertexBuffer,X.indexBuffer,X.segments,e.paint,p.transform.zoom,void 0,nt)}}if(a.children)for(const X of a.children)wi(p,e,X,f,y,w,I)}const fr=[1,-1,1];function $r(p,e,a,f){if(!a.modelManager)return!0;const y=a.modelManager;if(!a.shadowRenderer)return!0;const w=a.shadowRenderer,I=e.aabb;let M=!0,L=p.maxHeight;if(L===0){let V=0;for(const Z in p.instancesPerModel){const U=y.getModel(Z,f);U?V=Math.max(V,Math.max(Math.max(U.aabb.max[0],U.aabb.max[1]),U.aabb.max[2])):M=!1}L=p.maxScale*V*1.41+p.maxVerticalOffset,M&&(p.maxHeight=L)}I.max[2]=L,I.min[2]+=p.terrainElevationMin,I.max[2]+=p.terrainElevationMax,i.af(I.min,I.min,e.tileMatrix),i.af(I.max,I.max,e.tileMatrix);const N=I.intersects(w.getCurrentCascadeFrustum());return a.currentShadowCascade===0&&(p.isInsideFirstShadowMapFrustum=N===2),N===0}function Nr(p,e){const a=p.uniformValues.u_cutoff_params[0],f=p.uniformValues.u_cutoff_params[1],y=p.uniformValues.u_cutoff_params[2],w=p.uniformValues.u_cutoff_params[3];return f===a||w===y?1:i.aA(((e-a)/(f-a)-y)/(w-y),0,1)}function co(p,e,a,f){if(e.pitch<20)return 1;const y=e.getWorldToCameraMatrix();i.aB(y,y,p);const w=i.bT(a.min[0],a.min[1],a.min[2],1);let I=i.aC(i.eF(),w,y),M=I,L=I;w[1]=a.max[1],I=i.aC(i.eF(),w,y),M=I[1]<M[1]?I:M,L=I[1]>L[1]?I:L,w[0]=a.max[0],I=i.aC(i.eF(),w,y),M=I[1]<M[1]?I:M,L=I[1]>L[1]?I:L,w[1]=a.min[1],I=i.aC(i.eF(),w,y),M=I[1]<M[1]?I:M,L=I[1]>L[1]?I:L;const N=i.aA(f[0],0,1),V=100*e.pixelsPerMeter*i.aA(f[1],0,1),Z=i.aA(f[2],0,1),U=i.eG(i.eF(),M,L,N),X=Math.tan(.5*e.fovX),Q=-U[2]*X;if(V===0)return U[1]<-Math.abs(Q)?Z:1;const nt=(-Math.abs(Q)-U[1])/V,ht=(_t,Ct,bt)=>(1-bt)*_t+bt*Ct,lt=i.aA(ht(1,Z,nt),Z,1);return ht(1,lt,i.aA((e.pitch-20)/20,0,1))}class No{}class Jo{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(e,a,f){{const Z=this._storage.get(a.id);if(Z)return Z.lastUsedFrameIdx=e,Z.buf}const y=f.gl,w=y.getBufferParameter(y.ELEMENT_ARRAY_BUFFER,y.BUFFER_SIZE),I=new ArrayBuffer(w),M=new Int16Array(I);y.getBufferSubData(y.ELEMENT_ARRAY_BUFFER,0,new Int16Array(I));const L=new i.eI;for(let Z=0;Z<w/2;Z+=3){const U=M[Z],X=M[Z+1],Q=M[Z+2];L.emplaceBack(U,X),L.emplaceBack(X,Q),L.emplaceBack(Q,U)}const N=f.bindVertexArrayOES.current,V=new No;return V.buf=new la(f,L),V.lastUsedFrameIdx=e,this._storage.set(a.id,V),f.bindVertexArrayOES.set(N),V.buf}update(e){for(const[a,f]of this._storage)e-f.lastUsedFrameIdx>30&&(f.buf.destroy(),this._storage.delete(a))}destroy(){for(const[e,a]of this._storage)a.buf.destroy(),this._storage.delete(e)}}class Vo{constructor(e){this.occluderSize=30,this.depthOffset=-1e-4,e.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),e.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const Es=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Ko{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class $n{constructor(e,a){this.revealStart=11,this.revealRange=2,e.registerParameter(this,[...a,"Reveal"],"revealStart",{min:0,max:17,step:.05}),e.registerParameter(this,[...a,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const _s=i.eh([{type:"Float32",name:"a_pos_2f",components:2}]);class Qo{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(e,a){const f=e.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const I=new i.eJ,M=new i.b0;I.emplaceBack(-1,-1),I.emplaceBack(1,-1),I.emplaceBack(1,1),I.emplaceBack(-1,1),M.emplaceBack(0,1,2),M.emplaceBack(0,2,3),this.vignetteVx=e.context.createVertexBuffer(I,_s.members),this.vignetteIdx=e.context.createIndexBuffer(M)}const y=i.bf.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){e.uploadCommonUniforms(e.context,f);const I={u_vignetteShape:(w={vignetteShape:[a.start,a.range,Math.pow(10,a.fadePower)],vignetteColor:[a.color.r,a.color.g,a.color.b,a.color.a*a.strength]}).vignetteShape,u_vignetteColor:w.vignetteColor};f.draw(e,e.context.gl.TRIANGLES,zi.disabled,sr.disabled,yr.alphaBlended,Qi.disabled,I,"vignette",this.vignetteVx,this.vignetteIdx,y)}var w}}class Jr{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(e,a){const f=e.getFreeCameraOptions().position,y=f.toAltitude(),w=f.toLngLat(),I=i.an(w.lng),M=i.an(w.lat),L=e.pixelsPerMeter/a,N=I*i.eL,V=i.eL*Math.log(Math.tan(Math.PI/4+M/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const Z=-this._offsetYPrev+V,U=-this._elevationPrev+y;this._accumulatedOffsetX+=(-this._offsetXPrev+N)*L,this._accumulatedOffsetY+=Z*L,this._accumulatedElevation+=U*L,this._offsetXPrev=N,this._offsetYPrev=V,this._elevationPrev=y}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function vr(p,e){return[-(p[0]-Math.floor(p[0]/e)*e),-(p[1]-Math.floor(p[1]/e)*e),-(p[2]-Math.floor(p[2]/e)*e)]}function Jl(p){const e=i.eq(1323123451230),a=[];for(let f=0;f<p;++f){const y=2*e()-1,w=2*e()-1,I=2*e()-1;a.push(i.d4(y,w,I))}return a}function ys(p,e,a,f,y){const w=i.aA((y-a)/(f-a),0,1);return(1-w)*p+w*e}class ml{constructor(e){this._movement=new Jr,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Qo,this._ppmScaleFactor=e}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(e,a){const f=e.transform;this._movement.update(f,this._ppmScaleFactor);const y=f.starsProjMatrix,w=i.c6([]);i.c8(w,w,i.an(90)-f._pitch),i.c7(w,w,-f.angle);const I=i.cb(new Float32Array(16),w),M=i.eK(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),L=i.ef([],M),N=i.aB([],L,I),V=Date.now()/1e3;return this._accumulatedTimeFromStart+=(V-this._prevTime)*a,this._prevTime=V,{projectionMatrix:y,modelviewMatrix:N}}}class Kl extends ml{constructor(e){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new $n(e.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(e){const a=e.context;if(!this.particlesVx){const f=Jl(this.particlesCount),y=new i.eM,w=new i.b0;let I=0;const M=i.eq(1323123451230);for(let L=0;L<f.length;++L){const N=f[L],V=[2*M()-1,M(),M(),M()];y.emplaceBack(N[0],N[1],N[2],-1,-1,...V),y.emplaceBack(N[0],N[1],N[2],1,-1,...V),y.emplaceBack(N[0],N[1],N[2],1,1,...V),y.emplaceBack(N[0],N[1],N[2],-1,1,...V),w.emplaceBack(I+0,I+1,I+2),w.emplaceBack(I+0,I+2,I+3),I+=4}this.particlesVx=a.createVertexBuffer(y,Es.members),this.particlesIdx=a.createIndexBuffer(w)}}draw(e){if(!this._params.overrideStyleParameters&&!e.style.rain)return;const a=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},f=e.transform.zoom;if(a.revealStart>f)return;const y=ys(0,1,a.revealStart,a.revealStart+a.revealRange,f);if(!this.particlesVx||!this.particlesIdx)return;const w=structuredClone(this._params);let I=[-w.direction.x,w.direction.y,-100];i.aw(I,I);const M=structuredClone(this._vignetteParams);M.strength*=y,w.overrideStyleParameters||(w.intensity=e.style.rain.state.density,w.timeFactor=e.style.rain.state.intensity,w.color=structuredClone(e.style.rain.state.color),I=structuredClone(e.style.rain.state.direction),w.screenThinning.intensity=e.style.rain.state.centerThinning,w.dropletSizeX=e.style.rain.state.dropletSize[0],w.dropletSizeYScale=e.style.rain.state.dropletSize[1]/e.style.rain.state.dropletSize[0],w.distortionStrength=100*e.style.rain.state.distortionStrength,M.strength=1,M.color=structuredClone(e.style.rain.state.vignetteColor));const L=this.updateOnRender(e,w.timeFactor),N=e.context,V=N.gl,Z=e.transform;this.screenTexture&&this.screenTexture.size[0]===e.width&&this.screenTexture.size[1]===e.height||(this.screenTexture=new i.T(N,{width:e.width,height:e.height,data:null},V.RGBA8)),w.distortionStrength>0&&(N.activeTexture.set(V.TEXTURE0),this.screenTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),V.copyTexSubImage2D(V.TEXTURE_2D,0,0,0,0,0,e.width,e.height));const U=e.getOrCreateProgram("rainParticle");e.uploadCommonUniforms(N,U),N.activeTexture.set(V.TEXTURE0),this.screenTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE);const X=[w.color.r,w.color.g,w.color.b,w.color.a],Q=(nt,ht)=>{const lt=vr(this._movement.getPosition(),nt),_t=w.dropletSizeX,Ct=w.dropletSizeX*w.dropletSizeYScale,bt=e.width/2,Gt=e.height/2,zt=ys(0,w.screenThinning.start,0,1,w.screenThinning.intensity),Zt=ys(.001,w.screenThinning.range,0,1,w.screenThinning.intensity),Vt=ys(0,w.screenThinning.particleOffset,0,1,w.screenThinning.intensity),kt=(Ht={modelview:L.modelviewMatrix,projection:L.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:lt,velocityConeAperture:w.velocityConeAperture,velocity:w.velocity,boxSize:nt,rainDropletSize:[_t,Ct],distortionStrength:w.distortionStrength,rainDirection:I,color:X,screenSize:[Z.width,Z.height],thinningCenterPos:[bt,Gt],thinningShape:[zt,Zt,Math.pow(10,w.screenThinning.fadePower)],thinningAffectedRatio:w.screenThinning.affectedRatio,thinningParticleOffset:Vt,shapeDirectionalPower:w.shapeDirPower,shapeNormalPower:w.shapeNormalPower,mode:ht?0:1},{u_modelview:Float32Array.from(Ht.modelview),u_projection:Float32Array.from(Ht.projection),u_time:Ht.time,u_cam_pos:Ht.camPos,u_texScreen:0,u_velocityConeAperture:Ht.velocityConeAperture,u_velocity:Ht.velocity,u_boxSize:Ht.boxSize,u_rainDropletSize:Ht.rainDropletSize,u_distortionStrength:Ht.distortionStrength,u_rainDirection:Ht.rainDirection,u_color:Ht.color,u_screenSize:Ht.screenSize,u_thinningCenterPos:Ht.thinningCenterPos,u_thinningShape:Ht.thinningShape,u_thinningAffectedRatio:Ht.thinningAffectedRatio,u_thinningParticleOffset:Ht.thinningParticleOffset,u_shapeDirectionalPower:Ht.shapeDirectionalPower,u_shapeNormalPower:Ht.shapeNormalPower,u_mode:Ht.mode});var Ht;const pe=Math.round(w.intensity*this.particlesCount),ae=i.bf.simpleSegment(0,0,4*pe,2*pe);U.draw(e,V.TRIANGLES,zi.disabled,sr.disabled,yr.alphaBlended,Qi.disabled,kt,"rain_particles",this.particlesVx,this.particlesIdx,ae)};w.distortionStrength>0&&Q(w.boxSize,!0),Q(w.boxSize,!1),this._vignette.draw(e,M)}}const Fs=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class mc extends ml{constructor(e){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new $n(e.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(e){const a=e.context;if(!this.particlesVx){const f=Jl(this.particlesCount),y=new i.eN,w=new i.b0;let I=0;const M=i.eq(1323123451230);for(let L=0;L<f.length;++L){const N=f[L],V=M(),Z=M(),U=M(),X=[L/f.length,V,Z,U],Q=[M(),M()];y.emplaceBack(N[0],N[1],N[2],-1,-1,...X,...Q),y.emplaceBack(N[0],N[1],N[2],1,-1,...X,...Q),y.emplaceBack(N[0],N[1],N[2],1,1,...X,...Q),y.emplaceBack(N[0],N[1],N[2],-1,1,...X,...Q),w.emplaceBack(I+0,I+1,I+2),w.emplaceBack(I+0,I+2,I+3),I+=4}this.particlesVx=a.createVertexBuffer(y,Fs.members),this.particlesIdx=a.createIndexBuffer(w)}}draw(e){if(!this._params.overrideStyleParameters&&!e.style.snow)return;const a=structuredClone(this._params);let f=[-a.direction.x,a.direction.y,-100];i.aw(f,f);const y=structuredClone(this._vignetteParams),w=a.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},I=e.transform.zoom;if(w.revealStart>I)return;const M=ys(0,1,w.revealStart,w.revealStart+w.revealRange,I);y.strength*=M,a.overrideStyleParameters||(a.intensity=e.style.snow.state.density,a.timeFactor=e.style.snow.state.intensity,a.color=structuredClone(e.style.snow.state.color),f=structuredClone(e.style.snow.state.direction),a.screenThinning.intensity=e.style.snow.state.centerThinning,a.billboardSize=2.79*e.style.snow.state.flakeSize,y.strength=1,y.color=structuredClone(e.style.snow.state.vignetteColor));const L=this.updateOnRender(e,a.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const N=e.context,V=N.gl,Z=e.transform,U=e.getOrCreateProgram("snowParticle");e.uploadCommonUniforms(N,U),((X,Q,nt)=>{const ht=vr(this._movement.getPosition(),X),lt=Z.width/2,_t=Z.height/2,Ct=ys(0,nt.screenThinning.start,0,1,nt.screenThinning.intensity),bt=ys(.001,nt.screenThinning.range,0,1,nt.screenThinning.intensity),Gt=ys(0,nt.screenThinning.particleOffset,0,1,nt.screenThinning.intensity),zt=(Zt={modelview:L.modelviewMatrix,projection:L.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:ht,velocityConeAperture:nt.velocityConeAperture,velocity:nt.velocity,horizontalOscillationRadius:nt.horizontalOscillationRadius,horizontalOscillationRate:nt.horizontalOscillationRate,boxSize:X,billboardSize:1*nt.billboardSize,simpleShapeParameters:[nt.shapeFadeStart,nt.shapeFadePower],screenSize:[Z.width,Z.height],thinningCenterPos:[lt,_t],thinningShape:[Ct,bt,Math.pow(10,nt.screenThinning.fadePower)],thinningAffectedRatio:nt.screenThinning.affectedRatio,thinningParticleOffset:Gt,color:[nt.color.r,nt.color.g,nt.color.b,nt.color.a],direction:f},{u_modelview:Float32Array.from(Zt.modelview),u_projection:Float32Array.from(Zt.projection),u_time:Zt.time,u_cam_pos:Zt.camPos,u_velocityConeAperture:Zt.velocityConeAperture,u_velocity:Zt.velocity,u_horizontalOscillationRadius:Zt.horizontalOscillationRadius,u_horizontalOscillationRate:Zt.horizontalOscillationRate,u_boxSize:Zt.boxSize,u_billboardSize:Zt.billboardSize,u_simpleShapeParameters:Zt.simpleShapeParameters,u_screenSize:Zt.screenSize,u_thinningCenterPos:Zt.thinningCenterPos,u_thinningShape:Zt.thinningShape,u_thinningAffectedRatio:Zt.thinningAffectedRatio,u_thinningParticleOffset:Zt.thinningParticleOffset,u_particleColor:Zt.color,u_direction:Zt.direction});var Zt;const Vt=Math.round(nt.intensity*this.particlesCount),kt=i.bf.simpleSegment(0,0,4*Vt,2*Vt);this.particlesVx&&this.particlesIdx&&U.draw(e,V.TRIANGLES,zi.disabled,sr.disabled,yr.alphaBlended,Qi.disabled,zt,"snow_particles",this.particlesVx,this.particlesIdx,kt)})(a.boxSize,0,a),this._vignette.draw(e,y)}}const Wa={symbol:function(p,e,a,f,y){if(p.renderPass!=="translucent")return;const w=sr.disabled,I=p.colorModeForRenderPass(),M=a.layout.get("text-variable-anchor"),L=a.layout.get("text-size-scale-range"),N=i.aA(p.scaleFactor,L[0],L[1]);M&&function(U,X,Q,nt,ht,lt,_t,Ct){const bt=X.transform,Gt=ht==="map",zt=lt==="map";for(const Zt of U){const Vt=nt.getTile(Zt),kt=Vt.getBucket(Q);if(!kt||!kt.text||!kt.text.segments.get().length)continue;const Ht=i.bJ(kt.textSizeData,bt.zoom,Ct),pe=Cn(Zt,kt.getProjection(),bt),ae=bt.calculatePixelsToTileUnitsMatrix(Vt),Ce=Xc(pe,Vt.tileID.canonical,zt,Gt,bt,kt.getProjection(),ae),ve=kt.hasIconTextFit()&&kt.hasIconData();Ht&&Ep(kt,Gt,zt,_t,bt,Ce,Zt,Math.pow(2,bt.zoom-Vt.tileID.overscaledZ),Ht,ve)}}(f,p,a,e,a.layout.get("text-rotation-alignment"),a.layout.get("text-pitch-alignment"),y,N);const V=a.paint.get("icon-opacity").constantOr(1)!==0,Z=a.paint.get("text-opacity").constantOr(1)!==0;a.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(V||Z)?qd(p,e,a,f,w,I):(V&&qd(p,e,a,f,w,I,{onlyIcons:!0}),Z&&qd(p,e,a,f,w,I,{onlyText:!0})),e.map.showCollisionBoxes&&(lh(p,e,a,f,a.paint.get("text-translate"),a.paint.get("text-translate-anchor"),!0),lh(p,e,a,f,a.paint.get("icon-translate"),a.paint.get("icon-translate-anchor"),!1))},circle:function(p,e,a,f){if(p.renderPass!=="translucent")return;const y=a.paint.get("circle-opacity"),w=a.paint.get("circle-stroke-width"),I=a.paint.get("circle-stroke-opacity"),M=a.layout.get("circle-sort-key").constantOr(1)!==void 0,L=a.paint.get("circle-emissive-strength");if(y.constantOr(1)===0&&(w.constantOr(1)===0||I.constantOr(1)===0))return;const N=p.context,V=N.gl,Z=p.transform,U=!(!p.terrain||!p.terrain.enabled),X=a.layout.get("circle-elevation-reference"),Q=p.depthModeForSublayer(0,zi.ReadOnly),nt=new zi(p.context.gl.LEQUAL,zi.ReadOnly,p.depthRangeFor3D),ht=X==="none"||U?Q:nt,lt=sr.disabled,_t=p.colorModeForDrapableLayerRenderPass(L),Ct=Z.projection.name==="globe",bt=[i.aF(Z.center.lng),i.aJ(Z.center.lat)],Gt=[];for(let Zt=0;Zt<f.length;Zt++){const Vt=f[Zt],kt=e.getTile(Vt),Ht=kt.getBucket(a);if(!Ht||Ht.projection.name!==Z.projection.name)continue;const pe=Ht.programConfigurations.get(a.id),ae=Ht.layoutVertexBuffer,Ce=Ht.globeExtVertexBuffer,ve=Ht.indexBuffer,Fe=i.d$(a),oi=[Ce],ge=p.isTileAffectedByFog(Vt);Ct&&Fe.push("PROJECTION_GLOBE_VIEW"),Fe.push("DEPTH_D24"),p.terrain&&Z.depthOcclusionForSymbolsAndCircles&&Fe.push("DEPTH_OCCLUSION"),Ht.hasElevation&&!p.terrain&&(Fe.push("ELEVATED_ROADS"),oi.push(Ht.elevatedLayoutVertexBuffer));const re=p.getOrCreateProgram("circle",{config:pe,defines:Fe,overrideFog:ge}),Be=Z.projection.createInversionMatrix(Z,Vt.canonical),Te={programConfiguration:pe,program:re,layoutVertexBuffer:ae,dynamicBuffers:oi,indexBuffer:ve,uniformValues:i.e0(p,Vt,kt,Be,bt,a),tile:kt};if(M){const qe=Ht.segments.get();for(const si of qe)Gt.push({segments:new i.bf([si]),sortKey:si.sortKey,state:Te})}else Gt.push({segments:Ht.segments,sortKey:0,state:Te})}M&&Gt.sort((Zt,Vt)=>Zt.sortKey-Vt.sortKey);const zt={useDepthForOcclusion:Z.depthOcclusionForSymbolsAndCircles};for(const Zt of Gt){const{programConfiguration:Vt,program:kt,layoutVertexBuffer:Ht,dynamicBuffers:pe,indexBuffer:ae,uniformValues:Ce,tile:ve}=Zt.state,Fe=Zt.segments;p.terrain&&p.terrain.setupElevationDraw(ve,kt,zt),p.uploadCommonUniforms(N,kt,ve.tileID.toUnwrapped()),kt.draw(p,V.TRIANGLES,ht,lt,_t,Qi.disabled,Ce,a.id,Ht,ae,Fe,a.paint,Z.zoom,Vt,pe)}},heatmap:function(p,e,a,f){if(a.paint.get("heatmap-opacity")!==0)if(p.renderPass==="offscreen"){const y=p.context,w=y.gl,I=sr.disabled,M=new yr([w.ONE,w.ONE,w.ONE,w.ONE],i.ao.transparent,[!0,!0,!0,!0]);(function(X,Q,nt,ht){const lt=X.gl,_t=Q.width*ht,Ct=Q.height*ht;X.activeTexture.set(lt.TEXTURE1),X.viewport.set([0,0,_t,Ct]);let bt=nt.heatmapFbo;if(!bt||bt&&(bt.width!==_t||bt.height!==Ct)){bt&&bt.destroy();const Gt=lt.createTexture();lt.bindTexture(lt.TEXTURE_2D,Gt),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_WRAP_S,lt.CLAMP_TO_EDGE),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_WRAP_T,lt.CLAMP_TO_EDGE),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_MIN_FILTER,lt.LINEAR),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_MAG_FILTER,lt.LINEAR),bt=nt.heatmapFbo=X.createFramebuffer(_t,Ct,!0,null),function(zt,Zt,Vt,kt,Ht,pe){const ae=zt.gl;ae.texImage2D(ae.TEXTURE_2D,0,zt.extRenderToTextureHalfFloat?ae.RGBA16F:ae.RGBA,Ht,pe,0,ae.RGBA,zt.extRenderToTextureHalfFloat?ae.HALF_FLOAT:ae.UNSIGNED_BYTE,null),kt.colorAttachment.set(Vt)}(X,0,Gt,bt,_t,Ct)}else lt.bindTexture(lt.TEXTURE_2D,bt.colorAttachment.get()),X.bindFramebuffer.set(bt.framebuffer)})(y,p,a,p.transform.projection.name==="globe"?.5:.25),y.clear({color:i.ao.transparent});const L=p.transform,N=L.projection.name==="globe",V=N?["PROJECTION_GLOBE_VIEW"]:[],Z=N?Qi.frontCCW:Qi.disabled,U=[i.aF(L.center.lng),i.aJ(L.center.lat)];for(let X=0;X<f.length;X++){const Q=f[X];if(e.hasRenderableParent(Q))continue;const nt=e.getTile(Q),ht=nt.getBucket(a);if(!ht||ht.projection.name!==L.projection.name)continue;const lt=p.isTileAffectedByFog(Q),_t=ht.programConfigurations.get(a.id),Ct=p.getOrCreateProgram("heatmap",{config:_t,defines:V,overrideFog:lt}),{zoom:bt}=p.transform;p.terrain&&p.terrain.setupElevationDraw(nt,Ct),p.uploadCommonUniforms(y,Ct,Q.toUnwrapped());const Gt=L.projection.createInversionMatrix(L,Q.canonical);Ct.draw(p,w.TRIANGLES,zi.disabled,I,M,Z,gf(p,Q,nt,Gt,U,bt,a.paint.get("heatmap-intensity")),a.id,ht.layoutVertexBuffer,ht.indexBuffer,ht.segments,a.paint,p.transform.zoom,_t,N?[ht.globeExtVertexBuffer]:null)}y.viewport.set([0,0,p.width,p.height])}else p.renderPass==="translucent"&&(p.context.setColorMode(p.colorModeForRenderPass()),function(y,w){const I=y.context,M=I.gl,L=w.heatmapFbo;if(!L)return;I.activeTexture.set(M.TEXTURE0),M.bindTexture(M.TEXTURE_2D,L.colorAttachment.get()),I.activeTexture.set(M.TEXTURE1);let N=w.colorRampTexture;N||(N=w.colorRampTexture=new i.T(I,w.colorRamp,M.RGBA8)),N.bind(M.LINEAR,M.CLAMP_TO_EDGE),y.getOrCreateProgram("heatmapTexture").draw(y,M.TRIANGLES,zi.disabled,sr.disabled,y.colorModeForRenderPass(),Qi.disabled,((V,Z,U,X)=>({u_image:0,u_color_ramp:1,u_opacity:Z.paint.get("heatmap-opacity")}))(0,w),w.id,y.viewportBuffer,y.quadTriangleIndexBuffer,y.viewportSegments,w.paint,y.transform.zoom)}(p,a))},line:function(p,e,a,f){if(p.renderPass!=="translucent")return;const y=a.paint.get("line-opacity"),w=a.paint.get("line-width");if(y.constantOr(1)===0||w.constantOr(1)===0)return;const I=a.paint.get("line-emissive-strength"),M=a.paint.get("line-occlusion-opacity"),L=a.layout.get("line-elevation-reference"),N=a.layout.get("line-width-unit")==="meters",V=L==="sea",Z=!(!p.terrain||!p.terrain.enabled),U=p.context,X=U.gl;if(a.hasElevatedBuckets&&p.transform.projection.name==="globe")return;const Q=a.layout.get("line-cross-slope"),nt=Q!==void 0,ht=Q<1,lt=p.colorModeForDrapableLayerRenderPass(I),_t=p.terrain&&p.terrain.renderingToTexture,Ct=_t?1:i.o.devicePixelRatio,bt=a.paint.get("line-dasharray"),Gt=bt.constantOr(1),zt=a.layout.get("line-cap"),Zt=bt.constantOr(null),Vt=zt.constantOr(null),kt=a.paint.get("line-pattern"),Ht=kt.constantOr(1),pe=a.paint.get("line-pattern-cross-fade"),ae=kt.constantOr(null),Ce=a.paint.get("line-opacity").constantOr(1);let ve=!Ht&&Ce!==1||p.depthOcclusion&&M>0&&M<1;const Fe=a.paint.get("line-gradient"),oi=Ht?"linePattern":"line",ge=i.e1(a);let re;if(_t&&p.terrain&&p.terrain.clipOrMaskOverlapStencilType()&&(ve=!1),M!==0&&p.depthOcclusion){const si=a.paint._values["line-opacity"];si&&si.value&&si.value.kind==="constant"?re=si.value:i.w(`Occlusion opacity for layer ${a.id} is supported only when line-opacity isn't data-driven.`)}w.value.kind!=="constant"&&w.value.isLineProgressConstant===!1&&ge.push("VARIABLE_LINE_WIDTH");const Be=(si,Ci,ni,li,Li,Ti)=>{for(const xi of si){const Ii=e.getTile(xi);if(Ht&&!Ii.patternsLoaded())continue;const Zi=Ii.getBucket(a);if(!Zi||Zi.elevationType!=="none"&&!Li||Zi.elevationType==="none"&&Li)continue;p.prepareDrawTile();const Fr=[...Ci],qr=p.shadowRenderer,En=Zi.elevationType==="road"&&!!qr&&qr.enabled;let ar=[0,0,0];if(En){const cr=p.style.directionalLight,Wr=p.style.ambientLight;cr&&Wr&&(ar=hl(p.style,cr,Wr)),Fr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const jr=Zi.programConfigurations.get(a.id);let br=!1;if(ae&&Ii.imageAtlas){const cr=i.e2.from(ae),Wr=cr.getPrimary().scaleSelf(Ct).toString(),fo=Ii.imageAtlas.patternPositions.get(Wr),Uo=cr.getSecondary(),So=Uo?Ii.imageAtlas.patternPositions.get(Uo.scaleSelf(Ct).toString()):null;br=!!fo&&!!So,fo&&jr.setConstantPatternPositions(fo,So)}pe>0&&(br||jr.getPatternTransitionVertexBuffer("line-pattern"))&&Fr.push("LINE_PATTERN_TRANSITION");const xn=p.isTileAffectedByFog(xi),Vr=p.getOrCreateProgram(oi,{config:jr,defines:Fr,overrideFog:xn});if(!Ht&&Zt&&Vt&&Ii.lineAtlas){const cr=Ii.lineAtlas.getDash(Zt,Vt);cr&&jr.setConstantPatternPositions(cr)}En&&qr.setupShadows(Ii.tileID.toUnwrapped(),Vr,"vector-tile");let[kn,Kr]=a.paint.get("line-trim-offset");(Vt==="round"||Vt==="square")&&kn!==Kr&&(kn===0&&(kn-=1),Kr===1&&(Kr+=1));const wr=_t?xi.projMatrix:null,ln=N?1/Zi.tileToMeter/i.ay(Ii,1,p.transform.zoom):1,Er=N?1/Zi.tileToMeter/i.ay(Ii,1,Math.floor(p.transform.zoom)):1,eo=Ht?i.e3(p,Ii,a,wr,Ct,ln,Er,[kn,Kr],ar,pe):i.e4(p,Ii,a,wr,Zi.lineClipsArray.length,Ct,ln,Er,[kn,Kr],ar);if(Fe){const cr=Zi.gradients[a.id];let Wr=cr.texture;if(a.gradientVersion!==cr.version){let fo=256;if(a.stepInterpolant){const Uo=e.getSource().maxzoom,So=xi.canonical.z===Uo?Math.ceil(1<<p.transform.maxZoom-xi.canonical.z):1;fo=i.aA(i.e5(Zi.maxLineLength/i.al*1024*So),256,U.maxTextureSize)}cr.gradient=i.e6({expression:a.gradientExpression(),evaluationKey:"lineProgress",resolution:fo,image:cr.gradient||void 0,clips:Zi.lineClipsArray}),cr.texture?cr.texture.update(cr.gradient):cr.texture=new i.T(U,cr.gradient,X.RGBA8),cr.version=a.gradientVersion,Wr=cr.texture}U.activeTexture.set(X.TEXTURE1),Wr.bind(a.stepInterpolant?X.NEAREST:X.LINEAR,X.CLAMP_TO_EDGE)}Gt&&(U.activeTexture.set(X.TEXTURE0),Ii.lineAtlasTexture&&Ii.lineAtlasTexture.bind(X.LINEAR,X.REPEAT),jr.updatePaintBuffers()),Ht&&(U.activeTexture.set(X.TEXTURE0),Ii.imageAtlasTexture&&Ii.imageAtlasTexture.bind(X.LINEAR,X.CLAMP_TO_EDGE),jr.updatePaintBuffers()),Li&&!V&&p.terrain.setupElevationDraw(Ii,Vr),p.uploadCommonUniforms(U,Vr,xi.toUnwrapped());const cn=cr=>{re!=null&&(re.value=Ce*M),Vr.draw(p,X.TRIANGLES,ni,cr,lt,Qi.disabled,eo,a.id,Zi.layoutVertexBuffer,Zi.indexBuffer,Zi.segments,a.paint,p.transform.zoom,jr,[Zi.layoutVertexBuffer2,Zi.patternVertexBuffer,Zi.zOffsetVertexBuffer]),re!=null&&(re.value=Ce)};if(ve&&!Li){const cr=p.stencilModeForClipping(xi).ref;cr===0&&_t&&U.clear({stencil:0});const Wr={func:X.EQUAL,mask:255};eo.u_alpha_discard_threshold=.8,cn(new sr(Wr,cr,255,X.KEEP,X.KEEP,X.INVERT)),eo.u_alpha_discard_threshold=0,cn(new sr(Wr,cr,255,X.KEEP,X.KEEP,X.KEEP))}else eo.u_alpha_discard_threshold=ve&&Li&&Ti?.8:0,cn(Li?li:p.stencilModeForClipping(xi))}};let Te=p.depthModeForSublayer(0,zi.ReadOnly);const qe=new zi(p.depthOcclusion?X.GREATER:X.LEQUAL,zi.ReadOnly,p.depthRangeFor3D);if(a.hasNonElevatedBuckets){const si=!_t&&p.terrain;M!==0&&si?i.w(`Occlusion opacity for layer ${a.id} is supported on terrain only if the layer has line-z-offset enabled.`):si?i.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${a.id}.`):Be(f,ge,Te,sr.disabled,!1,!0)}if(a.hasElevatedBuckets){L==="hd-road-markup"?Z||(Te=qe,ge.push("ELEVATED_ROADS")):(ge.push("ELEVATED"),Te=qe,nt&&ge.push(ht?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),V&&ge.push("ELEVATION_REFERENCE_SEA"));const si=ve?p.stencilModeFor3D():sr.disabled;p.forceTerrainMode=!0,Be(f,ge,Te,si,!0,!0),ve&&Be(f,ge,Te,si,!0,!1),p.forceTerrainMode=!1}ve&&(p.resetStencilClippingMasks(),_t&&U.clear({stencil:0})),M===0||p.depthOcclusion||_t||p.layersWithOcclusionOpacity.push(p.currentLayer)},fill:function(p,e,a,f){const y=a.paint.get("fill-color"),w=a.paint.get("fill-opacity");if(w.constantOr(1)===0)return;const I=a.paint.get("fill-emissive-strength"),M=p.colorModeForDrapableLayerRenderPass(I),L=a.paint.get("fill-pattern"),N=p.opaquePassEnabledForLayer()&&!L.constantOr(1)&&y.constantOr(i.ao.transparent).a===1&&w.constantOr(0)===1?"opaque":"translucent";let V="none";a.layout.get("fill-elevation-reference")!=="none"?V="road":a.paint.get("fill-z-offset").constantOr(1)!==0&&(V="offset");const Z=!(!p.terrain||!p.terrain.enabled),U={painter:p,sourceCache:e,layer:a,coords:f,colorMode:M,elevationType:V,terrainEnabled:Z,pass:N};if(p.renderPass!=="shadow")if(V!=="offset"){if(Go(U,!1),V==="road"){const X=!Z&&p.renderPass==="translucent";X&&to(p,e,a,f,"geometry"),Go(U,!0,sr.disabled),X&&function(Q){const{painter:nt,sourceCache:ht,layer:lt,coords:_t,colorMode:Ct}=Q,bt=nt.context.gl,Gt=Q.painter.shadowRenderer,zt=!!Gt&&Gt.enabled,Zt=new zi(nt.context.gl.LEQUAL,zi.ReadOnly,nt.depthRangeFor3D);let Vt=[0,0,0];if(zt){const Ht=nt.style.directionalLight,pe=nt.style.ambientLight;Ht&&pe&&(Vt=hl(nt.style,Ht,pe))}const kt=Ht=>{for(const pe of _t){const ae=ht.getTile(pe),Ce=ae.getBucket(lt);if(!Ce)continue;const ve=Ce.elevatedStructures;if(!ve)continue;let Fe,oi;if(Ht?(Fe=ve.renderableBridgeSegments,oi=ve.bridgeProgramConfigurations.get(lt.id)):(Fe=ve.renderableTunnelSegments,oi=ve.tunnelProgramConfigurations.get(lt.id)),!Fe||Fe.segments[0].primitiveLength===0)continue;oi.updatePaintBuffers(),nt.prepareDrawTile();const ge=nt.isTileAffectedByFog(pe),re=[];zt&&re.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Be=nt.getOrCreateProgram("elevatedStructures",{config:oi,overrideFog:ge,defines:re}),Te=nt.translatePosMatrix(pe.projMatrix,ae,lt.paint.get("fill-translate"),lt.paint.get("fill-translate-anchor"));zt&&Gt.setupShadows(ae.tileID.toUnwrapped(),Be,"vector-tile");const qe=sh(Te,Vt);nt.uploadCommonUniforms(nt.context,Be,pe.toUnwrapped()),Be.draw(nt,bt.TRIANGLES,Zt,sr.disabled,Ct,Qi.backCCW,qe,lt.id,ve.vertexBuffer,ve.indexBuffer,Fe,lt.paint,nt.transform.zoom,oi,[ve.vertexBufferNormal])}};kt(!0),kt(!1)}(U)}}else Go(U,!1,p.stencilModeFor3D());else p.shadowRenderer&&V==="road"&&!Z&&function(X){const{painter:Q,sourceCache:nt,layer:ht,coords:lt}=X,_t=Q.context.gl,Ct=X.painter.shadowRenderer;for(const bt of lt){const Gt=nt.getTile(bt),zt=Gt.getBucket(ht);if(!zt)continue;const Zt=zt.elevatedStructures;if(!Zt||!Zt.shadowCasterSegments||Zt.shadowCasterSegments.segments[0].primitiveLength===0)continue;Q.prepareDrawTile();const Vt=zt.bufferData.programConfigurations.get(ht.id),kt=Q.isTileAffectedByFog(bt),Ht=Q.getOrCreateProgram("elevatedStructuresDepth",{config:Vt,overrideFog:kt}),pe=Ct.calculateShadowPassMatrixFromTile(Gt.tileID.toUnwrapped());Q.uploadCommonUniforms(Q.context,Ht,bt.toUnwrapped());const ae={u_matrix:pe,u_depth_bias:0};Ht.draw(Q,_t.TRIANGLES,Ct.getShadowPassDepthMode(),sr.disabled,Ct.getShadowPassColorMode(),Qi.disabled,ae,ht.id,Zt.vertexBuffer,Zt.indexBuffer,Zt.shadowCasterSegments,ht.paint,Q.transform.zoom,Vt)}}(U)},"fill-extrusion":function(p,e,a,f){const y=a.paint.get("fill-extrusion-opacity"),w=p.context,I=w.gl,M=p.terrain,L=M&&M.renderingToTexture;if(y===0)return;const N=p.conflationActive&&p.style.isLayerClipped(a,e.getSource()),V=p.style.order.indexOf(a.fqid);if(N&&function(Z,U,X,Q,nt){for(const ht of Q){const lt=U.getTile(ht).getBucket(X);lt&&(lt.updateReplacement(ht,Z.replacementSource,nt),lt.uploadCentroid(Z.context))}}(p,e,a,f,V),M||N)for(const Z of f){const U=e.getTile(Z).getBucket(a);U&&Nc(p.context,e,Z,U,a,M,N)}if(p.renderPass==="shadow"&&p.shadowRenderer){const Z=p.shadowRenderer;if(M&&y<.65&&a._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof i.ad)return;const U=Z.getShadowPassDepthMode(),X=Z.getShadowPassColorMode();Si(p,e,a,f,U,sr.disabled,X,N)}else if(p.renderPass==="translucent"){const Z=!a.paint.get("fill-extrusion-pattern").constantOr(1),U=a.paint.get("fill-extrusion-color").constantOr(i.ao.white);if(!L&&U.a!==0){const X=new zi(p.context.gl.LEQUAL,zi.ReadWrite,p.depthRangeFor3D);y===1&&Z?Si(p,e,a,f,X,sr.disabled,yr.unblended,N):(Si(p,e,a,f,X,sr.disabled,yr.disabled,N),Si(p,e,a,f,X,p.stencilModeFor3D(),p.colorModeForRenderPass(),N),p.resetStencilClippingMasks())}if(p.style.enable3dLights()&&Z&&(!M&&p.transform.projection.name!=="globe"||L)){const X=a.paint.get("fill-extrusion-opacity"),Q=a.paint.get("fill-extrusion-ambient-occlusion-intensity"),nt=a.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),ht=a.paint.get("fill-extrusion-flood-light-intensity"),lt=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",_t=a.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(lt?null:a.lut).toArray01().slice(0,3),Ct=Q>0&&nt>0,bt=ht>0,Gt=(Vt,kt,Ht)=>(1-Ht)*Vt+Ht*kt,zt=new Su;zt.translate=a.paint.get("fill-extrusion-translate"),zt.translateAnchor=a.paint.get("fill-extrusion-translate-anchor"),zt.edgeRadius=a.layout.get("fill-extrusion-edge-radius"),zt.cutoffFadeRange=a.paint.get("fill-extrusion-cutoff-fade-range");const Zt=Vt=>{const kt=p.depthModeForSublayer(1,zi.ReadOnly,I.LEQUAL,!0),Ht=a.paint.get(Vt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),pe=Gt(.1,3,Ht),ae=p._showOverdrawInspector;if(!ae){const Ce=new sr({func:I.ALWAYS,mask:255},255,255,I.KEEP,I.KEEP,I.REPLACE),ve=new yr([I.ONE,I.ONE,I.ONE,I.ONE],i.ao.transparent,[!1,!1,!1,!0],I.MIN);zl(zt,p,e,a,f,kt,Ce,ve,Qi.disabled,Vt,"sdf",X,Q,nt,ht,_t,pe,N,!1)}{const Ce=ae?sr.disabled:new sr({func:I.EQUAL,mask:255},255,255,I.KEEP,I.DECR,I.DECR),ve=ae?p.colorModeForRenderPass():new yr([I.ONE_MINUS_DST_ALPHA,I.DST_ALPHA,I.ONE,I.ONE],i.ao.transparent,[!0,!0,!0,!0]);zl(zt,p,e,a,f,kt,Ce,ve,Qi.disabled,Vt,"color",X,Q,nt,ht,_t,pe,N,!1)}};if(L){const Vt=(kt,Ht,pe)=>{const ae=p.depthModeForSublayer(1,zi.ReadOnly,I.LEQUAL,!1),Ce=a.paint.get(kt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ve=Gt(.1,3,Ce);{const Fe=new yr([I.ONE,I.ONE,I.ONE,I.ONE],i.ao.transparent,[!1,!1,!1,!0]);zl(zt,p,e,a,f,ae,sr.disabled,Fe,Qi.disabled,kt,"clear",X,Q,nt,ht,_t,ve,N,Ht)}{const Fe=new sr({func:I.ALWAYS,mask:255},255,255,I.KEEP,I.KEEP,I.REPLACE),oi=new yr([I.ONE,I.ONE,I.ONE,I.ONE],i.ao.transparent,[!1,!1,!1,!0],I.MIN);zl(zt,p,e,a,f,ae,Fe,oi,Qi.disabled,kt,"sdf",X,Q,nt,ht,_t,ve,N,Ht)}{const Fe=kt?I.ZERO:I.ONE_MINUS_DST_ALPHA,oi=new sr({func:I.EQUAL,mask:255},255,255,I.KEEP,I.DECR,I.DECR),ge=new yr([Fe,I.DST_ALPHA,I.ONE_MINUS_DST_ALPHA,I.ZERO],i.ao.transparent,[!0,!0,!0,!0]);zl(zt,p,e,a,f,ae,oi,ge,Qi.disabled,kt,"color",X,Q,nt,ht,_t,ve,N,Ht)}{const Fe=new yr([I.ONE,I.ONE,I.ONE,kt?I.ZERO:I.ONE],i.ao.transparent,[!1,!1,!1,!0],kt?I.FUNC_ADD:I.MAX);zl(zt,p,e,a,f,ae,sr.disabled,Fe,Qi.disabled,kt,"clear",X,Q,nt,ht,_t,ve,N,Ht,pe)}};if(Ct||bt){let kt;if(p.prepareDrawTile(),M){const Ht=M.drapeBufferSize[0],pe=M.drapeBufferSize[1];kt=M.framebufferCopyTexture,kt&&(!kt||kt.size[0]===Ht&&kt.size[1]===pe)||(kt&&kt.destroy(),kt=M.framebufferCopyTexture=new i.T(w,new i.q({width:Ht,height:pe}),I.RGBA8)),kt.bind(I.LINEAR,I.CLAMP_TO_EDGE),I.copyTexSubImage2D(I.TEXTURE_2D,0,0,0,0,0,Ht,pe)}Ct&&Vt(!0,!1,kt),bt&&Vt(!1,!0,kt)}}else Ct&&Zt(!0),bt&&Zt(!1),(Ct||bt)&&p.resetStencilClippingMasks()}}},building:function(p,e,a,f){p.currentLayer<p.firstLightBeamLayer&&(p.firstLightBeamLayer=p.currentLayer);const y=a.paint.get("building-ambient-occlusion-ground-intensity"),w=a.paint.get("building-ambient-occlusion-ground-radius"),I=a.paint.get("building-ambient-occlusion-ground-attenuation"),M=a.paint.get("building-opacity");if(M<=0)return;let L=y>0&&w>0,N=!0;const V=a.paint.get("building-vertical-scale");if(V<=0)return;(!p.shadowRenderer||V<1)&&(N=!1);const Z=p.conflationActive&&p.style.isLayerClipped(a,e.getSource()),U=p.style.order.indexOf(a.fqid);if(function(X,Q,nt,ht,lt,_t){for(const Ct of _t){const bt=Q.getTile(Ct).getBucket(nt);bt&&(lt&&bt.updateReplacement(Ct,X.replacementSource,ht),bt.uploadUpdatedIndexBuffer(X.context))}}(p,e,a,U,Z,f),function(X,Q,nt,ht){for(const lt of ht){const _t=Q.getTile(lt).getBucket(nt);_t&&_t.needsEvaluation()&&_t.uploadUpdatedColorBuffer(X.context)}}(p,e,a,f),a.resetLayerRenderingStats(p),p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!0),p.renderPass==="shadow"&&p.shadowRenderer){const X=p.shadowRenderer,Q=[],nt=X.getShadowPassDepthMode();Iu({painter:p,source:e,layer:a,coords:f,defines:Q,blendMode:X.getShadowPassColorMode(),depthMode:nt,opacity:M,verticalScale:V,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(p.renderPass==="translucent"){let X=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];N&&(X=X.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),p.shadowRenderer&&p.shadowRenderer.useNormalOffset&&(X=X.concat("NORMAL_OFFSET"));const Q=a.paint.get("building-facade-emissive-chance"),nt=a.paint.get("building-ambient-occlusion-intensity"),ht=a.paint.get("building-flood-light-intensity"),lt=a.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",_t=a.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(lt?null:a.lut).toArray01().slice(0,3),Ct=a.paint.get("building-flood-light-ground-attenuation"),bt=ht>0,Gt=new zi(p.context.gl.LEQUAL,zi.ReadWrite,p.depthRangeFor3D);M<1&&Iu({painter:p,source:e,layer:a,coords:f,defines:X,blendMode:yr.disabled,depthMode:Gt,opacity:M,verticalScale:V,facadeEmissiveChance:Q,facadeAOIntensity:nt,floodLightIntensity:ht,floodLightColor:_t,depthOnly:!0});const zt=p.colorModeForRenderPass();Iu({painter:p,source:e,layer:a,coords:f,defines:X,blendMode:zt,depthMode:Gt,opacity:M,verticalScale:V,facadeEmissiveChance:Q,facadeAOIntensity:nt,floodLightIntensity:ht,floodLightColor:_t}),L&&Wh(p,e,a,f,!0,M,y,w,ht,_t,I,Z),bt&&Wh(p,e,a,f,!1,M,y,w,ht,_t,Ct,Z)}else if(p.renderPass==="light-beam"){const X=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],Q=new zi(p.context.gl.LEQUAL,zi.ReadOnly,p.depthRangeFor3D);Iu({painter:p,source:e,layer:a,coords:f,defines:X,blendMode:yr.alphaBlended,depthMode:Q,opacity:M,verticalScale:V,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!1),p.resetStencilClippingMasks()},hillshade:function(p,e,a,f){if(p.renderPass!=="offscreen"&&p.renderPass!=="translucent"||p.style.disableElevatedTerrain)return;const y=p.context,w=p.terrain&&p.terrain.renderingToTexture,[I,M]=p.renderPass!=="translucent"||w?[{},f]:p.stencilConfigForOverlap(f);for(const L of M){const N=e.getTile(L);if(N.needsHillshadePrepare&&p.renderPass==="offscreen")mp(p,N,a);else if(p.renderPass==="translucent"){const V=p.depthModeForSublayer(0,zi.ReadOnly),Z=a.paint.get("hillshade-emissive-strength"),U=p.colorModeForDrapableLayerRenderPass(Z),X=w&&p.terrain?p.terrain.stencilModeForRTTOverlap(L):I[L.overscaledZ];Mm(p,L,N,a,V,X,U)}}y.viewport.set([0,0,p.width,p.height]),p.resetStencilClippingMasks()},raster:function(p,e,a,f,y,w){if(p.renderPass!=="translucent"||a.paint.get("raster-opacity")===0)return;const I=p.transform.projection.name==="globe",M=a.paint.get("raster-elevation")!==0,L=M&&I;if(p.renderElevatedRasterBackface&&!L)return;const N=p.context,V=N.gl,Z=e.getSource(),U=function(zt,Zt,Vt,kt){const Ht=Zt.paint.get("raster-color"),pe=zt.type==="raster-array",ae=[],Ce=Zt.paint.get("raster-resampling"),ve=Zt.paint.get("raster-color-mix");let Fe=Zt.paint.get("raster-color-range");const oi=[ve[0],ve[1],ve[2],0],ge=ve[3];let re=Ce==="nearest"?kt.NEAREST:kt.LINEAR;if(pe&&(ae.push("RASTER_ARRAY"),Ht||ae.push("RASTER_COLOR"),Ce==="linear"&&ae.push("RASTER_ARRAY_LINEAR"),re=kt.NEAREST,!Fe&&zt.rasterLayers)){const Be=zt.rasterLayers.find(({id:Te})=>Te===Zt.sourceLayer);Be&&Be.fields&&Be.fields.range&&(Fe=Be.fields.range)}if(Fe=Fe||[0,1],Ht){ae.push("RASTER_COLOR"),Vt.activeTexture.set(kt.TEXTURE2),Zt.updateColorRamp(Fe);let Be=Zt.colorRampTexture;Be||(Be=Zt.colorRampTexture=new i.T(Vt,Zt.colorRamp,kt.RGBA8)),Be.bind(kt.LINEAR,kt.CLAMP_TO_EDGE)}return{mix:oi,range:Fe,offset:ge,defines:ae,resampling:re}}(Z,a,N,V);if(Z instanceof i.aT&&!f.length&&!I)return;const X=a.paint.get("raster-emissive-strength"),Q=p.colorModeForDrapableLayerRenderPass(X),nt=p.terrain&&p.terrain.renderingToTexture,ht=!p.options.moving,lt=a.paint.get("raster-resampling")==="nearest"?V.NEAREST:V.LINEAR;if(Z instanceof i.aT&&!f.length&&(Z.onNorthPole||Z.onSouthPole)){const zt=M?p.stencilModeFor3D():sr.disabled;return void Xh(!!Z.onNorthPole,null,p,e,a,X,U,Qi.disabled,zt)}if(!f.length)return;const[_t,Ct]=Z instanceof i.aT||nt?[{},f]:p.stencilConfigForOverlap(f),bt=Ct[Ct.length-1].overscaledZ;L&&U.defines.push("PROJECTION_GLOBE_VIEW"),M&&U.defines.push("RENDER_CUTOFF");const Gt=(zt,Zt,Vt)=>{for(const kt of zt){const Ht=kt.toUnwrapped(),pe=e.getTile(kt);if(nt&&(!pe||!pe.hasData()))continue;N.activeTexture.set(V.TEXTURE0);const ae=yf(pe,Z,a,U);if(!ae||!ae.texture)continue;const{texture:Ce,mix:ve,offset:Fe,tileSize:oi,buffer:ge}=ae;let re,Be;nt?(re=zi.disabled,Be=kt.projMatrix):M?(re=new zi(V.LEQUAL,zi.ReadWrite,p.depthRangeFor3D),Be=I?Float32Array.from(p.transform.expandedFarZProjMatrix):p.transform.calculateProjMatrix(Ht,ht)):(re=p.depthModeForSublayer(kt.overscaledZ-bt,a.paint.get("raster-opacity")===1?zi.ReadWrite:zi.ReadOnly,V.LESS),Be=p.transform.calculateProjMatrix(Ht,ht));const Te=p.terrain&&nt?p.terrain.stencilModeForRTTOverlap(kt):_t[kt.overscaledZ],qe=w?0:a.paint.get("raster-fade-duration");pe.registerFadeDuration(qe);const si=e.findLoadedParent(kt,0),Ci=_u(pe,si,e,p.transform,qe);let ni,li;!Ci.isFading&&pe.refreshedUponExpiration&&(pe.refreshedUponExpiration=!1),p.terrain&&p.terrain.prepareDrawTile(),N.activeTexture.set(V.TEXTURE0),Ce.bind(lt,V.CLAMP_TO_EDGE),N.activeTexture.set(V.TEXTURE1),si?(si.texture&&si.texture.bind(lt,V.CLAMP_TO_EDGE),ni=Math.pow(2,si.tileID.overscaledZ-pe.tileID.overscaledZ),li=[pe.tileID.canonical.x*ni%1,pe.tileID.canonical.y*ni%1]):Ce.bind(lt,V.CLAMP_TO_EDGE),"useMipmap"in Ce&&N.extTextureFilterAnisotropic&&p.transform.pitch>20&&V.texParameterf(V.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);const Li=p.transform;let Ti;const xi=M?Yh(Li):[0,0,0,0];let Ii,Zi,Fr,qr,En,ar=0;if(L&&Z instanceof i.aT&&Z.coordinates.length>3)Ii=Float32Array.from(i.bj(i.dI(new i.cC(0,0,0)))),Zi=Float32Array.from(Li.globeMatrix),Fr=Float32Array.from(i.dE(Li)),qr=[i.aF(Li.center.lng),i.aJ(Li.center.lat)],Ti=Z.elevatedGlobePerspectiveTransform,En=Z.elevatedGlobeGridMatrix||new Float32Array(9);else if(L){const Vr=i.dF(kt.canonical);ar=i.dG(Vr.getCenter().lat),Ii=Float32Array.from(i.bj(i.dI(kt.canonical))),Zi=Float32Array.from(Li.globeMatrix),Fr=Float32Array.from(i.dE(Li)),qr=[i.aF(Li.center.lng),i.aJ(Li.center.lat)],Ti=[0,0],En=Float32Array.from(i.dH(kt.canonical,Vr,ar,Li.worldSize/Li._pixelsPerMercatorPixel))}else Ti=Z instanceof i.aT?Z.perspectiveTransform:[0,0],Ii=new Float32Array(16),Zi=new Float32Array(9),Fr=new Float32Array(16),qr=[0,0],En=new Float32Array(9);const jr=bu(Be,Ii,Zi,Fr,En,li||[0,0],i.aj(p.transform.zoom),qr,xi,ni||1,Ci,a,Ti,M?a.paint.get("raster-elevation"):0,2,ve,Fe,U.range,oi,ge,X),br=p.isTileAffectedByFog(kt),xn=p.getOrCreateProgram("raster",{defines:U.defines,overrideFog:br});if(p.uploadCommonUniforms(N,xn,Ht),Z instanceof i.aT){const Vr=Z.elevatedGlobeVertexBuffer,kn=Z.elevatedGlobeIndexBuffer;if(nt||!I)Z.boundsBuffer&&Z.boundsSegments&&xn.draw(p,V.TRIANGLES,re,sr.disabled,Q,Qi.disabled,jr,a.id,Z.boundsBuffer,p.quadTriangleIndexBuffer,Z.boundsSegments);else if(Vr&&kn){const Kr=Li.zoom<=i.cZ?Z.elevatedGlobeSegments:Z.getSegmentsForLongitude(Li.center.lng);Kr&&xn.draw(p,V.TRIANGLES,re,sr.disabled,Q,Zt,jr,a.id,Vr,kn,Kr)}}else if(L){re=new zi(V.LEQUAL,zi.ReadOnly,p.depthRangeFor3D);const Vr=p.globeSharedBuffers;if(Vr){const[kn,Kr,wr]=Vr.getGridBuffers(ar,!1);xn.draw(p,V.TRIANGLES,re,Vt||Te,p.colorModeForRenderPass(),Zt,jr,a.id,kn,Kr,wr)}}else{const{tileBoundsBuffer:Vr,tileBoundsIndexBuffer:kn,tileBoundsSegments:Kr}=p.getTileBoundsBuffers(pe);xn.draw(p,V.TRIANGLES,re,Te,Q,Qi.disabled,jr,a.id,Vr,kn,Kr)}}if(!(Z instanceof i.aT)&&L)for(const kt of zt){const Ht=kt.canonical.y===(1<<kt.canonical.z)-1;kt.canonical.y===0&&Xh(!0,kt,p,e,a,X,U,Zt,Vt||sr.disabled),Ht&&Xh(!1,kt,p,e,a,X,U,Zt===Qi.frontCW?Qi.backCW:Qi.frontCW,Vt||sr.disabled)}};L?Gt(Ct,p.renderElevatedRasterBackface?Qi.backCW:Qi.frontCW,p.stencilModeFor3D()):Gt(Ct,Qi.disabled,void 0),p.resetStencilClippingMasks()},"raster-particle":function(p,e,a,f,y,w){p.renderPass==="offscreen"&&function(I,M,L,N){if(!N.length)return;const V=I.context,Z=V.gl,U=M.getSource();if(!(U instanceof es))return;const X=Math.ceil(Math.sqrt(L.paint.get("raster-particle-count")));let Q=L.particlePositionRGBAImage;if(!Q||Q.width!==X){const Ct=function(bt){const Gt=bt*bt,zt=new Uint8Array(4*Gt),Zt=function(kt){return kt|=0,kt=Math.imul(2747636419^kt,2654435769),kt=Math.imul(kt^kt>>>16,2654435769),((kt=Math.imul(kt^kt>>>16,2654435769))>>>0)/4294967296},Vt=1/1.1;for(let kt=0;kt<Gt;kt++){const Ht=Vt*(Zt(2*kt+0)+wu),pe=Vt*(Zt(2*kt+1)+wu),ae=255*Ht%1,Ce=255*pe%1,ve=ae,Fe=pe-Ce/255,oi=Ce;zt[4*kt+0]=255*(Ht-ae/255),zt[4*kt+1]=255*ve,zt[4*kt+2]=255*Fe,zt[4*kt+3]=255*oi}return zt}(X);Q=L.particlePositionRGBAImage=new i.q({width:X,height:X},Ct)}let nt=L.particleFramebuffer;nt?nt.width!==X&&(nt.destroy(),nt=L.particleFramebuffer=V.createFramebuffer(X,X,!0,null)):nt=L.particleFramebuffer=V.createFramebuffer(X,X,!0,null);const ht=[];for(const Ct of N){const bt=M.getTile(Ct);if(!(bt instanceof as))continue;const Gt=hd(bt,U,L);if(!Gt)continue;const zt=[bt.tileSize,bt.tileSize];let Zt=L.tileFramebuffer;Zt||(Zt=L.tileFramebuffer=V.createFramebuffer(zt[0],zt[1],!0,null));let Vt=bt.rasterParticleState;Vt||(Vt=bt.rasterParticleState=new ks(V,Ct,zt,Q));const kt=Vt.update(L.lastInvalidatedAt);Vt.particleTextureDimension!==X&&Vt.updateParticleTexture(Ct,Q);const Ht=Vt.targetColorTexture;Vt.targetColorTexture=Vt.backgroundColorTexture,Vt.backgroundColorTexture=Ht;const pe=Vt.particleTexture0;Vt.particleTexture0=Vt.particleTexture1,Vt.particleTexture1=pe,ht.push([Ct,Gt,Vt,kt])}if(ht.length===0)return;const lt=i.o.now(),_t=L.previousDrawTimestamp?.001*(lt-L.previousDrawTimestamp):.0167;if(L.previousDrawTimestamp=lt,L.hasColorMap()){V.activeTexture.set(Z.TEXTURE0+2);let Ct=L.colorRampTexture;Ct||(Ct=L.colorRampTexture=new i.T(V,L.colorRamp,Z.RGBA8)),Ct.bind(Z.LINEAR,Z.CLAMP_TO_EDGE)}V.bindFramebuffer.set(L.tileFramebuffer.framebuffer),function(Ct,bt,Gt){const zt=Ct.context,Zt=zt.gl,Vt=bt.tileFramebuffer;zt.activeTexture.set(Zt.TEXTURE0);const kt={u_texture:0,u_opacity:1.05*(pe=bt.paint.get("raster-particle-fade-opacity-factor"))/(pe+.05)},Ht=Ct.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var pe;for(const ae of Gt){const[,,Ce,ve]=ae;Vt.colorAttachment.set(Ce.targetColorTexture.texture),zt.viewport.set([0,0,Vt.width,Vt.height]),zt.clear({color:i.ao.transparent}),ve&&(Ce.backgroundColorTexture.bind(Zt.NEAREST,Zt.CLAMP_TO_EDGE),Ht.draw(Ct,Zt.TRIANGLES,zi.disabled,sr.disabled,yr.alphaBlended,Qi.disabled,kt,bt.id,Ct.viewportBuffer,Ct.quadTriangleIndexBuffer,Ct.viewportSegments))}}(I,L,ht),function(Ct,bt,Gt,zt){const Zt=Ct.context,Vt=Zt.gl,kt=Gt.tileFramebuffer,Ht=Ct.transform.projection.name==="globe",pe=Gt.paint.get("raster-particle-max-speed");for(const ae of zt){const[Ce,ve,Fe]=ae;Zt.activeTexture.set(Vt.TEXTURE0+0),ve.texture.bind(Vt.LINEAR,Vt.CLAMP_TO_EDGE),kt.colorAttachment.set(Fe.targetColorTexture.texture);const oi=Ct.getOrCreateProgram("rasterParticleDraw",{defines:ve.defines,overrideFog:!1});Zt.activeTexture.set(Vt.TEXTURE0+1);const ge=ve.scalarData?[]:[0,1,2,3].map(Te=>i.e8[Te](Ce));ge.push(Ce);const re=Ce.canonical.x,Be=Ce.canonical.y;for(const Te of ge){const qe=bt.getTile(Ht?Te.wrapped():Te);if(!qe)continue;const si=qe.rasterParticleState;if(!si)continue;const Ci=Te.canonical.x+(1<<Te.canonical.z)*(Te.wrap-Ce.wrap),ni=Te.canonical.y;si.particleTexture0.bind(Vt.NEAREST,Vt.CLAMP_TO_EDGE);const li=Oc(1,si.particleTexture0.size[0],[Ci-re,ni-Be],0,ve.texture.size,2,pe,ve.textureOffset,ve.scale,ve.offset);oi.draw(Ct,Vt.POINTS,zi.disabled,sr.disabled,yr.alphaBlended,Qi.disabled,li,Gt.id,si.particleIndexBuffer,void 0,si.particleSegment)}}}(I,M,L,ht),V.bindFramebuffer.set(L.particleFramebuffer.framebuffer),function(Ct,bt,Gt,zt){const Zt=Ct.context,Vt=Zt.gl,kt=bt.paint.get("raster-particle-max-speed"),Ht=zt*bt.paint.get("raster-particle-speed-factor")*.15,pe=function(Ce){return Math.pow(Ce,6)}(.01+1*bt.paint.get("raster-particle-reset-rate-factor")),ae=bt.particleFramebuffer;Zt.viewport.set([0,0,ae.width,ae.height]);for(const Ce of Gt){const[,ve,Fe]=Ce;Zt.activeTexture.set(Vt.TEXTURE0+0),ve.texture.bind(Vt.LINEAR,Vt.CLAMP_TO_EDGE),Zt.activeTexture.set(Vt.TEXTURE0+1);const oi=Fe.particleTexture0;oi.bind(Vt.NEAREST,Vt.CLAMP_TO_EDGE);const ge=uo(1,oi.size[0],0,ve.texture.size,kt,Ht,pe,ve.textureOffset,ve.scale,ve.offset);ae.colorAttachment.set(Fe.particleTexture1.texture),Zt.clear({color:i.ao.transparent}),Ct.getOrCreateProgram("rasterParticleUpdate",{defines:ve.defines}).draw(Ct,Vt.TRIANGLES,zi.disabled,sr.disabled,yr.unblended,Qi.disabled,ge,bt.id,Ct.viewportBuffer,Ct.quadTriangleIndexBuffer,Ct.viewportSegments)}}(I,L,ht,_t)}(p,e,a,f),p.renderPass==="translucent"&&(function(I,M,L,N,V){const Z=I.context,U=Z.gl,X=M.getSource().tileSize,Q=5*(1-i.ah(i.cK,i.cK+1,I.transform.zoom))*X+L.paint.get("raster-particle-elevation"),nt=!I.options.moving,ht=I.transform.projection.name==="globe";if(!N.length)return;const[lt,_t]=I.stencilConfigForOverlap(N),Ct=[];ht&&Ct.push("PROJECTION_GLOBE_VIEW");const bt=I.stencilModeFor3D();for(const Gt of _t){const zt=Gt.toUnwrapped(),Zt=M.getTile(Gt);if(!Zt.rasterParticleState)continue;const Vt=Zt.rasterParticleState,kt=100;Zt.registerFadeDuration(kt);const Ht=M.findLoadedParent(Gt,0),pe=_u(Zt,Ht,M,I.transform,kt);let ae,Ce;I.terrain&&I.terrain.prepareDrawTile(),Z.activeTexture.set(U.TEXTURE0),Vt.targetColorTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),Z.activeTexture.set(U.TEXTURE1),Ht&&Ht.rasterParticleState?(Ht.rasterParticleState.targetColorTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),ae=Math.pow(2,Ht.tileID.overscaledZ-Zt.tileID.overscaledZ),Ce=[Zt.tileID.canonical.x*ae%1,Zt.tileID.canonical.y*ae%1]):Vt.targetColorTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE);const ve=ht?Float32Array.from(I.transform.expandedFarZProjMatrix):I.transform.calculateProjMatrix(zt,nt),Fe=I.transform,oi=ca(Fe),ge=i.dF(Gt.canonical),re=i.dG(ge.getCenter().lat);let Be,Te,qe,si,Ci;ht?(Be=Float32Array.from(i.bj(i.dI(Gt.canonical))),Te=Float32Array.from(Fe.globeMatrix),qe=Float32Array.from(i.dE(Fe)),si=[i.aF(Fe.center.lng),i.aJ(Fe.center.lat)],Ci=Float32Array.from(i.dH(Gt.canonical,ge,re,Fe.worldSize/Fe._pixelsPerMercatorPixel))):(Be=new Float32Array(16),Te=new Float32Array(9),qe=new Float32Array(16),si=[0,0],Ci=new Float32Array(9));const ni=ah(ve,Be,Te,qe,Ci,Ce||[0,0],i.aj(I.transform.zoom),si,oi,ae||1,pe,Q),li=I.isTileAffectedByFog(Gt),Li=I.getOrCreateProgram("rasterParticle",{defines:Ct,overrideFog:li});if(I.uploadCommonUniforms(Z,Li,zt),ht){const Ti=new zi(U.LEQUAL,zi.ReadOnly,I.depthRangeFor3D),xi=0,Ii=I.globeSharedBuffers;if(Ii){const[Zi,Fr,qr]=Ii.getGridBuffers(re,xi!==0);Li.draw(I,U.TRIANGLES,Ti,bt,yr.alphaBlended,I.renderElevatedRasterBackface?Qi.frontCCW:Qi.backCCW,ni,L.id,Zi,Fr,qr)}}else{const Ti=I.depthModeForSublayer(0,zi.ReadOnly),xi=lt[Gt.overscaledZ],{tileBoundsBuffer:Ii,tileBoundsIndexBuffer:Zi,tileBoundsSegments:Fr}=I.getTileBoundsBuffers(Zt);Li.draw(I,U.TRIANGLES,Ti,xi,yr.alphaBlended,Qi.disabled,ni,L.id,Ii,Zi,Fr)}}I.resetStencilClippingMasks()}(p,e,a,f),p.style.map.triggerRepaint())},background:function(p,e,a,f){const y=a.paint.get("background-color"),w=a.paint.get("background-color-use-theme").constantOr("default")==="none",I=a.paint.get("background-opacity"),M=a.paint.get("background-emissive-strength"),L=a.paint.get("background-pitch-alignment")==="viewport";if(I===0)return;const N=p.context,V=N.gl,Z=p.transform,U=Z.tileSize,X=a.paint.get("background-pattern");let Q;if(X!==void 0&&(X===null||(Q=p.imageManager.getPattern(i.I.from(X.toString()),a.scope,p.style.getLut(a.scope)),!Q)))return;const nt=!X&&y.a===1&&I===1&&p.opaquePassEnabledForLayer()?"opaque":"translucent";if(p.renderPass!==nt)return;const ht=sr.disabled,lt=p.depthModeForSublayer(0,nt==="opaque"?zi.ReadWrite:zi.ReadOnly),_t=p.colorModeForDrapableLayerRenderPass(M),Ct=X?"backgroundPattern":"background";let bt,Gt=f;if(Gt||(bt=p.getBackgroundTiles(),Gt=Object.values(bt).map(zt=>zt.tileID)),X&&(N.activeTexture.set(V.TEXTURE0),p.imageManager.bind(p.context,a.scope)),L){const zt=p.getOrCreateProgram(Ct,{overrideFog:!1,overrideRtt:!0}),Zt=new Float32Array(i.bz([])),Vt=new i.aP(0,0,0,0,0),kt=X?sd(Zt,M,I,p,0,a.scope,Q,L,{tileID:Vt,tileSize:U}):Gh(Zt,M,I,y.toPremultipliedRenderColor(w?null:a.lut));zt.draw(p,V.TRIANGLES,lt,ht,_t,Qi.disabled,kt,a.id,p.viewportBuffer,p.quadTriangleIndexBuffer,p.viewportSegments)}else for(const zt of Gt){const Zt=p.isTileAffectedByFog(zt),Vt=p.getOrCreateProgram(Ct,{overrideFog:Zt}),kt=zt.toUnwrapped(),Ht=f?zt.projMatrix:p.transform.calculateProjMatrix(kt);p.prepareDrawTile();const pe=e?e.getTile(zt):bt?bt[zt.key]:new Lo(zt,U,Z.zoom,p),ae=X?sd(Ht,M,I,p,0,a.scope,Q,L,{tileID:zt,tileSize:U}):Gh(Ht,M,I,y.toPremultipliedRenderColor(w?null:a.lut));p.uploadCommonUniforms(N,Vt,kt);const{tileBoundsBuffer:Ce,tileBoundsIndexBuffer:ve,tileBoundsSegments:Fe}=p.getTileBoundsBuffers(pe);Vt.draw(p,V.TRIANGLES,lt,ht,_t,Qi.disabled,ae,a.id,Ce,ve,Fe)}},sky:function(p,e,a){const f=p._atmosphere?i.aj(p.transform.zoom):1,y=a.paint.get("sky-opacity")*f;if(y===0)return;const w=p.context,I=a.paint.get("sky-type"),M=new zi(w.gl.LEQUAL,zi.ReadOnly,[0,1]),L=p.frameCounter/1e3%1;I==="atmosphere"?p.renderPass==="offscreen"?a.needsSkyboxCapture(p)&&(function(N,V,Z,U){const X=N.context,Q=X.gl;let nt=V.skyboxFbo;if(!nt){nt=V.skyboxFbo=X.createFramebuffer(32,32,!0,null),V.skyboxGeometry=new mt(X),V.skyboxTexture=X.gl.createTexture(),Q.bindTexture(Q.TEXTURE_CUBE_MAP,V.skyboxTexture),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_WRAP_S,Q.CLAMP_TO_EDGE),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_WRAP_T,Q.CLAMP_TO_EDGE),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_MIN_FILTER,Q.LINEAR),Q.texParameteri(Q.TEXTURE_CUBE_MAP,Q.TEXTURE_MAG_FILTER,Q.LINEAR);for(let Ct=0;Ct<6;++Ct)Q.texImage2D(Q.TEXTURE_CUBE_MAP_POSITIVE_X+Ct,0,Q.RGBA,32,32,0,Q.RGBA,Q.UNSIGNED_BYTE,null)}X.bindFramebuffer.set(nt.framebuffer),X.viewport.set([0,0,32,32]);const ht=V.getCenter(N,!0),lt=N.getOrCreateProgram("skyboxCapture"),_t=new Float64Array(16);i.bz(_t),i.em(_t,_t,.5*-Math.PI),ut(N,V,lt,_t,ht,0),i.bz(_t),i.em(_t,_t,.5*Math.PI),ut(N,V,lt,_t,ht,1),i.bz(_t),i.cT(_t,_t,.5*-Math.PI),ut(N,V,lt,_t,ht,2),i.bz(_t),i.cT(_t,_t,.5*Math.PI),ut(N,V,lt,_t,ht,3),i.bz(_t),ut(N,V,lt,_t,ht,4),i.bz(_t),i.em(_t,_t,Math.PI),ut(N,V,lt,_t,ht,5),X.viewport.set([0,0,N.width,N.height])}(p,a),a.markSkyboxValid(p)):p.renderPass==="sky"&&function(N,V,Z,U,X){const Q=N.context,nt=Q.gl,ht=N.transform,lt=N.getOrCreateProgram("skybox");Q.activeTexture.set(nt.TEXTURE0),nt.bindTexture(nt.TEXTURE_CUBE_MAP,V.skyboxTexture);const _t=((Ct,bt,Gt,zt,Zt)=>({u_matrix:Ct,u_sun_direction:bt,u_cubemap:0,u_opacity:zt,u_temporal_offset:Zt}))(ht.skyboxMatrix,V.getCenter(N,!1),0,U,X);N.uploadCommonUniforms(Q,lt),lt.draw(N,nt.TRIANGLES,Z,sr.disabled,N.colorModeForRenderPass(),Qi.backCW,_t,"skybox",V.skyboxGeometry.vertexBuffer,V.skyboxGeometry.indexBuffer,V.skyboxGeometry.segment)}(p,a,M,y,L):I==="gradient"&&p.renderPass==="sky"&&function(N,V,Z,U,X){const Q=N.context,nt=Q.gl,ht=N.transform,lt=N.getOrCreateProgram("skyboxGradient");V.skyboxGeometry||(V.skyboxGeometry=new mt(Q)),Q.activeTexture.set(nt.TEXTURE0);let _t=V.colorRampTexture;_t||(_t=V.colorRampTexture=new i.T(Q,V.colorRamp,nt.RGBA8)),_t.bind(nt.LINEAR,nt.CLAMP_TO_EDGE);const Ct=((bt,Gt,zt,Zt,Vt)=>({u_matrix:bt,u_color_ramp:0,u_center_direction:Gt,u_radius:i.an(zt),u_opacity:Zt,u_temporal_offset:Vt}))(ht.skyboxMatrix,V.getCenter(N,!1),V.paint.get("sky-gradient-radius"),U,X);N.uploadCommonUniforms(Q,lt),lt.draw(N,nt.TRIANGLES,Z,sr.disabled,N.colorModeForRenderPass(),Qi.backCW,Ct,"skyboxGradient",V.skyboxGeometry.vertexBuffer,V.skyboxGeometry.indexBuffer,V.skyboxGeometry.segment)}(p,a,M,y,L)},custom:function(p,e,a,f){const y=p.context,w=a.implementation;if(!p.transform.projection.unsupportedLayers||!p.transform.projection.unsupportedLayers.includes("custom")||p.terrain&&(p.terrain.renderingToTexture||p.renderPass==="offscreen")&&a.isDraped(e)){if(p.renderPass==="offscreen"){const I=w.prerender;if(I){if(p.setCustomLayerDefaults(),y.setColorMode(p.colorModeForRenderPass()),p.transform.projection.name==="globe"){const M=p.transform.pointMerc;I.call(w,y.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),i.aj(p.transform.zoom),[M.x,M.y],p.transform.pixelsPerMeterRatio)}else I.call(w,y.gl,p.transform.customLayerMatrix());y.setDirty(),p.setBaseState()}}else if(p.renderPass==="translucent"){if(p.terrain&&p.terrain.renderingToTexture){const M=w.renderToTile;if(M){const L=f[0].canonical,N={x:L.x+f[0].wrap*(w.wrapTileId?0:1<<L.z),y:L.y,z:L.z};y.setDepthMode(zi.disabled),y.setStencilMode(sr.disabled),y.setColorMode(p.colorModeForRenderPass()),p.setCustomLayerDefaults(),M.call(w,y.gl,N),y.setDirty(),p.setBaseState()}return}p.setCustomLayerDefaults(),y.setColorMode(p.colorModeForRenderPass()),y.setStencilMode(sr.disabled);const I=w.renderingMode==="3d"?new zi(p.context.gl.LEQUAL,zi.ReadWrite,p.depthRangeFor3D):p.depthModeForSublayer(0,zi.ReadOnly);if(y.setDepthMode(I),p.transform.projection.name==="globe"){const M=p.transform.pointMerc;w.render(y.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),i.aj(p.transform.zoom),[M.x,M.y],p.transform.pixelsPerMeterRatio)}else w.render(y.gl,p.transform.customLayerMatrix());y.setDirty(),p.setBaseState(),y.bindFramebuffer.set(null)}}else i.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(p,e,a,f){if(p.renderPass==="opaque")return;const y=a.paint.get("model-opacity").constantOr(1),w=a.paint.get("model-elevation-reference"),I=w==="ground",M=w==="ground";if(y===0)return;const L=a.paint.get("model-cast-shadows");if(p.renderPass==="shadow"&&(!L||p.terrain&&y<.65&&a._transitionablePaint._values["model-opacity"].value.expression instanceof i.ad))return;const N=p.shadowRenderer,V=a.paint.get("model-receive-shadows");N&&(N.useNormalOffset=!0,V||(N.enabled=!1));const Z=()=>{N&&(N.useNormalOffset=!0,V||(N.enabled=!0))},U=e.getSource();if(p.renderPass==="light-beam"&&U.type!=="batched-model")return;if(U.type==="vector"||U.type==="geojson")return function(bt,Gt,zt,Zt,Vt){const kt=bt.transform,Ht=kt.projection.name==="globe",pe=kt.getFreeCameraOptions().position;if(!bt.modelManager)return;const ae=bt.modelManager;zt.modelManager=ae;const Ce=bt.shadowRenderer;if(!zt._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ve=zt._unevaluatedLayout._values["model-id"],Fe=Object.assign({},zt.layout.get("model-id").parameters),oi=bt.style.order.indexOf(zt.fqid);for(const ge of Zt){const re=Gt.getTile(ge).getBucket(zt);if(!re||re.projection.name!==kt.projection.name)continue;const Be=re.getModelUris();if(Be&&!re.modelsRequested&&(ae.addModelsFromBucket(Be,Vt),re.modelsRequested=!0),Ht)Fe.zoom=ge.overscaledZ;else{const Ti=Fi(ge,kt);Fe.zoom=Ti}const Te=ve.possiblyEvaluate(Fe);if(ii(bt,re,ge),Di.shadowUniformsInitialized=!1,Di.useSingleShadowCascade=!!Ce&&Ce.getMaxCascadeForTile(ge.toUnwrapped())===0,bt.renderPass==="shadow"&&Ce){if(bt.currentShadowCascade===1&&re.isInsideFirstShadowMapFrustum)continue;const Ti=kt.calculatePosMatrix(ge.toUnwrapped(),kt.worldSize);if(Di.tileMatrix.set(Ti),Di.shadowTileMatrix=Float32Array.from(Ce.calculateShadowPassMatrixFromMatrix(Ti)),Di.aabb.min=[0,0,0],Di.aabb.max[0]=Di.aabb.max[1]=i.al,Di.aabb.max[2]=0,$r(re,Di,bt,zt.scope))continue}const qe=1<<ge.canonical.z,si=[((pe.x-ge.wrap)*qe-ge.canonical.x)*i.al,(pe.y*qe-ge.canonical.y)*i.al,pe.z*qe*i.al];bt.conflationActive&&Object.keys(re.instancesPerModel).length>0&&bt.style.isLayerClipped(zt,Gt.getSource())&&re.updateReplacement(ge,bt.replacementSource,oi,Vt)&&(re.uploaded=!1,re.upload(bt.context));let Ci=0;const ni=new Array,li=new Array,Li=new Array;for(let Ti in re.instancesPerModel){const xi=re.instancesPerModel[Ti];xi.features.length>0&&!Ht&&(Ti=Te.evaluate(xi.features[0].feature,{}));const Ii=ae.getModel(Ti,Vt);if(Ii||ae.hasURLBeenRequested(Ti)||re.modelUris.includes(Ti)||(re.modelUris.push(Ti),re.modelsRequested=!1),Ii&&Ii.uploaded)if(Ht){const Zi=i.c4([],[pe.x,pe.y,pe.z],bt.transform.worldSize);i.ev(Zi,Zi);for(let Fr=0;Fr<xi.instancedDataArray.length;++Fr){const qr=[0,0,0],En=[1,1,1],ar=i.ew(),jr=xi.tileCoordinatesForInstance(Fr),br=xi.transformForInstance(Fr);i.ex(En,br),i.ey(ar,br),i.ez(qr,ar);const xn=xi.translationForInstance(Fr),Vr=new i.aS(0,0);i.eA(re.canonical,Vr,jr.x,jr.y);const kn=i.bB();i.eB(kn,Ii,bt.transform,Vr,qr,En,xn,!0,!1,!1);const Kr=xi.colorForInstance(Fr),wr=i.bz([]),ln=i.ee(Vr.lat,bt.transform.zoom),Er=i.bp([],[1,1,1/ln]);i.bq(wr,wr,Zi),Li.push({zScaleMatrix:Er,negCameraPosMatrix:wr});for(const eo of Ii.nodes)de(bt,eo,kn,bt.transform.expandedFarZProjMatrix,Ci,ni,li,Ii.materialOverrides,Kr);++Ci}}else for(const Zi of Ii.nodes)wi(bt,zt,Zi,xi,si,ge,Di)}if(Ht)if(bt.renderPass==="shadow"){for(const Ti of li)De(Ti.mesh,Ti.nodeModelMatrix,bt,zt);for(const Ti of ni)De(Ti.mesh,Ti.nodeModelMatrix,bt,zt)}else Je(bt,zt,1,ni,li,Li)}}(p,e,a,f,be(U,a,p.style._importedAsBasemap)),void Z();if(!U.loaded())return;if(U.type==="batched-model")return function(bt,Gt,zt,Zt){zt.resetLayerRenderingStats(bt);const Vt=bt.context,kt=bt.transform,Ht=bt.style.fog,pe=bt.shadowRenderer;if(kt.projection.name!=="mercator")return void i.w(`Drawing 3D landmark models for ${kt.projection.name} projection is not yet implemented`);const ae=bt.transform.getFreeCameraOptions().position,Ce=i.c4([],[ae.x,ae.y,ae.z],bt.transform.worldSize),ve=i.ev([],Ce),Fe=i.bz([]),oi=i.ee(kt.center.lat,kt.zoom),ge=i.bp([],[1,1,1/oi]);i.bq(Fe,Fe,ve);const re=zt.paint.get("model-opacity").constantOr(1),Be=new zi(Vt.gl.LEQUAL,zi.ReadWrite,bt.depthRangeFor3D),Te=new zi(Vt.gl.LEQUAL,zi.ReadOnly,bt.depthRangeFor3D),qe=new i.d8([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),si=bt.renderPass==="shadow",Ci=si&&pe?pe.getCurrentCascadeFrustum():kt.getFrustum(kt.scaleZoom(kt.worldSize)),ni=zt.paint.get("model-front-cutoff"),li=ni[2]<1,Li=sa(bt,zt.paint.get("model-cutoff-fade-range")),Ti=zt.getLayerRenderingStats();(function(xi,Ii,Zi,Fr){const qr=xi.terrain?xi.terrain.exaggeration():0,En=xi.transform.zoom;for(const ar of Fr){const jr=Ii.getTile(ar).getBucket(Zi);jr&&(jr.setFilter(Zi.filter),xi.conflationActive&&jr.updateReplacement(ar,xi.replacementSource),jr.evaluateTransform(xi,Zi),xi.terrain&&qr>0&&jr.elevationUpdate(xi.terrain,qr,ar,Zi.source),jr.needsReEvaluation(xi,En,Zi)&&jr.evaluate(Zi))}})(bt,Gt,zt,Zt),function(){let xi,Ii,Zi;li?(xi=Zt.length-1,Ii=-1,Zi=-1):(xi=0,Ii=Zt.length,Zi=1);const Fr=new Float64Array(16),qr=i.cz(),En=new i.P(0,0);for(let ar=xi;ar!==Ii;ar+=Zi){const jr=Zt[ar],br=Gt.getTile(jr).getBucket(zt);if(!br||!br.uploaded)continue;let xn=!1;pe&&(xn=pe.getMaxCascadeForTile(jr.toUnwrapped())===0);const Vr=kt.calculatePosMatrix(jr.toUnwrapped(),kt.worldSize),kn=br.modelTraits;!si&&li&&(i.bk(Fr,Vr),i.af(qr,Ce,Fr),En.x=qr[0],En.y=qr[1]);const Kr=[];br.setFilter(zt.filter);for(const wr of br.getNodesInfo()){if(wr.hiddenByReplacement||!wr.node.meshes)continue;const ln=wr.node;let Er=0;bt.terrain&&ln.elevation&&(Er=ln.elevation*bt.terrain.exaggeration());const eo=(()=>{const Fa=wr.aabb;return qe.min=[...Fa.min],qe.max=[...Fa.max],qe.min[2]+=Er,qe.max[2]+=Er,i.af(qe.min,qe.min,Vr),i.af(qe.max,qe.max,Vr),qe})(),cn=wr.evaluatedScale;if(cn[0]<=1&&cn[1]<=1&&cn[2]<=1&&eo.intersects(Ci)===0)continue;if(!si&&li){const Fa=.16666666666666666;wr.cameraCollisionOpacity=Ce[0]>eo.min[0]&&Ce[0]<eo.max[0]&&Ce[1]>eo.min[1]&&Ce[1]<eo.max[1]&&Ce[2]*oi<eo.max[2]&&ln.footprint&&i.b$(En,ln.footprint)?Math.max(wr.cameraCollisionOpacity-Fa,0):Math.min(1,wr.cameraCollisionOpacity+Fa)}const cr=[...Vr],Wr=1/i.d6(jr.canonical),fo=ln.anchor?ln.anchor[0]:0,Uo=ln.anchor?ln.anchor[1]:0;i.bq(cr,cr,[fo*(cn[0]-1)+wr.evaluatedTranslation[0]*Wr,Uo*(cn[1]-1)+wr.evaluatedTranslation[1]*Wr,Er+wr.evaluatedTranslation[2]]),i.cp(cn,i.eD)||i.cR(cr,cr,cn);const So=i.aB([],cr,ln.globalMatrix),Ro=i.aB([],kt.expandedFarZProjMatrix,So),mo=i.aB([],kt.expandedFarZProjMatrix,cr),ha=i.aC([],[fo,Uo,Er,1],Ro)[2];ln.hidden=!1;let wa=re;si||(li&&(wa*=wr.cameraCollisionOpacity,wa*=co(cr,kt,wr.aabb,ni)),wa*=Nr(Li,ha)),wa!==0?Kr.push({nodeInfo:wr,depth:ha,opacity:wa,wvpForNode:Ro,wvpForTile:mo,nodeModelMatrix:So,tileModelMatrix:cr}):ln.hidden=!0}si||Kr.sort((wr,ln)=>!li||wr.opacity===1&&ln.opacity===1?wr.depth<ln.depth?-1:1:wr.opacity===1?-1:ln.opacity===1?1:wr.depth>ln.depth?-1:1);for(const wr of Kr){const ln=wr.nodeInfo,Er=ln.node;let eo=i.aB([],ge,wr.tileModelMatrix);i.aB(eo,Fe,eo);const cn=i.bk([],eo);i.ef(cn,cn),i.cR(cn,cn,fr),eo=i.aB(eo,eo,Er.globalMatrix);const cr=bt.renderPass==="light-beam",Wr=zt.paint.get("model-color-use-theme").constantOr("default")==="none",fo=kn&i.eH.HasMapboxMeshFeatures,Uo=fo?0:ln.evaluatedRMEA[0][2];for(let So=0;So<Er.meshes.length;++So){const Ro=Er.meshes[So],mo=So===Er.lightMeshIndex;let ha=wr.wvpForNode;if(mo){if(!cr&&!bt.terrain&&bt.shadowRenderer){bt.currentLayer<bt.firstLightBeamLayer&&(bt.firstLightBeamLayer=bt.currentLayer);continue}ha=wr.wvpForTile}else if(cr)continue;const wa={defines:[]},Fa=[];if(!si&&pe&&(pe.useNormalOffset=!!Ro.normalBuffer),ce(wa.defines,Fa,Ro,bt,Wr?null:zt.lut),fo||wa.defines.push("DIFFUSE_SHADED"),xn&&wa.defines.push("SHADOWS_SINGLE_CASCADE"),Ti&&(si?Ti.numRenderedVerticesInShadowPass+=Ro.vertexArray.length:Ti.numRenderedVerticesInTransparentPass+=Ro.vertexArray.length),si){De(Ro,wr.nodeModelMatrix,bt,zt);continue}let tc=null;if(Ht){const ko=_e(wr.nodeModelMatrix,bt.transform);if(tc=new Float32Array(ko),kt.projection.name!=="globe"){const Dn=Ro.aabb.min,$o=Ro.aabb.max,[As,ro]=Ht.getOpacityForBounds(ko,Dn[0],Dn[1],$o[0],$o[1]);wa.overrideFog=As>=xe||ro>=xe}}const ua=Ro.material;let yc;ua.occlusionTexture&&ua.occlusionTexture.offsetScale&&(yc=ua.occlusionTexture.offsetScale,wa.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const xc=bt.getOrCreateProgram("model",wa);!si&&pe&&pe.setupShadowsFromMatrix(wr.tileModelMatrix,xc,pe.useNormalOffset),bt.uploadCommonUniforms(Vt,xc,null,tc);const Bs=ua.pbrMetallicRoughness;Bs.metallicFactor=.9,Bs.roughnessFactor=.5;const io=ad(new Float32Array(ha),new Float32Array(eo),new Float32Array(cn),new Float32Array(Er.globalMatrix),bt,wr.opacity,Bs.baseColorFactor,ua.emissiveFactor,Bs.metallicFactor,Bs.roughnessFactor,ua,Uo,zt,[0,0,0],yc);!mo&&(ln.hasTranslucentParts||wr.opacity<1)&&xc.draw(bt,Vt.gl.TRIANGLES,Be,sr.disabled,yr.disabled,Qi.backCCW,io,zt.id,Ro.vertexBuffer,Ro.indexBuffer,Ro.segments,zt.paint,bt.transform.zoom,void 0,Fa),xc.draw(bt,Vt.gl.TRIANGLES,mo?Te:Be,sr.disabled,mo||wr.opacity<1||ln.hasTranslucentParts?yr.alphaBlended:yr.unblended,Qi.backCCW,io,zt.id,Ro.vertexBuffer,Ro.indexBuffer,Ro.segments,zt.paint,bt.transform.zoom,void 0,Fa)}}}}()}(p,e,a,f),void Z();if(U.type!=="model")return;const X=U.getModels(),Q=[],nt=p.transform.getFreeCameraOptions().position,ht=i.c4([],[nt.x,nt.y,nt.z],p.transform.worldSize);i.ev(ht,ht);const lt=[],_t=[];let Ct=0;for(const bt of X){const Gt=e.getFeatureState("",bt.id),zt={type:"Unknown",id:bt.id,properties:bt.featureProperties},Zt=a.paint.get("model-rotation").evaluate(zt,Gt),Vt=a.paint.get("model-scale").evaluate(zt,Gt),kt=a.paint.get("model-translation").evaluate(zt,Gt);Qe(a,bt.id,Gt,bt.featureProperties,bt.nodeOverrideNames,bt.nodeOverrides),Xe(a,bt.id,Gt,bt.featureProperties,bt.materialOverrideNames,bt.materialOverrides),bt.nodeOverrides.size>0&&bt.computeBoundsAndApplyParent(),bt.computeModelMatrix(p,Zt,Vt,kt,M,I,!1);const Ht=i.bz([]),pe=i.ee(bt.position.lat,p.transform.zoom),ae=i.bp([],[1,1,1/pe]);i.bq(Ht,Ht,ht),Q.push({zScaleMatrix:ae,negCameraPosMatrix:Ht});for(const Ce of bt.nodes)de(p,Ce,bt.matrix,p.transform.expandedFarZProjMatrix,Ct,lt,_t,bt.materialOverrides);Ct++}if(lt.sort((bt,Gt)=>Gt.depth-bt.depth),p.renderPass!=="shadow")Je(p,a,y,lt,_t,Q),Z();else{for(const bt of _t)De(bt.mesh,bt.nodeModelMatrix,p,a);for(const bt of lt)De(bt.mesh,bt.nodeModelMatrix,p,a);Z()}}},Ql={line:function(p,e,a){if(p.hasElevatedBuckets=!1,p.hasNonElevatedBuckets=!1,p._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||p._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(e){const f=e.getVisibleCoordinates();for(const y of f){const w=e.getTile(y).getBucket(p);if(w&&(w.elevationType!=="none"?p.hasElevatedBuckets=!0:p.hasNonElevatedBuckets=!0,p.hasElevatedBuckets&&p.hasNonElevatedBuckets))break}}}else p.hasNonElevatedBuckets=!0},model:function(p,e,a){const f=e.getSource();if(!f.loaded())return;if(f.type==="vector"||f.type==="geojson"){const w=be(f,p,a.style._importedAsBasemap);return void(a.modelManager&&a.modelManager.upload(a,w))}if(f.type==="batched-model"||f.type!=="model")return;const y=f.getModels();for(const w of y)w.upload(a.context)},raster:function(p,e,a){const f=e.getSource();if(!(f instanceof es&&f.loaded()))return;const y=p.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!y)return;const w=p.paint.get("raster-array-band")||f.getInitialBand(y);if(w==null)return;const I=e.getIds().map(M=>e.getTileByID(M));for(const M of I)M.updateNeeded(p.id,w)&&f.prepareTile(M,y,p.id,w)},"raster-particle":function(p,e,a){const f=e.getSource();if(!(f instanceof es&&f.loaded()))return;const y=p.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!y)return;const w=p.paint.get("raster-particle-array-band")||f.getInitialBand(y);if(w==null)return;const I=e.getIds().map(M=>e.getTileByID(M));for(const M of I)M.updateNeeded(p.id,w)&&f.prepareTile(M,y,p.id,w)}},Uc={fill:to},Zs={fill:function(p,e,a,f){if(!a.layout||a.layout.get("fill-elevation-reference")==="none"||a.paint.get("fill-opacity").constantOr(1)===0)return;const y=p.context.gl,w=new zi(y.LEQUAL,zi.ReadOnly,p.depthRangeFor3D),I=new sr({func:y.ALWAYS,mask:255},255,255,y.KEEP,y.KEEP,y.REPLACE),M=p.transform.getFreeCameraOptions().position,L=p.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const N of f){const V=e.getTile(N),Z=V.getBucket(a);if(!Z)continue;const U=Z.elevatedStructures;if(!U||U.depthSegments.segments[0].primitiveLength===0)continue;const X=ld(N.toUnwrapped(),M),Q=p.translatePosMatrix(N.projMatrix,V,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor")),nt=rd(Q,X,0,1,0);L.draw(p,y.TRIANGLES,w,I,yr.disabled,Qi.disabled,nt,a.id,U.vertexBuffer,U.indexBuffer,U.depthSegments,a.paint,p.transform.zoom)}}};class Po{constructor(e,a,f,y,w,I){this.context=new Zh(e,a),this.transform=f,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=w,this._timeStamp=i.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const M=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const N of M)this._debugParams.enabledLayers[N]=!0;w.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),w.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),w.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),w.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),w.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),w.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const N of M)w.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],N);this.occlusionParams=new Vo(w),this.setup(),this.numSublayers=On.maxUnderzooming+On.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new i.eO,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new hu(this),this._wireframeDebugCache=new Jo,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const L=new i.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new i.T(this.context,L,e.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=y,this.worldview=I}updateTerrain(e,a){const f=!!e&&!!e.terrain&&this.transform.projection.supportsTerrain;if(!(f||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new kc(this,e));const y=this._terrain;this.transform.elevation=f?y:null,y.update(e,this.transform,a),this.transform.elevation&&!y.enabled&&(this.transform.elevation=null)}_updateFog(e){const a=e.fog;if(!a||this.transform.projection.name==="globe"||a.getOpacity(this.transform.pitch)<1||a.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[f,y]=a.getFovAdjustedRange(this.transform._fov);if(f>y)return void(this.transform.fogCullDistSq=null);const w=f+.78*(y-f);this.transform.fogCullDistSq=w*w}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(e){e&&!this._terrain&&(this._terrain=new kc(this,this.style)),this._forceTerrainMode=e}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(e,a){if(this.width=e*i.o.devicePixelRatio,this.height=a*i.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const f of this.style.order)this.style._mergedLayers[f].resize()}setup(){const e=this.context,a=new i.bc;a.emplaceBack(0,0),a.emplaceBack(i.al,0),a.emplaceBack(0,i.al),a.emplaceBack(i.al,i.al),this.tileExtentBuffer=e.createVertexBuffer(a,i.be.members),this.tileExtentSegments=i.bf.simpleSegment(0,0,4,2);const f=new i.bc;f.emplaceBack(0,0),f.emplaceBack(i.al,0),f.emplaceBack(0,i.al),f.emplaceBack(i.al,i.al),this.debugBuffer=e.createVertexBuffer(f,i.be.members),this.debugSegments=i.bf.simpleSegment(0,0,4,5);const y=new i.bc;y.emplaceBack(-1,-1),y.emplaceBack(1,-1),y.emplaceBack(-1,1),y.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(y,i.be.members),this.viewportSegments=i.bf.simpleSegment(0,0,4,2);const w=new i.a$;w.emplaceBack(0,0,0,0),w.emplaceBack(i.al,0,i.al,0),w.emplaceBack(0,i.al,0,i.al),w.emplaceBack(i.al,i.al,i.al,i.al),this.mercatorBoundsBuffer=e.createVertexBuffer(w,i.bh.members),this.mercatorBoundsSegments=i.bf.simpleSegment(0,0,4,2);const I=new i.b0;I.emplaceBack(0,1,2),I.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(I);const M=new i.bd;for(const N of[0,1,3,2,0])M.emplaceBack(N);this.debugIndexBuffer=e.createIndexBuffer(M),this.emptyTexture=new i.T(e,new i.q({width:1,height:1},Uint8Array.of(0,0,0,0)),e.gl.RGBA8),this.identityMat=i.bB();const L=this.context.gl;this.stencilClearMode=new sr({func:L.ALWAYS,mask:0},0,255,L.ZERO,L.ZERO,L.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(e){return e._makeTileBoundsBuffers(this.context,this.transform.projection),e._tileBoundsBuffer?{tileBoundsBuffer:e._tileBoundsBuffer,tileBoundsIndexBuffer:e._tileBoundsIndexBuffer,tileBoundsSegments:e._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const e=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,e.TRIANGLES,zi.disabled,this.stencilClearMode,yr.disabled,Qi.disabled,Uh(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(e,a,f){if(!a||this.currentStencilSource===a.id||!e.isTileClipped()||!f||f.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let M=!1;for(const L of f)if(this._tileClippingMaskIDs[L.key]===void 0){M=!0;break}if(!M)return}this.currentStencilSource=a.id;const y=this.context,w=y.gl;this.nextStencilID+f.length>256&&this.clearStencil(),y.setColorMode(yr.disabled),y.setDepthMode(zi.disabled);const I=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const M of f){const L=a.getTile(M),N=this._tileClippingMaskIDs[M.key]=this.nextStencilID++,{tileBoundsBuffer:V,tileBoundsIndexBuffer:Z,tileBoundsSegments:U}=this.getTileBoundsBuffers(L);I.draw(this,w.TRIANGLES,zi.disabled,new sr({func:w.ALWAYS,mask:0},N,255,w.KEEP,w.KEEP,w.REPLACE),yr.disabled,Qi.disabled,Uh(M.projMatrix),"$clipping",V,Z,U)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,a=this.context.gl;return new sr({func:a.NOTEQUAL,mask:255},e,255,a.KEEP,a.KEEP,a.REPLACE)}stencilModeForClipping(e){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(e);const a=this.context.gl;return new sr({func:a.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,a.KEEP,a.KEEP,a.REPLACE)}stencilConfigForOverlap(e){const a=this.context.gl,f=e.sort((I,M)=>M.overscaledZ-I.overscaledZ),y=f[f.length-1].overscaledZ,w=f[0].overscaledZ-y+1;if(w>1){this.currentStencilSource=void 0,this.nextStencilID+w>256&&this.clearStencil();const I={};for(let M=0;M<w;M++)I[M+y]=new sr({func:a.GEQUAL,mask:255},M+this.nextStencilID,255,a.KEEP,a.KEEP,a.REPLACE);return this.nextStencilID+=w,[I,f]}return[{[y]:sr.disabled},f]}colorModeForRenderPass(){const e=this.context.gl;return this._showOverdrawInspector?new yr([e.CONSTANT_COLOR,e.ONE,e.CONSTANT_COLOR,e.ONE],new i.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?yr.unblended:yr.alphaBlended}colorModeForDrapableLayerRenderPass(e){const a=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new yr([a.ONE,a.ONE_MINUS_SRC_ALPHA,a.CONSTANT_ALPHA,a.ONE_MINUS_SRC_ALPHA],new i.ao(0,0,0,e===void 0?0:e),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(e,a,f,y=!1){if(this.depthOcclusion)return new zi(this.context.gl.GREATER,zi.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!y)return zi.disabled;const w=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new zi(f||this.context.gl.LEQUAL,a,[w,w])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const e=this.context.gl,a=Math.ceil(this.width),f=Math.ceil(this.height),y=this.context.bindFramebuffer.get(),w=e.getParameter(e.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===a&&this.depthFBO.height===f||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),a!==0&&f!==0&&(this.depthFBO=new zr(this.context,a,f,!1,"texture"),this.depthTexture=new i.T(this.context,{width:a,height:f,data:null},e.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(y),e.bindTexture(e.TEXTURE_2D,w),this.depthFBO&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),e.blitFramebuffer(0,0,a,f,0,0,a,f,e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((e,a)=>e+a/this._fpsHistory.length,0))}render(e,a){const f=i.o.now();this._dt=f-this._timeStamp,this._timeStamp=f,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=e.map.repaint,this.style=e,this.options=a;const y=this.style._mergedLayers,w=!(!this.terrain||!this.terrain.enabled),I=()=>this.style._getOrder(w).filter(ge=>{const re=y[ge];return!(re.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[re.type]});let M=I(),L=!1,N=!1,V=null;for(const ge of M){const re=y[ge];re.type==="circle"?L=!0:re.type==="building"?V=re:re.type==="symbol"&&(re.hasOcclusionOpacityProperties?N=!0:L=!0)}let Z=M.map(ge=>y[ge]);const U=this.style._mergedSourceCaches;this.imageManager=e.imageManager,this.modelManager=e.modelManager,this.symbolFadeChange=e.placement.symbolFadeChange(i.o.now()),this.imageManager.beginFrame();let X=0,Q=!1;for(const ge in U){const re=U[ge];re.used&&(re.prepare(this.context),re.getSource().usedInConflation&&++X)}let nt=!1;for(const ge of Z)ge.isHidden(this.transform.zoom)||(ge.type==="clip"&&(nt=!0),this.prepareLayer(ge));const ht={},lt={},_t={},Ct={},bt={};for(const ge in U){const re=U[ge];ht[ge]=re.getVisibleCoordinates(),lt[ge]=ht[ge].slice().reverse(),_t[ge]=re.getVisibleCoordinates(!0).reverse(),Ct[ge]=re.getShadowCasterCoordinates(),bt[ge]=re.sortCoordinatesByDistance(ht[ge])}const Gt=ge=>{const re=this.style.getLayerSourceCache(ge);return re&&re.used?re.getSource():null};if(X||nt||this._clippingActiveLastFrame){const ge=[],re=[];let Be=0;for(const Te of Z)this.isSourceForClippingOrConflation(Te,Gt(Te))&&(ge.push(Te),re.push(Be)),Be++;if(nt||ge.length>1||this._clippingActiveLastFrame){nt=!1;const Te=[];for(let qe=0;qe<ge.length;qe++){const si=ge[qe],Ci=re[qe],ni=this.style.getLayerSourceCache(si);if(!ni||!ni.used||!ni.getSource().usedInConflation&&si.type!=="clip"&&si.type!=="building")continue;let li=i.eP,Li=i.bZ.None;const Ti=[];let xi=!0;if(si.type==="building")li=i.eR;else if(si.type==="clip"){li=Ci;for(const Ii of si.layout.get("clip-layer-types"))Li|=Ii==="model"?i.bZ.Model:Ii==="symbol"?i.bZ.Symbol:i.bZ.FillExtrusion;for(const Ii of si.layout.get("clip-layer-scope"))Ti.push(Ii);si.isHidden(this.transform.zoom)?xi=!1:nt=!0}xi&&Te.push({layer:si.fqid,cache:ni,order:li,clipMask:Li,clipScope:Ti})}this.replacementSource.setSources(Te),Q=!0}}this._clippingActiveLastFrame=nt,Q||this.replacementSource.clear(),this.conflationActive=Q,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let ge=0;ge<Z.length;ge++){const re=Z[ge],Be=re.cutoffRange();if(this.longestCutoffRange=Math.max(Be,this.longestCutoffRange),Be>0){const Te=Gt(re);Te&&(this.minCutoffZoom=Math.max(Te.minzoom,this.minCutoffZoom)),re.minzoom&&(this.minCutoffZoom=Math.max(re.minzoom,this.minCutoffZoom))}re.is3D(w)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=ge),this._lastOcclusionLayer=ge)}const zt=this.style&&this.style.fog;zt?(this._fogVisible=zt.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=zt.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(_t),this.opaquePassCutoff=0,M=I(),Z=M.map(ge=>y[ge]));const Zt=this._shadowRenderer;if(Zt){Zt.updateShadowParameters(this.transform,this.style.directionalLight);for(const ge in U)for(const re of ht[ge]){let Be={min:0,max:0};this.terrain&&(Be=this.terrain.getMinMaxForTile(re)||Be),Zt.addShadowReceiver(re.toUnwrapped(),Be.min,Be.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new i.eQ(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Xt(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const Vt=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),kt=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(Vt&&!this._snow&&(this._snow=new mc(this)),!Vt&&this._snow&&(this._snow.destroy(),delete this._snow),kt&&!this._rain&&(this._rain=new Kl(this)),!kt&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),V){this.buildingTileBorderManager||(this.buildingTileBorderManager=new ft);const ge=this.style.getLayerSourceCache(V);this.buildingTileBorderManager.updateBorders(ge,V)}if(!Kn.has(this.context.gl))return;this.renderPass="offscreen";for(const ge of Z){const re=e.getLayerSourceCache(ge);if(!ge.hasOffscreenPass()||ge.isHidden(this.transform.zoom))continue;const Be=re?lt[re.id]:void 0;(ge.type==="custom"||ge.type==="raster"||ge.type==="raster-particle"||ge.isSky()||Be&&Be.length)&&this.renderLayer(this,re,ge,Be)}this.depthRangeFor3D=[0,1-(Z.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Ct)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const Ht=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),pe=(()=>{if(a.showOverdrawInspector)return i.ao.black;const ge=this.style.fog;if(ge&&this.transform.projection.supportsFog){const re=this.style.getLut(ge.scope);if(!Ht){const Be=ge.properties.get("color-use-theme")==="none",Te=ge.properties.get("color").toNonPremultipliedRenderColor(Be?null:re).toArray01();return new i.ao(...Te)}if(Ht){const Be=ge.properties.get("space-color-use-theme")==="none",Te=ge.properties.get("space-color").toNonPremultipliedRenderColor(Be?null:re).toArray01();return new i.ao(...Te)}}return i.ao.transparent})();if(this.context.clear({color:pe,depth:1}),this.clearStencil(),this._showOverdrawInspector=a.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ht&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=M.length-1;this.currentLayer>=0;this.currentLayer--){const ge=Z[this.currentLayer],re=e.getLayerSourceCache(ge);if(ge.isSky())continue;const Be=re?(ge.is3D(w)?bt:lt)[re.id]:void 0;this._renderTileClippingMasks(ge,re,Be),this.renderLayer(this,re,ge,Be)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Ht&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||i.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){const ge=Z[this.currentLayer],re=e.getLayerSourceCache(ge);ge.isSky()&&this.renderLayer(this,re,ge,re?lt[re.id]:void 0)}function ae(ge,re){let Be;return re&&(Be=(ge.type==="symbol"?_t:ge.is3D(w)?bt:lt)[re.id]),Be}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<M.length;){const ge=Z[this.currentLayer];if(ge.type==="raster"||ge.type==="raster-particle"){const re=e.getLayerSourceCache(ge);this.renderLayer(this,re,ge,ae(ge,re))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ce=0;Zt&&(Ce=Zt.getShadowCastingLayerCount());let ve=!1,Fe=-1;for(let ge=0;ge<M.length;++ge){const re=Z[ge];re.isHidden(this.transform.zoom)||re.is3D(w)&&(Fe=ge)}N&&Fe===-1&&(L=!0);let oi=!1;for(;this.currentLayer<M.length;){const ge=Z[this.currentLayer],re=e.getLayerSourceCache(ge);if(ge.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(ge)){if(ge.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!oi&&ge.is3D(w)&&!w){const Be=this.currentLayer,Te=qe=>{for(this.currentLayer=0;this.currentLayer<Z.length;this.currentLayer++){const si=Z[this.currentLayer];if(Uc[si.type]){const Ci=this.style.getLayerSourceCache(si);Uc[si.type](this,Ci,si,ae(si,Ci),qe)}}};Te("initialize"),Te("reset"),this.currentLayer=Be,oi=!0}if(L&&!ve&&this.terrain&&!this.transform.isOrthographic&&(ve=!0,this.blitDepth()),N&&Fe!==-1&&this.currentLayer===Fe+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(ge,re,re?ht[re.id]:void 0),this.renderLayer(this,re,ge,ae(ge,re)),!this.terrain&&Zt&&Ce>0&&ge.hasShadowPass()&&--Ce==0){{this.clearStencil(),this.resetStencilClippingMasks();const Be=this.currentLayer;for(this.currentLayer=0;this.currentLayer<Z.length;this.currentLayer++){const Te=Z[this.currentLayer];if(Zs[Te.type]){const qe=this.style.getLayerSourceCache(Te);Zs[Te.type](this,qe,Te,ae(Te,qe))}}this.currentLayer=Be}if(Zt.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Be=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Be;this.currentLayer++){const Te=Z[this.currentLayer];if(!Te.hasLightBeamPass())continue;const qe=e.getLayerSourceCache(Te);this.renderLayer(this,qe,Te,qe?lt[qe.id]:void 0)}this.currentLayer=Be,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Be=this.currentLayer;this.depthOcclusion=!0;for(const Te of this.layersWithOcclusionOpacity){this.currentLayer=Te;const qe=Z[this.currentLayer],si=e.getLayerSourceCache(qe),Ci=si?lt[si.id]:void 0;this.terrain||this._renderTileClippingMasks(qe,si,si?ht[si.id]:void 0),this.renderLayer(this,si,qe,Ci)}this.depthOcclusion=!1,this.currentLayer=Be,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let ge=null;Z.forEach(re=>{const Be=e.getLayerSourceCache(re);Be&&!re.isHidden(this.transform.zoom)&&Be.getVisibleCoordinates().length&&(!ge||ge.getSource().maxzoom<Be.getSource().maxzoom)&&(ge=Be)}),ge&&this.options.showTileBoundaries&&v(this,ge,ge.getVisibleCoordinates(),i.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&v(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new i.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(ge){const re=ge.transform.padding;D(ge,ge.transform.height-(re.top||0),3,fc),D(ge,re.bottom||0,3,Hd),k(ge,re.left||0,3,C),k(ge,ge.transform.width-(re.right||0),3,s);const Be=ge.transform.centerPoint;(function(Te,qe,si,Ci){j(Te,qe-1,si-10,2,20,Ci),j(Te,qe-10,si-1,20,2,Ci)})(ge,Be.x,ge.transform.height-Be.y,d)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),Q||(this.conflationActive=!1)}prepareLayer(e){this.gpuTimingStart(e);const{unsupportedLayers:a}=this.transform.projection,f=!a||!a.includes(e.type);if(Ql[e.type]&&(f||this.terrain&&e.type==="custom")){const y=this.style.getLayerSourceCache(e);Ql[e.type](e,y,this)}this.gpuTimingEnd()}renderLayer(e,a,f,y){f.isHidden(this.transform.zoom)||(f.type==="background"||f.type==="sky"||f.type==="custom"||f.type==="model"||f.type==="raster"||f.type==="raster-particle"||y&&y.length)&&(this.id=f.id,this.gpuTimingStart(f),e.transform.projection.unsupportedLayers&&e.transform.projection.unsupportedLayers.includes(f.type)&&(!e.terrain||f.type!=="custom")||f.type==="clip"||Wa[f.type](e,a,f,y,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(e){if(!this.options.gpuTiming)return;const a=this.context.extTimerQuery,f=this.context.gl;let y=this.gpuTimers[e.id];y||(y=this.gpuTimers[e.id]={calls:0,cpuTime:0,query:f.createQuery()}),y.calls++,f.beginQuery(a.TIME_ELAPSED_EXT,y.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const e=this.context.extTimerQuery,a=this.context.gl,f=a.createQuery();this.deferredRenderGpuTimeQueries.push(f),a.beginQuery(e.TIME_ELAPSED_EXT,f)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const e=this.gpuTimers;return this.gpuTimers={},e}collectDeferredRenderGpuQueries(){const e=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],e}queryGpuTimers(e){const a={};for(const f in e){const y=e[f],w=this.context.extTimerQuery,I=w.getQueryParameter(y.query,this.context.gl.QUERY_RESULT)/1e6;w.deleteQueryEXT(y.query),a[f]=I}return a}queryGpuTimeDeferredRender(e){if(!this.options.gpuTimingDeferredRender)return 0;const a=this.context.gl;let f=0;for(const y of e)f+=a.getQueryParameter(y,a.QUERY_RESULT)/1e6,a.deleteQuery(y);return f}translatePosMatrix(e,a,f,y,w){if(!f[0]&&!f[1])return e;const I=w?y==="map"?this.transform.angle:0:y==="viewport"?-this.transform.angle:0;if(I){const N=Math.sin(I),V=Math.cos(I);f=[f[0]*V-f[1]*N,f[0]*N+f[1]*V]}const M=[w?f[0]:i.ay(a,f[0],this.transform.zoom),w?f[1]:i.ay(a,f[1],this.transform.zoom),0],L=new Float32Array(16);return i.bq(L,e,M),L}saveTileTexture(e){if(e.context!==this.context)return;const a=e.size[0],f=this._tileTextures[a];f?f.push(e):this._tileTextures[a]=[e]}getTileTexture(e){const a=this._tileTextures[e];return a&&a.length>0?a.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(e,a,f){const y=f===void 0?this.terrain&&this.terrain.renderingToTexture:f,w=[];return this.style&&this.style.enable3dLights()&&(e==="globeRaster"||e==="terrainRaster"?(w.push("LIGHTING_3D_MODE"),w.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):y||w.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||w.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(w.push("TERRAIN"),this.linearFloatFilteringSupported()&&w.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&w.push("GLOBE"),!this._fogVisible||y||a!==void 0&&!a||w.push("FOG","FOG_DITHERING"),y&&w.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&w.push("OVERDRAW_INSPECTOR"),w}getOrCreateProgram(e,a){this.cache=this.cache||{};const f=a&&a.defines||[],y=a&&a.config,w=this.currentGlobalDefines(e,a&&a.overrideFog,a&&a.overrideRtt).concat(f),I=Vd.cacheKey(zd[e],e,w,y);return this.cache[I]||(this.cache[I]=new Vd(this.context,e,zd[e],y,Xf[e],w)),this.cache[I]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new i.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(e,a){if(this.style.enable3dLights()){const f=this.style.directionalLight,y=this.style.ambientLight;if(f&&y){const w=((I,M,L)=>{const N=I.properties.get("direction"),V=I.properties.get("color-use-theme")==="none",Z=I.properties.get("color").toNonPremultipliedRenderColor(V?null:L.getLut(I.scope)).toArray01(),U=I.properties.get("intensity"),X=M.properties.get("color-use-theme")==="none",Q=M.properties.get("color").toNonPremultipliedRenderColor(X?null:L.getLut(M.scope)).toArray01(),nt=M.properties.get("intensity"),ht=[N.x,N.y,N.z],lt=i.dM(Q,nt),_t=i.dM(Z,U);return{u_lighting_ambient_color:lt,u_lighting_directional_dir:ht,u_lighting_directional_color:_t,u_ground_radiance:Yo(ht,_t,lt)}})(f,y,this.style);a.setLightsUniformValues(e,w)}}}uploadCommonUniforms(e,a,f,y,w){if(this.uploadCommonLightUniforms(e,a),this.terrain&&this.terrain.renderingToTexture)return;const I=this.style.fog;if(I){const M=I.getOpacity(this.transform.pitch),L=((N,V,Z,U,X,Q,nt,ht,lt,_t,Ct,bt)=>{const Gt=N.transform,zt=V.properties.get("color-use-theme")==="none",Zt=V.properties.get("color").toNonPremultipliedRenderColor(zt?null:N.style.getLut(V.scope)).toArray01();Zt[3]=U;const Vt=N.frameCounter/1e3%1,[kt,Ht]=V.properties.get("vertical-range");return{u_fog_matrix:Z?Gt.calculateFogTileMatrix(Z):bt||N.identityMat,u_fog_range:V.getFovAdjustedRange(Gt._fov),u_fog_color:Zt,u_fog_horizon_blend:V.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(kt,Ht),Ht],u_fog_temporal_offset:Vt,u_frustum_tl:X,u_frustum_tr:Q,u_frustum_br:nt,u_frustum_bl:ht,u_globe_pos:lt,u_globe_radius:_t,u_viewport:Ct,u_globe_transition:i.aj(Gt.zoom),u_is_globe:+(Gt.projection.name==="globe")}})(this,I,f,M,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*i.o.devicePixelRatio,this.transform.height*i.o.devicePixelRatio],y);a.setFogUniformValues(e,L)}w&&a.setCutoffUniformValues(e,w.uniformValues)}setTileLoadedFlag(e){this.tileLoaded=e}saveCanvasCopy(){const e=this.canvasCopy();e&&(this.frameCopies.push(e),this.tileLoaded=!1)}canvasCopy(){const e=this.context.gl,a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,e.drawingBufferWidth,e.drawingBufferHeight,0),a}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const e=this.style&&this.style.fog;return!!e&&e.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const e=this._backgroundTiles,a=this._backgroundTiles={},f=this.transform.coveringTiles({tileSize:512});for(const y of f)a[y.key]=e[y.key]||new Lo(y,512,this.transform.tileZoom,this,void 0,this.worldview);return a}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(e,a){return!(!e.is3D(!(!this.terrain||!this.terrain.enabled))||e.type!=="clip"&&e.type!=="building"&&(e.minzoom&&e.minzoom>this.transform.zoom||(this.style._clipLayerPresent||e.sourceLayer!=="building"&&e.sourceLayer!=="procedural_buildings")&&(!a||a.type!=="batched-model")))}isTileAffectedByFog(e){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let a=this._cachedTileFogOpacities[e.key];return a||(this._cachedTileFogOpacities[e.key]=a=this.style.fog.getOpacityForTile(e)),a[0]>=xe||a[1]>=xe}setupDepthForOcclusion(e,a,f){const y=this.context,w=y.gl,I=!!f;var M;f||(f={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),y.activeTexture.set(w.TEXTURE3),e&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(w.NEAREST,w.CLAMP_TO_EDGE),f.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],f.u_depth_range_unpack=[2/((M=this.depthRangeFor3D)[1]-M[0]),-1-2*M[0]/(M[1]-M[0])],f.u_occluder_half_size=.5*this.occlusionParams.occluderSize,f.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(w.NEAREST,w.CLAMP_TO_EDGE),y.activeTexture.set(w.TEXTURE0),I||a.setTerrainUniformValues(y,f)}}function Mo(p,e){let a=!1,f=null;const y=()=>{f=null,a&&(p(),f=setTimeout(y,e),a=!1)};return()=>(a=!0,f||y(),f)}class hs{constructor(e){this._hashName=e&&encodeURIComponent(e),i.aX(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Mo(this._updateHashUnthrottled.bind(this),300)}addTo(e){return this._map=e,window.addEventListener("hashchange",this._onHashChange,!1),e.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const e=this._map;if(!e)return"";const a=To(e);if(this._hashName){const f=this._hashName;let y=!1;const w=location.hash.slice(1).split("&").map(I=>{const M=I.split("=")[0];return M===f?(y=!0,`${M}=${a}`):I}).filter(I=>I);return y||w.push(`${f}=${a}`),`#${w.join("&")}`}return`#${a}`}_getCurrentHash(){const e=location.hash.replace("#","");if(this._hashName){let a;return e.split("&").map(f=>f.split("=")).forEach(f=>{f[0]===this._hashName&&(a=f)}),(a&&a[1]||"").split("/")}return e.split("/")}_onHashChange(){const e=this._map;if(!e)return!1;const a=this._getCurrentHash();if(a.length>=3&&!a.some(f=>isNaN(Number(f)))){const f=e.dragRotate.isEnabled()&&e.touchZoomRotate.isEnabled()?+(a[3]||0):e.getBearing();return e.jumpTo({center:[+a[2],+a[1]],zoom:+a[0],bearing:f,pitch:+(a[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function To(p,e){const a=p.getCenter(),f=Math.round(100*p.getZoom())/100,y=Math.ceil((f*Math.LN2+Math.log(512/360/.5))/Math.LN10),w=Math.pow(10,y),I=Math.round(a.lng*w)/w,M=Math.round(a.lat*w)/w,L=p.getBearing(),N=p.getPitch();let V=e?`/${I}/${M}/${f}`:`${f}/${M}/${I}`;return(L||N)&&(V+="/"+Math.round(10*L)/10),N&&(V+=`/${Math.round(N)}`),V}const Ll={linearity:.3,easing:i.eS(0,0,.3,1)},ch=Object.assign({deceleration:2500,maxSpeed:1400},Ll),Mp=Object.assign({deceleration:20,maxSpeed:1400},Ll),Rl=Object.assign({deceleration:1e3,maxSpeed:360},Ll),hh=Object.assign({deceleration:1e3,maxSpeed:90},Ll);class Cp{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:i.o.now(),settings:e})}_drainInertiaBuffer(){const e=this._inertiaBuffer,a=i.o.now();for(;e.length>0&&a-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const a={zoom:0,bearing:0,pitch:0,pan:new i.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:w}of this._inertiaBuffer)a.zoom+=w.zoomDelta||0,a.bearing+=w.bearingDelta||0,a.pitch+=w.pitchDelta||0,w.panDelta&&a.pan._add(w.panDelta),w.around&&(a.around=w.around),w.pinchAround&&(a.pinchAround=w.pinchAround);const f=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,y={};if(a.pan.mag()){const w=uh(a.pan.mag(),f,Object.assign({},ch,e||{}));y.offset=a.pan.mult(w.amount/a.pan.mag()),y.center=this._map.transform.center,kl(y,w)}if(a.zoom){const w=uh(a.zoom,f,Mp);y.zoom=this._map.transform.zoom+w.amount,kl(y,w)}if(a.bearing){const w=uh(a.bearing,f,Rl);y.bearing=this._map.transform.bearing+i.aA(w.amount,-179,179),kl(y,w)}if(a.pitch){const w=uh(a.pitch,f,hh);y.pitch=this._map.transform.pitch+w.amount,kl(y,w)}if(y.zoom||y.bearing){const w=a.pinchAround===void 0?a.around:a.pinchAround;y.around=w?this._map.unproject(w):this._map.getCenter()}return this.clear(),y.noMoveStart=!0,y}}function kl(p,e){(!p.duration||p.duration<e.duration)&&(p.duration=e.duration,p.easing=e.easing)}function uh(p,e,a){const{maxSpeed:f,linearity:y,deceleration:w}=a,I=i.aA(p*y/(e/1e3),-f,f),M=Math.abs(I)/(w*y);return{easing:a.easing,duration:1e3*M,amount:I*(M/2)}}class qn extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a,f,y={}){const w=tl(a.getCanvasContainer(),f),I=a.unproject(w);super(e,Object.assign({point:w,lngLat:I,originalEvent:f},y)),this._defaultPrevented=!1,this.target=a}}class Fl extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a,f){const y=e==="touchend"?f.changedTouches:f.touches,w=fa(a.getCanvasContainer(),y),I=w.map(L=>a.unproject(L)),M=w.reduce((L,N,V,Z)=>L.add(N.div(Z.length)),new i.P(0,0));super(e,{points:w,point:M,lngLats:I,lngLat:a.unproject(M),originalEvent:f}),this._defaultPrevented=!1}}class gc extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a){super("wheel",{originalEvent:a}),this._defaultPrevented=!1}}class Wd{constructor(e,a){this._map=e,this._clickTolerance=a.clickTolerance}reset(){this._mousedownPos=void 0}wheel(e){return this._firePreventable(new gc(this._map,e))}mousedown(e,a){return this._mousedownPos=a,this._firePreventable(new qn(e.type,this._map,e))}mouseup(e){this._map.fire(new qn(e.type,this._map,e))}preclick(e){const a=new MouseEvent("preclick",e);this._map.fire(new qn(a.type,this._map,a))}click(e,a){this._mousedownPos&&this._mousedownPos.dist(a)>=this._clickTolerance||(this.preclick(e),this._map.fire(new qn(e.type,this._map,e)))}dblclick(e){return this._firePreventable(new qn(e.type,this._map,e))}mouseover(e){this._map.fire(new qn(e.type,this._map,e))}mouseout(e){this._map.fire(new qn(e.type,this._map,e))}touchstart(e){return this._firePreventable(new Fl(e.type,this._map,e))}touchmove(e){this._map.fire(new Fl(e.type,this._map,e))}touchend(e){this._map.fire(new Fl(e.type,this._map,e))}touchcancel(e){this._map.fire(new Fl(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class dh{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(e){this._map.fire(new qn(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new qn("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._map.fire(new qn(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class xf{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=a.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,a){this.isEnabled()&&e.shiftKey&&e.button===0&&(Fn(),this._startPos=this._lastPos=a,this._active=!0)}mousemoveWindow(e,a){if(!this._active)return;const f=a,y=this._startPos,w=this._lastPos;if(!y||!w||w.equals(f)||!this._box&&f.dist(y)<this._clickTolerance)return;this._lastPos=f,this._box||(this._box=Ri("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",e));const I=Math.min(y.x,f.x),M=Math.max(y.x,f.x),L=Math.min(y.y,f.y),N=Math.max(y.y,f.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${I}px,${L}px)`,this._box.style.width=M-I+"px",this._box.style.height=N-L+"px")})}mouseupWindow(e,a){if(!this._active)return;const f=this._startPos,y=a;if(f&&e.button===0){if(this.reset(),Do(),f.x!==y.x||f.y!==y.y)return this._map.fire(new i.z("boxzoomend",{originalEvent:e})),{cameraAnimation:w=>w.fitScreenCoordinates(f,y,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",e)}}keydown(e){this._active&&e.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",e))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),us(),delete this._startPos,delete this._lastPos}_fireEvent(e,a){return this._map.fire(new i.z(e,{originalEvent:a}))}}function Dp(p,e){const a={};for(let f=0;f<p.length;f++)a[p[f].identifier]=e[f];return a}class zp{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(e,a,f){(this.centroid||f.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=e.timeStamp),f.length===this.numTouches&&(this.centroid=function(y){const w=new i.P(0,0);for(const I of y)w._add(I);return w.div(y.length)}(a),this.touches=Dp(f,a)))}touchmove(e,a,f){if(this.aborted||!this.centroid)return;const y=Dp(f,a);for(const w in this.touches){const I=y[w];(!I||I.dist(this.touches[w])>30)&&(this.aborted=!0)}}touchend(e,a,f){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),f.length===0){const y=!this.aborted&&this.centroid;if(this.reset(),y)return y}}}class Eu{constructor(e){this.singleTap=new zp(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(e,a,f){this.singleTap.touchstart(e,a,f)}touchmove(e,a,f){this.singleTap.touchmove(e,a,f)}touchend(e,a,f){const y=this.singleTap.touchend(e,a,f);if(y){const w=e.timeStamp-this.lastTime<500,I=!this.lastTap||this.lastTap.dist(y)<30;if(w&&I||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=y,this.count===this.numTaps)return this.reset(),y}}}class Cm{constructor(){this._zoomIn=new Eu({numTouches:1,numTaps:2}),this._zoomOut=new Eu({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,a,f){this._zoomIn.touchstart(e,a,f),this._zoomOut.touchstart(e,a,f)}touchmove(e,a,f){this._zoomIn.touchmove(e,a,f),this._zoomOut.touchmove(e,a,f)}touchend(e,a,f){const y=this._zoomIn.touchend(e,a,f),w=this._zoomOut.touchend(e,a,f);return y?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:I=>I.easeTo({duration:300,zoom:I.getZoom()+1,around:I.unproject(y)},{originalEvent:e})}):w?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:I=>I.easeTo({duration:300,zoom:I.getZoom()-1,around:I.unproject(w)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Lp={0:1,2:2},Yf={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class ud{constructor(e){this.reset(),this._clickTolerance=e.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(e,a){return!1}_move(e,a){return{}}mousedown(e,a){if(this._lastPoint)return;const f=Nl(e);this._correctButton(e,f)&&(this._lastPoint=a,this._eventButton=f)}mousemoveWindow(e,a){const f=this._lastPoint;if(f){if(e.preventDefault(),this._eventButton!=null&&function(y,w){const I=Lp[w];return y.buttons===void 0||(y.buttons&I)!==I}(e,this._eventButton))this.reset();else if(this._moved||!(a.dist(f)<this._clickTolerance))return this._moved=!0,this._lastPoint=a,this._move(f,a)}}mouseupWindow(e){this._lastPoint&&Nl(e)===this._eventButton&&(this._moved&&Do(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Jf extends ud{mousedown(e,a){super.mousedown(e,a),this._lastPoint&&(this._active=!0)}_correctButton(e,a){return a===0&&!e.ctrlKey}_move(e,a){return{around:a,panDelta:a.sub(e)}}}class vf extends ud{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?Yf[e.pitchRotateKey]:void 0}_correctButton(e,a){return this._pitchRotateKey?a===0&&e[this._pitchRotateKey]:a===0&&e.ctrlKey||a===2}_move(e,a){const f=.8*(a.x-e.x);if(f)return this._active=!0,{bearingDelta:f}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class dd extends ud{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?Yf[e.pitchRotateKey]:void 0}_correctButton(e,a){return this._pitchRotateKey?a===0&&e[this._pitchRotateKey]:a===0&&e.ctrlKey||a===2}_move(e,a){const f=-.5*(a.y-e.y);if(f)return this._active=!0,{pitchDelta:f}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class fg{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._minTouches=1,this._clickTolerance=a.clickTolerance||1,this.reset(),i.aX(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new i.P(0,0)}touchstart(e,a,f){return this._calculateTransform(e,a,f)}touchmove(e,a,f){if(this._active&&!(f.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(f.length===1&&!i.eT())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return e.cancelable&&e.preventDefault(),this._calculateTransform(e,a,f)}}touchend(e,a,f){this._calculateTransform(e,a,f),this._active&&f.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,a,f){f.length>0&&(this._active=!0);const y=Dp(f,a),w=new i.P(0,0),I=new i.P(0,0);let M=0;for(const N in y){const V=y[N],Z=this._touches[N];Z&&(w._add(V),I._add(V.sub(Z)),M++,y[N]=V)}if(this._touches=y,M<this._minTouches||!I.mag())return;const L=I.div(M);return this._sum._add(L),this._sum.mag()<this._clickTolerance?void 0:{around:w.div(M),panDelta:L}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Ri("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Au{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(e){}_move(e,a,f){return{}}touchstart(e,a,f){this._firstTwoTouches||f.length<2||(this._firstTwoTouches=[f[0].identifier,f[1].identifier],this._start([a[0],a[1]]))}touchmove(e,a,f){const y=this._firstTwoTouches;if(!y)return;e.preventDefault();const[w,I]=y,M=pd(f,a,w),L=pd(f,a,I);if(!M||!L)return;const N=this._aroundCenter?null:M.add(L).div(2);return this._move([M,L],N,e)}touchend(e,a,f){if(!this._firstTwoTouches)return;const[y,w]=this._firstTwoTouches,I=pd(f,a,y),M=pd(f,a,w);I&&M||(this._active&&Do(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&e.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function pd(p,e,a){for(let f=0;f<p.length;f++)if(p[f].identifier===a)return e[f]}function Rp(p,e){return Math.log2(p/e)}class mg extends Au{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,a){const f=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(Rp(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Rp(this._distance,f),pinchAround:a}}}function Dm(p,e){return 180*p.angleWith(e)/Math.PI}class gg extends Au{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,a){const f=this._vector;if(this._vector=e[0].sub(e[1]),f&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Dm(this._vector,f),pinchAround:a}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const a=25/(Math.PI*this._minDiameter)*360,f=this._startVector;if(!f)return!1;const y=Dm(e,f);return Math.abs(y)<a}}function Kf(p){return Math.abs(p.y)>Math.abs(p.x)}class zm extends Au{constructor(e){super(),this._map=e}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(e){this._lastPoints=e,Kf(e[0].sub(e[1]))&&(this._valid=!1)}_move(e,a,f){const y=this._lastPoints;if(!y)return;const w=e[0].sub(y[0]),I=e[1].sub(y[1]);return this._map._cooperativeGestures&&!i.eT()&&f.touches.length<3||(this._valid=this.gestureBeginsVertically(w,I,f.timeStamp),!this._valid)?void 0:(this._lastPoints=e,this._active=!0,{pitchDelta:(w.y+I.y)/2*-.5})}gestureBeginsVertically(e,a,f){if(this._valid!==void 0)return this._valid;const y=e.mag()>=2,w=a.mag()>=2;if(!y&&!w)return;if(!y||!w)return this._firstMove==null&&(this._firstMove=f),f-this._firstMove<100&&void 0;const I=e.y>0==a.y>0;return Kf(e)&&Kf(a)&&I}}const Qf={panStep:100,bearingStep:15,pitchStep:10};class Lm{constructor(){const e=Qf;this._panStep=e.panStep,this._bearingStep=e.bearingStep,this._pitchStep=e.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let a=0,f=0,y=0,w=0,I=0;switch(e.keyCode){case 61:case 107:case 171:case 187:a=1;break;case 189:case 109:case 173:a=-1;break;case 37:e.shiftKey?f=-1:(e.preventDefault(),w=-1);break;case 39:e.shiftKey?f=1:(e.preventDefault(),w=1);break;case 38:e.shiftKey?y=1:(e.preventDefault(),I=-1);break;case 40:e.shiftKey?y=-1:(e.preventDefault(),I=1);break;default:return}return this._rotationDisabled&&(f=0,y=0),{cameraAnimation:M=>{const L=M.getZoom();M.easeTo({duration:300,easeId:"keyboardHandler",easing:Rm,zoom:a?Math.round(L)+a*(e.shiftKey?2:1):L,bearing:M.getBearing()+f*this._bearingStep,pitch:M.getPitch()+y*this._pitchStep,offset:[-w*this._panStep,-I*this._panStep],center:M.getCenter()},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Rm(p){return p*(2-p)}const _g=4.000244140625,f_=1/450;class yg{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._handler=a,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=f_,i.aX(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&e.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(e){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(e.ctrlKey||e.metaKey||this.isZooming()||i.eT()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let a=e.deltaMode===WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const f=i.o.now(),y=f-(this._lastWheelEventTime||0);this._lastWheelEventTime=f,a!==0&&a%_g==0?this._type="wheel":a!==0&&Math.abs(a)<4?this._type="trackpad":y>400?(this._type=null,this._lastValue=a,this._timeout=window.setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(y*a)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,a+=this._lastValue)),e.shiftKey&&a&&(a/=4),this._type&&(this._lastWheelEvent=e,this._delta-=a,this._active||this._start(e)),e.preventDefault()}_onTimeout(e){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(e)}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const a=tl(this._el,e);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:a,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const e=this._map.transform;this._type==="wheel"&&e.projection.wrap&&(e._center.lng>=180||e._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const a=()=>e._terrainEnabled()&&this._aroundCoord?e.computeZoomRelativeTo(this._aroundCoord):e.zoom;if(this._delta!==0){const N=this._type==="wheel"&&Math.abs(this._delta)>_g?this._wheelZoomRate:this._defaultZoomRate;let V=2/(1+Math.exp(-Math.abs(this._delta*N)));this._delta<0&&V!==0&&(V=1/V);const Z=a(),U=Math.pow(2,Z),X=typeof this._targetZoom=="number"?e.zoomScale(this._targetZoom):U;this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,e.scaleZoom(X*V))),this._type==="wheel"&&(this._startZoom=Z,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const f=typeof this._targetZoom=="number"?this._targetZoom:a(),y=this._startZoom,w=this._easing;let I,M=!1;if(this._type==="wheel"&&y&&w){const N=Math.min((i.o.now()-this._lastWheelEventTime)/200,1),V=w(N);I=i.ak(y,f,V),N<1?this._frameId||(this._frameId=!0):M=!0}else I=f,M=!0;this._active=!0,M&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let L=I-a();return L*this._lastDelta<0&&(L=0),{noInertia:!0,needsRenderFrame:!M,zoomDelta:L,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let a=i.eU;if(this._prevEase){const f=this._prevEase,y=(i.o.now()-f.start)/f.duration,w=f.easing(y+.01)-f.easing(y),I=.27/Math.sqrt(w*w+1e-4)*.01,M=Math.sqrt(.0729-I*I);a=i.eS(I,M,.25,1)}return this._prevEase={start:i.o.now(),duration:e,easing:a},a}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Ri("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class po{constructor(e,a){this._clickZoom=e,this._tapZoom=a}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class xg{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(e,a){return e.preventDefault(),{cameraAnimation:f=>{f.easeTo({duration:300,zoom:f.getZoom()+(e.shiftKey?-1:1),around:f.unproject(a)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class km{constructor(){this._tap=new Eu({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(e,a,f){this._swipePoint||(this._tapTime&&e.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?f.length>0&&(this._swipePoint=a[0],this._swipeTouch=f[0].identifier):this._tap.touchstart(e,a,f))}touchmove(e,a,f){if(this._tapTime){if(this._swipePoint){if(f[0].identifier!==this._swipeTouch)return;const y=a[0],w=y.y-this._swipePoint.y;return this._swipePoint=y,e.preventDefault(),this._active=!0,{zoomDelta:w/128}}}else this._tap.touchmove(e,a,f)}touchend(e,a,f){this._tapTime?this._swipePoint&&f.length===0&&this.reset():this._tap.touchend(e,a,f)&&(this._tapTime=e.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class vg{constructor(e,a,f){this._el=e,this._mousePan=a,this._touchPan=f}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Fm{constructor(e,a,f){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=a,this._mousePitch=f}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Pu{constructor(e,a,f,y){this._el=e,this._touchZoom=a,this._touchRotate=f,this._tapDragZoom=y,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const ba=p=>p.zoom||p.drag||p.pitch||p.rotate;class tm extends i.z{}class kp{constructor(){this.constants=[1,1,.01],this.radius=0}setup(e,a){const f=i.av([],a,e);this.radius=i.ag(f[2]<0?i.eW([],f,this.constants):[f[0],f[1],0])}projectRay(e){i.eW(e,e,this.constants),i.aw(e,e),i.eX(e,e,this.constants);const a=i.c4([],e,this.radius);if(a[2]>0){const f=i.c4([],[0,0,1],i.bI(a,[0,0,1])),y=i.c4([],i.aw([],[a[0],a[1],0]),this.radius),w=i.d7([],a,i.c4([],i.av([],i.d7([],y,f),a),2));a[0]=w[0],a[1]=w[1]}return a}}function jc(p){return p.panDelta&&p.panDelta.mag()||p.zoomDelta||p.bearingDelta||p.pitchDelta}class bf{constructor(e,a){this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Cp(e),this._bearingSnap=a.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new kp,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(a),i.aX(["handleEvent","handleWindowEvent"],this);const f=this._el;this._listeners=[[f,"touchstart",{passive:!0}],[f,"touchmove",{passive:!1}],[f,"touchend",void 0],[f,"touchcancel",void 0],[f,"mousedown",void 0],[f,"mousemove",void 0],[f,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[f,"mouseover",void 0],[f,"mouseout",void 0],[f,"dblclick",void 0],[f,"click",void 0],[f,"keydown",{capture:!1}],[f,"keyup",void 0],[f,"wheel",{passive:!1}],[f,"contextmenu",void 0],[window,"blur",void 0]];for(const[y,w,I]of this._listeners){const M=y===document?this.handleWindowEvent:this.handleEvent;y.addEventListener(w,M,I)}}destroy(){for(const[e,a,f]of this._listeners){const y=e===document?this.handleWindowEvent:this.handleEvent;e.removeEventListener(a,y,f)}}_addDefaultHandlers(e){const a=this._map,f=a.getCanvasContainer();this._add("mapEvent",new Wd(a,e));const y=a.boxZoom=new xf(a,e);this._add("boxZoom",y);const w=new Cm,I=new xg;a.doubleClickZoom=new po(I,w),this._add("tapZoom",w),this._add("clickZoom",I);const M=new km;this._add("tapDragZoom",M);const L=a.touchPitch=new zm(a);this._add("touchPitch",L);const N=new vf(e),V=new dd(e);a.dragRotate=new Fm(e,N,V),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",V,["mouseRotate"]);const Z=new Jf(e),U=new fg(a,e);a.dragPan=new vg(f,Z,U),this._add("mousePan",Z),this._add("touchPan",U,["touchZoom","touchRotate"]);const X=new gg,Q=new mg;a.touchZoomRotate=new Pu(f,Q,X,M),this._add("touchRotate",X,["touchPan","touchZoom"]),this._add("touchZoom",Q,["touchPan","touchRotate"]),this._add("blockableMapEvent",new dh(a));const nt=a.scrollZoom=new yg(a,this);this._add("scrollZoom",nt,["mousePan"]);const ht=a.keyboard=new Lm;this._add("keyboard",ht);for(const lt of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])e.interactive&&e[lt]&&a[lt].enable(e[lt])}_add(e,a,f){this._handlers.push({handlerName:e,handler:a,allowed:f}),this._handlersById[e]=a}stop(e){if(!this._updatingCamera){for(const{handler:a}of this._handlers)a.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!ba(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(e,a,f){for(const y in e)if(y!==f&&(!a||a.indexOf(y)<0))return!0;return!1}handleWindowEvent(e){this.handleEvent(e,`${e.type}Window`)}_getMapTouches(e){const a=[];for(const f of e)this._el.contains(f.target)&&a.push(f);return a}handleEvent(e,a){this._updatingCamera=!0;const f=e.type==="renderFrame",y=f?void 0:e,w={needsRenderFrame:!1},I={},M={},L=e.touches?this._getMapTouches(e.touches):void 0,N=L?fa(this._el,L):f?void 0:tl(this._el,e);for(const{handlerName:U,handler:X,allowed:Q}of this._handlers){if(!X.isEnabled())continue;let nt;this._blockedByActive(M,Q,U)?X.reset():X[a||e.type]&&(nt=X[a||e.type](e,N,L),this.mergeHandlerResult(w,I,nt,U,y),nt&&nt.needsRenderFrame&&this._triggerRenderFrame()),(nt||X.isActive())&&(M[U]=X)}const V={};for(const U in this._previousActiveHandlers)M[U]||(V[U]=y);this._previousActiveHandlers=M,(Object.keys(V).length||jc(w))&&(this._changes.push([w,I,V]),this._triggerRenderFrame()),(Object.keys(M).length||jc(w))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:Z}=w;Z&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],Z(this._map))}mergeHandlerResult(e,a,f,y,w){if(!f)return;Object.assign(e,f);const I={handlerName:y,originalEvent:f.originalEvent||w};f.zoomDelta!==void 0&&(a.zoom=I),f.panDelta!==void 0&&(a.drag=I),f.pitchDelta!==void 0&&(a.pitch=I),f.bearingDelta!==void 0&&(a.rotate=I)}_applyChanges(){const e={},a={},f={};for(const[y,w,I]of this._changes)y.panDelta&&(e.panDelta=(e.panDelta||new i.P(0,0))._add(y.panDelta)),y.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+y.zoomDelta),y.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+y.bearingDelta),y.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+y.pitchDelta),y.around!==void 0&&(e.around=y.around),y.aroundCoord!==void 0&&(e.aroundCoord=y.aroundCoord),y.pinchAround!==void 0&&(e.pinchAround=y.pinchAround),y.noInertia&&(e.noInertia=y.noInertia),Object.assign(a,w),Object.assign(f,I);this._updateMapTransform(e,a,f),this._changes=[]}_updateMapTransform(e,a,f){const y=this._map,w=y.transform,I=_t=>[_t.x,_t.y,_t.z];if((_t=>{const Ct=this._eventsInProgress.drag;return Ct&&!this._handlersById[Ct.handlerName].isActive()})()&&!jc(e)){const _t=w.zoom;w.cameraElevationReference="sea",this._originalZoom!=null&&w._orthographicProjectionAtLowPitch&&w.projection.name!=="globe"&&w.pitch===0?(w.cameraElevationReference="ground",w.zoom=this._originalZoom):(w.recenterOnTerrain(),w.cameraElevationReference="ground"),_t!==w.zoom&&this._map._update(!0)}if(w._isCameraConstrained&&y._stop(!0),!jc(e))return void this._fireEvents(a,f,!0);let{panDelta:M,zoomDelta:L,bearingDelta:N,pitchDelta:V,around:Z,aroundCoord:U,pinchAround:X}=e;w._isCameraConstrained&&(L>0&&(L=0),w._isCameraConstrained=!1),X!==void 0&&(Z=X),(L||(_t=>a[_t]&&!this._eventsInProgress[_t])("drag"))&&Z&&(this._dragOrigin=I(w.pointCoordinate3D(Z)),this._originalZoom=w.zoom,this._trackingEllipsoid.setup(w._camera.position,this._dragOrigin)),w.cameraElevationReference="sea",y._stop(!0),Z=Z||y.transform.centerPoint,N&&(w.bearing+=N),V&&(w.pitch+=V),w._updateCameraState();const Q=[0,0,0];if(M)if(w.projection.name==="mercator"){const _t=this._trackingEllipsoid.projectRay(w.screenPointToMercatorRay(Z).dir),Ct=this._trackingEllipsoid.projectRay(w.screenPointToMercatorRay(Z.sub(M)).dir);Q[0]=Ct[0]-_t[0],Q[1]=Ct[1]-_t[1]}else{const _t=w.pointCoordinate(Z);if(w.projection.name==="globe"){M=M.rotate(-w.angle);const Ct=w._pixelsPerMercatorPixel/w.worldSize;Q[0]=-M.x*i.eV(i.a_(_t.y))*Ct,Q[1]=-M.y*i.eV(w.center.lat)*Ct}else{const Ct=w.pointCoordinate(Z.sub(M));_t&&Ct&&(Q[0]=Ct.x-_t.x,Q[1]=Ct.y-_t.y)}}const nt=w.zoom,ht=[0,0,0];if(L){const _t=I(U||w.pointCoordinate3D(Z)),Ct={dir:i.aw([],i.av([],_t,w._camera.position))};if(Ct.dir[2]<0){const bt=w.zoomDeltaToMovement(_t,L);i.c4(ht,Ct.dir,bt)}}const lt=i.d7(Q,Q,ht);w._translateCameraConstrained(lt),L&&Math.abs(w.zoom-nt)>1e-4&&w.recenterOnTerrain(),w.cameraElevationReference="ground",this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(a,f,!0)}_fireEvents(e,a,f){const y=ba(this._eventsInProgress),w=ba(e),I={};for(const V in e){const{originalEvent:Z}=e[V];this._eventsInProgress[V]||(I[`${V}start`]=Z),this._eventsInProgress[V]=e[V]}!y&&w&&this._fireEvent("movestart",w.originalEvent);for(const V in I)this._fireEvent(V,I[V]);w&&this._fireEvent("move",w.originalEvent);for(const V in e){const{originalEvent:Z}=e[V];this._fireEvent(V,Z)}const M={};let L;for(const V in this._eventsInProgress){const{handlerName:Z,originalEvent:U}=this._eventsInProgress[V];this._handlersById[Z].isActive()||(delete this._eventsInProgress[V],L=a[Z]||U,M[`${V}end`]=L)}for(const V in M)this._fireEvent(V,M[V]);const N=ba(this._eventsInProgress);if(f&&(y||w)&&!N){this._updatingCamera=!0;const V=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),Z=U=>U!==0&&-this._bearingSnap<U&&U<this._bearingSnap;V?(Z(V.bearing||this._map.getBearing())&&(V.bearing=0),this._map.easeTo(V,{originalEvent:L})):(this._map.fire(new i.z("moveend",{originalEvent:L})),Z(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(e,a){this._map.fire(new i.z(e,a?{originalEvent:a}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(e=>{this._frameId=void 0,this.handleEvent(new tm("renderFrame",{timeStamp:e})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const ts="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Jh extends i.E{constructor(e,a){super(),this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=a.bearingSnap,this._respectPrefersReducedMotion=a.respectPrefersReducedMotion!==!1,i.aX(["_renderFrameCallback"],this)}getCenter(){return new i.aS(this.transform.center.lng,this.transform.center.lat)}setCenter(e,a){return this.jumpTo({center:e},a)}panBy(e,a,f){return e=i.P.convert(e).mult(-1),this.panTo(this.transform.center,Object.assign({offset:e},a),f)}panTo(e,a,f){return this.easeTo(Object.assign({center:e},a),f)}getZoom(){return this.transform.zoom}setZoom(e,a){return this.jumpTo({zoom:e},a),this}zoomTo(e,a,f){return this.easeTo(Object.assign({zoom:e},a),f)}zoomIn(e,a){return this.zoomTo(this.getZoom()+1,e,a),this}zoomOut(e,a){return this.zoomTo(this.getZoom()-1,e,a),this}getBearing(){return this.transform.bearing}setBearing(e,a){return this.jumpTo({bearing:e},a),this}getPadding(){return this.transform.padding}setPadding(e,a){return this.jumpTo({padding:e},a),this}rotateTo(e,a,f){return this.easeTo(Object.assign({bearing:e},a),f)}resetNorth(e,a){return this.rotateTo(0,Object.assign({duration:1e3},e),a),this}resetNorthPitch(e,a){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},e),a),this}snapToNorth(e,a){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,a):this}getPitch(){return this.transform.pitch}setPitch(e,a){return this.jumpTo({pitch:e},a),this}cameraForBounds(e,a){e=i.aI.convert(e);const f=a&&a.bearing||0,y=a&&a.pitch||0,w=e.getNorthWest(),I=e.getSouthEast();return this._cameraForBounds(this.transform,w,I,f,y,a)}_extendPadding(e){const a={top:0,right:0,bottom:0,left:0};return e==null?Object.assign({},a,this.transform.padding):typeof e=="number"?{top:e,bottom:e,right:e,left:e}:Object.assign({},a,e)}_extendCameraOptions(e){return(e=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},e)).padding=this._extendPadding(e.padding),e}_minimumAABBFrustumDistance(e,a){const f=a.max[0]-a.min[0],y=a.max[1]-a.min[1];return f/y>e.aspect?f/(2*Math.tan(.5*e.fovX)*e.aspect):y/(2*Math.tan(.5*e.fovY)*e.aspect)}_cameraForBoundsOnGlobe(e,a,f,y,w,I){const M=e.clone(),L=this._extendCameraOptions(I);M.bearing=y,M.pitch=w;const N=i.aS.convert(a),V=i.aS.convert(f),Z=.5*(N.lat+V.lat),U=.5*(N.lng+V.lng),X=i.eY(Z,U),Q=i.aw([],X),nt=i.aw([],i.bH([],Q,[0,1,0])),ht=i.bH([],nt,Q),lt=[nt[0],nt[1],nt[2],0,ht[0],ht[1],ht[2],0,Q[0],Q[1],Q[2],0,0,0,0,1],_t=[X,i.eY(N.lat,N.lng),i.eY(V.lat,N.lng),i.eY(V.lat,V.lng),i.eY(N.lat,V.lng),i.eY(Z,N.lng),i.eY(Z,V.lng),i.eY(N.lat,U),i.eY(V.lat,U)];let Ct=i.d8.fromPoints(_t.map(Te=>[i.bI(nt,Te),i.bI(ht,Te),i.bI(Q,Te)]));const bt=i.af([],Ct.center,lt);i.eZ(bt)===0&&i.e_(bt,0,0,1),i.aw(bt,bt),i.c4(bt,bt,i.aD),M.center=i.e$(bt);const Gt=M.getWorldToCameraMatrix(),zt=i.bk(new Float64Array(16),Gt);Ct=i.d8.applyTransform(Ct,i.aB([],Gt,lt));const Zt=this._extendAABB(Ct,M,L,y);if(!Zt)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Ct=Zt,i.af(bt,bt,Gt);const Vt=.5*(Ct.max[2]-Ct.min[2]),kt=this._minimumAABBFrustumDistance(M,Ct),Ht=i.c4([],[0,0,1],Vt),pe=i.d7(Ht,bt,Ht),ae=kt+(M.pitch===0?0:i.bF(bt,pe)),Ce=M.globeCenterInViewSpace,ve=i.av([],bt,[Ce[0],Ce[1],Ce[2]]);i.aw(ve,ve),i.c4(ve,ve,ae);const Fe=i.d7([],bt,ve);i.af(Fe,Fe,zt);const oi=i.eL/i.aD,ge=i.ag(Fe),re=i.ce(Math.max(ge*oi-i.eL,Number.EPSILON),0),Be=Math.min(M.zoomFromMercatorZAdjusted(re),L.maxZoom);return Be>.5*(i.cZ+i.cK)?(M.setProjection({name:"mercator"}),M.zoom=Be,this._cameraForBounds(M,a,f,y,w,I)):{center:M.center,zoom:Be,bearing:y,pitch:w}}_extendAABB(e,a,f,y){const w=.5*((f.padding.left||0)+(f.padding.right||0)),I=.5*((f.padding.top||0)+(f.padding.bottom||0)),M=I,L=w,N=w,V=I,Z=a.width-(L+N),U=a.height-(M+V),X=i.av([],e.max,e.min),Q=Math.min(Z/X[0],U/X[1]),nt=Math.min(a.scaleZoom(a.scale*Q),f.maxZoom);if(isNaN(nt))return null;const ht=a.scale/a.zoomScale(nt),lt=new i.d8([e.min[0]-L*ht,e.min[1]-V*ht,e.min[2]],[e.max[0]+N*ht,e.max[1]+M*ht,e.max[2]]),_t=(typeof f.offset.x=="number"&&typeof f.offset.y=="number"?new i.P(f.offset.x,f.offset.y):i.P.convert(f.offset)).rotate(-i.an(y));return lt.center[0]-=_t.x*ht,lt.center[1]+=_t.y*ht,lt}queryTerrainElevation(e,a){const f=this.transform.elevation;return f?(a=Object.assign({},{exaggerated:!0},a),f.getAtPoint(i.ae.fromLngLat(e),null,a.exaggerated)):null}_cameraForBounds(e,a,f,y,w,I){if(e.projection.name==="globe")return this._cameraForBoundsOnGlobe(e,a,f,y,w,I);const M=e.clone(),L=this._extendCameraOptions(I);M.bearing=y,M.pitch=w;const N=i.aS.convert(a),V=i.aS.convert(f),Z=new i.aS(N.lng,V.lat),U=new i.aS(V.lng,N.lat),X=M.project(N),Q=M.project(V),nt=this.queryTerrainElevation(N),ht=this.queryTerrainElevation(V),lt=this.queryTerrainElevation(Z),_t=this.queryTerrainElevation(U),Ct=[[X.x,X.y,Math.min(nt||0,ht||0,lt||0,_t||0)],[Q.x,Q.y,Math.max(nt||0,ht||0,lt||0,_t||0)]];let bt=i.d8.fromPoints(Ct);const Gt=M.getWorldToCameraMatrix(),zt=i.bk(new Float64Array(16),Gt);bt=i.d8.applyTransform(bt,Gt);const Zt=this._extendAABB(bt,M,L,y);if(!Zt)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");bt=Zt;const Vt=.5*i.av([],bt.max,bt.min)[2],kt=this._minimumAABBFrustumDistance(M,bt),Ht=[0,0,1,0];i.aC(Ht,Ht,Gt),i.f0(Ht,Ht);const pe=i.c4([],Ht,kt+Vt),ae=i.d7([],bt.center,pe);i.af(bt.center,bt.center,zt),i.af(ae,ae,zt);const Ce=M.unproject(new i.P(bt.center[0],bt.center[1])),ve=i.f1(M.projection,Ce),Fe=Math.pow(2,ve),oi=Math.min(M._zoomFromMercatorZ(ae[2]*M.pixelsPerMeter*Fe/M.worldSize),L.maxZoom);return M.mercatorFromTransition&&oi<.5*(i.cZ+i.cK)?(M.setProjection({name:"globe"}),M.zoom=oi,this._cameraForBounds(M,a,f,y,w,I)):{center:Ce,zoom:oi,bearing:y,pitch:w}}fitBounds(e,a,f){const y=this.cameraForBounds(e,a);return this._fitInternal(y,a,f)}fitScreenCoordinates(e,a,f,y,w){const I=i.P.convert(e),M=i.P.convert(a),L=new i.P(Math.min(I.x,M.x),Math.min(I.y,M.y)),N=new i.P(Math.max(I.x,M.x),Math.max(I.y,M.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(I,M))return this;const V=this.transform.pointLocation3D(L),Z=this.transform.pointLocation3D(N),U=this.transform.pointLocation3D(new i.P(L.x,N.y)),X=this.transform.pointLocation3D(new i.P(N.x,L.y)),Q=[Math.min(V.lng,Z.lng,U.lng,X.lng),Math.min(V.lat,Z.lat,U.lat,X.lat)],nt=[Math.max(V.lng,Z.lng,U.lng,X.lng),Math.max(V.lat,Z.lat,U.lat,X.lat)],ht=y&&y.pitch?y.pitch:this.getPitch(),lt=this._cameraForBounds(this.transform,Q,nt,f,ht,y);return this._fitInternal(lt,y,w)}_fitInternal(e,a,f){return e?(a=Object.assign(e,a)).linear?this.easeTo(a,f):this.flyTo(a,f):this}jumpTo(e,a){this.stop();const f=e.preloadOnly?this.transform.clone():this.transform;let y=!1,w=!1,I=!1;"zoom"in e&&f.zoom!==+e.zoom&&(y=!0,f.zoom=+e.zoom),e.center!==void 0&&(f.center=i.aS.convert(e.center)),"bearing"in e&&f.bearing!==+e.bearing&&(w=!0,f.bearing=+e.bearing),"pitch"in e&&f.pitch!==+e.pitch&&(I=!0,f.pitch=+e.pitch);const M=typeof e.padding=="number"?this._extendPadding(e.padding):e.padding;if(e.padding!=null&&!f.isPaddingEqual(M))if(e.retainPadding===!1){const L=f.clone();L.padding=M,f.setLocationAtPoint(f.center,L.centerPoint)}else f.padding=M;return e.preloadOnly?(this._preloadTiles(f),this):(this.fire(new i.z("movestart",a)).fire(new i.z("move",a)),y&&this.fire(new i.z("zoomstart",a)).fire(new i.z("zoom",a)).fire(new i.z("zoomend",a)),w&&this.fire(new i.z("rotatestart",a)).fire(new i.z("rotate",a)).fire(new i.z("rotateend",a)),I&&this.fire(new i.z("pitchstart",a)).fire(new i.z("pitch",a)).fire(new i.z("pitchend",a)),this.fire(new i.z("moveend",a)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||i.w(ts),this.transform.getFreeCameraOptions()}setFreeCameraOptions(e,a){const f=this.transform;if(!f.projection.supportsFreeCamera)return i.w(ts),this;this.stop();const y=f.zoom,w=f.pitch,I=f.bearing;f.setFreeCameraOptions(e);const M=y!==f.zoom,L=w!==f.pitch,N=I!==f.bearing;return this.fire(new i.z("movestart",a)).fire(new i.z("move",a)),M&&this.fire(new i.z("zoomstart",a)).fire(new i.z("zoom",a)).fire(new i.z("zoomend",a)),N&&this.fire(new i.z("rotatestart",a)).fire(new i.z("rotate",a)).fire(new i.z("rotateend",a)),L&&this.fire(new i.z("pitchstart",a)).fire(new i.z("pitch",a)).fire(new i.z("pitchend",a)),this.fire(new i.z("moveend",a)),this}easeTo(e,a){this._stop(!1,e.easeId),((e=Object.assign({offset:[0,0],duration:500,easing:i.eU},e)).animate===!1||this._prefersReducedMotion(e))&&(e.duration=0);const f=this.transform,y=this.getZoom(),w=this.getBearing(),I=this.getPitch(),M=this.getPadding(),L="zoom"in e?+e.zoom:y,N="bearing"in e?this._normalizeBearing(e.bearing,w):w,V="pitch"in e?+e.pitch:I,Z=this._extendPadding(e.padding),U=i.P.convert(e.offset);let X,Q,nt;if(f.projection.name==="globe"){const Ht=i.ae.fromLngLat(f.center),pe=U.rotate(-f.angle);Ht.x+=pe.x/f.worldSize,Ht.y+=pe.y/f.worldSize;const ae=Ht.toLngLat(),Ce=i.aS.convert(e.center||ae);this._normalizeCenter(Ce),X=f.centerPoint.add(pe),Q=new i.P(Ht.x,Ht.y).mult(f.worldSize),nt=new i.P(i.aF(Ce.lng),i.aJ(Ce.lat)).mult(f.worldSize).sub(Q)}else{X=f.centerPoint.add(U);const Ht=f.pointLocation(X),pe=i.aS.convert(e.center||Ht);this._normalizeCenter(pe),Q=f.project(Ht),nt=f.project(pe).sub(Q)}const ht=f.zoomScale(L-y);let lt,_t;e.around&&(lt=i.aS.convert(e.around),_t=f.locationPoint(lt));const Ct=this._zooming||L!==y,bt=this._rotating||w!==N,Gt=this._pitching||V!==I,zt=!f.isPaddingEqual(Z),Zt=e.retainPadding===!1?f.clone():f,Vt=Ht=>pe=>{if(Ct&&(Ht.zoom=i.ak(y,L,pe)),bt&&(Ht.bearing=i.ak(w,N,pe)),Gt&&(Ht.pitch=i.ak(I,V,pe)),zt&&(Zt.interpolatePadding(M,Z,pe),X=Zt.centerPoint.add(U)),lt)Ht.setLocationAtPoint(lt,_t);else{const ae=Ht.zoomScale(Ht.zoom-y),Ce=L>y?Math.min(2,ht):Math.max(.5,ht),ve=Math.pow(Ce,1-pe),Fe=Ht.unproject(Q.add(nt.mult(pe*ve)).mult(ae));Ht.setLocationAtPoint(Ht.renderWorldCopies?Fe.wrap():Fe,X)}return e.preloadOnly||this._fireMoveEvents(a),Ht};if(e.preloadOnly){const Ht=this._emulate(Vt,e.duration,f);return this._preloadTiles(Ht),this}const kt={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Ct,this._rotating=bt,this._pitching=Gt,this._padding=zt,this._easeId=e.easeId,this._prepareEase(a,e.noMoveStart,kt),this._ease(Vt(f),Ht=>{f.cameraElevationReference==="sea"&&f.recenterOnTerrain(),this._afterEase(a,Ht)},e),this}_prepareEase(e,a,f={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),a||f.moving||this.fire(new i.z("movestart",e)),this._zooming&&!f.zooming&&this.fire(new i.z("zoomstart",e)),this._rotating&&!f.rotating&&this.fire(new i.z("rotatestart",e)),this._pitching&&!f.pitching&&this.fire(new i.z("pitchstart",e))}_fireMoveEvents(e){this.fire(new i.z("move",e)),this._zooming&&this.fire(new i.z("zoom",e)),this._rotating&&this.fire(new i.z("rotate",e)),this._pitching&&this.fire(new i.z("pitch",e))}_afterEase(e,a){if(this._easeId&&a&&this._easeId===a)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const f=this._zooming,y=this._rotating,w=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,f&&this.fire(new i.z("zoomend",e)),y&&this.fire(new i.z("rotateend",e)),w&&this.fire(new i.z("pitchend",e)),this.fire(new i.z("moveend",e))}flyTo(e,a){if(this._prefersReducedMotion(e)){const Te=i.aH(e,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Te,a)}this.stop(),e=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:i.eU},e);const f=this.transform,y=this.getZoom(),w=this.getBearing(),I=this.getPitch(),M=this.getPadding(),L="zoom"in e?i.aA(+e.zoom,f.minZoom,f.maxZoom):y,N="bearing"in e?this._normalizeBearing(e.bearing,w):w,V="pitch"in e?+e.pitch:I,Z=this._extendPadding(e.padding),U=f.zoomScale(L-y),X=i.P.convert(e.offset);let Q=f.centerPoint.add(X);const nt=f.pointLocation(Q),ht=i.aS.convert(e.center||nt);this._normalizeCenter(ht);const lt=f.project(nt),_t=f.project(ht).sub(lt);let Ct=e.curve;const bt=Math.max(f.width,f.height),Gt=bt/U,zt=_t.mag();if("minZoom"in e){const Te=i.aA(Math.min(e.minZoom,y,L),f.minZoom,f.maxZoom),qe=bt/f.zoomScale(Te-y);Ct=Math.sqrt(qe/zt*2)}const Zt=Ct*Ct;function Vt(Te){const qe=(Gt*Gt-bt*bt+(Te?-1:1)*Zt*Zt*zt*zt)/(2*(Te?Gt:bt)*Zt*zt);return Math.log(Math.sqrt(qe*qe+1)-qe)}function kt(Te){return(Math.exp(Te)-Math.exp(-Te))/2}function Ht(Te){return(Math.exp(Te)+Math.exp(-Te))/2}const pe=Vt(0);let ae=function(Te){return Ht(pe)/Ht(pe+Ct*Te)},Ce=function(Te){return bt*((Ht(pe)*(kt(qe=pe+Ct*Te)/Ht(qe))-kt(pe))/Zt)/zt;var qe},ve=(Vt(1)-pe)/Ct;if(Math.abs(zt)<1e-6||!isFinite(ve)){if(Math.abs(bt-Gt)<1e-6)return this.easeTo(e,a);const Te=Gt<bt?-1:1;ve=Math.abs(Math.log(Gt/bt))/Ct,Ce=function(){return 0},ae=function(qe){return Math.exp(Te*Ct*qe)}}e.duration="duration"in e?+e.duration:1e3*ve/("screenSpeed"in e?+e.screenSpeed/Ct:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0);const Fe=w!==N,oi=V!==I,ge=!f.isPaddingEqual(Z),re=e.retainPadding===!1?f.clone():f,Be=Te=>qe=>{const si=qe*ve,Ci=1/ae(si);Te.zoom=qe===1?L:y+Te.scaleZoom(Ci),Fe&&(Te.bearing=i.ak(w,N,qe)),oi&&(Te.pitch=i.ak(I,V,qe)),ge&&(re.interpolatePadding(M,Z,qe),Q=re.centerPoint.add(X));const ni=qe===1?ht:Te.unproject(lt.add(_t.mult(Ce(si))).mult(Ci));return Te.setLocationAtPoint(Te.renderWorldCopies?ni.wrap():ni,Q),Te._updateCameraOnTerrain(),e.preloadOnly||this._fireMoveEvents(a),Te};if(e.preloadOnly){const Te=this._emulate(Be,e.duration,f);return this._preloadTiles(Te),this}return this._zooming=!0,this._rotating=Fe,this._pitching=oi,this._padding=ge,this._prepareEase(a,!1),this._ease(Be(f),()=>this._afterEase(a),e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(e){}_cancelRenderFrame(e){}_stop(e,a){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const f=this._onEaseEnd;this._onEaseEnd=void 0,f.call(this,a)}if(!e){const f=this.handlers;f&&f.stop(!1)}return this}_ease(e,a,f){f.animate===!1||f.duration===0?(e(1),a()):(this._easeStart=i.o.now(),this._easeOptions=f,this._onEaseFrame=e,this._onEaseEnd=a,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const e=Math.min((i.o.now()-this._easeStart)/this._easeOptions.duration,1),a=this._onEaseFrame;a&&a(this._easeOptions.easing(e)),e<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(e,a){e=i.bS(e,-180,180);const f=Math.abs(e-a);return Math.abs(e-360-a)<f&&(e-=360),Math.abs(e+360-a)<f&&(e+=360),e}_normalizeCenter(e){const a=this.transform;if(a.maxBounds||a.projection.name!=="globe"&&!a.renderWorldCopies)return;const f=e.lng-a.center.lng;e.lng+=f>180?-360:f<-180?360:0}_prefersReducedMotion(e){return this._respectPrefersReducedMotion&&i.o.prefersReducedMotion&&!(e&&e.essential)}_emulate(e,a,f){const y=Math.ceil(15*a/1e3),w=[],I=e(f.clone());for(let M=0;M<=y;M++){const L=I(M/y);w.push(L.clone())}return w}_preloadTiles(e,a){}}class Xd{constructor(e={}){this.options=e,i.aX(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(e){const a=this.options&&this.options.compact,f=e._getUIString("AttributionControl.ToggleAttribution");this._map=e,this._container=Ri("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Ri("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",f);const y=Ri("span","mapboxgl-ctrl-icon",this._compactButton);return y.setAttribute("aria-hidden","true"),y.setAttribute("title",f),this._innerContainer=Ri("div","mapboxgl-ctrl-attrib-inner",this._container),a&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),a===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let e=this._editLink;e||(e=this._editLink=this._container.querySelector(".mapbox-improve-map"));const a=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||i.e.ACCESS_TOKEN}];if(e){const f=a.reduce((y,w,I)=>(w.value&&(y+=`${w.key}=${w.value}${I<a.length-1?"&":""}`),y),"?");e.href=`${i.e.FEEDBACK_URL}/${f}#${To(this._map,!0)}`,e.rel="noopener nofollow"}}_updateData(e){!e||(e.dataType!=="source"||e.sourceDataType!=="metadata"&&e.sourceDataType!=="visibility")&&e.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let e=[];if(this._map.style.stylesheet){const y=this._map.style.stylesheet;this.styleOwner=y.owner,this.styleId=y.id}const a=this._map.style._mergedSourceCaches;for(const y in a){const w=a[y];if(w.used){const I=w.getSource();I.attribution&&e.indexOf(I.attribution)<0&&e.push(I.attribution)}}e.sort((y,w)=>y.length-w.length),e=e.filter((y,w)=>{for(let I=w+1;I<e.length;I++)if(e[I].indexOf(y)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=[...this.options.customAttribution,...e]:e.unshift(this.options.customAttribution));const f=e.join(" | ");f!==this._attribHTML&&(this._attribHTML=f,e.length?(this._innerContainer.innerHTML=f,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class wf{constructor(){i.aX(["_updateLogo","_updateCompact"],this)}onAdd(e){this._map=e,this._container=Ri("div","mapboxgl-ctrl");const a=Ri("a","mapboxgl-ctrl-logo");return a.target="_blank",a.rel="noopener nofollow",a.href="https://www.mapbox.com/",a.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),a.setAttribute("rel","noopener nofollow"),this._container.appendChild(a),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(e){e&&e.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const e=this._map.style._sourceCaches;if(Object.entries(e).length===0)return!0;for(const a in e){const f=e[a].getSource();if(f.hasOwnProperty("mapbox_logo")&&!f.mapbox_logo)return!1}return!0}_updateCompact(){const e=this._container.children;if(e.length){const a=e[0];this._map.getCanvasContainer().offsetWidth<250?a.classList.add("mapboxgl-compact"):a.classList.remove("mapboxgl-compact")}}}class Tf{constructor(){i.aX(["_onIndoorUpdate"],this)}onAdd(e){return this._map=e,this._container=Ri("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",a=>this._onIndoorUpdate(a)),this._container}_createButton(e,a){const f=Ri("button",e,this._container);return f.type="button",f.addEventListener("click",a),f}_createSeparator(){return Ri("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(e,a){this._map&&(e.setAttribute("aria-label",a),e.textContent=a)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(e){if(!e||!e.floors)return this._model=e,void(this._container.style.display="none");const a=this._model;this._model=e,this._container.style.display="inline-block",this._container.style.borderRadius="8px",a&&Array.from(this._container.children).forEach(f=>f.remove()),e.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(e.floors,e.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const e=this._createButton("mapboxgl-ctrl-buildings-toggle",()=>{const a=this._map;this._model&&a&&a._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)});Ri("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&e.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(e),this._createSeparator()}_updateBuildingsButtonState(){const e=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");e&&this._model&&(this._model.activeFloorsVisible?e.classList.remove("mapboxgl-ctrl-level-button-selected"):e.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(e,a){for(let f=0;f<e.length;f++){const y=e[f],w=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(y.id)});this._setButtonTitle(w,y.zIndex.toString()),this._model&&y.id===this._model.selectedFloorId&&a&&w.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(w),f<e.length-1&&this._createSeparator()}}}class Bm{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const a=++this._id;return this._queue.push({callback:e,id:a,cancelled:!1}),a}remove(e){const a=this._currentlyRunning,f=a?this._queue.concat(a):this._queue;for(const y of f)if(y.id===e)return void(y.cancelled=!0)}run(e=0){const a=this._currentlyRunning=this._queue;this._queue=[];for(const f of a)if(!f.cancelled&&(f.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Fp{constructor(e){this.jumpTo(e)}getValue(e){if(e<=this._startTime)return this._start;if(e>=this._endTime)return this._end;const a=i.dC((e-this._startTime)/(this._endTime-this._startTime));return this._start*(1-a)+this._end*a}isEasing(e){return e>=this._startTime&&e<=this._endTime}jumpTo(e){this._startTime=-1/0,this._endTime=-1/0,this._start=e,this._end=e}easeTo(e,a,f){this._start=this.getValue(a),this._end=e,this._startTime=a,this._endTime=a+f}}const m_={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class bg extends i.z{constructor(e,a,f,y){const{point:w,lngLat:I,originalEvent:M,target:L}=e;super(e.type,{point:w,lngLat:I,originalEvent:M,target:L}),this.preventDefault=()=>{e.preventDefault()},this.id=a,this.interaction=f,this.feature=y}}class Om{constructor(e){this.map=e,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(e,a){if(this.typeById.has(e))throw new Error(`Interaction id "${e}" already exists.`);const f=a.filter;let y=a.type;f&&this.filters.set(e,i.b5(f)),y==="mouseover"&&(y="mouseenter"),y==="mouseout"&&(y="mouseleave");const w=this.interactionsByType.get(y)||new Map;y==="mouseenter"||y==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(e,a)):w.size===0&&this.map.on(y,this.handleType),w.size===0&&this.interactionsByType.set(y,w),w.set(e,a),this.typeById.set(e,y)}get(e){const a=this.typeById.get(e);if(!a)return;const f=this.interactionsByType.get(a);return f?f.get(e):void 0}remove(e){const a=this.typeById.get(e);if(!a)return;this.typeById.delete(e),this.filters.delete(e);const f=this.interactionsByType.get(a);f&&(f.delete(e),a==="mouseenter"||a==="mouseleave"?(this.delegatedInteractions.delete(e),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):f.size===0&&this.map.off(a,this.handleType))}queryTargets(e,a){const f=[];for(const[y,w]of a)w.target&&f.push({targetId:y,target:w.target,filter:this.filters.get(y)});return this.map.style.queryRenderedTargets(e,f,this.map.transform)}handleMove(e){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const a=this.queryTargets(e.point,Array.from(this.delegatedInteractions).reverse());a.length&&(e.type="mouseenter",this.handleType(e,a));const f=new Map;for(const[y,{feature:w}]of this.prevHoveredFeatures)this.hoveredFeatures.has(y)||f.set(w.id,w);f.size&&(e.type="mouseleave",this.handleType(e,Array.from(f.values())))}handleOut(e){const a=Array.from(this.hoveredFeatures.values()).map(({feature:f})=>f);a.length&&(e.type="mouseleave",this.handleType(e,a)),this.hoveredFeatures.clear()}handleType(e,a){const f=e.type==="mouseenter";if(f&&!this.interactionsByType.has(e.type))return void i.w("mouseenter interaction required for mouseleave to work.");const y=Array.from(this.interactionsByType.get(e.type)).reverse(),w=!!a;a=a||this.queryTargets(e.point,y);let I=!1;const M=new Set;for(const L of a){for(const[N,V]of y){if(!V.target)continue;const Z=L.variants?L.variants[N]:null;if(Z){for(const U of Z){if(Pa(U,L,M,N))continue;const X=new i.dw(L,U),Q=Al(U,L,N);w&&X.id!==void 0&&(X.state=this.map.getFeatureState(X));const nt=f?this.prevHoveredFeatures.get(Q):null,ht=new bg(e,N,V,X),lt=nt?nt.stop:V.handler(ht);if(f&&this.hoveredFeatures.set(Q,{feature:L,stop:lt}),lt!==!1){I=!0;break}}if(I)break}}if(I)break}if(!I)for(const[L,N]of y){const{handler:V,target:Z}=N;if(!Z&&V(new bg(e,L,N,null))!==!1)break}}}function Bp(p,e){if(Array.isArray(p)&&Array.isArray(e)){const a=new Set(p),f=new Set(e);return a.size===f.size&&p.every(y=>f.has(y))}return i.bx(p,e)}const Op={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Sf={showCompass:!0,showZoom:!0,visualizePitch:!1};class ph{constructor(e,a,f=!1){this._clickTolerance=10,this.element=a,this.mouseRotate=new vf({clickTolerance:e.dragRotate._mouseRotate._clickTolerance}),this.map=e,f&&(this.mousePitch=new dd({clickTolerance:e.dragRotate._mousePitch._clickTolerance})),i.aX(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener("mousedown",this.mousedown),a.addEventListener("touchstart",this.touchstart,{passive:!1}),a.addEventListener("touchmove",this.touchmove),a.addEventListener("touchend",this.touchend),a.addEventListener("touchcancel",this.reset)}down(e,a){this.mouseRotate.mousedown(e,a),this.mousePitch&&this.mousePitch.mousedown(e,a),Fn()}move(e,a){const f=this.map,y=this.mouseRotate.mousemoveWindow(e,a),w=y&&y.bearingDelta;if(w&&f.setBearing(f.getBearing()+w),this.mousePitch){const I=this.mousePitch.mousemoveWindow(e,a),M=I&&I.pitchDelta;M&&f.setPitch(f.getPitch()+M)}}off(){const e=this.element;e.removeEventListener("mousedown",this.mousedown),e.removeEventListener("touchstart",this.touchstart),e.removeEventListener("touchmove",this.touchmove),e.removeEventListener("touchend",this.touchend),e.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){us(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(e){this.down(Object.assign({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),tl(this.element,e)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(e){this.move(e,tl(this.element,e))}mouseup(e){this.mouseRotate.mouseupWindow(e),this.mousePitch&&this.mousePitch.mouseupWindow(e),this.offTemp()}touchstart(e){e.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=fa(this.element,e.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>e.preventDefault()},this._startPos))}touchmove(e){e.targetTouches.length!==1?this.reset():(this._lastPos=fa(this.element,e.targetTouches)[0],this.move({preventDefault:()=>e.preventDefault()},this._lastPos))}touchend(e){e.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function _c(p,e,a){if(p=new i.aS(p.lng,p.lat),e){const f=new i.aS(p.lng-360,p.lat),y=new i.aS(p.lng+360,p.lat),w=360*Math.ceil(Math.abs(p.lng-a.center.lng)/360),I=a.locationPoint3D(p).distSqr(e),M=e.x<0||e.y<0||e.x>a.width||e.y>a.height;a.locationPoint3D(f).distSqr(e)<I&&(M||Math.abs(f.lng-a.center.lng)<w)?p=f:a.locationPoint3D(y).distSqr(e)<I&&(M||Math.abs(y.lng-a.center.lng)<w)&&(p=y)}for(;Math.abs(p.lng-a.center.lng)>180;){const f=a.locationPoint3D(p);if(f.x>=0&&f.y>=0&&f.x<=a.width&&f.y<=a.height)break;p.lng>a.center.lng?p.lng-=360:p.lng+=360}return p}const fh={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},ka={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Mu extends i.E{constructor(e,a){super(),(e instanceof HTMLElement||a)&&(e=Object.assign({element:e},a)),i.aX(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:f="center",color:y="#3FB1CE",scale:w=1,draggable:I=!1,clickTolerance:M=0,rotation:L=ka.rotation,rotationAlignment:N=ka.rotationAlignment,pitchAlignment:V=ka.pitchAlignment,occludedOpacity:Z=ka.occludedOpacity,altitude:U=ka.altitude}=e||{};this._anchor=f,this._color=y,this._scale=w,this._draggable=I,this._clickTolerance=M,this._rotation=L,this._rotationAlignment=N,this._pitchAlignment=V,this._occludedOpacity=Z,this._altitude=U,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),e&&e.element?(this._element=e.element,this._offset=i.P.convert(e&&e.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=i.P.convert(e&&e.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",nt=>{nt.preventDefault()}),this._element.addEventListener("mousedown",nt=>{nt.preventDefault()});const X=this._element.classList;for(const nt in fh)X.remove(`mapboxgl-marker-anchor-${nt}`);X.add(`mapboxgl-marker-anchor-${this._anchor}`);const Q=e&&e.className?e.className.trim().split(/\s+/):[];X.add(...Q),this._popup=null}_createDefaultMarker(){const e=Ri("div"),a=Ve("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},e);if(this._altitude===0){const f=Ve("radialGradient",{id:"shadowGradient"},Ve("defs",{},a));Ve("stop",{offset:"10%","stop-opacity":.4},f),Ve("stop",{offset:"100%","stop-opacity":.05},f),Ve("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},a)}return Ve("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},a),Ve("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},a),Ve("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},a),e}addTo(e){return e===this._map||(this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._updateMoving),e.on("moveend",this._update),e.on("remove",this._clearFadeTimer),e._addMarker(this),this.setDraggable(this._draggable),this._update(),e.on("click",this._onMapClick)),this}remove(){const e=this._map;return e&&(e.off("click",this._onMapClick),e.off("move",this._updateMoving),e.off("moveend",this._update),e.off("mousedown",this._addDragHandler),e.off("touchstart",this._addDragHandler),e.off("mouseup",this._onUp),e.off("touchend",this._onUp),e.off("mousemove",this._onMove),e.off("touchmove",this._onMove),e.off("remove",this._clearFadeTimer),e._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=i.aS.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(e){return e===this._altitude||(this._defaultMarker&&(this._altitude===0&&e!==0||this._altitude!==0&&e===0)&&(this._element=this._createDefaultMarker()),this._altitude=e||ka.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const y=Math.sqrt(Math.pow(13.5,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[y,-1*(38.1-13.5+y)],"bottom-right":[-y,-1*(38.1-13.5+y)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=e,e._marker=this,e._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(e){const a=e.code,f=e.charCode||e.keyCode;a!=="Space"&&a!=="Enter"&&f!==32&&f!==13||this.togglePopup()}_onMapClick(e){const a=e.originalEvent.target,f=this._element;this._popup&&(a===f||f.contains(a))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const e=this._popup;return e?(e.isOpen()?(e.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(e.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const e=this._map,a=this._pos;if(!e||!a)return!1;const f=e.unproject(a,this._altitude),y=e.getFreeCameraOptions();if(!y.position)return!1;const w=y.position.toLngLat();return w.distanceTo(f)<.9*w.distanceTo(this._lngLat)}_evaluateOpacity(){const e=this._map;if(!e)return;const a=this._pos;if(!a||a.x<0||a.x>e.transform.width||a.y<0||a.y>e.transform.height)return void this._clearFadeTimer();const f=e.unproject(a,this._altitude);let y;e._showingGlobe()&&i.f4(e.transform,this._lngLat)?y=0:(y=1-e._queryFogOpacity(f),e.transform._terrainEnabled()&&e.getTerrain()&&this._behindTerrain()&&(y*=this._occludedOpacity)),this._element.style.opacity=`${y}`,this._element.style.pointerEvents=y>0?"auto":"none",this._popup&&this._popup._setOpacity(y),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const e=this._pos;if(!e||!this._map)return;const a=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${e.x}px,${e.y}px)
            ${fh[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${a.x}px,${a.y}px)
        `}_calculateXYTransform(){const e=this._pos,a=this._map,f=this.getPitchAlignment();if(!a||!e||f!=="map")return"";if(!a._showingGlobe()){const L=a.getPitch();return L?`rotateX(${L}deg)`:""}const y=i.cW(i.f5(a.transform,this._lngLat)),w=e.sub(i.f6(a.transform)),I=Math.abs(w.x)+Math.abs(w.y);if(I===0)return"";const M=y/I;return`rotateX(${-w.y*M}deg) rotateY(${w.x*M}deg)`}_calculateZTransform(){const e=this._pos,a=this._map;if(!a||!e)return"";let f=0;const y=this.getRotationAlignment();if(y==="map")if(a._showingGlobe()){const w=a.project(new i.aS(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),I=a.project(new i.aS(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(w);f=i.cW(Math.atan2(I.y,I.x))-90}else f=-a.getBearing();else if(y==="horizon"){const w=i.ah(4,6,a.getZoom()),I=i.f6(a.transform);I.y+=w*a.transform.height;const M=e.sub(I),L=i.cW(Math.atan2(M.y,M.x));f=(L>90?L-270:L+90)*(1-w)}return f+=this._rotation,f?`rotateZ(${f}deg)`:""}_update(e){cancelAnimationFrame(this._updateFrameId);const a=this._map;a&&(a.transform.renderWorldCopies&&(this._lngLat=_c(this._lngLat,this._pos,a.transform)),this._pos=a.project(this._lngLat,this._altitude),e===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),a._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(a._showingGlobe()||a.getTerrain()||a.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(e){return this._offset=i.P.convert(e),this._update(),this}addClassName(e){return this._element.classList.add(e),this}removeClassName(e){return this._element.classList.remove(e),this}toggleClassName(e){return this._element.classList.toggle(e)}_onMove(e){const a=this._map;if(!a)return;const f=this._pointerdownPos,y=this._positionDelta;if(f&&y){if(!this._isDragging){const w=this._clickTolerance||a._clickTolerance;if(e.point.dist(f)<w)return;this._isDragging=!0}this._pos=e.point.sub(y),this._lngLat=a.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new i.z("dragstart"))),this.fire(new i.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const e=this._map;e&&(e.off("mousemove",this._onMove),e.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new i.z("dragend")),this._state="inactive"}_addDragHandler(e){const a=this._map,f=this._pos;a&&f&&this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(f),this._pointerdownPos=e.point,this._state="pending",a.on("mousemove",this._onMove),a.on("touchmove",this._onMove),a.once("mouseup",this._onUp),a.once("touchend",this._onUp))}setDraggable(e){this._draggable=!!e;const a=this._map;return a&&(e?(a.on("mousedown",this._addDragHandler),a.on("touchstart",this._addDragHandler)):(a.off("mousedown",this._addDragHandler),a.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||ka.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||ka.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e||ka.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(e){return this._occludedOpacity=e||ka.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const mh={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},g_={maxWidth:100,unit:"metric"},__={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},y_={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},Nm=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Vm(p=new i.P(0,0),e="bottom"){if(typeof p=="number"){const a=Math.round(Math.sqrt(.5*Math.pow(p,2)));switch(e){case"top":return new i.P(0,p);case"top-left":return new i.P(a,a);case"top-right":return new i.P(-a,a);case"bottom":return new i.P(0,-p);case"bottom-left":return new i.P(a,-a);case"bottom-right":return new i.P(-a,-a);case"left":return new i.P(p,0);case"right":return new i.P(-p,0)}return new i.P(0,0)}return p instanceof i.P||Array.isArray(p)?i.P.convert(p):i.P.convert(p[e]||[0,0])}return{version:Pe,supported:Or.supported,setRTLTextPlugin:i.fa,getRTLTextPluginStatus:i.f9,Map:class extends Jh{constructor(p){tr.mark(yi.create);const e=p;if((p=Object.assign({},Op,p)).minZoom!=null&&p.maxZoom!=null&&p.minZoom>p.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(p.minPitch!=null&&p.maxPitch!=null&&p.minPitch>p.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(p.minPitch!=null&&p.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(p.maxPitch!=null&&p.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(p.antialias&&i.f2(window)&&(p.antialias=!1,i.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Cc(p.minZoom,p.maxZoom,p.minPitch,p.maxPitch,p.renderWorldCopies,null,null),p),this._repaint=!!p.repaint,this._interactive=p.interactive,this._minTileCacheSize=p.minTileCacheSize,this._maxTileCacheSize=p.maxTileCacheSize,this._failIfMajorPerformanceCaveat=p.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=p.preserveDrawingBuffer,this._antialias=p.antialias,this._trackResize=p.trackResize,this._bearingSnap=p.bearingSnap,this._refreshExpiredTiles=p.refreshExpiredTiles,this._fadeDuration=p.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=p.crossSourceCollisions,this._collectResourceTiming=p.collectResourceTiming,this._language=this._parseLanguage(p.language),this._worldview=p.worldview,this._renderTaskQueue=new Bm,this._domRenderTaskQueue=new Bm,this._controls=[],this._markers=[],this._popups=[],this._mapId=i.b1(),this._locale=Object.assign({},m_,p.locale),this._clickTolerance=p.clickTolerance,this._cooperativeGestures=p.cooperativeGestures,this._performanceMetricsCollection=p.performanceMetricsCollection,this._tessellationStep=p.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=p.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Fp(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=p.scaleFactor,this._requestManager=new bh(p.transformRequest,p.accessToken,p.testMode),this._silenceAuthErrors=!!p.testMode,this._contextCreateOptions=p.contextCreateOptions?Object.assign({},p.contextCreateOptions):{},typeof p.container=="string"){const a=document.getElementById(p.container);if(!a)throw new Error(`Container '${p.container.toString()}' not found.`);this._container=a}else{if(!(p.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=p.container}if(this._container.childNodes.length>0&&i.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),p.maxBounds&&this.setMaxBounds(p.maxBounds),this._spriteFormat=p.spriteFormat,i.aX(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Ko),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new bf(this,p),this._localFontFamily=p.localFontFamily,this._localIdeographFontFamily=p.localIdeographFontFamily,(p.style||!p.testMode)&&this.setStyle(p.style||i.e.DEFAULT_STYLE,{config:p.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),p.projection&&this.setProjection(p.projection),p.hash&&(this._hash=new hs(typeof p.hash=="string"&&p.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){e.center==null&&e.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:p.center,zoom:p.zoom,bearing:p.bearing,pitch:p.pitch});const a=p.bounds;a&&(this.resize(),this.fitBounds(a,Object.assign({},p.fitBoundsOptions,{duration:0})))}this.resize(),p.attributionControl&&this.addControl(new Xd({customAttribution:p.customAttribution})),this._logoControl=new wf,this.addControl(this._logoControl,p.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()}),this.on("data",a=>{this._update(a.dataType==="style"),this.fire(new i.z(`${a.dataType}data`,a))}),this.on("dataloading",a=>{this.fire(new i.z(`${a.dataType}dataloading`,a))}),this._interactions=new Om(this)}_getMapId(){return this._mapId}addControl(p,e){if(e===void 0&&(e=p.getDefaultPosition?p.getDefaultPosition():"top-right"),!p||!p.onAdd)return this.fire(new i.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const a=p.onAdd(this);this._controls.push(p);const f=this._controlPositions[e];return e.indexOf("bottom")!==-1?f.insertBefore(a,f.firstChild):f.appendChild(a),this}removeControl(p){if(!p||!p.onRemove)return this.fire(new i.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const e=this._controls.indexOf(p);return e>-1&&this._controls.splice(e,1),p.onRemove(this),this}hasControl(p){return this._controls.indexOf(p)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(p){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const e=!this._moving;return e&&this.fire(new i.z("movestart",p)).fire(new i.z("move",p)),this.fire(new i.z("resize",p)),e&&this.fire(new i.z("moveend",p)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(p){return this.transform.setMaxBounds(i.aI.convert(p)),this._update()}setMinZoom(p){if((p=p??-2)>=-2&&p<=this.transform.maxZoom)return this.transform.minZoom=p,this._update(),this.getZoom()<p?this.setZoom(p):this.fire(new i.z("zoomstart")).fire(new i.z("zoom")).fire(new i.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(p){if((p=p??22)>=this.transform.minZoom)return this.transform.maxZoom=p,this._update(),this.getZoom()>p?this.setZoom(p):this.fire(new i.z("zoomstart")).fire(new i.z("zoom")).fire(new i.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(p){if((p=p??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(p>=0&&p<=this.transform.maxPitch)return this.transform.minPitch=p,this._update(),this.getPitch()<p?this.setPitch(p):this.fire(new i.z("pitchstart")).fire(new i.z("pitch")).fire(new i.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(p){if((p=p??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(p>=this.transform.minPitch)return this.transform.maxPitch=p,this._update(),this.getPitch()>p?this.setPitch(p):this.fire(new i.z("pitchstart")).fire(new i.z("pitch")).fire(new i.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(p){return this._scaleFactor=p,this.painter.scaleFactor=p,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(e=>e.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(p){return this.transform.renderWorldCopies=p,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(p){return p==="auto"?navigator.language:Array.isArray(p)?p.length===0?void 0:p.map(e=>e==="auto"?navigator.language:e):p}setLanguage(p){const e=this._parseLanguage(p);if(!this.style||e===this._language)return this;this._language=e,this.style.reloadSources();for(const a of this._controls)a._setLanguage&&a._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(p){return this.style&&p!==this._worldview?(this._worldview=p,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(p){return this._lazyInitEmptyStyle(),p?typeof p=="string"&&(p={name:p}):p=null,this._useExplicitProjection=!!p,this._prioritizeAndUpdateProjection(p,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const p=this.transform,e=p.projection.name;let a;e==="globe"&&p.zoom>=i.cK?(p.setMercatorFromTransition(),a=!0):e==="mercator"&&p.zoom<i.cK&&(p.setProjection({name:"globe"}),a=!0),a&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(p,e){return this._updateProjection(p||e||{name:"mercator"})}_updateProjection(p){let e;const a=this.transform.mercatorFromTransition;e=p.name==="globe"&&this.transform.zoom>=i.cK?this.transform.setMercatorFromTransition():this.transform.setProjection(p),this.style.applyProjectionUpdate();const f=this.transform.getProjection().name==="mercator"&&a!==this.transform.mercatorFromTransition;return(e||f)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(p,e){return this.transform.locationPoint3D(i.aS.convert(p),e)}unproject(p,e){return this.transform.pointLocation3D(i.P.convert(p),e)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(p,e,a){const f=y=>{let w=[];if(Array.isArray(e)){const I=e.filter(M=>this.getLayer(M));w=I.length?this.queryRenderedFeatures(y,{layers:I}):[]}else w=this.queryRenderedFeatures(y,{target:e});return w};if(p==="mouseenter"||p==="mouseover"){let y=!1;return{listener:a,targets:e,delegates:{mousemove:I=>{const M=f(I.point);M.length?y||(y=!0,a.call(this,new qn(p,this,I.originalEvent,{features:M}))):y=!1},mouseout:()=>{y=!1}}}}if(p==="mouseleave"||p==="mouseout"){let y=!1;return{listener:a,targets:e,delegates:{mousemove:M=>{f(M.point).length?y=!0:y&&(y=!1,a.call(this,new qn(p,this,M.originalEvent)))},mouseout:M=>{y&&(y=!1,a.call(this,new qn(p,this,M.originalEvent)))}}}}{const y=w=>{const I=f(w.point);I.length&&(w.features=I,a.call(this,w),delete w.features)};return{listener:a,targets:e,delegates:{[p]:y}}}}on(p,e,a){if(typeof e=="function"||a===void 0)return super.on(p,e);if(typeof e=="string"&&(e=[e]),!this._areTargetsValid(e))return this;const f=this._createDelegatedListener(p,e,a);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[p]=this._delegatedListeners[p]||[],this._delegatedListeners[p].push(f);for(const y in f.delegates)this.on(y,f.delegates[y]);return this}once(p,e,a){if(typeof e=="function"||a===void 0)return super.once(p,e);if(typeof e=="string"&&(e=[e]),!this._areTargetsValid(e))return this;const f=this._createDelegatedListener(p,e,a);for(const y in f.delegates)this.once(y,f.delegates[y]);return this}off(p,e,a){if(typeof e=="function"||a===void 0)return super.off(p,e);if(typeof e=="string"&&(e=[e]),!this._areTargetsValid(e))return this;const f=this._delegatedListeners?this._delegatedListeners[p]:void 0;return f&&(y=>{for(let w=0;w<y.length;w++){const I=y[w];if(I.listener===a&&Bp(I.targets,e)){for(const M in I.delegates)this.off(M,I.delegates[M]);return y.splice(w,1),this}}})(f),this}queryRenderedFeatures(p,e){if(!this.style)return[];if(p===void 0||p instanceof i.P||Array.isArray(p)||e!==void 0||(e=p,p=void 0),p=p||[[0,0],[this.transform.width,this.transform.height]],!e){const w=this.style.queryRenderedFeatures(p,void 0,this.transform),I=this.style.queryRenderedFeatureset(p,void 0,this.transform);return w.concat(I)}let a=!0;if(e.target&&(a=this._isTargetValid(e.target),a&&!e.layers))return this.style.queryRenderedFeatureset(p,e,this.transform);let f=!0;if(e.layers&&Array.isArray(e.layers)){for(const w of e.layers)if(!this._isValidId(w)){f=!1;break}if(f&&!e.target)return this.style.queryRenderedFeatures(p,e,this.transform)}let y=[];return f&&(y=y.concat(this.style.queryRenderedFeatures(p,e,this.transform))),a&&(y=y.concat(this.style.queryRenderedFeatureset(p,e,this.transform))),y}querySourceFeatures(p,e){return!p||typeof p=="string"&&!this._isValidId(p)?[]:this.style.querySourceFeatures(p,e)}queryRasterValue(p,e,a){return this._isValidId(p)?this.style.queryRasterValue(p,e,a):Promise.resolve(null)}isPointOnSurface(p){const{name:e}=this.transform.projection;return e!=="globe"&&e!=="mercator"&&i.w(`${e} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(i.P.convert(p))}addInteraction(p,e){return this._interactions.add(p,e),this}removeInteraction(p){return this._interactions.remove(p),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(p){return this._cooperativeGestures=p,this}setStyle(p,e){return e=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},e),this.style&&p&&e.diff!==!1&&e.localFontFamily===this._localFontFamily&&e.localIdeographFontFamily===this._localIdeographFontFamily&&!e.config?(this.style._diffStyle(p,(a,f)=>{if(a){const y=typeof a=="string"?a:a instanceof Error?a.message:a.error;i.w(`Unable to perform style diff: ${y}. Rebuilding the style from scratch.`),this._updateStyle(p,e)}else f&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=e.localIdeographFontFamily,this._localFontFamily=e.localFontFamily,this._updateStyle(p,e))}_getUIString(p){const e=this._locale[p];if(e==null)throw new Error(`Missing UI string '${p}'`);return e}_updateStyle(p,e){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),p){const a=Object.assign({},e);e&&e.config&&(a.initialConfig=e.config,delete a.config),this.style=new xa(this,a).load(p),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new xa(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(i.w("There is no style added to the map."),!1)}_isValidId(p){return p==null?(this.fire(new i.y(new Error("IDs can't be empty."))),!1):!i.dq(p)||(this.fire(new i.y(new Error(`IDs can't contain special symbols: "${p}".`))),!1)}_isTargetValid(p){return"featuresetId"in p?this._isValidId("importId"in p?p.importId:p.featuresetId):"layerId"in p&&this._isValidId(p.layerId)}_areTargetsValid(p){if(Array.isArray(p)){for(const e of p)if(!this._isValidId(e))return!1;return!0}return this._isTargetValid(p)}addSource(p,e){return this._isValidId(p)?(this._lazyInitEmptyStyle(),this.style.addSource(p,e),this._update(!0)):this}isSourceLoaded(p){return!!this._isValidId(p)&&!!this.style&&this.style._isSourceCacheLoaded(p)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(p,e,a){this._lazyInitEmptyStyle(),this.style.addSourceType(p,e,a)}removeSource(p){return this._isValidId(p)?(this.style.removeSource(p),this._updateTerrain(),this._update(!0)):this}getSource(p){return this._isValidId(p)?this.style.getOwnSource(p):null}addImage(p,e,{pixelRatio:a=1,sdf:f=!1,stretchX:y,stretchY:w,content:I}={}){this._lazyInitEmptyStyle();const M=i.I.from(p);if(e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap){const{width:L,height:N,data:V}=i.o.getImageData(e);this.style.addImage(M,{data:new i.q({width:L,height:N},V),pixelRatio:a,stretchX:y,stretchY:w,content:I,sdf:f,version:0,usvg:!1})}else if(e.width===void 0||e.height===void 0)this.fire(new i.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:L,height:N}=e,V=e;this.style.addImage(M,{data:new i.q({width:L,height:N},new Uint8Array(V.data)),pixelRatio:a,stretchX:y,stretchY:w,content:I,sdf:f,usvg:!1,version:0,userImage:V}),V.onAdd&&V.onAdd(this,p)}}updateImage(p,e){this._lazyInitEmptyStyle();const a=i.I.from(p),f=this.style.getImage(a);if(!f)return void this.fire(new i.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const y=e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap?i.o.getImageData(e):e,{width:w,height:I,data:M}=y;if(w===void 0||I===void 0)return void this.fire(new i.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(w!==(f.usvg?f.icon.usvg_tree.width:f.data.width)||I!==(f.usvg?f.icon.usvg_tree.height:f.data.height))return void this.fire(new i.y(new Error(`The width and height of the updated image (${w}, ${I})
                must be that same as the previous version of the image
                (${f.data.width}, ${f.data.height})`)));const L=!(e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap);let N=!1;f.usvg?(f.data=new i.q({width:w,height:I},new Uint8Array(M)),f.usvg=!1,f.icon=void 0,N=!0):f.data.replace(M,L),this.style.updateImage(a,f,N)}hasImage(p){return p?!!this.style&&!!this.style.getImage(i.I.from(p)):(this.fire(new i.y(new Error("Missing required image id"))),!1)}removeImage(p){this.style.removeImage(i.I.from(p))}loadImage(p,e){i.n(this._requestManager.transformRequest(p,i.R.Image),(a,f)=>{e(a,f instanceof HTMLImageElement?i.o.getImageData(f):f)})}listImages(){return this.style.listImages().map(p=>p.name)}addModel(p,e){this._lazyInitEmptyStyle(),this.style.addModel(p,e)}hasModel(p){return p?this.style.hasModel(p):(this.fire(new i.y(new Error("Missing required model id"))),!1)}removeModel(p){this.style.removeModel(p)}listModels(){return this.style.listModels()}addLayer(p,e){return this._isValidId(p.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(p,e),this._update(!0)):this}getSlot(p){const e=this.getLayer(p);return e&&e.slot||null}setSlot(p,e){return this.style.setSlot(p,e),this.style.mergeLayers(),this._update(!0)}addImport(p,e){return this.style.addImport(p,e).catch(a=>this.fire(new i.y(new Error("Failed to add import",a)))),this}updateImport(p,e){return typeof e!="string"&&e.id!==p?(this.removeImport(p),this.addImport(e)):(this.style.updateImport(p,e),this._update(!0))}removeImport(p){return this.style.removeImport(p),this}moveImport(p,e){return this.style.moveImport(p,e),this._update(!0)}moveLayer(p,e){return this._isValidId(p)?(this.style.moveLayer(p,e),this._update(!0)):this}removeLayer(p){return this._isValidId(p)?(this.style.removeLayer(p),this._update(!0)):this}getLayer(p){if(!this._isValidId(p))return null;const e=this.style.getOwnLayer(p);return e?e.type==="custom"?e.implementation:e.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(p,e,a){return this._isValidId(p)?(this.style.setLayerZoomRange(p,e,a),this._update(!0)):this}setFilter(p,e,a={}){return this._isValidId(p)?(this.style.setFilter(p,e,a),this._update(!0)):this}getFilter(p){return this._isValidId(p)?this.style.getFilter(p):null}setPaintProperty(p,e,a,f={}){return this._isValidId(p)?(this.style.setPaintProperty(p,e,a,f),this._update(!0)):this}getPaintProperty(p,e){return this._isValidId(p)?this.style.getPaintProperty(p,e):null}setLayoutProperty(p,e,a,f={}){return this._isValidId(p)?(this.style.setLayoutProperty(p,e,a,f),this._update(!0)):this}getLayoutProperty(p,e){return this._isValidId(p)?this.style.getLayoutProperty(p,e):null}setLayerProperty(p,e,a,f={}){return this._isValidId(p)?(this.style.setLayerProperty(p,e,a,f),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(p){return this.style.setGlyphsUrl(p),this._update(!0)}getSchema(p){return this.style.getSchema(p)}setSchema(p,e){return this.style.setSchema(p,e),this._update(!0)}getConfig(p){return this.style.getConfig(p)}setConfig(p,e){return this.style.setConfig(p,e),this._update(!0)}getConfigProperty(p,e){return this.style.getConfigProperty(p,e)}setConfigProperty(p,e,a){return this.style.setConfigProperty(p,e,a),this._update(!0)}getFeaturesetDescriptors(p){return this.style.getFeaturesetDescriptors(p)}setLights(p){if(this._lazyInitEmptyStyle(),p&&p.length===1&&p[0].type==="flat"){const e=p[0];e.properties?this.style.setFlatLight(e.properties,e.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(p),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const p=this.style.getLights()||[];return p.length===0&&p.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),p}setLight(p,e={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:p}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(p){return this._lazyInitEmptyStyle(),!p&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(p),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(p){return this._lazyInitEmptyStyle(),this.style.setFog(p),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(p){return this._lazyInitEmptyStyle(),this.style.setSnow(p),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(p){return this._lazyInitEmptyStyle(),this.style.setRain(p),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(p){return this._lazyInitEmptyStyle(),this.style.setColorTheme(p),this._update(!0)}setImportColorTheme(p,e){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(p,e),this._update(!0)}setCamera(p){return this.style.setCamera(p),this._triggerCameraUpdate(p)}_triggerCameraUpdate(p){return this._update(this.transform.setOrthographicProjectionAtLowPitch(p["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(p){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(i.aS.convert(p),this.transform):0}setFeatureState(p,e){return p.source&&!this._isValidId(p.source)?this:(this.style.setFeatureState(p,e),this._update())}removeFeatureState(p,e){return p.source&&!this._isValidId(p.source)?this:(this.style.removeFeatureState(p,e),this._update())}getFeatureState(p){return p.source&&!this._isValidId(p.source)?null:this.style.getFeatureState(p)}_selectIndoorFloor(p){this.indoor.selectFloor(p)}_setIndoorActiveFloorsVisibility(p){this.indoor.setActiveFloorsVisibility(p)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Tf),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const p=this._container.getBoundingClientRect().width||400,e=this._container.getBoundingClientRect().height||300;let a,f,y,w=this._container;for(;w&&(!f||!y);){const I=window.getComputedStyle(w).transform;I&&I!=="none"&&(a=I.match(/matrix.*\((.+)\)/)[1].split(", "),a[0]&&a[0]!=="0"&&a[0]!=="1"&&(f=a[0]),a[3]&&a[3]!=="0"&&a[3]!=="1"&&(y=a[3])),w=w.parentElement}this._containerWidth=f?Math.abs(p/f):p,this._containerHeight=y?Math.abs(e/y):e}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&i.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new aa(this.style),this.on("load",()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}),this.on("idle",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})}))}_setupContainer(){const p=this._container;p.classList.add("mapboxgl-map"),(this._missingCSSCanary=Ri("div","mapboxgl-canary",p)).style.visibility="hidden",this._detectMissingCSS();const e=this._canvasContainer=Ri("div","mapboxgl-canvas-container",p);this._canvas=Ri("canvas","mapboxgl-canvas",e),this._interactive&&(e.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const a=this._controlContainer=Ri("div","mapboxgl-control-container",p),f=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(y=>{f[y]=Ri("div",`mapboxgl-ctrl-${y}`,a)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(p,e){const a=i.o.devicePixelRatio||1;this._canvas.width=a*Math.ceil(p),this._canvas.height=a*Math.ceil(e),this._canvas.style.width=`${p}px`,this._canvas.style.height=`${e}px`}_addMarker(p){this._markers.push(p)}_removeMarker(p){const e=this._markers.indexOf(p);e!==-1&&this._markers.splice(e,1)}_addPopup(p){this._popups.push(p)}_removePopup(p){const e=this._popups.indexOf(p);e!==-1&&this._popups.splice(e,1)}_setupPainter(){const p=Object.assign({},Or.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),e=this._canvas.getContext("webgl2",p);e?(vo(e,!0),this.painter=new Po(e,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",a=>{a.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),i.k.testSupport(e)):this.fire(new i.y(new Error("Failed to initialize WebGL")))}_contextLost(p){p.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new i.z("webglcontextlost",{originalEvent:p}))}_contextRestored(p){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new i.z("webglcontextrestored",{originalEvent:p}))}_onMapScroll(p){if(p.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(p){return this.style?(this._styleDirty=this._styleDirty||p,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(p){return this._update(),this._renderTaskQueue.add(p)}_cancelRenderFrame(p){this._renderTaskQueue.remove(p)}_requestDomTask(p){!this.loaded()||this.loaded()&&!this.isMoving()?p():this._domRenderTaskQueue.add(p)}_render(p){let e;this.fire(new i.z("renderstart")),++this._frameId;const a=this.painter.context.extTimerQuery,f=i.o.now(),y=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(e=y.createQuery(),y.beginQuery(a.TIME_ELAPSED_EXT,e)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(p),this._domRenderTaskQueue.run(p),this._removed)return;this._updateProjectionTransition();const w=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const N=this.transform.zoom,V=this.transform.pitch,Z=i.o.now(),U=new i.ac(N,{now:Z,fadeDuration:w,pitch:V,transition:this.style.transition,worldview:this._worldview});this.style.update(U)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let I=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),I=this._updateAverageElevation(f),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):I=this._updateAverageElevation(f);const M=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,w,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),M&&(this._placementDirty=M.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:w,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new i.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,tr.mark(yi.load),this.fire(new i.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),e){const N=i.o.now()-f;y.endQuery(a.TIME_ELAPSED_EXT),setTimeout(()=>{const V=y.getQueryParameter(e,y.QUERY_RESULT)/1e6;y.deleteQuery(e),this.fire(new i.z("gpu-timing-frame",{cpuTime:N,gpuTime:V}))},50)}if(this.listens("gpu-timing-layer")){const N=this.painter.collectGpuTimers();setTimeout(()=>{const V=this.painter.queryGpuTimers(N);this.fire(new i.z("gpu-timing-layer",{layerTimes:V}))},50)}if(this.listens("gpu-timing-deferred-render")){const N=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const V=this.painter.queryGpuTimeDeferredRender(N);this.fire(new i.z("gpu-timing-deferred-render",{gpuTime:V}))},50)}const L=this._sourcesDirty||this._styleDirty||this._placementDirty||I;if(L||this._repaint)this.triggerRepaint();else{const N=this.idle();if(N&&(I=this._updateAverageElevation(f,!0)),I)this.triggerRepaint();else if(this._triggerFrame(!1),N&&(this.fire(new i.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const V=this._calculateSpeedIndex();this.fire(new i.z("speedindexcompleted",{speedIndex:V})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||L||(this._fullyLoaded=!0,tr.mark(yi.fullLoad),this._performanceMetricsCollection&&ho(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(p){for(const e of this._markers)p&&!this.getRenderWorldCopies()&&(e._lngLat=e._lngLat.wrap()),e._update();for(const e of this._popups)!p||this.getRenderWorldCopies()||e._trackPointer||(e._lngLat=e._lngLat.wrap()),e._update()}_updateAverageElevation(p,e=!1){const a=y=>(this.transform.averageElevation=y,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&a(0);const f=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(f||(e||p-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(p)){const y=this.transform.averageElevation;let w=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(w)?w=0:this._averageElevationLastSampledAt=p;const I=Math.abs(y-w);if(I>1){if(this._isInitialLoad||f)return this._averageElevation.jumpTo(w),a(w);this._averageElevation.easeTo(w,p,300)}else if(I>1e-4)return this._averageElevation.jumpTo(w),a(w)}return!!this._averageElevation.isEasing(p)&&a(this._averageElevation.getValue(p))}_authenticate(){ma(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,p=>{if(p&&(p.message===Zr||p.status===401)){const e=this.painter.context.gl;vo(e,!1),this._logoControl instanceof wf&&this._logoControl._updateLogo(),e&&e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new i.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),Ks(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Qs(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&Wo(this._requestManager._customAccessToken)}_updateTerrain(){const p=this._isDragging();this.painter.updateTerrain(this.style,p)}_calculateSpeedIndex(){const p=this.painter.canvasCopy(),e=this.painter.getCanvasCopiesAndTimestamps();e.timeStamps.push(performance.now());const a=this.painter.context.gl,f=a.createFramebuffer();function y(w){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,w,0);const I=new Uint8Array(a.drawingBufferWidth*a.drawingBufferHeight*4);return a.readPixels(0,0,a.drawingBufferWidth,a.drawingBufferHeight,a.RGBA,a.UNSIGNED_BYTE,I),I}return a.bindFramebuffer(a.FRAMEBUFFER,f),this._canvasPixelComparison(y(p),e.canvasCopies.map(y),e.timeStamps)}_canvasPixelComparison(p,e,a){let f=a[1]-a[0];const y=p.length/4;for(let w=0;w<e.length;w++){const I=e[w];let M=0;for(let L=0;L<I.length;L+=4)I[L]===p[L]&&I[L+1]===p[L+1]&&I[L+2]===p[L+2]&&I[L+3]===p[L+3]&&(M+=1);f+=(a[w+2]-a[w+1])*(1-M/y)}return f}remove(){this._hash&&this._hash.remove();for(const e of this._controls)e.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const p=this.painter.context.gl.getExtension("WEBGL_lose_context");p&&p.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Kn.delete(this.painter.context.gl),qo.remove(),Jn.remove(),this._removed=!0,this.fire(new i.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(p){this._renderNextFrame=this._renderNextFrame||p,this.style&&!this._frame&&(this._frame=i.o.frame(e=>{const a=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,a&&this._render(e)}))}_preloadTiles(p){const e=this.style?this.style.getSourceCaches():[];return i.bv(e,(a,f)=>a._preloadTiles(p,f),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(p){this._trackResize&&this.resize({originalEvent:p})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(p){this._showTileBoundaries!==p&&(this._showTileBoundaries=p,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(p){this._showParseStatus!==p&&(this._showParseStatus=p,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(p){this._showTerrainWireframe!==p&&(this._showTerrainWireframe=p,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(p){this._showLayers2DWireframe!==p&&(this._showLayers2DWireframe=p,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(p){this._showLayers3DWireframe!==p&&(this._showLayers3DWireframe=p,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(p){this._speedIndexTiming!==p&&(this._speedIndexTiming=p,this._update())}get showPadding(){return!!this._showPadding}set showPadding(p){this._showPadding!==p&&(this._showPadding=p,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(p){this._showCollisionBoxes!==p&&(this._showCollisionBoxes=p,this._tp.refreshUI(),p?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(p){this._showOverdrawInspector!==p&&(this._showOverdrawInspector=p,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(p){this._repaint!==p&&(this._repaint=p,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(p){this._vertices=p,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(p){this._showTileAABBs!==p&&(this._showTileAABBs=p,this._tp.refreshUI(),p&&this._update())}_setCacheLimits(p,e){i.f3(p,e)}get version(){return Pe}},NavigationControl:class{constructor(p={}){this.options=Object.assign({},Sf,p),this._container=Ri("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",e=>e.preventDefault()),this.options.showZoom&&(i.aX(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",e=>{this._map&&this._map.zoomIn({},{originalEvent:e})}),Ri("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",e=>{this._map&&this._map.zoomOut({},{originalEvent:e})}),Ri("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(i.aX(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",e=>{const a=this._map;a&&(this.options.visualizePitch?a.resetNorthPitch({},{originalEvent:e}):a.resetNorth({},{originalEvent:e}))}),this._compassIcon=Ri("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const p=this._map;if(!p)return;const e=p.getZoom(),a=e===p.getMaxZoom(),f=e===p.getMinZoom();this._zoomInButton.disabled=a,this._zoomOutButton.disabled=f,this._zoomInButton.setAttribute("aria-disabled",a.toString()),this._zoomOutButton.setAttribute("aria-disabled",f.toString())}_rotateCompassArrow(){const p=this._map;if(!p)return;const e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(p.transform.pitch*(Math.PI/180)),.5)}) rotateX(${p.transform.pitch}deg) rotateZ(${p.transform.angle*(180/Math.PI)}deg)`:`rotate(${p.transform.angle*(180/Math.PI)}deg)`;p._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=e)})}onAdd(p){return this._map=p,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),p.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&p.on("pitch",this._rotateCompassArrow),p.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new ph(p,this._compass,this.options.visualizePitch)),this._container}onRemove(){const p=this._map;p&&(this._container.remove(),this.options.showZoom&&p.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&p.off("pitch",this._rotateCompassArrow),p.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(p,e){const a=Ri("button",p,this._container);return a.type="button",a.addEventListener("click",e),a}_setButtonTitle(p,e){if(!this._map)return;const a=this._map._getUIString(`NavigationControl.${e}`);p.setAttribute("aria-label",a),p.firstElementChild&&p.firstElementChild.setAttribute("title",a)}},GeolocateControl:class extends i.E{constructor(p={}){super();const e=navigator.geolocation;this.options=Object.assign({geolocation:e},mh,p),i.aX(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Mo(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(p){return this._map=p,this._container=Ri("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(p){const e=(a=!!this.options.geolocation)=>{this._supportsGeolocation=a,p(a)};this._supportsGeolocation!==void 0?p(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(a=>e(a.state!=="denied")).catch(()=>e()):e()}_isOutOfMapMaxBounds(p){const e=this._map.getMaxBounds(),a=p.coords;return!!e&&(a.longitude<e.getWest()||a.longitude>e.getEast()||a.latitude<e.getSouth()||a.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(p){if(this._map){if(this._isOutOfMapMaxBounds(p))return this._setErrorState(),this.fire(new i.z("outofmaxbounds",p)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=p,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(p),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(p),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.z("geolocate",Object.assign({coords:p.coords,timestamp:p.timestamp},p.toJSON?{toJSON:p.toJSON.bind(p)}:{}))),this._finish()}}_updateCamera(p){const e=new i.aS(p.coords.longitude,p.coords.latitude),a=p.coords.accuracy,f=this._map.getBearing(),y=Object.assign({bearing:f},this.options.fitBoundsOptions);this._map.fitBounds(e.toBounds(a),y,{geolocateSource:!0})}_updateMarker(p){if(p){const e=new i.aS(p.coords.longitude,p.coords.latitude);this._accuracyCircleMarker.setLngLat(e).addTo(this._map),this._userLocationDotMarker.setLngLat(e).addTo(this._map),this._accuracy=p.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const p=this._map.transform,e=i.ce(1,p._center.lat)*p.worldSize,a=Math.ceil(2*this._accuracy*e);this._circleElement.style.width=`${a}px`,this._circleElement.style.height=`${a}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(p){if(this._map){if(this.options.trackUserLocation)if(p.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(p.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.z("error",p)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(p){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",e=>e.preventDefault()),this._geolocateButton=Ri("button","mapboxgl-ctrl-geolocate",this._container),Ri("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",p===!1){i.w("Geolocation support is not available so the GeolocateControl will be disabled.");const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}else{const e=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Ri("div","mapboxgl-user-location"),this._dotElement.appendChild(Ri("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Ri("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Mu({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Ri("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Mu({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",e=>{e.geolocateSource||this._watchState!=="ACTIVE_LOCK"||e.originalEvent&&e.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new i.z("trackuserlocationend")))})}}_onDeviceOrientation(p){this._userLocationDotMarker&&(p.webkitCompassHeading?this._heading=p.webkitCompassHeading:p.absolute===!0&&(this._heading=-1*p.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return i.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new i.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new i.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new i.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let p;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(p={maximumAge:6e5,timeout:0},this._noTimeout=!0):(p=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,p),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const p=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(e=>{e==="granted"&&p()}).catch(console.error):p()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Xd,ScaleControl:class{constructor(p={}){this.options=Object.assign({},g_,p),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),i.aX(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const p=this.options.maxWidth||100,e=this._map,a=e._containerHeight/2,f=e._containerWidth/2-p/2,y=e.unproject([f,a]),w=e.unproject([f+p,a]),I=y.distanceTo(w);if(this.options.unit==="imperial"){const M=3.2808*I;M>5280?this._setScale(p,M/5280,"mile"):this._setScale(p,M,"foot")}else this.options.unit==="nautical"?this._setScale(p,I/1852,"nautical-mile"):I>=1e3?this._setScale(p,I/1e3,"kilometer"):this._setScale(p,I,"meter")}_setScale(p,e,a){this._map._requestDomTask(()=>{const f=function(w){const I=Math.pow(10,`${Math.floor(w)}`.length-1);let M=w/I;return M=M>=10?10:M>=5?5:M>=3?3:M>=2?2:M>=1?1:function(L){const N=Math.pow(10,Math.ceil(-Math.log(L)/Math.LN10));return Math.round(L*N)/N}(M),I*M}(e),y=f/e;this._container.innerHTML=this._isNumberFormatSupported&&a!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:a}).format(f):`${f}&nbsp;${__[a]}`,this._container.style.width=p*y+"px"})}onAdd(p){return this._map=p,this._language=p.getLanguage(),this._container=Ri("div","mapboxgl-ctrl mapboxgl-ctrl-scale",p.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(p){this._language=p,this._update()}setUnit(p){this.options.unit=p,this._update()}},FullscreenControl:class{constructor(p={}){this._fullscreen=!1,p&&p.container&&(p.container instanceof HTMLElement?this._container=p.container:i.w("Full screen control 'container' must be a DOM element.")),i.aX(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(p){return this._map=p,this._container||(this._container=this._map.getContainer()),this._controlContainer=Ri("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",i.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const p=this._fullscreenButton=Ri("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Ri("span","mapboxgl-ctrl-icon",p).setAttribute("aria-hidden","true"),p.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const p=this._getTitle();this._fullscreenButton.setAttribute("aria-label",p),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",p)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Tf,Popup:class extends i.E{constructor(p){super(),this.options=Object.assign(Object.create(y_),p),this._altitude=this.options.altitude,i.aX(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(p&&p.className?p.className.trim().split(/\s+/):[])}addTo(p){return this._map&&this.remove(),this._map=p,this.options.closeOnClick&&p.on("preclick",this._onClose),this.options.closeOnMove&&p.on("move",this._onClose),p.on("remove",this.remove),this._update(),p._addPopup(this),this._focusFirstElement(),this._trackPointer?(p.on("mousemove",this._onMouseEvent),p.on("mouseup",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")):p.on("move",this._update),this.fire(new i.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const p=this._map;return p&&(p.off("move",this._update),p.off("move",this._onClose),p.off("preclick",this._onClose),p.off("click",this._onClose),p.off("remove",this.remove),p.off("mousemove",this._onMouseEvent),p.off("mouseup",this._onMouseEvent),p.off("drag",this._onMouseEvent),p._canvasContainer&&p._canvasContainer.classList.remove("mapboxgl-track-pointer"),p._removePopup(this),this._map=void 0),this.fire(new i.z("close")),this}getLngLat(){return this._lngLat}setLngLat(p){this._lngLat=i.aS.convert(p),this._pos=null,this._trackPointer=!1,this._update();const e=this._map;return e&&(e.on("move",this._update),e.off("mousemove",this._onMouseEvent),e._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(p){return this._altitude=p,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const p=this._map;return p&&(p.off("move",this._update),p.on("mousemove",this._onMouseEvent),p.on("drag",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(p){return this.setDOMContent(document.createTextNode(p))}setHTML(p){const e=document.createDocumentFragment(),a=document.createElement("body");let f;for(a.innerHTML=p;f=a.firstChild,f;)e.appendChild(f);return this.setDOMContent(e)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(p){return this.options.maxWidth=p,this._update(),this}setDOMContent(p){let e=this._content;if(e)for(;e.hasChildNodes();)e.firstChild&&e.removeChild(e.firstChild);else e=this._content=Ri("div","mapboxgl-popup-content",this._container||void 0);if(e.appendChild(p),this.options.closeButton){const a=this._closeButton=Ri("button","mapboxgl-popup-close-button",e);a.type="button",a.setAttribute("aria-label","Close popup"),a.innerHTML='<span aria-hidden="true">&#215;</span>',a.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(p){return this._classList.add(p),this._updateClassList(),this}removeClassName(p){return this._classList.delete(p),this._updateClassList(),this}setOffset(p){return this.options.offset=p,this._update(),this}toggleClassName(p){let e;return this._classList.delete(p)?e=!1:(this._classList.add(p),e=!0),this._updateClassList(),e}_onMouseEvent(p){this._update(p.point)}_getAnchor(p){if(this.options.anchor)return this.options.anchor;const e=this._map,a=this._container,f=this._pos;if(!e||!a||!f)return"bottom";const y=a.offsetWidth,w=a.offsetHeight,I=f.x<y/2,M=f.x>e.transform.width-y/2;if(f.y+p<w)return I?"top-left":M?"top-right":"top";if(f.y>e.transform.height-w){if(I)return"bottom-left";if(M)return"bottom-right"}return I?"left":M?"right":"bottom"}_updateClassList(){const p=this._container;if(!p)return;const e=[...this._classList];e.push("mapboxgl-popup"),this._anchor&&e.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&e.push("mapboxgl-popup-track-pointer"),p.className=e.join(" ")}_update(p){const e=this._map,a=this._content;if(!e||!this._lngLat&&!this._trackPointer||!a)return;let f=this._container;if(f||(f=this._container=Ri("div","mapboxgl-popup",e.getContainer()),this._tip=Ri("div","mapboxgl-popup-tip",f),f.appendChild(a)),this.options.maxWidth&&f.style.maxWidth!==this.options.maxWidth&&(f.style.maxWidth=this.options.maxWidth),e.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=_c(this._lngLat,this._pos,e.transform)),!this._trackPointer||p){const y=this._pos=this._trackPointer&&p instanceof i.P?p:e.project(this._lngLat,this._altitude),w=Vm(this.options.offset),I=this._anchor=this._getAnchor(w.y),M=Vm(this.options.offset,I),L=y.add(M).round();e._requestDomTask(()=>{this._container&&I&&(this._container.style.transform=`${fh[I]} translate(${L.x}px,${L.y}px)`)})}if(!this._marker&&e._showingGlobe()){const y=i.f4(e.transform,this._lngLat)?0:1;this._setOpacity(y)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const p=this._container.querySelector(Nm);p&&p.focus()}_onClose(){this.remove()}_setOpacity(p){this._container&&(this._container.style.opacity=`${p}`),this._content&&(this._content.style.pointerEvents=p?"auto":"none")}},Marker:Mu,Style:xa,LngLat:i.aS,LngLatBounds:i.aI,Point:i.P,MercatorCoordinate:i.ae,FreeCameraOptions:hc,Evented:i.E,config:i.e,prewarm:i.f8,clearPrewarmedResources:i.f7,get accessToken(){return i.e.ACCESS_TOKEN},set accessToken(p){i.e.ACCESS_TOKEN=p},get baseApiUrl(){return i.e.API_URL},set baseApiUrl(p){i.e.API_URL=p},get workerCount(){return i.fh.workerCount},set workerCount(p){i.fh.workerCount=p},get maxParallelImageRequests(){return i.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(p){i.e.MAX_PARALLEL_IMAGE_REQUESTS=p},clearStorage(p){i.fg(p)},get workerUrl(){return i.ff.workerUrl},set workerUrl(p){i.ff.workerUrl=p},get workerClass(){return i.ff.workerClass},set workerClass(p){i.ff.workerClass=p},get workerParams(){return i.ff.workerParams},set workerParams(p){i.ff.workerParams=p},get dracoUrl(){return i.fe()},set dracoUrl(p){i.fd(p)},get meshoptUrl(){return i.fc()},set meshoptUrl(p){i.fb(p)},setNow:i.o.setNow,restoreNow:i.o.restoreNow}});var it=Dt;return it})})(Ib);var OT=Ib.exports;const Ab=wb(OT);function NT(){const $t=localStorage.getItem("mapProvider"),wt=localStorage.getItem("mapboxAccessToken");return{provider:$t||"maplibre",mapboxAccessToken:wt||void 0}}function db($t){localStorage.setItem("mapProvider",$t.provider),$t.mapboxAccessToken?localStorage.setItem("mapboxAccessToken",$t.mapboxAccessToken):localStorage.removeItem("mapboxAccessToken"),console.log(":",$t.provider)}const VT=$t=>{const wt=$t.split(`
`).filter(Dt=>Dt.trim()),vt=wt[0].split(",").map(Dt=>Dt.trim()),Lt=[];for(let Dt=1;Dt<wt.length;Dt++){const Ft=wt[Dt].split(",").map(it=>it.trim());if(Ft.length>=3){const it={x:parseFloat(Ft[0]),y:parseFloat(Ft[1]),z:parseFloat(Ft[2]),elevation:parseFloat(Ft[3]||Ft[2]),type:Ft[4]||"point",description:Ft[5]||"",properties:{}};if(vt.length>6)for(let i=6;i<vt.length&&i<Ft.length;i++)it.properties[vt[i]]=Ft[i];Lt.push(it)}}return Lt},Kx=$t=>({id:$t.id,name:$t.name,type:$t.type==="flight"?"waypoint":"object",source:$t.source,position:{longitude:$t.longitude,latitude:$t.latitude,altitude:$t.altitude},properties:$t.properties}),H0=$t=>({id:$t.id,name:$t.name,longitude:$t.position.longitude,latitude:$t.position.latitude,altitude:$t.position.altitude,type:$t.type==="waypoint"?"flight":"unknown",source:$t.source,properties:$t.properties}),Pb=$t=>{if($t.length<2)return 0;let wt=0;for(let vt=1;vt<$t.length;vt++){const Lt=$t[vt-1].position,Dt=$t[vt].position,Ft=6371e3,it=Lt.latitude*Math.PI/180,i=Dt.latitude*Math.PI/180,Pe=(Dt.latitude-Lt.latitude)*Math.PI/180,yi=(Dt.longitude-Lt.longitude)*Math.PI/180,tr=Math.sin(Pe/2)*Math.sin(Pe/2)+Math.cos(it)*Math.cos(i)*Math.sin(yi/2)*Math.sin(yi/2),vn=2*Math.atan2(Math.sqrt(tr),Math.sqrt(1-tr)),on=Ft*vn,Br=Dt.altitude-Lt.altitude,Or=Math.sqrt(on*on+Br*Br);wt+=Or}return wt},UT=($t,wt=10)=>{Pb($t);let vt=0;for(let Lt=1;Lt<$t.length;Lt++){const Dt=$t[Lt].flight?.speed||wt,Ft=$t[Lt-1].position,it=$t[Lt].position,i=6371e3,Pe=Ft.latitude*Math.PI/180,yi=it.latitude*Math.PI/180,tr=(it.latitude-Ft.latitude)*Math.PI/180,vn=(it.longitude-Ft.longitude)*Math.PI/180,on=Math.sin(tr/2)*Math.sin(tr/2)+Math.cos(Pe)*Math.cos(yi)*Math.sin(vn/2)*Math.sin(vn/2),Br=2*Math.atan2(Math.sqrt(on),Math.sqrt(1-on)),Ri=i*Br/Dt,Ve=$t[Lt].duration||0;vt+=Ri+Ve}return vt},jT=($t,wt,vt,Lt)=>{const Dt=new Date().toISOString();return{id:`mission_${Date.now()}`,name:$t,created:Dt,settings:{homePosition:vt,maxAltitude:400,maxDistance:1e3,returnToHomeAltitude:50,emergencyAction:"rtl",...Lt},waypoints:wt,metadata:{totalDistance:Pb(wt),estimatedDuration:UT(wt),maxAltitude:Math.max(...wt.map(Ft=>Ft.position.altitude))}}},GT=$t=>{const wt=$t.split(`
`).filter(Lt=>Lt.trim());wt[0].split(",").map(Lt=>Lt.trim());const vt=[];for(let Lt=1;Lt<wt.length;Lt++){const Dt=wt[Lt].split(",").map(Ft=>Ft.trim());if(Dt.length>=6){const Ft={x:parseFloat(Dt[0]),y:parseFloat(Dt[1]),z:parseFloat(Dt[2]),mesh_id:parseInt(Dt[3]),vertex_id:parseInt(Dt[4]),elevation:parseFloat(Dt[5]),slope:Dt[6]?parseFloat(Dt[6]):void 0,aspect:Dt[7]?parseFloat(Dt[7]):void 0};vt.push(Ft)}}return vt},$T=$t=>{const wt=$t.split(`
`).filter(Dt=>Dt.trim()),vt=wt[0].split(",").map(Dt=>Dt.trim()),Lt=[];for(let Dt=1;Dt<wt.length;Dt++){const Ft=wt[Dt].split(",").map(it=>it.trim());if(Ft.length>=6){const it={x:parseFloat(Ft[0]),y:parseFloat(Ft[1]),z:parseFloat(Ft[2]),elevation:parseFloat(Ft[3]),waypoint_id:parseInt(Ft[4]),timestamp:Ft[5]||void 0,speed:Ft[6]?parseFloat(Ft[6]):void 0,action:Ft[7]||void 0,description:Ft[8]||void 0,properties:{}};if(vt.length>9)for(let i=9;i<vt.length&&i<Ft.length;i++)it.properties[vt[i]]=Ft[i];Lt.push(it)}}return Lt},qT=$t=>{const wt=$t.split(`
`).filter(Dt=>Dt.trim()),vt=wt[0].split(",").map(Dt=>Dt.trim()),Lt=[];for(let Dt=1;Dt<wt.length;Dt++){const Ft=wt[Dt].split(",").map(it=>it.trim());if(Ft.length>=6){const it={x:parseFloat(Ft[0]),y:parseFloat(Ft[1]),z:parseFloat(Ft[2]),elevation:parseFloat(Ft[3]),timestamp:Ft[4],speed:parseFloat(Ft[5]),battery_level:Ft[6]?parseFloat(Ft[6]):void 0,signal_strength:Ft[7]?parseFloat(Ft[7]):void 0,gps_accuracy:Ft[8]?parseFloat(Ft[8]):void 0,action:Ft[9]||void 0,description:Ft[10]||void 0,properties:{}};if(vt.length>11)for(let i=11;i<vt.length&&i<Ft.length;i++)it.properties[vt[i]]=Ft[i];Lt.push(it)}}return Lt},ZT=$t=>{console.log(""),console.log("CSV500:",$t.substring(0,500));const wt=$t.split(`
`).filter(Dt=>Dt.trim());if(console.log("CSV:",wt.length),wt.length<2)throw console.error("CSV"),new Error("");const vt=wt[0].split(",").map(Dt=>Dt.trim());console.log(":",vt);const Lt=[];for(let Dt=1;Dt<wt.length;Dt++)try{const Ft=wt[Dt].split(",").map(i=>i.trim());if(Ft.length<6){console.warn(` ${Dt} :`,Ft);continue}const it={x:parseFloat(Ft[0]),y:parseFloat(Ft[1]),z:parseFloat(Ft[2]),elevation:parseFloat(Ft[3]),type:Ft[4],description:Ft[5],properties:{damage_level:Ft[6]?parseInt(Ft[6]):0,component_type:Ft[7]||"unknown",inspection_date:Ft[8]||void 0}};if(isNaN(it.x)||isNaN(it.y)||isNaN(it.z)){console.warn(` ${Dt} :`,Ft);continue}Lt.push(it)}catch(Ft){console.error(` ${Dt} :`,Ft,wt[Dt])}return console.log(":",Lt.length,""),console.log("3:",Lt.slice(0,3)),Lt},HT=$t=>{console.log(""),console.log("CSV500:",$t.substring(0,500));const wt=$t.split(`
`).filter(Dt=>Dt.trim());if(console.log("CSV:",wt.length),wt.length<2)throw console.error("CSV"),new Error("");const vt=wt[0].split(",").map(Dt=>Dt.trim());console.log(":",vt);const Lt=[];for(let Dt=1;Dt<wt.length;Dt++)try{const Ft=wt[Dt].split(",").map(i=>i.trim());if(Ft.length<6){console.warn(` ${Dt} :`,Ft);continue}const it={x:parseFloat(Ft[0]),y:parseFloat(Ft[1]),z:parseFloat(Ft[2]),mesh_id:parseInt(Ft[3]),vertex_id:parseInt(Ft[4]),elevation:parseFloat(Ft[5]),slope:Ft[6]?parseFloat(Ft[6]):void 0,aspect:Ft[7]?parseFloat(Ft[7]):void 0,damage_level:Ft[8]?parseInt(Ft[8]):0,component_type:Ft[9]||"unknown"};if(isNaN(it.x)||isNaN(it.y)||isNaN(it.z)){console.warn(` ${Dt} :`,Ft);continue}Lt.push(it)}catch(Ft){console.error(` ${Dt} :`,Ft,wt[Dt])}return console.log(":",Lt.length,""),console.log("3:",Lt.slice(0,3)),Lt},WT=$t=>{const wt=[],vt=new Map;return $t.forEach(Lt=>{vt.has(Lt.mesh_id)||vt.set(Lt.mesh_id,[]),vt.get(Lt.mesh_id).push(Lt)}),vt.forEach((Lt,Dt)=>{if(Lt.length===25)for(let Ft=0;Ft<4;Ft++)for(let it=0;it<4;it++){const i=Lt[Ft*5+it],Pe=Lt[Ft*5+it+1],yi=Lt[(Ft+1)*5+it],tr=Lt[(Ft+1)*5+it+1];wt.push([[i.x,i.y,i.z],[Pe.x,Pe.y,Pe.z],[yi.x,yi.y,yi.z]]),wt.push([[Pe.x,Pe.y,Pe.z],[tr.x,tr.y,tr.z],[yi.x,yi.y,yi.z]])}}),wt},pb=($t,wt,vt="3d-points")=>{console.log("3D:",wt.length,""),console.log(":",wt[0]);const Lt=wt.map(Ft=>({type:"Feature",geometry:{type:"Point",coordinates:[Ft.x,Ft.y]},properties:{elevation:Ft.elevation,z:Ft.z,type:Ft.type,description:Ft.description,damage_level:Ft.properties?.damage_level||0,...Ft.properties}}));console.log(":",Lt.slice(0,3)),$t.getSource(vt)&&$t.removeSource(vt);const Dt=`${vt}-layer`;$t.getLayer(Dt)&&$t.removeLayer(Dt);try{if(console.log(":",vt),$t.addSource(vt,{type:"geojson",data:{type:"FeatureCollection",features:Lt}}),console.log(":",Dt),$t.addLayer({id:Dt,type:"circle",source:vt,paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,8,15,15,20,25],"circle-color":["match",["get","damage_level"],0,"#00ff00",1,"#ffff00",2,"#ffaa00",3,"#ff6600",4,"#ff0000",5,"#990000","#ff4444"],"circle-opacity":.9,"circle-stroke-width":3,"circle-stroke-color":"#ffffff"}}),console.log("3D"),wt.length>0){const Ft=wt.reduce((i,Pe)=>i+Pe.x,0)/wt.length,it=wt.reduce((i,Pe)=>i+Pe.y,0)/wt.length;console.log(":",[Ft,it]),$t.flyTo({center:[Ft,it],zoom:16,duration:2e3})}}catch(Ft){throw console.error("3D:",Ft),Ft}},fb=($t,wt,vt="3d-mesh")=>{console.log("3D:",wt.length,"");const Lt=WT(wt);console.log(":",Lt.length,"");const Dt=Lt.map((it,i)=>({type:"Feature",geometry:{type:"Polygon",coordinates:[it.map(Pe=>[Pe[0],Pe[1]])]},properties:{id:i,elevation:it.reduce((Pe,yi)=>Pe+yi[2],0)/3,z:it.reduce((Pe,yi)=>Pe+yi[2],0)/3}}));console.log(":",Dt.slice(0,2)),$t.getSource(vt)&&$t.removeSource(vt);const Ft=`${vt}-layer`;$t.getLayer(Ft)&&$t.removeLayer(Ft);try{if($t.addSource(vt,{type:"geojson",data:{type:"FeatureCollection",features:Dt}}),$t.addLayer({id:Ft,type:"fill",source:vt,paint:{"fill-color":["match",["get","damage_level"],0,"#00ff00",1,"#ffff00",2,"#ffaa00",3,"#ff6600",4,"#ff0000",5,"#990000","#ff4444"],"fill-opacity":.7,"fill-outline-color":"#ffffff"}}),console.log("3D"),wt.length>0){const it=wt.reduce((Pe,yi)=>Pe+yi.x,0)/wt.length,i=wt.reduce((Pe,yi)=>Pe+yi.y,0)/wt.length;$t.flyTo({center:[it,i],zoom:16,duration:2e3})}}catch(it){throw console.error("3D:",it),it}},XT=($t,wt,vt="drone-waypoints")=>{console.log(":",wt.length,"");const Lt=wt.map(i=>({type:"Feature",geometry:{type:"Point",coordinates:[i.x,i.y]},properties:{elevation:i.elevation,z:i.z,waypoint_id:i.waypoint_id,timestamp:i.timestamp,speed:i.speed,action:i.action,description:i.description,...i.properties}})),Dt=wt.length>1?[{type:"Feature",geometry:{type:"LineString",coordinates:wt.map(i=>[i.x,i.y])},properties:{type:"flight-path",waypoint_count:wt.length}}]:[];console.log(":",Lt.slice(0,3)),$t.getSource(vt)&&$t.removeSource(vt);const Ft=`${vt}-waypoints-layer`,it=`${vt}-path-layer`;$t.getLayer(Ft)&&$t.removeLayer(Ft),$t.getLayer(it)&&$t.removeLayer(it);try{if($t.addSource(vt,{type:"geojson",data:{type:"FeatureCollection",features:Lt}}),$t.addLayer({id:Ft,type:"circle",source:vt,paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,6,15,12,20,20],"circle-color":["match",["get","action"],"takeoff","#00ff00","land","#ff0000","hover","#ffff00","#007cba"],"circle-opacity":.9,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),Dt.length>0&&($t.addSource(`${vt}-path`,{type:"geojson",data:{type:"FeatureCollection",features:Dt}}),$t.addLayer({id:it,type:"line",source:`${vt}-path`,paint:{"line-color":"#ff6b35","line-width":3,"line-opacity":.8}})),console.log(""),wt.length>0){const i=wt.reduce((yi,tr)=>yi+tr.x,0)/wt.length,Pe=wt.reduce((yi,tr)=>yi+tr.y,0)/wt.length;$t.flyTo({center:[i,Pe],zoom:15,duration:2e3})}}catch(i){throw console.error(":",i),i}},YT=($t,wt,vt="drone-flight-log")=>{console.log(":",wt.length,"");const Lt=wt.map(i=>({type:"Feature",geometry:{type:"Point",coordinates:[i.x,i.y]},properties:{elevation:i.elevation,z:i.z,timestamp:i.timestamp,speed:i.speed,battery_level:i.battery_level,signal_strength:i.signal_strength,gps_accuracy:i.gps_accuracy,action:i.action,description:i.description,...i.properties}})),Dt=wt.length>1?[{type:"Feature",geometry:{type:"LineString",coordinates:wt.map(i=>[i.x,i.y])},properties:{type:"flight-trajectory",log_count:wt.length}}]:[];console.log(":",Lt.slice(0,3)),$t.getSource(vt)&&$t.removeSource(vt);const Ft=`${vt}-points-layer`,it=`${vt}-trajectory-layer`;$t.getLayer(Ft)&&$t.removeLayer(Ft),$t.getLayer(it)&&$t.removeLayer(it);try{if($t.addSource(vt,{type:"geojson",data:{type:"FeatureCollection",features:Lt}}),$t.addLayer({id:Ft,type:"circle",source:vt,paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,3,15,6,20,10],"circle-color":["interpolate",["linear"],["get","speed"],0,"#00ff00",10,"#ffff00",20,"#ff0000"],"circle-opacity":.7,"circle-stroke-width":1,"circle-stroke-color":"#ffffff"}}),Dt.length>0&&($t.addSource(`${vt}-trajectory`,{type:"geojson",data:{type:"FeatureCollection",features:Dt}}),$t.addLayer({id:it,type:"line",source:`${vt}-trajectory`,paint:{"line-color":"#00ff00","line-width":2,"line-opacity":.6}})),console.log(""),wt.length>0){const i=wt.reduce((yi,tr)=>yi+tr.x,0)/wt.length,Pe=wt.reduce((yi,tr)=>yi+tr.y,0)/wt.length;$t.flyTo({center:[i,Pe],zoom:15,duration:2e3})}}catch(i){throw console.error(":",i),i}},W0=async($t,wt,vt="points")=>{console.log(":",$t.name,":",vt);const Lt=await $t.text();switch(console.log("100:",Lt.substring(0,100)),vt){case"points":const Dt=VT(Lt);console.log(":",Dt.length,""),console.log("3:",Dt.slice(0,3)),pb(wt,Dt);break;case"mesh":const Ft=GT(Lt);console.log(":",Ft.length,""),console.log("3:",Ft.slice(0,3)),fb(wt,Ft);break;case"waypoints":const it=$T(Lt);console.log(":",it.length,""),console.log("3:",it.slice(0,3)),XT(wt,it);break;case"flight-log":const i=qT(Lt);console.log(":",i.length,""),console.log("3:",i.slice(0,3)),YT(wt,i);break;case"building-inspection":const Pe=ZT(Lt);console.log(":",Pe.length,""),console.log("3:",Pe.slice(0,3)),pb(wt,Pe);break;case"building-inspection-mesh":const yi=HT(Lt);console.log(":",yi.length,""),console.log("3:",yi.slice(0,3)),fb(wt,yi);break;default:throw new Error(`: ${vt}`)}},JT=($t,wt=["3d-points","3d-mesh"])=>{wt.forEach(vt=>{const Lt=`${vt}-layer`;$t.getLayer(Lt)&&$t.removeLayer(Lt),$t.getSource(vt)&&$t.removeSource(vt)})},KT=($t,wt)=>{const vt=$t.trim().split(`
`);if(vt.length<2)return[];const Lt=vt[0].split(",").map(Ft=>Ft.trim().toLowerCase()),Dt=[];for(let Ft=1;Ft<vt.length;Ft++){const it=vt[Ft].split(",").map(Pe=>Pe.trim().replace(/"/g,"")),i={};if(Lt.forEach((Pe,yi)=>{i[Pe]=it[yi]||""}),i.longitude&&i.latitude){const Pe={id:i.id||`${wt}_${Ft}_${Date.now()}`,name:i.name||`${Ft}`,longitude:parseFloat(i.longitude),latitude:parseFloat(i.latitude),altitude:parseFloat(i.altitude||i.height||i.elevation)||50,type:i.type||"unknown",source:wt,properties:{}};Object.keys(i).forEach(yi=>{["id","name","longitude","latitude","altitude","height","elevation","type"].includes(yi)||(Pe.properties[yi]=i[yi])}),Dt.push(Pe)}}return Dt},QT=($t,wt)=>{const vt=JSON.parse($t),Lt=[];return vt.type==="FeatureCollection"&&vt.features?vt.features.forEach((Dt,Ft)=>{if(Dt.geometry&&Dt.geometry.type==="Point"){const it=Dt.geometry.coordinates,i=Dt.properties||{},Pe={id:i.id||`${wt}_${Ft}_${Date.now()}`,name:i.name||`${Ft+1}`,longitude:it[0],latitude:it[1],altitude:it[2]||i.altitude||i.height||i.elevation||50,type:i.type||"unknown",source:wt,properties:{...i}};delete Pe.properties.id,delete Pe.properties.name,delete Pe.properties.altitude,delete Pe.properties.height,delete Pe.properties.elevation,delete Pe.properties.type,Lt.push(Pe)}}):Array.isArray(vt)&&vt.forEach((Dt,Ft)=>{if(Dt.longitude&&Dt.latitude){const it={id:Dt.id||`${wt}_${Ft}_${Date.now()}`,name:Dt.name||`${Ft+1}`,longitude:parseFloat(Dt.longitude||Dt.lng),latitude:parseFloat(Dt.latitude||Dt.lat),altitude:parseFloat(Dt.altitude||Dt.height||Dt.elevation)||50,type:Dt.type||"unknown",source:wt,properties:{}};Object.keys(Dt).forEach(i=>{["id","name","longitude","latitude","lng","lat","altitude","height","elevation","type"].includes(i)||(it.properties[i]=Dt[i])}),Lt.push(it)}}),Lt},t2=$t=>{if($t.length===0)return"";const vt=[["longitude","latitude","altitude","name","type","source"].join(",")];return $t.forEach(Lt=>{const Dt=[Lt.longitude,Lt.latitude,Lt.altitude,`"${Lt.name}"`,Lt.type,`"${Lt.source}"`];vt.push(Dt.join(","))}),vt.join(`
`)},e2=$t=>{const wt={type:"FeatureCollection",metadata:{export_time:new Date().toISOString(),total_objects:$t.length,generator:"MapLibre GSI Terrain System"},features:$t.map(vt=>({type:"Feature",geometry:{type:"Point",coordinates:[vt.longitude,vt.latitude,vt.altitude]},properties:{name:vt.name,type:vt.type,altitude:vt.altitude,source:vt.source,id:vt.id,...vt.properties}}))};return JSON.stringify(wt,null,2)},mb=$t=>{if($t.length===0)return"";const wt=["id","name","type","source","longitude","latitude","altitude","relativeAltitude","timestamp","duration","speed","heading","action","waypointId","sequenceNumber","batteryLevel","signalStrength","gpsAccuracy","temperature","humidity","windSpeed","windDirection","missionId","operatorId","aircraftModel","aircraftSerial","description"],vt=$t.map(Dt=>[Dt.id,Dt.name,Dt.type,Dt.source,Dt.position.longitude,Dt.position.latitude,Dt.position.altitude,Dt.position.relativeAltitude||"",Dt.timestamp||"",Dt.duration||"",Dt.flight?.speed||"",Dt.flight?.heading||"",Dt.flight?.action||"",Dt.flight?.waypointId||"",Dt.flight?.sequenceNumber||"",Dt.telemetry?.batteryLevel||"",Dt.telemetry?.signalStrength||"",Dt.telemetry?.gpsAccuracy||"",Dt.telemetry?.temperature||"",Dt.telemetry?.humidity||"",Dt.telemetry?.windSpeed||"",Dt.telemetry?.windDirection||"",Dt.metadata?.missionId||"",Dt.metadata?.operatorId||"",Dt.metadata?.aircraftModel||"",Dt.metadata?.aircraftSerial||"",Dt.metadata?.description||""]);return[wt.join(","),...vt.map(Dt=>Dt.join(","))].join(`
`)},gb=$t=>{const wt=$t.map(Lt=>({type:"Feature",geometry:Lt.geometry||{type:"Point",coordinates:[Lt.position.longitude,Lt.position.latitude,Lt.position.altitude]},properties:{id:Lt.id,name:Lt.name,type:Lt.type,source:Lt.source,altitude:Lt.position.altitude,relativeAltitude:Lt.position.relativeAltitude,timestamp:Lt.timestamp,duration:Lt.duration,flight:Lt.flight,telemetry:Lt.telemetry,metadata:Lt.metadata,...Lt.properties}})),vt={type:"FeatureCollection",metadata:{generator:"MapLibre GSI Terrain - Unified Flight Data",timestamp:new Date().toISOString(),count:$t.length},features:wt};return JSON.stringify(vt,null,2)},i2=$t=>{const wt=$t.waypoints;if(wt.length===0)return"";const vt=wt.map(Ft=>`
        <Placemark>
            <name>${Ft.name}</name>
            <description>
                <![CDATA[
                    <b>Action:</b> ${Ft.flight?.action||"waypoint"}<br/>
                    <b>Altitude:</b> ${Ft.position.altitude}m<br/>
                    <b>Speed:</b> ${Ft.flight?.speed||"N/A"} m/s<br/>
                    <b>Duration:</b> ${Ft.duration||0}s
                ]]>
            </description>
            <Point>
                <coordinates>${Ft.position.longitude},${Ft.position.latitude},${Ft.position.altitude}</coordinates>
            </Point>
        </Placemark>`).join(""),Lt=wt.map(Ft=>`${Ft.position.longitude},${Ft.position.latitude},${Ft.position.altitude}`).join(" ");return`<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${$t.name}</name>
        <description>${$t.description||""}</description>
        
        <Style id="waypointStyle">
            <IconStyle>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
                </Icon>
            </IconStyle>
        </Style>
        
        <Style id="pathStyle">
            <LineStyle>
                <color>ff0000ff</color>
                <width>3</width>
            </LineStyle>
        </Style>
        
        ${vt}
        
        <Placemark>
            <name>Flight Path</name>
            <styleUrl>#pathStyle</styleUrl>
            <LineString>
                <altitudeMode>absolute</altitudeMode>
                <coordinates>${Lt}</coordinates>
            </LineString>
        </Placemark>
        
        <Placemark>
            <name>Home Position</name>
            <Point>
                <coordinates>${$t.settings.homePosition.longitude},${$t.settings.homePosition.latitude},${$t.settings.homePosition.altitude}</coordinates>
            </Point>
        </Placemark>
    </Document>
</kml>`},X0=$t=>{const wt=$t.trim().split(`
`);if(wt.length<2)return[];wt[0].split(",").map(Lt=>Lt.trim());const vt=[];for(let Lt=1;Lt<wt.length;Lt++){const Dt=wt[Lt].split(",").map(Ft=>Ft.trim());if(Dt.length>=6){const Ft={id:Dt[0]||`unified_${Date.now()}_${Lt}`,name:Dt[1]||`Flight Data ${Lt}`,type:Dt[2]||"waypoint",source:Dt[3]||"csv_import",position:{longitude:parseFloat(Dt[4])||0,latitude:parseFloat(Dt[5])||0,altitude:parseFloat(Dt[6])||0,relativeAltitude:Dt[7]?parseFloat(Dt[7]):void 0}};Dt[8]&&(Ft.timestamp=Dt[8]),Dt[9]&&(Ft.duration=parseFloat(Dt[9])),(Dt[10]||Dt[11]||Dt[12]||Dt[13]||Dt[14])&&(Ft.flight={speed:Dt[10]?parseFloat(Dt[10]):void 0,heading:Dt[11]?parseFloat(Dt[11]):void 0,action:Dt[12],waypointId:Dt[13]?parseInt(Dt[13]):void 0,sequenceNumber:Dt[14]?parseInt(Dt[14]):void 0}),(Dt[15]||Dt[16]||Dt[17]||Dt[18]||Dt[19]||Dt[20]||Dt[21])&&(Ft.telemetry={batteryLevel:Dt[15]?parseFloat(Dt[15]):void 0,signalStrength:Dt[16]?parseFloat(Dt[16]):void 0,gpsAccuracy:Dt[17]?parseFloat(Dt[17]):void 0,temperature:Dt[18]?parseFloat(Dt[18]):void 0,humidity:Dt[19]?parseFloat(Dt[19]):void 0,windSpeed:Dt[20]?parseFloat(Dt[20]):void 0,windDirection:Dt[21]?parseFloat(Dt[21]):void 0}),(Dt[22]||Dt[23]||Dt[24]||Dt[25]||Dt[26])&&(Ft.metadata={missionId:Dt[22]||void 0,operatorId:Dt[23]||void 0,aircraftModel:Dt[24]||void 0,aircraftSerial:Dt[25]||void 0,description:Dt[26]||void 0}),vt.push(Ft)}}return vt},_b=$t=>{try{const wt=JSON.parse($t);if(wt.type!=="FeatureCollection"||!wt.features)throw new Error("Invalid GeoJSON format");return wt.features.map((Lt,Dt)=>{const Ft=Lt.properties||{},it=Lt.geometry;let i={longitude:0,latitude:0,altitude:0};return it&&(it.type==="Point"?i={longitude:it.coordinates[0],latitude:it.coordinates[1],altitude:it.coordinates[2]||Ft.altitude||0}:it.type==="LineString"&&it.coordinates.length>0?i={longitude:it.coordinates[0][0],latitude:it.coordinates[0][1],altitude:it.coordinates[0][2]||Ft.altitude||0}:it.type==="Polygon"&&it.coordinates[0].length>0&&(i={longitude:it.coordinates[0][0][0],latitude:it.coordinates[0][0][1],altitude:it.coordinates[0][0][2]||Ft.altitude||0})),{id:Ft.id||`geojson_${Date.now()}_${Dt}`,name:Ft.name||`Flight Data ${Dt+1}`,type:Ft.type||"waypoint",source:Ft.source||"geojson_import",position:{...i,relativeAltitude:Ft.relativeAltitude},timestamp:Ft.timestamp,duration:Ft.duration,flight:Ft.flight,telemetry:Ft.telemetry,metadata:Ft.metadata,geometry:it,properties:Ft}})}catch(wt){return console.error("GeoJSON parse error:",wt),[]}},r2=$t=>{try{const wt=JSON.parse($t);if(!wt.id||!wt.name||!wt.settings||!wt.waypoints)throw new Error("Invalid flight mission format");return wt}catch(wt){return console.error("Flight mission parse error:",wt),null}},Im=($t,wt,vt)=>{try{const Lt=new Blob([$t],{type:vt}),Dt=URL.createObjectURL(Lt),Ft=document.createElement("a");Ft.href=Dt,Ft.download=wt,Ft.style.display="none",document.body.appendChild(Ft),Ft.click(),document.body.removeChild(Ft),URL.revokeObjectURL(Dt),console.log(`: ${wt}`)}catch(Lt){throw console.error(":",Lt),Lt}},n2=($t=[139.7454,35.6586])=>{const wt=[];for(let Lt=1;Lt<=5;Lt++){const Dt=(Lt-1)*(2*Math.PI/5)+Math.random()*.5,Ft=200+Math.random()*300,it=[$t[0]+Ft*Math.cos(Dt)/111320,$t[1]+Ft*Math.sin(Dt)/110540];wt.push({id:`tokyo_tower_drone_${Lt}_${Date.now()}`,name:`${String(Lt).padStart(2,"0")}`,longitude:it[0],latitude:it[1],altitude:250+Math.random()*100,type:"drone",source:"tokyo_tower_inspection",properties:{mission:"tower_inspection",status:"active"}})}return[{type:"base",name:"",lat_offset:-.001,lng_offset:.001,altitude:50},{type:"sensor",name:"",lat_offset:5e-4,lng_offset:-8e-4,altitude:100},{type:"weather",name:"",lat_offset:-8e-4,lng_offset:-.001,altitude:80},{type:"manual",name:"A",lat_offset:3e-4,lng_offset:5e-4,altitude:200}].forEach((Lt,Dt)=>{wt.push({id:`tokyo_tower_${Lt.type}_${Dt}_${Date.now()}`,name:Lt.name,longitude:$t[0]+Lt.lng_offset,latitude:$t[1]+Lt.lat_offset,altitude:Lt.altitude+(Math.random()-.5)*20,type:Lt.type,source:"tokyo_tower_inspection",properties:{facility_type:"inspection_equipment",tower_related:!0}})}),wt},o2=`
const vsSource = \`#version 300 es
    in vec4 a_position;
    out vec2 v_tex_coord;

    void main() {
        gl_Position = a_position;
        v_tex_coord = vec2(a_position.x * 0.5 + 0.5, a_position.y * -0.5 + 0.5);
    }
\`;

const fsSource = \`#version 300 es
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    uniform sampler2D u_height_map;
    in vec2 v_tex_coord;
    out vec4 fragColor;

    void main() {
        vec4 color = texture(u_height_map, v_tex_coord);
        vec3 rgb = color.rgb * 255.0;

        // terrarium0
        vec4 zero_elevation_color = vec4(128.0, 0.0, 0.0, 255.0) / 255.0;

        // 
        bool is_valid = (rgb.r != 128.0 || rgb.g != 0.0 || rgb.b != 0.0) && color.a != 0.0;

        float rgb_value = dot(rgb, vec3(65536.0, 256.0, 1.0));
        float height = mix(rgb_value, rgb_value - 16777216.0, step(8388608.0, rgb_value)) * 0.01;

        // terrarium
        height += 32768.0;
        float r = floor(height / 256.0);
        float g = floor(mod(height, 256.0));
        float b = floor((height - floor(height)) * 256.0);

        // terrarium
        fragColor = mix(
            zero_elevation_color,
            vec4(
                r / 255.0,
                g / 255.0,
                b / 255.0,
                1.0
            ),
            float(is_valid)
        );
    }
\`;

let gl = null;
let program = null;
let positionBuffer = null;
let heightMapLocation = null;

const initWebGL = (canvas) => {
	gl = canvas.getContext('webgl2');
	if (!gl) {
		throw new Error('WebGL not supported');
	}

	const loadShader = (
		gl,
		type,
		source,
	) => {
		const shader = gl.createShader(type);
		if (!shader) {
			console.error('Unable to create shader');
			return null;
		}
		gl.shaderSource(shader, source);
		gl.compileShader(shader);

		if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
			console.error(
				'An error occurred compiling the shaders: ' +
					gl.getShaderInfoLog(shader),
			);
			gl.deleteShader(shader);
			return null;
		}
		return shader;
	};

	const vertexShader = loadShader(gl, gl.VERTEX_SHADER, vsSource);
	const fragmentShader = loadShader(gl, gl.FRAGMENT_SHADER, fsSource);
	if (!vertexShader || !fragmentShader) {
		throw new Error('Failed to load shaders');
	}

	program = gl.createProgram();
	if (!program) {
		throw new Error('Failed to create program');
	}
	gl.attachShader(program, vertexShader);
	gl.attachShader(program, fragmentShader);
	gl.linkProgram(program);

	if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
		console.error(
			'Unable to initialize the shader program: ' +
				gl.getProgramInfoLog(program),
		);
		throw new Error('Failed to link program');
	}

	positionBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
	const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
	gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
	const positionLocation = gl.getAttribLocation(program, 'a_position');
	gl.enableVertexAttribArray(positionLocation);
	gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

	heightMapLocation = gl.getUniformLocation(program, 'u_height_map');
};

const canvas = new OffscreenCanvas(256, 256);

self.onmessage = async (e) => {
	const { url, image } = e.data;

	try {
		if (!gl) {
			initWebGL(canvas);
		}

		if (!gl || !program || !positionBuffer || !heightMapLocation) {
			throw new Error('WebGL initialization failed');
		}

		const heightMap = gl.createTexture();
		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, heightMap);
		gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);

		gl.useProgram(program);
		gl.uniform1i(heightMapLocation, 0);

		gl.clear(gl.COLOR_BUFFER_BIT);
		gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

		const blob = await canvas.convertToBlob();
		if (!blob) {
			throw new Error('Failed to convert canvas to blob');
		}
		const buffer = await blob.arrayBuffer();
		self.postMessage({ url, buffer });
	} catch (error) {
		if (error instanceof Error) {
			self.postMessage({ url, error: error.message });
		}
	}
};
`,s2=async($t,wt)=>{let vt;try{console.log("[GSI DEM] Fetching:",$t),vt=await fetch($t,{signal:wt}),console.log("[GSI DEM] Fetch success:",vt.status,vt.statusText)}catch(Lt){return wt.aborted||console.error(`[GSI DEM] Failed to fetch image from ${$t}:`,Lt),null}return vt.ok?await createImageBitmap(await vt.blob()):(console.error(`[GSI DEM] Response not OK: ${vt.status} ${vt.statusText}`),null)};class a2{worker;pendingRequests;constructor(wt){this.worker=wt,this.pendingRequests=new Map,this.worker.addEventListener("message",this.handleMessage),this.worker.addEventListener("error",this.handleError)}async request(wt,vt){const Lt=await s2(wt,vt.signal);return Lt?new Promise((Dt,Ft)=>{this.pendingRequests.set(wt,{resolve:Dt,reject:Ft,controller:vt}),this.worker.postMessage({image:Lt,url:wt}),vt.signal.onabort=()=>{this.pendingRequests.delete(wt),Ft(new Error("Request aborted"))}}):Promise.reject(new Error("Failed to load image"))}handleMessage=wt=>{const{url:vt,buffer:Lt,error:Dt}=wt.data,Ft=this.pendingRequests.get(vt);Dt?(console.error(`Error processing tile ${vt}:`,Dt),Ft&&(Ft.reject(new Error(Dt)),this.pendingRequests.delete(vt))):Ft&&(Ft.resolve({data:new Uint8Array(Lt)}),this.pendingRequests.delete(vt))};handleError=wt=>{console.error("Worker error:",wt),this.pendingRequests.forEach(vt=>{vt.reject(new Error("Worker error occurred"))}),this.pendingRequests.clear()}}const l2=new Blob([o2],{type:"application/javascript"}),c2=new Worker(URL.createObjectURL(l2)),h2=new a2(c2),u2=$t=>{const wt=new RegExp(`^${$t}:(?://)?`);return(vt,Lt)=>{let Dt=vt.url.replace(wt,"");return Dt=Dt.replace(/^(https?)\/{2,}/,"$1://"),console.log("[GSI DEM] Original URL:",vt.url),console.log("[GSI DEM] Processed URL:",Dt),h2.request(Dt,Lt)}};class d2{map;currentStyleId;styles;terrainSource;constructor(wt,vt){this.map=wt,this.terrainSource=vt,this.styles=new Map,this.currentStyleId="satellite",this.initializeStyles()}initializeStyles(){this.addStyle({id:"satellite",name:"",description:"",styleObject:{version:8,sources:{seamlessphoto:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg"],maxzoom:18,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"seamlessphoto",source:"seamlessphoto",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"standard",name:"",description:"",styleObject:{version:8,sources:{gsi_std:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"],maxzoom:18,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"gsi_std",source:"gsi_std",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"pale",name:"",description:"",styleObject:{version:8,sources:{gsi_pale:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png"],maxzoom:18,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"gsi_pale",source:"gsi_pale",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"blank",name:"",description:"",styleObject:{version:8,sources:{gsi_blank:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png"],maxzoom:14,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"gsi_blank",source:"gsi_blank",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"dark",name:"",description:"",styleObject:{version:8,sources:{terrain:this.terrainSource},layers:[{id:"background",type:"background",paint:{"background-color":"#1a1a1a"}}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"relief",name:"",description:"",styleObject:{version:8,sources:{relief:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png"],maxzoom:15,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"relief",source:"relief",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}})}addStyle(wt){this.styles.set(wt.id,wt)}getStyle(wt){return this.styles.get(wt)}getAllStyles(){return Array.from(this.styles.values())}switchStyle(wt){const vt=this.styles.get(wt);if(!vt){console.warn(`Style not found: ${wt}`);return}const Lt=this.map.getStyle(),Dt=Lt.sources,Ft=Lt.layers,it={},i=[],Pe=["drone-objects","drone-connections","altitude-lines","drawing-polygon","selected-object","drone-trail","flight-plan-waypoints","flight-plan-path"];for(const[yi,tr]of Object.entries(Dt))Pe.includes(yi)&&(it[yi]=tr);for(const yi of Ft)Pe.some(tr=>yi.id.includes(tr)||yi.source===tr)&&i.push(yi);if(vt.styleObject){const yi=JSON.parse(JSON.stringify(vt.styleObject));yi.sources={...yi.sources,...it},yi.layers||(yi.layers=[]),yi.layers.push(...i),this.map.setStyle(yi),this.currentStyleId=wt}}getCurrentStyleId(){return this.currentStyleId}setTerrainExaggeration(wt){this.map.getTerrain()&&this.map.setTerrain({source:"terrain",exaggeration:wt})}createStyleControl(){const wt=document.createElement("div");wt.className="maplibregl-ctrl maplibregl-ctrl-group map-style-control",wt.style.cssText=`
			position: absolute;
			top: 10px;
			right: 10px;
			background: white;
			border-radius: 4px;
			box-shadow: 0 0 0 2px rgba(0,0,0,.1);
			padding: 10px;
			max-width: 200px;
			z-index: 1;
		`;const vt=document.createElement("div");vt.textContent="",vt.style.cssText=`
			font-weight: bold;
			margin-bottom: 8px;
			font-size: 12px;
			color: #333;
		`,wt.appendChild(vt);const Lt=document.createElement("div");Lt.style.cssText=`
			display: flex;
			flex-direction: column;
			gap: 6px;
		`;for(const i of this.getAllStyles()){const Pe=document.createElement("button");Pe.textContent=i.name,Pe.title=i.description,Pe.style.cssText=`
				padding: 8px 12px;
				border: 1px solid #ddd;
				border-radius: 4px;
				background: ${this.currentStyleId===i.id?"#007cbf":"white"};
				color: ${this.currentStyleId===i.id?"white":"#333"};
				cursor: pointer;
				font-size: 11px;
				transition: all 0.2s;
			`,Pe.addEventListener("mouseenter",()=>{this.currentStyleId!==i.id&&(Pe.style.background="#f0f0f0")}),Pe.addEventListener("mouseleave",()=>{this.currentStyleId!==i.id&&(Pe.style.background="white")}),Pe.addEventListener("click",()=>{this.switchStyle(i.id),Lt.querySelectorAll("button").forEach(tr=>{const vn=tr.textContent===i.name;tr.style.background=vn?"#007cbf":"white",tr.style.color=vn?"white":"#333"})}),Lt.appendChild(Pe)}wt.appendChild(Lt);const Dt=document.createElement("div");Dt.style.cssText=`
			margin-top: 12px;
			padding-top: 8px;
			border-top: 1px solid #ddd;
		`;const Ft=document.createElement("label");Ft.textContent=": 1.5x",Ft.style.cssText=`
			display: block;
			font-size: 11px;
			margin-bottom: 4px;
			color: #333;
		`;const it=document.createElement("input");return it.type="range",it.min="1.0",it.max="3.0",it.step="0.1",it.value="1.5",it.style.cssText=`
			width: 100%;
		`,it.addEventListener("input",i=>{const Pe=parseFloat(i.target.value);this.setTerrainExaggeration(Pe),Ft.textContent=`: ${Pe.toFixed(1)}x`}),Dt.appendChild(Ft),Dt.appendChild(it),wt.appendChild(Dt),wt}}const Y0={linear:$t=>$t,easeInQuad:$t=>$t*$t,easeOutQuad:$t=>$t*(2-$t),easeInOutQuad:$t=>$t<.5?2*$t*$t:-1+(4-2*$t)*$t,easeInCubic:$t=>$t*$t*$t,easeOutCubic:$t=>--$t*$t*$t+1,easeInOutCubic:$t=>$t<.5?4*$t*$t*$t:($t-1)*(2*$t-2)*(2*$t-2)+1,easeInOutSine:$t=>-(Math.cos(Math.PI*$t)-1)/2,easeOutElastic:$t=>{const wt=2*Math.PI/3;return $t===0?0:$t===1?1:Math.pow(2,-10*$t)*Math.sin(($t*10-.75)*wt)+1}};class p2{map;config;flightLog=[];currentFlightPlan=[];currentFlightPlanName="";currentFlightPlanDescription="";flightPlanActive=!1;currentFlightPhase=0;animationFrameId=null;onLogUpdate;constructor(wt,vt){this.map=wt,this.config={maxSpeed:20,maxAltitude:500,minAltitude:5,acceleration:2,deceleration:3,rotationSpeed:45,physicsEnabled:!0,collisionDetection:!1,...vt}}setLogUpdateCallback(wt){this.onLogUpdate=wt}addFlightLog(wt,vt,Lt,Dt="info"){const Ft={timestamp:new Date().toLocaleTimeString("ja-JP"),phase:wt,action:vt,details:Lt,type:Dt};this.flightLog.push(Ft),this.onLogUpdate&&this.onLogUpdate(this.flightLog)}getFlightLog(){return this.flightLog}clearFlightLog(){this.flightLog=[],this.onLogUpdate&&this.onLogUpdate(this.flightLog)}setFlightPlan(wt){this.currentFlightPlan=wt.phases,this.currentFlightPlanName=wt.name,this.currentFlightPlanDescription=wt.description,this.addFlightLog("","",`${wt.name} `,"success")}startFlightPlan(){if(this.currentFlightPlan.length===0){this.addFlightLog("","","","error");return}if(this.flightPlanActive){this.addFlightLog("","","","warning");return}this.flightPlanActive=!0,this.currentFlightPhase=0,this.addFlightLog("",this.currentFlightPlanName,this.currentFlightPlanDescription,"success"),this.executeFlightPhase()}pauseFlightPlan(){this.flightPlanActive=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.addFlightLog("","","","info")}resumeFlightPlan(){if(this.currentFlightPlan.length===0){this.addFlightLog("","","","error");return}this.flightPlanActive=!0,this.addFlightLog("","","","success"),this.executeFlightPhase()}stopFlightPlan(){this.flightPlanActive=!1,this.currentFlightPhase=0,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.addFlightLog("","","","warning")}executeFlightPhase(){if(!this.flightPlanActive||this.currentFlightPhase>=this.currentFlightPlan.length){this.completeFlightPlan();return}const wt=this.currentFlightPlan[this.currentFlightPhase];this.addFlightLog(wt.phase,wt.action,` ${this.currentFlightPhase+1} `,"info");const vt={center:[wt.position[0],wt.position[1]],zoom:wt.zoom??17,pitch:wt.pitch??60,bearing:wt.bearing??0,duration:wt.duration,easing:Y0.easeInOutCubic};this.map.flyTo(vt),setTimeout(()=>{this.currentFlightPhase++,this.executeFlightPhase()},wt.duration)}completeFlightPlan(){this.flightPlanActive=!1,this.currentFlightPhase=0,this.addFlightLog("","","","success")}flyToSmooth(wt,vt){const Lt={center:[wt[0],wt[1]],zoom:vt?.zoom??this.map.getZoom(),pitch:vt?.pitch??this.map.getPitch(),bearing:vt?.bearing??this.map.getBearing(),duration:vt?.duration??1e3,easing:vt?.easing?Y0[vt.easing]:Y0.easeInOutCubic};this.map.flyTo(Lt)}flyAlongPath(wt,vt){if(wt.length<2){console.warn("At least 2 waypoints are required");return}const Dt=(vt?.totalDuration??wt.length*2e3)/(wt.length-1);let Ft=0;const it=()=>{if(Ft>=wt.length-1){vt?.onComplete&&vt.onComplete();return}const i=wt[Ft],Pe=wt[Ft+1],yi=this.calculateBearing(i,Pe);if(this.map.flyTo({center:[Pe[0],Pe[1]],zoom:17,pitch:60,bearing:yi,duration:Dt,easing:Y0.easeInOutCubic}),vt?.onProgress){const tr=(Ft+1)/wt.length;vt.onProgress(tr,Ft+1)}Ft++,setTimeout(()=>{this.animationFrameId=requestAnimationFrame(it)},Dt)};it()}calculateBearing(wt,vt){const Lt=wt[1]*Math.PI/180,Dt=wt[0]*Math.PI/180,Ft=vt[1]*Math.PI/180,it=vt[0]*Math.PI/180,i=Math.sin(it-Dt)*Math.cos(Ft),Pe=Math.cos(Lt)*Math.sin(Ft)-Math.sin(Lt)*Math.cos(Ft)*Math.cos(it-Dt);return(Math.atan2(i,Pe)*180/Math.PI+360)%360}flyOrbit(wt,vt,Lt,Dt){const Ft=Dt?.duration??1e4,it=Dt?.clockwise??!0,i=Dt?.startAngle??0,yi=Ft/1e3*60;let tr=0;const vn=()=>{if(tr>=yi)return;const on=tr/yi,Br=i+(it?1:-1)*on*360,Or=Br*Math.PI/180,Ri=wt[0]+vt/111320*Math.cos(Or),Ve=wt[1]+vt/110540*Math.sin(Or);this.map.setCenter([Ri,Ve]),this.map.setBearing(Br),Dt?.onProgress&&Dt.onProgress(Br),tr++,this.animationFrameId=requestAnimationFrame(vn)};vn()}getFlightPlanStatus(){return{active:this.flightPlanActive,currentPhase:this.currentFlightPhase,totalPhases:this.currentFlightPlan.length,planName:this.currentFlightPlanName}}updateConfig(wt){this.config={...this.config,...wt}}getConfig(){return{...this.config}}}class f2{map;physicsState;modelMatrix=[];trail=[];maxTrailLength=100;constructor(wt,vt){this.map=wt,this.physicsState={position:vt,velocity:[0,0,0],acceleration:[0,0,0],rotation:[0,0,0],angularVelocity:[0,0,0]}}createCustomLayer(){return{id:"drone-3d-model",type:"custom",renderingMode:"3d",onAdd(wt,vt){},render(wt,vt){}}}static generateDroneGeometry(){const wt=[],vt=[],Lt=[],Dt=[],it=[[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1],[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1]],i=3,Pe=.3,yi=[[i,0,0],[-i,0,0],[0,i,0],[0,-i,0]],tr=1.5,vn=8;for(let on=0;on<yi.length;on++){const[Br,Or,Ri]=yi[on];for(let Ve=0;Ve<vn;Ve++){const Io=Ve/vn*Math.PI*2,gr=Br+Math.cos(Io)*tr,Yr=Or+Math.sin(Io)*tr,Fn=Ri+Pe;wt.push(gr,Yr,Fn),vt.push(0,0,1),Lt.push(.2,.2,.2)}}for(let on=0;on<it.length;on++){const[Br,Or,Ri]=it[on];wt.push(Br,Or,Ri),vt.push(0,0,1),Lt.push(1,.2,.2)}return{vertices:wt,normals:vt,colors:Lt,indices:Dt}}updatePosition(wt){this.physicsState.position=wt,this.trail.push([...wt]),this.trail.length>this.maxTrailLength&&this.trail.shift()}updateRotation(wt){this.physicsState.rotation=wt}updatePhysics(wt){this.physicsState.velocity[0]+=this.physicsState.acceleration[0]*wt,this.physicsState.velocity[1]+=this.physicsState.acceleration[1]*wt,this.physicsState.velocity[2]+=this.physicsState.acceleration[2]*wt,this.physicsState.position[0]+=this.physicsState.velocity[0]*wt,this.physicsState.position[1]+=this.physicsState.velocity[1]*wt,this.physicsState.position[2]+=this.physicsState.velocity[2]*wt;const vt=.95;this.physicsState.velocity[0]*=vt,this.physicsState.velocity[1]*=vt,this.physicsState.velocity[2]*=vt,this.physicsState.rotation[0]+=this.physicsState.angularVelocity[0]*wt,this.physicsState.rotation[1]+=this.physicsState.angularVelocity[1]*wt,this.physicsState.rotation[2]+=this.physicsState.angularVelocity[2]*wt,this.physicsState.angularVelocity[0]*=vt,this.physicsState.angularVelocity[1]*=vt,this.physicsState.angularVelocity[2]*=vt}applyForce(wt){this.physicsState.acceleration[0]=wt[0],this.physicsState.acceleration[1]=wt[1],this.physicsState.acceleration[2]=wt[2]}applyTorque(wt){this.physicsState.angularVelocity[0]+=wt[0],this.physicsState.angularVelocity[1]+=wt[1],this.physicsState.angularVelocity[2]+=wt[2]}getPosition(){return[...this.physicsState.position]}getPhysicsState(){return{...this.physicsState}}getTrail(){return[...this.trail]}clearTrail(){this.trail=[]}toGeoJSON(){return{type:"Feature",geometry:{type:"Point",coordinates:[this.physicsState.position[0],this.physicsState.position[1],this.physicsState.position[2]]},properties:{type:"drone",rotation:this.physicsState.rotation,velocity:this.physicsState.velocity}}}trailToGeoJSON(){return{type:"Feature",geometry:{type:"LineString",coordinates:this.trail.map(wt=>[wt[0],wt[1],wt[2]])},properties:{type:"drone-trail"}}}}class m2{map;droneModel;keyboardState;gamepadIndex=null;updateInterval=null;updateRate=1e3/60;controls={forward:["w","ArrowUp"],backward:["s","ArrowDown"],left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["Space"],down:["Shift"],rotateLeft:["q"],rotateRight:["e"],turbo:["Control"]};params={moveSpeed:1e-4,altitudeSpeed:2,rotationSpeed:2,turboMultiplier:2};constructor(wt,vt){this.map=wt,this.droneModel=vt,this.keyboardState={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rotateLeft:!1,rotateRight:!1,turbo:!1},this.setupEventListeners(),this.detectGamepad()}setupEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),window.addEventListener("gamepadconnected",this.handleGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.handleGamepadDisconnected.bind(this))}handleKeyDown(wt){const vt=wt.key.toLowerCase();(this.controls.forward.includes(vt)||this.controls.forward.includes(wt.key))&&(this.keyboardState.forward=!0,wt.preventDefault()),(this.controls.backward.includes(vt)||this.controls.backward.includes(wt.key))&&(this.keyboardState.backward=!0,wt.preventDefault()),(this.controls.left.includes(vt)||this.controls.left.includes(wt.key))&&(this.keyboardState.left=!0,wt.preventDefault()),(this.controls.right.includes(vt)||this.controls.right.includes(wt.key))&&(this.keyboardState.right=!0,wt.preventDefault()),this.controls.up.includes(wt.key)&&(this.keyboardState.up=!0,wt.preventDefault()),this.controls.down.includes(wt.key)&&(this.keyboardState.down=!0,wt.preventDefault()),this.controls.rotateLeft.includes(vt)&&(this.keyboardState.rotateLeft=!0,wt.preventDefault()),this.controls.rotateRight.includes(vt)&&(this.keyboardState.rotateRight=!0,wt.preventDefault()),this.controls.turbo.includes(wt.key)&&(this.keyboardState.turbo=!0,wt.preventDefault())}handleKeyUp(wt){const vt=wt.key.toLowerCase();(this.controls.forward.includes(vt)||this.controls.forward.includes(wt.key))&&(this.keyboardState.forward=!1),(this.controls.backward.includes(vt)||this.controls.backward.includes(wt.key))&&(this.keyboardState.backward=!1),(this.controls.left.includes(vt)||this.controls.left.includes(wt.key))&&(this.keyboardState.left=!1),(this.controls.right.includes(vt)||this.controls.right.includes(wt.key))&&(this.keyboardState.right=!1),this.controls.up.includes(wt.key)&&(this.keyboardState.up=!1),this.controls.down.includes(wt.key)&&(this.keyboardState.down=!1),this.controls.rotateLeft.includes(vt)&&(this.keyboardState.rotateLeft=!1),this.controls.rotateRight.includes(vt)&&(this.keyboardState.rotateRight=!1),this.controls.turbo.includes(wt.key)&&(this.keyboardState.turbo=!1)}handleGamepadConnected(wt){console.log(":",wt.gamepad.id),this.gamepadIndex=wt.gamepad.index}handleGamepadDisconnected(wt){console.log(":",wt.gamepad.id),this.gamepadIndex===wt.gamepad.index&&(this.gamepadIndex=null)}detectGamepad(){const wt=navigator.getGamepads();for(let vt=0;vt<wt.length;vt++)if(wt[vt]){this.gamepadIndex=vt,console.log(":",wt[vt]?.id);break}}getGamepadInput(){if(this.gamepadIndex===null)return null;const vt=navigator.getGamepads()[this.gamepadIndex];return vt?{leftStick:{x:vt.axes[0]||0,y:vt.axes[1]||0},rightStick:{x:vt.axes[2]||0,y:vt.axes[3]||0},throttle:vt.buttons[7]?.value||0,buttons:{takeoff:vt.buttons[0]?.pressed||!1,land:vt.buttons[1]?.pressed||!1,hover:vt.buttons[2]?.pressed||!1,turbo:vt.buttons[6]?.pressed||!1}}:null}enable(){this.updateInterval===null&&(this.updateInterval=window.setInterval(()=>{this.update()},this.updateRate),console.log(""))}disable(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null),this.keyboardState={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rotateLeft:!1,rotateRight:!1,turbo:!1},console.log("")}update(){const wt=this.updateRate/1e3,vt=this.getGamepadInput();let Lt=0,Dt=0,Ft=0,it=0;if(this.keyboardState.forward&&(Dt+=1),this.keyboardState.backward&&(Dt-=1),this.keyboardState.left&&(Lt-=1),this.keyboardState.right&&(Lt+=1),this.keyboardState.up&&(Ft+=1),this.keyboardState.down&&(Ft-=1),this.keyboardState.rotateLeft&&(it-=1),this.keyboardState.rotateRight&&(it+=1),vt){const us=Math.abs(vt.leftStick.x)>.15?vt.leftStick.x:0,ao=Math.abs(vt.leftStick.y)>.15?vt.leftStick.y:0,Do=Math.abs(vt.rightStick.x)>.15?vt.rightStick.x:0;Lt+=us,Dt-=ao,it+=Do,vt.throttle>.1&&(Ft+=vt.throttle)}const i=this.keyboardState.turbo||vt?.buttons.turbo?this.params.turboMultiplier:1,Pe=this.droneModel.getPhysicsState(),yi=Pe.position,tr=Pe.rotation,vn=this.map.getBearing(),on=vn*Math.PI/180,Br=Lt*Math.cos(on)-Dt*Math.sin(on),Or=Lt*Math.sin(on)+Dt*Math.cos(on),Ri=yi[0]+Br*this.params.moveSpeed*i,Ve=yi[1]+Or*this.params.moveSpeed*i,Io=yi[2]+Ft*this.params.altitudeSpeed*wt*i,gr=Math.max(5,Math.min(500,Io));this.droneModel.updatePosition([Ri,Ve,gr]);const Yr=tr[2]+it*this.params.rotationSpeed;this.droneModel.updateRotation([tr[0],tr[1],Yr]),this.droneModel.updatePhysics(wt),(Lt!==0||Dt!==0||Ft!==0||it!==0)&&(this.map.setCenter([Ri,Ve]),it!==0&&this.map.setBearing(vn+it*this.params.rotationSpeed))}getKeyboardState(){return{...this.keyboardState}}isGamepadConnected(){return this.gamepadIndex!==null}updateParams(wt){Object.assign(this.params,wt)}getControlsHelp(){return`

  W /        : 
  S /        : 
  A /        : 
  D /        : 
  Space       : 
  Shift       : 
  Q           : 
  E           : 
  Ctrl        : 


    : 
    : 
  R2    : 
  L2    : 
  A      : 
  B      : 
		`}}class g2{map;droneModel;leftJoystick;rightJoystick;updateInterval=null;updateRate=1e3/60;leftJoystickContainer=null;leftJoystickKnob=null;rightJoystickContainer=null;rightJoystickKnob=null;config={maxDistance:60,deadzone:.15,sensitivity:1.5,returnSpeed:.2};params={moveSpeed:1e-4,altitudeSpeed:2,rotationSpeed:2};constructor(wt,vt){this.map=wt,this.droneModel=vt,this.leftJoystick=this.createTouchState(),this.rightJoystick=this.createTouchState(),this.setupJoystickUI(),this.setupEventListeners()}createTouchState(){return{active:!1,startX:0,startY:0,currentX:0,currentY:0,deltaX:0,deltaY:0,touchId:null}}setupJoystickUI(){this.leftJoystickContainer=document.getElementById("leftJoystick"),this.leftJoystickKnob=document.getElementById("leftJoystickKnob"),this.rightJoystickContainer=document.getElementById("rightJoystick"),this.rightJoystickKnob=document.getElementById("rightJoystickKnob"),(!this.leftJoystickContainer||!this.rightJoystickContainer)&&console.warn("UI")}setupEventListeners(){this.leftJoystickContainer&&(this.leftJoystickContainer.addEventListener("touchstart",this.handleTouchStart.bind(this,"left"),{passive:!1}),this.leftJoystickContainer.addEventListener("touchmove",this.handleTouchMove.bind(this,"left"),{passive:!1}),this.leftJoystickContainer.addEventListener("touchend",this.handleTouchEnd.bind(this,"left"),{passive:!1})),this.rightJoystickContainer&&(this.rightJoystickContainer.addEventListener("touchstart",this.handleTouchStart.bind(this,"right"),{passive:!1}),this.rightJoystickContainer.addEventListener("touchmove",this.handleTouchMove.bind(this,"right"),{passive:!1}),this.rightJoystickContainer.addEventListener("touchend",this.handleTouchEnd.bind(this,"right"),{passive:!1}))}handleTouchStart(wt,vt){vt.preventDefault();const Lt=vt.touches[0];if(!Lt)return;const Dt=wt==="left"?this.leftJoystick:this.rightJoystick,Ft=wt==="left"?this.leftJoystickContainer:this.rightJoystickContainer;if(!Ft)return;const it=Ft.getBoundingClientRect(),i=it.left+it.width/2,Pe=it.top+it.height/2;Dt.active=!0,Dt.touchId=Lt.identifier,Dt.startX=i,Dt.startY=Pe,Dt.currentX=Lt.clientX,Dt.currentY=Lt.clientY,this.updateJoystickDelta(Dt),this.updateJoystickUI(wt)}handleTouchMove(wt,vt){vt.preventDefault();const Lt=wt==="left"?this.leftJoystick:this.rightJoystick;if(!Lt.active||Lt.touchId===null)return;const Dt=Array.from(vt.touches).find(Ft=>Ft.identifier===Lt.touchId);Dt&&(Lt.currentX=Dt.clientX,Lt.currentY=Dt.clientY,this.updateJoystickDelta(Lt),this.updateJoystickUI(wt))}handleTouchEnd(wt,vt){vt.preventDefault();const Lt=wt==="left"?this.leftJoystick:this.rightJoystick;Lt.active=!1,Lt.touchId=null,Lt.deltaX=0,Lt.deltaY=0,this.updateJoystickUI(wt)}updateJoystickDelta(wt){let vt=wt.currentX-wt.startX,Lt=wt.currentY-wt.startY;if(Math.sqrt(vt*vt+Lt*Lt)>this.config.maxDistance){const Ft=Math.atan2(Lt,vt);vt=Math.cos(Ft)*this.config.maxDistance,Lt=Math.sin(Ft)*this.config.maxDistance}wt.deltaX=vt/this.config.maxDistance,wt.deltaY=Lt/this.config.maxDistance,Math.abs(wt.deltaX)<this.config.deadzone&&(wt.deltaX=0),Math.abs(wt.deltaY)<this.config.deadzone&&(wt.deltaY=0)}updateJoystickUI(wt){const vt=wt==="left"?this.leftJoystick:this.rightJoystick,Lt=wt==="left"?this.leftJoystickKnob:this.rightJoystickKnob;if(Lt)if(vt.active){const Dt=vt.deltaX*this.config.maxDistance,Ft=vt.deltaY*this.config.maxDistance;Lt.style.transform=`translate(${Dt}px, ${Ft}px)`,Lt.style.opacity="1"}else Lt.style.transform="translate(0, 0)",Lt.style.opacity="0.5"}enable(){this.updateInterval===null&&(this.leftJoystickContainer&&(this.leftJoystickContainer.style.display="flex",this.leftJoystickContainer.style.pointerEvents="auto"),this.rightJoystickContainer&&(this.rightJoystickContainer.style.display="flex",this.rightJoystickContainer.style.pointerEvents="auto"),this.updateInterval=window.setInterval(()=>{this.processInput()},this.updateRate))}disable(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null),this.leftJoystickContainer&&(this.leftJoystickContainer.style.display="none",this.leftJoystickContainer.style.pointerEvents="none"),this.rightJoystickContainer&&(this.rightJoystickContainer.style.display="none",this.rightJoystickContainer.style.pointerEvents="none"),this.leftJoystick=this.createTouchState(),this.rightJoystick=this.createTouchState()}processInput(){const wt=this.getInput(),vt=this.droneModel.getPosition();let[Lt,Dt,Ft]=vt;const it=this.updateRate/1e3,i=this.config.sensitivity,Pe=-wt.leftJoystick.y;Dt+=Pe*this.params.moveSpeed*i;const yi=wt.leftJoystick.x;Lt+=yi*this.params.moveSpeed*i;const tr=-wt.rightJoystick.y;Ft+=tr*this.params.altitudeSpeed*it*i;const vn=wt.rightJoystick.x,Br=this.map.getBearing()+vn*this.params.rotationSpeed*i;this.droneModel.updatePosition([Lt,Dt,Ft]),this.map.easeTo({center:[Lt,Dt],bearing:Br,duration:this.updateRate})}getInput(){return{leftJoystick:{x:this.leftJoystick.deltaX,y:this.leftJoystick.deltaY},rightJoystick:{x:this.rightJoystick.deltaX,y:this.rightJoystick.deltaY},buttons:{turbo:!1,center:!1}}}isEnabled(){return this.updateInterval!==null}updateConfig(wt){this.config={...this.config,...wt}}destroy(){this.disable(),this.leftJoystickContainer&&this.leftJoystickContainer.replaceWith(this.leftJoystickContainer.cloneNode(!0)),this.rightJoystickContainer&&this.rightJoystickContainer.replaceWith(this.rightJoystickContainer.cloneNode(!0))}}class _2{map=null;droneModel=null;flightController=null;state={isEnabled:!1,flightStatus:"STANDBY",currentPhase:"-",phaseIndex:0,totalPhases:0,elapsedTime:0,dronePosition:null,droneAltitude:0,droneHeading:0,droneSpeed:0,cameraCenter:null,cameraZoom:0,cameraPitch:0,cameraBearing:0,currentPhaseData:null,totalObjects:0,fps:0,memory:0};events=[];maxEvents=10;updateInterval=null;startTime=0;frameCount=0;lastFpsTime=0;overlay=null;toggleBtn=null;closeBtn=null;debugModeBtn=null;handleToggle;handleClose;handleToggleBtnClick;constructor(){this.handleToggle=()=>this.toggle(),this.handleClose=()=>this.hide(),this.handleToggleBtnClick=()=>{this.overlay?.classList.contains("visible")?this.hide():this.show()},this.initializeDOMElements(),this.setupEventListeners()}initializeDOMElements(){this.overlay=document.getElementById("debugOverlay"),this.toggleBtn=document.getElementById("debugToggleBtn"),this.closeBtn=document.getElementById("debugOverlayClose")}setupEventListeners(){this.debugModeBtn=document.getElementById("toggleDebugMode"),this.debugModeBtn&&this.debugModeBtn.addEventListener("click",this.handleToggle),this.closeBtn&&this.closeBtn.addEventListener("click",this.handleClose),this.toggleBtn&&this.toggleBtn.addEventListener("click",this.handleToggleBtnClick)}removeEventListeners(){this.debugModeBtn&&this.debugModeBtn.removeEventListener("click",this.handleToggle),this.closeBtn&&this.closeBtn.removeEventListener("click",this.handleClose),this.toggleBtn&&this.toggleBtn.removeEventListener("click",this.handleToggleBtnClick)}setMap(wt){this.map=wt}setDroneModel(wt){this.droneModel=wt}setFlightController(wt){this.flightController=wt}enable(){this.state.isEnabled=!0,this.startTime=Date.now(),this.lastFpsTime=performance.now(),this.frameCount=0,this.toggleBtn&&this.toggleBtn.classList.add("active"),this.startUpdateLoop(),this.show(),this.addEvent("ENABLE","Debug mode enabled"),console.log("[DEBUG] Debug mode enabled")}disable(){this.state.isEnabled=!1,this.toggleBtn&&this.toggleBtn.classList.remove("active"),this.stopUpdateLoop(),this.hide(),this.addEvent("DISABLE","Debug mode disabled"),console.log("[DEBUG] Debug mode disabled")}toggle(){this.state.isEnabled?this.disable():this.enable()}show(){this.overlay&&this.overlay.classList.add("visible")}hide(){this.overlay&&this.overlay.classList.remove("visible")}startUpdateLoop(){this.updateInterval||(this.updateInterval=window.setInterval(()=>{this.updateState(),this.updateDOM()},100))}stopUpdateLoop(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}updateState(){this.state.elapsedTime=Date.now()-this.startTime,this.frameCount++;const wt=performance.now();if(wt-this.lastFpsTime>=1e3&&(this.state.fps=Math.round(this.frameCount*1e3/(wt-this.lastFpsTime)),this.frameCount=0,this.lastFpsTime=wt),performance.memory&&(this.state.memory=Math.round(performance.memory.usedJSHeapSize/1024/1024)),this.map){const vt=this.map.getCenter();this.state.cameraCenter={lng:vt.lng,lat:vt.lat},this.state.cameraZoom=this.map.getZoom(),this.state.cameraPitch=this.map.getPitch(),this.state.cameraBearing=this.map.getBearing()}if(this.droneModel){if(typeof this.droneModel.getPosition=="function"){const vt=this.droneModel.getPosition();vt&&(this.state.dronePosition={lng:vt[0],lat:vt[1]},this.state.droneAltitude=vt[2]||0)}typeof this.droneModel.getHeading=="function"&&(this.state.droneHeading=this.droneModel.getHeading()),typeof this.droneModel.getSpeed=="function"&&(this.state.droneSpeed=this.droneModel.getSpeed())}}updateDOM(){this.updateElement("debugFlightStatus",this.state.flightStatus,this.getStatusClass()),this.updateElement("debugCurrentPhase",this.state.currentPhase),this.updateElement("debugPhaseIndex",`${this.state.phaseIndex} / ${this.state.totalPhases}`),this.updateElement("debugElapsedTime",this.formatTime(this.state.elapsedTime)),this.state.dronePosition&&this.updateElement("debugDronePosition",`${this.state.dronePosition.lng.toFixed(6)}, ${this.state.dronePosition.lat.toFixed(6)}`),this.updateElement("debugDroneAltitude",`${this.state.droneAltitude.toFixed(1)}`),this.updateElement("debugDroneHeading",`${this.state.droneHeading.toFixed(1)}`),this.updateElement("debugDroneSpeed",`${this.state.droneSpeed.toFixed(2)}`),this.state.cameraCenter&&this.updateElement("debugCameraCenter",`${this.state.cameraCenter.lng.toFixed(6)}, ${this.state.cameraCenter.lat.toFixed(6)}`),this.updateElement("debugCameraZoom",`${this.state.cameraZoom.toFixed(2)}`),this.updateElement("debugCameraPitch",`${this.state.cameraPitch.toFixed(1)}`),this.updateElement("debugCameraBearing",`${this.state.cameraBearing.toFixed(1)}`);const wt=document.getElementById("debugPhaseData");wt&&(this.state.currentPhaseData?wt.innerHTML=this.formatJSON(this.state.currentPhaseData):wt.textContent="-"),this.updateElement("debugTotalObjects",`${this.state.totalObjects}`),this.updateElement("debugTotalPhases",`${this.state.totalPhases}`),this.updateElement("debugFPS",`${this.state.fps}`),this.updateElement("debugMemory",`${this.state.memory}`)}updateElement(wt,vt,Lt){const Dt=document.getElementById(wt);Dt&&(Dt.textContent=vt,Lt&&(Dt.className=`debug-value ${Lt}`))}getStatusClass(){switch(this.state.flightStatus){case"FLYING":return"success";case"PAUSED":return"warning";case"ERROR":return"error";case"COMPLETED":return"info";default:return""}}formatTime(wt){const vt=Math.floor(wt/1e3),Lt=Math.floor(vt/3600),Dt=Math.floor(vt%3600/60),Ft=vt%60;return`${Lt.toString().padStart(2,"0")}:${Dt.toString().padStart(2,"0")}:${Ft.toString().padStart(2,"0")}`}escapeHtml(wt){return wt.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}formatJSON(wt){const vt=JSON.stringify(wt,null,2);return this.escapeHtml(vt).replace(/&quot;([^&]+)&quot;:/g,'<span class="key">&quot;$1&quot;</span>:').replace(/: &quot;([^&]*)&quot;/g,': <span class="string">&quot;$1&quot;</span>').replace(/([:,\[]\s*)(-?\d+\.?\d*)/g,'$1<span class="number">$2</span>').replace(/: (true|false)/g,': <span class="boolean">$1</span>').replace(/: null/g,': <span class="null">null</span>')}addEvent(wt,vt){const Lt=new Date,Dt=`${Lt.getHours().toString().padStart(2,"0")}:${Lt.getMinutes().toString().padStart(2,"0")}:${Lt.getSeconds().toString().padStart(2,"0")}`;this.events.unshift({time:Dt,type:wt,data:vt}),this.events.length>this.maxEvents&&(this.events=this.events.slice(0,this.maxEvents)),this.updateEventLog()}updateEventLog(){const wt=document.getElementById("debugEventLog");wt&&(wt.innerHTML=this.events.map(vt=>`
			<div class="debug-event">
				<span class="debug-event-time">${vt.time}</span>
				<span class="debug-event-type">${vt.type}</span>
				<span class="debug-event-data">${vt.data}</span>
			</div>
		`).join(""))}setFlightStatus(wt){this.state.flightStatus=wt,this.addEvent("STATUS",`Flight status changed to ${wt}`)}setCurrentPhase(wt,vt,Lt){this.state.currentPhase=wt.phase,this.state.phaseIndex=vt+1,this.state.totalPhases=Lt,this.state.currentPhaseData=wt,this.addEvent("PHASE",`${wt.phase}: ${wt.action}`)}setTotalObjects(wt){this.state.totalObjects=wt}setTotalPhases(wt){this.state.totalPhases=wt}logEvent(wt,vt){this.addEvent(wt,vt)}isEnabled(){return this.state.isEnabled}destroy(){this.stopUpdateLoop(),this.removeEventListeners(),this.events=[],this.map=null,this.droneModel=null,this.flightController=null,this.overlay=null,this.toggleBtn=null,this.closeBtn=null,this.debugModeBtn=null}}const cp=NT(),y2=cp.provider==="mapbox"?Ab:iv;cp.provider==="mapbox"?cp.mapboxAccessToken?(Ab.accessToken=cp.mapboxAccessToken,console.log("[OK] Mapbox GL ")):console.warn("[WARNING] Mapbox "):console.log("[OK] MapLibre GL ");const ov=window.IS_MOBILE_DEVICE||!1,x2={maxZoom:16,pitch:0,maxPitch:30,zoom:14,tileSize:512,enableTerrain:!1,terrainExaggeration:0,fadeDuration:0,enableDroneTrail:!1,pixelRatio:Math.min(window.devicePixelRatio,2),roundZoomLevel:!0,collectResourceTiming:!1},v2={maxZoom:18,pitch:60,maxPitch:85,zoom:15,tileSize:256,enableTerrain:!0,terrainExaggeration:1.2,fadeDuration:300,enableDroneTrail:!0},of=ov?x2:v2;console.log("=".repeat(60));console.log("");console.log(":",ov?"":"");console.log(":",of);console.log("=".repeat(60));const b2=`id,name,type,source,longitude,latitude,altitude,relativeAltitude,timestamp,duration,speed,heading,action,waypointId,sequenceNumber,batteryLevel,signalStrength,gpsAccuracy,temperature,humidity,windSpeed,windDirection,missionId,operatorId,aircraftModel,aircraftSerial,description
flight_001,1,waypoint,manual,139.7454,35.6586,100,50,2024-01-15T10:00:00Z,30,5,0,takeoff,1,1,85,-45,2,25,60,3,180,mission_001,operator_001,DJI_Mavic_3,SN001,
flight_002,2,waypoint,manual,139.7456,35.6588,120,70,2024-01-15T10:01:00Z,45,8,90,hover,2,2,82,-48,1.5,24,58,2.5,175,mission_001,operator_001,DJI_Mavic_3,SN001,
flight_003,3,waypoint,manual,139.7458,35.6590,150,100,2024-01-15T10:02:00Z,60,6,180,move,3,3,79,-50,2,23,55,3,170,mission_001,operator_001,DJI_Mavic_3,SN001,`,w2=`id,name,type,source,longitude,latitude,altitude,relativeAltitude,timestamp,duration,speed,heading,action,waypointId,sequenceNumber,batteryLevel,signalStrength,gpsAccuracy,temperature,humidity,windSpeed,windDirection,missionId,operatorId,aircraftModel,aircraftSerial,description
trajectory_001,1,trajectory_point,auto,139.7450,35.6580,50,0,2024-01-15T09:55:00Z,10,3,0,takeoff,1,1,90,-40,1,26,65,1,180,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_002,2,trajectory_point,auto,139.7452,35.6582,75,25,2024-01-15T09:56:00Z,15,5,45,move,2,2,88,-42,1.2,25,63,1.5,175,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_003,3,trajectory_point,auto,139.7454,35.6584,100,50,2024-01-15T09:57:00Z,20,7,90,move,3,3,85,-45,1.5,24,60,2,170,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_004,4,trajectory_point,auto,139.7456,35.6586,125,75,2024-01-15T09:58:00Z,25,6,135,move,4,4,82,-48,1.8,23,57,2.5,165,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_005,5,trajectory_point,auto,139.7458,35.6588,150,100,2024-01-15T09:59:00Z,30,4,180,land,5,5,79,-50,2,22,55,3,160,trajectory_001,operator_001,DJI_Mavic_3,SN001,`;window.addEventListener("error",$t=>{console.error(":",$t.error||$t.message),$t.preventDefault(),tx("",$t.error?.message||$t.message||"","error")});window.addEventListener("unhandledrejection",$t=>{console.error("Promise:",$t.reason),$t.preventDefault();const wt=$t.reason instanceof Error?$t.reason.message:String($t.reason||"");tx("",wt,"error")});function tx($t,wt,vt="error"){const Lt=vt==="error"?"rgba(244, 67, 54, 0.95)":"rgba(255, 193, 7, 0.95)",Dt=vt==="error"?"#fff":"#000",Ft=document.createElement("div");Ft.style.cssText=`
		position: fixed;
		top: 20px;
		right: 20px;
		background: ${Lt};
		color: ${Dt};
		padding: 16px 24px;
		border-radius: 8px;
		z-index: 10000;
		font-size: 14px;
		box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		max-width: 400px;
		cursor: pointer;
		animation: slideIn 0.3s ease-out;
	`,Ft.innerHTML=`
		<div style="font-weight: bold; margin-bottom: 4px;">${$t}</div>
		<div style="font-size: 12px; opacity: 0.9;">${wt}</div>
		<div style="font-size: 11px; margin-top: 8px; opacity: 0.7;"></div>
	`,Ft.addEventListener("click",()=>{Ft.style.transition="opacity 0.3s",Ft.style.opacity="0",setTimeout(()=>Ft.remove(),300)}),document.body.appendChild(Ft),setTimeout(()=>{Ft.parentElement&&(Ft.style.transition="opacity 0.5s",Ft.style.opacity="0",setTimeout(()=>Ft.remove(),500))},1e4)}console.log(" ...");let Ay;try{if(console.log("[START] DEM..."),typeof iv.addProtocol!="function")throw new Error("maplibregl.addProtocol MapLibre GL JS");const $t=u2("gsidem");console.log("[DEBUG] Protocol action created:",typeof $t),iv.addProtocol("gsidem",$t),console.log("[DEBUG] addProtocol called"),Ay={type:"raster-dem",tiles:["gsidem://https://tiles.gsj.jp/tiles/elev/mixed/{z}/{y}/{x}.png"],tileSize:256,encoding:"terrarium",minzoom:1,maxzoom:14,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},console.log("[SUCCESS] DEM"),console.log("[DEBUG] Terrain source tiles:",Ay.tiles)}catch($t){console.error("[ERROR] DEM:",$t),Ay={type:"raster-dem",tiles:["https://tiles.gsj.jp/tiles/elev/mixed/{z}/{y}/{x}.png"],tileSize:256,encoding:"terrarium",minzoom:1,maxzoom:14,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'};const wt=$t instanceof Error?$t.message:String($t);console.warn(` 
:`,wt),setTimeout(()=>{const vt=document.createElement("div");vt.style.cssText=`
			position: fixed;
			bottom: 80px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(255, 193, 7, 0.95);
			color: #000;
			padding: 12px 24px;
			border-radius: 8px;
			z-index: 10000;
			font-size: 14px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			max-width: 90%;
			text-align: center;
		`,vt.textContent=" ",document.body.appendChild(vt),setTimeout(()=>{vt.style.transition="opacity 0.5s",vt.style.opacity="0",setTimeout(()=>vt.remove(),500)},5e3)},1e3)}const ug={center:[139.7454,35.6586],zoom:15,pitch:60,bearing:0},lr=new y2.Map({container:"map",zoom:ug.zoom,center:ug.center,minZoom:5,maxZoom:18,pitch:ug.pitch,maxPitch:85,preserveDrawingBuffer:!0,refreshExpiredTiles:!1,fadeDuration:of.fadeDuration,trackResize:!0,...ov&&{maxTileCacheSize:50,renderWorldCopies:!1,crossSourceCollisions:!1,pixelRatio:of.pixelRatio,collectResourceTiming:!1,antialias:!1},style:{version:8,glyphs:"https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",sources:{seamlessphoto:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg"],maxzoom:18,tileSize:of.tileSize,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},...of.enableTerrain?{terrain:Ay}:{},"drone-objects":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"drone-connections":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"altitude-lines":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"drawing-polygon":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"selected-object":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"flight-plan-waypoints":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"flight-plan-path":{type:"geojson",data:{type:"FeatureCollection",features:[]}}},layers:[{id:"seamlessphoto",source:"seamlessphoto",type:"raster"}],...of.enableTerrain?{terrain:{source:"terrain",exaggeration:of.terrainExaggeration}}:{}}});lr.on("error",$t=>{console.error(":",$t);const wt=$t.error?.message||"";wt.includes("Failed to fetch")?(tx("","","warning"),xo(": ")):(tx("",wt,"error"),xo(`: ${wt}`))});console.log(" - load...");let Yn=[],Py=!0,rf=!1,nf=!1,su=!1,pa=null,Am=!1,p_=null,Ec=[],cg=null,Qx=!1,T2,hg,J0,d_,Of,Hc,rv=!1,Em=!1,sf=[],Pm=!1,hp=0,Qa=[],Bu="",My="";const nv=[{phase:"",action:"",duration:3e3,position:[139.7454,35.6586,100]},{phase:"1",action:"",duration:4e3,position:[139.7456,35.6588,150]},{phase:"2",action:"",duration:4e3,position:[139.7452,35.6588,150]},{phase:"3",action:"",duration:4e3,position:[139.7452,35.6584,150]},{phase:"4",action:"",duration:4e3,position:[139.7456,35.6584,150]},{phase:"1",action:"",duration:3e3,position:[139.7455,35.6587,120]},{phase:"2",action:"",duration:3e3,position:[139.7453,35.6587,120]},{phase:"3",action:"",duration:3e3,position:[139.7453,35.6585,120]},{phase:"4",action:"",duration:3e3,position:[139.7455,35.6585,120]},{phase:"",action:"",duration:5e3,position:[139.7454,35.6586,200]},{phase:"",action:"",duration:3e3,position:[139.7454,35.6586,0]}];Qa=nv;Bu="";My="";const Cr=($t,wt="info")=>{const vt=document.createElement("div");vt.style.cssText=`
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${wt==="success"?"rgba(34, 197, 94, 0.9)":wt==="error"?"rgba(239, 68, 68, 0.9)":"rgba(59, 130, 246, 0.9)"};
        backdrop-filter: blur(4px);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        max-width: 300px;
        word-wrap: break-word;
        border: 1px solid ${wt==="success"?"rgba(34, 197, 94, 0.3)":wt==="error"?"rgba(239, 68, 68, 0.3)":"rgba(59, 130, 246, 0.3)"};
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
    `,vt.textContent=$t,document.body.appendChild(vt),setTimeout(()=>{vt.style.transform="translateX(0)",vt.style.opacity="1"},100),setTimeout(()=>{vt.style.transform="translateX(100%)",vt.style.opacity="0",setTimeout(()=>{document.body.contains(vt)&&document.body.removeChild(vt)},300)},3e3)},Xr=($t,wt,vt,Lt="info",Dt,Ft)=>{const Pe={timestamp:new Date().toLocaleTimeString("ja-JP"),phase:$t,action:wt,details:vt,type:Lt,...Dt&&{position:Dt},...Ft&&{camera:Ft}};sf.push(Pe),pg(),sf.length>50&&(sf=sf.slice(-30))},pg=()=>{const $t=document.getElementById("flightStatus"),wt=document.getElementById("flightLog"),vt=document.getElementById("flightLogContainer");if(!(!$t||!wt||!vt)){if($t.innerHTML="",Pm&&Qa.length>0){const Lt=document.createElement("div");Lt.className="flight-status-bar",Lt.innerHTML=`
			<div class="status-indicator active">
				<span class="status-dot"></span>
				<span class="status-text"></span>
			</div>
			<div class="current-phase">
				<span class="phase-label">:</span>
				<span class="phase-name">${Qa[hp]?.phase||""}</span>
				<span class="phase-number">(${hp+1}/${Qa.length})</span>
			</div>
		`,$t.appendChild(Lt)}else if(Qa.length>0){const Lt=document.createElement("div");Lt.className="flight-status-bar",Lt.innerHTML=`
			<div class="status-indicator standby">
				<span class="status-dot"></span>
				<span class="status-text"></span>
			</div>
			<div class="current-phase">
				<span class="phase-label">:</span>
				<span class="phase-name">${Bu}</span>
			</div>
		`,$t.appendChild(Lt)}wt.innerHTML="",sf.forEach((Lt,Dt)=>{const Ft=document.createElement("div"),it=Dt===sf.length-1,i=Dt>=sf.length-3;Ft.className=`log-entry ${it?"log-entry-latest":""} ${i?"log-entry-recent":""}`;const Pe=document.createElement("span");Pe.className="log-timestamp",Pe.textContent=Lt.timestamp;const yi=document.createElement("span");yi.className="log-phase",yi.textContent=Lt.phase;const tr=document.createElement("span");tr.className=`log-action ${Lt.type}`,tr.textContent=Lt.action;const vn=document.createElement("span");if(vn.className="log-details",vn.textContent=Lt.details,it){const on=document.createElement("span");on.className="latest-indicator",on.textContent="",Ft.insertBefore(on,Ft.firstChild)}if(Ft.appendChild(Pe),Ft.appendChild(yi),Ft.appendChild(tr),Ft.appendChild(vn),Lt.position||Lt.camera){const on=document.createElement("div");if(on.className="log-extended-info",Lt.position){const Br=document.createElement("div");Br.className="log-position-info",Br.innerHTML=`
					<span class="info-label">:</span>
					<span class="info-value"> ${Lt.position.latitude.toFixed(6)}</span>
					<span class="info-value"> ${Lt.position.longitude.toFixed(6)}</span>
					<span class="info-value"> ${Lt.position.altitude.toFixed(1)}m</span>
				`,on.appendChild(Br)}if(Lt.camera){const Br=document.createElement("div");Br.className="log-camera-info",Br.innerHTML=`
					<span class="info-label">:</span>
					<span class="info-value"> ${Lt.camera.bearing.toFixed(1)}</span>
					<span class="info-value"> ${Lt.camera.pitch}</span>
					<span class="info-value"> ${Lt.camera.zoom}</span>
				`,on.appendChild(Br)}Ft.appendChild(on)}wt.appendChild(Ft)}),requestAnimationFrame(()=>{vt.scrollTo({top:vt.scrollHeight,behavior:"smooth"})})}},S2=()=>{sf=[],pg(),Xr("","","","info")},I2=()=>{const vt=`timestamp,phase,action,details,type,latitude,longitude,altitude,bearing,pitch,zoom
`+sf.map(it=>{const i=`${it.timestamp},${it.phase},${it.action},${it.details},${it.type}`,Pe=it.position?.latitude.toFixed(6)||"",yi=it.position?.longitude.toFixed(6)||"",tr=it.position?.altitude.toFixed(1)||"",vn=it.camera?.bearing.toFixed(1)||"",on=it.camera?.pitch||"",Br=it.camera?.zoom||"";return`${i},${Pe},${yi},${tr},${vn},${on},${Br}`}).join(`
`),Lt=new Blob([vt],{type:"text/csv"}),Dt=URL.createObjectURL(Lt),Ft=document.createElement("a");Ft.href=Dt,Ft.download=`tokyo_tower_flight_log_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.csv`,document.body.appendChild(Ft),Ft.click(),document.body.removeChild(Ft),URL.revokeObjectURL(Dt),Xr("","","CSV","success")},xo=$t=>{const wt=document.getElementById("status");wt&&(wt.textContent=$t),console.log("Status:",$t)},E2=()=>{of.enableDroneTrail&&lr.addLayer({id:"altitude-lines-layer",type:"line",source:"altitude-lines",paint:{"line-color":"#ffaa00","line-width":1,"line-opacity":.4}}),lr.addLayer({id:"polygon-fill-layer",type:"fill",source:"drone-objects",filter:["==",["get","type"],"polygon"],paint:{"fill-color":"#ff6b6b","fill-opacity":.3}}),lr.addLayer({id:"polygon-stroke-layer",type:"line",source:"drone-objects",filter:["==",["get","type"],"polygon"],paint:{"line-color":"#ff6b6b","line-width":2,"line-opacity":.8}}),lr.addLayer({id:"drone-objects-3d",type:"circle",source:"drone-objects",filter:["!=",["get","type"],"polygon"],paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,["interpolate",["linear"],["get","altitude"],50,3,300,8],18,["interpolate",["linear"],["get","altitude"],50,6,300,16]],"circle-color":["match",["get","type"],"drone","#ff4444","building","#44ff44","sensor","#4444ff","base","#ffaa00","weather","#ff44ff","manual","#888888","flight","#ff6b6b","#cccccc"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),lr.addLayer({id:"drone-objects-2d",type:"circle",source:"drone-objects",filter:["!=",["get","type"],"polygon"],layout:{visibility:"none"},paint:{"circle-radius":6,"circle-color":["match",["get","type"],"drone","#ff4444","building","#44ff44","sensor","#4444ff","base","#ffaa00","weather","#ff44ff","manual","#888888","flight","#ff6b6b","#cccccc"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),of.enableDroneTrail&&lr.addLayer({id:"drone-connections",type:"line",source:"drone-connections",paint:{"line-color":"#00ff00","line-width":2,"line-opacity":.7,"line-dasharray":[2,2]}}),lr.addLayer({id:"drone-labels",type:"symbol",source:"drone-objects",layout:{"text-field":["format",["get","name"],{},`
`,{},["concat",["to-string",["get","altitude"]],"m"],{"font-scale":.8}],"text-font":["Open Sans Regular","Arial Unicode MS Regular"],"text-size":12,"text-offset":[0,-2],"text-anchor":"bottom"},paint:{"text-color":"#ffffff","text-halo-color":"#000000","text-halo-width":1}}),lr.addLayer({id:"polygon-fill",type:"fill",source:"drawing-polygon",paint:{"fill-color":"#ff6b6b","fill-opacity":.3}}),lr.addLayer({id:"polygon-stroke",type:"line",source:"drawing-polygon",paint:{"line-color":"#ff6b6b","line-width":3,"line-opacity":.8}}),lr.addLayer({id:"polygon-points",type:"circle",source:"drawing-polygon",paint:{"circle-radius":6,"circle-color":"#ff6b6b","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),lr.addLayer({id:"selected-object-highlight",type:"fill",source:"selected-object",paint:{"fill-color":"#00ff00","fill-opacity":.2}}),lr.addLayer({id:"selected-object-stroke",type:"line",source:"selected-object",paint:{"line-color":"#00ff00","line-width":4,"line-opacity":.8}}),lr.addLayer({id:"selected-object-points",type:"circle",source:"selected-object",paint:{"circle-radius":8,"circle-color":"#00ff00","circle-stroke-width":3,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),lr.addLayer({id:"flight-plan-path-layer",type:"line",source:"flight-plan-path",paint:{"line-color":"#00ffff","line-width":3,"line-opacity":.8},layout:{"line-cap":"round","line-join":"round"}}),lr.addLayer({id:"flight-plan-waypoints-layer",type:"circle",source:"flight-plan-waypoints",paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,6,18,12],"circle-color":"#00ffff","circle-stroke-width":3,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),lr.addLayer({id:"flight-plan-waypoint-labels",type:"symbol",source:"flight-plan-waypoints",layout:{"text-field":["get","name"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":12,"text-offset":[0,-2],"text-anchor":"bottom"},paint:{"text-color":"#00ffff","text-halo-color":"#000000","text-halo-width":2}})},K0=$t=>{const wt=(Ft,it)=>{const i=lr.getSource(Ft);i?.type==="geojson"&&i.setData({type:"FeatureCollection",features:it})};if(!$t||$t.length===0){wt("flight-plan-waypoints",[]),wt("flight-plan-path",[]);return}const vt=$t.map((Ft,it)=>({type:"Feature",geometry:{type:"Point",coordinates:[Ft.position[0],Ft.position[1],Ft.position[2]]},properties:{id:`waypoint-${it}`,name:`WP${it+1}: ${Ft.phase}`,phase:Ft.phase,action:Ft.action,altitude:Ft.position[2],sequenceNumber:it+1}})),Lt=$t.map(Ft=>[Ft.position[0],Ft.position[1],Ft.position[2]]),Dt={type:"Feature",geometry:{type:"LineString",coordinates:Lt},properties:{id:"flight-path",name:"Flight Path"}};wt("flight-plan-waypoints",vt),wt("flight-plan-path",[Dt]),console.log(`: ${$t.length}: ${Lt.length}`)},rc=()=>{const $t=Yn.map(Lt=>{const Dt=Lt;if(Lt.type==="polygon"&&Dt.geometry){const Ft={type:"Feature",geometry:Dt.geometry,properties:{id:Lt.id,name:Lt.name,altitude:Lt.altitude,type:Lt.type,area:Dt.area||0}};return console.log(":",Ft),Ft}else return{type:"Feature",geometry:{type:"Point",coordinates:[Lt.longitude,Lt.latitude]},properties:{id:Lt.id,name:Lt.name,altitude:Lt.altitude,type:Lt.type}}});console.log("updateDisplay: :",$t);const wt={type:"FeatureCollection",features:$t};console.log("drone-objects:",wt),lr.getSource("drone-objects")?.setData(wt);const vt=Yn.map(Lt=>({type:"Feature",geometry:{type:"LineString",coordinates:[[Lt.longitude,Lt.latitude],[Lt.longitude,Lt.latitude]]},properties:{altitude:Lt.altitude}}));of.enableDroneTrail&&(lr.getSource("altitude-lines")?.setData({type:"FeatureCollection",features:vt}),A2()),console.log(`: ${Yn.length}`)},A2=()=>{if(Yn.length<2){lr.getSource("drone-connections")?.setData({type:"FeatureCollection",features:[]});return}const $t={};Yn.forEach(vt=>{$t[vt.type]||($t[vt.type]=[]),$t[vt.type].push(vt)});const wt=[];Object.values($t).forEach(vt=>{if(vt.length>=2){const Lt=vt.map(Dt=>[Dt.longitude,Dt.latitude]);wt.push({type:"Feature",geometry:{type:"LineString",coordinates:Lt},properties:{type:"connection"}})}}),lr.getSource("drone-connections")?.setData({type:"FeatureCollection",features:wt})},P2=$t=>{const wt=[$t.lng,$t.lat];if(Ec.length>=3){const vt=Ec[0];if(Math.sqrt(Math.pow((wt[0]-vt[0])*111e3,2)+Math.pow((wt[1]-vt[1])*111e3,2))<100){C2();return}}Ec.push(wt),M2(),Cr(`${Ec.length} (${Ec.length>=3?"":""})`,"info")},M2=()=>{const $t=[];if(Ec.forEach((wt,vt)=>{const Lt={type:"Feature",geometry:{type:"Point",coordinates:wt},properties:{index:vt,isFirst:vt===0}};$t.push(Lt)}),Ec.length>=2){const wt=[...Ec];Ec.length>=3&&wt.push(Ec[0]),$t.push({type:"Feature",geometry:{type:"LineString",coordinates:wt},properties:{type:"drawing-line"}})}lr.getSource("drawing-polygon").setData({type:"FeatureCollection",features:$t})},C2=()=>{if(Ec.length<3){Cr("3","warning");return}const $t=[...Ec,Ec[0]],wt=D2(Ec),vt={id:`polygon_${Date.now()}`,name:`_${Yn.filter(Lt=>Lt.type==="polygon").length+1}`,longitude:Ec[0][0],latitude:Ec[0][1],altitude:0,type:"polygon",source:"polygon_draw",geometry:{type:"Polygon",coordinates:[$t]},area:wt};Yn.push(vt),console.log(":",vt),console.log("loadedObjects:",Yn),Q0(),rc(),Cr(`${vt.name} (: ${wt.toFixed(0)})`,"success")},D2=$t=>{let wt=0;const vt=$t.length;for(let Dt=0;Dt<vt;Dt++){const Ft=(Dt+1)%vt;wt+=$t[Dt][0]*$t[Ft][1],wt-=$t[Ft][0]*$t[Dt][1]}wt=Math.abs(wt)/2;const Lt=111e3;return wt*Lt*Lt},Q0=()=>{Ec=[],lr.getSource("drawing-polygon").setData({type:"FeatureCollection",features:[]})},z2=$t=>{const wt=lr.project($t),vt=20;let Lt=null,Dt=1/0;return Yn.forEach(Ft=>{const it=lr.project([Ft.longitude,Ft.latitude]),i=Math.sqrt(Math.pow(wt.x-it.x,2)+Math.pow(wt.y-it.y,2));i<vt&&i<Dt&&(Dt=i,Lt=Ft)}),Lt?(pa=Lt,sv(),Cr(`${Lt.name}`,"info"),!0):(Cy(),!1)},Cy=()=>{pa=null,sv()},sv=()=>{if(!pa){lr.getSource("selected-object").setData({type:"FeatureCollection",features:[]});return}const $t=[];if(pa.type==="polygon"){const wt=pa;wt.geometry&&wt.geometry.coordinates&&($t.push({type:"Feature",geometry:wt.geometry,properties:{id:pa.id,type:"selected-polygon"}}),wt.geometry.coordinates[0].slice(0,-1).forEach((vt,Lt)=>{$t.push({type:"Feature",geometry:{type:"Point",coordinates:vt},properties:{id:pa.id,type:"selected-vertex",vertexIndex:Lt}})}))}else $t.push({type:"Feature",geometry:{type:"Point",coordinates:[pa.longitude,pa.latitude]},properties:{id:pa.id,type:"selected-point"}});lr.getSource("selected-object").setData({type:"FeatureCollection",features:$t})},L2=()=>{lr.dragPan.disable(),lr.scrollZoom.disable(),lr.boxZoom.disable(),lr.dragRotate.disable(),lr.keyboard.disable(),lr.doubleClickZoom.disable(),lr.touchZoomRotate.disable()},R2=()=>{lr.dragPan.enable(),lr.scrollZoom.enable(),lr.boxZoom.enable(),lr.dragRotate.enable(),lr.keyboard.enable(),lr.doubleClickZoom.enable(),lr.touchZoomRotate.enable()},k2=$t=>pa?(Am=!0,p_=[$t.lng,$t.lat],lr.getCanvas().style.cursor="grabbing",L2(),!0):!1,F2=$t=>{if(!Am||!pa||!p_)return;const wt=$t.lng-p_[0],vt=$t.lat-p_[1];if(pa.type==="polygon"){const Lt=pa;Lt.geometry&&Lt.geometry.coordinates&&(Lt.geometry.coordinates[0]=Lt.geometry.coordinates[0].map(Dt=>[Dt[0]+wt,Dt[1]+vt]))}pa.longitude+=wt,pa.latitude+=vt,p_=[$t.lng,$t.lat],rc(),sv()},Mb=()=>{Am&&pa&&(Am=!1,p_=null,lr.getCanvas().style.cursor=su?"crosshair":"",R2(),Cr(`${pa.name}`,"success"))},B2=()=>{if(!pa){Cr("","warning");return}const $t=pa.name;confirm(`${$t}`)&&(Yn=Yn.filter(vt=>vt.id!==pa.id),Cy(),rc(),Cr(`${$t}`,"success"))},O2=$t=>{const wt={id:`manual_${Date.now()}`,name:`_${Yn.filter(vt=>vt.type==="manual").length+1}`,longitude:$t.lng,latitude:$t.lat,altitude:150+Math.random()*100,type:"manual",source:"manual_draw"};Yn.push(wt),rc(),Cr(`: ${wt.name}`,"success")},N2=()=>{Py=!Py,Py?(lr.easeTo({pitch:60,duration:1e3}),lr.setLayoutProperty("drone-objects-3d","visibility","visible"),lr.setLayoutProperty("drone-objects-2d","visibility","none"),xo("3D")):(lr.easeTo({pitch:0,duration:1e3}),lr.setLayoutProperty("drone-objects-3d","visibility","none"),lr.setLayoutProperty("drone-objects-2d","visibility","visible"),xo("2D"))},V2=()=>{document.getElementById("loadPoints")?.addEventListener("click",async()=>{try{const vt=await fetch("./data/mock-3d-data.csv");if(!vt.ok)throw new Error(`HTTP error! status: ${vt.status}`);const Lt=await vt.text(),Dt=new Blob([Lt],{type:"text/csv"}),Ft=new File([Dt],"sample-points.csv",{type:"text/csv"});await W0(Ft,lr,"points"),Cr("","success")}catch(vt){console.error(":",vt),Cr("","error")}}),document.getElementById("loadMesh")?.addEventListener("click",async()=>{try{const vt=await fetch("./data/mock-mesh-data.csv");if(!vt.ok)throw new Error(`HTTP error! status: ${vt.status}`);const Lt=await vt.text(),Dt=new Blob([Lt],{type:"text/csv"}),Ft=new File([Dt],"sample-mesh.csv",{type:"text/csv"});await W0(Ft,lr,"mesh"),Cr("","success")}catch(vt){console.error(":",vt),Cr("","error")}}),document.getElementById("loadBuilding")?.addEventListener("click",async()=>{try{console.log("");const[vt,Lt]=await Promise.all([fetch("./data/mock-building-inspection-points.csv"),fetch("./data/mock-building-inspection-mesh.csv")]);if(console.log(":",{points:{ok:vt.ok,status:vt.status},mesh:{ok:Lt.ok,status:Lt.status}}),!vt.ok||!Lt.ok)throw new Error(`: HTTP error! status: points=${vt.status}, mesh=${Lt.status}`);const[Dt,Ft]=await Promise.all([vt.text(),Lt.text()]);console.log("CSV:",{pointsLength:Dt.length,meshLength:Ft.length,pointsPreview:Dt.substring(0,200),meshPreview:Ft.substring(0,200)});const it=new Blob([Dt],{type:"text/csv"}),i=new File([it],"building-points.csv",{type:"text/csv"});await W0(i,lr,"building-inspection");const Pe=new Blob([Ft],{type:"text/csv"}),yi=new File([Pe],"building-mesh.csv",{type:"text/csv"});await W0(yi,lr,"building-inspection-mesh"),Cr("","success")}catch(vt){console.error(":",vt),Cr(`: ${vt instanceof Error?vt.message:""}`,"error")}}),document.getElementById("loadDroneData")?.addEventListener("click",()=>{if(Qx)Cr("","info");else{const vt=n2([139.7454,35.6586]);Yn.push(...vt),rc(),Qx=!0,xo(`: ${vt.length}`),Cr("","success")}}),document.getElementById("startSimulation")?.addEventListener("click",()=>{if(cg){clearInterval(cg),cg=null,xo("");return}if(Yn.length===0){Cr("","error");return}xo(""),cg=setInterval(()=>{Yn.forEach(vt=>{vt.type==="drone"&&(vt.longitude+=(Math.random()-.5)*2e-4,vt.latitude+=(Math.random()-.5)*2e-4,vt.altitude+=(Math.random()-.5)*10,vt.altitude=Math.max(50,Math.min(400,vt.altitude)))}),rc()},1e3)}),document.getElementById("toggleDrawMode")?.addEventListener("click",()=>{if(rf=!rf,rf){nf=!1;const Lt=document.getElementById("togglePolygonMode");Lt&&(Lt.textContent=""),Q0()}const vt=document.getElementById("toggleDrawMode");vt&&(vt.textContent=rf?"":""),lr.getCanvas().style.cursor=rf?"crosshair":"",xo(rf?" - ":""),Cr(rf?"":"","info")}),document.getElementById("togglePolygonMode")?.addEventListener("click",()=>{if(nf=!nf,nf){rf=!1;const Lt=document.getElementById("toggleDrawMode");Lt&&(Lt.textContent="")}else Q0();const vt=document.getElementById("togglePolygonMode");vt&&(vt.textContent=nf?"":""),lr.getCanvas().style.cursor=nf?"crosshair":"",xo(nf?" - ":""),Cr(nf?"":"","info")}),document.getElementById("toggleEditMode")?.addEventListener("click",()=>{if(su=!su,su){rf=!1,nf=!1;const Lt=document.getElementById("toggleDrawMode"),Dt=document.getElementById("togglePolygonMode");Lt&&(Lt.textContent=""),Dt&&(Dt.textContent=""),Q0()}else Cy();const vt=document.getElementById("toggleEditMode");vt&&(vt.textContent=su?"":""),lr.getCanvas().style.cursor=su?"crosshair":"",xo(su?" - Delete":""),Cr(su?"":"","info")}),document.getElementById("importCSV")?.addEventListener("click",()=>{const vt=document.createElement("input");vt.type="file",vt.accept=".csv",vt.onchange=async Lt=>{const Dt=Lt.target.files?.[0];if(Dt)try{xo("CSV...");const Ft=await Dt.text(),it=KT(Ft,Dt.name);it.length>0?(Yn.push(...it),rc(),xo(`CSV: ${it.length}`),Cr(`CSV${it.length}`,"success"),Xr("","CSV",`${Dt.name}${it.length}`,"success")):(Cr("CSV","warning"),Xr("","CSV","CSV","warning"))}catch(Ft){console.error("CSV:",Ft),Cr("CSV","error"),Xr("","CSV",`${Dt.name}`,"error"),xo("CSV")}},vt.click()}),document.getElementById("importGeoJSON")?.addEventListener("click",()=>{const vt=document.createElement("input");vt.type="file",vt.accept=".geojson,.json",vt.onchange=async Lt=>{const Dt=Lt.target.files?.[0];if(Dt)try{xo("GeoJSON...");const Ft=await Dt.text(),it=QT(Ft,Dt.name);it.length>0?(Yn.push(...it),rc(),xo(`GeoJSON: ${it.length}`),Cr(`GeoJSON${it.length}`,"success"),Xr("","GeoJSON",`${Dt.name}${it.length}`,"success")):(Cr("GeoJSON","warning"),Xr("","GeoJSON","GeoJSON","warning"))}catch(Ft){console.error("GeoJSON:",Ft),Cr("GeoJSON","error"),Xr("","GeoJSON",`${Dt.name}`,"error"),xo("GeoJSON")}},vt.click()}),document.getElementById("exportCSV")?.addEventListener("click",()=>{if(Yn.length>0){const vt=t2(Yn);Im(vt,"tokyo_tower_drone_data.csv","text/csv"),xo("CSV"),Cr("CSV","success")}else Cr("","error")}),document.getElementById("exportGeoJSON")?.addEventListener("click",()=>{if(Yn.length>0){const vt=e2(Yn);Im(vt,"tokyo_tower_drone_data.geojson","application/geo+json"),xo("GeoJSON"),Cr("GeoJSON","success")}else Cr("","error")}),document.getElementById("clearData")?.addEventListener("click",()=>{Yn.length>0&&confirm(`${Yn.length}`)&&(Yn=[],rc(),JT(lr),Qx=!1,cg&&(clearInterval(cg),cg=null),xo(""),Cr("","info"))}),document.getElementById("toggle3D")?.addEventListener("click",()=>{N2();const vt=document.getElementById("toggle3D");vt&&(vt.textContent=Py?"2D":"3D"),Cr(Py?"3D":"2D","info")}),document.getElementById("clearLog")?.addEventListener("click",()=>{S2()}),document.getElementById("exportLog")?.addEventListener("click",()=>{I2()}),document.getElementById("startFlightPlan")?.addEventListener("click",()=>{yb()}),document.getElementById("pauseFlightPlan")?.addEventListener("click",()=>{tv()}),document.getElementById("exportFlightPlan")?.addEventListener("click",()=>{xb()}),document.getElementById("importFlightPlan")?.addEventListener("click",()=>{vb()}),document.getElementById("mobileFlightPlanToggle")?.addEventListener("click",()=>{const vt=document.getElementById("mobileFlightPlanModalOverlay");vt&&vt.classList.add("visible")}),document.getElementById("mobileFlightPlanModalClose")?.addEventListener("click",()=>{const vt=document.getElementById("mobileFlightPlanModalOverlay");vt&&vt.classList.remove("visible")}),document.getElementById("mobileFlightPlanModalOverlay")?.addEventListener("click",vt=>{if(vt.target===vt.currentTarget){const Lt=document.getElementById("mobileFlightPlanModalOverlay");Lt&&Lt.classList.remove("visible")}});const $t=document.getElementById("mobileFlightPlanSelect"),wt=document.getElementById("flightPlanSelect");$t&&wt&&($t.addEventListener("change",()=>{wt.value=$t.value;const vt=new Event("change",{bubbles:!0});wt.dispatchEvent(vt)}),wt.addEventListener("change",()=>{$t.value=wt.value})),document.getElementById("mobileStartFlightPlan")?.addEventListener("click",()=>{yb();const vt=document.getElementById("mobileFlightPlanModalOverlay");vt&&vt.classList.remove("visible")}),document.getElementById("mobilePauseFlightPlan")?.addEventListener("click",()=>{tv()}),document.getElementById("mobileEnableGameControl")?.addEventListener("click",()=>{const vt=document.getElementById("enableGameControl");vt&&vt.click();const Lt=document.getElementById("mobileFlightPlanModalOverlay");Lt&&Lt.classList.remove("visible")}),document.getElementById("mobileExportFlightPlan")?.addEventListener("click",()=>{xb()}),document.getElementById("mobileImportFlightPlan")?.addEventListener("click",()=>{vb()}),document.getElementById("mobileHomeButton")?.addEventListener("click",()=>{Pm&&tv(),lr.flyTo({center:ug.center,zoom:ug.zoom,pitch:ug.pitch,bearing:ug.bearing,duration:1500}),Cr("","success"),console.log(": ")}),document.getElementById("toggleLog")?.addEventListener("click",()=>{const vt=document.getElementById("flightLogContainer"),Lt=document.getElementById("toggleLog");if(console.log("Toggle"),console.log("FlightLogContainer:",vt),console.log("Toggle:",Lt),console.log("FlightLogContainer:",vt?.classList.contains("visible")),vt&&Lt){const Dt=vt.classList.contains("visible");console.log(":",Dt),Dt?(vt.classList.remove("visible"),vt.classList.add("hidden"),Lt.textContent="",Xr("","","","info"),console.log("")):(vt.classList.remove("hidden"),vt.classList.add("visible"),Lt.textContent="",Xr("","","","info"),console.log(""))}else console.error("FlightLogContainerToggle")}),document.getElementById("importFlightData")?.addEventListener("click",()=>{const vt=document.createElement("input");vt.type="file",vt.accept=".csv,.json,.geojson",vt.onchange=async Lt=>{const Dt=Lt.target.files?.[0];if(Dt)try{xo("...");const Ft=await Dt.text();let it=[];if(Dt.name.endsWith(".csv")?it=X0(Ft):(Dt.name.endsWith(".json")||Dt.name.endsWith(".geojson"))&&(it=_b(Ft)),it.length>0){const i=it.map(Pe=>H0(Pe));Yn.push(...i),rc(),xo(`: ${it.length}`),Cr(`${it.length}`,"success"),Xr("","",`${Dt.name}${it.length}`,"success")}else Cr("","warning"),Xr("","","","warning")}catch(Ft){console.error(":",Ft),Cr("","error"),Xr("","",`${Dt.name}`,"error"),xo("")}},vt.click()}),document.getElementById("importMission")?.addEventListener("click",()=>{const vt=document.createElement("input");vt.type="file",vt.accept=".json",vt.onchange=async Lt=>{const Dt=Lt.target.files?.[0];if(Dt)try{xo("...");const Ft=await Dt.text(),it=r2(Ft);if(it&&it.waypoints&&it.waypoints.length>0){const i=it.waypoints.map((yi,tr)=>({id:`mission_waypoint_${tr+1}`,name:`_${it.name}_WP${tr+1}`,longitude:yi.position.longitude,latitude:yi.position.latitude,altitude:yi.position.altitude,type:"flight",source:`mission_${Dt.name}`}));Yn.push(...i),rc(),xo(`: ${it.waypoints.length}`),Cr(`${it.name}${it.waypoints.length}`,"success"),Xr("","",`${it.name}: ${it.waypoints.length}`,"success");const Pe=it.waypoints[0];lr.flyTo({center:[Pe.position.longitude,Pe.position.latitude],zoom:16,duration:2e3})}else Cr("","warning"),Xr("","","","warning")}catch(Ft){console.error(":",Ft),Cr("","error"),Xr("","",`${Dt.name}`,"error"),xo("")}},vt.click()}),document.getElementById("loadSampleFlightData")?.addEventListener("click",async()=>{try{xo("...");const vt=X0(b2);if(vt.length>0){const Lt=vt.map(Dt=>H0(Dt));Yn.push(...Lt),rc(),xo(`: ${vt.length}`),Cr(`${vt.length}`,"success"),Xr("","",`${vt.length}`,"success")}else Cr("","error"),Xr("","","","error")}catch(vt){console.error(":",vt),Cr("","error"),Xr("","",`: ${vt instanceof Error?vt.message:""}`,"error"),xo("")}}),document.getElementById("loadSampleTrajectory")?.addEventListener("click",async()=>{try{xo("...");const vt=X0(w2);if(vt.length>0){const Lt=vt.filter(Ft=>Ft.timestamp).sort((Ft,it)=>new Date(Ft.timestamp).getTime()-new Date(it.timestamp).getTime()),Dt=Lt.map((Ft,it)=>{const i=H0(Ft);return i.name=`_${it+1}`,i.type="flight",i});if(Yn.push(...Dt),rc(),xo(`: ${Lt.length}`),Cr(`${Lt.length}`,"success"),Xr("","",`${Lt.length}`,"success"),Lt.length>0){const Ft=Lt[0];lr.flyTo({center:[Ft.position.longitude,Ft.position.latitude],zoom:16,duration:2e3})}}else Cr("","error"),Xr("","","","error")}catch(vt){console.error(":",vt),Cr("","error"),Xr("","",`: ${vt instanceof Error?vt.message:""}`,"error"),xo("")}}),document.getElementById("exportFlightData")?.addEventListener("click",()=>{if(Yn.length>0){const vt=Yn.map(Lt=>Kx(Lt));try{const Lt=mb(vt);Im(Lt,"unified_flight_data.csv","text/csv");const Dt=gb(vt);Im(Dt,"unified_flight_data.geojson","application/geo+json"),xo(""),Cr("CSVGeoJSON","success"),Xr("","",`${vt.length}`,"success")}catch(Lt){console.error(":",Lt),Cr("","error"),Xr("","","","error")}}else Cr("","warning"),Xr("","","","warning")}),document.getElementById("exportMission")?.addEventListener("click",()=>{if(Yn.length>0){const vt=Yn.filter(Lt=>Lt.type==="flight"||Lt.type==="drone");if(vt.length>0)try{const Lt=vt.map(Pe=>Kx(Pe));if(Lt.length===0)return;const Dt=Lt[0].position,Ft=jT("Generated_Mission",Lt,{longitude:Dt.longitude,latitude:Dt.latitude,altitude:Dt.altitude}),it=i2(Ft);Im(it,`flight_mission_${new Date().toISOString().slice(0,10)}.kml`,"application/vnd.google-earth.kml+xml");const i=JSON.stringify(Ft,null,2);Im(i,`flight_mission_${new Date().toISOString().slice(0,10)}.json`,"application/json"),xo(""),Cr("KMLJSON","success"),Xr("","",`${Ft.waypoints.length}`,"success")}catch(Lt){console.error(":",Lt),Cr("","error"),Xr("","","","error")}else Cr("","warning"),Xr("","","","warning")}else Cr("","warning"),Xr("","","","warning")}),document.getElementById("importTrajectory")?.addEventListener("click",()=>{const vt=document.createElement("input");vt.type="file",vt.accept=".csv,.json,.geojson",vt.onchange=async Lt=>{const Dt=Lt.target.files?.[0];if(Dt)try{xo("...");const Ft=await Dt.text();let it=[];Dt.name.endsWith(".csv")?it=X0(Ft):(Dt.name.endsWith(".json")||Dt.name.endsWith(".geojson"))&&(it=_b(Ft));const i=it.filter(Pe=>Pe.timestamp).sort((Pe,yi)=>new Date(Pe.timestamp).getTime()-new Date(yi.timestamp).getTime());if(i.length>0){const Pe=i.map((yi,tr)=>{const vn=H0(yi);return vn.name=`_${tr+1}`,vn.type="flight",vn});if(Yn.push(...Pe),rc(),xo(`: ${i.length}`),Cr(`${i.length}`,"success"),Xr("","",`${Dt.name}${i.length}`,"success"),i.length>0){const yi=i[0];lr.flyTo({center:[yi.position.longitude,yi.position.latitude],zoom:16,duration:2e3})}}else Cr("","warning"),Xr("","","","warning")}catch(Ft){console.error(":",Ft),Cr("","error"),Xr("","",`${Dt.name}`,"error"),xo("")}},vt.click()}),document.getElementById("exportTrajectory")?.addEventListener("click",()=>{if(Yn.length>0){const vt=Yn.filter(Lt=>Lt.type==="flight"||Lt.type==="drone");if(vt.length>0)try{const Lt=vt.map((it,i)=>{const Pe=Kx(it);return Pe.timestamp||(Pe.timestamp=new Date(Date.now()+i*1e4).toISOString()),Pe.type="trajectory_point",Pe}),Dt=mb(Lt);Im(Dt,"flight_trajectory.csv","text/csv");const Ft=gb(Lt);Im(Ft,"flight_trajectory.geojson","application/geo+json"),xo(""),Cr("CSVGeoJSON","success"),Xr("","",`${Lt.length}`,"success")}catch(Lt){console.error(":",Lt),Cr("","error"),Xr("","","","error")}else Cr("","warning"),Xr("","","","warning")}else Cr("","warning"),Xr("","","","warning")})},yb=()=>{if(Pm){Xr("","","","warning");return}if(Qa.length===0){Xr("","","","error");return}dg()&&Em&&(Of.disable(),Em=!1,Xr("","","","info")),rv&&(d_.disable(),Xr("","","","info")),Pm=!0,hp=0,Xr("","",`${Bu}`,"success"),pg(),Hc?.isEnabled()&&(Hc.setFlightStatus("FLYING"),Hc.setTotalPhases(Qa.length),Hc.logEvent("FLIGHT",`Started: ${Bu}`));let $t=Yn.find(wt=>wt.type==="drone");if($t)$t.name=`${Bu}`,$t.longitude=Qa[0].position[0],$t.latitude=Qa[0].position[1],$t.altitude=0;else{const wt={id:"inspection-drone-1",name:`${Bu}`,longitude:Qa[0].position[0],latitude:Qa[0].position[1],altitude:0,type:"drone",source:"flight-plan"};Yn.push(wt)}rc(),Cb()},Cb=()=>{if(!Pm||hp>=Qa.length){j2();return}const $t=Qa[hp],wt=Yn.find(Ft=>Ft.type==="drone");if(Hc?.isEnabled()&&Hc.setCurrentPhase($t,hp,Qa.length),!wt){Xr("","","","error");return}wt.longitude=$t.position[0],wt.latitude=$t.position[1],wt.altitude=$t.position[2];let vt=0;if(hp<Qa.length-1){const Ft=Qa[hp+1];vt=U2([$t.position[0],$t.position[1]],[Ft.position[0],Ft.position[1]])}else vt=$t.bearing??0;const Lt=$t.zoom??18,Dt=$t.pitch??70;Xr($t.phase,"",$t.action,"info",{latitude:wt.latitude,longitude:wt.longitude,altitude:wt.altitude},{bearing:Math.round(vt*100)/100,pitch:Dt,zoom:Lt}),lr.flyTo({center:[wt.longitude,wt.latitude],zoom:Lt,pitch:Dt,bearing:vt,duration:$t.duration}),rc(),setTimeout(()=>{hp++,pg(),Cb()},$t.duration)},U2=($t,wt)=>{const vt=$t[1]*Math.PI/180,Lt=$t[0]*Math.PI/180,Dt=wt[1]*Math.PI/180,Ft=wt[0]*Math.PI/180,it=Math.sin(Ft-Lt)*Math.cos(Dt),i=Math.cos(vt)*Math.sin(Dt)-Math.sin(vt)*Math.cos(Dt)*Math.cos(Ft-Lt);return(Math.atan2(it,i)*180/Math.PI+360)%360},tv=()=>{if(!Pm){Xr("","","","warning");return}Pm=!1,dg()&&Of&&(Of.enable(),Em=!0,console.log(": ")),Xr("","",`${hp+1}`,"warning"),pg(),Hc?.isEnabled()&&(Hc.setFlightStatus("PAUSED"),Hc.logEvent("PAUSE",`Paused at phase ${hp+1}`))},j2=()=>{Pm=!1,dg()&&Of&&(Of.enable(),Em=!0,console.log(": ")),Xr("","",`${Bu}`,"success"),pg(),Cr("","success"),Hc?.isEnabled()&&(Hc.setFlightStatus("COMPLETED"),Hc.logEvent("COMPLETE",`Finished: ${Bu}`))},xb=()=>{const $t={name:Bu,description:My,created:new Date().toISOString(),phases:Qa,totalDuration:Qa.reduce((Ft,it)=>Ft+it.duration,0)},wt=JSON.stringify($t,null,2),vt=new Blob([wt],{type:"application/json"}),Lt=URL.createObjectURL(vt),Dt=document.createElement("a");Dt.href=Lt,Dt.download=`${Bu.replace(/\s+/g,"_")}_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.json`,document.body.appendChild(Dt),Dt.click(),document.body.removeChild(Dt),URL.revokeObjectURL(Lt),Xr("","","JSON","success")},vb=()=>{const $t=document.createElement("input");$t.type="file",$t.accept=".json",$t.onchange=wt=>{const vt=wt.target.files?.[0];if(vt){const Lt=new FileReader;Lt.onload=Dt=>{try{const Ft=JSON.parse(Dt.target?.result);if(!Ft.name||!Ft.phases||!Array.isArray(Ft.phases))throw new Error("");if(Qa=Ft.phases,Bu=Ft.name,My=Ft.description||"",hg.setFlightPlan(Ft),K0(Ft.phases),Xr("","",`${Ft.name}`,"success"),Cr("","success"),Ft.phases.length>0){const it=Ft.phases[0].position;lr.flyTo({center:[it[0],it[1]],zoom:16,duration:2e3})}}catch{Xr("","","","error"),Cr("","error")}},Lt.readAsText(vt)}},$t.click()};lr.on("click",$t=>{Am||(nf?P2($t.lngLat):rf?O2($t.lngLat):su&&(z2($t.lngLat)||Cy()))});lr.on("mousedown",$t=>{if(su){const wt=lr.project($t.lngLat),vt=20;let Lt=!1;Yn.forEach(Dt=>{const Ft=lr.project([Dt.longitude,Dt.latitude]);Math.sqrt(Math.pow(wt.x-Ft.x,2)+Math.pow(wt.y-Ft.y,2))<vt&&(Lt=!0,pa&&pa.id===Dt.id&&(k2($t.lngLat),$t.preventDefault()))}),!Lt&&Am&&Mb()}});lr.on("mousemove",$t=>{su&&Am&&($t.preventDefault(),F2($t.lngLat))});lr.on("mouseup",$t=>{su&&Am&&($t.preventDefault(),Mb())});document.addEventListener("keydown",$t=>{($t.key==="Delete"||$t.key==="Backspace")&&su&&pa&&($t.preventDefault(),B2()),$t.key==="Escape"&&su&&Cy()});lr.on("webglcontextlost",$t=>{console.error("WebGL context lost:",$t),$t.preventDefault(),confirm(`

Map rendering issue detected. Reload page?`)&&window.location.reload()});lr.on("webglcontextrestored",()=>{console.log("WebGL context restored")});let ev=null;window.addEventListener("resize",()=>{ev&&clearTimeout(ev),ev=window.setTimeout(()=>{lr.resize(),console.log("Map resized for iOS Safari")},100)});window.addEventListener("orientationchange",()=>{setTimeout(()=>{lr.resize(),console.log("Map resized after orientation change")},300)});lr.on("error",$t=>{if(console.error("MapLibre GL error:",$t),$t.error&&$t.error.message&&$t.error.message.includes("tile")){console.warn("Tile loading error (non-critical):",$t.error.message);return}$t.error&&$t.error.message&&console.error("Critical map error:",$t.error.message)});lr.on("load",()=>{console.log('map.on("load") '),setTimeout(()=>{lr.resize(),console.log("Initial map resize for iOS Safari")},100);try{E2(),console.log("setupLayers() ")}catch(Or){console.error("setupLayers() :",Or),alert("")}try{V2(),console.log("setupEventHandlers() ")}catch(Or){console.error("setupEventHandlers() :",Or),alert("")}xo(" - "),console.log("");try{T2=new d2(lr,Ay),console.log("MapStyleManager"),hg=new p2(lr),hg.setLogUpdateCallback(Ri=>{sf=Ri,pg()}),console.log("FlightController"),J0=new f2(lr,[139.7454,35.6586,100]),console.log("DroneModel"),d_=new m2(lr,J0),console.log("GameController"),Of=new g2(lr,J0),console.log("TouchController"),Hc=new _2,Hc.setMap(lr),Hc.setDroneModel(J0),Hc.setFlightController(hg),console.log("DebugManager"),dg()&&(Of.enable(),Em=!0,console.log(": "));const Or={name:"",description:"",created:new Date().toISOString(),totalDuration:39e3,phases:nv};hg.setFlightPlan(Or),K0(Or.phases),Xr("","","","success")}catch(Or){console.error(":",Or),Xr("","","","error")}Xr("","","","success"),Xr("","","","info"),setTimeout(()=>{const Or=document.getElementById("flightLogContainer"),Ri=document.getElementById("toggleLog");Or&&Ri?(Or.classList.remove("hidden"),Or.classList.add("visible"),Ri.textContent="",console.log("")):console.error("FlightLogContainerToggle")},100);try{const Or=document.getElementById("flightPlanSelect");Or&&Or.addEventListener("change",async Io=>{const gr=Io.target.value;if(gr==="custom"){const Yr=document.getElementById("importFlightPlan");Yr&&Yr.click();return}try{const Yr={"mt-fuji":"./data/mt-fuji-flight-plan.json","tokyo-skytree":"./data/tokyo-skytree-flight-plan.json","kyoto-kinkakuji":"./data/kyoto-kinkakuji-flight-plan.json"};if(gr==="tokyo-tower"){const Fn={name:"",description:"",created:new Date().toISOString(),totalDuration:39e3,phases:nv};Qa=Fn.phases,Bu=Fn.name,My=Fn.description;const us=Yn.find(ao=>ao.type==="drone");us&&(us.name=`${Fn.name}`,rc()),hg.setFlightPlan(Fn),K0(Fn.phases),Cr("","success"),lr.flyTo({center:[139.7454,35.6586],zoom:16,pitch:60,bearing:0,duration:2e3})}else{const Fn=Yr[gr];if(!Fn){Cr("","error");return}const us=await fetch(Fn);if(!us.ok)throw new Error("");const ao=await us.json();Qa=ao.phases,Bu=ao.name,My=ao.description;const Do=Yn.find(fa=>fa.type==="drone");Do&&(Do.name=`${ao.name}`,rc()),hg.setFlightPlan(ao),K0(ao.phases),Cr(`${ao.name}`,"success");const tl=ao.phases[0].position;lr.flyTo({center:[tl[0],tl[1]],zoom:ao.phases[0].zoom||16,pitch:ao.phases[0].pitch||60,bearing:ao.phases[0].bearing||0,duration:2e3})}}catch(Yr){console.error(":",Yr);const Fn=Yr instanceof Error?Yr.message:"Unknown error";Cr(`: ${Fn}`,"error"),Xr("","",`${Fn}`,"error")}});const Ri=document.getElementById("enableGameControl");Ri&&Ri.addEventListener("click",()=>{if(!d_){Cr("","error");return}d_.enable(),rv=!0,dg()&&(Of.enable(),Em=!0);const Io=document.getElementById("gameControlHelp");Io&&(Io.style.display="block");const gr=dg()?"":"/";Cr("","success"),Xr("","",`${gr}`,"info"),Ri.style.opacity="0.5",Ri.style.cursor="not-allowed"});const Ve=document.getElementById("disableGameControl");Ve&&Ve.addEventListener("click",()=>{if(!d_)return;d_.disable(),rv=!1;const Io=document.getElementById("gameControlHelp");Io&&(Io.style.display="none"),Cr("","info"),Xr("","","","info");const gr=document.getElementById("enableGameControl");gr&&(gr.style.opacity="1",gr.style.cursor="pointer"),dg()&&Em&&(Of.disable(),Em=!1)})}catch(Or){console.error(":",Or),console.error("")}const $t=document.getElementById("infoPanelToggle"),wt=document.getElementById("infoPanel");$t&&wt&&(localStorage.getItem("infoPanelVisible")==="false"&&(wt.classList.remove("visible"),$t.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
				<circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
				<path d="M12 16v-4m0-4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
			</svg>`),$t.addEventListener("click",()=>{const Ri=wt.classList.contains("visible");wt.classList.toggle("visible"),localStorage.setItem("infoPanelVisible",(!Ri).toString()),Ri?$t.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
					<path d="M12 16v-4m0-4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>`:$t.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>`}));const vt=document.getElementById("flightPlanToggle"),Lt=document.getElementById("flightPlanExport");vt&&Lt&&(localStorage.getItem("flightPlanVisible")==="false"&&(Lt.classList.remove("visible"),vt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
				<path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" fill="currentColor"/>
			</svg>`),vt.addEventListener("click",()=>{const Ri=Lt.classList.contains("visible");Lt.classList.toggle("visible"),localStorage.setItem("flightPlanVisible",(!Ri).toString()),Ri?vt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" fill="currentColor"/>
				</svg>`:vt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>`}));const Dt=document.getElementById("controlsToggle"),Ft=document.getElementById("controls");Dt&&Ft&&(localStorage.getItem("controlsVisible")==="true"&&(Ft.classList.add("visible"),Dt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
				<path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
			</svg>`),Dt.addEventListener("click",()=>{const Ri=Ft.classList.contains("visible");Ft.classList.toggle("visible"),localStorage.setItem("controlsVisible",(!Ri).toString()),Ri?Dt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
					<path d="M3 12h18M3 6h18M3 18h18" stroke-width="2" stroke-linecap="round"/>
				</svg>`:Dt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
					<path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
				</svg>`}));const it=document.getElementById("helpButton"),i=document.getElementById("helpModalOverlay"),Pe=document.getElementById("helpModalClose");it&&i&&it.addEventListener("click",()=>{i.classList.add("visible")}),Pe&&i&&(Pe.addEventListener("click",()=>{i.classList.remove("visible")}),i.addEventListener("click",Or=>{Or.target===i&&i.classList.remove("visible")}));const yi=document.getElementById("mapProviderSelect"),tr=document.getElementById("mapboxTokenSection"),vn=document.getElementById("mapboxTokenInput"),on=document.getElementById("saveMapboxToken"),Br=document.getElementById("currentProviderInfo");yi&&Br&&(yi.value=cp.provider,Br.innerHTML=`: <strong>${cp.provider==="mapbox"?"Mapbox GL":"MapLibre GL"}</strong>`,cp.provider==="mapbox"&&tr&&(tr.style.display="block",vn&&cp.mapboxAccessToken&&(vn.value=cp.mapboxAccessToken)),yi.addEventListener("change",Or=>{const Ri=Or.target.value;Ri==="mapbox"&&tr?tr.style.display="block":tr&&(tr.style.display="none"),Ri==="maplibre"&&(confirm(`MapLibre GL
`)?(db({provider:Ri}),location.reload()):(yi.value=cp.provider,cp.provider==="mapbox"&&tr&&(tr.style.display="block")))}),on&&vn&&on.addEventListener("click",()=>{const Or=vn.value.trim();if(!Or){alert("");return}if(!Or.startsWith("pk.")){alert(`Mapbox
pk.`);return}db({provider:"mapbox",mapboxAccessToken:Or}),location.reload()})),console.log('map.on("load") ')});function dg(){const $t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,wt=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),vt=window.innerWidth<=768;return $t&&wt||$t&&vt}
