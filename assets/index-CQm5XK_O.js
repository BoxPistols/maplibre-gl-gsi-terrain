var OT=Object.defineProperty;var NT=(jt,bt,Lt)=>bt in jt?OT(jt,bt,{enumerable:!0,configurable:!0,writable:!0,value:Lt}):jt[bt]=Lt;var Mi=(jt,bt,Lt)=>NT(jt,typeof bt!="symbol"?bt+"":bt,Lt);(function(){const bt=document.createElement("link").relList;if(bt&&bt.supports&&bt.supports("modulepreload"))return;for(const Dt of document.querySelectorAll('link[rel="modulepreload"]'))re(Dt);new MutationObserver(Dt=>{for(const qt of Dt)if(qt.type==="childList")for(const nt of qt.addedNodes)nt.tagName==="LINK"&&nt.rel==="modulepreload"&&re(nt)}).observe(document,{childList:!0,subtree:!0});function Lt(Dt){const qt={};return Dt.integrity&&(qt.integrity=Dt.integrity),Dt.referrerPolicy&&(qt.referrerPolicy=Dt.referrerPolicy),Dt.crossOrigin==="use-credentials"?qt.credentials="include":Dt.crossOrigin==="anonymous"?qt.credentials="omit":qt.credentials="same-origin",qt}function re(Dt){if(Dt.ep)return;Dt.ep=!0;const qt=Lt(Dt);fetch(Dt.href,qt)}})();var wb=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Tb(jt){return jt&&jt.__esModule&&Object.prototype.hasOwnProperty.call(jt,"default")?jt.default:jt}var Sb={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v5.13.0/LICENSE.txt
 */(function(jt,bt){(function(Lt,re){jt.exports=re()})(wb,function(){var Lt={},re={};function Dt(nt,i,Le){if(re[nt]=Le,nt==="index"){var wi="var sharedModule = {}; ("+re.shared+")(sharedModule); ("+re.worker+")(sharedModule);",nr={};return re.shared(nr),re.index(Lt,nr),typeof window<"u"&&Lt.setWorkerUrl(window.URL.createObjectURL(new Blob([wi],{type:"text/javascript"}))),Lt}}Dt("shared",["exports"],function(nt){function i(h,o,c,g){return new(c||(c=Promise))(function(x,T){function A(G){try{B(g.next(G))}catch(W){T(W)}}function z(G){try{B(g.throw(G))}catch(W){T(W)}}function B(G){var W;G.done?x(G.value):(W=G.value,W instanceof c?W:new c(function(Q){Q(W)})).then(A,z)}B((g=g.apply(h,o||[])).next())})}function Le(h,o){this.x=h,this.y=o}function wi(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var nr,bn;typeof SuppressedError=="function"&&SuppressedError,Le.prototype={clone(){return new Le(this.x,this.y)},add(h){return this.clone()._add(h)},sub(h){return this.clone()._sub(h)},multByPoint(h){return this.clone()._multByPoint(h)},divByPoint(h){return this.clone()._divByPoint(h)},mult(h){return this.clone()._mult(h)},div(h){return this.clone()._div(h)},rotate(h){return this.clone()._rotate(h)},rotateAround(h,o){return this.clone()._rotateAround(h,o)},matMult(h){return this.clone()._matMult(h)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(h){return this.x===h.x&&this.y===h.y},dist(h){return Math.sqrt(this.distSqr(h))},distSqr(h){const o=h.x-this.x,c=h.y-this.y;return o*o+c*c},angle(){return Math.atan2(this.y,this.x)},angleTo(h){return Math.atan2(this.y-h.y,this.x-h.x)},angleWith(h){return this.angleWithSep(h.x,h.y)},angleWithSep(h,o){return Math.atan2(this.x*o-this.y*h,this.x*h+this.y*o)},_matMult(h){const o=h[2]*this.x+h[3]*this.y;return this.x=h[0]*this.x+h[1]*this.y,this.y=o,this},_add(h){return this.x+=h.x,this.y+=h.y,this},_sub(h){return this.x-=h.x,this.y-=h.y,this},_mult(h){return this.x*=h,this.y*=h,this},_div(h){return this.x/=h,this.y/=h,this},_multByPoint(h){return this.x*=h.x,this.y*=h.y,this},_divByPoint(h){return this.x/=h.x,this.y/=h.y,this},_unit(){return this._div(this.mag()),this},_perp(){const h=this.y;return this.y=this.x,this.x=-h,this},_rotate(h){const o=Math.cos(h),c=Math.sin(h),g=c*this.x+o*this.y;return this.x=o*this.x-c*this.y,this.y=g,this},_rotateAround(h,o){const c=Math.cos(h),g=Math.sin(h),x=o.y+g*(this.x-o.x)+c*(this.y-o.y);return this.x=o.x+c*(this.x-o.x)-g*(this.y-o.y),this.y=x,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Le},Le.convert=function(h){if(h instanceof Le)return h;if(Array.isArray(h))return new Le(+h[0],+h[1]);if(h.x!==void 0&&h.y!==void 0)return new Le(+h.x,+h.y);throw new Error("Expected [x, y] or {x, y} point format")};var cn=function(){if(bn)return nr;function h(o,c,g,x){this.cx=3*o,this.bx=3*(g-o)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*c,this.by=3*(x-c)-this.cy,this.ay=1-this.cy-this.by,this.p1x=o,this.p1y=c,this.p2x=g,this.p2y=x}return bn=1,nr=h,h.prototype={sampleCurveX:function(o){return((this.ax*o+this.bx)*o+this.cx)*o},sampleCurveY:function(o){return((this.ay*o+this.by)*o+this.cy)*o},sampleCurveDerivativeX:function(o){return(3*this.ax*o+2*this.bx)*o+this.cx},solveCurveX:function(o,c){if(c===void 0&&(c=1e-6),o<0)return 0;if(o>1)return 1;for(var g=o,x=0;x<8;x++){var T=this.sampleCurveX(g)-o;if(Math.abs(T)<c)return g;var A=this.sampleCurveDerivativeX(g);if(Math.abs(A)<1e-6)break;g-=T/A}var z=0,B=1;for(g=o,x=0;x<20&&(T=this.sampleCurveX(g),!(Math.abs(T-o)<c));x++)o>T?z=g:B=g,g=.5*(B-z)+z;return g},solve:function(o,c){return this.sampleCurveY(this.solveCurveX(o,c))}},nr}(),Rr=wi(cn);let xr,Ci;function Re(){return xr==null&&(xr=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),xr}function Rn(){if(Ci==null&&(Ci=!1,Re())){const o=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(o){for(let g=0;g<5*5;g++){const x=4*g;o.fillStyle=`rgb(${x},${x+1},${x+2})`,o.fillRect(g%5,Math.floor(g/5),1,1)}const c=o.getImageData(0,0,5,5).data;for(let g=0;g<5*5*4;g++)if(g%4!=3&&c[g]!==g){Ci=!0;break}}}return Ci||!1}var pr=1e-6,$r=typeof Float32Array<"u"?Float32Array:Array;function En(){var h=new $r(9);return $r!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[5]=0,h[6]=0,h[7]=0),h[0]=1,h[4]=1,h[8]=1,h}function $o(h){return h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}function no(){var h=new $r(3);return $r!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h}function bo(h){var o=h[0],c=h[1],g=h[2];return Math.sqrt(o*o+c*c+g*g)}function ba(h,o,c){var g=new $r(3);return g[0]=h,g[1]=o,g[2]=c,g}function Os(h,o,c){return h[0]=o[0]+c[0],h[1]=o[1]+c[1],h[2]=o[2]+c[2],h}function Ya(h,o,c){return h[0]=o[0]*c,h[1]=o[1]*c,h[2]=o[2]*c,h}function al(h,o,c){var g=o[0],x=o[1],T=o[2],A=c[0],z=c[1],B=c[2];return h[0]=x*B-T*z,h[1]=T*A-g*B,h[2]=g*z-x*A,h}var Ja,Hr=bo;function sc(h,o,c){var g=o[0],x=o[1],T=o[2],A=o[3];return h[0]=c[0]*g+c[4]*x+c[8]*T+c[12]*A,h[1]=c[1]*g+c[5]*x+c[9]*T+c[13]*A,h[2]=c[2]*g+c[6]*x+c[10]*T+c[14]*A,h[3]=c[3]*g+c[7]*x+c[11]*T+c[15]*A,h}function cs(){var h=new $r(4);return $r!=Float32Array&&(h[0]=0,h[1]=0,h[2]=0),h[3]=1,h}function Kn(h,o,c,g){var x=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"zyx",T=Math.PI/360;o*=T,g*=T,c*=T;var A=Math.sin(o),z=Math.cos(o),B=Math.sin(c),G=Math.cos(c),W=Math.sin(g),Q=Math.cos(g);switch(x){case"xyz":h[0]=A*G*Q+z*B*W,h[1]=z*B*Q-A*G*W,h[2]=z*G*W+A*B*Q,h[3]=z*G*Q-A*B*W;break;case"xzy":h[0]=A*G*Q-z*B*W,h[1]=z*B*Q-A*G*W,h[2]=z*G*W+A*B*Q,h[3]=z*G*Q+A*B*W;break;case"yxz":h[0]=A*G*Q+z*B*W,h[1]=z*B*Q-A*G*W,h[2]=z*G*W-A*B*Q,h[3]=z*G*Q+A*B*W;break;case"yzx":h[0]=A*G*Q+z*B*W,h[1]=z*B*Q+A*G*W,h[2]=z*G*W-A*B*Q,h[3]=z*G*Q-A*B*W;break;case"zxy":h[0]=A*G*Q-z*B*W,h[1]=z*B*Q+A*G*W,h[2]=z*G*W+A*B*Q,h[3]=z*G*Q-A*B*W;break;case"zyx":h[0]=A*G*Q-z*B*W,h[1]=z*B*Q+A*G*W,h[2]=z*G*W-A*B*Q,h[3]=z*G*Q+A*B*W;break;default:throw new Error("Unknown angle order "+x)}return h}function hn(){var h=new $r(2);return $r!=Float32Array&&(h[0]=0,h[1]=0),h}function Co(h,o){var c=new $r(2);return c[0]=h,c[1]=o,c}no(),Ja=new $r(4),$r!=Float32Array&&(Ja[0]=0,Ja[1]=0,Ja[2]=0,Ja[3]=0),no(),ba(1,0,0),ba(0,1,0),cs(),cs(),En(),hn();const zn=8192;function Ys(h,o,c){return o*(zn/(h.tileSize*Math.pow(2,c-h.tileID.overscaledZ)))}function vs(h,o){return(h%o+o)%o}function Ps(h,o,c){return h*(1-c)+o*c}function Hn(h){if(h<=0)return 0;if(h>=1)return 1;const o=h*h,c=o*h;return 4*(h<.5?c:3*(h-o)+c-.75)}function di(h,o,c,g){const x=new Rr(h,o,c,g);return T=>x.solve(T)}const tr=di(.25,.1,.25,1);function fr(h,o,c){return Math.min(c,Math.max(o,h))}function Wr(h,o,c){const g=c-o,x=((h-o)%g+g)%g+o;return x===o?c:x}function qr(h,...o){for(const c of o)for(const g in c)h[g]=c[g];return h}let Xi=1;function Xr(h,o,c){const g={};for(const x in h)g[x]=o.call(this,h[x],x,h);return g}function $n(h,o,c){const g={};for(const x in h)o.call(this,h[x],x,h)&&(g[x]=h[x]);return g}function qo(h){return Array.isArray(h)?h.map(qo):typeof h=="object"&&h?Xr(h,qo):h}const On={};function ho(h){On[h]||(typeof console<"u"&&console.warn(h),On[h]=!0)}function ds(h,o,c){return(c.y-h.y)*(o.x-h.x)>(o.y-h.y)*(c.x-h.x)}function Ns(h){return typeof WorkerGlobalScope<"u"&&h!==void 0&&h instanceof WorkerGlobalScope}let xo=null;function oo(h){return typeof ImageBitmap<"u"&&h instanceof ImageBitmap}const ll="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function $l(h,o,c,g,x){return i(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const T=new VideoFrame(h,{timestamp:0});try{const A=T==null?void 0:T.format;if(!A||!A.startsWith("BGR")&&!A.startsWith("RGB"))throw new Error(`Unrecognized format ${A}`);const z=A.startsWith("BGR"),B=new Uint8ClampedArray(g*x*4);if(yield T.copyTo(B,function(G,W,Q,ot,ct){const ut=4*Math.max(-W,0),xt=(Math.max(0,Q)-Q)*ot*4+ut,Et=4*ot,Vt=Math.max(0,W),ue=Math.max(0,Q);return{rect:{x:Vt,y:ue,width:Math.min(G.width,W+ot)-Vt,height:Math.min(G.height,Q+ct)-ue},layout:[{offset:xt,stride:Et}]}}(h,o,c,g,x)),z)for(let G=0;G<B.length;G+=4){const W=B[G];B[G]=B[G+2],B[G+2]=W}return B}finally{T.close()}})}let Ms,wa;function ql(h,o,c,g){return h.addEventListener(o,c,g),{unsubscribe:()=>{h.removeEventListener(o,c,g)}}}function bs(h){return h*Math.PI/180}function Cs(h){return h/Math.PI*180}const cl={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},Ml={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},Cl="AbortError";function Vs(){return new Error(Cl)}const hl={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Ka(h){return hl.REGISTERED_PROTOCOLS[h.substring(0,h.indexOf("://"))]}const Zl="global-dispatcher";class Da extends Error{constructor(o,c,g,x){super(`AJAXError: ${c} (${o}): ${g}`),this.status=o,this.statusText=c,this.url=g,this.body=x}}const so=()=>Ns(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,we=function(h,o){if(/:\/\//.test(h.url)&&!/^https?:|^file:/.test(h.url)){const g=Ka(h.url);if(g)return g(h,o);if(Ns(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,targetMapId:Zl},o)}if(!(/^file:/.test(c=h.url)||/^file:/.test(so())&&!/^\w+:/.test(c))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(g,x){return i(this,void 0,void 0,function*(){const T=new Request(g.url,{method:g.method||"GET",body:g.body,credentials:g.credentials,headers:g.headers,cache:g.cache,referrer:so(),signal:x.signal});let A,z;g.type!=="json"||T.headers.has("Accept")||T.headers.set("Accept","application/json");try{A=yield fetch(T)}catch(G){throw new Da(0,G.message,g.url,new Blob)}if(!A.ok){const G=yield A.blob();throw new Da(A.status,A.statusText,g.url,G)}z=g.type==="arrayBuffer"||g.type==="image"?A.arrayBuffer():g.type==="json"?A.json():A.text();const B=yield z;if(x.signal.aborted)throw Vs();return{data:B,cacheControl:A.headers.get("Cache-Control"),expires:A.headers.get("Expires")}})}(h,o);if(Ns(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:h,mustQueue:!0,targetMapId:Zl},o)}var c;return function(g,x){return new Promise((T,A)=>{var z;const B=new XMLHttpRequest;B.open(g.method||"GET",g.url,!0),g.type!=="arrayBuffer"&&g.type!=="image"||(B.responseType="arraybuffer");for(const G in g.headers)B.setRequestHeader(G,g.headers[G]);g.type==="json"&&(B.responseType="text",!((z=g.headers)===null||z===void 0)&&z.Accept||B.setRequestHeader("Accept","application/json")),B.withCredentials=g.credentials==="include",B.onerror=()=>{A(new Error(B.statusText))},B.onload=()=>{if(!x.signal.aborted)if((B.status>=200&&B.status<300||B.status===0)&&B.response!==null){let G=B.response;if(g.type==="json")try{G=JSON.parse(B.response)}catch(W){return void A(W)}T({data:G,cacheControl:B.getResponseHeader("Cache-Control"),expires:B.getResponseHeader("Expires")})}else{const G=new Blob([B.response],{type:B.getResponseHeader("Content-Type")});A(new Da(B.status,B.statusText,g.url,G))}},x.signal.addEventListener("abort",()=>{B.abort(),A(Vs())}),B.send(g.body)})}(h,o)};function St(h){if(!h||h.indexOf("://")<=0||h.indexOf("data:image/")===0||h.indexOf("blob:")===0)return!0;const o=new URL(h),c=window.location;return o.protocol===c.protocol&&o.host===c.host}function Pt(h,o,c){c[h]&&c[h].indexOf(o)!==-1||(c[h]=c[h]||[],c[h].push(o))}function Nt(h,o,c){if(c&&c[h]){const g=c[h].indexOf(o);g!==-1&&c[h].splice(g,1)}}class ce{constructor(o,c={}){qr(this,c),this.type=o}}class ae extends ce{constructor(o,c={}){super("error",qr({error:o},c))}}class Fe{on(o,c){return this._listeners=this._listeners||{},Pt(o,c,this._listeners),{unsubscribe:()=>{this.off(o,c)}}}off(o,c){return Nt(o,c,this._listeners),Nt(o,c,this._oneTimeListeners),this}once(o,c){return c?(this._oneTimeListeners=this._oneTimeListeners||{},Pt(o,c,this._oneTimeListeners),this):new Promise(g=>this.once(o,g))}fire(o,c){typeof o=="string"&&(o=new ce(o,c||{}));const g=o.type;if(this.listens(g)){o.target=this;const x=this._listeners&&this._listeners[g]?this._listeners[g].slice():[];for(const z of x)z.call(this,o);const T=this._oneTimeListeners&&this._oneTimeListeners[g]?this._oneTimeListeners[g].slice():[];for(const z of T)Nt(g,z,this._oneTimeListeners),z.call(this,o);const A=this._eventedParent;A&&(qr(o,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),A.fire(o))}else o instanceof ae&&console.error(o.error);return this}listens(o){return this._listeners&&this._listeners[o]&&this._listeners[o].length>0||this._oneTimeListeners&&this._oneTimeListeners[o]&&this._oneTimeListeners[o].length>0||this._eventedParent&&this._eventedParent.listens(o)}setEventedParent(o,c){return this._eventedParent=o,this._eventedParentData=c,this}}var Jt={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},"font-faces":{type:"array",value:"fontFaces"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},encoding:{type:"enum",values:{mvt:{},mlt:{}},default:"mvt"},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const De=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function We(h,o){const c={};for(const g in h)g!=="ref"&&(c[g]=h[g]);return De.forEach(g=>{g in o&&(c[g]=o[g])}),c}function ci(h,o){if(Array.isArray(h)){if(!Array.isArray(o)||h.length!==o.length)return!1;for(let c=0;c<h.length;c++)if(!ci(h[c],o[c]))return!1;return!0}if(typeof h=="object"&&h!==null&&o!==null){if(typeof o!="object"||Object.keys(h).length!==Object.keys(o).length)return!1;for(const c in h)if(!ci(h[c],o[c]))return!1;return!0}return h===o}function ui(h,o){h.push(o)}function cr(h,o,c){ui(c,{command:"addSource",args:[h,o[h]]})}function zr(h,o,c){ui(o,{command:"removeSource",args:[h]}),c[h]=!0}function Ae(h,o,c,g){zr(h,c,g),cr(h,o,c)}function Do(h,o,c){let g;for(g in h[c])if(Object.prototype.hasOwnProperty.call(h[c],g)&&g!=="data"&&!ci(h[c][g],o[c][g]))return!1;for(g in o[c])if(Object.prototype.hasOwnProperty.call(o[c],g)&&g!=="data"&&!ci(h[c][g],o[c][g]))return!1;return!0}function An(h,o,c,g,x,T){h=h||{},o=o||{};for(const A in h)Object.prototype.hasOwnProperty.call(h,A)&&(ci(h[A],o[A])||c.push({command:T,args:[g,A,o[A],x]}));for(const A in o)Object.prototype.hasOwnProperty.call(o,A)&&!Object.prototype.hasOwnProperty.call(h,A)&&(ci(h[A],o[A])||c.push({command:T,args:[g,A,o[A],x]}))}function Qn(h){return h.id}function ar(h,o){return h[o.id]=o,h}class bi{constructor(o,c,g,x){this.message=(o?`${o}: `:"")+g,x&&(this.identifier=x),c!=null&&c.__line__&&(this.line=c.__line__)}}function Zo(h,...o){for(const c of o)for(const g in c)h[g]=c[g];return h}class zo extends Error{constructor(o,c){super(c),this.message=c,this.key=o}}class se{constructor(o,c=[]){this.parent=o,this.bindings={};for(const[g,x]of c)this.bindings[g]=x}concat(o){return new se(this,o)}get(o){if(this.bindings[o])return this.bindings[o];if(this.parent)return this.parent.get(o);throw new Error(`${o} not found in scope.`)}has(o){return!!this.bindings[o]||!!this.parent&&this.parent.has(o)}}const st={kind:"null"},tt={kind:"number"},wt={kind:"string"},Bt={kind:"boolean"},Ht={kind:"color"},oe={kind:"projectionDefinition"},ye={kind:"object"},Yt={kind:"value"},xe={kind:"collator"},ti={kind:"formatted"},$e={kind:"padding"},Di={kind:"colorArray"},er={kind:"numberArray"},Ki={kind:"resolvedImage"},Hi={kind:"variableAnchorOffsetCollection"};function gr(h,o){return{kind:"array",itemType:h,N:o}}function Qi(h){if(h.kind==="array"){const o=Qi(h.itemType);return typeof h.N=="number"?`array<${o}, ${h.N}>`:h.itemType.kind==="value"?"array":`array<${o}>`}return h.kind}const Cn=[st,tt,wt,Bt,Ht,oe,ti,ye,gr(Yt),$e,er,Di,Ki,Hi];function Nn(h,o){if(o.kind==="error")return null;if(h.kind==="array"){if(o.kind==="array"&&(o.N===0&&o.itemType.kind==="value"||!Nn(h.itemType,o.itemType))&&(typeof h.N!="number"||h.N===o.N))return null}else{if(h.kind===o.kind)return null;if(h.kind==="value"){for(const c of Cn)if(!Nn(c,o))return null}}return`Expected ${Qi(h)} but found ${Qi(o)} instead.`}function Vo(h,o){return o.some(c=>c.kind===h.kind)}function Qr(h,o){return o.some(c=>c==="null"?h===null:c==="array"?Array.isArray(h):c==="object"?h&&!Array.isArray(h)&&typeof h=="object":c===typeof h)}function ao(h,o){return h.kind==="array"&&o.kind==="array"?h.itemType.kind===o.itemType.kind&&typeof h.N=="number":h.kind===o.kind}const gn=.96422,Ur=.82521,Wn=4/29,to=6/29,Dn=3*to*to,eo=to*to*to,ps=Math.PI/180,na=180/Math.PI;function Dl(h){return(h%=360)<0&&(h+=360),h}function Ih([h,o,c,g]){let x,T;const A=ul((.2225045*(h=hs(h))+.7168786*(o=hs(o))+.0606169*(c=hs(c)))/1);h===o&&o===c?x=T=A:(x=ul((.4360747*h+.3850649*o+.1430804*c)/gn),T=ul((.0139322*h+.0971045*o+.7141733*c)/Ur));const z=116*A-16;return[z<0?0:z,500*(x-A),200*(A-T),g]}function hs(h){return h<=.04045?h/12.92:Math.pow((h+.055)/1.055,2.4)}function ul(h){return h>eo?Math.pow(h,1/3):h/Dn+Wn}function Ta([h,o,c,g]){let x=(h+16)/116,T=isNaN(o)?x:x+o/500,A=isNaN(c)?x:x-c/200;return x=1*za(x),T=gn*za(T),A=Ur*za(A),[zl(3.1338561*T-1.6168667*x-.4906146*A),zl(-.9787684*T+1.9161415*x+.033454*A),zl(.0719453*T-.2289914*x+1.4052427*A),g]}function zl(h){return(h=h<=.00304?12.92*h:1.055*Math.pow(h,1/2.4)-.055)<0?0:h>1?1:h}function za(h){return h>to?h*h*h:Dn*(h-Wn)}const Qa=Object.hasOwn||function(h,o){return Object.prototype.hasOwnProperty.call(h,o)};function Hl(h,o){return Qa(h,o)?h[o]:void 0}function Eh(h){return parseInt(h.padEnd(2,h),16)/255}function Nu(h,o){return dl(o?h/100:h,0,1)}function dl(h,o,c){return Math.min(Math.max(o,h),c)}function La(h){return!h.some(Number.isNaN)}const ac={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function fs(h,o,c){return h+c*(o-h)}function Js(h,o,c){return h.map((g,x)=>fs(g,o[x],c))}class un{constructor(o,c,g,x=1,T=!0){this.r=o,this.g=c,this.b=g,this.a=x,T||(this.r*=x,this.g*=x,this.b*=x,x||this.overwriteGetter("rgb",[o,c,g,x]))}static parse(o){if(o instanceof un)return o;if(typeof o!="string")return;const c=function(g){if((g=g.toLowerCase().trim())==="transparent")return[0,0,0,0];const x=Hl(ac,g);if(x){const[A,z,B]=x;return[A/255,z/255,B/255,1]}if(g.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(g)){const A=g.length<6?1:2;let z=1;return[Eh(g.slice(z,z+=A)),Eh(g.slice(z,z+=A)),Eh(g.slice(z,z+=A)),Eh(g.slice(z,z+A)||"ff")]}if(g.startsWith("rgb")){const A=g.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(A){const[z,B,G,W,Q,ot,ct,ut,xt,Et,Vt,ue]=A,Qt=[W||" ",ct||" ",Et].join("");if(Qt==="  "||Qt==="  /"||Qt===",,"||Qt===",,,"){const ee=[G,ot,xt].join(""),Se=ee==="%%%"?100:ee===""?255:0;if(Se){const Ee=[dl(+B/Se,0,1),dl(+Q/Se,0,1),dl(+ut/Se,0,1),Vt?Nu(+Vt,ue):1];if(La(Ee))return Ee}}return}}const T=g.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(T){const[A,z,B,G,W,Q,ot,ct,ut]=T,xt=[B||" ",W||" ",ot].join("");if(xt==="  "||xt==="  /"||xt===",,"||xt===",,,"){const Et=[+z,dl(+G,0,100),dl(+Q,0,100),ct?Nu(+ct,ut):1];if(La(Et))return function([Vt,ue,Qt,ee]){function Se(Ee){const ei=(Ee+Vt/30)%12,Ii=ue*Math.min(Qt,1-Qt);return Qt-Ii*Math.max(-1,Math.min(ei-3,9-ei,1))}return Vt=Dl(Vt),ue/=100,Qt/=100,[Se(0),Se(8),Se(4),ee]}(Et)}}}(o);return c?new un(...c,!1):void 0}get rgb(){const{r:o,g:c,b:g,a:x}=this,T=x||1/0;return this.overwriteGetter("rgb",[o/T,c/T,g/T,x])}get hcl(){return this.overwriteGetter("hcl",function(o){const[c,g,x,T]=Ih(o),A=Math.sqrt(g*g+x*x);return[Math.round(1e4*A)?Dl(Math.atan2(x,g)*na):NaN,A,c,T]}(this.rgb))}get lab(){return this.overwriteGetter("lab",Ih(this.rgb))}overwriteGetter(o,c){return Object.defineProperty(this,o,{value:c}),c}toString(){const[o,c,g,x]=this.rgb;return`rgba(${[o,c,g].map(T=>Math.round(255*T)).join(",")},${x})`}static interpolate(o,c,g,x="rgb"){switch(x){case"rgb":{const[T,A,z,B]=Js(o.rgb,c.rgb,g);return new un(T,A,z,B,!1)}case"hcl":{const[T,A,z,B]=o.hcl,[G,W,Q,ot]=c.hcl;let ct,ut;if(isNaN(T)||isNaN(G))isNaN(T)?isNaN(G)?ct=NaN:(ct=G,z!==1&&z!==0||(ut=W)):(ct=T,Q!==1&&Q!==0||(ut=A));else{let Qt=G-T;G>T&&Qt>180?Qt-=360:G<T&&T-G>180&&(Qt+=360),ct=T+g*Qt}const[xt,Et,Vt,ue]=function([Qt,ee,Se,Ee]){return Qt=isNaN(Qt)?0:Qt*ps,Ta([Se,Math.cos(Qt)*ee,Math.sin(Qt)*ee,Ee])}([ct,ut??fs(A,W,g),fs(z,Q,g),fs(B,ot,g)]);return new un(xt,Et,Vt,ue,!1)}case"lab":{const[T,A,z,B]=Ta(Js(o.lab,c.lab,g));return new un(T,A,z,B,!1)}}}}un.black=new un(0,0,0,1),un.white=new un(1,1,1,1),un.transparent=new un(0,0,0,0),un.red=new un(1,0,0,1);class oa{constructor(o,c,g){this.sensitivity=o?c?"variant":"case":c?"accent":"base",this.locale=g,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(o,c){return this.collator.compare(o,c)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const Vn=["bottom","center","top"];class lc{constructor(o,c,g,x,T,A){this.text=o,this.image=c,this.scale=g,this.fontStack=x,this.textColor=T,this.verticalAlign=A}}class Uo{constructor(o){this.sections=o}static fromString(o){return new Uo([new lc(o,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(o=>o.text.length!==0||o.image&&o.image.name.length!==0)}static factory(o){return o instanceof Uo?o:Uo.fromString(o)}toString(){return this.sections.length===0?"":this.sections.map(o=>o.text).join("")}}class ms{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof ms)return o;if(typeof o=="number")return new ms([o,o,o,o]);if(Array.isArray(o)&&!(o.length<1||o.length>4)){for(const c of o)if(typeof c!="number")return;switch(o.length){case 1:o=[o[0],o[0],o[0],o[0]];break;case 2:o=[o[0],o[1],o[0],o[1]];break;case 3:o=[o[0],o[1],o[2],o[1]]}return new ms(o)}}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g){return new ms(Js(o.values,c.values,g))}}class sa{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof sa)return o;if(typeof o=="number")return new sa([o]);if(Array.isArray(o)){for(const c of o)if(typeof c!="number")return;return new sa(o)}}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g){return new sa(Js(o.values,c.values,g))}}class Us{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof Us)return o;if(typeof o=="string"){const g=un.parse(o);return g?new Us([g]):void 0}if(!Array.isArray(o))return;const c=[];for(const g of o){if(typeof g!="string")return;const x=un.parse(g);if(!x)return;c.push(x)}return new Us(c)}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g,x="rgb"){const T=[];if(o.values.length!=c.values.length)throw new Error(`colorArray: Arrays have mismatched length (${o.values.length} vs. ${c.values.length}), cannot interpolate.`);for(let A=0;A<o.values.length;A++)T.push(un.interpolate(o.values[A],c.values[A],g,x));return new Us(T)}}class Xn extends Error{constructor(o){super(o),this.name="RuntimeError"}toJSON(){return this.message}}const Vu=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Ds{constructor(o){this.values=o.slice()}static parse(o){if(o instanceof Ds)return o;if(Array.isArray(o)&&!(o.length<1)&&o.length%2==0){for(let c=0;c<o.length;c+=2){const g=o[c],x=o[c+1];if(typeof g!="string"||!Vu.has(g)||!Array.isArray(x)||x.length!==2||typeof x[0]!="number"||typeof x[1]!="number")return}return new Ds(o)}}toString(){return JSON.stringify(this.values)}static interpolate(o,c,g){const x=o.values,T=c.values;if(x.length!==T.length)throw new Xn(`Cannot interpolate values of different length. from: ${o.toString()}, to: ${c.toString()}`);const A=[];for(let z=0;z<x.length;z+=2){if(x[z]!==T[z])throw new Xn(`Cannot interpolate values containing mismatched anchors. from[${z}]: ${x[z]}, to[${z}]: ${T[z]}`);A.push(x[z]);const[B,G]=x[z+1],[W,Q]=T[z+1];A.push([fs(B,W,g),fs(G,Q,g)])}return new Ds(A)}}class js{constructor(o){this.name=o.name,this.available=o.available}toString(){return this.name}static fromString(o){return o?new js({name:o,available:!1}):null}}class aa{constructor(o,c,g){this.from=o,this.to=c,this.transition=g}static interpolate(o,c,g){return new aa(o,c,g)}static parse(o){return o instanceof aa?o:Array.isArray(o)&&o.length===3&&typeof o[0]=="string"&&typeof o[1]=="string"&&typeof o[2]=="number"?new aa(o[0],o[1],o[2]):typeof o=="object"&&typeof o.from=="string"&&typeof o.to=="string"&&typeof o.transition=="number"?new aa(o.from,o.to,o.transition):typeof o=="string"?new aa(o,o,1):void 0}}function Uu(h,o,c,g){return typeof h=="number"&&h>=0&&h<=255&&typeof o=="number"&&o>=0&&o<=255&&typeof c=="number"&&c>=0&&c<=255?g===void 0||typeof g=="number"&&g>=0&&g<=1?null:`Invalid rgba value [${[h,o,c,g].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof g=="number"?[h,o,c,g]:[h,o,c]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ll(h){if(h===null||typeof h=="string"||typeof h=="boolean"||typeof h=="number"||h instanceof aa||h instanceof un||h instanceof oa||h instanceof Uo||h instanceof ms||h instanceof sa||h instanceof Us||h instanceof Ds||h instanceof js)return!0;if(Array.isArray(h)){for(const o of h)if(!Ll(o))return!1;return!0}if(typeof h=="object"){for(const o in h)if(!Ll(h[o]))return!1;return!0}return!1}function vr(h){if(h===null)return st;if(typeof h=="string")return wt;if(typeof h=="boolean")return Bt;if(typeof h=="number")return tt;if(h instanceof un)return Ht;if(h instanceof aa)return oe;if(h instanceof oa)return xe;if(h instanceof Uo)return ti;if(h instanceof ms)return $e;if(h instanceof sa)return er;if(h instanceof Us)return Di;if(h instanceof Ds)return Hi;if(h instanceof js)return Ki;if(Array.isArray(h)){const o=h.length;let c;for(const g of h){const x=vr(g);if(c){if(c===x)continue;c=Yt;break}c=x}return gr(c||Yt,o)}return ye}function Ah(h){const o=typeof h;return h===null?"":o==="string"||o==="number"||o==="boolean"?String(h):h instanceof un||h instanceof aa||h instanceof Uo||h instanceof ms||h instanceof sa||h instanceof Us||h instanceof Ds||h instanceof js?h.toString():JSON.stringify(h)}class Wl{constructor(o,c){this.type=o,this.value=c}static parse(o,c){if(o.length!==2)return c.error(`'literal' expression requires exactly one argument, but found ${o.length-1} instead.`);if(!Ll(o[1]))return c.error("invalid value");const g=o[1];let x=vr(g);const T=c.expectedType;return x.kind!=="array"||x.N!==0||!T||T.kind!=="array"||typeof T.N=="number"&&T.N!==0||(x=T),new Wl(x,g)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const Yc={string:wt,number:tt,boolean:Bt,object:ye};class Ra{constructor(o,c){this.type=o,this.args=c}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");let g,x=1;const T=o[0];if(T==="array"){let z,B;if(o.length>2){const G=o[1];if(typeof G!="string"||!(G in Yc)||G==="object")return c.error('The item type argument of "array" must be one of string, number, boolean',1);z=Yc[G],x++}else z=Yt;if(o.length>3){if(o[2]!==null&&(typeof o[2]!="number"||o[2]<0||o[2]!==Math.floor(o[2])))return c.error('The length argument to "array" must be a positive integer literal',2);B=o[2],x++}g=gr(z,B)}else{if(!Yc[T])throw new Error(`Types doesn't contain name = ${T}`);g=Yc[T]}const A=[];for(;x<o.length;x++){const z=c.parse(o[x],x,Yt);if(!z)return null;A.push(z)}return new Ra(g,A)}evaluate(o){for(let c=0;c<this.args.length;c++){const g=this.args[c].evaluate(o);if(!Nn(this.type,vr(g)))return g;if(c===this.args.length-1)throw new Xn(`Expected value to be of type ${Qi(this.type)}, but found ${Qi(vr(g))} instead.`)}throw new Error}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every(o=>o.outputDefined())}}const ko={"to-boolean":Bt,"to-color":Ht,"to-number":tt,"to-string":wt};class pl{constructor(o,c){this.type=o,this.args=c}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");const g=o[0];if(!ko[g])throw new Error(`Can't parse ${g} as it is not part of the known types`);if((g==="to-boolean"||g==="to-string")&&o.length!==2)return c.error("Expected one argument.");const x=ko[g],T=[];for(let A=1;A<o.length;A++){const z=c.parse(o[A],A,Yt);if(!z)return null;T.push(z)}return new pl(x,T)}evaluate(o){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(o);case"color":{let c,g;for(const x of this.args){if(c=x.evaluate(o),g=null,c instanceof un)return c;if(typeof c=="string"){const T=o.parseColor(c);if(T)return T}else if(Array.isArray(c)&&(g=c.length<3||c.length>4?`Invalid rgba value ${JSON.stringify(c)}: expected an array containing either three or four numeric values.`:Uu(c[0],c[1],c[2],c[3]),!g))return new un(c[0]/255,c[1]/255,c[2]/255,c[3])}throw new Xn(g||`Could not parse color from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"padding":{let c;for(const g of this.args){c=g.evaluate(o);const x=ms.parse(c);if(x)return x}throw new Xn(`Could not parse padding from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"numberArray":{let c;for(const g of this.args){c=g.evaluate(o);const x=sa.parse(c);if(x)return x}throw new Xn(`Could not parse numberArray from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"colorArray":{let c;for(const g of this.args){c=g.evaluate(o);const x=Us.parse(c);if(x)return x}throw new Xn(`Could not parse colorArray from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"variableAnchorOffsetCollection":{let c;for(const g of this.args){c=g.evaluate(o);const x=Ds.parse(c);if(x)return x}throw new Xn(`Could not parse variableAnchorOffsetCollection from value '${typeof c=="string"?c:JSON.stringify(c)}'`)}case"number":{let c=null;for(const g of this.args){if(c=g.evaluate(o),c===null)return 0;const x=Number(c);if(!isNaN(x))return x}throw new Xn(`Could not convert ${JSON.stringify(c)} to number.`)}case"formatted":return Uo.fromString(Ah(this.args[0].evaluate(o)));case"resolvedImage":return js.fromString(Ah(this.args[0].evaluate(o)));case"projectionDefinition":return this.args[0].evaluate(o);default:return Ah(this.args[0].evaluate(o))}}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every(o=>o.outputDefined())}}const qn=["Unknown","Point","LineString","Polygon"];class rn{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?qn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(o){let c=this._parseColorCache.get(o);return c||(c=un.parse(o),this._parseColorCache.set(o,c)),c}}class lu{constructor(o,c,g=[],x,T=new se,A=[]){this.registry=o,this.path=g,this.key=g.map(z=>`[${z}]`).join(""),this.scope=T,this.errors=A,this.expectedType=x,this._isConstant=c}parse(o,c,g,x,T={}){return c?this.concat(c,g,x)._parse(o,T):this._parse(o,T)}_parse(o,c){function g(x,T,A){return A==="assert"?new Ra(T,[x]):A==="coerce"?new pl(T,[x]):x}if(o!==null&&typeof o!="string"&&typeof o!="boolean"&&typeof o!="number"||(o=["literal",o]),Array.isArray(o)){if(o.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const x=o[0];if(typeof x!="string")return this.error(`Expression name must be a string, but found ${typeof x} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const T=this.registry[x];if(T){let A=T.parse(o,this);if(!A)return null;if(this.expectedType){const z=this.expectedType,B=A.type;if(z.kind!=="string"&&z.kind!=="number"&&z.kind!=="boolean"&&z.kind!=="object"&&z.kind!=="array"||B.kind!=="value"){if(z.kind==="projectionDefinition"&&["string","array"].includes(B.kind)||["color","formatted","resolvedImage"].includes(z.kind)&&["value","string"].includes(B.kind)||["padding","numberArray"].includes(z.kind)&&["value","number","array"].includes(B.kind)||z.kind==="colorArray"&&["value","string","array"].includes(B.kind)||z.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(B.kind))A=g(A,z,c.typeAnnotation||"coerce");else if(this.checkSubtype(z,B))return null}else A=g(A,z,c.typeAnnotation||"assert")}if(!(A instanceof Wl)&&A.type.kind!=="resolvedImage"&&this._isConstant(A)){const z=new rn;try{A=new Wl(A.type,A.evaluate(z))}catch(B){return this.error(B.message),null}}return A}return this.error(`Unknown expression "${x}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(o===void 0?"'undefined' value invalid. Use null instead.":typeof o=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof o} instead.`)}concat(o,c,g){const x=typeof o=="number"?this.path.concat(o):this.path,T=g?this.scope.concat(g):this.scope;return new lu(this.registry,this._isConstant,x,c||null,T,this.errors)}error(o,...c){const g=`${this.key}${c.map(x=>`[${x}]`).join("")}`;this.errors.push(new zo(g,o))}checkSubtype(o,c){const g=Nn(o,c);return g&&this.error(g),g}}class Un{constructor(o,c){this.type=c.type,this.bindings=[].concat(o),this.result=c}evaluate(o){return this.result.evaluate(o)}eachChild(o){for(const c of this.bindings)o(c[1]);o(this.result)}static parse(o,c){if(o.length<4)return c.error(`Expected at least 3 arguments, but found ${o.length-1} instead.`);const g=[];for(let T=1;T<o.length-1;T+=2){const A=o[T];if(typeof A!="string")return c.error(`Expected string, but found ${typeof A} instead.`,T);if(/[^a-zA-Z0-9_]/.test(A))return c.error("Variable names must contain only alphanumeric characters or '_'.",T);const z=c.parse(o[T+1],T+1);if(!z)return null;g.push([A,z])}const x=c.parse(o[o.length-1],o.length-1,c.expectedType,g);return x?new Un(g,x):null}outputDefined(){return this.result.outputDefined()}}class ju{constructor(o,c){this.type=c.type,this.name=o,this.boundExpression=c}static parse(o,c){if(o.length!==2||typeof o[1]!="string")return c.error("'var' expression requires exactly one string literal argument.");const g=o[1];return c.scope.has(g)?new ju(g,c.scope.get(g)):c.error(`Unknown variable "${g}". Make sure "${g}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(o){return this.boundExpression.evaluate(o)}eachChild(){}outputDefined(){return!1}}class tl{constructor(o,c,g){this.type=o,this.index=c,this.input=g}static parse(o,c){if(o.length!==3)return c.error(`Expected 2 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,tt),x=c.parse(o[2],2,gr(c.expectedType||Yt));return g&&x?new tl(x.type.itemType,g,x):null}evaluate(o){const c=this.index.evaluate(o),g=this.input.evaluate(o);if(c<0)throw new Xn(`Array index out of bounds: ${c} < 0.`);if(c>=g.length)throw new Xn(`Array index out of bounds: ${c} > ${g.length-1}.`);if(c!==Math.floor(c))throw new Xn(`Array index must be an integer, but found ${c} instead.`);return g[c]}eachChild(o){o(this.index),o(this.input)}outputDefined(){return!1}}class Sa{constructor(o,c){this.type=Bt,this.needle=o,this.haystack=c}static parse(o,c){if(o.length!==3)return c.error(`Expected 2 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,Yt),x=c.parse(o[2],2,Yt);return g&&x?Vo(g.type,[Bt,wt,tt,st,Yt])?new Sa(g,x):c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Qi(g.type)} instead`):null}evaluate(o){const c=this.needle.evaluate(o),g=this.haystack.evaluate(o);if(!g)return!1;if(!Qr(c,["boolean","string","number","null"]))throw new Xn(`Expected first argument to be of type boolean, string, number or null, but found ${Qi(vr(c))} instead.`);if(!Qr(g,["string","array"]))throw new Xn(`Expected second argument to be of type array or string, but found ${Qi(vr(g))} instead.`);return g.indexOf(c)>=0}eachChild(o){o(this.needle),o(this.haystack)}outputDefined(){return!0}}class cc{constructor(o,c,g){this.type=tt,this.needle=o,this.haystack=c,this.fromIndex=g}static parse(o,c){if(o.length<=2||o.length>=5)return c.error(`Expected 2 or 3 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,Yt),x=c.parse(o[2],2,Yt);if(!g||!x)return null;if(!Vo(g.type,[Bt,wt,tt,st,Yt]))return c.error(`Expected first argument to be of type boolean, string, number or null, but found ${Qi(g.type)} instead`);if(o.length===4){const T=c.parse(o[3],3,tt);return T?new cc(g,x,T):null}return new cc(g,x)}evaluate(o){const c=this.needle.evaluate(o),g=this.haystack.evaluate(o);if(!Qr(c,["boolean","string","number","null"]))throw new Xn(`Expected first argument to be of type boolean, string, number or null, but found ${Qi(vr(c))} instead.`);let x;if(this.fromIndex&&(x=this.fromIndex.evaluate(o)),Qr(g,["string"])){const T=g.indexOf(c,x);return T===-1?-1:[...g.slice(0,T)].length}if(Qr(g,["array"]))return g.indexOf(c,x);throw new Xn(`Expected second argument to be of type array or string, but found ${Qi(vr(g))} instead.`)}eachChild(o){o(this.needle),o(this.haystack),this.fromIndex&&o(this.fromIndex)}outputDefined(){return!1}}class Jc{constructor(o,c,g,x,T,A){this.inputType=o,this.type=c,this.input=g,this.cases=x,this.outputs=T,this.otherwise=A}static parse(o,c){if(o.length<5)return c.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if(o.length%2!=1)return c.error("Expected an even number of arguments.");let g,x;c.expectedType&&c.expectedType.kind!=="value"&&(x=c.expectedType);const T={},A=[];for(let G=2;G<o.length-1;G+=2){let W=o[G];const Q=o[G+1];Array.isArray(W)||(W=[W]);const ot=c.concat(G);if(W.length===0)return ot.error("Expected at least one branch label.");for(const ut of W){if(typeof ut!="number"&&typeof ut!="string")return ot.error("Branch labels must be numbers or strings.");if(typeof ut=="number"&&Math.abs(ut)>Number.MAX_SAFE_INTEGER)return ot.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof ut=="number"&&Math.floor(ut)!==ut)return ot.error("Numeric branch labels must be integer values.");if(g){if(ot.checkSubtype(g,vr(ut)))return null}else g=vr(ut);if(T[String(ut)]!==void 0)return ot.error("Branch labels must be unique.");T[String(ut)]=A.length}const ct=c.parse(Q,G,x);if(!ct)return null;x=x||ct.type,A.push(ct)}const z=c.parse(o[1],1,Yt);if(!z)return null;const B=c.parse(o[o.length-1],o.length-1,x);return B?z.type.kind!=="value"&&c.concat(1).checkSubtype(g,z.type)?null:new Jc(g,x,z,T,A,B):null}evaluate(o){const c=this.input.evaluate(o);return(vr(c)===this.inputType&&this.outputs[this.cases[c]]||this.otherwise).evaluate(o)}eachChild(o){o(this.input),this.outputs.forEach(o),o(this.otherwise)}outputDefined(){return this.outputs.every(o=>o.outputDefined())&&this.otherwise.outputDefined()}}class Kc{constructor(o,c,g){this.type=o,this.branches=c,this.otherwise=g}static parse(o,c){if(o.length<4)return c.error(`Expected at least 3 arguments, but found only ${o.length-1}.`);if(o.length%2!=0)return c.error("Expected an odd number of arguments.");let g;c.expectedType&&c.expectedType.kind!=="value"&&(g=c.expectedType);const x=[];for(let A=1;A<o.length-1;A+=2){const z=c.parse(o[A],A,Bt);if(!z)return null;const B=c.parse(o[A+1],A+1,g);if(!B)return null;x.push([z,B]),g=g||B.type}const T=c.parse(o[o.length-1],o.length-1,g);if(!T)return null;if(!g)throw new Error("Can't infer output type");return new Kc(g,x,T)}evaluate(o){for(const[c,g]of this.branches)if(c.evaluate(o))return g.evaluate(o);return this.otherwise.evaluate(o)}eachChild(o){for(const[c,g]of this.branches)o(c),o(g);o(this.otherwise)}outputDefined(){return this.branches.every(([o,c])=>c.outputDefined())&&this.otherwise.outputDefined()}}class Rl{constructor(o,c,g,x){this.type=o,this.input=c,this.beginIndex=g,this.endIndex=x}static parse(o,c){if(o.length<=2||o.length>=5)return c.error(`Expected 2 or 3 arguments, but found ${o.length-1} instead.`);const g=c.parse(o[1],1,Yt),x=c.parse(o[2],2,tt);if(!g||!x)return null;if(!Vo(g.type,[gr(Yt),wt,Yt]))return c.error(`Expected first argument to be of type array or string, but found ${Qi(g.type)} instead`);if(o.length===4){const T=c.parse(o[3],3,tt);return T?new Rl(g.type,g,x,T):null}return new Rl(g.type,g,x)}evaluate(o){const c=this.input.evaluate(o),g=this.beginIndex.evaluate(o);let x;if(this.endIndex&&(x=this.endIndex.evaluate(o)),Qr(c,["string"]))return[...c].slice(g,x).join("");if(Qr(c,["array"]))return c.slice(g,x);throw new Xn(`Expected first argument to be of type array or string, but found ${Qi(vr(c))} instead.`)}eachChild(o){o(this.input),o(this.beginIndex),this.endIndex&&o(this.endIndex)}outputDefined(){return!1}}function es(h,o){const c=h.length-1;let g,x,T=0,A=c,z=0;for(;T<=A;)if(z=Math.floor((T+A)/2),g=h[z],x=h[z+1],g<=o){if(z===c||o<x)return z;T=z+1}else{if(!(g>o))throw new Xn("Input is not a number.");A=z-1}return 0}class Ph{constructor(o,c,g){this.type=o,this.input=c,this.labels=[],this.outputs=[];for(const[x,T]of g)this.labels.push(x),this.outputs.push(T)}static parse(o,c){if(o.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if((o.length-1)%2!=0)return c.error("Expected an even number of arguments.");const g=c.parse(o[1],1,tt);if(!g)return null;const x=[];let T=null;c.expectedType&&c.expectedType.kind!=="value"&&(T=c.expectedType);for(let A=1;A<o.length;A+=2){const z=A===1?-1/0:o[A],B=o[A+1],G=A,W=A+1;if(typeof z!="number")return c.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',G);if(x.length&&x[x.length-1][0]>=z)return c.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',G);const Q=c.parse(B,W,T);if(!Q)return null;T=T||Q.type,x.push([z,Q])}return new Ph(T,g,x)}evaluate(o){const c=this.labels,g=this.outputs;if(c.length===1)return g[0].evaluate(o);const x=this.input.evaluate(o);if(x<=c[0])return g[0].evaluate(o);const T=c.length;return x>=c[T-1]?g[T-1].evaluate(o):g[es(c,x)].evaluate(o)}eachChild(o){o(this.input);for(const c of this.outputs)o(c)}outputDefined(){return this.outputs.every(o=>o.outputDefined())}}function pp(h){return h&&h.__esModule&&Object.prototype.hasOwnProperty.call(h,"default")?h.default:h}var Xl,Br,Gu=function(){if(Br)return Xl;function h(o,c,g,x){this.cx=3*o,this.bx=3*(g-o)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*c,this.by=3*(x-c)-this.cy,this.ay=1-this.cy-this.by,this.p1x=o,this.p1y=c,this.p2x=g,this.p2y=x}return Br=1,Xl=h,h.prototype={sampleCurveX:function(o){return((this.ax*o+this.bx)*o+this.cx)*o},sampleCurveY:function(o){return((this.ay*o+this.by)*o+this.cy)*o},sampleCurveDerivativeX:function(o){return(3*this.ax*o+2*this.bx)*o+this.cx},solveCurveX:function(o,c){if(c===void 0&&(c=1e-6),o<0)return 0;if(o>1)return 1;for(var g=o,x=0;x<8;x++){var T=this.sampleCurveX(g)-o;if(Math.abs(T)<c)return g;var A=this.sampleCurveDerivativeX(g);if(Math.abs(A)<1e-6)break;g-=T/A}var z=0,B=1;for(g=o,x=0;x<20&&(T=this.sampleCurveX(g),!(Math.abs(T-o)<c));x++)o>T?z=g:B=g,g=.5*(B-z)+z;return g},solve:function(o,c){return this.sampleCurveY(this.solveCurveX(o,c))}},Xl}(),cf=pp(Gu);class la{constructor(o,c,g,x,T){this.type=o,this.operator=c,this.interpolation=g,this.input=x,this.labels=[],this.outputs=[];for(const[A,z]of T)this.labels.push(A),this.outputs.push(z)}static interpolationFactor(o,c,g,x){let T=0;if(o.name==="exponential")T=Gi(c,o.base,g,x);else if(o.name==="linear")T=Gi(c,1,g,x);else if(o.name==="cubic-bezier"){const A=o.controlPoints;T=new cf(A[0],A[1],A[2],A[3]).solve(Gi(c,1,g,x))}return T}static parse(o,c){let[g,x,T,...A]=o;if(!Array.isArray(x)||x.length===0)return c.error("Expected an interpolation type expression.",1);if(x[0]==="linear")x={name:"linear"};else if(x[0]==="exponential"){const G=x[1];if(typeof G!="number")return c.error("Exponential interpolation requires a numeric base.",1,1);x={name:"exponential",base:G}}else{if(x[0]!=="cubic-bezier")return c.error(`Unknown interpolation type ${String(x[0])}`,1,0);{const G=x.slice(1);if(G.length!==4||G.some(W=>typeof W!="number"||W<0||W>1))return c.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);x={name:"cubic-bezier",controlPoints:G}}}if(o.length-1<4)return c.error(`Expected at least 4 arguments, but found only ${o.length-1}.`);if((o.length-1)%2!=0)return c.error("Expected an even number of arguments.");if(T=c.parse(T,2,tt),!T)return null;const z=[];let B=null;g!=="interpolate-hcl"&&g!=="interpolate-lab"||c.expectedType==Di?c.expectedType&&c.expectedType.kind!=="value"&&(B=c.expectedType):B=Ht;for(let G=0;G<A.length;G+=2){const W=A[G],Q=A[G+1],ot=G+3,ct=G+4;if(typeof W!="number")return c.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',ot);if(z.length&&z[z.length-1][0]>=W)return c.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',ot);const ut=c.parse(Q,ct,B);if(!ut)return null;B=B||ut.type,z.push([W,ut])}return ao(B,tt)||ao(B,oe)||ao(B,Ht)||ao(B,$e)||ao(B,er)||ao(B,Di)||ao(B,Hi)||ao(B,gr(tt))?new la(B,g,x,T,z):c.error(`Type ${Qi(B)} is not interpolatable.`)}evaluate(o){const c=this.labels,g=this.outputs;if(c.length===1)return g[0].evaluate(o);const x=this.input.evaluate(o);if(x<=c[0])return g[0].evaluate(o);const T=c.length;if(x>=c[T-1])return g[T-1].evaluate(o);const A=es(c,x),z=la.interpolationFactor(this.interpolation,x,c[A],c[A+1]),B=g[A].evaluate(o),G=g[A+1].evaluate(o);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return fs(B,G,z);case"color":return un.interpolate(B,G,z);case"padding":return ms.interpolate(B,G,z);case"colorArray":return Us.interpolate(B,G,z);case"numberArray":return sa.interpolate(B,G,z);case"variableAnchorOffsetCollection":return Ds.interpolate(B,G,z);case"array":return Js(B,G,z);case"projectionDefinition":return aa.interpolate(B,G,z)}case"interpolate-hcl":switch(this.type.kind){case"color":return un.interpolate(B,G,z,"hcl");case"colorArray":return Us.interpolate(B,G,z,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return un.interpolate(B,G,z,"lab");case"colorArray":return Us.interpolate(B,G,z,"lab")}}}eachChild(o){o(this.input);for(const c of this.outputs)o(c)}outputDefined(){return this.outputs.every(o=>o.outputDefined())}}function Gi(h,o,c,g){const x=g-c,T=h-c;return x===0?0:o===1?T/x:(Math.pow(o,T)-1)/(Math.pow(o,x)-1)}const el={color:un.interpolate,number:fs,padding:ms.interpolate,numberArray:sa.interpolate,colorArray:Us.interpolate,variableAnchorOffsetCollection:Ds.interpolate,array:Js};class fl{constructor(o,c){this.type=o,this.args=c}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");let g=null;const x=c.expectedType;x&&x.kind!=="value"&&(g=x);const T=[];for(const z of o.slice(1)){const B=c.parse(z,1+T.length,g,void 0,{typeAnnotation:"omit"});if(!B)return null;g=g||B.type,T.push(B)}if(!g)throw new Error("No output type");const A=x&&T.some(z=>Nn(x,z.type));return new fl(A?Yt:g,T)}evaluate(o){let c,g=null,x=0;for(const T of this.args)if(x++,g=T.evaluate(o),g&&g instanceof js&&!g.available&&(c||(c=g.name),g=null,x===this.args.length&&(g=c)),g!==null)break;return g}eachChild(o){this.args.forEach(o)}outputDefined(){return this.args.every(o=>o.outputDefined())}}function ml(h,o){return h==="=="||h==="!="?o.kind==="boolean"||o.kind==="string"||o.kind==="number"||o.kind==="null"||o.kind==="value":o.kind==="string"||o.kind==="number"||o.kind==="value"}function kl(h,o,c,g){return g.compare(o,c)===0}function ka(h,o,c){const g=h!=="=="&&h!=="!=";return class Ib{constructor(T,A,z){this.type=Bt,this.lhs=T,this.rhs=A,this.collator=z,this.hasUntypedArgument=T.type.kind==="value"||A.type.kind==="value"}static parse(T,A){if(T.length!==3&&T.length!==4)return A.error("Expected two or three arguments.");const z=T[0];let B=A.parse(T[1],1,Yt);if(!B)return null;if(!ml(z,B.type))return A.concat(1).error(`"${z}" comparisons are not supported for type '${Qi(B.type)}'.`);let G=A.parse(T[2],2,Yt);if(!G)return null;if(!ml(z,G.type))return A.concat(2).error(`"${z}" comparisons are not supported for type '${Qi(G.type)}'.`);if(B.type.kind!==G.type.kind&&B.type.kind!=="value"&&G.type.kind!=="value")return A.error(`Cannot compare types '${Qi(B.type)}' and '${Qi(G.type)}'.`);g&&(B.type.kind==="value"&&G.type.kind!=="value"?B=new Ra(G.type,[B]):B.type.kind!=="value"&&G.type.kind==="value"&&(G=new Ra(B.type,[G])));let W=null;if(T.length===4){if(B.type.kind!=="string"&&G.type.kind!=="string"&&B.type.kind!=="value"&&G.type.kind!=="value")return A.error("Cannot use collator to compare non-string types.");if(W=A.parse(T[3],3,xe),!W)return null}return new Ib(B,G,W)}evaluate(T){const A=this.lhs.evaluate(T),z=this.rhs.evaluate(T);if(g&&this.hasUntypedArgument){const B=vr(A),G=vr(z);if(B.kind!==G.kind||B.kind!=="string"&&B.kind!=="number")throw new Xn(`Expected arguments for "${h}" to be (string, string) or (number, number), but found (${B.kind}, ${G.kind}) instead.`)}if(this.collator&&!g&&this.hasUntypedArgument){const B=vr(A),G=vr(z);if(B.kind!=="string"||G.kind!=="string")return o(T,A,z)}return this.collator?c(T,A,z,this.collator.evaluate(T)):o(T,A,z)}eachChild(T){T(this.lhs),T(this.rhs),this.collator&&T(this.collator)}outputDefined(){return!0}}}const Vi=ka("==",function(h,o,c){return o===c},kl),Jr=ka("!=",function(h,o,c){return o!==c},function(h,o,c,g){return!kl(0,o,c,g)}),mn=ka("<",function(h,o,c){return o<c},function(h,o,c,g){return g.compare(o,c)<0}),il=ka(">",function(h,o,c){return o>c},function(h,o,c,g){return g.compare(o,c)>0}),Qc=ka("<=",function(h,o,c){return o<=c},function(h,o,c,g){return g.compare(o,c)<=0}),dn=ka(">=",function(h,o,c){return o>=c},function(h,o,c,g){return g.compare(o,c)>=0});class ca{constructor(o,c,g){this.type=xe,this.locale=g,this.caseSensitive=o,this.diacriticSensitive=c}static parse(o,c){if(o.length!==2)return c.error("Expected one argument.");const g=o[1];if(typeof g!="object"||Array.isArray(g))return c.error("Collator options argument must be an object.");const x=c.parse(g["case-sensitive"]!==void 0&&g["case-sensitive"],1,Bt);if(!x)return null;const T=c.parse(g["diacritic-sensitive"]!==void 0&&g["diacritic-sensitive"],1,Bt);if(!T)return null;let A=null;return g.locale&&(A=c.parse(g.locale,1,wt),!A)?null:new ca(x,T,A)}evaluate(o){return new oa(this.caseSensitive.evaluate(o),this.diacriticSensitive.evaluate(o),this.locale?this.locale.evaluate(o):null)}eachChild(o){o(this.caseSensitive),o(this.diacriticSensitive),this.locale&&o(this.locale)}outputDefined(){return!1}}class Dc{constructor(o,c,g,x,T){this.type=wt,this.number=o,this.locale=c,this.currency=g,this.minFractionDigits=x,this.maxFractionDigits=T}static parse(o,c){if(o.length!==3)return c.error("Expected two arguments.");const g=c.parse(o[1],1,tt);if(!g)return null;const x=o[2];if(typeof x!="object"||Array.isArray(x))return c.error("NumberFormat options argument must be an object.");let T=null;if(x.locale&&(T=c.parse(x.locale,1,wt),!T))return null;let A=null;if(x.currency&&(A=c.parse(x.currency,1,wt),!A))return null;let z=null;if(x["min-fraction-digits"]&&(z=c.parse(x["min-fraction-digits"],1,tt),!z))return null;let B=null;return x["max-fraction-digits"]&&(B=c.parse(x["max-fraction-digits"],1,tt),!B)?null:new Dc(g,T,A,z,B)}evaluate(o){return new Intl.NumberFormat(this.locale?this.locale.evaluate(o):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(o):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(o):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(o):void 0}).format(this.number.evaluate(o))}eachChild(o){o(this.number),this.locale&&o(this.locale),this.currency&&o(this.currency),this.minFractionDigits&&o(this.minFractionDigits),this.maxFractionDigits&&o(this.maxFractionDigits)}outputDefined(){return!1}}class hc{constructor(o){this.type=ti,this.sections=o}static parse(o,c){if(o.length<2)return c.error("Expected at least one argument.");const g=o[1];if(!Array.isArray(g)&&typeof g=="object")return c.error("First argument must be an image or text section.");const x=[];let T=!1;for(let A=1;A<=o.length-1;++A){const z=o[A];if(T&&typeof z=="object"&&!Array.isArray(z)){T=!1;let B=null;if(z["font-scale"]&&(B=c.parse(z["font-scale"],1,tt),!B))return null;let G=null;if(z["text-font"]&&(G=c.parse(z["text-font"],1,gr(wt)),!G))return null;let W=null;if(z["text-color"]&&(W=c.parse(z["text-color"],1,Ht),!W))return null;let Q=null;if(z["vertical-align"]){if(typeof z["vertical-align"]=="string"&&!Vn.includes(z["vertical-align"]))return c.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${z["vertical-align"]}' instead.`);if(Q=c.parse(z["vertical-align"],1,wt),!Q)return null}const ot=x[x.length-1];ot.scale=B,ot.font=G,ot.textColor=W,ot.verticalAlign=Q}else{const B=c.parse(o[A],1,Yt);if(!B)return null;const G=B.type.kind;if(G!=="string"&&G!=="value"&&G!=="null"&&G!=="resolvedImage")return c.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");T=!0,x.push({content:B,scale:null,font:null,textColor:null,verticalAlign:null})}}return new hc(x)}evaluate(o){return new Uo(this.sections.map(c=>{const g=c.content.evaluate(o);return vr(g)===Ki?new lc("",g,null,null,null,c.verticalAlign?c.verticalAlign.evaluate(o):null):new lc(Ah(g),null,c.scale?c.scale.evaluate(o):null,c.font?c.font.evaluate(o).join(","):null,c.textColor?c.textColor.evaluate(o):null,c.verticalAlign?c.verticalAlign.evaluate(o):null)}))}eachChild(o){for(const c of this.sections)o(c.content),c.scale&&o(c.scale),c.font&&o(c.font),c.textColor&&o(c.textColor),c.verticalAlign&&o(c.verticalAlign)}outputDefined(){return!1}}class ws{constructor(o){this.type=Ki,this.input=o}static parse(o,c){if(o.length!==2)return c.error("Expected two arguments.");const g=c.parse(o[1],1,wt);return g?new ws(g):c.error("No image name provided.")}evaluate(o){const c=this.input.evaluate(o),g=js.fromString(c);return g&&o.availableImages&&(g.available=o.availableImages.indexOf(c)>-1),g}eachChild(o){o(this.input)}outputDefined(){return!1}}class Ho{constructor(o){this.type=tt,this.input=o}static parse(o,c){if(o.length!==2)return c.error(`Expected 1 argument, but found ${o.length-1} instead.`);const g=c.parse(o[1],1);return g?g.type.kind!=="array"&&g.type.kind!=="string"&&g.type.kind!=="value"?c.error(`Expected argument of type string or array, but found ${Qi(g.type)} instead.`):new Ho(g):null}evaluate(o){const c=this.input.evaluate(o);if(typeof c=="string")return[...c].length;if(Array.isArray(c))return c.length;throw new Xn(`Expected value to be of type string or array, but found ${Qi(vr(c))} instead.`)}eachChild(o){o(this.input)}outputDefined(){return!1}}const zc=8192;function Id(h,o){const c=(180+h[0])/360,g=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h[1]*Math.PI/360)))/360,x=Math.pow(2,o.z);return[Math.round(c*x*zc),Math.round(g*x*zc)]}function Ed(h,o){const c=Math.pow(2,o.z);return[(x=(h[0]/zc+o.x)/c,360*x-180),(g=(h[1]/zc+o.y)/c,360/Math.PI*Math.atan(Math.exp((180-360*g)*Math.PI/180))-90)];var g,x}function th(h,o){h[0]=Math.min(h[0],o[0]),h[1]=Math.min(h[1],o[1]),h[2]=Math.max(h[2],o[0]),h[3]=Math.max(h[3],o[1])}function uc(h,o){return!(h[0]<=o[0]||h[2]>=o[2]||h[1]<=o[1]||h[3]>=o[3])}function hf(h,o,c){const g=h[0]-o[0],x=h[1]-o[1],T=h[0]-c[0],A=h[1]-c[1];return g*A-T*x==0&&g*T<=0&&x*A<=0}function eh(h,o,c,g){return(x=[g[0]-c[0],g[1]-c[1]])[0]*(T=[o[0]-h[0],o[1]-h[1]])[1]-x[1]*T[0]!=0&&!(!gs(h,o,c,g)||!gs(c,g,h,o));var x,T}function Ts(h,o,c){for(const g of c)for(let x=0;x<g.length-1;++x)if(eh(h,o,g[x],g[x+1]))return!0;return!1}function gl(h,o,c=!1){let g=!1;for(const z of o)for(let B=0;B<z.length-1;B++){if(hf(h,z[B],z[B+1]))return c;(T=z[B])[1]>(x=h)[1]!=(A=z[B+1])[1]>x[1]&&x[0]<(A[0]-T[0])*(x[1]-T[1])/(A[1]-T[1])+T[0]&&(g=!g)}var x,T,A;return g}function Fa(h,o){for(const c of o)if(gl(h,c))return!0;return!1}function Ad(h,o){for(const c of h)if(!gl(c,o))return!1;for(let c=0;c<h.length-1;++c)if(Ts(h[c],h[c+1],o))return!1;return!0}function $u(h,o){for(const c of o)if(Ad(h,c))return!0;return!1}function gs(h,o,c,g){const x=g[0]-c[0],T=g[1]-c[1],A=(h[0]-c[0])*T-x*(h[1]-c[1]),z=(o[0]-c[0])*T-x*(o[1]-c[1]);return A>0&&z<0||A<0&&z>0}function Yl(h,o,c){const g=[];for(let x=0;x<h.length;x++){const T=[];for(let A=0;A<h[x].length;A++){const z=Id(h[x][A],c);th(o,z),T.push(z)}g.push(T)}return g}function Lc(h,o,c){const g=[];for(let x=0;x<h.length;x++){const T=Yl(h[x],o,c);g.push(T)}return g}function Fo(h,o,c,g){if(h[0]<c[0]||h[0]>c[2]){const x=.5*g;let T=h[0]-c[0]>x?-g:c[0]-h[0]>x?g:0;T===0&&(T=h[0]-c[2]>x?-g:c[2]-h[0]>x?g:0),h[0]+=T}th(o,h)}function Sr(h,o,c,g){const x=Math.pow(2,g.z)*zc,T=[g.x*zc,g.y*zc],A=[];for(const z of h)for(const B of z){const G=[B.x+T[0],B.y+T[1]];Fo(G,o,c,x),A.push(G)}return A}function ki(h,o,c,g){const x=Math.pow(2,g.z)*zc,T=[g.x*zc,g.y*zc],A=[];for(const B of h){const G=[];for(const W of B){const Q=[W.x+T[0],W.y+T[1]];th(o,Q),G.push(Q)}A.push(G)}if(o[2]-o[0]<=x/2){(z=o)[0]=z[1]=1/0,z[2]=z[3]=-1/0;for(const B of A)for(const G of B)Fo(G,o,c,x)}var z;return A}class Fl{constructor(o,c){this.type=Bt,this.geojson=o,this.geometries=c}static parse(o,c){if(o.length!==2)return c.error(`'within' expression requires exactly one argument, but found ${o.length-1} instead.`);if(Ll(o[1])){const g=o[1];if(g.type==="FeatureCollection"){const x=[];for(const T of g.features){const{type:A,coordinates:z}=T.geometry;A==="Polygon"&&x.push(z),A==="MultiPolygon"&&x.push(...z)}if(x.length)return new Fl(g,{type:"MultiPolygon",coordinates:x})}else if(g.type==="Feature"){const x=g.geometry.type;if(x==="Polygon"||x==="MultiPolygon")return new Fl(g,g.geometry)}else if(g.type==="Polygon"||g.type==="MultiPolygon")return new Fl(g,g)}return c.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(o){if(o.geometry()!=null&&o.canonicalID()!=null){if(o.geometryType()==="Point")return function(c,g){const x=[1/0,1/0,-1/0,-1/0],T=[1/0,1/0,-1/0,-1/0],A=c.canonicalID();if(g.type==="Polygon"){const z=Yl(g.coordinates,T,A),B=Sr(c.geometry(),x,T,A);if(!uc(x,T))return!1;for(const G of B)if(!gl(G,z))return!1}if(g.type==="MultiPolygon"){const z=Lc(g.coordinates,T,A),B=Sr(c.geometry(),x,T,A);if(!uc(x,T))return!1;for(const G of B)if(!Fa(G,z))return!1}return!0}(o,this.geometries);if(o.geometryType()==="LineString")return function(c,g){const x=[1/0,1/0,-1/0,-1/0],T=[1/0,1/0,-1/0,-1/0],A=c.canonicalID();if(g.type==="Polygon"){const z=Yl(g.coordinates,T,A),B=ki(c.geometry(),x,T,A);if(!uc(x,T))return!1;for(const G of B)if(!Ad(G,z))return!1}if(g.type==="MultiPolygon"){const z=Lc(g.coordinates,T,A),B=ki(c.geometry(),x,T,A);if(!uc(x,T))return!1;for(const G of B)if(!$u(G,z))return!1}return!0}(o,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let hr=class{constructor(h=[],o=(c,g)=>c<g?-1:c>g?1:0){if(this.data=h,this.length=this.data.length,this.compare=o,this.length>0)for(let c=(this.length>>1)-1;c>=0;c--)this._down(c)}push(h){this.data.push(h),this._up(this.length++)}pop(){if(this.length===0)return;const h=this.data[0],o=this.data.pop();return--this.length>0&&(this.data[0]=o,this._down(0)),h}peek(){return this.data[0]}_up(h){const{data:o,compare:c}=this,g=o[h];for(;h>0;){const x=h-1>>1,T=o[x];if(c(g,T)>=0)break;o[h]=T,h=x}o[h]=g}_down(h){const{data:o,compare:c}=this,g=this.length>>1,x=o[h];for(;h<g;){let T=1+(h<<1);const A=T+1;if(A<this.length&&c(o[A],o[T])<0&&(T=A),c(o[T],x)>=0)break;o[h]=o[T],h=T}o[h]=x}};function cu(h,o,c=0,g=h.length-1,x=rr){for(;g>c;){if(g-c>600){const B=g-c+1,G=o-c+1,W=Math.log(B),Q=.5*Math.exp(2*W/3),ot=.5*Math.sqrt(W*Q*(B-Q)/B)*(G-B/2<0?-1:1);cu(h,o,Math.max(c,Math.floor(o-G*Q/B+ot)),Math.min(g,Math.floor(o+(B-G)*Q/B+ot)),x)}const T=h[o];let A=c,z=g;for(Mh(h,c,o),x(h[g],T)>0&&Mh(h,c,g);A<z;){for(Mh(h,A,z),A++,z--;x(h[A],T)<0;)A++;for(;x(h[z],T)>0;)z--}x(h[c],T)===0?Mh(h,c,z):(z++,Mh(h,z,g)),z<=o&&(c=z+1),o<=z&&(g=z-1)}}function Mh(h,o,c){const g=h[o];h[o]=h[c],h[c]=g}function rr(h,o){return h<o?-1:h>o?1:0}function ih(h,o){if(h.length<=1)return[h];const c=[];let g,x;for(const T of h){const A=Uf(T);A!==0&&(T.area=Math.abs(A),x===void 0&&(x=A<0),x===A<0?(g&&c.push(g),g=[T]):g.push(T))}if(g&&c.push(g),o>1)for(let T=0;T<c.length;T++)c[T].length<=o||(cu(c[T],o,1,c[T].length-1,fp),c[T]=c[T].slice(0,o));return c}function fp(h,o){return o.area-h.area}function Uf(h){let o=0;for(let c,g,x=0,T=h.length,A=T-1;x<T;A=x++)c=h[x],g=h[A],o+=(g.x-c.x)*(c.y+g.y);return o}const dc=1/298.257223563,hu=dc*(2-dc),Ss=Math.PI/180;class Ks{constructor(o){const c=6378.137*Ss*1e3,g=Math.cos(o*Ss),x=1/(1-hu*(1-g*g)),T=Math.sqrt(x);this.kx=c*T*g,this.ky=c*T*x*(1-hu)}distance(o,c){const g=this.wrap(o[0]-c[0])*this.kx,x=(o[1]-c[1])*this.ky;return Math.sqrt(g*g+x*x)}pointOnLine(o,c){let g,x,T,A,z=1/0;for(let B=0;B<o.length-1;B++){let G=o[B][0],W=o[B][1],Q=this.wrap(o[B+1][0]-G)*this.kx,ot=(o[B+1][1]-W)*this.ky,ct=0;Q===0&&ot===0||(ct=(this.wrap(c[0]-G)*this.kx*Q+(c[1]-W)*this.ky*ot)/(Q*Q+ot*ot),ct>1?(G=o[B+1][0],W=o[B+1][1]):ct>0&&(G+=Q/this.kx*ct,W+=ot/this.ky*ct)),Q=this.wrap(c[0]-G)*this.kx,ot=(c[1]-W)*this.ky;const ut=Q*Q+ot*ot;ut<z&&(z=ut,g=G,x=W,T=B,A=ct)}return{point:[g,x],index:T,t:Math.max(0,Math.min(1,A))}}wrap(o){for(;o<-180;)o+=360;for(;o>180;)o-=360;return o}}function Ch(h,o){return o[0]-h[0]}function Rc(h){return h[1]-h[0]+1}function ha(h,o){return h[1]>=h[0]&&h[1]<o}function Is(h,o){if(h[0]>h[1])return[null,null];const c=Rc(h);if(o){if(c===2)return[h,null];const x=Math.floor(c/2);return[[h[0],h[0]+x],[h[0]+x,h[1]]]}if(c===1)return[h,null];const g=Math.floor(c/2)-1;return[[h[0],h[0]+g],[h[0]+g+1,h[1]]]}function uf(h,o){if(!ha(o,h.length))return[1/0,1/0,-1/0,-1/0];const c=[1/0,1/0,-1/0,-1/0];for(let g=o[0];g<=o[1];++g)th(c,h[g]);return c}function df(h){const o=[1/0,1/0,-1/0,-1/0];for(const c of h)for(const g of c)th(o,g);return o}function uu(h){return h[0]!==-1/0&&h[1]!==-1/0&&h[2]!==1/0&&h[3]!==1/0}function kc(h,o,c){if(!uu(h)||!uu(o))return NaN;let g=0,x=0;return h[2]<o[0]&&(g=o[0]-h[2]),h[0]>o[2]&&(g=h[0]-o[2]),h[1]>o[3]&&(x=h[1]-o[3]),h[3]<o[1]&&(x=o[1]-h[3]),c.distance([0,0],[g,x])}function Dh(h,o,c){const g=c.pointOnLine(o,h);return c.distance(h,g.point)}function _l(h,o,c,g,x){const T=Math.min(Dh(h,[c,g],x),Dh(o,[c,g],x)),A=Math.min(Dh(c,[h,o],x),Dh(g,[h,o],x));return Math.min(T,A)}function jf(h,o,c,g,x){if(!ha(o,h.length)||!ha(g,c.length))return 1/0;let T=1/0;for(let A=o[0];A<o[1];++A){const z=h[A],B=h[A+1];for(let G=g[0];G<g[1];++G){const W=c[G],Q=c[G+1];if(eh(z,B,W,Q))return 0;T=Math.min(T,_l(z,B,W,Q,x))}}return T}function uo(h,o,c,g,x){if(!ha(o,h.length)||!ha(g,c.length))return NaN;let T=1/0;for(let A=o[0];A<=o[1];++A)for(let z=g[0];z<=g[1];++z)if(T=Math.min(T,x.distance(h[A],c[z])),T===0)return T;return T}function Pd(h,o,c){if(gl(h,o,!0))return 0;let g=1/0;for(const x of o){const T=x[0],A=x[x.length-1];if(T!==A&&(g=Math.min(g,Dh(h,[A,T],c)),g===0))return g;const z=c.pointOnLine(x,h);if(g=Math.min(g,c.distance(h,z.point)),g===0)return g}return g}function zh(h,o,c,g){if(!ha(o,h.length))return NaN;for(let T=o[0];T<=o[1];++T)if(gl(h[T],c,!0))return 0;let x=1/0;for(let T=o[0];T<o[1];++T){const A=h[T],z=h[T+1];for(const B of c)for(let G=0,W=B.length,Q=W-1;G<W;Q=G++){const ot=B[Q],ct=B[G];if(eh(A,z,ot,ct))return 0;x=Math.min(x,_l(A,z,ot,ct,g))}}return x}function Gf(h,o){for(const c of h)for(const g of c)if(gl(g,o,!0))return!0;return!1}function $f(h,o,c,g=1/0){const x=df(h),T=df(o);if(g!==1/0&&kc(x,T,c)>=g)return g;if(uc(x,T)){if(Gf(h,o))return 0}else if(Gf(o,h))return 0;let A=1/0;for(const z of h)for(let B=0,G=z.length,W=G-1;B<G;W=B++){const Q=z[W],ot=z[B];for(const ct of o)for(let ut=0,xt=ct.length,Et=xt-1;ut<xt;Et=ut++){const Vt=ct[Et],ue=ct[ut];if(eh(Q,ot,Vt,ue))return 0;A=Math.min(A,_l(Q,ot,Vt,ue,c))}}return A}function qf(h,o,c,g,x,T){if(!T)return;const A=kc(uf(g,T),x,c);A<o&&h.push([A,T,[0,0]])}function pc(h,o,c,g,x,T,A){if(!T||!A)return;const z=kc(uf(g,T),uf(x,A),c);z<o&&h.push([z,T,A])}function mp(h,o,c,g,x=1/0){let T=Math.min(g.distance(h[0],c[0][0]),x);if(T===0)return T;const A=new hr([[0,[0,h.length-1],[0,0]]],Ch),z=df(c);for(;A.length>0;){const B=A.pop();if(B[0]>=T)continue;const G=B[1],W=o?50:100;if(Rc(G)<=W){if(!ha(G,h.length))return NaN;if(o){const Q=zh(h,G,c,g);if(isNaN(Q)||Q===0)return Q;T=Math.min(T,Q)}else for(let Q=G[0];Q<=G[1];++Q){const ot=Pd(h[Q],c,g);if(T=Math.min(T,ot),T===0)return 0}}else{const Q=Is(G,o);qf(A,T,g,h,z,Q[0]),qf(A,T,g,h,z,Q[1])}}return T}function qu(h,o,c,g,x,T=1/0){let A=Math.min(T,x.distance(h[0],c[0]));if(A===0)return A;const z=new hr([[0,[0,h.length-1],[0,c.length-1]]],Ch);for(;z.length>0;){const B=z.pop();if(B[0]>=A)continue;const G=B[1],W=B[2],Q=o?50:100,ot=g?50:100;if(Rc(G)<=Q&&Rc(W)<=ot){if(!ha(G,h.length)&&ha(W,c.length))return NaN;let ct;if(o&&g)ct=jf(h,G,c,W,x),A=Math.min(A,ct);else if(o&&!g){const ut=h.slice(G[0],G[1]+1);for(let xt=W[0];xt<=W[1];++xt)if(ct=Dh(c[xt],ut,x),A=Math.min(A,ct),A===0)return A}else if(!o&&g){const ut=c.slice(W[0],W[1]+1);for(let xt=G[0];xt<=G[1];++xt)if(ct=Dh(h[xt],ut,x),A=Math.min(A,ct),A===0)return A}else ct=uo(h,G,c,W,x),A=Math.min(A,ct)}else{const ct=Is(G,o),ut=Is(W,g);pc(z,A,x,h,c,ct[0],ut[0]),pc(z,A,x,h,c,ct[0],ut[1]),pc(z,A,x,h,c,ct[1],ut[0]),pc(z,A,x,h,c,ct[1],ut[1])}}return A}function Zu(h){return h.type==="MultiPolygon"?h.coordinates.map(o=>({type:"Polygon",coordinates:o})):h.type==="MultiLineString"?h.coordinates.map(o=>({type:"LineString",coordinates:o})):h.type==="MultiPoint"?h.coordinates.map(o=>({type:"Point",coordinates:o})):[h]}class rh{constructor(o,c){this.type=tt,this.geojson=o,this.geometries=c}static parse(o,c){if(o.length!==2)return c.error(`'distance' expression requires exactly one argument, but found ${o.length-1} instead.`);if(Ll(o[1])){const g=o[1];if(g.type==="FeatureCollection")return new rh(g,g.features.map(x=>Zu(x.geometry)).flat());if(g.type==="Feature")return new rh(g,Zu(g.geometry));if("type"in g&&"coordinates"in g)return new rh(g,Zu(g))}return c.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(o){if(o.geometry()!=null&&o.canonicalID()!=null){if(o.geometryType()==="Point")return function(c,g){const x=c.geometry(),T=x.flat().map(B=>Ed([B.x,B.y],c.canonical));if(x.length===0)return NaN;const A=new Ks(T[0][1]);let z=1/0;for(const B of g){switch(B.type){case"Point":z=Math.min(z,qu(T,!1,[B.coordinates],!1,A,z));break;case"LineString":z=Math.min(z,qu(T,!1,B.coordinates,!0,A,z));break;case"Polygon":z=Math.min(z,mp(T,!1,B.coordinates,A,z))}if(z===0)return z}return z}(o,this.geometries);if(o.geometryType()==="LineString")return function(c,g){const x=c.geometry(),T=x.flat().map(B=>Ed([B.x,B.y],c.canonical));if(x.length===0)return NaN;const A=new Ks(T[0][1]);let z=1/0;for(const B of g){switch(B.type){case"Point":z=Math.min(z,qu(T,!0,[B.coordinates],!1,A,z));break;case"LineString":z=Math.min(z,qu(T,!0,B.coordinates,!0,A,z));break;case"Polygon":z=Math.min(z,mp(T,!0,B.coordinates,A,z))}if(z===0)return z}return z}(o,this.geometries);if(o.geometryType()==="Polygon")return function(c,g){const x=c.geometry();if(x.length===0||x[0].length===0)return NaN;const T=ih(x,0).map(B=>B.map(G=>G.map(W=>Ed([W.x,W.y],c.canonical)))),A=new Ks(T[0][0][0][1]);let z=1/0;for(const B of g)for(const G of T){switch(B.type){case"Point":z=Math.min(z,mp([B.coordinates],!1,G,A,z));break;case"LineString":z=Math.min(z,mp(B.coordinates,!0,G,A,z));break;case"Polygon":z=Math.min(z,$f(G,B.coordinates,A,z))}if(z===0)return z}return z}(o,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class du{constructor(o){this.type=Yt,this.key=o}static parse(o,c){if(o.length!==2)return c.error(`Expected 1 argument, but found ${o.length-1} instead.`);const g=o[1];return g==null?c.error("Global state property must be defined."):typeof g!="string"?c.error(`Global state property must be string, but found ${typeof o[1]} instead.`):new du(g)}evaluate(o){var c;const g=(c=o.globals)===null||c===void 0?void 0:c.globalState;return g&&Object.keys(g).length!==0?Hl(g,this.key):null}eachChild(){}outputDefined(){return!1}}const Ia={"==":Vi,"!=":Jr,">":il,"<":mn,">=":dn,"<=":Qc,array:Ra,at:tl,boolean:Ra,case:Kc,coalesce:fl,collator:ca,format:hc,image:ws,in:Sa,"index-of":cc,interpolate:la,"interpolate-hcl":la,"interpolate-lab":la,length:Ho,let:Un,literal:Wl,match:Jc,number:Ra,"number-format":Dc,object:Ra,slice:Rl,step:Ph,string:Ra,"to-boolean":pl,"to-color":pl,"to-number":pl,"to-string":pl,var:ju,within:Fl,distance:rh,"global-state":du};class ua{constructor(o,c,g,x){this.name=o,this.type=c,this._evaluate=g,this.args=x}evaluate(o){return this._evaluate(o,this.args)}eachChild(o){this.args.forEach(o)}outputDefined(){return!1}static parse(o,c){const g=o[0],x=ua.definitions[g];if(!x)return c.error(`Unknown expression "${g}". If you wanted a literal array, use ["literal", [...]].`,0);const T=Array.isArray(x)?x[0]:x.type,A=Array.isArray(x)?[[x[1],x[2]]]:x.overloads,z=A.filter(([G])=>!Array.isArray(G)||G.length===o.length-1);let B=null;for(const[G,W]of z){B=new lu(c.registry,nh,c.path,null,c.scope);const Q=[];let ot=!1;for(let ct=1;ct<o.length;ct++){const ut=o[ct],xt=Array.isArray(G)?G[ct-1]:G.type,Et=B.parse(ut,1+Q.length,xt);if(!Et){ot=!0;break}Q.push(Et)}if(!ot)if(Array.isArray(G)&&G.length!==Q.length)B.error(`Expected ${G.length} arguments, but found ${Q.length} instead.`);else{for(let ct=0;ct<Q.length;ct++){const ut=Array.isArray(G)?G[ct]:G.type,xt=Q[ct];B.concat(ct+1).checkSubtype(ut,xt.type)}if(B.errors.length===0)return new ua(g,T,W,Q)}}if(z.length===1)c.errors.push(...B.errors);else{const G=(z.length?z:A).map(([Q])=>{return ot=Q,Array.isArray(ot)?`(${ot.map(Qi).join(", ")})`:`(${Qi(ot.type)}...)`;var ot}).join(" | "),W=[];for(let Q=1;Q<o.length;Q++){const ot=c.parse(o[Q],1+W.length);if(!ot)return null;W.push(Qi(ot.type))}c.error(`Expected arguments of type ${G}, but found (${W.join(", ")}) instead.`)}return null}static register(o,c){ua.definitions=c;for(const g in c)o[g]=ua}}function Hu(h,[o,c,g,x]){o=o.evaluate(h),c=c.evaluate(h),g=g.evaluate(h);const T=x?x.evaluate(h):1,A=Uu(o,c,g,T);if(A)throw new Xn(A);return new un(o/255,c/255,g/255,T,!1)}function gp(h,o){return h in o}function Md(h,o){const c=o[h];return c===void 0?null:c}function Jl(h){return{type:h}}function nh(h){if(h instanceof ju)return nh(h.boundExpression);if(h instanceof ua&&h.name==="error"||h instanceof ca||h instanceof Fl||h instanceof rh||h instanceof du)return!1;const o=h instanceof pl||h instanceof Ra;let c=!0;return h.eachChild(g=>{c=o?c&&nh(g):c&&g instanceof Wl}),!!c&&Wu(h)&&Ba(h,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"])}function Wu(h){if(h instanceof ua&&(h.name==="get"&&h.args.length===1||h.name==="feature-state"||h.name==="has"&&h.args.length===1||h.name==="properties"||h.name==="geometry-type"||h.name==="id"||/^filter-/.test(h.name))||h instanceof Fl||h instanceof rh)return!1;let o=!0;return h.eachChild(c=>{o&&!Wu(c)&&(o=!1)}),o}function Lh(h){if(h instanceof ua&&h.name==="feature-state")return!1;let o=!0;return h.eachChild(c=>{o&&!Lh(c)&&(o=!1)}),o}function Ba(h,o){if(h instanceof ua&&o.indexOf(h.name)>=0)return!1;let c=!0;return h.eachChild(g=>{c&&!Ba(g,o)&&(c=!1)}),c}function Cd(h){return{result:"success",value:h}}function ri(h){return{result:"error",value:h}}function Rh(h){return h["property-type"]==="data-driven"||h["property-type"]==="cross-faded-data-driven"}function pu(h){return!!h.expression&&h.expression.parameters.indexOf("zoom")>-1}function kh(h){return!!h.expression&&h.expression.interpolated}function Pn(h){return h instanceof Number?"number":h instanceof String?"string":h instanceof Boolean?"boolean":Array.isArray(h)?"array":h===null?"null":typeof h}function Fh(h){return typeof h=="object"&&h!==null&&!Array.isArray(h)&&vr(h)===ye}function Fc(h){return h}function Dd(h,o){const c=h.stops&&typeof h.stops[0][0]=="object",g=c||!(c||h.property!==void 0),x=h.type||(kh(o)?"exponential":"interval"),T=function(W){switch(W.type){case"color":return un.parse;case"padding":return ms.parse;case"numberArray":return sa.parse;case"colorArray":return Us.parse;default:return null}}(o);if(T&&((h=Zo({},h)).stops&&(h.stops=h.stops.map(W=>[W[0],T(W[1])])),h.default=T(h.default?h.default:o.default)),h.colorSpace&&(A=h.colorSpace)!=="rgb"&&A!=="hcl"&&A!=="lab")throw new Error(`Unknown color space: "${h.colorSpace}"`);var A;const z=function(W){switch(W){case"exponential":return Zf;case"interval":return Xu;case"categorical":return jr;case"identity":return Cm;default:throw new Error(`Unknown function type "${W}"`)}}(x);let B,G;if(x==="categorical"){B=Object.create(null);for(const W of h.stops)B[W[0]]=W[1];G=typeof h.stops[0][0]}if(c){const W={},Q=[];for(let ut=0;ut<h.stops.length;ut++){const xt=h.stops[ut],Et=xt[0].zoom;W[Et]===void 0&&(W[Et]={zoom:Et,type:h.type,property:h.property,default:h.default,stops:[]},Q.push(Et)),W[Et].stops.push([xt[0].value,xt[1]])}const ot=[];for(const ut of Q)ot.push([W[ut].zoom,Dd(W[ut],o)]);const ct={name:"linear"};return{kind:"composite",interpolationType:ct,interpolationFactor:la.interpolationFactor.bind(void 0,ct),zoomStops:ot.map(ut=>ut[0]),evaluate:({zoom:ut},xt)=>Zf({stops:ot,base:h.base},o,ut).evaluate(ut,xt)}}if(g){const W=x==="exponential"?{name:"exponential",base:h.base!==void 0?h.base:1}:null;return{kind:"camera",interpolationType:W,interpolationFactor:la.interpolationFactor.bind(void 0,W),zoomStops:h.stops.map(Q=>Q[0]),evaluate:({zoom:Q})=>z(h,o,Q,B,G)}}return{kind:"source",evaluate(W,Q){const ot=Q&&Q.properties?Q.properties[h.property]:void 0;return ot===void 0?Oa(h.default,o.default):z(h,o,ot,B,G)}}}function Oa(h,o,c){return h!==void 0?h:o!==void 0?o:c!==void 0?c:void 0}function jr(h,o,c,g,x){return Oa(typeof c===x?g[c]:void 0,h.default,o.default)}function Xu(h,o,c){if(Pn(c)!=="number")return Oa(h.default,o.default);const g=h.stops.length;if(g===1||c<=h.stops[0][0])return h.stops[0][1];if(c>=h.stops[g-1][0])return h.stops[g-1][1];const x=es(h.stops.map(T=>T[0]),c);return h.stops[x][1]}function Zf(h,o,c){const g=h.base!==void 0?h.base:1;if(Pn(c)!=="number")return Oa(h.default,o.default);const x=h.stops.length;if(x===1||c<=h.stops[0][0])return h.stops[0][1];if(c>=h.stops[x-1][0])return h.stops[x-1][1];const T=es(h.stops.map(W=>W[0]),c),A=function(W,Q,ot,ct){const ut=ct-ot,xt=W-ot;return ut===0?0:Q===1?xt/ut:(Math.pow(Q,xt)-1)/(Math.pow(Q,ut)-1)}(c,g,h.stops[T][0],h.stops[T+1][0]),z=h.stops[T][1],B=h.stops[T+1][1],G=el[o.type]||Fc;return typeof z.evaluate=="function"?{evaluate(...W){const Q=z.evaluate.apply(void 0,W),ot=B.evaluate.apply(void 0,W);if(Q!==void 0&&ot!==void 0)return G(Q,ot,A,h.colorSpace)}}:G(z,B,A,h.colorSpace)}function Cm(h,o,c){switch(o.type){case"color":c=un.parse(c);break;case"formatted":c=Uo.fromString(c.toString());break;case"resolvedImage":c=js.fromString(c.toString());break;case"padding":c=ms.parse(c);break;case"colorArray":c=Us.parse(c);break;case"numberArray":c=sa.parse(c);break;default:Pn(c)===o.type||o.type==="enum"&&o.values[c]||(c=void 0)}return Oa(c,h.default,o.default)}ua.register(Ia,{error:[{kind:"error"},[wt],(h,[o])=>{throw new Xn(o.evaluate(h))}],typeof:[wt,[Yt],(h,[o])=>Qi(vr(o.evaluate(h)))],"to-rgba":[gr(tt,4),[Ht],(h,[o])=>{const[c,g,x,T]=o.evaluate(h).rgb;return[255*c,255*g,255*x,T]}],rgb:[Ht,[tt,tt,tt],Hu],rgba:[Ht,[tt,tt,tt,tt],Hu],has:{type:Bt,overloads:[[[wt],(h,[o])=>gp(o.evaluate(h),h.properties())],[[wt,ye],(h,[o,c])=>gp(o.evaluate(h),c.evaluate(h))]]},get:{type:Yt,overloads:[[[wt],(h,[o])=>Md(o.evaluate(h),h.properties())],[[wt,ye],(h,[o,c])=>Md(o.evaluate(h),c.evaluate(h))]]},"feature-state":[Yt,[wt],(h,[o])=>Md(o.evaluate(h),h.featureState||{})],properties:[ye,[],h=>h.properties()],"geometry-type":[wt,[],h=>h.geometryType()],id:[Yt,[],h=>h.id()],zoom:[tt,[],h=>h.globals.zoom],"heatmap-density":[tt,[],h=>h.globals.heatmapDensity||0],elevation:[tt,[],h=>h.globals.elevation||0],"line-progress":[tt,[],h=>h.globals.lineProgress||0],accumulated:[Yt,[],h=>h.globals.accumulated===void 0?null:h.globals.accumulated],"+":[tt,Jl(tt),(h,o)=>{let c=0;for(const g of o)c+=g.evaluate(h);return c}],"*":[tt,Jl(tt),(h,o)=>{let c=1;for(const g of o)c*=g.evaluate(h);return c}],"-":{type:tt,overloads:[[[tt,tt],(h,[o,c])=>o.evaluate(h)-c.evaluate(h)],[[tt],(h,[o])=>-o.evaluate(h)]]},"/":[tt,[tt,tt],(h,[o,c])=>o.evaluate(h)/c.evaluate(h)],"%":[tt,[tt,tt],(h,[o,c])=>o.evaluate(h)%c.evaluate(h)],ln2:[tt,[],()=>Math.LN2],pi:[tt,[],()=>Math.PI],e:[tt,[],()=>Math.E],"^":[tt,[tt,tt],(h,[o,c])=>Math.pow(o.evaluate(h),c.evaluate(h))],sqrt:[tt,[tt],(h,[o])=>Math.sqrt(o.evaluate(h))],log10:[tt,[tt],(h,[o])=>Math.log(o.evaluate(h))/Math.LN10],ln:[tt,[tt],(h,[o])=>Math.log(o.evaluate(h))],log2:[tt,[tt],(h,[o])=>Math.log(o.evaluate(h))/Math.LN2],sin:[tt,[tt],(h,[o])=>Math.sin(o.evaluate(h))],cos:[tt,[tt],(h,[o])=>Math.cos(o.evaluate(h))],tan:[tt,[tt],(h,[o])=>Math.tan(o.evaluate(h))],asin:[tt,[tt],(h,[o])=>Math.asin(o.evaluate(h))],acos:[tt,[tt],(h,[o])=>Math.acos(o.evaluate(h))],atan:[tt,[tt],(h,[o])=>Math.atan(o.evaluate(h))],min:[tt,Jl(tt),(h,o)=>Math.min(...o.map(c=>c.evaluate(h)))],max:[tt,Jl(tt),(h,o)=>Math.max(...o.map(c=>c.evaluate(h)))],abs:[tt,[tt],(h,[o])=>Math.abs(o.evaluate(h))],round:[tt,[tt],(h,[o])=>{const c=o.evaluate(h);return c<0?-Math.round(-c):Math.round(c)}],floor:[tt,[tt],(h,[o])=>Math.floor(o.evaluate(h))],ceil:[tt,[tt],(h,[o])=>Math.ceil(o.evaluate(h))],"filter-==":[Bt,[wt,Yt],(h,[o,c])=>h.properties()[o.value]===c.value],"filter-id-==":[Bt,[Yt],(h,[o])=>h.id()===o.value],"filter-type-==":[Bt,[wt],(h,[o])=>h.geometryType()===o.value],"filter-<":[Bt,[wt,Yt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g<x}],"filter-id-<":[Bt,[Yt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c<g}],"filter->":[Bt,[wt,Yt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g>x}],"filter-id->":[Bt,[Yt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c>g}],"filter-<=":[Bt,[wt,Yt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g<=x}],"filter-id-<=":[Bt,[Yt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c<=g}],"filter->=":[Bt,[wt,Yt],(h,[o,c])=>{const g=h.properties()[o.value],x=c.value;return typeof g==typeof x&&g>=x}],"filter-id->=":[Bt,[Yt],(h,[o])=>{const c=h.id(),g=o.value;return typeof c==typeof g&&c>=g}],"filter-has":[Bt,[Yt],(h,[o])=>o.value in h.properties()],"filter-has-id":[Bt,[],h=>h.id()!==null&&h.id()!==void 0],"filter-type-in":[Bt,[gr(wt)],(h,[o])=>o.value.indexOf(h.geometryType())>=0],"filter-id-in":[Bt,[gr(Yt)],(h,[o])=>o.value.indexOf(h.id())>=0],"filter-in-small":[Bt,[wt,gr(Yt)],(h,[o,c])=>c.value.indexOf(h.properties()[o.value])>=0],"filter-in-large":[Bt,[wt,gr(Yt)],(h,[o,c])=>function(g,x,T,A){for(;T<=A;){const z=T+A>>1;if(x[z]===g)return!0;x[z]>g?A=z-1:T=z+1}return!1}(h.properties()[o.value],c.value,0,c.value.length-1)],all:{type:Bt,overloads:[[[Bt,Bt],(h,[o,c])=>o.evaluate(h)&&c.evaluate(h)],[Jl(Bt),(h,o)=>{for(const c of o)if(!c.evaluate(h))return!1;return!0}]]},any:{type:Bt,overloads:[[[Bt,Bt],(h,[o,c])=>o.evaluate(h)||c.evaluate(h)],[Jl(Bt),(h,o)=>{for(const c of o)if(c.evaluate(h))return!0;return!1}]]},"!":[Bt,[Bt],(h,[o])=>!o.evaluate(h)],"is-supported-script":[Bt,[wt],(h,[o])=>{const c=h.globals&&h.globals.isSupportedScript;return!c||c(o.evaluate(h))}],upcase:[wt,[wt],(h,[o])=>o.evaluate(h).toUpperCase()],downcase:[wt,[wt],(h,[o])=>o.evaluate(h).toLowerCase()],concat:[wt,Jl(Yt),(h,o)=>o.map(c=>Ah(c.evaluate(h))).join("")],"resolved-locale":[wt,[xe],(h,[o])=>o.evaluate(h).resolvedLocale()]});class fu{constructor(o,c,g){this.expression=o,this._warningHistory={},this._evaluator=new rn,this._defaultValue=c?function(x){if(x.type==="color"&&Fh(x.default))return new un(0,0,0,0);switch(x.type){case"color":return un.parse(x.default)||null;case"padding":return ms.parse(x.default)||null;case"numberArray":return sa.parse(x.default)||null;case"colorArray":return Us.parse(x.default)||null;case"variableAnchorOffsetCollection":return Ds.parse(x.default)||null;case"projectionDefinition":return aa.parse(x.default)||null;default:return x.default===void 0?null:x.default}}(c):null,this._enumValues=c&&c.type==="enum"?c.values:null,this._globalState=g}evaluateWithoutErrorHandling(o,c,g,x,T,A){return this._globalState&&(o=mu(o,this._globalState)),this._evaluator.globals=o,this._evaluator.feature=c,this._evaluator.featureState=g,this._evaluator.canonical=x,this._evaluator.availableImages=T||null,this._evaluator.formattedSection=A,this.expression.evaluate(this._evaluator)}evaluate(o,c,g,x,T,A){this._globalState&&(o=mu(o,this._globalState)),this._evaluator.globals=o,this._evaluator.feature=c||null,this._evaluator.featureState=g||null,this._evaluator.canonical=x,this._evaluator.availableImages=T||null,this._evaluator.formattedSection=A||null;try{const z=this.expression.evaluate(this._evaluator);if(z==null||typeof z=="number"&&z!=z)return this._defaultValue;if(this._enumValues&&!(z in this._enumValues))throw new Xn(`Expected value to be one of ${Object.keys(this._enumValues).map(B=>JSON.stringify(B)).join(", ")}, but found ${JSON.stringify(z)} instead.`);return z}catch(z){return this._warningHistory[z.message]||(this._warningHistory[z.message]=!0,typeof console<"u"&&console.warn(z.message)),this._defaultValue}}}function _p(h){return Array.isArray(h)&&h.length>0&&typeof h[0]=="string"&&h[0]in Ia}function lo(h,o,c){const g=new lu(Ia,nh,[],o?function(T){const A={color:Ht,string:wt,number:tt,enum:wt,boolean:Bt,formatted:ti,padding:$e,numberArray:er,colorArray:Di,projectionDefinition:oe,resolvedImage:Ki,variableAnchorOffsetCollection:Hi};return T.type==="array"?gr(A[T.value]||Yt,T.length):A[T.type]}(o):void 0),x=g.parse(h,void 0,void 0,void 0,o&&o.type==="string"?{typeAnnotation:"coerce"}:void 0);return x?Cd(new fu(x,o,c)):ri(g.errors)}class Bh{constructor(o,c,g){this.kind=o,this._styleExpression=c,this.isStateDependent=o!=="constant"&&!Lh(c.expression),this.globalStateRefs=vp(c.expression),this._globalState=g}evaluateWithoutErrorHandling(o,c,g,x,T,A){return this._globalState&&(o=mu(o,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(o,c,g,x,T,A)}evaluate(o,c,g,x,T,A){return this._globalState&&(o=mu(o,this._globalState)),this._styleExpression.evaluate(o,c,g,x,T,A)}}class Yu{constructor(o,c,g,x,T){this.kind=o,this.zoomStops=g,this._styleExpression=c,this.isStateDependent=o!=="camera"&&!Lh(c.expression),this.globalStateRefs=vp(c.expression),this.interpolationType=x,this._globalState=T}evaluateWithoutErrorHandling(o,c,g,x,T,A){return this._globalState&&(o=mu(o,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(o,c,g,x,T,A)}evaluate(o,c,g,x,T,A){return this._globalState&&(o=mu(o,this._globalState)),this._styleExpression.evaluate(o,c,g,x,T,A)}interpolationFactor(o,c,g){return this.interpolationType?la.interpolationFactor(this.interpolationType,o,c,g):0}}function Hf(h,o,c){const g=lo(h,o,c);if(g.result==="error")return g;const x=g.value.expression,T=Wu(x);if(!T&&!Rh(o))return ri([new zo("","data expressions not supported")]);const A=Ba(x,["zoom"]);if(!A&&!pu(o))return ri([new zo("","zoom expressions not supported")]);const z=xp(x);return z||A?z instanceof zo?ri([z]):z instanceof la&&!kh(o)?ri([new zo("",'"interpolate" expressions cannot be used with this property')]):Cd(z?new Yu(T?"camera":"composite",g.value,z.labels,z instanceof la?z.interpolation:void 0,c):new Bh(T?"constant":"source",g.value,c)):ri([new zo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class yp{constructor(o,c){this._parameters=o,this._specification=c,Zo(this,Dd(this._parameters,this._specification))}static deserialize(o){return new yp(o._parameters,o._specification)}static serialize(o){return{_parameters:o._parameters,_specification:o._specification}}}function xp(h){let o=null;if(h instanceof Un)o=xp(h.result);else if(h instanceof fl){for(const c of h.args)if(o=xp(c),o)break}else(h instanceof Ph||h instanceof la)&&h.input instanceof ua&&h.input.name==="zoom"&&(o=h);return o instanceof zo||h.eachChild(c=>{const g=xp(c);g instanceof zo?o=g:!o&&g?o=new zo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):o&&g&&o!==g&&(o=new zo("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),o}function vp(h,o=new Set){return h instanceof du&&o.add(h.key),h.eachChild(c=>{vp(c,o)}),o}function mu(h,o){const{zoom:c,heatmapDensity:g,elevation:x,lineProgress:T,isSupportedScript:A,accumulated:z}=h??{};return{zoom:c,heatmapDensity:g,elevation:x,lineProgress:T,isSupportedScript:A,accumulated:z,globalState:o}}function bp(h){if(h===!0||h===!1)return!0;if(!Array.isArray(h)||h.length===0)return!1;switch(h[0]){case"has":return h.length>=2&&h[1]!=="$id"&&h[1]!=="$type";case"in":return h.length>=3&&(typeof h[1]!="string"||Array.isArray(h[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return h.length!==3||Array.isArray(h[1])||Array.isArray(h[2]);case"any":case"all":for(const o of h.slice(1))if(!bp(o)&&typeof o!="boolean")return!1;return!0;default:return!0}}const zd={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function Ld(h,o){if(h==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};bp(h)||(h=Oh(h));const c=lo(h,zd,o);if(c.result==="error")throw new Error(c.value.map(g=>`${g.key}: ${g.message}`).join(", "));return{filter:(g,x,T)=>c.value.evaluate(g,x,{},T),needGeometry:Rd(h),getGlobalStateRefs:()=>vp(c.value.expression)}}function Wf(h,o){return h<o?-1:h>o?1:0}function Rd(h){if(!Array.isArray(h))return!1;if(h[0]==="within"||h[0]==="distance")return!0;for(let o=1;o<h.length;o++)if(Rd(h[o]))return!0;return!1}function Oh(h){if(!h)return!0;const o=h[0];return h.length<=1?o!=="any":o==="=="?Ju(h[1],h[2],"=="):o==="!="?Vh(Ju(h[1],h[2],"==")):o==="<"||o===">"||o==="<="||o===">="?Ju(h[1],h[2],o):o==="any"?(c=h.slice(1),["any"].concat(c.map(Oh))):o==="all"?["all"].concat(h.slice(1).map(Oh)):o==="none"?["all"].concat(h.slice(1).map(Oh).map(Vh)):o==="in"?Nh(h[1],h.slice(2)):o==="!in"?Vh(Nh(h[1],h.slice(2))):o==="has"?gu(h[1]):o!=="!has"||Vh(gu(h[1]));var c}function Ju(h,o,c){switch(h){case"$type":return[`filter-type-${c}`,o];case"$id":return[`filter-id-${c}`,o];default:return[`filter-${c}`,h,o]}}function Nh(h,o){if(o.length===0)return!1;switch(h){case"$type":return["filter-type-in",["literal",o]];case"$id":return["filter-id-in",["literal",o]];default:return o.length>200&&!o.some(c=>typeof c!=typeof o[0])?["filter-in-large",h,["literal",o.sort(Wf)]]:["filter-in-small",h,["literal",o]]}}function gu(h){switch(h){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",h]}}function Vh(h){return["!",h]}function Uh(h){const o=typeof h;if(o==="number"||o==="boolean"||o==="string"||h==null)return JSON.stringify(h);if(Array.isArray(h)){let x="[";for(const T of h)x+=`${Uh(T)},`;return`${x}]`}const c=Object.keys(h).sort();let g="{";for(let x=0;x<c.length;x++)g+=`${JSON.stringify(c[x])}:${Uh(h[c[x]])},`;return`${g}}`}function pf(h){let o="";for(const c of De)o+=`/${Uh(h[c])}`;return o}function kd(h){const o=h.value;return o?[new bi(h.key,o,"constants have been deprecated as of v8")]:[]}function rs(h){return h instanceof Number||h instanceof String||h instanceof Boolean?h.valueOf():h}function yl(h){if(Array.isArray(h))return h.map(yl);if(h instanceof Object&&!(h instanceof Number||h instanceof String||h instanceof Boolean)){const o={};for(const c in h)o[c]=yl(h[c]);return o}return rs(h)}function Ea(h){const o=h.key,c=h.value,g=h.valueSpec||{},x=h.objectElementValidators||{},T=h.style,A=h.styleSpec,z=h.validateSpec;let B=[];const G=Pn(c);if(G!=="object")return[new bi(o,c,`object expected, ${G} found`)];for(const W in c){const Q=W.split(".")[0],ot=Hl(g,Q)||g["*"];let ct;if(Hl(x,Q))ct=x[Q];else if(Hl(g,Q))ct=z;else if(x["*"])ct=x["*"];else{if(!g["*"]){B.push(new bi(o,c[W],`unknown property "${W}"`));continue}ct=z}B=B.concat(ct({key:(o&&`${o}.`)+W,value:c[W],valueSpec:ot,style:T,styleSpec:A,object:c,objectKey:W,validateSpec:z},c))}for(const W in g)x[W]||g[W].required&&g[W].default===void 0&&c[W]===void 0&&B.push(new bi(o,c,`missing required property "${W}"`));return B}function jh(h){const o=h.value,c=h.valueSpec,g=h.style,x=h.styleSpec,T=h.key,A=h.arrayElementValidator||h.validateSpec;if(Pn(o)!=="array")return[new bi(T,o,`array expected, ${Pn(o)} found`)];if(c.length&&o.length!==c.length)return[new bi(T,o,`array length ${c.length} expected, length ${o.length} found`)];if(c["min-length"]&&o.length<c["min-length"])return[new bi(T,o,`array length at least ${c["min-length"]} expected, length ${o.length} found`)];let z={type:c.value,values:c.values};x.$version<7&&(z.function=c.function),Pn(c.value)==="object"&&(z=c.value);let B=[];for(let G=0;G<o.length;G++)B=B.concat(A({array:o,arrayIndex:G,value:o[G],valueSpec:z,validateSpec:h.validateSpec,style:g,styleSpec:x,key:`${T}[${G}]`}));return B}function oh(h){const o=h.key,c=h.value,g=h.valueSpec;let x=Pn(c);return x==="number"&&c!=c&&(x="NaN"),x!=="number"?[new bi(o,c,`number expected, ${x} found`)]:"minimum"in g&&c<g.minimum?[new bi(o,c,`${c} is less than the minimum value ${g.minimum}`)]:"maximum"in g&&c>g.maximum?[new bi(o,c,`${c} is greater than the maximum value ${g.maximum}`)]:[]}function Fd(h){const o=h.valueSpec,c=rs(h.value.type);let g,x,T,A={};const z=c!=="categorical"&&h.value.property===void 0,B=!z,G=Pn(h.value.stops)==="array"&&Pn(h.value.stops[0])==="array"&&Pn(h.value.stops[0][0])==="object",W=Ea({key:h.key,value:h.value,valueSpec:h.styleSpec.function,validateSpec:h.validateSpec,style:h.style,styleSpec:h.styleSpec,objectElementValidators:{stops:function(ct){if(c==="identity")return[new bi(ct.key,ct.value,'identity function may not have a "stops" property')];let ut=[];const xt=ct.value;return ut=ut.concat(jh({key:ct.key,value:xt,valueSpec:ct.valueSpec,validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec,arrayElementValidator:Q})),Pn(xt)==="array"&&xt.length===0&&ut.push(new bi(ct.key,xt,"array must have at least one stop")),ut},default:function(ct){return ct.validateSpec({key:ct.key,value:ct.value,valueSpec:o,validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec})}}});return c==="identity"&&z&&W.push(new bi(h.key,h.value,'missing required property "property"')),c==="identity"||h.value.stops||W.push(new bi(h.key,h.value,'missing required property "stops"')),c==="exponential"&&h.valueSpec.expression&&!kh(h.valueSpec)&&W.push(new bi(h.key,h.value,"exponential functions not supported")),h.styleSpec.$version>=8&&(B&&!Rh(h.valueSpec)?W.push(new bi(h.key,h.value,"property functions not supported")):z&&!pu(h.valueSpec)&&W.push(new bi(h.key,h.value,"zoom functions not supported"))),c!=="categorical"&&!G||h.value.property!==void 0||W.push(new bi(h.key,h.value,'"property" property is required')),W;function Q(ct){let ut=[];const xt=ct.value,Et=ct.key;if(Pn(xt)!=="array")return[new bi(Et,xt,`array expected, ${Pn(xt)} found`)];if(xt.length!==2)return[new bi(Et,xt,`array length 2 expected, length ${xt.length} found`)];if(G){if(Pn(xt[0])!=="object")return[new bi(Et,xt,`object expected, ${Pn(xt[0])} found`)];if(xt[0].zoom===void 0)return[new bi(Et,xt,"object stop key must have zoom")];if(xt[0].value===void 0)return[new bi(Et,xt,"object stop key must have value")];if(T&&T>rs(xt[0].zoom))return[new bi(Et,xt[0].zoom,"stop zoom values must appear in ascending order")];rs(xt[0].zoom)!==T&&(T=rs(xt[0].zoom),x=void 0,A={}),ut=ut.concat(Ea({key:`${Et}[0]`,value:xt[0],valueSpec:{zoom:{}},validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec,objectElementValidators:{zoom:oh,value:ot}}))}else ut=ut.concat(ot({key:`${Et}[0]`,value:xt[0],validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec},xt));return _p(yl(xt[1]))?ut.concat([new bi(`${Et}[1]`,xt[1],"expressions are not allowed in function stops.")]):ut.concat(ct.validateSpec({key:`${Et}[1]`,value:xt[1],valueSpec:o,validateSpec:ct.validateSpec,style:ct.style,styleSpec:ct.styleSpec}))}function ot(ct,ut){const xt=Pn(ct.value),Et=rs(ct.value),Vt=ct.value!==null?ct.value:ut;if(g){if(xt!==g)return[new bi(ct.key,Vt,`${xt} stop domain type must match previous stop domain type ${g}`)]}else g=xt;if(xt!=="number"&&xt!=="string"&&xt!=="boolean")return[new bi(ct.key,Vt,"stop domain value must be a number, string, or boolean")];if(xt!=="number"&&c!=="categorical"){let ue=`number expected, ${xt} found`;return Rh(o)&&c===void 0&&(ue+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new bi(ct.key,Vt,ue)]}return c!=="categorical"||xt!=="number"||isFinite(Et)&&Math.floor(Et)===Et?c!=="categorical"&&xt==="number"&&x!==void 0&&Et<x?[new bi(ct.key,Vt,"stop domain values must appear in ascending order")]:(x=Et,c==="categorical"&&Et in A?[new bi(ct.key,Vt,"stop domain values must be unique")]:(A[Et]=!0,[])):[new bi(ct.key,Vt,`integer expected, found ${Et}`)]}}function Bc(h){const o=(h.expressionContext==="property"?Hf:lo)(yl(h.value),h.valueSpec);if(o.result==="error")return o.value.map(g=>new bi(`${h.key}${g.key}`,h.value,g.message));const c=o.value.expression||o.value._styleExpression.expression;if(h.expressionContext==="property"&&h.propertyKey==="text-font"&&!c.outputDefined())return[new bi(h.key,h.value,`Invalid data expression for "${h.propertyKey}". Output values must be contained as literals within the expression.`)];if(h.expressionContext==="property"&&h.propertyType==="layout"&&!Lh(c))return[new bi(h.key,h.value,'"feature-state" data expressions are not supported with layout properties.')];if(h.expressionContext==="filter"&&!Lh(c))return[new bi(h.key,h.value,'"feature-state" data expressions are not supported with filters.')];if(h.expressionContext&&h.expressionContext.indexOf("cluster")===0){if(!Ba(c,["zoom","feature-state"]))return[new bi(h.key,h.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(h.expressionContext==="cluster-initial"&&!Wu(c))return[new bi(h.key,h.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function wp(h){const o=h.key,c=h.value,g=Pn(c);return g!=="string"?[new bi(o,c,`color expected, ${g} found`)]:un.parse(String(c))?[]:[new bi(o,c,`color expected, "${c}" found`)]}function Ku(h){const o=h.key,c=h.value,g=h.valueSpec,x=[];return Array.isArray(g.values)?g.values.indexOf(rs(c))===-1&&x.push(new bi(o,c,`expected one of [${g.values.join(", ")}], ${JSON.stringify(c)} found`)):Object.keys(g.values).indexOf(rs(c))===-1&&x.push(new bi(o,c,`expected one of [${Object.keys(g.values).join(", ")}], ${JSON.stringify(c)} found`)),x}function Tp(h){return bp(yl(h.value))?Bc(Zo({},h,{expressionContext:"filter",valueSpec:{value:"boolean"}})):_u(h)}function _u(h){const o=h.value,c=h.key;if(Pn(o)!=="array")return[new bi(c,o,`array expected, ${Pn(o)} found`)];const g=h.styleSpec;let x,T=[];if(o.length<1)return[new bi(c,o,"filter array must have at least 1 element")];switch(T=T.concat(Ku({key:`${c}[0]`,value:o[0],valueSpec:g.filter_operator,style:h.style,styleSpec:h.styleSpec})),rs(o[0])){case"<":case"<=":case">":case">=":o.length>=2&&rs(o[1])==="$type"&&T.push(new bi(c,o,`"$type" cannot be use with operator "${o[0]}"`));case"==":case"!=":o.length!==3&&T.push(new bi(c,o,`filter array for operator "${o[0]}" must have 3 elements`));case"in":case"!in":o.length>=2&&(x=Pn(o[1]),x!=="string"&&T.push(new bi(`${c}[1]`,o[1],`string expected, ${x} found`)));for(let A=2;A<o.length;A++)x=Pn(o[A]),rs(o[1])==="$type"?T=T.concat(Ku({key:`${c}[${A}]`,value:o[A],valueSpec:g.geometry_type,style:h.style,styleSpec:h.styleSpec})):x!=="string"&&x!=="number"&&x!=="boolean"&&T.push(new bi(`${c}[${A}]`,o[A],`string, number, or boolean expected, ${x} found`));break;case"any":case"all":case"none":for(let A=1;A<o.length;A++)T=T.concat(_u({key:`${c}[${A}]`,value:o[A],style:h.style,styleSpec:h.styleSpec}));break;case"has":case"!has":x=Pn(o[1]),o.length!==2?T.push(new bi(c,o,`filter array for "${o[0]}" operator must have 2 elements`)):x!=="string"&&T.push(new bi(`${c}[1]`,o[1],`string expected, ${x} found`))}return T}function Qu(h,o){const c=h.key,g=h.validateSpec,x=h.style,T=h.styleSpec,A=h.value,z=h.objectKey,B=T[`${o}_${h.layerType}`];if(!B)return[];const G=z.match(/^(.*)-transition$/);if(o==="paint"&&G&&B[G[1]]&&B[G[1]].transition)return g({key:c,value:A,valueSpec:T.transition,style:x,styleSpec:T});const W=h.valueSpec||B[z];if(!W)return[new bi(c,A,`unknown property "${z}"`)];let Q;if(Pn(A)==="string"&&Rh(W)&&!W.tokens&&(Q=/^{([^}]+)}$/.exec(A)))return[new bi(c,A,`"${z}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(Q[1])} }\`.`)];const ot=[];return h.layerType==="symbol"&&z==="text-font"&&Fh(yl(A))&&rs(A.type)==="identity"&&ot.push(new bi(c,A,'"text-font" does not support identity functions')),ot.concat(g({key:h.key,value:A,valueSpec:W,style:x,styleSpec:T,expressionContext:"property",propertyType:o,propertyKey:z}))}function ff(h){return Qu(h,"paint")}function td(h){return Qu(h,"layout")}function Xf(h){let o=[];const c=h.value,g=h.key,x=h.style,T=h.styleSpec;if(Pn(c)!=="object")return[new bi(g,c,`object expected, ${Pn(c)} found`)];c.type||c.ref||o.push(new bi(g,c,'either "type" or "ref" is required'));let A=rs(c.type);const z=rs(c.ref);if(c.id){const B=rs(c.id);for(let G=0;G<h.arrayIndex;G++){const W=x.layers[G];rs(W.id)===B&&o.push(new bi(g,c.id,`duplicate layer id "${c.id}", previously used at line ${W.id.__line__}`))}}if("ref"in c){let B;["type","source","source-layer","filter","layout"].forEach(G=>{G in c&&o.push(new bi(g,c[G],`"${G}" is prohibited for ref layers`))}),x.layers.forEach(G=>{rs(G.id)===z&&(B=G)}),B?B.ref?o.push(new bi(g,c.ref,"ref cannot reference another ref layer")):A=rs(B.type):o.push(new bi(g,c.ref,`ref layer "${z}" not found`))}else if(A!=="background")if(c.source){const B=x.sources&&x.sources[c.source],G=B&&rs(B.type);B?G==="vector"&&A==="raster"?o.push(new bi(g,c.source,`layer "${c.id}" requires a raster source`)):G!=="raster-dem"&&A==="hillshade"||G!=="raster-dem"&&A==="color-relief"?o.push(new bi(g,c.source,`layer "${c.id}" requires a raster-dem source`)):G==="raster"&&A!=="raster"?o.push(new bi(g,c.source,`layer "${c.id}" requires a vector source`)):G!=="vector"||c["source-layer"]?G==="raster-dem"&&A!=="hillshade"&&A!=="color-relief"?o.push(new bi(g,c.source,"raster-dem source can only be used with layer type 'hillshade' or 'color-relief'.")):A!=="line"||!c.paint||!c.paint["line-gradient"]||G==="geojson"&&B.lineMetrics||o.push(new bi(g,c,`layer "${c.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):o.push(new bi(g,c,`layer "${c.id}" must specify a "source-layer"`)):o.push(new bi(g,c.source,`source "${c.source}" not found`))}else o.push(new bi(g,c,'missing required property "source"'));return o=o.concat(Ea({key:g,value:c,valueSpec:T.layer,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,objectElementValidators:{"*":()=>[],type:()=>h.validateSpec({key:`${g}.type`,value:c.type,valueSpec:T.layer.type,style:h.style,styleSpec:h.styleSpec,validateSpec:h.validateSpec,object:c,objectKey:"type"}),filter:Tp,layout:B=>Ea({layer:c,key:B.key,value:B.value,style:B.style,styleSpec:B.styleSpec,validateSpec:B.validateSpec,objectElementValidators:{"*":G=>td(Zo({layerType:A},G))}}),paint:B=>Ea({layer:c,key:B.key,value:B.value,style:B.style,styleSpec:B.styleSpec,validateSpec:B.validateSpec,objectElementValidators:{"*":G=>ff(Zo({layerType:A},G))}})}})),o}function Oc(h){const o=h.value,c=h.key,g=Pn(o);return g!=="string"?[new bi(c,o,`string expected, ${g} found`)]:[]}const Bd={promoteId:function({key:h,value:o}){if(Pn(o)==="string")return Oc({key:h,value:o});{const c=[];for(const g in o)c.push(...Oc({key:`${h}.${g}`,value:o[g]}));return c}}};function Od(h){const o=h.value,c=h.key,g=h.styleSpec,x=h.style,T=h.validateSpec;if(!o.type)return[new bi(c,o,'"type" is required')];const A=rs(o.type);let z;switch(A){case"vector":case"raster":return z=Ea({key:c,value:o,valueSpec:g[`source_${A.replace("-","_")}`],style:h.style,styleSpec:g,objectElementValidators:Bd,validateSpec:T}),z;case"raster-dem":return z=function(B){var G;const W=(G=B.sourceName)!==null&&G!==void 0?G:"",Q=B.value,ot=B.styleSpec,ct=ot.source_raster_dem,ut=B.style;let xt=[];const Et=Pn(Q);if(Q===void 0)return xt;if(Et!=="object")return xt.push(new bi("source_raster_dem",Q,`object expected, ${Et} found`)),xt;const Vt=rs(Q.encoding)==="custom",ue=["redFactor","greenFactor","blueFactor","baseShift"],Qt=B.value.encoding?`"${B.value.encoding}"`:"Default";for(const ee in Q)!Vt&&ue.includes(ee)?xt.push(new bi(ee,Q[ee],`In "${W}": "${ee}" is only valid when "encoding" is set to "custom". ${Qt} encoding found`)):ct[ee]?xt=xt.concat(B.validateSpec({key:ee,value:Q[ee],valueSpec:ct[ee],validateSpec:B.validateSpec,style:ut,styleSpec:ot})):xt.push(new bi(ee,Q[ee],`unknown property "${ee}"`));return xt}({sourceName:c,value:o,style:h.style,styleSpec:g,validateSpec:T}),z;case"geojson":if(z=Ea({key:c,value:o,valueSpec:g.source_geojson,style:x,styleSpec:g,validateSpec:T,objectElementValidators:Bd}),o.cluster)for(const B in o.clusterProperties){const[G,W]=o.clusterProperties[B],Q=typeof G=="string"?[G,["accumulated"],["get",B]]:G;z.push(...Bc({key:`${c}.${B}.map`,value:W,expressionContext:"cluster-map"})),z.push(...Bc({key:`${c}.${B}.reduce`,value:Q,expressionContext:"cluster-reduce"}))}return z;case"video":return Ea({key:c,value:o,valueSpec:g.source_video,style:x,validateSpec:T,styleSpec:g});case"image":return Ea({key:c,value:o,valueSpec:g.source_image,style:x,validateSpec:T,styleSpec:g});case"canvas":return[new bi(c,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Ku({key:`${c}.type`,value:o.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function ed(h){const o=h.value,c=h.styleSpec,g=c.light,x=h.style;let T=[];const A=Pn(o);if(o===void 0)return T;if(A!=="object")return T=T.concat([new bi("light",o,`object expected, ${A} found`)]),T;for(const z in o){const B=z.match(/^(.*)-transition$/);T=T.concat(B&&g[B[1]]&&g[B[1]].transition?h.validateSpec({key:z,value:o[z],valueSpec:c.transition,validateSpec:h.validateSpec,style:x,styleSpec:c}):g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],validateSpec:h.validateSpec,style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)])}return T}function sh(h){const o=h.value,c=h.styleSpec,g=c.sky,x=h.style,T=Pn(o);if(o===void 0)return[];if(T!=="object")return[new bi("sky",o,`object expected, ${T} found`)];let A=[];for(const z in o)A=A.concat(g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)]);return A}function Gh(h){const o=h.value,c=h.styleSpec,g=c.terrain,x=h.style;let T=[];const A=Pn(o);if(o===void 0)return T;if(A!=="object")return T=T.concat([new bi("terrain",o,`object expected, ${A} found`)]),T;for(const z in o)T=T.concat(g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],validateSpec:h.validateSpec,style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)]);return T}function mf(h){let o=[];const c=h.value,g=h.key;if(Array.isArray(c)){const x=[],T=[];for(const A in c)c[A].id&&x.includes(c[A].id)&&o.push(new bi(g,c,`all the sprites' ids must be unique, but ${c[A].id} is duplicated`)),x.push(c[A].id),c[A].url&&T.includes(c[A].url)&&o.push(new bi(g,c,`all the sprites' URLs must be unique, but ${c[A].url} is duplicated`)),T.push(c[A].url),o=o.concat(Ea({key:`${g}[${A}]`,value:c[A],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:h.validateSpec}));return o}return Oc({key:g,value:c})}function id(h){return o=h.value,o&&o.constructor===Object?[]:[new bi(h.key,h.value,`object expected, ${Pn(h.value)} found`)];var o}const $h={"*":()=>[],array:jh,boolean:function(h){const o=h.value,c=h.key,g=Pn(o);return g!=="boolean"?[new bi(c,o,`boolean expected, ${g} found`)]:[]},number:oh,color:wp,constants:kd,enum:Ku,filter:Tp,function:Fd,layer:Xf,object:Ea,source:Od,light:ed,sky:sh,terrain:Gh,projection:function(h){const o=h.value,c=h.styleSpec,g=c.projection,x=h.style,T=Pn(o);if(o===void 0)return[];if(T!=="object")return[new bi("projection",o,`object expected, ${T} found`)];let A=[];for(const z in o)A=A.concat(g[z]?h.validateSpec({key:z,value:o[z],valueSpec:g[z],style:x,styleSpec:c}):[new bi(z,o[z],`unknown property "${z}"`)]);return A},projectionDefinition:function(h){const o=h.key;let c=h.value;c=c instanceof String?c.valueOf():c;const g=Pn(c);return g!=="array"||function(x){return Array.isArray(x)&&x.length===3&&typeof x[0]=="string"&&typeof x[1]=="string"&&typeof x[2]=="number"}(c)||function(x){return!!["interpolate","step","literal"].includes(x[0])}(c)?["array","string"].includes(g)?[]:[new bi(o,c,`projection expected, invalid type "${g}" found`)]:[new bi(o,c,`projection expected, invalid array ${JSON.stringify(c)} found`)]},string:Oc,formatted:function(h){return Oc(h).length===0?[]:Bc(h)},resolvedImage:function(h){return Oc(h).length===0?[]:Bc(h)},padding:function(h){const o=h.key,c=h.value;if(Pn(c)==="array"){if(c.length<1||c.length>4)return[new bi(o,c,`padding requires 1 to 4 values; ${c.length} values found`)];const g={type:"number"};let x=[];for(let T=0;T<c.length;T++)x=x.concat(h.validateSpec({key:`${o}[${T}]`,value:c[T],validateSpec:h.validateSpec,valueSpec:g}));return x}return oh({key:o,value:c,valueSpec:{}})},numberArray:function(h){const o=h.key,c=h.value;if(Pn(c)==="array"){const g={type:"number"};if(c.length<1)return[new bi(o,c,"array length at least 1 expected, length 0 found")];let x=[];for(let T=0;T<c.length;T++)x=x.concat(h.validateSpec({key:`${o}[${T}]`,value:c[T],validateSpec:h.validateSpec,valueSpec:g}));return x}return oh({key:o,value:c,valueSpec:{}})},colorArray:function(h){const o=h.key,c=h.value;if(Pn(c)==="array"){if(c.length<1)return[new bi(o,c,"array length at least 1 expected, length 0 found")];let g=[];for(let x=0;x<c.length;x++)g=g.concat(wp({key:`${o}[${x}]`,value:c[x]}));return g}return wp({key:o,value:c})},variableAnchorOffsetCollection:function(h){const o=h.key,c=h.value,g=Pn(c),x=h.styleSpec;if(g!=="array"||c.length<1||c.length%2!=0)return[new bi(o,c,"variableAnchorOffsetCollection requires a non-empty array of even length")];let T=[];for(let A=0;A<c.length;A+=2)T=T.concat(Ku({key:`${o}[${A}]`,value:c[A],valueSpec:x.layout_symbol["text-anchor"]})),T=T.concat(jh({key:`${o}[${A+1}]`,value:c[A+1],valueSpec:{length:2,value:"number"},validateSpec:h.validateSpec,style:h.style,styleSpec:x}));return T},sprite:mf,state:id};function yu(h){const o=h.value,c=h.valueSpec,g=h.styleSpec;return h.validateSpec=yu,c.expression&&Fh(rs(o))?Fd(h):c.expression&&_p(yl(o))?Bc(h):c.type&&$h[c.type]?$h[c.type](h):Ea(Zo({},h,{valueSpec:c.type?g[c.type]:c}))}function xl(h){const o=h.value,c=h.key,g=Oc(h);return g.length||(o.indexOf("{fontstack}")===-1&&g.push(new bi(c,o,'"glyphs" url must include a "{fontstack}" token')),o.indexOf("{range}")===-1&&g.push(new bi(c,o,'"glyphs" url must include a "{range}" token'))),g}function vl(h,o=Jt){let c=[];return c=c.concat(yu({key:"",value:h,valueSpec:o.$root,styleSpec:o,style:h,validateSpec:yu,objectElementValidators:{glyphs:xl,"*":()=>[]}})),h.constants&&(c=c.concat(kd({key:"constants",value:h.constants}))),Nc(c)}function Qs(h){return function(o){return h(Object.assign({},o,{validateSpec:yu}))}}function Nc(h){return[].concat(h).sort((o,c)=>o.line-c.line)}function ns(h){return function(...o){return Nc(h.apply(this,o))}}vl.source=ns(Qs(Od)),vl.sprite=ns(Qs(mf)),vl.glyphs=ns(Qs(xl)),vl.light=ns(Qs(ed)),vl.sky=ns(Qs(sh)),vl.terrain=ns(Qs(Gh)),vl.state=ns(Qs(id)),vl.layer=ns(Qs(Xf)),vl.filter=ns(Qs(Tp)),vl.paintProperty=ns(Qs(ff)),vl.layoutProperty=ns(Qs(td));const xu=Jt,ah=vl,Nd=ah.light,Sp=ah.sky,Vc=ah.paintProperty,Vd=ah.layoutProperty;function vu(h,o){let c=!1;if(o&&o.length)for(const g of o)h.fire(new ae(new Error(g.message))),c=!0;return c}class rd{constructor(o,c,g){const x=this.cells=[];if(o instanceof ArrayBuffer){this.arrayBuffer=o;const A=new Int32Array(this.arrayBuffer);o=A[0],this.d=(c=A[1])+2*(g=A[2]);for(let B=0;B<this.d*this.d;B++){const G=A[3+B],W=A[3+B+1];x.push(G===W?null:A.subarray(G,W))}const z=A[3+x.length+1];this.keys=A.subarray(A[3+x.length],z),this.bboxes=A.subarray(z),this.insert=this._insertReadonly}else{this.d=c+2*g;for(let A=0;A<this.d*this.d;A++)x.push([]);this.keys=[],this.bboxes=[]}this.n=c,this.extent=o,this.padding=g,this.scale=c/o,this.uid=0;const T=g/c*o;this.min=-T,this.max=o+T}insert(o,c,g,x,T){this._forEachCell(c,g,x,T,this._insertCell,this.uid++,void 0,void 0),this.keys.push(o),this.bboxes.push(c),this.bboxes.push(g),this.bboxes.push(x),this.bboxes.push(T)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(o,c,g,x,T,A){this.cells[T].push(A)}query(o,c,g,x,T){const A=this.min,z=this.max;if(o<=A&&c<=A&&z<=g&&z<=x&&!T)return Array.prototype.slice.call(this.keys);{const B=[];return this._forEachCell(o,c,g,x,this._queryCell,B,{},T),B}}_queryCell(o,c,g,x,T,A,z,B){const G=this.cells[T];if(G!==null){const W=this.keys,Q=this.bboxes;for(let ot=0;ot<G.length;ot++){const ct=G[ot];if(z[ct]===void 0){const ut=4*ct;(B?B(Q[ut+0],Q[ut+1],Q[ut+2],Q[ut+3]):o<=Q[ut+2]&&c<=Q[ut+3]&&g>=Q[ut+0]&&x>=Q[ut+1])?(z[ct]=!0,A.push(W[ct])):z[ct]=!1}}}}_forEachCell(o,c,g,x,T,A,z,B){const G=this._convertToCellCoord(o),W=this._convertToCellCoord(c),Q=this._convertToCellCoord(g),ot=this._convertToCellCoord(x);for(let ct=G;ct<=Q;ct++)for(let ut=W;ut<=ot;ut++){const xt=this.d*ut+ct;if((!B||B(this._convertFromCellCoord(ct),this._convertFromCellCoord(ut),this._convertFromCellCoord(ct+1),this._convertFromCellCoord(ut+1)))&&T.call(this,o,c,g,x,xt,A,z,B))return}}_convertFromCellCoord(o){return(o-this.padding)/this.scale}_convertToCellCoord(o){return Math.max(0,Math.min(this.d-1,Math.floor(o*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const o=this.cells,c=3+this.cells.length+1+1;let g=0;for(let A=0;A<this.cells.length;A++)g+=this.cells[A].length;const x=new Int32Array(c+g+this.keys.length+this.bboxes.length);x[0]=this.extent,x[1]=this.n,x[2]=this.padding;let T=c;for(let A=0;A<o.length;A++){const z=o[A];x[3+A]=T,x.set(z,T),T+=z.length}return x[3+o.length]=T,x.set(this.keys,T),T+=this.keys.length,x[3+o.length+1]=T,x.set(this.bboxes,T),T+=this.bboxes.length,x.buffer}static serialize(o,c){const g=o.toArrayBuffer();return c&&c.push(g),{buffer:g}}static deserialize(o){return new rd(o.buffer)}}const Kl={};function ir(h,o,c={}){if(Kl[h])throw new Error(`${h} is already registered.`);Object.defineProperty(o,"_classRegistryKey",{value:h,writeable:!1}),Kl[h]={klass:o,omit:c.omit||[],shallow:c.shallow||[]}}ir("Object",Object),ir("Set",Set),ir("TransferableGridIndex",rd),ir("Color",un),ir("Error",Error),ir("AJAXError",Da),ir("ResolvedImage",js),ir("StylePropertyFunction",yp),ir("StyleExpression",fu,{omit:["_evaluator"]}),ir("ZoomDependentExpression",Yu),ir("ZoomConstantExpression",Bh),ir("CompoundExpression",ua,{omit:["_evaluate"]});for(const h in Ia)Ia[h]._classRegistryKey||ir(`Expression_${h}`,Ia[h]);function bu(h){return h&&typeof ArrayBuffer<"u"&&(h instanceof ArrayBuffer||h.constructor&&h.constructor.name==="ArrayBuffer")}function Ip(h){return h.$name||h.constructor._classRegistryKey}function Yf(h){return!function(o){if(o===null||typeof o!="object")return!1;const c=Ip(o);return!(!c||c==="Object")}(h)&&(h==null||typeof h=="boolean"||typeof h=="number"||typeof h=="string"||h instanceof Boolean||h instanceof Number||h instanceof String||h instanceof Date||h instanceof RegExp||h instanceof Blob||h instanceof Error||bu(h)||oo(h)||ArrayBuffer.isView(h)||h instanceof ImageData)}function Ud(h,o){if(Yf(h))return(bu(h)||oo(h))&&o&&o.push(h),ArrayBuffer.isView(h)&&o&&o.push(h.buffer),h instanceof ImageData&&o&&o.push(h.data.buffer),h;if(Array.isArray(h)){const T=[];for(const A of h)T.push(Ud(A,o));return T}if(typeof h!="object")throw new Error("can't serialize object of type "+typeof h);const c=Ip(h);if(!c)throw new Error(`can't serialize object of unregistered class ${h.constructor.name}`);if(!Kl[c])throw new Error(`${c} is not registered.`);const{klass:g}=Kl[c],x=g.serialize?g.serialize(h,o):{};if(g.serialize){if(o&&x===o[o.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const T in h){if(!h.hasOwnProperty(T)||Kl[c].omit.indexOf(T)>=0)continue;const A=h[T];x[T]=Kl[c].shallow.indexOf(T)>=0?A:Ud(A,o)}h instanceof Error&&(x.message=h.message)}if(x.$name)throw new Error("$name property is reserved for worker serialization logic.");return c!=="Object"&&(x.$name=c),x}function lh(h){if(Yf(h))return h;if(Array.isArray(h))return h.map(lh);if(typeof h!="object")throw new Error("can't deserialize object of type "+typeof h);const o=Ip(h)||"Object";if(!Kl[o])throw new Error(`can't deserialize unregistered class ${o}`);const{klass:c}=Kl[o];if(!c)throw new Error(`can't deserialize unregistered class ${o}`);if(c.deserialize)return c.deserialize(h);const g=Object.create(c.prototype);for(const x of Object.keys(h)){if(x==="$name")continue;const T=h[x];g[x]=Kl[o].shallow.indexOf(x)>=0?T:lh(T)}return g}class nd{constructor(){this.first=!0}update(o,c){const g=Math.floor(o);return this.first?(this.first=!1,this.lastIntegerZoom=g,this.lastIntegerZoomTime=0,this.lastZoom=o,this.lastFloorZoom=g,!0):(this.lastFloorZoom>g?(this.lastIntegerZoom=g+1,this.lastIntegerZoomTime=c):this.lastFloorZoom<g&&(this.lastIntegerZoom=g,this.lastIntegerZoomTime=c),o!==this.lastZoom&&(this.lastZoom=o,this.lastFloorZoom=g,!0))}}function gf(h){return/[\u02EA\u02EB\u2E80-\u2FDF\u2FF0-\u303F\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FD-\u30FF\u3105-\u312F\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))}function qh(h){return/[\u02EA\u02EB\u1100-\u11FF\u1400-\u167F\u18B0-\u18F5\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u3007\u3012\u3013\u3020-\u302F\u3031-\u303F\u3041-\u3096\u309D-\u30FB\u30FD-\u30FF\u3105-\u312F\u3131-\u318E\u3190-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE48\uFE50-\uFE57\uFE5F-\uFE62\uFE67-\uFE6F\uFF00-\uFF07\uFF0A-\uFF0C\uFF0E-\uFF19\uFF1F-\uFF3A\uFF3C\uFF3E\uFF40-\uFF5A\uFFE0-\uFFE2\uFFE4-\uFFE7]|\uD802[\uDD80-\uDD9F]|\uD805[\uDD80-\uDDFF]|\uD806[\uDE00-\uDEBF]|\uD811[\uDC00-\uDE7F]|\uD81B[\uDFE0-\uDFE4\uDFF0-\uDFF6]|[\uD81C-\uD822\uD83D\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD30-\uDEFB]|\uD833[\uDEC0-\uDFCF]|\uD834[\uDC00-\uDDFF\uDEE0-\uDF7F]|\uD836[\uDC00-\uDEAF]|\uD83C[\uDC00-\uDE00\uDF00-\uDFFF]|\uD83E[\uDD00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))}function _f(h){return/\s/u.test(String.fromCodePoint(h))}function Uc(h){for(const o of h)if(qh(o.codePointAt(0)))return!0;return!1}function od(h){for(const o of h)if(!jd(o.codePointAt(0)))return!1;return!0}function Ep(h){const o=h.map(c=>{try{return new RegExp(`\\p{sc=${c}}`,"u").source}catch{return null}}).filter(c=>c);return new RegExp(o.join("|"),"u")}const yf=Ep(["Arab","Dupl","Mong","Ougr","Syrc"]);function jd(h){return!yf.test(String.fromCodePoint(h))}function fc(h){return!(qh(h)||(o=h,/[\xA7\xA9\xAE\xB1\xBC-\xBE\xD7\xF7\u2016\u2020\u2021\u2030\u2031\u203B\u203C\u2042\u2047-\u2049\u2051\u2100-\u218F\u221E\u2234\u2235\u2300-\u2307\u230C-\u231F\u2324-\u2328\u232B\u237D-\u239A\u23BE-\u23CD\u23CF\u23D1-\u23DB\u23E2-\u2422\u2424-\u24FF\u25A0-\u2619\u2620-\u2767\u2776-\u2793\u2B12-\u2B2F\u2B50-\u2B59\u2BB8-\u2BEB\u3000-\u303F\u30A0-\u30FF\uE000-\uF8FF\uFE30-\uFE6F\uFF00-\uFFEF\uFFFC\uFFFD]|[\uDB80-\uDBFF][\uDC00-\uDFFF]/gim.test(String.fromCodePoint(o))));var o}const wu=Ep(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function sd(h){return wu.test(String.fromCodePoint(h))}function Tu(h,o){return!(!o&&sd(h)||/[\u0900-\u0DFF\u0F00-\u109F\u1780-\u17FF]/gim.test(String.fromCodePoint(h)))}function ch(h){for(const o of h)if(sd(o.codePointAt(0)))return!0;return!1}const jc=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(h){this.pluginStatus=h.pluginStatus,this.pluginURL=h.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(h){if(jc.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=h.applyArabicShaping,this.processBidirectionalText=h.processBidirectionalText,this.processStyledBidirectionalText=h.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(h,o){return i(this,void 0,void 0,function*(){if(this.isParsed())return this.getState();if(h.pluginStatus!=="loading")return this.setState(h),h;const c=h.pluginURL,g=new Promise(T=>{this.loadScriptResolve=T});o(c);const x=new Promise(T=>setTimeout(()=>T(),this.TIMEOUT));if(yield Promise.race([g,x]),this.isParsed()){const T={pluginStatus:"loaded",pluginURL:c};return this.setState(T),T}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${c}`)})}};class wo{constructor(o,c){this.isSupportedScript=xf,this.zoom=o,c?(this.now=c.now||0,this.fadeDuration=c.fadeDuration||0,this.zoomHistory=c.zoomHistory||new nd,this.transition=c.transition||{}):(this.now=0,this.fadeDuration=0,this.zoomHistory=new nd,this.transition={})}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const o=this.zoom,c=o-Math.floor(o),g=this.crossFadingFactor();return o>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:c+(1-c)*g}:{fromScale:.5,toScale:1,t:1-(1-g)*c}}}function xf(h){return function(o,c){for(const g of o)if(!Tu(g.codePointAt(0),c))return!1;return!0}(h,jc.getRTLTextPluginStatus()==="loaded")}const Su="-transition";class Zh{constructor(o,c,g){this.property=o,this.value=c,this.expression=function(x,T,A){if(Fh(x))return new yp(x,T);if(_p(x)){const z=Hf(x,T,A);if(z.result==="error")throw new Error(z.value.map(B=>`${B.key}: ${B.message}`).join(", "));return z.value}{let z=x;return T.type==="color"&&typeof x=="string"?z=un.parse(x):T.type!=="padding"||typeof x!="number"&&!Array.isArray(x)?T.type!=="numberArray"||typeof x!="number"&&!Array.isArray(x)?T.type!=="colorArray"||typeof x!="string"&&!Array.isArray(x)?T.type==="variableAnchorOffsetCollection"&&Array.isArray(x)?z=Ds.parse(x):T.type==="projectionDefinition"&&typeof x=="string"&&(z=aa.parse(x)):z=Us.parse(x):z=sa.parse(x):z=ms.parse(x),{globalStateRefs:new Set,_globalState:null,kind:"constant",evaluate:()=>z}}}(c===void 0?o.specification.default:c,o.specification,g)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}getGlobalStateRefs(){return this.expression.globalStateRefs||new Set}possiblyEvaluate(o,c,g){return this.property.possiblyEvaluate(this,o,c,g)}}class ad{constructor(o,c){this.property=o,this.value=new Zh(o,void 0,c)}transitioned(o,c){return new ld(this.property,this.value,c,qr({},o.transition,this.transition),o.now)}untransitioned(){return new ld(this.property,this.value,null,{},0)}}class Ap{constructor(o,c){this._properties=o,this._values=Object.create(o.defaultTransitionablePropertyValues),this._globalState=c}getValue(o){return qo(this._values[o].value.value)}setValue(o,c){Object.prototype.hasOwnProperty.call(this._values,o)||(this._values[o]=new ad(this._values[o].property,this._globalState)),this._values[o].value=new Zh(this._values[o].property,c===null?void 0:qo(c),this._globalState)}getTransition(o){return qo(this._values[o].transition)}setTransition(o,c){Object.prototype.hasOwnProperty.call(this._values,o)||(this._values[o]=new ad(this._values[o].property,this._globalState)),this._values[o].transition=qo(c)||void 0}serialize(){const o={};for(const c of Object.keys(this._values)){const g=this.getValue(c);g!==void 0&&(o[c]=g);const x=this.getTransition(c);x!==void 0&&(o[`${c}${Su}`]=x)}return o}transitioned(o,c){const g=new Hh(this._properties);for(const x of Object.keys(this._values))g._values[x]=this._values[x].transitioned(o,c._values[x]);return g}untransitioned(){const o=new Hh(this._properties);for(const c of Object.keys(this._values))o._values[c]=this._values[c].untransitioned();return o}}class ld{constructor(o,c,g,x,T){this.property=o,this.value=c,this.begin=T+x.delay||0,this.end=this.begin+x.duration||0,o.specification.transition&&(x.delay||x.duration)&&(this.prior=g)}possiblyEvaluate(o,c,g){const x=o.now||0,T=this.value.possiblyEvaluate(o,c,g),A=this.prior;if(A){if(x>this.end)return this.prior=null,T;if(this.value.isDataDriven())return this.prior=null,T;if(x<this.begin)return A.possiblyEvaluate(o,c,g);{const z=(x-this.begin)/(this.end-this.begin);return this.property.interpolate(A.possiblyEvaluate(o,c,g),T,Hn(z))}}return T}}class Hh{constructor(o){this._properties=o,this._values=Object.create(o.defaultTransitioningPropertyValues)}possiblyEvaluate(o,c,g){const x=new Wh(this._properties);for(const T of Object.keys(this._values))x._values[T]=this._values[T].possiblyEvaluate(o,c,g);return x}hasTransition(){for(const o of Object.keys(this._values))if(this._values[o].prior)return!0;return!1}}class Jf{constructor(o,c){this._properties=o,this._values=Object.create(o.defaultPropertyValues),this._globalState=c}hasValue(o){return this._values[o].value!==void 0}getValue(o){return qo(this._values[o].value)}setValue(o,c){this._values[o]=new Zh(this._values[o].property,c===null?void 0:qo(c),this._globalState)}serialize(){const o={};for(const c of Object.keys(this._values)){const g=this.getValue(c);g!==void 0&&(o[c]=g)}return o}possiblyEvaluate(o,c,g){const x=new Wh(this._properties);for(const T of Object.keys(this._values))x._values[T]=this._values[T].possiblyEvaluate(o,c,g);return x}}class da{constructor(o,c,g){this.property=o,this.value=c,this.parameters=g}isConstant(){return this.value.kind==="constant"}constantOr(o){return this.value.kind==="constant"?this.value.value:o}evaluate(o,c,g,x){return this.property.evaluate(this.value,this.parameters,o,c,g,x)}}class Wh{constructor(o){this._properties=o,this._values=Object.create(o.defaultPossiblyEvaluatedValues)}get(o){return this._values[o]}}class Ir{constructor(o){this.specification=o}possiblyEvaluate(o,c){if(o.isDataDriven())throw new Error("Value should not be data driven");return o.expression.evaluate(c)}interpolate(o,c,g){const x=el[this.specification.type];return x?x(o,c,g):o}}class Or{constructor(o,c){this.specification=o,this.overrides=c}possiblyEvaluate(o,c,g,x){return new da(this,o.expression.kind==="constant"||o.expression.kind==="camera"?{kind:"constant",value:o.expression.evaluate(c,null,{},g,x)}:o.expression,c)}interpolate(o,c,g){if(o.value.kind!=="constant"||c.value.kind!=="constant")return o;if(o.value.value===void 0||c.value.value===void 0)return new da(this,{kind:"constant",value:void 0},o.parameters);const x=el[this.specification.type];if(x){const T=x(o.value.value,c.value.value,g);return new da(this,{kind:"constant",value:T},o.parameters)}return o}evaluate(o,c,g,x,T,A){return o.kind==="constant"?o.value:o.evaluate(c,g,x,T,A)}}class Xh extends Or{possiblyEvaluate(o,c,g,x){if(o.value===void 0)return new da(this,{kind:"constant",value:void 0},c);if(o.expression.kind==="constant"){const T=o.expression.evaluate(c,null,{},g,x),A=o.property.specification.type==="resolvedImage"&&typeof T!="string"?T.name:T,z=this._calculate(A,A,A,c);return new da(this,{kind:"constant",value:z},c)}if(o.expression.kind==="camera"){const T=this._calculate(o.expression.evaluate({zoom:c.zoom-1}),o.expression.evaluate({zoom:c.zoom}),o.expression.evaluate({zoom:c.zoom+1}),c);return new da(this,{kind:"constant",value:T},c)}return new da(this,o.expression,c)}evaluate(o,c,g,x,T,A){if(o.kind==="source"){const z=o.evaluate(c,g,x,T,A);return this._calculate(z,z,z,c)}return o.kind==="composite"?this._calculate(o.evaluate({zoom:Math.floor(c.zoom)-1},g,x),o.evaluate({zoom:Math.floor(c.zoom)},g,x),o.evaluate({zoom:Math.floor(c.zoom)+1},g,x),c):o.value}_calculate(o,c,g,x){return x.zoom>x.zoomHistory.lastIntegerZoom?{from:o,to:c}:{from:g,to:c}}interpolate(o){return o}}class mc{constructor(o){this.specification=o}possiblyEvaluate(o,c,g,x){if(o.value!==void 0){if(o.expression.kind==="constant"){const T=o.expression.evaluate(c,null,{},g,x);return this._calculate(T,T,T,c)}return this._calculate(o.expression.evaluate(new wo(Math.floor(c.zoom-1),c)),o.expression.evaluate(new wo(Math.floor(c.zoom),c)),o.expression.evaluate(new wo(Math.floor(c.zoom+1),c)),c)}}_calculate(o,c,g,x){return x.zoom>x.zoomHistory.lastIntegerZoom?{from:o,to:c}:{from:g,to:c}}interpolate(o){return o}}class hh{constructor(o){this.specification=o}possiblyEvaluate(o,c,g,x){return!!o.expression.evaluate(c,null,{},g,x)}interpolate(){return!1}}class _s{constructor(o){this.properties=o,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const c in o){const g=o[c];g.specification.overridable&&this.overridableProperties.push(c);const x=this.defaultPropertyValues[c]=new Zh(g,void 0,void 0),T=this.defaultTransitionablePropertyValues[c]=new ad(g,void 0);this.defaultTransitioningPropertyValues[c]=T.untransitioned(),this.defaultPossiblyEvaluatedValues[c]=x.possiblyEvaluate({})}}}ir("DataDrivenProperty",Or),ir("DataConstantProperty",Ir),ir("CrossFadedDataDrivenProperty",Xh),ir("CrossFadedProperty",mc),ir("ColorRampProperty",hh);class bl extends Fe{constructor(o,c,g){if(super(),this.id=o.id,this.type=o.type,this._globalState=g,this._featureFilter={filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set},o.type!=="custom"&&(this.metadata=o.metadata,this.minzoom=o.minzoom,this.maxzoom=o.maxzoom,o.type!=="background"&&(this.source=o.source,this.sourceLayer=o["source-layer"],this.filter=o.filter,this._featureFilter=Ld(o.filter,g)),c.layout&&(this._unevaluatedLayout=new Jf(c.layout,g)),c.paint)){this._transitionablePaint=new Ap(c.paint,g);for(const x in o.paint)this.setPaintProperty(x,o.paint[x],{validate:!1});for(const x in o.layout)this.setLayoutProperty(x,o.layout[x],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Wh(c.paint)}}setFilter(o){this.filter=o,this._featureFilter=Ld(o,this._globalState)}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(o){return o==="visibility"?this.visibility:this._unevaluatedLayout.getValue(o)}getLayoutAffectingGlobalStateRefs(){const o=new Set;if(this._unevaluatedLayout)for(const c in this._unevaluatedLayout._values){const g=this._unevaluatedLayout._values[c];for(const x of g.getGlobalStateRefs())o.add(x)}for(const c of this._featureFilter.getGlobalStateRefs())o.add(c);return o}getPaintAffectingGlobalStateRefs(){var o;const c=new globalThis.Map;if(this._transitionablePaint)for(const g in this._transitionablePaint._values){const x=this._transitionablePaint._values[g].value;for(const T of x.getGlobalStateRefs()){const A=(o=c.get(T))!==null&&o!==void 0?o:[];A.push({name:g,value:x.value}),c.set(T,A)}}return c}setLayoutProperty(o,c,g={}){c!=null&&this._validate(Vd,`layers.${this.id}.layout.${o}`,o,c,g)||(o!=="visibility"?this._unevaluatedLayout.setValue(o,c):this.visibility=c)}getPaintProperty(o){return o.endsWith(Su)?this._transitionablePaint.getTransition(o.slice(0,-11)):this._transitionablePaint.getValue(o)}setPaintProperty(o,c,g={}){if(c!=null&&this._validate(Vc,`layers.${this.id}.paint.${o}`,o,c,g))return!1;if(o.endsWith(Su))return this._transitionablePaint.setTransition(o.slice(0,-11),c||void 0),!1;{const x=this._transitionablePaint._values[o],T=x.property.specification["property-type"]==="cross-faded-data-driven",A=x.value.isDataDriven(),z=x.value;this._transitionablePaint.setValue(o,c),this._handleSpecialPaintPropertyUpdate(o);const B=this._transitionablePaint._values[o].value;return B.isDataDriven()||A||T||this._handleOverridablePaintPropertyUpdate(o,z,B)}}_handleSpecialPaintPropertyUpdate(o){}_handleOverridablePaintPropertyUpdate(o,c,g){return!1}isHidden(o,c=!1){return!!(this.minzoom&&o<(c?Math.floor(this.minzoom):this.minzoom))||!!(this.maxzoom&&o>=this.maxzoom)||this.visibility==="none"}updateTransitions(o){this._transitioningPaint=this._transitionablePaint.transitioned(o,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(o,c){o.getCrossfadeParameters&&(this._crossfadeParameters=o.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(o,void 0,c)),this.paint=this._transitioningPaint.possiblyEvaluate(o,void 0,c)}serialize(){const o={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(o.layout=o.layout||{},o.layout.visibility=this.visibility),$n(o,(c,g)=>!(c===void 0||g==="layout"&&!Object.keys(c).length||g==="paint"&&!Object.keys(c).length))}_validate(o,c,g,x,T={}){return(!T||T.validate!==!1)&&vu(this,o.call(ah,{key:c,layerType:this.type,objectKey:g,value:x,styleSpec:Jt,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const o in this.paint._values){const c=this.paint.get(o);if(c instanceof da&&Rh(c.property.specification)&&(c.value.kind==="source"||c.value.kind==="composite")&&c.value.isStateDependent)return!0}return!1}}let Gd;var Pp={get paint(){return Gd=Gd||new _s({"raster-opacity":new Ir(Jt.paint_raster["raster-opacity"]),"raster-hue-rotate":new Ir(Jt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ir(Jt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ir(Jt.paint_raster["raster-brightness-max"]),"raster-saturation":new Ir(Jt.paint_raster["raster-saturation"]),"raster-contrast":new Ir(Jt.paint_raster["raster-contrast"]),"raster-resampling":new Ir(Jt.paint_raster["raster-resampling"]),"raster-fade-duration":new Ir(Jt.paint_raster["raster-fade-duration"])})}};class $d extends bl{constructor(o,c){super(o,Pp,c)}}const Mp={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class cd{constructor(o,c){this._structArray=o,this._pos1=c*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class po{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(o,c){return o._trim(),c&&(o.isTransferred=!0,c.push(o.arrayBuffer)),{length:o.length,arrayBuffer:o.arrayBuffer}}static deserialize(o){const c=Object.create(this.prototype);return c.arrayBuffer=o.arrayBuffer,c.length=o.length,c.capacity=o.arrayBuffer.byteLength/c.bytesPerElement,c._refreshViews(),c}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(o){this.reserve(o),this.length=o}reserve(o){if(o>this.capacity){this.capacity=Math.max(o,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const c=this.uint8;this._refreshViews(),c&&this.uint8.set(c)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Ko(h,o=1){let c=0,g=0;return{members:h.map(x=>{const T=Mp[x.type].BYTES_PER_ELEMENT,A=c=Ei(c,Math.max(o,T)),z=x.components||1;return g=Math.max(g,T),c+=T*z,{name:x.name,type:x.type,components:z,offset:A}}),size:Ei(c,Math.max(g,o)),alignment:o}}function Ei(h,o){return Math.ceil(h/o)*o}class Iu extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c){const g=this.length;return this.resize(g+1),this.emplace(g,o,c)}emplace(o,c,g){const x=2*o;return this.int16[x+0]=c,this.int16[x+1]=g,o}}Iu.prototype.bytesPerElement=4,ir("StructArrayLayout2i4",Iu);class Bl extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.int16[T+0]=c,this.int16[T+1]=g,this.int16[T+2]=x,o}}Bl.prototype.bytesPerElement=6,ir("StructArrayLayout3i6",Bl);class Gc extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x){const T=this.length;return this.resize(T+1),this.emplace(T,o,c,g,x)}emplace(o,c,g,x,T){const A=4*o;return this.int16[A+0]=c,this.int16[A+1]=g,this.int16[A+2]=x,this.int16[A+3]=T,o}}Gc.prototype.bytesPerElement=8,ir("StructArrayLayout4i8",Gc);class $c extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=6*o;return this.int16[B+0]=c,this.int16[B+1]=g,this.int16[B+2]=x,this.int16[B+3]=T,this.int16[B+4]=A,this.int16[B+5]=z,o}}$c.prototype.bytesPerElement=12,ir("StructArrayLayout2i4i12",$c);class Zi extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=4*o,G=8*o;return this.int16[B+0]=c,this.int16[B+1]=g,this.uint8[G+4]=x,this.uint8[G+5]=T,this.uint8[G+6]=A,this.uint8[G+7]=z,o}}Zi.prototype.bytesPerElement=8,ir("StructArrayLayout2i4ub8",Zi);class Yh extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c){const g=this.length;return this.resize(g+1),this.emplace(g,o,c)}emplace(o,c,g){const x=2*o;return this.float32[x+0]=c,this.float32[x+1]=g,o}}Yh.prototype.bytesPerElement=8,ir("StructArrayLayout2f8",Yh);class hd extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W){const Q=this.length;return this.resize(Q+1),this.emplace(Q,o,c,g,x,T,A,z,B,G,W)}emplace(o,c,g,x,T,A,z,B,G,W,Q){const ot=10*o;return this.uint16[ot+0]=c,this.uint16[ot+1]=g,this.uint16[ot+2]=x,this.uint16[ot+3]=T,this.uint16[ot+4]=A,this.uint16[ot+5]=z,this.uint16[ot+6]=B,this.uint16[ot+7]=G,this.uint16[ot+8]=W,this.uint16[ot+9]=Q,o}}hd.prototype.bytesPerElement=20,ir("StructArrayLayout10ui20",hd);class Eu extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B){const G=this.length;return this.resize(G+1),this.emplace(G,o,c,g,x,T,A,z,B)}emplace(o,c,g,x,T,A,z,B,G){const W=8*o;return this.uint16[W+0]=c,this.uint16[W+1]=g,this.uint16[W+2]=x,this.uint16[W+3]=T,this.uint16[W+4]=A,this.uint16[W+5]=z,this.uint16[W+6]=B,this.uint16[W+7]=G,o}}Eu.prototype.bytesPerElement=16,ir("StructArrayLayout8ui16",Eu);class Jh extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W,Q,ot){const ct=this.length;return this.resize(ct+1),this.emplace(ct,o,c,g,x,T,A,z,B,G,W,Q,ot)}emplace(o,c,g,x,T,A,z,B,G,W,Q,ot,ct){const ut=12*o;return this.int16[ut+0]=c,this.int16[ut+1]=g,this.int16[ut+2]=x,this.int16[ut+3]=T,this.uint16[ut+4]=A,this.uint16[ut+5]=z,this.uint16[ut+6]=B,this.uint16[ut+7]=G,this.int16[ut+8]=W,this.int16[ut+9]=Q,this.int16[ut+10]=ot,this.int16[ut+11]=ct,o}}Jh.prototype.bytesPerElement=24,ir("StructArrayLayout4i4ui4i24",Jh);class qd extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.float32[T+0]=c,this.float32[T+1]=g,this.float32[T+2]=x,o}}qd.prototype.bytesPerElement=12,ir("StructArrayLayout3f12",qd);class Kh extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(o){const c=this.length;return this.resize(c+1),this.emplace(c,o)}emplace(o,c){return this.uint32[1*o+0]=c,o}}Kh.prototype.bytesPerElement=4,ir("StructArrayLayout1ul4",Kh);class Qh extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G){const W=this.length;return this.resize(W+1),this.emplace(W,o,c,g,x,T,A,z,B,G)}emplace(o,c,g,x,T,A,z,B,G,W){const Q=10*o,ot=5*o;return this.int16[Q+0]=c,this.int16[Q+1]=g,this.int16[Q+2]=x,this.int16[Q+3]=T,this.int16[Q+4]=A,this.int16[Q+5]=z,this.uint32[ot+3]=B,this.uint16[Q+8]=G,this.uint16[Q+9]=W,o}}Qh.prototype.bytesPerElement=20,ir("StructArrayLayout6i1ul2ui20",Qh);class vf extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=6*o;return this.int16[B+0]=c,this.int16[B+1]=g,this.int16[B+2]=x,this.int16[B+3]=T,this.int16[B+4]=A,this.int16[B+5]=z,o}}vf.prototype.bytesPerElement=12,ir("StructArrayLayout2i2i2i12",vf);class Cp extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T){const A=this.length;return this.resize(A+1),this.emplace(A,o,c,g,x,T)}emplace(o,c,g,x,T,A){const z=4*o,B=8*o;return this.float32[z+0]=c,this.float32[z+1]=g,this.float32[z+2]=x,this.int16[B+6]=T,this.int16[B+7]=A,o}}Cp.prototype.bytesPerElement=16,ir("StructArrayLayout2f1f2i16",Cp);class Gs extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A){const z=this.length;return this.resize(z+1),this.emplace(z,o,c,g,x,T,A)}emplace(o,c,g,x,T,A,z){const B=16*o,G=4*o,W=8*o;return this.uint8[B+0]=c,this.uint8[B+1]=g,this.float32[G+1]=x,this.float32[G+2]=T,this.int16[W+6]=A,this.int16[W+7]=z,o}}Gs.prototype.bytesPerElement=16,ir("StructArrayLayout2ub2f2i16",Gs);class ud extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.uint16[T+0]=c,this.uint16[T+1]=g,this.uint16[T+2]=x,o}}ud.prototype.bytesPerElement=6,ir("StructArrayLayout3ui6",ud);class pa extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt,Et,Vt){const ue=this.length;return this.resize(ue+1),this.emplace(ue,o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt,Et,Vt)}emplace(o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt,Et,Vt,ue){const Qt=24*o,ee=12*o,Se=48*o;return this.int16[Qt+0]=c,this.int16[Qt+1]=g,this.uint16[Qt+2]=x,this.uint16[Qt+3]=T,this.uint32[ee+2]=A,this.uint32[ee+3]=z,this.uint32[ee+4]=B,this.uint16[Qt+10]=G,this.uint16[Qt+11]=W,this.uint16[Qt+12]=Q,this.float32[ee+7]=ot,this.float32[ee+8]=ct,this.uint8[Se+36]=ut,this.uint8[Se+37]=xt,this.uint8[Se+38]=Et,this.uint32[ee+10]=Vt,this.int16[Qt+22]=ue,o}}pa.prototype.bytesPerElement=48,ir("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",pa);class gc extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt,Et,Vt,ue,Qt,ee,Se,Ee,ei,Ii,fi,zi,Ji,$i){const Ui=this.length;return this.resize(Ui+1),this.emplace(Ui,o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt,Et,Vt,ue,Qt,ee,Se,Ee,ei,Ii,fi,zi,Ji,$i)}emplace(o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt,Et,Vt,ue,Qt,ee,Se,Ee,ei,Ii,fi,zi,Ji,$i,Ui){const _i=32*o,kr=16*o;return this.int16[_i+0]=c,this.int16[_i+1]=g,this.int16[_i+2]=x,this.int16[_i+3]=T,this.int16[_i+4]=A,this.int16[_i+5]=z,this.int16[_i+6]=B,this.int16[_i+7]=G,this.uint16[_i+8]=W,this.uint16[_i+9]=Q,this.uint16[_i+10]=ot,this.uint16[_i+11]=ct,this.uint16[_i+12]=ut,this.uint16[_i+13]=xt,this.uint16[_i+14]=Et,this.uint16[_i+15]=Vt,this.uint16[_i+16]=ue,this.uint16[_i+17]=Qt,this.uint16[_i+18]=ee,this.uint16[_i+19]=Se,this.uint16[_i+20]=Ee,this.uint16[_i+21]=ei,this.uint16[_i+22]=Ii,this.uint32[kr+12]=fi,this.float32[kr+13]=zi,this.float32[kr+14]=Ji,this.uint16[_i+30]=$i,this.uint16[_i+31]=Ui,o}}gc.prototype.bytesPerElement=64,ir("StructArrayLayout8i15ui1ul2f2ui64",gc);class Zd extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o){const c=this.length;return this.resize(c+1),this.emplace(c,o)}emplace(o,c){return this.float32[1*o+0]=c,o}}Zd.prototype.bytesPerElement=4,ir("StructArrayLayout1f4",Zd);class C extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=3*o;return this.uint16[6*o+0]=c,this.float32[T+1]=g,this.float32[T+2]=x,o}}C.prototype.bytesPerElement=12,ir("StructArrayLayout1ui2f12",C);class s extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c,g){const x=this.length;return this.resize(x+1),this.emplace(x,o,c,g)}emplace(o,c,g,x){const T=4*o;return this.uint32[2*o+0]=c,this.uint16[T+2]=g,this.uint16[T+3]=x,o}}s.prototype.bytesPerElement=8,ir("StructArrayLayout1ul2ui8",s);class d extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o,c){const g=this.length;return this.resize(g+1),this.emplace(g,o,c)}emplace(o,c,g){const x=2*o;return this.uint16[x+0]=c,this.uint16[x+1]=g,o}}d.prototype.bytesPerElement=4,ir("StructArrayLayout2ui4",d);class v extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(o){const c=this.length;return this.resize(c+1),this.emplace(c,o)}emplace(o,c){return this.uint16[1*o+0]=c,o}}v.prototype.bytesPerElement=2,ir("StructArrayLayout1ui2",v);class S extends po{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(o,c,g,x){const T=this.length;return this.resize(T+1),this.emplace(T,o,c,g,x)}emplace(o,c,g,x,T){const A=4*o;return this.float32[A+0]=c,this.float32[A+1]=g,this.float32[A+2]=x,this.float32[A+3]=T,o}}S.prototype.bytesPerElement=16,ir("StructArrayLayout4f16",S);class D extends cd{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Le(this.anchorPointX,this.anchorPointY)}}D.prototype.size=20;class k extends Qh{get(o){return new D(this,o)}}ir("CollisionBoxArray",k);class j extends cd{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(o){this._structArray.uint8[this._pos1+37]=o}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(o){this._structArray.uint8[this._pos1+38]=o}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(o){this._structArray.uint32[this._pos4+10]=o}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}j.prototype.size=48;class H extends pa{get(o){return new j(this,o)}}ir("PlacedSymbolArray",H);class J extends cd{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(o){this._structArray.uint32[this._pos4+12]=o}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}J.prototype.size=64;class et extends gc{get(o){return new J(this,o)}}ir("SymbolInstanceArray",et);class mt extends Zd{getoffsetX(o){return this.float32[1*o+0]}}ir("GlyphOffsetArray",mt);class dt extends Bl{getx(o){return this.int16[3*o+0]}gety(o){return this.int16[3*o+1]}gettileUnitDistanceFromAnchor(o){return this.int16[3*o+2]}}ir("SymbolLineVertexArray",dt);class Tt extends cd{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}Tt.prototype.size=12;class pt extends C{get(o){return new Tt(this,o)}}ir("TextAnchorOffsetArray",pt);class It extends cd{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}It.prototype.size=8;class Kt extends s{get(o){return new It(this,o)}}ir("FeatureIndexArray",Kt);class Wt extends Iu{}class ft extends Iu{}class _e extends Iu{}class he extends $c{}class me extends Zi{}class be extends Yh{}class de extends hd{}class Ce extends Eu{}class Qe extends Jh{}class Xe extends qd{}class Je extends Kh{}class ii extends vf{}class Ri extends Gs{}class Oi extends ud{}class Ti extends d{}const br=Ko([{name:"a_pos",components:2,type:"Int16"}],4),{members:tn}=br;class Zr{constructor(o=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=o}prepareSegment(o,c,g,x){const T=this.segments[this.segments.length-1];return o>Zr.MAX_VERTEX_ARRAY_LENGTH&&ho(`Max vertices per segment is ${Zr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${o}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${Zr.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!T||T.vertexLength+o>Zr.MAX_VERTEX_ARRAY_LENGTH||T.sortKey!==x?this.createNewSegment(c,g,x):T}createNewSegment(o,c,g){const x={vertexOffset:o.length,primitiveOffset:c.length,vertexLength:0,primitiveLength:0,vaos:{}};return g!==void 0&&(x.sortKey=g),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(x),x}getOrCreateLatestSegment(o,c,g){return this.prepareSegment(0,o,c,g)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const o of this.segments)for(const c in o.vaos)o.vaos[c].destroy()}static simpleSegment(o,c,g,x){return new Zr([{vertexOffset:o,primitiveOffset:c,vertexLength:g,primitiveLength:x,vaos:{},sortKey:0}])}}function vo(h,o){return 256*(h=fr(Math.floor(h),0,255))+fr(Math.floor(o),0,255)}Zr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,ir("SegmentVector",Zr);const Wo=Ko([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]),os=Ko([{name:"a_dasharray_from",components:4,type:"Uint16"},{name:"a_dasharray_to",components:4,type:"Uint16"}]);var Xo,zs,ss,io={exports:{}},Es={exports:{}},as={exports:{}},sn=function(){if(ss)return io.exports;ss=1;var h=(Xo||(Xo=1,Es.exports=function(c,g){var x,T,A,z,B,G,W,Q;for(T=c.length-(x=3&c.length),A=g,B=3432918353,G=461845907,Q=0;Q<T;)W=255&c.charCodeAt(Q)|(255&c.charCodeAt(++Q))<<8|(255&c.charCodeAt(++Q))<<16|(255&c.charCodeAt(++Q))<<24,++Q,A=27492+(65535&(z=5*(65535&(A=(A^=W=(65535&(W=(W=(65535&W)*B+(((W>>>16)*B&65535)<<16)&4294967295)<<15|W>>>17))*G+(((W>>>16)*G&65535)<<16)&4294967295)<<13|A>>>19))+((5*(A>>>16)&65535)<<16)&4294967295))+((58964+(z>>>16)&65535)<<16);switch(W=0,x){case 3:W^=(255&c.charCodeAt(Q+2))<<16;case 2:W^=(255&c.charCodeAt(Q+1))<<8;case 1:A^=W=(65535&(W=(W=(65535&(W^=255&c.charCodeAt(Q)))*B+(((W>>>16)*B&65535)<<16)&4294967295)<<15|W>>>17))*G+(((W>>>16)*G&65535)<<16)&4294967295}return A^=c.length,A=2246822507*(65535&(A^=A>>>16))+((2246822507*(A>>>16)&65535)<<16)&4294967295,A=3266489909*(65535&(A^=A>>>13))+((3266489909*(A>>>16)&65535)<<16)&4294967295,(A^=A>>>16)>>>0}),Es.exports),o=(zs||(zs=1,as.exports=function(c,g){for(var x,T=c.length,A=g^T,z=0;T>=4;)x=1540483477*(65535&(x=255&c.charCodeAt(z)|(255&c.charCodeAt(++z))<<8|(255&c.charCodeAt(++z))<<16|(255&c.charCodeAt(++z))<<24))+((1540483477*(x>>>16)&65535)<<16),A=1540483477*(65535&A)+((1540483477*(A>>>16)&65535)<<16)^(x=1540483477*(65535&(x^=x>>>24))+((1540483477*(x>>>16)&65535)<<16)),T-=4,++z;switch(T){case 3:A^=(255&c.charCodeAt(z+2))<<16;case 2:A^=(255&c.charCodeAt(z+1))<<8;case 1:A=1540483477*(65535&(A^=255&c.charCodeAt(z)))+((1540483477*(A>>>16)&65535)<<16)}return A=1540483477*(65535&(A^=A>>>13))+((1540483477*(A>>>16)&65535)<<16),(A^=A>>>15)>>>0}),as.exports);return io.exports=h,io.exports.murmur3=h,io.exports.murmur2=o,io.exports}(),Er=wi(sn);class Ql{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(o,c,g,x){this.ids.push(As(o)),this.positions.push(c,g,x)}getPositions(o){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const c=As(o);let g=0,x=this.ids.length-1;for(;g<x;){const A=g+x>>1;this.ids[A]>=c?x=A:g=A+1}const T=[];for(;this.ids[g]===c;)T.push({index:this.positions[3*g],start:this.positions[3*g+1],end:this.positions[3*g+2]}),g++;return T}static serialize(o,c){const g=new Float64Array(o.ids),x=new Uint32Array(o.positions);return wl(g,x,0,g.length-1),c&&c.push(g.buffer,x.buffer),{ids:g,positions:x}}static deserialize(o){const c=new Ql;return c.ids=o.ids,c.positions=o.positions,c.indexed=!0,c}}function As(h){const o=+h;return!isNaN(o)&&o<=Number.MAX_SAFE_INTEGER?o:Er(String(h))}function wl(h,o,c,g){for(;c<g;){const x=h[c+g>>1];let T=c-1,A=g+1;for(;;){do T++;while(h[T]<x);do A--;while(h[A]>x);if(T>=A)break;tc(h,T,A),tc(o,3*T,3*A),tc(o,3*T+1,3*A+1),tc(o,3*T+2,3*A+2)}A-c<g-A?(wl(h,o,c,A),c=A+1):(wl(h,o,A+1,g),g=A)}}function tc(h,o,c){const g=h[o];h[o]=h[c],h[c]=g}ir("FeaturePositionMap",Ql);class $s{constructor(o,c){this.gl=o.gl,this.location=c}}class _c extends $s{constructor(o,c){super(o,c),this.current=0}set(o){this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class rl extends $s{constructor(o,c){super(o,c),this.current=[0,0,0,0]}set(o){o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3]))}}class ec extends $s{constructor(o,c){super(o,c),this.current=un.transparent}set(o){o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a))}}const qc=new Float32Array(16);function ta(h){return[vo(255*h.r,255*h.g),vo(255*h.b,255*h.a)]}class Bo{constructor(o,c,g){this.value=o,this.uniformNames=c.map(x=>`u_${x}`),this.type=g}setUniform(o,c,g){o.set(g.constantOr(this.value))}getBinding(o,c,g){return this.type==="color"?new ec(o,c):new _c(o,c)}}class Oo{constructor(o,c){this.uniformNames=c.map(g=>`u_${g}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(o,c){this.pixelRatioFrom=c.pixelRatio,this.pixelRatioTo=o.pixelRatio,this.patternFrom=c.tlbr,this.patternTo=o.tlbr}setConstantDashPositions(o,c){this.dashTo=[0,o.y,o.height,o.width],this.dashFrom=[0,c.y,c.height,c.width]}setUniform(o,c,g,x){let T=null;x==="u_pattern_to"?T=this.patternTo:x==="u_pattern_from"?T=this.patternFrom:x==="u_dasharray_to"?T=this.dashTo:x==="u_dasharray_from"?T=this.dashFrom:x==="u_pixel_ratio_to"?T=this.pixelRatioTo:x==="u_pixel_ratio_from"&&(T=this.pixelRatioFrom),T!==null&&o.set(T)}getBinding(o,c,g){return g.substr(0,9)==="u_pattern"||g.substr(0,12)==="u_dasharray_"?new rl(o,c):new _c(o,c)}}class ys{constructor(o,c,g,x){this.expression=o,this.type=g,this.maxValue=0,this.paintVertexAttributes=c.map(T=>({name:`a_${T}`,type:"Float32",components:g==="color"?2:1,offset:0})),this.paintVertexArray=new x}populatePaintArray(o,c,g){const x=this.paintVertexArray.length,T=this.expression.evaluate(new wo(0,g),c,{},g.canonical,[],g.formattedSection);this.paintVertexArray.resize(o),this._setPaintValue(x,o,T)}updatePaintArray(o,c,g,x,T){const A=this.expression.evaluate(new wo(0,T),g,x);this._setPaintValue(o,c,A)}_setPaintValue(o,c,g){if(this.type==="color"){const x=ta(g);for(let T=o;T<c;T++)this.paintVertexArray.emplace(T,x[0],x[1])}else{for(let x=o;x<c;x++)this.paintVertexArray.emplace(x,g);this.maxValue=Math.max(this.maxValue,Math.abs(g))}}upload(o){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=o.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Lo{constructor(o,c,g,x,T,A){this.expression=o,this.uniformNames=c.map(z=>`u_${z}_t`),this.type=g,this.useIntegerZoom=x,this.zoom=T,this.maxValue=0,this.paintVertexAttributes=c.map(z=>({name:`a_${z}`,type:"Float32",components:g==="color"?4:2,offset:0})),this.paintVertexArray=new A}populatePaintArray(o,c,g){const x=this.expression.evaluate(new wo(this.zoom,g),c,{},g.canonical,[],g.formattedSection),T=this.expression.evaluate(new wo(this.zoom+1,g),c,{},g.canonical,[],g.formattedSection),A=this.paintVertexArray.length;this.paintVertexArray.resize(o),this._setPaintValue(A,o,x,T)}updatePaintArray(o,c,g,x,T){const A=this.expression.evaluate(new wo(this.zoom,T),g,x),z=this.expression.evaluate(new wo(this.zoom+1,T),g,x);this._setPaintValue(o,c,A,z)}_setPaintValue(o,c,g,x){if(this.type==="color"){const T=ta(g),A=ta(x);for(let z=o;z<c;z++)this.paintVertexArray.emplace(z,T[0],T[1],A[0],A[1])}else{for(let T=o;T<c;T++)this.paintVertexArray.emplace(T,g,x);this.maxValue=Math.max(this.maxValue,Math.abs(g),Math.abs(x))}}upload(o){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=o.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(o,c){const g=this.useIntegerZoom?Math.floor(c.zoom):c.zoom,x=fr(this.expression.interpolationFactor(g,this.zoom,this.zoom+1),0,1);o.set(x)}getBinding(o,c,g){return new _c(o,c)}}class Ol{constructor(o,c,g,x,T,A){this.expression=o,this.type=c,this.useIntegerZoom=g,this.zoom=x,this.layerId=A,this.zoomInPaintVertexArray=new T,this.zoomOutPaintVertexArray=new T}populatePaintArray(o,c,g){const x=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(o),this.zoomOutPaintVertexArray.resize(o),this._setPaintValues(x,o,this.getPositionIds(c),g)}updatePaintArray(o,c,g,x,T){this._setPaintValues(o,c,this.getPositionIds(g),T)}_setPaintValues(o,c,g,x){const T=this.getPositions(x);if(!T||!g)return;const A=T[g.min],z=T[g.mid],B=T[g.max];if(A&&z&&B)for(let G=o;G<c;G++)this.emplace(this.zoomInPaintVertexArray,G,z,A),this.emplace(this.zoomOutPaintVertexArray,G,z,B)}upload(o){if(this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer){const c=this.getVertexAttributes();this.zoomInPaintVertexBuffer=o.createVertexBuffer(this.zoomInPaintVertexArray,c,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=o.createVertexBuffer(this.zoomOutPaintVertexArray,c,this.expression.isStateDependent)}}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class uh extends Ol{getPositions(o){return o.imagePositions}getPositionIds(o){return o.patterns&&o.patterns[this.layerId]}getVertexAttributes(){return Wo.members}emplace(o,c,g,x){o.emplace(c,g.tlbr[0],g.tlbr[1],g.tlbr[2],g.tlbr[3],x.tlbr[0],x.tlbr[1],x.tlbr[2],x.tlbr[3],g.pixelRatio,x.pixelRatio)}}class Dp extends Ol{getPositions(o){return o.dashPositions}getPositionIds(o){return o.dashes&&o.dashes[this.layerId]}getVertexAttributes(){return os.members}emplace(o,c,g,x){o.emplace(c,0,g.y,g.height,g.width,0,x.y,x.height,x.width)}}class Nl{constructor(o,c,g){this.binders={},this._buffers=[];const x=[];for(const T in o.paint._values){if(!g(T))continue;const A=o.paint.get(T);if(!(A instanceof da&&Rh(A.property.specification)))continue;const z=zp(T,o.type),B=A.value,G=A.property.specification.type,W=A.property.useIntegerZoom,Q=A.property.specification["property-type"],ot=Q==="cross-faded"||Q==="cross-faded-data-driven";if(B.kind==="constant")this.binders[T]=ot?new Oo(B.value,z):new Bo(B.value,z,G),x.push(`/u_${T}`);else if(B.kind==="source"||ot){const ct=Vl(T,G,"source");this.binders[T]=ot?T==="line-dasharray"?new Dp(B,G,W,c,ct,o.id):new uh(B,G,W,c,ct,o.id):new ys(B,z,G,ct),x.push(`/a_${T}`)}else{const ct=Vl(T,G,"composite");this.binders[T]=new Lo(B,z,G,W,c,ct),x.push(`/z_${T}`)}}this.cacheKey=x.sort().join("")}getMaxValue(o){const c=this.binders[o];return c instanceof ys||c instanceof Lo?c.maxValue:0}populatePaintArrays(o,c,g){for(const x in this.binders){const T=this.binders[x];(T instanceof ys||T instanceof Lo||T instanceof Ol)&&T.populatePaintArray(o,c,g)}}setConstantPatternPositions(o,c){for(const g in this.binders){const x=this.binders[g];x instanceof Oo&&x.setConstantPatternPositions(o,c)}}setConstantDashPositions(o,c){for(const g in this.binders){const x=this.binders[g];x instanceof Oo&&x.setConstantDashPositions(o,c)}}updatePaintArrays(o,c,g,x,T){let A=!1;for(const z in o){const B=c.getPositions(z);for(const G of B){const W=g.feature(G.index);for(const Q in this.binders){const ot=this.binders[Q];if((ot instanceof ys||ot instanceof Lo||ot instanceof Ol)&&ot.expression.isStateDependent===!0){const ct=x.paint.get(Q);ot.expression=ct.value,ot.updatePaintArray(G.start,G.end,W,o[z],T),A=!0}}}}return A}defines(){const o=[];for(const c in this.binders){const g=this.binders[c];(g instanceof Bo||g instanceof Oo)&&o.push(...g.uniformNames.map(x=>`#define HAS_UNIFORM_${x}`))}return o}getBinderAttributes(){const o=[];for(const c in this.binders){const g=this.binders[c];if(g instanceof ys||g instanceof Lo)for(let x=0;x<g.paintVertexAttributes.length;x++)o.push(g.paintVertexAttributes[x].name);else if(g instanceof Ol){const x=g.getVertexAttributes();for(const T of x)o.push(T.name)}}return o}getBinderUniforms(){const o=[];for(const c in this.binders){const g=this.binders[c];if(g instanceof Bo||g instanceof Oo||g instanceof Lo)for(const x of g.uniformNames)o.push(x)}return o}getPaintVertexBuffers(){return this._buffers}getUniforms(o,c){const g=[];for(const x in this.binders){const T=this.binders[x];if(T instanceof Bo||T instanceof Oo||T instanceof Lo){for(const A of T.uniformNames)if(c[A]){const z=T.getBinding(o,c[A],A);g.push({name:A,property:x,binding:z})}}}return g}setUniforms(o,c,g,x){for(const{name:T,property:A,binding:z}of c)this.binders[A].setUniform(z,x,g.get(A),T)}updatePaintBuffers(o){this._buffers=[];for(const c in this.binders){const g=this.binders[c];if(o&&g instanceof Ol){const x=o.fromScale===2?g.zoomInPaintVertexBuffer:g.zoomOutPaintVertexBuffer;x&&this._buffers.push(x)}else(g instanceof ys||g instanceof Lo)&&g.paintVertexBuffer&&this._buffers.push(g.paintVertexBuffer)}}upload(o){for(const c in this.binders){const g=this.binders[c];(g instanceof ys||g instanceof Lo||g instanceof Ol)&&g.upload(o)}this.updatePaintBuffers()}destroy(){for(const o in this.binders){const c=this.binders[o];(c instanceof ys||c instanceof Lo||c instanceof Ol)&&c.destroy()}}}class dh{constructor(o,c,g=()=>!0){this.programConfigurations={};for(const x of o)this.programConfigurations[x.id]=new Nl(x,c,g);this.needsUpload=!1,this._featureMap=new Ql,this._bufferOffset=0}populatePaintArrays(o,c,g,x){for(const T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(o,c,x);c.id!==void 0&&this._featureMap.add(c.id,g,this._bufferOffset,o),this._bufferOffset=o,this.needsUpload=!0}updatePaintArrays(o,c,g,x){for(const T of g)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(o,this._featureMap,c,T,x)||this.needsUpload}get(o){return this.programConfigurations[o]}upload(o){if(this.needsUpload){for(const c in this.programConfigurations)this.programConfigurations[c].upload(o);this.needsUpload=!1}}destroy(){for(const o in this.programConfigurations)this.programConfigurations[o].destroy()}}function zp(h,o){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-dasharray":["dasharray_to","dasharray_from"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[h]||[h.replace(`${o}-`,"").replace(/-/g,"_")]}function Vl(h,o,c){const g={color:{source:Yh,composite:S},number:{source:Zd,composite:Yh}},x=function(T){return{"line-pattern":{source:de,composite:de},"fill-pattern":{source:de,composite:de},"fill-extrusion-pattern":{source:de,composite:de},"line-dasharray":{source:Ce,composite:Ce}}[T]}(h);return x&&x[c]||g[o][c]}ir("ConstantBinder",Bo),ir("CrossFadedConstantBinder",Oo),ir("SourceExpressionBinder",ys),ir("CrossFadedPatternBinder",uh),ir("CrossFadedDasharrayBinder",Dp),ir("CompositeExpressionBinder",Lo),ir("ProgramConfiguration",Nl,{omit:["_buffers"]}),ir("ProgramConfigurationSet",dh);const ph=Math.pow(2,14)-1,ro=-ph-1;function Ul(h){const o=zn/h.extent,c=h.loadGeometry();for(let g=0;g<c.length;g++){const x=c[g];for(let T=0;T<x.length;T++){const A=x[T],z=Math.round(A.x*o),B=Math.round(A.y*o);A.x=fr(z,ro,ph),A.y=fr(B,ro,ph),(z<A.x||z>A.x+1||B<A.y||B>A.y+1)&&ho("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return c}function yc(h,o){return{type:h.type,id:h.id,properties:h.properties,geometry:o?Ul(h):[]}}const Hd=-32768;function fh(h,o,c,g,x){h.emplaceBack(Hd+8*o+g,Hd+8*c+x)}class bf{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.layoutVertexArray=new ft,this.indexArray=new Oi,this.segments=new Zr,this.programConfigurations=new dh(o.layers,o.zoom),this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){const x=this.layers[0],T=[];let A=null,z=!1,B=x.type==="heatmap";if(x.type==="circle"){const W=x;A=W.layout.get("circle-sort-key"),z=!A.isConstant(),B=B||W.paint.get("circle-pitch-alignment")==="map"}const G=B?c.subdivisionGranularity.circle:1;for(const{feature:W,id:Q,index:ot,sourceLayerIndex:ct}of o){const ut=this.layers[0]._featureFilter.needGeometry,xt=yc(W,ut);if(!this.layers[0]._featureFilter.filter(new wo(this.zoom),xt,g))continue;const Et=z?A.evaluate(xt,{},g):void 0,Vt={id:Q,properties:W.properties,type:W.type,sourceLayerIndex:ct,index:ot,geometry:ut?xt.geometry:Ul(W),patterns:{},sortKey:Et};T.push(Vt)}z&&T.sort((W,Q)=>W.sortKey-Q.sortKey);for(const W of T){const{geometry:Q,index:ot,sourceLayerIndex:ct}=W,ut=o[ot].feature;this.addFeature(W,Q,ot,g,G),c.featureIndex.insert(ut,Q,ot,ct,this.index)}}update(o,c,g){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g})}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,tn),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(o,c,g,x,T=1){let A;switch(T){case 1:A=[0,7];break;case 3:A=[0,2,5,7];break;case 5:A=[0,1,3,4,6,7];break;case 7:A=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${T}; valid values are 1, 3, 5, 7.`)}const z=A.length;for(const B of c)for(const G of B){const W=G.x,Q=G.y;if(W<0||W>=zn||Q<0||Q>=zn)continue;const ot=this.segments.prepareSegment(z*z,this.layoutVertexArray,this.indexArray,o.sortKey),ct=ot.vertexLength;for(let ut=0;ut<z;ut++)for(let xt=0;xt<z;xt++)fh(this.layoutVertexArray,W,Q,A[xt],A[ut]);for(let ut=0;ut<z-1;ut++)for(let xt=0;xt<z-1;xt++){const Et=ct+ut*z+xt,Vt=ct+(ut+1)*z+xt;this.indexArray.emplaceBack(Et,Vt+1,Et+1),this.indexArray.emplaceBack(Et,Vt,Vt+1)}ot.vertexLength+=z*z,ot.primitiveLength+=(z-1)*(z-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:{},canonical:x})}}function Lp(h,o){for(let c=0;c<h.length;c++)if(pd(o,h[c]))return!0;for(let c=0;c<o.length;c++)if(pd(h,o[c]))return!0;return!!kp(h,o)}function Rp(h,o,c){return!!pd(h,o)||!!dd(o,h,c)}function Au(h,o){if(h.length===1)return wf(o,h[0]);for(let c=0;c<o.length;c++){const g=o[c];for(let x=0;x<g.length;x++)if(pd(h,g[x]))return!0}for(let c=0;c<h.length;c++)if(wf(o,h[c]))return!0;for(let c=0;c<o.length;c++)if(kp(h,o[c]))return!0;return!1}function Dm(h,o,c){if(h.length>1){if(kp(h,o))return!0;for(let g=0;g<o.length;g++)if(dd(o[g],h,c))return!0}for(let g=0;g<h.length;g++)if(dd(h[g],o,c))return!0;return!1}function kp(h,o){if(h.length===0||o.length===0)return!1;for(let c=0;c<h.length-1;c++){const g=h[c],x=h[c+1];for(let T=0;T<o.length-1;T++)if(Kf(g,x,o[T],o[T+1]))return!0}return!1}function Kf(h,o,c,g){return ds(h,c,g)!==ds(o,c,g)&&ds(h,o,c)!==ds(h,o,g)}function dd(h,o,c){const g=c*c;if(o.length===1)return h.distSqr(o[0])<g;for(let x=1;x<o.length;x++)if(Qf(h,o[x-1],o[x])<g)return!0;return!1}function Qf(h,o,c){const g=o.distSqr(c);if(g===0)return h.distSqr(o);const x=((h.x-o.x)*(c.x-o.x)+(h.y-o.y)*(c.y-o.y))/g;return h.distSqr(x<0?o:x>1?c:c.sub(o)._mult(x)._add(o))}function wf(h,o){let c,g,x,T=!1;for(let A=0;A<h.length;A++){c=h[A];for(let z=0,B=c.length-1;z<c.length;B=z++)g=c[z],x=c[B],g.y>o.y!=x.y>o.y&&o.x<(x.x-g.x)*(o.y-g.y)/(x.y-g.y)+g.x&&(T=!T)}return T}function pd(h,o){let c=!1;for(let g=0,x=h.length-1;g<h.length;x=g++){const T=h[g],A=h[x];T.y>o.y!=A.y>o.y&&o.x<(A.x-T.x)*(o.y-T.y)/(A.y-T.y)+T.x&&(c=!c)}return c}function gg(h,o,c){const g=c[0],x=c[2];if(h.x<g.x&&o.x<g.x||h.x>x.x&&o.x>x.x||h.y<g.y&&o.y<g.y||h.y>x.y&&o.y>x.y)return!1;const T=ds(h,o,c[0]);return T!==ds(h,o,c[1])||T!==ds(h,o,c[2])||T!==ds(h,o,c[3])}function Pu(h,o,c){const g=o.paint.get(h).value;return g.kind==="constant"?g.value:c.programConfigurations.get(o.id).getMaxValue(h)}function fd(h){return Math.sqrt(h[0]*h[0]+h[1]*h[1])}function Fp(h,o,c,g,x){if(!o[0]&&!o[1])return h;const T=Le.convert(o)._mult(x);c==="viewport"&&T._rotate(-g);const A=[];for(let z=0;z<h.length;z++)A.push(h[z].sub(T));return A}function _g({queryGeometry:h,size:o},c){return Rp(h,c,o)}function zm({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x},T){return Rp(h,T,o*(c.projectTileCoordinates(T.x,T.y,g,x).signedDistanceFromCamera/c.cameraToCenterDistance))}function yg({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x},T){const A=c.projectTileCoordinates(T.x,T.y,g,x).signedDistanceFromCamera,z=o*(c.cameraToCenterDistance/A);return Rp(h,em(T,c,g,x),z)}function tm({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x},T){return Rp(h,em(T,c,g,x),o)}function Lm({queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x,pitchAlignment:T="map",pitchScale:A="map"},z){const B=T==="map"?A==="map"?_g:zm:A==="map"?yg:tm,G={queryGeometry:h,size:o,transform:c,unwrappedTileID:g,getElevation:x};for(const W of z)for(const Q of W)if(B(G,Q))return!0;return!1}function em(h,o,c,g){const x=o.projectTileCoordinates(h.x,h.y,c,g).point;return new Le((.5*x.x+.5)*o.width,(.5*-x.y+.5)*o.height)}let Rm,km;ir("CircleBucket",bf,{omit:["layers"]});var xg={get paint(){return km=km||new _s({"circle-radius":new Or(Jt.paint_circle["circle-radius"]),"circle-color":new Or(Jt.paint_circle["circle-color"]),"circle-blur":new Or(Jt.paint_circle["circle-blur"]),"circle-opacity":new Or(Jt.paint_circle["circle-opacity"]),"circle-translate":new Ir(Jt.paint_circle["circle-translate"]),"circle-translate-anchor":new Ir(Jt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ir(Jt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ir(Jt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Or(Jt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Or(Jt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Or(Jt.paint_circle["circle-stroke-opacity"])})},get layout(){return Rm=Rm||new _s({"circle-sort-key":new Or(Jt.layout_circle["circle-sort-key"])})}};class g_ extends bl{constructor(o,c){super(o,xg,c)}createBucket(o){return new bf(o)}queryRadius(o){const c=o;return Pu("circle-radius",this,c)+Pu("circle-stroke-width",this,c)+fd(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A,unwrappedTileID:z,getElevation:B}){const G=Fp(o,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-T.bearingInRadians,A),W=this.paint.get("circle-radius").evaluate(c,g)+this.paint.get("circle-stroke-width").evaluate(c,g),Q=this.paint.get("circle-pitch-scale"),ot=this.paint.get("circle-pitch-alignment");let ct,ut;return ot==="map"?(ct=G,ut=W*A):(ct=function(xt,Et,Vt,ue){return xt.map(Qt=>em(Qt,Et,Vt,ue))}(G,T,z,B),ut=W),Lm({queryGeometry:ct,size:ut,transform:T,unwrappedTileID:z,getElevation:B,pitchAlignment:ot,pitchScale:Q},x)}}class vg extends bf{}let To;ir("HeatmapBucket",vg,{omit:["layers"]});var bg={get paint(){return To=To||new _s({"heatmap-radius":new Or(Jt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Or(Jt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ir(Jt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new hh(Jt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ir(Jt.paint_heatmap["heatmap-opacity"])})}};function Fm(h,{width:o,height:c},g,x){if(x){if(x instanceof Uint8ClampedArray)x=new Uint8Array(x.buffer);else if(x.length!==o*c*g)throw new RangeError(`mismatched image size. expected: ${x.length} but got: ${o*c*g}`)}else x=new Uint8Array(o*c*g);return h.width=o,h.height=c,h.data=x,h}function wg(h,{width:o,height:c},g){if(o===h.width&&c===h.height)return;const x=Fm({},{width:o,height:c},g);Bm(h,x,{x:0,y:0},{x:0,y:0},{width:Math.min(h.width,o),height:Math.min(h.height,c)},g),h.width=o,h.height=c,h.data=x.data}function Bm(h,o,c,g,x,T){if(x.width===0||x.height===0)return o;if(x.width>h.width||x.height>h.height||c.x>h.width-x.width||c.y>h.height-x.height)throw new RangeError("out of range source coordinates for image copy");if(x.width>o.width||x.height>o.height||g.x>o.width-x.width||g.y>o.height-x.height)throw new RangeError("out of range destination coordinates for image copy");const A=h.data,z=o.data;if(A===z)throw new Error("srcData equals dstData, so image is already copied");for(let B=0;B<x.height;B++){const G=((c.y+B)*h.width+c.x)*T,W=((g.y+B)*o.width+g.x)*T;for(let Q=0;Q<x.width*T;Q++)z[W+Q]=A[G+Q]}return o}class Mu{constructor(o,c){Fm(this,o,1,c)}resize(o){wg(this,o,1)}clone(){return new Mu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(o,c,g,x,T){Bm(o,c,g,x,T,1)}}class Aa{constructor(o,c){Fm(this,o,4,c)}resize(o){wg(this,o,4)}replace(o,c){c?this.data.set(o):this.data=o instanceof Uint8ClampedArray?new Uint8Array(o.buffer):o}clone(){return new Aa({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(o,c,g,x,T){Bm(o,c,g,x,T,4)}setPixel(o,c,g){const x=4*(o*this.width+c);this.data[x+0]=Math.round(255*g.r/g.a),this.data[x+1]=Math.round(255*g.g/g.a),this.data[x+2]=Math.round(255*g.b/g.a),this.data[x+3]=Math.round(255*g.a)}}function im(h){const o={},c=h.resolution||256,g=h.clips?h.clips.length:1,x=h.image||new Aa({width:c,height:g});if(Math.log(c)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${c}`);const T=(A,z,B)=>{o[h.evaluationKey]=B;const G=h.expression.evaluate(o);x.setPixel(A/4/c,z/4,G)};if(h.clips)for(let A=0,z=0;A<g;++A,z+=4*c)for(let B=0,G=0;B<c;B++,G+=4){const W=B/(c-1),{start:Q,end:ot}=h.clips[A];T(z,G,Q*(1-W)+ot*W)}else for(let A=0,z=0;A<c;A++,z+=4)T(0,z,A/(c-1));return x}ir("AlphaImage",Mu),ir("RGBAImage",Aa);const Bp="big-fb";class Zc extends bl{createBucket(o){return new vg(o)}constructor(o,c){super(o,bg,c),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(o){o==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=im({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(Bp)&&this.heatmapFbos.delete(Bp)}queryRadius(o){return Pu("heatmap-radius",this,o)}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A,unwrappedTileID:z,getElevation:B}){return Lm({queryGeometry:o,size:this.paint.get("heatmap-radius").evaluate(c,g)*A,transform:T,unwrappedTileID:z,getElevation:B},x)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Tf;var ls={get paint(){return Tf=Tf||new _s({"hillshade-illumination-direction":new Ir(Jt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-altitude":new Ir(Jt.paint_hillshade["hillshade-illumination-altitude"]),"hillshade-illumination-anchor":new Ir(Jt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ir(Jt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ir(Jt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ir(Jt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ir(Jt.paint_hillshade["hillshade-accent-color"]),"hillshade-method":new Ir(Jt.paint_hillshade["hillshade-method"])})}};class tu extends bl{constructor(o,c){super(o,ls,c),this.recalculate({zoom:0,zoomHistory:{}},void 0)}getIlluminationProperties(){let o=this.paint.get("hillshade-illumination-direction").values,c=this.paint.get("hillshade-illumination-altitude").values,g=this.paint.get("hillshade-highlight-color").values,x=this.paint.get("hillshade-shadow-color").values;const T=Math.max(o.length,c.length,g.length,x.length);o=o.concat(Array(T-o.length).fill(o.at(-1))),c=c.concat(Array(T-c.length).fill(c.at(-1))),g=g.concat(Array(T-g.length).fill(g.at(-1))),x=x.concat(Array(T-x.length).fill(x.at(-1)));const A=c.map(bs);return{directionRadians:o.map(bs),altitudeRadians:A,shadowColor:x,highlightColor:g}}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}let Wd;var Sf={get paint(){return Wd=Wd||new _s({"color-relief-opacity":new Ir(Jt["paint_color-relief"]["color-relief-opacity"]),"color-relief-color":new hh(Jt["paint_color-relief"]["color-relief-color"])})}};class If{constructor(o,c,g,x){this.context=o,this.format=g,this.texture=o.gl.createTexture(),this.update(c,x)}update(o,c,g){const{width:x,height:T}=o,A=!(this.size&&this.size[0]===x&&this.size[1]===T||g),{context:z}=this,{gl:B}=z;if(this.useMipmap=!!(c&&c.useMipmap),B.bindTexture(B.TEXTURE_2D,this.texture),z.pixelStoreUnpackFlipY.set(!1),z.pixelStoreUnpack.set(1),z.pixelStoreUnpackPremultiplyAlpha.set(this.format===B.RGBA&&(!c||c.premultiply!==!1)),A)this.size=[x,T],o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof HTMLVideoElement||o instanceof ImageData||oo(o)?B.texImage2D(B.TEXTURE_2D,0,this.format,this.format,B.UNSIGNED_BYTE,o):B.texImage2D(B.TEXTURE_2D,0,this.format,x,T,0,this.format,B.UNSIGNED_BYTE,o.data);else{const{x:G,y:W}=g||{x:0,y:0};o instanceof HTMLImageElement||o instanceof HTMLCanvasElement||o instanceof HTMLVideoElement||o instanceof ImageData||oo(o)?B.texSubImage2D(B.TEXTURE_2D,0,G,W,B.RGBA,B.UNSIGNED_BYTE,o):B.texSubImage2D(B.TEXTURE_2D,0,G,W,x,T,B.RGBA,B.UNSIGNED_BYTE,o.data)}this.useMipmap&&this.isSizePowerOfTwo()&&B.generateMipmap(B.TEXTURE_2D),z.pixelStoreUnpackFlipY.setDefault(),z.pixelStoreUnpack.setDefault(),z.pixelStoreUnpackPremultiplyAlpha.setDefault()}bind(o,c,g){const{context:x}=this,{gl:T}=x;T.bindTexture(T.TEXTURE_2D,this.texture),g!==T.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(g=T.LINEAR),o!==this.filter&&(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,o),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,g||o),this.filter=o),c!==this.wrap&&(T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,c),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,c),this.wrap=c)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:o}=this.context;o.deleteTexture(this.texture),this.texture=null}}class Om{constructor(o,c,g,x=1,T=1,A=1,z=0){if(this.uid=o,c.height!==c.width)throw new RangeError("DEM tiles must be square");if(g&&!["mapbox","terrarium","custom"].includes(g))return void ho(`"${g}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=c.height;const B=this.dim=c.height-2;switch(this.data=new Uint32Array(c.data.buffer),g){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=x,this.greenFactor=T,this.blueFactor=A,this.baseShift=z;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let G=0;G<B;G++)this.data[this._idx(-1,G)]=this.data[this._idx(0,G)],this.data[this._idx(B,G)]=this.data[this._idx(B-1,G)],this.data[this._idx(G,-1)]=this.data[this._idx(G,0)],this.data[this._idx(G,B)]=this.data[this._idx(G,B-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(B,-1)]=this.data[this._idx(B-1,0)],this.data[this._idx(-1,B)]=this.data[this._idx(0,B-1)],this.data[this._idx(B,B)]=this.data[this._idx(B-1,B-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let G=0;G<B;G++)for(let W=0;W<B;W++){const Q=this.get(G,W);Q>this.max&&(this.max=Q),Q<this.min&&(this.min=Q)}}get(o,c){const g=new Uint8Array(this.data.buffer),x=4*this._idx(o,c);return this.unpack(g[x],g[x+1],g[x+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(o,c){if(o<-1||o>=this.dim+1||c<-1||c>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(c+1)*this.stride+(o+1)}unpack(o,c,g){return o*this.redFactor+c*this.greenFactor+g*this.blueFactor-this.baseShift}pack(o){return Op(o,this.getUnpackVector())}getPixels(){return new Aa({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(o,c,g){if(this.dim!==o.dim)throw new Error("dem dimension mismatch");let x=c*this.dim,T=c*this.dim+this.dim,A=g*this.dim,z=g*this.dim+this.dim;switch(c){case-1:x=T-1;break;case 1:T=x+1}switch(g){case-1:A=z-1;break;case 1:z=A+1}const B=-c*this.dim,G=-g*this.dim;for(let W=A;W<z;W++)for(let Q=x;Q<T;Q++)this.data[this._idx(Q,W)]=o.data[this._idx(Q+B,W+G)]}}function Op(h,o){const c=o[0],g=o[1],x=o[2],T=o[3],A=Math.min(c,g,x),z=Math.round((h+T)/A);return{r:Math.floor(z*A/c)%256,g:Math.floor(z*A/g)%256,b:Math.floor(z*A/x)%256}}ir("DEMData",Om);class __ extends bl{constructor(o,c){super(o,Sf,c)}_createColorRamp(o){const c={elevationStops:[],colorStops:[]},g=this._transitionablePaint._values["color-relief-color"].value.expression;if(g instanceof Bh&&g._styleExpression.expression instanceof la){this.colorRampExpression=g;const A=g._styleExpression.expression;c.elevationStops=A.labels,c.colorStops=[];for(const z of c.elevationStops)c.colorStops.push(A.evaluate({globals:{elevation:z}}))}if(c.elevationStops.length<1&&(c.elevationStops=[0],c.colorStops=[un.transparent]),c.elevationStops.length<2&&(c.elevationStops.push(c.elevationStops[0]+1),c.colorStops.push(c.colorStops[0])),c.elevationStops.length<=o)return c;const x={elevationStops:[],colorStops:[]},T=(c.elevationStops.length-1)/(o-1);for(let A=0;A<c.elevationStops.length-.5;A+=T)x.elevationStops.push(c.elevationStops[Math.round(A)]),x.colorStops.push(c.colorStops[Math.round(A)]);return ho(`Too many colors in specification of ${this.id} color-relief layer, may not render properly. Max possible colors: ${o}, provided: ${c.elevationStops.length}`),x}_colorRampChanged(){return this.colorRampExpression!=this._transitionablePaint._values["color-relief-color"].value.expression}getColorRampTextures(o,c,g){if(this.colorRampTextures&&!this._colorRampChanged())return this.colorRampTextures;const x=this._createColorRamp(c),T=new Aa({width:x.colorStops.length,height:1}),A=new Aa({width:x.colorStops.length,height:1});for(let z=0;z<x.elevationStops.length;z++){const B=Op(x.elevationStops[z],g);A.setPixel(0,z,new un(B.r/255,B.g/255,B.b/255,1)),T.setPixel(0,z,x.colorStops[z])}return this.colorRampTextures={elevationTexture:new If(o,A,o.gl.RGBA),colorTexture:new If(o,T,o.gl.RGBA)},this.colorRampTextures}hasOffscreenPass(){return this.visibility!=="none"&&!!this.colorRampTextures}}const Tg=Ko([{name:"a_pos",components:2,type:"Int16"}],4),{members:Nm}=Tg;function Np(h,o,c){const g=c.patternDependencies;let x=!1;for(const T of o){const A=T.paint.get(`${h}-pattern`);A.isConstant()||(x=!0);const z=A.constantOr(null);z&&(x=!0,g[z.to]=!0,g[z.from]=!0)}return x}function Vp(h,o,c,g,x){const{zoom:T}=g,A=x.patternDependencies;for(const z of o){const B=z.paint.get(`${h}-pattern`).value;if(B.kind!=="constant"){let G=B.evaluate({zoom:T-1},c,{},x.availableImages),W=B.evaluate({zoom:T},c,{},x.availableImages),Q=B.evaluate({zoom:T+1},c,{},x.availableImages);G=G&&G.name?G.name:G,W=W&&W.name?W.name:W,Q=Q&&Q.name?Q.name:Q,A[G]=!0,A[W]=!0,A[Q]=!0,c.patterns[z.id]={min:G,mid:W,max:Q}}}return c}function Ef(h,o,c,g,x){let T;if(x===function(A,z,B,G){let W=0;for(let Q=z,ot=B-G;Q<B;Q+=G)W+=(A[ot]-A[Q])*(A[Q+1]+A[ot+1]),ot=Q;return W}(h,o,c,g)>0)for(let A=o;A<c;A+=g)T=N(A/g|0,h[A],h[A+1],T);else for(let A=c-g;A>=o;A-=g)T=N(A/g|0,h[A],h[A+1],T);return T&&f(T,T.next)&&(V(T),T=T.next),T}function mh(h,o){if(!h)return h;o||(o=h);let c,g=h;do if(c=!1,g.steiner||!f(g,g.next)&&a(g.prev,g,g.next)!==0)g=g.next;else{if(V(g),g=o=g.prev,g===g.next)break;c=!0}while(c||g!==o);return o}function xc(h,o,c,g,x,T,A){if(!h)return;!A&&T&&function(B,G,W,Q){let ot=B;do ot.z===0&&(ot.z=Vm(ot.x,ot.y,G,W,Q)),ot.prevZ=ot.prev,ot.nextZ=ot.next,ot=ot.next;while(ot!==B);ot.prevZ.nextZ=null,ot.prevZ=null,function(ct){let ut,xt=1;do{let Et,Vt=ct;ct=null;let ue=null;for(ut=0;Vt;){ut++;let Qt=Vt,ee=0;for(let Ee=0;Ee<xt&&(ee++,Qt=Qt.nextZ,Qt);Ee++);let Se=xt;for(;ee>0||Se>0&&Qt;)ee!==0&&(Se===0||!Qt||Vt.z<=Qt.z)?(Et=Vt,Vt=Vt.nextZ,ee--):(Et=Qt,Qt=Qt.nextZ,Se--),ue?ue.nextZ=Et:ct=Et,Et.prevZ=ue,ue=Et;Vt=Qt}ue.nextZ=null,xt*=2}while(ut>1)}(ot)}(h,g,x,T);let z=h;for(;h.prev!==h.next;){const B=h.prev,G=h.next;if(T?Na(h,g,x,T):gh(h))o.push(B.i,h.i,G.i),V(h),h=G.next,z=G.next;else if((h=G)===z){A?A===1?xc(h=Cu(mh(h),o),o,c,g,x,T,2):A===2&&_h(h,o,c,g,x,T):xc(mh(h),o,c,g,x,T,1);break}}}function gh(h){const o=h.prev,c=h,g=h.next;if(a(o,c,g)>=0)return!1;const x=o.x,T=c.x,A=g.x,z=o.y,B=c.y,G=g.y,W=Math.min(x,T,A),Q=Math.min(z,B,G),ot=Math.max(x,T,A),ct=Math.max(z,B,G);let ut=g.next;for(;ut!==o;){if(ut.x>=W&&ut.x<=ot&&ut.y>=Q&&ut.y<=ct&&p(x,z,T,B,A,G,ut.x,ut.y)&&a(ut.prev,ut,ut.next)>=0)return!1;ut=ut.next}return!0}function Na(h,o,c,g){const x=h.prev,T=h,A=h.next;if(a(x,T,A)>=0)return!1;const z=x.x,B=T.x,G=A.x,W=x.y,Q=T.y,ot=A.y,ct=Math.min(z,B,G),ut=Math.min(W,Q,ot),xt=Math.max(z,B,G),Et=Math.max(W,Q,ot),Vt=Vm(ct,ut,o,c,g),ue=Vm(xt,Et,o,c,g);let Qt=h.prevZ,ee=h.nextZ;for(;Qt&&Qt.z>=Vt&&ee&&ee.z<=ue;){if(Qt.x>=ct&&Qt.x<=xt&&Qt.y>=ut&&Qt.y<=Et&&Qt!==x&&Qt!==A&&p(z,W,B,Q,G,ot,Qt.x,Qt.y)&&a(Qt.prev,Qt,Qt.next)>=0||(Qt=Qt.prevZ,ee.x>=ct&&ee.x<=xt&&ee.y>=ut&&ee.y<=Et&&ee!==x&&ee!==A&&p(z,W,B,Q,G,ot,ee.x,ee.y)&&a(ee.prev,ee,ee.next)>=0))return!1;ee=ee.nextZ}for(;Qt&&Qt.z>=Vt;){if(Qt.x>=ct&&Qt.x<=xt&&Qt.y>=ut&&Qt.y<=Et&&Qt!==x&&Qt!==A&&p(z,W,B,Q,G,ot,Qt.x,Qt.y)&&a(Qt.prev,Qt,Qt.next)>=0)return!1;Qt=Qt.prevZ}for(;ee&&ee.z<=ue;){if(ee.x>=ct&&ee.x<=xt&&ee.y>=ut&&ee.y<=Et&&ee!==x&&ee!==A&&p(z,W,B,Q,G,ot,ee.x,ee.y)&&a(ee.prev,ee,ee.next)>=0)return!1;ee=ee.nextZ}return!0}function Cu(h,o){let c=h;do{const g=c.prev,x=c.next.next;!f(g,x)&&y(g,c,c.next,x)&&M(g,x)&&M(x,g)&&(o.push(g.i,c.i,x.i),V(c),V(c.next),c=h=x),c=c.next}while(c!==h);return mh(c)}function _h(h,o,c,g,x,T){let A=h;do{let z=A.next.next;for(;z!==A.prev;){if(A.i!==z.i&&e(A,z)){let B=L(A,z);return A=mh(A,A.next),B=mh(B,B.next),xc(A,o,c,g,x,T,0),void xc(B,o,c,g,x,T,0)}z=z.next}A=A.next}while(A!==h)}function y_(h,o){let c=h.x-o.x;return c===0&&(c=h.y-o.y,c===0)&&(c=(h.next.y-h.y)/(h.next.x-h.x)-(o.next.y-o.y)/(o.next.x-o.x)),c}function x_(h,o){const c=function(x,T){let A=T;const z=x.x,B=x.y;let G,W=-1/0;if(f(x,A))return A;do{if(f(x,A.next))return A.next;if(B<=A.y&&B>=A.next.y&&A.next.y!==A.y){const xt=A.x+(B-A.y)*(A.next.x-A.x)/(A.next.y-A.y);if(xt<=z&&xt>W&&(W=xt,G=A.x<A.next.x?A:A.next,xt===z))return G}A=A.next}while(A!==T);if(!G)return null;const Q=G,ot=G.x,ct=G.y;let ut=1/0;A=G;do{if(z>=A.x&&A.x>=ot&&z!==A.x&&Tl(B<ct?z:W,B,ot,ct,B<ct?W:z,B,A.x,A.y)){const xt=Math.abs(B-A.y)/(z-A.x);M(A,x)&&(xt<ut||xt===ut&&(A.x>G.x||A.x===G.x&&v_(G,A)))&&(G=A,ut=xt)}A=A.next}while(A!==Q);return G}(h,o);if(!c)return o;const g=L(c,h);return mh(g,g.next),mh(c,c.next)}function v_(h,o){return a(h.prev,h,o.prev)<0&&a(o.next,h,h.next)<0}function Vm(h,o,c,g,x){return(h=1431655765&((h=858993459&((h=252645135&((h=16711935&((h=(h-c)*x|0)|h<<8))|h<<4))|h<<2))|h<<1))|(o=1431655765&((o=858993459&((o=252645135&((o=16711935&((o=(o-g)*x|0)|o<<8))|o<<4))|o<<2))|o<<1))<<1}function Um(h){let o=h,c=h;do(o.x<c.x||o.x===c.x&&o.y<c.y)&&(c=o),o=o.next;while(o!==h);return c}function Tl(h,o,c,g,x,T,A,z){return(x-A)*(o-z)>=(h-A)*(T-z)&&(h-A)*(g-z)>=(c-A)*(o-z)&&(c-A)*(T-z)>=(x-A)*(g-z)}function p(h,o,c,g,x,T,A,z){return!(h===A&&o===z)&&Tl(h,o,c,g,x,T,A,z)}function e(h,o){return h.next.i!==o.i&&h.prev.i!==o.i&&!function(c,g){let x=c;do{if(x.i!==c.i&&x.next.i!==c.i&&x.i!==g.i&&x.next.i!==g.i&&y(x,x.next,c,g))return!0;x=x.next}while(x!==c);return!1}(h,o)&&(M(h,o)&&M(o,h)&&function(c,g){let x=c,T=!1;const A=(c.x+g.x)/2,z=(c.y+g.y)/2;do x.y>z!=x.next.y>z&&x.next.y!==x.y&&A<(x.next.x-x.x)*(z-x.y)/(x.next.y-x.y)+x.x&&(T=!T),x=x.next;while(x!==c);return T}(h,o)&&(a(h.prev,h,o.prev)||a(h,o.prev,o))||f(h,o)&&a(h.prev,h,h.next)>0&&a(o.prev,o,o.next)>0)}function a(h,o,c){return(o.y-h.y)*(c.x-o.x)-(o.x-h.x)*(c.y-o.y)}function f(h,o){return h.x===o.x&&h.y===o.y}function y(h,o,c,g){const x=I(a(h,o,c)),T=I(a(h,o,g)),A=I(a(c,g,h)),z=I(a(c,g,o));return x!==T&&A!==z||!(x!==0||!w(h,c,o))||!(T!==0||!w(h,g,o))||!(A!==0||!w(c,h,g))||!(z!==0||!w(c,o,g))}function w(h,o,c){return o.x<=Math.max(h.x,c.x)&&o.x>=Math.min(h.x,c.x)&&o.y<=Math.max(h.y,c.y)&&o.y>=Math.min(h.y,c.y)}function I(h){return h>0?1:h<0?-1:0}function M(h,o){return a(h.prev,h,h.next)<0?a(h,o,h.next)>=0&&a(h,h.prev,o)>=0:a(h,o,h.prev)<0||a(h,h.next,o)<0}function L(h,o){const c=Z(h.i,h.x,h.y),g=Z(o.i,o.x,o.y),x=h.next,T=o.prev;return h.next=o,o.prev=h,c.next=x,x.prev=c,g.next=c,c.prev=g,T.next=g,g.prev=T,g}function N(h,o,c,g){const x=Z(h,o,c);return g?(x.next=g.next,x.prev=g,g.next.prev=x,g.next=x):(x.prev=x,x.next=x),x}function V(h){h.next.prev=h.prev,h.prev.next=h.next,h.prevZ&&(h.prevZ.nextZ=h.nextZ),h.nextZ&&(h.nextZ.prevZ=h.prevZ)}function Z(h,o,c){return{i:h,x:o,y:c,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class U{constructor(o,c){if(c>o)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=o,this._minGranularity=c}getGranularityForZoomLevel(o){return Math.max(Math.floor(this._baseZoomGranularity/(1<<o)),this._minGranularity,1)}}class X{constructor(o){this.fill=o.fill,this.line=o.line,this.tile=o.tile,this.stencil=o.stencil,this.circle=o.circle}}X.noSubdivision=new X({fill:new U(0,0),line:new U(0,0),tile:new U(0,0),stencil:new U(0,0),circle:1}),ir("SubdivisionGranularityExpression",U),ir("SubdivisionGranularitySetting",X);const K=-32768,rt=32767;class ht{constructor(o,c){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=o,this._granularityCellSize=zn/o,this._canonical=c}_getKey(o,c){return(o+=32768)<<16|c+32768}_vertexToIndex(o,c){if(o<-32768||c<-32768||o>32767||c>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const g=0|Math.round(o),x=0|Math.round(c),T=this._getKey(g,x);if(this._vertexDictionary.has(T))return this._vertexDictionary.get(T);const A=this._vertexBuffer.length/2;return this._vertexDictionary.set(T,A),this._vertexBuffer.push(g,x),A}_subdivideTrianglesScanline(o){if(this._granularity<2)return function(x,T){const A=[];for(let z=0;z<T.length;z+=3){const B=T[z],G=T[z+1],W=T[z+2],Q=x[2*B],ot=x[2*B+1];(x[2*G]-Q)*(x[2*W+1]-ot)-(x[2*G+1]-ot)*(x[2*W]-Q)>0?(A.push(B),A.push(W),A.push(G)):(A.push(B),A.push(G),A.push(W))}return A}(this._vertexBuffer,o);const c=[],g=o.length;for(let x=0;x<g;x+=3){const T=[o[x+0],o[x+1],o[x+2]],A=[this._vertexBuffer[2*o[x+0]+0],this._vertexBuffer[2*o[x+0]+1],this._vertexBuffer[2*o[x+1]+0],this._vertexBuffer[2*o[x+1]+1],this._vertexBuffer[2*o[x+2]+0],this._vertexBuffer[2*o[x+2]+1]];let z=1/0,B=1/0,G=-1/0,W=-1/0;for(let xt=0;xt<3;xt++){const Et=A[2*xt],Vt=A[2*xt+1];z=Math.min(z,Et),G=Math.max(G,Et),B=Math.min(B,Vt),W=Math.max(W,Vt)}if(z===G||B===W)continue;const Q=Math.floor(z/this._granularityCellSize),ot=Math.ceil(G/this._granularityCellSize),ct=Math.floor(B/this._granularityCellSize),ut=Math.ceil(W/this._granularityCellSize);if(Q!==ot||ct!==ut)for(let xt=ct;xt<ut;xt++){const Et=this._scanlineGenerateVertexRingForCellRow(xt,A,T);Mt(this._vertexBuffer,Et,c)}else c.push(...T)}return c}_scanlineGenerateVertexRingForCellRow(o,c,g){const x=o*this._granularityCellSize,T=x+this._granularityCellSize,A=[];for(let z=0;z<3;z++){const B=c[2*z],G=c[2*z+1],W=c[2*(z+1)%6],Q=c[(2*(z+1)+1)%6],ot=c[2*(z+2)%6],ct=c[(2*(z+2)+1)%6],ut=W-B,xt=Q-G,Et=ut===0,Vt=xt===0,ue=(x-G)/xt,Qt=(T-G)/xt,ee=Math.min(ue,Qt),Se=Math.max(ue,Qt);if(!Vt&&(ee>=1||Se<=0)||Vt&&(G<x||G>T)){Q>=x&&Q<=T&&A.push(g[(z+1)%3]);continue}!Vt&&ee>0&&A.push(this._vertexToIndex(B+ut*ee,G+xt*ee));const Ee=B+ut*Math.max(ee,0),ei=B+ut*Math.min(Se,1);Et||this._generateIntraEdgeVertices(A,B,G,W,Q,Ee,ei),!Vt&&Se<1&&A.push(this._vertexToIndex(B+ut*Se,G+xt*Se)),(Vt||Q>=x&&Q<=T)&&A.push(g[(z+1)%3]),!Vt&&(Q<=x||Q>=T)&&this._generateInterEdgeVertices(A,B,G,W,Q,ot,ct,ei,x,T)}return A}_generateIntraEdgeVertices(o,c,g,x,T,A,z){const B=x-c,G=T-g,W=G===0,Q=W?Math.min(c,x):Math.min(A,z),ot=W?Math.max(c,x):Math.max(A,z),ct=Math.floor(Q/this._granularityCellSize)+1,ut=Math.ceil(ot/this._granularityCellSize)-1;if(W?c<x:A<z)for(let xt=ct;xt<=ut;xt++){const Et=xt*this._granularityCellSize;o.push(this._vertexToIndex(Et,g+G*(Et-c)/B))}else for(let xt=ut;xt>=ct;xt--){const Et=xt*this._granularityCellSize;o.push(this._vertexToIndex(Et,g+G*(Et-c)/B))}}_generateInterEdgeVertices(o,c,g,x,T,A,z,B,G,W){const Q=T-g,ot=A-x,ct=z-T,ut=(G-T)/ct,xt=(W-T)/ct,Et=Math.min(ut,xt),Vt=Math.max(ut,xt),ue=x+ot*Et;let Qt=Math.floor(Math.min(ue,B)/this._granularityCellSize)+1,ee=Math.ceil(Math.max(ue,B)/this._granularityCellSize)-1,Se=B<ue;const Ee=ct===0;if(Ee&&(z===G||z===W))return;if(Ee||Et>=1||Vt<=0){const Ii=g-z,fi=A+(c-A)*Math.min((G-z)/Ii,(W-z)/Ii);Qt=Math.floor(Math.min(fi,B)/this._granularityCellSize)+1,ee=Math.ceil(Math.max(fi,B)/this._granularityCellSize)-1,Se=B<fi}const ei=Q>0?W:G;if(Se)for(let Ii=Qt;Ii<=ee;Ii++)o.push(this._vertexToIndex(Ii*this._granularityCellSize,ei));else for(let Ii=ee;Ii>=Qt;Ii--)o.push(this._vertexToIndex(Ii*this._granularityCellSize,ei))}_generateOutline(o){const c=[];for(const g of o){const x=_t(g,this._granularity,!0),T=this._pointArrayToIndices(x),A=[];for(let z=1;z<T.length;z++)A.push(T[z-1]),A.push(T[z]);c.push(A)}return c}_handlePoles(o){let c=!1,g=!1;this._canonical&&(this._canonical.y===0&&(c=!0),this._canonical.y===(1<<this._canonical.z)-1&&(g=!0)),(c||g)&&this._fillPoles(o,c,g)}_ensureNoPoleVertices(){const o=this._vertexBuffer;for(let c=0;c<o.length;c+=2){const g=o[c+1];g===K&&(o[c+1]=-32767),g===rt&&(o[c+1]=32766)}}_generatePoleQuad(o,c,g,x,T,A){x>T!=(A===K)?(o.push(c),o.push(g),o.push(this._vertexToIndex(x,A)),o.push(g),o.push(this._vertexToIndex(T,A)),o.push(this._vertexToIndex(x,A))):(o.push(g),o.push(c),o.push(this._vertexToIndex(x,A)),o.push(this._vertexToIndex(T,A)),o.push(g),o.push(this._vertexToIndex(x,A)))}_fillPoles(o,c,g){const x=this._vertexBuffer,T=zn,A=o.length;for(let z=2;z<A;z+=3){const B=o[z-2],G=o[z-1],W=o[z],Q=x[2*B],ot=x[2*B+1],ct=x[2*G],ut=x[2*G+1],xt=x[2*W],Et=x[2*W+1];c&&(ot===0&&ut===0&&this._generatePoleQuad(o,B,G,Q,ct,K),ut===0&&Et===0&&this._generatePoleQuad(o,G,W,ct,xt,K),Et===0&&ot===0&&this._generatePoleQuad(o,W,B,xt,Q,K)),g&&(ot===T&&ut===T&&this._generatePoleQuad(o,B,G,Q,ct,rt),ut===T&&Et===T&&this._generatePoleQuad(o,G,W,ct,xt,rt),Et===T&&ot===T&&this._generatePoleQuad(o,W,B,xt,Q,rt))}}_initializeVertices(o){for(let c=0;c<o.length;c+=2)this._vertexToIndex(o[c],o[c+1])}subdividePolygonInternal(o,c){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:g,holeIndices:x}=function(z){const B=[],G=[];for(const W of z)if(W.length!==0){W!==z[0]&&B.push(G.length/2);for(let Q=0;Q<W.length;Q++)G.push(W[Q].x),G.push(W[Q].y)}return{flattened:G,holeIndices:B}}(o);let T;this._initializeVertices(g);try{const z=function(G,W,Q=2){const ot=W&&W.length,ct=ot?W[0]*Q:G.length;let ut=Ef(G,0,ct,Q,!0);const xt=[];if(!ut||ut.next===ut.prev)return xt;let Et,Vt,ue;if(ot&&(ut=function(Qt,ee,Se,Ee){const ei=[];for(let Ii=0,fi=ee.length;Ii<fi;Ii++){const zi=Ef(Qt,ee[Ii]*Ee,Ii<fi-1?ee[Ii+1]*Ee:Qt.length,Ee,!1);zi===zi.next&&(zi.steiner=!0),ei.push(Um(zi))}ei.sort(y_);for(let Ii=0;Ii<ei.length;Ii++)Se=x_(ei[Ii],Se);return Se}(G,W,ut,Q)),G.length>80*Q){Et=G[0],Vt=G[1];let Qt=Et,ee=Vt;for(let Se=Q;Se<ct;Se+=Q){const Ee=G[Se],ei=G[Se+1];Ee<Et&&(Et=Ee),ei<Vt&&(Vt=ei),Ee>Qt&&(Qt=Ee),ei>ee&&(ee=ei)}ue=Math.max(Qt-Et,ee-Vt),ue=ue!==0?32767/ue:0}return xc(ut,xt,Q,Et,Vt,ue,0),xt}(g,x),B=this._convertIndices(g,z);T=this._subdivideTrianglesScanline(B)}catch(z){console.error(z)}let A=[];return c&&(A=this._generateOutline(o)),this._ensureNoPoleVertices(),this._handlePoles(T),{verticesFlattened:this._vertexBuffer,indicesTriangles:T,indicesLineList:A}}_convertIndices(o,c){const g=[];for(let x=0;x<c.length;x++)g.push(this._vertexToIndex(o[2*c[x]],o[2*c[x]+1]));return g}_pointArrayToIndices(o){const c=[];for(let g=0;g<o.length;g++){const x=o[g];c.push(this._vertexToIndex(x.x,x.y))}return c}}function lt(h,o,c,g=!0){return new ht(c,o).subdividePolygonInternal(h,g)}function _t(h,o,c=!1){if(!h||h.length<1)return[];if(h.length<2)return[];const g=h[0],x=h[h.length-1],T=c&&(g.x!==x.x||g.y!==x.y);if(o<2)return T?[...h,h[0]]:[...h];const A=Math.floor(zn/o),z=[];z.push(new Le(h[0].x,h[0].y));const B=h.length,G=T?B:B-1;for(let W=0;W<G;W++){const Q=h[W],ot=W<B-1?h[W+1]:h[0],ct=Q.x,ut=Q.y,xt=ot.x,Et=ot.y,Vt=ct!==xt,ue=ut!==Et;if(!Vt&&!ue)continue;const Qt=xt-ct,ee=Et-ut,Se=Math.abs(Qt),Ee=Math.abs(ee);let ei=ct,Ii=ut;for(;;){const zi=Qt>0?(Math.floor(ei/A)+1)*A:(Math.ceil(ei/A)-1)*A,Ji=ee>0?(Math.floor(Ii/A)+1)*A:(Math.ceil(Ii/A)-1)*A,$i=Math.abs(ei-zi),Ui=Math.abs(Ii-Ji),_i=Math.abs(ei-xt),kr=Math.abs(Ii-Et),Ar=Vt?$i/Se:Number.POSITIVE_INFINITY,Nr=ue?Ui/Ee:Number.POSITIVE_INFINITY;if((_i<=$i||!Vt)&&(kr<=Ui||!ue))break;if(Ar<Nr&&Vt||!ue){ei=zi,Ii+=ee*Ar;const yr=new Le(ei,Math.round(Ii));z[z.length-1].x===yr.x&&z[z.length-1].y===yr.y||z.push(yr)}else{ei+=Qt*Nr,Ii=Ji;const yr=new Le(Math.round(ei),Ii);z[z.length-1].x===yr.x&&z[z.length-1].y===yr.y||z.push(yr)}}const fi=new Le(xt,Et);z[z.length-1].x===fi.x&&z[z.length-1].y===fi.y||z.push(fi)}return z}function Mt(h,o,c){if(o.length===0)throw new Error("Subdivision vertex ring is empty.");let g=0,x=h[2*o[0]];for(let B=1;B<o.length;B++){const G=h[2*o[B]];G<x&&(x=G,g=B)}const T=o.length;let A=g,z=(A+1)%T;for(;;){const B=A-1>=0?A-1:T-1,G=(z+1)%T,W=h[2*o[B]],Q=h[2*o[G]],ot=h[2*o[A]],ct=h[2*o[A]+1],ut=h[2*o[z]+1];let xt=!1;if(W<Q)xt=!0;else if(W>Q)xt=!1;else{const Et=ut-ct,Vt=-(h[2*o[z]]-ot),ue=ct<ut?1:-1;((W-ot)*Et+(h[2*o[B]+1]-ct)*Vt)*ue>((Q-ot)*Et+(h[2*o[G]+1]-ct)*Vt)*ue&&(xt=!0)}if(xt){const Et=o[B],Vt=o[A],ue=o[z];Et!==Vt&&Et!==ue&&Vt!==ue&&c.push(ue,Vt,Et),A--,A<0&&(A=T-1)}else{const Et=o[G],Vt=o[A],ue=o[z];Et!==Vt&&Et!==ue&&Vt!==ue&&c.push(ue,Vt,Et),z++,z>=T&&(z=0)}if(B===G)break}}function vt(h,o,c,g,x,T,A,z,B){const G=x.length/2,W=A&&z&&B;if(G<Zr.MAX_VERTEX_ARRAY_LENGTH){const Q=o.prepareSegment(G,c,g),ot=Q.vertexLength;for(let xt=0;xt<T.length;xt+=3)g.emplaceBack(ot+T[xt],ot+T[xt+1],ot+T[xt+2]);let ct,ut;Q.vertexLength+=G,Q.primitiveLength+=T.length/3,W&&(ut=A.prepareSegment(G,c,z),ct=ut.vertexLength,ut.vertexLength+=G);for(let xt=0;xt<x.length;xt+=2)h(x[xt],x[xt+1]);if(W)for(let xt=0;xt<B.length;xt++){const Et=B[xt];for(let Vt=1;Vt<Et.length;Vt+=2)z.emplaceBack(ct+Et[Vt-1],ct+Et[Vt]);ut.primitiveLength+=Et.length/2}}else(function(Q,ot,ct,ut,xt,Et){const Vt=[];for(let Ee=0;Ee<ut.length/2;Ee++)Vt.push(-1);const ue={count:0};let Qt=0,ee=Q.getOrCreateLatestSegment(ot,ct),Se=ee.vertexLength;for(let Ee=2;Ee<xt.length;Ee+=3){const ei=xt[Ee-2],Ii=xt[Ee-1],fi=xt[Ee];let zi=Vt[ei]<Qt,Ji=Vt[Ii]<Qt,$i=Vt[fi]<Qt;ee.vertexLength+((zi?1:0)+(Ji?1:0)+($i?1:0))>Zr.MAX_VERTEX_ARRAY_LENGTH&&(ee=Q.createNewSegment(ot,ct),Qt=ue.count,zi=!0,Ji=!0,$i=!0,Se=0);const Ui=Ut(Vt,ut,Et,ue,ei,zi,ee),_i=Ut(Vt,ut,Et,ue,Ii,Ji,ee),kr=Ut(Vt,ut,Et,ue,fi,$i,ee);ct.emplaceBack(Se+Ui-Qt,Se+_i-Qt,Se+kr-Qt),ee.primitiveLength++}})(o,c,g,x,T,h),W&&function(Q,ot,ct,ut,xt,Et){const Vt=[];for(let Ee=0;Ee<ut.length/2;Ee++)Vt.push(-1);const ue={count:0};let Qt=0,ee=Q.getOrCreateLatestSegment(ot,ct),Se=ee.vertexLength;for(let Ee=0;Ee<xt.length;Ee++){const ei=xt[Ee];for(let Ii=1;Ii<xt[Ee].length;Ii+=2){const fi=ei[Ii-1],zi=ei[Ii];let Ji=Vt[fi]<Qt,$i=Vt[zi]<Qt;ee.vertexLength+((Ji?1:0)+($i?1:0))>Zr.MAX_VERTEX_ARRAY_LENGTH&&(ee=Q.createNewSegment(ot,ct),Qt=ue.count,Ji=!0,$i=!0,Se=0);const Ui=Ut(Vt,ut,Et,ue,fi,Ji,ee),_i=Ut(Vt,ut,Et,ue,zi,$i,ee);ct.emplaceBack(Se+Ui-Qt,Se+_i-Qt),ee.primitiveLength++}}}(A,c,z,x,B,h),o.forceNewSegmentOnNextPrepare(),A==null||A.forceNewSegmentOnNextPrepare()}function Ut(h,o,c,g,x,T,A){if(T){const z=g.count;return c(o[2*x],o[2*x+1]),h[x]=g.count,g.count++,A.vertexLength++,z}return h[x]}class Ct{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.patternFeatures=[],this.layoutVertexArray=new _e,this.indexArray=new Oi,this.indexArray2=new Ti,this.programConfigurations=new dh(o.layers,o.zoom),this.segments=new Zr,this.segments2=new Zr,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){this.hasDependencies=Np("fill",this.layers,c);const x=this.layers[0].layout.get("fill-sort-key"),T=!x.isConstant(),A=[];for(const{feature:z,id:B,index:G,sourceLayerIndex:W}of o){const Q=this.layers[0]._featureFilter.needGeometry,ot=yc(z,Q);if(!this.layers[0]._featureFilter.filter(new wo(this.zoom),ot,g))continue;const ct=T?x.evaluate(ot,{},g,c.availableImages):void 0,ut={id:B,properties:z.properties,type:z.type,sourceLayerIndex:W,index:G,geometry:Q?ot.geometry:Ul(z),patterns:{},sortKey:ct};A.push(ut)}T&&A.sort((z,B)=>z.sortKey-B.sortKey);for(const z of A){const{geometry:B,index:G,sourceLayerIndex:W}=z;if(this.hasDependencies){const Q=Vp("fill",this.layers,z,{zoom:this.zoom},c);this.patternFeatures.push(Q)}else this.addFeature(z,B,G,g,{},c.subdivisionGranularity);c.featureIndex.insert(o[G].feature,B,G,W,this.index)}}update(o,c,g){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g})}addFeatures(o,c,g){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,c,g,o.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,Nm),this.indexBuffer=o.createIndexBuffer(this.indexArray),this.indexBuffer2=o.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(o,c,g,x,T,A){for(const z of ih(c,500)){const B=lt(z,x,A.fill.getGranularityForZoomLevel(x.z)),G=this.layoutVertexArray;vt((W,Q)=>{G.emplaceBack(W,Q)},this.segments,this.layoutVertexArray,this.indexArray,B.verticesFlattened,B.indicesTriangles,this.segments2,this.indexArray2,B.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:T,canonical:x})}}let $t,Ot;ir("FillBucket",Ct,{omit:["layers","patternFeatures"]});var Rt={get paint(){return Ot=Ot||new _s({"fill-antialias":new Ir(Jt.paint_fill["fill-antialias"]),"fill-opacity":new Or(Jt.paint_fill["fill-opacity"]),"fill-color":new Or(Jt.paint_fill["fill-color"]),"fill-outline-color":new Or(Jt.paint_fill["fill-outline-color"]),"fill-translate":new Ir(Jt.paint_fill["fill-translate"]),"fill-translate-anchor":new Ir(Jt.paint_fill["fill-translate-anchor"]),"fill-pattern":new Xh(Jt.paint_fill["fill-pattern"])})},get layout(){return $t=$t||new _s({"fill-sort-key":new Or(Jt.layout_fill["fill-sort-key"])})}};class Zt extends bl{constructor(o,c){super(o,Rt,c)}recalculate(o,c){super.recalculate(o,c);const g=this.paint._values["fill-outline-color"];g.value.kind==="constant"&&g.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(o){return new Ct(o)}queryRadius(){return fd(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:o,geometry:c,transform:g,pixelsToTileUnits:x}){return Au(Fp(o,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-g.bearingInRadians,x),c)}isTileClipped(){return!0}}const pe=Ko([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),le=Ko([{name:"a_centroid",components:2,type:"Int16"}],4),{members:Me}=pe;class ve{constructor(o,c,g,x,T){this.properties={},this.extent=g,this.type=0,this.id=void 0,this._pbf=o,this._geometry=-1,this._keys=x,this._values=T,o.readFields(Be,this,c)}loadGeometry(){const o=this._pbf;o.pos=this._geometry;const c=o.readVarint()+o.pos,g=[];let x,T=1,A=0,z=0,B=0;for(;o.pos<c;){if(A<=0){const G=o.readVarint();T=7&G,A=G>>3}if(A--,T===1||T===2)z+=o.readSVarint(),B+=o.readSVarint(),T===1&&(x&&g.push(x),x=[]),x&&x.push(new Le(z,B));else{if(T!==7)throw new Error(`unknown command ${T}`);x&&x.push(x[0].clone())}}return x&&g.push(x),g}bbox(){const o=this._pbf;o.pos=this._geometry;const c=o.readVarint()+o.pos;let g=1,x=0,T=0,A=0,z=1/0,B=-1/0,G=1/0,W=-1/0;for(;o.pos<c;){if(x<=0){const Q=o.readVarint();g=7&Q,x=Q>>3}if(x--,g===1||g===2)T+=o.readSVarint(),A+=o.readSVarint(),T<z&&(z=T),T>B&&(B=T),A<G&&(G=A),A>W&&(W=A);else if(g!==7)throw new Error(`unknown command ${g}`)}return[z,G,B,W]}toGeoJSON(o,c,g){const x=this.extent*Math.pow(2,g),T=this.extent*o,A=this.extent*c,z=this.loadGeometry();function B(ot){return[360*(ot.x+T)/x-180,360/Math.PI*Math.atan(Math.exp((1-2*(ot.y+A)/x)*Math.PI))-90]}function G(ot){return ot.map(B)}let W;if(this.type===1){const ot=[];for(const ut of z)ot.push(ut[0]);const ct=G(ot);W=ot.length===1?{type:"Point",coordinates:ct[0]}:{type:"MultiPoint",coordinates:ct}}else if(this.type===2){const ot=z.map(G);W=ot.length===1?{type:"LineString",coordinates:ot[0]}:{type:"MultiLineString",coordinates:ot}}else{if(this.type!==3)throw new Error("unknown feature type");{const ot=function(ut){const xt=ut.length;if(xt<=1)return[ut];const Et=[];let Vt,ue;for(let Qt=0;Qt<xt;Qt++){const ee=oi(ut[Qt]);ee!==0&&(ue===void 0&&(ue=ee<0),ue===ee<0?(Vt&&Et.push(Vt),Vt=[ut[Qt]]):Vt&&Vt.push(ut[Qt]))}return Vt&&Et.push(Vt),Et}(z),ct=[];for(const ut of ot)ct.push(ut.map(G));W=ct.length===1?{type:"Polygon",coordinates:ct[0]}:{type:"MultiPolygon",coordinates:ct}}}const Q={type:"Feature",geometry:W,properties:this.properties};return this.id!=null&&(Q.id=this.id),Q}}function Be(h,o,c){h===1?o.id=c.readVarint():h===2?function(g,x){const T=g.readVarint()+g.pos;for(;g.pos<T;){const A=x._keys[g.readVarint()],z=x._values[g.readVarint()];x.properties[A]=z}}(c,o):h===3?o.type=c.readVarint():h===4&&(o._geometry=c.pos)}function oi(h){let o=0;for(let c,g,x=0,T=h.length,A=T-1;x<T;A=x++)c=h[x],g=h[A],o+=(g.x-c.x)*(c.y+g.y);return o}ve.types=["Unknown","Point","LineString","Polygon"];class ge{constructor(o,c){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=o,this._keys=[],this._values=[],this._features=[],o.readFields(ie,this,c),this.length=this._features.length}feature(o){if(o<0||o>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[o];const c=this._pbf.readVarint()+this._pbf.pos;return new ve(this._pbf,c,this.extent,this._keys,this._values)}}function ie(h,o,c){h===15?o.version=c.readVarint():h===1?o.name=c.readString():h===5?o.extent=c.readVarint():h===2?o._features.push(c.pos):h===3?o._keys.push(c.readString()):h===4&&o._values.push(function(g){let x=null;const T=g.readVarint()+g.pos;for(;g.pos<T;){const A=g.readVarint()>>3;x=A===1?g.readString():A===2?g.readFloat():A===3?g.readDouble():A===4?g.readVarint64():A===5?g.readVarint():A===6?g.readSVarint():A===7?g.readBoolean():null}if(x==null)throw new Error("unknown feature value");return x}(c))}class Oe{constructor(o,c){this.layers=o.readFields(Te,{},c)}}function Te(h,o,c){if(h===3){const g=new ge(c,c.readVarint()+c.pos);g.length&&(o[g.name]=g)}}const qe=Math.pow(2,13);function si(h,o,c,g,x,T,A,z){h.emplaceBack(o,c,2*Math.floor(g*qe)+A,x*qe*2,T*qe*2,Math.round(z))}class Li{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.layoutVertexArray=new he,this.centroidVertexArray=new Wt,this.indexArray=new Oi,this.programConfigurations=new dh(o.layers,o.zoom),this.segments=new Zr,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){this.features=[],this.hasDependencies=Np("fill-extrusion",this.layers,c);for(const{feature:x,id:T,index:A,sourceLayerIndex:z}of o){const B=this.layers[0]._featureFilter.needGeometry,G=yc(x,B);if(!this.layers[0]._featureFilter.filter(new wo(this.zoom),G,g))continue;const W={id:T,sourceLayerIndex:z,index:A,geometry:B?G.geometry:Ul(x),properties:x.properties,type:x.type,patterns:{}};this.hasDependencies?this.features.push(Vp("fill-extrusion",this.layers,W,{zoom:this.zoom},c)):this.addFeature(W,W.geometry,A,g,{},c.subdivisionGranularity),c.featureIndex.insert(x,W.geometry,A,z,this.index,!0)}}addFeatures(o,c,g){for(const x of this.features){const{geometry:T}=x;this.addFeature(x,T,x.index,c,g,o.subdivisionGranularity)}}update(o,c,g){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g})}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,Me),this.centroidVertexBuffer=o.createVertexBuffer(this.centroidVertexArray,le.members,!0),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(o,c,g,x,T,A){for(const z of ih(c,500)){const B={x:0,y:0,sampleCount:0},G=this.layoutVertexArray.length;this.processPolygon(B,x,o,z,A);const W=this.layoutVertexArray.length-G,Q=Math.floor(B.x/B.sampleCount),ot=Math.floor(B.y/B.sampleCount);for(let ct=0;ct<W;ct++)this.centroidVertexArray.emplaceBack(Q,ot)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:T,canonical:x})}processPolygon(o,c,g,x,T){if(x.length<1||Fi(x[0]))return;for(const Q of x)Q.length!==0&&ni(o,Q);const A={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},z=T.fill.getGranularityForZoomLevel(c.z),B=ve.types[g.type]==="Polygon";for(const Q of x){if(Q.length===0||Fi(Q))continue;const ot=_t(Q,z,B);this._generateSideFaces(ot,A)}if(!B)return;const G=lt(x,c,z,!1),W=this.layoutVertexArray;vt((Q,ot)=>{si(W,Q,ot,0,0,1,1,0)},this.segments,this.layoutVertexArray,this.indexArray,G.verticesFlattened,G.indicesTriangles)}_generateSideFaces(o,c){let g=0;for(let x=1;x<o.length;x++){const T=o[x],A=o[x-1];if(li(T,A))continue;c.segment.vertexLength+4>Zr.MAX_VERTEX_ARRAY_LENGTH&&(c.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const z=T.sub(A)._perp()._unit(),B=A.dist(T);g+B>32768&&(g=0),si(this.layoutVertexArray,T.x,T.y,z.x,z.y,0,0,g),si(this.layoutVertexArray,T.x,T.y,z.x,z.y,0,1,g),g+=B,si(this.layoutVertexArray,A.x,A.y,z.x,z.y,0,0,g),si(this.layoutVertexArray,A.x,A.y,z.x,z.y,0,1,g);const G=c.segment.vertexLength;this.indexArray.emplaceBack(G,G+2,G+1),this.indexArray.emplaceBack(G+1,G+2,G+3),c.segment.vertexLength+=4,c.segment.primitiveLength+=2}}}function ni(h,o){for(let c=0;c<o.length;c++){const g=o[c];c===o.length-1&&o[0].x===g.x&&o[0].y===g.y||(h.x+=g.x,h.y+=g.y,h.sampleCount++)}}function li(h,o){return h.x===o.x&&(h.x<0||h.x>zn)||h.y===o.y&&(h.y<0||h.y>zn)}function Fi(h){return h.every(o=>o.x<0)||h.every(o=>o.x>zn)||h.every(o=>o.y<0)||h.every(o=>o.y>zn)}let Si;ir("FillExtrusionBucket",Li,{omit:["layers","features"]});var xi={get paint(){return Si=Si||new _s({"fill-extrusion-opacity":new Ir(Jt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Or(Jt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ir(Jt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ir(Jt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Xh(Jt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Or(Jt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Or(Jt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ir(Jt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class Ai extends bl{constructor(o,c){super(o,xi,c)}createBucket(o){return new Li(o)}queryRadius(){return fd(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A,pixelPosMatrix:z}){const B=Fp(o,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-T.bearingInRadians,A),G=this.paint.get("fill-extrusion-height").evaluate(c,g),W=this.paint.get("fill-extrusion-base").evaluate(c,g),Q=function(ct,ut){const xt=[];for(const Et of ct){const Vt=[Et.x,Et.y,0,1];sc(Vt,Vt,ut),xt.push(new Le(Vt[0]/Vt[3],Vt[1]/Vt[3]))}return xt}(B,z),ot=function(ct,ut,xt,Et){const Vt=[],ue=[],Qt=Et[8]*ut,ee=Et[9]*ut,Se=Et[10]*ut,Ee=Et[11]*ut,ei=Et[8]*xt,Ii=Et[9]*xt,fi=Et[10]*xt,zi=Et[11]*xt;for(const Ji of ct){const $i=[],Ui=[];for(const _i of Ji){const kr=_i.x,Ar=_i.y,Nr=Et[0]*kr+Et[4]*Ar+Et[12],yr=Et[1]*kr+Et[5]*Ar+Et[13],Bn=Et[2]*kr+Et[6]*Ar+Et[14],ts=Et[3]*kr+Et[7]*Ar+Et[15],_a=Bn+Se,Ga=ts+Ee,Ac=Nr+ei,Il=yr+Ii,Rs=Bn+fi,$a=ts+zi,Ws=new Le((Nr+Qt)/Ga,(yr+ee)/Ga);Ws.z=_a/Ga,$i.push(Ws);const qa=new Le(Ac/$a,Il/$a);qa.z=Rs/$a,Ui.push(qa)}Vt.push($i),ue.push(Ui)}return[Vt,ue]}(x,W,G,z);return function(ct,ut,xt){let Et=1/0;Au(xt,ut)&&(Et=Gr(xt,ut[0]));for(let Vt=0;Vt<ut.length;Vt++){const ue=ut[Vt],Qt=ct[Vt];for(let ee=0;ee<ue.length-1;ee++){const Se=ue[ee],Ee=[Se,ue[ee+1],Qt[ee+1],Qt[ee],Se];Lp(xt,Ee)&&(Et=Math.min(Et,Gr(xt,Ee)))}}return Et!==1/0&&Et}(ot[0],ot[1],Q)}}function Wi(h,o){return h.x*o.x+h.y*o.y}function Gr(h,o){if(h.length===1){let c=0;const g=o[c++];let x;for(;!x||g.equals(x);)if(x=o[c++],!x)return 1/0;for(;c<o.length;c++){const T=o[c],A=h[0],z=x.sub(g),B=T.sub(g),G=A.sub(g),W=Wi(z,z),Q=Wi(z,B),ot=Wi(B,B),ct=Wi(G,z),ut=Wi(G,B),xt=W*ot-Q*Q,Et=(ot*ct-Q*ut)/xt,Vt=(W*ut-Q*ct)/xt,ue=g.z*(1-Et-Vt)+x.z*Et+T.z*Vt;if(isFinite(ue))return ue}return 1/0}{let c=1/0;for(const g of o)c=Math.min(c,g.z);return c}}const en=Ko([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:kn}=en,ur=Ko([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:Kr}=ur,Pr=Math.cos(Math.PI/180*37.5),Mn=Math.pow(2,14)/.5;class Yr{constructor(o){this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(c=>c.id),this.index=o.index,this.hasDependencies=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(c=>{this.gradients[c.id]={}}),this.layoutVertexArray=new me,this.layoutVertexArray2=new be,this.indexArray=new Oi,this.programConfigurations=new dh(o.layers,o.zoom),this.segments=new Zr,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id)}populate(o,c,g){this.hasDependencies=Np("line",this.layers,c)||this.hasLineDasharray(this.layers);const x=this.layers[0].layout.get("line-sort-key"),T=!x.isConstant(),A=[];for(const{feature:z,id:B,index:G,sourceLayerIndex:W}of o){const Q=this.layers[0]._featureFilter.needGeometry,ot=yc(z,Q);if(!this.layers[0]._featureFilter.filter(new wo(this.zoom),ot,g))continue;const ct=T?x.evaluate(ot,{},g):void 0,ut={id:B,properties:z.properties,type:z.type,sourceLayerIndex:W,index:G,geometry:Q?ot.geometry:Ul(z),patterns:{},dashes:{},sortKey:ct};A.push(ut)}T&&A.sort((z,B)=>z.sortKey-B.sortKey);for(const z of A){const{geometry:B,index:G,sourceLayerIndex:W}=z;this.hasDependencies?(Np("line",this.layers,c)?Vp("line",this.layers,z,{zoom:this.zoom},c):this.hasLineDasharray(this.layers)&&this.addLineDashDependencies(this.layers,z,this.zoom,c),this.patternFeatures.push(z)):this.addFeature(z,B,G,g,{},{},c.subdivisionGranularity),c.featureIndex.insert(o[G].feature,B,G,W,this.index)}}update(o,c,g,x){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(o,c,this.stateDependentLayers,{imagePositions:g,dashPositions:x})}addFeatures(o,c,g,x){for(const T of this.patternFeatures)this.addFeature(T,T.geometry,T.index,c,g,x,o.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(o){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=o.createVertexBuffer(this.layoutVertexArray2,Kr)),this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,kn),this.indexBuffer=o.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(o),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(o){if(o.properties&&Object.prototype.hasOwnProperty.call(o.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(o.properties,"mapbox_clip_end"))return{start:+o.properties.mapbox_clip_start,end:+o.properties.mapbox_clip_end}}addFeature(o,c,g,x,T,A,z){const B=this.layers[0].layout,G=B.get("line-join").evaluate(o,{}),W=B.get("line-cap"),Q=B.get("line-miter-limit"),ot=B.get("line-round-limit");this.lineClips=this.lineFeatureClips(o);for(const ct of c)this.addLine(ct,o,G,W,Q,ot,x,z);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,o,g,{imagePositions:T,dashPositions:A,canonical:x})}addLine(o,c,g,x,T,A,z,B){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,o=_t(o,z?B.line.getGranularityForZoomLevel(z.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Qt=0;Qt<o.length-1;Qt++)this.totalDistance+=o[Qt].dist(o[Qt+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const G=ve.types[c.type]==="Polygon";let W=o.length;for(;W>=2&&o[W-1].equals(o[W-2]);)W--;let Q=0;for(;Q<W-1&&o[Q].equals(o[Q+1]);)Q++;if(W<(G?3:2))return;g==="bevel"&&(T=1.05);const ot=this.overscaling<=16?122880/(512*this.overscaling):0,ct=this.segments.prepareSegment(10*W,this.layoutVertexArray,this.indexArray);let ut,xt,Et,Vt,ue;this.e1=this.e2=-1,G&&(ut=o[W-2],ue=o[Q].sub(ut)._unit()._perp());for(let Qt=Q;Qt<W;Qt++){if(Et=Qt===W-1?G?o[Q+1]:void 0:o[Qt+1],Et&&o[Qt].equals(Et))continue;ue&&(Vt=ue),ut&&(xt=ut),ut=o[Qt],ue=Et?Et.sub(ut)._unit()._perp():Vt,Vt=Vt||ue;let ee=Vt.add(ue);ee.x===0&&ee.y===0||ee._unit();const Se=Vt.x*ue.x+Vt.y*ue.y,Ee=ee.x*ue.x+ee.y*ue.y,ei=Ee!==0?1/Ee:1/0,Ii=2*Math.sqrt(2-2*Ee),fi=Ee<Pr&&xt&&Et,zi=Vt.x*ue.y-Vt.y*ue.x>0;if(fi&&Qt>Q){const Ui=ut.dist(xt);if(Ui>2*ot){const _i=ut.sub(ut.sub(xt)._mult(ot/Ui)._round());this.updateDistance(xt,_i),this.addCurrentVertex(_i,Vt,0,0,ct),xt=_i}}const Ji=xt&&Et;let $i=Ji?g:G?"butt":x;if(Ji&&$i==="round"&&(ei<A?$i="miter":ei<=2&&($i="fakeround")),$i==="miter"&&ei>T&&($i="bevel"),$i==="bevel"&&(ei>2&&($i="flipbevel"),ei<T&&($i="miter")),xt&&this.updateDistance(xt,ut),$i==="miter")ee._mult(ei),this.addCurrentVertex(ut,ee,0,0,ct);else if($i==="flipbevel"){if(ei>100)ee=ue.mult(-1);else{const Ui=ei*Vt.add(ue).mag()/Vt.sub(ue).mag();ee._perp()._mult(Ui*(zi?-1:1))}this.addCurrentVertex(ut,ee,0,0,ct),this.addCurrentVertex(ut,ee.mult(-1),0,0,ct)}else if($i==="bevel"||$i==="fakeround"){const Ui=-Math.sqrt(ei*ei-1),_i=zi?Ui:0,kr=zi?0:Ui;if(xt&&this.addCurrentVertex(ut,Vt,_i,kr,ct),$i==="fakeround"){const Ar=Math.round(180*Ii/Math.PI/20);for(let Nr=1;Nr<Ar;Nr++){let yr=Nr/Ar;if(yr!==.5){const ts=yr-.5;yr+=yr*ts*(yr-1)*((1.0904+Se*(Se*(3.55645-1.43519*Se)-3.2452))*ts*ts+(.848013+Se*(.215638*Se-1.06021)))}const Bn=ue.sub(Vt)._mult(yr)._add(Vt)._unit()._mult(zi?-1:1);this.addHalfVertex(ut,Bn.x,Bn.y,!1,zi,0,ct)}}Et&&this.addCurrentVertex(ut,ue,-_i,-kr,ct)}else if($i==="butt")this.addCurrentVertex(ut,ee,0,0,ct);else if($i==="square"){const Ui=xt?1:-1;this.addCurrentVertex(ut,ee,Ui,Ui,ct)}else $i==="round"&&(xt&&(this.addCurrentVertex(ut,Vt,0,0,ct),this.addCurrentVertex(ut,Vt,1,1,ct,!0)),Et&&(this.addCurrentVertex(ut,ue,-1,-1,ct,!0),this.addCurrentVertex(ut,ue,0,0,ct)));if(fi&&Qt<W-1){const Ui=ut.dist(Et);if(Ui>2*ot){const _i=ut.add(Et.sub(ut)._mult(ot/Ui)._round());this.updateDistance(ut,_i),this.addCurrentVertex(_i,ue,0,0,ct),ut=_i}}}}addCurrentVertex(o,c,g,x,T,A=!1){const z=c.y*x-c.x,B=-c.y-c.x*x;this.addHalfVertex(o,c.x+c.y*g,c.y-c.x*g,A,!1,g,T),this.addHalfVertex(o,z,B,A,!0,-x,T),this.distance>Mn/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(o,c,g,x,T,A))}addHalfVertex({x:o,y:c},g,x,T,A,z,B){const G=.5*(this.lineClips?this.scaledDistance*(Mn-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((o<<1)+(T?1:0),(c<<1)+(A?1:0),Math.round(63*g)+128,Math.round(63*x)+128,1+(z===0?0:z<0?-1:1)|(63&G)<<2,G>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const W=B.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,W,this.e2),B.primitiveLength++),A?this.e2=W:this.e1=W}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(o,c){this.distance+=o.dist(c),this.updateScaledDistance()}hasLineDasharray(o){for(const c of o){const g=c.paint.get("line-dasharray");if(g&&!g.isConstant())return!0}return!1}addLineDashDependencies(o,c,g,x){for(const T of o){const A=T.paint.get("line-dasharray");if(!A||A.value.kind==="constant")continue;const z=T.layout.get("line-cap")==="round",B={dasharray:A.value.evaluate({zoom:g-1},c,{}),round:z},G={dasharray:A.value.evaluate({zoom:g},c,{}),round:z},W={dasharray:A.value.evaluate({zoom:g+1},c,{}),round:z},Q=`${B.dasharray.join(",")},${B.round}`,ot=`${G.dasharray.join(",")},${G.round}`,ct=`${W.dasharray.join(",")},${W.round}`;x.dashDependencies[Q]=B,x.dashDependencies[ot]=G,x.dashDependencies[ct]=W,c.dashes[T.id]={min:Q,mid:ot,max:ct}}}}let Zn,an;ir("LineBucket",Yr,{omit:["layers","patternFeatures"]});var Mr={get paint(){return an=an||new _s({"line-opacity":new Or(Jt.paint_line["line-opacity"]),"line-color":new Or(Jt.paint_line["line-color"]),"line-translate":new Ir(Jt.paint_line["line-translate"]),"line-translate-anchor":new Ir(Jt.paint_line["line-translate-anchor"]),"line-width":new Or(Jt.paint_line["line-width"]),"line-gap-width":new Or(Jt.paint_line["line-gap-width"]),"line-offset":new Or(Jt.paint_line["line-offset"]),"line-blur":new Or(Jt.paint_line["line-blur"]),"line-dasharray":new Xh(Jt.paint_line["line-dasharray"]),"line-pattern":new Xh(Jt.paint_line["line-pattern"]),"line-gradient":new hh(Jt.paint_line["line-gradient"])})},get layout(){return Zn=Zn||new _s({"line-cap":new Ir(Jt.layout_line["line-cap"]),"line-join":new Or(Jt.layout_line["line-join"]),"line-miter-limit":new Ir(Jt.layout_line["line-miter-limit"]),"line-round-limit":new Ir(Jt.layout_line["line-round-limit"]),"line-sort-key":new Or(Jt.layout_line["line-sort-key"])})}};class _n extends Or{possiblyEvaluate(o,c){return c=new wo(Math.floor(c.zoom),{now:c.now,fadeDuration:c.fadeDuration,zoomHistory:c.zoomHistory,transition:c.transition}),super.possiblyEvaluate(o,c)}evaluate(o,c,g,x){return c=qr({},c,{zoom:Math.floor(c.zoom)}),super.evaluate(o,c,g,x)}}let Lr;class fo extends bl{constructor(o,c){super(o,Mr,c),this.gradientVersion=0,Lr||(Lr=new _n(Mr.paint.properties["line-width"].specification),Lr.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(o){if(o==="line-gradient"){const c=this.gradientExpression();this.stepInterpolant=!!function(g){return g._styleExpression!==void 0}(c)&&c._styleExpression.expression instanceof Ph,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(o,c){super.recalculate(o,c),this.paint._values["line-floorwidth"]=Lr.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,o)}createBucket(o){return new Yr(o)}queryRadius(o){const c=o,g=yn(Pu("line-width",this,c),Pu("line-gap-width",this,c)),x=Pu("line-offset",this,c);return g/2+Math.abs(x)+fd(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:o,feature:c,featureState:g,geometry:x,transform:T,pixelsToTileUnits:A}){const z=Fp(o,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-T.bearingInRadians,A),B=A/2*yn(this.paint.get("line-width").evaluate(c,g),this.paint.get("line-gap-width").evaluate(c,g)),G=this.paint.get("line-offset").evaluate(c,g);return G&&(x=function(W,Q){const ot=[];for(let ct=0;ct<W.length;ct++){const ut=W[ct],xt=[];for(let Et=0;Et<ut.length;Et++){const Vt=ut[Et-1],ue=ut[Et],Qt=ut[Et+1],ee=Et===0?new Le(0,0):ue.sub(Vt)._unit()._perp(),Se=Et===ut.length-1?new Le(0,0):Qt.sub(ue)._unit()._perp(),Ee=ee._add(Se)._unit(),ei=Ee.x*Se.x+Ee.y*Se.y;ei!==0&&Ee._mult(1/ei),xt.push(Ee._mult(Q)._add(ue))}ot.push(xt)}return ot}(x,G*A)),function(W,Q,ot){for(let ct=0;ct<Q.length;ct++){const ut=Q[ct];if(W.length>=3){for(let xt=0;xt<ut.length;xt++)if(pd(W,ut[xt]))return!0}if(Dm(W,ut,ot))return!0}return!1}(z,x,B)}isTileClipped(){return!0}}function yn(h,o){return o>0?o+2*h:h}const mr=Ko([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),nn=Ko([{name:"a_projected_pos",components:3,type:"Float32"}],4);Ko([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const So=Ko([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);Ko([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Yo=Ko([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Ro=Ko([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function jo(h,o,c){return h.sections.forEach(g=>{g.text=function(x,T,A){const z=T.layout.get("text-transform").evaluate(A,{});return z==="uppercase"?x=x.toLocaleUpperCase():z==="lowercase"&&(x=x.toLocaleLowerCase()),jc.applyArabicShaping&&(x=jc.applyArabicShaping(x)),x}(g.text,o,c)}),h}Ko([{name:"triangle",components:3,type:"Uint16"}]),Ko([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Ko([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Ko([{type:"Float32",name:"offsetX"}]),Ko([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Ko([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);var Io=24;const fa={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""},Pa={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},Va={40:!0};function ic(h,o,c,g,x,T){if("fontStack"in o){const A=c[o.fontStack],z=A&&A[h];return z?z.metrics.advance*o.scale+x:0}{const A=g[o.imageName];return A?A.displaySize[0]*o.scale*Io/T+x:0}}function ma(h,o,c,g){const x=Math.pow(h-o,2);return g?h<o?x/2:2*x:x+Math.abs(c)*c}function vc(h,o,c){let g=0;return h===10&&(g-=1e4),c&&(g+=150),h!==40&&h!==65288||(g+=50),o!==41&&o!==65289||(g+=50),g}function bc(h,o,c,g,x,T){let A=null,z=ma(o,c,x,T);for(const B of g){const G=ma(o-B.x,c,x,T)+B.badness;G<=z&&(A=B,z=G)}return{index:h,x:o,priorBreak:A,badness:z}}function qs(h){return h?qs(h.priorBreak).concat(h.index):[]}class mo{constructor(o="",c=[],g=[]){this.text=o,this.sections=c,this.sectionIndex=g,this.imageSectionID=null}static fromFeature(o,c){const g=new mo;for(let x=0;x<o.sections.length;x++){const T=o.sections[x];T.image?g.addImageSection(T):g.addTextSection(T,c)}return g}length(){return[...this.text].length}getSection(o){return this.sections[this.sectionIndex[o]]}getSectionIndex(o){return this.sectionIndex[o]}verticalizePunctuation(){this.text=function(o){let c="",g={premature:!0,value:void 0};const x=o[Symbol.iterator]();let T=x.next();const A=o[Symbol.iterator]();A.next();let z=A.next();for(;!T.done;)c+=!z.done&&fc(z.value.codePointAt(0))&&!fa[z.value]||!g.premature&&fc(g.value.codePointAt(0))&&!fa[g.value]||!fa[T.value]?T.value:fa[T.value],g={value:T.value,premature:!1},T=x.next(),z=A.next();return c}(this.text)}hasZeroWidthSpaces(){return this.text.includes("")}trim(){const o=this.text.match(/^\s*/),c=o?o[0].length:0,g=this.text.match(/\S\s*$/),x=g?g[0].length-1:0;this.text=this.text.substring(c,this.text.length-x),this.sectionIndex=this.sectionIndex.slice(c,this.sectionIndex.length-x)}substring(o,c){const g=[...this.text].slice(o,c).join(""),x=this.sectionIndex.slice(o,c);return new mo(g,this.sections,x)}toCodeUnitIndex(o){return[...this.text].slice(0,o).join("").length}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((o,c)=>Math.max(o,this.sections[c].scale),0)}getMaxImageSize(o){let c=0,g=0;for(let x=0;x<this.length();x++){const T=this.getSection(x);if("imageName"in T){const A=o[T.imageName];if(!A)continue;const z=A.displaySize;c=Math.max(c,z[0]),g=Math.max(g,z[1])}}return{maxImageWidth:c,maxImageHeight:g}}addTextSection(o,c){this.text+=o.text,this.sections.push({scale:o.scale||1,verticalAlign:o.verticalAlign||"bottom",fontStack:o.fontStack||c});const g=this.sections.length-1;this.sectionIndex.push(...[...o.text].map(()=>g))}addImageSection(o){const c=o.image?o.image.name:"";if(c.length===0)return void ho("Can't add FormattedSection with an empty image.");const g=this.getNextImageSectionCharCode();g?(this.text+=String.fromCharCode(g),this.sections.push({scale:1,verticalAlign:o.verticalAlign||"bottom",imageName:c}),this.sectionIndex.push(this.sections.length-1)):ho("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}determineLineBreaks(o,c,g,x,T){const A=[],z=this.determineAverageLineWidth(o,c,g,x,T),B=this.hasZeroWidthSpaces();let G=0,W=0;const Q=this.text[Symbol.iterator]();let ot=Q.next();const ct=this.text[Symbol.iterator]();ct.next();let ut=ct.next();const xt=this.text[Symbol.iterator]();xt.next(),xt.next();let Et=xt.next();for(;!ot.done;){const Vt=this.getSection(W),ue=ot.value.codePointAt(0);if(_f(ue)||(G+=ic(ue,Vt,g,x,o,T)),!ut.done){const Qt=gf(ue),ee=ut.value.codePointAt(0);(Pa[ue]||Qt||"imageName"in Vt||!Et.done&&Va[ee])&&A.push(bc(W+1,G,z,A,vc(ue,ee,Qt&&B),!1))}W++,ot=Q.next(),ut=ct.next(),Et=xt.next()}return qs(bc(this.length(),G,z,A,0,!0))}determineAverageLineWidth(o,c,g,x,T){let A=0,z=0;for(const B of this.text){const G=this.getSection(z);A+=ic(B.codePointAt(0),G,g,x,o,T),z++}return A/Math.max(1,Math.ceil(A/c))}}const Go=4294967296,jn=1/Go,Qo=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");class Ls{constructor(o=new Uint8Array(16)){this.buf=ArrayBuffer.isView(o)?o:new Uint8Array(o),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(o,c,g=this.length){for(;this.pos<g;){const x=this.readVarint(),T=x>>3,A=this.pos;this.type=7&x,o(T,c,this),this.pos===A&&this.skip(x)}return c}readMessage(o,c){return this.readFields(o,c,this.readVarint()+this.pos)}readFixed32(){const o=this.dataView.getUint32(this.pos,!0);return this.pos+=4,o}readSFixed32(){const o=this.dataView.getInt32(this.pos,!0);return this.pos+=4,o}readFixed64(){const o=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Go;return this.pos+=8,o}readSFixed64(){const o=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Go;return this.pos+=8,o}readFloat(){const o=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,o}readDouble(){const o=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,o}readVarint(o){const c=this.buf;let g,x;return x=c[this.pos++],g=127&x,x<128?g:(x=c[this.pos++],g|=(127&x)<<7,x<128?g:(x=c[this.pos++],g|=(127&x)<<14,x<128?g:(x=c[this.pos++],g|=(127&x)<<21,x<128?g:(x=c[this.pos],g|=(15&x)<<28,function(T,A,z){const B=z.buf;let G,W;if(W=B[z.pos++],G=(112&W)>>4,W<128||(W=B[z.pos++],G|=(127&W)<<3,W<128)||(W=B[z.pos++],G|=(127&W)<<10,W<128)||(W=B[z.pos++],G|=(127&W)<<17,W<128)||(W=B[z.pos++],G|=(127&W)<<24,W<128)||(W=B[z.pos++],G|=(1&W)<<31,W<128))return go(T,G,A);throw new Error("Expected varint not more than 10 bytes")}(g,o,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const o=this.readVarint();return o%2==1?(o+1)/-2:o/2}readBoolean(){return!!this.readVarint()}readString(){const o=this.readVarint()+this.pos,c=this.pos;return this.pos=o,o-c>=12&&Qo?Qo.decode(this.buf.subarray(c,o)):function(g,x,T){let A="",z=x;for(;z<T;){const B=g[z];let G,W,Q,ot=null,ct=B>239?4:B>223?3:B>191?2:1;if(z+ct>T)break;ct===1?B<128&&(ot=B):ct===2?(G=g[z+1],(192&G)==128&&(ot=(31&B)<<6|63&G,ot<=127&&(ot=null))):ct===3?(G=g[z+1],W=g[z+2],(192&G)==128&&(192&W)==128&&(ot=(15&B)<<12|(63&G)<<6|63&W,(ot<=2047||ot>=55296&&ot<=57343)&&(ot=null))):ct===4&&(G=g[z+1],W=g[z+2],Q=g[z+3],(192&G)==128&&(192&W)==128&&(192&Q)==128&&(ot=(15&B)<<18|(63&G)<<12|(63&W)<<6|63&Q,(ot<=65535||ot>=1114112)&&(ot=null))),ot===null?(ot=65533,ct=1):ot>65535&&(ot-=65536,A+=String.fromCharCode(ot>>>10&1023|55296),ot=56320|1023&ot),A+=String.fromCharCode(ot),z+=ct}return A}(this.buf,c,o)}readBytes(){const o=this.readVarint()+this.pos,c=this.buf.subarray(this.pos,o);return this.pos=o,c}readPackedVarint(o=[],c){const g=this.readPackedEnd();for(;this.pos<g;)o.push(this.readVarint(c));return o}readPackedSVarint(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readSVarint());return o}readPackedBoolean(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readBoolean());return o}readPackedFloat(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readFloat());return o}readPackedDouble(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readDouble());return o}readPackedFixed32(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readFixed32());return o}readPackedSFixed32(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readSFixed32());return o}readPackedFixed64(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readFixed64());return o}readPackedSFixed64(o=[]){const c=this.readPackedEnd();for(;this.pos<c;)o.push(this.readSFixed64());return o}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(o){const c=7&o;if(c===0)for(;this.buf[this.pos++]>127;);else if(c===2)this.pos=this.readVarint()+this.pos;else if(c===5)this.pos+=4;else{if(c!==1)throw new Error(`Unimplemented type: ${c}`);this.pos+=8}}writeTag(o,c){this.writeVarint(o<<3|c)}realloc(o){let c=this.length||16;for(;c<this.pos+o;)c*=2;if(c!==this.length){const g=new Uint8Array(c);g.set(this.buf),this.buf=g,this.dataView=new DataView(g.buffer),this.length=c}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(o){this.realloc(4),this.dataView.setInt32(this.pos,o,!0),this.pos+=4}writeSFixed32(o){this.realloc(4),this.dataView.setInt32(this.pos,o,!0),this.pos+=4}writeFixed64(o){this.realloc(8),this.dataView.setInt32(this.pos,-1&o,!0),this.dataView.setInt32(this.pos+4,Math.floor(o*jn),!0),this.pos+=8}writeSFixed64(o){this.realloc(8),this.dataView.setInt32(this.pos,-1&o,!0),this.dataView.setInt32(this.pos+4,Math.floor(o*jn),!0),this.pos+=8}writeVarint(o){(o=+o||0)>268435455||o<0?function(c,g){let x,T;if(c>=0?(x=c%4294967296|0,T=c/4294967296|0):(x=~(-c%4294967296),T=~(-c/4294967296),4294967295^x?x=x+1|0:(x=0,T=T+1|0)),c>=18446744073709552e3||c<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");g.realloc(10),function(A,z,B){B.buf[B.pos++]=127&A|128,A>>>=7,B.buf[B.pos++]=127&A|128,A>>>=7,B.buf[B.pos++]=127&A|128,A>>>=7,B.buf[B.pos++]=127&A|128,B.buf[B.pos]=127&(A>>>=7)}(x,0,g),function(A,z){const B=(7&A)<<4;z.buf[z.pos++]|=B|((A>>>=3)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A|((A>>>=7)?128:0),A&&(z.buf[z.pos++]=127&A)))))}(T,g)}(o,this):(this.realloc(4),this.buf[this.pos++]=127&o|(o>127?128:0),o<=127||(this.buf[this.pos++]=127&(o>>>=7)|(o>127?128:0),o<=127||(this.buf[this.pos++]=127&(o>>>=7)|(o>127?128:0),o<=127||(this.buf[this.pos++]=o>>>7&127))))}writeSVarint(o){this.writeVarint(o<0?2*-o-1:2*o)}writeBoolean(o){this.writeVarint(+o)}writeString(o){o=String(o),this.realloc(4*o.length),this.pos++;const c=this.pos;this.pos=function(x,T,A){for(let z,B,G=0;G<T.length;G++){if(z=T.charCodeAt(G),z>55295&&z<57344){if(!B){z>56319||G+1===T.length?(x[A++]=239,x[A++]=191,x[A++]=189):B=z;continue}if(z<56320){x[A++]=239,x[A++]=191,x[A++]=189,B=z;continue}z=B-55296<<10|z-56320|65536,B=null}else B&&(x[A++]=239,x[A++]=191,x[A++]=189,B=null);z<128?x[A++]=z:(z<2048?x[A++]=z>>6|192:(z<65536?x[A++]=z>>12|224:(x[A++]=z>>18|240,x[A++]=z>>12&63|128),x[A++]=z>>6&63|128),x[A++]=63&z|128)}return A}(this.buf,o,this.pos);const g=this.pos-c;g>=128&&rc(c,g,this),this.pos=c-1,this.writeVarint(g),this.pos+=g}writeFloat(o){this.realloc(4),this.dataView.setFloat32(this.pos,o,!0),this.pos+=4}writeDouble(o){this.realloc(8),this.dataView.setFloat64(this.pos,o,!0),this.pos+=8}writeBytes(o){const c=o.length;this.writeVarint(c),this.realloc(c);for(let g=0;g<c;g++)this.buf[this.pos++]=o[g]}writeRawMessage(o,c){this.pos++;const g=this.pos;o(c,this);const x=this.pos-g;x>=128&&rc(g,x,this),this.pos=g-1,this.writeVarint(x),this.pos+=x}writeMessage(o,c,g){this.writeTag(o,2),this.writeRawMessage(c,g)}writePackedVarint(o,c){c.length&&this.writeMessage(o,Up,c)}writePackedSVarint(o,c){c.length&&this.writeMessage(o,Du,c)}writePackedBoolean(o,c){c.length&&this.writeMessage(o,wc,c)}writePackedFloat(o,c){c.length&&this.writeMessage(o,jp,c)}writePackedDouble(o,c){c.length&&this.writeMessage(o,Gp,c)}writePackedFixed32(o,c){c.length&&this.writeMessage(o,eu,c)}writePackedSFixed32(o,c){c.length&&this.writeMessage(o,Zs,c)}writePackedFixed64(o,c){c.length&&this.writeMessage(o,Tc,c)}writePackedSFixed64(o,c){c.length&&this.writeMessage(o,Xd,c)}writeBytesField(o,c){this.writeTag(o,2),this.writeBytes(c)}writeFixed32Field(o,c){this.writeTag(o,5),this.writeFixed32(c)}writeSFixed32Field(o,c){this.writeTag(o,5),this.writeSFixed32(c)}writeFixed64Field(o,c){this.writeTag(o,1),this.writeFixed64(c)}writeSFixed64Field(o,c){this.writeTag(o,1),this.writeSFixed64(c)}writeVarintField(o,c){this.writeTag(o,0),this.writeVarint(c)}writeSVarintField(o,c){this.writeTag(o,0),this.writeSVarint(c)}writeStringField(o,c){this.writeTag(o,2),this.writeString(c)}writeFloatField(o,c){this.writeTag(o,5),this.writeFloat(c)}writeDoubleField(o,c){this.writeTag(o,1),this.writeDouble(c)}writeBooleanField(o,c){this.writeVarintField(o,+c)}}function go(h,o,c){return c?4294967296*o+(h>>>0):4294967296*(o>>>0)+(h>>>0)}function rc(h,o,c){const g=o<=16383?1:o<=2097151?2:o<=268435455?3:Math.floor(Math.log(o)/(7*Math.LN2));c.realloc(g);for(let x=c.pos-1;x>=h;x--)c.buf[x+g]=c.buf[x]}function Up(h,o){for(let c=0;c<h.length;c++)o.writeVarint(h[c])}function Du(h,o){for(let c=0;c<h.length;c++)o.writeSVarint(h[c])}function jp(h,o){for(let c=0;c<h.length;c++)o.writeFloat(h[c])}function Gp(h,o){for(let c=0;c<h.length;c++)o.writeDouble(h[c])}function wc(h,o){for(let c=0;c<h.length;c++)o.writeBoolean(h[c])}function eu(h,o){for(let c=0;c<h.length;c++)o.writeFixed32(h[c])}function Zs(h,o){for(let c=0;c<h.length;c++)o.writeSFixed32(h[c])}function Tc(h,o){for(let c=0;c<h.length;c++)o.writeFixed64(h[c])}function Xd(h,o){for(let c=0;c<h.length;c++)o.writeSFixed64(h[c])}function Sg(h,o,c){h===1&&c.readMessage(rm,o)}function rm(h,o,c){if(h===3){const{id:g,bitmap:x,width:T,height:A,left:z,top:B,advance:G}=c.readMessage(rx,{});o.push({id:g,bitmap:new Mu({width:T+6,height:A+6},x),metrics:{width:T,height:A,left:z,top:B,advance:G}})}}function rx(h,o,c){h===1?o.id=c.readVarint():h===2?o.bitmap=c.readBytes():h===3?o.width=c.readVarint():h===4?o.height=c.readVarint():h===5?o.left=c.readSVarint():h===6?o.top=c.readSVarint():h===7&&(o.advance=c.readVarint())}function b_(h){let o=0,c=0;for(const A of h)o+=A.w*A.h,c=Math.max(c,A.w);h.sort((A,z)=>z.h-A.h);const g=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(o/.95)),c),h:1/0}];let x=0,T=0;for(const A of h)for(let z=g.length-1;z>=0;z--){const B=g[z];if(!(A.w>B.w||A.h>B.h)){if(A.x=B.x,A.y=B.y,T=Math.max(T,A.y+A.h),x=Math.max(x,A.x+A.w),A.w===B.w&&A.h===B.h){const G=g.pop();G&&z<g.length&&(g[z]=G)}else A.h===B.h?(B.x+=A.w,B.w-=A.w):A.w===B.w?(B.y+=A.h,B.h-=A.h):(g.push({x:B.x+A.w,y:B.y,w:B.w-A.w,h:A.h}),B.y+=A.h,B.h-=A.h);break}}return{w:x,h:T,fill:o/(x*T)||0}}class nm{constructor(o,{pixelRatio:c,version:g,stretchX:x,stretchY:T,content:A,textFitWidth:z,textFitHeight:B}){this.paddedRect=o,this.pixelRatio=c,this.stretchX=x,this.stretchY=T,this.content=A,this.version=g,this.textFitWidth=z,this.textFitHeight=B}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Ly{constructor(o,c){const g={},x={};this.haveRenderCallbacks=[];const T=[];this.addImages(o,g,T),this.addImages(c,x,T);const{w:A,h:z}=b_(T),B=new Aa({width:A||1,height:z||1});for(const G in o){const W=o[G],Q=g[G].paddedRect;Aa.copy(W.data,B,{x:0,y:0},{x:Q.x+1,y:Q.y+1},W.data)}for(const G in c){const W=c[G],Q=x[G].paddedRect,ot=Q.x+1,ct=Q.y+1,ut=W.data.width,xt=W.data.height;Aa.copy(W.data,B,{x:0,y:0},{x:ot,y:ct},W.data),Aa.copy(W.data,B,{x:0,y:xt-1},{x:ot,y:ct-1},{width:ut,height:1}),Aa.copy(W.data,B,{x:0,y:0},{x:ot,y:ct+xt},{width:ut,height:1}),Aa.copy(W.data,B,{x:ut-1,y:0},{x:ot-1,y:ct},{width:1,height:xt}),Aa.copy(W.data,B,{x:0,y:0},{x:ot+ut,y:ct},{width:1,height:xt})}this.image=B,this.iconPositions=g,this.patternPositions=x}addImages(o,c,g){for(const x in o){const T=o[x],A={x:0,y:0,w:T.data.width+2,h:T.data.height+2};g.push(A),c[x]=new nm(A,T),T.hasRenderCallback&&this.haveRenderCallbacks.push(x)}}patchUpdatedImages(o,c){o.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const g in o.updatedImages)this.patchUpdatedImage(this.iconPositions[g],o.getImage(g),c),this.patchUpdatedImage(this.patternPositions[g],o.getImage(g),c)}patchUpdatedImage(o,c,g){if(!o||!c||o.version===c.version)return;o.version=c.version;const[x,T]=o.tl;g.update(c.data,void 0,{x,y:T})}}var Yd;function Ig(h,o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut){const xt=mo.fromFeature(h,x);let Et;Q===nt.ay.vertical&&xt.verticalizePunctuation();let Vt=xt.determineLineBreaks(G,T,o,g,ct);const{processBidirectionalText:ue,processStyledBidirectionalText:Qt}=jc;if(ue&&xt.sections.length===1){Et=[],Vt=Vt.map(ei=>xt.toCodeUnitIndex(ei));const Ee=ue(xt.toString(),Vt);for(const ei of Ee){const Ii=[...ei].map(()=>0);Et.push(new mo(ei,xt.sections,Ii))}}else if(Qt){Et=[],Vt=Vt.map(fi=>xt.toCodeUnitIndex(fi));let Ee=0;const ei=[];for(const fi of xt.text)ei.push(...Array(fi.length).fill(xt.sectionIndex[Ee])),Ee++;const Ii=Qt(xt.text,ei,Vt);for(const fi of Ii){const zi=[];let Ji="";for(const $i of fi[0])zi.push(fi[1][Ji.length]),Ji+=$i;Et.push(new mo(fi[0],xt.sections,zi))}}else Et=function(Ee,ei){const Ii=[];let fi=0;for(const zi of ei)Ii.push(Ee.substring(fi,zi)),fi=zi;return fi<Ee.length()&&Ii.push(Ee.substring(fi,Ee.length())),Ii}(xt,Vt);const ee=[],Se={positionedLines:ee,text:xt.toString(),top:W[1],bottom:W[1],left:W[0],right:W[0],writingMode:Q,iconsInText:!1,verticalizable:!1};return function(Ee,ei,Ii,fi,zi,Ji,$i,Ui,_i,kr,Ar,Nr){let yr=0,Bn=0,ts=0,_a=0;const Ga=Ui==="right"?1:Ui==="left"?0:.5,Ac=Io/Nr;let Il=0;for(const Ws of zi){Ws.trim();const qa=Ws.getMaxScale(),jl={positionedGlyphs:[],lineOffset:0};Ee.positionedLines[Il]=jl;const Gl=jl.positionedGlyphs;let Pc=0;if(!Ws.length()){Bn+=Ji,++Il;continue}const Za=md(fi,Ws,Ac);let Mc=0;for(const Ha of Ws.text){const xs=Ws.getSection(Mc),ya=Ha.codePointAt(0),ks=Ry(_i,Ar,ya),Ca={glyph:ya,imageName:null,x:yr,y:Bn+-17,vertical:ks,scale:1,fontStack:"",sectionIndex:Ws.getSectionIndex(Mc),metrics:null,rect:null};let rp;if("fontStack"in xs){if(rp=ky(xs,ya,ks,Za,ei,Ii),!rp)continue;Ca.fontStack=xs.fontStack}else{if(Ee.iconsInText=!0,xs.scale*=Ac,rp=Eg(xs,ks,qa,Za,fi),!rp)continue;Pc=Math.max(Pc,rp.imageOffset),Ca.imageName=xs.imageName}const{rect:Lu,metrics:sg,baselineOffset:Qp}=rp;Ca.y+=Qp,Ca.scale=xs.scale,Ca.metrics=sg,Ca.rect=Lu,Gl.push(Ca),ks?(Ee.verticalizable=!0,yr+=("imageName"in xs?sg.advance:Io)*xs.scale+kr):yr+=sg.advance*xs.scale+kr,Mc++}Gl.length!==0&&(ts=Math.max(yr-kr,ts),w_(Gl,0,Gl.length-1,Ga)),yr=0,jl.lineOffset=Math.max(Pc,(qa-1)*Io);const xh=Ji*qa+Pc;Bn+=xh,_a=Math.max(xh,_a),++Il}const{horizontalAlign:Rs,verticalAlign:$a}=jm($i);(function(Ws,qa,jl,Gl,Pc,Za,Mc,xh,Ha){const xs=(qa-jl)*Pc;let ya=0;ya=Za!==Mc?-xh*Gl- -17:-Gl*Ha*Mc+.5*Mc;for(const ks of Ws)for(const Ca of ks.positionedGlyphs)Ca.x+=xs,Ca.y+=ya})(Ee.positionedLines,Ga,Rs,$a,ts,_a,Ji,Bn,zi.length),Ee.top+=-$a*Bn,Ee.bottom=Ee.top+Bn,Ee.left+=-Rs*ts,Ee.right=Ee.left+ts}(Se,o,c,g,Et,A,z,B,Q,G,ot,ut),!function(Ee){for(const ei of Ee)if(ei.positionedGlyphs.length!==0)return!1;return!0}(ee)&&Se}function jm(h){let o=.5,c=.5;switch(h){case"right":case"top-right":case"bottom-right":o=1;break;case"left":case"top-left":case"bottom-left":o=0}switch(h){case"bottom":case"bottom-right":case"bottom-left":c=1;break;case"top":case"top-right":case"top-left":c=0}return{horizontalAlign:o,verticalAlign:c}}function md(h,o,c){const g=o.getMaxScale()*Io,{maxImageWidth:x,maxImageHeight:T}=o.getMaxImageSize(h),A=Math.max(g,T*c);return{verticalLineContentWidth:Math.max(g,x*c),horizontalLineContentHeight:A}}function gd(h){switch(h){case"top":return 0;case"center":return .5;default:return 1}}function Ry(h,o,c){return!(h===nt.ay.horizontal||!o&&!qh(c)||o&&(_f(c)||(g=c,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(g)))));var g}function ky(h,o,c,g,x,T){const A=T[h.fontStack],z=function(G,W,Q,ot){if(G&&G.rect)return G;const ct=W[Q.fontStack],ut=ct&&ct[ot];return ut?{rect:null,metrics:ut.metrics}:null}(A&&A[o],x,h,o);if(z===null)return null;let B;if(c)B=g.verticalLineContentWidth-h.scale*Io;else{const G=gd(h.verticalAlign);B=(g.horizontalLineContentHeight-h.scale*Io)*G}return{rect:z.rect,metrics:z.metrics,baselineOffset:B}}function Eg(h,o,c,g,x){const T=x[h.imageName];if(!T)return null;const A=T.paddedRect,z=T.displaySize,B={width:z[0],height:z[1],left:1,top:-3,advance:o?z[1]:z[0]};let G;if(o)G=g.verticalLineContentWidth-z[1]*h.scale;else{const W=gd(h.verticalAlign);G=(g.horizontalLineContentHeight-z[1]*h.scale)*W}return{rect:A,metrics:B,baselineOffset:G,imageOffset:(o?z[0]:z[1])*h.scale-Io*c}}function w_(h,o,c,g){if(g===0)return;const x=h[c],T=(h[c].x+x.metrics.advance*x.scale)*g;for(let A=o;A<=c;A++)h[A].x-=T}function Gm(h,o,c){const{horizontalAlign:g,verticalAlign:x}=jm(c),T=o[0]-h.displaySize[0]*g,A=o[1]-h.displaySize[1]*x;return{image:h,top:A,bottom:A+h.displaySize[1],left:T,right:T+h.displaySize[0]}}function $m(h){var o,c;let g=h.left,x=h.top,T=h.right-g,A=h.bottom-x;const z=(o=h.image.textFitWidth)!==null&&o!==void 0?o:"stretchOrShrink",B=(c=h.image.textFitHeight)!==null&&c!==void 0?c:"stretchOrShrink",G=(h.image.content[2]-h.image.content[0])/(h.image.content[3]-h.image.content[1]);if(B==="proportional"){if(z==="stretchOnly"&&T/A<G||z==="proportional"){const W=Math.ceil(A*G);g*=W/T,T=W}}else if(z==="proportional"&&B==="stretchOnly"&&G!==0&&T/A>G){const W=Math.ceil(T/G);x*=W/A,A=W}return{x1:g,y1:x,x2:g+T,y2:x+A}}function T_(h,o,c,g,x,T){const A=h.image;let z;if(A.content){const Et=A.content,Vt=A.pixelRatio||1;z=[Et[0]/Vt,Et[1]/Vt,A.displaySize[0]-Et[2]/Vt,A.displaySize[1]-Et[3]/Vt]}const B=o.left*T,G=o.right*T;let W,Q,ot,ct;c==="width"||c==="both"?(ct=x[0]+B-g[3],Q=x[0]+G+g[1]):(ct=x[0]+(B+G-A.displaySize[0])/2,Q=ct+A.displaySize[0]);const ut=o.top*T,xt=o.bottom*T;return c==="height"||c==="both"?(W=x[1]+ut-g[0],ot=x[1]+xt+g[2]):(W=x[1]+(ut+xt-A.displaySize[1])/2,ot=W+A.displaySize[1]),{image:A,top:W,right:Q,bottom:ot,left:ct,collisionPadding:z}}ir("ImagePosition",nm),ir("ImageAtlas",Ly),nt.ay=void 0,(Yd=nt.ay||(nt.ay={}))[Yd.none=0]="none",Yd[Yd.horizontal=1]="horizontal",Yd[Yd.vertical=2]="vertical",Yd[Yd.horizontalOnly=3]="horizontalOnly";const iu=128,_d=32640;function Ag(h,o){const{expression:c}=o;if(c.kind==="constant")return{kind:"constant",layoutSize:c.evaluate(new wo(h+1))};if(c.kind==="source")return{kind:"source"};{const{zoomStops:g,interpolationType:x}=c;let T=0;for(;T<g.length&&g[T]<=h;)T++;T=Math.max(0,T-1);let A=T;for(;A<g.length&&g[A]<h+1;)A++;A=Math.min(g.length-1,A);const z=g[T],B=g[A];return c.kind==="composite"?{kind:"composite",minZoom:z,maxZoom:B,interpolationType:x}:{kind:"camera",minZoom:z,maxZoom:B,minSize:c.evaluate(new wo(z)),maxSize:c.evaluate(new wo(B)),interpolationType:x}}}function Pg(h,o,c){let g="never";const x=h.get(o);return x?g=x:h.get(c)&&(g="always"),g}const Fy=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function zu(h,o,c,g,x,T,A,z,B,G,W,Q,ot){const ct=z?Math.min(_d,Math.round(z[0])):0,ut=z?Math.min(_d,Math.round(z[1])):0;h.emplaceBack(o,c,Math.round(32*g),Math.round(32*x),T,A,(ct<<1)+(B?1:0),ut,16*G,16*W,256*Q,256*ot)}function Mg(h,o,c){h.emplaceBack(o.x,o.y,c),h.emplaceBack(o.x,o.y,c),h.emplaceBack(o.x,o.y,c),h.emplaceBack(o.x,o.y,c)}function S_(h){for(const o of h.sections)if(ch(o.text))return!0;return!1}class Cg{constructor(o){this.layoutVertexArray=new Qe,this.indexArray=new Oi,this.programConfigurations=o,this.segments=new Zr,this.dynamicLayoutVertexArray=new Xe,this.opacityVertexArray=new Je,this.hasVisibleVertices=!1,this.placedSymbolArray=new H}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(o,c,g,x){this.isEmpty()||(g&&(this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,mr.members),this.indexBuffer=o.createIndexBuffer(this.indexArray,c),this.dynamicLayoutVertexBuffer=o.createVertexBuffer(this.dynamicLayoutVertexArray,nn.members,!0),this.opacityVertexBuffer=o.createVertexBuffer(this.opacityVertexArray,Fy,!0),this.opacityVertexBuffer.itemSize=1),(g||x)&&this.programConfigurations.upload(o))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}ir("SymbolBuffers",Cg);class I_{constructor(o,c,g){this.layoutVertexArray=new o,this.layoutAttributes=c,this.indexArray=new g,this.segments=new Zr,this.collisionVertexArray=new Ri}upload(o){this.layoutVertexBuffer=o.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=o.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=o.createVertexBuffer(this.collisionVertexArray,So.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}ir("CollisionBuffers",I_);class om{constructor(o){this.collisionBoxArray=o.collisionBoxArray,this.zoom=o.zoom,this.overscaling=o.overscaling,this.layers=o.layers,this.layerIds=this.layers.map(A=>A.id),this.index=o.index,this.pixelRatio=o.pixelRatio,this.sourceLayerIndex=o.sourceLayerIndex,this.hasDependencies=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const c=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Ag(this.zoom,c["text-size"]),this.iconSizeData=Ag(this.zoom,c["icon-size"]);const g=this.layers[0].layout,x=g.get("symbol-sort-key"),T=g.get("symbol-z-order");this.canOverlap=Pg(g,"text-overlap","text-allow-overlap")!=="never"||Pg(g,"icon-overlap","icon-allow-overlap")!=="never"||g.get("text-ignore-placement")||g.get("icon-ignore-placement"),this.sortFeaturesByKey=T!=="viewport-y"&&!x.isConstant(),this.sortFeaturesByY=(T==="viewport-y"||T==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,g.get("symbol-placement")==="point"&&(this.writingModes=g.get("text-writing-mode").map(A=>nt.ay[A])),this.stateDependentLayerIds=this.layers.filter(A=>A.isStateDependent()).map(A=>A.id),this.sourceID=o.sourceID}createArrays(){this.text=new Cg(new dh(this.layers,this.zoom,o=>/^text/.test(o))),this.icon=new Cg(new dh(this.layers,this.zoom,o=>/^icon/.test(o))),this.glyphOffsetArray=new mt,this.lineVertexArray=new dt,this.symbolInstances=new et,this.textAnchorOffsets=new pt}calculateGlyphDependencies(o,c,g,x,T){for(const A of o)if(c[A.codePointAt(0)]=!0,(g||x)&&T){const z=fa[A];z&&(c[z.codePointAt(0)]=!0)}}populate(o,c,g){const x=this.layers[0],T=x.layout,A=T.get("text-font"),z=T.get("text-field"),B=T.get("icon-image"),G=(z.value.kind!=="constant"||z.value.value instanceof Uo&&!z.value.value.isEmpty()||z.value.value.toString().length>0)&&(A.value.kind!=="constant"||A.value.value.length>0),W=B.value.kind!=="constant"||!!B.value.value||Object.keys(B.parameters).length>0,Q=T.get("symbol-sort-key");if(this.features=[],!G&&!W)return;const ot=c.iconDependencies,ct=c.glyphDependencies,ut=c.availableImages,xt=new wo(this.zoom);for(const{feature:Et,id:Vt,index:ue,sourceLayerIndex:Qt}of o){const ee=x._featureFilter.needGeometry,Se=yc(Et,ee);if(!x._featureFilter.filter(xt,Se,g))continue;let Ee,ei;if(ee||(Se.geometry=Ul(Et)),G){const fi=x.getValueAndResolveTokens("text-field",Se,g,ut),zi=Uo.factory(fi),Ji=this.hasRTLText=this.hasRTLText||S_(zi);(!Ji||jc.getRTLTextPluginStatus()==="unavailable"||Ji&&jc.isParsed())&&(Ee=jo(zi,x,Se))}if(W){const fi=x.getValueAndResolveTokens("icon-image",Se,g,ut);ei=fi instanceof js?fi:js.fromString(fi)}if(!Ee&&!ei)continue;const Ii=this.sortFeaturesByKey?Q.evaluate(Se,{},g):void 0;if(this.features.push({id:Vt,text:Ee,icon:ei,index:ue,sourceLayerIndex:Qt,geometry:Se.geometry,properties:Et.properties,type:ve.types[Et.type],sortKey:Ii}),ei&&(ot[ei.name]=!0),Ee){const fi=A.evaluate(Se,{},g).join(","),zi=T.get("text-rotation-alignment")!=="viewport"&&T.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(nt.ay.vertical)>=0;for(const Ji of Ee.sections)if(Ji.image)ot[Ji.image.name]=!0;else{const $i=Uc(Ee.toString()),Ui=Ji.fontStack||fi,_i=ct[Ui]=ct[Ui]||{};this.calculateGlyphDependencies(Ji.text,_i,zi,this.allowVerticalPlacement,$i)}}}T.get("symbol-placement")==="line"&&(this.features=function(Et){const Vt={},ue={},Qt=[];let ee=0;function Se(fi){Qt.push(Et[fi]),ee++}function Ee(fi,zi,Ji){const $i=ue[fi];return delete ue[fi],ue[zi]=$i,Qt[$i].geometry[0].pop(),Qt[$i].geometry[0]=Qt[$i].geometry[0].concat(Ji[0]),$i}function ei(fi,zi,Ji){const $i=Vt[zi];return delete Vt[zi],Vt[fi]=$i,Qt[$i].geometry[0].shift(),Qt[$i].geometry[0]=Ji[0].concat(Qt[$i].geometry[0]),$i}function Ii(fi,zi,Ji){const $i=Ji?zi[0][zi[0].length-1]:zi[0][0];return`${fi}:${$i.x}:${$i.y}`}for(let fi=0;fi<Et.length;fi++){const zi=Et[fi],Ji=zi.geometry,$i=zi.text?zi.text.toString():null;if(!$i){Se(fi);continue}const Ui=Ii($i,Ji),_i=Ii($i,Ji,!0);if(Ui in ue&&_i in Vt&&ue[Ui]!==Vt[_i]){const kr=ei(Ui,_i,Ji),Ar=Ee(Ui,_i,Qt[kr].geometry);delete Vt[Ui],delete ue[_i],ue[Ii($i,Qt[Ar].geometry,!0)]=Ar,Qt[kr].geometry=null}else Ui in ue?Ee(Ui,_i,Ji):_i in Vt?ei(Ui,_i,Ji):(Se(fi),Vt[Ui]=ee-1,ue[_i]=ee-1)}return Qt.filter(fi=>fi.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Et,Vt)=>Et.sortKey-Vt.sortKey)}update(o,c,g){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(o,c,this.layers,{imagePositions:g}),this.icon.programConfigurations.updatePaintArrays(o,c,this.layers,{imagePositions:g}))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(o){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(o),this.iconCollisionBox.upload(o)),this.text.upload(o,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(o,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(o,c){const g=this.lineVertexArray.length;if(o.segment!==void 0){let x=o.dist(c[o.segment+1]),T=o.dist(c[o.segment]);const A={};for(let z=o.segment+1;z<c.length;z++)A[z]={x:c[z].x,y:c[z].y,tileUnitDistanceFromAnchor:x},z<c.length-1&&(x+=c[z+1].dist(c[z]));for(let z=o.segment||0;z>=0;z--)A[z]={x:c[z].x,y:c[z].y,tileUnitDistanceFromAnchor:T},z>0&&(T+=c[z-1].dist(c[z]));for(let z=0;z<c.length;z++){const B=A[z];this.lineVertexArray.emplaceBack(B.x,B.y,B.tileUnitDistanceFromAnchor)}}return{lineStartIndex:g,lineLength:this.lineVertexArray.length-g}}addSymbols(o,c,g,x,T,A,z,B,G,W,Q,ot){const ct=o.indexArray,ut=o.layoutVertexArray,xt=o.segments.prepareSegment(4*c.length,ut,ct,this.canOverlap?A.sortKey:void 0),Et=this.glyphOffsetArray.length,Vt=xt.vertexLength,ue=this.allowVerticalPlacement&&z===nt.ay.vertical?Math.PI/2:0,Qt=A.text&&A.text.sections;for(let ee=0;ee<c.length;ee++){const{tl:Se,tr:Ee,bl:ei,br:Ii,tex:fi,pixelOffsetTL:zi,pixelOffsetBR:Ji,minFontScaleX:$i,minFontScaleY:Ui,glyphOffset:_i,isSDF:kr,sectionIndex:Ar}=c[ee],Nr=xt.vertexLength,yr=_i[1];zu(ut,B.x,B.y,Se.x,yr+Se.y,fi.x,fi.y,g,kr,zi.x,zi.y,$i,Ui),zu(ut,B.x,B.y,Ee.x,yr+Ee.y,fi.x+fi.w,fi.y,g,kr,Ji.x,zi.y,$i,Ui),zu(ut,B.x,B.y,ei.x,yr+ei.y,fi.x,fi.y+fi.h,g,kr,zi.x,Ji.y,$i,Ui),zu(ut,B.x,B.y,Ii.x,yr+Ii.y,fi.x+fi.w,fi.y+fi.h,g,kr,Ji.x,Ji.y,$i,Ui),Mg(o.dynamicLayoutVertexArray,B,ue),ct.emplaceBack(Nr,Nr+2,Nr+1),ct.emplaceBack(Nr+1,Nr+2,Nr+3),xt.vertexLength+=4,xt.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(_i[0]),ee!==c.length-1&&Ar===c[ee+1].sectionIndex||o.programConfigurations.populatePaintArrays(ut.length,A,A.index,{imagePositions:{},canonical:ot,formattedSection:Qt&&Qt[Ar]})}o.placedSymbolArray.emplaceBack(B.x,B.y,Et,this.glyphOffsetArray.length-Et,Vt,G,W,B.segment,g?g[0]:0,g?g[1]:0,x[0],x[1],z,0,!1,0,Q)}_addCollisionDebugVertex(o,c,g,x,T,A){return c.emplaceBack(0,0),o.emplaceBack(g.x,g.y,x,T,Math.round(A.x),Math.round(A.y))}addCollisionDebugVertices(o,c,g,x,T,A,z){const B=T.segments.prepareSegment(4,T.layoutVertexArray,T.indexArray),G=B.vertexLength,W=T.layoutVertexArray,Q=T.collisionVertexArray,ot=z.anchorX,ct=z.anchorY;this._addCollisionDebugVertex(W,Q,A,ot,ct,new Le(o,c)),this._addCollisionDebugVertex(W,Q,A,ot,ct,new Le(g,c)),this._addCollisionDebugVertex(W,Q,A,ot,ct,new Le(g,x)),this._addCollisionDebugVertex(W,Q,A,ot,ct,new Le(o,x)),B.vertexLength+=4;const ut=T.indexArray;ut.emplaceBack(G,G+1),ut.emplaceBack(G+1,G+2),ut.emplaceBack(G+2,G+3),ut.emplaceBack(G+3,G),B.primitiveLength+=4}addDebugCollisionBoxes(o,c,g,x){for(let T=o;T<c;T++){const A=this.collisionBoxArray.get(T);this.addCollisionDebugVertices(A.x1,A.y1,A.x2,A.y2,x?this.textCollisionBox:this.iconCollisionBox,A.anchorPoint,g)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new I_(ii,Yo.members,Ti),this.iconCollisionBox=new I_(ii,Yo.members,Ti);for(let o=0;o<this.symbolInstances.length;o++){const c=this.symbolInstances.get(o);this.addDebugCollisionBoxes(c.textBoxStartIndex,c.textBoxEndIndex,c,!0),this.addDebugCollisionBoxes(c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c,!0),this.addDebugCollisionBoxes(c.iconBoxStartIndex,c.iconBoxEndIndex,c,!1),this.addDebugCollisionBoxes(c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex,c,!1)}}_deserializeCollisionBoxesForSymbol(o,c,g,x,T,A,z,B,G){const W={};for(let Q=c;Q<g;Q++){const ot=o.get(Q);W.textBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.textFeatureIndex=ot.featureIndex;break}for(let Q=x;Q<T;Q++){const ot=o.get(Q);W.verticalTextBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.verticalTextFeatureIndex=ot.featureIndex;break}for(let Q=A;Q<z;Q++){const ot=o.get(Q);W.iconBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.iconFeatureIndex=ot.featureIndex;break}for(let Q=B;Q<G;Q++){const ot=o.get(Q);W.verticalIconBox={x1:ot.x1,y1:ot.y1,x2:ot.x2,y2:ot.y2,anchorPointX:ot.anchorPointX,anchorPointY:ot.anchorPointY},W.verticalIconFeatureIndex=ot.featureIndex;break}return W}deserializeCollisionBoxes(o){this.collisionArrays=[];for(let c=0;c<this.symbolInstances.length;c++){const g=this.symbolInstances.get(c);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(o,g.textBoxStartIndex,g.textBoxEndIndex,g.verticalTextBoxStartIndex,g.verticalTextBoxEndIndex,g.iconBoxStartIndex,g.iconBoxEndIndex,g.verticalIconBoxStartIndex,g.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(o,c){const g=o.placedSymbolArray.get(c),x=g.vertexStartIndex+4*g.numGlyphs;for(let T=g.vertexStartIndex;T<x;T+=4)o.indexArray.emplaceBack(T,T+2,T+1),o.indexArray.emplaceBack(T+1,T+2,T+3)}getSortedSymbolIndexes(o){if(this.sortedAngle===o&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const c=Math.sin(o),g=Math.cos(o),x=[],T=[],A=[];for(let z=0;z<this.symbolInstances.length;++z){A.push(z);const B=this.symbolInstances.get(z);x.push(0|Math.round(c*B.anchorX+g*B.anchorY)),T.push(B.featureIndex)}return A.sort((z,B)=>x[z]-x[B]||T[B]-T[z]),A}addToSortKeyRanges(o,c){const g=this.sortKeyRanges[this.sortKeyRanges.length-1];g&&g.sortKey===c?g.symbolInstanceEnd=o+1:this.sortKeyRanges.push({sortKey:c,symbolInstanceStart:o,symbolInstanceEnd:o+1})}sortFeatures(o){if(this.sortFeaturesByY&&this.sortedAngle!==o&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(o),this.sortedAngle=o,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const c of this.symbolInstanceIndexes){const g=this.symbolInstances.get(c);this.featureSortOrder.push(g.featureIndex),[g.rightJustifiedTextSymbolIndex,g.centerJustifiedTextSymbolIndex,g.leftJustifiedTextSymbolIndex].forEach((x,T,A)=>{x>=0&&A.indexOf(x)===T&&this.addIndicesForPlacedSymbol(this.text,x)}),g.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,g.verticalPlacedTextSymbolIndex),g.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,g.placedIconSymbolIndex),g.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,g.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let By,E_;ir("SymbolBucket",om,{omit:["layers","collisionBoxArray","features","compareText"]}),om.MAX_GLYPHS=65535,om.addDynamicAttributes=Mg;var Dg={get paint(){return E_=E_||new _s({"icon-opacity":new Or(Jt.paint_symbol["icon-opacity"]),"icon-color":new Or(Jt.paint_symbol["icon-color"]),"icon-halo-color":new Or(Jt.paint_symbol["icon-halo-color"]),"icon-halo-width":new Or(Jt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Or(Jt.paint_symbol["icon-halo-blur"]),"icon-translate":new Ir(Jt.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ir(Jt.paint_symbol["icon-translate-anchor"]),"text-opacity":new Or(Jt.paint_symbol["text-opacity"]),"text-color":new Or(Jt.paint_symbol["text-color"],{runtimeType:Ht,getOverride:h=>h.textColor,hasOverride:h=>!!h.textColor}),"text-halo-color":new Or(Jt.paint_symbol["text-halo-color"]),"text-halo-width":new Or(Jt.paint_symbol["text-halo-width"]),"text-halo-blur":new Or(Jt.paint_symbol["text-halo-blur"]),"text-translate":new Ir(Jt.paint_symbol["text-translate"]),"text-translate-anchor":new Ir(Jt.paint_symbol["text-translate-anchor"])})},get layout(){return By=By||new _s({"symbol-placement":new Ir(Jt.layout_symbol["symbol-placement"]),"symbol-spacing":new Ir(Jt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ir(Jt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Or(Jt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ir(Jt.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Ir(Jt.layout_symbol["icon-allow-overlap"]),"icon-overlap":new Ir(Jt.layout_symbol["icon-overlap"]),"icon-ignore-placement":new Ir(Jt.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ir(Jt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ir(Jt.layout_symbol["icon-rotation-alignment"]),"icon-size":new Or(Jt.layout_symbol["icon-size"]),"icon-text-fit":new Ir(Jt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ir(Jt.layout_symbol["icon-text-fit-padding"]),"icon-image":new Or(Jt.layout_symbol["icon-image"]),"icon-rotate":new Or(Jt.layout_symbol["icon-rotate"]),"icon-padding":new Or(Jt.layout_symbol["icon-padding"]),"icon-keep-upright":new Ir(Jt.layout_symbol["icon-keep-upright"]),"icon-offset":new Or(Jt.layout_symbol["icon-offset"]),"icon-anchor":new Or(Jt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ir(Jt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ir(Jt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ir(Jt.layout_symbol["text-rotation-alignment"]),"text-field":new Or(Jt.layout_symbol["text-field"]),"text-font":new Or(Jt.layout_symbol["text-font"]),"text-size":new Or(Jt.layout_symbol["text-size"]),"text-max-width":new Or(Jt.layout_symbol["text-max-width"]),"text-line-height":new Ir(Jt.layout_symbol["text-line-height"]),"text-letter-spacing":new Or(Jt.layout_symbol["text-letter-spacing"]),"text-justify":new Or(Jt.layout_symbol["text-justify"]),"text-radial-offset":new Or(Jt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ir(Jt.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new Or(Jt.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new Or(Jt.layout_symbol["text-anchor"]),"text-max-angle":new Ir(Jt.layout_symbol["text-max-angle"]),"text-writing-mode":new Ir(Jt.layout_symbol["text-writing-mode"]),"text-rotate":new Or(Jt.layout_symbol["text-rotate"]),"text-padding":new Ir(Jt.layout_symbol["text-padding"]),"text-keep-upright":new Ir(Jt.layout_symbol["text-keep-upright"]),"text-transform":new Or(Jt.layout_symbol["text-transform"]),"text-offset":new Or(Jt.layout_symbol["text-offset"]),"text-allow-overlap":new Ir(Jt.layout_symbol["text-allow-overlap"]),"text-overlap":new Ir(Jt.layout_symbol["text-overlap"]),"text-ignore-placement":new Ir(Jt.layout_symbol["text-ignore-placement"]),"text-optional":new Ir(Jt.layout_symbol["text-optional"])})}};class Oy{constructor(o){if(o.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=o.property.overrides?o.property.overrides.runtimeType:st,this.defaultValue=o}evaluate(o){if(o.formattedSection){const c=this.defaultValue.property.overrides;if(c&&c.hasOverride(o.formattedSection))return c.getOverride(o.formattedSection)}return o.feature&&o.featureState?this.defaultValue.evaluate(o.feature,o.featureState):this.defaultValue.property.specification.default}eachChild(o){this.defaultValue.isConstant()||o(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}ir("FormatSectionOverride",Oy,{omit:["defaultValue"]});class qm extends bl{constructor(o,c){super(o,Dg,c)}recalculate(o,c){if(super.recalculate(o,c),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const g=this.layout.get("text-writing-mode");if(g){const x=[];for(const T of g)x.indexOf(T)<0&&x.push(T);this.layout._values["text-writing-mode"]=x}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(o,c,g,x){const T=this.layout.get(o).evaluate(c,{},g,x),A=this._unevaluatedLayout._values[o];return A.isDataDriven()||_p(A.value)||!T?T:function(z,B){return B.replace(/{([^{}]+)}/g,(G,W)=>z&&W in z?String(z[W]):"")}(c.properties,T)}createBucket(o){return new om(o)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const o of Dg.paint.overridableProperties){if(!qm.hasPaintOverride(this.layout,o))continue;const c=this.paint.get(o),g=new Oy(c),x=new fu(g,c.property.specification);let T=null;T=c.value.kind==="constant"||c.value.kind==="source"?new Bh("source",x):new Yu("composite",x,c.value.zoomStops),this.paint._values[o]=new da(c.property,T,c.parameters)}}_handleOverridablePaintPropertyUpdate(o,c,g){return!(!this.layout||c.isDataDriven()||g.isDataDriven())&&qm.hasPaintOverride(this.layout,o)}static hasPaintOverride(o,c){const g=o.get("text-field"),x=Dg.paint.properties[c];let T=!1;const A=z=>{for(const B of z)if(x.overrides&&x.overrides.hasOverride(B))return void(T=!0)};if(g.value.kind==="constant"&&g.value.value instanceof Uo)A(g.value.value.sections);else if(g.value.kind==="source"||g.value.kind==="composite"){const z=G=>{T||(G instanceof Wl&&vr(G.value)===ti?A(G.value.sections):G instanceof hc?A(G.sections):G.eachChild(z))},B=g.value;B._styleExpression&&z(B._styleExpression.expression)}return T}}let Ny;var nx={get paint(){return Ny=Ny||new _s({"background-color":new Ir(Jt.paint_background["background-color"]),"background-pattern":new mc(Jt.paint_background["background-pattern"]),"background-opacity":new Ir(Jt.paint_background["background-opacity"])})}};class Vy extends bl{constructor(o,c){super(o,nx,c)}}class Uy extends bl{constructor(o,c){super(o,{},c),this.onAdd=g=>{this.implementation.onAdd&&this.implementation.onAdd(g,g.painter.context.gl)},this.onRemove=g=>{this.implementation.onRemove&&this.implementation.onRemove(g,g.painter.context.gl)},this.implementation=o}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class jy{constructor(o){this._methodToThrottle=o,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const Gy={once:!0},zg=63710088e-1;class Jd{constructor(o,c){if(isNaN(o)||isNaN(c))throw new Error(`Invalid LngLat object: (${o}, ${c})`);if(this.lng=+o,this.lat=+c,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Jd(Wr(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(o){const c=Math.PI/180,g=this.lat*c,x=o.lat*c,T=Math.sin(g)*Math.sin(x)+Math.cos(g)*Math.cos(x)*Math.cos((o.lng-this.lng)*c);return zg*Math.acos(Math.min(T,1))}static convert(o){if(o instanceof Jd)return o;if(Array.isArray(o)&&(o.length===2||o.length===3))return new Jd(Number(o[0]),Number(o[1]));if(!Array.isArray(o)&&typeof o=="object"&&o!==null)return new Jd(Number("lng"in o?o.lng:o.lon),Number(o.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const A_=2*Math.PI*zg;function Lg(h){return A_*Math.cos(h*Math.PI/180)}function Kd(h){return(180+h)/360}function Ma(h){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+h*Math.PI/360)))/360}function P_(h,o){return h/Lg(o)}function sm(h){return 360*h-180}function Rg(h){return 360/Math.PI*Math.atan(Math.exp((180-360*h)*Math.PI/180))-90}function $y(h,o){return h*Lg(Rg(o))}class Zm{constructor(o,c,g=0){this.x=+o,this.y=+c,this.z=+g}static fromLngLat(o,c=0){const g=Jd.convert(o);return new Zm(Kd(g.lng),Ma(g.lat),P_(c,g.lat))}toLngLat(){return new Jd(sm(this.x),Rg(this.y))}toAltitude(){return $y(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/A_*(o=Rg(this.y),1/Math.cos(o*Math.PI/180));var o}}function qy(h,o,c){var g=2*Math.PI*6378137/256/Math.pow(2,c);return[h*g-2*Math.PI*6378137/2,o*g-2*Math.PI*6378137/2]}class $p{constructor(o,c,g){if(!function(x,T,A){return!(x<0||x>25||A<0||A>=Math.pow(2,x)||T<0||T>=Math.pow(2,x))}(o,c,g))throw new Error(`x=${c}, y=${g}, z=${o} outside of bounds. 0<=x<${Math.pow(2,o)}, 0<=y<${Math.pow(2,o)} 0<=z<=25 `);this.z=o,this.x=c,this.y=g,this.key=yd(0,o,o,c,g)}equals(o){return this.z===o.z&&this.x===o.x&&this.y===o.y}url(o,c,g){const x=(A=this.y,z=this.z,B=qy(256*(T=this.x),256*(A=Math.pow(2,z)-A-1),z),G=qy(256*(T+1),256*(A+1),z),B[0]+","+B[1]+","+G[0]+","+G[1]);var T,A,z,B,G;const W=function(Q,ot,ct){let ut,xt="";for(let Et=Q;Et>0;Et--)ut=1<<Et-1,xt+=(ot&ut?1:0)+(ct&ut?2:0);return xt}(this.z,this.x,this.y);return o[(this.x+this.y)%o.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(g==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,c>1?"@2x":"").replace(/{quadkey}/g,W).replace(/{bbox-epsg-3857}/g,x)}isChildOf(o){const c=this.z-o.z;return c>0&&o.x===this.x>>c&&o.y===this.y>>c}getTilePoint(o){const c=Math.pow(2,this.z);return new Le((o.x*c-this.x)*zn,(o.y*c-this.y)*zn)}toString(){return`${this.z}/${this.x}/${this.y}`}}class M_{constructor(o,c){this.wrap=o,this.canonical=c,this.key=yd(o,c.z,c.z,c.x,c.y)}}class nl{constructor(o,c,g,x,T){if(this.terrainRttPosMatrix32f=null,o<g)throw new Error(`overscaledZ should be >= z; overscaledZ = ${o}; z = ${g}`);this.overscaledZ=o,this.wrap=c,this.canonical=new $p(g,+x,+T),this.key=yd(c,o,g,x,T)}clone(){return new nl(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(o){return this.overscaledZ===o.overscaledZ&&this.wrap===o.wrap&&this.canonical.equals(o.canonical)}scaledTo(o){if(o>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${o}; overscaledZ = ${this.overscaledZ}`);const c=this.canonical.z-o;return o>this.canonical.z?new nl(o,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new nl(o,this.wrap,o,this.canonical.x>>c,this.canonical.y>>c)}isOverscaled(){return this.overscaledZ>this.canonical.z}calculateScaledKey(o,c){if(o>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${o}; overscaledZ = ${this.overscaledZ}`);const g=this.canonical.z-o;return o>this.canonical.z?yd(this.wrap*+c,o,this.canonical.z,this.canonical.x,this.canonical.y):yd(this.wrap*+c,o,o,this.canonical.x>>g,this.canonical.y>>g)}isChildOf(o){if(o.wrap!==this.wrap||this.overscaledZ-o.overscaledZ<=0)return!1;if(o.overscaledZ===0)return this.overscaledZ>0;const c=this.canonical.z-o.canonical.z;return!(c<0)&&o.canonical.x===this.canonical.x>>c&&o.canonical.y===this.canonical.y>>c}children(o){if(this.overscaledZ>=o)return[new nl(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const c=this.canonical.z+1,g=2*this.canonical.x,x=2*this.canonical.y;return[new nl(c,this.wrap,c,g,x),new nl(c,this.wrap,c,g+1,x),new nl(c,this.wrap,c,g,x+1),new nl(c,this.wrap,c,g+1,x+1)]}isLessThan(o){return this.wrap<o.wrap||!(this.wrap>o.wrap)&&(this.overscaledZ<o.overscaledZ||!(this.overscaledZ>o.overscaledZ)&&(this.canonical.x<o.canonical.x||!(this.canonical.x>o.canonical.x)&&this.canonical.y<o.canonical.y))}wrapped(){return new nl(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(o){return new nl(this.overscaledZ,o,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new M_(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(o){return this.canonical.getTilePoint(new Zm(o.x-this.wrap,o.y))}}function yd(h,o,c,g,x){(h*=2)<0&&(h=-1*h-1);const T=1<<c;return(T*T*h+T*x+g).toString(36)+c.toString(36)+o.toString(36)}function Hm(h,o){return o?h.properties[o]:h.id}function ox(h,o){const c={id:h.id};if(o.removeAllProperties&&(delete h.removeProperties,delete h.addOrUpdateProperties,delete o.removeProperties),o.removeProperties)for(const g of o.removeProperties){const x=h.addOrUpdateProperties.findIndex(T=>T.key===g);x>-1&&h.addOrUpdateProperties.splice(x,1)}return(h.removeAllProperties||o.removeAllProperties)&&(c.removeAllProperties=!0),(h.removeProperties||o.removeProperties)&&(c.removeProperties=[...h.removeProperties||[],...o.removeProperties||[]]),(h.addOrUpdateProperties||o.addOrUpdateProperties)&&(c.addOrUpdateProperties=[...h.addOrUpdateProperties||[],...o.addOrUpdateProperties||[]]),(h.newGeometry||o.newGeometry)&&(c.newGeometry=o.newGeometry||h.newGeometry),c}function Zy(h){var o,c;if(!h)return{};const g={};return g.removeAll=h.removeAll,g.remove=new Set(h.remove||[]),g.add=new Map((o=h.add)===null||o===void 0?void 0:o.map(x=>[x.id,x])),g.update=new Map((c=h.update)===null||c===void 0?void 0:c.map(x=>[x.id,x])),g}ir("CanonicalTileID",$p),ir("OverscaledTileID",nl,{omit:["terrainRttPosMatrix32f"]});class Hy{constructor(o){this._stringToNumber={},this._numberToString=[];for(let c=0;c<o.length;c++){const g=o[c];this._stringToNumber[g]=c,this._numberToString[c]=g}}encode(o){return this._stringToNumber[o]}decode(o){if(o>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${o} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[o]}}class Wy{constructor(o,c,g,x,T){this.type="Feature",this._vectorTileFeature=o,o._z=c,o._x=g,o._y=x,this.properties=o.properties,this.id=T}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(o){this._geometry=o}toJSON(){const o={geometry:this.geometry};for(const c in this)c!=="_geometry"&&c!=="_vectorTileFeature"&&(o[c]=this[c]);return o}}class am{constructor(o,c,g){Mi(this,"_name");Mi(this,"dataBuffer");Mi(this,"nullabilityBuffer");Mi(this,"_size");this._name=o,this.dataBuffer=c,typeof g=="number"?this._size=g:(this.nullabilityBuffer=g,this._size=g.size())}getValue(o){return this.nullabilityBuffer&&!this.nullabilityBuffer.get(o)?null:this.getValueFromBuffer(o)}has(o){return this.nullabilityBuffer&&this.nullabilityBuffer.get(o)||!this.nullabilityBuffer}get name(){return this._name}get size(){return this._size}}class kg extends am{}class Wm extends kg{getValueFromBuffer(o){return this.dataBuffer[o]}}class C_ extends kg{getValueFromBuffer(o){return this.dataBuffer[o]}}class D_ extends am{constructor(c,g,x,T){super(c,g,T);Mi(this,"delta");this.delta=x}}class Af extends D_{constructor(o,c,g,x){super(o,Int32Array.of(c),g,x)}getValueFromBuffer(o){return this.dataBuffer[0]+o*this.delta}}class z_ extends am{constructor(o,c,g){super(o,Int32Array.of(c),g)}getValueFromBuffer(o){return this.dataBuffer[0]}}class ea{constructor(o,c,g,x,T=4096){Mi(this,"_name");Mi(this,"_geometryVector");Mi(this,"_idVector");Mi(this,"_propertyVectors");Mi(this,"_extent");Mi(this,"propertyVectorsMap");this._name=o,this._geometryVector=c,this._idVector=g,this._propertyVectors=x,this._extent=T}get name(){return this._name}get idVector(){return this._idVector}get geometryVector(){return this._geometryVector}get propertyVectors(){return this._propertyVectors}getPropertyVector(o){return this.propertyVectorsMap||(this.propertyVectorsMap=new Map(this._propertyVectors.map(c=>[c.name,c]))),this.propertyVectorsMap.get(o)}*[Symbol.iterator](){const o=this.geometryVector[Symbol.iterator]();let c=0;for(;c<this.numFeatures;){let g;this.idVector&&(g=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(c)):this.idVector.getValue(c));const x=o==null?void 0:o.next().value,T={};for(const A of this.propertyVectors){if(!A)continue;const z=A.name,B=A.getValue(c);B!==null&&(T[z]=B)}c++,yield{id:g,geometry:x,properties:T}}}get numFeatures(){return this.geometryVector.numGeometries}get extent(){return this._extent}getFeatures(){const o=[],c=this.geometryVector.getGeometries();for(let g=0;g<this.numFeatures;g++){let x;this.idVector&&(x=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(g)):this.idVector.getValue(g));const T={coordinates:c[g],type:this.geometryVector.geometryType(g)},A={};for(const z of this.propertyVectors){if(!z)continue;const B=z.name,G=z.getValue(g);G!==null&&(A[B]=G)}o.push({id:x,geometry:T,properties:A})}return o}containsMaxSaveIntegerValues(o){return o instanceof Wm||o instanceof z_&&o instanceof Af||o instanceof C_}}class lm{constructor(o){Mi(this,"value");this.value=o}get(){return this.value}set(o){this.value=o}increment(){return this.value++}add(o){this.value+=o}}var ol,Fn,ru,Sc,qp,Ic,Hs,ga,cm,yh;(function(h){h.PRESENT="PRESENT",h.DATA="DATA",h.OFFSET="OFFSET",h.LENGTH="LENGTH"})(ol||(ol={}));class Fg{constructor(o,c,g){Mi(this,"_dictionaryType");Mi(this,"_offsetType");Mi(this,"_lengthType");this._dictionaryType=o,this._offsetType=c,this._lengthType=g}get dictionaryType(){return this._dictionaryType}get offsetType(){return this._offsetType}get lengthType(){return this._lengthType}}function ia(h,o,c){const g=new Int32Array(c);let x=0,T=o.get();for(let A=0;A<g.length;A++){let z=h[T++],B=127&z;z<128||(z=h[T++],B|=(127&z)<<7,z<128||(z=h[T++],B|=(127&z)<<14,z<128||(z=h[T++],B|=(127&z)<<21,z<128||(z=h[T++],B|=(15&z)<<28)))),g[x++]=B}return o.set(T),g}function hm(h,o,c){const g=new BigInt64Array(c);for(let x=0;x<g.length;x++)g[x]=Yy(h,o);return g}function Xy(h,o){let c,g;return g=h[o.get()],o.increment(),c=127&g,g<128?c:(g=h[o.get()],o.increment(),c|=(127&g)<<7,g<128?c:(g=h[o.get()],o.increment(),c|=(127&g)<<14,g<128?c:(g=h[o.get()],o.increment(),c|=(127&g)<<21,g<128?c:(g=h[o.get()],c|=(15&g)<<28,function(x,T,A){let z,B;if(B=T[A.get()],A.increment(),z=(112&B)>>4,B<128||(B=T[A.get()],A.increment(),z|=(127&B)<<3,B<128)||(B=T[A.get()],A.increment(),z|=(127&B)<<10,B<128)||(B=T[A.get()],A.increment(),z|=(127&B)<<17,B<128)||(B=T[A.get()],A.increment(),z|=(127&B)<<24,B<128)||(B=T[A.get()],A.increment(),z|=(1&B)<<31,B<128))return 4294967296*z+(x>>>0);throw new Error("Expected varint not more than 10 bytes")}(c,h,o)))))}function xd(h,o,c,g){throw new Error("FastPFor is not implemented yet.")}function Pf(h){return h>>>1^-(1&h)}function Ua(h){return h>>1n^-(1n&h)}function Yy(h,o){let c=0n,g=0,x=o.get();for(;x<h.length;){const T=h[x++];if(c|=BigInt(127&T)<<BigInt(g),!(128&T))break;if(g+=7,g>=64)throw new Error("Varint too long")}return o.set(x),c}function L_(h,o,c){const g=new Int32Array(c);let x=0;for(let T=0;T<o;T++){const A=h[T];g.fill(h[T+o],x,x+A),x+=A}return g}function R_(h,o,c){const g=new BigInt64Array(c);let x=0;for(let T=0;T<o;T++){const A=Number(h[T]);g.fill(h[T+o],x,x+A),x+=A}return g}function Xm(h,o,c){const g=new Float64Array(c);let x=0;for(let T=0;T<o;T++){const A=h[T];g.fill(h[T+o],x,x+A),x+=A}return g}function k_(h){const o=h.length/4*4;let c=1;if(o>=4)for(let g=h[0];c<o-4;c+=4)g=h[c]+=g,g=h[c+1]+=g,g=h[c+2]+=g,g=h[c+3]+=g;for(;c!=h.length;)h[c]+=h[c-1],++c}function Jy(h){h[0]=h[0]>>>1^-(1&h[0]),h[1]=h[1]>>>1^-(1&h[1]);const o=h.length/4*4;let c=2;if(o>=4)for(;c<o-4;c+=4){const g=h[c],x=h[c+1],T=h[c+2],A=h[c+3];h[c]=(g>>>1^-(1&g))+h[c-2],h[c+1]=(x>>>1^-(1&x))+h[c-1],h[c+2]=(T>>>1^-(1&T))+h[c],h[c+3]=(A>>>1^-(1&A))+h[c+1]}for(;c!=h.length;c+=2)h[c]=(h[c]>>>1^-(1&h[c]))+h[c-2],h[c+1]=(h[c+1]>>>1^-(1&h[c+1]))+h[c-1]}function vd(h,o,c){return Math.min(c,Math.max(o,h))}(function(h){h.NONE="NONE",h.DELTA="DELTA",h.COMPONENTWISE_DELTA="COMPONENTWISE_DELTA",h.RLE="RLE",h.MORTON="MORTON",h.PDE="PDE"})(Fn||(Fn={})),function(h){h.NONE="NONE",h.FAST_PFOR="FAST_PFOR",h.VARINT="VARINT",h.ALP="ALP"}(ru||(ru={})),function(h){h.NONE="NONE",h.SINGLE="SINGLE",h.SHARED="SHARED",h.VERTEX="VERTEX",h.MORTON="MORTON",h.FSST="FSST"}(Sc||(Sc={})),function(h){h.VERTEX="VERTEX",h.INDEX="INDEX",h.STRING="STRING",h.KEY="KEY"}(qp||(qp={})),function(h){h.VAR_BINARY="VAR_BINARY",h.GEOMETRIES="GEOMETRIES",h.PARTS="PARTS",h.RINGS="RINGS",h.TRIANGLES="TRIANGLES",h.SYMBOL="SYMBOL",h.DICTIONARY="DICTIONARY"}(Ic||(Ic={}));class Zp{constructor(o,c,g,x,T,A,z){Mi(this,"_physicalStreamType");Mi(this,"_logicalStreamType");Mi(this,"_logicalLevelTechnique1");Mi(this,"_logicalLevelTechnique2");Mi(this,"_physicalLevelTechnique");Mi(this,"_numValues");Mi(this,"_byteLength");this._physicalStreamType=o,this._logicalStreamType=c,this._logicalLevelTechnique1=g,this._logicalLevelTechnique2=x,this._physicalLevelTechnique=T,this._numValues=A,this._byteLength=z}static decode(o,c){const g=o[c.get()],x=Object.values(ol)[g>>4];let T=null;switch(x){case ol.DATA:T=new Fg(Object.values(Sc)[15&g]);break;case ol.OFFSET:T=new Fg(null,Object.values(qp)[15&g]);break;case ol.LENGTH:T=new Fg(null,null,Object.values(Ic)[15&g])}c.increment();const A=o[c.get()],z=Object.values(Fn)[A>>5],B=Object.values(Fn)[A>>2&7],G=Object.values(ru)[3&A];c.increment();const W=ia(o,c,2);return new Zp(x,T,z,B,G,W[0],W[1])}get physicalStreamType(){return this._physicalStreamType}get logicalStreamType(){return this._logicalStreamType}get logicalLevelTechnique1(){return this._logicalLevelTechnique1}get logicalLevelTechnique2(){return this._logicalLevelTechnique2}get physicalLevelTechnique(){return this._physicalLevelTechnique}get numValues(){return this._numValues}get byteLength(){return this._byteLength}getDecompressedCount(){return this._numValues}}class um extends Zp{constructor(c,g,x,T,A,z,B,G,W){super(c,g,x,T,A,z,B);Mi(this,"num_bits");Mi(this,"coordinate_shift");this.num_bits=G,this.coordinate_shift=W}static decode(c,g){const x=Zp.decode(c,g),T=ia(c,g,2);return new um(x.physicalStreamType,x.logicalStreamType,x.logicalLevelTechnique1,x.logicalLevelTechnique2,x.physicalLevelTechnique,x.numValues,x.byteLength,T[0],T[1])}static decodePartial(c,g,x){const T=ia(g,x,2);return new um(c.physicalStreamType,c.logicalStreamType,c.logicalLevelTechnique1,c.logicalLevelTechnique2,c.physicalLevelTechnique,c.numValues,c.byteLength,T[0],T[1])}numBits(){return this.num_bits}coordinateShift(){return this.coordinate_shift}}class Mf extends Zp{constructor(c,g,x,T,A,z,B,G,W){super(c,g,x,T,A,z,B);Mi(this,"_runs");Mi(this,"_numRleValues");this._runs=G,this._numRleValues=W}static decode(c,g){const x=Zp.decode(c,g),T=ia(c,g,2);return new Mf(x.physicalStreamType,x.logicalStreamType,x.logicalLevelTechnique1,x.logicalLevelTechnique2,x.physicalLevelTechnique,x.numValues,x.byteLength,T[0],T[1])}static decodePartial(c,g,x){const T=ia(g,x,2);return new Mf(c.physicalStreamType,c.logicalStreamType,c.logicalLevelTechnique1,c.logicalLevelTechnique2,c.physicalLevelTechnique,c.numValues,c.byteLength,T[0],T[1])}get runs(){return this._runs}get numRleValues(){return this._numRleValues}getDecompressedCount(){return this._numRleValues}}class Sl{static decode(o,c){const g=Zp.decode(o,c);return g.logicalLevelTechnique1===Fn.MORTON?um.decodePartial(g,o,c):Fn.RLE!==g.logicalLevelTechnique1&&Fn.RLE!==g.logicalLevelTechnique2||ru.NONE===g.physicalLevelTechnique?g:Mf.decodePartial(g,o,c)}}(function(h){h[h.FLAT=0]="FLAT",h[h.CONST=1]="CONST",h[h.SEQUENCE=2]="SEQUENCE",h[h.DICTIONARY=3]="DICTIONARY",h[h.FSST_DICTIONARY=4]="FSST_DICTIONARY"})(Hs||(Hs={}));class nu{constructor(o,c){Mi(this,"values");Mi(this,"_size");this.values=o,this._size=c}get(o){const c=Math.floor(o/8);return(this.values[c]>>o%8&1)==1}set(o,c){const g=Math.floor(o/8);this.values[g]=this.values[g]|(c?1:0)<<o%8}getInt(o){const c=Math.floor(o/8);return this.values[c]>>o%8&1}size(){return this._size}getBuffer(){return this.values}}class xn{constructor(){}static decodeIntStream(o,c,g,x,T){const A=xn.decodePhysicalLevelTechnique(o,c,g);return this.decodeIntBuffer(A,g,x,T)}static decodeLengthStreamToOffsetBuffer(o,c,g){const x=xn.decodePhysicalLevelTechnique(o,c,g);return this.decodeLengthToOffsetBuffer(x,g)}static decodePhysicalLevelTechnique(o,c,g){const x=g.physicalLevelTechnique;if(x===ru.FAST_PFOR)return xd();if(x===ru.VARINT)return ia(o,c,g.numValues);if(x===ru.NONE){const T=c.get();c.add(g.byteLength);const A=o.subarray(T,c.get());return new Int32Array(A)}throw new Error("Specified physicalLevelTechnique is not supported (yet).")}static decodeConstIntStream(o,c,g,x){const T=xn.decodePhysicalLevelTechnique(o,c,g);if(T.length===1){const A=T[0];return x?Pf(A):A}return x?function(A){return Pf(A[1])}(T):function(A){return A[1]}(T)}static decodeSequenceIntStream(o,c,g){return function(x){if(x.length==2){const T=Pf(x[1]);return[T,T]}return[Pf(x[2]),Pf(x[3])]}(xn.decodePhysicalLevelTechnique(o,c,g))}static decodeSequenceLongStream(o,c,g){return function(x){if(x.length==2){const T=Ua(x[1]);return[T,T]}return[Ua(x[2]),Ua(x[3])]}(hm(o,c,g.numValues))}static decodeLongStream(o,c,g,x){const T=hm(o,c,g.numValues);return this.decodeLongBuffer(T,g,x)}static decodeLongFloat64Stream(o,c,g,x){const T=function(A,z,B){const G=new Float64Array(z);for(let W=0;W<z;W++)G[W]=Xy(A,B);return G}(o,g.numValues,c);return this.decodeFloat64Buffer(T,g,x)}static decodeConstLongStream(o,c,g,x){const T=hm(o,c,g.numValues);if(T.length===1){const A=T[0];return x?Ua(A):A}return x?function(A){return Ua(A[1])}(T):function(A){return A[1]}(T)}static decodeIntBuffer(o,c,g,x){switch(c.logicalLevelTechnique1){case Fn.DELTA:return c.logicalLevelTechnique2===Fn.RLE?function(T,A,z){const B=new Int32Array(z);let G=0,W=0;for(let Q=0;Q<A;Q++){const ot=T[Q],ct=Pf(T[Q+A]);for(let ut=0;ut<ot;ut++)W+=ct,B[G++]=W}return B}(o,c.runs,c.numRleValues):(function(T){T[0]=T[0]>>>1^-(1&T[0]);const A=T.length/4*4;let z=1;if(A>=4)for(;z<A-4;z+=4){const B=T[z],G=T[z+1],W=T[z+2],Q=T[z+3];T[z]=(B>>>1^-(1&B))+T[z-1],T[z+1]=(G>>>1^-(1&G))+T[z],T[z+2]=(W>>>1^-(1&W))+T[z+1],T[z+3]=(Q>>>1^-(1&Q))+T[z+2]}for(;z!=T.length;++z)T[z]=(T[z]>>>1^-(1&T[z]))+T[z-1]}(o),o);case Fn.RLE:return function(T,A,z){return z?function(B,G,W){const Q=new Int32Array(W);let ot=0;for(let ct=0;ct<G;ct++){const ut=B[ct];let xt=B[ct+G];xt=xt>>>1^-(1&xt),Q.fill(xt,ot,ot+ut),ot+=ut}return Q}(T,A.runs,A.numRleValues):L_(T,A.runs,A.numRleValues)}(o,c,g);case Fn.MORTON:return k_(o),o;case Fn.COMPONENTWISE_DELTA:return x?(function(T,A,z,B){let G=T[0]>>>1^-(1&T[0]),W=T[1]>>>1^-(1&T[1]);T[0]=vd(Math.round(G*A),z,B),T[1]=vd(Math.round(W*A),z,B);const Q=T.length/16;let ot=2;if(Q>=4)for(;ot<Q-4;ot+=4){const ct=T[ot],ut=T[ot+1],xt=(ct>>>1^-(1&ct))+G,Et=(ut>>>1^-(1&ut))+W;T[ot]=vd(Math.round(xt*A),z,B),T[ot+1]=vd(Math.round(Et*A),z,B);const Vt=T[ot+2],ue=T[ot+3];G=(Vt>>>1^-(1&Vt))+xt,W=(ue>>>1^-(1&ue))+Et,T[ot+2]=vd(Math.round(G*A),z,B),T[ot+3]=vd(Math.round(W*A),z,B)}for(;ot!=T.length;ot+=2)G+=T[ot]>>>1^-(1&T[ot]),W+=T[ot+1]>>>1^-(1&T[ot+1]),T[ot]=vd(Math.round(G*A),z,B),T[ot+1]=vd(Math.round(W*A),z,B)}(o,x.scale,x.min,x.max),o):(Jy(o),o);case Fn.NONE:return g&&function(T){for(let A=0;A<T.length;A++){const z=T[A];T[A]=z>>>1^-(1&z)}}(o),o;default:throw new Error(`The specified Logical level technique is not supported: ${c.logicalLevelTechnique1}`)}}static decodeLongBuffer(o,c,g){switch(c.logicalLevelTechnique1){case Fn.DELTA:return c.logicalLevelTechnique2===Fn.RLE?function(x,T,A){const z=new BigInt64Array(A);let B=0,G=0n;for(let W=0;W<T;W++){const Q=Number(x[W]),ot=Ua(x[W+T]);for(let ct=0;ct<Q;ct++)G+=ot,z[B++]=G}return z}(o,c.runs,c.numRleValues):(function(x){x[0]=x[0]>>1n^-(1n&x[0]);const T=x.length/4*4;let A=1;if(T>=4)for(;A<T-4;A+=4){const z=x[A],B=x[A+1],G=x[A+2],W=x[A+3];x[A]=(z>>1n^-(1n&z))+x[A-1],x[A+1]=(B>>1n^-(1n&B))+x[A],x[A+2]=(G>>1n^-(1n&G))+x[A+1],x[A+3]=(W>>1n^-(1n&W))+x[A+2]}for(;A!=x.length;++A)x[A]=(x[A]>>1n^-(1n&x[A]))+x[A-1]}(o),o);case Fn.RLE:return function(x,T,A){return A?function(z,B,G){const W=new BigInt64Array(G);let Q=0;for(let ot=0;ot<B;ot++){const ct=Number(z[ot]);let ut=z[ot+B];ut=ut>>1n^-(1n&ut),W.fill(ut,Q,Q+ct),Q+=ct}return W}(x,T.runs,T.numRleValues):R_(x,T.runs,T.numRleValues)}(o,c,g);case Fn.NONE:return g&&function(x){for(let T=0;T<x.length;T++){const A=x[T];x[T]=A>>1n^-(1n&A)}}(o),o;default:throw new Error(`The specified Logical level technique is not supported: ${c.logicalLevelTechnique1}`)}}static decodeFloat64Buffer(o,c,g){switch(c.logicalLevelTechnique1){case Fn.DELTA:return c.logicalLevelTechnique2===Fn.RLE&&(o=Xm(o,c.runs,c.numRleValues)),function(x){x[0]=x[0]%2==1?(x[0]+1)/-2:x[0]/2;const T=x.length/4*4;let A=1;if(T>=4)for(;A<T-4;A+=4){const z=x[A],B=x[A+1],G=x[A+2],W=x[A+3];x[A]=(z%2==1?(z+1)/-2:z/2)+x[A-1],x[A+1]=(B%2==1?(B+1)/-2:B/2)+x[A],x[A+2]=(G%2==1?(G+1)/-2:G/2)+x[A+1],x[A+3]=(W%2==1?(W+1)/-2:W/2)+x[A+2]}for(;A!=x.length;++A)x[A]=(x[A]%2==1?(x[A]+1)/-2:x[A]/2)+x[A-1]}(o),o;case Fn.RLE:return function(x,T,A){return A?function(z,B,G){const W=new Float64Array(G);let Q=0;for(let ot=0;ot<B;ot++){const ct=z[ot];let ut=z[ot+B];ut=ut%2==1?(ut+1)/-2:ut/2,W.fill(ut,Q,Q+ct),Q+=ct}return W}(x,T.runs,T.numRleValues):Xm(x,T.runs,T.numRleValues)}(o,c,g);case Fn.NONE:return g&&function(x){for(let T=0;T<x.length;T++){const A=x[T];x[T]=A%2==1?(A+1)/-2:A/2}}(o),o;default:throw new Error(`The specified Logical level technique is not supported: ${c.logicalLevelTechnique1}`)}}static decodeLengthToOffsetBuffer(o,c){if(c.logicalLevelTechnique1===Fn.DELTA&&c.logicalLevelTechnique2===Fn.NONE)return function(g){const x=new Int32Array(g.length+1);x[0]=0,x[1]=Pf(g[0]);let T=x[1],A=2;for(;A!=x.length;++A){const z=g[A-1];T+=z>>>1^-(1&z),x[A]=x[A-1]+T}return x}(o);if(c.logicalLevelTechnique1===Fn.RLE&&c.logicalLevelTechnique2===Fn.NONE)return function(g,x,T){const A=new Int32Array(T+1);A[0]=0;let z=1,B=A[0];for(let G=0;G<x;G++){const W=g[G],Q=g[G+x];for(let ot=z;ot<z+W;ot++)A[ot]=Q+B,B=A[ot];z+=W}return A}(o,c.runs,c.numRleValues);if(c.logicalLevelTechnique1===Fn.NONE&&c.logicalLevelTechnique2===Fn.NONE){(function(x){let T=0;for(let A=0;A<x.length;A++)x[A]+=T,T=x[A]})(o);const g=new Int32Array(c.numValues+1);return g[0]=0,g.set(o,1),g}if(c.logicalLevelTechnique1===Fn.DELTA&&c.logicalLevelTechnique2===Fn.RLE){const g=function(x,T,A){const z=new Int32Array(A+1);z[0]=0;let B=1,G=z[0];for(let W=0;W<T;W++){const Q=x[W];let ot=x[W+T];ot=ot>>>1^-(1&ot);for(let ct=B;ct<B+Q;ct++)z[ct]=ot+G,G=z[ct];B+=Q}return z}(o,c.runs,c.numRleValues);return k_(g),g}throw new Error("Only delta encoding is supported for transforming length to offset streams yet.")}static decodeNullableIntStream(o,c,g,x,T){const A=g.physicalLevelTechnique===ru.FAST_PFOR?xd():ia(o,c,g.numValues);return this.decodeNullableIntBuffer(A,g,x,T)}static decodeNullableLongStream(o,c,g,x,T){const A=hm(o,c,g.numValues);return this.decodeNullableLongBuffer(A,g,x,T)}static decodeNullableIntBuffer(o,c,g,x){switch(c.logicalLevelTechnique1){case Fn.DELTA:return c.logicalLevelTechnique2===Fn.RLE&&(o=L_(o,c.runs,c.numRleValues)),function(T,A){const z=new Int32Array(T.size());let B=0;T.get(0)?(z[0]=T.get(0)?A[0]>>>1^-(1&A[0]):0,B=1):z[0]=0;let G=1;for(;G!=z.length;++G)z[G]=T.get(G)?z[G-1]+(A[B]>>>1^-(1&A[B++])):z[G-1];return z}(x,o);case Fn.RLE:return function(T,A,z,B){const G=A;return z?function(W,Q,ot){const ct=new Int32Array(W.size());let ut=0;for(let xt=0;xt<ot;xt++){const Et=Q[xt];let Vt=Q[xt+ot];Vt=Vt>>>1^-(1&Vt);for(let ue=ut;ue<ut+Et;ue++)W.get(ue)?ct[ue]=Vt:(ct[ue]=0,ut++);ut+=Et}return ct}(B,T,G.runs):function(W,Q,ot){const ct=new Int32Array(W.size());let ut=0;for(let xt=0;xt<ot;xt++){const Et=Q[xt],Vt=Q[xt+ot];for(let ue=ut;ue<ut+Et;ue++)W.get(ue)?ct[ue]=Vt:(ct[ue]=0,ut++);ut+=Et}return ct}(B,T,G.runs)}(o,c,g,x);case Fn.MORTON:return k_(o),o;case Fn.COMPONENTWISE_DELTA:return Jy(o),o;case Fn.NONE:return o=g?function(T,A){const z=new Int32Array(T.size());let B=0,G=0;for(;G!=z.length;++G)if(T.get(G)){const W=A[B++];z[G]=W>>>1^-(1&W)}else z[G]=0;return z}(x,o):function(T,A){const z=new Int32Array(T.size());let B=0,G=0;for(;G!=z.length;++G)z[G]=T.get(G)?A[B++]:0;return z}(x,o),o;default:throw new Error("The specified Logical level technique is not supported")}}static decodeNullableLongBuffer(o,c,g,x){switch(c.logicalLevelTechnique1){case Fn.DELTA:return c.logicalLevelTechnique2===Fn.RLE&&(o=R_(o,c.runs,c.numRleValues)),function(T,A){const z=new BigInt64Array(T.size());let B=0;T.get(0)?(z[0]=T.get(0)?A[0]>>1n^-(1n&A[0]):0n,B=1):z[0]=0n;let G=1;for(;G!=z.length;++G)z[G]=T.get(G)?z[G-1]+(A[B]>>1n^-(1n&A[B++])):z[G-1];return z}(x,o);case Fn.RLE:return function(T,A,z,B){const G=A;return z?function(W,Q,ot){const ct=new BigInt64Array(W.size());let ut=0;for(let xt=0;xt<ot;xt++){const Et=Number(Q[xt]);let Vt=Q[xt+ot];Vt=Vt>>1n^-(1n&Vt);for(let ue=ut;ue<ut+Et;ue++)W.get(ue)?ct[ue]=Vt:(ct[ue]=0n,ut++);ut+=Et}return ct}(B,T,G.runs):function(W,Q,ot){const ct=new BigInt64Array(W.size());let ut=0;for(let xt=0;xt<ot;xt++){const Et=Number(Q[xt]),Vt=Q[xt+ot];for(let ue=ut;ue<ut+Et;ue++)W.get(ue)?ct[ue]=Vt:(ct[ue]=0n,ut++);ut+=Et}return ct}(B,T,G.runs)}(o,c,g,x);case Fn.NONE:return o=g?function(T,A){const z=new BigInt64Array(T.size());let B=0,G=0;for(;G!=z.length;++G)if(T.get(G)){const W=A[B++];z[G]=W>>1n^-(1n&W)}else z[G]=0n;return z}(x,o):function(T,A){const z=new BigInt64Array(T.size());let B=0,G=0;for(;G!=z.length;++G)z[G]=T.get(G)?A[B++]:0n;return z}(x,o),o;default:throw new Error("The specified Logical level technique is not supported")}}static getVectorType(o,c,g,x){const T=o.logicalLevelTechnique1;if(T===Fn.RLE)return o.runs===1?Hs.CONST:Hs.FLAT;const A=c instanceof nu?c.size():c;if(T===Fn.DELTA&&o.logicalLevelTechnique2===Fn.RLE){const z=o.runs,B=2;if(o.numRleValues!==A)return Hs.FLAT;if(z===1)return Hs.SEQUENCE;if(z===2){const G=x.get();let W;if(o.physicalLevelTechnique===ru.VARINT)W=ia(g,x,4);else{const Q=x.get();W=new Int32Array(g.buffer,g.byteOffset+Q,4)}if(x.set(G),W[2]===B&&W[3]===B)return Hs.SEQUENCE}}return o.numValues===1?Hs.CONST:Hs.FLAT}}class F_ extends kg{getValueFromBuffer(o){return this.dataBuffer[o]}}class Ym extends D_{constructor(o,c,g,x){super(o,BigInt64Array.of(c),g,x)}getValueFromBuffer(o){return this.dataBuffer[0]+BigInt(o)*this.delta}}class Ec{constructor(o,c,g){Mi(this,"_geometryOffsets");Mi(this,"_partOffsets");Mi(this,"_ringOffsets");this._geometryOffsets=o,this._partOffsets=c,this._ringOffsets=g}get geometryOffsets(){return this._geometryOffsets}get partOffsets(){return this._partOffsets}get ringOffsets(){return this._ringOffsets}}class Ky{constructor(o,c){Mi(this,"tileExtent");Mi(this,"_numBits");Mi(this,"_coordinateShift");Mi(this,"minBound");Mi(this,"maxBound");this._coordinateShift=o<0?Math.abs(o):0,this.tileExtent=c+this._coordinateShift,this._numBits=Math.ceil(Math.log2(this.tileExtent)),this.minBound=o,this.maxBound=c}validateCoordinates(o){if(o.x<this.minBound||o.y<this.minBound||o.x>this.maxBound||o.y>this.maxBound)throw new Error("The specified tile buffer size is currently not supported.")}numBits(){return this._numBits}coordinateShift(){return this._coordinateShift}}class dm extends Ky{encode(o){this.validateCoordinates(o);const c=o.x+this._coordinateShift,g=o.y+this._coordinateShift;let x=0;for(let T=0;T<this._numBits;T++)x|=(c&1<<T)<<T|(g&1<<T)<<T+1;return x}decode(o){return{x:this.decodeMorton(o)-this._coordinateShift,y:this.decodeMorton(o>>1)-this._coordinateShift}}decodeMorton(o){let c=0;for(let g=0;g<this._numBits;g++)c|=(o&1<<2*g)>>g;return c}static decode(o,c,g){return{x:dm.decodeMorton(o,c)-g,y:dm.decodeMorton(o>>1,c)-g}}static decodeMorton(o,c){let g=0;for(let x=0;x<c;x++)g|=(o&1<<2*x)>>x;return g}}(function(h){h[h.POINT=0]="POINT",h[h.LINESTRING=1]="LINESTRING",h[h.POLYGON=2]="POLYGON",h[h.MULTIPOINT=3]="MULTIPOINT",h[h.MULTILINESTRING=4]="MULTILINESTRING",h[h.MULTIPOLYGON=5]="MULTIPOLYGON"})(ga||(ga={})),function(h){h[h.POINT=0]="POINT",h[h.LINESTRING=1]="LINESTRING",h[h.POLYGON=2]="POLYGON"}(cm||(cm={})),function(h){h[h.MORTON=0]="MORTON",h[h.VEC_2=1]="VEC_2",h[h.VEC_3=2]="VEC_3"}(yh||(yh={}));class sx{createPoint(o){return[[o]]}createMultiPoint(o){return o.map(c=>[c])}createLineString(o){return[o]}createMultiLineString(o){return o}createPolygon(o,c){return[o,...c]}createMultiPolygon(o){return o.flat()}}function Qy(h){const o=new Array(h.numGeometries);let c=1,g=1,x=1,T=0;const A=new sx;let z=0,B=0;const G=h.mortonSettings,W=h.topologyVector,Q=W.geometryOffsets,ot=W.partOffsets,ct=W.ringOffsets,ut=h.vertexOffsets,xt=h.containsPolygonGeometry(),Et=h.vertexBuffer;for(let Vt=0;Vt<h.numGeometries;Vt++){const ue=h.geometryType(Vt);if(ue===ga.POINT){if(ut&&ut.length!==0)if(h.vertexBufferType===yh.VEC_2){const Qt=2*ut[B++],ee=new Le(Et[Qt],Et[Qt+1]);o[T++]=A.createPoint(ee)}else{const Qt=ut[B++],ee=dm.decode(Et[Qt],G.numBits,G.coordinateShift),Se=new Le(ee.x,ee.y);o[T++]=A.createPoint(Se)}else{const Qt=new Le(Et[z++],Et[z++]);o[T++]=A.createPoint(Qt)}Q&&x++,ot&&c++,ct&&g++}else if(ue===ga.MULTIPOINT){const Qt=Q[x]-Q[x-1];x++;const ee=new Array(Qt);if(ut&&ut.length!==0){for(let Se=0;Se<Qt;Se++){const Ee=2*ut[B++];ee[Se]=new Le(Et[Ee],Et[Ee+1])}o[T++]=A.createMultiPoint(ee)}else{for(let Se=0;Se<Qt;Se++){const Ee=Et[z++],ei=Et[z++];ee[Se]=new Le(Ee,ei)}o[T++]=A.createMultiPoint(ee)}}else if(ue===ga.LINESTRING){let Qt,ee=0;xt?(ee=ct[g]-ct[g-1],g++):ee=ot[c]-ot[c-1],c++,ut&&ut.length!==0?(Qt=h.vertexBufferType===yh.VEC_2?O_(Et,ut,B,ee,!1):Cf(Et,ut,B,ee,!1,G),B+=ee):(Qt=B_(Et,z,ee,!1),z+=2*ee),o[T++]=A.createLineString(Qt),Q&&x++}else if(ue===ga.POLYGON){const Qt=ot[c]-ot[c-1];c++;const ee=new Array(Qt-1);let Se=ct[g]-ct[g-1];if(g++,ut&&ut.length!==0){const Ee=h.vertexBufferType===yh.VEC_2?Og(Et,ut,B,Se):Ng(Et,ut,B,Se,0,G);B+=Se;for(let ei=0;ei<ee.length;ei++)Se=ct[g]-ct[g-1],g++,ee[ei]=h.vertexBufferType===yh.VEC_2?Og(Et,ut,B,Se):Ng(Et,ut,B,Se,0,G),B+=Se;o[T++]=A.createPolygon(Ee,ee)}else{const Ee=Bg(Et,z,Se);z+=2*Se;for(let ei=0;ei<ee.length;ei++)Se=ct[g]-ct[g-1],g++,ee[ei]=Bg(Et,z,Se),z+=2*Se;o[T++]=A.createPolygon(Ee,ee)}Q&&x++}else if(ue===ga.MULTILINESTRING){const Qt=Q[x]-Q[x-1];x++;const ee=new Array(Qt);if(ut&&ut.length!==0){for(let Se=0;Se<Qt;Se++){let Ee=0;xt?(Ee=ct[g]-ct[g-1],g++):Ee=ot[c]-ot[c-1],c++;const ei=h.vertexBufferType===yh.VEC_2?O_(Et,ut,B,Ee,!1):Cf(Et,ut,B,Ee,!1,G);ee[Se]=ei,B+=Ee}o[T++]=A.createMultiLineString(ee)}else{for(let Se=0;Se<Qt;Se++){let Ee=0;xt?(Ee=ct[g]-ct[g-1],g++):Ee=ot[c]-ot[c-1],c++,ee[Se]=B_(Et,z,Ee,!1),z+=2*Ee}o[T++]=A.createMultiLineString(ee)}}else{if(ue!==ga.MULTIPOLYGON)throw new Error("The specified geometry type is currently not supported.");{const Qt=Q[x]-Q[x-1];x++;const ee=new Array(Qt);let Se=0;if(ut&&ut.length!==0){for(let Ee=0;Ee<Qt;Ee++){const ei=ot[c]-ot[c-1];c++;const Ii=new Array(ei-1);Se=ct[g]-ct[g-1],g++;const fi=h.vertexBufferType===yh.VEC_2?Og(Et,ut,B,Se):Ng(Et,ut,B,Se,0,G);B+=Se;for(let zi=0;zi<Ii.length;zi++)Se=ct[g]-ct[g-1],g++,Ii[zi]=h.vertexBufferType===yh.VEC_2?Og(Et,ut,B,Se):Ng(Et,ut,B,Se,0,G),B+=Se;ee[Ee]=A.createPolygon(fi,Ii)}o[T++]=A.createMultiPolygon(ee)}else{for(let Ee=0;Ee<Qt;Ee++){const ei=ot[c]-ot[c-1];c++;const Ii=new Array(ei-1);Se=ct[g]-ct[g-1],g++;const fi=Bg(Et,z,Se);z+=2*Se;for(let zi=0;zi<Ii.length;zi++){const Ji=ct[g]-ct[g-1];g++,Ii[zi]=Bg(Et,z,Ji),z+=2*Ji}ee[Ee]=A.createPolygon(fi,Ii)}o[T++]=A.createMultiPolygon(ee)}}}}return o}function Bg(h,o,c){return B_(h,o,c,!0)}function Og(h,o,c,g){return O_(h,o,c,g,!0)}function Ng(h,o,c,g,x,T){return Cf(h,o,c,g,!0,T)}function B_(h,o,c,g){const x=new Array(g?c+1:c);for(let T=0;T<2*c;T+=2)x[T/2]=new Le(h[o+T],h[o+T+1]);return g&&(x[x.length-1]=x[0]),x}function O_(h,o,c,g,x){const T=new Array(x?g+1:g);for(let A=0;A<2*g;A+=2){const z=2*o[c+A/2];T[A/2]=new Le(h[z],h[z+1])}return x&&(T[T.length-1]=T[0]),T}function Cf(h,o,c,g,x,T){const A=new Array(x?g+1:g);for(let z=0;z<g;z++){const B=dm.decode(h[o[c+z]],T.numBits,T.coordinateShift);A[z]=new Le(B.x,B.y)}return x&&(A[A.length-1]=A[0]),A}class N_{constructor(o,c,g,x,T){Mi(this,"_vertexBufferType");Mi(this,"_topologyVector");Mi(this,"_vertexOffsets");Mi(this,"_vertexBuffer");Mi(this,"_mortonSettings");this._vertexBufferType=o,this._topologyVector=c,this._vertexOffsets=g,this._vertexBuffer=x,this._mortonSettings=T}get vertexBufferType(){return this._vertexBufferType}get topologyVector(){return this._topologyVector}get vertexOffsets(){return this._vertexOffsets}get vertexBuffer(){return this._vertexBuffer}*[Symbol.iterator](){const o=Qy(this);let c=0;for(;c<this.numGeometries;)yield{coordinates:o[c],type:this.geometryType(c)},c++}getSimpleEncodedVertex(o){const c=this.vertexOffsets?2*this.vertexOffsets[o]:2*o;return[this.vertexBuffer[c],this.vertexBuffer[c+1]]}getVertex(o){if(this.vertexOffsets&&this.mortonSettings){const g=dm.decode(this.vertexBuffer[this.vertexOffsets[o]],this.mortonSettings.numBits,this.mortonSettings.coordinateShift);return[g.x,g.y]}const c=this.vertexOffsets?2*this.vertexOffsets[o]:2*o;return[this.vertexBuffer[c],this.vertexBuffer[c+1]]}getGeometries(){return Qy(this)}get mortonSettings(){return this._mortonSettings}}class pm extends N_{constructor(c,g,x,T,A,z,B){super(x,T,A,z,B);Mi(this,"_numGeometries");Mi(this,"_geometryType");this._numGeometries=c,this._geometryType=g}static createMortonEncoded(c,g,x,T,A,z){return new pm(c,g,yh.MORTON,x,T,A,z)}static create(c,g,x,T,A){return new pm(c,g,yh.VEC_2,x,T,A)}geometryType(c){return this._geometryType}get numGeometries(){return this._numGeometries}containsPolygonGeometry(){return this._geometryType===ga.POLYGON||this._geometryType===ga.MULTIPOLYGON}containsSingleGeometryType(){return!0}}class Hp extends N_{constructor(c,g,x,T,A,z){super(c,x,T,A,z);Mi(this,"_geometryTypes");this._geometryTypes=g}static createMortonEncoded(c,g,x,T,A){return new Hp(yh.MORTON,c,g,x,T,A)}static create(c,g,x,T){return new Hp(yh.VEC_2,c,g,x,T)}geometryType(c){return this._geometryTypes[c]}get numGeometries(){return this._geometryTypes.length}containsPolygonGeometry(){for(let c=0;c<this.numGeometries;c++)if(this.geometryType(c)===ga.POLYGON||this.geometryType(c)===ga.MULTIPOLYGON)return!0;return!1}containsSingleGeometryType(){return!1}}class V_{constructor(o,c,g,x){Mi(this,"_triangleOffsets");Mi(this,"_indexBuffer");Mi(this,"_vertexBuffer");Mi(this,"_topologyVector");this._triangleOffsets=o,this._indexBuffer=c,this._vertexBuffer=g,this._topologyVector=x}get triangleOffsets(){return this._triangleOffsets}get indexBuffer(){return this._indexBuffer}get vertexBuffer(){return this._vertexBuffer}get topologyVector(){return this._topologyVector}getGeometries(){if(!this._topologyVector)throw new Error("Cannot convert GpuVector to coordinates without topology information");const o=new Array(this.numGeometries),c=this._topologyVector,g=c.partOffsets,x=c.ringOffsets,T=c.geometryOffsets;let A=0,z=1,B=1,G=1;for(let W=0;W<this.numGeometries;W++)switch(this.geometryType(W)){case ga.POLYGON:{const Q=g[z]-g[z-1];z++;const ot=[];for(let ct=0;ct<Q;ct++){const ut=x[B]-x[B-1];B++;const xt=[];for(let Et=0;Et<ut;Et++){const Vt=this._vertexBuffer[A++],ue=this._vertexBuffer[A++];xt.push(new Le(Vt,ue))}xt.length>0&&xt.push(xt[0]),ot.push(xt)}o[W]=ot,T&&G++}break;case ga.MULTIPOLYGON:{const Q=T[G]-T[G-1];G++;const ot=[];for(let ct=0;ct<Q;ct++){const ut=g[z]-g[z-1];z++;for(let xt=0;xt<ut;xt++){const Et=x[B]-x[B-1];B++;const Vt=[];for(let ue=0;ue<Et;ue++){const Qt=this._vertexBuffer[A++],ee=this._vertexBuffer[A++];Vt.push(new Le(Qt,ee))}Vt.length>0&&Vt.push(Vt[0]),ot.push(Vt)}}o[W]=ot}}return o}[Symbol.iterator](){return null}}class fm extends V_{constructor(c,g,x,T,A,z){super(x,T,A,z);Mi(this,"_numGeometries");Mi(this,"_geometryType");this._numGeometries=c,this._geometryType=g}static create(c,g,x,T,A,z){return new fm(c,g,x,T,A,z)}geometryType(c){return this._geometryType}get numGeometries(){return this._numGeometries}containsSingleGeometryType(){return!0}}class Df extends V_{constructor(c,g,x,T,A){super(g,x,T,A);Mi(this,"_geometryTypes");this._geometryTypes=c}static create(c,g,x,T,A){return new Df(c,g,x,T,A)}geometryType(c){return this._geometryTypes[c]}get numGeometries(){return this._geometryTypes.length}containsSingleGeometryType(){return!1}}function t0(h,o,c,g,x){const T=Sl.decode(h,c);let A=null,z=null,B=null,G=null,W=null,Q=null,ot=null,ct=null;if(xn.getVectorType(T,g,h,c)===Hs.CONST){const xt=xn.decodeConstIntStream(h,c,T,!1);for(let Et=0;Et<o-1;Et++){const Vt=Sl.decode(h,c);switch(Vt.physicalStreamType){case ol.LENGTH:switch(Vt.logicalStreamType.lengthType){case Ic.GEOMETRIES:A=xn.decodeLengthStreamToOffsetBuffer(h,c,Vt);break;case Ic.PARTS:z=xn.decodeLengthStreamToOffsetBuffer(h,c,Vt);break;case Ic.RINGS:B=xn.decodeLengthStreamToOffsetBuffer(h,c,Vt);break;case Ic.TRIANGLES:ot=xn.decodeLengthStreamToOffsetBuffer(h,c,Vt)}break;case ol.OFFSET:switch(Vt.logicalStreamType.offsetType){case qp.VERTEX:G=xn.decodeIntStream(h,c,Vt,!1);break;case qp.INDEX:ct=xn.decodeIntStream(h,c,Vt,!1)}break;case ol.DATA:if(Sc.VERTEX===Vt.logicalStreamType.dictionaryType)W=xn.decodeIntStream(h,c,Vt,!0,x);else{const ue=Vt;Q={numBits:ue.numBits(),coordinateShift:ue.coordinateShift()},W=xn.decodeIntStream(h,c,Vt,!1,x)}}}if(ct!==null){if(A!=null||z!=null){const Et=new Ec(A,z,B);return fm.create(g,xt,ot,ct,W,Et)}return fm.create(g,xt,ot,ct,W)}return Q===null?pm.create(g,xt,new Ec(A,z,B),G,W):pm.createMortonEncoded(g,xt,new Ec(A,z,B),G,W,Q)}const ut=xn.decodeIntStream(h,c,T,!1);for(let xt=0;xt<o-1;xt++){const Et=Sl.decode(h,c);switch(Et.physicalStreamType){case ol.LENGTH:switch(Et.logicalStreamType.lengthType){case Ic.GEOMETRIES:A=xn.decodeIntStream(h,c,Et,!1);break;case Ic.PARTS:z=xn.decodeIntStream(h,c,Et,!1);break;case Ic.RINGS:B=xn.decodeIntStream(h,c,Et,!1);break;case Ic.TRIANGLES:ot=xn.decodeLengthStreamToOffsetBuffer(h,c,Et)}break;case ol.OFFSET:switch(Et.logicalStreamType.offsetType){case qp.VERTEX:G=xn.decodeIntStream(h,c,Et,!1);break;case qp.INDEX:ct=xn.decodeIntStream(h,c,Et,!1)}break;case ol.DATA:if(Sc.VERTEX===Et.logicalStreamType.dictionaryType)W=xn.decodeIntStream(h,c,Et,!0,x);else{const Vt=Et;Q={numBits:Vt.numBits(),coordinateShift:Vt.coordinateShift()},W=xn.decodeIntStream(h,c,Et,!1,x)}}}return ct!==null&&z===null?Df.create(ut,ot,ct,W):(A!==null?(A=U_(ut,A,2),z!==null&&B!==null?(z=Vg(ut,A,z,!1),B=function(xt,Et,Vt,ue){const Qt=new Int32Array(Vt[Vt.length-1]+1);let ee=0;Qt[0]=ee;let Se=1,Ee=1,ei=0;for(let Ii=0;Ii<xt.length;Ii++){const fi=xt[Ii],zi=Et[Ii+1]-Et[Ii];if(fi!==0&&fi!==3)for(let Ji=0;Ji<zi;Ji++){const $i=Vt[Se]-Vt[Se-1];Se++;for(let Ui=0;Ui<$i;Ui++)ee=Qt[Ee++]=ee+ue[ei++]}else for(let Ji=0;Ji<zi;Ji++)Qt[Ee++]=++ee,Se++}return Qt}(ut,A,z,B)):z!==null&&(z=function(xt,Et,Vt){const ue=new Int32Array(Et[Et.length-1]+1);let Qt=0;ue[0]=Qt;let ee=1,Se=0;for(let Ee=0;Ee<xt.length;Ee++){const ei=xt[Ee],Ii=Et[Ee+1]-Et[Ee];if(ei===4||ei===1)for(let fi=0;fi<Ii;fi++)Qt=ue[ee++]=Qt+Vt[Se++];else for(let fi=0;fi<Ii;fi++)ue[ee++]=++Qt}return ue}(ut,A,z))):z!==null&&B!==null?(z=U_(ut,z,1),B=Vg(ut,z,B,!0)):z!==null&&(z=U_(ut,z,0)),ct!==null?Df.create(ut,ot,ct,W,new Ec(A,z,B)):Q===null?Hp.create(ut,new Ec(A,z,B),G,W):Hp.createMortonEncoded(ut,new Ec(A,z,B),G,W,Q))}function U_(h,o,c){const g=new Int32Array(h.length+1);let x=0;g[0]=x;let T=0;for(let A=0;A<h.length;A++)x=g[A+1]=x+(h[A]>c?o[T++]:1);return g}function Vg(h,o,c,g){const x=new Int32Array(o[o.length-1]+1);let T=0;x[0]=T;let A=1,z=0;for(let B=0;B<h.length;B++){const G=h[B],W=o[B+1]-o[B];if(G===5||G===2||g&&(G===4||G===1))for(let Q=0;Q<W;Q++)T=x[A++]=T+c[z++];else for(let Q=0;Q<W;Q++)x[A++]=++T}return x}class e0 extends am{constructor(c,g,x){super(c,g.getBuffer(),x);Mi(this,"dataVector");this.dataVector=g}getValueFromBuffer(c){return this.dataVector.get(c)}}class i0 extends kg{getValueFromBuffer(o){return this.dataBuffer[o]}}class Ug extends am{constructor(o,c,g){super(o,BigInt64Array.of(c),g)}getValueFromBuffer(o){return this.dataBuffer[0]}}function j_(h,o,c){for(let g=0;g<h;g++){const x=Sl.decode(o,c);c.add(x.byteLength)}}function mm(h,o,c){return jg(h,Math.ceil(o/8),c)}function jg(h,o,c){const g=new Uint8Array(o);let x=0;for(;x<o;){const T=h[c.increment()];if(T<=127){const A=T+3,z=h[c.increment()],B=x+A;g.fill(z,x,B),x=B}else{const A=256-T;for(let z=0;z<A;z++)g[x++]=h[c.increment()]}}return g}const ax=new TextDecoder;function G_(h,o,c){return c-o>=12?ax.decode(h.subarray(o,c)):function(g,x,T){let A="",z=x;for(;z<T;){const B=g[z];let G,W,Q,ot=null,ct=B>239?4:B>223?3:B>191?2:1;if(z+ct>T)break;ct===1?B<128&&(ot=B):ct===2?(G=g[z+1],(192&G)==128&&(ot=(31&B)<<6|63&G,ot<=127&&(ot=null))):ct===3?(G=g[z+1],W=g[z+2],(192&G)==128&&(192&W)==128&&(ot=(15&B)<<12|(63&G)<<6|63&W,(ot<=2047||ot>=55296&&ot<=57343)&&(ot=null))):ct===4&&(G=g[z+1],W=g[z+2],Q=g[z+3],(192&G)==128&&(192&W)==128&&(192&Q)==128&&(ot=(15&B)<<18|(63&G)<<12|(63&W)<<6|63&Q,(ot<=65535||ot>=1114112)&&(ot=null))),ot===null?(ot=65533,ct=1):ot>65535&&(ot-=65536,A+=String.fromCharCode(ot>>>10&1023|55296),ot=56320|1023&ot),A+=String.fromCharCode(ot),z+=ct}return A}(h,o,c)}class $_ extends am{constructor(c,g,x,T){super(c,x,T);Mi(this,"offsetBuffer");this.offsetBuffer=g}}class r0 extends $_{constructor(c,g,x,T){super(c,g,x,T??g.length-1);Mi(this,"textEncoder");this.textEncoder=new TextEncoder}getValueFromBuffer(c){return G_(this.dataBuffer,this.offsetBuffer[c],this.offsetBuffer[c+1])}}class zf extends $_{constructor(c,g,x,T,A){super(c,x,T,A??g.length);Mi(this,"indexBuffer");Mi(this,"textEncoder");this.indexBuffer=g,this.indexBuffer=g,this.textEncoder=new TextEncoder}getValueFromBuffer(c){const g=this.indexBuffer[c];return G_(this.dataBuffer,this.offsetBuffer[g],this.offsetBuffer[g+1])}}class Qd extends $_{constructor(c,g,x,T,A,z,B){super(c,x,T,B);Mi(this,"indexBuffer");Mi(this,"symbolOffsetBuffer");Mi(this,"symbolTableBuffer");Mi(this,"textEncoder");Mi(this,"symbolLengthBuffer");Mi(this,"lengthBuffer");Mi(this,"decodedDictionary");this.indexBuffer=g,this.symbolOffsetBuffer=A,this.symbolTableBuffer=z,this.textEncoder=new TextEncoder}getValueFromBuffer(c){this.decodedDictionary==null&&(this.symbolLengthBuffer==null&&(this.symbolLengthBuffer=this.offsetToLengthBuffer(this.symbolOffsetBuffer),this.lengthBuffer=this.offsetToLengthBuffer(this.offsetBuffer)),this.decodedDictionary=function(x,T,A){const z=[],B=new Array(T.length).fill(0);for(let G=1;G<T.length;G++)B[G]=B[G-1]+T[G-1];for(let G=0;G<A.length;G++)if(A[G]===255)z.push(A[++G]);else{const W=T[A[G]],Q=B[A[G]];for(let ot=0;ot<W;ot++)z.push(x[Q+ot])}return new Uint8Array(z)}(this.symbolTableBuffer,this.symbolLengthBuffer,this.dataBuffer));const g=this.indexBuffer[c];return G_(this.decodedDictionary,this.offsetBuffer[g],this.offsetBuffer[g+1])}offsetToLengthBuffer(c){const g=new Uint32Array(c.length-1);let x=c[0];for(let T=1;T<c.length;T++){const A=c[T];g[T-1]=A-x,x=A}return g}}const Kp=class Kp{constructor(){}static decode(o,c,g,x,T){let A=null,z=null,B=null,G=null,W=null,Q=null,ot=null,ct=null;for(let ut=0;ut<x;ut++){const xt=Sl.decode(c,g);if(xt.byteLength!==0)switch(xt.physicalStreamType){case ol.PRESENT:{const Et=mm(c,xt.numValues,g);Q=new nu(Et,xt.numValues);break}case ol.OFFSET:z=T!=null||Q!=null?xn.decodeNullableIntStream(c,g,xt,!1,T??Q):xn.decodeIntStream(c,g,xt,!1);break;case ol.LENGTH:{const Et=xn.decodeLengthStreamToOffsetBuffer(c,g,xt);Ic.DICTIONARY===xt.logicalStreamType.lengthType?A=Et:Ic.SYMBOL===xt.logicalStreamType.lengthType?G=Et:ot=Et;break}case ol.DATA:{const Et=c.subarray(g.get(),g.get()+xt.byteLength);g.add(xt.byteLength);const Vt=xt.logicalStreamType.dictionaryType;Sc.FSST===Vt?W=Et:Sc.SINGLE===Vt||Sc.SHARED===Vt?B=Et:Sc.NONE===Vt&&(ct=Et);break}}}return this.decodeFsstDictionaryVector(o,W,z,A,B,G,T??Q)??this.decodeDictionaryVector(o,B,z,A,T??Q)??this.decodePlainStringVector(o,ot,ct,z,T??Q)}static decodeFsstDictionaryVector(o,c,g,x,T,A,z){return c?new Qd(o,g,x,T,A,c,z):null}static decodeDictionaryVector(o,c,g,x,T){return c?T?new zf(o,g,x,c,T):new zf(o,g,x,c):null}static decodePlainStringVector(o,c,g,x,T){if(!c||!g)return null;if(x)return T?new zf(o,x,c,g,T):new zf(o,x,c,g);if(T&&T.size()!==c.length-1){const A=new Int32Array(T.size());let z=0;for(let B=0;B<T.size();B++)A[B]=T.get(B)?z++:0;return new zf(o,A,c,g,T)}return T?new r0(o,c,g,T):new r0(o,c,g)}static decodeSharedDictionary(o,c,g,x,T){let A=null,z=null,B=null,G=null,W=!1;for(;!W;){const ut=Sl.decode(o,c);switch(ut.physicalStreamType){case ol.LENGTH:Ic.DICTIONARY===ut.logicalStreamType.lengthType?A=xn.decodeLengthStreamToOffsetBuffer(o,c,ut):B=xn.decodeLengthStreamToOffsetBuffer(o,c,ut);break;case ol.DATA:Sc.SINGLE===ut.logicalStreamType.dictionaryType||Sc.SHARED===ut.logicalStreamType.dictionaryType?(z=o.subarray(c.get(),c.get()+ut.byteLength),W=!0):G=o.subarray(c.get(),c.get()+ut.byteLength),c.add(ut.byteLength)}}const Q=g.complexType.children,ot=[];let ct=0;for(const ut of Q){const xt=ia(o,c,1)[0];if(xt==0)continue;const Et=`${g.name}${ut.name===Kp.ROOT_COLUMN_NAME?"":Kp.NESTED_COLUMN_SEPARATOR+ut.name}`;if(T&&!T.has(Et)){j_(xt,o,c);continue}if(xt!==2||ut.type!=="scalarField"||ut.scalarField.physicalType!==9)throw new Error("Currently only optional string fields are implemented for a struct.");const Vt=Sl.decode(o,c),ue=mm(o,Vt.numValues,c),Qt=Sl.decode(o,c),ee=(Qt instanceof Mf?Qt.numRleValues:Qt.numValues)!==x?xn.decodeNullableIntStream(o,c,Qt,!1,new nu(ue,Vt.numValues)):xn.decodeIntStream(o,c,Qt,!1);ot[ct++]=G?new Qd(Et,ee,A,z,B,G,new nu(ue,Vt.numValues)):new zf(Et,ee,A,z,new nu(ue,Vt.numValues))}return ot}};Mi(Kp,"ROOT_COLUMN_NAME","default"),Mi(Kp,"NESTED_COLUMN_SEPARATOR",":");let Jm=Kp;function n0(h,o,c,g,x,T){return c.type==="scalarType"?function(A,z,B,G,W,Q){let ot=null,ct=0;if(A===0)return null;if(Q.nullable){const xt=Sl.decode(z,B);ct=xt.numValues;const Et=B.get(),Vt=mm(z,ct,B);B.set(Et+xt.byteLength),ot=new nu(Vt,xt.numValues)}const ut=ot??G;switch(W.physicalType){case 4:case 3:return function(xt,Et,Vt,ue,Qt){const ee=Sl.decode(xt,Et),Se=xn.getVectorType(ee,Qt,xt,Et),Ee=ue.physicalType===3;if(Se===Hs.FLAT){const ei=tp(Qt)?xn.decodeNullableIntStream(xt,Et,ee,Ee,Qt):xn.decodeIntStream(xt,Et,ee,Ee);return new Wm(Vt.name,ei,Qt)}if(Se===Hs.SEQUENCE){const ei=xn.decodeSequenceIntStream(xt,Et,ee);return new Af(Vt.name,ei[0],ei[1],ee.numRleValues)}{const ei=xn.decodeConstIntStream(xt,Et,ee,Ee);return new z_(Vt.name,ei,Qt)}}(z,B,Q,W,ut);case 9:return Jm.decode(Q.name,z,B,Q.nullable?A-1:A,ot);case 0:return function(xt,Et,Vt,ue,Qt){const ee=Sl.decode(xt,Et),Se=ee.numValues,Ee=Et.get(),ei=tp(Qt)?function(fi,zi,Ji,$i){const Ui=jg(fi,Math.ceil(zi/8),Ji),_i=new nu(Ui,zi),kr=$i.size(),Ar=new nu(new Uint8Array(kr),kr);let Nr=0;for(let yr=0;yr<$i.size();yr++){const Bn=!!$i.get(yr)&&_i.get(Nr++);Ar.set(yr,Bn)}return Ar.getBuffer()}(xt,Se,Et,Qt):mm(xt,Se,Et);Et.set(Ee+ee.byteLength);const Ii=new nu(ei,Se);return new e0(Vt.name,Ii,Qt)}(z,B,Q,0,ut);case 6:case 5:return function(xt,Et,Vt,ue,Qt){const ee=Sl.decode(xt,Et),Se=xn.getVectorType(ee,ue,xt,Et),Ee=Qt.physicalType===5;if(Se===Hs.FLAT){const ei=tp(ue)?xn.decodeNullableLongStream(xt,Et,ee,Ee,ue):xn.decodeLongStream(xt,Et,ee,Ee);return new F_(Vt.name,ei,ue)}if(Se===Hs.SEQUENCE){const ei=xn.decodeSequenceLongStream(xt,Et,ee);return new Ym(Vt.name,ei[0],ei[1],ee.numRleValues)}{const ei=xn.decodeConstLongStream(xt,Et,ee,Ee);return new Ug(Vt.name,ei,ue)}}(z,B,Q,ut,W);case 7:return function(xt,Et,Vt,ue){const Qt=Sl.decode(xt,Et),ee=tp(ue)?function(Se,Ee,ei,Ii){const fi=Ee.get(),zi=fi+Ii*Float32Array.BYTES_PER_ELEMENT,Ji=new Uint8Array(Se.subarray(fi,zi)).buffer,$i=new Float32Array(Ji);Ee.set(zi);const Ui=ei.size(),_i=new Float32Array(Ui);let kr=0;for(let Ar=0;Ar<Ui;Ar++)_i[Ar]=ei.get(Ar)?$i[kr++]:0;return _i}(xt,Et,ue,Qt.numValues):function(Se,Ee,ei){const Ii=Ee.get(),fi=Ii+ei*Float32Array.BYTES_PER_ELEMENT,zi=new Uint8Array(Se.subarray(Ii,fi)).buffer,Ji=new Float32Array(zi);return Ee.set(fi),Ji}(xt,Et,Qt.numValues);return new i0(Vt.name,ee,ue)}(z,B,Q,ut);case 8:return function(xt,Et,Vt,ue){const Qt=Sl.decode(xt,Et),ee=tp(ue)?function(Se,Ee,ei,Ii){const fi=Ee.get(),zi=fi+Ii*Float64Array.BYTES_PER_ELEMENT,Ji=new Uint8Array(Se.subarray(fi,zi)).buffer,$i=new Float64Array(Ji);Ee.set(zi);const Ui=ei.size(),_i=new Float64Array(Ui);let kr=0;for(let Ar=0;Ar<Ui;Ar++)_i[Ar]=ei.get(Ar)?$i[kr++]:0;return _i}(xt,Et,ue,Qt.numValues):function(Se,Ee,ei){const Ii=Ee.get(),fi=Ii+ei*Float64Array.BYTES_PER_ELEMENT,zi=new Uint8Array(Se.subarray(Ii,fi)).buffer,Ji=new Float64Array(zi);return Ee.set(fi),Ji}(xt,Et,Qt.numValues);return new C_(Vt.name,ee,ue)}(z,B,Q,ut);default:throw new Error(`The specified data type for the field is currently not supported: ${W}`)}}(g,h,o,x,c.scalarType,c):g!=1?null:Jm.decodeSharedDictionary(h,o,c,x,T)}function tp(h){return h instanceof nu}class Wp{static decodeColumnType(o){switch(o){case 0:case 1:case 2:case 3:{const c={};c.nullable=!!(1&o),c.columnScope=0;const g={};return g.physicalType=o>1?6:4,g.type="physicalType",c.scalarType=g,c.type="scalarType",c}case 4:{const c={nullable:!1,columnScope:0},g={type:"physicalType",physicalType:0};return c.type="complexType",c.complexType=g,c}case 30:{const c={nullable:!1,columnScope:0},g={type:"physicalType",physicalType:1};return c.type="complexType",c.complexType=g,c}default:return this.mapScalarType(o)}}static columnTypeHasName(o){return o>=10}static columnTypeHasChildren(o){return o===30}static hasStreamCount(o){if(o.name==="id")return!1;if(o.type==="scalarType"){const c=o.scalarType;if(c.type==="physicalType")switch(c.physicalType){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:default:return!1;case 9:return!0}else if(c.type==="logicalType")return!1}else if(o.type==="complexType"){const c=o.complexType;if(c.type==="physicalType")switch(c.physicalType){case 0:case 1:return!0;default:return!1}}return console.warn("Unexpected column type in hasStreamCount",o),!1}static mapScalarType(o){let c=null;switch(o){case 10:case 11:c=0;break;case 12:case 13:c=1;break;case 14:case 15:c=2;break;case 16:case 17:c=3;break;case 18:case 19:c=4;break;case 20:case 21:c=5;break;case 22:case 23:c=6;break;case 24:case 25:c=7;break;case 26:case 27:c=8;break;case 28:case 29:c=9;break;default:return null}const g={};g.nullable=!!(1&o),g.columnScope=0;const x={type:"physicalType"};return x.physicalType=c,g.type="scalarType",g.scalarType=x,g}}const Gg=new TextDecoder;function gm(h,o){const c=ia(h,o,1)[0];if(c===0)return"";const g=o.get(),x=h.subarray(g,g+c);return o.add(c),Gg.decode(x)}function q_(h,o){const c=ia(h,o,1)[0]>>>0,g=!!(4&c),x=!!(2&c),T=ia(h,o,1)[0]>>>0,A={};if(1&c&&(A.nullable=!0),x){const z={};if(g?(z.type="logicalType",z.logicalType=T):(z.type="physicalType",z.physicalType=T),8&c){const B=ia(h,o,1)[0]>>>0;z.children=new Array(B);for(let G=0;G<B;G++)z.children[G]=q_(h,o)}A.type="complexField",A.complexField=z}else{const z={};g?(z.type="logicalType",z.logicalType=T):(z.type="physicalType",z.physicalType=T),A.type="scalarField",A.scalarField=z}return A}function o0(h,o){const c=ia(h,o,1)[0]>>>0,g=Wp.decodeColumnType(c);if(!g)throw new Error(`Unsupported column type code: ${c}`);if(Wp.columnTypeHasName(c)?g.name=gm(h,o):c>=0&&c<=3?g.name="id":c===4&&(g.name="geometry"),Wp.columnTypeHasChildren(c)){const x=ia(h,o,1)[0]>>>0,T=g.complexType;T.children=new Array(x);for(let A=0;A<x;A++)T.children[A]=q_(h,o)}return g}function s0(h,o){const c={featureTables:[]},g={};g.name=gm(h,o);const x=ia(h,o,1)[0]>>>0,T=ia(h,o,1)[0]>>>0;g.columns=new Array(T);for(let A=0;A<T;A++)g.columns[A]=o0(h,o);return c.featureTables.push(g),[c,x]}function a0(h,o,c,g,x,T,A=!1){const z=o.scalarType.physicalType,B=xn.getVectorType(x,T,h,c);if(z===4)switch(B){case Hs.FLAT:{const G=xn.decodeIntStream(h,c,x,!1);return new Wm(g,G,T)}case Hs.SEQUENCE:{const G=xn.decodeSequenceIntStream(h,c,x);return new Af(g,G[0],G[1],x.numRleValues)}case Hs.CONST:{const G=xn.decodeConstIntStream(h,c,x,!1);return new z_(g,G,T)}}else switch(B){case Hs.FLAT:{if(A){const W=xn.decodeLongFloat64Stream(h,c,x,!1);return new C_(g,W,T)}const G=xn.decodeLongStream(h,c,x,!1);return new F_(g,G,T)}case Hs.SEQUENCE:{const G=xn.decodeSequenceLongStream(h,c,x);return new Ym(g,G[0],G[1],x.numRleValues)}case Hs.CONST:{const G=xn.decodeConstLongStream(h,c,x,!1);return new Ug(g,G,T)}}throw new Error("Vector type not supported for id column.")}class lx{constructor(o,c){var g;switch(this._featureData=o,this.properties=this._featureData.properties||{},(g=this._featureData.geometry)===null||g===void 0?void 0:g.type){case ga.POINT:case ga.MULTIPOINT:this.type=1;break;case ga.LINESTRING:case ga.MULTILINESTRING:this.type=2;break;case ga.POLYGON:case ga.MULTIPOLYGON:this.type=3;break;default:this.type=0}this.extent=c,this.id=Number(this._featureData.id)}projectPoint(o,c,g,x){return[360*(o.x+c)/x-180,360/Math.PI*Math.atan(Math.exp((1-2*(o.y+g)/x)*Math.PI))-90]}projectLine(o,c,g,x){return o.map(T=>this.projectPoint(T,c,g,x))}toGeoJSON(o,c,g){const x=this.extent*Math.pow(2,g),T=this.extent*o,A=this.extent*c,z=this.loadGeometry();let B;switch(this.type){case 1:{const W=[];for(const ot of z)W.push(ot[0]);const Q=this.projectLine(W,T,A,x);B=W.length===1?{type:"Point",coordinates:Q[0]}:{type:"MultiPoint",coordinates:Q};break}case 2:{const W=z.map(Q=>this.projectLine(Q,T,A,x));B=W.length===1?{type:"LineString",coordinates:W[0]}:{type:"MultiLineString",coordinates:W};break}case 3:{const W=ih(z),Q=[];for(const ot of W)Q.push(ot.map(ct=>this.projectLine(ct,T,A,x)));B=Q.length===1?{type:"Polygon",coordinates:Q[0]}:{type:"MultiPolygon",coordinates:Q};break}default:throw new Error(`unknown feature type: ${this.type}`)}const G={type:"Feature",geometry:B,properties:this.properties};return this.id!=null&&(G.id=this.id),G}loadGeometry(){const o=[];for(const c of this._featureData.geometry.coordinates){const g=[];for(const x of c)g.push(new Le(x.x,x.y));o.push(g)}return o}bbox(){return[0,0,0,0]}}class cx{constructor(o){this.features=[],this.featureTable=o,this.name=o.name,this.extent=o.extent,this.version=2,this.features=o.getFeatures(),this.length=this.features.length}feature(o){return new lx(this.features[o],this.extent)}}class $g{constructor(o){this.layers={};const c=function(g,x,T=!0){const A=new lm(0),z=[];for(;A.get()<g.length;){const B=ia(g,A,1)[0]>>>0,G=A.get()+B;if(G>g.length)throw new Error(`Block overruns tile: ${G} > ${g.length}`);if(ia(g,A,1)[0]>>>0!=1){A.set(G);continue}const W=s0(g,A),Q=W[1],ot=W[0].featureTables[0];let ct=null,ut=null;const xt=[];let Et=0;for(const ue of ot.columns){const Qt=ue.name;if(Qt==="id"){let ee=null;if(ue.nullable){const Ee=Sl.decode(g,A),ei=A.get(),Ii=mm(g,Ee.numValues,A);A.set(ei+Ee.byteLength),ee=new nu(Ii,Ee.numValues)}const Se=Sl.decode(g,A);Et=Se.getDecompressedCount(),ct=a0(g,ue,A,Qt,Se,ee??Et,T)}else if(Qt==="geometry"){const ee=ia(g,A,1)[0];if(Et===0){const Se=A.get();Et=Sl.decode(g,A).getDecompressedCount(),A.set(Se)}ut=t0(g,ee,A,Et,x)}else{const ee=Wp.hasStreamCount(ue)?ia(g,A,1)[0]:1;if(ee===0&&ue.type==="scalarType")continue;const Se=n0(g,A,ue,ee,Et,void 0);Se&&(Array.isArray(Se)?xt.push(...Se):xt.push(Se))}}const Vt=new ea(ot.name,ut,ct,xt,Q);z.push(Vt),A.set(G)}return z}(new Uint8Array(o));this.layers=c.reduce((g,x)=>Object.assign(Object.assign({},g),{[x.name]:new cx(x)}),{})}}class bd{constructor(){this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0}extend(o){return this.minX=Math.min(this.minX,o.x),this.minY=Math.min(this.minY,o.y),this.maxX=Math.max(this.maxX,o.x),this.maxY=Math.max(this.maxY,o.y),this}expandBy(o){return this.minX-=o,this.minY-=o,this.maxX+=o,this.maxY+=o,(this.minX>this.maxX||this.minY>this.maxY)&&(this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0),this}shrinkBy(o){return this.expandBy(-o)}map(o){const c=new bd;return c.extend(o(new Le(this.minX,this.minY))),c.extend(o(new Le(this.maxX,this.minY))),c.extend(o(new Le(this.minX,this.maxY))),c.extend(o(new Le(this.maxX,this.maxY))),c}static fromPoints(o){const c=new bd;for(const g of o)c.extend(g);return c}contains(o){return o.x>=this.minX&&o.x<=this.maxX&&o.y>=this.minY&&o.y<=this.maxY}empty(){return this.minX>this.maxX}width(){return this.maxX-this.minX}height(){return this.maxY-this.minY}covers(o){return!this.empty()&&!o.empty()&&o.minX>=this.minX&&o.maxX<=this.maxX&&o.minY>=this.minY&&o.maxY<=this.maxY}intersects(o){return!this.empty()&&!o.empty()&&o.minX<=this.maxX&&o.maxX>=this.minX&&o.minY<=this.maxY&&o.maxY>=this.minY}}const qg="_geojsonTileLayer";class l0{constructor(o,c){this.tileID=o,this.x=o.canonical.x,this.y=o.canonical.y,this.z=o.canonical.z,this.grid=new rd(zn,16,0),this.grid3D=new rd(zn,16,0),this.featureIndexArray=new Kt,this.promoteId=c}insert(o,c,g,x,T,A){const z=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(g,x,T);const B=A?this.grid3D:this.grid;for(let G=0;G<c.length;G++){const W=c[G],Q=[1/0,1/0,-1/0,-1/0];for(let ot=0;ot<W.length;ot++){const ct=W[ot];Q[0]=Math.min(Q[0],ct.x),Q[1]=Math.min(Q[1],ct.y),Q[2]=Math.max(Q[2],ct.x),Q[3]=Math.max(Q[3],ct.y)}Q[0]<zn&&Q[1]<zn&&Q[2]>=0&&Q[3]>=0&&B.insert(z,Q[0],Q[1],Q[2],Q[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=this.encoding!=="mlt"?new Oe(new Ls(this.rawTileData)).layers:new $g(this.rawTileData).layers,this.sourceLayerCoder=new Hy(this.vtLayers?Object.keys(this.vtLayers).sort():[qg])),this.vtLayers}query(o,c,g,x){this.loadVTLayers();const T=o.params,A=zn/o.tileSize/o.scale,z=Ld(T.filter,T.globalState),B=o.queryGeometry,G=o.queryPadding*A,W=bd.fromPoints(B),Q=this.grid.query(W.minX-G,W.minY-G,W.maxX+G,W.maxY+G),ot=bd.fromPoints(o.cameraQueryGeometry).expandBy(G),ct=this.grid3D.query(ot.minX,ot.minY,ot.maxX,ot.maxY,(Et,Vt,ue,Qt)=>function(ee,Se,Ee,ei,Ii){for(const zi of ee)if(Se<=zi.x&&Ee<=zi.y&&ei>=zi.x&&Ii>=zi.y)return!0;const fi=[new Le(Se,Ee),new Le(Se,Ii),new Le(ei,Ii),new Le(ei,Ee)];if(ee.length>2){for(const zi of fi)if(pd(ee,zi))return!0}for(let zi=0;zi<ee.length-1;zi++)if(gg(ee[zi],ee[zi+1],fi))return!0;return!1}(o.cameraQueryGeometry,Et-G,Vt-G,ue+G,Qt+G));for(const Et of ct)Q.push(Et);Q.sort(H_);const ut={};let xt;for(let Et=0;Et<Q.length;Et++){const Vt=Q[Et];if(Vt===xt)continue;xt=Vt;const ue=this.featureIndexArray.get(Vt);let Qt=null;this.loadMatchingFeature(ut,ue.bucketIndex,ue.sourceLayerIndex,ue.featureIndex,z,T.layers,T.availableImages,c,g,x,(ee,Se,Ee)=>(Qt||(Qt=Ul(ee)),Se.queryIntersectsFeature({queryGeometry:B,feature:ee,featureState:Ee,geometry:Qt,zoom:this.z,transform:o.transform,pixelsToTileUnits:A,pixelPosMatrix:o.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:o.getElevation})))}return ut}loadMatchingFeature(o,c,g,x,T,A,z,B,G,W,Q){const ot=this.bucketLayerIDs[c];if(A&&!ot.some(Et=>A.has(Et)))return;const ct=this.sourceLayerCoder.decode(g),ut=this.vtLayers[ct].feature(x);if(T.needGeometry){const Et=yc(ut,!0);if(!T.filter(new wo(this.tileID.overscaledZ),Et,this.tileID.canonical))return}else if(!T.filter(new wo(this.tileID.overscaledZ),ut))return;const xt=this.getId(ut,ct);for(let Et=0;Et<ot.length;Et++){const Vt=ot[Et];if(A&&!A.has(Vt))continue;const ue=B[Vt];if(!ue)continue;let Qt={};xt&&W&&(Qt=W.getState(ue.sourceLayer||qg,xt));const ee=qr({},G[Vt]);ee.paint=Z_(ee.paint,ue.paint,ut,Qt,z),ee.layout=Z_(ee.layout,ue.layout,ut,Qt,z);const Se=!Q||Q(ut,ue,Qt);if(!Se)continue;const Ee=new Wy(ut,this.z,this.x,this.y,xt);Ee.layer=ee;let ei=o[Vt];ei===void 0&&(ei=o[Vt]=[]),ei.push({featureIndex:x,feature:Ee,intersectionZ:Se})}}lookupSymbolFeatures(o,c,g,x,T,A,z,B){const G={};this.loadVTLayers();const W=Ld(T.filterSpec,T.globalState);for(const Q of o)this.loadMatchingFeature(G,g,x,Q,W,A,z,B,c);return G}hasLayer(o){for(const c of this.bucketLayerIDs)for(const g of c)if(o===g)return!0;return!1}getId(o,c){var g;let x=o.id;return this.promoteId&&(x=o.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[c]],typeof x=="boolean"&&(x=Number(x)),x===void 0&&(!((g=o.properties)===null||g===void 0)&&g.cluster)&&this.promoteId&&(x=Number(o.properties.cluster_id))),x}}function Z_(h,o,c,g,x){return Xr(h,(T,A)=>{const z=o instanceof Wh?o.get(A):null;return z&&z.evaluate?z.evaluate(c,g,x):z})}function H_(h,o){return o-h}function W_(h,o,c,g,x){const T=[];for(let A=0;A<h.length;A++){const z=h[A];let B;for(let G=0;G<z.length-1;G++){let W=z[G],Q=z[G+1];W.x<o&&Q.x<o||(W.x<o?W=new Le(o,W.y+(o-W.x)/(Q.x-W.x)*(Q.y-W.y))._round():Q.x<o&&(Q=new Le(o,W.y+(o-W.x)/(Q.x-W.x)*(Q.y-W.y))._round()),W.y<c&&Q.y<c||(W.y<c?W=new Le(W.x+(c-W.y)/(Q.y-W.y)*(Q.x-W.x),c)._round():Q.y<c&&(Q=new Le(W.x+(c-W.y)/(Q.y-W.y)*(Q.x-W.x),c)._round()),W.x>=g&&Q.x>=g||(W.x>=g?W=new Le(g,W.y+(g-W.x)/(Q.x-W.x)*(Q.y-W.y))._round():Q.x>=g&&(Q=new Le(g,W.y+(g-W.x)/(Q.x-W.x)*(Q.y-W.y))._round()),W.y>=x&&Q.y>=x||(W.y>=x?W=new Le(W.x+(x-W.y)/(Q.y-W.y)*(Q.x-W.x),x)._round():Q.y>=x&&(Q=new Le(W.x+(x-W.y)/(Q.y-W.y)*(Q.x-W.x),x)._round()),B&&W.equals(B[B.length-1])||(B=[W],T.push(B)),B.push(Q)))))}}return T}function X_(h,o,c,g,x){switch(o){case 1:return function(T,A,z,B){const G=[];for(const W of T)for(const Q of W){const ot=B===0?Q.x:Q.y;ot>=A&&ot<=z&&G.push([Q])}return G}(h,c,g,x);case 2:return Y_(h,c,g,x,!1);case 3:return Y_(h,c,g,x,!0)}return[]}function c0(h,o,c,g,x){const T=g===0?h0:hx;let A=[];const z=[];for(let W=0;W<h.length-1;W++){const Q=h[W],ot=h[W+1],ct=g===0?Q.x:Q.y,ut=g===0?ot.x:ot.y;let xt=!1;ct<o?ut>o&&A.push(T(Q,ot,o)):ct>c?ut<c&&A.push(T(Q,ot,c)):A.push(Q),ut<o&&ct>=o&&(A.push(T(Q,ot,o)),xt=!0),ut>c&&ct<=c&&(A.push(T(Q,ot,c)),xt=!0),!x&&xt&&(z.push(A),A=[])}const B=h.length-1,G=g===0?h[B].x:h[B].y;return G>=o&&G<=c&&A.push(h[B]),x&&A.length>0&&!A[0].equals(A[A.length-1])&&A.push(new Le(A[0].x,A[0].y)),A.length>0&&z.push(A),z}function Y_(h,o,c,g,x){const T=[];for(const A of h){const z=c0(A,o,c,g,x);z.length>0&&T.push(...z)}return T}function h0(h,o,c){return new Le(c,h.y+(c-h.x)/(o.x-h.x)*(o.y-h.y))}function hx(h,o,c){return new Le(h.x+(c-h.y)/(o.y-h.y)*(o.x-h.x),c)}ir("FeatureIndex",l0,{omit:["rawTileData","sourceLayerCoder"]});class ep extends Le{constructor(o,c,g,x){super(o,c),this.angle=g,x!==void 0&&(this.segment=x)}clone(){return new ep(this.x,this.y,this.angle,this.segment)}}function J_(h,o,c,g,x){if(o.segment===void 0||c===0)return!0;let T=o,A=o.segment+1,z=0;for(;z>-c/2;){if(A--,A<0)return!1;z-=h[A].dist(T),T=h[A]}z+=h[A].dist(h[A+1]),A++;const B=[];let G=0;for(;z<c/2;){const W=h[A],Q=h[A+1];if(!Q)return!1;let ot=h[A-1].angleTo(W)-W.angleTo(Q);for(ot=Math.abs((ot+3*Math.PI)%(2*Math.PI)-Math.PI),B.push({distance:z,angleDelta:ot}),G+=ot;z-B[0].distance>g;)G-=B.shift().angleDelta;if(G>x)return!1;A++,z+=W.dist(Q)}return!0}function Xp(h){let o=0;for(let c=0;c<h.length-1;c++)o+=h[c].dist(h[c+1]);return o}function K_(h,o,c){return h?.6*o*c:0}function Q_(h,o){return Math.max(h?h.right-h.left:0,o?o.right-o.left:0)}function u0(h,o,c,g,x,T){const A=K_(c,x,T),z=Q_(c,g)*T;let B=0;const G=Xp(h)/2;for(let W=0;W<h.length-1;W++){const Q=h[W],ot=h[W+1],ct=Q.dist(ot);if(B+ct>G){const ut=(G-B)/ct,xt=el.number(Q.x,ot.x,ut),Et=el.number(Q.y,ot.y,ut),Vt=new ep(xt,Et,ot.angleTo(Q),W);return Vt._round(),!A||J_(h,Vt,z,A,o)?Vt:void 0}B+=ct}}function Zg(h,o,c,g,x,T,A,z,B){const G=K_(g,T,A),W=Q_(g,x),Q=W*A,ot=h[0].x===0||h[0].x===B||h[0].y===0||h[0].y===B;return o-Q<o/4&&(o=Q+o/4),d0(h,ot?o/2*z%o:(W/2+2*T)*A*z%o,o,G,c,Q,ot,!1,B)}function d0(h,o,c,g,x,T,A,z,B){const G=T/2,W=Xp(h);let Q=0,ot=o-c,ct=[];for(let ut=0;ut<h.length-1;ut++){const xt=h[ut],Et=h[ut+1],Vt=xt.dist(Et),ue=Et.angleTo(xt);for(;ot+c<Q+Vt;){ot+=c;const Qt=(ot-Q)/Vt,ee=el.number(xt.x,Et.x,Qt),Se=el.number(xt.y,Et.y,Qt);if(ee>=0&&ee<B&&Se>=0&&Se<B&&ot-G>=0&&ot+G<=W){const Ee=new ep(ee,Se,ue,ut);Ee._round(),g&&!J_(h,Ee,T,g,x)||ct.push(Ee)}}Q+=Vt}return z||ct.length||A||(ct=d0(h,Q/2,c,g,x,T,A,!0,B)),ct}function ty(h,o,c,g){const x=[],T=h.image,A=T.pixelRatio,z=T.paddedRect.w-2,B=T.paddedRect.h-2;let G={x1:h.left,y1:h.top,x2:h.right,y2:h.bottom};const W=T.stretchX||[[0,z]],Q=T.stretchY||[[0,B]],ot=(_i,kr)=>_i+kr[1]-kr[0],ct=W.reduce(ot,0),ut=Q.reduce(ot,0),xt=z-ct,Et=B-ut;let Vt=0,ue=ct,Qt=0,ee=ut,Se=0,Ee=xt,ei=0,Ii=Et;if(T.content&&g){const _i=T.content,kr=_i[2]-_i[0],Ar=_i[3]-_i[1];(T.textFitWidth||T.textFitHeight)&&(G=$m(h)),Vt=Yp(W,0,_i[0]),Qt=Yp(Q,0,_i[1]),ue=Yp(W,_i[0],_i[2]),ee=Yp(Q,_i[1],_i[3]),Se=_i[0]-Vt,ei=_i[1]-Qt,Ee=kr-ue,Ii=Ar-ee}const fi=G.x1,zi=G.y1,Ji=G.x2-fi,$i=G.y2-zi,Ui=(_i,kr,Ar,Nr)=>{const yr=Km(_i.stretch-Vt,ue,Ji,fi),Bn=Qm(_i.fixed-Se,Ee,_i.stretch,ct),ts=Km(kr.stretch-Qt,ee,$i,zi),_a=Qm(kr.fixed-ei,Ii,kr.stretch,ut),Ga=Km(Ar.stretch-Vt,ue,Ji,fi),Ac=Qm(Ar.fixed-Se,Ee,Ar.stretch,ct),Il=Km(Nr.stretch-Qt,ee,$i,zi),Rs=Qm(Nr.fixed-ei,Ii,Nr.stretch,ut),$a=new Le(yr,ts),Ws=new Le(Ga,ts),qa=new Le(Ga,Il),jl=new Le(yr,Il),Gl=new Le(Bn/A,_a/A),Pc=new Le(Ac/A,Rs/A),Za=o*Math.PI/180;if(Za){const Ha=Math.sin(Za),xs=Math.cos(Za),ya=[xs,-Ha,Ha,xs];$a._matMult(ya),Ws._matMult(ya),jl._matMult(ya),qa._matMult(ya)}const Mc=_i.stretch+_i.fixed,xh=kr.stretch+kr.fixed;return{tl:$a,tr:Ws,bl:jl,br:qa,tex:{x:T.paddedRect.x+1+Mc,y:T.paddedRect.y+1+xh,w:Ar.stretch+Ar.fixed-Mc,h:Nr.stretch+Nr.fixed-xh},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Gl,pixelOffsetBR:Pc,minFontScaleX:Ee/A/Ji,minFontScaleY:Ii/A/$i,isSDF:c}};if(g&&(T.stretchX||T.stretchY)){const _i=ey(W,xt,ct),kr=ey(Q,Et,ut);for(let Ar=0;Ar<_i.length-1;Ar++){const Nr=_i[Ar],yr=_i[Ar+1];for(let Bn=0;Bn<kr.length-1;Bn++)x.push(Ui(Nr,kr[Bn],yr,kr[Bn+1]))}}else x.push(Ui({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:z+1},{fixed:0,stretch:B+1}));return x}function Yp(h,o,c){let g=0;for(const x of h)g+=Math.max(o,Math.min(c,x[1]))-Math.max(o,Math.min(c,x[0]));return g}function ey(h,o,c){const g=[{fixed:-1,stretch:0}];for(const[x,T]of h){const A=g[g.length-1];g.push({fixed:x-A.stretch,stretch:A.stretch}),g.push({fixed:x-A.stretch,stretch:A.stretch+(T-x)})}return g.push({fixed:o+1,stretch:c}),g}function Km(h,o,c,g){return h/o*c+g}function Qm(h,o,c,g){return h-o*c/g}ir("Anchor",ep);class tg{constructor(o,c,g,x,T,A,z,B,G,W){var Q;if(this.boxStartIndex=o.length,G){let ot=A.top,ct=A.bottom;const ut=A.collisionPadding;ut&&(ot-=ut[1],ct+=ut[3]);let xt=ct-ot;xt>0&&(xt=Math.max(10,xt),this.circleDiameter=xt)}else{const ot=!((Q=A.image)===null||Q===void 0)&&Q.content&&(A.image.textFitWidth||A.image.textFitHeight)?$m(A):{x1:A.left,y1:A.top,x2:A.right,y2:A.bottom};ot.y1=ot.y1*z-B[0],ot.y2=ot.y2*z+B[2],ot.x1=ot.x1*z-B[3],ot.x2=ot.x2*z+B[1];const ct=A.collisionPadding;if(ct&&(ot.x1-=ct[0]*z,ot.y1-=ct[1]*z,ot.x2+=ct[2]*z,ot.y2+=ct[3]*z),W){const ut=new Le(ot.x1,ot.y1),xt=new Le(ot.x2,ot.y1),Et=new Le(ot.x1,ot.y2),Vt=new Le(ot.x2,ot.y2),ue=W*Math.PI/180;ut._rotate(ue),xt._rotate(ue),Et._rotate(ue),Vt._rotate(ue),ot.x1=Math.min(ut.x,xt.x,Et.x,Vt.x),ot.x2=Math.max(ut.x,xt.x,Et.x,Vt.x),ot.y1=Math.min(ut.y,xt.y,Et.y,Vt.y),ot.y2=Math.max(ut.y,xt.y,Et.y,Vt.y)}o.emplaceBack(c.x,c.y,ot.x1,ot.y1,ot.x2,ot.y2,g,x,T)}this.boxEndIndex=o.length}}class ux{constructor(o=[],c=(g,x)=>g<x?-1:g>x?1:0){if(this.data=o,this.length=this.data.length,this.compare=c,this.length>0)for(let g=(this.length>>1)-1;g>=0;g--)this._down(g)}push(o){this.data.push(o),this._up(this.length++)}pop(){if(this.length===0)return;const o=this.data[0],c=this.data.pop();return--this.length>0&&(this.data[0]=c,this._down(0)),o}peek(){return this.data[0]}_up(o){const{data:c,compare:g}=this,x=c[o];for(;o>0;){const T=o-1>>1,A=c[T];if(g(x,A)>=0)break;c[o]=A,o=T}c[o]=x}_down(o){const{data:c,compare:g}=this,x=this.length>>1,T=c[o];for(;o<x;){let A=1+(o<<1);const z=A+1;if(z<this.length&&g(c[z],c[A])<0&&(A=z),g(c[A],T)>=0)break;c[o]=c[A],o=A}c[o]=T}}function dx(h,o=1,c=!1){const g=bd.fromPoints(h[0]),x=Math.min(g.width(),g.height());let T=x/2;const A=new ux([],p0),{minX:z,minY:B,maxX:G,maxY:W}=g;if(x===0)return new Le(z,B);for(let ct=z;ct<G;ct+=x)for(let ut=B;ut<W;ut+=x)A.push(new wd(ct+T,ut+T,T,h));let Q=function(ct){let ut=0,xt=0,Et=0;const Vt=ct[0];for(let ue=0,Qt=Vt.length,ee=Qt-1;ue<Qt;ee=ue++){const Se=Vt[ue],Ee=Vt[ee],ei=Se.x*Ee.y-Ee.x*Se.y;xt+=(Se.x+Ee.x)*ei,Et+=(Se.y+Ee.y)*ei,ut+=3*ei}return new wd(xt/ut,Et/ut,0,ct)}(h),ot=A.length;for(;A.length;){const ct=A.pop();(ct.d>Q.d||!Q.d)&&(Q=ct,c&&console.log("found best %d after %d probes",Math.round(1e4*ct.d)/1e4,ot)),ct.max-Q.d<=o||(T=ct.h/2,A.push(new wd(ct.p.x-T,ct.p.y-T,T,h)),A.push(new wd(ct.p.x+T,ct.p.y-T,T,h)),A.push(new wd(ct.p.x-T,ct.p.y+T,T,h)),A.push(new wd(ct.p.x+T,ct.p.y+T,T,h)),ot+=4)}return c&&(console.log(`num probes: ${ot}`),console.log(`best distance: ${Q.d}`)),Q.p}function p0(h,o){return o.max-h.max}function wd(h,o,c,g){this.p=new Le(h,o),this.h=c,this.d=function(x,T){let A=!1,z=1/0;for(let B=0;B<T.length;B++){const G=T[B];for(let W=0,Q=G.length,ot=Q-1;W<Q;ot=W++){const ct=G[W],ut=G[ot];ct.y>x.y!=ut.y>x.y&&x.x<(ut.x-ct.x)*(x.y-ct.y)/(ut.y-ct.y)+ct.x&&(A=!A),z=Math.min(z,Qf(x,ct,ut))}}return(A?1:-1)*Math.sqrt(z)}(this.p,g),this.max=this.d+this.h*Math.SQRT2}var ja;nt.aO=void 0,(ja=nt.aO||(nt.aO={}))[ja.center=1]="center",ja[ja.left=2]="left",ja[ja.right=3]="right",ja[ja.top=4]="top",ja[ja.bottom=5]="bottom",ja[ja["top-left"]=6]="top-left",ja[ja["top-right"]=7]="top-right",ja[ja["bottom-left"]=8]="bottom-left",ja[ja["bottom-right"]=9]="bottom-right";const ip=Number.POSITIVE_INFINITY;function Lf(h,o){return o[1]!==ip?function(c,g,x){let T=0,A=0;switch(g=Math.abs(g),x=Math.abs(x),c){case"top-right":case"top-left":case"top":A=x-7;break;case"bottom-right":case"bottom-left":case"bottom":A=7-x}switch(c){case"top-right":case"bottom-right":case"right":T=-g;break;case"top-left":case"bottom-left":case"left":T=g}return[T,A]}(h,o[0],o[1]):function(c,g){let x=0,T=0;g<0&&(g=0);const A=g/Math.SQRT2;switch(c){case"top-right":case"top-left":T=A-7;break;case"bottom-right":case"bottom-left":T=7-A;break;case"bottom":T=7-g;break;case"top":T=g-7}switch(c){case"top-right":case"bottom-right":x=-A;break;case"top-left":case"bottom-left":x=A;break;case"left":x=g;break;case"right":x=-g}return[x,T]}(h,o[0])}function _m(h,o,c){var g;const x=h.layout,T=(g=x.get("text-variable-anchor-offset"))===null||g===void 0?void 0:g.evaluate(o,{},c);if(T){const z=T.values,B=[];for(let G=0;G<z.length;G+=2){const W=B[G]=z[G],Q=z[G+1].map(ot=>ot*Io);W.startsWith("top")?Q[1]-=7:W.startsWith("bottom")&&(Q[1]+=7),B[G+1]=Q}return new Ds(B)}const A=x.get("text-variable-anchor");if(A){let z;z=h._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[x.get("text-radial-offset").evaluate(o,{},c)*Io,ip]:x.get("text-offset").evaluate(o,{},c).map(G=>G*Io);const B=[];for(const G of A)B.push(G,Lf(G,z));return new Ds(B)}return null}function eg(h){switch(h){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Hg(h,o,c,g,x,T,A,z,B,G,W,Q){let ot=T.textMaxSize.evaluate(o,{});ot===void 0&&(ot=A);const ct=h.layers[0].layout,ut=ct.get("icon-offset").evaluate(o,{},W),xt=ym(c.horizontal),Et=A/24,Vt=h.tilePixelRatio*Et,ue=h.tilePixelRatio*ot/24,Qt=h.tilePixelRatio*z,ee=h.tilePixelRatio*ct.get("symbol-spacing"),Se=ct.get("text-padding")*h.tilePixelRatio,Ee=function(Ar,Nr,yr,Bn=1){const ts=Ar.get("icon-padding").evaluate(Nr,{},yr),_a=ts&&ts.values;return[_a[0]*Bn,_a[1]*Bn,_a[2]*Bn,_a[3]*Bn]}(ct,o,W,h.tilePixelRatio),ei=ct.get("text-max-angle")/180*Math.PI,Ii=ct.get("text-rotation-alignment")!=="viewport"&&ct.get("symbol-placement")!=="point",fi=ct.get("icon-rotation-alignment")==="map"&&ct.get("symbol-placement")!=="point",zi=ct.get("symbol-placement"),Ji=ee/2,$i=ct.get("icon-text-fit");let Ui;g&&$i!=="none"&&(h.allowVerticalPlacement&&c.vertical&&(Ui=T_(g,c.vertical,$i,ct.get("icon-text-fit-padding"),ut,Et)),xt&&(g=T_(g,xt,$i,ct.get("icon-text-fit-padding"),ut,Et)));const _i=W?Q.line.getGranularityForZoomLevel(W.z):1,kr=(Ar,Nr)=>{Nr.x<0||Nr.x>=zn||Nr.y<0||Nr.y>=zn||function(yr,Bn,ts,_a,Ga,Ac,Il,Rs,$a,Ws,qa,jl,Gl,Pc,Za,Mc,xh,Ha,xs,ya,ks,Ca,rp,Lu,sg){const Qp=yr.addToLineVertexArray(Bn,ts);let Ff,Bf,np,vm,ny=0,Yg=0,oy=0,g0=0,Jg=-1,Kg=-1;const op={};let _0=Er("");if(yr.allowVerticalPlacement&&_a.vertical){const El=Rs.layout.get("text-rotate").evaluate(ks,{},Lu)+90;np=new tg($a,Bn,Ws,qa,jl,_a.vertical,Gl,Pc,Za,El),Il&&(vm=new tg($a,Bn,Ws,qa,jl,Il,xh,Ha,Za,El))}if(Ga){const El=Rs.layout.get("icon-rotate").evaluate(ks,{}),Hc=Rs.layout.get("icon-text-fit")!=="none",tf=ty(Ga,El,rp,Hc),su=Il?ty(Il,El,rp,Hc):void 0;Bf=new tg($a,Bn,Ws,qa,jl,Ga,xh,Ha,!1,El),ny=4*tf.length;const sp=yr.iconSizeData;let Ru=null;sp.kind==="source"?(Ru=[iu*Rs.layout.get("icon-size").evaluate(ks,{})],Ru[0]>_d&&ho(`${yr.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):sp.kind==="composite"&&(Ru=[iu*Ca.compositeIconSizes[0].evaluate(ks,{},Lu),iu*Ca.compositeIconSizes[1].evaluate(ks,{},Lu)],(Ru[0]>_d||Ru[1]>_d)&&ho(`${yr.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),yr.addSymbols(yr.icon,tf,Ru,ya,xs,ks,nt.ay.none,Bn,Qp.lineStartIndex,Qp.lineLength,-1,Lu),Jg=yr.icon.placedSymbolArray.length-1,su&&(Yg=4*su.length,yr.addSymbols(yr.icon,su,Ru,ya,xs,ks,nt.ay.vertical,Bn,Qp.lineStartIndex,Qp.lineLength,-1,Lu),Kg=yr.icon.placedSymbolArray.length-1)}const y0=Object.keys(_a.horizontal);for(const El of y0){const Hc=_a.horizontal[El];if(!Ff){_0=Er(Hc.text);const su=Rs.layout.get("text-rotate").evaluate(ks,{},Lu);Ff=new tg($a,Bn,Ws,qa,jl,Hc,Gl,Pc,Za,su)}const tf=Hc.positionedLines.length===1;if(oy+=f0(yr,Bn,Hc,Ac,Rs,Za,ks,Mc,Qp,_a.vertical?nt.ay.horizontal:nt.ay.horizontalOnly,tf?y0:[El],op,Jg,Ca,Lu),tf)break}_a.vertical&&(g0+=f0(yr,Bn,_a.vertical,Ac,Rs,Za,ks,Mc,Qp,nt.ay.vertical,["vertical"],op,Kg,Ca,Lu));const px=Ff?Ff.boxStartIndex:yr.collisionBoxArray.length,fx=Ff?Ff.boxEndIndex:yr.collisionBoxArray.length,mx=np?np.boxStartIndex:yr.collisionBoxArray.length,gx=np?np.boxEndIndex:yr.collisionBoxArray.length,x0=Bf?Bf.boxStartIndex:yr.collisionBoxArray.length,_x=Bf?Bf.boxEndIndex:yr.collisionBoxArray.length,yx=vm?vm.boxStartIndex:yr.collisionBoxArray.length,xx=vm?vm.boxEndIndex:yr.collisionBoxArray.length;let vh=-1;const bm=(El,Hc)=>El&&El.circleDiameter?Math.max(El.circleDiameter,Hc):Hc;vh=bm(Ff,vh),vh=bm(np,vh),vh=bm(Bf,vh),vh=bm(vm,vh);const sy=vh>-1?1:0;sy&&(vh*=sg/Io),yr.glyphOffsetArray.length>=om.MAX_GLYPHS&&ho("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),ks.sortKey!==void 0&&yr.addToSortKeyRanges(yr.symbolInstances.length,ks.sortKey);const v0=_m(Rs,ks,Lu),[b0,w0]=function(El,Hc){const tf=El.length,su=Hc==null?void 0:Hc.values;if((su==null?void 0:su.length)>0)for(let sp=0;sp<su.length;sp+=2){const Ru=su[sp+1];El.emplaceBack(nt.aO[su[sp]],Ru[0],Ru[1])}return[tf,El.length]}(yr.textAnchorOffsets,v0);yr.symbolInstances.emplaceBack(Bn.x,Bn.y,op.right>=0?op.right:-1,op.center>=0?op.center:-1,op.left>=0?op.left:-1,op.vertical||-1,Jg,Kg,_0,px,fx,mx,gx,x0,_x,yx,xx,Ws,oy,g0,ny,Yg,sy,0,Gl,vh,b0,w0)}(h,Nr,Ar,c,g,x,Ui,h.layers[0],h.collisionBoxArray,o.index,o.sourceLayerIndex,h.index,Vt,[Se,Se,Se,Se],Ii,B,Qt,Ee,fi,ut,o,T,G,W,A)};if(zi==="line")for(const Ar of W_(o.geometry,0,0,zn,zn)){const Nr=_t(Ar,_i),yr=Zg(Nr,ee,ei,c.vertical||xt,g,24,ue,h.overscaling,zn);for(const Bn of yr)xt&&iy(h,xt.text,Ji,Bn)||kr(Nr,Bn)}else if(zi==="line-center"){for(const Ar of o.geometry)if(Ar.length>1){const Nr=_t(Ar,_i),yr=u0(Nr,ei,c.vertical||xt,g,24,ue);yr&&kr(Nr,yr)}}else if(o.type==="Polygon")for(const Ar of ih(o.geometry,0)){const Nr=dx(Ar,16);kr(_t(Ar[0],_i,!0),new ep(Nr.x,Nr.y,0))}else if(o.type==="LineString")for(const Ar of o.geometry){const Nr=_t(Ar,_i);kr(Nr,new ep(Nr[0].x,Nr[0].y,0))}else if(o.type==="Point")for(const Ar of o.geometry)for(const Nr of Ar)kr([Nr],new ep(Nr.x,Nr.y,0))}function f0(h,o,c,g,x,T,A,z,B,G,W,Q,ot,ct,ut){const xt=function(ue,Qt,ee,Se,Ee,ei,Ii,fi){const zi=Se.layout.get("text-rotate").evaluate(ei,{})*Math.PI/180,Ji=[];for(const $i of Qt.positionedLines)for(const Ui of $i.positionedGlyphs){if(!Ui.rect)continue;const _i=Ui.rect||{};let kr=4,Ar=!0,Nr=1,yr=0;const Bn=(Ee||fi)&&Ui.vertical,ts=Ui.metrics.advance*Ui.scale/2;if(fi&&Qt.verticalizable&&(yr=$i.lineOffset/2-(Ui.imageName?-(Io-Ui.metrics.width*Ui.scale)/2:(Ui.scale-1)*Io)),Ui.imageName){const Ha=Ii[Ui.imageName];Ar=Ha.sdf,Nr=Ha.pixelRatio,kr=1/Nr}const _a=Ee?[Ui.x+ts,Ui.y]:[0,0];let Ga=Ee?[0,0]:[Ui.x+ts+ee[0],Ui.y+ee[1]-yr],Ac=[0,0];Bn&&(Ac=Ga,Ga=[0,0]);const Il=Ui.metrics.isDoubleResolution?2:1,Rs=(Ui.metrics.left-kr)*Ui.scale-ts+Ga[0],$a=(-Ui.metrics.top-kr)*Ui.scale+Ga[1],Ws=Rs+_i.w/Il*Ui.scale/Nr,qa=$a+_i.h/Il*Ui.scale/Nr,jl=new Le(Rs,$a),Gl=new Le(Ws,$a),Pc=new Le(Rs,qa),Za=new Le(Ws,qa);if(Bn){const Ha=new Le(-ts,ts- -17),xs=-Math.PI/2,ya=12-ts,ks=new Le(22-ya,-(Ui.imageName?ya:0)),Ca=new Le(...Ac);jl._rotateAround(xs,Ha)._add(ks)._add(Ca),Gl._rotateAround(xs,Ha)._add(ks)._add(Ca),Pc._rotateAround(xs,Ha)._add(ks)._add(Ca),Za._rotateAround(xs,Ha)._add(ks)._add(Ca)}if(zi){const Ha=Math.sin(zi),xs=Math.cos(zi),ya=[xs,-Ha,Ha,xs];jl._matMult(ya),Gl._matMult(ya),Pc._matMult(ya),Za._matMult(ya)}const Mc=new Le(0,0),xh=new Le(0,0);Ji.push({tl:jl,tr:Gl,bl:Pc,br:Za,tex:_i,writingMode:Qt.writingMode,glyphOffset:_a,sectionIndex:Ui.sectionIndex,isSDF:Ar,pixelOffsetTL:Mc,pixelOffsetBR:xh,minFontScaleX:0,minFontScaleY:0})}return Ji}(0,c,z,x,T,A,g,h.allowVerticalPlacement),Et=h.textSizeData;let Vt=null;Et.kind==="source"?(Vt=[iu*x.layout.get("text-size").evaluate(A,{})],Vt[0]>_d&&ho(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):Et.kind==="composite"&&(Vt=[iu*ct.compositeTextSizes[0].evaluate(A,{},ut),iu*ct.compositeTextSizes[1].evaluate(A,{},ut)],(Vt[0]>_d||Vt[1]>_d)&&ho(`${h.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),h.addSymbols(h.text,xt,Vt,z,T,A,G,o,B.lineStartIndex,B.lineLength,ot,ut);for(const ue of W)Q[ue]=h.text.placedSymbolArray.length-1;return 4*xt.length}function ym(h){for(const o in h)return h[o];return null}function iy(h,o,c,g){const x=h.compareText;if(o in x){const T=x[o];for(let A=T.length-1;A>=0;A--)if(g.dist(T[A])<c)return!0}else x[o]=[];return x[o].push(g),!1}const ou=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Jp{static from(o){if(!(o instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[c,g]=new Uint8Array(o,0,2);if(c!==219)throw new Error("Data does not appear to be in a KDBush format.");const x=g>>4;if(x!==1)throw new Error(`Got v${x} data when expected v1.`);const T=ou[15&g];if(!T)throw new Error("Unrecognized array type.");const[A]=new Uint16Array(o,2,1),[z]=new Uint32Array(o,4,1);return new Jp(z,A,T,o)}constructor(o,c=64,g=Float64Array,x){if(isNaN(o)||o<0)throw new Error(`Unpexpected numItems value: ${o}.`);this.numItems=+o,this.nodeSize=Math.min(Math.max(+c,2),65535),this.ArrayType=g,this.IndexArrayType=o<65536?Uint16Array:Uint32Array;const T=ou.indexOf(this.ArrayType),A=2*o*this.ArrayType.BYTES_PER_ELEMENT,z=o*this.IndexArrayType.BYTES_PER_ELEMENT,B=(8-z%8)%8;if(T<0)throw new Error(`Unexpected typed array class: ${g}.`);x&&x instanceof ArrayBuffer?(this.data=x,this.ids=new this.IndexArrayType(this.data,8,o),this.coords=new this.ArrayType(this.data,8+z+B,2*o),this._pos=2*o,this._finished=!0):(this.data=new ArrayBuffer(8+A+z+B),this.ids=new this.IndexArrayType(this.data,8,o),this.coords=new this.ArrayType(this.data,8+z+B,2*o),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+T]),new Uint16Array(this.data,2,1)[0]=c,new Uint32Array(this.data,4,1)[0]=o)}add(o,c){const g=this._pos>>1;return this.ids[g]=g,this.coords[this._pos++]=o,this.coords[this._pos++]=c,g}finish(){const o=this._pos>>1;if(o!==this.numItems)throw new Error(`Added ${o} items when expected ${this.numItems}.`);return ig(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(o,c,g,x){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:T,coords:A,nodeSize:z}=this,B=[0,T.length-1,0],G=[];for(;B.length;){const W=B.pop()||0,Q=B.pop()||0,ot=B.pop()||0;if(Q-ot<=z){for(let Et=ot;Et<=Q;Et++){const Vt=A[2*Et],ue=A[2*Et+1];Vt>=o&&Vt<=g&&ue>=c&&ue<=x&&G.push(T[Et])}continue}const ct=ot+Q>>1,ut=A[2*ct],xt=A[2*ct+1];ut>=o&&ut<=g&&xt>=c&&xt<=x&&G.push(T[ct]),(W===0?o<=ut:c<=xt)&&(B.push(ot),B.push(ct-1),B.push(1-W)),(W===0?g>=ut:x>=xt)&&(B.push(ct+1),B.push(Q),B.push(1-W))}return G}within(o,c,g){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:x,coords:T,nodeSize:A}=this,z=[0,x.length-1,0],B=[],G=g*g;for(;z.length;){const W=z.pop()||0,Q=z.pop()||0,ot=z.pop()||0;if(Q-ot<=A){for(let Et=ot;Et<=Q;Et++)rg(T[2*Et],T[2*Et+1],o,c)<=G&&B.push(x[Et]);continue}const ct=ot+Q>>1,ut=T[2*ct],xt=T[2*ct+1];rg(ut,xt,o,c)<=G&&B.push(x[ct]),(W===0?o-g<=ut:c-g<=xt)&&(z.push(ot),z.push(ct-1),z.push(1-W)),(W===0?o+g>=ut:c+g>=xt)&&(z.push(ct+1),z.push(Q),z.push(1-W))}return B}}function ig(h,o,c,g,x,T){if(x-g<=c)return;const A=g+x>>1;Rf(h,o,A,g,x,T),ig(h,o,c,g,A-1,1-T),ig(h,o,c,A+1,x,1-T)}function Rf(h,o,c,g,x,T){for(;x>g;){if(x-g>600){const G=x-g+1,W=c-g+1,Q=Math.log(G),ot=.5*Math.exp(2*Q/3),ct=.5*Math.sqrt(Q*ot*(G-ot)/G)*(W-G/2<0?-1:1);Rf(h,o,c,Math.max(g,Math.floor(c-W*ot/G+ct)),Math.min(x,Math.floor(c+(G-W)*ot/G+ct)),T)}const A=o[2*c+T];let z=g,B=x;for(Td(h,o,g,c),o[2*x+T]>A&&Td(h,o,g,x);z<B;){for(Td(h,o,z,B),z++,B--;o[2*z+T]<A;)z++;for(;o[2*B+T]>A;)B--}o[2*g+T]===A?Td(h,o,g,B):(B++,Td(h,o,B,x)),B<=c&&(g=B+1),c<=B&&(x=B-1)}}function Td(h,o,c,g){Wg(h,c,g),Wg(o,2*c,2*g),Wg(o,2*c+1,2*g+1)}function Wg(h,o,c){const g=h[o];h[o]=h[c],h[c]=g}function rg(h,o,c,g){const x=h-c,T=o-g;return x*x+T*T}var Xg;nt.cG=void 0,(Xg=nt.cG||(nt.cG={})).create="create",Xg.load="load",Xg.fullLoad="fullLoad";let ng=null,og=[];const xm=1e3/60,ry="loadTime",kf="fullLoadTime",m0={mark(h){performance.mark(h)},frame(h){const o=h;ng!=null&&og.push(o-ng),ng=o},clearMetrics(){ng=null,og=[],performance.clearMeasures(ry),performance.clearMeasures(kf);for(const h in nt.cG)performance.clearMarks(nt.cG[h])},getPerformanceMetrics(){performance.measure(ry,nt.cG.create,nt.cG.load),performance.measure(kf,nt.cG.create,nt.cG.fullLoad);const h=performance.getEntriesByName(ry)[0].duration,o=performance.getEntriesByName(kf)[0].duration,c=og.length,g=1/(og.reduce((T,A)=>T+A,0)/c/1e3),x=og.filter(T=>T>xm).reduce((T,A)=>T+(A-xm)/xm,0);return{loadTime:h,fullLoadTime:o,fps:g,percentDroppedFrames:x/(c+x)*100,totalFrames:c}}};nt.$=Rn,nt.A=$r,nt.B=vu,nt.C=ah,nt.D=Ir,nt.E=Fe,nt.F=function([h,o,c]){return o+=90,o*=Math.PI/180,c*=Math.PI/180,{x:h*Math.cos(o)*Math.sin(c),y:h*Math.sin(o)*Math.sin(c),z:h*Math.cos(c)}},nt.G=el,nt.H=wo,nt.I=nm,nt.J=Sp,nt.K=function(h){if(xo==null){const o=h.navigator?h.navigator.userAgent:null;xo=!!h.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return xo},nt.L=class{constructor(h,o){this.target=h,this.mapId=o,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new jy(()=>this.process()),this.subscription=ql(this.target,"message",c=>this.receive(c),!1),this.globalScope=Ns(self)?h:window}registerMessageHandler(h,o){this.messageHandlers[h]=o}unregisterMessageHandler(h){delete this.messageHandlers[h]}sendAsync(h,o){return new Promise((c,g)=>{const x=Math.round(1e18*Math.random()).toString(36).substring(0,10),T=o?ql(o.signal,"abort",()=>{T==null||T.unsubscribe(),delete this.resolveRejects[x];const B={id:x,type:"<cancel>",origin:location.origin,targetMapId:h.targetMapId,sourceMapId:this.mapId};this.target.postMessage(B)},Gy):null;this.resolveRejects[x]={resolve:B=>{T==null||T.unsubscribe(),c(B)},reject:B=>{T==null||T.unsubscribe(),g(B)}};const A=[],z=Object.assign(Object.assign({},h),{id:x,sourceMapId:this.mapId,origin:location.origin,data:Ud(h.data,A)});this.target.postMessage(z,{transfer:A})})}receive(h){const o=h.data,c=o.id;if(!(o.origin!=="file://"&&location.origin!=="file://"&&o.origin!=="resource://android"&&location.origin!=="resource://android"&&o.origin!==location.origin||o.targetMapId&&this.mapId!==o.targetMapId)){if(o.type==="<cancel>"){delete this.tasks[c];const g=this.abortControllers[c];return delete this.abortControllers[c],void(g&&g.abort())}if(Ns(self)||o.mustQueue)return this.tasks[c]=o,this.taskQueue.push(c),void this.invoker.trigger();this.processTask(c,o)}}process(){if(this.taskQueue.length===0)return;const h=this.taskQueue.shift(),o=this.tasks[h];delete this.tasks[h],this.taskQueue.length>0&&this.invoker.trigger(),o&&this.processTask(h,o)}processTask(h,o){return i(this,void 0,void 0,function*(){if(o.type==="<response>"){const x=this.resolveRejects[h];return delete this.resolveRejects[h],x?void(o.error?x.reject(lh(o.error)):x.resolve(lh(o.data))):void 0}if(!this.messageHandlers[o.type])return void this.completeTask(h,new Error(`Could not find a registered handler for ${o.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const c=lh(o.data),g=new AbortController;this.abortControllers[h]=g;try{const x=yield this.messageHandlers[o.type](o.sourceMapId,c,g);this.completeTask(h,null,x)}catch(x){this.completeTask(h,x)}})}completeTask(h,o,c){const g=[];delete this.abortControllers[h];const x={id:h,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:o?Ud(o):null,data:Ud(c,g)};this.target.postMessage(x,{transfer:g})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},nt.M=Zl,nt.N=function(){var h=new $r(16);return $r!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=0,h[12]=0,h[13]=0,h[14]=0),h[0]=1,h[5]=1,h[10]=1,h[15]=1,h},nt.O=function(h,o,c){var g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt=c[0],Et=c[1],Vt=c[2];return o===h?(h[12]=o[0]*xt+o[4]*Et+o[8]*Vt+o[12],h[13]=o[1]*xt+o[5]*Et+o[9]*Vt+o[13],h[14]=o[2]*xt+o[6]*Et+o[10]*Vt+o[14],h[15]=o[3]*xt+o[7]*Et+o[11]*Vt+o[15]):(x=o[1],T=o[2],A=o[3],z=o[4],B=o[5],G=o[6],W=o[7],Q=o[8],ot=o[9],ct=o[10],ut=o[11],h[0]=g=o[0],h[1]=x,h[2]=T,h[3]=A,h[4]=z,h[5]=B,h[6]=G,h[7]=W,h[8]=Q,h[9]=ot,h[10]=ct,h[11]=ut,h[12]=g*xt+z*Et+Q*Vt+o[12],h[13]=x*xt+B*Et+ot*Vt+o[13],h[14]=T*xt+G*Et+ct*Vt+o[14],h[15]=A*xt+W*Et+ut*Vt+o[15]),h},nt.P=Le,nt.Q=function(h,o,c){var g=c[0],x=c[1],T=c[2];return h[0]=o[0]*g,h[1]=o[1]*g,h[2]=o[2]*g,h[3]=o[3]*g,h[4]=o[4]*x,h[5]=o[5]*x,h[6]=o[6]*x,h[7]=o[7]*x,h[8]=o[8]*T,h[9]=o[9]*T,h[10]=o[10]*T,h[11]=o[11]*T,h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15],h},nt.R=Aa,nt.S=function(h,o,c){var g=o[0],x=o[1],T=o[2],A=o[3],z=o[4],B=o[5],G=o[6],W=o[7],Q=o[8],ot=o[9],ct=o[10],ut=o[11],xt=o[12],Et=o[13],Vt=o[14],ue=o[15],Qt=c[0],ee=c[1],Se=c[2],Ee=c[3];return h[0]=Qt*g+ee*z+Se*Q+Ee*xt,h[1]=Qt*x+ee*B+Se*ot+Ee*Et,h[2]=Qt*T+ee*G+Se*ct+Ee*Vt,h[3]=Qt*A+ee*W+Se*ut+Ee*ue,h[4]=(Qt=c[4])*g+(ee=c[5])*z+(Se=c[6])*Q+(Ee=c[7])*xt,h[5]=Qt*x+ee*B+Se*ot+Ee*Et,h[6]=Qt*T+ee*G+Se*ct+Ee*Vt,h[7]=Qt*A+ee*W+Se*ut+Ee*ue,h[8]=(Qt=c[8])*g+(ee=c[9])*z+(Se=c[10])*Q+(Ee=c[11])*xt,h[9]=Qt*x+ee*B+Se*ot+Ee*Et,h[10]=Qt*T+ee*G+Se*ct+Ee*Vt,h[11]=Qt*A+ee*W+Se*ut+Ee*ue,h[12]=(Qt=c[12])*g+(ee=c[13])*z+(Se=c[14])*Q+(Ee=c[15])*xt,h[13]=Qt*x+ee*B+Se*ot+Ee*Et,h[14]=Qt*T+ee*G+Se*ct+Ee*Vt,h[15]=Qt*A+ee*W+Se*ut+Ee*ue,h},nt.T=If,nt.U=function(h,o){const c={};for(let g=0;g<o.length;g++){const x=o[g];x in h&&(c[x]=h[x])}return c},nt.V=Jd,nt.W=Wr,nt.X=Ma,nt.Y=Kd,nt.Z=Re,nt._=i,nt.a=hl,nt.a$=Os,nt.a0=$l,nt.a1=nl,nt.a2=sm,nt.a3=Rg,nt.a4=zn,nt.a5=function(h,o,c){if(!h)return o||{};if(!o)return h||{};const g=Zy(h),x=Zy(o);(function(A,z){z.removeAll&&(A.add.clear(),A.update.clear(),A.remove.clear(),z.remove.clear());for(const B of z.remove)A.add.delete(B),A.update.delete(B);for(const[B,G]of z.update){const W=A.update.get(B);W&&(z.update.set(B,ox(W,G)),A.update.delete(B))}})(g,x);const T={};if((g.removeAll||x.removeAll)&&(T.removeAll=!0),T.remove=new Set([...g.remove,...x.remove]),T.add=new Map([...g.add,...x.add]),T.update=new Map([...g.update,...x.update]),T.remove.size&&T.add.size)for(const A of T.add.keys())T.remove.delete(A);return function(A){const z={};return A.removeAll&&(z.removeAll=A.removeAll),A.remove&&(z.remove=Array.from(A.remove)),A.add&&(z.add=Array.from(A.add.values())),A.update&&(z.update=Array.from(A.update.values())),z}(T)},nt.a6=function(h,o){if(h==null)return!0;if(h.type==="Feature")return Hm(h,o)!=null;if(h.type==="FeatureCollection"){const c=new Set;for(const g of h.features){const x=Hm(g,o);if(x==null||c.has(x))return!1;c.add(x)}return!0}return!1},nt.a7=function(h,o){const c=new Map;if(h!=null)if(h.type==="Feature")c.set(Hm(h,o),h);else for(const g of h.features)c.set(Hm(g,o),g);return c},nt.a8=function(h,o,c){var g,x;if(o.removeAll)h.clear();else if(o.remove)for(const T of o.remove)h.delete(T);if(o.add)for(const T of o.add){const A=Hm(T,c);A!=null&&h.set(A,T)}if(o.update)for(const T of o.update){let A=h.get(T.id);if(!A)continue;const z=!!T.newGeometry,B=T.removeAllProperties||((g=T.removeProperties)===null||g===void 0?void 0:g.length)>0||((x=T.addOrUpdateProperties)===null||x===void 0?void 0:x.length)>0;if((z||B)&&(A=Object.assign({},A),h.set(T.id,A),z&&(A.geometry=T.newGeometry),B)){if(A.properties=T.removeAllProperties?{}:Object.assign({},A.properties||{}),T.removeProperties)for(const G of T.removeProperties)delete A.properties[G];if(T.addOrUpdateProperties)for(const{key:G,value:W}of T.addOrUpdateProperties)A.properties[G]=W}}},nt.a9=qg,nt.aA=function(h,o){var c=o[0],g=o[1],x=o[2],T=o[3],A=o[4],z=o[5],B=o[6],G=o[7],W=o[8],Q=o[9],ot=o[10],ct=o[11],ut=o[12],xt=o[13],Et=o[14],Vt=o[15],ue=c*z-g*A,Qt=c*B-x*A,ee=c*G-T*A,Se=g*B-x*z,Ee=g*G-T*z,ei=x*G-T*B,Ii=W*xt-Q*ut,fi=W*Et-ot*ut,zi=W*Vt-ct*ut,Ji=Q*Et-ot*xt,$i=Q*Vt-ct*xt,Ui=ot*Vt-ct*Et,_i=ue*Ui-Qt*$i+ee*Ji+Se*zi-Ee*fi+ei*Ii;return _i?(h[0]=(z*Ui-B*$i+G*Ji)*(_i=1/_i),h[1]=(x*$i-g*Ui-T*Ji)*_i,h[2]=(xt*ei-Et*Ee+Vt*Se)*_i,h[3]=(ot*Ee-Q*ei-ct*Se)*_i,h[4]=(B*zi-A*Ui-G*fi)*_i,h[5]=(c*Ui-x*zi+T*fi)*_i,h[6]=(Et*ee-ut*ei-Vt*Qt)*_i,h[7]=(W*ei-ot*ee+ct*Qt)*_i,h[8]=(A*$i-z*zi+G*Ii)*_i,h[9]=(g*zi-c*$i-T*Ii)*_i,h[10]=(ut*Ee-xt*ee+Vt*ue)*_i,h[11]=(Q*ee-W*Ee-ct*ue)*_i,h[12]=(z*fi-A*Ji-B*Ii)*_i,h[13]=(c*Ji-g*fi+x*Ii)*_i,h[14]=(xt*Qt-ut*Se-Et*ue)*_i,h[15]=(W*Se-Q*Qt+ot*ue)*_i,h):null},nt.aB=hn,nt.aC=function(h){var o=h[0],c=h[1];return Math.sqrt(o*o+c*c)},nt.aD=function(h){return h[0]=0,h[1]=0,h},nt.aE=function(h,o,c){return h[0]=o[0]*c,h[1]=o[1]*c,h},nt.aF=Mg,nt.aG=sc,nt.aH=function(h,o,c,g){const x=o.y-h.y,T=o.x-h.x,A=g.y-c.y,z=g.x-c.x,B=A*T-z*x;if(B===0)return null;const G=(z*(h.y-c.y)-A*(h.x-c.x))/B;return new Le(h.x+G*T,h.y+G*x)},nt.aI=W_,nt.aJ=Lp,nt.aK=function(h){let o=1/0,c=1/0,g=-1/0,x=-1/0;for(const T of h)o=Math.min(o,T.x),c=Math.min(c,T.y),g=Math.max(g,T.x),x=Math.max(x,T.y);return[o,c,g,x]},nt.aL=Io,nt.aM=Ys,nt.aN=function(h,o,c,g,x=!1){if(!c[0]&&!c[1])return[0,0];const T=x?g==="map"?-h.bearingInRadians:0:g==="viewport"?h.bearingInRadians:0;if(T){const A=Math.sin(T),z=Math.cos(T);c=[c[0]*z-c[1]*A,c[0]*A+c[1]*z]}return[x?c[0]:Ys(o,c[0],h.zoom),x?c[1]:Ys(o,c[1],h.zoom)]},nt.aP=Pg,nt.aQ=eg,nt.aR=jm,nt.aS=Jp,nt.aT=Ko,nt.aU=X,nt.aV=Wt,nt.aW=Zr,nt.aX=Oi,nt.aY=Cs,nt.aZ=$y,nt.a_=Ya,nt.aa=Zm,nt.ab=bd,nt.ac=25,nt.ad=$p,nt.ae=h=>{const o=window.document.createElement("video");return o.muted=!0,new Promise(c=>{o.onloadstart=()=>{c(o)};for(const g of h){const x=window.document.createElement("source");St(g)||(o.crossOrigin="Anonymous"),x.src=g,o.appendChild(x)}})},nt.af=bi,nt.ag=function(){return Xi++},nt.ah=k,nt.ai=om,nt.aj=Ld,nt.ak=yc,nt.al=Wy,nt.am=function(h){const o={};if(h.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(c,g,x,T)=>{const A=x||T;return o[g]=!A||A.toLowerCase(),""}),o["max-age"]){const c=parseInt(o["max-age"],10);isNaN(c)?delete o["max-age"]:o["max-age"]=c}return o},nt.an=fr,nt.ao=85.051129,nt.ap=bs,nt.aq=function(h){return Math.pow(2,h)},nt.ar=$o,nt.as=P_,nt.at=function(h){return Math.log(h)/Math.LN2},nt.au=function(h){var o=h[0],c=h[1];return o*o+c*c},nt.av=class{constructor(h,o){this.max=h,this.onRemove=o,this.reset()}reset(){for(const h in this.data)for(const o of this.data[h])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(h,o,c){const g=h.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);const x={value:o,timeout:void 0};if(c!==void 0&&(x.timeout=setTimeout(()=>{this.remove(h,x)},c)),this.data[g].push(x),this.order.push(g),this.order.length>this.max){const T=this._getAndRemoveByKey(this.order[0]);T&&this.onRemove(T)}return this}has(h){return h.wrapped().key in this.data}getAndRemove(h){return this.has(h)?this._getAndRemoveByKey(h.wrapped().key):null}_getAndRemoveByKey(h){const o=this.data[h].shift();return o.timeout&&clearTimeout(o.timeout),this.data[h].length===0&&delete this.data[h],this.order.splice(this.order.indexOf(h),1),o.value}getByKey(h){const o=this.data[h];return o?o[0].value:null}get(h){return this.has(h)?this.data[h.wrapped().key][0].value:null}remove(h,o){if(!this.has(h))return this;const c=h.wrapped().key,g=o===void 0?0:this.data[c].indexOf(o),x=this.data[c][g];return this.data[c].splice(g,1),x.timeout&&clearTimeout(x.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(x.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(h){for(this.max=h;this.order.length>this.max;){const o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(h){const o=[];for(const c in this.data)for(const g of this.data[c])h(g.value)||o.push(g);for(const c of o)this.remove(c.value.tileID,c)}},nt.aw=function(h){if(!h.length)return new Set;const o=Math.max(...h.map(B=>B.canonical.z));let c=1/0,g=-1/0,x=1/0,T=-1/0;const A=[];for(const B of h){const{x:G,y:W,z:Q}=B.canonical,ot=Math.pow(2,o-Q),ct=G*ot,ut=W*ot;A.push({id:B,x:ct,y:ut}),ct<c&&(c=ct),ct>g&&(g=ct),ut<x&&(x=ut),ut>T&&(T=ut)}const z=new Set;for(const B of A)B.x!==c&&B.x!==g&&B.y!==x&&B.y!==T||z.add(B.id);return z},nt.ax=function(h,o){let c=0,g=0;if(h.kind==="constant")g=h.layoutSize;else if(h.kind!=="source"){const{interpolationType:x,minZoom:T,maxZoom:A}=h,z=x?fr(la.interpolationFactor(x,o,T,A),0,1):0;h.kind==="camera"?g=el.number(h.minSize,h.maxSize,z):c=z}return{uSizeT:c,uSize:g}},nt.az=function(h,{uSize:o,uSizeT:c},{lowerSize:g,upperSize:x}){return h.kind==="source"?g/iu:h.kind==="composite"?el.number(g/iu,x/iu,c):o},nt.b=oo,nt.b$=class extends $s{constructor(h,o){super(h,o),this.current=qc}set(h){if(h[12]!==this.current[12]||h[0]!==this.current[0])return this.current=h,void this.gl.uniformMatrix4fv(this.location,!1,h);for(let o=1;o<16;o++)if(h[o]!==this.current[o]){this.current=h,this.gl.uniformMatrix4fv(this.location,!1,h);break}}},nt.b0=function(h){var o=new $r(3);return o[0]=h[0],o[1]=h[1],o[2]=h[2],o},nt.b1=function(h,o,c){return h[0]=o[0]-c[0],h[1]=o[1]-c[1],h[2]=o[2]-c[2],h},nt.b2=function(h,o){var c=o[0],g=o[1],x=o[2],T=c*c+g*g+x*x;return T>0&&(T=1/Math.sqrt(T)),h[0]=o[0]*T,h[1]=o[1]*T,h[2]=o[2]*T,h},nt.b3=al,nt.b4=function(h,o){return h[0]*o[0]+h[1]*o[1]+h[2]*o[2]},nt.b5=function(h,o,c){return h[0]=o[0]*c[0],h[1]=o[1]*c[1],h[2]=o[2]*c[2],h[3]=o[3]*c[3],h},nt.b6=bo,nt.b7=function(h,o,c){const g=o[0]*c[0]+o[1]*c[1]+o[2]*c[2];return g===0?null:(-(h[0]*c[0]+h[1]*c[1]+h[2]*c[2])-c[3])/g},nt.b8=Hr,nt.b9=function(h,o,c){return h[0]=o[0]*c,h[1]=o[1]*c,h[2]=o[2]*c,h[3]=o[3]*c,h},nt.bA=Kn,nt.bB=function(h,o,c){var g=c[0],x=c[1],T=c[2],A=c[3],z=o[0],B=o[1],G=o[2],W=x*G-T*B,Q=T*z-g*G,ot=g*B-x*z;return h[0]=z+A*(W+=W)+x*(ot+=ot)-T*(Q+=Q),h[1]=B+A*Q+T*W-g*ot,h[2]=G+A*ot+g*Q-x*W,h},nt.bC=function(h,o,c){const g=(x=[h[0],h[1],h[2],o[0],o[1],o[2],c[0],c[1],c[2]])[0]*((W=x[8])*(A=x[4])-(z=x[5])*(G=x[7]))+x[1]*(-W*(T=x[3])+z*(B=x[6]))+x[2]*(G*T-A*B);var x,T,A,z,B,G,W;if(g===0)return null;const Q=al([],[o[0],o[1],o[2]],[c[0],c[1],c[2]]),ot=al([],[c[0],c[1],c[2]],[h[0],h[1],h[2]]),ct=al([],[h[0],h[1],h[2]],[o[0],o[1],o[2]]),ut=Ya([],Q,-h[3]);return Os(ut,ut,Ya([],ot,-o[3])),Os(ut,ut,Ya([],ct,-c[3])),Ya(ut,ut,1/g),ut},nt.bD=zg,nt.bE=function(){return new Float64Array(4)},nt.bF=function(h,o,c,g){var x=[],T=[];return x[0]=o[0]-c[0],x[1]=o[1]-c[1],x[2]=o[2]-c[2],T[0]=x[0]*Math.cos(g)-x[1]*Math.sin(g),T[1]=x[0]*Math.sin(g)+x[1]*Math.cos(g),T[2]=x[2],h[0]=T[0]+c[0],h[1]=T[1]+c[1],h[2]=T[2]+c[2],h},nt.bG=function(h,o,c,g){var x=[],T=[];return x[0]=o[0]-c[0],x[1]=o[1]-c[1],x[2]=o[2]-c[2],T[0]=x[0],T[1]=x[1]*Math.cos(g)-x[2]*Math.sin(g),T[2]=x[1]*Math.sin(g)+x[2]*Math.cos(g),h[0]=T[0]+c[0],h[1]=T[1]+c[1],h[2]=T[2]+c[2],h},nt.bH=function(h,o,c,g){var x=[],T=[];return x[0]=o[0]-c[0],x[1]=o[1]-c[1],x[2]=o[2]-c[2],T[0]=x[2]*Math.sin(g)+x[0]*Math.cos(g),T[1]=x[1],T[2]=x[2]*Math.cos(g)-x[0]*Math.sin(g),h[0]=T[0]+c[0],h[1]=T[1]+c[1],h[2]=T[2]+c[2],h},nt.bI=function(h,o,c){var g=Math.sin(c),x=Math.cos(c),T=o[0],A=o[1],z=o[2],B=o[3],G=o[8],W=o[9],Q=o[10],ot=o[11];return o!==h&&(h[4]=o[4],h[5]=o[5],h[6]=o[6],h[7]=o[7],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15]),h[0]=T*x-G*g,h[1]=A*x-W*g,h[2]=z*x-Q*g,h[3]=B*x-ot*g,h[8]=T*g+G*x,h[9]=A*g+W*x,h[10]=z*g+Q*x,h[11]=B*g+ot*x,h},nt.bJ=function(h,o){const c=vs(h,360),g=vs(o,360),x=g-c,T=g>c?x-360:x+360;return Math.abs(x)<Math.abs(T)?x:T},nt.bK=function(h){return h[0]=0,h[1]=0,h[2]=0,h},nt.bL=function(h,o,c,g){const x=Math.sqrt(h*h+o*o),T=Math.sqrt(c*c+g*g);h/=x,o/=x,c/=T,g/=T;const A=Math.acos(h*c+o*g);return-o*c+h*g>0?A:-A},nt.bM=function(h,o){const c=vs(h,2*Math.PI),g=vs(o,2*Math.PI);return Math.min(Math.abs(c-g),Math.abs(c-g+2*Math.PI),Math.abs(c-g-2*Math.PI))},nt.bN=function(){const h={},o=Jt.$version;for(const c in Jt.$root){const g=Jt.$root[c];if(g.required){let x=null;x=c==="version"?o:g.type==="array"?[]:{},x!=null&&(h[c]=x)}}return h},nt.bO=so,nt.bP=nd,nt.bQ=function h(o,c){if(Array.isArray(o)){if(!Array.isArray(c)||o.length!==c.length)return!1;for(let g=0;g<o.length;g++)if(!h(o[g],c[g]))return!1;return!0}if(typeof o=="object"&&o!==null&&c!==null){if(typeof c!="object"||Object.keys(o).length!==Object.keys(c).length)return!1;for(const g in o)if(!h(o[g],c[g]))return!1;return!0}return o===c},nt.bR=function(h){h=h.slice();const o=Object.create(null);for(let c=0;c<h.length;c++)o[h[c].id]=h[c];for(let c=0;c<h.length;c++)"ref"in h[c]&&(h[c]=We(h[c],o[h[c].ref]));return h},nt.bS=function(h,o){if(h.type==="custom")return new Uy(h,o);switch(h.type){case"background":return new Vy(h,o);case"circle":return new g_(h,o);case"color-relief":return new __(h,o);case"fill":return new Zt(h,o);case"fill-extrusion":return new Ai(h,o);case"heatmap":return new Zc(h,o);case"hillshade":return new tu(h,o);case"line":return new fo(h,o);case"raster":return new $d(h,o);case"symbol":return new qm(h,o)}},nt.bT=h=>h.type==="raster",nt.bU=qo,nt.bV=function(h,o){if(!h)return[{command:"setStyle",args:[o]}];let c=[];try{if(!ci(h.version,o.version))return[{command:"setStyle",args:[o]}];ci(h.center,o.center)||c.push({command:"setCenter",args:[o.center]}),ci(h.state,o.state)||c.push({command:"setGlobalState",args:[o.state]}),ci(h.centerAltitude,o.centerAltitude)||c.push({command:"setCenterAltitude",args:[o.centerAltitude]}),ci(h.zoom,o.zoom)||c.push({command:"setZoom",args:[o.zoom]}),ci(h.bearing,o.bearing)||c.push({command:"setBearing",args:[o.bearing]}),ci(h.pitch,o.pitch)||c.push({command:"setPitch",args:[o.pitch]}),ci(h.roll,o.roll)||c.push({command:"setRoll",args:[o.roll]}),ci(h.sprite,o.sprite)||c.push({command:"setSprite",args:[o.sprite]}),ci(h.glyphs,o.glyphs)||c.push({command:"setGlyphs",args:[o.glyphs]}),ci(h.transition,o.transition)||c.push({command:"setTransition",args:[o.transition]}),ci(h.light,o.light)||c.push({command:"setLight",args:[o.light]}),ci(h.terrain,o.terrain)||c.push({command:"setTerrain",args:[o.terrain]}),ci(h.sky,o.sky)||c.push({command:"setSky",args:[o.sky]}),ci(h.projection,o.projection)||c.push({command:"setProjection",args:[o.projection]});const g={},x=[];(function(A,z,B,G){let W;for(W in z=z||{},A=A||{})Object.prototype.hasOwnProperty.call(A,W)&&(Object.prototype.hasOwnProperty.call(z,W)||zr(W,B,G));for(W in z)Object.prototype.hasOwnProperty.call(z,W)&&(Object.prototype.hasOwnProperty.call(A,W)?ci(A[W],z[W])||(A[W].type==="geojson"&&z[W].type==="geojson"&&Do(A,z,W)?ui(B,{command:"setGeoJSONSourceData",args:[W,z[W].data]}):Ae(W,z,B,G)):cr(W,z,B))})(h.sources,o.sources,x,g);const T=[];h.layers&&h.layers.forEach(A=>{"source"in A&&g[A.source]?c.push({command:"removeLayer",args:[A.id]}):T.push(A)}),c=c.concat(x),function(A,z,B){z=z||[];const G=(A=A||[]).map(Qn),W=z.map(Qn),Q=A.reduce(ar,{}),ot=z.reduce(ar,{}),ct=G.slice(),ut=Object.create(null);let xt,Et,Vt,ue,Qt;for(let ee=0,Se=0;ee<G.length;ee++)xt=G[ee],Object.prototype.hasOwnProperty.call(ot,xt)?Se++:(ui(B,{command:"removeLayer",args:[xt]}),ct.splice(ct.indexOf(xt,Se),1));for(let ee=0,Se=0;ee<W.length;ee++)xt=W[W.length-1-ee],ct[ct.length-1-ee]!==xt&&(Object.prototype.hasOwnProperty.call(Q,xt)?(ui(B,{command:"removeLayer",args:[xt]}),ct.splice(ct.lastIndexOf(xt,ct.length-Se),1)):Se++,ue=ct[ct.length-ee],ui(B,{command:"addLayer",args:[ot[xt],ue]}),ct.splice(ct.length-ee,0,xt),ut[xt]=!0);for(let ee=0;ee<W.length;ee++)if(xt=W[ee],Et=Q[xt],Vt=ot[xt],!ut[xt]&&!ci(Et,Vt))if(ci(Et.source,Vt.source)&&ci(Et["source-layer"],Vt["source-layer"])&&ci(Et.type,Vt.type)){for(Qt in An(Et.layout,Vt.layout,B,xt,null,"setLayoutProperty"),An(Et.paint,Vt.paint,B,xt,null,"setPaintProperty"),ci(Et.filter,Vt.filter)||ui(B,{command:"setFilter",args:[xt,Vt.filter]}),ci(Et.minzoom,Vt.minzoom)&&ci(Et.maxzoom,Vt.maxzoom)||ui(B,{command:"setLayerZoomRange",args:[xt,Vt.minzoom,Vt.maxzoom]}),Et)Object.prototype.hasOwnProperty.call(Et,Qt)&&Qt!=="layout"&&Qt!=="paint"&&Qt!=="filter"&&Qt!=="metadata"&&Qt!=="minzoom"&&Qt!=="maxzoom"&&(Qt.indexOf("paint.")===0?An(Et[Qt],Vt[Qt],B,xt,Qt.slice(6),"setPaintProperty"):ci(Et[Qt],Vt[Qt])||ui(B,{command:"setLayerProperty",args:[xt,Qt,Vt[Qt]]}));for(Qt in Vt)Object.prototype.hasOwnProperty.call(Vt,Qt)&&!Object.prototype.hasOwnProperty.call(Et,Qt)&&Qt!=="layout"&&Qt!=="paint"&&Qt!=="filter"&&Qt!=="metadata"&&Qt!=="minzoom"&&Qt!=="maxzoom"&&(Qt.indexOf("paint.")===0?An(Et[Qt],Vt[Qt],B,xt,Qt.slice(6),"setPaintProperty"):ci(Et[Qt],Vt[Qt])||ui(B,{command:"setLayerProperty",args:[xt,Qt,Vt[Qt]]}))}else ui(B,{command:"removeLayer",args:[xt]}),ue=ct[ct.lastIndexOf(xt)+1],ui(B,{command:"addLayer",args:[Vt,ue]})}(T,o.layers,c)}catch(g){console.warn("Unable to compute style diff:",g),c=[{command:"setStyle",args:[o]}]}return c},nt.bW=function(h){const o=[],c=h.id;return c===void 0&&o.push({message:`layers.${c}: missing required property "id"`}),h.render===void 0&&o.push({message:`layers.${c}: missing required method "render"`}),h.renderingMode&&h.renderingMode!=="2d"&&h.renderingMode!=="3d"&&o.push({message:`layers.${c}: property "renderingMode" must be either "2d" or "3d"`}),o},nt.bX=Xr,nt.bY=$n,nt.bZ=class extends $s{constructor(h,o){super(h,o),this.current=0}set(h){this.current!==h&&(this.current=h,this.gl.uniform1i(this.location,h))}},nt.b_=ec,nt.ba=function(h,o){return h[0]*o[0]+h[1]*o[1]+h[2]*o[2]+h[3]},nt.bb=M_,nt.bc=yd,nt.bd=function(h,o,c,g,x){var T=1/Math.tan(o/2);if(h[0]=T/c,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=T,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[11]=-1,h[12]=0,h[13]=0,h[15]=0,x!=null&&x!==1/0){var A=1/(g-x);h[10]=(x+g)*A,h[14]=2*x*g*A}else h[10]=-1,h[14]=-2*g;return h},nt.be=function(h){var o=new $r(16);return o[0]=h[0],o[1]=h[1],o[2]=h[2],o[3]=h[3],o[4]=h[4],o[5]=h[5],o[6]=h[6],o[7]=h[7],o[8]=h[8],o[9]=h[9],o[10]=h[10],o[11]=h[11],o[12]=h[12],o[13]=h[13],o[14]=h[14],o[15]=h[15],o},nt.bf=function(h,o,c){var g=Math.sin(c),x=Math.cos(c),T=o[0],A=o[1],z=o[2],B=o[3],G=o[4],W=o[5],Q=o[6],ot=o[7];return o!==h&&(h[8]=o[8],h[9]=o[9],h[10]=o[10],h[11]=o[11],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15]),h[0]=T*x+G*g,h[1]=A*x+W*g,h[2]=z*x+Q*g,h[3]=B*x+ot*g,h[4]=G*x-T*g,h[5]=W*x-A*g,h[6]=Q*x-z*g,h[7]=ot*x-B*g,h},nt.bg=function(h,o,c){var g=Math.sin(c),x=Math.cos(c),T=o[4],A=o[5],z=o[6],B=o[7],G=o[8],W=o[9],Q=o[10],ot=o[11];return o!==h&&(h[0]=o[0],h[1]=o[1],h[2]=o[2],h[3]=o[3],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15]),h[4]=T*x+G*g,h[5]=A*x+W*g,h[6]=z*x+Q*g,h[7]=B*x+ot*g,h[8]=G*x-T*g,h[9]=W*x-A*g,h[10]=Q*x-z*g,h[11]=ot*x-B*g,h},nt.bh=function(){const h=new Float32Array(16);return $o(h),h},nt.bi=function(){const h=new Float64Array(16);return $o(h),h},nt.bj=function(){return new Float64Array(16)},nt.bk=function(h,o,c){const g=new Float64Array(4);return Kn(g,h,o-90,c),g},nt.bl=function(h,o,c,g){var x,T,A,z,B,G=o[0],W=o[1],Q=o[2],ot=o[3],ct=c[0],ut=c[1],xt=c[2],Et=c[3];return(T=G*ct+W*ut+Q*xt+ot*Et)<0&&(T=-T,ct=-ct,ut=-ut,xt=-xt,Et=-Et),1-T>pr?(x=Math.acos(T),A=Math.sin(x),z=Math.sin((1-g)*x)/A,B=Math.sin(g*x)/A):(z=1-g,B=g),h[0]=z*G+B*ct,h[1]=z*W+B*ut,h[2]=z*Q+B*xt,h[3]=z*ot+B*Et,h},nt.bm=function(h){const o=new Float64Array(9);var c,g,x,T,A,z,B,G,W,Q,ot,ct,ut,xt,Et,Vt,ue,Qt;Q=(x=(g=h)[0])*(B=x+x),ot=(T=g[1])*B,ut=(A=g[2])*B,xt=A*(G=T+T),Vt=(z=g[3])*B,ue=z*G,Qt=z*(W=A+A),(c=o)[0]=1-(ct=T*G)-(Et=A*W),c[3]=ot-Qt,c[6]=ut+ue,c[1]=ot+Qt,c[4]=1-Q-Et,c[7]=xt-Vt,c[2]=ut-ue,c[5]=xt+Vt,c[8]=1-Q-ct;const ee=Cs(-Math.asin(fr(o[2],-1,1)));let Se,Ee;return Math.hypot(o[5],o[8])<.001?(Se=0,Ee=-Cs(Math.atan2(o[3],o[4]))):(Se=Cs(o[5]===0&&o[8]===0?0:Math.atan2(o[5],o[8])),Ee=Cs(o[1]===0&&o[0]===0?0:Math.atan2(o[1],o[0]))),{roll:Se,pitch:ee+90,bearing:Ee}},nt.bn=function(h,o){return h.roll==o.roll&&h.pitch==o.pitch&&h.bearing==o.bearing},nt.bo=un,nt.bp=_c,nt.bq=K,nt.br=rt,nt.bs=U,nt.bt=Ps,nt.bu=Hn,nt.bv=aa,nt.bw=function(h,o,c,g,x){return Ps(g,x,fr((h-o)/(c-o),0,1))},nt.bx=vs,nt.by=function(){return new Float64Array(3)},nt.bz=function(h,o,c,g){return h[0]=o[0]+c[0]*g,h[1]=o[1]+c[1]*g,h[2]=o[2]+c[2]*g,h},nt.c=Vs,nt.c$=class{constructor(h){this._marks={start:[h.url,"start"].join("#"),end:[h.url,"end"].join("#"),measure:h.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let h=performance.getEntriesByName(this._marks.measure);return h.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),h=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),h}},nt.c0=rl,nt.c1=class extends $s{constructor(h,o){super(h,o),this.current=[0,0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]&&h[2]===this.current[2]||(this.current=h,this.gl.uniform3f(this.location,h[0],h[1],h[2]))}},nt.c2=class extends $s{constructor(h,o){super(h,o),this.current=[0,0]}set(h){h[0]===this.current[0]&&h[1]===this.current[1]||(this.current=h,this.gl.uniform2f(this.location,h[0],h[1]))}},nt.c3=En,nt.c4=function(h,o){var c=Math.sin(o),g=Math.cos(o);return h[0]=g,h[1]=c,h[2]=0,h[3]=-c,h[4]=g,h[5]=0,h[6]=0,h[7]=0,h[8]=1,h},nt.c5=function(h,o,c){var g=o[0],x=o[1],T=o[2];return h[0]=g*c[0]+x*c[3]+T*c[6],h[1]=g*c[1]+x*c[4]+T*c[7],h[2]=g*c[2]+x*c[5]+T*c[8],h},nt.c6=function(h,o,c,g,x,T,A){var z=1/(o-c),B=1/(g-x),G=1/(T-A);return h[0]=-2*z,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=-2*B,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=2*G,h[11]=0,h[12]=(o+c)*z,h[13]=(x+g)*B,h[14]=(A+T)*G,h[15]=1,h},nt.c7=class extends $s{constructor(h,o){super(h,o),this.current=new Array}set(h){if(h!=this.current){this.current=h;const o=new Float32Array(4*h.length);for(let c=0;c<h.length;c++)o[4*c]=h[c].r,o[4*c+1]=h[c].g,o[4*c+2]=h[c].b,o[4*c+3]=h[c].a;this.gl.uniform4fv(this.location,o)}}},nt.c8=class extends $s{constructor(h,o){super(h,o),this.current=new Array}set(h){if(h!=this.current){this.current=h;const o=new Float32Array(h);this.gl.uniform1fv(this.location,o)}}},nt.c9=class extends Cp{},nt.cA=function(h){return cl[h]||Ml[h]},nt.cB=function(h,o,c){var g=o[0],x=o[1];return h[0]=c[0]*g+c[4]*x+c[12],h[1]=c[1]*g+c[5]*x+c[13],h},nt.cC=function(h,o){const{x:c,y:g}=Zm.fromLngLat(o);return!(h<0||h>25||g<0||g>=1||c<0||c>=1)},nt.cD=function(h,o){return h[0]=o[0],h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=o[1],h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=o[2],h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h},nt.cE=class extends Bl{},nt.cF=m0,nt.cH=function(h){return h.message===Cl},nt.cI=Da,nt.cJ=function(h,o){hl.REGISTERED_PROTOCOLS[h]=o},nt.cK=function(h){delete hl.REGISTERED_PROTOCOLS[h]},nt.cL=function(h,o){const c={};for(let x=0;x<h.length;x++){const T=o&&o[h[x].id]||pf(h[x]);o&&(o[h[x].id]=T);let A=c[T];A||(A=c[T]=[]),A.push(h[x])}const g=[];for(const x in c)g.push(c[x]);return g},nt.cM=ir,nt.cN=Hy,nt.cO=l0,nt.cP=Ly,nt.cQ=function(h){h.bucket.createArrays(),h.bucket.tilePixelRatio=zn/(512*h.bucket.overscaling),h.bucket.compareText={},h.bucket.iconsNeedLinear=!1;const o=h.bucket.layers[0],c=o.layout,g=o._unevaluatedLayout._values,x={layoutIconSize:g["icon-size"].possiblyEvaluate(new wo(h.bucket.zoom+1),h.canonical),layoutTextSize:g["text-size"].possiblyEvaluate(new wo(h.bucket.zoom+1),h.canonical),textMaxSize:g["text-size"].possiblyEvaluate(new wo(18))};if(h.bucket.textSizeData.kind==="composite"){const{minZoom:G,maxZoom:W}=h.bucket.textSizeData;x.compositeTextSizes=[g["text-size"].possiblyEvaluate(new wo(G),h.canonical),g["text-size"].possiblyEvaluate(new wo(W),h.canonical)]}if(h.bucket.iconSizeData.kind==="composite"){const{minZoom:G,maxZoom:W}=h.bucket.iconSizeData;x.compositeIconSizes=[g["icon-size"].possiblyEvaluate(new wo(G),h.canonical),g["icon-size"].possiblyEvaluate(new wo(W),h.canonical)]}const T=c.get("text-line-height")*Io,A=c.get("text-rotation-alignment")!=="viewport"&&c.get("symbol-placement")!=="point",z=c.get("text-keep-upright"),B=c.get("text-size");for(const G of h.bucket.features){const W=c.get("text-font").evaluate(G,{},h.canonical).join(","),Q=B.evaluate(G,{},h.canonical),ot=x.layoutTextSize.evaluate(G,{},h.canonical),ct=x.layoutIconSize.evaluate(G,{},h.canonical),ut={horizontal:{},vertical:void 0},xt=G.text;let Et,Vt=[0,0];if(xt){const ee=xt.toString(),Se=c.get("text-letter-spacing").evaluate(G,{},h.canonical)*Io,Ee=od(ee)?Se:0,ei=c.get("text-anchor").evaluate(G,{},h.canonical),Ii=_m(o,G,h.canonical);if(!Ii){const $i=c.get("text-radial-offset").evaluate(G,{},h.canonical);Vt=$i?Lf(ei,[$i*Io,ip]):c.get("text-offset").evaluate(G,{},h.canonical).map(Ui=>Ui*Io)}let fi=A?"center":c.get("text-justify").evaluate(G,{},h.canonical);const zi=c.get("symbol-placement")==="point"?c.get("text-max-width").evaluate(G,{},h.canonical)*Io:1/0,Ji=()=>{h.bucket.allowVerticalPlacement&&Uc(ee)&&(ut.vertical=Ig(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,zi,T,ei,"left",Ee,Vt,nt.ay.vertical,!0,ot,Q))};if(!A&&Ii){const $i=new Set;if(fi==="auto")for(let _i=0;_i<Ii.values.length;_i+=2)$i.add(eg(Ii.values[_i]));else $i.add(fi);let Ui=!1;for(const _i of $i)if(!ut.horizontal[_i])if(Ui)ut.horizontal[_i]=ut.horizontal[0];else{const kr=Ig(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,zi,T,"center",_i,Ee,Vt,nt.ay.horizontal,!1,ot,Q);kr&&(ut.horizontal[_i]=kr,Ui=kr.positionedLines.length===1)}Ji()}else{fi==="auto"&&(fi=eg(ei));const $i=Ig(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,zi,T,ei,fi,Ee,Vt,nt.ay.horizontal,!1,ot,Q);$i&&(ut.horizontal[fi]=$i),Ji(),Uc(ee)&&A&&z&&(ut.vertical=Ig(xt,h.glyphMap,h.glyphPositions,h.imagePositions,W,zi,T,ei,fi,Ee,Vt,nt.ay.vertical,!1,ot,Q))}}let ue=!1;if(G.icon&&G.icon.name){const ee=h.imageMap[G.icon.name];ee&&(Et=Gm(h.imagePositions[G.icon.name],c.get("icon-offset").evaluate(G,{},h.canonical),c.get("icon-anchor").evaluate(G,{},h.canonical)),ue=!!ee.sdf,h.bucket.sdfIcons===void 0?h.bucket.sdfIcons=ue:h.bucket.sdfIcons!==ue&&ho("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(ee.pixelRatio!==h.bucket.pixelRatio||c.get("icon-rotate").constantOr(1)!==0)&&(h.bucket.iconsNeedLinear=!0))}const Qt=ym(ut.horizontal)||ut.vertical;h.bucket.iconsInText=!!Qt&&Qt.iconsInText,(Qt||Et)&&Hg(h.bucket,G,ut,Et,h.imageMap,x,ot,ct,Vt,ue,h.canonical,h.subdivisionGranularity)}h.showCollisionBoxes&&h.bucket.generateCollisionDebugBuffers()},nt.cR=Ct,nt.cS=Li,nt.cT=Yr,nt.cU=ge,nt.cV=Ls,nt.cW=ve,nt.cX=function(h,o,c,g,x,T){let A=X_(h,o,c,x,0);return A=X_(A,o,g,T,1),A},nt.cY=class{constructor(h){this.maxEntries=h,this.map=new Map}get(h){const o=this.map.get(h);return o!==void 0&&(this.map.delete(h),this.map.set(h,o)),o}set(h,o){if(this.map.has(h))this.map.delete(h);else if(this.map.size>=this.maxEntries){const c=this.map.keys().next().value;this.map.delete(c)}this.map.set(h,o)}clear(){this.map.clear()}},nt.cZ=Oe,nt.c_=$g,nt.ca=Ro,nt.cb=class extends ud{},nt.cc=Bp,nt.cd=function(h){return h<=1?1:Math.pow(2,Math.ceil(Math.log(h)/Math.LN2))},nt.ce=im,nt.cf=function(h,o,c){var g=o[0],x=o[1],T=o[2],A=c[3]*g+c[7]*x+c[11]*T+c[15];return h[0]=(c[0]*g+c[4]*x+c[8]*T+c[12])/(A=A||1),h[1]=(c[1]*g+c[5]*x+c[9]*T+c[13])/A,h[2]=(c[2]*g+c[6]*x+c[10]*T+c[14])/A,h},nt.cg=class extends Gc{},nt.ch=class extends v{},nt.ci=function(h,o){return h[0]===o[0]&&h[1]===o[1]&&h[2]===o[2]&&h[3]===o[3]&&h[4]===o[4]&&h[5]===o[5]&&h[6]===o[6]&&h[7]===o[7]&&h[8]===o[8]&&h[9]===o[9]&&h[10]===o[10]&&h[11]===o[11]&&h[12]===o[12]&&h[13]===o[13]&&h[14]===o[14]&&h[15]===o[15]},nt.cj=function(h,o){var c=h[0],g=h[1],x=h[2],T=h[3],A=h[4],z=h[5],B=h[6],G=h[7],W=h[8],Q=h[9],ot=h[10],ct=h[11],ut=h[12],xt=h[13],Et=h[14],Vt=h[15],ue=o[0],Qt=o[1],ee=o[2],Se=o[3],Ee=o[4],ei=o[5],Ii=o[6],fi=o[7],zi=o[8],Ji=o[9],$i=o[10],Ui=o[11],_i=o[12],kr=o[13],Ar=o[14],Nr=o[15];return Math.abs(c-ue)<=pr*Math.max(1,Math.abs(c),Math.abs(ue))&&Math.abs(g-Qt)<=pr*Math.max(1,Math.abs(g),Math.abs(Qt))&&Math.abs(x-ee)<=pr*Math.max(1,Math.abs(x),Math.abs(ee))&&Math.abs(T-Se)<=pr*Math.max(1,Math.abs(T),Math.abs(Se))&&Math.abs(A-Ee)<=pr*Math.max(1,Math.abs(A),Math.abs(Ee))&&Math.abs(z-ei)<=pr*Math.max(1,Math.abs(z),Math.abs(ei))&&Math.abs(B-Ii)<=pr*Math.max(1,Math.abs(B),Math.abs(Ii))&&Math.abs(G-fi)<=pr*Math.max(1,Math.abs(G),Math.abs(fi))&&Math.abs(W-zi)<=pr*Math.max(1,Math.abs(W),Math.abs(zi))&&Math.abs(Q-Ji)<=pr*Math.max(1,Math.abs(Q),Math.abs(Ji))&&Math.abs(ot-$i)<=pr*Math.max(1,Math.abs(ot),Math.abs($i))&&Math.abs(ct-Ui)<=pr*Math.max(1,Math.abs(ct),Math.abs(Ui))&&Math.abs(ut-_i)<=pr*Math.max(1,Math.abs(ut),Math.abs(_i))&&Math.abs(xt-kr)<=pr*Math.max(1,Math.abs(xt),Math.abs(kr))&&Math.abs(Et-Ar)<=pr*Math.max(1,Math.abs(Et),Math.abs(Ar))&&Math.abs(Vt-Nr)<=pr*Math.max(1,Math.abs(Vt),Math.abs(Nr))},nt.ck=function(h,o){return h[0]=o[0],h[1]=o[1],h[2]=o[2],h[3]=o[3],h[4]=o[4],h[5]=o[5],h[6]=o[6],h[7]=o[7],h[8]=o[8],h[9]=o[9],h[10]=o[10],h[11]=o[11],h[12]=o[12],h[13]=o[13],h[14]=o[14],h[15]=o[15],h},nt.cl=h=>h.type==="symbol",nt.cm=h=>h.type==="circle",nt.cn=h=>h.type==="heatmap",nt.co=h=>h.type==="line",nt.cp=h=>h.type==="fill",nt.cq=h=>h.type==="fill-extrusion",nt.cr=h=>h.type==="hillshade",nt.cs=h=>h.type==="color-relief",nt.ct=h=>h.type==="background",nt.cu=h=>h.type==="custom",nt.cv=di,nt.cw=function(h,o,c){const g=Co(o.x-c.x,o.y-c.y),x=Co(h.x-c.x,h.y-c.y);var T,A;return Cs(Math.atan2(g[0]*x[1]-g[1]*x[0],(T=g)[0]*(A=x)[0]+T[1]*A[1]))},nt.cx=tr,nt.cy=function(h,o){return Ml[o]&&(h instanceof MouseEvent||h instanceof WheelEvent)},nt.cz=function(h,o){return cl[o]&&"touches"in h},nt.d=St,nt.d0=function(h,o,c,g,x){return i(this,void 0,void 0,function*(){if(Rn())try{return yield $l(h,o,c,g,x)}catch{}return function(T,A,z,B,G){const W=T.width,Q=T.height;Ms&&wa||(Ms=new OffscreenCanvas(W,Q),wa=Ms.getContext("2d",{willReadFrequently:!0})),Ms.width=W,Ms.height=Q,wa.drawImage(T,0,0,W,Q);const ot=wa.getImageData(A,z,B,G);return wa.clearRect(0,0,W,Q),ot.data}(h,o,c,g,x)})},nt.d1=Om,nt.d2=wi,nt.d3=lo,nt.d4=jc,nt.e=qr,nt.f=h=>i(void 0,void 0,void 0,function*(){if(h.byteLength===0)return createImageBitmap(new ImageData(1,1));const o=new Blob([new Uint8Array(h)],{type:"image/png"});try{return createImageBitmap(o)}catch(c){throw new Error(`Could not load image because of ${c.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),nt.g=Ka,nt.h=h=>new Promise((o,c)=>{const g=new Image;g.onload=()=>{o(g),URL.revokeObjectURL(g.src),g.onload=null,window.requestAnimationFrame(()=>{g.src=ll})},g.onerror=()=>c(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const x=new Blob([new Uint8Array(h)],{type:"image/png"});g.src=h.byteLength?URL.createObjectURL(x):ll}),nt.i=Ns,nt.j=(h,o)=>we(qr(h,{type:"json"}),o),nt.k=ae,nt.l=ce,nt.m=we,nt.n=(h,o)=>we(qr(h,{type:"arrayBuffer"}),o),nt.o=function(h){return new Ls(h).readFields(Sg,[])},nt.p=b_,nt.q=function(h){return/[\u02EA\u02EB\u1100-\u11FF\u2E80-\u2FDF\u3000-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(h))},nt.r=Mu,nt.s=ql,nt.t=_s,nt.u=Jt,nt.v=xu,nt.w=ho,nt.x=Ap,nt.y=Nd,nt.z=Su}),Dt("worker",["./shared"],function(nt){class i{constructor(St,Pt){this.keyCache={},St&&this.replace(St,Pt)}replace(St,Pt){this._layerConfigs={},this._layers={},this.update(St,[],Pt)}update(St,Pt,Nt){for(const ae of St){this._layerConfigs[ae.id]=ae;const Fe=this._layers[ae.id]=nt.bS(ae,Nt);Fe._featureFilter=nt.aj(Fe.filter,Nt),this.keyCache[ae.id]&&delete this.keyCache[ae.id]}for(const ae of Pt)delete this.keyCache[ae],delete this._layerConfigs[ae],delete this._layers[ae];this.familiesBySource={};const ce=nt.cL(Object.values(this._layerConfigs),this.keyCache);for(const ae of ce){const Fe=ae.map(cr=>this._layers[cr.id]),Jt=Fe[0];if(Jt.visibility==="none")continue;const De=Jt.source||"";let We=this.familiesBySource[De];We||(We=this.familiesBySource[De]={});const ci=Jt.sourceLayer||nt.a9;let ui=We[ci];ui||(ui=We[ci]=[]),ui.push(Fe)}}}class Le{constructor(St){const Pt={},Nt=[];for(const Jt in St){const De=St[Jt],We=Pt[Jt]={};for(const ci in De){const ui=De[+ci];if(!ui||ui.bitmap.width===0||ui.bitmap.height===0)continue;const cr={x:0,y:0,w:ui.bitmap.width+2,h:ui.bitmap.height+2};Nt.push(cr),We[ci]={rect:cr,metrics:ui.metrics}}}const{w:ce,h:ae}=nt.p(Nt),Fe=new nt.r({width:ce||1,height:ae||1});for(const Jt in St){const De=St[Jt];for(const We in De){const ci=De[+We];if(!ci||ci.bitmap.width===0||ci.bitmap.height===0)continue;const ui=Pt[Jt][We].rect;nt.r.copy(ci.bitmap,Fe,{x:0,y:0},{x:ui.x+1,y:ui.y+1},ci.bitmap)}}this.image=Fe,this.positions=Pt}}nt.cM("GlyphAtlas",Le);class wi{constructor(St){this.tileID=new nt.a1(St.tileID.overscaledZ,St.tileID.wrap,St.tileID.canonical.z,St.tileID.canonical.x,St.tileID.canonical.y),this.uid=St.uid,this.zoom=St.zoom,this.pixelRatio=St.pixelRatio,this.tileSize=St.tileSize,this.source=St.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=St.showCollisionBoxes,this.collectResourceTiming=!!St.collectResourceTiming,this.returnDependencies=!!St.returnDependencies,this.promoteId=St.promoteId,this.inFlightDependencies=[]}parse(St,Pt,Nt,ce,ae){return nt._(this,void 0,void 0,function*(){this.status="parsing",this.data=St,this.collisionBoxArray=new nt.ah;const Fe=new nt.cN(Object.keys(St.layers).sort()),Jt=new nt.cO(this.tileID,this.promoteId);Jt.bucketLayerIDs=[];const De={},We={featureIndex:Jt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},dashDependencies:{},availableImages:Nt,subdivisionGranularity:ae},ci=Pt.familiesBySource[this.source];for(const wt in ci){const Bt=St.layers[wt];if(!Bt)continue;Bt.version===1&&nt.w(`Vector tile source "${this.source}" layer "${wt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Ht=Fe.encode(wt),oe=[];for(let ye=0;ye<Bt.length;ye++){const Yt=Bt.feature(ye),xe=Jt.getId(Yt,wt);oe.push({feature:Yt,id:xe,index:ye,sourceLayerIndex:Ht})}for(const ye of ci[wt]){const Yt=ye[0];Yt.source!==this.source&&nt.w(`layer.source = ${Yt.source} does not equal this.source = ${this.source}`),Yt.isHidden(this.zoom,!0)||(nr(ye,this.zoom,Nt),(De[Yt.id]=Yt.createBucket({index:Jt.bucketLayerIDs.length,layers:ye,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Ht,sourceID:this.source})).populate(oe,We,this.tileID.canonical),Jt.bucketLayerIDs.push(ye.map(xe=>xe.id)))}}const ui=nt.bX(We.glyphDependencies,wt=>Object.keys(wt).map(Number));this.inFlightDependencies.forEach(wt=>wt==null?void 0:wt.abort()),this.inFlightDependencies=[];let cr=Promise.resolve({});if(Object.keys(ui).length){const wt=new AbortController;this.inFlightDependencies.push(wt),cr=ce.sendAsync({type:"GG",data:{stacks:ui,source:this.source,tileID:this.tileID,type:"glyphs"}},wt)}const zr=Object.keys(We.iconDependencies);let Ae=Promise.resolve({});if(zr.length){const wt=new AbortController;this.inFlightDependencies.push(wt),Ae=ce.sendAsync({type:"GI",data:{icons:zr,source:this.source,tileID:this.tileID,type:"icons"}},wt)}const Do=Object.keys(We.patternDependencies);let An=Promise.resolve({});if(Do.length){const wt=new AbortController;this.inFlightDependencies.push(wt),An=ce.sendAsync({type:"GI",data:{icons:Do,source:this.source,tileID:this.tileID,type:"patterns"}},wt)}const Qn=We.dashDependencies;let ar=Promise.resolve({});if(Object.keys(Qn).length){const wt=new AbortController;this.inFlightDependencies.push(wt),ar=ce.sendAsync({type:"GDA",data:{dashes:Qn}},wt)}const[bi,Zo,zo,se]=yield Promise.all([cr,Ae,An,ar]),st=new Le(bi),tt=new nt.cP(Zo,zo);for(const wt in De){const Bt=De[wt];Bt instanceof nt.ai?(nr(Bt.layers,this.zoom,Nt),nt.cQ({bucket:Bt,glyphMap:bi,glyphPositions:st.positions,imageMap:Zo,imagePositions:tt.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:We.subdivisionGranularity})):Bt.hasDependencies&&(Bt instanceof nt.cR||Bt instanceof nt.cS||Bt instanceof nt.cT)&&(nr(Bt.layers,this.zoom,Nt),Bt.addFeatures(We,this.tileID.canonical,tt.patternPositions,se))}return this.status="done",{buckets:Object.values(De).filter(wt=>!wt.isEmpty()),featureIndex:Jt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:st.image,imageAtlas:tt,dashPositions:se,glyphMap:this.returnDependencies?bi:null,iconMap:this.returnDependencies?Zo:null,glyphPositions:this.returnDependencies?st.positions:null}})}}function nr(we,St,Pt){const Nt=new nt.H(St);for(const ce of we)ce.recalculate(Nt,Pt)}class bn extends nt.cW{constructor(St,Pt){super(new nt.cV,0,Pt,[],[]),this.feature=St,this.type=St.type,this.properties=St.tags?St.tags:{},"id"in St&&(typeof St.id=="string"?this.id=parseInt(St.id,10):typeof St.id!="number"||isNaN(St.id)||(this.id=St.id))}loadGeometry(){const St=[],Pt=this.feature.type===1?[this.feature.geometry]:this.feature.geometry;for(const Nt of Pt){const ce=[];for(const ae of Nt)ce.push(new nt.P(ae[0],ae[1]));St.push(ce)}return St}}class cn extends nt.cU{constructor(St,Pt){super(new nt.cV),this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.version=Pt?Pt.version:1,this.extent=Pt?Pt.extent:4096,this.length=St.length,this.features=St}feature(St){return new bn(this.features[St],this.extent)}}function Rr(we,St){St.writeVarintField(15,we.version||1),St.writeStringField(1,we.name||""),St.writeVarintField(5,we.extent||4096);const Pt={keys:[],values:[],keycache:{},valuecache:{}};for(let ae=0;ae<we.length;ae++)Pt.feature=we.feature(ae),St.writeMessage(2,xr,Pt);const Nt=Pt.keys;for(const ae of Nt)St.writeStringField(3,ae);const ce=Pt.values;for(const ae of ce)St.writeMessage(4,$r,ae)}function xr(we,St){if(!we.feature)return;const Pt=we.feature;Pt.id!==void 0&&St.writeVarintField(1,Pt.id),St.writeMessage(2,Ci,we),St.writeVarintField(3,Pt.type),St.writeMessage(4,pr,Pt)}function Ci(we,St){var Pt;for(const Nt in(Pt=we.feature)==null?void 0:Pt.properties){let ce=we.feature.properties[Nt],ae=we.keycache[Nt];if(ce===null)continue;ae===void 0&&(we.keys.push(Nt),ae=we.keys.length-1,we.keycache[Nt]=ae),St.writeVarint(ae),typeof ce!="string"&&typeof ce!="boolean"&&typeof ce!="number"&&(ce=JSON.stringify(ce));const Fe=typeof ce+":"+ce;let Jt=we.valuecache[Fe];Jt===void 0&&(we.values.push(ce),Jt=we.values.length-1,we.valuecache[Fe]=Jt),St.writeVarint(Jt)}}function Re(we,St){return(St<<3)+(7&we)}function Rn(we){return we<<1^we>>31}function pr(we,St){const Pt=we.loadGeometry(),Nt=we.type;let ce=0,ae=0;for(const Fe of Pt){let Jt=1;Nt===1&&(Jt=Fe.length),St.writeVarint(Re(1,Jt));const De=Nt===3?Fe.length-1:Fe.length;for(let We=0;We<De;We++){We===1&&Nt!==1&&St.writeVarint(Re(2,De-1));const ci=Fe[We].x-ce,ui=Fe[We].y-ae;St.writeVarint(Rn(ci)),St.writeVarint(Rn(ui)),ce+=ci,ae+=ui}we.type===3&&St.writeVarint(Re(7,1))}}function $r(we,St){const Pt=typeof we;Pt==="string"?St.writeStringField(1,we):Pt==="boolean"?St.writeBooleanField(7,we):Pt==="number"&&(we%1!=0?St.writeDoubleField(3,we):we<0?St.writeSVarintField(6,we):St.writeVarintField(5,we))}class En extends nt.cW{constructor(St,Pt,Nt,ce,ae){super(new nt.cV,0,ae,[],[]),this.type=St,this.properties=Nt||{},this.extent=ae,this.pointsArray=Pt,this.id=ce}loadGeometry(){return this.pointsArray.map(St=>St.map(Pt=>new nt.P(Pt.x,Pt.y)))}}class $o extends nt.cU{constructor(St,Pt,Nt){super(new nt.cV),this.version=2,this._myFeatures=St,this.name=Pt,this.length=St.length,this.extent=Nt}feature(St){return this._myFeatures[St]}}class no{constructor(){this.layers={}}addLayer(St){this.layers[St.name]=St}}function bo(we){let St=function(Pt){const Nt=new nt.cV;return function(ce,ae){for(const Fe in ce.layers)ae.writeMessage(3,Rr,ce.layers[Fe])}(Pt,Nt),Nt.finish()}(we);return St.byteOffset===0&&St.byteLength===St.buffer.byteLength||(St=new Uint8Array(St)),{vectorTile:we,rawData:St.buffer}}function ba(we,St,Pt){const{extent:Nt}=we,ce=Math.pow(2,Pt.z-St.z),ae=(Pt.x-St.x*ce)*Nt,Fe=(Pt.y-St.y*ce)*Nt,Jt=[];for(let De=0;De<we.length;De++){const We=we.feature(De);let ci=We.loadGeometry();for(const cr of ci)for(const zr of cr)zr.x=zr.x*ce-ae,zr.y=zr.y*ce-Fe;const ui=128;ci=nt.cX(ci,We.type,-ui,-ui,Nt+ui,Nt+ui),ci.length!==0&&Jt.push(new En(We.type,ci,We.properties,We.id,Nt))}return new $o(Jt,we.name,Nt)}class Os{constructor(St,Pt,Nt){this.actor=St,this.layerIndex=Pt,this.availableImages=Nt,this.fetching={},this.loading={},this.loaded={},this.overzoomedTileResultCache=new nt.cY(1e3)}loadVectorTile(St,Pt){return nt._(this,void 0,void 0,function*(){const Nt=yield nt.n(St.request,Pt);try{return{vectorTile:St.encoding!=="mlt"?new nt.cZ(new nt.cV(Nt.data)):new nt.c_(Nt.data),rawData:Nt.data,cacheControl:Nt.cacheControl,expires:Nt.expires}}catch(ce){const ae=new Uint8Array(Nt.data);let Fe=`Unable to parse the tile at ${St.request.url}, `;throw Fe+=ae[0]===31&&ae[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ce.message}`,new Error(Fe)}})}loadTile(St){return nt._(this,void 0,void 0,function*(){const{uid:Pt,overzoomParameters:Nt}=St;Nt&&(St.request=Nt.overzoomRequest);const ce=!!(St&&St.request&&St.request.collectResourceTiming)&&new nt.c$(St.request),ae=new wi(St);this.loading[Pt]=ae;const Fe=new AbortController;ae.abort=Fe;try{const Jt=yield this.loadVectorTile(St,Fe);if(delete this.loading[Pt],!Jt)return null;if(Nt){const cr=this._getOverzoomTile(St,Jt.vectorTile);Jt.rawData=cr.rawData,Jt.vectorTile=cr.vectorTile}const De=Jt.rawData,We={};Jt.expires&&(We.expires=Jt.expires),Jt.cacheControl&&(We.cacheControl=Jt.cacheControl);const ci={};if(ce){const cr=ce.finish();cr&&(ci.resourceTiming=JSON.parse(JSON.stringify(cr)))}ae.vectorTile=Jt.vectorTile;const ui=ae.parse(Jt.vectorTile,this.layerIndex,this.availableImages,this.actor,St.subdivisionGranularity);this.loaded[Pt]=ae,this.fetching[Pt]={rawTileData:De,cacheControl:We,resourceTiming:ci};try{const cr=yield ui;return nt.e({rawTileData:De.slice(0),encoding:St.encoding},cr,We,ci)}finally{delete this.fetching[Pt]}}catch(Jt){throw delete this.loading[Pt],ae.status="done",this.loaded[Pt]=ae,Jt}})}_getOverzoomTile(St,Pt){const{tileID:Nt,source:ce,overzoomParameters:ae}=St,{maxZoomTileID:Fe}=ae,Jt=`${Fe.key}_${Nt.key}`,De=this.overzoomedTileResultCache.get(Jt);if(De)return De;const We=new no,ci=this.layerIndex.familiesBySource[ce];for(const cr in ci){const zr=Pt.layers[cr];if(!zr)continue;const Ae=ba(zr,Fe,Nt.canonical);Ae.length>0&&We.addLayer(Ae)}const ui=bo(We);return this.overzoomedTileResultCache.set(Jt,ui),ui}reloadTile(St){return nt._(this,void 0,void 0,function*(){const Pt=St.uid;if(!this.loaded||!this.loaded[Pt])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const Nt=this.loaded[Pt];if(Nt.showCollisionBoxes=St.showCollisionBoxes,Nt.status==="parsing"){const ce=yield Nt.parse(Nt.vectorTile,this.layerIndex,this.availableImages,this.actor,St.subdivisionGranularity);let ae;if(this.fetching[Pt]){const{rawTileData:Fe,cacheControl:Jt,resourceTiming:De}=this.fetching[Pt];delete this.fetching[Pt],ae=nt.e({rawTileData:Fe.slice(0),encoding:St.encoding},ce,Jt,De)}else ae=ce;return ae}if(Nt.status==="done"&&Nt.vectorTile)return Nt.parse(Nt.vectorTile,this.layerIndex,this.availableImages,this.actor,St.subdivisionGranularity)})}abortTile(St){return nt._(this,void 0,void 0,function*(){const Pt=this.loading,Nt=St.uid;Pt&&Pt[Nt]&&Pt[Nt].abort&&(Pt[Nt].abort.abort(),delete Pt[Nt])})}removeTile(St){return nt._(this,void 0,void 0,function*(){this.loaded&&this.loaded[St.uid]&&delete this.loaded[St.uid]})}}class Ya{constructor(){this.loaded={}}loadTile(St){return nt._(this,void 0,void 0,function*(){const{uid:Pt,encoding:Nt,rawImageData:ce,redFactor:ae,greenFactor:Fe,blueFactor:Jt,baseShift:De}=St,We=ce.width+2,ci=ce.height+2,ui=nt.b(ce)?new nt.R({width:We,height:ci},yield nt.d0(ce,-1,-1,We,ci)):ce,cr=new nt.d1(Pt,ui,Nt,ae,Fe,Jt,De);return this.loaded=this.loaded||{},this.loaded[Pt]=cr,cr})}removeTile(St){const Pt=this.loaded,Nt=St.uid;Pt&&Pt[Nt]&&delete Pt[Nt]}}var al,Ja,Hr=function(){if(Ja)return al;function we(Pt,Nt){if(Pt.length!==0){St(Pt[0],Nt);for(var ce=1;ce<Pt.length;ce++)St(Pt[ce],!Nt)}}function St(Pt,Nt){for(var ce=0,ae=0,Fe=0,Jt=Pt.length,De=Jt-1;Fe<Jt;De=Fe++){var We=(Pt[Fe][0]-Pt[De][0])*(Pt[De][1]+Pt[Fe][1]),ci=ce+We;ae+=Math.abs(ce)>=Math.abs(We)?ce-ci+We:We-ci+ce,ce=ci}ce+ae>=0!=!!Nt&&Pt.reverse()}return Ja=1,al=function Pt(Nt,ce){var ae,Fe=Nt&&Nt.type;if(Fe==="FeatureCollection")for(ae=0;ae<Nt.features.length;ae++)Pt(Nt.features[ae],ce);else if(Fe==="GeometryCollection")for(ae=0;ae<Nt.geometries.length;ae++)Pt(Nt.geometries[ae],ce);else if(Fe==="Feature")Pt(Nt.geometry,ce);else if(Fe==="Polygon")we(Nt.coordinates,ce);else if(Fe==="MultiPolygon")for(ae=0;ae<Nt.coordinates.length;ae++)we(Nt.coordinates[ae],ce);return Nt}}(),sc=nt.d2(Hr);const cs={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:we=>we},Kn=Math.fround||(hn=new Float32Array(1),we=>(hn[0]=+we,hn[0]));var hn;class Co{constructor(St){this.options=Object.assign(Object.create(cs),St),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(St){const{log:Pt,minZoom:Nt,maxZoom:ce}=this.options;Pt&&console.time("total time");const ae=`prepare ${St.length} points`;Pt&&console.time(ae),this.points=St;const Fe=[];for(let De=0;De<St.length;De++){const We=St[De];if(!We.geometry)continue;const[ci,ui]=We.geometry.coordinates,cr=Kn(vs(ci)),zr=Kn(Ps(ui));Fe.push(cr,zr,1/0,De,-1,1),this.options.reduce&&Fe.push(0)}let Jt=this.trees[ce+1]=this._createTree(Fe);Pt&&console.timeEnd(ae);for(let De=ce;De>=Nt;De--){const We=+Date.now();Jt=this.trees[De]=this._createTree(this._cluster(Jt,De)),Pt&&console.log("z%d: %d clusters in %dms",De,Jt.numItems,+Date.now()-We)}return Pt&&console.timeEnd("total time"),this}getClusters(St,Pt){let Nt=((St[0]+180)%360+360)%360-180;const ce=Math.max(-90,Math.min(90,St[1]));let ae=St[2]===180?180:((St[2]+180)%360+360)%360-180;const Fe=Math.max(-90,Math.min(90,St[3]));if(St[2]-St[0]>=360)Nt=-180,ae=180;else if(Nt>ae){const ui=this.getClusters([Nt,ce,180,Fe],Pt),cr=this.getClusters([-180,ce,ae,Fe],Pt);return ui.concat(cr)}const Jt=this.trees[this._limitZoom(Pt)],De=Jt.range(vs(Nt),Ps(Fe),vs(ae),Ps(ce)),We=Jt.data,ci=[];for(const ui of De){const cr=this.stride*ui;ci.push(We[cr+5]>1?zn(We,cr,this.clusterProps):this.points[We[cr+3]])}return ci}getChildren(St){const Pt=this._getOriginId(St),Nt=this._getOriginZoom(St),ce="No cluster with the specified id.",ae=this.trees[Nt];if(!ae)throw new Error(ce);const Fe=ae.data;if(Pt*this.stride>=Fe.length)throw new Error(ce);const Jt=this.options.radius/(this.options.extent*Math.pow(2,Nt-1)),De=ae.within(Fe[Pt*this.stride],Fe[Pt*this.stride+1],Jt),We=[];for(const ci of De){const ui=ci*this.stride;Fe[ui+4]===St&&We.push(Fe[ui+5]>1?zn(Fe,ui,this.clusterProps):this.points[Fe[ui+3]])}if(We.length===0)throw new Error(ce);return We}getLeaves(St,Pt,Nt){const ce=[];return this._appendLeaves(ce,St,Pt=Pt||10,Nt=Nt||0,0),ce}getTile(St,Pt,Nt){const ce=this.trees[this._limitZoom(St)],ae=Math.pow(2,St),{extent:Fe,radius:Jt}=this.options,De=Jt/Fe,We=(Nt-De)/ae,ci=(Nt+1+De)/ae,ui={features:[]};return this._addTileFeatures(ce.range((Pt-De)/ae,We,(Pt+1+De)/ae,ci),ce.data,Pt,Nt,ae,ui),Pt===0&&this._addTileFeatures(ce.range(1-De/ae,We,1,ci),ce.data,ae,Nt,ae,ui),Pt===ae-1&&this._addTileFeatures(ce.range(0,We,De/ae,ci),ce.data,-1,Nt,ae,ui),ui.features.length?ui:null}getClusterExpansionZoom(St){let Pt=this._getOriginZoom(St)-1;for(;Pt<=this.options.maxZoom;){const Nt=this.getChildren(St);if(Pt++,Nt.length!==1)break;St=Nt[0].properties.cluster_id}return Pt}_appendLeaves(St,Pt,Nt,ce,ae){const Fe=this.getChildren(Pt);for(const Jt of Fe){const De=Jt.properties;if(De&&De.cluster?ae+De.point_count<=ce?ae+=De.point_count:ae=this._appendLeaves(St,De.cluster_id,Nt,ce,ae):ae<ce?ae++:St.push(Jt),St.length===Nt)break}return ae}_createTree(St){const Pt=new nt.aS(St.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Nt=0;Nt<St.length;Nt+=this.stride)Pt.add(St[Nt],St[Nt+1]);return Pt.finish(),Pt.data=St,Pt}_addTileFeatures(St,Pt,Nt,ce,ae,Fe){for(const Jt of St){const De=Jt*this.stride,We=Pt[De+5]>1;let ci,ui,cr;if(We)ci=Ys(Pt,De,this.clusterProps),ui=Pt[De],cr=Pt[De+1];else{const Do=this.points[Pt[De+3]];ci=Do.properties;const[An,Qn]=Do.geometry.coordinates;ui=vs(An),cr=Ps(Qn)}const zr={type:1,geometry:[[Math.round(this.options.extent*(ui*ae-Nt)),Math.round(this.options.extent*(cr*ae-ce))]],tags:ci};let Ae;Ae=We||this.options.generateId?Pt[De+3]:this.points[Pt[De+3]].id,Ae!==void 0&&(zr.id=Ae),Fe.features.push(zr)}}_limitZoom(St){return Math.max(this.options.minZoom,Math.min(Math.floor(+St),this.options.maxZoom+1))}_cluster(St,Pt){const{radius:Nt,extent:ce,reduce:ae,minPoints:Fe}=this.options,Jt=Nt/(ce*Math.pow(2,Pt)),De=St.data,We=[],ci=this.stride;for(let ui=0;ui<De.length;ui+=ci){if(De[ui+2]<=Pt)continue;De[ui+2]=Pt;const cr=De[ui],zr=De[ui+1],Ae=St.within(De[ui],De[ui+1],Jt),Do=De[ui+5];let An=Do;for(const Qn of Ae){const ar=Qn*ci;De[ar+2]>Pt&&(An+=De[ar+5])}if(An>Do&&An>=Fe){let Qn,ar=cr*Do,bi=zr*Do,Zo=-1;const zo=(ui/ci<<5)+(Pt+1)+this.points.length;for(const se of Ae){const st=se*ci;if(De[st+2]<=Pt)continue;De[st+2]=Pt;const tt=De[st+5];ar+=De[st]*tt,bi+=De[st+1]*tt,De[st+4]=zo,ae&&(Qn||(Qn=this._map(De,ui,!0),Zo=this.clusterProps.length,this.clusterProps.push(Qn)),ae(Qn,this._map(De,st)))}De[ui+4]=zo,We.push(ar/An,bi/An,1/0,zo,-1,An),ae&&We.push(Zo)}else{for(let Qn=0;Qn<ci;Qn++)We.push(De[ui+Qn]);if(An>1)for(const Qn of Ae){const ar=Qn*ci;if(!(De[ar+2]<=Pt)){De[ar+2]=Pt;for(let bi=0;bi<ci;bi++)We.push(De[ar+bi])}}}}return We}_getOriginId(St){return St-this.points.length>>5}_getOriginZoom(St){return(St-this.points.length)%32}_map(St,Pt,Nt){if(St[Pt+5]>1){const Fe=this.clusterProps[St[Pt+6]];return Nt?Object.assign({},Fe):Fe}const ce=this.points[St[Pt+3]].properties,ae=this.options.map(ce);return Nt&&ae===ce?Object.assign({},ae):ae}}function zn(we,St,Pt){return{type:"Feature",id:we[St+3],properties:Ys(we,St,Pt),geometry:{type:"Point",coordinates:[(Nt=we[St],360*(Nt-.5)),Hn(we[St+1])]}};var Nt}function Ys(we,St,Pt){const Nt=we[St+5],ce=Nt>=1e4?`${Math.round(Nt/1e3)}k`:Nt>=1e3?Math.round(Nt/100)/10+"k":Nt,ae=we[St+6],Fe=ae===-1?{}:Object.assign({},Pt[ae]);return Object.assign(Fe,{cluster:!0,cluster_id:we[St+3],point_count:Nt,point_count_abbreviated:ce})}function vs(we){return we/360+.5}function Ps(we){const St=Math.sin(we*Math.PI/180),Pt=.5-.25*Math.log((1+St)/(1-St))/Math.PI;return Pt<0?0:Pt>1?1:Pt}function Hn(we){const St=(180-360*we)*Math.PI/180;return 360*Math.atan(Math.exp(St))/Math.PI-90}function di(we,St,Pt,Nt){let ce=Nt;const ae=St+(Pt-St>>1);let Fe,Jt=Pt-St;const De=we[St],We=we[St+1],ci=we[Pt],ui=we[Pt+1];for(let cr=St+3;cr<Pt;cr+=3){const zr=tr(we[cr],we[cr+1],De,We,ci,ui);if(zr>ce)Fe=cr,ce=zr;else if(zr===ce){const Ae=Math.abs(cr-ae);Ae<Jt&&(Fe=cr,Jt=Ae)}}ce>Nt&&(Fe-St>3&&di(we,St,Fe,Nt),we[Fe+2]=ce,Pt-Fe>3&&di(we,Fe,Pt,Nt))}function tr(we,St,Pt,Nt,ce,ae){let Fe=ce-Pt,Jt=ae-Nt;if(Fe!==0||Jt!==0){const De=((we-Pt)*Fe+(St-Nt)*Jt)/(Fe*Fe+Jt*Jt);De>1?(Pt=ce,Nt=ae):De>0&&(Pt+=Fe*De,Nt+=Jt*De)}return Fe=we-Pt,Jt=St-Nt,Fe*Fe+Jt*Jt}function fr(we,St,Pt,Nt){const ce={id:we??null,type:St,geometry:Pt,tags:Nt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(St==="Point"||St==="MultiPoint"||St==="LineString")Wr(ce,Pt);else if(St==="Polygon")Wr(ce,Pt[0]);else if(St==="MultiLineString")for(const ae of Pt)Wr(ce,ae);else if(St==="MultiPolygon")for(const ae of Pt)Wr(ce,ae[0]);return ce}function Wr(we,St){for(let Pt=0;Pt<St.length;Pt+=3)we.minX=Math.min(we.minX,St[Pt]),we.minY=Math.min(we.minY,St[Pt+1]),we.maxX=Math.max(we.maxX,St[Pt]),we.maxY=Math.max(we.maxY,St[Pt+1])}function qr(we,St,Pt,Nt){if(!St.geometry)return;const ce=St.geometry.coordinates;if(ce&&ce.length===0)return;const ae=St.geometry.type,Fe=Math.pow(Pt.tolerance/((1<<Pt.maxZoom)*Pt.extent),2);let Jt=[],De=St.id;if(Pt.promoteId?De=St.properties[Pt.promoteId]:Pt.generateId&&(De=Nt||0),ae==="Point")Xi(ce,Jt);else if(ae==="MultiPoint")for(const We of ce)Xi(We,Jt);else if(ae==="LineString")Xr(ce,Jt,Fe,!1);else if(ae==="MultiLineString"){if(Pt.lineMetrics){for(const We of ce)Jt=[],Xr(We,Jt,Fe,!1),we.push(fr(De,"LineString",Jt,St.properties));return}$n(ce,Jt,Fe,!1)}else if(ae==="Polygon")$n(ce,Jt,Fe,!0);else{if(ae!=="MultiPolygon"){if(ae==="GeometryCollection"){for(const We of St.geometry.geometries)qr(we,{id:De,geometry:We,properties:St.properties},Pt,Nt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const We of ce){const ci=[];$n(We,ci,Fe,!0),Jt.push(ci)}}we.push(fr(De,ae,Jt,St.properties))}function Xi(we,St){St.push(qo(we[0]),On(we[1]),0)}function Xr(we,St,Pt,Nt){let ce,ae,Fe=0;for(let De=0;De<we.length;De++){const We=qo(we[De][0]),ci=On(we[De][1]);St.push(We,ci,0),De>0&&(Fe+=Nt?(ce*ci-We*ae)/2:Math.sqrt(Math.pow(We-ce,2)+Math.pow(ci-ae,2))),ce=We,ae=ci}const Jt=St.length-3;St[2]=1,di(St,0,Jt,Pt),St[Jt+2]=1,St.size=Math.abs(Fe),St.start=0,St.end=St.size}function $n(we,St,Pt,Nt){for(let ce=0;ce<we.length;ce++){const ae=[];Xr(we[ce],ae,Pt,Nt),St.push(ae)}}function qo(we){return we/360+.5}function On(we){const St=Math.sin(we*Math.PI/180),Pt=.5-.25*Math.log((1+St)/(1-St))/Math.PI;return Pt<0?0:Pt>1?1:Pt}function ho(we,St,Pt,Nt,ce,ae,Fe,Jt){if(Nt/=St,ae>=(Pt/=St)&&Fe<Nt)return we;if(Fe<Pt||ae>=Nt)return null;const De=[];for(const We of we){const ci=We.geometry;let ui=We.type;const cr=ce===0?We.minX:We.minY,zr=ce===0?We.maxX:We.maxY;if(cr>=Pt&&zr<Nt){De.push(We);continue}if(zr<Pt||cr>=Nt)continue;let Ae=[];if(ui==="Point"||ui==="MultiPoint")ds(ci,Ae,Pt,Nt,ce);else if(ui==="LineString")Ns(ci,Ae,Pt,Nt,ce,!1,Jt.lineMetrics);else if(ui==="MultiLineString")oo(ci,Ae,Pt,Nt,ce,!1);else if(ui==="Polygon")oo(ci,Ae,Pt,Nt,ce,!0);else if(ui==="MultiPolygon")for(const Do of ci){const An=[];oo(Do,An,Pt,Nt,ce,!0),An.length&&Ae.push(An)}if(Ae.length){if(Jt.lineMetrics&&ui==="LineString"){for(const Do of Ae)De.push(fr(We.id,ui,Do,We.tags));continue}ui!=="LineString"&&ui!=="MultiLineString"||(Ae.length===1?(ui="LineString",Ae=Ae[0]):ui="MultiLineString"),ui!=="Point"&&ui!=="MultiPoint"||(ui=Ae.length===3?"Point":"MultiPoint"),De.push(fr(We.id,ui,Ae,We.tags))}}return De.length?De:null}function ds(we,St,Pt,Nt,ce){for(let ae=0;ae<we.length;ae+=3){const Fe=we[ae+ce];Fe>=Pt&&Fe<=Nt&&ll(St,we[ae],we[ae+1],we[ae+2])}}function Ns(we,St,Pt,Nt,ce,ae,Fe){let Jt=xo(we);const De=ce===0?$l:Ms;let We,ci,ui=we.start;for(let An=0;An<we.length-3;An+=3){const Qn=we[An],ar=we[An+1],bi=we[An+2],Zo=we[An+3],zo=we[An+4],se=ce===0?Qn:ar,st=ce===0?Zo:zo;let tt=!1;Fe&&(We=Math.sqrt(Math.pow(Qn-Zo,2)+Math.pow(ar-zo,2))),se<Pt?st>Pt&&(ci=De(Jt,Qn,ar,Zo,zo,Pt),Fe&&(Jt.start=ui+We*ci)):se>Nt?st<Nt&&(ci=De(Jt,Qn,ar,Zo,zo,Nt),Fe&&(Jt.start=ui+We*ci)):ll(Jt,Qn,ar,bi),st<Pt&&se>=Pt&&(ci=De(Jt,Qn,ar,Zo,zo,Pt),tt=!0),st>Nt&&se<=Nt&&(ci=De(Jt,Qn,ar,Zo,zo,Nt),tt=!0),!ae&&tt&&(Fe&&(Jt.end=ui+We*ci),St.push(Jt),Jt=xo(we)),Fe&&(ui+=We)}let cr=we.length-3;const zr=we[cr],Ae=we[cr+1],Do=ce===0?zr:Ae;Do>=Pt&&Do<=Nt&&ll(Jt,zr,Ae,we[cr+2]),cr=Jt.length-3,ae&&cr>=3&&(Jt[cr]!==Jt[0]||Jt[cr+1]!==Jt[1])&&ll(Jt,Jt[0],Jt[1],Jt[2]),Jt.length&&St.push(Jt)}function xo(we){const St=[];return St.size=we.size,St.start=we.start,St.end=we.end,St}function oo(we,St,Pt,Nt,ce,ae){for(const Fe of we)Ns(Fe,St,Pt,Nt,ce,ae,!1)}function ll(we,St,Pt,Nt){we.push(St,Pt,Nt)}function $l(we,St,Pt,Nt,ce,ae){const Fe=(ae-St)/(Nt-St);return ll(we,ae,Pt+(ce-Pt)*Fe,1),Fe}function Ms(we,St,Pt,Nt,ce,ae){const Fe=(ae-Pt)/(ce-Pt);return ll(we,St+(Nt-St)*Fe,ae,1),Fe}function wa(we,St){const Pt=[];for(let Nt=0;Nt<we.length;Nt++){const ce=we[Nt],ae=ce.type;let Fe;if(ae==="Point"||ae==="MultiPoint"||ae==="LineString")Fe=ql(ce.geometry,St);else if(ae==="MultiLineString"||ae==="Polygon"){Fe=[];for(const Jt of ce.geometry)Fe.push(ql(Jt,St))}else if(ae==="MultiPolygon"){Fe=[];for(const Jt of ce.geometry){const De=[];for(const We of Jt)De.push(ql(We,St));Fe.push(De)}}Pt.push(fr(ce.id,ae,Fe,ce.tags))}return Pt}function ql(we,St){const Pt=[];Pt.size=we.size,we.start!==void 0&&(Pt.start=we.start,Pt.end=we.end);for(let Nt=0;Nt<we.length;Nt+=3)Pt.push(we[Nt]+St,we[Nt+1],we[Nt+2]);return Pt}function bs(we,St){if(we.transformed)return we;const Pt=1<<we.z,Nt=we.x,ce=we.y;for(const ae of we.features){const Fe=ae.geometry,Jt=ae.type;if(ae.geometry=[],Jt===1)for(let De=0;De<Fe.length;De+=2)ae.geometry.push(Cs(Fe[De],Fe[De+1],St,Pt,Nt,ce));else for(let De=0;De<Fe.length;De++){const We=[];for(let ci=0;ci<Fe[De].length;ci+=2)We.push(Cs(Fe[De][ci],Fe[De][ci+1],St,Pt,Nt,ce));ae.geometry.push(We)}}return we.transformed=!0,we}function Cs(we,St,Pt,Nt,ce,ae){return[Math.round(Pt*(we*Nt-ce)),Math.round(Pt*(St*Nt-ae))]}function cl(we,St,Pt,Nt,ce){const ae=St===ce.maxZoom?0:ce.tolerance/((1<<St)*ce.extent),Fe={features:[],numPoints:0,numSimplified:0,numFeatures:we.length,source:null,x:Pt,y:Nt,z:St,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Jt of we)Ml(Fe,Jt,ae,ce);return Fe}function Ml(we,St,Pt,Nt){const ce=St.geometry,ae=St.type,Fe=[];if(we.minX=Math.min(we.minX,St.minX),we.minY=Math.min(we.minY,St.minY),we.maxX=Math.max(we.maxX,St.maxX),we.maxY=Math.max(we.maxY,St.maxY),ae==="Point"||ae==="MultiPoint")for(let Jt=0;Jt<ce.length;Jt+=3)Fe.push(ce[Jt],ce[Jt+1]),we.numPoints++,we.numSimplified++;else if(ae==="LineString")Cl(Fe,ce,we,Pt,!1,!1);else if(ae==="MultiLineString"||ae==="Polygon")for(let Jt=0;Jt<ce.length;Jt++)Cl(Fe,ce[Jt],we,Pt,ae==="Polygon",Jt===0);else if(ae==="MultiPolygon")for(let Jt=0;Jt<ce.length;Jt++){const De=ce[Jt];for(let We=0;We<De.length;We++)Cl(Fe,De[We],we,Pt,!0,We===0)}if(Fe.length){let Jt=St.tags||null;if(ae==="LineString"&&Nt.lineMetrics){Jt={};for(const We in St.tags)Jt[We]=St.tags[We];Jt.mapbox_clip_start=ce.start/ce.size,Jt.mapbox_clip_end=ce.end/ce.size}const De={geometry:Fe,type:ae==="Polygon"||ae==="MultiPolygon"?3:ae==="LineString"||ae==="MultiLineString"?2:1,tags:Jt};St.id!==null&&(De.id=St.id),we.features.push(De)}}function Cl(we,St,Pt,Nt,ce,ae){const Fe=Nt*Nt;if(Nt>0&&St.size<(ce?Fe:Nt))return void(Pt.numPoints+=St.length/3);const Jt=[];for(let De=0;De<St.length;De+=3)(Nt===0||St[De+2]>Fe)&&(Pt.numSimplified++,Jt.push(St[De],St[De+1])),Pt.numPoints++;ce&&function(De,We){let ci=0;for(let ui=0,cr=De.length,zr=cr-2;ui<cr;zr=ui,ui+=2)ci+=(De[ui]-De[zr])*(De[ui+1]+De[zr+1]);if(ci>0===We)for(let ui=0,cr=De.length;ui<cr/2;ui+=2){const zr=De[ui],Ae=De[ui+1];De[ui]=De[cr-2-ui],De[ui+1]=De[cr-1-ui],De[cr-2-ui]=zr,De[cr-1-ui]=Ae}}(Jt,ae),we.push(Jt)}const Vs={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class hl{constructor(St,Pt){const Nt=(Pt=this.options=function(ae,Fe){for(const Jt in Fe)ae[Jt]=Fe[Jt];return ae}(Object.create(Vs),Pt)).debug;if(Nt&&console.time("preprocess data"),Pt.maxZoom<0||Pt.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Pt.promoteId&&Pt.generateId)throw new Error("promoteId and generateId cannot be used together.");let ce=function(ae,Fe){const Jt=[];if(ae.type==="FeatureCollection")for(let De=0;De<ae.features.length;De++)qr(Jt,ae.features[De],Fe,De);else qr(Jt,ae.type==="Feature"?ae:{geometry:ae},Fe);return Jt}(St,Pt);this.tiles={},this.tileCoords=[],Nt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Pt.indexMaxZoom,Pt.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ce=function(ae,Fe){const Jt=Fe.buffer/Fe.extent;let De=ae;const We=ho(ae,1,-1-Jt,Jt,0,-1,2,Fe),ci=ho(ae,1,1-Jt,2+Jt,0,-1,2,Fe);return(We||ci)&&(De=ho(ae,1,-Jt,1+Jt,0,-1,2,Fe)||[],We&&(De=wa(We,1).concat(De)),ci&&(De=De.concat(wa(ci,-1)))),De}(ce,Pt),ce.length&&this.splitTile(ce,0,0,0),Nt&&(ce.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(St,Pt,Nt,ce,ae,Fe,Jt){const De=[St,Pt,Nt,ce],We=this.options,ci=We.debug;for(;De.length;){ce=De.pop(),Nt=De.pop(),Pt=De.pop(),St=De.pop();const ui=1<<Pt,cr=Ka(Pt,Nt,ce);let zr=this.tiles[cr];if(!zr&&(ci>1&&console.time("creation"),zr=this.tiles[cr]=cl(St,Pt,Nt,ce,We),this.tileCoords.push({z:Pt,x:Nt,y:ce}),ci)){ci>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Pt,Nt,ce,zr.numFeatures,zr.numPoints,zr.numSimplified),console.timeEnd("creation"));const tt=`z${Pt}`;this.stats[tt]=(this.stats[tt]||0)+1,this.total++}if(zr.source=St,ae==null){if(Pt===We.indexMaxZoom||zr.numPoints<=We.indexMaxPoints)continue}else{if(Pt===We.maxZoom||Pt===ae)continue;if(ae!=null){const tt=ae-Pt;if(Nt!==Fe>>tt||ce!==Jt>>tt)continue}}if(zr.source=null,St.length===0)continue;ci>1&&console.time("clipping");const Ae=.5*We.buffer/We.extent,Do=.5-Ae,An=.5+Ae,Qn=1+Ae;let ar=null,bi=null,Zo=null,zo=null,se=ho(St,ui,Nt-Ae,Nt+An,0,zr.minX,zr.maxX,We),st=ho(St,ui,Nt+Do,Nt+Qn,0,zr.minX,zr.maxX,We);St=null,se&&(ar=ho(se,ui,ce-Ae,ce+An,1,zr.minY,zr.maxY,We),bi=ho(se,ui,ce+Do,ce+Qn,1,zr.minY,zr.maxY,We),se=null),st&&(Zo=ho(st,ui,ce-Ae,ce+An,1,zr.minY,zr.maxY,We),zo=ho(st,ui,ce+Do,ce+Qn,1,zr.minY,zr.maxY,We),st=null),ci>1&&console.timeEnd("clipping"),De.push(ar||[],Pt+1,2*Nt,2*ce),De.push(bi||[],Pt+1,2*Nt,2*ce+1),De.push(Zo||[],Pt+1,2*Nt+1,2*ce),De.push(zo||[],Pt+1,2*Nt+1,2*ce+1)}}getTile(St,Pt,Nt){St=+St,Pt=+Pt,Nt=+Nt;const ce=this.options,{extent:ae,debug:Fe}=ce;if(St<0||St>24)return null;const Jt=1<<St,De=Ka(St,Pt=Pt+Jt&Jt-1,Nt);if(this.tiles[De])return bs(this.tiles[De],ae);Fe>1&&console.log("drilling down to z%d-%d-%d",St,Pt,Nt);let We,ci=St,ui=Pt,cr=Nt;for(;!We&&ci>0;)ci--,ui>>=1,cr>>=1,We=this.tiles[Ka(ci,ui,cr)];return We&&We.source?(Fe>1&&(console.log("found parent tile z%d-%d-%d",ci,ui,cr),console.time("drilling down")),this.splitTile(We.source,ci,ui,cr,St,Pt,Nt),Fe>1&&console.timeEnd("drilling down"),this.tiles[De]?bs(this.tiles[De],ae):null):null}}function Ka(we,St,Pt){return 32*((1<<we)*Pt+St)+we}class Zl extends Os{constructor(St,Pt,Nt,ce=Da){super(St,Pt,Nt),this._dataUpdateable=new Map,this._createGeoJSONIndex=ce}loadVectorTile(St,Pt){return nt._(this,void 0,void 0,function*(){const Nt=St.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const ce=this._geoJSONIndex.getTile(Nt.z,Nt.x,Nt.y);return ce?bo(new cn(ce.features,{version:2,extent:nt.a4})):null})}loadData(St){return nt._(this,void 0,void 0,function*(){var Pt;(Pt=this._pendingRequest)===null||Pt===void 0||Pt.abort();const Nt=this._startPerformance(St);this._pendingRequest=new AbortController;try{(!this._pendingData||St.request||St.data||St.dataDiff)&&(this._pendingData=this.loadAndProcessGeoJSON(St,this._pendingRequest));const ce=yield this._pendingData;this._geoJSONIndex=this._createGeoJSONIndex(ce,St),this.loaded={};const ae=St.dataDiff&&nt.a6(ce)?{applyDiff:!0}:{data:ce};return this._finishPerformance(Nt,St,ae),ae}catch(ce){if(delete this._pendingRequest,nt.cH(ce))return{abandoned:!0};throw ce}})}_startPerformance(St){var Pt;if(!((Pt=St==null?void 0:St.request)===null||Pt===void 0)&&Pt.collectResourceTiming)return new nt.c$(St.request)}_finishPerformance(St,Pt,Nt){if(!St)return;const ce=St.finish();ce&&(Nt.resourceTiming={},Nt.resourceTiming[Pt.source]=JSON.parse(JSON.stringify(ce)))}getData(){return nt._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(St){const Pt=this.loaded;return Pt&&Pt[St.uid]?super.reloadTile(St):this.loadTile(St)}loadAndProcessGeoJSON(St,Pt){return nt._(this,void 0,void 0,function*(){let Nt;if(St.request?Nt=yield this.loadGeoJSONFromUrl(St.request,St.promoteId,Pt):St.data?Nt=this._loadGeoJSONFromObject(St.data,St.promoteId):St.dataDiff&&(Nt=this._loadGeoJSONFromDiff(St.dataDiff,St.promoteId,St.source)),delete this._pendingRequest,typeof Nt!="object")throw new Error(`Input data given to '${St.source}' is not a valid GeoJSON object.`);return sc(Nt,!0),St.filter&&(Nt=this._filterGeoJSON(Nt,St.filter)),Nt})}loadGeoJSONFromUrl(St,Pt,Nt){return nt._(this,void 0,void 0,function*(){const ce=yield nt.j(St,Nt);return this._dataUpdateable=nt.a6(ce.data,Pt)?nt.a7(ce.data,Pt):void 0,ce.data})}_loadGeoJSONFromObject(St,Pt){return this._dataUpdateable=nt.a6(St,Pt)?nt.a7(St,Pt):void 0,St}_loadGeoJSONFromDiff(St,Pt,Nt){if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${Nt}`);nt.a8(this._dataUpdateable,St,Pt);const ce=Array.from(this._dataUpdateable.values());return this._toFeatureCollection(ce)}_filterGeoJSON(St,Pt){const Nt=nt.d3(Pt,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Nt.result==="error")throw new Error(Nt.value.map(ae=>`${ae.key}: ${ae.message}`).join(", "));const ce=St.features.filter(ae=>Nt.value.evaluate({zoom:0},ae));return this._toFeatureCollection(ce)}_toFeatureCollection(St){return{type:"FeatureCollection",features:St}}removeSource(St){return nt._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(St){return this._geoJSONIndex.getClusterExpansionZoom(St.clusterId)}getClusterChildren(St){return this._geoJSONIndex.getChildren(St.clusterId)}getClusterLeaves(St){return this._geoJSONIndex.getLeaves(St.clusterId,St.limit,St.offset)}}function Da(we,St){return St.cluster?new Co(function({superclusterOptions:Pt,clusterProperties:Nt}){if(!Nt||!Pt)return Pt;const ce={},ae={},Fe={accumulated:null,zoom:0},Jt={properties:null},De=Object.keys(Nt);for(const We of De){const[ci,ui]=Nt[We],cr=nt.d3(ui),zr=nt.d3(typeof ci=="string"?[ci,["accumulated"],["get",We]]:ci);ce[We]=cr.value,ae[We]=zr.value}return Pt.map=We=>{Jt.properties=We;const ci={};for(const ui of De)ci[ui]=ce[ui].evaluate(Fe,Jt);return ci},Pt.reduce=(We,ci)=>{Jt.properties=ci;for(const ui of De)Fe.accumulated=We[ui],We[ui]=ae[ui].evaluate(Fe,Jt)},Pt}(St)).load(we.features):function(Pt,Nt){return new hl(Pt,Nt)}(we,St.geojsonVtOptions)}class so{constructor(St){this.self=St,this.actor=new nt.L(St),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.globalStates=new Map,this.self.registerWorkerSource=(Pt,Nt)=>{if(this.externalWorkerSourceTypes[Pt])throw new Error(`Worker source with name "${Pt}" already registered.`);this.externalWorkerSourceTypes[Pt]=Nt},this.self.addProtocol=nt.cJ,this.self.removeProtocol=nt.cK,this.self.registerRTLTextPlugin=Pt=>{nt.d4.setMethods(Pt)},this.actor.registerMessageHandler("LDT",(Pt,Nt)=>this._getDEMWorkerSource(Pt,Nt.source).loadTile(Nt)),this.actor.registerMessageHandler("RDT",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){this._getDEMWorkerSource(Pt,Nt.source).removeTile(Nt)})),this.actor.registerMessageHandler("GCEZ",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){return this._getWorkerSource(Pt,Nt.type,Nt.source).getClusterExpansionZoom(Nt)})),this.actor.registerMessageHandler("GCC",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){return this._getWorkerSource(Pt,Nt.type,Nt.source).getClusterChildren(Nt)})),this.actor.registerMessageHandler("GCL",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){return this._getWorkerSource(Pt,Nt.type,Nt.source).getClusterLeaves(Nt)})),this.actor.registerMessageHandler("LD",(Pt,Nt)=>this._getWorkerSource(Pt,Nt.type,Nt.source).loadData(Nt)),this.actor.registerMessageHandler("GD",(Pt,Nt)=>this._getWorkerSource(Pt,Nt.type,Nt.source).getData()),this.actor.registerMessageHandler("LT",(Pt,Nt)=>this._getWorkerSource(Pt,Nt.type,Nt.source).loadTile(Nt)),this.actor.registerMessageHandler("RT",(Pt,Nt)=>this._getWorkerSource(Pt,Nt.type,Nt.source).reloadTile(Nt)),this.actor.registerMessageHandler("AT",(Pt,Nt)=>this._getWorkerSource(Pt,Nt.type,Nt.source).abortTile(Nt)),this.actor.registerMessageHandler("RMT",(Pt,Nt)=>this._getWorkerSource(Pt,Nt.type,Nt.source).removeTile(Nt)),this.actor.registerMessageHandler("RS",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){if(!this.workerSources[Pt]||!this.workerSources[Pt][Nt.type]||!this.workerSources[Pt][Nt.type][Nt.source])return;const ce=this.workerSources[Pt][Nt.type][Nt.source];delete this.workerSources[Pt][Nt.type][Nt.source],ce.removeSource!==void 0&&ce.removeSource(Nt)})),this.actor.registerMessageHandler("RM",Pt=>nt._(this,void 0,void 0,function*(){delete this.layerIndexes[Pt],delete this.availableImages[Pt],delete this.workerSources[Pt],delete this.demWorkerSources[Pt],this.globalStates.delete(Pt)})),this.actor.registerMessageHandler("SR",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){this.referrer=Nt})),this.actor.registerMessageHandler("SRPS",(Pt,Nt)=>this._syncRTLPluginState(Pt,Nt)),this.actor.registerMessageHandler("IS",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){this.self.importScripts(Nt)})),this.actor.registerMessageHandler("SI",(Pt,Nt)=>this._setImages(Pt,Nt)),this.actor.registerMessageHandler("UL",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){this._getLayerIndex(Pt).update(Nt.layers,Nt.removedIds,this._getGlobalState(Pt))})),this.actor.registerMessageHandler("UGS",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){const ce=this._getGlobalState(Pt);for(const ae in Nt)ce[ae]=Nt[ae]})),this.actor.registerMessageHandler("SL",(Pt,Nt)=>nt._(this,void 0,void 0,function*(){this._getLayerIndex(Pt).replace(Nt,this._getGlobalState(Pt))}))}_getGlobalState(St){let Pt=this.globalStates.get(St);return Pt||(Pt={},this.globalStates.set(St,Pt)),Pt}_setImages(St,Pt){return nt._(this,void 0,void 0,function*(){this.availableImages[St]=Pt;for(const Nt in this.workerSources[St]){const ce=this.workerSources[St][Nt];for(const ae in ce)ce[ae].availableImages=Pt}})}_syncRTLPluginState(St,Pt){return nt._(this,void 0,void 0,function*(){return yield nt.d4.syncState(Pt,this.self.importScripts)})}_getAvailableImages(St){let Pt=this.availableImages[St];return Pt||(Pt=[]),Pt}_getLayerIndex(St){let Pt=this.layerIndexes[St];return Pt||(Pt=this.layerIndexes[St]=new i),Pt}_getWorkerSource(St,Pt,Nt){if(this.workerSources[St]||(this.workerSources[St]={}),this.workerSources[St][Pt]||(this.workerSources[St][Pt]={}),!this.workerSources[St][Pt][Nt]){const ce={sendAsync:(ae,Fe)=>(ae.targetMapId=St,this.actor.sendAsync(ae,Fe))};switch(Pt){case"vector":this.workerSources[St][Pt][Nt]=new Os(ce,this._getLayerIndex(St),this._getAvailableImages(St));break;case"geojson":this.workerSources[St][Pt][Nt]=new Zl(ce,this._getLayerIndex(St),this._getAvailableImages(St));break;default:this.workerSources[St][Pt][Nt]=new this.externalWorkerSourceTypes[Pt](ce,this._getLayerIndex(St),this._getAvailableImages(St))}}return this.workerSources[St][Pt][Nt]}_getDEMWorkerSource(St,Pt){return this.demWorkerSources[St]||(this.demWorkerSources[St]={}),this.demWorkerSources[St][Pt]||(this.demWorkerSources[St][Pt]=new Ya),this.demWorkerSources[St][Pt]}}return nt.i(self)&&(self.worker=new so(self)),so}),Dt("index",["exports","./shared"],function(nt,i){var Le="5.13.0";function wi(){var C=new i.A(4);return i.A!=Float32Array&&(C[1]=0,C[2]=0),C[0]=1,C[3]=1,C}let nr,bn,cn;const Rr={frame(C,s,d){const v=requestAnimationFrame(D=>{S(),s(D)}),{unsubscribe:S}=i.s(C.signal,"abort",()=>{S(),cancelAnimationFrame(v),d(i.c())},!1)},frameAsync(C){return new Promise((s,d)=>{this.frame(C,s,d)})},getImageData(C,s=0){return this.getImageCanvasContext(C).getImageData(-s,-s,C.width+2*s,C.height+2*s)},getImageCanvasContext(C){const s=window.document.createElement("canvas"),d=s.getContext("2d",{willReadFrequently:!0});if(!d)throw new Error("failed to create canvas 2d context");return s.width=C.width,s.height=C.height,d.drawImage(C,0,0,C.width,C.height),d},resolveURL:C=>(nr||(nr=document.createElement("a")),nr.href=C,nr.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return cn!==void 0?cn:!!matchMedia&&(bn==null&&(bn=matchMedia("(prefers-reduced-motion: reduce)")),bn.matches)},set prefersReducedMotion(C){cn=C}},xr=new class{constructor(){this._realTime=typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),this._frozenAt=null}getCurrentTime(){return this._frozenAt!==null?this._frozenAt:this._realTime()}setNow(C){this._frozenAt=C}restoreNow(){this._frozenAt=null}isFrozen(){return this._frozenAt!==null}};function Ci(){return xr.getCurrentTime()}class Re{static testProp(s){if(!Re.docStyle)return s[0];for(let d=0;d<s.length;d++)if(s[d]in Re.docStyle)return s[d];return s[0]}static create(s,d,v){const S=window.document.createElement(s);return d!==void 0&&(S.className=d),v&&v.appendChild(S),S}static createNS(s,d){return window.document.createElementNS(s,d)}static disableDrag(){Re.docStyle&&Re.selectProp&&(Re.userSelect=Re.docStyle[Re.selectProp],Re.docStyle[Re.selectProp]="none")}static enableDrag(){Re.docStyle&&Re.selectProp&&(Re.docStyle[Re.selectProp]=Re.userSelect)}static setTransform(s,d){s.style[Re.transformProp]=d}static addEventListener(s,d,v,S={}){s.addEventListener(d,v,"passive"in S?S:S.capture)}static removeEventListener(s,d,v,S={}){s.removeEventListener(d,v,"passive"in S?S:S.capture)}static suppressClickInternal(s){s.preventDefault(),s.stopPropagation(),window.removeEventListener("click",Re.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",Re.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",Re.suppressClickInternal,!0)},0)}static getScale(s){const d=s.getBoundingClientRect();return{x:d.width/s.offsetWidth||1,y:d.height/s.offsetHeight||1,boundingClientRect:d}}static getPoint(s,d,v){const S=d.boundingClientRect;return new i.P((v.clientX-S.left)/d.x-s.clientLeft,(v.clientY-S.top)/d.y-s.clientTop)}static mousePos(s,d){const v=Re.getScale(s);return Re.getPoint(s,v,d)}static touchPos(s,d){const v=[],S=Re.getScale(s);for(let D=0;D<d.length;D++)v.push(Re.getPoint(s,S,d[D]));return v}static mouseButton(s){return s.button}static remove(s){s.parentNode&&s.parentNode.removeChild(s)}static sanitize(s){const d=new DOMParser().parseFromString(s,"text/html").body||document.createElement("body"),v=d.querySelectorAll("script");for(const S of v)S.remove();return Re.clean(d),d.innerHTML}static isPossiblyDangerous(s,d){const v=d.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(s)||!v.includes("javascript:")&&!v.includes("data:"))||!!s.startsWith("on")||void 0}static clean(s){const d=s.children;for(const v of d)Re.removeAttributes(v),Re.clean(v)}static removeAttributes(s){for(const{name:d,value:v}of s.attributes)Re.isPossiblyDangerous(d,v)&&s.removeAttribute(d)}}Re.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,Re.selectProp=Re.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),Re.transformProp=Re.testProp(["transform","WebkitTransform"]);const Rn={supported:!1,testSupport:function(C){!En&&$r&&($o?no(C):pr=C)}};let pr,$r,En=!1,$o=!1;function no(C){const s=C.createTexture();C.bindTexture(C.TEXTURE_2D,s);try{if(C.texImage2D(C.TEXTURE_2D,0,C.RGBA,C.RGBA,C.UNSIGNED_BYTE,$r),C.isContextLost())return;Rn.supported=!0}catch{}C.deleteTexture(s),En=!0}var bo;typeof document<"u"&&($r=document.createElement("img"),$r.onload=()=>{pr&&no(pr),pr=null,$o=!0},$r.onerror=()=>{En=!0,pr=null},$r.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(C){let s,d,v,S;C.resetRequestQueue=()=>{s=[],d=0,v=0,S={}},C.addThrottleControl=H=>{const J=v++;return S[J]=H,J},C.removeThrottleControl=H=>{delete S[H],k()},C.getImage=(H,J,et=!0)=>new Promise((mt,dt)=>{Rn.supported&&(H.headers||(H.headers={}),H.headers.accept="image/webp,*/*"),i.e(H,{type:"image"}),s.push({abortController:J,requestParameters:H,supportImageRefresh:et,state:"queued",onError:Tt=>{dt(Tt)},onSuccess:Tt=>{mt(Tt)}}),k()});const D=H=>i._(this,void 0,void 0,function*(){H.state="running";const{requestParameters:J,supportImageRefresh:et,onError:mt,onSuccess:dt,abortController:Tt}=H,pt=et===!1&&!i.i(self)&&!i.g(J.url)&&(!J.headers||Object.keys(J.headers).reduce((Wt,ft)=>Wt&&ft==="accept",!0));d++;const It=pt?j(J,Tt):i.m(J,Tt);try{const Wt=yield It;delete H.abortController,H.state="completed",Wt.data instanceof HTMLImageElement||i.b(Wt.data)?dt(Wt):Wt.data&&dt({data:yield(Kt=Wt.data,typeof createImageBitmap=="function"?i.f(Kt):i.h(Kt)),cacheControl:Wt.cacheControl,expires:Wt.expires})}catch(Wt){delete H.abortController,mt(Wt)}finally{d--,k()}var Kt}),k=()=>{const H=(()=>{for(const J of Object.keys(S))if(S[J]())return!0;return!1})()?i.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:i.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let J=d;J<H&&s.length>0;J++){const et=s.shift();et.abortController.signal.aborted?J--:D(et)}},j=(H,J)=>new Promise((et,mt)=>{const dt=new Image,Tt=H.url,pt=H.credentials;pt&&pt==="include"?dt.crossOrigin="use-credentials":(pt&&pt==="same-origin"||!i.d(Tt))&&(dt.crossOrigin="anonymous"),J.signal.addEventListener("abort",()=>{dt.src="",mt(i.c())}),dt.fetchPriority="high",dt.onload=()=>{dt.onerror=dt.onload=null,et({data:dt})},dt.onerror=()=>{dt.onerror=dt.onload=null,J.signal.aborted||mt(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},dt.src=Tt})}(bo||(bo={})),bo.resetRequestQueue();class ba{constructor(s){this._transformRequestFn=s??null}transformRequest(s,d){return this._transformRequestFn&&this._transformRequestFn(s,d)||{url:s}}setTransformRequest(s){this._transformRequestFn=s}}function Os(C){const s=[];if(typeof C=="string")s.push({id:"default",url:C});else if(C&&C.length>0){const d=[];for(const{id:v,url:S}of C){const D=`${v}${S}`;d.indexOf(D)===-1&&(d.push(D),s.push({id:v,url:S}))}}return s}function Ya(C,s,d){try{const v=new URL(C);return v.pathname+=`${s}${d}`,v.toString()}catch{throw new Error(`Invalid sprite URL "${C}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}function al(C){const{userImage:s}=C;return!!(s&&s.render&&s.render())&&(C.data.replace(new Uint8Array(s.data.buffer)),!0)}class Ja extends i.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new i.R({width:1,height:1}),this.dirty=!0}destroy(){this.atlasTexture&&(this.atlasTexture.destroy(),this.atlasTexture=null);for(const s of Object.keys(this.images))this.removeImage(s);this.patterns={},this.atlasImage=new i.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(s){if(this.loaded!==s&&(this.loaded=s,s)){for(const{ids:d,promiseResolve:v}of this.requestors)v(this._getImagesForIds(d));this.requestors=[]}}getImage(s){const d=this.images[s];if(d&&!d.data&&d.spriteData){const v=d.spriteData;d.data=new i.R({width:v.width,height:v.height},v.context.getImageData(v.x,v.y,v.width,v.height).data),d.spriteData=null}return d}addImage(s,d){if(this.images[s])throw new Error(`Image id ${s} already exist, use updateImage instead`);this._validate(s,d)&&(this.images[s]=d)}_validate(s,d){let v=!0;const S=d.data||d.spriteData;return this._validateStretch(d.stretchX,S&&S.width)||(this.fire(new i.k(new Error(`Image "${s}" has invalid "stretchX" value`))),v=!1),this._validateStretch(d.stretchY,S&&S.height)||(this.fire(new i.k(new Error(`Image "${s}" has invalid "stretchY" value`))),v=!1),this._validateContent(d.content,d)||(this.fire(new i.k(new Error(`Image "${s}" has invalid "content" value`))),v=!1),v}_validateStretch(s,d){if(!s)return!0;let v=0;for(const S of s){if(S[0]<v||S[1]<S[0]||d<S[1])return!1;v=S[1]}return!0}_validateContent(s,d){if(!s)return!0;if(s.length!==4)return!1;const v=d.spriteData,S=v&&v.width||d.data.width,D=v&&v.height||d.data.height;return!(s[0]<0||S<s[0]||s[1]<0||D<s[1]||s[2]<0||S<s[2]||s[3]<0||D<s[3]||s[2]<s[0]||s[3]<s[1])}updateImage(s,d,v=!0){const S=this.getImage(s);if(v&&(S.data.width!==d.data.width||S.data.height!==d.data.height))throw new Error(`size mismatch between old image (${S.data.width}x${S.data.height}) and new image (${d.data.width}x${d.data.height}).`);d.version=S.version+1,this.images[s]=d,this.updatedImages[s]=!0}removeImage(s){const d=this.images[s];delete this.images[s],delete this.patterns[s],d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(s){return new Promise((d,v)=>{let S=!0;if(!this.isLoaded())for(const D of s)this.images[D]||(S=!1);this.isLoaded()||S?d(this._getImagesForIds(s)):this.requestors.push({ids:s,promiseResolve:d})})}_getImagesForIds(s){const d={};for(const v of s){let S=this.getImage(v);S||(this.fire(new i.l("styleimagemissing",{id:v})),S=this.getImage(v)),S?d[v]={data:S.data.clone(),pixelRatio:S.pixelRatio,sdf:S.sdf,version:S.version,stretchX:S.stretchX,stretchY:S.stretchY,content:S.content,textFitWidth:S.textFitWidth,textFitHeight:S.textFitHeight,hasRenderCallback:!!(S.userImage&&S.userImage.render)}:i.w(`Image "${v}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return d}getPixelSize(){const{width:s,height:d}=this.atlasImage;return{width:s,height:d}}getPattern(s){const d=this.patterns[s],v=this.getImage(s);if(!v)return null;if(d&&d.position.version===v.version)return d.position;if(d)d.position.version=v.version;else{const S={w:v.data.width+2,h:v.data.height+2,x:0,y:0},D=new i.I(S,v);this.patterns[s]={bin:S,position:D}}return this._updatePatternAtlas(),this.patterns[s].position}bind(s){const d=s.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new i.T(s,this.atlasImage,d.RGBA),this.atlasTexture.bind(d.LINEAR,d.CLAMP_TO_EDGE)}_updatePatternAtlas(){const s=[];for(const D in this.patterns)s.push(this.patterns[D].bin);const{w:d,h:v}=i.p(s),S=this.atlasImage;S.resize({width:d||1,height:v||1});for(const D in this.patterns){const{bin:k}=this.patterns[D],j=k.x+1,H=k.y+1,J=this.getImage(D).data,et=J.width,mt=J.height;i.R.copy(J,S,{x:0,y:0},{x:j,y:H},{width:et,height:mt}),i.R.copy(J,S,{x:0,y:mt-1},{x:j,y:H-1},{width:et,height:1}),i.R.copy(J,S,{x:0,y:0},{x:j,y:H+mt},{width:et,height:1}),i.R.copy(J,S,{x:et-1,y:0},{x:j-1,y:H},{width:1,height:mt}),i.R.copy(J,S,{x:0,y:0},{x:j+et,y:H},{width:1,height:mt})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(s){for(const d of s){if(this.callbackDispatchedThisFrame[d])continue;this.callbackDispatchedThisFrame[d]=!0;const v=this.getImage(d);v||i.w(`Image with ID: "${d}" was not found`),al(v)&&this.updateImage(d,v)}}cloneImages(){const s={};for(const d in this.images){const v=this.images[d];s[d]=Object.assign(Object.assign({},v),{data:v.data?v.data.clone():null})}return s}}const Hr=1e20;function sc(C,s,d,v,S,D,k,j,H){for(let J=s;J<s+v;J++)cs(C,d*D+J,D,S,k,j,H);for(let J=d;J<d+S;J++)cs(C,J*D+s,1,v,k,j,H)}function cs(C,s,d,v,S,D,k){D[0]=0,k[0]=-Hr,k[1]=Hr,S[0]=C[s];for(let j=1,H=0,J=0;j<v;j++){S[j]=C[s+j*d];const et=j*j;do{const mt=D[H];J=(S[j]-S[mt]+et-mt*mt)/(j-mt)/2}while(J<=k[H]&&--H>-1);H++,D[H]=j,k[H]=J,k[H+1]=Hr}for(let j=0,H=0;j<v;j++){for(;k[H+1]<j;)H++;const J=D[H],et=j-J;C[s+j*d]=S[J]+et*et}}const Kn=i.v.layout_symbol["text-font"].default.join(",");class hn{constructor(s,d,v){this.requestManager=s,this.localIdeographFontFamily=d,this.entries={},this.lang=v}setURL(s){this.url=s}getGlyphs(s){return i._(this,void 0,void 0,function*(){const d=[];for(const D in s)for(const k of s[D])d.push(this._getAndCacheGlyphsPromise(D,k));const v=yield Promise.all(d),S={};for(const{stack:D,id:k,glyph:j}of v)S[D]||(S[D]={}),S[D][k]=j&&{id:j.id,bitmap:j.bitmap.clone(),metrics:j.metrics};return S})}_getAndCacheGlyphsPromise(s,d){return i._(this,void 0,void 0,function*(){let v=this.entries[s];v||(v=this.entries[s]={glyphs:{},requests:{},ranges:{}});let S=v.glyphs[d];return S!==void 0?{stack:s,id:d,glyph:S}:!this.url||this._charUsesLocalIdeographFontFamily(d)?(S=v.glyphs[d]=this._drawGlyph(v,s,d),{stack:s,id:d,glyph:S}):yield this._downloadAndCacheRangePromise(s,d)})}_downloadAndCacheRangePromise(s,d){return i._(this,void 0,void 0,function*(){const v=this.entries[s],S=Math.floor(d/256);if(v.ranges[S])return{stack:s,id:d,glyph:null};if(!v.requests[S]){const D=hn.loadGlyphRange(s,S,this.url,this.requestManager);v.requests[S]=D}try{const D=yield v.requests[S];for(const k in D)v.glyphs[+k]=D[+k];return v.ranges[S]=!0,{stack:s,id:d,glyph:D[d]||null}}catch(D){const k=v.glyphs[d]=this._drawGlyph(v,s,d);return this._warnOnMissingGlyphRange(k,S,d,D),{stack:s,id:d,glyph:k}}})}_warnOnMissingGlyphRange(s,d,v,S){const D=256*d,k=D+255,j=v.toString(16).padStart(4,"0").toUpperCase();i.w(`Unable to load glyph range ${d}, ${D}-${k}. Rendering codepoint U+${j} locally instead. ${S}`)}_charUsesLocalIdeographFontFamily(s){return!!this.localIdeographFontFamily&&i.q(s)}_drawGlyph(s,d,v){const S=d===Kn&&this.localIdeographFontFamily!==""&&this._charUsesLocalIdeographFontFamily(v),D=S?"ideographTinySDF":"tinySDF";s[D]||(s[D]=this._createTinySDF(S?this.localIdeographFontFamily:d));const k=s[D].draw(String.fromCodePoint(v));return{id:v,bitmap:new i.r({width:k.width||60,height:k.height||60},k.data),metrics:{width:k.glyphWidth/2||24,height:k.glyphHeight/2||24,left:k.glyphLeft/2+.5||0,top:k.glyphTop/2-27.5||-8,advance:k.glyphAdvance/2||24,isDoubleResolution:!0}}}_createTinySDF(s){const d=s?s.split(","):[];d.push("sans-serif");const v=d.map(S=>/[-\w]+/.test(S)?S:`'${CSS.escape(S)}'`).join(",");return new hn.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:v,fontWeight:this._fontWeight(d[0]),fontStyle:this._fontStyle(d[0]),lang:this.lang})}_fontStyle(s){return/italic/i.test(s)?"italic":/oblique/i.test(s)?"oblique":"normal"}_fontWeight(s){const d={thin:100,hairline:100,"extra light":200,"ultra light":200,light:300,normal:400,regular:400,medium:500,semibold:600,demibold:600,bold:700,"extra bold":800,"ultra bold":800,black:900,heavy:900,"extra black":950,"ultra black":950};let v;for(const[S,D]of Object.entries(d))new RegExp(`\\b${S}\\b`,"i").test(s)&&(v=`${D}`);return v}destroy(){for(const s in this.entries){const d=this.entries[s];d.tinySDF&&(d.tinySDF=null),d.ideographTinySDF&&(d.ideographTinySDF=null),d.glyphs={},d.requests={},d.ranges={}}this.entries={}}}hn.loadGlyphRange=function(C,s,d,v){return i._(this,void 0,void 0,function*(){const S=256*s,D=S+255,k=v.transformRequest(d.replace("{fontstack}",C).replace("{range}",`${S}-${D}`),"Glyphs"),j=yield i.n(k,new AbortController);if(!j||!j.data)throw new Error(`Could not load glyph range. range: ${s}, ${S}-${D}`);const H={};for(const J of i.o(j.data))H[J.id]=J;return H})},hn.TinySDF=class{constructor({fontSize:C=24,buffer:s=3,radius:d=8,cutoff:v=.25,fontFamily:S="sans-serif",fontWeight:D="normal",fontStyle:k="normal",lang:j=null}={}){this.buffer=s,this.cutoff=v,this.radius=d,this.lang=j;const H=this.size=C+4*s,J=this._createCanvas(H),et=this.ctx=J.getContext("2d",{willReadFrequently:!0});et.font=`${k} ${D} ${C}px ${S}`,et.textBaseline="alphabetic",et.textAlign="left",et.fillStyle="black",this.gridOuter=new Float64Array(H*H),this.gridInner=new Float64Array(H*H),this.f=new Float64Array(H),this.z=new Float64Array(H+1),this.v=new Uint16Array(H)}_createCanvas(C){const s=document.createElement("canvas");return s.width=s.height=C,s}draw(C){const{width:s,actualBoundingBoxAscent:d,actualBoundingBoxDescent:v,actualBoundingBoxLeft:S,actualBoundingBoxRight:D}=this.ctx.measureText(C),k=Math.ceil(d),j=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(D-S))),H=Math.min(this.size-this.buffer,k+Math.ceil(v)),J=j+2*this.buffer,et=H+2*this.buffer,mt=Math.max(J*et,0),dt=new Uint8ClampedArray(mt),Tt={data:dt,width:J,height:et,glyphWidth:j,glyphHeight:H,glyphTop:k,glyphLeft:0,glyphAdvance:s};if(j===0||H===0)return Tt;const{ctx:pt,buffer:It,gridInner:Kt,gridOuter:Wt}=this;this.lang&&(pt.lang=this.lang),pt.clearRect(It,It,j,H),pt.fillText(C,It,It+k);const ft=pt.getImageData(It,It,j,H);Wt.fill(Hr,0,mt),Kt.fill(0,0,mt);for(let _e=0;_e<H;_e++)for(let he=0;he<j;he++){const me=ft.data[4*(_e*j+he)+3]/255;if(me===0)continue;const be=(_e+It)*J+he+It;if(me===1)Wt[be]=0,Kt[be]=Hr;else{const de=.5-me;Wt[be]=de>0?de*de:0,Kt[be]=de<0?de*de:0}}sc(Wt,0,0,J,et,J,this.f,this.v,this.z),sc(Kt,It,It,j,H,J,this.f,this.v,this.z);for(let _e=0;_e<mt;_e++){const he=Math.sqrt(Wt[_e])-Math.sqrt(Kt[_e]);dt[_e]=Math.round(255-255*(he/this.radius+this.cutoff))}return Tt}};class Co{constructor(){this.specification=i.u.light.position}possiblyEvaluate(s,d){return i.F(s.expression.evaluate(d))}interpolate(s,d,v){return{x:i.G.number(s.x,d.x,v),y:i.G.number(s.y,d.y,v),z:i.G.number(s.z,d.z,v)}}}let zn;class Ys extends i.E{constructor(s){super(),zn=zn||new i.t({anchor:new i.D(i.u.light.anchor),position:new Co,color:new i.D(i.u.light.color),intensity:new i.D(i.u.light.intensity)}),this._transitionable=new i.x(zn,void 0),this.setLight(s),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(s,d={}){if(!this._validate(i.y,s,d))for(const v in s){const S=s[v];v.endsWith(i.z)?this._transitionable.setTransition(v.slice(0,-i.z.length),S):this._transitionable.setValue(v,S)}}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}_validate(s,d,v){return(!v||v.validate!==!1)&&i.B(this,s.call(i.C,{value:d,style:{glyphs:!0,sprite:!0},styleSpec:i.u}))}}const vs=new i.t({"sky-color":new i.D(i.u.sky["sky-color"]),"horizon-color":new i.D(i.u.sky["horizon-color"]),"fog-color":new i.D(i.u.sky["fog-color"]),"fog-ground-blend":new i.D(i.u.sky["fog-ground-blend"]),"horizon-fog-blend":new i.D(i.u.sky["horizon-fog-blend"]),"sky-horizon-blend":new i.D(i.u.sky["sky-horizon-blend"]),"atmosphere-blend":new i.D(i.u.sky["atmosphere-blend"])});class Ps extends i.E{constructor(s){super(),this._transitionable=new i.x(vs,void 0),this.setSky(s),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new i.H(0))}setSky(s,d={}){if(!this._validate(i.J,s,d)){s||(s={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const v in s){const S=s[v];v.endsWith(i.z)?this._transitionable.setTransition(v.slice(0,-i.z.length),S):this._transitionable.setValue(v,S)}}}getSky(){return this._transitionable.serialize()}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}_validate(s,d,v={}){return(v==null?void 0:v.validate)!==!1&&i.B(this,s.call(i.C,i.e({value:d,style:{glyphs:!0,sprite:!0},styleSpec:i.u})))}calculateFogBlendOpacity(s){return s<60?0:s<70?(s-60)/10:1}}class Hn{constructor(s,d){this.width=s,this.height=d,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(s,d){const v=s.join(",")+String(d);return this.dashEntry[v]||(this.dashEntry[v]=this.addDash(s,d)),this.dashEntry[v]}getDashRanges(s,d,v){const S=[];let D=s.length%2==1?-s[s.length-1]*v:0,k=s[0]*v,j=!0;S.push({left:D,right:k,isDash:j,zeroLength:s[0]===0});let H=s[0];for(let J=1;J<s.length;J++){j=!j;const et=s[J];D=H*v,H+=et,k=H*v,S.push({left:D,right:k,isDash:j,zeroLength:et===0})}return S}addRoundDash(s,d,v){const S=d/2;for(let D=-v;D<=v;D++){const k=this.width*(this.nextRow+v+D);let j=0,H=s[j];for(let J=0;J<this.width;J++){J/H.right>1&&(H=s[++j]);const et=Math.abs(J-H.left),mt=Math.abs(J-H.right),dt=Math.min(et,mt);let Tt;const pt=D/v*(S+1);if(H.isDash){const It=S-Math.abs(pt);Tt=Math.sqrt(dt*dt+It*It)}else Tt=S-Math.sqrt(dt*dt+pt*pt);this.data[k+J]=Math.max(0,Math.min(255,Tt+128))}}}addRegularDash(s){for(let j=s.length-1;j>=0;--j){const H=s[j],J=s[j+1];H.zeroLength?s.splice(j,1):J&&J.isDash===H.isDash&&(J.left=H.left,s.splice(j,1))}const d=s[0],v=s[s.length-1];d.isDash===v.isDash&&(d.left=v.left-this.width,v.right=d.right+this.width);const S=this.width*this.nextRow;let D=0,k=s[D];for(let j=0;j<this.width;j++){j/k.right>1&&(k=s[++D]);const H=Math.abs(j-k.left),J=Math.abs(j-k.right),et=Math.min(H,J);this.data[S+j]=Math.max(0,Math.min(255,(k.isDash?et:-et)+128))}}addDash(s,d){const v=d?7:0,S=2*v+1;if(this.nextRow+S>this.height)return i.w("LineAtlas out of space"),null;let D=0;for(let j=0;j<s.length;j++)D+=s[j];if(D!==0){const j=this.width/D,H=this.getDashRanges(s,this.width,j);d?this.addRoundDash(H,j,v):this.addRegularDash(H)}const k={y:this.nextRow+v,height:2*v,width:D};return this.nextRow+=S,this.dirty=!0,k}bind(s){const d=s.gl;this.texture?(d.bindTexture(d.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,d.texSubImage2D(d.TEXTURE_2D,0,0,0,this.width,this.height,d.ALPHA,d.UNSIGNED_BYTE,this.data))):(this.texture=d.createTexture(),d.bindTexture(d.TEXTURE_2D,this.texture),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texImage2D(d.TEXTURE_2D,0,d.ALPHA,this.width,this.height,0,d.ALPHA,d.UNSIGNED_BYTE,this.data))}}const di="maplibre_preloaded_worker_pool";class tr{constructor(){this.active={}}acquire(s){if(!this.workers)for(this.workers=[];this.workers.length<tr.workerCount;)this.workers.push(new Worker(i.a.WORKER_URL));return this.active[s]=!0,this.workers.slice()}release(s){delete this.active[s],this.numActive()===0&&(this.workers.forEach(d=>{d.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[di]}numActive(){return Object.keys(this.active).length}}const fr=Math.floor(Rr.hardwareConcurrency/2);let Wr,qr;function Xi(){return Wr||(Wr=new tr),Wr}tr.workerCount=i.K(globalThis)?Math.max(Math.min(fr,3),1):1;class Xr{constructor(s,d){this.workerPool=s,this.actors=[],this.currentActor=0,this.id=d;const v=this.workerPool.acquire(d);for(let S=0;S<v.length;S++){const D=new i.L(v[S],d);D.name=`Worker ${S}`,this.actors.push(D)}if(!this.actors.length)throw new Error("No actors found")}broadcast(s,d){const v=[];for(const S of this.actors)v.push(S.sendAsync({type:s,data:d}));return Promise.all(v)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(s=!0){this.actors.forEach(d=>{d.remove()}),this.actors=[],s&&this.workerPool.release(this.id)}registerMessageHandler(s,d){for(const v of this.actors)v.registerMessageHandler(s,d)}unregisterMessageHandler(s){for(const d of this.actors)d.unregisterMessageHandler(s)}}function $n(){return qr||(qr=new Xr(Xi(),i.M),qr.registerMessageHandler("GR",(C,s,d)=>i.m(s,d))),qr}function qo(C,s){const d=i.N();return i.O(d,d,[1,1,0]),i.Q(d,d,[.5*C.width,.5*C.height,1]),C.calculatePosMatrix?i.S(d,d,C.calculatePosMatrix(s.toUnwrapped())):d}function On(C,s,d,v,S,D,k){var j;const H=function(dt,Tt,pt){if(dt)for(const It of dt){const Kt=Tt[It];if(Kt&&Kt.source===pt&&Kt.type==="fill-extrusion")return!0}else for(const It in Tt){const Kt=Tt[It];if(Kt.source===pt&&Kt.type==="fill-extrusion")return!0}return!1}((j=S==null?void 0:S.layers)!==null&&j!==void 0?j:null,s,C.id),J=D.maxPitchScaleFactor(),et=C.tilesIn(v,J,H);et.sort(ho);const mt=[];for(const dt of et)mt.push({wrappedTileID:dt.tileID.wrapped().key,queryResults:dt.tile.queryRenderedFeatures(s,d,C.getState(),dt.queryGeometry,dt.cameraQueryGeometry,dt.scale,S,D,J,qo(D,dt.tileID),k?(Tt,pt)=>k(dt.tileID,Tt,pt):void 0)});return function(dt,Tt){for(const pt in dt)for(const It of dt[pt])ds(It,Tt);return dt}(function(dt){const Tt={},pt={};for(const It of dt){const Kt=It.queryResults,Wt=It.wrappedTileID,ft=pt[Wt]=pt[Wt]||{};for(const _e in Kt){const he=Kt[_e],me=ft[_e]=ft[_e]||{},be=Tt[_e]=Tt[_e]||[];for(const de of he)me[de.featureIndex]||(me[de.featureIndex]=!0,be.push(de))}}return Tt}(mt),C)}function ho(C,s){const d=C.tileID,v=s.tileID;return d.overscaledZ-v.overscaledZ||d.canonical.y-v.canonical.y||d.wrap-v.wrap||d.canonical.x-v.canonical.x}function ds(C,s){const d=C.feature,v=s.getFeatureState(d.layer["source-layer"],d.id);d.source=d.layer.source,d.layer["source-layer"]&&(d.sourceLayer=d.layer["source-layer"]),d.state=v}function Ns(C,s,d){return i._(this,void 0,void 0,function*(){let v=C;if(C.url?v=(yield i.j(s.transformRequest(C.url,"Source"),d)).data:yield Rr.frameAsync(d),!v)return null;const S=i.U(i.e(v,C),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in v&&v.vector_layers&&(S.vectorLayerIds=v.vector_layers.map(D=>D.id)),S})}class xo{constructor(s,d){s&&(d?this.setSouthWest(s).setNorthEast(d):Array.isArray(s)&&(s.length===4?this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]]):this.setSouthWest(s[0]).setNorthEast(s[1])))}setNorthEast(s){return this._ne=s instanceof i.V?new i.V(s.lng,s.lat):i.V.convert(s),this}setSouthWest(s){return this._sw=s instanceof i.V?new i.V(s.lng,s.lat):i.V.convert(s),this}extend(s){const d=this._sw,v=this._ne;let S,D;if(s instanceof i.V)S=s,D=s;else{if(!(s instanceof xo))return Array.isArray(s)?s.length===4||s.every(Array.isArray)?this.extend(xo.convert(s)):this.extend(i.V.convert(s)):s&&("lng"in s||"lon"in s)&&"lat"in s?this.extend(i.V.convert(s)):this;if(S=s._sw,D=s._ne,!S||!D)return this}return d||v?(d.lng=Math.min(S.lng,d.lng),d.lat=Math.min(S.lat,d.lat),v.lng=Math.max(D.lng,v.lng),v.lat=Math.max(D.lat,v.lat)):(this._sw=new i.V(S.lng,S.lat),this._ne=new i.V(D.lng,D.lat)),this}getCenter(){return new i.V((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new i.V(this.getWest(),this.getNorth())}getSouthEast(){return new i.V(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(s){const{lng:d,lat:v}=i.V.convert(s);let S=this._sw.lng<=d&&d<=this._ne.lng;return this._sw.lng>this._ne.lng&&(S=this._sw.lng>=d&&d>=this._ne.lng),this._sw.lat<=v&&v<=this._ne.lat&&S}intersects(s){if((s=xo.convert(s)).getNorth()<this.getSouth()||s.getSouth()>this.getNorth())return!1;const d=i.W(this.getWest(),-180,180),v=i.W(this.getEast(),-180,180),S=i.W(s.getWest(),-180,180),D=i.W(s.getEast(),-180,180),k=d>v,j=S>D;return!(!k||!j)||(k?D>=d||S<=v:j?v>=S||d<=D:!(S>v||D<d))}static convert(s){return s instanceof xo?s:s&&new xo(s)}static fromLngLat(s,d=0){const v=360*d/40075017,S=v/Math.cos(Math.PI/180*s.lat);return new xo(new i.V(s.lng-S,s.lat-v),new i.V(s.lng+S,s.lat+v))}adjustAntiMeridian(){const s=new i.V(this._sw.lng,this._sw.lat),d=new i.V(this._ne.lng,this._ne.lat);return new xo(s,s.lng>d.lng?new i.V(d.lng+360,d.lat):d)}}class oo{constructor(s,d,v){this.bounds=xo.convert(this.validateBounds(s)),this.minzoom=d||0,this.maxzoom=v||24}validateBounds(s){return Array.isArray(s)&&s.length===4?[Math.max(-180,s[0]),Math.max(-90,s[1]),Math.min(180,s[2]),Math.min(90,s[3])]:[-180,-90,180,90]}contains(s){const d=Math.pow(2,s.z),v=Math.floor(i.Y(this.bounds.getWest())*d),S=Math.floor(i.X(this.bounds.getNorth())*d),D=Math.ceil(i.Y(this.bounds.getEast())*d),k=Math.ceil(i.X(this.bounds.getSouth())*d);return s.x>=v&&s.x<D&&s.y>=S&&s.y<k}}class ll extends i.E{constructor(s,d,v,S){if(super(),this.id=s,this.dispatcher=v,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,i.e(this,i.U(d,["url","scheme","tileSize","promoteId","encoding"])),this._options=i.e({type:"vector"},d),this._collectResourceTiming=d.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(S)}load(){return i._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new i.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const s=yield Ns(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.tileManagers[this.id].clearTiles(),s&&(i.e(this,s),s.bounds&&(this.tileBounds=new oo(s.bounds,this.minzoom,this.maxzoom)),this.fire(new i.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.l("data",{dataType:"source",sourceDataType:"content"})))}catch(s){this._tileJSONRequest=null,this._loaded=!0,this.fire(new i.k(s))}})}loaded(){return this._loaded}hasTile(s){return!this.tileBounds||this.tileBounds.contains(s.canonical)}onAdd(s){this.map=s,this.load()}setSourceProperty(s){this._tileJSONRequest&&this._tileJSONRequest.abort(),s(),this.load()}setTiles(s){return this.setSourceProperty(()=>{this._options.tiles=s}),this}setUrl(s){return this.setSourceProperty(()=>{this.url=s,this._options.url=s}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return i.e({},this._options)}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),v={request:this.map._requestManager.transformRequest(d,"Tile"),uid:s.uid,tileID:s.tileID,zoom:s.tileID.overscaledZ,tileSize:this.tileSize*s.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,encoding:this.encoding,overzoomParameters:this._getOverzoomParameters(s)};v.request.collectResourceTiming=this._collectResourceTiming;let S="RT";if(s.actor&&s.state!=="expired"){if(s.state==="loading")return new Promise((D,k)=>{s.reloadPromise={resolve:D,reject:k}})}else s.actor=this.dispatcher.getActor(),S="LT";s.abortController=new AbortController;try{const D=yield s.actor.sendAsync({type:S,data:v},s.abortController);if(delete s.abortController,s.aborted)return;this._afterTileLoadWorkerResponse(s,D)}catch(D){if(delete s.abortController,s.aborted)return;if(D&&D.status!==404)throw D;this._afterTileLoadWorkerResponse(s,null)}})}_getOverzoomParameters(s){if(s.tileID.canonical.z<=this.maxzoom||this.map._zoomLevelsToOverscale===void 0)return;const d=s.tileID.scaledTo(this.maxzoom).canonical,v=d.url(this.tiles,this.map.getPixelRatio(),this.scheme);return{maxZoomTileID:d,overzoomRequest:this.map._requestManager.transformRequest(v,"Tile")}}_afterTileLoadWorkerResponse(s,d){if(d&&d.resourceTiming&&(s.resourceTiming=d.resourceTiming),d&&this.map._refreshExpiredTiles&&s.setExpiryData(d),s.loadVectorData(d,this.map.painter),s.reloadPromise){const v=s.reloadPromise;s.reloadPromise=null,this.loadTile(s).then(v.resolve).catch(v.reject)}}abortTile(s){return i._(this,void 0,void 0,function*(){s.abortController&&(s.abortController.abort(),delete s.abortController),s.actor&&(yield s.actor.sendAsync({type:"AT",data:{uid:s.uid,type:this.type,source:this.id}}))})}unloadTile(s){return i._(this,void 0,void 0,function*(){s.unloadVectorData(),s.actor&&(yield s.actor.sendAsync({type:"RMT",data:{uid:s.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class $l extends i.E{constructor(s,d,v,S){super(),this.id=s,this.dispatcher=v,this.setEventedParent(S),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=i.e({type:"raster"},d),i.e(this,i.U(d,["url","scheme","tileSize"]))}load(){return i._(this,arguments,void 0,function*(s=!1){this._loaded=!1,this.fire(new i.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const d=yield Ns(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,d&&(i.e(this,d),d.bounds&&(this.tileBounds=new oo(d.bounds,this.minzoom,this.maxzoom)),this.fire(new i.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:s})))}catch(d){this._tileJSONRequest=null,this._loaded=!0,this.fire(new i.k(d))}})}loaded(){return this._loaded}onAdd(s){this.map=s,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(s){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),s(),this.load(!0)}setTiles(s){return this.setSourceProperty(()=>{this._options.tiles=s}),this}setUrl(s){return this.setSourceProperty(()=>{this.url=s,this._options.url=s}),this}serialize(){return i.e({},this._options)}hasTile(s){return!this.tileBounds||this.tileBounds.contains(s.canonical)}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);s.abortController=new AbortController;try{const v=yield bo.getImage(this.map._requestManager.transformRequest(d,"Tile"),s.abortController,this.map._refreshExpiredTiles);if(delete s.abortController,s.aborted)return void(s.state="unloaded");if(v&&v.data){this.map._refreshExpiredTiles&&(v.cacheControl||v.expires)&&s.setExpiryData({cacheControl:v.cacheControl,expires:v.expires});const S=this.map.painter.context,D=S.gl,k=v.data;s.texture=this.map.painter.getTileTexture(k.width),s.texture?s.texture.update(k,{useMipmap:!0}):(s.texture=new i.T(S,k,D.RGBA,{useMipmap:!0}),s.texture.bind(D.LINEAR,D.CLAMP_TO_EDGE,D.LINEAR_MIPMAP_NEAREST)),s.state="loaded"}}catch(v){if(delete s.abortController,s.aborted)s.state="unloaded";else if(v)throw s.state="errored",v}})}abortTile(s){return i._(this,void 0,void 0,function*(){s.abortController&&(s.abortController.abort(),delete s.abortController)})}unloadTile(s){return i._(this,void 0,void 0,function*(){s.texture&&this.map.painter.saveTileTexture(s.texture)})}hasTransition(){return!1}}class Ms extends $l{constructor(s,d,v,S){super(s,d,v,S),this.type="raster-dem",this.maxzoom=22,this._options=i.e({type:"raster-dem"},d),this.encoding=d.encoding||"mapbox",this.redFactor=d.redFactor,this.greenFactor=d.greenFactor,this.blueFactor=d.blueFactor,this.baseShift=d.baseShift}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),v=this.map._requestManager.transformRequest(d,"Tile");s.neighboringTiles=this._getNeighboringTiles(s.tileID),s.abortController=new AbortController;try{const S=yield bo.getImage(v,s.abortController,this.map._refreshExpiredTiles);if(delete s.abortController,s.aborted)return void(s.state="unloaded");if(S&&S.data){const D=S.data;this.map._refreshExpiredTiles&&(S.cacheControl||S.expires)&&s.setExpiryData({cacheControl:S.cacheControl,expires:S.expires});const k=i.b(D)&&i.Z()?D:yield this.readImageNow(D),j={type:this.type,uid:s.uid,source:this.id,rawImageData:k,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!s.actor||s.state==="expired"){s.actor=this.dispatcher.getActor();const H=yield s.actor.sendAsync({type:"LDT",data:j});s.dem=H,s.needsHillshadePrepare=!0,s.needsTerrainPrepare=!0,s.state="loaded"}}}catch(S){if(delete s.abortController,s.aborted)s.state="unloaded";else if(S)throw s.state="errored",S}})}readImageNow(s){return i._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&i.$()){const d=s.width+2,v=s.height+2;try{return new i.R({width:d,height:v},yield i.a0(s,-1,-1,d,v))}catch{}}return Rr.getImageData(s,1)})}_getNeighboringTiles(s){const d=s.canonical,v=Math.pow(2,d.z),S=(d.x-1+v)%v,D=d.x===0?s.wrap-1:s.wrap,k=(d.x+1+v)%v,j=d.x+1===v?s.wrap+1:s.wrap,H={};return H[new i.a1(s.overscaledZ,D,d.z,S,d.y).key]={backfilled:!1},H[new i.a1(s.overscaledZ,j,d.z,k,d.y).key]={backfilled:!1},d.y>0&&(H[new i.a1(s.overscaledZ,D,d.z,S,d.y-1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,s.wrap,d.z,d.x,d.y-1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,j,d.z,k,d.y-1).key]={backfilled:!1}),d.y+1<v&&(H[new i.a1(s.overscaledZ,D,d.z,S,d.y+1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,s.wrap,d.z,d.x,d.y+1).key]={backfilled:!1},H[new i.a1(s.overscaledZ,j,d.z,k,d.y+1).key]={backfilled:!1}),H}unloadTile(s){return i._(this,void 0,void 0,function*(){s.demTexture&&this.map.painter.saveTileTexture(s.demTexture),s.fbo&&(s.fbo.destroy(),delete s.fbo),s.dem&&delete s.dem,delete s.neighboringTiles,s.state="unloaded",s.actor&&(yield s.actor.sendAsync({type:"RDT",data:{type:this.type,uid:s.uid,source:this.id}}))})}}function wa(C){return C.type==="GeometryCollection"?C.geometries.map(s=>s.coordinates).flat(1/0):C.coordinates.flat(1/0)}function ql(C){const s=new xo;let d;switch(C.type){case"FeatureCollection":d=C.features.map(v=>wa(v.geometry)).flat(1/0);break;case"Feature":d=wa(C.geometry);break;default:d=wa(C)}if(d.length==0)return s;for(let v=0;v<d.length-1;v+=2)s.extend([d[v],d[v+1]]);return s}class bs extends i.E{constructor(s,d,v,S){super(),this.id=s,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._isUpdatingWorker=!1,this._pendingWorkerUpdate={data:d.data},this.actor=v.getActor(),this.setEventedParent(S),this._data=typeof d.data=="string"?{url:d.data}:{geojson:d.data},this._options=i.e({},d),this._collectResourceTiming=d.collectResourceTiming,d.maxzoom!==void 0&&(this.maxzoom=d.maxzoom),d.type&&(this.type=d.type),d.attribution&&(this.attribution=d.attribution),this.promoteId=d.promoteId,d.clusterMaxZoom!==void 0&&this.maxzoom<=d.clusterMaxZoom&&i.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${d.clusterMaxZoom}".`),this.workerOptions=i.e({source:this.id,cluster:d.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(d.buffer!==void 0?d.buffer:128),tolerance:this._pixelsToTileUnits(d.tolerance!==void 0?d.tolerance:.375),extent:i.a4,maxZoom:this.maxzoom,lineMetrics:d.lineMetrics||!1,generateId:d.generateId||!1},superclusterOptions:{maxZoom:this._getClusterMaxZoom(d.clusterMaxZoom),minPoints:Math.max(2,d.clusterMinPoints||2),extent:i.a4,radius:this._pixelsToTileUnits(d.clusterRadius||50),log:!1,generateId:d.generateId||!1},clusterProperties:d.clusterProperties,filter:d.filter},d.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_hasPendingWorkerUpdate(){return this._pendingWorkerUpdate.data!==void 0||this._pendingWorkerUpdate.diff!==void 0||this._pendingWorkerUpdate.optionsChanged}_pixelsToTileUnits(s){return s*(i.a4/this.tileSize)}_getClusterMaxZoom(s){const d=s?Math.round(s):this.maxzoom-1;return Number.isInteger(s)||s===void 0||i.w(`Integer expected for option 'clusterMaxZoom': provided value "${s}" rounded to "${d}"`),d}load(){return i._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(s){this.map=s,this.load()}setData(s,d){this._data=typeof s=="string"?{url:s}:{geojson:s},this._pendingWorkerUpdate={data:s};const v=this._updateWorkerData();return d?v:this}updateData(s,d){this._pendingWorkerUpdate.diff=i.a5(this._pendingWorkerUpdate.diff,s);const v=this._updateWorkerData();return d?v:this}getData(){return i._(this,void 0,void 0,function*(){const s=i.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:s})})}getBounds(){return i._(this,void 0,void 0,function*(){return ql(yield this.getData())})}setClusterOptions(s){return this.workerOptions.cluster=s.cluster,s.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(s.clusterRadius)),s.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=this._getClusterMaxZoom(s.clusterMaxZoom)),this._pendingWorkerUpdate.optionsChanged=!0,this._updateWorkerData(),this}getClusterExpansionZoom(s){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:s,source:this.id}})}getClusterChildren(s){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:s,source:this.id}})}getClusterLeaves(s,d,v){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:s,limit:d,offset:v}})}_updateWorkerData(){return i._(this,void 0,void 0,function*(){if(this._isUpdatingWorker)return;if(!this._hasPendingWorkerUpdate())return void i.w(`No pending worker updates for GeoJSONSource ${this.id}.`);const{data:s,diff:d}=this._pendingWorkerUpdate,v=i.e({type:this.type},this.workerOptions);s?(typeof s=="string"?(v.request=this.map._requestManager.transformRequest(Rr.resolveURL(s),"Source"),v.request.collectResourceTiming=this._collectResourceTiming):v.data=s,this._pendingWorkerUpdate.data=void 0):d&&(v.dataDiff=d,this._pendingWorkerUpdate.diff=void 0),this._pendingWorkerUpdate.optionsChanged=void 0,this._isUpdatingWorker=!0,this.fire(new i.l("dataloading",{dataType:"source"}));try{const S=yield this.actor.sendAsync({type:"LD",data:v});if(this._isUpdatingWorker=!1,this._removed||S.abandoned)return void this.fire(new i.l("dataabort",{dataType:"source"}));S.applyDiff?this._applyDiff(d):this._data={geojson:S.data};let D=null;S.resourceTiming&&S.resourceTiming[this.id]&&(D=S.resourceTiming[this.id].slice(0));const k={dataType:"source"};this._collectResourceTiming&&D&&D.length>0&&i.e(k,{resourceTiming:D}),this.fire(new i.l("data",Object.assign(Object.assign({},k),{sourceDataType:"metadata"}))),this.fire(new i.l("data",Object.assign(Object.assign({},k),{sourceDataType:"content",shouldReloadTileOptions:this._getShouldReloadTileOptions(d)})))}catch(S){if(this._isUpdatingWorker=!1,this._removed)return void this.fire(new i.l("dataabort",{dataType:"source"}));this.fire(new i.k(S))}finally{this._hasPendingWorkerUpdate()&&this._updateWorkerData()}})}_applyDiff(s){const d=typeof this.promoteId=="string"?this.promoteId:void 0;this._data.url||this._data.updateable||!i.a6(this._data.geojson,d)||(this._data={updateable:i.a7(this._data.geojson,d)}),s&&this._data.updateable?i.a8(this._data.updateable,s,d):i.w("Cannot apply GeoJSONSource#updateData due to internal error")}_getShouldReloadTileOptions(s){if(this._options.cluster||!s||s.removeAll)return;const{add:d=[],update:v=[],remove:S=[]}=s||{},D=new Set([...v.map(k=>k.id),...S]);for(const k of D.values())if(typeof k!="number"&&this.promoteId==null)return void i.w(`GeoJSONSource "${this.id}": updateData is slower when using string GeoJSON feature IDs (e.g. "${k}"). Consider using promoteId or numeric IDs for better performance.`);return{nextBounds:[...v.map(k=>k.newGeometry),...d.map(k=>k.geometry)].filter(Boolean).map(k=>ql(k)),prevIds:D}}shouldReloadTile(s,{nextBounds:d,prevIds:v}){if(!s.latestFeatureIndex)return s.state!=="unloaded";const S=s.latestFeatureIndex.loadVTLayers();for(let H=0;H<s.latestFeatureIndex.featureIndexArray.length;H++){const J=s.latestFeatureIndex.featureIndexArray.get(H),et=S[i.a9].feature(J.featureIndex),mt=s.latestFeatureIndex.getId(et,i.a9);if(v.has(mt))return!0}const{buffer:D,extent:k}=this.workerOptions.geojsonVtOptions,j=function({x:H,y:J,z:et},mt=0){const dt=i.a2((H-mt)/Math.pow(2,et)),Tt=i.a3((J+1+mt)/Math.pow(2,et)),pt=i.a2((H+1+mt)/Math.pow(2,et)),It=i.a3((J-mt)/Math.pow(2,et));return new xo([dt,Tt],[pt,It])}(s.tileID.canonical,D/k);for(const H of d)if(j.intersects(H))return!0;return!1}loaded(){return!this._isUpdatingWorker&&!this._hasPendingWorkerUpdate()}loadTile(s){return i._(this,void 0,void 0,function*(){const d=s.actor?"RT":"LT";s.actor=this.actor;const v={type:this.type,uid:s.uid,tileID:s.tileID,zoom:s.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};s.abortController=new AbortController;const S=yield this.actor.sendAsync({type:d,data:v},s.abortController);delete s.abortController,s.unloadVectorData(),s.aborted||s.loadVectorData(S,this.map.painter,d==="RT")})}abortTile(s){return i._(this,void 0,void 0,function*(){s.abortController&&(s.abortController.abort(),delete s.abortController),s.aborted=!0})}unloadTile(s){return i._(this,void 0,void 0,function*(){s.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:s.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return i.e({},this._options,{type:this.type,data:this._data.updateable?{type:"FeatureCollection",features:Array.from(this._data.updateable.values())}:this._data.url||this._data.geojson})}hasTransition(){return!1}}class Cs extends i.E{constructor(s,d,v,S){super(),this.flippedWindingOrder=!1,this.id=s,this.dispatcher=v,this.coordinates=d.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(S),this.options=d}load(s){return i._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new i.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const d=yield bo.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,d&&d.data&&(this.image=d.data,s&&(this.coordinates=s),this._finishLoading())}catch(d){this._request=null,this._loaded=!0,this.fire(new i.k(d))}})}loaded(){return this._loaded}updateImage(s){return s.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=s.url,this.load(s.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new i.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(s){this.map=s,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(s){this.coordinates=s;const d=s.map(i.aa.fromLngLat);var v;return this.tileID=function(S){const D=i.ab.fromPoints(S),k=D.width(),j=D.height(),H=Math.max(k,j),J=Math.max(0,Math.floor(-Math.log(H)/Math.LN2)),et=Math.pow(2,J);return new i.ad(J,Math.floor((D.minX+D.maxX)/2*et),Math.floor((D.minY+D.maxY)/2*et))}(d),this.terrainTileRanges=this._getOverlappingTileRanges(d),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=d.map(S=>this.tileID.getTilePoint(S)._round()),this.flippedWindingOrder=((v=this.tileCoords)[1].x-v[0].x)*(v[2].y-v[0].y)-(v[1].y-v[0].y)*(v[2].x-v[0].x)<0,this.fire(new i.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const s=this.map.painter.context,d=s.gl;this.texture||(this.texture=new i.T(s,this.image,d.RGBA),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE));let v=!1;for(const S in this.tiles){const D=this.tiles[S];D.state!=="loaded"&&(D.state="loaded",D.texture=this.texture,v=!0)}v&&this.fire(new i.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(s){return i._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(s.tileID.canonical)?(this.tiles[String(s.tileID.wrap)]=s,s.buckets={}):s.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(s){const{minX:d,minY:v,maxX:S,maxY:D}=i.ab.fromPoints(s),k={};for(let j=0;j<=i.ac;j++){const H=Math.pow(2,j),J=Math.floor(d*H),et=Math.floor(v*H),mt=Math.floor(S*H),dt=Math.floor(D*H);k[j]={minTileX:J,minTileY:et,maxTileX:mt,maxTileY:dt}}return k}}class cl extends Cs{constructor(s,d,v,S){super(s,d,v,S),this.roundZoom=!0,this.type="video",this.options=d}load(){return i._(this,void 0,void 0,function*(){this._loaded=!1;const s=this.options;this.urls=[];for(const d of s.urls)this.urls.push(this.map._requestManager.transformRequest(d,"Source").url);try{const d=yield i.ae(this.urls);if(this._loaded=!0,!d)return;this.video=d,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(d){this.fire(new i.k(d))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(s){if(this.video){const d=this.video.seekable;s<d.start(0)||s>d.end(0)?this.fire(new i.k(new i.af(`sources.${this.id}`,null,`Playback for this video can be set only between the ${d.start(0)} and ${d.end(0)}-second mark.`))):this.video.currentTime=s}}getVideo(){return this.video}onAdd(s){this.map||(this.map=s,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const s=this.map.painter.context,d=s.gl;this.texture?this.video.paused||(this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE),d.texSubImage2D(d.TEXTURE_2D,0,0,0,d.RGBA,d.UNSIGNED_BYTE,this.video)):(this.texture=new i.T(s,this.video,d.RGBA),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE));let v=!1;for(const S in this.tiles){const D=this.tiles[S];D.state!=="loaded"&&(D.state="loaded",D.texture=this.texture,v=!0)}v&&this.fire(new i.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class Ml extends Cs{constructor(s,d,v,S){super(s,d,v,S),d.coordinates?Array.isArray(d.coordinates)&&d.coordinates.length===4&&!d.coordinates.some(D=>!Array.isArray(D)||D.length!==2||D.some(k=>typeof k!="number"))||this.fire(new i.k(new i.af(`sources.${s}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new i.k(new i.af(`sources.${s}`,null,'missing required property "coordinates"'))),d.animate&&typeof d.animate!="boolean"&&this.fire(new i.k(new i.af(`sources.${s}`,null,'optional "animate" property must be a boolean value'))),d.canvas?typeof d.canvas=="string"||d.canvas instanceof HTMLCanvasElement||this.fire(new i.k(new i.af(`sources.${s}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new i.k(new i.af(`sources.${s}`,null,'missing required property "canvas"'))),this.options=d,this.animate=d.animate===void 0||d.animate}load(){return i._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new i.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(s){this.map=s,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let s=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,s=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,s=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const d=this.map.painter.context,v=d.gl;this.texture?(s||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new i.T(d,this.canvas,v.RGBA,{premultiply:!0});let S=!1;for(const D in this.tiles){const k=this.tiles[D];k.state!=="loaded"&&(k.state="loaded",k.texture=this.texture,S=!0)}S&&this.fire(new i.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",animate:this.animate,canvas:this.options.canvas,coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const s of[this.canvas.width,this.canvas.height])if(isNaN(s)||s<=0)return!0;return!1}}const Cl={},Vs=C=>{switch(C){case"geojson":return bs;case"image":return Cs;case"raster":return $l;case"raster-dem":return Ms;case"vector":return ll;case"video":return cl;case"canvas":return Ml}return Cl[C]},hl="RTLPluginLoaded";class Ka extends i.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=$n()}_syncState(s){return this.status=s,this.dispatcher.broadcast("SRPS",{pluginStatus:s,pluginURL:this.url}).catch(d=>{throw this.status="error",d})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(s){return i._(this,arguments,void 0,function*(d,v=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=Rr.resolveURL(d),!this.url)throw new Error(`requested url ${d} is invalid`);if(this.status==="unavailable"){if(!v)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return i._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new i.l(hl))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let Zl=null;function Da(){return Zl||(Zl=new Ka),Zl}var so,we;(function(C){C[C.Base=0]="Base",C[C.Parent=1]="Parent"})(so||(so={})),function(C){C[C.Departing=0]="Departing",C[C.Incoming=1]="Incoming"}(we||(we={}));class St{constructor(s,d){this.timeAdded=0,this.fadeEndTime=0,this.fadeOpacity=1,this.tileID=s,this.uid=i.ag(),this.uses=0,this.tileSize=d,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}isRenderable(s){return this.hasData()&&(!this.fadeEndTime||this.fadeOpacity>0)&&(s||!this.holdingForSymbolFade())}setCrossFadeLogic({fadingRole:s,fadingDirection:d,fadingParentID:v,fadeEndTime:S}){this.resetFadeLogic(),this.fadingRole=s,this.fadingDirection=d,this.fadingParentID=v,this.fadeEndTime=S}setSelfFadeLogic(s){this.resetFadeLogic(),this.selfFading=!0,this.fadeEndTime=s}resetFadeLogic(){this.fadingRole=null,this.fadingDirection=null,this.fadingParentID=null,this.selfFading=!1,this.timeAdded=Ci(),this.fadeEndTime=0,this.fadeOpacity=1}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(s){this.demTexture&&s.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(s,d,v){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",s){s.featureIndex&&(this.latestFeatureIndex=s.featureIndex,s.rawTileData?(this.latestRawTileData=s.rawTileData,this.latestFeatureIndex.rawTileData=s.rawTileData,this.latestFeatureIndex.encoding=s.encoding):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData,this.latestFeatureIndex.encoding=this.latestEncoding)),this.collisionBoxArray=s.collisionBoxArray,this.buckets=function(S,D){const k={};if(!D)return k;for(const j of S){const H=j.layerIds.map(J=>D.getLayer(J)).filter(Boolean);if(H.length!==0){j.layers=H,j.stateDependentLayerIds&&(j.stateDependentLayers=j.stateDependentLayerIds.map(J=>H.filter(et=>et.id===J)[0]));for(const J of H)k[J.id]=j}}return k}(s.buckets,d==null?void 0:d.style),this.hasSymbolBuckets=!1;for(const S in this.buckets){const D=this.buckets[S];if(D instanceof i.ai){if(this.hasSymbolBuckets=!0,!v)break;D.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const S in this.buckets){const D=this.buckets[S];if(D instanceof i.ai&&D.hasRTLText){this.hasRTLText=!0,Da().lazyLoad();break}}this.queryPadding=0;for(const S in this.buckets){const D=this.buckets[S];this.queryPadding=Math.max(this.queryPadding,d.style.getLayer(S).queryRadius(D))}s.imageAtlas&&(this.imageAtlas=s.imageAtlas),s.glyphAtlasImage&&(this.glyphAtlasImage=s.glyphAtlasImage),this.dashPositions=s.dashPositions}else this.collisionBoxArray=new i.ah}unloadVectorData(){for(const s in this.buckets)this.buckets[s].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.dashPositions&&(this.dashPositions=null),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(s){return this.buckets[s.id]}upload(s){for(const v in this.buckets){const S=this.buckets[v];S.uploadPending()&&S.upload(s)}const d=s.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new i.T(s,this.imageAtlas.image,d.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new i.T(s,this.glyphAtlasImage,d.ALPHA),this.glyphAtlasImage=null)}prepare(s){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(s,this.imageAtlasTexture)}queryRenderedFeatures(s,d,v,S,D,k,j,H,J,et,mt){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:S,cameraQueryGeometry:D,scale:k,tileSize:this.tileSize,pixelPosMatrix:et,transform:H,params:j,queryPadding:this.queryPadding*J,getElevation:mt},s,d,v):{}}querySourceFeatures(s,d){const v=this.latestFeatureIndex;if(!v||!v.rawTileData)return;const S=v.loadVTLayers(),D=d&&d.sourceLayer?d.sourceLayer:"",k=S[i.a9]||S[D];if(!k)return;const j=i.aj(d==null?void 0:d.filter,d==null?void 0:d.globalState),{z:H,x:J,y:et}=this.tileID.canonical,mt={z:H,x:J,y:et};for(let dt=0;dt<k.length;dt++){const Tt=k.feature(dt);if(j.needGeometry){const Kt=i.ak(Tt,!0);if(!j.filter(new i.H(this.tileID.overscaledZ),Kt,this.tileID.canonical))continue}else if(!j.filter(new i.H(this.tileID.overscaledZ),Tt))continue;const pt=v.getId(Tt,D),It=new i.al(Tt,H,J,et,pt);It.tile=mt,s.push(It)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(s){const d=this.expirationTime;if(s.cacheControl){const v=i.am(s.cacheControl);v["max-age"]&&(this.expirationTime=Date.now()+1e3*v["max-age"])}else s.expires&&(this.expirationTime=new Date(s.expires).getTime());if(this.expirationTime){const v=Date.now();let S=!1;if(this.expirationTime>v)S=!1;else if(d)if(this.expirationTime<d)S=!0;else{const D=this.expirationTime-d;D?this.expirationTime=v+Math.max(D,3e4):S=!0}else S=!0;S?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(s,d){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(s).length===0)return;const v=this.latestFeatureIndex.loadVTLayers();for(const S in this.buckets){if(!d.style.hasLayer(S))continue;const D=this.buckets[S],k=D.layers[0].sourceLayer||i.a9,j=v[k],H=s[k];if(!j||!H||Object.keys(H).length===0)continue;D.update(H,j,this.imageAtlas&&this.imageAtlas.patternPositions||{},this.dashPositions||{});const J=d&&d.style&&d.style.getLayer(S);J&&(this.queryPadding=Math.max(this.queryPadding,J.queryRadius(D)))}}holdingForSymbolFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Ci()}clearSymbolFadeHold(){this.symbolFadeHoldUntil=void 0}setSymbolHoldDuration(s){this.symbolFadeHoldUntil=Ci()+s}setDependencies(s,d){const v={};for(const S of d)v[S]=!0;this.dependencies[s]=v}hasDependency(s,d){for(const v of s){const S=this.dependencies[v];if(S){for(const D of d)if(S[D])return!0}}return!1}}class Pt{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(s,d,v){const S=String(d);if(this.stateChanges[s]=this.stateChanges[s]||{},this.stateChanges[s][S]=this.stateChanges[s][S]||{},i.e(this.stateChanges[s][S],v),this.deletedStates[s]===null){this.deletedStates[s]={};for(const D in this.state[s])D!==S&&(this.deletedStates[s][D]=null)}else if(this.deletedStates[s]&&this.deletedStates[s][S]===null){this.deletedStates[s][S]={};for(const D in this.state[s][S])v[D]||(this.deletedStates[s][S][D]=null)}else for(const D in v)this.deletedStates[s]&&this.deletedStates[s][S]&&this.deletedStates[s][S][D]===null&&delete this.deletedStates[s][S][D]}removeFeatureState(s,d,v){if(this.deletedStates[s]===null)return;const S=String(d);if(this.deletedStates[s]=this.deletedStates[s]||{},v&&d!==void 0)this.deletedStates[s][S]!==null&&(this.deletedStates[s][S]=this.deletedStates[s][S]||{},this.deletedStates[s][S][v]=null);else if(d!==void 0)if(this.stateChanges[s]&&this.stateChanges[s][S])for(v in this.deletedStates[s][S]={},this.stateChanges[s][S])this.deletedStates[s][S][v]=null;else this.deletedStates[s][S]=null;else this.deletedStates[s]=null}getState(s,d){const v=String(d),S=i.e({},(this.state[s]||{})[v],(this.stateChanges[s]||{})[v]);if(this.deletedStates[s]===null)return{};if(this.deletedStates[s]){const D=this.deletedStates[s][d];if(D===null)return{};for(const k in D)delete S[k]}return S}initializeTileState(s,d){s.setFeatureState(this.state,d)}coalesceChanges(s,d){const v={};for(const S in this.stateChanges){this.state[S]=this.state[S]||{};const D={};for(const k in this.stateChanges[S])this.state[S][k]||(this.state[S][k]={}),i.e(this.state[S][k],this.stateChanges[S][k]),D[k]=this.state[S][k];v[S]=D}for(const S in this.deletedStates){this.state[S]=this.state[S]||{};const D={};if(this.deletedStates[S]===null)for(const k in this.state[S])D[k]={},this.state[S][k]={};else for(const k in this.deletedStates[S]){if(this.deletedStates[S][k]===null)this.state[S][k]={};else for(const j of Object.keys(this.deletedStates[S][k]))delete this.state[S][k][j];D[k]=this.state[S][k]}v[S]=v[S]||{},i.e(v[S],D)}if(this.stateChanges={},this.deletedStates={},Object.keys(v).length!==0)for(const S in s)s[S].setFeatureState(v,d)}}const Nt=89.25;function ce(C,s){const d=i.an(s.lat,-i.ao,i.ao);return new i.P(i.Y(s.lng)*C,i.X(d)*C)}function ae(C,s){return new i.aa(s.x/C,s.y/C).toLngLat()}function Fe(C){return C.cameraToCenterDistance*Math.min(.85*Math.tan(i.ap(90-C.pitch)),Math.tan(i.ap(Nt-C.pitch)))}function Jt(C,s){const d=C.canonical,v=s/i.aq(d.z),S=d.x+Math.pow(2,d.z)*C.wrap,D=i.ar(new Float64Array(16));return i.O(D,D,[S*v,d.y*v,0]),i.Q(D,D,[v/i.a4,v/i.a4,1]),D}function De(C,s,d,v,S){const D=i.aa.fromLngLat(C,s),k=S*i.as(1,C.lat),j=k*Math.cos(i.ap(d)),H=Math.sqrt(k*k-j*j),J=H*Math.sin(i.ap(-v)),et=H*Math.cos(i.ap(-v));return new i.aa(D.x+J,D.y+et,D.z+j)}function We(C,s,d){const v=s.intersectsFrustum(C);if(!d||v===0)return v;const S=s.intersectsPlane(d);return S===0?0:v===2&&S===2?2:1}function ci(C,s,d){let v=0;const S=(d-s)/10;for(let D=0;D<10;D++)v+=S*Math.pow(Math.cos(s+(D+.5)/10*(d-s)),C);return v}function ui(C,s){return function(d,v,S,D,k){const j=2*((C-1)/i.at(Math.cos(i.ap(Nt-k))/Math.cos(i.ap(Nt)))-1),H=Math.acos(S/D),J=2*ci(j-1,0,i.ap(k/2)),et=Math.min(i.ap(Nt),H+i.ap(k/2)),mt=ci(j-1,Math.min(et,H-i.ap(k/2)),et),dt=Math.atan(v/S),Tt=Math.hypot(v,S);let pt=d;return pt+=i.at(D/Tt/Math.max(.5,Math.cos(i.ap(k/2)))),pt+=j*i.at(Math.cos(dt))/2,pt-=i.at(Math.max(1,mt/J/s))/2,pt}}const cr=ui(9.314,3);function zr(C,s){const d=(s.roundZoom?Math.round:Math.floor)(C.zoom+i.at(C.tileSize/s.tileSize));return Math.max(0,d)}function Ae(C,s){const d=C.getCameraFrustum(),v=C.getClippingPlane(),S=C.screenPointToMercatorCoordinate(C.getCameraPoint()),D=i.aa.fromLngLat(C.center,C.elevation);S.z=D.z+Math.cos(C.pitchInRadians)*C.cameraToCenterDistance/C.worldSize;const k=C.getCoveringTilesDetailsProvider(),j=k.allowVariableZoom(C,s),H=zr(C,s),J=s.minzoom||0,et=s.maxzoom!==void 0?s.maxzoom:C.maxZoom,mt=Math.min(Math.max(0,H),et),dt=Math.pow(2,mt),Tt=[dt*S.x,dt*S.y,0],pt=[dt*D.x,dt*D.y,0],It=Math.hypot(D.x-S.x,D.y-S.y),Kt=Math.abs(D.z-S.z),Wt=Math.hypot(It,Kt),ft=me=>({zoom:0,x:0,y:0,wrap:me,fullyVisible:!1}),_e=[],he=[];if(C.renderWorldCopies&&k.allowWorldCopies())for(let me=1;me<=3;me++)_e.push(ft(-me)),_e.push(ft(me));for(_e.push(ft(0));_e.length>0;){const me=_e.pop(),be=me.x,de=me.y;let Ce=me.fullyVisible;const Qe={x:be,y:de,z:me.zoom},Xe=k.getTileBoundingVolume(Qe,me.wrap,C.elevation,s);if(!Ce){const Oi=We(d,Xe,v);if(Oi===0)continue;Ce=Oi===2}const Je=k.distanceToTile2d(S.x,S.y,Qe,Xe);let ii=H;j&&(ii=(s.calculateTileZoom||cr)(C.zoom+i.at(C.tileSize/s.tileSize),Je,Kt,Wt,C.fov)),ii=(s.roundZoom?Math.round:Math.floor)(ii),ii=Math.max(0,ii);const Ri=Math.min(ii,et);if(me.wrap=k.getWrap(D,Qe,me.wrap),me.zoom>=Ri){if(me.zoom<J)continue;const Oi=mt-me.zoom,Ti=Tt[0]-.5-(be<<Oi),br=Tt[1]-.5-(de<<Oi),tn=s.reparseOverscaled?Math.max(me.zoom,ii):me.zoom;he.push({tileID:new i.a1(me.zoom===et?tn:me.zoom,me.wrap,me.zoom,be,de),distanceSq:i.au([pt[0]-.5-be,pt[1]-.5-de]),tileDistanceToCamera:Math.sqrt(Ti*Ti+br*br)})}else for(let Oi=0;Oi<4;Oi++)_e.push({zoom:me.zoom+1,x:(be<<1)+Oi%2,y:(de<<1)+(Oi>>1),wrap:me.wrap,fullyVisible:Ce})}return he.sort((me,be)=>me.distanceSq-be.distanceSq).map(me=>me.tileID)}const Do=i.ab.fromPoints([new i.P(0,0),new i.P(i.a4,i.a4)]);class An extends i.E{constructor(s,d,v){super(),this.id=s,this.dispatcher=v,this.on("data",S=>this._dataHandler(S)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((S,D,k,j)=>{const H=new(Vs(D.type))(S,D,k,j);if(H.id!==S)throw new Error(`Expected Source id to be ${S} instead of ${H.id}`);return H})(s,d,v,this),this._tiles={},this._cache=new i.av(0,S=>this._unloadTile(S)),this._timers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._rasterFadeDuration=0,this._maxFadingAncestorLevels=5,this._state=new Pt,this._didEmitContent=!1,this._updated=!1}onAdd(s){this.map=s,this._maxTileCacheSize=s?s._maxTileCacheSize:null,this._maxTileCacheZoomLevels=s?s._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(s)}onRemove(s){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(s)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const s in this._tiles){const d=this._tiles[s];if(d.state!=="loaded"&&d.state!=="errored")return!1}return!0}getSource(){return this._source}getState(){return this._state}pause(){this._paused=!0}resume(){if(!this._paused)return;const s=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,s&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(s,d,v){return i._(this,void 0,void 0,function*(){try{yield this._source.loadTile(s),this._tileLoaded(s,d,v)}catch(S){s.state="errored",S.status!==404?this._source.fire(new i.k(S,{tile:s})):this.update(this.transform,this.terrain)}})}_unloadTile(s){this._source.unloadTile&&this._source.unloadTile(s)}_abortTile(s){this._source.abortTile&&this._source.abortTile(s),this._source.fire(new i.l("dataabort",{tile:s,coord:s.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(s){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const d in this._tiles){const v=this._tiles[d];v.upload(s),v.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(s=>s.tileID).sort(Qn).map(s=>s.key)}getRenderableIds(s){const d=[];for(const v in this._tiles)this._isIdRenderable(v,s)&&d.push(this._tiles[v]);return s?d.sort((v,S)=>{const D=v.tileID,k=S.tileID,j=new i.P(D.canonical.x,D.canonical.y)._rotate(-this.transform.bearingInRadians),H=new i.P(k.canonical.x,k.canonical.y)._rotate(-this.transform.bearingInRadians);return D.overscaledZ-k.overscaledZ||H.y-j.y||H.x-j.x}).map(v=>v.tileID.key):d.map(v=>v.tileID).sort(Qn).map(v=>v.key)}hasRenderableParent(s){const d=s.overscaledZ-1;if(d>=this._source.minzoom){const v=this.getLoadedTile(s.scaledTo(d));if(v)return this._isIdRenderable(v.tileID.key)}return!1}_isIdRenderable(s,d=!1){var v;return(v=this._tiles[s])===null||v===void 0?void 0:v.isRenderable(d)}reload(s,d=void 0){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const v in this._tiles)d&&this._source.shouldReloadTile&&!this._source.shouldReloadTile(this._tiles[v],d)||(s?this._reloadTile(v,"expired"):this._tiles[v].state!=="errored"&&this._reloadTile(v,"reloading"))}}_reloadTile(s,d){return i._(this,void 0,void 0,function*(){const v=this._tiles[s];v&&(v.state!=="loading"&&(v.state=d),yield this._loadTile(v,s,d))})}_tileLoaded(s,d,v){s.timeAdded=Ci(),s.selfFading&&(s.fadeEndTime=s.timeAdded+this._rasterFadeDuration),v==="expired"&&(s.refreshedUponExpiration=!0),this._setTileReloadTimer(d,s),this.getSource().type==="raster-dem"&&s.dem&&this._backfillDEM(s),this._state.initializeTileState(s,this.map?this.map.painter:null),s.aborted||this._source.fire(new i.l("data",{dataType:"source",tile:s,coord:s.tileID}))}_backfillDEM(s){const d=this.getRenderableIds();for(let S=0;S<d.length;S++){const D=d[S];if(s.neighboringTiles&&s.neighboringTiles[D]){const k=this.getTileByID(D);v(s,k),v(k,s)}}function v(S,D){S.needsHillshadePrepare=!0,S.needsTerrainPrepare=!0;let k=D.tileID.canonical.x-S.tileID.canonical.x;const j=D.tileID.canonical.y-S.tileID.canonical.y,H=Math.pow(2,S.tileID.canonical.z),J=D.tileID.key;k===0&&j===0||Math.abs(j)>1||(Math.abs(k)>1&&(Math.abs(k+H)===1?k+=H:Math.abs(k-H)===1&&(k-=H)),D.dem&&S.dem&&(S.dem.backfillBorder(D.dem,k,j),S.neighboringTiles&&S.neighboringTiles[J]&&(S.neighboringTiles[J].backfilled=!0)))}}getTile(s){return this.getTileByID(s.key)}getTileByID(s){return this._tiles[s]}_retainLoadedChildren(s,d){const v=this._getLoadedDescendents(d),S=new Set;for(const D of d){const k=v[D.key];if(!(k!=null&&k.length)){S.add(D);continue}const j=D.overscaledZ+An.maxOverzooming,H=k.filter(mt=>mt.tileID.overscaledZ<=j);if(!H.length){S.add(D);continue}const J=Math.min(...H.map(mt=>mt.tileID.overscaledZ)),et=H.filter(mt=>mt.tileID.overscaledZ===J).map(mt=>mt.tileID);for(const mt of et)s[mt.key]=mt;this._areDescendentsComplete(et,J,D.overscaledZ)||S.add(D)}return S}_getLoadedDescendents(s){var d;const v={};for(const S in this._tiles){const D=this._tiles[S];if(D.hasData())for(const k of s)D.tileID.isChildOf(k)&&(v[d=k.key]||(v[d]=[])).push(D)}return v}_areDescendentsComplete(s,d,v){return s.length===1&&s[0].isOverscaled()?s[0].overscaledZ===d:Math.pow(4,d-v)===s.length}getLoadedTile(s){const d=this._tiles[s.key];return d!=null&&d.hasData()?d:null}updateCacheSize(s){const d=Math.ceil(s.width/this._source.tileSize)+1,v=Math.ceil(s.height/this._source.tileSize)+1,S=Math.floor(d*v*(this._maxTileCacheZoomLevels===null?i.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),D=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,S):S;this._cache.setMaxSize(D)}handleWrapJump(s){const d=Math.round((s-(this._prevLng===void 0?s:this._prevLng))/360);if(this._prevLng=s,d){const v={};for(const S in this._tiles){const D=this._tiles[S];D.tileID=D.tileID.unwrapTo(D.tileID.wrap+d),v[D.tileID.key]=D}this._tiles=v,this._resetTileReloadTimers()}}update(s,d){if(!this._sourceLoaded||this._paused)return;let v;this.transform=s,this.terrain=d,this.updateCacheSize(s),this.handleWrapJump(this.transform.center.lng),this.used||this.usedForTerrain?this._source.tileID?v=s.getVisibleUnwrappedCoordinates(this._source.tileID).map(H=>new i.a1(H.canonical.z,H.wrap,H.canonical.z,H.canonical.x,H.canonical.y)):(v=Ae(s,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.type==="vector"&&this.map._zoomLevelsToOverscale!==void 0?s.maxZoom-this.map._zoomLevelsToOverscale:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:d,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(v=v.filter(H=>this._source.hasTile(H)))):v=[],this.usedForTerrain&&(v=this._addTerrainIdealTiles(v));const S=v.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,S&&this.fire(new i.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const D=zr(s,this._source),k=this._updateRetainedTiles(v,D),j=ar(this._source.type);j&&this._rasterFadeDuration>0&&!d&&this._updateFadingTiles(v,k),j?this._cleanUpRasterTiles(k):this._cleanUpVectorTiles(k)}_cleanUpRasterTiles(s){for(const d in this._tiles)s[d]||this._removeTile(d)}_cleanUpVectorTiles(s){for(const d in this._tiles){const v=this._tiles[d];s[d]?v.clearSymbolFadeHold():v.hasSymbolBuckets?v.holdingForSymbolFade()?v.symbolFadeFinished()&&this._removeTile(d):v.setSymbolHoldDuration(this.map._fadeDuration):this._removeTile(d)}}_addTerrainIdealTiles(s){const d=[];for(const v of s)if(v.canonical.z>this._source.minzoom){const S=v.scaledTo(v.canonical.z-1);d.push(S);const D=v.scaledTo(Math.max(this._source.minzoom,Math.min(v.canonical.z,5)));d.push(D)}return s.concat(d)}releaseSymbolFadeTiles(){for(const s in this._tiles)this._tiles[s].holdingForSymbolFade()&&this._removeTile(s)}_updateRetainedTiles(s,d){var v;const S=new Set;for(const J of s)this._addTile(J).hasData()||S.add(J);const D=s.reduce((J,et)=>(J[et.key]=et,J),{}),k=this._retainLoadedChildren(D,S),j={},H=Math.max(d-An.maxUnderzooming,this._source.minzoom);for(const J of k){let et=this._tiles[J.key],mt=et==null?void 0:et.wasRequested();for(let dt=J.overscaledZ-1;dt>=H;--dt){const Tt=J.scaledTo(dt);if(j[Tt.key])break;if(j[Tt.key]=!0,et=this.getTile(Tt),!et&&mt&&(et=this._addTile(Tt)),et){const pt=et.hasData();if((pt||!(!((v=this.map)===null||v===void 0)&&v.cancelPendingTileRequestsWhileZooming)||mt)&&(D[Tt.key]=Tt),mt=et.wasRequested(),pt)break}}}return D}_updateFadingTiles(s,d){const v=Ci(),S=i.aw(s);for(const D of s){const k=this._tiles[D.key];k.fadingDirection!==we.Departing&&k.fadeOpacity!==0||k.resetFadeLogic(),this._updateFadingAncestor(k,d,v)||this._updateFadingDescendents(k,d,v)||this._updateFadingEdge(k,S,v)||k.resetFadeLogic()}}_updateFadingAncestor(s,d,v){if(!s.hasData())return!1;const{tileID:S,fadingRole:D,fadingDirection:k,fadingParentID:j}=s;if(D===so.Base&&k===we.Incoming&&j)return d[j.key]=j,!0;const H=Math.max(S.overscaledZ-this._maxFadingAncestorLevels,this._source.minzoom);for(let J=S.overscaledZ-1;J>=H;J--){const et=S.scaledTo(J),mt=this.getLoadedTile(et);if(mt)return s.setCrossFadeLogic({fadingRole:so.Base,fadingDirection:we.Incoming,fadingParentID:mt.tileID,fadeEndTime:v+this._rasterFadeDuration}),mt.setCrossFadeLogic({fadingRole:so.Parent,fadingDirection:we.Departing,fadeEndTime:v+this._rasterFadeDuration}),d[et.key]=et,!0}return!1}_updateFadingDescendents(s,d,v){if(!s.hasData())return!1;const S=s.tileID.children(this._source.maxzoom);let D=this._updateFadingChildren(s,S,d,v);if(D)return!0;for(const k of S){const j=k.children(this._source.maxzoom);this._updateFadingChildren(s,j,d,v)&&(D=!0)}return D}_updateFadingChildren(s,d,v,S){if(d[0].overscaledZ>=this._source.maxzoom)return!1;let D=!1;for(const k of d){const j=this.getLoadedTile(k);if(!j)continue;const{fadingRole:H,fadingDirection:J,fadingParentID:et}=j;H===so.Base&&J===we.Departing&&et||(j.setCrossFadeLogic({fadingRole:so.Base,fadingDirection:we.Departing,fadingParentID:s.tileID,fadeEndTime:S+this._rasterFadeDuration}),s.setCrossFadeLogic({fadingRole:so.Parent,fadingDirection:we.Incoming,fadeEndTime:S+this._rasterFadeDuration})),v[k.key]=k,D=!0}return D}_updateFadingEdge(s,d,v){const S=s.tileID;return!!s.selfFading||!s.hasData()&&!!d.has(S)&&(s.setSelfFadeLogic(v+this._rasterFadeDuration),!0)}_addTile(s){let d=this._tiles[s.key];if(d)return d;d=this._cache.getAndRemove(s),d&&(d.resetFadeLogic(),this._setTileReloadTimer(s.key,d),d.tileID=s,this._state.initializeTileState(d,this.map?this.map.painter:null));const v=d;return d||(d=new St(s,this._source.tileSize*s.overscaleFactor()),this._loadTile(d,s.key,d.state)),d.uses++,this._tiles[s.key]=d,v||this._source.fire(new i.l("dataloading",{tile:d,coord:d.tileID,dataType:"source"})),d}_setTileReloadTimer(s,d){this._clearTileReloadTimer(s);const v=d.getExpiryTimeout();v&&(this._timers[s]=setTimeout(()=>{this._reloadTile(s,"expired"),delete this._timers[s]},v))}_clearTileReloadTimer(s){const d=this._timers[s];d&&(clearTimeout(d),delete this._timers[s])}_resetTileReloadTimers(){for(const s in this._timers)clearTimeout(this._timers[s]),delete this._timers[s];for(const s in this._tiles)this._setTileReloadTimer(s,this._tiles[s])}refreshTiles(s){for(const d in this._tiles)(this._isIdRenderable(d)||this._tiles[d].state=="errored")&&s.some(v=>v.equals(this._tiles[d].tileID.canonical))&&this._reloadTile(d,"expired")}_removeTile(s){const d=this._tiles[s];d&&(d.uses--,delete this._tiles[s],this._clearTileReloadTimer(s),d.uses>0||(d.hasData()&&d.state!=="reloading"?this._cache.add(d.tileID,d,d.getExpiryTimeout()):(d.aborted=!0,this._abortTile(d),this._unloadTile(d))))}_dataHandler(s){s.dataType==="source"&&(s.sourceDataType!=="metadata"?s.sourceDataType==="content"&&this._sourceLoaded&&!this._paused&&(this.reload(s.sourceDataChanged,s.shouldReloadTileOptions),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0):this._sourceLoaded=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const s in this._tiles)this._removeTile(s);this._cache.reset()}tilesIn(s,d,v){const S=[],D=this.transform;if(!D)return S;const k=D.getCoveringTilesDetailsProvider().allowWorldCopies(),j=v?D.getCameraQueryGeometry(s):s,H=Tt=>D.screenPointToMercatorCoordinate(Tt,this.terrain),J=this.transformBbox(s,H,!k),et=this.transformBbox(j,H,!k),mt=this.getIds(),dt=i.ab.fromPoints(et);for(let Tt=0;Tt<mt.length;Tt++){const pt=this._tiles[mt[Tt]];if(pt.holdingForSymbolFade())continue;const It=k?[pt.tileID]:[pt.tileID.unwrapTo(-1),pt.tileID.unwrapTo(0)],Kt=Math.pow(2,D.zoom-pt.tileID.overscaledZ),Wt=d*pt.queryPadding*i.a4/pt.tileSize/Kt;for(const ft of It){const _e=dt.map(he=>ft.getTilePoint(new i.aa(he.x,he.y)));if(_e.expandBy(Wt),_e.intersects(Do)){const he=J.map(be=>ft.getTilePoint(be)),me=et.map(be=>ft.getTilePoint(be));S.push({tile:pt,tileID:k?ft:ft.unwrapTo(0),queryGeometry:he,cameraQueryGeometry:me,scale:Kt})}}}return S}transformBbox(s,d,v){let S=s.map(d);if(v){const D=i.ab.fromPoints(s);D.shrinkBy(.001*Math.min(D.width(),D.height()));const k=D.map(d);i.ab.fromPoints(S).covers(k)||(S=S.map(j=>j.x>.5?new i.aa(j.x-1,j.y,j.z):j))}return S}getVisibleCoordinates(s){const d=this.getRenderableIds(s).map(v=>this._tiles[v].tileID);return this.transform&&this.transform.populateCache(d),d}hasTransition(){if(this._source.hasTransition())return!0;if(ar(this._source.type)&&this._rasterFadeDuration>0){const s=Ci();for(const d in this._tiles)if(this._tiles[d].fadeEndTime>=s)return!0}return!1}setRasterFadeDuration(s){this._rasterFadeDuration=s}setFeatureState(s,d,v){this._state.updateState(s=s||i.a9,d,v)}removeFeatureState(s,d,v){this._state.removeFeatureState(s=s||i.a9,d,v)}getFeatureState(s,d){return this._state.getState(s=s||i.a9,d)}setDependencies(s,d,v){const S=this._tiles[s];S&&S.setDependencies(d,v)}reloadTilesForDependencies(s,d){for(const v in this._tiles)this._tiles[v].hasDependency(s,d)&&this._reloadTile(v,"reloading");this._cache.filter(v=>!v.hasDependency(s,d))}}function Qn(C,s){const d=Math.abs(2*C.wrap)-+(C.wrap<0),v=Math.abs(2*s.wrap)-+(s.wrap<0);return C.overscaledZ-s.overscaledZ||v-d||s.canonical.y-C.canonical.y||s.canonical.x-C.canonical.x}function ar(C){return C==="raster"||C==="image"||C==="video"}An.maxUnderzooming=10,An.maxOverzooming=3;class bi{constructor(s,d){this.reset(s,d)}reset(s,d){this.points=s||[],this._distances=[0];for(let v=1;v<this.points.length;v++)this._distances[v]=this._distances[v-1]+this.points[v].dist(this.points[v-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(d||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(s){if(this.points.length===1)return this.points[0];s=i.an(s,0,1);let d=1,v=this._distances[d];const S=s*this.paddedLength+this.padding;for(;v<S&&d<this._distances.length;)v=this._distances[++d];const D=d-1,k=this._distances[D],j=v-k,H=j>0?(S-k)/j:0;return this.points[D].mult(1-H).add(this.points[d].mult(H))}}function Zo(C,s){let d=!0;return C==="always"||C!=="never"&&s!=="never"||(d=!1),d}class zo{constructor(s,d,v){const S=this.boxCells=[],D=this.circleCells=[];this.xCellCount=Math.ceil(s/v),this.yCellCount=Math.ceil(d/v);for(let k=0;k<this.xCellCount*this.yCellCount;k++)S.push([]),D.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=s,this.height=d,this.xScale=this.xCellCount/s,this.yScale=this.yCellCount/d,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(s,d,v,S,D){this._forEachCell(d,v,S,D,this._insertBoxCell,this.boxUid++),this.boxKeys.push(s),this.bboxes.push(d),this.bboxes.push(v),this.bboxes.push(S),this.bboxes.push(D)}insertCircle(s,d,v,S){this._forEachCell(d-S,v-S,d+S,v+S,this._insertCircleCell,this.circleUid++),this.circleKeys.push(s),this.circles.push(d),this.circles.push(v),this.circles.push(S)}_insertBoxCell(s,d,v,S,D,k){this.boxCells[D].push(k)}_insertCircleCell(s,d,v,S,D,k){this.circleCells[D].push(k)}_query(s,d,v,S,D,k,j){if(v<0||s>this.width||S<0||d>this.height)return[];const H=[];if(s<=0&&d<=0&&this.width<=v&&this.height<=S){if(D)return[{key:null,x1:s,y1:d,x2:v,y2:S}];for(let J=0;J<this.boxKeys.length;J++)H.push({key:this.boxKeys[J],x1:this.bboxes[4*J],y1:this.bboxes[4*J+1],x2:this.bboxes[4*J+2],y2:this.bboxes[4*J+3]});for(let J=0;J<this.circleKeys.length;J++){const et=this.circles[3*J],mt=this.circles[3*J+1],dt=this.circles[3*J+2];H.push({key:this.circleKeys[J],x1:et-dt,y1:mt-dt,x2:et+dt,y2:mt+dt})}}else this._forEachCell(s,d,v,S,this._queryCell,H,{hitTest:D,overlapMode:k,seenUids:{box:{},circle:{}}},j);return H}query(s,d,v,S){return this._query(s,d,v,S,!1,null)}hitTest(s,d,v,S,D,k){return this._query(s,d,v,S,!0,D,k).length>0}hitTestCircle(s,d,v,S,D){const k=s-v,j=s+v,H=d-v,J=d+v;if(j<0||k>this.width||J<0||H>this.height)return!1;const et=[];return this._forEachCell(k,H,j,J,this._queryCellCircle,et,{hitTest:!0,overlapMode:S,circle:{x:s,y:d,radius:v},seenUids:{box:{},circle:{}}},D),et.length>0}_queryCell(s,d,v,S,D,k,j,H){const{seenUids:J,hitTest:et,overlapMode:mt}=j,dt=this.boxCells[D];if(dt!==null){const pt=this.bboxes;for(const It of dt)if(!J.box[It]){J.box[It]=!0;const Kt=4*It,Wt=this.boxKeys[It];if(s<=pt[Kt+2]&&d<=pt[Kt+3]&&v>=pt[Kt+0]&&S>=pt[Kt+1]&&(!H||H(Wt))&&(!et||!Zo(mt,Wt.overlapMode))&&(k.push({key:Wt,x1:pt[Kt],y1:pt[Kt+1],x2:pt[Kt+2],y2:pt[Kt+3]}),et))return!0}}const Tt=this.circleCells[D];if(Tt!==null){const pt=this.circles;for(const It of Tt)if(!J.circle[It]){J.circle[It]=!0;const Kt=3*It,Wt=this.circleKeys[It];if(this._circleAndRectCollide(pt[Kt],pt[Kt+1],pt[Kt+2],s,d,v,S)&&(!H||H(Wt))&&(!et||!Zo(mt,Wt.overlapMode))){const ft=pt[Kt],_e=pt[Kt+1],he=pt[Kt+2];if(k.push({key:Wt,x1:ft-he,y1:_e-he,x2:ft+he,y2:_e+he}),et)return!0}}}return!1}_queryCellCircle(s,d,v,S,D,k,j,H){const{circle:J,seenUids:et,overlapMode:mt}=j,dt=this.boxCells[D];if(dt!==null){const pt=this.bboxes;for(const It of dt)if(!et.box[It]){et.box[It]=!0;const Kt=4*It,Wt=this.boxKeys[It];if(this._circleAndRectCollide(J.x,J.y,J.radius,pt[Kt+0],pt[Kt+1],pt[Kt+2],pt[Kt+3])&&(!H||H(Wt))&&!Zo(mt,Wt.overlapMode))return k.push(!0),!0}}const Tt=this.circleCells[D];if(Tt!==null){const pt=this.circles;for(const It of Tt)if(!et.circle[It]){et.circle[It]=!0;const Kt=3*It,Wt=this.circleKeys[It];if(this._circlesCollide(pt[Kt],pt[Kt+1],pt[Kt+2],J.x,J.y,J.radius)&&(!H||H(Wt))&&!Zo(mt,Wt.overlapMode))return k.push(!0),!0}}}_forEachCell(s,d,v,S,D,k,j,H){const J=this._convertToXCellCoord(s),et=this._convertToYCellCoord(d),mt=this._convertToXCellCoord(v),dt=this._convertToYCellCoord(S);for(let Tt=J;Tt<=mt;Tt++)for(let pt=et;pt<=dt;pt++)if(D.call(this,s,d,v,S,this.xCellCount*pt+Tt,k,j,H))return}_convertToXCellCoord(s){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(s*this.xScale)))}_convertToYCellCoord(s){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(s*this.yScale)))}_circlesCollide(s,d,v,S,D,k){const j=S-s,H=D-d,J=v+k;return J*J>j*j+H*H}_circleAndRectCollide(s,d,v,S,D,k,j){const H=(k-S)/2,J=Math.abs(s-(S+H));if(J>H+v)return!1;const et=(j-D)/2,mt=Math.abs(d-(D+et));if(mt>et+v)return!1;if(J<=H||mt<=et)return!0;const dt=J-H,Tt=mt-et;return dt*dt+Tt*Tt<=v*v}}function se(C,s,d){const v=i.N();if(!C){const{vecSouth:mt,vecEast:dt}=tt(s),Tt=wi();Tt[0]=dt[0],Tt[1]=dt[1],Tt[2]=mt[0],Tt[3]=mt[1],S=Tt,(et=(k=(D=Tt)[0])*(J=D[3])-(H=D[2])*(j=D[1]))&&(S[0]=J*(et=1/et),S[1]=-j*et,S[2]=-H*et,S[3]=k*et),v[0]=Tt[0],v[1]=Tt[1],v[4]=Tt[2],v[5]=Tt[3]}var S,D,k,j,H,J,et;return i.Q(v,v,[1/d,1/d,1]),v}function st(C,s,d,v){if(C){const S=i.N();if(!s){const{vecSouth:D,vecEast:k}=tt(d);S[0]=k[0],S[1]=k[1],S[4]=D[0],S[5]=D[1]}return i.Q(S,S,[v,v,1]),S}return d.pixelsToClipSpaceMatrix}function tt(C){const s=Math.cos(C.rollInRadians),d=Math.sin(C.rollInRadians),v=Math.cos(C.pitchInRadians),S=Math.cos(C.bearingInRadians),D=Math.sin(C.bearingInRadians),k=i.aB();k[0]=-S*v*d-D*s,k[1]=-D*v*d+S*s;const j=i.aC(k);j<1e-9?i.aD(k):i.aE(k,k,1/j);const H=i.aB();H[0]=S*v*s-D*d,H[1]=D*v*s+S*d;const J=i.aC(H);return J<1e-9?i.aD(H):i.aE(H,H,1/J),{vecEast:H,vecSouth:k}}function wt(C,s,d,v){let S;v?(S=[C,s,v(C,s),1],i.aG(S,S,d)):(S=[C,s,0,1],Vo(S,S,d));const D=S[3];return{point:new i.P(S[0]/D,S[1]/D),signedDistanceFromCamera:D,isOccluded:!1}}function Bt(C,s){return .5+C/s*.5}function Ht(C,s){return C.x>=-s[0]&&C.x<=s[0]&&C.y>=-s[1]&&C.y<=s[1]}function oe(C,s,d,v,S,D,k,j,H,J,et,mt,dt){const Tt=d?C.textSizeData:C.iconSizeData,pt=i.ax(Tt,s.transform.zoom),It=[256/s.width*2+1,256/s.height*2+1],Kt=d?C.text.dynamicLayoutVertexArray:C.icon.dynamicLayoutVertexArray;Kt.clear();const Wt=C.lineVertexArray,ft=d?C.text.placedSymbolArray:C.icon.placedSymbolArray,_e=s.transform.width/s.transform.height;let he=!1;for(let me=0;me<ft.length;me++){const be=ft.get(me);if(be.hidden||be.writingMode===i.ay.vertical&&!he){Nn(be.numGlyphs,Kt);continue}he=!1;const de=new i.P(be.anchorX,be.anchorY),Ce={getElevation:dt,pitchedLabelPlaneMatrix:v,lineVertexArray:Wt,pitchWithMap:D,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:s.transform,tileAnchorPoint:de,unwrappedTileID:H,width:J,height:et,translation:mt},Qe=Ki(be.anchorX,be.anchorY,Ce);if(!Ht(Qe.point,It)){Nn(be.numGlyphs,Kt);continue}const Xe=Bt(s.transform.cameraToCenterDistance,Qe.signedDistanceFromCamera),Je=i.az(Tt,pt,be),ii=D?Je*s.transform.getPitchedTextCorrection(be.anchorX,be.anchorY,H)/Xe:Je*Xe,Ri=xe({projectionContext:Ce,pitchedLabelPlaneMatrixInverse:S,symbol:be,fontSize:ii,flip:!1,keepUpright:k,glyphOffsetArray:C.glyphOffsetArray,dynamicLayoutVertexArray:Kt,aspectRatio:_e,rotateToLine:j});he=Ri.useVertical,(Ri.notEnoughRoom||he||Ri.needsFlipping&&xe({projectionContext:Ce,pitchedLabelPlaneMatrixInverse:S,symbol:be,fontSize:ii,flip:!0,keepUpright:k,glyphOffsetArray:C.glyphOffsetArray,dynamicLayoutVertexArray:Kt,aspectRatio:_e,rotateToLine:j}).notEnoughRoom)&&Nn(be.numGlyphs,Kt)}d?C.text.dynamicLayoutVertexBuffer.updateData(Kt):C.icon.dynamicLayoutVertexBuffer.updateData(Kt)}function ye(C,s,d,v,S,D,k,j){const H=D.glyphStartIndex+D.numGlyphs,J=D.lineStartIndex,et=D.lineStartIndex+D.lineLength,mt=s.getoffsetX(D.glyphStartIndex),dt=s.getoffsetX(H-1),Tt=Qi(C*mt,d,v,S,D.segment,J,et,j,k);if(!Tt)return null;const pt=Qi(C*dt,d,v,S,D.segment,J,et,j,k);return pt?j.projectionCache.anyProjectionOccluded?null:{first:Tt,last:pt}:null}function Yt(C,s,d,v){return C===i.ay.horizontal&&Math.abs(d.y-s.y)>Math.abs(d.x-s.x)*v?{useVertical:!0}:(C===i.ay.vertical?s.y<d.y:s.x>d.x)?{needsFlipping:!0}:null}function xe(C){const{projectionContext:s,pitchedLabelPlaneMatrixInverse:d,symbol:v,fontSize:S,flip:D,keepUpright:k,glyphOffsetArray:j,dynamicLayoutVertexArray:H,aspectRatio:J,rotateToLine:et}=C,mt=S/24,dt=v.lineOffsetX*mt,Tt=v.lineOffsetY*mt;let pt;if(v.numGlyphs>1){const It=v.glyphStartIndex+v.numGlyphs,Kt=v.lineStartIndex,Wt=v.lineStartIndex+v.lineLength,ft=ye(mt,j,dt,Tt,D,v,et,s);if(!ft)return{notEnoughRoom:!0};const _e=er(ft.first.point.x,ft.first.point.y,s,d),he=er(ft.last.point.x,ft.last.point.y,s,d);if(k&&!D){const me=Yt(v.writingMode,_e,he,J);if(me)return me}pt=[ft.first];for(let me=v.glyphStartIndex+1;me<It-1;me++){const be=Qi(mt*j.getoffsetX(me),dt,Tt,D,v.segment,Kt,Wt,s,et);if(!be)return{notEnoughRoom:!0};pt.push(be)}pt.push(ft.last)}else{if(k&&!D){const Kt=Di(s.tileAnchorPoint.x,s.tileAnchorPoint.y,s).point,Wt=v.lineStartIndex+v.segment+1,ft=new i.P(s.lineVertexArray.getx(Wt),s.lineVertexArray.gety(Wt)),_e=Di(ft.x,ft.y,s),he=_e.signedDistanceFromCamera>0?_e.point:ti(s.tileAnchorPoint,ft,Kt,1,s),me=er(Kt.x,Kt.y,s,d),be=er(he.x,he.y,s,d),de=Yt(v.writingMode,me,be,J);if(de)return de}const It=Qi(mt*j.getoffsetX(v.glyphStartIndex),dt,Tt,D,v.segment,v.lineStartIndex,v.lineStartIndex+v.lineLength,s,et);if(!It||s.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};pt=[It]}for(const It of pt)i.aF(H,It.point,It.angle);return{}}function ti(C,s,d,v,S){const D=C.add(C.sub(s)._unit()),k=Di(D.x,D.y,S).point,j=d.sub(k);return d.add(j._mult(v/j.mag()))}function $e(C,s,d){const v=s.projectionCache;if(v.projections[C])return v.projections[C];const S=new i.P(s.lineVertexArray.getx(C),s.lineVertexArray.gety(C)),D=Di(S.x,S.y,s);if(D.signedDistanceFromCamera>0)return v.projections[C]=D.point,v.anyProjectionOccluded=v.anyProjectionOccluded||D.isOccluded,D.point;const k=C-d.direction;return ti(d.distanceFromAnchor===0?s.tileAnchorPoint:new i.P(s.lineVertexArray.getx(k),s.lineVertexArray.gety(k)),S,d.previousVertex,d.absOffsetX-d.distanceFromAnchor+1,s)}function Di(C,s,d){const v=C+d.translation[0],S=s+d.translation[1];let D;return d.pitchWithMap?(D=wt(v,S,d.pitchedLabelPlaneMatrix,d.getElevation),D.isOccluded=!1):(D=d.transform.projectTileCoordinates(v,S,d.unwrappedTileID,d.getElevation),D.point.x=(.5*D.point.x+.5)*d.width,D.point.y=(.5*-D.point.y+.5)*d.height),D}function er(C,s,d,v){if(d.pitchWithMap){const S=[C,s,0,1];return i.aG(S,S,v),d.transform.projectTileCoordinates(S[0]/S[3],S[1]/S[3],d.unwrappedTileID,d.getElevation).point}return{x:C/d.width*2-1,y:1-s/d.height*2}}function Ki(C,s,d){return d.transform.projectTileCoordinates(C,s,d.unwrappedTileID,d.getElevation)}function Hi(C,s,d){return C._unit()._perp()._mult(s*d)}function gr(C,s,d,v,S,D,k,j,H){if(j.projectionCache.offsets[C])return j.projectionCache.offsets[C];const J=d.add(s);if(C+H.direction<v||C+H.direction>=S)return j.projectionCache.offsets[C]=J,J;const et=$e(C+H.direction,j,H),mt=Hi(et.sub(d),k,H.direction),dt=d.add(mt),Tt=et.add(mt);return j.projectionCache.offsets[C]=i.aH(D,J,dt,Tt)||J,j.projectionCache.offsets[C]}function Qi(C,s,d,v,S,D,k,j,H){const J=v?C-s:C+s;let et=J>0?1:-1,mt=0;v&&(et*=-1,mt=Math.PI),et<0&&(mt+=Math.PI);let dt,Tt=et>0?D+S:D+S+1;j.projectionCache.cachedAnchorPoint?dt=j.projectionCache.cachedAnchorPoint:(dt=Di(j.tileAnchorPoint.x,j.tileAnchorPoint.y,j).point,j.projectionCache.cachedAnchorPoint=dt);let pt,It,Kt=dt,Wt=dt,ft=0,_e=0;const he=Math.abs(J),me=[];let be;for(;ft+_e<=he;){if(Tt+=et,Tt<D||Tt>=k)return null;ft+=_e,Wt=Kt,It=pt;const Qe={absOffsetX:he,direction:et,distanceFromAnchor:ft,previousVertex:Wt};if(Kt=$e(Tt,j,Qe),d===0)me.push(Wt),be=Kt.sub(Wt);else{let Xe;const Je=Kt.sub(Wt);Xe=Je.mag()===0?Hi($e(Tt+et,j,Qe).sub(Kt),d,et):Hi(Je,d,et),It||(It=Wt.add(Xe)),pt=gr(Tt,Xe,Kt,D,k,It,d,j,Qe),me.push(It),be=pt.sub(It)}_e=be.mag()}const de=be._mult((he-ft)/_e)._add(It||Wt),Ce=mt+Math.atan2(Kt.y-Wt.y,Kt.x-Wt.x);return me.push(de),{point:de,angle:H?Ce:0,path:me}}const Cn=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Nn(C,s){for(let d=0;d<C;d++){const v=s.length;s.resize(v+4),s.float32.set(Cn,3*v)}}function Vo(C,s,d){const v=s[0],S=s[1];return C[0]=d[0]*v+d[4]*S+d[12],C[1]=d[1]*v+d[5]*S+d[13],C[3]=d[3]*v+d[7]*S+d[15],C}const Qr=100;class ao{constructor(s,d=new zo(s.width+200,s.height+200,25),v=new zo(s.width+200,s.height+200,25)){this.transform=s,this.grid=d,this.ignoredGrid=v,this.pitchFactor=Math.cos(s.pitch*Math.PI/180)*s.cameraToCenterDistance,this.screenRightBoundary=s.width+Qr,this.screenBottomBoundary=s.height+Qr,this.gridRightBoundary=s.width+200,this.gridBottomBoundary=s.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(s,d,v,S,D,k,j,H,J,et,mt,dt){const Tt=this.projectAndGetPerspectiveRatio(s.anchorPointX+H[0],s.anchorPointY+H[1],D,et,dt),pt=v*Tt.perspectiveRatio;let It;if(k||j)It=this._projectCollisionBox(s,pt,S,D,k,j,H,Tt,et,mt,dt);else{const be=Tt.x+(mt?mt.x*pt:0),de=Tt.y+(mt?mt.y*pt:0);It={allPointsOccluded:!1,box:[be+s.x1*pt,de+s.y1*pt,be+s.x2*pt,de+s.y2*pt]}}const[Kt,Wt,ft,_e]=It.box,he=k?It.allPointsOccluded:Tt.isOccluded;let me=he;return me||(me=Tt.perspectiveRatio<this.perspectiveRatioCutoff),me||(me=!this.isInsideGrid(Kt,Wt,ft,_e)),me||d!=="always"&&this.grid.hitTest(Kt,Wt,ft,_e,d,J)?{box:[Kt,Wt,ft,_e],placeable:!1,offscreen:!1,occluded:he}:{box:[Kt,Wt,ft,_e],placeable:!0,offscreen:this.isOffscreen(Kt,Wt,ft,_e),occluded:he}}placeCollisionCircles(s,d,v,S,D,k,j,H,J,et,mt,dt,Tt,pt){const It=[],Kt=new i.P(d.anchorX,d.anchorY),Wt=this.getPerspectiveRatio(Kt.x,Kt.y,k,pt),ft=(J?D*this.transform.getPitchedTextCorrection(d.anchorX,d.anchorY,k)/Wt:D*Wt)/i.aL,_e={getElevation:pt,pitchedLabelPlaneMatrix:j,lineVertexArray:v,pitchWithMap:J,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:Kt,unwrappedTileID:k,width:this.transform.width,height:this.transform.height,translation:Tt},he=ye(ft,S,d.lineOffsetX*ft,d.lineOffsetY*ft,!1,d,!1,_e);let me=!1,be=!1,de=!0;if(he){const Ce=.5*mt*Wt+dt,Qe=new i.P(-100,-100),Xe=new i.P(this.screenRightBoundary,this.screenBottomBoundary),Je=new bi,ii=he.first,Ri=he.last;let Oi=[];for(let tn=ii.path.length-1;tn>=1;tn--)Oi.push(ii.path[tn]);for(let tn=1;tn<Ri.path.length;tn++)Oi.push(Ri.path[tn]);const Ti=2.5*Ce;if(J){const tn=this.projectPathToScreenSpace(Oi,_e);Oi=tn.some(Zr=>Zr.signedDistanceFromCamera<=0)?[]:tn.map(Zr=>Zr.point)}let br=[];if(Oi.length>0){const tn=Oi[0].clone(),Zr=Oi[0].clone();for(let vo=1;vo<Oi.length;vo++)tn.x=Math.min(tn.x,Oi[vo].x),tn.y=Math.min(tn.y,Oi[vo].y),Zr.x=Math.max(Zr.x,Oi[vo].x),Zr.y=Math.max(Zr.y,Oi[vo].y);br=tn.x>=Qe.x&&Zr.x<=Xe.x&&tn.y>=Qe.y&&Zr.y<=Xe.y?[Oi]:Zr.x<Qe.x||tn.x>Xe.x||Zr.y<Qe.y||tn.y>Xe.y?[]:i.aI([Oi],Qe.x,Qe.y,Xe.x,Xe.y)}for(const tn of br){Je.reset(tn,.25*Ce);let Zr=0;Zr=Je.length<=.5*Ce?1:Math.ceil(Je.paddedLength/Ti)+1;for(let vo=0;vo<Zr;vo++){const Wo=vo/Math.max(Zr-1,1),os=Je.lerp(Wo),Xo=os.x+Qr,zs=os.y+Qr;It.push(Xo,zs,Ce,0);const ss=Xo-Ce,io=zs-Ce,Es=Xo+Ce,as=zs+Ce;if(de=de&&this.isOffscreen(ss,io,Es,as),be=be||this.isInsideGrid(ss,io,Es,as),s!=="always"&&this.grid.hitTestCircle(Xo,zs,Ce,s,et)&&(me=!0,!H))return{circles:[],offscreen:!1,collisionDetected:me}}}}return{circles:!H&&me||!be||Wt<this.perspectiveRatioCutoff?[]:It,offscreen:de,collisionDetected:me}}projectPathToScreenSpace(s,d){const v=function(S,D){const k=i.N();return i.aA(k,D.pitchedLabelPlaneMatrix),S.map(j=>{const H=wt(j.x,j.y,k,D.getElevation),J=D.transform.projectTileCoordinates(H.point.x,H.point.y,D.unwrappedTileID,D.getElevation);return J.point.x=(.5*J.point.x+.5)*D.width,J.point.y=(.5*-J.point.y+.5)*D.height,J})}(s,d);return function(S){let D=0,k=0,j=0,H=0;for(let J=0;J<S.length;J++)S[J].isOccluded?(j=J+1,H=0):(H++,H>k&&(k=H,D=j));return S.slice(D,D+k)}(v)}queryRenderedSymbols(s){if(s.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const d=[],v=new i.ab;for(const mt of s){const dt=new i.P(mt.x+Qr,mt.y+Qr);v.extend(dt),d.push(dt)}const{minX:S,minY:D,maxX:k,maxY:j}=v,H=this.grid.query(S,D,k,j).concat(this.ignoredGrid.query(S,D,k,j)),J={},et={};for(const mt of H){const dt=mt.key;if(J[dt.bucketInstanceId]===void 0&&(J[dt.bucketInstanceId]={}),J[dt.bucketInstanceId][dt.featureIndex])continue;const Tt=[new i.P(mt.x1,mt.y1),new i.P(mt.x2,mt.y1),new i.P(mt.x2,mt.y2),new i.P(mt.x1,mt.y2)];i.aJ(d,Tt)&&(J[dt.bucketInstanceId][dt.featureIndex]=!0,et[dt.bucketInstanceId]===void 0&&(et[dt.bucketInstanceId]=[]),et[dt.bucketInstanceId].push(dt.featureIndex))}return et}insertCollisionBox(s,d,v,S,D,k){(v?this.ignoredGrid:this.grid).insert({bucketInstanceId:S,featureIndex:D,collisionGroupID:k,overlapMode:d},s[0],s[1],s[2],s[3])}insertCollisionCircles(s,d,v,S,D,k){const j=v?this.ignoredGrid:this.grid,H={bucketInstanceId:S,featureIndex:D,collisionGroupID:k,overlapMode:d};for(let J=0;J<s.length;J+=4)j.insertCircle(H,s[J],s[J+1],s[J+2])}projectAndGetPerspectiveRatio(s,d,v,S,D){if(D){let k;S?(k=[s,d,S(s,d),1],i.aG(k,k,D)):(k=[s,d,0,1],Vo(k,k,D));const j=k[3];return{x:(k[0]/j+1)/2*this.transform.width+Qr,y:(-k[1]/j+1)/2*this.transform.height+Qr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/j*.5,isOccluded:!1,signedDistanceFromCamera:j}}{const k=this.transform.projectTileCoordinates(s,d,v,S);return{x:(k.point.x+1)/2*this.transform.width+Qr,y:(1-k.point.y)/2*this.transform.height+Qr,perspectiveRatio:.5+this.transform.cameraToCenterDistance/k.signedDistanceFromCamera*.5,isOccluded:k.isOccluded,signedDistanceFromCamera:k.signedDistanceFromCamera}}}getPerspectiveRatio(s,d,v,S){const D=this.transform.projectTileCoordinates(s,d,v,S);return .5+this.transform.cameraToCenterDistance/D.signedDistanceFromCamera*.5}isOffscreen(s,d,v,S){return v<Qr||s>=this.screenRightBoundary||S<Qr||d>this.screenBottomBoundary}isInsideGrid(s,d,v,S){return v>=0&&s<this.gridRightBoundary&&S>=0&&d<this.gridBottomBoundary}getViewportMatrix(){const s=i.ar([]);return i.O(s,s,[-100,-100,0]),s}_projectCollisionBox(s,d,v,S,D,k,j,H,J,et,mt){let dt=1,Tt=0,pt=0,It=1;const Kt=s.anchorPointX+j[0],Wt=s.anchorPointY+j[1];if(k&&!D){const Oi=this.projectAndGetPerspectiveRatio(Kt+1,Wt,S,J,mt),Ti=Oi.x-H.x,br=Math.atan((Oi.y-H.y)/Ti)+(Ti<0?Math.PI:0),tn=Math.sin(br),Zr=Math.cos(br);dt=Zr,Tt=tn,pt=-tn,It=Zr}else if(!k&&D){const Oi=tt(this.transform);dt=Oi.vecEast[0],Tt=Oi.vecEast[1],pt=Oi.vecSouth[0],It=Oi.vecSouth[1]}let ft=H.x,_e=H.y,he=d;D&&(ft=Kt,_e=Wt,he=Math.pow(2,-(this.transform.zoom-v.overscaledZ)),he*=this.transform.getPitchedTextCorrection(Kt,Wt,S),et||(he*=i.an(.5+H.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),et&&(ft+=dt*et.x*he+pt*et.y*he,_e+=Tt*et.x*he+It*et.y*he);const me=s.x1*he,be=s.x2*he,de=(me+be)/2,Ce=s.y1*he,Qe=s.y2*he,Xe=(Ce+Qe)/2,Je=[{offsetX:me,offsetY:Ce},{offsetX:de,offsetY:Ce},{offsetX:be,offsetY:Ce},{offsetX:be,offsetY:Xe},{offsetX:be,offsetY:Qe},{offsetX:de,offsetY:Qe},{offsetX:me,offsetY:Qe},{offsetX:me,offsetY:Xe}];let ii=[];for(const{offsetX:Oi,offsetY:Ti}of Je)ii.push(new i.P(ft+dt*Oi+pt*Ti,_e+Tt*Oi+It*Ti));let Ri=!1;if(D){const Oi=ii.map(Ti=>this.projectAndGetPerspectiveRatio(Ti.x,Ti.y,S,J,mt));Ri=Oi.some(Ti=>!Ti.isOccluded),ii=Oi.map(Ti=>new i.P(Ti.x,Ti.y))}else Ri=!0;return{box:i.aK(ii),allPointsOccluded:!Ri}}}class gn{constructor(s,d,v,S){this.opacity=s?Math.max(0,Math.min(1,s.opacity+(s.placed?d:-d))):S&&v?1:0,this.placed=v}isHidden(){return this.opacity===0&&!this.placed}}class Ur{constructor(s,d,v,S,D){this.text=new gn(s?s.text:null,d,v,D),this.icon=new gn(s?s.icon:null,d,S,D)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Wn{constructor(s,d,v){this.text=s,this.icon=d,this.skipFade=v}}class to{constructor(s,d,v,S,D){this.bucketInstanceId=s,this.featureIndex=d,this.sourceLayerIndex=v,this.bucketIndex=S,this.tileID=D}}class Dn{constructor(s){this.crossSourceCollisions=s,this.maxGroupID=0,this.collisionGroups={}}get(s){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[s]){const d=++this.maxGroupID;this.collisionGroups[s]={ID:d,predicate:v=>v.collisionGroupID===d}}return this.collisionGroups[s]}}function eo(C,s,d,v,S){const{horizontalAlign:D,verticalAlign:k}=i.aR(C);return new i.P(-(D-.5)*s+v[0]*S,-(k-.5)*d+v[1]*S)}class ps{constructor(s,d,v,S,D){this.transform=s.clone(),this.terrain=d,this.collisionIndex=new ao(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=v,this.retainedQueryData={},this.collisionGroups=new Dn(S),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=D,D&&(D.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(s){const d=this.terrain;return d?(v,S)=>d.getElevation(s,v,S):null}getBucketParts(s,d,v,S){const D=v.getBucket(d),k=v.latestFeatureIndex;if(!D||!k||d.id!==D.layerIds[0])return;const j=v.collisionBoxArray,H=D.layers[0].layout,J=D.layers[0].paint,et=Math.pow(2,this.transform.zoom-v.tileID.overscaledZ),mt=v.tileSize/i.a4,dt=v.tileID.toUnwrapped(),Tt=H.get("text-rotation-alignment")==="map",pt=i.aM(v,1,this.transform.zoom),It=i.aN(this.collisionIndex.transform,v,J.get("text-translate"),J.get("text-translate-anchor")),Kt=i.aN(this.collisionIndex.transform,v,J.get("icon-translate"),J.get("icon-translate-anchor")),Wt=se(Tt,this.transform,pt);this.retainedQueryData[D.bucketInstanceId]=new to(D.bucketInstanceId,k,D.sourceLayerIndex,D.index,v.tileID);const ft={bucket:D,layout:H,translationText:It,translationIcon:Kt,unwrappedTileID:dt,pitchedLabelPlaneMatrix:Wt,scale:et,textPixelRatio:mt,holdingForFade:v.holdingForSymbolFade(),collisionBoxArray:j,partiallyEvaluatedTextSize:i.ax(D.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(D.sourceID)};if(S)for(const _e of D.sortKeyRanges){const{sortKey:he,symbolInstanceStart:me,symbolInstanceEnd:be}=_e;s.push({sortKey:he,symbolInstanceStart:me,symbolInstanceEnd:be,parameters:ft})}else s.push({symbolInstanceStart:0,symbolInstanceEnd:D.symbolInstances.length,parameters:ft})}attemptAnchorPlacement(s,d,v,S,D,k,j,H,J,et,mt,dt,Tt,pt,It,Kt,Wt,ft,_e,he){const me=i.aO[s.textAnchor],be=[s.textOffset0,s.textOffset1],de=eo(me,v,S,be,D),Ce=this.collisionIndex.placeCollisionBox(d,dt,H,J,et,j,k,Kt,mt.predicate,_e,de,he);if((!ft||this.collisionIndex.placeCollisionBox(ft,dt,H,J,et,j,k,Wt,mt.predicate,_e,de,he).placeable)&&Ce.placeable){let Qe;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Tt.crossTileID]&&this.prevPlacement.placements[Tt.crossTileID]&&this.prevPlacement.placements[Tt.crossTileID].text&&(Qe=this.prevPlacement.variableOffsets[Tt.crossTileID].anchor),Tt.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[Tt.crossTileID]={textOffset:be,width:v,height:S,anchor:me,textBoxScale:D,prevAnchor:Qe},this.markUsedJustification(pt,me,Tt,It),pt.allowVerticalPlacement&&(this.markUsedOrientation(pt,It,Tt),this.placedOrientations[Tt.crossTileID]=It),{shift:de,placedGlyphBoxes:Ce}}}placeLayerBucketPart(s,d,v){const{bucket:S,layout:D,translationText:k,translationIcon:j,unwrappedTileID:H,pitchedLabelPlaneMatrix:J,textPixelRatio:et,holdingForFade:mt,collisionBoxArray:dt,partiallyEvaluatedTextSize:Tt,collisionGroup:pt}=s.parameters,It=D.get("text-optional"),Kt=D.get("icon-optional"),Wt=i.aP(D,"text-overlap","text-allow-overlap"),ft=Wt==="always",_e=i.aP(D,"icon-overlap","icon-allow-overlap"),he=_e==="always",me=D.get("text-rotation-alignment")==="map",be=D.get("text-pitch-alignment")==="map",de=D.get("icon-text-fit")!=="none",Ce=D.get("symbol-z-order")==="viewport-y",Qe=ft&&(he||!S.hasIconData()||Kt),Xe=he&&(ft||!S.hasTextData()||It);!S.collisionArrays&&dt&&S.deserializeCollisionBoxes(dt);const Je=this.retainedQueryData[S.bucketInstanceId].tileID,ii=this._getTerrainElevationFunc(Je),Ri=this.transform.getFastPathSimpleProjectionMatrix(Je),Oi=(Ti,br,tn)=>{var Zr,vo;if(d[Ti.crossTileID])return;if(mt)return void(this.placements[Ti.crossTileID]=new Wn(!1,!1,!1));let Wo=!1,os=!1,Xo=!0,zs=null,ss={box:null,placeable:!1,offscreen:null,occluded:!1},io={placeable:!1},Es=null,as=null,sn=null,Er=0,Ql=0,As=0;br.textFeatureIndex?Er=br.textFeatureIndex:Ti.useRuntimeCollisionCircles&&(Er=Ti.featureIndex),br.verticalTextFeatureIndex&&(Ql=br.verticalTextFeatureIndex);const wl=br.textBox;if(wl){const rl=Bo=>{let Oo=i.ay.horizontal;if(S.allowVerticalPlacement&&!Bo&&this.prevPlacement){const ys=this.prevPlacement.placedOrientations[Ti.crossTileID];ys&&(this.placedOrientations[Ti.crossTileID]=ys,Oo=ys,this.markUsedOrientation(S,Oo,Ti))}return Oo},ec=(Bo,Oo)=>{if(S.allowVerticalPlacement&&Ti.numVerticalGlyphVertices>0&&br.verticalTextBox){for(const ys of S.writingModes)if(ys===i.ay.vertical?(ss=Oo(),io=ss):ss=Bo(),ss&&ss.placeable)break}else ss=Bo()},qc=Ti.textAnchorOffsetStartIndex,ta=Ti.textAnchorOffsetEndIndex;if(ta===qc){const Bo=(Oo,ys)=>{const Lo=this.collisionIndex.placeCollisionBox(Oo,Wt,et,Je,H,be,me,k,pt.predicate,ii,void 0,Ri);return Lo&&Lo.placeable&&(this.markUsedOrientation(S,ys,Ti),this.placedOrientations[Ti.crossTileID]=ys),Lo};ec(()=>Bo(wl,i.ay.horizontal),()=>{const Oo=br.verticalTextBox;return S.allowVerticalPlacement&&Ti.numVerticalGlyphVertices>0&&Oo?Bo(Oo,i.ay.vertical):{box:null,offscreen:null}}),rl(ss&&ss.placeable)}else{let Bo=i.aO[(vo=(Zr=this.prevPlacement)===null||Zr===void 0?void 0:Zr.variableOffsets[Ti.crossTileID])===null||vo===void 0?void 0:vo.anchor];const Oo=(Lo,Ol,uh)=>{const Dp=Lo.x2-Lo.x1,Nl=Lo.y2-Lo.y1,dh=Ti.textBoxScale,zp=de&&_e==="never"?Ol:null;let Vl=null,ph=Wt==="never"?1:2,ro="never";Bo&&ph++;for(let Ul=0;Ul<ph;Ul++){for(let yc=qc;yc<ta;yc++){const Hd=S.textAnchorOffsets.get(yc);if(Bo&&Hd.textAnchor!==Bo)continue;const fh=this.attemptAnchorPlacement(Hd,Lo,Dp,Nl,dh,me,be,et,Je,H,pt,ro,Ti,S,uh,k,j,zp,ii);if(fh&&(Vl=fh.placedGlyphBoxes,Vl&&Vl.placeable))return Wo=!0,zs=fh.shift,Vl}Bo?Bo=null:ro=Wt}return v&&!Vl&&(Vl={box:this.collisionIndex.placeCollisionBox(wl,"always",et,Je,H,be,me,k,pt.predicate,ii,void 0,Ri).box,offscreen:!1,placeable:!1,occluded:!1}),Vl};ec(()=>Oo(wl,br.iconBox,i.ay.horizontal),()=>{const Lo=br.verticalTextBox;return S.allowVerticalPlacement&&(!ss||!ss.placeable)&&Ti.numVerticalGlyphVertices>0&&Lo?Oo(Lo,br.verticalIconBox,i.ay.vertical):{box:null,occluded:!0,offscreen:null}}),ss&&(Wo=ss.placeable,Xo=ss.offscreen);const ys=rl(ss&&ss.placeable);if(!Wo&&this.prevPlacement){const Lo=this.prevPlacement.variableOffsets[Ti.crossTileID];Lo&&(this.variableOffsets[Ti.crossTileID]=Lo,this.markUsedJustification(S,Lo.anchor,Ti,ys))}}}if(Es=ss,Wo=Es&&Es.placeable,Xo=Es&&Es.offscreen,Ti.useRuntimeCollisionCircles&&Ti.centerJustifiedTextSymbolIndex>=0){const rl=S.text.placedSymbolArray.get(Ti.centerJustifiedTextSymbolIndex),ec=i.az(S.textSizeData,Tt,rl),qc=D.get("text-padding");as=this.collisionIndex.placeCollisionCircles(Wt,rl,S.lineVertexArray,S.glyphOffsetArray,ec,H,J,v,be,pt.predicate,Ti.collisionCircleDiameter,qc,k,ii),as.circles.length&&as.collisionDetected&&!v&&i.w("Collisions detected, but collision boxes are not shown"),Wo=ft||as.circles.length>0&&!as.collisionDetected,Xo=Xo&&as.offscreen}if(br.iconFeatureIndex&&(As=br.iconFeatureIndex),br.iconBox){const rl=ec=>this.collisionIndex.placeCollisionBox(ec,_e,et,Je,H,be,me,j,pt.predicate,ii,de&&zs?zs:void 0,Ri);io&&io.placeable&&br.verticalIconBox?(sn=rl(br.verticalIconBox),os=sn.placeable):(sn=rl(br.iconBox),os=sn.placeable),Xo=Xo&&sn.offscreen}const tc=It||Ti.numHorizontalGlyphVertices===0&&Ti.numVerticalGlyphVertices===0,$s=Kt||Ti.numIconVertices===0;tc||$s?$s?tc||(os=os&&Wo):Wo=os&&Wo:os=Wo=os&&Wo;const _c=os&&sn.placeable;if(Wo&&Es.placeable&&this.collisionIndex.insertCollisionBox(Es.box,Wt,D.get("text-ignore-placement"),S.bucketInstanceId,io&&io.placeable&&Ql?Ql:Er,pt.ID),_c&&this.collisionIndex.insertCollisionBox(sn.box,_e,D.get("icon-ignore-placement"),S.bucketInstanceId,As,pt.ID),as&&Wo&&this.collisionIndex.insertCollisionCircles(as.circles,Wt,D.get("text-ignore-placement"),S.bucketInstanceId,Er,pt.ID),v&&this.storeCollisionData(S.bucketInstanceId,tn,br,Es,sn,as),Ti.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(S.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Ti.crossTileID]=new Wn((Wo||Qe)&&!(Es!=null&&Es.occluded),(os||Xe)&&!(sn!=null&&sn.occluded),Xo||S.justReloaded),d[Ti.crossTileID]=!0};if(Ce){if(s.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const Ti=S.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let br=Ti.length-1;br>=0;--br){const tn=Ti[br];Oi(S.symbolInstances.get(tn),S.collisionArrays[tn],tn)}}else for(let Ti=s.symbolInstanceStart;Ti<s.symbolInstanceEnd;Ti++)Oi(S.symbolInstances.get(Ti),S.collisionArrays[Ti],Ti);S.justReloaded=!1}storeCollisionData(s,d,v,S,D,k){if(v.textBox||v.iconBox){let j,H;this.collisionBoxArrays.has(s)?j=this.collisionBoxArrays.get(s):(j=new Map,this.collisionBoxArrays.set(s,j)),j.has(d)?H=j.get(d):(H={text:null,icon:null},j.set(d,H)),v.textBox&&(H.text=S.box),v.iconBox&&(H.icon=D.box)}if(k){let j=this.collisionCircleArrays[s];j===void 0&&(j=this.collisionCircleArrays[s]=[]);for(let H=0;H<k.circles.length;H+=4)j.push(k.circles[H+0]-Qr),j.push(k.circles[H+1]-Qr),j.push(k.circles[H+2]),j.push(k.collisionDetected?1:0)}}markUsedJustification(s,d,v,S){let D;D=S===i.ay.vertical?v.verticalPlacedTextSymbolIndex:{left:v.leftJustifiedTextSymbolIndex,center:v.centerJustifiedTextSymbolIndex,right:v.rightJustifiedTextSymbolIndex}[i.aQ(d)];const k=[v.leftJustifiedTextSymbolIndex,v.centerJustifiedTextSymbolIndex,v.rightJustifiedTextSymbolIndex,v.verticalPlacedTextSymbolIndex];for(const j of k)j>=0&&(s.text.placedSymbolArray.get(j).crossTileID=D>=0&&j!==D?0:v.crossTileID)}markUsedOrientation(s,d,v){const S=d===i.ay.horizontal||d===i.ay.horizontalOnly?d:0,D=d===i.ay.vertical?d:0,k=[v.leftJustifiedTextSymbolIndex,v.centerJustifiedTextSymbolIndex,v.rightJustifiedTextSymbolIndex];for(const j of k)s.text.placedSymbolArray.get(j).placedOrientation=S;v.verticalPlacedTextSymbolIndex&&(s.text.placedSymbolArray.get(v.verticalPlacedTextSymbolIndex).placedOrientation=D)}commit(s){this.commitTime=s,this.zoomAtLastRecencyCheck=this.transform.zoom;const d=this.prevPlacement;let v=!1;this.prevZoomAdjustment=d?d.zoomAdjustment(this.transform.zoom):0;const S=d?d.symbolFadeChange(s):1,D=d?d.opacities:{},k=d?d.variableOffsets:{},j=d?d.placedOrientations:{};for(const H in this.placements){const J=this.placements[H],et=D[H];et?(this.opacities[H]=new Ur(et,S,J.text,J.icon),v=v||J.text!==et.text.placed||J.icon!==et.icon.placed):(this.opacities[H]=new Ur(null,S,J.text,J.icon,J.skipFade),v=v||J.text||J.icon)}for(const H in D){const J=D[H];if(!this.opacities[H]){const et=new Ur(J,S,!1,!1);et.isHidden()||(this.opacities[H]=et,v=v||J.text.placed||J.icon.placed)}}for(const H in k)this.variableOffsets[H]||!this.opacities[H]||this.opacities[H].isHidden()||(this.variableOffsets[H]=k[H]);for(const H in j)this.placedOrientations[H]||!this.opacities[H]||this.opacities[H].isHidden()||(this.placedOrientations[H]=j[H]);if(d&&d.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");v?this.lastPlacementChangeTime=s:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=d?d.lastPlacementChangeTime:s)}updateLayerOpacities(s,d){const v={};for(const S of d){const D=S.getBucket(s);D&&S.latestFeatureIndex&&s.id===D.layerIds[0]&&this.updateBucketOpacities(D,S.tileID,v,S.collisionBoxArray)}}updateBucketOpacities(s,d,v,S){s.hasTextData()&&(s.text.opacityVertexArray.clear(),s.text.hasVisibleVertices=!1),s.hasIconData()&&(s.icon.opacityVertexArray.clear(),s.icon.hasVisibleVertices=!1),s.hasIconCollisionBoxData()&&s.iconCollisionBox.collisionVertexArray.clear(),s.hasTextCollisionBoxData()&&s.textCollisionBox.collisionVertexArray.clear();const D=s.layers[0],k=D.layout,j=new Ur(null,0,!1,!1,!0),H=k.get("text-allow-overlap"),J=k.get("icon-allow-overlap"),et=D._unevaluatedLayout.hasValue("text-variable-anchor")||D._unevaluatedLayout.hasValue("text-variable-anchor-offset"),mt=k.get("text-rotation-alignment")==="map",dt=k.get("text-pitch-alignment")==="map",Tt=k.get("icon-text-fit")!=="none",pt=new Ur(null,0,H&&(J||!s.hasIconData()||k.get("icon-optional")),J&&(H||!s.hasTextData()||k.get("text-optional")),!0);!s.collisionArrays&&S&&(s.hasIconCollisionBoxData()||s.hasTextCollisionBoxData())&&s.deserializeCollisionBoxes(S);const It=(Wt,ft,_e)=>{for(let he=0;he<ft/4;he++)Wt.opacityVertexArray.emplaceBack(_e);Wt.hasVisibleVertices=Wt.hasVisibleVertices||_e!==Hl},Kt=this.collisionBoxArrays.get(s.bucketInstanceId);for(let Wt=0;Wt<s.symbolInstances.length;Wt++){const ft=s.symbolInstances.get(Wt),{numHorizontalGlyphVertices:_e,numVerticalGlyphVertices:he,crossTileID:me}=ft;let be=this.opacities[me];v[me]?be=j:be||(be=pt,this.opacities[me]=be),v[me]=!0;const de=ft.numIconVertices>0,Ce=this.placedOrientations[ft.crossTileID],Qe=Ce===i.ay.vertical,Xe=Ce===i.ay.horizontal||Ce===i.ay.horizontalOnly;if(_e>0||he>0){const ii=Qa(be.text);It(s.text,_e,Qe?Hl:ii),It(s.text,he,Xe?Hl:ii);const Ri=be.text.isHidden();[ft.rightJustifiedTextSymbolIndex,ft.centerJustifiedTextSymbolIndex,ft.leftJustifiedTextSymbolIndex].forEach(br=>{br>=0&&(s.text.placedSymbolArray.get(br).hidden=Ri||Qe?1:0)}),ft.verticalPlacedTextSymbolIndex>=0&&(s.text.placedSymbolArray.get(ft.verticalPlacedTextSymbolIndex).hidden=Ri||Xe?1:0);const Oi=this.variableOffsets[ft.crossTileID];Oi&&this.markUsedJustification(s,Oi.anchor,ft,Ce);const Ti=this.placedOrientations[ft.crossTileID];Ti&&(this.markUsedJustification(s,"left",ft,Ti),this.markUsedOrientation(s,Ti,ft))}if(de){const ii=Qa(be.icon),Ri=!(Tt&&ft.verticalPlacedIconSymbolIndex&&Qe);ft.placedIconSymbolIndex>=0&&(It(s.icon,ft.numIconVertices,Ri?ii:Hl),s.icon.placedSymbolArray.get(ft.placedIconSymbolIndex).hidden=be.icon.isHidden()),ft.verticalPlacedIconSymbolIndex>=0&&(It(s.icon,ft.numVerticalIconVertices,Ri?Hl:ii),s.icon.placedSymbolArray.get(ft.verticalPlacedIconSymbolIndex).hidden=be.icon.isHidden())}const Je=Kt&&Kt.has(Wt)?Kt.get(Wt):{text:null,icon:null};if(s.hasIconCollisionBoxData()||s.hasTextCollisionBoxData()){const ii=s.collisionArrays[Wt];if(ii){let Ri=new i.P(0,0);if(ii.textBox||ii.verticalTextBox){let Oi=!0;if(et){const Ti=this.variableOffsets[me];Ti?(Ri=eo(Ti.anchor,Ti.width,Ti.height,Ti.textOffset,Ti.textBoxScale),mt&&Ri._rotate(dt?-this.transform.bearingInRadians:this.transform.bearingInRadians)):Oi=!1}if(ii.textBox||ii.verticalTextBox){let Ti;ii.textBox&&(Ti=Qe),ii.verticalTextBox&&(Ti=Xe),na(s.textCollisionBox.collisionVertexArray,be.text.placed,!Oi||Ti,Je.text,Ri.x,Ri.y)}}if(ii.iconBox||ii.verticalIconBox){const Oi=!!(!Xe&&ii.verticalIconBox);let Ti;ii.iconBox&&(Ti=Oi),ii.verticalIconBox&&(Ti=!Oi),na(s.iconCollisionBox.collisionVertexArray,be.icon.placed,Ti,Je.icon,Tt?Ri.x:0,Tt?Ri.y:0)}}}}if(s.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[s.bucketInstanceId]&&(this.retainedQueryData[s.bucketInstanceId].featureSortOrder=s.featureSortOrder),s.hasTextData()&&s.text.opacityVertexBuffer&&s.text.opacityVertexBuffer.updateData(s.text.opacityVertexArray),s.hasIconData()&&s.icon.opacityVertexBuffer&&s.icon.opacityVertexBuffer.updateData(s.icon.opacityVertexArray),s.hasIconCollisionBoxData()&&s.iconCollisionBox.collisionVertexBuffer&&s.iconCollisionBox.collisionVertexBuffer.updateData(s.iconCollisionBox.collisionVertexArray),s.hasTextCollisionBoxData()&&s.textCollisionBox.collisionVertexBuffer&&s.textCollisionBox.collisionVertexBuffer.updateData(s.textCollisionBox.collisionVertexArray),s.text.opacityVertexArray.length!==s.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${s.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${s.text.layoutVertexArray.length}) / 4`);if(s.icon.opacityVertexArray.length!==s.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${s.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${s.icon.layoutVertexArray.length}) / 4`);s.bucketInstanceId in this.collisionCircleArrays&&(s.collisionCircleArray=this.collisionCircleArrays[s.bucketInstanceId],delete this.collisionCircleArrays[s.bucketInstanceId])}symbolFadeChange(s){return this.fadeDuration===0?1:(s-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(s){return Math.max(0,(this.transform.zoom-s)/1.5)}hasTransitions(s){return this.stale||s-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(s,d){const v=this.zoomAtLastRecencyCheck===d?1-this.zoomAdjustment(d):1;return this.zoomAtLastRecencyCheck=d,this.commitTime+this.fadeDuration*v>s}setStale(){this.stale=!0}}function na(C,s,d,v,S,D){v&&v.length!==0||(v=[0,0,0,0]);const k=v[0]-Qr,j=v[1]-Qr,H=v[2]-Qr,J=v[3]-Qr;C.emplaceBack(s?1:0,d?1:0,S||0,D||0,k,j),C.emplaceBack(s?1:0,d?1:0,S||0,D||0,H,j),C.emplaceBack(s?1:0,d?1:0,S||0,D||0,H,J),C.emplaceBack(s?1:0,d?1:0,S||0,D||0,k,J)}const Dl=Math.pow(2,25),Ih=Math.pow(2,24),hs=Math.pow(2,17),ul=Math.pow(2,16),Ta=Math.pow(2,9),zl=Math.pow(2,8),za=Math.pow(2,1);function Qa(C){if(C.opacity===0&&!C.placed)return 0;if(C.opacity===1&&C.placed)return 4294967295;const s=C.placed?1:0,d=Math.floor(127*C.opacity);return d*Dl+s*Ih+d*hs+s*ul+d*Ta+s*zl+d*za+s}const Hl=0;class Eh{constructor(s){this._sortAcrossTiles=s.layout.get("symbol-z-order")!=="viewport-y"&&!s.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(s,d,v,S,D){const k=this._bucketParts;for(;this._currentTileIndex<s.length;)if(d.getBucketParts(k,S,s[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,D())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,k.sort((j,H)=>j.sortKey-H.sortKey));this._currentPartIndex<k.length;)if(d.placeLayerBucketPart(k[this._currentPartIndex],this._seenCrossTileIDs,v),this._currentPartIndex++,D())return!0;return!1}}class Nu{constructor(s,d,v,S,D,k,j,H){this.placement=new ps(s,d,k,j,H),this._currentPlacementIndex=v.length-1,this._forceFullPlacement=S,this._showCollisionBoxes=D,this._done=!1}isDone(){return this._done}continuePlacement(s,d,v){const S=Ci(),D=()=>!this._forceFullPlacement&&Ci()-S>2;for(;this._currentPlacementIndex>=0;){const k=d[s[this._currentPlacementIndex]],j=this.placement.collisionIndex.transform.zoom;if(k.type==="symbol"&&(!k.minzoom||k.minzoom<=j)&&(!k.maxzoom||k.maxzoom>j)){if(this._inProgressLayer||(this._inProgressLayer=new Eh(k)),this._inProgressLayer.continuePlacement(v[k.source],this.placement,this._showCollisionBoxes,k,D))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(s){return this.placement.commit(s),this.placement}}const dl=512/i.a4/2;class La{constructor(s,d,v){this.tileID=s,this.bucketInstanceId=v,this._symbolsByKey={};const S=new Map;for(let D=0;D<d.length;D++){const k=d.get(D),j=k.key,H=S.get(j);H?H.push(k):S.set(j,[k])}for(const[D,k]of S){const j={positions:k.map(H=>({x:Math.floor(H.anchorX*dl),y:Math.floor(H.anchorY*dl)})),crossTileIDs:k.map(H=>H.crossTileID)};if(j.positions.length>128){const H=new i.aS(j.positions.length,16,Uint16Array);for(const{x:J,y:et}of j.positions)H.add(J,et);H.finish(),delete j.positions,j.index=H}this._symbolsByKey[D]=j}}getScaledCoordinates(s,d){const{x:v,y:S,z:D}=this.tileID.canonical,{x:k,y:j,z:H}=d.canonical,J=dl/Math.pow(2,H-D),et=(j*i.a4+s.anchorY)*J,mt=S*i.a4*dl;return{x:Math.floor((k*i.a4+s.anchorX)*J-v*i.a4*dl),y:Math.floor(et-mt)}}findMatches(s,d,v){const S=this.tileID.canonical.z<d.canonical.z?1:Math.pow(2,this.tileID.canonical.z-d.canonical.z);for(let D=0;D<s.length;D++){const k=s.get(D);if(k.crossTileID)continue;const j=this._symbolsByKey[k.key];if(!j)continue;const H=this.getScaledCoordinates(k,d);if(j.index){const J=j.index.range(H.x-S,H.y-S,H.x+S,H.y+S).sort();for(const et of J){const mt=j.crossTileIDs[et];if(!v[mt]){v[mt]=!0,k.crossTileID=mt;break}}}else if(j.positions)for(let J=0;J<j.positions.length;J++){const et=j.positions[J],mt=j.crossTileIDs[J];if(Math.abs(et.x-H.x)<=S&&Math.abs(et.y-H.y)<=S&&!v[mt]){v[mt]=!0,k.crossTileID=mt;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:s})=>s)}}class ac{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class fs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(s){const d=Math.round((s-this.lng)/360);if(d!==0)for(const v in this.indexes){const S=this.indexes[v],D={};for(const k in S){const j=S[k];j.tileID=j.tileID.unwrapTo(j.tileID.wrap+d),D[j.tileID.key]=j}this.indexes[v]=D}this.lng=s}addBucket(s,d,v){if(this.indexes[s.overscaledZ]&&this.indexes[s.overscaledZ][s.key]){if(this.indexes[s.overscaledZ][s.key].bucketInstanceId===d.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(s.overscaledZ,this.indexes[s.overscaledZ][s.key])}for(let D=0;D<d.symbolInstances.length;D++)d.symbolInstances.get(D).crossTileID=0;this.usedCrossTileIDs[s.overscaledZ]||(this.usedCrossTileIDs[s.overscaledZ]={});const S=this.usedCrossTileIDs[s.overscaledZ];for(const D in this.indexes){const k=this.indexes[D];if(Number(D)>s.overscaledZ)for(const j in k){const H=k[j];H.tileID.isChildOf(s)&&H.findMatches(d.symbolInstances,s,S)}else{const j=k[s.scaledTo(Number(D)).key];j&&j.findMatches(d.symbolInstances,s,S)}}for(let D=0;D<d.symbolInstances.length;D++){const k=d.symbolInstances.get(D);k.crossTileID||(k.crossTileID=v.generate(),S[k.crossTileID]=!0)}return this.indexes[s.overscaledZ]===void 0&&(this.indexes[s.overscaledZ]={}),this.indexes[s.overscaledZ][s.key]=new La(s,d.symbolInstances,d.bucketInstanceId),!0}removeBucketCrossTileIDs(s,d){for(const v of d.getCrossTileIDsLists())for(const S of v)delete this.usedCrossTileIDs[s][S]}removeStaleBuckets(s){let d=!1;for(const v in this.indexes){const S=this.indexes[v];for(const D in S)s[S[D].bucketInstanceId]||(this.removeBucketCrossTileIDs(v,S[D]),delete S[D],d=!0)}return d}}class Js{constructor(){this.layerIndexes={},this.crossTileIDs=new ac,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(s,d,v){let S=this.layerIndexes[s.id];S===void 0&&(S=this.layerIndexes[s.id]=new fs);let D=!1;const k={};S.handleWrapJump(v);for(const j of d){const H=j.getBucket(s);H&&s.id===H.layerIds[0]&&(H.bucketInstanceId||(H.bucketInstanceId=++this.maxBucketInstanceId),S.addBucket(j.tileID,H,this.crossTileIDs)&&(D=!0),k[H.bucketInstanceId]=!0)}return S.removeStaleBuckets(k)&&(D=!0),D}pruneUnusedLayers(s){const d={};s.forEach(v=>{d[v]=!0});for(const v in this.layerIndexes)d[v]||delete this.layerIndexes[v]}}var un="void main() {fragColor=vec4(1.0);}";const oa={prelude:Vn(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:Vn("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:Vn("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:Vn(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:Vn(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Vn(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Vn(un,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:Vn(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:Vn(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Vn("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Vn("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),colorRelief:Vn(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;uniform vec4 u_unpack;uniform sampler2D u_elevation_stops;uniform sampler2D u_color_stops;uniform int u_color_ramp_size;uniform float u_opacity;in vec2 v_pos;float getElevation(vec2 coord) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}float getElevationStop(int stop) {float x=(float(stop)+0.5)/float(u_color_ramp_size);vec4 data=texture(u_elevation_stops,vec2(x,0))*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {float el=getElevation(v_pos);int r=(u_color_ramp_size-1);int l=0;float el_l=getElevationStop(l);float el_r=getElevationStop(r);while(r-l > 1){int m=(r+l)/2;float el_m=getElevationStop(m);if(el < el_m){r=m;el_r=el_m;}else
{l=m;el_l=el_m;}}float x=(float(l)+(el-el_l)/(el_r-el_l)+0.5)/float(u_color_ramp_size);fragColor=u_opacity*texture(u_color_stops,vec2(x,0));
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_dimension;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_pos/8192.0)*scale+epsilon;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),debug:Vn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:Vn(un,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:Vn(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:Vn(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:Vn(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:Vn(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Vn(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Vn(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Vn(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {vec2 epsilon=1.0/u_dimension;float tileSize=u_dimension.x-2.0;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))*tileSize/pow(2.0,exaggeration+(28.2562-u_zoom));fragColor=clamp(vec4(deriv.x/8.0+0.5,deriv.y/8.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Vn(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform float u_exaggeration;uniform vec4 u_accent;uniform int u_method;uniform float u_altitudes[NUM_ILLUMINATION_SOURCES];uniform float u_azimuths[NUM_ILLUMINATION_SOURCES];uniform vec4 u_shadows[NUM_ILLUMINATION_SOURCES];uniform vec4 u_highlights[NUM_ILLUMINATION_SOURCES];
#define PI 3.141592653589793
#define STANDARD 0
#define COMBINED 1
#define IGOR 2
#define MULTIDIRECTIONAL 3
#define BASIC 4
float get_aspect(vec2 deriv){return deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);}void igor_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float aspect=get_aspect(deriv);float azimuth=u_azimuths[0]+PI;float slope_stength=atan(length(deriv))*2.0/PI;float aspect_strength=1.0-abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);float shadow_strength=slope_stength*aspect_strength;float highlight_strength=slope_stength*(1.0-aspect_strength);fragColor=u_shadows[0]*shadow_strength+u_highlights[0]*highlight_strength;}void standard_hillshade(vec2 deriv){float azimuth=u_azimuths[0]+PI;float slope=atan(0.625*length(deriv));float aspect=get_aspect(deriv);float intensity=u_exaggeration;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadows[0],u_highlights[0],shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;}void basic_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor=u_highlights[0]*(2.0*shade-1.0);}else
{fragColor=u_shadows[0]*(1.0-2.0*shade);}}void multidirectional_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;fragColor=vec4(0,0,0,0);for(int i=0; i < NUM_ILLUMINATION_SOURCES; i++){float cos_alt=cos(u_altitudes[i]);float sin_alt=sin(u_altitudes[i]);float cos_az=-cos(u_azimuths[i]);float sin_az=-sin(u_azimuths[i]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor+=u_highlights[i]*(2.0*shade-1.0)/float(NUM_ILLUMINATION_SOURCES);}else
{fragColor+=u_shadows[i]*(1.0-2.0*shade)/float(NUM_ILLUMINATION_SOURCES);}}}void combined_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=acos((sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv)));cang=clamp(cang,0.0,PI/2.0);float shade=cang*atan(length(deriv))*4.0/PI/PI;float highlight=(PI/2.0-cang)*atan(length(deriv))*4.0/PI/PI;fragColor=u_shadows[0]*shade+u_highlights[0]*highlight;}void main() {vec4 pixel=texture(u_image,v_pos);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));vec2 deriv=((pixel.rg*8.0)-4.0)/scaleFactor;if (u_method==BASIC) {basic_hillshade(deriv);} else if (u_method==COMBINED) {combined_hillshade(deriv);} else if (u_method==IGOR) {igor_hillshade(deriv);} else if (u_method==MULTIDIRECTIONAL) {multidirectional_hillshade(deriv);} else if (u_method==STANDARD) {standard_hillshade(deriv);} else {standard_hillshade(deriv);}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:Vn(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Vn(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Vn(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Vn(`uniform lowp float u_device_pixel_ratio;uniform lowp float u_lineatlas_width;uniform sampler2D u_image;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0/u_device_pixel_ratio)/min(dasharray_from.w,dasharray_to.w);alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),lineGradientSDF:Vn(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform sampler2D u_image_dash;uniform float u_mix;uniform lowp float u_lineatlas_width;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);float sdfdist_a=texture(u_image_dash,v_tex_a).a;float sdfdist_b=texture(u_image_dash,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0)/min(dasharray_from.w,dasharray_to.w);float dash_alpha=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*dash_alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;out vec2 v_tex_a;out vec2 v_tex_b;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;float texel_height=1.0/u_image_height;float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),raster:Vn(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:Vn(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Vn(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Vn(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Vn("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Vn("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Vn("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:Vn("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:Vn(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:Vn("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Vn(C,s){const d=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,v=s.match(/in ([\w]+) ([\w]+)/g),S=C.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),D=s.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),k=D?D.concat(S):S,j={};return{fragmentSource:C=C.replace(d,(H,J,et,mt,dt)=>(j[dt]=!0,J==="define"?`
#ifndef HAS_UNIFORM_u_${dt}
in ${et} ${mt} ${dt};
#else
uniform ${et} ${mt} u_${dt};
#endif
`:`
#ifdef HAS_UNIFORM_u_${dt}
    ${et} ${mt} ${dt} = u_${dt};
#endif
`)),vertexSource:s=s.replace(d,(H,J,et,mt,dt)=>{const Tt=mt==="float"?"vec2":"vec4",pt=dt.match(/color/)?"color":Tt;return j[dt]?J==="define"?`
#ifndef HAS_UNIFORM_u_${dt}
uniform lowp float u_${dt}_t;
in ${et} ${Tt} a_${dt};
out ${et} ${mt} ${dt};
#else
uniform ${et} ${mt} u_${dt};
#endif
`:pt==="vec4"?`
#ifndef HAS_UNIFORM_u_${dt}
    ${dt} = a_${dt};
#else
    ${et} ${mt} ${dt} = u_${dt};
#endif
`:`
#ifndef HAS_UNIFORM_u_${dt}
    ${dt} = unpack_mix_${pt}(a_${dt}, u_${dt}_t);
#else
    ${et} ${mt} ${dt} = u_${dt};
#endif
`:J==="define"?`
#ifndef HAS_UNIFORM_u_${dt}
uniform lowp float u_${dt}_t;
in ${et} ${Tt} a_${dt};
#else
uniform ${et} ${mt} u_${dt};
#endif
`:pt==="vec4"?`
#ifndef HAS_UNIFORM_u_${dt}
    ${et} ${mt} ${dt} = a_${dt};
#else
    ${et} ${mt} ${dt} = u_${dt};
#endif
`:`
#ifndef HAS_UNIFORM_u_${dt}
    ${et} ${mt} ${dt} = unpack_mix_${pt}(a_${dt}, u_${dt}_t);
#else
    ${et} ${mt} ${dt} = u_${dt};
#endif
`}),staticAttributes:v,staticUniforms:k}}class lc{constructor(s,d,v){this.vertexBuffer=s,this.indexBuffer=d,this.segments=v}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var Uo=i.aT([{name:"a_pos",type:"Int16",components:2}]);const ms="#define PROJECTION_MERCATOR",sa="mercator";class Us{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return sa}get shaderDefine(){return ms}get shaderPreludeCode(){return oa.projectionMercator}get vertexShaderPreludeCode(){return oa.projectionMercator.vertexSource}get subdivisionGranularity(){return i.aU.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(s){}getMeshFromTileID(s,d,v,S,D){if(this._cachedMesh)return this._cachedMesh;const k=new i.aV;k.emplaceBack(0,0),k.emplaceBack(i.a4,0),k.emplaceBack(0,i.a4),k.emplaceBack(i.a4,i.a4);const j=s.createVertexBuffer(k,Uo.members),H=i.aW.simpleSegment(0,0,4,2),J=new i.aX;J.emplaceBack(1,0,2),J.emplaceBack(1,2,3);const et=s.createIndexBuffer(J);return this._cachedMesh=new lc(j,et,H),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(s){}}class Xn{constructor(s=0,d=0,v=0,S=0){if(isNaN(s)||s<0||isNaN(d)||d<0||isNaN(v)||v<0||isNaN(S)||S<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=s,this.bottom=d,this.left=v,this.right=S}interpolate(s,d,v){return d.top!=null&&s.top!=null&&(this.top=i.G.number(s.top,d.top,v)),d.bottom!=null&&s.bottom!=null&&(this.bottom=i.G.number(s.bottom,d.bottom,v)),d.left!=null&&s.left!=null&&(this.left=i.G.number(s.left,d.left,v)),d.right!=null&&s.right!=null&&(this.right=i.G.number(s.right,d.right,v)),this}getCenter(s,d){const v=i.an((this.left+s-this.right)/2,0,s),S=i.an((this.top+d-this.bottom)/2,0,d);return new i.P(v,S)}equals(s){return this.top===s.top&&this.bottom===s.bottom&&this.left===s.left&&this.right===s.right}clone(){return new Xn(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Vu(C,s){if(!C.renderWorldCopies||C.lngRange)return;const d=s.lng-C.center.lng;s.lng+=d>180?-360:d<-180?360:0}function Ds(C){return Math.max(0,Math.floor(C))}class js{constructor(s,d){var v;this.applyConstrain=(S,D)=>this._constrainOverride!==null?this._constrainOverride(S,D):this._callbacks.defaultConstrain(S,D),this._callbacks=s,this._tileSize=512,this._renderWorldCopies=(d==null?void 0:d.renderWorldCopies)===void 0||!!(d!=null&&d.renderWorldCopies),this._minZoom=(d==null?void 0:d.minZoom)||0,this._maxZoom=(d==null?void 0:d.maxZoom)||22,this._minPitch=(d==null?void 0:d.minPitch)==null?0:d==null?void 0:d.minPitch,this._maxPitch=(d==null?void 0:d.maxPitch)==null?60:d==null?void 0:d.maxPitch,this._constrainOverride=(v=d==null?void 0:d.constrainOverride)!==null&&v!==void 0?v:null,this.setMaxBounds(),this._width=0,this._height=0,this._center=new i.V(0,0),this._elevation=0,this._zoom=0,this._tileZoom=Ds(this._zoom),this._scale=i.aq(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new Xn,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(s,d,v){this._constrainOverride=s.constrainOverride,this._latRange=s.latRange,this._lngRange=s.lngRange,this._width=s.width,this._height=s.height,this._center=s.center,this._elevation=s.elevation,this._minElevationForCurrentTile=s.minElevationForCurrentTile,this._zoom=s.zoom,this._tileZoom=Ds(this._zoom),this._scale=i.aq(this._zoom),this._bearingInRadians=s.bearingInRadians,this._fovInRadians=s.fovInRadians,this._pitchInRadians=s.pitchInRadians,this._rollInRadians=s.rollInRadians,this._unmodified=s.unmodified,this._edgeInsets=new Xn(s.padding.top,s.padding.bottom,s.padding.left,s.padding.right),this._minZoom=s.minZoom,this._maxZoom=s.maxZoom,this._minPitch=s.minPitch,this._maxPitch=s.maxPitch,this._renderWorldCopies=s.renderWorldCopies,this._cameraToCenterDistance=s.cameraToCenterDistance,this._nearZ=s.nearZ,this._farZ=s.farZ,this._autoCalculateNearFarZ=!v&&s.autoCalculateNearFarZ,d&&this.constrainInternal(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(s){this._minElevationForCurrentTile=s}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(s){this._minZoom!==s&&(this._minZoom=s,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(s){this._maxZoom!==s&&(this._maxZoom=s,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(s){this._minPitch!==s&&(this._minPitch=s,this.setPitch(Math.max(this.pitch,s)))}get maxPitch(){return this._maxPitch}setMaxPitch(s){this._maxPitch!==s&&(this._maxPitch=s,this.setPitch(Math.min(this.pitch,s)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(s){s===void 0?s=!0:s===null&&(s=!1),this._renderWorldCopies=s}get constrainOverride(){return this._constrainOverride}setConstrainOverride(s){s===void 0&&(s=null),this._constrainOverride!==s&&(this._constrainOverride=s,this.constrainInternal(),this._calcMatrices())}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new i.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(s){const d=i.W(s,-180,180)*Math.PI/180;var v,S,D,k,j,H,J,et,mt;this._bearingInRadians!==d&&(this._unmodified=!1,this._bearingInRadians=d,this._calcMatrices(),this._rotationMatrix=wi(),v=this._rotationMatrix,D=-this._bearingInRadians,k=(S=this._rotationMatrix)[0],j=S[1],H=S[2],J=S[3],et=Math.sin(D),mt=Math.cos(D),v[0]=k*mt+H*et,v[1]=j*mt+J*et,v[2]=k*-et+H*mt,v[3]=j*-et+J*mt)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(s){const d=i.an(s,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==d&&(this._unmodified=!1,this._pitchInRadians=d,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(s){const d=s/180*Math.PI;this._rollInRadians!==d&&(this._unmodified=!1,this._rollInRadians=d,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return i.aY(this._fovInRadians)}setFov(s){s=i.an(s,.1,150),this.fov!==s&&(this._unmodified=!1,this._fovInRadians=i.ap(s),this._calcMatrices())}get zoom(){return this._zoom}setZoom(s){const d=this.applyConstrain(this._center,s).zoom;this._zoom!==d&&(this._unmodified=!1,this._zoom=d,this._tileZoom=Math.max(0,Math.floor(d)),this._scale=i.aq(d),this.constrainInternal(),this._calcMatrices())}get center(){return this._center}setCenter(s){s.lat===this._center.lat&&s.lng===this._center.lng||(this._unmodified=!1,this._center=s,this.constrainInternal(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(s){s!==this._elevation&&(this._elevation=s,this.constrainInternal(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(s){this._edgeInsets.equals(s)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,s,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(s,d){this._autoCalculateNearFarZ=!1,this._nearZ=s,this._farZ=d,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(s){return this._edgeInsets.equals(s)}interpolatePadding(s,d,v){this._unmodified=!1,this._edgeInsets.interpolate(s,d,v),this.constrainInternal(),this._calcMatrices()}resize(s,d,v=!0){this._width=s,this._height=d,v&&this.constrainInternal(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new xo([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(s){s?(this._lngRange=[s.getWest(),s.getEast()],this._latRange=[s.getSouth(),s.getNorth()],this.constrainInternal()):(this._lngRange=null,this._latRange=[-i.ao,i.ao])}getCameraQueryGeometry(s,d){if(d.length===1)return[d[0],s];{const{minX:v,minY:S,maxX:D,maxY:k}=i.ab.fromPoints(d).extend(s);return[new i.P(v,S),new i.P(D,S),new i.P(D,k),new i.P(v,k),new i.P(v,S)]}}constrainInternal(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const s=this._unmodified,{center:d,zoom:v}=this.applyConstrain(this.center,this.zoom);this.setCenter(d),this.setZoom(v),this._unmodified=s,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let s=i.ar(new Float64Array(16));i.Q(s,s,[this._width/2,-this._height/2,1]),i.O(s,s,[1,-1,0]),this._clipSpaceToPixelsMatrix=s,s=i.ar(new Float64Array(16)),i.Q(s,s,[1,-1,1]),i.O(s,s,[-1,-1,0]),i.Q(s,s,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=s,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(s,d,v,S){const D=v!==void 0?v:this.bearing,k=S=S!==void 0?S:this.pitch,j=i.aa.fromLngLat(s,d),H=-Math.cos(i.ap(k)),J=Math.sin(i.ap(k)),et=J*Math.sin(i.ap(D)),mt=-J*Math.cos(i.ap(D));let dt=this.elevation;const Tt=d-dt;let pt;H*Tt>=0||Math.abs(H)<.1?(pt=1e4,dt=d+pt*H):pt=-Tt/H;let It,Kt,Wt=i.aZ(1,j.y),ft=0;do{if(ft+=1,ft>10)break;Kt=pt/Wt,It=new i.aa(j.x+et*Kt,j.y+mt*Kt),Wt=1/It.meterInMercatorCoordinateUnits()}while(Math.abs(pt-Kt*Wt)>1e-12);return{center:It.toLngLat(),elevation:dt,zoom:i.at(this.height/2/Math.tan(this.fovInRadians/2)/Kt/this.tileSize)}}recalculateZoomAndCenter(s){if(this.elevation-s==0)return;const d=i.as(1,this.center.lat)*this.worldSize,v=this.cameraToCenterDistance/d,S=i.aa.fromLngLat(this.center,this.elevation),D=De(this.center,this.elevation,this.pitch,this.bearing,v);this._elevation=s;const k=this.calculateCenterFromCameraLngLatAlt(D.toLngLat(),i.aZ(D.z,S.y),this.bearing,this.pitch);this._elevation=k.elevation,this._center=k.center,this.setZoom(k.zoom)}getCameraPoint(){const s=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new i.P(s*Math.sin(this.rollInRadians),s*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const s=i.as(1,this.center.lat)*this.worldSize;return De(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/s).toLngLat()}getMercatorTileCoordinates(s){if(!s)return[0,0,1,1];const d=s.canonical.z>=0?1<<s.canonical.z:Math.pow(2,s.canonical.z);return[s.canonical.x/d,s.canonical.y/d,1/d/i.a4,1/d/i.a4]}}class aa{constructor(s,d){this.min=s,this.max=d,this.center=i.a_([],i.a$([],this.min,this.max),.5)}quadrant(s){const d=[s%2==0,s<2],v=i.b0(this.min),S=i.b0(this.max);for(let D=0;D<d.length;D++)v[D]=d[D]?this.min[D]:this.center[D],S[D]=d[D]?this.center[D]:this.max[D];return S[2]=this.max[2],new aa(v,S)}distanceX(s){return Math.max(Math.min(this.max[0],s[0]),this.min[0])-s[0]}distanceY(s){return Math.max(Math.min(this.max[1],s[1]),this.min[1])-s[1]}intersectsFrustum(s){let d=!0;for(let v=0;v<s.planes.length;v++){const S=this.intersectsPlane(s.planes[v]);if(S===0)return 0;S===1&&(d=!1)}return d?2:s.aabb.min[0]>this.max[0]||s.aabb.min[1]>this.max[1]||s.aabb.min[2]>this.max[2]||s.aabb.max[0]<this.min[0]||s.aabb.max[1]<this.min[1]||s.aabb.max[2]<this.min[2]?0:1}intersectsPlane(s){let d=s[3],v=s[3];for(let S=0;S<3;S++)s[S]>0?(d+=s[S]*this.min[S],v+=s[S]*this.max[S]):(v+=s[S]*this.min[S],d+=s[S]*this.max[S]);return d>=0?2:v<0?0:1}}class Uu{distanceToTile2d(s,d,v,S){const D=S.distanceX([s,d]),k=S.distanceY([s,d]);return Math.hypot(D,k)}getWrap(s,d,v){return v}getTileBoundingVolume(s,d,v,S){var D,k;let j=0,H=0;if(S!=null&&S.terrain){const et=new i.a1(s.z,d,s.z,s.x,s.y),mt=S.terrain.getMinMaxElevation(et);j=(D=mt.minElevation)!==null&&D!==void 0?D:Math.min(0,v),H=(k=mt.maxElevation)!==null&&k!==void 0?k:Math.max(0,v)}const J=1<<s.z;return new aa([d+s.x/J,s.y/J,j],[d+(s.x+1)/J,(s.y+1)/J,H])}allowVariableZoom(s,d){const v=s.fov*(Math.abs(Math.cos(s.rollInRadians))*s.height+Math.abs(Math.sin(s.rollInRadians))*s.width)/s.height,S=i.an(78.5-v/2,0,60);return!!d.terrain||s.pitch>S}allowWorldCopies(){return!0}prepareNextFrame(){}}class Ll{constructor(s,d,v){this.points=s,this.planes=d,this.aabb=v}static fromInvProjectionMatrix(s,d=1,v=0,S,D){const k=D?[[6,5,4],[0,1,2],[0,3,7],[2,1,5],[3,2,6],[0,4,5]]:[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]],j=Math.pow(2,v),H=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(dt=>function(Tt,pt,It,Kt){const Wt=i.aG([],Tt,pt),ft=1/Wt[3]/It*Kt;return i.b5(Wt,Wt,[ft,ft,1/Wt[3],ft])}(dt,s,d,j));S&&function(dt,Tt,pt,It){const Kt=It?4:0,Wt=It?0:4;let ft=0;const _e=[],he=[];for(let de=0;de<4;de++){const Ce=i.b1([],dt[de+Wt],dt[de+Kt]),Qe=i.b6(Ce);i.a_(Ce,Ce,1/Qe),_e.push(Qe),he.push(Ce)}for(let de=0;de<4;de++){const Ce=i.b7(dt[de+Kt],he[de],pt);ft=Ce!==null&&Ce>=0?Math.max(ft,Ce):Math.max(ft,_e[de])}const me=function(de,Ce){const Qe=i.b1([],de[Ce[0]],de[Ce[1]]),Xe=i.b1([],de[Ce[2]],de[Ce[1]]),Je=[0,0,0,0];return i.b2(Je,i.b3([],Qe,Xe)),Je[3]=-i.b4(Je,de[Ce[0]]),Je}(dt,Tt),be=function(de,Ce){const Qe=i.b8(de),Xe=i.b9([],de,1/Qe),Je=i.b1([],Ce,i.a_([],Xe,i.b4(Ce,Xe))),ii=i.b8(Je);if(ii>0){const Ri=Math.sqrt(1-Xe[3]*Xe[3]),Oi=i.a_([],Xe,-Xe[3]),Ti=i.a$([],Oi,i.a_([],Je,Ri/ii));return i.ba(Ce,Ti)}return null}(pt,me);if(be!==null){const de=be/i.b4(he[0],me);ft=Math.min(ft,de)}for(let de=0;de<4;de++){const Ce=Math.min(ft,_e[de]);dt[de+Wt]=[dt[de+Kt][0]+he[de][0]*Ce,dt[de+Kt][1]+he[de][1]*Ce,dt[de+Kt][2]+he[de][2]*Ce,1]}}(H,k[0],S,D);const J=k.map(dt=>{const Tt=i.b1([],H[dt[0]],H[dt[1]]),pt=i.b1([],H[dt[2]],H[dt[1]]),It=i.b2([],i.b3([],Tt,pt)),Kt=-i.b4(It,H[dt[1]]);return It.concat(Kt)}),et=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],mt=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const dt of H)for(let Tt=0;Tt<3;Tt++)et[Tt]=Math.min(et[Tt],dt[Tt]),mt[Tt]=Math.max(mt[Tt],dt[Tt]);return new Ll(H,J,new aa(et,mt))}}class vr{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(s){this._helper.setMinZoom(s)}setMaxZoom(s){this._helper.setMaxZoom(s)}setMinPitch(s){this._helper.setMinPitch(s)}setMaxPitch(s){this._helper.setMaxPitch(s)}setRenderWorldCopies(s){this._helper.setRenderWorldCopies(s)}setBearing(s){this._helper.setBearing(s)}setPitch(s){this._helper.setPitch(s)}setRoll(s){this._helper.setRoll(s)}setFov(s){this._helper.setFov(s)}setZoom(s){this._helper.setZoom(s)}setCenter(s){this._helper.setCenter(s)}setElevation(s){this._helper.setElevation(s)}setMinElevationForCurrentTile(s){this._helper.setMinElevationForCurrentTile(s)}setPadding(s){this._helper.setPadding(s)}interpolatePadding(s,d,v){return this._helper.interpolatePadding(s,d,v)}isPaddingEqual(s){return this._helper.isPaddingEqual(s)}resize(s,d,v=!0){this._helper.resize(s,d,v)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(s){this._helper.setMaxBounds(s)}setConstrainOverride(s){this._helper.setConstrainOverride(s)}overrideNearFarZ(s,d){this._helper.overrideNearFarZ(s,d)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(s){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),s)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(s,d){}constructor(s){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this.defaultConstrain=(d,v)=>{v=i.an(+v,this.minZoom,this.maxZoom);const S={center:new i.V(d.lng,d.lat),zoom:v};let D=this._helper._lngRange;if(!this._helper._renderWorldCopies&&D===null){const he=179.9999999999;D=[-he,he]}const k=this.tileSize*i.aq(S.zoom);let j=0,H=k,J=0,et=k,mt=0,dt=0;const{x:Tt,y:pt}=this.size;if(this._helper._latRange){const he=this._helper._latRange;j=i.X(he[1])*k,H=i.X(he[0])*k,H-j<pt&&(mt=pt/(H-j))}D&&(J=i.W(i.Y(D[0])*k,0,k),et=i.W(i.Y(D[1])*k,0,k),et<J&&(et+=k),et-J<Tt&&(dt=Tt/(et-J)));const{x:It,y:Kt}=ce(k,d);let Wt,ft;const _e=Math.max(dt||0,mt||0);if(_e){const he=new i.P(dt?(et+J)/2:It,mt?(H+j)/2:Kt);return S.center=ae(k,he).wrap(),S.zoom+=i.at(_e),S}if(this._helper._latRange){const he=pt/2;Kt-he<j&&(ft=j+he),Kt+he>H&&(ft=H-he)}if(D){const he=(J+et)/2;let me=It;this._helper._renderWorldCopies&&(me=i.W(It,he-k/2,he+k/2));const be=Tt/2;me-be<J&&(Wt=J+be),me+be>et&&(Wt=et-be)}if(Wt!==void 0||ft!==void 0){const he=new i.P(Wt??It,ft??Kt);S.center=ae(k,he).wrap()}return S},this.applyConstrain=(d,v)=>this._helper.applyConstrain(d,v),this._helper=new js({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(d,v)=>this.defaultConstrain(d,v)},s),this._coveringTilesDetailsProvider=new Uu}clone(){const s=new vr;return s.apply(this),s}apply(s,d,v){this._helper.apply(s,d,v)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(s){const d=[new i.bb(0,s)];if(this._helper._renderWorldCopies){const v=this.screenPointToMercatorCoordinate(new i.P(0,0)),S=this.screenPointToMercatorCoordinate(new i.P(this._helper._width,0)),D=this.screenPointToMercatorCoordinate(new i.P(this._helper._width,this._helper._height)),k=this.screenPointToMercatorCoordinate(new i.P(0,this._helper._height)),j=Math.floor(Math.min(v.x,S.x,D.x,k.x)),H=Math.floor(Math.max(v.x,S.x,D.x,k.x)),J=1;for(let et=j-J;et<=H+J;et++)et!==0&&d.push(new i.bb(et,s))}return d}getCameraFrustum(){return Ll.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(s){const d=this.screenPointToLocation(this.centerPoint,s),v=s?s.getElevationForLngLatZoom(d,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(v)}setLocationAtPoint(s,d){const v=i.as(this.elevation,this.center.lat),S=this.screenPointToMercatorCoordinateAtZ(d,v),D=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,v),k=i.aa.fromLngLat(s),j=new i.aa(k.x-(S.x-D.x),k.y-(S.y-D.y));this.setCenter(j==null?void 0:j.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(s,d){return d?this.coordinatePoint(i.aa.fromLngLat(s),d.getElevationForLngLatZoom(s,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(i.aa.fromLngLat(s))}screenPointToLocation(s,d){var v;return(v=this.screenPointToMercatorCoordinate(s,d))===null||v===void 0?void 0:v.toLngLat()}screenPointToMercatorCoordinate(s,d){if(d){const v=d.pointCoordinate(s);if(v!=null)return v}return this.screenPointToMercatorCoordinateAtZ(s)}screenPointToMercatorCoordinateAtZ(s,d){const v=d||0,S=[s.x,s.y,0,1],D=[s.x,s.y,1,1];i.aG(S,S,this._pixelMatrixInverse),i.aG(D,D,this._pixelMatrixInverse);const k=S[3],j=D[3],H=S[1]/k,J=D[1]/j,et=S[2]/k,mt=D[2]/j,dt=et===mt?0:(v-et)/(mt-et);return new i.aa(i.G.number(S[0]/k,D[0]/j,dt)/this.worldSize,i.G.number(H,J,dt)/this.worldSize,v)}coordinatePoint(s,d=0,v=this._pixelMatrix){const S=[s.x*this.worldSize,s.y*this.worldSize,d,1];return i.aG(S,S,v),new i.P(S[0]/S[3],S[1]/S[3])}getBounds(){const s=Math.max(0,this._helper._height/2-Fe(this));return new xo().extend(this.screenPointToLocation(new i.P(0,s))).extend(this.screenPointToLocation(new i.P(this._helper._width,s))).extend(this.screenPointToLocation(new i.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new i.P(0,this._helper._height)))}isPointOnMapSurface(s,d){return d?d.pointCoordinate(s)!=null:s.y>this.height/2-Fe(this)}calculatePosMatrix(s,d=!1,v){var S;const D=(S=s.key)!==null&&S!==void 0?S:i.bc(s.wrap,s.canonical.z,s.canonical.z,s.canonical.x,s.canonical.y),k=d?this._alignedPosMatrixCache:this._posMatrixCache;if(k.has(D)){const J=k.get(D);return v?J.f32:J.f64}const j=Jt(s,this.worldSize);i.S(j,d?this._alignedProjMatrix:this._viewProjMatrix,j);const H={f64:j,f32:new Float32Array(j)};return k.set(D,H),v?H.f32:H.f64}calculateFogMatrix(s){const d=s.key,v=this._fogMatrixCacheF32;if(v.has(d))return v.get(d);const S=Jt(s,this.worldSize);return i.S(S,this._fogMatrix,S),v.set(d,new Float32Array(S)),v.get(d)}calculateCenterFromCameraLngLatAlt(s,d,v,S){return this._helper.calculateCenterFromCameraLngLatAlt(s,d,v,S)}_calculateNearFarZIfNeeded(s,d,v){if(!this._helper.autoCalculateNearFarZ)return;const S=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),D=s-S*this._helper._pixelPerMeter/Math.cos(d),k=S<0?D:s,j=Math.PI/2+this.pitchInRadians,H=i.ap(this.fov)*(Math.abs(Math.cos(i.ap(this.roll)))*this.height+Math.abs(Math.sin(i.ap(this.roll)))*this.width)/this.height*(.5+v.y/this.height),J=Math.sin(H)*k/Math.sin(i.an(Math.PI-j-H,.01,Math.PI-.01)),et=Fe(this),mt=Math.atan(et/this._helper.cameraToCenterDistance),dt=i.ap(.75),Tt=mt>dt?2*mt*(.5+v.y/(2*et)):dt,pt=Math.sin(Tt)*k/Math.sin(i.an(Math.PI-j-Tt,.01,Math.PI-.01)),It=Math.min(J,pt);this._helper._farZ=1.01*(Math.cos(Math.PI/2-d)*It+k),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const s=this.centerOffset,d=ce(this.worldSize,this.center),v=d.x,S=d.y;this._helper._pixelPerMeter=i.as(1,this.center.lat)*this.worldSize;const D=i.ap(Math.min(this.pitch,Nt)),k=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(D));let j;this._calculateNearFarZIfNeeded(k,D,s),j=new Float64Array(16),i.bd(j,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),i.aA(this._invProjMatrix,j),j[8]=2*-s.x/this._helper._width,j[9]=2*s.y/this._helper._height,this._projectionMatrix=i.be(j),i.Q(j,j,[1,-1,1]),i.O(j,j,[0,0,-this._helper.cameraToCenterDistance]),i.bf(j,j,-this.rollInRadians),i.bg(j,j,this.pitchInRadians),i.bf(j,j,-this.bearingInRadians),i.O(j,j,[-v,-S,0]),this._mercatorMatrix=i.Q([],j,[this.worldSize,this.worldSize,this.worldSize]),i.Q(j,j,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=i.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,j),i.O(j,j,[0,0,-this.elevation]),this._viewProjMatrix=j,this._invViewProjMatrix=i.aA([],j);const H=[0,0,-1,1];i.aG(H,H,this._invViewProjMatrix),this._cameraPosition=[H[0]/H[3],H[1]/H[3],H[2]/H[3]],this._fogMatrix=new Float64Array(16),i.bd(this._fogMatrix,this.fovInRadians,this.width/this.height,k,this._helper._farZ),this._fogMatrix[8]=2*-s.x/this.width,this._fogMatrix[9]=2*s.y/this.height,i.Q(this._fogMatrix,this._fogMatrix,[1,-1,1]),i.O(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),i.bf(this._fogMatrix,this._fogMatrix,-this.rollInRadians),i.bg(this._fogMatrix,this._fogMatrix,this.pitchInRadians),i.bf(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),i.O(this._fogMatrix,this._fogMatrix,[-v,-S,0]),i.Q(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),i.O(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=i.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,j);const J=this._helper._width%2/2,et=this._helper._height%2/2,mt=Math.cos(this.bearingInRadians),dt=Math.sin(-this.bearingInRadians),Tt=v-Math.round(v)+mt*J+dt*et,pt=S-Math.round(S)+mt*et+dt*J,It=new Float64Array(j);if(i.O(It,It,[Tt>.5?Tt-1:Tt,pt>.5?pt-1:pt,0]),this._alignedProjMatrix=It,j=i.aA(new Float64Array(16),this._pixelMatrix),!j)throw new Error("failed to invert matrix");this._pixelMatrixInverse=j,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const s=this.screenPointToMercatorCoordinate(new i.P(0,0)),d=[s.x*this.worldSize,s.y*this.worldSize,0,1];return i.aG(d,d,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const s=i.as(1,this.center.lat)*this.worldSize;return De(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/s).toLngLat()}lngLatToCameraDepth(s,d){const v=i.aa.fromLngLat(s),S=[v.x*this.worldSize,v.y*this.worldSize,d,1];return i.aG(S,S,this._viewProjMatrix),S[2]/S[3]}getProjectionData(s){const{overscaledTileID:d,aligned:v,applyTerrainMatrix:S}=s,D=this._helper.getMercatorTileCoordinates(d),k=d?this.calculatePosMatrix(d,v,!0):null;let j;return j=d&&d.terrainRttPosMatrix32f&&S?d.terrainRttPosMatrix32f:k||i.bh(),{mainMatrix:j,tileMercatorCoords:D,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:j}}isLocationOccluded(s){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(s,d,v){return 1}transformLightDirection(s){return i.b0(s)}getRayDirectionFromPixel(s){throw new Error("Not implemented.")}projectTileCoordinates(s,d,v,S){const D=this.calculatePosMatrix(v);let k;S?(k=[s,d,S(s,d),1],i.aG(k,k,D)):(k=[s,d,0,1],Vo(k,k,D));const j=k[3];return{point:new i.P(k[0]/j,k[1]/j),signedDistanceFromCamera:j,isOccluded:!1}}populateCache(s){for(const d of s)this.calculatePosMatrix(d)}getMatrixForModel(s,d){const v=i.aa.fromLngLat(s,d),S=v.meterInMercatorCoordinateUnits(),D=i.bi();return i.O(D,D,[v.x,v.y,v.z]),i.bf(D,D,Math.PI),i.bg(D,D,Math.PI/2),i.Q(D,D,[-S,S,S]),D}getProjectionDataForCustomLayer(s=!0){const d=new i.a1(0,0,0,0,0),v=this.getProjectionData({overscaledTileID:d,applyGlobeMatrix:s}),S=Jt(d,this.worldSize);i.S(S,this._viewProjMatrix,S),v.tileMercatorCoords=[0,0,1,1];const D=[i.a4,i.a4,this.worldSize/this._helper.pixelsPerMeter],k=i.bj();return i.Q(k,S,D),v.fallbackMatrix=k,v.mainMatrix=k,v}getFastPathSimpleProjectionMatrix(s){return this.calculatePosMatrix(s)}}function Ah(){i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function Wl(C){if(C.useSlerp)if(C.k<1){const s=i.bk(C.startEulerAngles.roll,C.startEulerAngles.pitch,C.startEulerAngles.bearing),d=i.bk(C.endEulerAngles.roll,C.endEulerAngles.pitch,C.endEulerAngles.bearing),v=new Float64Array(4);i.bl(v,s,d,C.k);const S=i.bm(v);C.tr.setRoll(S.roll),C.tr.setPitch(S.pitch),C.tr.setBearing(S.bearing)}else C.tr.setRoll(C.endEulerAngles.roll),C.tr.setPitch(C.endEulerAngles.pitch),C.tr.setBearing(C.endEulerAngles.bearing);else C.tr.setRoll(i.G.number(C.startEulerAngles.roll,C.endEulerAngles.roll,C.k)),C.tr.setPitch(i.G.number(C.startEulerAngles.pitch,C.endEulerAngles.pitch,C.k)),C.tr.setBearing(i.G.number(C.startEulerAngles.bearing,C.endEulerAngles.bearing,C.k))}function Yc(C,s,d,v,S){const D=S.padding,k=ce(S.worldSize,d.getNorthWest()),j=ce(S.worldSize,d.getNorthEast()),H=ce(S.worldSize,d.getSouthEast()),J=ce(S.worldSize,d.getSouthWest()),et=i.ap(-v),mt=k.rotate(et),dt=j.rotate(et),Tt=H.rotate(et),pt=J.rotate(et),It=new i.P(Math.max(mt.x,dt.x,pt.x,Tt.x),Math.max(mt.y,dt.y,pt.y,Tt.y)),Kt=new i.P(Math.min(mt.x,dt.x,pt.x,Tt.x),Math.min(mt.y,dt.y,pt.y,Tt.y)),Wt=It.sub(Kt),ft=(S.width-(D.left+D.right+s.left+s.right))/Wt.x,_e=(S.height-(D.top+D.bottom+s.top+s.bottom))/Wt.y;if(_e<0||ft<0)return void Ah();const he=Math.min(i.at(S.scale*Math.min(ft,_e)),C.maxZoom),me=i.P.convert(C.offset),be=new i.P((s.left-s.right)/2,(s.top-s.bottom)/2).rotate(i.ap(v)),de=me.add(be).mult(S.scale/i.aq(he));return{center:ae(S.worldSize,k.add(H).div(2).sub(de)),zoom:he,bearing:v}}class Ra{get useGlobeControls(){return!1}handlePanInertia(s,d){const v=s.mag(),S=Math.abs(Fe(d));return{easingOffset:s.mult(Math.min(.75*S/v,1)),easingCenter:d.center}}handleMapControlsRollPitchBearingZoom(s,d){s.bearingDelta&&d.setBearing(d.bearing+s.bearingDelta),s.pitchDelta&&d.setPitch(d.pitch+s.pitchDelta),s.rollDelta&&d.setRoll(d.roll+s.rollDelta),s.zoomDelta&&d.setZoom(d.zoom+s.zoomDelta)}handleMapControlsPan(s,d,v){s.around.distSqr(d.centerPoint)<.01||d.setLocationAtPoint(v,s.around)}cameraForBoxAndBearing(s,d,v,S,D){return Yc(s,d,v,S,D)}handleJumpToCenterZoom(s,d){s.zoom!==(d.zoom!==void 0?+d.zoom:s.zoom)&&s.setZoom(+d.zoom),d.center!==void 0&&s.setCenter(i.V.convert(d.center))}handleEaseTo(s,d){const v=s.zoom,S=s.padding,D={roll:s.roll,pitch:s.pitch,bearing:s.bearing},k={roll:d.roll===void 0?s.roll:d.roll,pitch:d.pitch===void 0?s.pitch:d.pitch,bearing:d.bearing===void 0?s.bearing:d.bearing},j=d.zoom!==void 0,H=!s.isPaddingEqual(d.padding);let J=!1;const et=j?+d.zoom:s.zoom;let mt=s.centerPoint.add(d.offsetAsPoint);const dt=s.screenPointToLocation(mt),{center:Tt,zoom:pt}=s.applyConstrain(i.V.convert(d.center||dt),et??v);Vu(s,Tt);const It=ce(s.worldSize,dt),Kt=ce(s.worldSize,Tt).sub(It),Wt=i.aq(pt-v);return J=pt!==v,{easeFunc:ft=>{if(J&&s.setZoom(i.G.number(v,pt,ft)),i.bn(D,k)||Wl({startEulerAngles:D,endEulerAngles:k,tr:s,k:ft,useSlerp:D.roll!=k.roll}),H&&(s.interpolatePadding(S,d.padding,ft),mt=s.centerPoint.add(d.offsetAsPoint)),d.around)s.setLocationAtPoint(d.around,d.aroundPoint);else{const _e=i.aq(s.zoom-v),he=pt>v?Math.min(2,Wt):Math.max(.5,Wt),me=Math.pow(he,1-ft),be=ae(s.worldSize,It.add(Kt.mult(ft*me)).mult(_e));s.setLocationAtPoint(s.renderWorldCopies?be.wrap():be,mt)}},isZooming:J,elevationCenter:Tt}}handleFlyTo(s,d){const v=d.zoom!==void 0,S=s.zoom,D=s.applyConstrain(i.V.convert(d.center||d.locationAtOffset),v?+d.zoom:S),k=D.center,j=D.zoom;Vu(s,k);const H=ce(s.worldSize,d.locationAtOffset),J=ce(s.worldSize,k).sub(H),et=J.mag(),mt=i.aq(j-S);let dt;if(d.minZoom!==void 0){const Tt=Math.min(+d.minZoom,S,j),pt=s.applyConstrain(k,Tt).zoom;dt=i.aq(pt-S)}return{easeFunc:(Tt,pt,It,Kt)=>{s.setZoom(Tt===1?j:S+i.at(pt));const Wt=Tt===1?k:ae(s.worldSize,H.add(J.mult(It)).mult(pt));s.setLocationAtPoint(s.renderWorldCopies?Wt.wrap():Wt,Kt)},scaleOfZoom:mt,targetCenter:k,scaleOfMinZoom:dt,pixelPathLength:et}}}class ko{constructor(s,d,v){this.blendFunction=s,this.blendColor=d,this.mask=v}}ko.Replace=[1,0],ko.disabled=new ko(ko.Replace,i.bo.transparent,[!1,!1,!1,!1]),ko.unblended=new ko(ko.Replace,i.bo.transparent,[!0,!0,!0,!0]),ko.alphaBlended=new ko([1,771],i.bo.transparent,[!0,!0,!0,!0]);const pl=2305;class qn{constructor(s,d,v){this.enable=s,this.mode=d,this.frontFace=v}}qn.disabled=new qn(!1,1029,pl),qn.backCCW=new qn(!0,1029,pl),qn.frontCCW=new qn(!0,1028,pl);class rn{constructor(s,d,v){this.func=s,this.mask=d,this.range=v}}rn.ReadOnly=!1,rn.ReadWrite=!0,rn.disabled=new rn(519,rn.ReadOnly,[0,1]);const lu=7680;class Un{constructor(s,d,v,S,D,k){this.test=s,this.ref=d,this.mask=v,this.fail=S,this.depthFail=D,this.pass=k}}Un.disabled=new Un({func:519,mask:0},0,0,lu,lu,lu);const ju=new WeakMap;function tl(C){var s;if(ju.has(C))return ju.get(C);{const d=(s=C.getParameter(C.VERSION))===null||s===void 0?void 0:s.startsWith("WebGL 2.0");return ju.set(C,d),d}}class Sa{get awaitingQuery(){return!!this._readbackQueue}constructor(s){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=s;const d=s.context,v=d.gl;this._texFormat=v.RGBA,this._texType=v.UNSIGNED_BYTE;const S=new i.aV;S.emplaceBack(-1,-1),S.emplaceBack(2,-1),S.emplaceBack(-1,2);const D=new i.aX;D.emplaceBack(0,1,2),this._fullscreenTriangle=new lc(d.createVertexBuffer(S,Uo.members),d.createIndexBuffer(D),i.aW.simpleSegment(0,0,S.length,D.length)),this._resultBuffer=new Uint8Array(4),d.activeTexture.set(v.TEXTURE1);const k=v.createTexture();v.bindTexture(v.TEXTURE_2D,k),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.NEAREST),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.NEAREST),v.texImage2D(v.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=d.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(k),tl(v)&&(this._pbo=v.createBuffer(),v.bindBuffer(v.PIXEL_PACK_BUFFER,this._pbo),v.bufferData(v.PIXEL_PACK_BUFFER,4,v.STREAM_READ),v.bindBuffer(v.PIXEL_PACK_BUFFER,null))}destroy(){const s=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),s.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(s,d){const v=this._updateCount;return this._readbackQueue?v>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():v>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(s,d),this._updateCount++,this._measuredError}_bindFramebuffer(){const s=this._cachedRenderContext.context,d=s.gl;s.activeTexture.set(d.TEXTURE1),d.bindTexture(d.TEXTURE_2D,this._fbo.colorAttachment.get()),s.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(s,d){const v=this._cachedRenderContext.context,S=v.gl;if(this._bindFramebuffer(),v.viewport.set([0,0,this._texWidth,this._texHeight]),v.clear({color:i.bo.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(v,S.TRIANGLES,rn.disabled,Un.disabled,ko.unblended,qn.disabled,((D,k)=>({u_input:D,u_output_expected:k}))(s,d),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&tl(S)){S.bindBuffer(S.PIXEL_PACK_BUFFER,this._pbo),S.readBuffer(S.COLOR_ATTACHMENT0),S.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),S.bindBuffer(S.PIXEL_PACK_BUFFER,null);const D=S.fenceSync(S.SYNC_GPU_COMMANDS_COMPLETE,0);S.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:D}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const s=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&tl(s)){const d=s.clientWaitSync(this._readbackQueue.sync,0,0);if(d===s.WAIT_FAILED)return i.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(d===s.TIMEOUT_EXPIRED)return;s.bindBuffer(s.PIXEL_PACK_BUFFER,this._pbo),s.getBufferSubData(s.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),s.bindBuffer(s.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),s.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=Sa._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(s){let d=0;return d+=s[0]/256,d+=s[1]/65536,d+=s[2]/16777216,s[3]<127&&(d=-d),d/128}}const cc=i.a4/128;function Jc(C,s){const d=C.granularity!==void 0?Math.max(C.granularity,1):1,v=d+(C.generateBorders?2:0),S=d+(C.extendToNorthPole||C.generateBorders?1:0)+(C.extendToSouthPole||C.generateBorders?1:0),D=v+1,k=S+1,j=C.generateBorders?-1:0,H=C.generateBorders||C.extendToNorthPole?-1:0,J=d+(C.generateBorders?1:0),et=d+(C.generateBorders||C.extendToSouthPole?1:0),mt=D*k,dt=v*S*6,Tt=D*k>65536;if(Tt&&s==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const pt=Tt||s==="32bit",It=new Int16Array(2*mt);let Kt=0;for(let _e=H;_e<=et;_e++)for(let he=j;he<=J;he++){let me=he/d*i.a4;he===-1&&(me=-cc),he===d+1&&(me=i.a4+cc);let be=_e/d*i.a4;_e===-1&&(be=C.extendToNorthPole?i.bq:-cc),_e===d+1&&(be=C.extendToSouthPole?i.br:i.a4+cc),It[Kt++]=me,It[Kt++]=be}const Wt=pt?new Uint32Array(dt):new Uint16Array(dt);let ft=0;for(let _e=0;_e<S;_e++)for(let he=0;he<v;he++){const me=he+1+_e*D,be=he+(_e+1)*D,de=he+1+(_e+1)*D;Wt[ft++]=he+_e*D,Wt[ft++]=be,Wt[ft++]=me,Wt[ft++]=me,Wt[ft++]=be,Wt[ft++]=de}return{vertices:It.buffer.slice(0),indices:Wt.buffer.slice(0),uses32bitIndices:pt}}const Kc=new i.aU({fill:new i.bs(128,2),line:new i.bs(512,0),tile:new i.bs(128,32),stencil:new i.bs(128,1),circle:3});class Rl{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return oa.projectionGlobe}get vertexShaderPreludeCode(){return oa.projectionMercator.vertexSource}get subdivisionGranularity(){return Kc}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(s){this._errorMeasurement||(this._errorMeasurement=new Sa(s));const d=i.X(this._errorQueryLatitudeDegrees),v=2*Math.atan(Math.exp(Math.PI-d*Math.PI*2))-.5*Math.PI,S=this._errorMeasurement.updateErrorLoop(d,v),D=Ci();S!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=S,this._errorMeasurementLastChangeTime=D);const k=Math.min(Math.max((D-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=i.bt(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,i.bu(k))}_getMeshKey(s){return`${s.granularity.toString(36)}_${s.generateBorders?"b":""}${s.extendToNorthPole?"n":""}${s.extendToSouthPole?"s":""}`}getMeshFromTileID(s,d,v,S,D){const k=(D==="stencil"?Kc.stencil:Kc.tile).getGranularityForZoomLevel(d.z);return this._getMesh(s,{granularity:k,generateBorders:v,extendToNorthPole:d.y===0&&S,extendToSouthPole:d.y===(1<<d.z)-1&&S})}_getMesh(s,d){const v=this._getMeshKey(d);if(v in this._tileMeshCache)return this._tileMeshCache[v];const S=function(D,k){const j=Jc(k,"16bit"),H=i.aV.deserialize({arrayBuffer:j.vertices,length:j.vertices.byteLength/2/2}),J=i.aX.deserialize({arrayBuffer:j.indices,length:j.indices.byteLength/2/3});return new lc(D.createVertexBuffer(H,Uo.members),D.createIndexBuffer(J),i.aW.simpleSegment(0,0,H.length,J.length))}(s,d);return this._tileMeshCache[v]=S,S}recalculate(s){}hasTransition(){const s=Ci();let d=!1;return d=d||(s-this._errorMeasurementLastChangeTime)/1e3<.7,d=d||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,d}setErrorQueryLatitudeDegrees(s){this._errorQueryLatitudeDegrees=s}}const es=new i.t({type:new i.D(i.u.projection.type)});class Ph extends i.E{constructor(s){super(),this._transitionable=new i.x(es,void 0),this.setProjection(s),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new i.H(0)),this._mercatorProjection=new Us,this._verticalPerspectiveProjection=new Rl}get transitionState(){const s=this.properties.get("type");if(typeof s=="string"&&s==="mercator")return 0;if(typeof s=="string"&&s==="vertical-perspective")return 1;if(s instanceof i.bv){if(s.from==="vertical-perspective"&&s.to==="mercator")return 1-s.transition;if(s.from==="mercator"&&s.to==="vertical-perspective")return s.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(s){this._mercatorProjection.updateGPUdependent(s),this._verticalPerspectiveProjection.updateGPUdependent(s)}getMeshFromTileID(s,d,v,S,D){return this.currentProjection.getMeshFromTileID(s,d,v,S,D)}setProjection(s){this._transitionable.setValue("type",(s==null?void 0:s.type)||"mercator")}updateTransitions(s){this._transitioning=this._transitionable.transitioned(s,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(s){this.properties=this._transitioning.possiblyEvaluate(s)}setErrorQueryLatitudeDegrees(s){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(s),this._mercatorProjection.setErrorQueryLatitudeDegrees(s)}}function pp(C){const s=Gu(C.worldSize,C.center.lat);return 2*Math.PI*s}function Xl(C,s,d,v,S){const D=1/(1<<S),k=s/i.a4*D+v*D,j=i.bx((C/i.a4*D+d*D)*Math.PI*2+Math.PI,2*Math.PI),H=2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI,J=Math.cos(H),et=new Float64Array(3);return et[0]=Math.sin(j)*J,et[1]=Math.sin(H),et[2]=Math.cos(j)*J,et}function Br(C){return function(s,d){const v=Math.cos(d),S=new Float64Array(3);return S[0]=Math.sin(s)*v,S[1]=Math.sin(d),S[2]=Math.cos(s)*v,S}(C.lng*Math.PI/180,C.lat*Math.PI/180)}function Gu(C,s){return C/(2*Math.PI)/Math.cos(s*Math.PI/180)}function cf(C){const s=Math.asin(C[1])/Math.PI*180,d=Math.sqrt(C[0]*C[0]+C[2]*C[2]);if(d>1e-6){const v=C[0]/d,S=Math.acos(C[2]/d),D=(v>0?S:-S)/Math.PI*180;return new i.V(i.W(D,-180,180),s)}return new i.V(0,s)}function la(C){return Math.cos(C*Math.PI/180)}function Gi(C,s){const d=la(C),v=la(s);return i.at(v/d)}function el(C,s){const d=C.rotate(s.bearingInRadians),v=s.zoom+Gi(s.center.lat,0),S=i.bt(1/la(s.center.lat),1/la(Math.min(Math.abs(s.center.lat),60)),i.bw(v,7,3,0,1)),D=360/pp({worldSize:s.worldSize,center:{lat:s.center.lat}});return new i.V(s.center.lng-d.x*D*S,i.an(s.center.lat+d.y*D,-i.ao,i.ao))}function fl(C){const s=.5*C,d=Math.sin(s),v=Math.cos(s);return Math.log(d+v)-Math.log(v-d)}function ml(C,s,d,v){const S=C.lat+d*v;if(Math.abs(d)>1){const D=(Math.sign(C.lat+d)!==Math.sign(C.lat)?-Math.abs(C.lat):Math.abs(C.lat))*Math.PI/180,k=Math.abs(C.lat+d)*Math.PI/180,j=fl(D+v*(k-D)),H=fl(D),J=fl(k);return new i.V(C.lng+s*((j-H)/(J-H)),S)}return new i.V(C.lng+s*v,S)}class kl{constructor(s){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._boundingVolumeFactory=s}swapBuffers(){if(!this._hadAnyChanges)return;const s=this._cachePrevious;this._cachePrevious=this._cache,this._cache=s,this._cache.clear(),this._hadAnyChanges=!1}getTileBoundingVolume(s,d,v,S){const D=`${s.z}_${s.x}_${s.y}_${S!=null&&S.terrain?"t":""}`,k=this._cache.get(D);if(k)return k;const j=this._cachePrevious.get(D);if(j)return this._cache.set(D,j),j;const H=this._boundingVolumeFactory(s,d,v,S);return this._cache.set(D,H),this._hadAnyChanges=!0,H}}class ka{constructor(s,d,v,S){this.min=v,this.max=S,this.points=s,this.planes=d}static fromAabb(s,d){const v=[];for(let S=0;S<8;S++)v.push([1&~S?s[0]:d[0],(S>>1&1)==1?d[1]:s[1],(S>>2&1)==1?d[2]:s[2]]);return new ka(v,[[-1,0,0,d[0]],[1,0,0,-s[0]],[0,-1,0,d[1]],[0,1,0,-s[1]],[0,0,-1,d[2]],[0,0,1,-s[2]]],s,d)}static fromCenterSizeAngles(s,d,v){const S=i.bA([],v[0],v[1],v[2]),D=i.bB([],[d[0],0,0],S),k=i.bB([],[0,d[1],0],S),j=i.bB([],[0,0,d[2]],S),H=[...s],J=[...s];for(let mt=0;mt<8;mt++)for(let dt=0;dt<3;dt++){const Tt=s[dt]+D[dt]*(1&~mt?-1:1)+k[dt]*((mt>>1&1)==1?1:-1)+j[dt]*((mt>>2&1)==1?1:-1);H[dt]=Math.min(H[dt],Tt),J[dt]=Math.max(J[dt],Tt)}const et=[];for(let mt=0;mt<8;mt++){const dt=[...s];i.a$(dt,dt,i.a_([],D,1&~mt?-1:1)),i.a$(dt,dt,i.a_([],k,(mt>>1&1)==1?1:-1)),i.a$(dt,dt,i.a_([],j,(mt>>2&1)==1?1:-1)),et.push(dt)}return new ka(et,[[...D,-i.b4(D,et[0])],[...k,-i.b4(k,et[0])],[...j,-i.b4(j,et[0])],[-D[0],-D[1],-D[2],-i.b4(D,et[7])],[-k[0],-k[1],-k[2],-i.b4(k,et[7])],[-j[0],-j[1],-j[2],-i.b4(j,et[7])]],H,J)}intersectsFrustum(s){let d=!0;const v=this.points.length,S=this.planes.length,D=s.planes.length,k=s.points.length;for(let j=0;j<D;j++){const H=s.planes[j];let J=0;for(let et=0;et<v;et++){const mt=this.points[et];H[0]*mt[0]+H[1]*mt[1]+H[2]*mt[2]+H[3]>=0&&J++}if(J===0)return 0;J<v&&(d=!1)}if(d)return 2;for(let j=0;j<S;j++){const H=this.planes[j];let J=0;for(let et=0;et<k;et++){const mt=s.points[et];H[0]*mt[0]+H[1]*mt[1]+H[2]*mt[2]+H[3]>=0&&J++}if(J===0)return 0}return 1}intersectsPlane(s){const d=this.points.length;let v=0;for(let S=0;S<d;S++){const D=this.points[S];s[0]*D[0]+s[1]*D[1]+s[2]*D[2]+s[3]>=0&&v++}return v===d?2:v===0?0:1}}function Vi(C,s,d){const v=C-s;return v<0?-v:Math.max(0,v-d)}function Jr(C,s,d,v,S){const D=C-d;let k;return k=D<0?Math.min(-D,1+D-S):D>1?Math.min(Math.max(D-S,0),1-D):0,Math.max(k,Vi(s,v,S))}class mn{constructor(){this._boundingVolumeCache=new kl(this._computeTileBoundingVolume)}prepareNextFrame(){this._boundingVolumeCache.swapBuffers()}distanceToTile2d(s,d,v,S){const D=1<<v.z,k=1/D,j=v.x/D,H=v.y/D;let J=2;return J=Math.min(J,Jr(s,d,j,H,k)),J=Math.min(J,Jr(s,d,j+.5,-H-k,k)),J=Math.min(J,Jr(s,d,j+.5,2-H-k,k)),J}getWrap(s,d,v){const S=1<<d.z,D=1/S,k=d.x/S,j=Vi(s.x,k,D),H=Vi(s.x,k-1,D),J=Vi(s.x,k+1,D),et=Math.min(j,H,J);return et===J?1:et===H?-1:0}allowVariableZoom(s,d){return zr(s,d)>4}allowWorldCopies(){return!1}getTileBoundingVolume(s,d,v,S){return this._boundingVolumeCache.getTileBoundingVolume(s,d,v,S)}_computeTileBoundingVolume(s,d,v,S){var D,k;let j=0,H=0;if(S!=null&&S.terrain){const J=new i.a1(s.z,d,s.z,s.x,s.y),et=S.terrain.getMinMaxElevation(J);j=(D=et.minElevation)!==null&&D!==void 0?D:Math.min(0,v),H=(k=et.maxElevation)!==null&&k!==void 0?k:Math.max(0,v)}if(j/=i.bD,H/=i.bD,j+=1,H+=1,s.z<=0)return ka.fromAabb([-H,-H,-H],[H,H,H]);if(s.z===1)return ka.fromAabb([s.x===0?-H:0,s.y===0?0:-H,-H],[s.x===0?0:H,s.y===0?H:0,H]);{const J=[Xl(0,0,s.x,s.y,s.z),Xl(i.a4,0,s.x,s.y,s.z),Xl(i.a4,i.a4,s.x,s.y,s.z),Xl(0,i.a4,s.x,s.y,s.z)],et=[];for(const Je of J)et.push(i.a_([],Je,H));if(H!==j)for(const Je of J)et.push(i.a_([],Je,j));s.y===0&&et.push([0,1,0]),s.y===(1<<s.z)-1&&et.push([0,-1,0]);const mt=[1,1,1],dt=[-1,-1,-1];for(const Je of et)for(let ii=0;ii<3;ii++)mt[ii]=Math.min(mt[ii],Je[ii]),dt[ii]=Math.max(dt[ii],Je[ii]);const Tt=Xl(i.a4/2,i.a4/2,s.x,s.y,s.z),pt=i.b3([],[0,1,0],Tt);i.b2(pt,pt);const It=i.b3([],Tt,pt);i.b2(It,It);const Kt=i.b3([],J[2],J[1]);i.b2(Kt,Kt);const Wt=i.b3([],J[0],J[3]);i.b2(Wt,Wt),et.push(i.a_([],Tt,H)),s.y>=(1<<s.z)/2&&et.push(i.a_([],Xl(i.a4/2,0,s.x,s.y,s.z),H)),s.y<(1<<s.z)/2&&et.push(i.a_([],Xl(i.a4/2,i.a4,s.x,s.y,s.z),H));const ft=il(Tt,et),_e=il(It,et),he=[-Tt[0],-Tt[1],-Tt[2],ft.max],me=[Tt[0],Tt[1],Tt[2],-ft.min],be=[-It[0],-It[1],-It[2],_e.max],de=[It[0],It[1],It[2],-_e.min],Ce=[...Kt,0],Qe=[...Wt,0],Xe=[];return s.y===0?Xe.push(i.bC(Qe,Ce,he),i.bC(Qe,Ce,me)):Xe.push(i.bC(be,Ce,he),i.bC(be,Ce,me),i.bC(be,Qe,he),i.bC(be,Qe,me)),s.y===(1<<s.z)-1?Xe.push(i.bC(Qe,Ce,he),i.bC(Qe,Ce,me)):Xe.push(i.bC(de,Ce,he),i.bC(de,Ce,me),i.bC(de,Qe,he),i.bC(de,Qe,me)),new ka(Xe,[he,me,be,de,Ce,Qe],mt,dt)}}}function il(C,s){let d=1/0,v=-1/0;for(const S of s){const D=i.b4(C,S);d=Math.min(d,D),v=Math.max(v,D)}return{min:d,max:v}}class Qc{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(s){this._helper.setMinZoom(s)}setMaxZoom(s){this._helper.setMaxZoom(s)}setMinPitch(s){this._helper.setMinPitch(s)}setMaxPitch(s){this._helper.setMaxPitch(s)}setRenderWorldCopies(s){this._helper.setRenderWorldCopies(s)}setBearing(s){this._helper.setBearing(s)}setPitch(s){this._helper.setPitch(s)}setRoll(s){this._helper.setRoll(s)}setFov(s){this._helper.setFov(s)}setZoom(s){this._helper.setZoom(s)}setCenter(s){this._helper.setCenter(s)}setElevation(s){this._helper.setElevation(s)}setMinElevationForCurrentTile(s){this._helper.setMinElevationForCurrentTile(s)}setPadding(s){this._helper.setPadding(s)}interpolatePadding(s,d,v){return this._helper.interpolatePadding(s,d,v)}isPaddingEqual(s){return this._helper.isPaddingEqual(s)}resize(s,d){this._helper.resize(s,d)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(s){this._helper.setMaxBounds(s)}setConstrainOverride(s){this._helper.setConstrainOverride(s)}overrideNearFarZ(s,d){this._helper.overrideNearFarZ(s,d)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(s){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),s)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(s){}constructor(s){this._cachedClippingPlane=i.bE(),this._projectionMatrix=i.bi(),this._globeViewProjMatrix32f=i.bh(),this._globeViewProjMatrixNoCorrection=i.bi(),this._globeViewProjMatrixNoCorrectionInverted=i.bi(),this._globeProjMatrixInverted=i.bi(),this._cameraPosition=i.by(),this._globeLatitudeErrorCorrectionRadians=0,this.defaultConstrain=(d,v)=>{const S=i.an(d.lat,-i.ao,i.ao),D=i.an(+v,this.minZoom+Gi(0,S),this.maxZoom);return{center:new i.V(d.lng,S),zoom:D}},this.applyConstrain=(d,v)=>this._helper.applyConstrain(d,v),this._helper=new js({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(d,v)=>this.defaultConstrain(d,v)},s),this._coveringTilesDetailsProvider=new mn}clone(){const s=new Qc;return s.apply(this),s}apply(s,d){this._globeLatitudeErrorCorrectionRadians=d||0,this._helper.apply(s)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const s=i.by();return s[0]=this._cameraPosition[0],s[1]=this._cameraPosition[1],s[2]=this._cameraPosition[2],s}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(s){const{overscaledTileID:d,applyGlobeMatrix:v}=s,S=this._helper.getMercatorTileCoordinates(d);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:S,clippingPlane:this._cachedClippingPlane,projectionTransition:v?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(s){const d=this.pitchInRadians,v=this.cameraToCenterDistance/s,S=Math.sin(d)*v,D=Math.cos(d)*v+1,k=1/Math.sqrt(S*S+D*D)*1;let j=-S,H=D;const J=Math.sqrt(j*j+H*H);j/=J,H/=J;const et=[0,j,H];i.bF(et,et,[0,0,0],-this.bearingInRadians),i.bG(et,et,[0,0,0],-1*this.center.lat*Math.PI/180),i.bH(et,et,[0,0,0],this.center.lng*Math.PI/180);const mt=1/i.b6(et);return i.a_(et,et,mt),[...et,-k*mt]}isLocationOccluded(s){return!this.isSurfacePointVisible(Br(s))}transformLightDirection(s){const d=this._helper._center.lng*Math.PI/180,v=this._helper._center.lat*Math.PI/180,S=Math.cos(v),D=[Math.sin(d)*S,Math.sin(v),Math.cos(d)*S],k=[D[2],0,-D[0]],j=[0,0,0];i.b3(j,k,D),i.b2(k,k),i.b2(j,j);const H=[0,0,0];return i.b2(H,[k[0]*s[0]+j[0]*s[1]+D[0]*s[2],k[1]*s[0]+j[1]*s[1]+D[1]*s[2],k[2]*s[0]+j[2]*s[1]+D[2]*s[2]]),H}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(s,d,v){const S=function(j,H,J){const et=1/(1<<J.z);return new i.aa(j/i.a4*et+J.x*et,H/i.a4*et+J.y*et)}(s,d,v.canonical),D=(k=S.y,[i.bx(S.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-k*Math.PI*2))-.5*Math.PI]);var k;return this.getCircleRadiusCorrection()/Math.cos(D[1])}projectTileCoordinates(s,d,v,S){const D=v.canonical,k=Xl(s,d,D.x,D.y,D.z),j=1+(S?S(s,d):0)/i.bD,H=[k[0]*j,k[1]*j,k[2]*j,1];i.aG(H,H,this._globeViewProjMatrixNoCorrection);const J=this._cachedClippingPlane,et=J[0]*k[0]+J[1]*k[1]+J[2]*k[2]+J[3]<0;return{point:new i.P(H[0]/H[3],H[1]/H[3]),signedDistanceFromCamera:H[3],isOccluded:et}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const s=Gu(this.worldSize,this.center.lat),d=i.bj(),v=i.bj();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*s),i.bd(d,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const S=this.centerOffset;d[8]=2*-S.x/this._helper._width,d[9]=2*S.y/this._helper._height,this._projectionMatrix=i.be(d),this._globeProjMatrixInverted=i.bj(),i.aA(this._globeProjMatrixInverted,d),i.O(d,d,[0,0,-this.cameraToCenterDistance]),i.bf(d,d,this.rollInRadians),i.bg(d,d,-this.pitchInRadians),i.bf(d,d,this.bearingInRadians),i.O(d,d,[0,0,-s]);const D=i.by();D[0]=s,D[1]=s,D[2]=s,i.bg(v,d,this.center.lat*Math.PI/180),i.bI(v,v,-this.center.lng*Math.PI/180),i.Q(v,v,D),this._globeViewProjMatrixNoCorrection=v,i.bg(d,d,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),i.bI(d,d,-this.center.lng*Math.PI/180),i.Q(d,d,D),this._globeViewProjMatrix32f=new Float32Array(d),this._globeViewProjMatrixNoCorrectionInverted=i.bj(),i.aA(this._globeViewProjMatrixNoCorrectionInverted,v);const k=i.by();this._cameraPosition=i.by(),this._cameraPosition[2]=this.cameraToCenterDistance/s,i.bF(this._cameraPosition,this._cameraPosition,k,-this.rollInRadians),i.bG(this._cameraPosition,this._cameraPosition,k,this.pitchInRadians),i.bF(this._cameraPosition,this._cameraPosition,k,-this.bearingInRadians),i.a$(this._cameraPosition,this._cameraPosition,[0,0,1]),i.bG(this._cameraPosition,this._cameraPosition,k,-this.center.lat*Math.PI/180),i.bH(this._cameraPosition,this._cameraPosition,k,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(s);const j=i.be(this._globeViewProjMatrixNoCorrectionInverted);i.Q(j,j,[1,1,-1]),this._cachedFrustum=Ll.fromInvProjectionMatrix(j,1,0,this._cachedClippingPlane,!0)}calculateFogMatrix(s){i.w("calculateFogMatrix is not supported on globe projection.");const d=i.bj();return i.ar(d),d}getVisibleUnwrappedCoordinates(s){return[new i.bb(0,s)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(s){s&&i.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(s,d){if(!this._globeViewProjMatrixNoCorrection)return 1;const v=Br(s);i.a_(v,v,1+d/i.bD);const S=i.bE();return i.aG(S,[v[0],v[1],v[2],1],this._globeViewProjMatrixNoCorrection),S[2]/S[3]}populateCache(s){}getBounds(){const s=.5*this.width,d=.5*this.height,v=[new i.P(0,0),new i.P(s,0),new i.P(this.width,0),new i.P(this.width,d),new i.P(this.width,this.height),new i.P(s,this.height),new i.P(0,this.height),new i.P(0,d)],S=[];for(const mt of v)S.push(this.unprojectScreenPoint(mt));let D=0,k=0,j=0,H=0;const J=this.center;for(const mt of S){const dt=i.bJ(J.lng,mt.lng),Tt=i.bJ(J.lat,mt.lat);dt<k&&(k=dt),dt>D&&(D=dt),Tt<H&&(H=Tt),Tt>j&&(j=Tt)}const et=[J.lng+k,J.lat+H,J.lng+D,J.lat+j];return this.isSurfacePointOnScreen([0,1,0])&&(et[3]=90,et[0]=-180,et[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(et[1]=-90,et[0]=-180,et[2]=180),new xo(et)}calculateCenterFromCameraLngLatAlt(s,d,v,S){return this._helper.calculateCenterFromCameraLngLatAlt(s,d,v,S)}setLocationAtPoint(s,d){const v=Br(this.unprojectScreenPoint(d)),S=Br(s),D=i.by();i.bK(D);const k=i.by();i.bH(k,v,D,-this.center.lng*Math.PI/180),i.bG(k,k,D,this.center.lat*Math.PI/180);const j=S[0]*S[0]+S[2]*S[2],H=k[0]*k[0];if(j<H)return;const J=Math.sqrt(j-H),et=-J,mt=i.bL(S[0],S[2],k[0],J),dt=i.bL(S[0],S[2],k[0],et),Tt=i.by();i.bH(Tt,S,D,-mt);const pt=i.bL(Tt[1],Tt[2],k[1],k[2]),It=i.by();i.bH(It,S,D,-dt);const Kt=i.bL(It[1],It[2],k[1],k[2]),Wt=.5*Math.PI,ft=pt>=-Wt&&pt<=Wt,_e=Kt>=-Wt&&Kt<=Wt;let he,me;if(ft&&_e){const Qe=this.center.lng*Math.PI/180,Xe=this.center.lat*Math.PI/180;i.bM(mt,Qe)+i.bM(pt,Xe)<i.bM(dt,Qe)+i.bM(Kt,Xe)?(he=mt,me=pt):(he=dt,me=Kt)}else if(ft)he=mt,me=pt;else{if(!_e)return;he=dt,me=Kt}const be=he/Math.PI*180,de=me/Math.PI*180,Ce=this.center.lat;this.setCenter(new i.V(be,i.an(de,-90,90))),this.setZoom(this.zoom+Gi(Ce,this.center.lat))}locationToScreenPoint(s,d){const v=Br(s);if(d){const S=d.getElevationForLngLatZoom(s,this._helper._tileZoom);i.a_(v,v,1+S/i.bD)}return this._projectSurfacePointToScreen(v)}_projectSurfacePointToScreen(s){const d=i.bE();return i.aG(d,[...s,1],this._globeViewProjMatrixNoCorrection),d[0]/=d[3],d[1]/=d[3],new i.P((.5*d[0]+.5)*this.width,(.5*-d[1]+.5)*this.height)}screenPointToMercatorCoordinate(s,d){if(d){const v=d.pointCoordinate(s);if(v)return v}return i.aa.fromLngLat(this.unprojectScreenPoint(s))}screenPointToLocation(s,d){var v;return(v=this.screenPointToMercatorCoordinate(s,d))===null||v===void 0?void 0:v.toLngLat()}isPointOnMapSurface(s,d){const v=this._cameraPosition,S=this.getRayDirectionFromPixel(s);return!!this.rayPlanetIntersection(v,S)}getRayDirectionFromPixel(s){const d=i.bE();d[0]=s.x/this.width*2-1,d[1]=-1*(s.y/this.height*2-1),d[2]=1,d[3]=1,i.aG(d,d,this._globeViewProjMatrixNoCorrectionInverted),d[0]/=d[3],d[1]/=d[3],d[2]/=d[3];const v=i.by();v[0]=d[0]-this._cameraPosition[0],v[1]=d[1]-this._cameraPosition[1],v[2]=d[2]-this._cameraPosition[2];const S=i.by();return i.b2(S,v),S}isSurfacePointVisible(s){const d=this._cachedClippingPlane;return d[0]*s[0]+d[1]*s[1]+d[2]*s[2]+d[3]>=0}isSurfacePointOnScreen(s){if(!this.isSurfacePointVisible(s))return!1;const d=i.bE();return i.aG(d,[...s,1],this._globeViewProjMatrixNoCorrection),d[0]/=d[3],d[1]/=d[3],d[2]/=d[3],d[0]>-1&&d[0]<1&&d[1]>-1&&d[1]<1&&d[2]>-1&&d[2]<1}rayPlanetIntersection(s,d){const v=i.b4(s,d),S=i.by(),D=i.by();i.a_(D,d,v),i.b1(S,s,D);const k=1-i.b4(S,S);if(k<0)return null;const j=i.b4(s,s)-1,H=-v+(v<0?1:-1)*Math.sqrt(k),J=j/H,et=H;return{tMin:Math.min(J,et),tMax:Math.max(J,et)}}unprojectScreenPoint(s){const d=this._cameraPosition,v=this.getRayDirectionFromPixel(s),S=this.rayPlanetIntersection(d,v);if(S){const et=i.by();i.a$(et,d,[v[0]*S.tMin,v[1]*S.tMin,v[2]*S.tMin]);const mt=i.by();return i.b2(mt,et),cf(mt)}const D=this._cachedClippingPlane,k=D[0]*v[0]+D[1]*v[1]+D[2]*v[2],j=-i.ba(D,d)/k,H=i.by();if(j>0)i.a$(H,d,[v[0]*j,v[1]*j,v[2]*j]);else{const et=i.by();i.a$(et,d,[2*v[0],2*v[1],2*v[2]]);const mt=i.ba(this._cachedClippingPlane,et);i.b1(H,et,[this._cachedClippingPlane[0]*mt,this._cachedClippingPlane[1]*mt,this._cachedClippingPlane[2]*mt])}const J=function(et){const mt=i.by();return mt[0]=et[0]*-et[3],mt[1]=et[1]*-et[3],mt[2]=et[2]*-et[3],{center:mt,radius:Math.sqrt(1-et[3]*et[3])}}(D);return cf(function(et,mt,dt){const Tt=i.by();i.b1(Tt,dt,et);const pt=i.by();return i.bz(pt,et,Tt,mt/i.b8(Tt)),pt}(J.center,J.radius,H))}getMatrixForModel(s,d){const v=i.V.convert(s),S=1/i.bD,D=i.bi();return i.bI(D,D,v.lng/180*Math.PI),i.bg(D,D,-v.lat/180*Math.PI),i.O(D,D,[0,0,1+d/i.bD]),i.bg(D,D,.5*Math.PI),i.Q(D,D,[S,S,S]),D}getProjectionDataForCustomLayer(s=!0){const d=this.getProjectionData({overscaledTileID:new i.a1(0,0,0,0,0),applyGlobeMatrix:s});return d.tileMercatorCoords=[0,0,1,1],d}getFastPathSimpleProjectionMatrix(s){}}class dn{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(s){this._helper.setMinZoom(s)}setMaxZoom(s){this._helper.setMaxZoom(s)}setMinPitch(s){this._helper.setMinPitch(s)}setMaxPitch(s){this._helper.setMaxPitch(s)}setRenderWorldCopies(s){this._helper.setRenderWorldCopies(s)}setBearing(s){this._helper.setBearing(s)}setPitch(s){this._helper.setPitch(s)}setRoll(s){this._helper.setRoll(s)}setFov(s){this._helper.setFov(s)}setZoom(s){this._helper.setZoom(s)}setCenter(s){this._helper.setCenter(s)}setElevation(s){this._helper.setElevation(s)}setMinElevationForCurrentTile(s){this._helper.setMinElevationForCurrentTile(s)}setPadding(s){this._helper.setPadding(s)}interpolatePadding(s,d,v){return this._helper.interpolatePadding(s,d,v)}isPaddingEqual(s){return this._helper.isPaddingEqual(s)}resize(s,d,v=!0){this._helper.resize(s,d,v)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(s){this._helper.setMaxBounds(s)}setConstrainOverride(s){this._helper.setConstrainOverride(s)}overrideNearFarZ(s,d){this._helper.overrideNearFarZ(s,d)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(s){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),s)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(s,d){this._globeness=s,this._globeLatitudeErrorCorrectionRadians=d,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().prepareNextFrame(),this._mercatorTransform.getCoveringTilesDetailsProvider().prepareNextFrame()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(s){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this.defaultConstrain=(d,v)=>this.currentTransform.defaultConstrain(d,v),this.applyConstrain=(d,v)=>this._helper.applyConstrain(d,v),this._helper=new js({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(d,v)=>this.defaultConstrain(d,v)},s),this._globeness=1,this._mercatorTransform=new vr,this._verticalPerspectiveTransform=new Qc}clone(){const s=new dn;return s._globeness=this._globeness,s._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,s.apply(this),s}apply(s){this._helper.apply(s),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(s){const d=this._mercatorTransform.getProjectionData(s),v=this._verticalPerspectiveTransform.getProjectionData(s);return{mainMatrix:this.isGlobeRendering?v.mainMatrix:d.mainMatrix,clippingPlane:v.clippingPlane,tileMercatorCoords:v.tileMercatorCoords,projectionTransition:s.applyGlobeMatrix?this._globeness:0,fallbackMatrix:d.fallbackMatrix}}isLocationOccluded(s){return this.currentTransform.isLocationOccluded(s)}transformLightDirection(s){return this.currentTransform.transformLightDirection(s)}getPixelScale(){return i.bt(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return i.bt(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(s,d,v){const S=this._mercatorTransform.getPitchedTextCorrection(s,d,v),D=this._verticalPerspectiveTransform.getPitchedTextCorrection(s,d,v);return i.bt(S,D,this._globeness)}projectTileCoordinates(s,d,v,S){return this.currentTransform.projectTileCoordinates(s,d,v,S)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(s){return this.currentTransform.calculateFogMatrix(s)}getVisibleUnwrappedCoordinates(s){return this.currentTransform.getVisibleUnwrappedCoordinates(s)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(s){this._mercatorTransform.recalculateZoomAndCenter(s),this._verticalPerspectiveTransform.recalculateZoomAndCenter(s)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(s,d){return this.currentTransform.lngLatToCameraDepth(s,d)}populateCache(s){this._mercatorTransform.populateCache(s),this._verticalPerspectiveTransform.populateCache(s)}getBounds(){return this.currentTransform.getBounds()}calculateCenterFromCameraLngLatAlt(s,d,v,S){return this._helper.calculateCenterFromCameraLngLatAlt(s,d,v,S)}setLocationAtPoint(s,d){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(s,d),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(s,d),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(s,d){return this.currentTransform.locationToScreenPoint(s,d)}screenPointToMercatorCoordinate(s,d){return this.currentTransform.screenPointToMercatorCoordinate(s,d)}screenPointToLocation(s,d){return this.currentTransform.screenPointToLocation(s,d)}isPointOnMapSurface(s,d){return this.currentTransform.isPointOnMapSurface(s,d)}getRayDirectionFromPixel(s){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(s)}getMatrixForModel(s,d){return this.currentTransform.getMatrixForModel(s,d)}getProjectionDataForCustomLayer(s=!0){const d=this._mercatorTransform.getProjectionDataForCustomLayer(s);if(!this.isGlobeRendering)return d;const v=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(s);return v.fallbackMatrix=d.mainMatrix,v}getFastPathSimpleProjectionMatrix(s){return this.currentTransform.getFastPathSimpleProjectionMatrix(s)}}class ca{get useGlobeControls(){return!0}handlePanInertia(s,d){const v=el(s,d);return Math.abs(v.lng-d.center.lng)>180&&(v.lng=d.center.lng+179.5*Math.sign(v.lng-d.center.lng)),{easingCenter:v,easingOffset:new i.P(0,0)}}handleMapControlsRollPitchBearingZoom(s,d){const v=s.around,S=d.screenPointToLocation(v);s.bearingDelta&&d.setBearing(d.bearing+s.bearingDelta),s.pitchDelta&&d.setPitch(d.pitch+s.pitchDelta),s.rollDelta&&d.setRoll(d.roll+s.rollDelta);const D=d.zoom;s.zoomDelta&&d.setZoom(d.zoom+s.zoomDelta);const k=d.zoom-D;if(k===0)return;const j=i.bJ(d.center.lng,S.lng),H=j/(Math.abs(j/180)+1),J=i.bJ(d.center.lat,S.lat),et=d.getRayDirectionFromPixel(v),mt=d.cameraPosition,dt=-1*i.b4(mt,et),Tt=i.by();i.a$(Tt,mt,[et[0]*dt,et[1]*dt,et[2]*dt]);const pt=i.b6(Tt)-1,It=Math.exp(.5*-Math.max(pt-.3,0)),Kt=Gu(d.worldSize,d.center.lat)/Math.min(d.width,d.height),Wt=i.bw(Kt,.9,.5,1,.25),ft=(1-i.aq(-k))*Math.min(It,Wt),_e=d.center.lat,he=d.zoom,me=new i.V(d.center.lng+H*ft,i.an(d.center.lat+J*ft,-i.ao,i.ao));d.setLocationAtPoint(S,v);const be=d.center,de=i.bw(Math.abs(j),45,85,0,1),Ce=i.bw(Kt,.75,.35,0,1),Qe=Math.pow(Math.max(de,Ce),.25),Xe=i.bJ(be.lng,me.lng),Je=i.bJ(be.lat,me.lat);d.setCenter(new i.V(be.lng+Xe*Qe,be.lat+Je*Qe).wrap()),d.setZoom(he+Gi(_e,d.center.lat))}handleMapControlsPan(s,d,v){if(!s.panDelta)return;const S=d.center.lat,D=d.zoom;d.setCenter(el(s.panDelta,d).wrap()),d.setZoom(D+Gi(S,d.center.lat))}cameraForBoxAndBearing(s,d,v,S,D){const k=Yc(s,d,v,S,D),j=d.left/D.width*2-1,H=(D.width-d.right)/D.width*2-1,J=d.top/D.height*-2+1,et=(D.height-d.bottom)/D.height*-2+1,mt=i.bJ(v.getWest(),v.getEast())<0,dt=mt?v.getEast():v.getWest(),Tt=mt?v.getWest():v.getEast(),pt=Math.max(v.getNorth(),v.getSouth()),It=Math.min(v.getNorth(),v.getSouth()),Kt=dt+.5*i.bJ(dt,Tt),Wt=pt+.5*i.bJ(pt,It),ft=D.clone();ft.setCenter(k.center),ft.setBearing(k.bearing),ft.setPitch(0),ft.setRoll(0),ft.setZoom(k.zoom);const _e=ft.modelViewProjectionMatrix,he=[Br(v.getNorthWest()),Br(v.getNorthEast()),Br(v.getSouthWest()),Br(v.getSouthEast()),Br(new i.V(Tt,Wt)),Br(new i.V(dt,Wt)),Br(new i.V(Kt,pt)),Br(new i.V(Kt,It))],me=Br(k.center);let be=Number.POSITIVE_INFINITY;for(const de of he)j<0&&(be=ca.getLesserNonNegativeNonNull(be,ca.solveVectorScale(de,me,_e,"x",j))),H>0&&(be=ca.getLesserNonNegativeNonNull(be,ca.solveVectorScale(de,me,_e,"x",H))),J>0&&(be=ca.getLesserNonNegativeNonNull(be,ca.solveVectorScale(de,me,_e,"y",J))),et<0&&(be=ca.getLesserNonNegativeNonNull(be,ca.solveVectorScale(de,me,_e,"y",et)));if(Number.isFinite(be)&&be!==0)return k.zoom=ft.zoom+i.at(be),k;Ah()}handleJumpToCenterZoom(s,d){const v=s.center.lat,S=s.applyConstrain(d.center?i.V.convert(d.center):s.center,s.zoom).center;s.setCenter(S.wrap());const D=d.zoom!==void 0?+d.zoom:s.zoom+Gi(v,S.lat);s.zoom!==D&&s.setZoom(D)}handleEaseTo(s,d){const v=s.zoom,S=s.center,D=s.padding,k={roll:s.roll,pitch:s.pitch,bearing:s.bearing},j={roll:d.roll===void 0?s.roll:d.roll,pitch:d.pitch===void 0?s.pitch:d.pitch,bearing:d.bearing===void 0?s.bearing:d.bearing},H=d.zoom!==void 0,J=!s.isPaddingEqual(d.padding);let et=!1;const mt=d.center?i.V.convert(d.center):S,dt=s.applyConstrain(mt,v).center;Vu(s,dt);const Tt=s.clone();Tt.setCenter(dt),Tt.setZoom(H?+d.zoom:v+Gi(S.lat,mt.lat)),Tt.setBearing(d.bearing);const pt=new i.P(i.an(s.centerPoint.x+d.offsetAsPoint.x,0,s.width),i.an(s.centerPoint.y+d.offsetAsPoint.y,0,s.height));Tt.setLocationAtPoint(dt,pt);const It=(d.offset&&d.offsetAsPoint.mag())>0?Tt.center:dt,Kt=H?+d.zoom:v+Gi(S.lat,It.lat),Wt=v+Gi(S.lat,0),ft=Kt+Gi(It.lat,0),_e=i.bJ(S.lng,It.lng),he=i.bJ(S.lat,It.lat),me=i.aq(ft-Wt);return et=Kt!==v,{easeFunc:be=>{if(i.bn(k,j)||Wl({startEulerAngles:k,endEulerAngles:j,tr:s,k:be,useSlerp:k.roll!=j.roll}),J&&s.interpolatePadding(D,d.padding,be),d.around)i.w("Easing around a point is not supported under globe projection."),s.setLocationAtPoint(d.around,d.aroundPoint);else{const de=ft>Wt?Math.min(2,me):Math.max(.5,me),Ce=Math.pow(de,1-be),Qe=ml(S,_e,he,be*Ce);s.setCenter(Qe.wrap())}if(et){const de=i.G.number(Wt,ft,be)+Gi(0,s.center.lat);s.setZoom(de)}},isZooming:et,elevationCenter:It}}handleFlyTo(s,d){const v=d.zoom!==void 0,S=s.center,D=s.zoom,k=s.padding,j=!s.isPaddingEqual(d.padding),H=s.applyConstrain(i.V.convert(d.center||d.locationAtOffset),D).center,J=v?+d.zoom:s.zoom+Gi(s.center.lat,H.lat),et=s.clone();et.setCenter(H),et.setZoom(J),et.setBearing(d.bearing);const mt=new i.P(i.an(s.centerPoint.x+d.offsetAsPoint.x,0,s.width),i.an(s.centerPoint.y+d.offsetAsPoint.y,0,s.height));et.setLocationAtPoint(H,mt);const dt=et.center;Vu(s,dt);const Tt=function(he,me,be){const de=Br(me),Ce=Br(be),Qe=i.b4(de,Ce),Xe=Math.acos(Qe),Je=pp(he);return Xe/(2*Math.PI)*Je}(s,S,dt),pt=D+Gi(S.lat,0),It=J+Gi(dt.lat,0),Kt=i.aq(It-pt);let Wt;if(typeof d.minZoom=="number"){const he=+d.minZoom+Gi(dt.lat,0),me=Math.min(he,pt,It)+Gi(0,dt.lat),be=s.applyConstrain(dt,me).zoom+Gi(dt.lat,0);Wt=i.aq(be-pt)}const ft=i.bJ(S.lng,dt.lng),_e=i.bJ(S.lat,dt.lat);return{easeFunc:(he,me,be,de)=>{const Ce=ml(S,ft,_e,be);j&&s.interpolatePadding(k,d.padding,he);const Qe=he===1?dt:Ce;s.setCenter(Qe.wrap());const Xe=pt+i.at(me);s.setZoom(he===1?J:Xe+Gi(0,Qe.lat))},scaleOfZoom:Kt,targetCenter:dt,scaleOfMinZoom:Wt,pixelPathLength:Tt}}static solveVectorScale(s,d,v,S,D){const k=S==="x"?[v[0],v[4],v[8],v[12]]:[v[1],v[5],v[9],v[13]],j=[v[3],v[7],v[11],v[15]],H=s[0]*k[0]+s[1]*k[1]+s[2]*k[2],J=s[0]*j[0]+s[1]*j[1]+s[2]*j[2],et=d[0]*k[0]+d[1]*k[1]+d[2]*k[2],mt=d[0]*j[0]+d[1]*j[1]+d[2]*j[2];return et+D*J===H+D*mt||j[3]*(H-et)+k[3]*(mt-J)+H*mt==et*J?null:(et+k[3]-D*mt-D*j[3])/(et-H-D*mt+D*J)}static getLesserNonNegativeNonNull(s,d){return d!==null&&d>=0&&d<s?d:s}}class Dc{constructor(s){this._globe=s,this._mercatorCameraHelper=new Ra,this._verticalPerspectiveCameraHelper=new ca}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(s,d){return this.currentHelper.handlePanInertia(s,d)}handleMapControlsRollPitchBearingZoom(s,d){return this.currentHelper.handleMapControlsRollPitchBearingZoom(s,d)}handleMapControlsPan(s,d,v){this.currentHelper.handleMapControlsPan(s,d,v)}cameraForBoxAndBearing(s,d,v,S,D){return this.currentHelper.cameraForBoxAndBearing(s,d,v,S,D)}handleJumpToCenterZoom(s,d){this.currentHelper.handleJumpToCenterZoom(s,d)}handleEaseTo(s,d){return this.currentHelper.handleEaseTo(s,d)}handleFlyTo(s,d){return this.currentHelper.handleFlyTo(s,d)}}const hc=(C,s)=>i.B(C,s&&s.filter(d=>d.identifier!=="source.canvas")),ws=i.bN();class Ho extends i.E{constructor(s,d={}){var v,S;super(),this._rtlPluginLoaded=()=>{for(const k in this.tileManagers){const j=this.tileManagers[k].getSource().type;j!=="vector"&&j!=="geojson"||this.tileManagers[k].reload()}},this.map=s,this.dispatcher=new Xr(Xi(),s._getMapId()),this.dispatcher.registerMessageHandler("GG",(k,j)=>this.getGlyphs(k,j)),this.dispatcher.registerMessageHandler("GI",(k,j)=>this.getImages(k,j)),this.dispatcher.registerMessageHandler("GDA",(k,j)=>this.getDashes(k,j)),this.imageManager=new Ja,this.imageManager.setEventedParent(this);const D=((v=s._container)===null||v===void 0?void 0:v.lang)||typeof document<"u"&&((S=document.documentElement)===null||S===void 0?void 0:S.lang)||void 0;this.glyphManager=new hn(s._requestManager,d.localIdeographFontFamily,D),this.lineAtlas=new Hn(256,512),this.crossTileSymbolIndex=new Js,this._setInitialValues(),this._resetUpdates(),this.dispatcher.broadcast("SR",i.bO()),Da().on(hl,this._rtlPluginLoaded),this.on("data",k=>{if(k.dataType!=="source"||k.sourceDataType!=="metadata")return;const j=this.tileManagers[k.sourceId];if(!j)return;const H=j.getSource();if(H&&H.vectorLayerIds)for(const J in this._layers){const et=this._layers[J];et.source===H.id&&this._validateLayer(et)}})}_setInitialValues(){var s;this._spritesImagesIds={},this._layers={},this._order=[],this.tileManagers={},this.zoomHistory=new i.bP,this._availableImages=[],this._globalState={},this._serializedLayers={},this.stylesheet=null,this.light=null,this.sky=null,this.projection&&(this.projection.destroy(),delete this.projection),this._loaded=!1,this._changed=!1,this._updatedLayers={},this._updatedSources={},this._changedImages={},this._glyphsDidChange=!1,this._updatedPaintProps={},this._layerOrderChanged=!1,this.crossTileSymbolIndex=new(((s=this.crossTileSymbolIndex)===null||s===void 0?void 0:s.constructor)||Object),this.pauseablePlacement=void 0,this.placement=void 0,this.z=0}setGlobalStateProperty(s,d){var v,S,D;this._checkLoaded();const k=d===null?(D=(S=(v=this.stylesheet.state)===null||v===void 0?void 0:v[s])===null||S===void 0?void 0:S.default)!==null&&D!==void 0?D:null:d;if(i.bQ(k,this._globalState[s]))return this;this._globalState[s]=k,this._applyGlobalStateChanges([s])}getGlobalState(){return this._globalState}setGlobalState(s){this._checkLoaded();const d=[];for(const v in s)!i.bQ(this._globalState[v],s[v].default)&&(d.push(v),this._globalState[v]=s[v].default);this._applyGlobalStateChanges(d)}_applyGlobalStateChanges(s){if(s.length===0)return;const d=new Set,v={};for(const S of s){v[S]=this._globalState[S];for(const D in this._layers){const k=this._layers[D],j=k.getLayoutAffectingGlobalStateRefs(),H=k.getPaintAffectingGlobalStateRefs();if(j.has(S)&&d.add(k.source),H.has(S))for(const{name:J,value:et}of H.get(S))this._updatePaintProperty(k,J,et)}}this.dispatcher.broadcast("UGS",v);for(const S in this.tileManagers)d.has(S)&&(this._reloadSource(S),this._changed=!0)}loadURL(s,d={},v){this.fire(new i.l("dataloading",{dataType:"style"})),d.validate=typeof d.validate!="boolean"||d.validate;const S=this.map._requestManager.transformRequest(s,"Style");this._loadStyleRequest=new AbortController;const D=this._loadStyleRequest;i.j(S,this._loadStyleRequest).then(k=>{this._loadStyleRequest=null,this._load(k.data,d,v)}).catch(k=>{this._loadStyleRequest=null,k&&!D.signal.aborted&&this.fire(new i.k(k))})}loadJSON(s,d={},v){this.fire(new i.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,Rr.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,d.validate=d.validate!==!1,this._load(s,d,v)}).catch(()=>{})}loadEmpty(){this.fire(new i.l("dataloading",{dataType:"style"})),this._load(ws,{validate:!1})}_load(s,d,v){var S,D;let k=d.transformStyle?d.transformStyle(v,s):s;if(!d.validate||!hc(this,i.C(k))){k=Object.assign({},k),this._loaded=!0,this.stylesheet=k;for(const j in k.sources)this.addSource(j,k.sources[j],{validate:!1});k.sprite?this._loadSprite(k.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(k.glyphs),this._createLayers(),this.light=new Ys(this.stylesheet.light),this._setProjectionInternal(((S=this.stylesheet.projection)===null||S===void 0?void 0:S.type)||"mercator"),this.sky=new Ps(this.stylesheet.sky),this.map.setTerrain((D=this.stylesheet.terrain)!==null&&D!==void 0?D:null),this.fire(new i.l("data",{dataType:"style"})),this.fire(new i.l("style.load"))}}_createLayers(){var s,d,v;const S=i.bR(this.stylesheet.layers);this.setGlobalState((s=this.stylesheet.state)!==null&&s!==void 0?s:null),this.dispatcher.broadcast("SL",S),this._order=S.map(D=>D.id),this._layers={},this._serializedLayers=null;for(const D of S){const k=i.bS(D,this._globalState);if(k.setEventedParent(this,{layer:{id:D.id}}),this._layers[D.id]=k,i.bT(k)&&this.tileManagers[k.source]){const j=(v=(d=D.paint)===null||d===void 0?void 0:d["raster-fade-duration"])!==null&&v!==void 0?v:k.paint.get("raster-fade-duration");this.tileManagers[k.source].setRasterFadeDuration(j)}}}_loadSprite(s,d=!1,v=void 0){let S;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(D,k,j,H){return i._(this,void 0,void 0,function*(){const J=Os(D),et=j>1?"@2x":"",mt={},dt={};for(const{id:Tt,url:pt}of J){const It=k.transformRequest(Ya(pt,et,".json"),"SpriteJSON");mt[Tt]=i.j(It,H);const Kt=k.transformRequest(Ya(pt,et,".png"),"SpriteImage");dt[Tt]=bo.getImage(Kt,H)}return yield Promise.all([...Object.values(mt),...Object.values(dt)]),function(Tt,pt){return i._(this,void 0,void 0,function*(){const It={};for(const Kt in Tt){It[Kt]={};const Wt=Rr.getImageCanvasContext((yield pt[Kt]).data),ft=(yield Tt[Kt]).data;for(const _e in ft){const{width:he,height:me,x:be,y:de,sdf:Ce,pixelRatio:Qe,stretchX:Xe,stretchY:Je,content:ii,textFitWidth:Ri,textFitHeight:Oi}=ft[_e];It[Kt][_e]={data:null,pixelRatio:Qe,sdf:Ce,stretchX:Xe,stretchY:Je,content:ii,textFitWidth:Ri,textFitHeight:Oi,spriteData:{width:he,height:me,x:be,y:de,context:Wt}}}}return It})}(mt,dt)})}(s,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(D=>{if(this._spriteRequest=null,D)for(const k in D){this._spritesImagesIds[k]=[];const j=this._spritesImagesIds[k]?this._spritesImagesIds[k].filter(H=>!(H in D)):[];for(const H of j)this.imageManager.removeImage(H),this._changedImages[H]=!0;for(const H in D[k]){const J=k==="default"?H:`${k}:${H}`;this._spritesImagesIds[k].push(J),J in this.imageManager.images?this.imageManager.updateImage(J,D[k][H],!1):this.imageManager.addImage(J,D[k][H]),d&&(this._changedImages[J]=!0)}}}).catch(D=>{this._spriteRequest=null,S=D,this.fire(new i.k(S))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),d&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"})),v&&v(S)})}_unloadSprite(){for(const s of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(s),this._changedImages[s]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"}))}_validateLayer(s){const d=this.tileManagers[s.source];if(!d)return;const v=s.sourceLayer;if(!v)return;const S=d.getSource();(S.type==="geojson"||S.vectorLayerIds&&S.vectorLayerIds.indexOf(v)===-1)&&this.fire(new i.k(new Error(`Source layer "${v}" does not exist on source "${S.id}" as specified by style layer "${s.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const s in this.tileManagers)if(!this.tileManagers[s].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(s,d=!1){const v=this._serializedAllLayers();if(!s||s.length===0)return Object.values(d?i.bU(v):v);const S=[];for(const D of s)if(v[D]){const k=d?i.bU(v[D]):v[D];S.push(k)}return S}_serializedAllLayers(){let s=this._serializedLayers;if(s)return s;s=this._serializedLayers={};const d=Object.keys(this._layers);for(const v of d){const S=this._layers[v];S.type!=="custom"&&(s[v]=S.serialize())}return s}hasTransitions(){var s,d,v;if(!((s=this.light)===null||s===void 0)&&s.hasTransition()||!((d=this.sky)===null||d===void 0)&&d.hasTransition()||!((v=this.projection)===null||v===void 0)&&v.hasTransition())return!0;for(const S in this.tileManagers)if(this.tileManagers[S].hasTransition())return!0;for(const S in this._layers)if(this._layers[S].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(s){if(!this._loaded)return;const d=this._changed;if(d){const S=Object.keys(this._updatedLayers),D=Object.keys(this._removedLayers);(S.length||D.length)&&this._updateWorkerLayers(S,D);for(const k in this._updatedSources){const j=this._updatedSources[k];if(j==="reload")this._reloadSource(k);else{if(j!=="clear")throw new Error(`Invalid action ${j}`);this._clearSource(k)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const k in this._updatedPaintProps)this._layers[k].updateTransitions(s);this.light.updateTransitions(s),this.sky.updateTransitions(s),this._resetUpdates()}const v={};for(const S in this.tileManagers){const D=this.tileManagers[S];v[S]=D.used,D.used=!1}for(const S of this._order){const D=this._layers[S];D.recalculate(s,this._availableImages),!D.isHidden(s.zoom)&&D.source&&(this.tileManagers[D.source].used=!0)}for(const S in v){const D=this.tileManagers[S];!!v[S]!=!!D.used&&D.fire(new i.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:S}))}this.light.recalculate(s),this.sky.recalculate(s),this.projection.recalculate(s),this.z=s.zoom,d&&this.fire(new i.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const s=Object.keys(this._changedImages);if(s.length){for(const d in this.tileManagers)this.tileManagers[d].reloadTilesForDependencies(["icons","patterns"],s);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const s in this.tileManagers)this.tileManagers[s].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(s,d){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(s,!1),removedIds:d})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(s,d={}){var v;this._checkLoaded();const S=this.serialize();if(s=d.transformStyle?d.transformStyle(S,s):s,((v=d.validate)===null||v===void 0||v)&&hc(this,i.C(s)))return!1;(s=i.bU(s)).layers=i.bR(s.layers);const D=i.bV(S,s),k=this._getOperationsToPerform(D);if(k.unimplemented.length>0)throw new Error(`Unimplemented: ${k.unimplemented.join(", ")}.`);if(k.operations.length===0)return!1;for(const j of k.operations)j();return this.stylesheet=s,this._serializedLayers=null,!0}_getOperationsToPerform(s){const d=[],v=[];for(const S of s)switch(S.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":d.push(()=>this.addLayer.apply(this,S.args));break;case"removeLayer":d.push(()=>this.removeLayer.apply(this,S.args));break;case"setPaintProperty":d.push(()=>this.setPaintProperty.apply(this,S.args));break;case"setLayoutProperty":d.push(()=>this.setLayoutProperty.apply(this,S.args));break;case"setFilter":d.push(()=>this.setFilter.apply(this,S.args));break;case"addSource":d.push(()=>this.addSource.apply(this,S.args));break;case"removeSource":d.push(()=>this.removeSource.apply(this,S.args));break;case"setLayerZoomRange":d.push(()=>this.setLayerZoomRange.apply(this,S.args));break;case"setLight":d.push(()=>this.setLight.apply(this,S.args));break;case"setGeoJSONSourceData":d.push(()=>this.setGeoJSONSourceData.apply(this,S.args));break;case"setGlyphs":d.push(()=>this.setGlyphs.apply(this,S.args));break;case"setSprite":d.push(()=>this.setSprite.apply(this,S.args));break;case"setTerrain":d.push(()=>this.map.setTerrain.apply(this,S.args));break;case"setSky":d.push(()=>this.setSky.apply(this,S.args));break;case"setProjection":this.setProjection.apply(this,S.args);break;case"setGlobalState":d.push(()=>this.setGlobalState.apply(this,S.args));break;case"setTransition":d.push(()=>{});break;default:v.push(S.command)}return{operations:d,unimplemented:v}}addImage(s,d){if(this.getImage(s))return this.fire(new i.k(new Error(`An image named "${s}" already exists.`)));this.imageManager.addImage(s,d),this._afterImageUpdated(s)}updateImage(s,d){this.imageManager.updateImage(s,d)}getImage(s){return this.imageManager.getImage(s)}removeImage(s){if(!this.getImage(s))return this.fire(new i.k(new Error(`An image named "${s}" does not exist.`)));this.imageManager.removeImage(s),this._afterImageUpdated(s)}_afterImageUpdated(s){this._availableImages=this.imageManager.listImages(),this._changedImages[s]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(s,d,v={}){if(this._checkLoaded(),this.tileManagers[s]!==void 0)throw new Error(`Source "${s}" already exists.`);if(!d.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(d).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(d.type)>=0&&this._validate(i.C.source,`sources.${s}`,d,null,v))return;this.map&&this.map._collectResourceTiming&&(d.collectResourceTiming=!0);const S=this.tileManagers[s]=new An(s,d,this.dispatcher);S.style=this,S.setEventedParent(this,()=>({isSourceLoaded:S.loaded(),source:S.serialize(),sourceId:s})),S.onAdd(this.map),this._changed=!0}removeSource(s){if(this._checkLoaded(),this.tileManagers[s]===void 0)throw new Error("There is no source with this ID");for(const v in this._layers)if(this._layers[v].source===s)return this.fire(new i.k(new Error(`Source "${s}" cannot be removed while layer "${v}" is using it.`)));const d=this.tileManagers[s];delete this.tileManagers[s],delete this._updatedSources[s],d.fire(new i.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:s})),d.setEventedParent(null),d.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(s,d){if(this._checkLoaded(),this.tileManagers[s]===void 0)throw new Error(`There is no source with this ID=${s}`);const v=this.tileManagers[s].getSource();if(v.type!=="geojson")throw new Error(`geojsonSource.type is ${v.type}, which is !== 'geojson`);v.setData(d),this._changed=!0}getSource(s){return this.tileManagers[s]&&this.tileManagers[s].getSource()}addLayer(s,d,v={}){this._checkLoaded();const S=s.id;if(this.getLayer(S))return void this.fire(new i.k(new Error(`Layer "${S}" already exists on this map.`)));let D;if(s.type==="custom"){if(hc(this,i.bW(s)))return;D=i.bS(s,this._globalState)}else{if("source"in s&&typeof s.source=="object"&&(this.addSource(S,s.source),s=i.bU(s),s=i.e(s,{source:S})),this._validate(i.C.layer,`layers.${S}`,s,{arrayIndex:-1},v))return;D=i.bS(s,this._globalState),this._validateLayer(D),D.setEventedParent(this,{layer:{id:S}})}const k=d?this._order.indexOf(d):this._order.length;if(d&&k===-1)this.fire(new i.k(new Error(`Cannot add layer "${S}" before non-existing layer "${d}".`)));else{if(this._order.splice(k,0,S),this._layerOrderChanged=!0,this._layers[S]=D,this._removedLayers[S]&&D.source&&D.type!=="custom"){const j=this._removedLayers[S];delete this._removedLayers[S],j.type!==D.type?this._updatedSources[D.source]="clear":(this._updatedSources[D.source]="reload",this.tileManagers[D.source].pause())}this._updateLayer(D),D.onAdd&&D.onAdd(this.map)}}moveLayer(s,d){if(this._checkLoaded(),this._changed=!0,!this._layers[s])return void this.fire(new i.k(new Error(`The layer '${s}' does not exist in the map's style and cannot be moved.`)));if(s===d)return;const v=this._order.indexOf(s);this._order.splice(v,1);const S=d?this._order.indexOf(d):this._order.length;d&&S===-1?this.fire(new i.k(new Error(`Cannot move layer "${s}" before non-existing layer "${d}".`))):(this._order.splice(S,0,s),this._layerOrderChanged=!0)}removeLayer(s){this._checkLoaded();const d=this._layers[s];if(!d)return void this.fire(new i.k(new Error(`Cannot remove non-existing layer "${s}".`)));d.setEventedParent(null);const v=this._order.indexOf(s);this._order.splice(v,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[s]=d,delete this._layers[s],this._serializedLayers&&delete this._serializedLayers[s],delete this._updatedLayers[s],delete this._updatedPaintProps[s],d.onRemove&&d.onRemove(this.map)}getLayer(s){return this._layers[s]}getLayersOrder(){return[...this._order]}hasLayer(s){return s in this._layers}setLayerZoomRange(s,d,v){this._checkLoaded();const S=this.getLayer(s);S?S.minzoom===d&&S.maxzoom===v||(d!=null&&(S.minzoom=d),v!=null&&(S.maxzoom=v),this._updateLayer(S)):this.fire(new i.k(new Error(`Cannot set the zoom range of non-existing layer "${s}".`)))}setFilter(s,d,v={}){this._checkLoaded();const S=this.getLayer(s);if(S){if(!i.bQ(S.filter,d))return d==null?(S.setFilter(void 0),void this._updateLayer(S)):void(this._validate(i.C.filter,`layers.${S.id}.filter`,d,null,v)||(S.setFilter(i.bU(d)),this._updateLayer(S)))}else this.fire(new i.k(new Error(`Cannot filter non-existing layer "${s}".`)))}getFilter(s){return i.bU(this.getLayer(s).filter)}setLayoutProperty(s,d,v,S={}){this._checkLoaded();const D=this.getLayer(s);D?i.bQ(D.getLayoutProperty(d),v)||(D.setLayoutProperty(d,v,S),this._updateLayer(D)):this.fire(new i.k(new Error(`Cannot style non-existing layer "${s}".`)))}getLayoutProperty(s,d){const v=this.getLayer(s);if(v)return v.getLayoutProperty(d);this.fire(new i.k(new Error(`Cannot get style of non-existing layer "${s}".`)))}setPaintProperty(s,d,v,S={}){this._checkLoaded();const D=this.getLayer(s);D?i.bQ(D.getPaintProperty(d),v)||this._updatePaintProperty(D,d,v,S):this.fire(new i.k(new Error(`Cannot style non-existing layer "${s}".`)))}_updatePaintProperty(s,d,v,S={}){s.setPaintProperty(d,v,S)&&this._updateLayer(s),i.bT(s)&&d==="raster-fade-duration"&&this.tileManagers[s.source].setRasterFadeDuration(v),this._changed=!0,this._updatedPaintProps[s.id]=!0,this._serializedLayers=null}getPaintProperty(s,d){return this.getLayer(s).getPaintProperty(d)}setFeatureState(s,d){this._checkLoaded();const v=s.source,S=s.sourceLayer,D=this.tileManagers[v];if(D===void 0)return void this.fire(new i.k(new Error(`The source '${v}' does not exist in the map's style.`)));const k=D.getSource().type;k==="geojson"&&S?this.fire(new i.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):k!=="vector"||S?(s.id===void 0&&this.fire(new i.k(new Error("The feature id parameter must be provided."))),D.setFeatureState(S,s.id,d)):this.fire(new i.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(s,d){this._checkLoaded();const v=s.source,S=this.tileManagers[v];if(S===void 0)return void this.fire(new i.k(new Error(`The source '${v}' does not exist in the map's style.`)));const D=S.getSource().type,k=D==="vector"?s.sourceLayer:void 0;D!=="vector"||k?d&&typeof s.id!="string"&&typeof s.id!="number"?this.fire(new i.k(new Error("A feature id is required to remove its specific state property."))):S.removeFeatureState(k,s.id,d):this.fire(new i.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(s){this._checkLoaded();const d=s.source,v=s.sourceLayer,S=this.tileManagers[d];if(S!==void 0)return S.getSource().type!=="vector"||v?(s.id===void 0&&this.fire(new i.k(new Error("The feature id parameter must be provided."))),S.getFeatureState(v,s.id)):void this.fire(new i.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new i.k(new Error(`The source '${d}' does not exist in the map's style.`)))}getTransition(){return i.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const s=i.bX(this.tileManagers,D=>D.serialize()),d=this._serializeByIds(this._order,!0),v=this.map.getTerrain()||void 0,S=this.stylesheet;return i.bY({version:S.version,name:S.name,metadata:S.metadata,light:S.light,sky:S.sky,center:S.center,zoom:S.zoom,bearing:S.bearing,pitch:S.pitch,sprite:S.sprite,glyphs:S.glyphs,transition:S.transition,projection:S.projection,sources:s,layers:d,terrain:v},D=>D!==void 0)}_updateLayer(s){this._updatedLayers[s.id]=!0,s.source&&!this._updatedSources[s.source]&&this.tileManagers[s.source].getSource().type!=="raster"&&(this._updatedSources[s.source]="reload",this.tileManagers[s.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(s){const d=k=>this._layers[k].type==="fill-extrusion",v={},S=[];for(let k=this._order.length-1;k>=0;k--){const j=this._order[k];if(d(j)){v[j]=k;for(const H of s){const J=H[j];if(J)for(const et of J)S.push(et)}}}S.sort((k,j)=>j.intersectionZ-k.intersectionZ);const D=[];for(let k=this._order.length-1;k>=0;k--){const j=this._order[k];if(d(j))for(let H=S.length-1;H>=0;H--){const J=S[H].feature;if(v[J.layer.id]<k)break;D.push(J),S.pop()}else for(const H of s){const J=H[j];if(J)for(const et of J)D.push(et.feature)}}return D}queryRenderedFeatures(s,d,v){d&&d.filter&&this._validate(i.C.filter,"queryRenderedFeatures.filter",d.filter,null,d);const S={};if(d&&d.layers){if(!(Array.isArray(d.layers)||d.layers instanceof Set))return this.fire(new i.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const J of d.layers){const et=this._layers[J];if(!et)return this.fire(new i.k(new Error(`The layer '${J}' does not exist in the map's style and cannot be queried for features.`))),[];S[et.source]=!0}}const D=[];d.availableImages=this._availableImages;const k=this._serializedAllLayers(),j=d.layers instanceof Set?d.layers:Array.isArray(d.layers)?new Set(d.layers):null,H=Object.assign(Object.assign({},d),{layers:j,globalState:this._globalState});for(const J in this.tileManagers)d.layers&&!S[J]||D.push(On(this.tileManagers[J],this._layers,k,s,H,v,this.map.terrain?(et,mt,dt)=>this.map.terrain.getElevation(et,mt,dt):void 0));return this.placement&&D.push(function(J,et,mt,dt,Tt,pt,It){const Kt={},Wt=pt.queryRenderedSymbols(dt),ft=[];for(const _e of Object.keys(Wt).map(Number))ft.push(It[_e]);ft.sort(ho);for(const _e of ft){const he=_e.featureIndex.lookupSymbolFeatures(Wt[_e.bucketInstanceId],et,_e.bucketIndex,_e.sourceLayerIndex,{filterSpec:Tt.filter,globalState:Tt.globalState},Tt.layers,Tt.availableImages,J);for(const me in he){const be=Kt[me]=Kt[me]||[],de=he[me];de.sort((Ce,Qe)=>{const Xe=_e.featureSortOrder;if(Xe){const Je=Xe.indexOf(Ce.featureIndex);return Xe.indexOf(Qe.featureIndex)-Je}return Qe.featureIndex-Ce.featureIndex});for(const Ce of de)be.push(Ce)}}return function(_e,he,me){for(const be in _e)for(const de of _e[be])ds(de,me[he[be].source]);return _e}(Kt,J,mt)}(this._layers,k,this.tileManagers,s,H,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(D)}querySourceFeatures(s,d){d!=null&&d.filter&&this._validate(i.C.filter,"querySourceFeatures.filter",d.filter,null,d);const v=this.tileManagers[s];return v?function(S,D){const k=S.getRenderableIds().map(J=>S.getTileByID(J)),j=[],H={};for(let J=0;J<k.length;J++){const et=k[J],mt=et.tileID.canonical.key;H[mt]||(H[mt]=!0,et.querySourceFeatures(j,D))}return j}(v,d?Object.assign(Object.assign({},d),{globalState:this._globalState}):{globalState:this._globalState}):[]}getLight(){return this.light.getLight()}setLight(s,d={}){this._checkLoaded();const v=this.light.getLight();let S=!1;for(const k in s)if(!i.bQ(s[k],v[k])){S=!0;break}if(!S)return;const D={now:Ci(),transition:i.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(s,d),this.light.updateTransitions(D)}getProjection(){var s;return(s=this.stylesheet)===null||s===void 0?void 0:s.projection}setProjection(s){if(this._checkLoaded(),this.projection){if(this.projection.name===s.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=s,this._setProjectionInternal(s.type)}getSky(){var s;return(s=this.stylesheet)===null||s===void 0?void 0:s.sky}setSky(s,d={}){this._checkLoaded();const v=this.getSky();let S=!1;if(!s&&!v)return;if(s&&!v)S=!0;else if(!s&&v)S=!0;else for(const k in s)if(!i.bQ(s[k],v[k])){S=!0;break}if(!S)return;const D={now:Ci(),transition:i.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=s,this.sky.setSky(s,d),this.sky.updateTransitions(D)}_setProjectionInternal(s){const d=function(v,S){const D={constrainOverride:S};if(Array.isArray(v)){const k=new Ph({type:v});return{projection:k,transform:new dn(D),cameraHelper:new Dc(k)}}switch(v){case"mercator":return{projection:new Us,transform:new vr(D),cameraHelper:new Ra};case"globe":{const k=new Ph({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:k,transform:new dn(D),cameraHelper:new Dc(k)}}case"vertical-perspective":return{projection:new Rl,transform:new Qc(D),cameraHelper:new ca};default:return i.w(`Unknown projection name: ${v}. Falling back to mercator projection.`),{projection:new Us,transform:new vr(D),cameraHelper:new Ra}}}(s,this.map.transformConstrain);this.projection=d.projection,this.map.migrateProjection(d.transform,d.cameraHelper);for(const v in this.tileManagers)this.tileManagers[v].reload()}_validate(s,d,v,S,D={}){return(!D||D.validate!==!1)&&hc(this,s.call(i.C,i.e({key:d,style:this.serialize(),value:v,styleSpec:i.u},S)))}_remove(s=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Da().off(hl,this._rtlPluginLoaded);for(const d in this._layers)this._layers[d].setEventedParent(null);for(const d in this.tileManagers){const v=this.tileManagers[d];v.setEventedParent(null),v.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),s&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(s)}_clearSource(s){this.tileManagers[s].clearTiles()}_reloadSource(s){this.tileManagers[s].resume(),this.tileManagers[s].reload()}_updateSources(s){for(const d in this.tileManagers)this.tileManagers[d].update(s,this.map.terrain)}_generateCollisionBoxes(){for(const s in this.tileManagers)this._reloadSource(s)}_updatePlacement(s,d,v,S,D=!1){let k=!1,j=!1;const H={};for(const J of this._order){const et=this._layers[J];if(et.type!=="symbol")continue;if(!H[et.source]){const dt=this.tileManagers[et.source];H[et.source]=dt.getRenderableIds(!0).map(Tt=>dt.getTileByID(Tt)).sort((Tt,pt)=>pt.tileID.overscaledZ-Tt.tileID.overscaledZ||(Tt.tileID.isLessThan(pt.tileID)?-1:1))}const mt=this.crossTileSymbolIndex.addLayer(et,H[et.source],s.center.lng);k=k||mt}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((D=D||this._layerOrderChanged||v===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(Ci(),s.zoom))&&(this.pauseablePlacement=new Nu(s,this.map.terrain,this._order,D,d,v,S,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,H),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(Ci()),j=!0),k&&this.pauseablePlacement.placement.setStale()),j||k)for(const J of this._order){const et=this._layers[J];et.type==="symbol"&&this.placement.updateLayerOpacities(et,H[et.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(Ci())}_releaseSymbolFadeTiles(){for(const s in this.tileManagers)this.tileManagers[s].releaseSymbolFadeTiles()}getImages(s,d){return i._(this,void 0,void 0,function*(){const v=yield this.imageManager.getImages(d.icons);this._updateTilesForChangedImages();const S=this.tileManagers[d.source];return S&&S.setDependencies(d.tileID.key,d.type,d.icons),v})}getGlyphs(s,d){return i._(this,void 0,void 0,function*(){const v=yield this.glyphManager.getGlyphs(d.stacks),S=this.tileManagers[d.source];return S&&S.setDependencies(d.tileID.key,d.type,[""]),v})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(s,d={}){this._checkLoaded(),s&&this._validate(i.C.glyphs,"glyphs",s,null,d)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=s,this.glyphManager.entries={},this.glyphManager.setURL(s))}getDashes(s,d){return i._(this,void 0,void 0,function*(){const v={};for(const[S,D]of Object.entries(d.dashes))v[S]=this.lineAtlas.getDash(D.dasharray,D.round);return v})}addSprite(s,d,v={},S){this._checkLoaded();const D=[{id:s,url:d}],k=[...Os(this.stylesheet.sprite),...D];this._validate(i.C.sprite,"sprite",k,null,v)||(this.stylesheet.sprite=k,this._loadSprite(D,!0,S))}removeSprite(s){this._checkLoaded();const d=Os(this.stylesheet.sprite);if(d.find(v=>v.id===s)){if(this._spritesImagesIds[s])for(const v of this._spritesImagesIds[s])this.imageManager.removeImage(v),this._changedImages[v]=!0;d.splice(d.findIndex(v=>v.id===s),1),this.stylesheet.sprite=d.length>0?d:void 0,delete this._spritesImagesIds[s],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new i.l("data",{dataType:"style"}))}else this.fire(new i.k(new Error(`Sprite "${s}" doesn't exists on this map.`)))}getSprite(){return Os(this.stylesheet.sprite)}setSprite(s,d={},v){this._checkLoaded(),s&&this._validate(i.C.sprite,"sprite",s,null,d)||(this.stylesheet.sprite=s,s?this._loadSprite(s,!0,v):(this._unloadSprite(),v&&v(null)))}destroy(){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null);for(const s in this.tileManagers){const d=this.tileManagers[s];if(d.setEventedParent(null),d._tiles){for(const v in d._tiles)d._tiles[v].unloadVectorData();d._tiles={}}d._cache.reset(),d.onRemove(this.map)}this.tileManagers={},this.imageManager&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this._availableImages=[],this._spritesImagesIds={}),this.glyphManager&&this.glyphManager.destroy();for(const s in this._layers){const d=this._layers[s];d.setEventedParent(null),d.onRemove&&d.onRemove(this.map)}this._setInitialValues(),this.setEventedParent(null),this.dispatcher.unregisterMessageHandler("GG"),this.dispatcher.unregisterMessageHandler("GI"),this.dispatcher.unregisterMessageHandler("GDA"),this.dispatcher.remove(!0),this._listeners={},this._oneTimeListeners={}}}var zc=i.aT([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Id{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(s,d,v,S,D,k,j,H,J){this.context=s;let et=this.boundPaintVertexBuffers.length!==S.length;for(let mt=0;!et&&mt<S.length;mt++)this.boundPaintVertexBuffers[mt]!==S[mt]&&(et=!0);!this.vao||this.boundProgram!==d||this.boundLayoutVertexBuffer!==v||et||this.boundIndexBuffer!==D||this.boundVertexOffset!==k||this.boundDynamicVertexBuffer!==j||this.boundDynamicVertexBuffer2!==H||this.boundDynamicVertexBuffer3!==J?this.freshBind(d,v,S,D,k,j,H,J):(s.bindVertexArray.set(this.vao),j&&j.bind(),D&&D.dynamicDraw&&D.bind(),H&&H.bind(),J&&J.bind())}freshBind(s,d,v,S,D,k,j,H){const J=s.numAttributes,et=this.context,mt=et.gl;this.vao&&this.destroy(),this.vao=et.createVertexArray(),et.bindVertexArray.set(this.vao),this.boundProgram=s,this.boundLayoutVertexBuffer=d,this.boundPaintVertexBuffers=v,this.boundIndexBuffer=S,this.boundVertexOffset=D,this.boundDynamicVertexBuffer=k,this.boundDynamicVertexBuffer2=j,this.boundDynamicVertexBuffer3=H,d.enableAttributes(mt,s);for(const dt of v)dt.enableAttributes(mt,s);k&&k.enableAttributes(mt,s),j&&j.enableAttributes(mt,s),H&&H.enableAttributes(mt,s),d.bind(),d.setVertexAttribPointers(mt,s,D);for(const dt of v)dt.bind(),dt.setVertexAttribPointers(mt,s,D);k&&(k.bind(),k.setVertexAttribPointers(mt,s,D)),S&&S.bind(),j&&(j.bind(),j.setVertexAttribPointers(mt,s,D)),H&&(H.bind(),H.setVertexAttribPointers(mt,s,D)),et.currentNumAttributes=J}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Ed=(C,s,d,v,S)=>({u_texture:0,u_ele_delta:C,u_fog_matrix:s,u_fog_color:d?d.properties.get("fog-color"):i.bo.white,u_fog_ground_blend:d?d.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:S?0:d?d.calculateFogBlendOpacity(v):0,u_horizon_color:d?d.properties.get("horizon-color"):i.bo.white,u_horizon_fog_blend:d?d.properties.get("horizon-fog-blend"):1,u_is_globe_mode:S?1:0}),th={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function uc(C){const s=[];for(let d=0;d<C.length;d++){if(C[d]===null)continue;const v=C[d].split(" ");s.push(v.pop())}return s}class hf{constructor(s,d,v,S,D,k,j,H,J=[]){const et=s.gl;this.program=et.createProgram();const mt=uc(d.staticAttributes),dt=v?v.getBinderAttributes():[],Tt=mt.concat(dt),pt=oa.prelude.staticUniforms?uc(oa.prelude.staticUniforms):[],It=j.staticUniforms?uc(j.staticUniforms):[],Kt=d.staticUniforms?uc(d.staticUniforms):[],Wt=v?v.getBinderUniforms():[],ft=pt.concat(It).concat(Kt).concat(Wt),_e=[];for(const Xe of ft)_e.indexOf(Xe)<0&&_e.push(Xe);const he=v?v.defines():[];tl(et)&&he.unshift("#version 300 es"),D&&he.push("#define OVERDRAW_INSPECTOR;"),k&&he.push("#define TERRAIN3D;"),H&&he.push(H),J&&he.push(...J);let me=he.concat(oa.prelude.fragmentSource,j.fragmentSource,d.fragmentSource).join(`
`),be=he.concat(oa.prelude.vertexSource,j.vertexSource,d.vertexSource).join(`
`);tl(et)||(me=function(Xe){return Xe.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")}(me),be=function(Xe){return Xe.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")}(be));const de=et.createShader(et.FRAGMENT_SHADER);if(et.isContextLost())return void(this.failedToCreate=!0);if(et.shaderSource(de,me),et.compileShader(de),!et.getShaderParameter(de,et.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${et.getShaderInfoLog(de)}`);et.attachShader(this.program,de);const Ce=et.createShader(et.VERTEX_SHADER);if(et.isContextLost())return void(this.failedToCreate=!0);if(et.shaderSource(Ce,be),et.compileShader(Ce),!et.getShaderParameter(Ce,et.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${et.getShaderInfoLog(Ce)}`);et.attachShader(this.program,Ce),this.attributes={};const Qe={};this.numAttributes=Tt.length;for(let Xe=0;Xe<this.numAttributes;Xe++)Tt[Xe]&&(et.bindAttribLocation(this.program,Xe,Tt[Xe]),this.attributes[Tt[Xe]]=Xe);if(et.linkProgram(this.program),!et.getProgramParameter(this.program,et.LINK_STATUS))throw new Error(`Program failed to link: ${et.getProgramInfoLog(this.program)}`);et.deleteShader(Ce),et.deleteShader(de);for(let Xe=0;Xe<_e.length;Xe++){const Je=_e[Xe];if(Je&&!Qe[Je]){const ii=et.getUniformLocation(this.program,Je);ii&&(Qe[Je]=ii)}}this.fixedUniforms=S(s,Qe),this.terrainUniforms=((Xe,Je)=>({u_depth:new i.bZ(Xe,Je.u_depth),u_terrain:new i.bZ(Xe,Je.u_terrain),u_terrain_dim:new i.bp(Xe,Je.u_terrain_dim),u_terrain_matrix:new i.b$(Xe,Je.u_terrain_matrix),u_terrain_unpack:new i.c0(Xe,Je.u_terrain_unpack),u_terrain_exaggeration:new i.bp(Xe,Je.u_terrain_exaggeration)}))(s,Qe),this.projectionUniforms=((Xe,Je)=>({u_projection_matrix:new i.b$(Xe,Je.u_projection_matrix),u_projection_tile_mercator_coords:new i.c0(Xe,Je.u_projection_tile_mercator_coords),u_projection_clipping_plane:new i.c0(Xe,Je.u_projection_clipping_plane),u_projection_transition:new i.bp(Xe,Je.u_projection_transition),u_projection_fallback_matrix:new i.b$(Xe,Je.u_projection_fallback_matrix)}))(s,Qe),this.binderUniforms=v?v.getUniforms(s,Qe):[]}draw(s,d,v,S,D,k,j,H,J,et,mt,dt,Tt,pt,It,Kt,Wt,ft,_e){const he=s.gl;if(this.failedToCreate)return;if(s.program.set(this.program),s.setDepthMode(v),s.setStencilMode(S),s.setColorMode(D),s.setCullFace(k),H){s.activeTexture.set(he.TEXTURE2),he.bindTexture(he.TEXTURE_2D,H.depthTexture),s.activeTexture.set(he.TEXTURE3),he.bindTexture(he.TEXTURE_2D,H.texture);for(const be in this.terrainUniforms)this.terrainUniforms[be].set(H[be])}if(J)for(const be in J)this.projectionUniforms[th[be]].set(J[be]);if(j)for(const be in this.fixedUniforms)this.fixedUniforms[be].set(j[be]);Kt&&Kt.setUniforms(s,this.binderUniforms,pt,{zoom:It});let me=0;switch(d){case he.LINES:me=2;break;case he.TRIANGLES:me=3;break;case he.LINE_STRIP:me=1}for(const be of Tt.get()){const de=be.vaos||(be.vaos={});(de[et]||(de[et]=new Id)).bind(s,this,mt,Kt?Kt.getPaintVertexBuffers():[],dt,be.vertexOffset,Wt,ft,_e),he.drawElements(d,be.primitiveLength*me,he.UNSIGNED_SHORT,be.primitiveOffset*me*2)}}}function eh(C,s,d){const v=1/i.aM(d,1,s.transform.tileZoom),S=Math.pow(2,d.tileID.overscaledZ),D=d.tileSize*Math.pow(2,s.transform.tileZoom)/S,k=D*(d.tileID.canonical.x+d.tileID.wrap*S),j=D*d.tileID.canonical.y;return{u_image:0,u_texsize:d.imageAtlasTexture.size,u_scale:[v,C.fromScale,C.toScale],u_fade:C.t,u_pixel_coord_upper:[k>>16,j>>16],u_pixel_coord_lower:[65535&k,65535&j]}}const Ts=(C,s,d,v)=>{const S=C.style.light,D=S.properties.get("position"),k=[D.x,D.y,D.z],j=i.c3();S.properties.get("anchor")==="viewport"&&i.c4(j,C.transform.bearingInRadians),i.c5(k,k,j);const H=C.transform.transformLightDirection(k),J=S.properties.get("color");return{u_lightpos:k,u_lightpos_globe:H,u_lightintensity:S.properties.get("intensity"),u_lightcolor:[J.r,J.g,J.b],u_vertical_gradient:+s,u_opacity:d,u_fill_translate:v}},gl=(C,s,d,v,S,D,k)=>i.e(Ts(C,s,d,v),eh(D,C,k),{u_height_factor:-Math.pow(2,S.overscaledZ)/k.tileSize/8}),Fa=(C,s,d,v)=>i.e(eh(s,C,d),{u_fill_translate:v}),Ad=(C,s)=>({u_world:C,u_fill_translate:s}),$u=(C,s,d,v,S)=>i.e(Fa(C,s,d,S),{u_world:v}),gs=(C,s,d,v,S)=>{const D=C.transform;let k,j,H=0;if(d.paint.get("circle-pitch-alignment")==="map"){const J=i.aM(s,1,D.zoom);k=!0,j=[J,J],H=J/(i.a4*Math.pow(2,s.tileID.overscaledZ))*2*Math.PI*S}else k=!1,j=D.pixelsToGLUnits;return{u_camera_to_center_distance:D.cameraToCenterDistance,u_scale_with_map:+(d.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+k,u_device_pixel_ratio:C.pixelRatio,u_extrude_scale:j,u_globe_extrude_scale:H,u_translate:v}},Yl=C=>({u_pixel_extrude_scale:[1/C.width,1/C.height]}),Lc=C=>({u_viewport_size:[C.width,C.height]}),Fo=(C,s=1)=>({u_color:C,u_overlay:0,u_overlay_scale:s}),Sr=(C,s,d,v)=>{const S=i.aM(C,1,s)/(i.a4*Math.pow(2,C.tileID.overscaledZ))*2*Math.PI*v;return{u_extrude_scale:i.aM(C,1,s),u_intensity:d,u_globe_extrude_scale:S}},ki=(C,s,d,v)=>{const S=i.N();i.c6(S,0,C.width,C.height,0,0,1);const D=C.context.gl;return{u_matrix:S,u_world:[D.drawingBufferWidth,D.drawingBufferHeight],u_image:d,u_color_ramp:v,u_opacity:s.paint.get("heatmap-opacity")}},Fl=(C,s,d)=>{const v=d.paint.get("hillshade-accent-color");let S;switch(d.paint.get("hillshade-method")){case"basic":S=4;break;case"combined":S=1;break;case"igor":S=2;break;case"multidirectional":S=3;break;default:S=0}const D=d.getIlluminationProperties();for(let k=0;k<D.directionRadians.length;k++)d.paint.get("hillshade-illumination-anchor")==="viewport"&&(D.directionRadians[k]+=C.transform.bearingInRadians);return{u_image:0,u_latrange:cu(0,s.tileID),u_exaggeration:d.paint.get("hillshade-exaggeration"),u_altitudes:D.altitudeRadians,u_azimuths:D.directionRadians,u_accent:v,u_method:S,u_highlights:D.highlightColor,u_shadows:D.shadowColor}},hr=(C,s)=>{const d=s.stride,v=i.N();return i.c6(v,0,i.a4,-i.a4,0,0,1),i.O(v,v,[0,-i.a4,0]),{u_matrix:v,u_image:1,u_dimension:[d,d],u_zoom:C.overscaledZ,u_unpack:s.getUnpackVector()}};function cu(C,s){const d=Math.pow(2,s.canonical.z),v=s.canonical.y;return[new i.aa(0,v/d).toLngLat().lat,new i.aa(0,(v+1)/d).toLngLat().lat]}const Mh=(C,s,d=0)=>({u_image:0,u_unpack:s.getUnpackVector(),u_dimension:[s.stride,s.stride],u_elevation_stops:1,u_color_stops:4,u_color_ramp_size:d,u_opacity:C.paint.get("color-relief-opacity")}),rr=(C,s,d,v)=>{const S=C.transform;return{u_translation:Ss(C,s,d),u_ratio:v/i.aM(s,1,S.zoom),u_device_pixel_ratio:C.pixelRatio,u_units_to_pixels:[1/S.pixelsToGLUnits[0],1/S.pixelsToGLUnits[1]]}},ih=(C,s,d,v,S)=>i.e(rr(C,s,d,v),{u_image:0,u_image_height:S}),fp=(C,s,d,v,S)=>{const D=C.transform,k=hu(s,D);return{u_translation:Ss(C,s,d),u_texsize:s.imageAtlasTexture.size,u_ratio:v/i.aM(s,1,D.zoom),u_device_pixel_ratio:C.pixelRatio,u_image:0,u_scale:[k,S.fromScale,S.toScale],u_fade:S.t,u_units_to_pixels:[1/D.pixelsToGLUnits[0],1/D.pixelsToGLUnits[1]]}},Uf=(C,s,d,v,S)=>{const D=hu(s,C.transform);return i.e(rr(C,s,d,v),{u_tileratio:D,u_crossfade_from:S.fromScale,u_crossfade_to:S.toScale,u_image:0,u_mix:S.t,u_lineatlas_width:C.lineAtlas.width,u_lineatlas_height:C.lineAtlas.height})},dc=(C,s,d,v,S,D)=>{const k=hu(s,C.transform);return i.e(rr(C,s,d,v),{u_image:0,u_image_height:D,u_tileratio:k,u_crossfade_from:S.fromScale,u_crossfade_to:S.toScale,u_image_dash:1,u_mix:S.t,u_lineatlas_width:C.lineAtlas.width,u_lineatlas_height:C.lineAtlas.height})};function hu(C,s){return 1/i.aM(C,1,s.tileZoom)}function Ss(C,s,d){return i.aN(C.transform,s,d.paint.get("line-translate"),d.paint.get("line-translate-anchor"))}const Ks=(C,s,d,v,S)=>{return{u_tl_parent:C,u_scale_parent:s,u_buffer_scale:1,u_fade_t:d.mix,u_opacity:d.opacity*v.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:v.paint.get("raster-brightness-min"),u_brightness_high:v.paint.get("raster-brightness-max"),u_saturation_factor:(k=v.paint.get("raster-saturation"),k>0?1-1/(1.001-k):-k),u_contrast_factor:(D=v.paint.get("raster-contrast"),D>0?1/(1-D):1+D),u_spin_weights:Ch(v.paint.get("raster-hue-rotate")),u_coords_top:[S[0].x,S[0].y,S[1].x,S[1].y],u_coords_bottom:[S[3].x,S[3].y,S[2].x,S[2].y]};var D,k};function Ch(C){C*=Math.PI/180;const s=Math.sin(C),d=Math.cos(C);return[(2*d+1)/3,(-Math.sqrt(3)*s-d+1)/3,(Math.sqrt(3)*s-d+1)/3]}const Rc=(C,s,d,v,S,D,k,j,H,J,et,mt,dt)=>{const Tt=k.transform;return{u_is_size_zoom_constant:+(C==="constant"||C==="source"),u_is_size_feature_constant:+(C==="constant"||C==="camera"),u_size_t:s?s.uSizeT:0,u_size:s?s.uSize:0,u_camera_to_center_distance:Tt.cameraToCenterDistance,u_pitch:Tt.pitch/360*2*Math.PI,u_rotate_symbol:+d,u_aspect_ratio:Tt.width/Tt.height,u_fade_change:k.options.fadeDuration?k.symbolFadeChange:1,u_label_plane_matrix:j,u_coord_matrix:H,u_is_text:+et,u_pitch_with_map:+v,u_is_along_line:S,u_is_variable_anchor:D,u_texsize:mt,u_texture:0,u_translation:J,u_pitched_scale:dt}},ha=(C,s,d,v,S,D,k,j,H,J,et,mt,dt,Tt)=>{const pt=k.transform;return i.e(Rc(C,s,d,v,S,D,k,j,H,J,et,mt,Tt),{u_gamma_scale:v?Math.cos(pt.pitch*Math.PI/180)*pt.cameraToCenterDistance:1,u_device_pixel_ratio:k.pixelRatio,u_is_halo:1})},Is=(C,s,d,v,S,D,k,j,H,J,et,mt,dt)=>i.e(ha(C,s,d,v,S,D,k,j,H,J,!0,et,0,dt),{u_texsize_icon:mt,u_texture_icon:1}),uf=(C,s)=>({u_opacity:C,u_color:s}),df=(C,s,d,v,S)=>i.e(function(D,k,j,H){const J=j.imageManager.getPattern(D.from.toString()),et=j.imageManager.getPattern(D.to.toString()),{width:mt,height:dt}=j.imageManager.getPixelSize(),Tt=Math.pow(2,H.tileID.overscaledZ),pt=H.tileSize*Math.pow(2,j.transform.tileZoom)/Tt,It=pt*(H.tileID.canonical.x+H.tileID.wrap*Tt),Kt=pt*H.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:J.tl,u_pattern_br_a:J.br,u_pattern_tl_b:et.tl,u_pattern_br_b:et.br,u_texsize:[mt,dt],u_mix:k.t,u_pattern_size_a:J.displaySize,u_pattern_size_b:et.displaySize,u_scale_a:k.fromScale,u_scale_b:k.toScale,u_tile_units_to_pixels:1/i.aM(H,1,j.transform.tileZoom),u_pixel_coord_upper:[It>>16,Kt>>16],u_pixel_coord_lower:[65535&It,65535&Kt]}}(d,S,s,v),{u_opacity:C}),uu=(C,s)=>{},kc={fillExtrusion:(C,s)=>({u_lightpos:new i.c1(C,s.u_lightpos),u_lightpos_globe:new i.c1(C,s.u_lightpos_globe),u_lightintensity:new i.bp(C,s.u_lightintensity),u_lightcolor:new i.c1(C,s.u_lightcolor),u_vertical_gradient:new i.bp(C,s.u_vertical_gradient),u_opacity:new i.bp(C,s.u_opacity),u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillExtrusionPattern:(C,s)=>({u_lightpos:new i.c1(C,s.u_lightpos),u_lightpos_globe:new i.c1(C,s.u_lightpos_globe),u_lightintensity:new i.bp(C,s.u_lightintensity),u_lightcolor:new i.c1(C,s.u_lightcolor),u_vertical_gradient:new i.bp(C,s.u_vertical_gradient),u_height_factor:new i.bp(C,s.u_height_factor),u_opacity:new i.bp(C,s.u_opacity),u_fill_translate:new i.c2(C,s.u_fill_translate),u_image:new i.bZ(C,s.u_image),u_texsize:new i.c2(C,s.u_texsize),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade)}),fill:(C,s)=>({u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillPattern:(C,s)=>({u_image:new i.bZ(C,s.u_image),u_texsize:new i.c2(C,s.u_texsize),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade),u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillOutline:(C,s)=>({u_world:new i.c2(C,s.u_world),u_fill_translate:new i.c2(C,s.u_fill_translate)}),fillOutlinePattern:(C,s)=>({u_world:new i.c2(C,s.u_world),u_image:new i.bZ(C,s.u_image),u_texsize:new i.c2(C,s.u_texsize),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade),u_fill_translate:new i.c2(C,s.u_fill_translate)}),circle:(C,s)=>({u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_scale_with_map:new i.bZ(C,s.u_scale_with_map),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_extrude_scale:new i.c2(C,s.u_extrude_scale),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_globe_extrude_scale:new i.bp(C,s.u_globe_extrude_scale),u_translate:new i.c2(C,s.u_translate)}),collisionBox:(C,s)=>({u_pixel_extrude_scale:new i.c2(C,s.u_pixel_extrude_scale)}),collisionCircle:(C,s)=>({u_viewport_size:new i.c2(C,s.u_viewport_size)}),debug:(C,s)=>({u_color:new i.b_(C,s.u_color),u_overlay:new i.bZ(C,s.u_overlay),u_overlay_scale:new i.bp(C,s.u_overlay_scale)}),depth:uu,clippingMask:uu,heatmap:(C,s)=>({u_extrude_scale:new i.bp(C,s.u_extrude_scale),u_intensity:new i.bp(C,s.u_intensity),u_globe_extrude_scale:new i.bp(C,s.u_globe_extrude_scale)}),heatmapTexture:(C,s)=>({u_matrix:new i.b$(C,s.u_matrix),u_world:new i.c2(C,s.u_world),u_image:new i.bZ(C,s.u_image),u_color_ramp:new i.bZ(C,s.u_color_ramp),u_opacity:new i.bp(C,s.u_opacity)}),hillshade:(C,s)=>({u_image:new i.bZ(C,s.u_image),u_latrange:new i.c2(C,s.u_latrange),u_exaggeration:new i.bp(C,s.u_exaggeration),u_altitudes:new i.c8(C,s.u_altitudes),u_azimuths:new i.c8(C,s.u_azimuths),u_accent:new i.b_(C,s.u_accent),u_method:new i.bZ(C,s.u_method),u_shadows:new i.c7(C,s.u_shadows),u_highlights:new i.c7(C,s.u_highlights)}),hillshadePrepare:(C,s)=>({u_matrix:new i.b$(C,s.u_matrix),u_image:new i.bZ(C,s.u_image),u_dimension:new i.c2(C,s.u_dimension),u_zoom:new i.bp(C,s.u_zoom),u_unpack:new i.c0(C,s.u_unpack)}),colorRelief:(C,s)=>({u_image:new i.bZ(C,s.u_image),u_unpack:new i.c0(C,s.u_unpack),u_dimension:new i.c2(C,s.u_dimension),u_elevation_stops:new i.bZ(C,s.u_elevation_stops),u_color_stops:new i.bZ(C,s.u_color_stops),u_color_ramp_size:new i.bZ(C,s.u_color_ramp_size),u_opacity:new i.bp(C,s.u_opacity)}),line:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels)}),lineGradient:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_image:new i.bZ(C,s.u_image),u_image_height:new i.bp(C,s.u_image_height)}),linePattern:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_texsize:new i.c2(C,s.u_texsize),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_image:new i.bZ(C,s.u_image),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_scale:new i.c1(C,s.u_scale),u_fade:new i.bp(C,s.u_fade)}),lineSDF:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_image:new i.bZ(C,s.u_image),u_mix:new i.bp(C,s.u_mix),u_tileratio:new i.bp(C,s.u_tileratio),u_crossfade_from:new i.bp(C,s.u_crossfade_from),u_crossfade_to:new i.bp(C,s.u_crossfade_to),u_lineatlas_width:new i.bp(C,s.u_lineatlas_width),u_lineatlas_height:new i.bp(C,s.u_lineatlas_height)}),lineGradientSDF:(C,s)=>({u_translation:new i.c2(C,s.u_translation),u_ratio:new i.bp(C,s.u_ratio),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_units_to_pixels:new i.c2(C,s.u_units_to_pixels),u_image:new i.bZ(C,s.u_image),u_image_height:new i.bp(C,s.u_image_height),u_tileratio:new i.bp(C,s.u_tileratio),u_crossfade_from:new i.bp(C,s.u_crossfade_from),u_crossfade_to:new i.bp(C,s.u_crossfade_to),u_image_dash:new i.bZ(C,s.u_image_dash),u_mix:new i.bp(C,s.u_mix),u_lineatlas_width:new i.bp(C,s.u_lineatlas_width),u_lineatlas_height:new i.bp(C,s.u_lineatlas_height)}),raster:(C,s)=>({u_tl_parent:new i.c2(C,s.u_tl_parent),u_scale_parent:new i.bp(C,s.u_scale_parent),u_buffer_scale:new i.bp(C,s.u_buffer_scale),u_fade_t:new i.bp(C,s.u_fade_t),u_opacity:new i.bp(C,s.u_opacity),u_image0:new i.bZ(C,s.u_image0),u_image1:new i.bZ(C,s.u_image1),u_brightness_low:new i.bp(C,s.u_brightness_low),u_brightness_high:new i.bp(C,s.u_brightness_high),u_saturation_factor:new i.bp(C,s.u_saturation_factor),u_contrast_factor:new i.bp(C,s.u_contrast_factor),u_spin_weights:new i.c1(C,s.u_spin_weights),u_coords_top:new i.c0(C,s.u_coords_top),u_coords_bottom:new i.c0(C,s.u_coords_bottom)}),symbolIcon:(C,s)=>({u_is_size_zoom_constant:new i.bZ(C,s.u_is_size_zoom_constant),u_is_size_feature_constant:new i.bZ(C,s.u_is_size_feature_constant),u_size_t:new i.bp(C,s.u_size_t),u_size:new i.bp(C,s.u_size),u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_pitch:new i.bp(C,s.u_pitch),u_rotate_symbol:new i.bZ(C,s.u_rotate_symbol),u_aspect_ratio:new i.bp(C,s.u_aspect_ratio),u_fade_change:new i.bp(C,s.u_fade_change),u_label_plane_matrix:new i.b$(C,s.u_label_plane_matrix),u_coord_matrix:new i.b$(C,s.u_coord_matrix),u_is_text:new i.bZ(C,s.u_is_text),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_is_along_line:new i.bZ(C,s.u_is_along_line),u_is_variable_anchor:new i.bZ(C,s.u_is_variable_anchor),u_texsize:new i.c2(C,s.u_texsize),u_texture:new i.bZ(C,s.u_texture),u_translation:new i.c2(C,s.u_translation),u_pitched_scale:new i.bp(C,s.u_pitched_scale)}),symbolSDF:(C,s)=>({u_is_size_zoom_constant:new i.bZ(C,s.u_is_size_zoom_constant),u_is_size_feature_constant:new i.bZ(C,s.u_is_size_feature_constant),u_size_t:new i.bp(C,s.u_size_t),u_size:new i.bp(C,s.u_size),u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_pitch:new i.bp(C,s.u_pitch),u_rotate_symbol:new i.bZ(C,s.u_rotate_symbol),u_aspect_ratio:new i.bp(C,s.u_aspect_ratio),u_fade_change:new i.bp(C,s.u_fade_change),u_label_plane_matrix:new i.b$(C,s.u_label_plane_matrix),u_coord_matrix:new i.b$(C,s.u_coord_matrix),u_is_text:new i.bZ(C,s.u_is_text),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_is_along_line:new i.bZ(C,s.u_is_along_line),u_is_variable_anchor:new i.bZ(C,s.u_is_variable_anchor),u_texsize:new i.c2(C,s.u_texsize),u_texture:new i.bZ(C,s.u_texture),u_gamma_scale:new i.bp(C,s.u_gamma_scale),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_is_halo:new i.bZ(C,s.u_is_halo),u_translation:new i.c2(C,s.u_translation),u_pitched_scale:new i.bp(C,s.u_pitched_scale)}),symbolTextAndIcon:(C,s)=>({u_is_size_zoom_constant:new i.bZ(C,s.u_is_size_zoom_constant),u_is_size_feature_constant:new i.bZ(C,s.u_is_size_feature_constant),u_size_t:new i.bp(C,s.u_size_t),u_size:new i.bp(C,s.u_size),u_camera_to_center_distance:new i.bp(C,s.u_camera_to_center_distance),u_pitch:new i.bp(C,s.u_pitch),u_rotate_symbol:new i.bZ(C,s.u_rotate_symbol),u_aspect_ratio:new i.bp(C,s.u_aspect_ratio),u_fade_change:new i.bp(C,s.u_fade_change),u_label_plane_matrix:new i.b$(C,s.u_label_plane_matrix),u_coord_matrix:new i.b$(C,s.u_coord_matrix),u_is_text:new i.bZ(C,s.u_is_text),u_pitch_with_map:new i.bZ(C,s.u_pitch_with_map),u_is_along_line:new i.bZ(C,s.u_is_along_line),u_is_variable_anchor:new i.bZ(C,s.u_is_variable_anchor),u_texsize:new i.c2(C,s.u_texsize),u_texsize_icon:new i.c2(C,s.u_texsize_icon),u_texture:new i.bZ(C,s.u_texture),u_texture_icon:new i.bZ(C,s.u_texture_icon),u_gamma_scale:new i.bp(C,s.u_gamma_scale),u_device_pixel_ratio:new i.bp(C,s.u_device_pixel_ratio),u_is_halo:new i.bZ(C,s.u_is_halo),u_translation:new i.c2(C,s.u_translation),u_pitched_scale:new i.bp(C,s.u_pitched_scale)}),background:(C,s)=>({u_opacity:new i.bp(C,s.u_opacity),u_color:new i.b_(C,s.u_color)}),backgroundPattern:(C,s)=>({u_opacity:new i.bp(C,s.u_opacity),u_image:new i.bZ(C,s.u_image),u_pattern_tl_a:new i.c2(C,s.u_pattern_tl_a),u_pattern_br_a:new i.c2(C,s.u_pattern_br_a),u_pattern_tl_b:new i.c2(C,s.u_pattern_tl_b),u_pattern_br_b:new i.c2(C,s.u_pattern_br_b),u_texsize:new i.c2(C,s.u_texsize),u_mix:new i.bp(C,s.u_mix),u_pattern_size_a:new i.c2(C,s.u_pattern_size_a),u_pattern_size_b:new i.c2(C,s.u_pattern_size_b),u_scale_a:new i.bp(C,s.u_scale_a),u_scale_b:new i.bp(C,s.u_scale_b),u_pixel_coord_upper:new i.c2(C,s.u_pixel_coord_upper),u_pixel_coord_lower:new i.c2(C,s.u_pixel_coord_lower),u_tile_units_to_pixels:new i.bp(C,s.u_tile_units_to_pixels)}),terrain:(C,s)=>({u_texture:new i.bZ(C,s.u_texture),u_ele_delta:new i.bp(C,s.u_ele_delta),u_fog_matrix:new i.b$(C,s.u_fog_matrix),u_fog_color:new i.b_(C,s.u_fog_color),u_fog_ground_blend:new i.bp(C,s.u_fog_ground_blend),u_fog_ground_blend_opacity:new i.bp(C,s.u_fog_ground_blend_opacity),u_horizon_color:new i.b_(C,s.u_horizon_color),u_horizon_fog_blend:new i.bp(C,s.u_horizon_fog_blend),u_is_globe_mode:new i.bp(C,s.u_is_globe_mode)}),terrainDepth:(C,s)=>({u_ele_delta:new i.bp(C,s.u_ele_delta)}),terrainCoords:(C,s)=>({u_texture:new i.bZ(C,s.u_texture),u_terrain_coords_id:new i.bp(C,s.u_terrain_coords_id),u_ele_delta:new i.bp(C,s.u_ele_delta)}),projectionErrorMeasurement:(C,s)=>({u_input:new i.bp(C,s.u_input),u_output_expected:new i.bp(C,s.u_output_expected)}),atmosphere:(C,s)=>({u_sun_pos:new i.c1(C,s.u_sun_pos),u_atmosphere_blend:new i.bp(C,s.u_atmosphere_blend),u_globe_position:new i.c1(C,s.u_globe_position),u_globe_radius:new i.bp(C,s.u_globe_radius),u_inv_proj_matrix:new i.b$(C,s.u_inv_proj_matrix)}),sky:(C,s)=>({u_sky_color:new i.b_(C,s.u_sky_color),u_horizon_color:new i.b_(C,s.u_horizon_color),u_horizon:new i.c2(C,s.u_horizon),u_horizon_normal:new i.c2(C,s.u_horizon_normal),u_sky_horizon_blend:new i.bp(C,s.u_sky_horizon_blend),u_sky_blend:new i.bp(C,s.u_sky_blend)})};class Dh{constructor(s,d,v){this.context=s;const S=s.gl;this.buffer=S.createBuffer(),this.dynamicDraw=!!v,this.context.unbindVAO(),s.bindElementBuffer.set(this.buffer),S.bufferData(S.ELEMENT_ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?S.DYNAMIC_DRAW:S.STATIC_DRAW),this.dynamicDraw||delete d.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(s){const d=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),d.bufferSubData(d.ELEMENT_ARRAY_BUFFER,0,s.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const _l={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class jf{constructor(s,d,v,S){this.length=d.length,this.attributes=v,this.itemSize=d.bytesPerElement,this.dynamicDraw=S,this.context=s;const D=s.gl;this.buffer=D.createBuffer(),s.bindVertexBuffer.set(this.buffer),D.bufferData(D.ARRAY_BUFFER,d.arrayBuffer,this.dynamicDraw?D.DYNAMIC_DRAW:D.STATIC_DRAW),this.dynamicDraw||delete d.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(s){if(s.length!==this.length)throw new Error(`Length of new data is ${s.length}, which doesn't match current length of ${this.length}`);const d=this.context.gl;this.bind(),d.bufferSubData(d.ARRAY_BUFFER,0,s.arrayBuffer)}enableAttributes(s,d){for(let v=0;v<this.attributes.length;v++){const S=d.attributes[this.attributes[v].name];S!==void 0&&s.enableVertexAttribArray(S)}}setVertexAttribPointers(s,d,v){for(let S=0;S<this.attributes.length;S++){const D=this.attributes[S],k=d.attributes[D.name];k!==void 0&&s.vertexAttribPointer(k,D.components,s[_l[D.type]],!1,this.itemSize,D.offset+this.itemSize*(v||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class uo{constructor(s){this.gl=s.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(s){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Pd extends uo{getDefault(){return i.bo.transparent}set(s){const d=this.current;(s.r!==d.r||s.g!==d.g||s.b!==d.b||s.a!==d.a||this.dirty)&&(this.gl.clearColor(s.r,s.g,s.b,s.a),this.current=s,this.dirty=!1)}}class zh extends uo{getDefault(){return 1}set(s){(s!==this.current||this.dirty)&&(this.gl.clearDepth(s),this.current=s,this.dirty=!1)}}class Gf extends uo{getDefault(){return 0}set(s){(s!==this.current||this.dirty)&&(this.gl.clearStencil(s),this.current=s,this.dirty=!1)}}class $f extends uo{getDefault(){return[!0,!0,!0,!0]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||s[3]!==d[3]||this.dirty)&&(this.gl.colorMask(s[0],s[1],s[2],s[3]),this.current=s,this.dirty=!1)}}class qf extends uo{getDefault(){return!0}set(s){(s!==this.current||this.dirty)&&(this.gl.depthMask(s),this.current=s,this.dirty=!1)}}class pc extends uo{getDefault(){return 255}set(s){(s!==this.current||this.dirty)&&(this.gl.stencilMask(s),this.current=s,this.dirty=!1)}}class mp extends uo{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(s){const d=this.current;(s.func!==d.func||s.ref!==d.ref||s.mask!==d.mask||this.dirty)&&(this.gl.stencilFunc(s.func,s.ref,s.mask),this.current=s,this.dirty=!1)}}class qu extends uo{getDefault(){const s=this.gl;return[s.KEEP,s.KEEP,s.KEEP]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||this.dirty)&&(this.gl.stencilOp(s[0],s[1],s[2]),this.current=s,this.dirty=!1)}}class Zu extends uo{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),this.current=s,this.dirty=!1}}class rh extends uo{getDefault(){return[0,1]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||this.dirty)&&(this.gl.depthRange(s[0],s[1]),this.current=s,this.dirty=!1)}}class du extends uo{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),this.current=s,this.dirty=!1}}class Ia extends uo{getDefault(){return this.gl.LESS}set(s){(s!==this.current||this.dirty)&&(this.gl.depthFunc(s),this.current=s,this.dirty=!1)}}class ua extends uo{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.BLEND):d.disable(d.BLEND),this.current=s,this.dirty=!1}}class Hu extends uo{getDefault(){const s=this.gl;return[s.ONE,s.ZERO]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||this.dirty)&&(this.gl.blendFunc(s[0],s[1]),this.current=s,this.dirty=!1)}}class gp extends uo{getDefault(){return i.bo.transparent}set(s){const d=this.current;(s.r!==d.r||s.g!==d.g||s.b!==d.b||s.a!==d.a||this.dirty)&&(this.gl.blendColor(s.r,s.g,s.b,s.a),this.current=s,this.dirty=!1)}}class Md extends uo{getDefault(){return this.gl.FUNC_ADD}set(s){(s!==this.current||this.dirty)&&(this.gl.blendEquation(s),this.current=s,this.dirty=!1)}}class Jl extends uo{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;s?d.enable(d.CULL_FACE):d.disable(d.CULL_FACE),this.current=s,this.dirty=!1}}class nh extends uo{getDefault(){return this.gl.BACK}set(s){(s!==this.current||this.dirty)&&(this.gl.cullFace(s),this.current=s,this.dirty=!1)}}class Wu extends uo{getDefault(){return this.gl.CCW}set(s){(s!==this.current||this.dirty)&&(this.gl.frontFace(s),this.current=s,this.dirty=!1)}}class Lh extends uo{getDefault(){return null}set(s){(s!==this.current||this.dirty)&&(this.gl.useProgram(s),this.current=s,this.dirty=!1)}}class Ba extends uo{getDefault(){return this.gl.TEXTURE0}set(s){(s!==this.current||this.dirty)&&(this.gl.activeTexture(s),this.current=s,this.dirty=!1)}}class Cd extends uo{getDefault(){const s=this.gl;return[0,0,s.drawingBufferWidth,s.drawingBufferHeight]}set(s){const d=this.current;(s[0]!==d[0]||s[1]!==d[1]||s[2]!==d[2]||s[3]!==d[3]||this.dirty)&&(this.gl.viewport(s[0],s[1],s[2],s[3]),this.current=s,this.dirty=!1)}}class ri extends uo{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindFramebuffer(d.FRAMEBUFFER,s),this.current=s,this.dirty=!1}}class Rh extends uo{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindRenderbuffer(d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}class pu extends uo{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindTexture(d.TEXTURE_2D,s),this.current=s,this.dirty=!1}}class kh extends uo{getDefault(){return null}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.bindBuffer(d.ARRAY_BUFFER,s),this.current=s,this.dirty=!1}}class Pn extends uo{getDefault(){return null}set(s){const d=this.gl;d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,s),this.current=s,this.dirty=!1}}class Fh extends uo{getDefault(){return null}set(s){var d;if(s===this.current&&!this.dirty)return;const v=this.gl;tl(v)?v.bindVertexArray(s):(d=v.getExtension("OES_vertex_array_object"))===null||d===void 0||d.bindVertexArrayOES(s),this.current=s,this.dirty=!1}}class Fc extends uo{getDefault(){return 4}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_ALIGNMENT,s),this.current=s,this.dirty=!1}}class Dd extends uo{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s),this.current=s,this.dirty=!1}}class Oa extends uo{getDefault(){return!1}set(s){if(s===this.current&&!this.dirty)return;const d=this.gl;d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,s),this.current=s,this.dirty=!1}}class jr extends uo{constructor(s,d){super(s),this.context=s,this.parent=d}getDefault(){return null}}class Xu extends jr{setDirty(){this.dirty=!0}set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,s,0),this.current=s,this.dirty=!1}}class Zf extends jr{set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}class Cm extends jr{set(s){if(s===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const d=this.gl;d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,s),this.current=s,this.dirty=!1}}const fu="Framebuffer is not complete";class _p{constructor(s,d,v,S,D){this.context=s,this.width=d,this.height=v;const k=s.gl,j=this.framebuffer=k.createFramebuffer();if(this.colorAttachment=new Xu(s,j),S)this.depthAttachment=D?new Cm(s,j):new Zf(s,j);else if(D)throw new Error("Stencil cannot be set without depth");if(k.checkFramebufferStatus(k.FRAMEBUFFER)!==k.FRAMEBUFFER_COMPLETE)throw new Error(fu)}destroy(){const s=this.context.gl,d=this.colorAttachment.get();if(d&&s.deleteTexture(d),this.depthAttachment){const v=this.depthAttachment.get();v&&s.deleteRenderbuffer(v)}s.deleteFramebuffer(this.framebuffer)}}class lo{constructor(s){var d,v;if(this.gl=s,this.clearColor=new Pd(this),this.clearDepth=new zh(this),this.clearStencil=new Gf(this),this.colorMask=new $f(this),this.depthMask=new qf(this),this.stencilMask=new pc(this),this.stencilFunc=new mp(this),this.stencilOp=new qu(this),this.stencilTest=new Zu(this),this.depthRange=new rh(this),this.depthTest=new du(this),this.depthFunc=new Ia(this),this.blend=new ua(this),this.blendFunc=new Hu(this),this.blendColor=new gp(this),this.blendEquation=new Md(this),this.cullFace=new Jl(this),this.cullFaceSide=new nh(this),this.frontFace=new Wu(this),this.program=new Lh(this),this.activeTexture=new Ba(this),this.viewport=new Cd(this),this.bindFramebuffer=new ri(this),this.bindRenderbuffer=new Rh(this),this.bindTexture=new pu(this),this.bindVertexBuffer=new kh(this),this.bindElementBuffer=new Pn(this),this.bindVertexArray=new Fh(this),this.pixelStoreUnpack=new Fc(this),this.pixelStoreUnpackPremultiplyAlpha=new Dd(this),this.pixelStoreUnpackFlipY=new Oa(this),this.extTextureFilterAnisotropic=s.getExtension("EXT_texture_filter_anisotropic")||s.getExtension("MOZ_EXT_texture_filter_anisotropic")||s.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=s.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),tl(s)){this.HALF_FLOAT=s.HALF_FLOAT;const S=s.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(d=s.RGBA16F)!==null&&d!==void 0?d:S==null?void 0:S.RGBA16F_EXT,this.RGB16F=(v=s.RGB16F)!==null&&v!==void 0?v:S==null?void 0:S.RGB16F_EXT,s.getExtension("EXT_color_buffer_float")}else{s.getExtension("EXT_color_buffer_half_float"),s.getExtension("OES_texture_half_float_linear");const S=s.getExtension("OES_texture_half_float");this.HALF_FLOAT=S==null?void 0:S.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(s,d){return new Dh(this,s,d)}createVertexBuffer(s,d,v){return new jf(this,s,d,v)}createRenderbuffer(s,d,v){const S=this.gl,D=S.createRenderbuffer();return this.bindRenderbuffer.set(D),S.renderbufferStorage(S.RENDERBUFFER,s,d,v),this.bindRenderbuffer.set(null),D}createFramebuffer(s,d,v,S){return new _p(this,s,d,v,S)}clear({color:s,depth:d,stencil:v}){const S=this.gl;let D=0;s&&(D|=S.COLOR_BUFFER_BIT,this.clearColor.set(s),this.colorMask.set([!0,!0,!0,!0])),d!==void 0&&(D|=S.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(d),this.depthMask.set(!0)),v!==void 0&&(D|=S.STENCIL_BUFFER_BIT,this.clearStencil.set(v),this.stencilMask.set(255)),S.clear(D)}setCullFace(s){s.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(s.mode),this.frontFace.set(s.frontFace))}setDepthMode(s){s.func!==this.gl.ALWAYS||s.mask?(this.depthTest.set(!0),this.depthFunc.set(s.func),this.depthMask.set(s.mask),this.depthRange.set(s.range)):this.depthTest.set(!1)}setStencilMode(s){s.test.func!==this.gl.ALWAYS||s.mask?(this.stencilTest.set(!0),this.stencilMask.set(s.mask),this.stencilOp.set([s.fail,s.depthFail,s.pass]),this.stencilFunc.set({func:s.test.func,ref:s.ref,mask:s.test.mask})):this.stencilTest.set(!1)}setColorMode(s){i.bQ(s.blendFunction,ko.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(s.blendFunction),this.blendColor.set(s.blendColor)),this.colorMask.set(s.mask)}createVertexArray(){var s;return tl(this.gl)?this.gl.createVertexArray():(s=this.gl.getExtension("OES_vertex_array_object"))===null||s===void 0?void 0:s.createVertexArrayOES()}deleteVertexArray(s){var d;return tl(this.gl)?this.gl.deleteVertexArray(s):(d=this.gl.getExtension("OES_vertex_array_object"))===null||d===void 0?void 0:d.deleteVertexArrayOES(s)}unbindVAO(){this.bindVertexArray.set(null)}}let Bh;function Yu(C,s,d,v,S){const D=C.context,k=C.transform,j=D.gl,H=C.useProgram("collisionBox"),J=[];let et=0,mt=0;for(let Wt=0;Wt<v.length;Wt++){const ft=v[Wt],_e=s.getTile(ft).getBucket(d);if(!_e)continue;const he=S?_e.textCollisionBox:_e.iconCollisionBox,me=_e.collisionCircleArray;me.length>0&&(J.push({circleArray:me,circleOffset:mt,coord:ft}),et+=me.length/4,mt=et),he&&H.draw(D,j.LINES,rn.disabled,Un.disabled,C.colorModeForRenderPass(),qn.disabled,Yl(C.transform),C.style.map.terrain&&C.style.map.terrain.getTerrainData(ft),k.getProjectionData({overscaledTileID:ft,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),d.id,he.layoutVertexBuffer,he.indexBuffer,he.segments,null,C.transform.zoom,null,null,he.collisionVertexBuffer)}if(!S||!J.length)return;const dt=C.useProgram("collisionCircle"),Tt=new i.c9;Tt.resize(4*et),Tt._trim();let pt=0;for(const Wt of J)for(let ft=0;ft<Wt.circleArray.length/4;ft++){const _e=4*ft,he=Wt.circleArray[_e+0],me=Wt.circleArray[_e+1],be=Wt.circleArray[_e+2],de=Wt.circleArray[_e+3];Tt.emplace(pt++,he,me,be,de,0),Tt.emplace(pt++,he,me,be,de,1),Tt.emplace(pt++,he,me,be,de,2),Tt.emplace(pt++,he,me,be,de,3)}(!Bh||Bh.length<2*et)&&(Bh=function(Wt){const ft=2*Wt,_e=new i.cb;_e.resize(ft),_e._trim();for(let he=0;he<ft;he++){const me=6*he;_e.uint16[me+0]=4*he+0,_e.uint16[me+1]=4*he+1,_e.uint16[me+2]=4*he+2,_e.uint16[me+3]=4*he+2,_e.uint16[me+4]=4*he+3,_e.uint16[me+5]=4*he+0}return _e}(et));const It=D.createIndexBuffer(Bh,!0),Kt=D.createVertexBuffer(Tt,i.ca.members,!0);for(const Wt of J){const ft=Lc(C.transform);dt.draw(D,j.TRIANGLES,rn.disabled,Un.disabled,C.colorModeForRenderPass(),qn.disabled,ft,C.style.map.terrain&&C.style.map.terrain.getTerrainData(Wt.coord),null,d.id,Kt,It,i.aW.simpleSegment(0,2*Wt.circleOffset,Wt.circleArray.length,Wt.circleArray.length/2),null,C.transform.zoom,null,null,null)}Kt.destroy(),It.destroy()}const Hf=i.ar(new Float32Array(16));function yp(C,s,d,v,S,D){const{horizontalAlign:k,verticalAlign:j}=i.aR(C);return new i.P((-(k-.5)*s/S+v[0])*D,(-(j-.5)*d/S+v[1])*D)}function xp(C,s,d,v,S,D){const k=s.tileAnchorPoint.add(new i.P(s.translation[0],s.translation[1]));if(s.pitchWithMap){let j=v.mult(D);d||(j=j.rotate(-S));const H=k.add(j);return wt(H.x,H.y,s.pitchedLabelPlaneMatrix,s.getElevation).point}if(d){const j=Di(s.tileAnchorPoint.x+1,s.tileAnchorPoint.y,s).point.sub(C),H=Math.atan(j.y/j.x)+(j.x<0?Math.PI:0);return C.add(v.rotate(H))}return C.add(v)}function vp(C,s,d,v,S,D,k,j,H,J,et,mt){const dt=C.text.placedSymbolArray,Tt=C.text.dynamicLayoutVertexArray,pt=C.icon.dynamicLayoutVertexArray,It={};Tt.clear();for(let Kt=0;Kt<dt.length;Kt++){const Wt=dt.get(Kt),ft=Wt.hidden||!Wt.crossTileID||C.allowVerticalPlacement&&!Wt.placedOrientation?null:v[Wt.crossTileID];if(ft){const _e=new i.P(Wt.anchorX,Wt.anchorY),he={getElevation:mt,width:S.width,height:S.height,pitchedLabelPlaneMatrix:D,pitchWithMap:d,transform:S,tileAnchorPoint:_e,translation:J,unwrappedTileID:et},me=d?Ki(_e.x,_e.y,he):Di(_e.x,_e.y,he),be=Bt(S.cameraToCenterDistance,me.signedDistanceFromCamera);let de=i.az(C.textSizeData,j,Wt)*be/i.aL;d&&(de*=C.tilePixelRatio/k);const{width:Ce,height:Qe,anchor:Xe,textOffset:Je,textBoxScale:ii}=ft,Ri=yp(Xe,Ce,Qe,Je,ii,de),Oi=S.getPitchedTextCorrection(_e.x+J[0],_e.y+J[1],et),Ti=xp(me.point,he,s,Ri,-S.bearingInRadians,Oi),br=C.allowVerticalPlacement&&Wt.placedOrientation===i.ay.vertical?Math.PI/2:0;for(let tn=0;tn<Wt.numGlyphs;tn++)i.aF(Tt,Ti,br);H&&Wt.associatedIconIndex>=0&&(It[Wt.associatedIconIndex]={shiftedAnchor:Ti,angle:br})}else Nn(Wt.numGlyphs,Tt)}if(H){pt.clear();const Kt=C.icon.placedSymbolArray;for(let Wt=0;Wt<Kt.length;Wt++){const ft=Kt.get(Wt);if(ft.hidden)Nn(ft.numGlyphs,pt);else{const _e=It[Wt];if(_e)for(let he=0;he<ft.numGlyphs;he++)i.aF(pt,_e.shiftedAnchor,_e.angle);else Nn(ft.numGlyphs,pt)}}C.icon.dynamicLayoutVertexBuffer.updateData(pt)}C.text.dynamicLayoutVertexBuffer.updateData(Tt)}function mu(C,s,d){return d.iconsInText&&s?"symbolTextAndIcon":C?"symbolSDF":"symbolIcon"}function bp(C,s,d,v,S,D,k,j,H,J,et,mt,dt){const Tt=C.context,pt=Tt.gl,It=C.transform,Kt=j==="map",Wt=H==="map",ft=j!=="viewport"&&d.layout.get("symbol-placement")!=="point",_e=Kt&&!Wt&&!ft,he=!d.layout.get("symbol-sort-key").isConstant();let me=!1;const be=C.getDepthModeForSublayer(0,rn.ReadOnly),de=d._unevaluatedLayout.hasValue("text-variable-anchor")||d._unevaluatedLayout.hasValue("text-variable-anchor-offset"),Ce=[],Qe=It.getCircleRadiusCorrection();for(const Xe of v){const Je=s.getTile(Xe),ii=Je.getBucket(d);if(!ii)continue;const Ri=S?ii.text:ii.icon;if(!Ri||!Ri.segments.get().length||!Ri.hasVisibleVertices)continue;const Oi=Ri.programConfigurations.get(d.id),Ti=S||ii.sdfIcons,br=S?ii.textSizeData:ii.iconSizeData,tn=Wt||It.pitch!==0,Zr=C.useProgram(mu(Ti,S,ii),Oi),vo=i.ax(br,It.zoom),Wo=C.style.map.terrain&&C.style.map.terrain.getTerrainData(Xe);let os,Xo,zs,ss,io=[0,0],Es=null;if(S)Xo=Je.glyphAtlasTexture,zs=pt.LINEAR,os=Je.glyphAtlasTexture.size,ii.iconsInText&&(io=Je.imageAtlasTexture.size,Es=Je.imageAtlasTexture,ss=tn||C.options.rotating||C.options.zooming||br.kind==="composite"||br.kind==="camera"?pt.LINEAR:pt.NEAREST);else{const Bo=d.layout.get("icon-size").constantOr(0)!==1||ii.iconsNeedLinear;Xo=Je.imageAtlasTexture,zs=Ti||C.options.rotating||C.options.zooming||Bo||tn?pt.LINEAR:pt.NEAREST,os=Je.imageAtlasTexture.size}const as=i.aM(Je,1,C.transform.zoom),sn=se(Kt,C.transform,as),Er=i.N();i.aA(Er,sn);const Ql=st(Wt,Kt,C.transform,as),As=i.aN(It,Je,D,k),wl=It.getProjectionData({overscaledTileID:Xe,applyGlobeMatrix:!dt,applyTerrainMatrix:!0}),tc=de&&ii.hasTextData(),$s=d.layout.get("icon-text-fit")!=="none"&&tc&&ii.hasIconData();if(ft){const Bo=C.style.map.terrain?(ys,Lo)=>C.style.map.terrain.getElevation(Xe,ys,Lo):null,Oo=d.layout.get("text-rotation-alignment")==="map";oe(ii,C,S,sn,Er,Wt,J,Oo,Xe.toUnwrapped(),It.width,It.height,As,Bo)}const _c=S&&de||$s,rl=ft||_c?Hf:Wt?sn:C.transform.clipSpaceToPixelsMatrix,ec=Ti&&d.paint.get(S?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let qc;qc=Ti?ii.iconsInText?Is(br.kind,vo,_e,Wt,ft,_c,C,rl,Ql,As,os,io,Qe):ha(br.kind,vo,_e,Wt,ft,_c,C,rl,Ql,As,S,os,0,Qe):Rc(br.kind,vo,_e,Wt,ft,_c,C,rl,Ql,As,S,os,Qe);const ta={program:Zr,buffers:Ri,uniformValues:qc,projectionData:wl,atlasTexture:Xo,atlasTextureIcon:Es,atlasInterpolation:zs,atlasInterpolationIcon:ss,isSDF:Ti,hasHalo:ec};if(he&&ii.canOverlap){me=!0;const Bo=Ri.segments.get();for(const Oo of Bo)Ce.push({segments:new i.aW([Oo]),sortKey:Oo.sortKey,state:ta,terrainData:Wo})}else Ce.push({segments:Ri.segments,sortKey:0,state:ta,terrainData:Wo})}me&&Ce.sort((Xe,Je)=>Xe.sortKey-Je.sortKey);for(const Xe of Ce){const Je=Xe.state;if(Tt.activeTexture.set(pt.TEXTURE0),Je.atlasTexture.bind(Je.atlasInterpolation,pt.CLAMP_TO_EDGE),Je.atlasTextureIcon&&(Tt.activeTexture.set(pt.TEXTURE1),Je.atlasTextureIcon&&Je.atlasTextureIcon.bind(Je.atlasInterpolationIcon,pt.CLAMP_TO_EDGE)),Je.isSDF){const ii=Je.uniformValues;Je.hasHalo&&(ii.u_is_halo=1,zd(Je.buffers,Xe.segments,d,C,Je.program,be,et,mt,ii,Je.projectionData,Xe.terrainData)),ii.u_is_halo=0}zd(Je.buffers,Xe.segments,d,C,Je.program,be,et,mt,Je.uniformValues,Je.projectionData,Xe.terrainData)}}function zd(C,s,d,v,S,D,k,j,H,J,et){const mt=v.context;S.draw(mt,mt.gl.TRIANGLES,D,k,j,qn.backCCW,H,et,J,d.id,C.layoutVertexBuffer,C.indexBuffer,s,d.paint,v.transform.zoom,C.programConfigurations.get(d.id),C.dynamicLayoutVertexBuffer,C.opacityVertexBuffer)}function Ld(C,s,d,v,S){const D=C.context,k=D.gl,j=Un.disabled,H=new ko([k.ONE,k.ONE],i.bo.transparent,[!0,!0,!0,!0]),J=s.getBucket(d);if(!J)return;const et=v.key;let mt=d.heatmapFbos.get(et);mt||(mt=Rd(D,s.tileSize,s.tileSize),d.heatmapFbos.set(et,mt)),D.bindFramebuffer.set(mt.framebuffer),D.viewport.set([0,0,s.tileSize,s.tileSize]),D.clear({color:i.bo.transparent});const dt=J.programConfigurations.get(d.id),Tt=C.useProgram("heatmap",dt,!S),pt=C.transform.getProjectionData({overscaledTileID:s.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),It=C.style.map.terrain.getTerrainData(v);Tt.draw(D,k.TRIANGLES,rn.disabled,j,H,qn.disabled,Sr(s,C.transform.zoom,d.paint.get("heatmap-intensity"),1),It,pt,d.id,J.layoutVertexBuffer,J.indexBuffer,J.segments,d.paint,C.transform.zoom,dt)}function Wf(C,s,d,v,S){const D=C.context,k=D.gl,j=C.transform;D.setColorMode(C.colorModeForRenderPass());const H=Oh(D,s),J=d.key,et=s.heatmapFbos.get(J);if(!et)return;D.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,et.colorAttachment.get()),D.activeTexture.set(k.TEXTURE1),H.bind(k.LINEAR,k.CLAMP_TO_EDGE);const mt=j.getProjectionData({overscaledTileID:d,applyTerrainMatrix:S,applyGlobeMatrix:!v});C.useProgram("heatmapTexture").draw(D,k.TRIANGLES,rn.disabled,Un.disabled,C.colorModeForRenderPass(),qn.disabled,ki(C,s,0,1),null,mt,s.id,C.rasterBoundsBuffer,C.quadTriangleIndexBuffer,C.rasterBoundsSegments,s.paint,j.zoom),et.destroy(),s.heatmapFbos.delete(J)}function Rd(C,s,d){var v,S;const D=C.gl,k=D.createTexture();D.bindTexture(D.TEXTURE_2D,k),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,D.LINEAR),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,D.LINEAR);const j=(v=C.HALF_FLOAT)!==null&&v!==void 0?v:D.UNSIGNED_BYTE,H=(S=C.RGBA16F)!==null&&S!==void 0?S:D.RGBA;D.texImage2D(D.TEXTURE_2D,0,H,s,d,0,D.RGBA,j,null);const J=C.createFramebuffer(s,d,!1,!1);return J.colorAttachment.set(k),J}function Oh(C,s){return s.colorRampTexture||(s.colorRampTexture=new i.T(C,s.colorRamp,C.gl.RGBA)),s.colorRampTexture}function Ju(C,s,d,v,S,D,k,j){let H=256;if(S.stepInterpolant){const J=s.getSource().maxzoom,et=k.canonical.z===J?Math.ceil(1<<C.transform.maxZoom-k.canonical.z):1;H=i.an(i.cd(D.maxLineLength/i.a4*1024*et),256,d.maxTextureSize)}return j.gradient=i.ce({expression:S.gradientExpression(),evaluationKey:"lineProgress",resolution:H,image:j.gradient||void 0,clips:D.lineClipsArray}),j.texture?j.texture.update(j.gradient):j.texture=new i.T(d,j.gradient,v.RGBA),j.version=S.gradientVersion,j.texture}function Nh(C,s,d,v,S){C.activeTexture.set(s.TEXTURE0),d.imageAtlasTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE),v.updatePaintBuffers(S)}function gu(C,s,d,v,S,D){(S||C.lineAtlas.dirty)&&(s.activeTexture.set(d.TEXTURE0),C.lineAtlas.bind(s)),v.updatePaintBuffers(D)}function Vh(C,s,d,v,S,D,k){const j=D.gradients[S.id];let H=j.texture;S.gradientVersion!==j.version&&(H=Ju(C,s,d,v,S,D,k,j)),d.activeTexture.set(v.TEXTURE0),H.bind(S.stepInterpolant?v.NEAREST:v.LINEAR,v.CLAMP_TO_EDGE)}function Uh(C,s,d,v,S,D,k,j,H){const J=D.gradients[S.id];let et=J.texture;S.gradientVersion!==J.version&&(et=Ju(C,s,d,v,S,D,k,J)),d.activeTexture.set(v.TEXTURE0),et.bind(S.stepInterpolant?v.NEAREST:v.LINEAR,v.CLAMP_TO_EDGE),d.activeTexture.set(v.TEXTURE1),C.lineAtlas.bind(d),j.updatePaintBuffers(H)}function pf(C,s,d,v,S){if(!d||!v||!v.imageAtlas)return;const D=v.imageAtlas.patternPositions;let k=D[d.to.toString()],j=D[d.from.toString()];if(!k&&j&&(k=j),!j&&k&&(j=k),!k||!j){const H=S.getPaintProperty(s);k=D[H],j=D[H]}k&&j&&C.setConstantPatternPositions(k,j)}function kd(C,s,d,v,S,D,k,j){const H=C.context.gl,J="fill-pattern",et=d.paint.get(J),mt=et&&et.constantOr(1),dt=d.getCrossfadeParameters();let Tt,pt,It,Kt,Wt;const ft=C.transform,_e=d.paint.get("fill-translate"),he=d.paint.get("fill-translate-anchor");k?(pt=mt&&!d.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Tt=H.LINES):(pt=mt?"fillPattern":"fill",Tt=H.TRIANGLES);const me=et.constantOr(null);for(const be of v){const de=s.getTile(be);if(mt&&!de.patternsLoaded())continue;const Ce=de.getBucket(d);if(!Ce)continue;const Qe=Ce.programConfigurations.get(d.id),Xe=C.useProgram(pt,Qe),Je=C.style.map.terrain&&C.style.map.terrain.getTerrainData(be);mt&&(C.context.activeTexture.set(H.TEXTURE0),de.imageAtlasTexture.bind(H.LINEAR,H.CLAMP_TO_EDGE),Qe.updatePaintBuffers(dt)),pf(Qe,J,me,de,d);const ii=ft.getProjectionData({overscaledTileID:be,applyGlobeMatrix:!j,applyTerrainMatrix:!0}),Ri=i.aN(ft,de,_e,he);if(k){Kt=Ce.indexBuffer2,Wt=Ce.segments2;const Ti=[H.drawingBufferWidth,H.drawingBufferHeight];It=pt==="fillOutlinePattern"&&mt?$u(C,dt,de,Ti,Ri):Ad(Ti,Ri)}else Kt=Ce.indexBuffer,Wt=Ce.segments,It=mt?Fa(C,dt,de,Ri):{u_fill_translate:Ri};const Oi=C.stencilModeForClipping(be);Xe.draw(C.context,Tt,S,Oi,D,qn.backCCW,It,Je,ii,d.id,Ce.layoutVertexBuffer,Kt,Wt,d.paint,C.transform.zoom,Qe)}}function rs(C,s,d,v,S,D,k,j){const H=C.context,J=H.gl,et="fill-extrusion-pattern",mt=d.paint.get(et),dt=mt.constantOr(1),Tt=d.getCrossfadeParameters(),pt=d.paint.get("fill-extrusion-opacity"),It=mt.constantOr(null),Kt=C.transform;for(const Wt of v){const ft=s.getTile(Wt),_e=ft.getBucket(d);if(!_e)continue;const he=C.style.map.terrain&&C.style.map.terrain.getTerrainData(Wt),me=_e.programConfigurations.get(d.id),be=C.useProgram(dt?"fillExtrusionPattern":"fillExtrusion",me);dt&&(C.context.activeTexture.set(J.TEXTURE0),ft.imageAtlasTexture.bind(J.LINEAR,J.CLAMP_TO_EDGE),me.updatePaintBuffers(Tt));const de=Kt.getProjectionData({overscaledTileID:Wt,applyGlobeMatrix:!j,applyTerrainMatrix:!0});pf(me,et,It,ft,d);const Ce=i.aN(Kt,ft,d.paint.get("fill-extrusion-translate"),d.paint.get("fill-extrusion-translate-anchor")),Qe=d.paint.get("fill-extrusion-vertical-gradient"),Xe=dt?gl(C,Qe,pt,Ce,Wt,Tt,ft):Ts(C,Qe,pt,Ce);be.draw(H,H.gl.TRIANGLES,S,D,k,qn.backCCW,Xe,he,de,d.id,_e.layoutVertexBuffer,_e.indexBuffer,_e.segments,d.paint,C.transform.zoom,me,C.style.map.terrain&&_e.centroidVertexBuffer)}}function yl(C,s,d,v,S,D,k,j,H){var J;const et=C.style.projection,mt=C.context,dt=C.transform,Tt=mt.gl,pt=[`#define NUM_ILLUMINATION_SOURCES ${d.paint.get("hillshade-highlight-color").values.length}`],It=C.useProgram("hillshade",null,!1,pt),Kt=!C.options.moving;for(const Wt of v){const ft=s.getTile(Wt),_e=ft.fbo;if(!_e)continue;const he=et.getMeshFromTileID(mt,Wt.canonical,j,!0,"raster"),me=(J=C.style.map.terrain)===null||J===void 0?void 0:J.getTerrainData(Wt);mt.activeTexture.set(Tt.TEXTURE0),Tt.bindTexture(Tt.TEXTURE_2D,_e.colorAttachment.get());const be=dt.getProjectionData({overscaledTileID:Wt,aligned:Kt,applyGlobeMatrix:!H,applyTerrainMatrix:!0});It.draw(mt,Tt.TRIANGLES,D,S[Wt.overscaledZ],k,qn.backCCW,Fl(C,ft,d),me,be,d.id,he.vertexBuffer,he.indexBuffer,he.segments)}}function Ea(C,s,d,v,S,D,k,j,H){var J;const et=C.style.projection,mt=C.context,dt=C.transform,Tt=mt.gl,pt=C.useProgram("colorRelief"),It=!C.options.moving;let Kt=!0,Wt=0;for(const ft of v){const _e=s.getTile(ft),he=_e.dem;if(Kt){const Xe=Tt.getParameter(Tt.MAX_TEXTURE_SIZE),{elevationTexture:Je,colorTexture:ii}=d.getColorRampTextures(mt,Xe,he.getUnpackVector());mt.activeTexture.set(Tt.TEXTURE1),Je.bind(Tt.NEAREST,Tt.CLAMP_TO_EDGE),mt.activeTexture.set(Tt.TEXTURE4),ii.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE),Kt=!1,Wt=Je.size[0]}if(!he||!he.data)continue;const me=he.stride,be=he.getPixels();if(mt.activeTexture.set(Tt.TEXTURE0),mt.pixelStoreUnpackPremultiplyAlpha.set(!1),_e.demTexture=_e.demTexture||C.getTileTexture(me),_e.demTexture){const Xe=_e.demTexture;Xe.update(be,{premultiply:!1}),Xe.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE)}else _e.demTexture=new i.T(mt,be,Tt.RGBA,{premultiply:!1}),_e.demTexture.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE);const de=et.getMeshFromTileID(mt,ft.canonical,j,!0,"raster"),Ce=(J=C.style.map.terrain)===null||J===void 0?void 0:J.getTerrainData(ft),Qe=dt.getProjectionData({overscaledTileID:ft,aligned:It,applyGlobeMatrix:!H,applyTerrainMatrix:!0});pt.draw(mt,Tt.TRIANGLES,D,S[ft.overscaledZ],k,qn.backCCW,Mh(d,_e.dem,Wt),Ce,Qe,d.id,de.vertexBuffer,de.indexBuffer,de.segments)}}const jh=[new i.P(0,0),new i.P(i.a4,0),new i.P(i.a4,i.a4),new i.P(0,i.a4)];function oh(C,s,d,v,S,D,k,j,H=!1,J=!1){const et=v[v.length-1].overscaledZ,mt=C.context,dt=mt.gl,Tt=C.useProgram("raster"),pt=C.transform,It=C.style.projection,Kt=C.colorModeForRenderPass(),Wt=!C.options.moving,ft=d.paint.get("raster-opacity"),_e=d.paint.get("raster-resampling"),he=d.paint.get("raster-fade-duration"),me=!!C.style.map.terrain;for(const be of v){const de=C.getDepthModeForSublayer(be.overscaledZ-et,ft===1?rn.ReadWrite:rn.ReadOnly,dt.LESS),Ce=s.getTile(be),Qe=_e==="nearest"?dt.NEAREST:dt.LINEAR;mt.activeTexture.set(dt.TEXTURE0),Ce.texture.bind(Qe,dt.CLAMP_TO_EDGE,dt.LINEAR_MIPMAP_NEAREST),mt.activeTexture.set(dt.TEXTURE1);const{parentTile:Xe,parentScaleBy:Je,parentTopLeft:ii,fadeValues:Ri}=Fd(Ce,s,he,me);Ce.fadeOpacity=Ri.tileOpacity,Xe?(Xe.fadeOpacity=Ri.parentTileOpacity,Xe.texture.bind(Qe,dt.CLAMP_TO_EDGE,dt.LINEAR_MIPMAP_NEAREST)):Ce.texture.bind(Qe,dt.CLAMP_TO_EDGE,dt.LINEAR_MIPMAP_NEAREST),Ce.texture.useMipmap&&mt.extTextureFilterAnisotropic&&C.transform.pitch>20&&dt.texParameterf(dt.TEXTURE_2D,mt.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,mt.extTextureFilterAnisotropicMax);const Oi=C.style.map.terrain&&C.style.map.terrain.getTerrainData(be),Ti=pt.getProjectionData({overscaledTileID:be,aligned:Wt,applyGlobeMatrix:!J,applyTerrainMatrix:!0}),br=Ks(ii,Je,Ri.fadeMix,d,j),tn=It.getMeshFromTileID(mt,be.canonical,D,k,"raster");Tt.draw(mt,dt.TRIANGLES,de,S?S[be.overscaledZ]:Un.disabled,Kt,H?qn.frontCCW:qn.backCCW,br,Oi,Ti,d.id,tn.vertexBuffer,tn.indexBuffer,tn.segments)}}function Fd(C,s,d,v){const S={parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:{tileOpacity:1,parentTileOpacity:1,fadeMix:{opacity:1,mix:0}}};if(d===0||v)return S;if(C.fadingParentID){const D=s.getLoadedTile(C.fadingParentID);if(!D)return S;const k=Math.pow(2,D.tileID.overscaledZ-C.tileID.overscaledZ),j=[C.tileID.canonical.x*k%1,C.tileID.canonical.y*k%1],H=function(J,et,mt){const dt=Ci(),Tt=(dt-et.timeAdded)/mt,pt=J.fadingDirection===we.Incoming,It=i.an((dt-J.timeAdded)/mt,0,1),Kt=i.an(1-Tt,0,1),Wt=pt?It:Kt;return{tileOpacity:Wt,parentTileOpacity:pt?Kt:It,fadeMix:{opacity:1,mix:1-Wt}}}(C,D,d);return{parentTile:D,parentScaleBy:k,parentTopLeft:j,fadeValues:H}}if(C.selfFading){const D=function(k,j){const H=(Ci()-k.timeAdded)/j,J=i.an(H,0,1);return{tileOpacity:J,fadeMix:{opacity:J,mix:0}}}(C,d);return{parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:D}}return S}const Bc=new i.bo(1,0,0,1),wp=new i.bo(0,1,0,1),Ku=new i.bo(0,0,1,1),Tp=new i.bo(1,0,1,1),_u=new i.bo(0,1,1,1);function Qu(C,s,d,v){td(C,0,s+d/2,C.transform.width,d,v)}function ff(C,s,d,v){td(C,s-d/2,0,d,C.transform.height,v)}function td(C,s,d,v,S,D){const k=C.context,j=k.gl;j.enable(j.SCISSOR_TEST),j.scissor(s*C.pixelRatio,d*C.pixelRatio,v*C.pixelRatio,S*C.pixelRatio),k.clear({color:D}),j.disable(j.SCISSOR_TEST)}function Xf(C,s,d){const v=C.context,S=v.gl,D=C.useProgram("debug"),k=rn.disabled,j=Un.disabled,H=C.colorModeForRenderPass(),J="$debug",et=C.style.map.terrain&&C.style.map.terrain.getTerrainData(d);v.activeTexture.set(S.TEXTURE0);const mt=s.getTileByID(d.key).latestRawTileData,dt=Math.floor((mt&&mt.byteLength||0)/1024),Tt=s.getTile(d).tileSize,pt=512/Math.min(Tt,512)*(d.overscaledZ/C.transform.zoom)*.5;let It=d.canonical.toString();d.overscaledZ!==d.canonical.z&&(It+=` => ${d.overscaledZ}`),function(Wt,ft){Wt.initDebugOverlayCanvas();const _e=Wt.debugOverlayCanvas,he=Wt.context.gl,me=Wt.debugOverlayCanvas.getContext("2d");me.clearRect(0,0,_e.width,_e.height),me.shadowColor="white",me.shadowBlur=2,me.lineWidth=1.5,me.strokeStyle="white",me.textBaseline="top",me.font="bold 36px Open Sans, sans-serif",me.fillText(ft,5,5),me.strokeText(ft,5,5),Wt.debugOverlayTexture.update(_e),Wt.debugOverlayTexture.bind(he.LINEAR,he.CLAMP_TO_EDGE)}(C,`${It} ${dt}kB`);const Kt=C.transform.getProjectionData({overscaledTileID:d,applyGlobeMatrix:!0,applyTerrainMatrix:!0});D.draw(v,S.TRIANGLES,k,j,ko.alphaBlended,qn.disabled,Fo(i.bo.transparent,pt),null,Kt,J,C.debugBuffer,C.quadTriangleIndexBuffer,C.debugSegments),D.draw(v,S.LINE_STRIP,k,j,H,qn.disabled,Fo(i.bo.red),et,Kt,J,C.debugBuffer,C.tileBorderIndexBuffer,C.debugSegments)}function Oc(C,s,d,v){const{isRenderingGlobe:S}=v,D=C.context,k=D.gl,j=C.transform,H=C.colorModeForRenderPass(),J=C.getDepthModeFor3D(),et=C.useProgram("terrain");D.bindFramebuffer.set(null),D.viewport.set([0,0,C.width,C.height]);for(const mt of d){const dt=s.getTerrainMesh(mt.tileID),Tt=C.renderToTexture.getTexture(mt),pt=s.getTerrainData(mt.tileID);D.activeTexture.set(k.TEXTURE0),k.bindTexture(k.TEXTURE_2D,Tt.texture);const It=s.getMeshFrameDelta(j.zoom),Kt=j.calculateFogMatrix(mt.tileID.toUnwrapped()),Wt=Ed(It,Kt,C.style.sky,j.pitch,S),ft=j.getProjectionData({overscaledTileID:mt.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});et.draw(D,k.TRIANGLES,J,Un.disabled,H,qn.backCCW,Wt,pt,ft,"terrain",dt.vertexBuffer,dt.indexBuffer,dt.segments)}}function Bd(C,s){if(!s.mesh){const d=new i.aV;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(1,1),d.emplaceBack(-1,1);const v=new i.aX;v.emplaceBack(0,1,2),v.emplaceBack(0,2,3),s.mesh=new lc(C.createVertexBuffer(d,Uo.members),C.createIndexBuffer(v),i.aW.simpleSegment(0,0,d.length,v.length))}return s.mesh}class Od{constructor(s,d){this.context=new lo(s),this.transform=d,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:i.ar(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=An.maxOverzooming+An.maxUnderzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Js}resize(s,d,v){if(this.width=Math.floor(s*v),this.height=Math.floor(d*v),this.pixelRatio=v,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const S of this.style._order)this.style._layers[S].resize()}setup(){const s=this.context,d=new i.aV;d.emplaceBack(0,0),d.emplaceBack(i.a4,0),d.emplaceBack(0,i.a4),d.emplaceBack(i.a4,i.a4),this.tileExtentBuffer=s.createVertexBuffer(d,Uo.members),this.tileExtentSegments=i.aW.simpleSegment(0,0,4,2);const v=new i.aV;v.emplaceBack(0,0),v.emplaceBack(i.a4,0),v.emplaceBack(0,i.a4),v.emplaceBack(i.a4,i.a4),this.debugBuffer=s.createVertexBuffer(v,Uo.members),this.debugSegments=i.aW.simpleSegment(0,0,4,5);const S=new i.cg;S.emplaceBack(0,0,0,0),S.emplaceBack(i.a4,0,i.a4,0),S.emplaceBack(0,i.a4,0,i.a4),S.emplaceBack(i.a4,i.a4,i.a4,i.a4),this.rasterBoundsBuffer=s.createVertexBuffer(S,zc.members),this.rasterBoundsSegments=i.aW.simpleSegment(0,0,4,2);const D=new i.aV;D.emplaceBack(0,0),D.emplaceBack(i.a4,0),D.emplaceBack(0,i.a4),D.emplaceBack(i.a4,i.a4),this.rasterBoundsBufferPosOnly=s.createVertexBuffer(D,Uo.members),this.rasterBoundsSegmentsPosOnly=i.aW.simpleSegment(0,0,4,5);const k=new i.aV;k.emplaceBack(0,0),k.emplaceBack(1,0),k.emplaceBack(0,1),k.emplaceBack(1,1),this.viewportBuffer=s.createVertexBuffer(k,Uo.members),this.viewportSegments=i.aW.simpleSegment(0,0,4,2);const j=new i.ch;j.emplaceBack(0),j.emplaceBack(1),j.emplaceBack(3),j.emplaceBack(2),j.emplaceBack(0),this.tileBorderIndexBuffer=s.createIndexBuffer(j);const H=new i.aX;H.emplaceBack(1,0,2),H.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=s.createIndexBuffer(H);const J=this.context.gl;this.stencilClearMode=new Un({func:J.ALWAYS,mask:0},0,255,J.ZERO,J.ZERO,J.ZERO),this.tileExtentMesh=new lc(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const s=this.context,d=s.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const v=i.N();i.c6(v,0,this.width,this.height,0,0,1),i.Q(v,v,[d.drawingBufferWidth,d.drawingBufferHeight,0]);const S={mainMatrix:v,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:v};this.useProgram("clippingMask",null,!0).draw(s,d.TRIANGLES,rn.disabled,this.stencilClearMode,ko.disabled,qn.disabled,null,null,S,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(s,d,v){if(this.currentStencilSource===s.source||!s.isTileClipped()||!d||!d.length)return;this.currentStencilSource=s.source,this.nextStencilID+d.length>256&&this.clearStencil();const S=this.context;S.setColorMode(ko.disabled),S.setDepthMode(rn.disabled);const D={};for(const k of d)D[k.key]=this.nextStencilID++;this._renderTileMasks(D,d,v,!0),this._renderTileMasks(D,d,v,!1),this._tileClippingMaskIDs=D}_renderTileMasks(s,d,v,S){const D=this.context,k=D.gl,j=this.style.projection,H=this.transform,J=this.useProgram("clippingMask");for(const et of d){const mt=s[et.key],dt=this.style.map.terrain&&this.style.map.terrain.getTerrainData(et),Tt=j.getMeshFromTileID(this.context,et.canonical,S,!0,"stencil"),pt=H.getProjectionData({overscaledTileID:et,applyGlobeMatrix:!v,applyTerrainMatrix:!0});J.draw(D,k.TRIANGLES,rn.disabled,new Un({func:k.ALWAYS,mask:0},mt,255,k.KEEP,k.KEEP,k.REPLACE),ko.disabled,v?qn.disabled:qn.backCCW,null,dt,pt,"$clipping",Tt.vertexBuffer,Tt.indexBuffer,Tt.segments)}}_renderTilesDepthBuffer(){const s=this.context,d=s.gl,v=this.style.projection,S=this.transform,D=this.useProgram("depth"),k=this.getDepthModeFor3D(),j=Ae(S,{tileSize:S.tileSize});for(const H of j){const J=this.style.map.terrain&&this.style.map.terrain.getTerrainData(H),et=v.getMeshFromTileID(this.context,H.canonical,!0,!0,"raster"),mt=S.getProjectionData({overscaledTileID:H,applyGlobeMatrix:!0,applyTerrainMatrix:!0});D.draw(s,d.TRIANGLES,k,Un.disabled,ko.disabled,qn.backCCW,null,J,mt,"$clipping",et.vertexBuffer,et.indexBuffer,et.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const s=this.nextStencilID++,d=this.context.gl;return new Un({func:d.NOTEQUAL,mask:255},s,255,d.KEEP,d.KEEP,d.REPLACE)}stencilModeForClipping(s){const d=this.context.gl;return new Un({func:d.EQUAL,mask:255},this._tileClippingMaskIDs[s.key],0,d.KEEP,d.KEEP,d.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(s){const d=this.context.gl,v=s.sort((k,j)=>j.overscaledZ-k.overscaledZ),S=v[v.length-1].overscaledZ,D=v[0].overscaledZ-S+1;if(D>1){this.currentStencilSource=void 0,this.nextStencilID+D>256&&this.clearStencil();const k={};for(let j=0;j<D;j++)k[j+S]=new Un({func:d.GEQUAL,mask:255},j+this.nextStencilID,255,d.KEEP,d.KEEP,d.REPLACE);return this.nextStencilID+=D,[k,v]}return[{[S]:Un.disabled},v]}stencilConfigForOverlapTwoPass(s){const d=this.context.gl,v=s.sort((k,j)=>j.overscaledZ-k.overscaledZ),S=v[v.length-1].overscaledZ,D=v[0].overscaledZ-S+1;if(this.clearStencil(),D>1){const k={},j={};for(let H=0;H<D;H++)k[H+S]=new Un({func:d.GREATER,mask:255},D+1+H,255,d.KEEP,d.KEEP,d.REPLACE),j[H+S]=new Un({func:d.GREATER,mask:255},1+H,255,d.KEEP,d.KEEP,d.REPLACE);return this.nextStencilID=2*D+1,[k,j,v]}return this.nextStencilID=3,[{[S]:new Un({func:d.GREATER,mask:255},2,255,d.KEEP,d.KEEP,d.REPLACE)},{[S]:new Un({func:d.GREATER,mask:255},1,255,d.KEEP,d.KEEP,d.REPLACE)},v]}colorModeForRenderPass(){const s=this.context.gl;return this._showOverdrawInspector?new ko([s.CONSTANT_COLOR,s.ONE],new i.bo(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ko.unblended:ko.alphaBlended}getDepthModeForSublayer(s,d,v){if(!this.opaquePassEnabledForLayer())return rn.disabled;const S=1-((1+this.currentLayer)*this.numSublayers+s)*this.depthEpsilon;return new rn(v||this.context.gl.LEQUAL,d,[S,S])}getDepthModeFor3D(){return new rn(this.context.gl.LEQUAL,rn.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(s,d){var v,S;this.style=s,this.options=d,this.lineAtlas=s.lineAtlas,this.imageManager=s.imageManager,this.glyphManager=s.glyphManager,this.symbolFadeChange=s.placement.symbolFadeChange(Ci()),this.imageManager.beginFrame();const D=this.style._order,k=this.style.tileManagers,j={},H={},J={},et={isRenderingToTexture:!1,isRenderingGlobe:((v=s.projection)===null||v===void 0?void 0:v.transitionState)>0};for(const dt in k){const Tt=k[dt];Tt.used&&Tt.prepare(this.context),j[dt]=Tt.getVisibleCoordinates(!1),H[dt]=j[dt].slice().reverse(),J[dt]=Tt.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let dt=0;dt<D.length;dt++)if(this.style._layers[D[dt]].is3D()){this.opaquePassCutoff=dt;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const dt of D){const Tt=this.style._layers[dt];if(!Tt.hasOffscreenPass()||Tt.isHidden(this.transform.zoom))continue;const pt=H[Tt.source];(Tt.type==="custom"||pt.length)&&this.renderLayer(this,k[Tt.source],Tt,pt,et)}if((S=this.style.projection)===null||S===void 0||S.updateGPUdependent({context:this.context,useProgram:dt=>this.useProgram(dt)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:d.showOverdrawInspector?i.bo.black:i.bo.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(dt,Tt){const pt=dt.context,It=pt.gl,Kt=((be,de,Ce)=>{const Qe=Math.cos(de.rollInRadians),Xe=Math.sin(de.rollInRadians),Je=Fe(de),ii=de.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:be.properties.get("sky-color"),u_horizon_color:be.properties.get("horizon-color"),u_horizon:[(de.width/2-Je*Xe)*Ce,(de.height/2+Je*Qe)*Ce],u_horizon_normal:[-Xe,Qe],u_sky_horizon_blend:be.properties.get("sky-horizon-blend")*de.height/2*Ce,u_sky_blend:ii}})(Tt,dt.style.map.transform,dt.pixelRatio),Wt=new rn(It.LEQUAL,rn.ReadWrite,[0,1]),ft=Un.disabled,_e=dt.colorModeForRenderPass(),he=dt.useProgram("sky"),me=Bd(pt,Tt);he.draw(pt,It.TRIANGLES,Wt,ft,_e,qn.disabled,Kt,null,void 0,"sky",me.vertexBuffer,me.indexBuffer,me.segments)}(this,this.style.sky),this._showOverdrawInspector=d.showOverdrawInspector,this.depthRangeFor3D=[0,1-(s._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=D.length-1;this.currentLayer>=0;this.currentLayer--){const dt=this.style._layers[D[this.currentLayer]],Tt=k[dt.source],pt=j[dt.source];this._renderTileClippingMasks(dt,pt,!1),this.renderLayer(this,Tt,dt,pt,et)}this.renderPass="translucent";let mt=!1;for(this.currentLayer=0;this.currentLayer<D.length;this.currentLayer++){const dt=this.style._layers[D[this.currentLayer]],Tt=k[dt.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(dt,et))continue;this.opaquePassEnabledForLayer()||mt||(mt=!0,et.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const pt=(dt.type==="symbol"?J:H)[dt.source];this._renderTileClippingMasks(dt,j[dt.source],!!this.renderToTexture),this.renderLayer(this,Tt,dt,pt,et)}if(et.isRenderingGlobe&&function(dt,Tt,pt){const It=dt.context,Kt=It.gl,Wt=dt.useProgram("atmosphere"),ft=new rn(Kt.LEQUAL,rn.ReadOnly,[0,1]),_e=dt.transform,he=function(ii,Ri){const Oi=ii.properties.get("position"),Ti=[-Oi.x,-Oi.y,-Oi.z],br=i.ar(new Float64Array(16));return ii.properties.get("anchor")==="map"&&(i.bf(br,br,Ri.rollInRadians),i.bg(br,br,-Ri.pitchInRadians),i.bf(br,br,Ri.bearingInRadians),i.bg(br,br,Ri.center.lat*Math.PI/180),i.bI(br,br,-Ri.center.lng*Math.PI/180)),i.cf(Ti,Ti,br),Ti}(pt,dt.transform),me=_e.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),be=Tt.properties.get("atmosphere-blend")*me.projectionTransition;if(be===0)return;const de=Gu(_e.worldSize,_e.center.lat),Ce=_e.inverseProjectionMatrix,Qe=new Float64Array(4);Qe[3]=1,i.aG(Qe,Qe,_e.modelViewProjectionMatrix),Qe[0]/=Qe[3],Qe[1]/=Qe[3],Qe[2]/=Qe[3],Qe[3]=1,i.aG(Qe,Qe,Ce),Qe[0]/=Qe[3],Qe[1]/=Qe[3],Qe[2]/=Qe[3],Qe[3]=1;const Xe=((ii,Ri,Oi,Ti,br)=>({u_sun_pos:ii,u_atmosphere_blend:Ri,u_globe_position:Oi,u_globe_radius:Ti,u_inv_proj_matrix:br}))(he,be,[Qe[0],Qe[1],Qe[2]],de,Ce),Je=Bd(It,Tt);Wt.draw(It,Kt.TRIANGLES,ft,Un.disabled,ko.alphaBlended,qn.disabled,Xe,null,null,"atmosphere",Je.vertexBuffer,Je.indexBuffer,Je.segments)}(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const dt=function(Tt,pt){let It=null;const Kt=Object.values(Tt._layers).flatMap(he=>he.source&&!he.isHidden(pt)?[Tt.tileManagers[he.source]]:[]),Wt=Kt.filter(he=>he.getSource().type==="vector"),ft=Kt.filter(he=>he.getSource().type!=="vector"),_e=he=>{(!It||It.getSource().maxzoom<he.getSource().maxzoom)&&(It=he)};return Wt.forEach(he=>_e(he)),It||ft.forEach(he=>_e(he)),It}(this.style,this.transform.zoom);dt&&function(Tt,pt,It){for(let Kt=0;Kt<It.length;Kt++)Xf(Tt,pt,It[Kt])}(this,dt,dt.getVisibleCoordinates())}this.options.showPadding&&function(dt){const Tt=dt.transform.padding;Qu(dt,dt.transform.height-(Tt.top||0),3,Bc),Qu(dt,Tt.bottom||0,3,wp),ff(dt,Tt.left||0,3,Ku),ff(dt,dt.transform.width-(Tt.right||0),3,Tp);const pt=dt.transform.centerPoint;(function(It,Kt,Wt,ft){td(It,Kt-1,Wt-10,2,20,ft),td(It,Kt-10,Wt-1,20,2,ft)})(dt,pt.x,dt.transform.height-pt.y,_u)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(s){if(!this.style||!this.style.map||!this.style.map.terrain)return;const d=this.terrainFacilitator.matrix,v=this.transform.modelViewProjectionMatrix;let S=this.terrainFacilitator.dirty;S||(S=s?!i.ci(d,v):!i.cj(d,v)),S||(S=this.style.map.terrain.tileManager.anyTilesAfterTime(this.terrainFacilitator.renderTime)),S&&(i.ck(d,v),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(D,k){const j=D.context,H=j.gl,J=D.transform,et=ko.unblended,mt=new rn(H.LEQUAL,rn.ReadWrite,[0,1]),dt=k.tileManager.getRenderableTiles(),Tt=D.useProgram("terrainDepth");j.bindFramebuffer.set(k.getFramebuffer("depth").framebuffer),j.viewport.set([0,0,D.width/devicePixelRatio,D.height/devicePixelRatio]),j.clear({color:i.bo.transparent,depth:1});for(const pt of dt){const It=k.getTerrainMesh(pt.tileID),Kt=k.getTerrainData(pt.tileID),Wt=J.getProjectionData({overscaledTileID:pt.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),ft={u_ele_delta:k.getMeshFrameDelta(J.zoom)};Tt.draw(j,H.TRIANGLES,mt,Un.disabled,et,qn.backCCW,ft,Kt,Wt,"terrain",It.vertexBuffer,It.indexBuffer,It.segments)}j.bindFramebuffer.set(null),j.viewport.set([0,0,D.width,D.height])}(this,this.style.map.terrain),function(D,k){const j=D.context,H=j.gl,J=D.transform,et=ko.unblended,mt=new rn(H.LEQUAL,rn.ReadWrite,[0,1]),dt=k.getCoordsTexture(),Tt=k.tileManager.getRenderableTiles(),pt=D.useProgram("terrainCoords");j.bindFramebuffer.set(k.getFramebuffer("coords").framebuffer),j.viewport.set([0,0,D.width/devicePixelRatio,D.height/devicePixelRatio]),j.clear({color:i.bo.transparent,depth:1}),k.coordsIndex=[];for(const It of Tt){const Kt=k.getTerrainMesh(It.tileID),Wt=k.getTerrainData(It.tileID);j.activeTexture.set(H.TEXTURE0),H.bindTexture(H.TEXTURE_2D,dt.texture);const ft={u_terrain_coords_id:(255-k.coordsIndex.length)/255,u_texture:0,u_ele_delta:k.getMeshFrameDelta(J.zoom)},_e=J.getProjectionData({overscaledTileID:It.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});pt.draw(j,H.TRIANGLES,mt,Un.disabled,et,qn.backCCW,ft,Wt,_e,"terrain",Kt.vertexBuffer,Kt.indexBuffer,Kt.segments),k.coordsIndex.push(It.tileID.key)}j.bindFramebuffer.set(null),j.viewport.set([0,0,D.width,D.height])}(this,this.style.map.terrain))}renderLayer(s,d,v,S,D){v.isHidden(this.transform.zoom)||(v.type==="background"||v.type==="custom"||(S||[]).length)&&(this.id=v.id,i.cl(v)?function(k,j,H,J,et,mt){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:dt}=mt,Tt=Un.disabled,pt=k.colorModeForRenderPass();(H._unevaluatedLayout.hasValue("text-variable-anchor")||H._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(It,Kt,Wt,ft,_e,he,me,be,de){const Ce=Kt.transform,Qe=Kt.style.map.terrain,Xe=_e==="map",Je=he==="map";for(const ii of It){const Ri=ft.getTile(ii),Oi=Ri.getBucket(Wt);if(!Oi||!Oi.text||!Oi.text.segments.get().length)continue;const Ti=i.ax(Oi.textSizeData,Ce.zoom),br=i.aM(Ri,1,Kt.transform.zoom),tn=se(Xe,Kt.transform,br),Zr=Wt.layout.get("icon-text-fit")!=="none"&&Oi.hasIconData();if(Ti){const vo=Math.pow(2,Ce.zoom-Ri.tileID.overscaledZ),Wo=Qe?(os,Xo)=>Qe.getElevation(ii,os,Xo):null;vp(Oi,Xe,Je,de,Ce,tn,vo,Ti,Zr,i.aN(Ce,Ri,me,be),ii.toUnwrapped(),Wo)}}}(J,k,H,j,H.layout.get("text-rotation-alignment"),H.layout.get("text-pitch-alignment"),H.paint.get("text-translate"),H.paint.get("text-translate-anchor"),et),H.paint.get("icon-opacity").constantOr(1)!==0&&bp(k,j,H,J,!1,H.paint.get("icon-translate"),H.paint.get("icon-translate-anchor"),H.layout.get("icon-rotation-alignment"),H.layout.get("icon-pitch-alignment"),H.layout.get("icon-keep-upright"),Tt,pt,dt),H.paint.get("text-opacity").constantOr(1)!==0&&bp(k,j,H,J,!0,H.paint.get("text-translate"),H.paint.get("text-translate-anchor"),H.layout.get("text-rotation-alignment"),H.layout.get("text-pitch-alignment"),H.layout.get("text-keep-upright"),Tt,pt,dt),j.map.showCollisionBoxes&&(Yu(k,j,H,J,!0),Yu(k,j,H,J,!1))}(s,d,v,S,this.style.placement.variableOffsets,D):i.cm(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:mt}=et,dt=H.paint.get("circle-opacity"),Tt=H.paint.get("circle-stroke-width"),pt=H.paint.get("circle-stroke-opacity"),It=!H.layout.get("circle-sort-key").isConstant();if(dt.constantOr(1)===0&&(Tt.constantOr(1)===0||pt.constantOr(1)===0))return;const Kt=k.context,Wt=Kt.gl,ft=k.transform,_e=k.getDepthModeForSublayer(0,rn.ReadOnly),he=Un.disabled,me=k.colorModeForRenderPass(),be=[],de=ft.getCircleRadiusCorrection();for(let Ce=0;Ce<J.length;Ce++){const Qe=J[Ce],Xe=j.getTile(Qe),Je=Xe.getBucket(H);if(!Je)continue;const ii=H.paint.get("circle-translate"),Ri=H.paint.get("circle-translate-anchor"),Oi=i.aN(ft,Xe,ii,Ri),Ti=Je.programConfigurations.get(H.id),br=k.useProgram("circle",Ti),tn=Je.layoutVertexBuffer,Zr=Je.indexBuffer,vo=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Qe),Wo={programConfiguration:Ti,program:br,layoutVertexBuffer:tn,indexBuffer:Zr,uniformValues:gs(k,Xe,H,Oi,de),terrainData:vo,projectionData:ft.getProjectionData({overscaledTileID:Qe,applyGlobeMatrix:!mt,applyTerrainMatrix:!0})};if(It){const os=Je.segments.get();for(const Xo of os)be.push({segments:new i.aW([Xo]),sortKey:Xo.sortKey,state:Wo})}else be.push({segments:Je.segments,sortKey:0,state:Wo})}It&&be.sort((Ce,Qe)=>Ce.sortKey-Qe.sortKey);for(const Ce of be){const{programConfiguration:Qe,program:Xe,layoutVertexBuffer:Je,indexBuffer:ii,uniformValues:Ri,terrainData:Oi,projectionData:Ti}=Ce.state;Xe.draw(Kt,Wt.TRIANGLES,_e,he,me,qn.backCCW,Ri,Oi,Ti,H.id,Je,ii,Ce.segments,H.paint,k.transform.zoom,Qe)}}(s,d,v,S,D):i.cn(v)?function(k,j,H,J,et){if(H.paint.get("heatmap-opacity")===0)return;const mt=k.context,{isRenderingToTexture:dt,isRenderingGlobe:Tt}=et;if(k.style.map.terrain){for(const pt of J){const It=j.getTile(pt);j.hasRenderableParent(pt)||(k.renderPass==="offscreen"?Ld(k,It,H,pt,Tt):k.renderPass==="translucent"&&Wf(k,H,pt,dt,Tt))}mt.viewport.set([0,0,k.width,k.height])}else k.renderPass==="offscreen"?function(pt,It,Kt,Wt){const ft=pt.context,_e=ft.gl,he=pt.transform,me=Un.disabled,be=new ko([_e.ONE,_e.ONE],i.bo.transparent,[!0,!0,!0,!0]);(function(de,Ce,Qe){const Xe=de.gl;de.activeTexture.set(Xe.TEXTURE1),de.viewport.set([0,0,Ce.width/4,Ce.height/4]);let Je=Qe.heatmapFbos.get(i.cc);Je?(Xe.bindTexture(Xe.TEXTURE_2D,Je.colorAttachment.get()),de.bindFramebuffer.set(Je.framebuffer)):(Je=Rd(de,Ce.width/4,Ce.height/4),Qe.heatmapFbos.set(i.cc,Je))})(ft,pt,Kt),ft.clear({color:i.bo.transparent});for(let de=0;de<Wt.length;de++){const Ce=Wt[de];if(It.hasRenderableParent(Ce))continue;const Qe=It.getTile(Ce),Xe=Qe.getBucket(Kt);if(!Xe)continue;const Je=Xe.programConfigurations.get(Kt.id),ii=pt.useProgram("heatmap",Je),Ri=he.getProjectionData({overscaledTileID:Ce,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),Oi=he.getCircleRadiusCorrection();ii.draw(ft,_e.TRIANGLES,rn.disabled,me,be,qn.backCCW,Sr(Qe,he.zoom,Kt.paint.get("heatmap-intensity"),Oi),null,Ri,Kt.id,Xe.layoutVertexBuffer,Xe.indexBuffer,Xe.segments,Kt.paint,he.zoom,Je)}ft.viewport.set([0,0,pt.width,pt.height])}(k,j,H,J):k.renderPass==="translucent"&&function(pt,It){const Kt=pt.context,Wt=Kt.gl;Kt.setColorMode(pt.colorModeForRenderPass());const ft=It.heatmapFbos.get(i.cc);ft&&(Kt.activeTexture.set(Wt.TEXTURE0),Wt.bindTexture(Wt.TEXTURE_2D,ft.colorAttachment.get()),Kt.activeTexture.set(Wt.TEXTURE1),Oh(Kt,It).bind(Wt.LINEAR,Wt.CLAMP_TO_EDGE),pt.useProgram("heatmapTexture").draw(Kt,Wt.TRIANGLES,rn.disabled,Un.disabled,pt.colorModeForRenderPass(),qn.disabled,ki(pt,It,0,1),null,null,It.id,pt.viewportBuffer,pt.quadTriangleIndexBuffer,pt.viewportSegments,It.paint,pt.transform.zoom))}(k,H)}(s,d,v,S,D):i.co(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent")return;const{isRenderingToTexture:mt}=et,dt=H.paint.get("line-opacity"),Tt=H.paint.get("line-width");if(dt.constantOr(1)===0||Tt.constantOr(1)===0)return;const pt=k.getDepthModeForSublayer(0,rn.ReadOnly),It=k.colorModeForRenderPass(),Kt=H.paint.get("line-dasharray"),Wt=Kt.constantOr(1),ft=H.paint.get("line-pattern"),_e=ft.constantOr(1),he=H.paint.get("line-gradient"),me=H.getCrossfadeParameters();let be;be=_e?"linePattern":Wt&&he?"lineGradientSDF":Wt?"lineSDF":he?"lineGradient":"line";const de=k.context,Ce=de.gl,Qe=k.transform;let Xe=!0;for(const Je of J){const ii=j.getTile(Je);if(_e&&!ii.patternsLoaded())continue;const Ri=ii.getBucket(H);if(!Ri)continue;const Oi=Ri.programConfigurations.get(H.id),Ti=k.context.program.get(),br=k.useProgram(be,Oi),tn=Xe||br.program!==Ti,Zr=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Je),vo=ft.constantOr(null),Wo=Kt&&Kt.constantOr(null);if(vo&&ii.imageAtlas){const io=ii.imageAtlas,Es=io.patternPositions[vo.to.toString()],as=io.patternPositions[vo.from.toString()];Es&&as&&Oi.setConstantPatternPositions(Es,as)}else if(Wo){const io=H.layout.get("line-cap")==="round",Es=k.lineAtlas.getDash(Wo.to,io),as=k.lineAtlas.getDash(Wo.from,io);Oi.setConstantDashPositions(Es,as)}const os=Qe.getProjectionData({overscaledTileID:Je,applyGlobeMatrix:!mt,applyTerrainMatrix:!0}),Xo=Qe.getPixelScale();let zs;_e?(zs=fp(k,ii,H,Xo,me),Nh(de,Ce,ii,Oi,me)):Wt&&he?(zs=dc(k,ii,H,Xo,me,Ri.lineClipsArray.length),Uh(k,j,de,Ce,H,Ri,Je,Oi,me)):Wt?(zs=Uf(k,ii,H,Xo,me),gu(k,de,Ce,Oi,tn,me)):he?(zs=ih(k,ii,H,Xo,Ri.lineClipsArray.length),Vh(k,j,de,Ce,H,Ri,Je)):zs=rr(k,ii,H,Xo);const ss=k.stencilModeForClipping(Je);br.draw(de,Ce.TRIANGLES,pt,ss,It,qn.disabled,zs,Zr,os,H.id,Ri.layoutVertexBuffer,Ri.indexBuffer,Ri.segments,H.paint,k.transform.zoom,Oi,Ri.layoutVertexBuffer2),Xe=!1}}(s,d,v,S,D):i.cp(v)?function(k,j,H,J,et){const mt=H.paint.get("fill-color"),dt=H.paint.get("fill-opacity");if(dt.constantOr(1)===0)return;const{isRenderingToTexture:Tt}=et,pt=k.colorModeForRenderPass(),It=H.paint.get("fill-pattern"),Kt=k.opaquePassEnabledForLayer()&&!It.constantOr(1)&&mt.constantOr(i.bo.transparent).a===1&&dt.constantOr(0)===1?"opaque":"translucent";if(k.renderPass===Kt){const Wt=k.getDepthModeForSublayer(1,k.renderPass==="opaque"?rn.ReadWrite:rn.ReadOnly);kd(k,j,H,J,Wt,pt,!1,Tt)}if(k.renderPass==="translucent"&&H.paint.get("fill-antialias")){const Wt=k.getDepthModeForSublayer(H.getPaintProperty("fill-outline-color")?2:0,rn.ReadOnly);kd(k,j,H,J,Wt,pt,!0,Tt)}}(s,d,v,S,D):i.cq(v)?function(k,j,H,J,et){const mt=H.paint.get("fill-extrusion-opacity");if(mt===0)return;const{isRenderingToTexture:dt}=et;if(k.renderPass==="translucent"){const Tt=new rn(k.context.gl.LEQUAL,rn.ReadWrite,k.depthRangeFor3D);if(mt!==1||H.paint.get("fill-extrusion-pattern").constantOr(1))rs(k,j,H,J,Tt,Un.disabled,ko.disabled,dt),rs(k,j,H,J,Tt,k.stencilModeFor3D(),k.colorModeForRenderPass(),dt);else{const pt=k.colorModeForRenderPass();rs(k,j,H,J,Tt,Un.disabled,pt,dt)}}}(s,d,v,S,D):i.cr(v)?function(k,j,H,J,et){if(k.renderPass!=="offscreen"&&k.renderPass!=="translucent")return;const{isRenderingToTexture:mt}=et,dt=k.context,Tt=k.style.projection.useSubdivision,pt=k.getDepthModeForSublayer(0,rn.ReadOnly),It=k.colorModeForRenderPass();if(k.renderPass==="offscreen")(function(Kt,Wt,ft,_e,he,me,be){const de=Kt.context,Ce=de.gl;for(const Qe of ft){const Xe=Wt.getTile(Qe),Je=Xe.dem;if(!Je||!Je.data||!Xe.needsHillshadePrepare)continue;const ii=Je.dim,Ri=Je.stride,Oi=Je.getPixels();if(de.activeTexture.set(Ce.TEXTURE1),de.pixelStoreUnpackPremultiplyAlpha.set(!1),Xe.demTexture=Xe.demTexture||Kt.getTileTexture(Ri),Xe.demTexture){const br=Xe.demTexture;br.update(Oi,{premultiply:!1}),br.bind(Ce.NEAREST,Ce.CLAMP_TO_EDGE)}else Xe.demTexture=new i.T(de,Oi,Ce.RGBA,{premultiply:!1}),Xe.demTexture.bind(Ce.NEAREST,Ce.CLAMP_TO_EDGE);de.activeTexture.set(Ce.TEXTURE0);let Ti=Xe.fbo;if(!Ti){const br=new i.T(de,{width:ii,height:ii,data:null},Ce.RGBA);br.bind(Ce.LINEAR,Ce.CLAMP_TO_EDGE),Ti=Xe.fbo=de.createFramebuffer(ii,ii,!0,!1),Ti.colorAttachment.set(br.texture)}de.bindFramebuffer.set(Ti.framebuffer),de.viewport.set([0,0,ii,ii]),Kt.useProgram("hillshadePrepare").draw(de,Ce.TRIANGLES,he,me,be,qn.disabled,hr(Xe.tileID,Je),null,null,_e.id,Kt.rasterBoundsBuffer,Kt.quadTriangleIndexBuffer,Kt.rasterBoundsSegments),Xe.needsHillshadePrepare=!1}})(k,j,J,H,pt,Un.disabled,It),dt.viewport.set([0,0,k.width,k.height]);else if(k.renderPass==="translucent")if(Tt){const[Kt,Wt,ft]=k.stencilConfigForOverlapTwoPass(J);yl(k,j,H,ft,Kt,pt,It,!1,mt),yl(k,j,H,ft,Wt,pt,It,!0,mt)}else{const[Kt,Wt]=k.getStencilConfigForOverlapAndUpdateStencilID(J);yl(k,j,H,Wt,Kt,pt,It,!1,mt)}}(s,d,v,S,D):i.cs(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent"||!J.length)return;const{isRenderingToTexture:mt}=et,dt=k.style.projection.useSubdivision,Tt=k.getDepthModeForSublayer(0,rn.ReadOnly),pt=k.colorModeForRenderPass();if(dt){const[It,Kt,Wt]=k.stencilConfigForOverlapTwoPass(J);Ea(k,j,H,Wt,It,Tt,pt,!1,mt),Ea(k,j,H,Wt,Kt,Tt,pt,!0,mt)}else{const[It,Kt]=k.getStencilConfigForOverlapAndUpdateStencilID(J);Ea(k,j,H,Kt,It,Tt,pt,!1,mt)}}(s,d,v,S,D):i.bT(v)?function(k,j,H,J,et){if(k.renderPass!=="translucent"||H.paint.get("raster-opacity")===0||!J.length)return;const{isRenderingToTexture:mt}=et,dt=j.getSource(),Tt=k.style.projection.useSubdivision;if(dt instanceof Cs)oh(k,j,H,J,null,!1,!1,dt.tileCoords,dt.flippedWindingOrder,mt);else if(Tt){const[pt,It,Kt]=k.stencilConfigForOverlapTwoPass(J);oh(k,j,H,Kt,pt,!1,!0,jh,!1,mt),oh(k,j,H,Kt,It,!0,!0,jh,!1,mt)}else{const[pt,It]=k.getStencilConfigForOverlapAndUpdateStencilID(J);oh(k,j,H,It,pt,!1,!0,jh,!1,mt)}}(s,d,v,S,D):i.ct(v)?function(k,j,H,J,et){const mt=H.paint.get("background-color"),dt=H.paint.get("background-opacity");if(dt===0)return;const{isRenderingToTexture:Tt}=et,pt=k.context,It=pt.gl,Kt=k.style.projection,Wt=k.transform,ft=Wt.tileSize,_e=H.paint.get("background-pattern");if(k.isPatternMissing(_e))return;const he=!_e&&mt.a===1&&dt===1&&k.opaquePassEnabledForLayer()?"opaque":"translucent";if(k.renderPass!==he)return;const me=Un.disabled,be=k.getDepthModeForSublayer(0,he==="opaque"?rn.ReadWrite:rn.ReadOnly),de=k.colorModeForRenderPass(),Ce=k.useProgram(_e?"backgroundPattern":"background"),Qe=J||Ae(Wt,{tileSize:ft,terrain:k.style.map.terrain});_e&&(pt.activeTexture.set(It.TEXTURE0),k.imageManager.bind(k.context));const Xe=H.getCrossfadeParameters();for(const Je of Qe){const ii=Wt.getProjectionData({overscaledTileID:Je,applyGlobeMatrix:!Tt,applyTerrainMatrix:!0}),Ri=_e?df(dt,k,_e,{tileID:Je,tileSize:ft},Xe):uf(dt,mt),Oi=k.style.map.terrain&&k.style.map.terrain.getTerrainData(Je),Ti=Kt.getMeshFromTileID(pt,Je.canonical,!1,!0,"raster");Ce.draw(pt,It.TRIANGLES,be,me,de,qn.backCCW,Ri,Oi,ii,H.id,Ti.vertexBuffer,Ti.indexBuffer,Ti.segments)}}(s,0,v,S,D):i.cu(v)&&function(k,j,H,J){const{isRenderingGlobe:et}=J,mt=k.context,dt=H.implementation,Tt=k.style.projection,pt=k.transform,It=pt.getProjectionDataForCustomLayer(et),Kt={farZ:pt.farZ,nearZ:pt.nearZ,fov:pt.fov*Math.PI/180,modelViewProjectionMatrix:pt.modelViewProjectionMatrix,projectionMatrix:pt.projectionMatrix,shaderData:{variantName:Tt.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${Tt.shaderPreludeCode.vertexSource}`,define:Tt.shaderDefine},defaultProjectionData:It},Wt=dt.renderingMode?dt.renderingMode:"2d";if(k.renderPass==="offscreen"){const ft=dt.prerender;ft&&(k.setCustomLayerDefaults(),mt.setColorMode(k.colorModeForRenderPass()),ft.call(dt,mt.gl,Kt),mt.setDirty(),k.setBaseState())}else if(k.renderPass==="translucent"){k.setCustomLayerDefaults(),mt.setColorMode(k.colorModeForRenderPass()),mt.setStencilMode(Un.disabled);const ft=Wt==="3d"?k.getDepthModeFor3D():k.getDepthModeForSublayer(0,rn.ReadOnly);mt.setDepthMode(ft),dt.render(mt.gl,Kt),mt.setDirty(),k.setBaseState(),mt.bindFramebuffer.set(null)}}(s,0,v,D))}saveTileTexture(s){const d=this._tileTextures[s.size[0]];d?d.push(s):this._tileTextures[s.size[0]]=[s]}getTileTexture(s){const d=this._tileTextures[s];return d&&d.length>0?d.pop():null}isPatternMissing(s){if(!s)return!1;if(!s.from||!s.to)return!0;const d=this.imageManager.getPattern(s.from.toString()),v=this.imageManager.getPattern(s.to.toString());return!d||!v}useProgram(s,d,v=!1,S=[]){this.cache=this.cache||{};const D=!!this.style.map.terrain,k=this.style.projection,j=v?oa.projectionMercator:k.shaderPreludeCode,H=v?ms:k.shaderDefine,J=s+(d?d.cacheKey:"")+`/${v?sa:k.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(D?"/terrain":"")+(S?`/${S.join("/")}`:"");return this.cache[J]||(this.cache[J]=new hf(this.context,oa[s],d,kc[s],this._showOverdrawInspector,D,j,H,S)),this.cache[J]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const s=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(s.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new i.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){var s,d;if(this._tileTextures){for(const v in this._tileTextures){const S=this._tileTextures[v];if(S)for(const D of S)D.destroy()}this._tileTextures={}}if(this.tileExtentBuffer&&this.tileExtentBuffer.destroy(),this.debugBuffer&&this.debugBuffer.destroy(),this.rasterBoundsBuffer&&this.rasterBoundsBuffer.destroy(),this.rasterBoundsBufferPosOnly&&this.rasterBoundsBufferPosOnly.destroy(),this.viewportBuffer&&this.viewportBuffer.destroy(),this.tileBorderIndexBuffer&&this.tileBorderIndexBuffer.destroy(),this.quadTriangleIndexBuffer&&this.quadTriangleIndexBuffer.destroy(),this.tileExtentMesh&&((s=this.tileExtentMesh.vertexBuffer)===null||s===void 0||s.destroy()),this.tileExtentMesh&&((d=this.tileExtentMesh.indexBuffer)===null||d===void 0||d.destroy()),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.cache){for(const v in this.cache){const S=this.cache[v];S&&S.program&&this.context.gl.deleteProgram(S.program)}this.cache={}}this.context&&this.context.setDefault()}overLimit(){const{drawingBufferWidth:s,drawingBufferHeight:d}=this.context.gl;return this.width!==s||this.height!==d}}function ed(C,s){let d,v=!1,S=null,D=null;const k=()=>{S=null,v&&(C.apply(D,d),S=setTimeout(k,s),v=!1)};return(...j)=>(v=!0,D=this,d=j,S||k(),S)}class sh{constructor(s){this._getCurrentHash=()=>{const d=window.location.hash.replace("#","");if(this._hashName){let v;return d.split("&").map(S=>S.split("=")).forEach(S=>{S[0]===this._hashName&&(v=S)}),(v&&v[1]||"").split("/")}return d.split("/")},this._onHashChange=()=>{const d=this._getCurrentHash();if(!this._isValidHash(d))return!1;const v=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(d[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+d[2],+d[1]],zoom:+d[0],bearing:v,pitch:+(d[4]||0)}),!0},this._updateHashUnthrottled=()=>{const d=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,d)},this._removeHash=()=>{const d=this._getCurrentHash();if(d.length===0)return;const v=d.join("/");let S=v;S.split("&").length>0&&(S=S.split("&")[0]),this._hashName&&(S=`${this._hashName}=${v}`);let D=window.location.hash.replace(S,"");D.startsWith("#&")?D=D.slice(0,1)+D.slice(2):D==="#"&&(D="");let k=window.location.href.replace(/(#.+)?$/,D);k=k.replace("&&","&"),window.history.replaceState(window.history.state,null,k)},this._updateHash=ed(this._updateHashUnthrottled,300),this._hashName=s&&encodeURIComponent(s)}addTo(s){return this._map=s,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(s){const d=this._map.getCenter(),v=Math.round(100*this._map.getZoom())/100,S=Math.ceil((v*Math.LN2+Math.log(512/360/.5))/Math.LN10),D=Math.pow(10,S),k=Math.round(d.lng*D)/D,j=Math.round(d.lat*D)/D,H=this._map.getBearing(),J=this._map.getPitch();let et="";if(et+=s?`/${k}/${j}/${v}`:`${v}/${j}/${k}`,(H||J)&&(et+="/"+Math.round(10*H)/10),J&&(et+=`/${Math.round(J)}`),this._hashName){const mt=this._hashName;let dt=!1;const Tt=window.location.hash.slice(1).split("&").map(pt=>{const It=pt.split("=")[0];return It===mt?(dt=!0,`${It}=${et}`):pt}).filter(pt=>pt);return dt||Tt.push(`${mt}=${et}`),`#${Tt.join("&")}`}return`#${et}`}_isValidHash(s){if(s.length<3||s.some(isNaN))return!1;try{new i.V(+s[2],+s[1])}catch{return!1}const d=+s[0],v=+(s[3]||0),S=+(s[4]||0);return d>=this._map.getMinZoom()&&d<=this._map.getMaxZoom()&&v>=-180&&v<=180&&S>=this._map.getMinPitch()&&S<=this._map.getMaxPitch()}}const Gh={linearity:.3,easing:i.cv(0,0,.3,1)},mf=i.e({deceleration:2500,maxSpeed:1400},Gh),id=i.e({deceleration:20,maxSpeed:1400},Gh),$h=i.e({deceleration:1e3,maxSpeed:360},Gh),yu=i.e({deceleration:1e3,maxSpeed:90},Gh),xl=i.e({deceleration:1e3,maxSpeed:360},Gh);class vl{constructor(s){this._map=s,this.clear()}clear(){this._inertiaBuffer=[]}record(s){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:Ci(),settings:s})}_drainInertiaBuffer(){const s=this._inertiaBuffer,d=Ci();for(;s.length>0&&d-s[0].time>160;)s.shift()}_onMoveEnd(s){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const d={zoom:0,bearing:0,pitch:0,roll:0,pan:new i.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:D}of this._inertiaBuffer)d.zoom+=D.zoomDelta||0,d.bearing+=D.bearingDelta||0,d.pitch+=D.pitchDelta||0,d.roll+=D.rollDelta||0,D.panDelta&&d.pan._add(D.panDelta),D.around&&(d.around=D.around),D.pinchAround&&(d.pinchAround=D.pinchAround);const v=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,S={};if(d.pan.mag()){const D=Nc(d.pan.mag(),v,i.e({},mf,s||{})),k=d.pan.mult(D.amount/d.pan.mag()),j=this._map.cameraHelper.handlePanInertia(k,this._map.transform);S.center=j.easingCenter,S.offset=j.easingOffset,Qs(S,D)}if(d.zoom){const D=Nc(d.zoom,v,id);S.zoom=this._map.transform.zoom+D.amount,Qs(S,D)}if(d.bearing){const D=Nc(d.bearing,v,$h);S.bearing=this._map.transform.bearing+i.an(D.amount,-179,179),Qs(S,D)}if(d.pitch){const D=Nc(d.pitch,v,yu);S.pitch=this._map.transform.pitch+D.amount,Qs(S,D)}if(d.roll){const D=Nc(d.roll,v,xl);S.roll=this._map.transform.roll+i.an(D.amount,-179,179),Qs(S,D)}if(S.zoom||S.bearing){const D=d.pinchAround===void 0?d.around:d.pinchAround;S.around=D?this._map.unproject(D):this._map.getCenter()}return this.clear(),i.e(S,{noMoveStart:!0})}}function Qs(C,s){(!C.duration||C.duration<s.duration)&&(C.duration=s.duration,C.easing=s.easing)}function Nc(C,s,d){const{maxSpeed:v,linearity:S,deceleration:D}=d,k=i.an(C*S/(s/1e3),-v,v),j=Math.abs(k)/(D*S);return{easing:d.easing,duration:1e3*j,amount:k*(j/2)}}class ns extends i.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,v,S={}){v=v instanceof MouseEvent?v:new MouseEvent(s,v);const D=Re.mousePos(d.getCanvas(),v),k=d.unproject(D);super(s,i.e({point:D,lngLat:k,originalEvent:v},S)),this._defaultPrevented=!1,this.target=d}}class xu extends i.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,v){const S=s==="touchend"?v.changedTouches:v.touches,D=Re.touchPos(d.getCanvasContainer(),S),k=D.map(H=>d.unproject(H)),j=D.reduce((H,J,et,mt)=>H.add(J.div(mt.length)),new i.P(0,0));super(s,{points:D,point:j,lngLats:k,lngLat:d.unproject(j),originalEvent:v}),this._defaultPrevented=!1}}class ah extends i.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(s,d,v){super(s,{originalEvent:v}),this._defaultPrevented=!1}}class Nd{constructor(s,d){this._map=s,this._clickTolerance=d.clickTolerance}reset(){delete this._mousedownPos}wheel(s){return this._firePreventable(new ah(s.type,this._map,s))}mousedown(s,d){return this._mousedownPos=d,this._firePreventable(new ns(s.type,this._map,s))}mouseup(s){this._map.fire(new ns(s.type,this._map,s))}click(s,d){this._mousedownPos&&this._mousedownPos.dist(d)>=this._clickTolerance||this._map.fire(new ns(s.type,this._map,s))}dblclick(s){return this._firePreventable(new ns(s.type,this._map,s))}mouseover(s){this._map.fire(new ns(s.type,this._map,s))}mouseout(s){this._map.fire(new ns(s.type,this._map,s))}touchstart(s){return this._firePreventable(new xu(s.type,this._map,s))}touchmove(s){this._map.fire(new xu(s.type,this._map,s))}touchend(s){this._map.fire(new xu(s.type,this._map,s))}touchcancel(s){this._map.fire(new xu(s.type,this._map,s))}_firePreventable(s){if(this._map.fire(s),s.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Sp{constructor(s){this._map=s}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(s){this._map.fire(new ns(s.type,this._map,s))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ns("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(s){this._delayContextMenu?this._contextMenuEvent=s:this._ignoreContextMenu||this._map.fire(new ns(s.type,this._map,s)),this._map.listens("contextmenu")&&s.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Vc{constructor(s){this._map=s}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(s){return this.transform.screenPointToLocation(i.P.convert(s),this._map.terrain)}}class Vd{constructor(s,d){this._map=s,this._tr=new Vc(s),this._el=s.getCanvasContainer(),this._container=s.getContainer(),this._clickTolerance=d.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(s,d){this.isEnabled()&&s.shiftKey&&s.button===0&&(Re.disableDrag(),this._startPos=this._lastPos=d,this._active=!0)}mousemoveWindow(s,d){if(!this._active)return;const v=d;if(this._lastPos.equals(v)||!this._box&&v.dist(this._startPos)<this._clickTolerance)return;const S=this._startPos;this._lastPos=v,this._box||(this._box=Re.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",s));const D=Math.min(S.x,v.x),k=Math.max(S.x,v.x),j=Math.min(S.y,v.y),H=Math.max(S.y,v.y);Re.setTransform(this._box,`translate(${D}px,${j}px)`),this._box.style.width=k-D+"px",this._box.style.height=H-j+"px"}mouseupWindow(s,d){if(!this._active||s.button!==0)return;const v=this._startPos,S=d;if(this.reset(),Re.suppressClick(),v.x!==S.x||v.y!==S.y)return this._map.fire(new i.l("boxzoomend",{originalEvent:s})),{cameraAnimation:D=>D.fitScreenCoordinates(v,S,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",s)}keydown(s){this._active&&s.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",s))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(Re.remove(this._box),this._box=null),Re.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(s,d){return this._map.fire(new i.l(s,{originalEvent:d}))}}function vu(C,s){if(C.length!==s.length)throw new Error(`The number of touches and points are not equal - touches ${C.length}, points ${s.length}`);const d={};for(let v=0;v<C.length;v++)d[C[v].identifier]=s[v];return d}class rd{constructor(s){this.reset(),this.numTouches=s.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(s,d,v){(this.centroid||v.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=s.timeStamp),v.length===this.numTouches&&(this.centroid=function(S){const D=new i.P(0,0);for(const k of S)D._add(k);return D.div(S.length)}(d),this.touches=vu(v,d)))}touchmove(s,d,v){if(this.aborted||!this.centroid)return;const S=vu(v,d);for(const D in this.touches){const k=S[D];(!k||k.dist(this.touches[D])>30)&&(this.aborted=!0)}}touchend(s,d,v){if((!this.centroid||s.timeStamp-this.startTime>500)&&(this.aborted=!0),v.length===0){const S=!this.aborted&&this.centroid;if(this.reset(),S)return S}}}class Kl{constructor(s){this.singleTap=new rd(s),this.numTaps=s.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(s,d,v){this.singleTap.touchstart(s,d,v)}touchmove(s,d,v){this.singleTap.touchmove(s,d,v)}touchend(s,d,v){const S=this.singleTap.touchend(s,d,v);if(S){const D=s.timeStamp-this.lastTime<500,k=!this.lastTap||this.lastTap.dist(S)<30;if(D&&k||this.reset(),this.count++,this.lastTime=s.timeStamp,this.lastTap=S,this.count===this.numTaps)return this.reset(),S}}}class ir{constructor(s){this._tr=new Vc(s),this._zoomIn=new Kl({numTouches:1,numTaps:2}),this._zoomOut=new Kl({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(s,d,v){this._zoomIn.touchstart(s,d,v),this._zoomOut.touchstart(s,d,v)}touchmove(s,d,v){this._zoomIn.touchmove(s,d,v),this._zoomOut.touchmove(s,d,v)}touchend(s,d,v){const S=this._zoomIn.touchend(s,d,v),D=this._zoomOut.touchend(s,d,v),k=this._tr;return S?(this._active=!0,s.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:j=>j.easeTo({duration:300,zoom:k.zoom+1,around:k.unproject(S)},{originalEvent:s})}):D?(this._active=!0,s.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:j=>j.easeTo({duration:300,zoom:k.zoom-1,around:k.unproject(D)},{originalEvent:s})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class bu{constructor(s){this._enabled=!!s.enable,this._moveStateManager=s.moveStateManager,this._clickTolerance=s.clickTolerance||1,this._moveFunction=s.move,this._activateOnStart=!!s.activateOnStart,s.assignEvents(this),this.reset()}reset(s){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(s)}_move(...s){const d=this._moveFunction(...s);if(d.bearingDelta||d.pitchDelta||d.rollDelta||d.around||d.panDelta)return this._active=!0,d}dragStart(s,d){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(s)&&(this._moveStateManager.startMove(s),this._lastPoint=Array.isArray(d)?d[0]:d,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(s,d){if(!this.isEnabled())return;const v=this._lastPoint;if(!v)return;if(s.preventDefault(),!this._moveStateManager.isValidMoveEvent(s))return void this.reset(s);const S=Array.isArray(d)?d[0]:d;return!this._moved&&S.dist(v)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=S,this._move(v,S))}dragEnd(s){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(s)&&(this._moved&&Re.suppressClick(),this.reset(s))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const Ip=0,Yf=2,Ud={[Ip]:1,[Yf]:2};class lh{constructor(s){this._correctEvent=s.checkCorrectEvent}startMove(s){const d=Re.mouseButton(s);this._eventButton=d}endMove(s){delete this._eventButton}isValidStartEvent(s){return this._correctEvent(s)}isValidMoveEvent(s){return!function(d,v){const S=Ud[v];return d.buttons===void 0||(d.buttons&S)!==S}(s,this._eventButton)}isValidEndEvent(s){return Re.mouseButton(s)===this._eventButton}}class nd{constructor(){this._firstTouch=void 0}_isOneFingerTouch(s){return s.targetTouches.length===1}_isSameTouchEvent(s){return s.targetTouches[0].identifier===this._firstTouch}startMove(s){this._firstTouch=s.targetTouches[0].identifier}endMove(s){delete this._firstTouch}isValidStartEvent(s){return this._isOneFingerTouch(s)}isValidMoveEvent(s){return this._isOneFingerTouch(s)&&this._isSameTouchEvent(s)}isValidEndEvent(s){return this._isOneFingerTouch(s)&&this._isSameTouchEvent(s)}}class gf{constructor(s=new lh({checkCorrectEvent:()=>!0}),d=new nd){this.mouseMoveStateManager=s,this.oneFingerTouchMoveStateManager=d}_executeRelevantHandler(s,d,v){return s instanceof MouseEvent?d(s):typeof TouchEvent<"u"&&s instanceof TouchEvent?v(s):void 0}startMove(s){this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.startMove(d),d=>this.oneFingerTouchMoveStateManager.startMove(d))}endMove(s){this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.endMove(d),d=>this.oneFingerTouchMoveStateManager.endMove(d))}isValidStartEvent(s){return this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.isValidStartEvent(d),d=>this.oneFingerTouchMoveStateManager.isValidStartEvent(d))}isValidMoveEvent(s){return this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.isValidMoveEvent(d),d=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(d))}isValidEndEvent(s){return this._executeRelevantHandler(s,d=>this.mouseMoveStateManager.isValidEndEvent(d),d=>this.oneFingerTouchMoveStateManager.isValidEndEvent(d))}}const qh=C=>{C.mousedown=C.dragStart,C.mousemoveWindow=C.dragMove,C.mouseup=C.dragEnd,C.contextmenu=s=>{s.preventDefault()}};class _f{constructor(s,d){this._clickTolerance=s.clickTolerance||1,this._map=d,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new i.P(0,0)}_shouldBePrevented(s){return s<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(s,d,v){return this._calculateTransform(s,d,v)}touchmove(s,d,v){if(this._active){if(!this._shouldBePrevented(v.length))return s.preventDefault(),this._calculateTransform(s,d,v);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",s)}}touchend(s,d,v){this._calculateTransform(s,d,v),this._active&&this._shouldBePrevented(v.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(s,d,v){v.length>0&&(this._active=!0);const S=vu(v,d),D=new i.P(0,0),k=new i.P(0,0);let j=0;for(const J in S){const et=S[J],mt=this._touches[J];mt&&(D._add(et),k._add(et.sub(mt)),j++,S[J]=et)}if(this._touches=S,this._shouldBePrevented(j)||!k.mag())return;const H=k.div(j);return this._sum._add(H),this._sum.mag()<this._clickTolerance?void 0:{around:D.div(j),panDelta:H}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Uc{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(s,d,v){this._firstTwoTouches||v.length<2||(this._firstTwoTouches=[v[0].identifier,v[1].identifier],this._start([d[0],d[1]]))}touchmove(s,d,v){if(!this._firstTwoTouches)return;s.preventDefault();const[S,D]=this._firstTwoTouches,k=od(v,d,S),j=od(v,d,D);if(!k||!j)return;const H=this._aroundCenter?null:k.add(j).div(2);return this._move([k,j],H,s)}touchend(s,d,v){if(!this._firstTwoTouches)return;const[S,D]=this._firstTwoTouches,k=od(v,d,S),j=od(v,d,D);k&&j||(this._active&&Re.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(s){this._enabled=!0,this._aroundCenter=!!s&&s.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function od(C,s,d){for(let v=0;v<C.length;v++)if(C[v].identifier===d)return s[v]}function Ep(C,s){return Math.log(C/s)/Math.LN2}class yf extends Uc{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(s){this._startDistance=this._distance=s[0].dist(s[1])}_move(s,d){const v=this._distance;if(this._distance=s[0].dist(s[1]),this._active||!(Math.abs(Ep(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Ep(this._distance,v),pinchAround:d}}}function jd(C,s){return 180*C.angleWith(s)/Math.PI}class fc extends Uc{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(s){this._startVector=this._vector=s[0].sub(s[1]),this._minDiameter=s[0].dist(s[1])}_move(s,d,v){const S=this._vector;if(this._vector=s[0].sub(s[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:jd(this._vector,S),pinchAround:d}}_isBelowThreshold(s){this._minDiameter=Math.min(this._minDiameter,s.mag());const d=25/(Math.PI*this._minDiameter)*360,v=jd(s,this._startVector);return Math.abs(v)<d}}function wu(C){return Math.abs(C.y)>Math.abs(C.x)}class sd extends Uc{constructor(s){super(),this._currentTouchCount=0,this._map=s}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(s,d,v){super.touchstart(s,d,v),this._currentTouchCount=v.length}_start(s){this._lastPoints=s,wu(s[0].sub(s[1]))&&(this._valid=!1)}_move(s,d,v){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const S=s[0].sub(this._lastPoints[0]),D=s[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(S,D,v.timeStamp),this._valid?(this._lastPoints=s,this._active=!0,{pitchDelta:(S.y+D.y)/2*-.5}):void 0}gestureBeginsVertically(s,d,v){if(this._valid!==void 0)return this._valid;const S=s.mag()>=2,D=d.mag()>=2;if(!S&&!D)return;if(!S||!D)return this._firstMove===void 0&&(this._firstMove=v),v-this._firstMove<100&&void 0;const k=s.y>0==d.y>0;return wu(s)&&wu(d)&&k}}const Tu={panStep:100,bearingStep:15,pitchStep:10};class ch{constructor(s){this._tr=new Vc(s);const d=Tu;this._panStep=d.panStep,this._bearingStep=d.bearingStep,this._pitchStep=d.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(s){if(s.altKey||s.ctrlKey||s.metaKey)return;let d=0,v=0,S=0,D=0,k=0;switch(s.keyCode){case 61:case 107:case 171:case 187:d=1;break;case 189:case 109:case 173:d=-1;break;case 37:s.shiftKey?v=-1:(s.preventDefault(),D=-1);break;case 39:s.shiftKey?v=1:(s.preventDefault(),D=1);break;case 38:s.shiftKey?S=1:(s.preventDefault(),k=-1);break;case 40:s.shiftKey?S=-1:(s.preventDefault(),k=1);break;default:return}return this._rotationDisabled&&(v=0,S=0),{cameraAnimation:j=>{const H=this._tr;j.easeTo({duration:300,easeId:"keyboardHandler",easing:jc,zoom:d?Math.round(H.zoom)+d*(s.shiftKey?2:1):H.zoom,bearing:H.bearing+v*this._bearingStep,pitch:H.pitch+S*this._pitchStep,offset:[-D*this._panStep,-k*this._panStep],center:H.center},{originalEvent:s})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function jc(C){return C*(2-C)}const wo=4.000244140625,xf=1/450;class Su{constructor(s,d){this._onTimeout=v=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(v)},this._map=s,this._tr=new Vc(s),this._triggerRenderFrame=d,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=xf}setZoomRate(s){this._defaultZoomRate=s}setWheelZoomRate(s){this._wheelZoomRate=s}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(s){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!s&&s.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(s){return!!this._map.cooperativeGestures.isEnabled()&&!(s.ctrlKey||this._map.cooperativeGestures.isBypassed(s))}wheel(s){if(!this.isEnabled())return;if(this._shouldBePrevented(s))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",s);let d=s.deltaMode===WheelEvent.DOM_DELTA_LINE?40*s.deltaY:s.deltaY;const v=Ci(),S=v-(this._lastWheelEventTime||0);this._lastWheelEventTime=v,d!==0&&d%wo==0?this._type="wheel":d!==0&&Math.abs(d)<4?this._type="trackpad":S>400?(this._type=null,this._lastValue=d,this._timeout=setTimeout(this._onTimeout,40,s)):this._type||(this._type=Math.abs(S*d)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,d+=this._lastValue)),s.shiftKey&&d&&(d/=4),this._type&&(this._lastWheelEvent=s,this._delta-=d,this._active||this._start(s)),s.preventDefault()}_start(s){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const d=Re.mousePos(this._map.getCanvas(),s),v=this._tr;this._aroundPoint=this._aroundCenter?v.transform.locationToScreenPoint(i.V.convert(v.center)):d,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const s=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const j=s.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=j),typeof this._targetZoom=="number"&&(this._targetZoom+=j)}if(this._delta!==0){const j=this._type==="wheel"&&Math.abs(this._delta)>wo?this._wheelZoomRate:this._defaultZoomRate;let H=2/(1+Math.exp(-Math.abs(this._delta*j)));this._delta<0&&H!==0&&(H=1/H);const J=typeof this._targetZoom!="number"?s.scale:i.aq(this._targetZoom);this._targetZoom=s.applyConstrain(s.getCameraLngLat(),i.at(J*H)).zoom,this._type==="wheel"&&(this._startZoom=s.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const d=typeof this._targetZoom!="number"?s.zoom:this._targetZoom,v=this._startZoom,S=this._easing;let D,k=!1;if(this._type==="wheel"&&v&&S){const j=Ci()-this._lastWheelEventTime,H=Math.min((j+5)/200,1),J=S(H);D=i.G.number(v,d,J),H<1?this._frameId||(this._frameId=!0):k=!0}else D=d,k=!0;return this._active=!0,k&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout},200)),this._lastExpectedZoom=D,{noInertia:!0,needsRenderFrame:!k,zoomDelta:D-s.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(s){let d=i.cx;if(this._prevEase){const v=this._prevEase,S=(Ci()-v.start)/v.duration,D=v.easing(S+.01)-v.easing(S),k=.27/Math.sqrt(D*D+1e-4)*.01,j=Math.sqrt(.0729-k*k);d=i.cv(k,j,.25,1)}return this._prevEase={start:Ci(),duration:s,easing:d},d}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Zh{constructor(s,d){this._clickZoom=s,this._tapZoom=d}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ad{constructor(s){this._tr=new Vc(s),this.reset()}reset(){this._active=!1}dblclick(s,d){return s.preventDefault(),{cameraAnimation:v=>{v.easeTo({duration:300,zoom:this._tr.zoom+(s.shiftKey?-1:1),around:this._tr.unproject(d)},{originalEvent:s})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ap{constructor(){this._tap=new Kl({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(s,d,v){if(!this._swipePoint)if(this._tapTime){const S=d[0],D=s.timeStamp-this._tapTime<500,k=this._tapPoint.dist(S)<30;D&&k?v.length>0&&(this._swipePoint=S,this._swipeTouch=v[0].identifier):this.reset()}else this._tap.touchstart(s,d,v)}touchmove(s,d,v){if(this._tapTime){if(this._swipePoint){if(v[0].identifier!==this._swipeTouch)return;const S=d[0],D=S.y-this._swipePoint.y;return this._swipePoint=S,s.preventDefault(),this._active=!0,{zoomDelta:D/128}}}else this._tap.touchmove(s,d,v)}touchend(s,d,v){if(this._tapTime)this._swipePoint&&v.length===0&&this.reset();else{const S=this._tap.touchend(s,d,v);S&&(this._tapTime=s.timeStamp,this._tapPoint=S)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ld{constructor(s,d,v){this._el=s,this._mousePan=d,this._touchPan=v}enable(s){this._inertiaOptions=s||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Hh{constructor(s,d,v,S){this._pitchWithRotate=s.pitchWithRotate,this._rollEnabled=s.rollEnabled,this._mouseRotate=d,this._mousePitch=v,this._mouseRoll=S}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class Jf{constructor(s,d,v,S){this._el=s,this._touchZoom=d,this._touchRotate=v,this._tapDragZoom=S,this._rotationDisabled=!1,this._enabled=!0}enable(s){this._touchZoom.enable(s),this._rotationDisabled||this._touchRotate.enable(s),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class da{constructor(s,d){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=s,this._options=d,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const s=this._map.getCanvasContainer();s.classList.add("maplibregl-cooperative-gestures"),this._container=Re.create("div","maplibregl-cooperative-gesture-screen",s);let d=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(d=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const v=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),S=document.createElement("div");S.className="maplibregl-desktop-message",S.textContent=d,this._container.appendChild(S);const D=document.createElement("div");D.className="maplibregl-mobile-message",D.textContent=v,this._container.appendChild(D),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(Re.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(s){return s[this._bypassKey]}notifyGestureBlocked(s,d){this._enabled&&(this._map.fire(new i.l("cooperativegestureprevented",{gestureType:s,originalEvent:d})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const Wh=C=>C.zoom||C.drag||C.roll||C.pitch||C.rotate;class Ir extends i.l{}function Or(C){return C.panDelta&&C.panDelta.mag()||C.zoomDelta||C.bearingDelta||C.pitchDelta||C.rollDelta}class Xh{constructor(s,d){this.handleWindowEvent=S=>{this.handleEvent(S,`${S.type}Window`)},this.handleEvent=(S,D)=>{if(S.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const k=S.type==="renderFrame"?void 0:S,j={needsRenderFrame:!1},H={},J={};for(const{handlerName:dt,handler:Tt,allowed:pt}of this._handlers){if(!Tt.isEnabled())continue;let It;if(this._blockedByActive(J,pt,dt))Tt.reset();else if(Tt[D||S.type]){if(i.cy(S,D||S.type)){const Kt=Re.mousePos(this._map.getCanvas(),S);It=Tt[D||S.type](S,Kt)}else if(i.cz(S,D||S.type)){const Kt=this._getMapTouches(S.touches),Wt=Re.touchPos(this._map.getCanvas(),Kt);It=Tt[D||S.type](S,Wt,Kt)}else i.cA(D||S.type)||(It=Tt[D||S.type](S));this.mergeHandlerResult(j,H,It,dt,k),It&&It.needsRenderFrame&&this._triggerRenderFrame()}(It||Tt.isActive())&&(J[dt]=Tt)}const et={};for(const dt in this._previousActiveHandlers)J[dt]||(et[dt]=k);this._previousActiveHandlers=J,(Object.keys(et).length||Or(j))&&(this._changes.push([j,H,et]),this._triggerRenderFrame()),(Object.keys(J).length||Or(j))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:mt}=j;mt&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],mt(this._map))},this._map=s,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new vl(s),this._bearingSnap=d.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(d);const v=this._el;this._listeners=[[v,"touchstart",{passive:!0}],[v,"touchmove",{passive:!1}],[v,"touchend",void 0],[v,"touchcancel",void 0],[v,"mousedown",void 0],[v,"mousemove",void 0],[v,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[v,"mouseover",void 0],[v,"mouseout",void 0],[v,"dblclick",void 0],[v,"click",void 0],[v,"keydown",{capture:!1}],[v,"keyup",void 0],[v,"wheel",{passive:!1}],[v,"contextmenu",void 0],[window,"blur",void 0]];for(const[S,D,k]of this._listeners)Re.addEventListener(S,D,S===document?this.handleWindowEvent:this.handleEvent,k)}destroy(){for(const[s,d,v]of this._listeners)Re.removeEventListener(s,d,s===document?this.handleWindowEvent:this.handleEvent,v)}_addDefaultHandlers(s){const d=this._map,v=d.getCanvasContainer();this._add("mapEvent",new Nd(d,s));const S=d.boxZoom=new Vd(d,s);this._add("boxZoom",S),s.interactive&&s.boxZoom&&S.enable();const D=d.cooperativeGestures=new da(d,s.cooperativeGestures);this._add("cooperativeGestures",D),s.cooperativeGestures&&D.enable();const k=new ir(d),j=new ad(d);d.doubleClickZoom=new Zh(j,k),this._add("tapZoom",k),this._add("clickZoom",j),s.interactive&&s.doubleClickZoom&&d.doubleClickZoom.enable();const H=new Ap;this._add("tapDragZoom",H);const J=d.touchPitch=new sd(d);this._add("touchPitch",J),s.interactive&&s.touchPitch&&d.touchPitch.enable(s.touchPitch);const et=()=>d.project(d.getCenter()),mt=function({enable:he,clickTolerance:me,aroundCenter:be=!0,minPixelCenterThreshold:de=100,rotateDegreesPerPixelMoved:Ce=.8},Qe){const Xe=new lh({checkCorrectEvent:Je=>Re.mouseButton(Je)===0&&Je.ctrlKey||Re.mouseButton(Je)===2&&!Je.ctrlKey});return new bu({clickTolerance:me,move:(Je,ii)=>{const Ri=Qe();if(be&&Math.abs(Ri.y-Je.y)>de)return{bearingDelta:i.cw(new i.P(Je.x,ii.y),ii,Ri)};let Oi=(ii.x-Je.x)*Ce;return be&&ii.y<Ri.y&&(Oi=-Oi),{bearingDelta:Oi}},moveStateManager:Xe,enable:he,assignEvents:qh})}(s,et),dt=function({enable:he,clickTolerance:me,pitchDegreesPerPixelMoved:be=-.5}){const de=new lh({checkCorrectEvent:Ce=>Re.mouseButton(Ce)===0&&Ce.ctrlKey||Re.mouseButton(Ce)===2});return new bu({clickTolerance:me,move:(Ce,Qe)=>({pitchDelta:(Qe.y-Ce.y)*be}),moveStateManager:de,enable:he,assignEvents:qh})}(s),Tt=function({enable:he,clickTolerance:me,rollDegreesPerPixelMoved:be=.3},de){const Ce=new lh({checkCorrectEvent:Qe=>Re.mouseButton(Qe)===2&&Qe.ctrlKey});return new bu({clickTolerance:me,move:(Qe,Xe)=>{const Je=de();let ii=(Xe.x-Qe.x)*be;return Xe.y<Je.y&&(ii=-ii),{rollDelta:ii}},moveStateManager:Ce,enable:he,assignEvents:qh})}(s,et);d.dragRotate=new Hh(s,mt,dt,Tt),this._add("mouseRotate",mt,["mousePitch"]),this._add("mousePitch",dt,["mouseRotate","mouseRoll"]),this._add("mouseRoll",Tt,["mousePitch"]),s.interactive&&s.dragRotate&&d.dragRotate.enable();const pt=function({enable:he,clickTolerance:me}){const be=new lh({checkCorrectEvent:de=>Re.mouseButton(de)===0&&!de.ctrlKey});return new bu({clickTolerance:me,move:(de,Ce)=>({around:Ce,panDelta:Ce.sub(de)}),activateOnStart:!0,moveStateManager:be,enable:he,assignEvents:qh})}(s),It=new _f(s,d);d.dragPan=new ld(v,pt,It),this._add("mousePan",pt),this._add("touchPan",It,["touchZoom","touchRotate"]),s.interactive&&s.dragPan&&d.dragPan.enable(s.dragPan);const Kt=new fc,Wt=new yf;d.touchZoomRotate=new Jf(v,Wt,Kt,H),this._add("touchRotate",Kt,["touchPan","touchZoom"]),this._add("touchZoom",Wt,["touchPan","touchRotate"]),s.interactive&&s.touchZoomRotate&&d.touchZoomRotate.enable(s.touchZoomRotate),this._add("blockableMapEvent",new Sp(d));const ft=d.scrollZoom=new Su(d,()=>this._triggerRenderFrame());this._add("scrollZoom",ft,["mousePan"]),s.interactive&&s.scrollZoom&&d.scrollZoom.enable(s.scrollZoom);const _e=d.keyboard=new ch(d);this._add("keyboard",_e),s.interactive&&s.keyboard&&d.keyboard.enable()}_add(s,d,v){this._handlers.push({handlerName:s,handler:d,allowed:v}),this._handlersById[s]=d}stop(s){if(!this._updatingCamera){for(const{handler:d}of this._handlers)d.reset();this._inertia.clear(),this._fireEvents({},{},s),this._changes=[]}}isActive(){for(const{handler:s}of this._handlers)if(s.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Wh(this._eventsInProgress)||this.isZooming()}_blockedByActive(s,d,v){for(const S in s)if(S!==v&&(!d||d.indexOf(S)<0))return!0;return!1}_getMapTouches(s){const d=[];for(const v of s)this._el.contains(v.target)&&d.push(v);return d}mergeHandlerResult(s,d,v,S,D){if(!v)return;i.e(s,v);const k={handlerName:S,originalEvent:v.originalEvent||D};v.zoomDelta!==void 0&&(d.zoom=k),v.panDelta!==void 0&&(d.drag=k),v.rollDelta!==void 0&&(d.roll=k),v.pitchDelta!==void 0&&(d.pitch=k),v.bearingDelta!==void 0&&(d.rotate=k)}_applyChanges(){const s={},d={},v={};for(const[S,D,k]of this._changes)S.panDelta&&(s.panDelta=(s.panDelta||new i.P(0,0))._add(S.panDelta)),S.zoomDelta&&(s.zoomDelta=(s.zoomDelta||0)+S.zoomDelta),S.bearingDelta&&(s.bearingDelta=(s.bearingDelta||0)+S.bearingDelta),S.pitchDelta&&(s.pitchDelta=(s.pitchDelta||0)+S.pitchDelta),S.rollDelta&&(s.rollDelta=(s.rollDelta||0)+S.rollDelta),S.around!==void 0&&(s.around=S.around),S.pinchAround!==void 0&&(s.pinchAround=S.pinchAround),S.noInertia&&(s.noInertia=S.noInertia),i.e(d,D),i.e(v,k);this._updateMapTransform(s,d,v),this._changes=[]}_updateMapTransform(s,d,v){const S=this._map,D=S._getTransformForUpdate(),k=S.terrain;if(!(Or(s)||k&&this._terrainMovement))return this._fireEvents(d,v,!0);S._stop(!0);let{panDelta:j,zoomDelta:H,bearingDelta:J,pitchDelta:et,rollDelta:mt,around:dt,pinchAround:Tt}=s;Tt!==void 0&&(dt=Tt),dt=dt||S.transform.centerPoint,k&&!D.isPointOnMapSurface(dt)&&(dt=D.centerPoint);const pt={panDelta:j,zoomDelta:H,rollDelta:mt,pitchDelta:et,bearingDelta:J,around:dt};this._map.cameraHelper.useGlobeControls&&!D.isPointOnMapSurface(dt)&&(dt=D.centerPoint);const It=dt.distSqr(D.centerPoint)<.01?D.center:D.screenPointToLocation(j?dt.sub(j):dt);this._handleMapControls({terrain:k,tr:D,deltasForHelper:pt,preZoomAroundLoc:It,combinedEventsInProgress:d,panDelta:j}),S._applyUpdatedTransform(D),this._map._update(),s.noInertia||this._inertia.record(s),this._fireEvents(d,v,!0)}_handleMapControls({terrain:s,tr:d,deltasForHelper:v,preZoomAroundLoc:S,combinedEventsInProgress:D,panDelta:k}){const j=this._map.cameraHelper;if(j.handleMapControlsRollPitchBearingZoom(v,d),s)return j.useGlobeControls?(this._terrainMovement||!D.drag&&!D.zoom||(this._terrainMovement=!0,this._map._elevationFreeze=!0),void j.handleMapControlsPan(v,d,S)):this._terrainMovement||!D.drag&&!D.zoom?void(D.drag&&this._terrainMovement&&k?d.setCenter(d.screenPointToLocation(d.centerPoint.sub(k))):j.handleMapControlsPan(v,d,S)):(this._terrainMovement=!0,this._map._elevationFreeze=!0,void j.handleMapControlsPan(v,d,S));j.handleMapControlsPan(v,d,S)}_fireEvents(s,d,v){const S=Wh(this._eventsInProgress),D=Wh(s),k={};for(const mt in s){const{originalEvent:dt}=s[mt];this._eventsInProgress[mt]||(k[`${mt}start`]=dt),this._eventsInProgress[mt]=s[mt]}!S&&D&&this._fireEvent("movestart",D.originalEvent);for(const mt in k)this._fireEvent(mt,k[mt]);D&&this._fireEvent("move",D.originalEvent);for(const mt in s){const{originalEvent:dt}=s[mt];this._fireEvent(mt,dt)}const j={};let H;for(const mt in this._eventsInProgress){const{handlerName:dt,originalEvent:Tt}=this._eventsInProgress[mt];this._handlersById[dt].isActive()||(delete this._eventsInProgress[mt],H=d[dt]||Tt,j[`${mt}end`]=H)}for(const mt in j)this._fireEvent(mt,j[mt]);const J=Wh(this._eventsInProgress),et=(S||D)&&!J;if(et&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const mt=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&mt.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(mt)}if(v&&et){this._updatingCamera=!0;const mt=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),dt=Tt=>Tt!==0&&-this._bearingSnap<Tt&&Tt<this._bearingSnap;!mt||!mt.essential&&Rr.prefersReducedMotion?(this._map.fire(new i.l("moveend",{originalEvent:H})),dt(this._map.getBearing())&&this._map.resetNorth()):(dt(mt.bearing||this._map.getBearing())&&(mt.bearing=0),mt.freezeElevation=!0,this._map.easeTo(mt,{originalEvent:H})),this._updatingCamera=!1}}_fireEvent(s,d){this._map.fire(new i.l(s,d?{originalEvent:d}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(s=>{delete this._frameId,this.handleEvent(new Ir("renderFrame",{timeStamp:s})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class mc extends i.E{constructor(s,d,v){super(),this._renderFrameCallback=()=>{const S=Math.min((Ci()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(S)),S<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=s,this._bearingSnap=v.bearingSnap,this.cameraHelper=d,this.on("moveend",()=>{delete this._requestedCameraState})}migrateProjection(s,d){s.apply(this.transform),this.transform=s,this.cameraHelper=d}getCenter(){return new i.V(this.transform.center.lng,this.transform.center.lat)}setCenter(s,d){return this.jumpTo({center:s},d)}getCenterElevation(){return this.transform.elevation}setCenterElevation(s,d){return this.jumpTo({elevation:s},d),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(s){this._centerClampedToGround=s}panBy(s,d,v){return s=i.P.convert(s).mult(-1),this.panTo(this.transform.center,i.e({offset:s},d),v)}panTo(s,d,v){return this.easeTo(i.e({center:s},d),v)}getZoom(){return this.transform.zoom}setZoom(s,d){return this.jumpTo({zoom:s},d),this}zoomTo(s,d,v){return this.easeTo(i.e({zoom:s},d),v)}zoomIn(s,d){return this.zoomTo(this.getZoom()+1,s,d),this}zoomOut(s,d){return this.zoomTo(this.getZoom()-1,s,d),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(s,d){return s!=this.transform.fov&&(this.transform.setFov(s),this.fire(new i.l("movestart",d)).fire(new i.l("move",d)).fire(new i.l("moveend",d))),this}getBearing(){return this.transform.bearing}setBearing(s,d){return this.jumpTo({bearing:s},d),this}getPadding(){return this.transform.padding}setPadding(s,d){return this.jumpTo({padding:s},d),this}rotateTo(s,d,v){return this.easeTo(i.e({bearing:s},d),v)}resetNorth(s,d){return this.rotateTo(0,i.e({duration:1e3},s),d),this}resetNorthPitch(s,d){return this.easeTo(i.e({bearing:0,pitch:0,roll:0,duration:1e3},s),d),this}snapToNorth(s,d){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(s,d):this}getPitch(){return this.transform.pitch}setPitch(s,d){return this.jumpTo({pitch:s},d),this}getRoll(){return this.transform.roll}setRoll(s,d){return this.jumpTo({roll:s},d),this}cameraForBounds(s,d){s=xo.convert(s).adjustAntiMeridian();const v=d&&d.bearing||0;return this._cameraForBoxAndBearing(s.getNorthWest(),s.getSouthEast(),v,d)}_cameraForBoxAndBearing(s,d,v,S){const D={top:0,bottom:0,right:0,left:0};if(typeof(S=i.e({padding:D,offset:[0,0],maxZoom:this.transform.maxZoom},S)).padding=="number"){const J=S.padding;S.padding={top:J,bottom:J,right:J,left:J}}const k=i.e(D,S.padding);S.padding=k;const j=this.transform,H=new xo(s,d);return this.cameraHelper.cameraForBoxAndBearing(S,k,H,v,j)}fitBounds(s,d,v){return this._fitInternal(this.cameraForBounds(s,d),d,v)}fitScreenCoordinates(s,d,v,S,D){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(i.P.convert(s)),this.transform.screenPointToLocation(i.P.convert(d)),v,S),S,D)}_fitInternal(s,d,v){return s?(delete(d=i.e(s,d)).padding,d.linear?this.easeTo(d,v):this.flyTo(d,v)):this}jumpTo(s,d){this.stop();const v=this._getTransformForUpdate();let S=!1,D=!1,k=!1;const j=v.zoom;this.cameraHelper.handleJumpToCenterZoom(v,s);const H=v.zoom!==j;return"elevation"in s&&v.elevation!==+s.elevation&&v.setElevation(+s.elevation),"bearing"in s&&v.bearing!==+s.bearing&&(S=!0,v.setBearing(+s.bearing)),"pitch"in s&&v.pitch!==+s.pitch&&(D=!0,v.setPitch(+s.pitch)),"roll"in s&&v.roll!==+s.roll&&(k=!0,v.setRoll(+s.roll)),s.padding==null||v.isPaddingEqual(s.padding)||v.setPadding(s.padding),this._applyUpdatedTransform(v),this.fire(new i.l("movestart",d)).fire(new i.l("move",d)),H&&this.fire(new i.l("zoomstart",d)).fire(new i.l("zoom",d)).fire(new i.l("zoomend",d)),S&&this.fire(new i.l("rotatestart",d)).fire(new i.l("rotate",d)).fire(new i.l("rotateend",d)),D&&this.fire(new i.l("pitchstart",d)).fire(new i.l("pitch",d)).fire(new i.l("pitchend",d)),k&&this.fire(new i.l("rollstart",d)).fire(new i.l("roll",d)).fire(new i.l("rollend",d)),this.fire(new i.l("moveend",d))}calculateCameraOptionsFromTo(s,d,v,S=0){const D=i.aa.fromLngLat(s,d),k=i.aa.fromLngLat(v,S),j=k.x-D.x,H=k.y-D.y,J=k.z-D.z,et=Math.hypot(j,H,J);if(et===0)throw new Error("Can't calculate camera options with same From and To");const mt=Math.hypot(j,H),dt=i.at(this.transform.cameraToCenterDistance/et/this.transform.tileSize),Tt=180*Math.atan2(j,-H)/Math.PI;let pt=180*Math.acos(mt/et)/Math.PI;return pt=J<0?90-pt:90+pt,{center:k.toLngLat(),elevation:S,zoom:dt,pitch:pt,bearing:Tt}}calculateCameraOptionsFromCameraLngLatAltRotation(s,d,v,S,D){const k=this.transform.calculateCenterFromCameraLngLatAlt(s,d,v,S);return{center:k.center,elevation:k.elevation,zoom:k.zoom,bearing:v,pitch:S,roll:D}}easeTo(s,d){this._stop(!1,s.easeId),((s=i.e({offset:[0,0],duration:500,easing:i.cx},s)).animate===!1||!s.essential&&Rr.prefersReducedMotion)&&(s.duration=0);const v=this._getTransformForUpdate(),S=this.getBearing(),D=v.pitch,k=v.roll,j="bearing"in s?this._normalizeBearing(s.bearing,S):S,H="pitch"in s?+s.pitch:D,J="roll"in s?this._normalizeBearing(s.roll,k):k,et="padding"in s?s.padding:v.padding,mt=i.P.convert(s.offset);let dt,Tt;s.around&&(dt=i.V.convert(s.around),Tt=v.locationToScreenPoint(dt));const pt={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},It=this.cameraHelper.handleEaseTo(v,{bearing:j,pitch:H,roll:J,padding:et,around:dt,aroundPoint:Tt,offsetAsPoint:mt,offset:s.offset,zoom:s.zoom,center:s.center});return this._rotating=this._rotating||S!==j,this._pitching=this._pitching||H!==D,this._rolling=this._rolling||J!==k,this._padding=!v.isPaddingEqual(et),this._zooming=this._zooming||It.isZooming,this._easeId=s.easeId,this._prepareEase(d,s.noMoveStart,pt),this.terrain&&this._prepareElevation(It.elevationCenter),this._ease(Kt=>{It.easeFunc(Kt),this.terrain&&!s.freezeElevation&&this._updateElevation(Kt),this._applyUpdatedTransform(v),this._fireMoveEvents(d)},Kt=>{this.terrain&&s.freezeElevation&&this._finalizeElevation(),this._afterEase(d,Kt)},s),this}_prepareEase(s,d,v={}){this._moving=!0,d||v.moving||this.fire(new i.l("movestart",s)),this._zooming&&!v.zooming&&this.fire(new i.l("zoomstart",s)),this._rotating&&!v.rotating&&this.fire(new i.l("rotatestart",s)),this._pitching&&!v.pitching&&this.fire(new i.l("pitchstart",s)),this._rolling&&!v.rolling&&this.fire(new i.l("rollstart",s))}_prepareElevation(s){this._elevationCenter=s,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(s,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(s){this._elevationStart!==void 0&&this._elevationCenter!==void 0||this._prepareElevation(this.transform.center),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const d=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(s<1&&d!==this._elevationTarget){const v=this._elevationTarget-this._elevationStart;this._elevationStart+=s*(v-(d-(v*s+this._elevationStart))/(1-s)),this._elevationTarget=d}this.transform.setElevation(i.G.number(this._elevationStart,this._elevationTarget,s))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(s){if(!this.terrain&&s.elevation>=0&&s.pitch<=90)return{};const d=s.getCameraLngLat(),v=s.getCameraAltitude(),S=this.terrain?this.terrain.getElevationForLngLatZoom(d,s.zoom):0;if(v<S){const D=this.calculateCameraOptionsFromTo(d,S,s.center,s.elevation);return{pitch:D.pitch,zoom:D.zoom}}return{}}_applyUpdatedTransform(s){const d=[];if(d.push(S=>this._elevateCameraIfInsideTerrain(S)),this.transformCameraUpdate&&d.push(S=>this.transformCameraUpdate(S)),!d.length)return;const v=s.clone();for(const S of d){const D=v.clone(),{center:k,zoom:j,roll:H,pitch:J,bearing:et,elevation:mt}=S(D);k&&D.setCenter(k),mt!==void 0&&D.setElevation(mt),j!==void 0&&D.setZoom(j),H!==void 0&&D.setRoll(H),J!==void 0&&D.setPitch(J),et!==void 0&&D.setBearing(et),v.apply(D)}this.transform.apply(v)}_fireMoveEvents(s){this.fire(new i.l("move",s)),this._zooming&&this.fire(new i.l("zoom",s)),this._rotating&&this.fire(new i.l("rotate",s)),this._pitching&&this.fire(new i.l("pitch",s)),this._rolling&&this.fire(new i.l("roll",s))}_afterEase(s,d){if(this._easeId&&d&&this._easeId===d)return;delete this._easeId;const v=this._zooming,S=this._rotating,D=this._pitching,k=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,v&&this.fire(new i.l("zoomend",s)),S&&this.fire(new i.l("rotateend",s)),D&&this.fire(new i.l("pitchend",s)),k&&this.fire(new i.l("rollend",s)),this.fire(new i.l("moveend",s))}flyTo(s,d){if(!s.essential&&Rr.prefersReducedMotion){const ii=i.U(s,["center","zoom","bearing","pitch","roll","elevation","padding"]);return this.jumpTo(ii,d)}this.stop(),s=i.e({offset:[0,0],speed:1.2,curve:1.42,easing:i.cx},s);const v=this._getTransformForUpdate(),S=v.bearing,D=v.pitch,k=v.roll,j=v.padding,H="bearing"in s?this._normalizeBearing(s.bearing,S):S,J="pitch"in s?+s.pitch:D,et="roll"in s?this._normalizeBearing(s.roll,k):k,mt="padding"in s?s.padding:v.padding,dt=i.P.convert(s.offset);let Tt=v.centerPoint.add(dt);const pt=v.screenPointToLocation(Tt),It=this.cameraHelper.handleFlyTo(v,{bearing:H,pitch:J,roll:et,padding:mt,locationAtOffset:pt,offsetAsPoint:dt,center:s.center,minZoom:s.minZoom,zoom:s.zoom});let Kt=s.curve;const Wt=Math.max(v.width,v.height),ft=Wt/It.scaleOfZoom,_e=It.pixelPathLength;typeof It.scaleOfMinZoom=="number"&&(Kt=Math.sqrt(Wt/It.scaleOfMinZoom/_e*2));const he=Kt*Kt;function me(ii){const Ri=(ft*ft-Wt*Wt+(ii?-1:1)*he*he*_e*_e)/(2*(ii?ft:Wt)*he*_e);return Math.log(Math.sqrt(Ri*Ri+1)-Ri)}function be(ii){return(Math.exp(ii)-Math.exp(-ii))/2}function de(ii){return(Math.exp(ii)+Math.exp(-ii))/2}const Ce=me(!1);let Qe=function(ii){return de(Ce)/de(Ce+Kt*ii)},Xe=function(ii){return Wt*((de(Ce)*(be(Ri=Ce+Kt*ii)/de(Ri))-be(Ce))/he)/_e;var Ri},Je=(me(!0)-Ce)/Kt;if(Math.abs(_e)<2e-6||!isFinite(Je)){if(Math.abs(Wt-ft)<1e-6)return this.easeTo(s,d);const ii=ft<Wt?-1:1;Je=Math.abs(Math.log(ft/Wt))/Kt,Xe=()=>0,Qe=Ri=>Math.exp(ii*Kt*Ri)}return s.duration="duration"in s?+s.duration:1e3*Je/("screenSpeed"in s?+s.screenSpeed/Kt:+s.speed),s.maxDuration&&s.duration>s.maxDuration&&(s.duration=0),this._zooming=!0,this._rotating=S!==H,this._pitching=J!==D,this._rolling=et!==k,this._padding=!v.isPaddingEqual(mt),this._prepareEase(d,!1),this.terrain&&this._prepareElevation(It.targetCenter),this._ease(ii=>{const Ri=ii*Je,Oi=1/Qe(Ri),Ti=Xe(Ri);this._rotating&&v.setBearing(i.G.number(S,H,ii)),this._pitching&&v.setPitch(i.G.number(D,J,ii)),this._rolling&&v.setRoll(i.G.number(k,et,ii)),this._padding&&(v.interpolatePadding(j,mt,ii),Tt=v.centerPoint.add(dt)),It.easeFunc(ii,Oi,Ti,Tt),this.terrain&&!s.freezeElevation&&this._updateElevation(ii),this._applyUpdatedTransform(v),this._fireMoveEvents(d)},()=>{this.terrain&&s.freezeElevation&&this._finalizeElevation(),this._afterEase(d)},s),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(s,d){var v;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const S=this._onEaseEnd;delete this._onEaseEnd,S.call(this,d)}return s||(v=this.handlers)===null||v===void 0||v.stop(!1),this}_ease(s,d,v){v.animate===!1||v.duration===0?(s(1),d()):(this._easeStart=Ci(),this._easeOptions=v,this._onEaseFrame=s,this._onEaseEnd=d,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(s,d){s=i.W(s,-180,180);const v=Math.abs(s-d);return Math.abs(s-360-d)<v&&(s-=360),Math.abs(s+360-d)<v&&(s+=360),s}queryTerrainElevation(s){return this.terrain?this.terrain.getElevationForLngLatZoom(i.V.convert(s),this.transform.tileZoom):null}}const hh={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class _s{constructor(s=hh){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=d=>{!d||d.sourceDataType!=="metadata"&&d.sourceDataType!=="visibility"&&d.dataType!=="style"&&d.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=s}getDefaultPosition(){return"bottom-right"}onAdd(s){return this._map=s,this._compact=this.options.compact,this._container=Re.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=Re.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=Re.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){Re.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(s,d){const v=this._map._getUIString(`AttributionControl.${d}`);s.title=v,s.setAttribute("aria-label",v)}_updateAttributions(){if(!this._map.style)return;let s=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?s=s.concat(this.options.customAttribution.map(S=>typeof S!="string"?"":S)):typeof this.options.customAttribution=="string"&&s.push(this.options.customAttribution)),this._map.style.stylesheet){const S=this._map.style.stylesheet;this.styleOwner=S.owner,this.styleId=S.id}const d=this._map.style.tileManagers;for(const S in d){const D=d[S];if(D.used||D.usedForTerrain){const k=D.getSource();k.attribution&&s.indexOf(k.attribution)<0&&s.push(k.attribution)}}s=s.filter(S=>String(S).trim()),s.sort((S,D)=>S.length-D.length),s=s.filter((S,D)=>{for(let k=D+1;k<s.length;k++)if(s[k].indexOf(S)>=0)return!1;return!0});const v=s.join(" | ");v!==this._attribHTML&&(this._attribHTML=v,s.length?(this._innerContainer.innerHTML=Re.sanitize(v),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class bl{constructor(s={}){this._updateCompact=()=>{const d=this._container.children;if(d.length){const v=d[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&v.classList.add("maplibregl-compact"):v.classList.remove("maplibregl-compact")}},this.options=s}getDefaultPosition(){return"bottom-left"}onAdd(s){this._map=s,this._compact=this.options&&this.options.compact,this._container=Re.create("div","maplibregl-ctrl");const d=Re.create("a","maplibregl-ctrl-logo");return d.target="_blank",d.rel="noopener nofollow",d.href="https://maplibre.org/",d.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),d.setAttribute("rel","noopener nofollow"),this._container.appendChild(d),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){Re.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Gd{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(s){const d=++this._id;return this._queue.push({callback:s,id:d,cancelled:!1}),d}remove(s){const d=this._currentlyRunning,v=d?this._queue.concat(d):this._queue;for(const S of v)if(S.id===s)return void(S.cancelled=!0)}run(s=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const d=this._currentlyRunning=this._queue;this._queue=[];for(const v of d)if(!v.cancelled&&(v.callback(s),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var Pp=i.aT([{name:"a_pos3d",type:"Int16",components:3}]);class $d extends i.E{constructor(s){super(),this._lastTilesetChange=Ci(),this.tileManager=s,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=s._source.tileSize*2**this.deltaZoom,s.usedForTerrain=!0,s.tileSize=this.tileSize}destruct(){this.tileManager.usedForTerrain=!1,this.tileManager.tileSize=null}getSource(){return this.tileManager._source}update(s,d){this.tileManager.update(s,d),this._renderableTilesKeys=[];const v={};for(const S of Ae(s,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:d,calculateTileZoom:this.tileManager._source.calculateTileZoom}))v[S.key]=!0,this._renderableTilesKeys.push(S.key),this._tiles[S.key]||(S.terrainRttPosMatrix32f=new Float64Array(16),i.c6(S.terrainRttPosMatrix32f,0,i.a4,i.a4,0,0,1),this._tiles[S.key]=new St(S,this.tileSize),this._lastTilesetChange=Ci());for(const S in this._tiles)v[S]||delete this._tiles[S]}freeRtt(s){for(const d in this._tiles){const v=this._tiles[d];(!s||v.tileID.equals(s)||v.tileID.isChildOf(s)||s.isChildOf(v.tileID))&&(v.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(s=>this.getTileByID(s))}getTileByID(s){return this._tiles[s]}getTerrainCoords(s,d){return d?this._getTerrainCoordsForTileRanges(s,d):this._getTerrainCoordsForRegularTile(s)}_getTerrainCoordsForRegularTile(s){const d={};for(const v of this._renderableTilesKeys){const S=this._tiles[v].tileID,D=s.clone(),k=i.bj();if(S.canonical.equals(s.canonical))i.c6(k,0,i.a4,i.a4,0,0,1);else if(S.canonical.isChildOf(s.canonical)){const j=S.canonical.z-s.canonical.z,H=S.canonical.x-(S.canonical.x>>j<<j),J=S.canonical.y-(S.canonical.y>>j<<j),et=i.a4>>j;i.c6(k,0,et,et,0,0,1),i.O(k,k,[-H*et,-J*et,0])}else{if(!s.canonical.isChildOf(S.canonical))continue;{const j=s.canonical.z-S.canonical.z,H=s.canonical.x-(s.canonical.x>>j<<j),J=s.canonical.y-(s.canonical.y>>j<<j),et=i.a4>>j;i.c6(k,0,i.a4,i.a4,0,0,1),i.O(k,k,[H*et,J*et,0]),i.Q(k,k,[1/2**j,1/2**j,0])}}D.terrainRttPosMatrix32f=new Float32Array(k),d[v]=D}return d}_getTerrainCoordsForTileRanges(s,d){const v={};for(const S of this._renderableTilesKeys){const D=this._tiles[S].tileID;if(!this._isWithinTileRanges(D,d))continue;const k=s.clone(),j=i.bj();if(D.canonical.z===s.canonical.z){const H=s.canonical.x-D.canonical.x,J=s.canonical.y-D.canonical.y;i.c6(j,0,i.a4,i.a4,0,0,1),i.O(j,j,[H*i.a4,J*i.a4,0])}else if(D.canonical.z>s.canonical.z){const H=D.canonical.z-s.canonical.z,J=D.canonical.x-(D.canonical.x>>H<<H),et=D.canonical.y-(D.canonical.y>>H<<H),mt=s.canonical.x-(D.canonical.x>>H),dt=s.canonical.y-(D.canonical.y>>H),Tt=i.a4>>H;i.c6(j,0,Tt,Tt,0,0,1),i.O(j,j,[-J*Tt+mt*i.a4,-et*Tt+dt*i.a4,0])}else{const H=s.canonical.z-D.canonical.z,J=s.canonical.x-(s.canonical.x>>H<<H),et=s.canonical.y-(s.canonical.y>>H<<H),mt=(s.canonical.x>>H)-D.canonical.x,dt=(s.canonical.y>>H)-D.canonical.y,Tt=i.a4<<H;i.c6(j,0,Tt,Tt,0,0,1),i.O(j,j,[J*i.a4+mt*Tt,et*i.a4+dt*Tt,0])}k.terrainRttPosMatrix32f=new Float32Array(j),v[S]=k}return v}getSourceTile(s,d){const v=this.tileManager._source;let S=s.overscaledZ-this.deltaZoom;if(S>v.maxzoom&&(S=v.maxzoom),S<v.minzoom)return null;this._sourceTileCache[s.key]||(this._sourceTileCache[s.key]=s.scaledTo(S).key);let D=this.tileManager.getTileByID(this._sourceTileCache[s.key]);if((!D||!D.dem)&&d)for(;S>=v.minzoom&&(!D||!D.dem);)D=this.tileManager.getTileByID(s.scaledTo(S--).key);return D}anyTilesAfterTime(s=Date.now()){return this._lastTilesetChange>=s}_isWithinTileRanges(s,d){return d[s.canonical.z]&&s.canonical.x>=d[s.canonical.z].minTileX&&s.canonical.x<=d[s.canonical.z].maxTileX&&s.canonical.y>=d[s.canonical.z].minTileY&&s.canonical.y<=d[s.canonical.z].maxTileY}}class Mp{constructor(s,d,v){this._meshCache={},this.painter=s,this.tileManager=new $d(d),this.options=v,this.exaggeration=typeof v.exaggeration=="number"?v.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(s,d,v,S=i.a4){var D;if(!(d>=0&&d<S&&v>=0&&v<S))return 0;const k=this.getTerrainData(s),j=(D=k.tile)===null||D===void 0?void 0:D.dem;if(!j)return 0;const H=i.cB([],[d/S*i.a4,v/S*i.a4],k.u_terrain_matrix),J=[H[0]*j.dim,H[1]*j.dim],et=Math.floor(J[0]),mt=Math.floor(J[1]),dt=J[0]-et,Tt=J[1]-mt;return j.get(et,mt)*(1-dt)*(1-Tt)+j.get(et+1,mt)*dt*(1-Tt)+j.get(et,mt+1)*(1-dt)*Tt+j.get(et+1,mt+1)*dt*Tt}getElevationForLngLatZoom(s,d){if(!i.cC(d,s.wrap()))return 0;const{tileID:v,mercatorX:S,mercatorY:D}=this._getOverscaledTileIDFromLngLatZoom(s,d);return this.getElevation(v,S%i.a4,D%i.a4,i.a4)}getElevation(s,d,v,S=i.a4){return this.getDEMElevation(s,d,v,S)*this.exaggeration}getTerrainData(s){if(!this._emptyDemTexture){const S=this.painter.context,D=new i.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new i.T(S,D,S.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new i.T(S,new i.R({width:1,height:1}),S.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(S.gl.NEAREST,S.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=i.ar([])}const d=this.tileManager.getSourceTile(s,!0);if(d&&d.dem&&(!d.demTexture||d.needsTerrainPrepare)){const S=this.painter.context;d.demTexture=this.painter.getTileTexture(d.dem.stride),d.demTexture?d.demTexture.update(d.dem.getPixels(),{premultiply:!1}):d.demTexture=new i.T(S,d.dem.getPixels(),S.gl.RGBA,{premultiply:!1}),d.demTexture.bind(S.gl.NEAREST,S.gl.CLAMP_TO_EDGE),d.needsTerrainPrepare=!1}const v=d&&d+d.tileID.key+s.key;if(v&&!this._demMatrixCache[v]){const S=this.tileManager.getSource().maxzoom;let D=s.canonical.z-d.tileID.canonical.z;s.overscaledZ>s.canonical.z&&(s.canonical.z>=S?D=s.canonical.z-S:i.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const k=s.canonical.x-(s.canonical.x>>D<<D),j=s.canonical.y-(s.canonical.y>>D<<D),H=i.cD(new Float64Array(16),[1/(i.a4<<D),1/(i.a4<<D),0]);i.O(H,H,[k*i.a4,j*i.a4,0]),this._demMatrixCache[s.key]={matrix:H,coord:s}}return{u_depth:2,u_terrain:3,u_terrain_dim:d&&d.dem&&d.dem.dim||1,u_terrain_matrix:v?this._demMatrixCache[s.key].matrix:this._emptyDemMatrix,u_terrain_unpack:d&&d.dem&&d.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(d&&d.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:d}}getFramebuffer(s){const d=this.painter,v=d.width/devicePixelRatio,S=d.height/devicePixelRatio;return!this._fbo||this._fbo.width===v&&this._fbo.height===S||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new i.T(d.context,{width:v,height:S,data:null},d.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(d.context.gl.NEAREST,d.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new i.T(d.context,{width:v,height:S,data:null},d.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(d.context.gl.NEAREST,d.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=d.context.createFramebuffer(v,S,!0,!1),this._fbo.depthAttachment.set(d.context.createRenderbuffer(d.context.gl.DEPTH_COMPONENT16,v,S))),this._fbo.colorAttachment.set(s==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const s=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const d=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let D=0,k=0;D<this._coordsTextureSize;D++)for(let j=0;j<this._coordsTextureSize;j++,k+=4)d[k+0]=255&j,d[k+1]=255&D,d[k+2]=j>>8<<4|D>>8,d[k+3]=0;const v=new i.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(d.buffer)),S=new i.T(s,v,s.gl.RGBA,{premultiply:!1});return S.bind(s.gl.NEAREST,s.gl.CLAMP_TO_EDGE),this._coordsTexture=S,S}pointCoordinate(s){this.painter.maybeDrawDepthAndCoords(!0);const d=new Uint8Array(4),v=this.painter.context,S=v.gl,D=Math.round(s.x*this.painter.pixelRatio/devicePixelRatio),k=Math.round(s.y*this.painter.pixelRatio/devicePixelRatio),j=Math.round(this.painter.height/devicePixelRatio);v.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),S.readPixels(D,j-k-1,1,1,S.RGBA,S.UNSIGNED_BYTE,d),v.bindFramebuffer.set(null);const H=d[0]+(d[2]>>4<<8),J=d[1]+((15&d[2])<<8),et=this.coordsIndex[255-d[3]],mt=et&&this.tileManager.getTileByID(et);if(!mt)return null;const dt=this._coordsTextureSize,Tt=(1<<mt.tileID.canonical.z)*dt;return new i.aa((mt.tileID.canonical.x*dt+H)/Tt+mt.tileID.wrap,(mt.tileID.canonical.y*dt+J)/Tt,this.getElevation(mt.tileID,H,J,dt))}depthAtPoint(s){const d=new Uint8Array(4),v=this.painter.context,S=v.gl;return v.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),S.readPixels(s.x,this.painter.height/devicePixelRatio-s.y-1,1,1,S.RGBA,S.UNSIGNED_BYTE,d),v.bindFramebuffer.set(null),(d[0]/16777216+d[1]/65536+d[2]/256+d[3])/256}getTerrainMesh(s){var d;const v=((d=this.painter.style.projection)===null||d===void 0?void 0:d.transitionState)>0,S=v&&s.canonical.y===0,D=v&&s.canonical.y===(1<<s.canonical.z)-1,k=`m_${S?"n":""}_${D?"s":""}`;if(this._meshCache[k])return this._meshCache[k];const j=this.painter.context,H=new i.cE,J=new i.aX,et=this.meshSize,mt=i.a4/et,dt=et*et;for(let de=0;de<=et;de++)for(let Ce=0;Ce<=et;Ce++)H.emplaceBack(Ce*mt,de*mt,0);for(let de=0;de<dt;de+=et+1)for(let Ce=0;Ce<et;Ce++)J.emplaceBack(Ce+de,et+Ce+de+1,et+Ce+de+2),J.emplaceBack(Ce+de,et+Ce+de+2,Ce+de+1);const Tt=H.length,pt=Tt+(et+1),It=(et+1)*et,Kt=S?i.bq:0,Wt=S?0:1,ft=D?i.br:i.a4,_e=D?0:1;for(let de=0;de<=et;de++)H.emplaceBack(de*mt,Kt,Wt);for(let de=0;de<=et;de++)H.emplaceBack(de*mt,ft,_e);for(let de=0;de<et;de++)J.emplaceBack(It+de,pt+de,pt+de+1),J.emplaceBack(It+de,pt+de+1,It+de+1),J.emplaceBack(0+de,Tt+de+1,Tt+de),J.emplaceBack(0+de,0+de+1,Tt+de+1);const he=H.length,me=he+2*(et+1);for(const de of[0,1])for(let Ce=0;Ce<=et;Ce++)for(const Qe of[0,1])H.emplaceBack(de*i.a4,Ce*mt,Qe);for(let de=0;de<2*et;de+=2)J.emplaceBack(he+de,he+de+1,he+de+3),J.emplaceBack(he+de,he+de+3,he+de+2),J.emplaceBack(me+de,me+de+3,me+de+1),J.emplaceBack(me+de,me+de+2,me+de+3);const be=new lc(j.createVertexBuffer(H,Pp.members),j.createIndexBuffer(J),i.aW.simpleSegment(0,0,H.length,J.length));return this._meshCache[k]=be,be}getMeshFrameDelta(s){return 2*Math.PI*i.bD/Math.pow(2,Math.max(s,0))/5}getMinTileElevationForLngLatZoom(s,d){var v;const{tileID:S}=this._getOverscaledTileIDFromLngLatZoom(s,d);return(v=this.getMinMaxElevation(S).minElevation)!==null&&v!==void 0?v:0}getMinMaxElevation(s){const d=this.getTerrainData(s).tile,v={minElevation:null,maxElevation:null};return d&&d.dem&&(v.minElevation=d.dem.min*this.exaggeration,v.maxElevation=d.dem.max*this.exaggeration),v}_getOverscaledTileIDFromLngLatZoom(s,d){const v=i.aa.fromLngLat(s.wrap()),S=(1<<d)*i.a4,D=v.x*S,k=v.y*S,j=Math.floor(D/i.a4),H=Math.floor(k/i.a4);return{tileID:new i.a1(d,0,d,j,H),mercatorX:D,mercatorY:k}}}class cd{constructor(s,d,v){this._context=s,this._size=d,this._tileSize=v,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const s of this._objects)s.texture.destroy(),s.fbo.destroy()}_createObject(s){const d=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),v=new i.T(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return v.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),d.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),d.colorAttachment.set(v.texture),{id:s,fbo:d,texture:v,stamp:-1,inUse:!1}}getObjectForId(s){return this._objects[s]}useObject(s){s.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(d=>s.id!==d),this._recentlyUsed.push(s.id)}stampObject(s){s.stamp=++this._stamp}getOrCreateFreeObject(){for(const d of this._recentlyUsed)if(!this._objects[d].inUse)return this._objects[d];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const s=this._createObject(this._objects.length);return this._objects.push(s),s}freeObject(s){s.inUse=!1}freeAllObjects(){for(const s of this._objects)this.freeObject(s)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(s=>!s.inUse)===!1}}const po={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0,"color-relief":!0};class Ko{constructor(s,d){this.painter=s,this.terrain=d,this.pool=new cd(s.context,30,d.tileManager.tileSize*d.qualityFactor)}destruct(){this.pool.destruct()}getTexture(s){return this.pool.getObjectForId(s.rtt[this._stacks.length-1].id).texture}prepareForRender(s,d){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.tileManager.getRenderableTiles(),this._renderableLayerIds=s._order.filter(v=>!s._layers[v].isHidden(d)),this._coordsAscending={};for(const v in s.tileManagers){this._coordsAscending[v]={};const S=s.tileManagers[v].getVisibleCoordinates(),D=s.tileManagers[v].getSource(),k=D instanceof Cs?D.terrainTileRanges:null;for(const j of S){const H=this.terrain.tileManager.getTerrainCoords(j,k);for(const J in H)this._coordsAscending[v][J]||(this._coordsAscending[v][J]=[]),this._coordsAscending[v][J].push(H[J])}}this._coordsAscendingStr={};for(const v of s._order){const S=s._layers[v],D=S.source;if(po[S.type]&&!this._coordsAscendingStr[D]){this._coordsAscendingStr[D]={};for(const k in this._coordsAscending[D])this._coordsAscendingStr[D][k]=this._coordsAscending[D][k].map(j=>j.key).sort().join()}}for(const v of this._renderableTiles)for(const S in this._coordsAscendingStr){const D=this._coordsAscendingStr[S][v.tileID.key];D&&D!==v.rttCoords[S]&&(v.rtt=[])}}renderLayer(s,d){if(s.isHidden(this.painter.transform.zoom))return!1;const v=Object.assign(Object.assign({},d),{isRenderingToTexture:!0}),S=s.type,D=this.painter,k=this._renderableLayerIds[this._renderableLayerIds.length-1]===s.id;if(po[S]&&(this._prevType&&po[this._prevType]||this._stacks.push([]),this._prevType=S,this._stacks[this._stacks.length-1].push(s.id),!k))return!0;if(po[this._prevType]||po[S]&&k){this._prevType=S;const j=this._stacks.length-1,H=this._stacks[j]||[];for(const J of this._renderableTiles){if(this.pool.isFull()&&(Oc(this.painter,this.terrain,this._rttTiles,v),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(J),J.rtt[j]){const mt=this.pool.getObjectForId(J.rtt[j].id);if(mt.stamp===J.rtt[j].stamp){this.pool.useObject(mt);continue}}const et=this.pool.getOrCreateFreeObject();this.pool.useObject(et),this.pool.stampObject(et),J.rtt[j]={id:et.id,stamp:et.stamp},D.context.bindFramebuffer.set(et.fbo.framebuffer),D.context.clear({color:i.bo.transparent,stencil:0}),D.currentStencilSource=void 0;for(let mt=0;mt<H.length;mt++){const dt=D.style._layers[H[mt]],Tt=dt.source?this._coordsAscending[dt.source][J.tileID.key]:[J.tileID];D.context.viewport.set([0,0,et.fbo.width,et.fbo.height]),D._renderTileClippingMasks(dt,Tt,!0),D.renderLayer(D,D.style.tileManagers[dt.source],dt,Tt,v),dt.source&&(J.rttCoords[dt.source]=this._coordsAscendingStr[dt.source][J.tileID.key])}}return Oc(this.painter,this.terrain,this._rttTiles,v),this._rttTiles=[],this.pool.freeAllObjects(),po[S]}return!1}}const Ei={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use  + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},Iu=Le,Bl={hash:!1,interactive:!0,bearingSnap:7,attributionControl:hh,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:i.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,transformConstrain:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,reduceMotion:void 0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0,experimentalZoomLevelsToOverscale:void 0},Gc={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class $c{constructor(s,d,v=!1){this.mousedown=D=>{this.startMove(D,Re.mousePos(this.element,D)),Re.addEventListener(window,"mousemove",this.mousemove),Re.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=D=>{this.move(D,Re.mousePos(this.element,D))},this.mouseup=D=>{this._rotatePitchHandler.dragEnd(D),this.offTemp()},this.touchstart=D=>{D.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Re.touchPos(this.element,D.targetTouches)[0],this.startMove(D,this._startPos),Re.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),Re.addEventListener(window,"touchend",this.touchend))},this.touchmove=D=>{D.targetTouches.length!==1?this.reset():(this._lastPos=Re.touchPos(this.element,D.targetTouches)[0],this.move(D,this._lastPos))},this.touchend=D=>{D.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHandler.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=d;const S=new gf;this._rotatePitchHandler=new bu({clickTolerance:3,move:(D,k)=>{const j=d.getBoundingClientRect(),H=new i.P((j.bottom-j.top)/2,(j.right-j.left)/2);return{bearingDelta:i.cw(new i.P(D.x,k.y),k,H),pitchDelta:v?-.5*(k.y-D.y):void 0}},moveStateManager:S,enable:!0,assignEvents:()=>{}}),this.map=s,Re.addEventListener(d,"mousedown",this.mousedown),Re.addEventListener(d,"touchstart",this.touchstart,{passive:!1}),Re.addEventListener(d,"touchcancel",this.reset)}startMove(s,d){this._rotatePitchHandler.dragStart(s,d),Re.disableDrag()}move(s,d){const v=this.map,{bearingDelta:S,pitchDelta:D}=this._rotatePitchHandler.dragMove(s,d)||{};S&&v.setBearing(v.getBearing()+S),D&&v.setPitch(v.getPitch()+D)}off(){const s=this.element;Re.removeEventListener(s,"mousedown",this.mousedown),Re.removeEventListener(s,"touchstart",this.touchstart,{passive:!1}),Re.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Re.removeEventListener(window,"touchend",this.touchend),Re.removeEventListener(s,"touchcancel",this.reset),this.offTemp()}offTemp(){Re.enableDrag(),Re.removeEventListener(window,"mousemove",this.mousemove),Re.removeEventListener(window,"mouseup",this.mouseup),Re.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),Re.removeEventListener(window,"touchend",this.touchend)}}let Zi;function Yh(C,s,d,v=!1){if(v||!d.getCoveringTilesDetailsProvider().allowWorldCopies())return C==null?void 0:C.wrap();const S=new i.V(C.lng,C.lat);if(C=new i.V(C.lng,C.lat),s){const D=new i.V(C.lng-360,C.lat),k=new i.V(C.lng+360,C.lat),j=d.locationToScreenPoint(C).distSqr(s);d.locationToScreenPoint(D).distSqr(s)<j?C=D:d.locationToScreenPoint(k).distSqr(s)<j&&(C=k)}for(;Math.abs(C.lng-d.center.lng)>180;){const D=d.locationToScreenPoint(C);if(D.x>=0&&D.y>=0&&D.x<=d.width&&D.y<=d.height)break;C.lng>d.center.lng?C.lng-=360:C.lng+=360}return C.lng!==S.lng&&d.isPointOnMapSurface(d.locationToScreenPoint(C))?C:S}const hd={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Eu(C,s,d){const v=C.classList;for(const S in hd)v.remove(`maplibregl-${d}-anchor-${S}`);v.add(`maplibregl-${d}-anchor-${s}`)}class Jh extends i.E{constructor(s){if(super(),this._onKeyPress=d=>{const v=d.code,S=d.charCode||d.keyCode;v!=="Space"&&v!=="Enter"&&S!==32&&S!==13||this.togglePopup()},this._onMapClick=d=>{const v=d.originalEvent.target,S=this._element;this._popup&&(v===S||S.contains(v))&&this.togglePopup()},this._update=d=>{if(!this._map)return;const v=this._map.loaded()&&!this._map.isMoving();((d==null?void 0:d.type)==="terrain"||(d==null?void 0:d.type)==="render"&&!v)&&this._map.once("render",this._update),this._lngLat=Yh(this._lngLat,this._flatPos,this._map.transform),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let S="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?S=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(S=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let D="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?D="rotateX(0deg)":this._pitchAlignment==="map"&&(D=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||d&&d.type!=="moveend"||(this._pos=this._pos.round()),Re.setTransform(this._element,`${hd[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${D} ${S}`),Rr.frameAsync(new AbortController).then(()=>{this._updateOpacity(d&&d.type==="moveend")}).catch(()=>{})},this._onMove=d=>{if(!this._isDragging){const v=this._clickTolerance||this._map._clickTolerance;this._isDragging=d.point.dist(this._pointerdownPos)>=v}this._isDragging&&(this._pos=d.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new i.l("dragstart"))),this.fire(new i.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new i.l("dragend")),this._state="inactive"},this._addDragHandler=d=>{this._element.contains(d.originalEvent.target)&&(d.preventDefault(),this._positionDelta=d.point.sub(this._pos).add(this._offset),this._pointerdownPos=d.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=s&&s.anchor||"center",this._color=s&&s.color||"#3FB1CE",this._scale=s&&s.scale||1,this._draggable=s&&s.draggable||!1,this._clickTolerance=s&&s.clickTolerance||0,this._subpixelPositioning=s&&s.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=s&&s.rotation||0,this._rotationAlignment=s&&s.rotationAlignment||"auto",this._pitchAlignment=s&&s.pitchAlignment&&s.pitchAlignment!=="auto"?s.pitchAlignment:this._rotationAlignment,this.setOpacity(s==null?void 0:s.opacity,s==null?void 0:s.opacityWhenCovered),s&&s.element)this._element=s.element,this._offset=i.P.convert(s&&s.offset||[0,0]);else{this._defaultMarker=!0,this._element=Re.create("div");const d=Re.createNS("http://www.w3.org/2000/svg","svg"),v=41,S=27;d.setAttributeNS(null,"display","block"),d.setAttributeNS(null,"height",`${v}px`),d.setAttributeNS(null,"width",`${S}px`),d.setAttributeNS(null,"viewBox",`0 0 ${S} ${v}`);const D=Re.createNS("http://www.w3.org/2000/svg","g");D.setAttributeNS(null,"stroke","none"),D.setAttributeNS(null,"stroke-width","1"),D.setAttributeNS(null,"fill","none"),D.setAttributeNS(null,"fill-rule","evenodd");const k=Re.createNS("http://www.w3.org/2000/svg","g");k.setAttributeNS(null,"fill-rule","nonzero");const j=Re.createNS("http://www.w3.org/2000/svg","g");j.setAttributeNS(null,"transform","translate(3.0, 29.0)"),j.setAttributeNS(null,"fill","#000000");const H=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const Wt of H){const ft=Re.createNS("http://www.w3.org/2000/svg","ellipse");ft.setAttributeNS(null,"opacity","0.04"),ft.setAttributeNS(null,"cx","10.5"),ft.setAttributeNS(null,"cy","5.80029008"),ft.setAttributeNS(null,"rx",Wt.rx),ft.setAttributeNS(null,"ry",Wt.ry),j.appendChild(ft)}const J=Re.createNS("http://www.w3.org/2000/svg","g");J.setAttributeNS(null,"fill",this._color);const et=Re.createNS("http://www.w3.org/2000/svg","path");et.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),J.appendChild(et);const mt=Re.createNS("http://www.w3.org/2000/svg","g");mt.setAttributeNS(null,"opacity","0.25"),mt.setAttributeNS(null,"fill","#000000");const dt=Re.createNS("http://www.w3.org/2000/svg","path");dt.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),mt.appendChild(dt);const Tt=Re.createNS("http://www.w3.org/2000/svg","g");Tt.setAttributeNS(null,"transform","translate(6.0, 7.0)"),Tt.setAttributeNS(null,"fill","#FFFFFF");const pt=Re.createNS("http://www.w3.org/2000/svg","g");pt.setAttributeNS(null,"transform","translate(8.0, 8.0)");const It=Re.createNS("http://www.w3.org/2000/svg","circle");It.setAttributeNS(null,"fill","#000000"),It.setAttributeNS(null,"opacity","0.25"),It.setAttributeNS(null,"cx","5.5"),It.setAttributeNS(null,"cy","5.5"),It.setAttributeNS(null,"r","5.4999962");const Kt=Re.createNS("http://www.w3.org/2000/svg","circle");Kt.setAttributeNS(null,"fill","#FFFFFF"),Kt.setAttributeNS(null,"cx","5.5"),Kt.setAttributeNS(null,"cy","5.5"),Kt.setAttributeNS(null,"r","5.4999962"),pt.appendChild(It),pt.appendChild(Kt),k.appendChild(j),k.appendChild(J),k.appendChild(mt),k.appendChild(Tt),k.appendChild(pt),d.appendChild(k),d.setAttributeNS(null,"height",v*this._scale+"px"),d.setAttributeNS(null,"width",S*this._scale+"px"),this._element.appendChild(d),this._offset=i.P.convert(s&&s.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",d=>{d.preventDefault()}),this._element.addEventListener("mousedown",d=>{d.preventDefault()}),Eu(this._element,this._anchor,"marker"),s&&s.className)for(const d of s.className.split(" "))this._element.classList.add(d);this._popup=null}addTo(s){return this.remove(),this._map=s,this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label",s._getUIString("Marker.Title")),this._element.hasAttribute("role")||this._element.setAttribute("role","button"),s.getCanvasContainer().appendChild(this._element),s.on("move",this._update),s.on("moveend",this._update),s.on("terrain",this._update),s.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),Re.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(s){return this._lngLat=i.V.convert(s),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(s){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),s){if(!("offset"in s.options)){const S=Math.abs(13.5)/Math.SQRT2;s.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[S,-1*(38.1-13.5+S)],"bottom-right":[-S,-1*(38.1-13.5+S)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=s,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(s){return this._subpixelPositioning=s,this}getPopup(){return this._popup}togglePopup(){const s=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:s?(s.isOpen()?s.remove():(s.setLngLat(this._lngLat),s.addTo(this._map)),this):this}_updateOpacity(s=!1){var d,v;const S=(d=this._map)===null||d===void 0?void 0:d.terrain,D=this._map.transform.isLocationOccluded(this._lngLat);if(!S||D){const Tt=D?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==Tt&&(this._element.style.opacity=Tt))}if(s)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const k=this._map,j=k.terrain.depthAtPoint(this._pos),H=k.terrain.getElevationForLngLatZoom(this._lngLat,k.transform.tileZoom);if(k.transform.lngLatToCameraDepth(this._lngLat,H)-j<.006)return void(this._element.style.opacity=this._opacity);const J=-this._offset.y/k.transform.pixelsPerMeter,et=Math.sin(k.getPitch()*Math.PI/180)*J,mt=k.terrain.depthAtPoint(new i.P(this._pos.x,this._pos.y-this._offset.y)),dt=k.transform.lngLatToCameraDepth(this._lngLat,H+et)-mt>.006;!((v=this._popup)===null||v===void 0)&&v.isOpen()&&dt&&this._popup.remove(),this._element.style.opacity=dt?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(s){return this._offset=i.P.convert(s),this._update(),this}addClassName(s){this._element.classList.add(s)}removeClassName(s){this._element.classList.remove(s)}toggleClassName(s){return this._element.classList.toggle(s)}setDraggable(s){return this._draggable=!!s,this._map&&(s?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(s){return this._rotation=s||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(s){return this._rotationAlignment=s||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(s){return this._pitchAlignment=s&&s!=="auto"?s:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(s,d){return(this._opacity===void 0||s===void 0&&d===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),s!==void 0&&(this._opacity=s),d!==void 0&&(this._opacityWhenCovered=d),this._map&&this._updateOpacity(!0),this}}const qd={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Kh=0,Qh=!1;const vf={maxWidth:100,unit:"metric"};function Cp(C,s,d){const v=d&&d.maxWidth||100,S=C._container.clientHeight/2,D=C._container.clientWidth/2,k=C.unproject([D-v/2,S]),j=C.unproject([D+v/2,S]),H=Math.round(C.project(j).x-C.project(k).x),J=Math.min(v,H,C._container.clientWidth),et=k.distanceTo(j);if(d&&d.unit==="imperial"){const mt=3.2808*et;mt>5280?Gs(s,J,mt/5280,C._getUIString("ScaleControl.Miles")):Gs(s,J,mt,C._getUIString("ScaleControl.Feet"))}else d&&d.unit==="nautical"?Gs(s,J,et/1852,C._getUIString("ScaleControl.NauticalMiles")):et>=1e3?Gs(s,J,et/1e3,C._getUIString("ScaleControl.Kilometers")):Gs(s,J,et,C._getUIString("ScaleControl.Meters"))}function Gs(C,s,d,v){const S=function(D){const k=Math.pow(10,`${Math.floor(D)}`.length-1);let j=D/k;return j=j>=10?10:j>=5?5:j>=3?3:j>=2?2:j>=1?1:function(H){const J=Math.pow(10,Math.ceil(-Math.log(H)/Math.LN10));return Math.round(H*J)/J}(j),k*j}(d);C.style.width=s*(S/d)+"px",C.innerHTML=`${S}&nbsp;${v}`}const ud={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},pa=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function gc(C){if(C){if(typeof C=="number"){const s=Math.round(Math.abs(C)/Math.SQRT2);return{center:new i.P(0,0),top:new i.P(0,C),"top-left":new i.P(s,s),"top-right":new i.P(-s,s),bottom:new i.P(0,-C),"bottom-left":new i.P(s,-s),"bottom-right":new i.P(-s,-s),left:new i.P(C,0),right:new i.P(-C,0)}}if(C instanceof i.P||Array.isArray(C)){const s=i.P.convert(C);return{center:s,top:s,"top-left":s,"top-right":s,bottom:s,"bottom-left":s,"bottom-right":s,left:s,right:s}}return{center:i.P.convert(C.center||[0,0]),top:i.P.convert(C.top||[0,0]),"top-left":i.P.convert(C["top-left"]||[0,0]),"top-right":i.P.convert(C["top-right"]||[0,0]),bottom:i.P.convert(C.bottom||[0,0]),"bottom-left":i.P.convert(C["bottom-left"]||[0,0]),"bottom-right":i.P.convert(C["bottom-right"]||[0,0]),left:i.P.convert(C.left||[0,0]),right:i.P.convert(C.right||[0,0])}}return gc(new i.P(0,0))}const Zd=Le;nt.AJAXError=i.cI,nt.Event=i.l,nt.Evented=i.E,nt.LngLat=i.V,nt.MercatorCoordinate=i.aa,nt.Point=i.P,nt.addProtocol=i.cJ,nt.config=i.a,nt.removeProtocol=i.cK,nt.AttributionControl=_s,nt.BoxZoomHandler=Vd,nt.CanvasSource=Ml,nt.CooperativeGesturesHandler=da,nt.DoubleClickZoomHandler=Zh,nt.DragPanHandler=ld,nt.DragRotateHandler=Hh,nt.EdgeInsets=Xn,nt.FullscreenControl=class extends i.E{constructor(C={}){super(),this._onFullscreenChange=()=>{var s;let d=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((s=d==null?void 0:d.shadowRoot)===null||s===void 0)&&s.fullscreenElement;)d=d.shadowRoot.fullscreenElement;d===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,C&&C.container&&(C.container instanceof HTMLElement?this._container=C.container:i.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(C){return this._map=C,this._container||(this._container=this._map.getContainer()),this._controlContainer=Re.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){Re.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const C=this._fullscreenButton=Re.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);Re.create("span","maplibregl-ctrl-icon",C).setAttribute("aria-hidden","true"),C.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const C=this._getTitle();this._fullscreenButton.setAttribute("aria-label",C),this._fullscreenButton.title=C}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new i.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new i.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},nt.GeoJSONSource=bs,nt.GeolocateControl=class extends i.E{constructor(C){super(),this._onSuccess=s=>{if(this._map){if(this._isOutOfMapMaxBounds(s))return this._setErrorState(),this.fire(new i.l("outofmaxbounds",s)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=s,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(s),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(s),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new i.l("geolocate",s)),this._finish()}},this._updateCamera=s=>{const d=new i.V(s.coords.longitude,s.coords.latitude),v=s.coords.accuracy,S=this._map.getBearing(),D=i.e({bearing:S},this.options.fitBoundsOptions),k=xo.fromLngLat(d,v);this._map.fitBounds(k,D,{geolocateSource:!0})},this._updateMarker=s=>{if(s){const d=new i.V(s.coords.longitude,s.coords.latitude);this._accuracyCircleMarker.setLngLat(d).addTo(this._map),this._userLocationDotMarker.setLngLat(d).addTo(this._map),this._accuracy=s.coords.accuracy,this._updateCircleRadiusIfNeeded()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onUpdate=()=>{this._updateCircleRadiusIfNeeded()},this._onError=s=>{if(this._map){if(s.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const d=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(s.code===3&&Qh)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new i.l("error",s)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",s=>s.preventDefault()),this._geolocateButton=Re.create("button","maplibregl-ctrl-geolocate",this._container),Re.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=s=>{if(this._map){if(s===!1){i.w("Geolocation support is not available so the GeolocateControl will be disabled.");const d=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d)}else{const d=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=d,this._geolocateButton.setAttribute("aria-label",d)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Re.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Jh({element:this._dotElement}),this._circleElement=Re.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Jh({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onUpdate),this._map.on("move",this._onUpdate),this._map.on("rotate",this._onUpdate),this._map.on("pitch",this._onUpdate)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",d=>{const v=(d==null?void 0:d[0])instanceof ResizeObserverEntry;d.geolocateSource||this._watchState!=="ACTIVE_LOCK"||v||this._map.isZooming()||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new i.l("trackuserlocationend")),this.fire(new i.l("userlocationlostfocus")))})}},this.options=i.e({},qd,C)}onAdd(C){return this._map=C,this._container=Re.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return i._(this,arguments,void 0,function*(s=!1){if(Zi!==void 0&&!s)return Zi;if(window.navigator.permissions===void 0)return Zi=!!window.navigator.geolocation,Zi;try{Zi=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{Zi=!!window.navigator.geolocation}return Zi})}().then(s=>this._finishSetupUI(s)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),Re.remove(this._container),this._map.off("zoom",this._onUpdate),this._map.off("move",this._onUpdate),this._map.off("rotate",this._onUpdate),this._map.off("pitch",this._onUpdate),this._map=void 0,Kh=0,Qh=!1}_isOutOfMapMaxBounds(C){const s=this._map.getMaxBounds(),d=C.coords;return s&&(d.longitude<s.getWest()||d.longitude>s.getEast()||d.latitude<s.getSouth()||d.latitude>s.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":case"BACKGROUND_ERROR":case"OFF":case void 0:break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadiusIfNeeded(){const C=this._userLocationDotMarker.getLngLat();if(!(this.options.showUserLocation&&this.options.showAccuracyCircle&&this._accuracy&&C))return;const s=this._map.project(C),d=this._map.unproject([s.x+100,s.y]),v=C.distanceTo(d)/100,S=2*this._accuracy/v;this._circleElement.style.width=`${S.toFixed(2)}px`,this._circleElement.style.height=`${S.toFixed(2)}px`}trigger(){if(!this._setup)return i.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new i.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Kh--,Qh=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new i.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new i.l("trackuserlocationstart")),this.fire(new i.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let C;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Kh++,Kh>1?(C={maximumAge:6e5,timeout:0},Qh=!0):(C=this.options.positionOptions,Qh=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,C)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},nt.GlobeControl=class{constructor(){this._toggleProjection=()=>{var C;const s=(C=this._map.getProjection())===null||C===void 0?void 0:C.type;this._map.setProjection(s!=="mercator"&&s?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var C;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((C=this._map.getProjection())===null||C===void 0?void 0:C.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(C){return this._map=C,this._container=Re.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=Re.create("button","maplibregl-ctrl-globe",this._container),Re.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){Re.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},nt.Hash=sh,nt.ImageSource=Cs,nt.KeyboardHandler=ch,nt.LngLatBounds=xo,nt.LogoControl=bl,nt.Map=class extends mc{constructor(C){var s,d;i.cF.mark(i.cG.create);const v=Object.assign(Object.assign(Object.assign({},Bl),C),{canvasContextAttributes:Object.assign(Object.assign({},Bl.canvasContextAttributes),C.canvasContextAttributes)});if(v.minZoom!=null&&v.maxZoom!=null&&v.minZoom>v.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(v.minPitch!=null&&v.maxPitch!=null&&v.minPitch>v.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(v.minPitch!=null&&v.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(v.maxPitch!=null&&v.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const S=new vr,D=new Ra;if(v.minZoom!==void 0&&S.setMinZoom(v.minZoom),v.maxZoom!==void 0&&S.setMaxZoom(v.maxZoom),v.minPitch!==void 0&&S.setMinPitch(v.minPitch),v.maxPitch!==void 0&&S.setMaxPitch(v.maxPitch),v.renderWorldCopies!==void 0&&S.setRenderWorldCopies(v.renderWorldCopies),v.transformConstrain!==null&&S.setConstrainOverride(v.transformConstrain),super(S,D,{bearingSnap:v.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Gd,this._controls=[],this._mapId=i.ag(),this._lostContextStyle={style:null,images:null},this._contextLost=j=>{j.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.painter.destroy();for(const H of Object.values(this.style._layers))if(H.type==="custom"&&console.warn(`Custom layer with id '${H.id}' cannot be restored after WebGL context loss. You will need to re-add it manually after context restoration.`),H._listeners)for(const[J]of Object.entries(H._listeners))console.warn(`Custom layer with id '${H.id}' had event listeners for event '${J}' which cannot be restored after WebGL context loss. You will need to re-add them manually after context restoration.`);this._lostContextStyle=this._getStyleAndImages(),this.style.destroy(),this.style=null,this.fire(new i.l("webglcontextlost",{originalEvent:j}))},this._contextRestored=j=>{this._lostContextStyle.style&&this.setStyle(this._lostContextStyle.style,{diff:!1}),this._lostContextStyle.images&&(this.style.imageManager.images=this._lostContextStyle.images),this._setupPainter(),this.resize(),this._update(),this.fire(new i.l("webglcontextrestored",{originalEvent:j}))},this._onMapScroll=j=>{if(j.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=v.interactive,this._maxTileCacheSize=v.maxTileCacheSize,this._maxTileCacheZoomLevels=v.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},v.canvasContextAttributes),this._trackResize=v.trackResize===!0,this._bearingSnap=v.bearingSnap,this._centerClampedToGround=v.centerClampedToGround,this._refreshExpiredTiles=v.refreshExpiredTiles===!0,this._fadeDuration=v.fadeDuration,this._crossSourceCollisions=v.crossSourceCollisions===!0,this._collectResourceTiming=v.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Ei),v.locale),this._clickTolerance=v.clickTolerance,this._overridePixelRatio=v.pixelRatio,this._maxCanvasSize=v.maxCanvasSize,this._zoomLevelsToOverscale=v.experimentalZoomLevelsToOverscale,this.transformCameraUpdate=v.transformCameraUpdate,this.transformConstrain=v.transformConstrain,this.cancelPendingTileRequestsWhileZooming=v.cancelPendingTileRequestsWhileZooming===!0,v.reduceMotion!==void 0&&(Rr.prefersReducedMotion=v.reduceMotion),this._imageQueueHandle=bo.addThrottleControl(()=>this.isMoving()),this._requestManager=new ba(v.transformRequest),typeof v.container=="string"){if(this._container=document.getElementById(v.container),!this._container)throw new Error(`Container '${v.container}' not found.`)}else{if(!(v.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=v.container}if(v.maxBounds&&this.setMaxBounds(v.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this.on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}),this.once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let j=!1;const H=ed(J=>{this._trackResize&&!this._removed&&(this.resize(J),this.redraw())},50);this._resizeObserver=new ResizeObserver(J=>{j?H(J):j=!0}),this._resizeObserver.observe(this._container)}this.handlers=new Xh(this,v),this._hash=v.hash&&new sh(typeof v.hash=="string"&&v.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:v.center,elevation:v.elevation,zoom:v.zoom,bearing:v.bearing,pitch:v.pitch,roll:v.roll}),v.bounds&&(this.resize(),this.fitBounds(v.bounds,i.e({},v.fitBoundsOptions,{duration:0}))));const k=typeof v.style=="string"||((d=(s=v.style)===null||s===void 0?void 0:s.projection)===null||d===void 0?void 0:d.type)!=="globe";this.resize(null,k),this._localIdeographFontFamily=v.localIdeographFontFamily,this._validateStyle=v.validateStyle,v.style&&this.setStyle(v.style,{localIdeographFontFamily:v.localIdeographFontFamily}),v.attributionControl&&this.addControl(new _s(typeof v.attributionControl=="boolean"?void 0:v.attributionControl)),v.maplibreLogo&&this.addControl(new bl,v.logoPosition),this.on("style.load",()=>{if(k||this._resizeTransform(),this.transform.unmodified){const j=i.U(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(j)}}),this.on("data",j=>{this._update(j.dataType==="style"),this.fire(new i.l(`${j.dataType}data`,j))}),this.on("dataloading",j=>{this.fire(new i.l(`${j.dataType}dataloading`,j))}),this.on("dataabort",j=>{this.fire(new i.l("sourcedataabort",j))})}_getMapId(){return this._mapId}setGlobalStateProperty(C,s){return this.style.setGlobalStateProperty(C,s),this._update(!0)}getGlobalState(){return this.style.getGlobalState()}addControl(C,s){if(s===void 0&&(s=C.getDefaultPosition?C.getDefaultPosition():"top-right"),!C||!C.onAdd)return this.fire(new i.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const d=C.onAdd(this);this._controls.push(C);const v=this._controlPositions[s];return s.indexOf("bottom")!==-1?v.insertBefore(d,v.firstChild):v.appendChild(d),this}removeControl(C){if(!C||!C.onRemove)return this.fire(new i.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const s=this._controls.indexOf(C);return s>-1&&this._controls.splice(s,1),C.onRemove(this),this}hasControl(C){return this._controls.indexOf(C)>-1}coveringTiles(C){return Ae(this.transform,C)}calculateCameraOptionsFromTo(C,s,d,v){return v==null&&this.terrain&&(v=this.terrain.getElevationForLngLatZoom(d,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(C,s,d,v)}resize(C,s=!0){const[d,v]=this._containerDimensions(),S=this._getClampedPixelRatio(d,v);if(this._resizeCanvas(d,v,S),this.painter.resize(d,v,S),this.painter.overLimit()){const k=this.painter.context.gl;this._maxCanvasSize=[k.drawingBufferWidth,k.drawingBufferHeight];const j=this._getClampedPixelRatio(d,v);this._resizeCanvas(d,v,j),this.painter.resize(d,v,j)}this._resizeTransform(s);const D=!this._moving;return D&&(this.stop(),this.fire(new i.l("movestart",C)).fire(new i.l("move",C))),this.fire(new i.l("resize",C)),D&&this.fire(new i.l("moveend",C)),this}_resizeTransform(C=!0){var s;const[d,v]=this._containerDimensions();this.transform.resize(d,v,C),(s=this._requestedCameraState)===null||s===void 0||s.resize(d,v,C)}_getClampedPixelRatio(C,s){const{0:d,1:v}=this._maxCanvasSize,S=this.getPixelRatio(),D=C*S,k=s*S;return Math.min(D>d?d/D:1,k>v?v/k:1)*S}getPixelRatio(){var C;return(C=this._overridePixelRatio)!==null&&C!==void 0?C:devicePixelRatio}setPixelRatio(C){this._overridePixelRatio=C,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(C){return this.transform.setMaxBounds(xo.convert(C)),this._update()}setMinZoom(C){if((C=C??-2)>=-2&&C<=this.transform.maxZoom)return this.transform.setMinZoom(C),this._update(),this.getZoom()<C&&this.setZoom(C),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(C){if((C=C??22)>=this.transform.minZoom)return this.transform.setMaxZoom(C),this._update(),this.getZoom()>C&&this.setZoom(C),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(C){if((C=C??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(C>=0&&C<=this.transform.maxPitch)return this.transform.setMinPitch(C),this._update(),this.getPitch()<C&&this.setPitch(C),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(C){if((C=C??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(C>=this.transform.minPitch)return this.transform.setMaxPitch(C),this._update(),this.getPitch()>C&&this.setPitch(C),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(C){return this.transform.setRenderWorldCopies(C),this._update()}setTransformConstrain(C){return this.transform.setConstrainOverride(C),this._update()}project(C){return this.transform.locationToScreenPoint(i.V.convert(C),this.style&&this.terrain)}unproject(C){return this.transform.screenPointToLocation(i.P.convert(C),this.terrain)}isMoving(){var C;return this._moving||((C=this.handlers)===null||C===void 0?void 0:C.isMoving())}isZooming(){var C;return this._zooming||((C=this.handlers)===null||C===void 0?void 0:C.isZooming())}isRotating(){var C;return this._rotating||((C=this.handlers)===null||C===void 0?void 0:C.isRotating())}_createDelegatedListener(C,s,d){if(C==="mouseenter"||C==="mouseover"){let v=!1;return{layers:s,listener:d,delegates:{mousemove:D=>{const k=s.filter(H=>this.getLayer(H)),j=k.length!==0?this.queryRenderedFeatures(D.point,{layers:k}):[];j.length?v||(v=!0,d.call(this,new ns(C,this,D.originalEvent,{features:j}))):v=!1},mouseout:()=>{v=!1}}}}if(C==="mouseleave"||C==="mouseout"){let v=!1;return{layers:s,listener:d,delegates:{mousemove:k=>{const j=s.filter(H=>this.getLayer(H));(j.length!==0?this.queryRenderedFeatures(k.point,{layers:j}):[]).length?v=!0:v&&(v=!1,d.call(this,new ns(C,this,k.originalEvent)))},mouseout:k=>{v&&(v=!1,d.call(this,new ns(C,this,k.originalEvent)))}}}}{const v=S=>{const D=s.filter(j=>this.getLayer(j)),k=D.length!==0?this.queryRenderedFeatures(S.point,{layers:D}):[];k.length&&(S.features=k,d.call(this,S),delete S.features)};return{layers:s,listener:d,delegates:{[C]:v}}}}_saveDelegatedListener(C,s){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[C]=this._delegatedListeners[C]||[],this._delegatedListeners[C].push(s)}_removeDelegatedListener(C,s,d){if(!this._delegatedListeners||!this._delegatedListeners[C])return;const v=this._delegatedListeners[C];for(let S=0;S<v.length;S++){const D=v[S];if(D.listener===d&&D.layers.length===s.length&&D.layers.every(k=>s.includes(k))){for(const k in D.delegates)this.off(k,D.delegates[k]);return void v.splice(S,1)}}}on(C,s,d){if(d===void 0)return super.on(C,s);const v=typeof s=="string"?[s]:s,S=this._createDelegatedListener(C,v,d);this._saveDelegatedListener(C,S);for(const D in S.delegates)this.on(D,S.delegates[D]);return{unsubscribe:()=>{this._removeDelegatedListener(C,v,d)}}}once(C,s,d){if(d===void 0)return super.once(C,s);const v=typeof s=="string"?[s]:s,S=this._createDelegatedListener(C,v,d);for(const D in S.delegates){const k=S.delegates[D];S.delegates[D]=(...j)=>{this._removeDelegatedListener(C,v,d),k(...j)}}this._saveDelegatedListener(C,S);for(const D in S.delegates)this.once(D,S.delegates[D]);return this}off(C,s,d){return d===void 0?super.off(C,s):(this._removeDelegatedListener(C,typeof s=="string"?[s]:s,d),this)}queryRenderedFeatures(C,s){if(!this.style)return[];let d;const v=C instanceof i.P||Array.isArray(C),S=v?C:[[0,0],[this.transform.width,this.transform.height]];if(s=s||(v?{}:C)||{},S instanceof i.P||typeof S[0]=="number")d=[i.P.convert(S)];else{const D=i.P.convert(S[0]),k=i.P.convert(S[1]);d=[D,new i.P(k.x,D.y),k,new i.P(D.x,k.y),D]}return this.style.queryRenderedFeatures(d,s,this.transform)}querySourceFeatures(C,s){return this.style.querySourceFeatures(C,s)}setStyle(C,s){return(s=i.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},s)).diff!==!1&&s.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&C?(this._diffStyle(C,s),this):(this._localIdeographFontFamily=s.localIdeographFontFamily,this._updateStyle(C,s))}setTransformRequest(C){return this._requestManager.setTransformRequest(C),this}_getUIString(C){const s=this._locale[C];if(s==null)throw new Error(`Missing UI string '${C}'`);return s}_updateStyle(C,s){var d,v;if(s.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(C,s));const S=this.style&&s.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!C)),C?(this.style=new Ho(this,s||{}),this.style.setEventedParent(this,{style:this.style}),typeof C=="string"?this.style.loadURL(C,s,S):this.style.loadJSON(C,s,S),this):((v=(d=this.style)===null||d===void 0?void 0:d.projection)===null||v===void 0||v.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new Ho(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(C,s){if(typeof C=="string"){const d=this._requestManager.transformRequest(C,"Style");i.j(d,new AbortController).then(v=>{this._updateDiff(v.data,s)}).catch(v=>{v&&this.fire(new i.k(v))})}else typeof C=="object"&&this._updateDiff(C,s)}_updateDiff(C,s){try{this.style.setState(C,s)&&this._update(!0)}catch(d){i.w(`Unable to perform style diff: ${d.message||d.error||d}.  Rebuilding the style from scratch.`),this._updateStyle(C,s)}}getStyle(){if(this.style)return this.style.serialize()}_getStyleAndImages(){return this.style?{style:this.style.serialize(),images:this.style.imageManager.cloneImages()}:{style:null,images:{}}}isStyleLoaded(){return this.style?this.style.loaded():i.w("There is no style added to the map.")}addSource(C,s){return this._lazyInitEmptyStyle(),this.style.addSource(C,s),this._update(!0)}isSourceLoaded(C){const s=this.style&&this.style.tileManagers[C];if(s!==void 0)return s.loaded();this.fire(new i.k(new Error(`There is no tile manager with ID '${C}'`)))}setTerrain(C){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),C){const s=this.style.tileManagers[C.source];if(!s)throw new Error(`cannot load terrain, because there exists no source with ID: ${C.source}`);this.terrain===null&&s.reload();for(const d in this.style._layers){const v=this.style._layers[d];v.type==="hillshade"&&v.source===C.source&&i.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality."),v.type==="color-relief"&&v.source===C.source&&i.w("You are using the same source for a color-relief layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new Mp(this.painter,s,C),this.painter.renderToTexture=new Ko(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=d=>{var v;d.dataType==="style"?this.terrain.tileManager.freeRtt():d.dataType==="source"&&d.tile&&(d.sourceId!==C.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),((v=d.source)===null||v===void 0?void 0:v.type)==="image"?this.terrain.tileManager.freeRtt():this.terrain.tileManager.freeRtt(d.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.tileManager.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new i.l("terrain",{terrain:C})),this}getTerrain(){var C,s;return(s=(C=this.terrain)===null||C===void 0?void 0:C.options)!==null&&s!==void 0?s:null}areTilesLoaded(){const C=this.style&&this.style.tileManagers;for(const s in C){const d=C[s]._tiles;for(const v in d){const S=d[v];if(S.state!=="loaded"&&S.state!=="errored")return!1}}return!0}removeSource(C){return this.style.removeSource(C),this._update(!0)}getSource(C){return this.style.getSource(C)}setSourceTileLodParams(C,s,d){if(d){const v=this.getSource(d);if(!v)throw new Error(`There is no source with ID "${d}", cannot set LOD parameters`);v.calculateTileZoom=ui(Math.max(1,C),Math.max(1,s))}else for(const v in this.style.tileManagers)this.style.tileManagers[v].getSource().calculateTileZoom=ui(Math.max(1,C),Math.max(1,s));return this._update(!0),this}refreshTiles(C,s){const d=this.style.tileManagers[C];if(!d)throw new Error(`There is no tile manager with ID "${C}", cannot refresh tile`);s===void 0?d.reload(!0):d.refreshTiles(s.map(v=>new i.ad(v.z,v.x,v.y)))}addImage(C,s,d={}){const{pixelRatio:v=1,sdf:S=!1,stretchX:D,stretchY:k,content:j,textFitWidth:H,textFitHeight:J}=d;if(this._lazyInitEmptyStyle(),!(s instanceof HTMLImageElement||i.b(s))){if(s.width===void 0||s.height===void 0)return this.fire(new i.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:et,height:mt,data:dt}=s,Tt=s;return this.style.addImage(C,{data:new i.R({width:et,height:mt},new Uint8Array(dt)),pixelRatio:v,stretchX:D,stretchY:k,content:j,textFitWidth:H,textFitHeight:J,sdf:S,version:0,userImage:Tt}),Tt.onAdd&&Tt.onAdd(this,C),this}}{const{width:et,height:mt,data:dt}=Rr.getImageData(s);this.style.addImage(C,{data:new i.R({width:et,height:mt},dt),pixelRatio:v,stretchX:D,stretchY:k,content:j,textFitWidth:H,textFitHeight:J,sdf:S,version:0})}}updateImage(C,s){const d=this.style.getImage(C);if(!d)return this.fire(new i.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const v=s instanceof HTMLImageElement||i.b(s)?Rr.getImageData(s):s,{width:S,height:D,data:k}=v;if(S===void 0||D===void 0)return this.fire(new i.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(S!==d.data.width||D!==d.data.height)return this.fire(new i.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const j=!(s instanceof HTMLImageElement||i.b(s));return d.data.replace(k,j),this.style.updateImage(C,d),this}getImage(C){return this.style.getImage(C)}hasImage(C){return C?!!this.style.getImage(C):(this.fire(new i.k(new Error("Missing required image id"))),!1)}removeImage(C){this.style.removeImage(C)}loadImage(C){return bo.getImage(this._requestManager.transformRequest(C,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(C,s){return this._lazyInitEmptyStyle(),this.style.addLayer(C,s),this._update(!0)}moveLayer(C,s){return this.style.moveLayer(C,s),this._update(!0)}removeLayer(C){return this.style.removeLayer(C),this._update(!0)}getLayer(C){return this.style.getLayer(C)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(C,s,d){return this.style.setLayerZoomRange(C,s,d),this._update(!0)}setFilter(C,s,d={}){return this.style.setFilter(C,s,d),this._update(!0)}getFilter(C){return this.style.getFilter(C)}setPaintProperty(C,s,d,v={}){return this.style.setPaintProperty(C,s,d,v),this._update(!0)}getPaintProperty(C,s){return this.style.getPaintProperty(C,s)}setLayoutProperty(C,s,d,v={}){return this.style.setLayoutProperty(C,s,d,v),this._update(!0)}getLayoutProperty(C,s){return this.style.getLayoutProperty(C,s)}setGlyphs(C,s={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(C,s),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(C,s,d={}){return this._lazyInitEmptyStyle(),this.style.addSprite(C,s,d,v=>{v||this._update(!0)}),this}removeSprite(C){return this._lazyInitEmptyStyle(),this.style.removeSprite(C),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(C,s={}){return this._lazyInitEmptyStyle(),this.style.setSprite(C,s,d=>{d||this._update(!0)}),this}setLight(C,s={}){return this._lazyInitEmptyStyle(),this.style.setLight(C,s),this._update(!0)}getLight(){return this.style.getLight()}setSky(C,s={}){return this._lazyInitEmptyStyle(),this.style.setSky(C,s),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(C,s){return this.style.setFeatureState(C,s),this._update()}removeFeatureState(C,s){return this.style.removeFeatureState(C,s),this._update()}getFeatureState(C){return this.style.getFeatureState(C)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let C=0,s=0;return this._container&&(C=this._container.clientWidth||400,s=this._container.clientHeight||300),[C,s]}_setupContainer(){const C=this._container;C.classList.add("maplibregl-map");const s=this._canvasContainer=Re.create("div","maplibregl-canvas-container",C);this._interactive&&s.classList.add("maplibregl-interactive"),this._canvas=Re.create("canvas","maplibregl-canvas",s),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const d=this._containerDimensions(),v=this._getClampedPixelRatio(d[0],d[1]);this._resizeCanvas(d[0],d[1],v);const S=this._controlContainer=Re.create("div","maplibregl-control-container",C),D=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(k=>{D[k]=Re.create("div",`maplibregl-ctrl-${k} `,S)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(C,s,d){this._canvas.width=Math.floor(d*C),this._canvas.height=Math.floor(d*s),this._canvas.style.width=`${C}px`,this._canvas.style.height=`${s}px`}_setupPainter(){const C=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let s=null;this._canvas.addEventListener("webglcontextcreationerror",v=>{s={requestedAttributes:C},v&&(s.statusMessage=v.statusMessage,s.type=v.type)},{once:!0});let d=null;if(d=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,C):this._canvas.getContext("webgl2",C)||this._canvas.getContext("webgl",C),!d){const v="Failed to initialize WebGL";throw s?(s.message=v,new Error(JSON.stringify(s))):new Error(v)}this.painter=new Od(d,this.transform),Rn.testSupport(d)}migrateProjection(C,s){super.migrateProjection(C,s),this.painter.transform=C,this.fire(new i.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(C){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||C,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(C){return this._update(),this._renderTaskQueue.add(C)}_cancelRenderFrame(C){this._renderTaskQueue.remove(C)}_render(C){var s,d,v,S,D;const k=this._idleTriggered?this._fadeDuration:0,j=((s=this.style.projection)===null||s===void 0?void 0:s.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(C),this._removed)return;let H=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const mt=this.transform.zoom,dt=Ci();this.style.zoomHistory.update(mt,dt);const Tt=new i.H(mt,{now:dt,fadeDuration:k,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),pt=Tt.crossFadingFactor();pt===1&&pt===this._crossFadingFactor||(H=!0,this._crossFadingFactor=pt),this.style.update(Tt)}const J=((d=this.style.projection)===null||d===void 0?void 0:d.transitionState)>0!==j;(v=this.style.projection)===null||v===void 0||v.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((S=this.style.projection)===null||S===void 0?void 0:S.transitionState,(D=this.style.projection)===null||D===void 0?void 0:D.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||J)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.tileManager.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,k,this._crossSourceCollisions,J),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:k,showPadding:this.showPadding}),this.fire(new i.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,i.cF.mark(i.cG.load),this.fire(new i.l("load"))),this.style&&(this.style.hasTransitions()||H)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const et=this._sourcesDirty||this._styleDirty||this._placementDirty;return et||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new i.l("idle")),!this._loaded||this._fullyLoaded||et||(this._fullyLoaded=!0,i.cF.mark(i.cG.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var C;this._hash&&this._hash.remove();for(const d of this._controls)d.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),bo.removeThrottleControl(this._imageQueueHandle),(C=this._resizeObserver)===null||C===void 0||C.disconnect();const s=this.painter.context.gl.getExtension("WEBGL_lose_context");s!=null&&s.loseContext&&s.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),Re.remove(this._canvasContainer),Re.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),i.cF.clearMetrics(),this._removed=!0,this.fire(new i.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,Rr.frame(this._frameRequest,C=>{i.cF.frame(C),this._frameRequest=null;try{this._render(C)}catch(s){if(!i.cH(s)&&!function(d){return d.message===fu}(s))throw s}},()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(C){this._showTileBoundaries!==C&&(this._showTileBoundaries=C,this._update())}get showPadding(){return!!this._showPadding}set showPadding(C){this._showPadding!==C&&(this._showPadding=C,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(C){this._showCollisionBoxes!==C&&(this._showCollisionBoxes=C,C?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(C){this._showOverdrawInspector!==C&&(this._showOverdrawInspector=C,this._update())}get repaint(){return!!this._repaint}set repaint(C){this._repaint!==C&&(this._repaint=C,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(C){this._vertices=C,this._update()}get version(){return Iu}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(C){return this._lazyInitEmptyStyle(),this.style.setProjection(C),this._update(!0)}},nt.MapMouseEvent=ns,nt.MapTouchEvent=xu,nt.MapWheelEvent=ah,nt.Marker=Jh,nt.NavigationControl=class{constructor(C){this._updateZoomButtons=()=>{const s=this._map.getZoom(),d=s===this._map.getMaxZoom(),v=s===this._map.getMinZoom();this._zoomInButton.disabled=d,this._zoomOutButton.disabled=v,this._zoomInButton.setAttribute("aria-disabled",d.toString()),this._zoomOutButton.setAttribute("aria-disabled",v.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(s,d)=>{const v=this._map._getUIString(`NavigationControl.${d}`);s.title=v,s.setAttribute("aria-label",v)},this.options=i.e({},Gc,C),this._container=Re.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",s=>s.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",s=>this._map.zoomIn({},{originalEvent:s})),Re.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",s=>this._map.zoomOut({},{originalEvent:s})),Re.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",s=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:s}):this._map.resetNorth({},{originalEvent:s})}),this._compassIcon=Re.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(C){return this._map=C,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new $c(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){Re.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(C,s){const d=Re.create("button",C,this._container);return d.type="button",d.addEventListener("click",s),d}},nt.Popup=class extends i.E{constructor(C){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:"")},this.remove=()=>(this._content&&Re.remove(this._content),this._container&&(Re.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new i.l("close"))),this),this._onMouseUp=s=>{this._update(s.point)},this._onMouseMove=s=>{this._update(s.point)},this._onDrag=s=>{this._update(s.point)},this._update=s=>{if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=Re.create("div","maplibregl-popup",this._map.getContainer()),this._tip=Re.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const k of this.options.className.split(" "))this._container.classList.add(k);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=Yh(this._lngLat,this._flatPos,this._map.transform,this._trackPointer),this._trackPointer&&!s)return;const d=this._flatPos=this._pos=this._trackPointer&&s?s:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&s?s:this._map.transform.locationToScreenPoint(this._lngLat));let v=this.options.anchor;const S=gc(this.options.offset);if(!v){const k=this._container.offsetWidth,j=this._container.offsetHeight;let H;H=d.y+S.bottom.y<j?["top"]:d.y>this._map.transform.height-j?["bottom"]:[],d.x<k/2?H.push("left"):d.x>this._map.transform.width-k/2&&H.push("right"),v=H.length===0?"bottom":H.join("-")}let D=d.add(S[v]);this.options.subpixelPositioning||(D=D.round()),Re.setTransform(this._container,`${hd[v]} translate(${D.x}px,${D.y}px)`),Eu(this._container,v,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=i.e(Object.create(ud),C)}addTo(C){return this._map&&this.remove(),this._map=C,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new i.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(C){return this._lngLat=i.V.convert(C),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(C){return this.setDOMContent(document.createTextNode(C))}setHTML(C){const s=document.createDocumentFragment(),d=document.createElement("body");let v;for(d.innerHTML=C;v=d.firstChild,v;)s.appendChild(v);return this.setDOMContent(s)}getMaxWidth(){var C;return(C=this._container)===null||C===void 0?void 0:C.style.maxWidth}setMaxWidth(C){return this.options.maxWidth=C,this._update(),this}setDOMContent(C){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=Re.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(C),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(C){return this._container&&this._container.classList.add(C),this}removeClassName(C){return this._container&&this._container.classList.remove(C),this}setOffset(C){return this.options.offset=C,this._update(),this}toggleClassName(C){if(this._container)return this._container.classList.toggle(C)}setSubpixelPositioning(C){this.options.subpixelPositioning=C}_createCloseButton(){this.options.closeButton&&(this._closeButton=Re.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const C=this._container.querySelector(pa);C&&C.focus()}},nt.RasterDEMTileSource=Ms,nt.RasterTileSource=$l,nt.ScaleControl=class{constructor(C){this._onMove=()=>{Cp(this._map,this._container,this.options)},this.setUnit=s=>{this.options.unit=s,Cp(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},vf),C)}getDefaultPosition(){return"bottom-left"}onAdd(C){return this._map=C,this._container=Re.create("div","maplibregl-ctrl maplibregl-ctrl-scale",C.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){Re.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},nt.ScrollZoomHandler=Su,nt.Style=Ho,nt.TerrainControl=class{constructor(C){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=C}onAdd(C){return this._map=C,this._container=Re.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=Re.create("button","maplibregl-ctrl-terrain",this._container),Re.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){Re.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},nt.TwoFingersTouchPitchHandler=sd,nt.TwoFingersTouchRotateHandler=fc,nt.TwoFingersTouchZoomHandler=yf,nt.TwoFingersTouchZoomRotateHandler=Jf,nt.VectorTileSource=ll,nt.VideoSource=cl,nt.addSourceType=(C,s)=>i._(void 0,void 0,void 0,function*(){if(Vs(C))throw new Error(`A source type called "${C}" already exists.`);((d,v)=>{Cl[d]=v})(C,s)}),nt.clearPrewarmedResources=function(){const C=Wr;C&&(C.isPreloaded()&&C.numActive()===1?(C.release(di),Wr=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},nt.createTileMesh=Jc,nt.getMaxParallelImageRequests=function(){return i.a.MAX_PARALLEL_IMAGE_REQUESTS},nt.getRTLTextPluginStatus=function(){return Da().getRTLTextPluginStatus()},nt.getVersion=function(){return Zd},nt.getWorkerCount=function(){return tr.workerCount},nt.getWorkerUrl=function(){return i.a.WORKER_URL},nt.importScriptInWorkers=function(C){return $n().broadcast("IS",C)},nt.isTimeFrozen=function(){return xr.isFrozen()},nt.now=Ci,nt.prewarm=function(){Xi().acquire(di)},nt.restoreNow=function(){xr.restoreNow()},nt.setMaxParallelImageRequests=function(C){i.a.MAX_PARALLEL_IMAGE_REQUESTS=C},nt.setNow=function(C){xr.setNow(C)},nt.setRTLTextPlugin=function(C,s){return Da().setRTLTextPlugin(C,s)},nt.setWorkerCount=function(C){tr.workerCount=C},nt.setWorkerUrl=function(C){i.a.WORKER_URL=C}});var qt=Lt;return qt})})(Sb);var VT=Sb.exports;const nv=Tb(VT);var Eb={exports:{}};(function(jt,bt){(function(Lt,re){jt.exports=re()})(wb,function(){var Lt,re,Dt;function qt(i,Le){if(!Lt)Lt=Le;else if(!re)re=Le;else{var wi="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+Lt+")(sharedChunk); ("+re+")(sharedChunk); self.onerror = null;",nr={};Lt(nr),Dt=Le(nr),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Dt.workerUrl=window.URL.createObjectURL(new Blob([wi],{type:"text/javascript"})))}}qt(["exports"],function(i){var Le=1e-6,wi=typeof Float32Array<"u"?Float32Array:Array;function nr(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=r*m-u*l;return _?(n[0]=m*(_=1/_),n[1]=-l*_,n[2]=-u*_,n[3]=r*_,n):null}function bn(){var n=new wi(9);return wi!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function cn(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=t[4],b=t[5],E=t[6],P=t[7],R=t[8];return n[0]=_*R-b*P,n[1]=u*P-l*R,n[2]=l*b-u*_,n[3]=b*E-m*R,n[4]=r*R-u*E,n[5]=u*m-r*b,n[6]=m*P-_*E,n[7]=l*E-r*P,n[8]=r*_-l*m,n}function Rr(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3],b=t[4],E=t[5],P=t[6],R=t[7],F=t[8],O=r[0],$=r[1],q=r[2],Y=r[3],it=r[4],at=r[5],gt=r[6],yt=r[7],At=r[8];return n[0]=O*l+$*_+q*P,n[1]=O*u+$*b+q*R,n[2]=O*m+$*E+q*F,n[3]=Y*l+it*_+at*P,n[4]=Y*u+it*b+at*R,n[5]=Y*m+it*E+at*F,n[6]=gt*l+yt*_+At*P,n[7]=gt*u+yt*b+At*R,n[8]=gt*m+yt*E+At*F,n}function xr(){var n=new wi(16);return wi!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function Ci(n){var t=new wi(16);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t}function Re(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function Rn(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=t[4],b=t[5],E=t[6],P=t[7],R=t[8],F=t[9],O=t[10],$=t[11],q=t[12],Y=t[13],it=t[14],at=t[15],gt=r*b-l*_,yt=r*E-u*_,At=r*P-m*_,Gt=l*E-u*b,kt=l*P-m*b,Xt=u*P-m*E,te=R*Y-F*q,ne=R*it-O*q,ze=R*at-$*q,fe=F*it-O*Y,ke=F*at-$*Y,Ue=O*at-$*it,Ze=gt*Ue-yt*ke+At*fe+Gt*ze-kt*ne+Xt*te;return Ze?(n[0]=(b*Ue-E*ke+P*fe)*(Ze=1/Ze),n[1]=(u*ke-l*Ue-m*fe)*Ze,n[2]=(Y*Xt-it*kt+at*Gt)*Ze,n[3]=(O*kt-F*Xt-$*Gt)*Ze,n[4]=(E*ze-_*Ue-P*ne)*Ze,n[5]=(r*Ue-u*ze+m*ne)*Ze,n[6]=(it*At-q*Xt-at*yt)*Ze,n[7]=(R*Xt-O*At+$*yt)*Ze,n[8]=(_*ke-b*ze+P*te)*Ze,n[9]=(l*ze-r*ke-m*te)*Ze,n[10]=(q*kt-Y*At+at*gt)*Ze,n[11]=(F*At-R*kt-$*gt)*Ze,n[12]=(b*ne-_*fe-E*te)*Ze,n[13]=(r*fe-l*ne+u*te)*Ze,n[14]=(Y*yt-q*Gt-it*gt)*Ze,n[15]=(R*Gt-F*yt+O*gt)*Ze,n):null}function pr(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3],b=t[4],E=t[5],P=t[6],R=t[7],F=t[8],O=t[9],$=t[10],q=t[11],Y=t[12],it=t[13],at=t[14],gt=t[15],yt=r[0],At=r[1],Gt=r[2],kt=r[3];return n[0]=yt*l+At*b+Gt*F+kt*Y,n[1]=yt*u+At*E+Gt*O+kt*it,n[2]=yt*m+At*P+Gt*$+kt*at,n[3]=yt*_+At*R+Gt*q+kt*gt,n[4]=(yt=r[4])*l+(At=r[5])*b+(Gt=r[6])*F+(kt=r[7])*Y,n[5]=yt*u+At*E+Gt*O+kt*it,n[6]=yt*m+At*P+Gt*$+kt*at,n[7]=yt*_+At*R+Gt*q+kt*gt,n[8]=(yt=r[8])*l+(At=r[9])*b+(Gt=r[10])*F+(kt=r[11])*Y,n[9]=yt*u+At*E+Gt*O+kt*it,n[10]=yt*m+At*P+Gt*$+kt*at,n[11]=yt*_+At*R+Gt*q+kt*gt,n[12]=(yt=r[12])*l+(At=r[13])*b+(Gt=r[14])*F+(kt=r[15])*Y,n[13]=yt*u+At*E+Gt*O+kt*it,n[14]=yt*m+At*P+Gt*$+kt*at,n[15]=yt*_+At*R+Gt*q+kt*gt,n}function $r(n,t,r){var l,u,m,_,b,E,P,R,F,O,$,q,Y=r[0],it=r[1],at=r[2];return t===n?(n[12]=t[0]*Y+t[4]*it+t[8]*at+t[12],n[13]=t[1]*Y+t[5]*it+t[9]*at+t[13],n[14]=t[2]*Y+t[6]*it+t[10]*at+t[14],n[15]=t[3]*Y+t[7]*it+t[11]*at+t[15]):(u=t[1],m=t[2],_=t[3],b=t[4],E=t[5],P=t[6],R=t[7],F=t[8],O=t[9],$=t[10],q=t[11],n[0]=l=t[0],n[1]=u,n[2]=m,n[3]=_,n[4]=b,n[5]=E,n[6]=P,n[7]=R,n[8]=F,n[9]=O,n[10]=$,n[11]=q,n[12]=l*Y+b*it+F*at+t[12],n[13]=u*Y+E*it+O*at+t[13],n[14]=m*Y+P*it+$*at+t[14],n[15]=_*Y+R*it+q*at+t[15]),n}function En(n,t,r){var l=r[0],u=r[1],m=r[2];return n[0]=t[0]*l,n[1]=t[1]*l,n[2]=t[2]*l,n[3]=t[3]*l,n[4]=t[4]*u,n[5]=t[5]*u,n[6]=t[6]*u,n[7]=t[7]*u,n[8]=t[8]*m,n[9]=t[9]*m,n[10]=t[10]*m,n[11]=t[11]*m,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}function $o(n,t,r){var l=Math.sin(r),u=Math.cos(r),m=t[4],_=t[5],b=t[6],E=t[7],P=t[8],R=t[9],F=t[10],O=t[11];return t!==n&&(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[4]=m*u+P*l,n[5]=_*u+R*l,n[6]=b*u+F*l,n[7]=E*u+O*l,n[8]=P*u-m*l,n[9]=R*u-_*l,n[10]=F*u-b*l,n[11]=O*u-E*l,n}function no(n,t,r){var l=Math.sin(r),u=Math.cos(r),m=t[0],_=t[1],b=t[2],E=t[3],P=t[8],R=t[9],F=t[10],O=t[11];return t!==n&&(n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=m*u-P*l,n[1]=_*u-R*l,n[2]=b*u-F*l,n[3]=E*u-O*l,n[8]=m*l+P*u,n[9]=_*l+R*u,n[10]=b*l+F*u,n[11]=E*l+O*u,n}function bo(n,t,r){var l=Math.sin(r),u=Math.cos(r),m=t[0],_=t[1],b=t[2],E=t[3],P=t[4],R=t[5],F=t[6],O=t[7];return t!==n&&(n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15]),n[0]=m*u+P*l,n[1]=_*u+R*l,n[2]=b*u+F*l,n[3]=E*u+O*l,n[4]=P*u-m*l,n[5]=R*u-_*l,n[6]=F*u-b*l,n[7]=O*u-E*l,n}function ba(n,t){return n[0]=t[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=t[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=t[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function Os(n,t,r){var l,u,m,_=r[0],b=r[1],E=r[2],P=Math.sqrt(_*_+b*b+E*E);return P<Le?null:(_*=P=1/P,b*=P,E*=P,l=Math.sin(t),u=Math.cos(t),n[0]=_*_*(m=1-u)+u,n[1]=b*_*m+E*l,n[2]=E*_*m-b*l,n[3]=0,n[4]=_*b*m-E*l,n[5]=b*b*m+u,n[6]=E*b*m+_*l,n[7]=0,n[8]=_*E*m+b*l,n[9]=b*E*m-_*l,n[10]=E*E*m+u,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function Ya(n,t){var r=t[0],l=t[1],u=t[2],m=t[4],_=t[5],b=t[6],E=t[8],P=t[9],R=t[10];return n[0]=Math.sqrt(r*r+l*l+u*u),n[1]=Math.sqrt(m*m+_*_+b*b),n[2]=Math.sqrt(E*E+P*P+R*R),n}function al(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=r+r,b=l+l,E=u+u,P=r*_,R=l*_,F=l*b,O=u*_,$=u*b,q=u*E,Y=m*_,it=m*b,at=m*E;return n[0]=1-F-q,n[1]=R+at,n[2]=O-it,n[3]=0,n[4]=R-at,n[5]=1-P-q,n[6]=$+Y,n[7]=0,n[8]=O+it,n[9]=$-Y,n[10]=1-P-F,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}var Ja=pr;function Hr(){var n=new wi(3);return wi!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function sc(n){var t=new wi(3);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function cs(n){var t=n[0],r=n[1],l=n[2];return Math.sqrt(t*t+r*r+l*l)}function Kn(n,t,r){var l=new wi(3);return l[0]=n,l[1]=t,l[2]=r,l}function hn(n,t,r,l){return n[0]=t,n[1]=r,n[2]=l,n}function Co(n,t,r){return n[0]=t[0]+r[0],n[1]=t[1]+r[1],n[2]=t[2]+r[2],n}function zn(n,t,r){return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],n}function Ys(n,t,r){return n[0]=t[0]*r[0],n[1]=t[1]*r[1],n[2]=t[2]*r[2],n}function vs(n,t,r){return n[0]=Math.min(t[0],r[0]),n[1]=Math.min(t[1],r[1]),n[2]=Math.min(t[2],r[2]),n}function Ps(n,t,r){return n[0]=Math.max(t[0],r[0]),n[1]=Math.max(t[1],r[1]),n[2]=Math.max(t[2],r[2]),n}function Hn(n,t,r){return n[0]=t[0]*r,n[1]=t[1]*r,n[2]=t[2]*r,n}function di(n,t,r,l){return n[0]=t[0]+r[0]*l,n[1]=t[1]+r[1]*l,n[2]=t[2]+r[2]*l,n}function tr(n,t){var r=t[0]-n[0],l=t[1]-n[1],u=t[2]-n[2];return Math.sqrt(r*r+l*l+u*u)}function fr(n,t){var r=t[0]-n[0],l=t[1]-n[1],u=t[2]-n[2];return r*r+l*l+u*u}function Wr(n){var t=n[0],r=n[1],l=n[2];return t*t+r*r+l*l}function qr(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}function Xi(n,t){var r=t[0],l=t[1],u=t[2],m=r*r+l*l+u*u;return m>0&&(m=1/Math.sqrt(m)),n[0]=t[0]*m,n[1]=t[1]*m,n[2]=t[2]*m,n}function Xr(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function $n(n,t,r){var l=t[0],u=t[1],m=t[2],_=r[0],b=r[1],E=r[2];return n[0]=u*E-m*b,n[1]=m*_-l*E,n[2]=l*b-u*_,n}function qo(n,t,r,l){var u=t[0],m=t[1],_=t[2];return n[0]=u+l*(r[0]-u),n[1]=m+l*(r[1]-m),n[2]=_+l*(r[2]-_),n}function On(n,t,r){var l=t[0],u=t[1],m=t[2],_=r[3]*l+r[7]*u+r[11]*m+r[15];return n[0]=(r[0]*l+r[4]*u+r[8]*m+r[12])/(_=_||1),n[1]=(r[1]*l+r[5]*u+r[9]*m+r[13])/_,n[2]=(r[2]*l+r[6]*u+r[10]*m+r[14])/_,n}function ho(n,t,r){var l=t[0],u=t[1],m=t[2];return n[0]=l*r[0]+u*r[3]+m*r[6],n[1]=l*r[1]+u*r[4]+m*r[7],n[2]=l*r[2]+u*r[5]+m*r[8],n}function ds(n,t,r){var l=r[0],u=r[1],m=r[2],_=r[3],b=t[0],E=t[1],P=t[2],R=u*P-m*E,F=m*b-l*P,O=l*E-u*b;return n[0]=b+_*(R+=R)+u*(O+=O)-m*(F+=F),n[1]=E+_*F+m*R-l*O,n[2]=P+_*O+l*F-u*R,n}function Ns(n){return n[0]=0,n[1]=0,n[2]=0,n}function xo(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]}var oo=zn,ll=Ys,$l=cs;function Ms(){var n=new wi(4);return wi!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function wa(n,t,r){return n[0]=t[0]*r,n[1]=t[1]*r,n[2]=t[2]*r,n[3]=t[3]*r,n}function ql(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=r*r+l*l+u*u+m*m;return _>0&&(_=1/Math.sqrt(_)),n[0]=r*_,n[1]=l*_,n[2]=u*_,n[3]=m*_,n}function bs(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3];return n[0]=r[0]*l+r[4]*u+r[8]*m+r[12]*_,n[1]=r[1]*l+r[5]*u+r[9]*m+r[13]*_,n[2]=r[2]*l+r[6]*u+r[10]*m+r[14]*_,n[3]=r[3]*l+r[7]*u+r[11]*m+r[15]*_,n}function Cs(){var n=new wi(4);return wi!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function cl(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function Ml(n,t,r){r*=.5;var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E+_*b,n[1]=u*E+m*b,n[2]=m*E-u*b,n[3]=_*E-l*b,n}function Cl(n,t,r){r*=.5;var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E-m*b,n[1]=u*E+_*b,n[2]=m*E+l*b,n[3]=_*E-u*b,n}Hr(),Ms();var Vs,hl,Ka,Zl=ql,Da=(Vs=Hr(),hl=Kn(1,0,0),Ka=Kn(0,1,0),function(n,t,r){var l=Xr(t,r);return l<-.999999?($n(Vs,hl,t),$l(Vs)<1e-6&&$n(Vs,Ka,t),Xi(Vs,Vs),function(u,m,_){_*=.5;var b=Math.sin(_);u[0]=b*m[0],u[1]=b*m[1],u[2]=b*m[2],u[3]=Math.cos(_)}(n,Vs,Math.PI),n):l>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):($n(Vs,t,r),n[0]=Vs[0],n[1]=Vs[1],n[2]=Vs[2],n[3]=1+l,Zl(n,n))});function so(){var n=new wi(2);return wi!=Float32Array&&(n[0]=0,n[1]=0),n}function we(n,t){var r=new wi(2);return r[0]=n,r[1]=t,r}function St(n,t,r){return n[0]=t,n[1]=r,n}function Pt(n,t,r){return n[0]=t[0]+r[0],n[1]=t[1]+r[1],n}function Nt(n,t,r){return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n}function ce(n,t,r){return n[0]=t[0]*r,n[1]=t[1]*r,n}function ae(n){var t=n[0],r=n[1];return Math.sqrt(t*t+r*r)}function Fe(n,t){var r=t[0],l=t[1],u=r*r+l*l;return u>0&&(u=1/Math.sqrt(u)),n[0]=t[0]*u,n[1]=t[1]*u,n}function Jt(n,t){return n[0]*t[0]+n[1]*t[1]}Cs(),Cs(),bn();var De,We,ci=Nt;function ui(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}so();var cr=function(){if(We)return De;function n(t,r,l,u){this.cx=3*t,this.bx=3*(l-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*r,this.by=3*(u-r)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=r,this.p2x=l,this.p2y=u}return We=1,De=n,n.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,r){if(r===void 0&&(r=1e-6),t<0)return 0;if(t>1)return 1;for(var l=t,u=0;u<8;u++){var m=this.sampleCurveX(l)-t;if(Math.abs(m)<r)return l;var _=this.sampleCurveDerivativeX(l);if(Math.abs(_)<1e-6)break;l-=m/_}var b=0,E=1;for(l=t,u=0;u<20&&(m=this.sampleCurveX(l),!(Math.abs(m-t)<r));u++)t>m?b=l:E=l,l=.5*(E-b)+b;return l},solve:function(t,r){return this.sampleCurveY(this.solveCurveX(t,r))}},De}(),zr=ui(cr);function Ae(n,t){this.x=n,this.y=t}function Do(n,t){if(Array.isArray(n)){if(!Array.isArray(t)||n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(!Do(n[r],t[r]))return!1;return!0}if(typeof n=="object"&&n!==null&&t!==null){if(typeof t!="object"||Object.keys(n).length!==Object.keys(t).length)return!1;for(const r in n)if(!Do(n[r],t[r]))return!1;return!0}return n===t}Ae.prototype={clone(){return new Ae(this.x,this.y)},add(n){return this.clone()._add(n)},sub(n){return this.clone()._sub(n)},multByPoint(n){return this.clone()._multByPoint(n)},divByPoint(n){return this.clone()._divByPoint(n)},mult(n){return this.clone()._mult(n)},div(n){return this.clone()._div(n)},rotate(n){return this.clone()._rotate(n)},rotateAround(n,t){return this.clone()._rotateAround(n,t)},matMult(n){return this.clone()._matMult(n)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(n){return this.x===n.x&&this.y===n.y},dist(n){return Math.sqrt(this.distSqr(n))},distSqr(n){const t=n.x-this.x,r=n.y-this.y;return t*t+r*r},angle(){return Math.atan2(this.y,this.x)},angleTo(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith(n){return this.angleWithSep(n.x,n.y)},angleWithSep(n,t){return Math.atan2(this.x*t-this.y*n,this.x*n+this.y*t)},_matMult(n){const t=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=t,this},_add(n){return this.x+=n.x,this.y+=n.y,this},_sub(n){return this.x-=n.x,this.y-=n.y,this},_mult(n){return this.x*=n,this.y*=n,this},_div(n){return this.x/=n,this.y/=n,this},_multByPoint(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint(n){return this.x/=n.x,this.y/=n.y,this},_unit(){return this._div(this.mag()),this},_perp(){const n=this.y;return this.y=this.x,this.x=-n,this},_rotate(n){const t=Math.cos(n),r=Math.sin(n),l=r*this.x+t*this.y;return this.x=t*this.x-r*this.y,this.y=l,this},_rotateAround(n,t){const r=Math.cos(n),l=Math.sin(n),u=t.y+l*(this.x-t.x)+r*(this.y-t.y);return this.x=t.x+r*(this.x-t.x)-l*(this.y-t.y),this.y=u,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Ae},Ae.convert=function(n){if(n instanceof Ae)return n;if(Array.isArray(n))return new Ae(+n[0],+n[1]);if(n.x!==void 0&&n.y!==void 0)return new Ae(+n.x,+n.y);throw new Error("Expected [x, y] or {x, y} point format")};const An=Math.PI/180,Qn=180/Math.PI;function ar(n){return n*An}function bi(n){return n*Qn}const Zo=[[0,0],[1,0],[1,1],[0,1]];function zo(n){if(n<=0)return 0;if(n>=1)return 1;const t=n*n,r=t*n;return 4*(n<.5?r:3*(n-t)+r-.75)}function se(n,t,r,l){const u=new zr(n,t,r,l);return function(m){return u.solve(m)}}const st=se(.25,.1,.25,1);function tt(n,t,r){return Math.min(r,Math.max(t,n))}function wt(n,t,r){return(r=tt((r-n)/(t-n),0,1))*r*(3-2*r)}function Bt(n,t,r){const l=r-t,u=((n-t)%l+l)%l+t;return u===t?r:u}function Ht(n,t,r){if(!n.length)return r(null,[]);let l=n.length;const u=new Array(n.length);let m=null;n.forEach((_,b)=>{t(_,(E,P)=>{E&&(m=E),u[b]=P,--l==0&&r(m,u)})})}let oe=1;function ye(){return oe++}function Yt(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log2(n)))}function xe(n,t){n.forEach(r=>{t[r]&&(t[r]=t[r].bind(t))})}function ti(n,t,r){const l={};for(const u in n)l[u]=t.call(this,n[u],u,n);return l}function $e(n,t,r){const l={};for(const u in n)t.call(this,n[u],u,n)&&(l[u]=n[u]);return l}function Di(n){return Array.isArray(n)?n.map(Di):typeof n=="object"&&n?ti(n,Di):n}function er(n,t){for(let r=0;r<n.length;r++)if(t.indexOf(n[r])>=0)return!0;return!1}const Ki={};function Hi(n){Ki[n]||(typeof console<"u"&&console.warn(n),Ki[n]=!0)}function gr(n,t,r){return(r.y-n.y)*(t.x-n.x)>(t.y-n.y)*(r.x-n.x)}function Qi(n){let t=0;for(let r,l,u=0,m=n.length,_=m-1;u<m;_=u++)r=n[u],l=n[_],t+=(l.x-r.x)*(r.y+l.y);return t}function Cn([n,t,r]){const l=ar(t+90),u=ar(r);return{x:n*Math.cos(l)*Math.sin(u),y:n*Math.sin(l)*Math.sin(u),z:n*Math.cos(u),azimuthal:t,polar:r}}function Nn(n){return(typeof self<"u"||n!==void 0)&&typeof WorkerGlobalScope<"u"&&(n!==void 0?n:self)instanceof WorkerGlobalScope}function Vo(n){const t={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,l,u,m)=>{const _=u||m;return t[l]=!_||_.toLowerCase(),""}),t["max-age"]){const r=parseInt(t["max-age"],10);isNaN(r)?delete t["max-age"]:t["max-age"]=r}return t}let Qr=null;function ao(n,t){return[n[4*t],n[4*t+1],n[4*t+2],n[4*t+3]]}function gn(n,t,r,l){for(;t<r;){const u=t+r>>1;n[u]<l?t=u+1:r=u}return t}function Ur(n,t,r,l){for(;t<r;){const u=t+r>>1;n[u]<=l?t=u+1:r=u}return t}function Wn(n){return n>0?1/(1.001-n):1+n}function to(n){return n>0?1-1/(1.001-n):-n}function Dn(n,t,r){return(n-t.min)*(r.max-r.min)/(t.max-t.min)+r.min}const eo={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!eo.API_URL)return null;try{const n=new URL(eo.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.3.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function ps(n){return eo.API_URL_REGEX.test(n)}function na(n){return eo.API_SPRITE_REGEX.test(n)}let Dl,Ih,hs,ul,Ta,zl;function za(){return Dl==null&&(Dl=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Dl}const Qa={now:()=>ul!==void 0?ul:performance.now(),setNow(n){ul=n},restoreNow(){ul=void 0},frame(n){const t=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(t)}},getImageData(n,t=0){const{width:r,height:l}=n;Ta||(Ta=document.createElement("canvas"));const u=Ta.getContext("2d",{willReadFrequently:!0});if(!u)throw new Error("failed to create canvas 2d context");return(r>Ta.width||l>Ta.height)&&(Ta.width=r,Ta.height=l),u.clearRect(-t,-t,r+2*t,l+2*t),u.drawImage(n,0,0,r,l),u.getImageData(-t,-t,r+2*t,l+2*t)},resolveURL:n=>(Ih||(Ih=document.createElement("a")),Ih.href=n,Ih.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(hs==null&&(hs=window.matchMedia("(prefers-reduced-motion: reduce)")),hs.matches)},hasCanvasFingerprintNoise(){if(zl!==void 0)return zl;if(!za())return zl=!1,!1;const n=new OffscreenCanvas(85,1),t=n.getContext("2d",{willReadFrequently:!0});let r=0;for(let u=0;u<n.width;++u)t.fillStyle=`rgba(${r++},${r++},${r++}, 255)`,t.fillRect(u,0,1,1);const l=t.getImageData(0,0,n.width,n.height);r=0;for(let u=0;u<l.data.length;++u)if(u%4!=3&&r++!==l.data[u])return zl=!0,!0;return zl=!1,!1}};function Hl(n,t){const r=n.indexOf("?");if(r<0)return`${n}?${new URLSearchParams(t).toString()}`;const l=new URLSearchParams(n.slice(r));for(const u in t)l.set(u,t[u]);return`${n.slice(0,r)}?${l.toString()}`}function Eh(n,t={persistentParams:[]}){const r=n.indexOf("?");if(r<0)return n;const l=new URLSearchParams,u=new URLSearchParams(n.slice(r));for(const _ of t.persistentParams){const b=u.get(_);b&&l.set(_,b)}const m=l.toString();return`${n.slice(0,r)}${m.length>0?`?${m}`:""}`}const Nu="mapbox-tiles";let dl=500,La=50;const ac=["language","worldview","jobid"];let fs,Js;function un(){try{return caches}catch{}}function oa(){const n=un();n&&fs==null&&(fs=n.open(Nu))}let Vn=1/0;const lc={supported:!1,testSupport:function(n){!sa&&ms&&(Us?Vu(n):Uo=n)}};let Uo,ms,sa=!1,Us=!1;const Xn=typeof self<"u"?self:{};function Vu(n){const t=n.createTexture();n.bindTexture(n.TEXTURE_2D,t);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,ms),n.isContextLost())return;lc.supported=!0}catch{}n.deleteTexture(t),sa=!0}Xn.document&&(ms=Xn.document.createElement("img"),ms.onload=function(){Uo&&Vu(Uo),Uo=null,Us=!0},ms.onerror=function(){sa=!0,Uo=null},ms.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Ds={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Ds);class js extends Error{constructor(t,r,l){r===401&&ps(l)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=r,this.url=l}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const aa=Nn()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Uu=function(n,t){if(!(/^file:/.test(r=n.url)||/^file:/.test(aa())&&!/^\w+:/.test(r))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(l,u){const m=new AbortController,_=new Request(l.url,{method:l.method||"GET",body:l.body,credentials:l.credentials,headers:l.headers,referrer:aa(),referrerPolicy:l.referrerPolicy,signal:m.signal});let b=!1,E=!1;const P=(R=_.url).indexOf("sku=")>0&&ps(R);var R;l.type==="json"&&_.headers.set("Accept","application/json");const F=($,q,Y)=>{if(E)return;if($&&$.message!=="SecurityError"&&Hi($.toString()),q&&Y)return O(q);const it=Date.now();fetch(_).then(at=>{if(at.ok){const gt=P?at.clone():null;return O(at,gt,it)}return u(new js(at.statusText,at.status,l.url))}).catch(at=>{at.name!=="AbortError"&&u(new Error(`${at.message} ${l.url}`))})},O=($,q,Y)=>{(l.type==="arrayBuffer"?$.arrayBuffer():l.type==="json"?$.json():$.text()).then(it=>{E||(q&&Y&&function(at,gt,yt){if(oa(),fs==null)return;const At=Vo(gt.headers.get("Cache-Control")||"");if(At["no-store"])return;const Gt={status:gt.status,statusText:gt.statusText,headers:new Headers};gt.headers.forEach((te,ne)=>Gt.headers.set(ne,te)),At["max-age"]&&Gt.headers.set("Expires",new Date(yt+1e3*At["max-age"]).toUTCString());const kt=Gt.headers.get("Expires");if(!kt||new Date(kt).getTime()-yt<42e4)return;let Xt=Eh(at.url,{persistentParams:ac});if(gt.status===206){const te=at.headers.get("Range");if(!te)return;Gt.status=200,Xt=Hl(Xt,{range:te})}(function(te,ne){if(Js===void 0)try{new Response(new ReadableStream),Js=!0}catch{Js=!1}Js?ne(te.body):te.blob().then(ne).catch(ze=>Hi(ze.message))})(gt,te=>{const ne=new Response((ze=gt.status)!==200&&ze!==404&&[101,103,204,205,304].includes(ze)?null:te,Gt);var ze;oa(),fs!=null&&fs.then(fe=>fe.put(Xt,ne)).catch(fe=>Hi(fe.message))})}(_,q,Y),b=!0,u(null,it,$.headers))}).catch(it=>{E||u(new Error(it.message))})};return P?function($,q){if(oa(),fs==null)return q(null);fs.then(Y=>{let it=Eh($.url,{persistentParams:ac});const at=$.headers.get("Range");at&&(it=Hl(it,{range:at})),Y.match(it).then(gt=>{const yt=function(At){if(!At)return!1;const Gt=new Date(At.headers.get("Expires")||0),kt=Vo(At.headers.get("Cache-Control")||"");return Number(Gt)>Date.now()&&!kt["no-cache"]}(gt);Y.delete(it).catch(q),yt&&Y.put(it,gt.clone()).catch(q),q(null,gt,yt)}).catch(q)}).catch(q)}(_,F):F(null,null),{cancel:()=>{E=!0,b||m.abort()}}}(n,t);if(Nn(self)&&self.worker.actor)return self.worker.actor.send("getResource",n,t,void 0,!0)}var r;return function(l,u){const m=new XMLHttpRequest;m.open(l.method||"GET",l.url,!0),l.type==="arrayBuffer"&&(m.responseType="arraybuffer");for(const _ in l.headers)m.setRequestHeader(_,l.headers[_]);return l.type==="json"&&(m.responseType="text",m.setRequestHeader("Accept","application/json")),m.withCredentials=l.credentials==="include",m.onerror=()=>{u(new Error(m.statusText))},m.onload=()=>{if((m.status>=200&&m.status<300||m.status===0)&&m.response!==null){let _=m.response;if(l.type==="json")try{_=JSON.parse(m.response)}catch(E){return u(E)}const b=new Headers;m.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(E=>{const P=E.split(": "),R=P.shift(),F=P.join(": ");b.append(R,F)}),u(null,_,b)}else u(new js(m.statusText,m.status,l.url))},m.send(l.body),{cancel:()=>m.abort()}}(n,t)},Ll=function(n,t){return Uu(Object.assign(n,{type:"arrayBuffer"}),t)};function vr(n){const t=document.createElement("a");return t.href=n,t.protocol===location.protocol&&t.host===location.host}const Ah="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Wl,Yc;Wl=[],Yc=0;const Ra=function(n,t){if(lc.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),Yc>=eo.MAX_PARALLEL_IMAGE_REQUESTS){const m={requestParameters:n,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return Wl.push(m),m}Yc++;let r=!1;const l=()=>{if(!r)for(r=!0,Yc--;Wl.length&&Yc<eo.MAX_PARALLEL_IMAGE_REQUESTS;){const m=Wl.shift(),{requestParameters:_,callback:b,cancelled:E}=m;E||(m.cancel=Ra(_,b).cancel)}},u=Ll(n,(m,_,b)=>{l(),m?t(m):_&&(self.createImageBitmap?function(E,P){const R=new Blob([new Uint8Array(E)],{type:"image/png"});createImageBitmap(R).then(F=>{P(null,F)}).catch(F=>{P(new Error(`Could not load image because of ${F.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(_,(E,P)=>t(E,P,b)):function(E,P){const R=new Image;R.onload=()=>{P(null,R),URL.revokeObjectURL(R.src),R.onload=null,requestAnimationFrame(()=>{R.src=Ah})},R.onerror=()=>P(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const F=new Blob([new Uint8Array(E)],{type:"image/png"});R.src=E.byteLength?URL.createObjectURL(F):Ah}(_,(E,P)=>t(E,P,b)))});return{cancel:()=>{u.cancel(),l()}}};var ko,pl,qn,rn={exports:{}},lu={exports:{}},Un={exports:{}},ju=function(){if(qn)return rn.exports;qn=1;var n=(ko||(ko=1,lu.exports=function(r,l){var u,m,_,b,E,P,R,F;for(m=r.length-(u=3&r.length),_=l,E=3432918353,P=461845907,F=0;F<m;)R=255&r.charCodeAt(F)|(255&r.charCodeAt(++F))<<8|(255&r.charCodeAt(++F))<<16|(255&r.charCodeAt(++F))<<24,++F,_=27492+(65535&(b=5*(65535&(_=(_^=R=(65535&(R=(R=(65535&R)*E+(((R>>>16)*E&65535)<<16)&4294967295)<<15|R>>>17))*P+(((R>>>16)*P&65535)<<16)&4294967295)<<13|_>>>19))+((5*(_>>>16)&65535)<<16)&4294967295))+((58964+(b>>>16)&65535)<<16);switch(R=0,u){case 3:R^=(255&r.charCodeAt(F+2))<<16;case 2:R^=(255&r.charCodeAt(F+1))<<8;case 1:_^=R=(65535&(R=(R=(65535&(R^=255&r.charCodeAt(F)))*E+(((R>>>16)*E&65535)<<16)&4294967295)<<15|R>>>17))*P+(((R>>>16)*P&65535)<<16)&4294967295}return _^=r.length,_=2246822507*(65535&(_^=_>>>16))+((2246822507*(_>>>16)&65535)<<16)&4294967295,_=3266489909*(65535&(_^=_>>>13))+((3266489909*(_>>>16)&65535)<<16)&4294967295,(_^=_>>>16)>>>0}),lu.exports),t=(pl||(pl=1,Un.exports=function(r,l){for(var u,m=r.length,_=l^m,b=0;m>=4;)u=1540483477*(65535&(u=255&r.charCodeAt(b)|(255&r.charCodeAt(++b))<<8|(255&r.charCodeAt(++b))<<16|(255&r.charCodeAt(++b))<<24))+((1540483477*(u>>>16)&65535)<<16),_=1540483477*(65535&_)+((1540483477*(_>>>16)&65535)<<16)^(u=1540483477*(65535&(u^=u>>>24))+((1540483477*(u>>>16)&65535)<<16)),m-=4,++b;switch(m){case 3:_^=(255&r.charCodeAt(b+2))<<16;case 2:_^=(255&r.charCodeAt(b+1))<<8;case 1:_=1540483477*(65535&(_^=255&r.charCodeAt(b)))+((1540483477*(_>>>16)&65535)<<16)}return _=1540483477*(65535&(_^=_>>>13))+((1540483477*(_>>>16)&65535)<<16),(_^=_>>>15)>>>0}),Un.exports);return rn.exports=n,rn.exports.murmur3=n,rn.exports.murmur2=t,rn.exports}(),tl=ui(ju);class Sa{constructor(t,...r){Object.assign(this,r[0]||{}),this.type=t}}class cc extends Sa{constructor(t,r={}){super("error",Object.assign({error:t},r))}}function Jc(n,t,r){r[n]&&r[n].indexOf(t)!==-1||(r[n]=r[n]||[],r[n].push(t))}function Kc(n,t,r){if(r&&r[n]){const l=r[n].indexOf(t);l!==-1&&r[n].splice(l,1)}}class Rl{on(t,r){return this._listeners=this._listeners||{},Jc(t,r,this._listeners),this}off(t,r){return Kc(t,r,this._listeners),Kc(t,r,this._oneTimeListeners),this}once(t,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},Jc(t,r,this._oneTimeListeners),this):new Promise(l=>{this.once(t,l)})}fire(t,r){const l=typeof t=="string"?new Sa(t,r):t,u=l.type;if(this.listens(u)){l.target=this;const m=this._listeners&&this._listeners[u]?this._listeners[u].slice():[];for(const E of m)E.call(this,l);const _=this._oneTimeListeners&&this._oneTimeListeners[u]?this._oneTimeListeners[u].slice():[];for(const E of _)Kc(u,E,this._oneTimeListeners),E.call(this,l);const b=this._eventedParent;if(b){const E=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(l,E),b.fire(l)}}else l instanceof cc&&console.error(l.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,r){return this._eventedParent=t,this._eventedParentData=r,this}}class es{constructor(t){typeof t=="string"?this.name=t:(this.name=t.name,this.iconsetId=t.iconsetId)}static from(t){return new es(t)}static toString(t){return t.iconsetId?`${t.name}${t.iconsetId}`:t.name}static parse(t){const[r,l]=t.split("");return new es({name:r,iconsetId:l})}static isEqual(t,r){return t.name===r.name&&t.iconsetId===r.iconsetId}toString(){return es.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Ph,pp={},Xl=function(){if(Ph)return pp;Ph=1;var n={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function t(m){return(m=Math.round(m))<0?0:m>255?255:m}function r(m){return t(m[m.length-1]==="%"?parseFloat(m)/100*255:parseInt(m))}function l(m){return(_=m[m.length-1]==="%"?parseFloat(m)/100:parseFloat(m))<0?0:_>1?1:_;var _}function u(m,_,b){return b<0?b+=1:b>1&&(b-=1),6*b<1?m+(_-m)*b*6:2*b<1?_:3*b<2?m+(_-m)*(2/3-b)*6:m}try{pp.parseCSSColor=function(m){var _,b=m.replace(/ /g,"").toLowerCase();if(b in n)return n[b].slice();if(b[0]==="#")return b.length===4?(_=parseInt(b.substr(1),16))>=0&&_<=4095?[(3840&_)>>4|(3840&_)>>8,240&_|(240&_)>>4,15&_|(15&_)<<4,1]:null:b.length===7&&(_=parseInt(b.substr(1),16))>=0&&_<=16777215?[(16711680&_)>>16,(65280&_)>>8,255&_,1]:null;var E=b.indexOf("("),P=b.indexOf(")");if(E!==-1&&P+1===b.length){var R=b.substr(0,E),F=b.substr(E+1,P-(E+1)).split(","),O=1;switch(R){case"rgba":if(F.length!==4)return null;O=l(F.pop());case"rgb":return F.length!==3?null:[r(F[0]),r(F[1]),r(F[2]),O];case"hsla":if(F.length!==4)return null;O=l(F.pop());case"hsl":if(F.length!==3)return null;var $=(parseFloat(F[0])%360+360)%360/360,q=l(F[1]),Y=l(F[2]),it=Y<=.5?Y*(q+1):Y+q-Y*q,at=2*Y-it;return[t(255*u(at,it,$+1/3)),t(255*u(at,it,$)),t(255*u(at,it,$-1/3)),O];default:return null}}return null}}catch{}return pp}();class Br{constructor(t,r,l,u=1){this.r=t,this.g=r,this.b=l,this.a=u}static parse(t){if(!t)return;if(t instanceof Br)return t;if(typeof t!="string")return;const r=Xl.parseCSSColor(t);return r?new Br(r[0]/255,r[1]/255,r[2]/255,r[3]):void 0}toString(){const[t,r,l,u]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*t)},${Math.round(255*r)},${Math.round(255*l)},${u})`}toNonPremultipliedRenderColor(t){const{r,g:l,b:u,a:m}=this;return new cf(t,r,l,u,m)}toPremultipliedRenderColor(t){const{r,g:l,b:u,a:m}=this;return new la(t,r*m,l*m,u*m,m)}clone(){return new Br(this.r,this.g,this.b,this.a)}}class Gu{constructor(t,r,l,u,m,_=!1){if(this.premultiplied=!1,this.premultiplied=_,t){const b=t.image.height,E=b*b;this.premultiplied?(r=m===0?0:r/m*(b-1),l=m===0?0:l/m*(b-1),u=m===0?0:u/m*(b-1)):(r*=b-1,l*=b-1,u*=b-1);const P=Math.floor(r),R=Math.floor(l),F=Math.floor(u),O=Math.ceil(r),$=Math.ceil(l),q=Math.ceil(u),Y=r-P,it=l-R,at=u-F,gt=t.image.data,yt=4*(P+R*E+F*b),At=4*(P+R*E+q*b),Gt=4*(P+$*E+F*b),kt=4*(P+$*E+q*b),Xt=4*(O+R*E+F*b),te=4*(O+R*E+q*b),ne=4*(O+$*E+F*b),ze=4*(O+$*E+q*b);if(yt<0||ze>=gt.length)throw new Error("out of range");this.r=Gi(Gi(Gi(gt[yt],gt[At],at),Gi(gt[Gt],gt[kt],at),it),Gi(Gi(gt[Xt],gt[te],at),Gi(gt[ne],gt[ze],at),it),Y)/255*(this.premultiplied?m:1),this.g=Gi(Gi(Gi(gt[yt+1],gt[At+1],at),Gi(gt[Gt+1],gt[kt+1],at),it),Gi(Gi(gt[Xt+1],gt[te+1],at),Gi(gt[ne+1],gt[ze+1],at),it),Y)/255*(this.premultiplied?m:1),this.b=Gi(Gi(Gi(gt[yt+2],gt[At+2],at),Gi(gt[Gt+2],gt[kt+2],at),it),Gi(Gi(gt[Xt+2],gt[te+2],at),Gi(gt[ne+2],gt[ze+2],at),it),Y)/255*(this.premultiplied?m:1),this.a=m}else this.r=r,this.g=l,this.b=u,this.a=m}toArray(){const{r:t,g:r,b:l,a:u}=this;return[255*t,255*r,255*l,u]}toHslaArray(){let{r:t,g:r,b:l,a:u}=this;if(this.premultiplied){if(u===0)return[0,0,0,0];const q=1/u;t*=q,r*=q,l*=q}const m=Math.min(Math.max(t,0),1),_=Math.min(Math.max(r,0),1),b=Math.min(Math.max(l,0),1),E=Math.min(m,_,b),P=Math.max(m,_,b),R=P-E,F=.5*(E+P);if(R===0)return[0,0,100*F,u];const O=F>.5?R/(2-P-E):R/(P+E);let $;switch(P){case m:$=60*((_-b)/R+(_<b?6:0));break;case _:$=60*((b-m)/R+2);break;default:$=60*((m-_)/R+4)}return[$,100*O,100*F,u]}toArray01(){const{r:t,g:r,b:l,a:u}=this;return[t,r,l,u]}toArray01Scaled(t){const{r,g:l,b:u}=this;return[r*t,l*t,u*t]}toArray01Linear(){const{r:t,g:r,b:l,a:u}=this;return[Math.pow(t,2.2),Math.pow(r,2.2),Math.pow(l,2.2),u]}}class cf extends Gu{constructor(t,r,l,u,m){super(t,r,l,u,m,!1)}}class la extends Gu{constructor(t,r,l,u,m){super(t,r,l,u,m,!0)}}function Gi(n,t,r){return n*(1-r)+t*r}function el(n,t,r){return n.map((l,u)=>Gi(l,t[u],r))}Br.black=new Br(0,0,0,1),Br.white=new Br(1,1,1,1),Br.transparent=new Br(0,0,0,0),Br.red=new Br(1,0,0,1),Br.blue=new Br(0,0,1,1);var fl=Object.freeze({__proto__:null,array:el,color:function(n,t,r){return new Br(Gi(n.r,t.r,r),Gi(n.g,t.g,r),Gi(n.b,t.b,r),Gi(n.a,t.a,r))},number:Gi});class ml extends Error{constructor(t,r){super(r),this.message=r,this.key=t}}class kl{constructor(t,r=[]){this.parent=t,this.bindings={};for(const[l,u]of r)this.bindings[l]=u}concat(t){return new kl(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}const ka={kind:"null"},Vi={kind:"number"},Jr={kind:"string"},mn={kind:"boolean"},il={kind:"color"},Qc={kind:"object"},dn={kind:"value"},ca={kind:"collator"},Dc={kind:"formatted"},hc={kind:"resolvedImage"};function ws(n,t){return{kind:"array",itemType:n,N:t}}function Ho(n){if(n.kind==="array"){const t=Ho(n.itemType);return typeof n.N=="number"?`array<${t}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${t}>`}return n.kind}const zc=[ka,Vi,Jr,mn,il,Dc,Qc,ws(dn),hc];function Id(n,t){if(t.kind==="error")return null;if(n.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!Id(n.itemType,t.itemType))&&(typeof n.N!="number"||n.N===t.N))return null}else{if(n.kind===t.kind)return null;if(n.kind==="value"){for(const r of zc)if(!Id(r,t))return null}}return`Expected ${Ho(n)} but found ${Ho(t)} instead.`}function Ed(n,t){return t.some(r=>r.kind===n.kind)}function th(n,t){return t.some(r=>r==="null"?n===null:r==="array"?Array.isArray(n):r==="object"?n&&!Array.isArray(n)&&typeof n=="object":r===typeof n)}function uc(n,t){return n.kind==="array"&&t.kind==="array"?n.N===t.N&&uc(n.itemType,t.itemType):n.kind===t.kind}class hf{constructor(t,r,l){this.sensitivity=t?r?"variant":"case":r?"accent":"base",this.locale=l,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,r){return this.collator.compare(t,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class eh{constructor(t,r,l,u,m){this.text=t.normalize?t.normalize():t,this.image=r,this.scale=l,this.fontStack=u,this.textColor=m}}class Ts{constructor(t){this.sections=t}static fromString(t){return new Ts([new eh(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||!!t.image&&t.image.hasPrimary())}static factory(t){return t instanceof Ts?t:Ts.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const r of this.sections){if(r.image){const u=r.image.getPrimary().id.toString();t.push(["image",u]);continue}t.push(r.text);const l={};r.fontStack&&(l["text-font"]=["literal",r.fontStack.split(",")]),r.scale&&(l["font-scale"]=r.scale),r.textColor&&(l["text-color"]=["rgba"].concat(r.textColor.toNonPremultipliedRenderColor(null).toArray())),t.push(l)}return t}}class gl{constructor(t,r={}){if(this.id=es.from(t),this.options=Object.assign({},r),r.transform){const{a:l,b:u,c:m,d:_,e:b,f:E}=r.transform;this.options.transform=new DOMMatrix([l,u,m,_,b,E])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:t,b:r,c:l,d:u,e:m,f:_}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:t,b:r,c:l,d:u,e:m,f:_}})}static parse(t){let r,l,u,m;try{({name:r,iconsetId:l,params:u,transform:m}=JSON.parse(t)||{})}catch{return null}if(!r)return null;const{a:_,b,c:E,d:P,e:R,f:F}=m||{};return new gl({name:r,iconsetId:l},{params:u,transform:new DOMMatrix([_,b,E,P,R,F])})}scaleSelf(t,r){return this.options.transform.scaleSelf(t,r),this}}class Fa{constructor(t,r,l,u,m=!1){this.primaryId=es.from(t),this.primaryOptions=r,l&&(this.secondaryId=es.from(l)),this.secondaryOptions=u,this.available=m}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new gl(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new gl(this.secondaryId,this.secondaryOptions):null}static from(t){return typeof t=="string"?Fa.build({name:t}):t}static build(t,r,l,u){return!t||typeof t=="object"&&!("name"in t)?null:new Fa(t,l,r,u)}}function Ad(n,t,r,l){return typeof n=="number"&&n>=0&&n<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof r=="number"&&r>=0&&r<=255?l===void 0||typeof l=="number"&&l>=0&&l<=1?null:`Invalid rgba value [${[n,t,r,l].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof l=="number"?[n,t,r,l]:[n,t,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function $u(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof Br||n instanceof hf||n instanceof Ts||n instanceof Fa)return!0;if(Array.isArray(n)){for(const t of n)if(!$u(t))return!1;return!0}if(typeof n=="object"){for(const t in n)if(!$u(n[t]))return!1;return!0}return!1}function gs(n){if(n===null)return ka;if(typeof n=="string")return Jr;if(typeof n=="boolean")return mn;if(typeof n=="number")return Vi;if(n instanceof Br)return il;if(n instanceof hf)return ca;if(n instanceof Ts)return Dc;if(n instanceof Fa)return hc;if(Array.isArray(n)){const t=n.length;let r;for(const l of n){const u=gs(l);if(r){if(r===u)continue;r=dn;break}r=u}return ws(r||dn,t)}return Qc}function Yl(n){const t=typeof n;return n===null?"":t==="string"||t==="number"||t==="boolean"?String(n):n instanceof Ts||n instanceof Fa||n instanceof Br?n.toString():JSON.stringify(n)}class Lc{constructor(t,r){this.type=t,this.value=r}static parse(t,r){if(t.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!$u(t[1]))return r.error("invalid value");const l=t[1];let u=gs(l);const m=r.expectedType;return u.kind!=="array"||u.N!==0||!m||m.kind!=="array"||typeof m.N=="number"&&m.N!==0||(u=m),new Lc(u,l)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Br?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Ts?this.value.serialize():this.value}}class Fo{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}}const Sr={string:Jr,number:Vi,boolean:mn,object:Qc};class ki{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");let l,u=1;const m=t[0];if(m==="array"){let b,E;if(t.length>2){const P=t[1];if(typeof P!="string"||!(P in Sr)||P==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);b=Sr[P],u++}else b=dn;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return r.error('The length argument to "array" must be a positive integer literal',2);E=t[2],u++}l=ws(b,E)}else l=Sr[m];const _=[];for(;u<t.length;u++){const b=r.parse(t[u],u,dn);if(!b)return null;_.push(b)}return new ki(l,_)}evaluate(t){for(let r=0;r<this.args.length;r++){const l=this.args[r].evaluate(t);if(!Id(this.type,gs(l)))return l;if(r===this.args.length-1)throw new Fo(`The expression ${JSON.stringify(this.args[r].serialize())} evaluated to ${Ho(gs(l))} but was expected to be of type ${Ho(this.type)}.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,r=[t.kind];if(t.kind==="array"){const l=t.itemType;if(l.kind==="string"||l.kind==="number"||l.kind==="boolean"){r.push(l.kind);const u=t.N;(typeof u=="number"||this.args.length>1)&&r.push(u)}}return r.concat(this.args.map(l=>l.serialize()))}}class Fl{constructor(t){this.type=Dc,this.sections=t}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const l=t[1];if(!Array.isArray(l)&&typeof l=="object")return r.error("First argument must be an image or text section.");const u=[];let m=!1;for(let _=1;_<=t.length-1;++_){const b=t[_];if(m&&typeof b=="object"&&!Array.isArray(b)){m=!1;let E=null;if(b["font-scale"]&&(E=r.parseObjectValue(b["font-scale"],_,"font-scale",Vi),!E))return null;let P=null;if(b["text-font"]&&(P=r.parseObjectValue(b["text-font"],_,"text-font",ws(Jr)),!P))return null;let R=null;if(b["text-color"]&&(R=r.parseObjectValue(b["text-color"],_,"text-color",il),!R))return null;const F=u[u.length-1];F.scale=E,F.font=P,F.textColor=R}else{const E=r.parse(t[_],_,dn);if(!E)return null;const P=E.type.kind;if(P!=="string"&&P!=="value"&&P!=="null"&&P!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");m=!0,u.push({content:E,scale:null,font:null,textColor:null})}}return new Fl(u)}evaluate(t){return new Ts(this.sections.map(r=>{const l=r.content.evaluate(t);return uc(gs(l),hc)?new eh("",l,null,null,null):new eh(Yl(l),null,r.scale?r.scale.evaluate(t):null,r.font?r.font.evaluate(t).join(","):null,r.textColor?r.textColor.evaluate(t):null)}))}eachChild(t){for(const r of this.sections)t(r.content),r.scale&&t(r.scale),r.font&&t(r.font),r.textColor&&t(r.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const r of this.sections){t.push(r.content.serialize());const l={};r.scale&&(l["font-scale"]=r.scale.serialize()),r.font&&(l["text-font"]=r.font.serialize()),r.textColor&&(l["text-color"]=r.textColor.serialize()),t.push(l)}return t}}class hr{constructor(t,r,l,u){this._imageWarnHistory={},this.type=hc,this.namePrimary=t,this.nameSecondary=r,l&&(this.paramsPrimary=l.params,this.iconsetIdPrimary=l.iconset?l.iconset.id:void 0),u&&(this.paramsSecondary=u.params,this.iconsetIdSecondary=u.iconset?u.iconset.id:void 0)}static parse(t,r){if(t.length<2)return r.error("Expected two or more arguments.");let l=1;const u=[];function m(){if(l<t.length){const b=r.parse(t[l],l++,Jr);return b?(u.push({image:b,options:{}}),!0):(r.error(u.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function _(){if(l<t.length){const E=t[l];if((b=E)===null||typeof b!="object"||Array.isArray(b))return!0;const P=E.params,R=E.iconset,F=r.concat(l);if(!P&&!R)return l++,!0;if(P){if(typeof P!="object"||P.constructor!==Object)return F.error('Image options "params" should be an object'),!1;const O={},$=F.concat(void 0,"params");for(const q in P){if(!q)return $.error("Image parameter name should be non-empty"),!1;const Y=$.concat(void 0,q).parse(P[q],void 0,il,void 0,{typeAnnotation:"coerce"});if(!Y)return!1;O[q]=Y}u[u.length-1].options.params=O}if(R){if(typeof R!="object"||R.constructor!==Object)return F.error('Image options "iconset" should be an object'),!1;if(!R.id)return F.error('Image options "iconset" should have an "id" property'),!1;u[u.length-1].options.iconset=R}return l++,!0}var b;return!0}for(let b=0;b<2;b++)if(!m()||!_())return;return new hr(u[0].image,u[1]?u[1].image:void 0,u[0].options,u[1]?u[1].options:void 0)}evaluateParams(t,r){const l={};if(r){for(const u in r)if(r[u])try{l[u]=r[u].evaluate(t)}catch{continue}if(Object.keys(l).length!==0)return{params:l}}}evaluate(t){const r={name:this.namePrimary.evaluate(t),iconsetId:this.iconsetIdPrimary},l=this.nameSecondary?{name:this.nameSecondary.evaluate(t),iconsetId:this.iconsetIdSecondary}:void 0,u=Fa.build(r,l,this.paramsPrimary?this.evaluateParams(t,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(t,this.paramsSecondary):void 0);if(u&&t.availableImages){const m=u.getPrimary().id;if(u.available=t.availableImages.some(_=>es.isEqual(_,m)),u.available){const _=u.getSecondary()?u.getSecondary().id:null;_&&(u.available=t.availableImages.some(b=>es.isEqual(b,_)))}}return u}eachChild(t){if(t(this.namePrimary),this.paramsPrimary)for(const r in this.paramsPrimary)this.paramsPrimary[r]&&t(this.paramsPrimary[r]);if(this.nameSecondary&&(t(this.nameSecondary),this.paramsSecondary))for(const r in this.paramsSecondary)this.paramsSecondary[r]&&t(this.paramsSecondary[r])}outputDefined(){return!1}serializeOptions(t,r){const l={};if(r&&(l.iconset={id:r}),t){l.params={};for(const u in t)t[u]&&(l.params[u]=t[u].serialize())}return Object.keys(l).length>0?l:void 0}serialize(){const t=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const r=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);r&&t.push(r)}if(this.nameSecondary&&(t.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const r=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);r&&t.push(r)}return t}}function cu(n){return rr(n)?"string":ih(n)?"number":fp(n)?"boolean":Array.isArray(n)?"array":n===null?"null":Mh(n)?"object":typeof n}function Mh(n){return n!=null&&!Array.isArray(n)&&typeof n!="function"&&!(n instanceof String||n instanceof Number||n instanceof Boolean)&&typeof n=="object"}function rr(n){return typeof n=="string"||n instanceof String}function ih(n){return typeof n=="number"||n instanceof Number}function fp(n){return typeof n=="boolean"||n instanceof Boolean}const Uf={"to-boolean":mn,"to-color":il,"to-number":Vi,"to-string":Jr};class dc{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const l=t[0],u=[];let m=ka;if(l==="to-array"){if(!Array.isArray(t[1]))return null;const _=t[1].length;if(r.expectedType){if(r.expectedType.kind!=="array")return r.error(`Expected ${r.expectedType.kind} but found array.`);m=ws(r.expectedType.itemType,_)}else{if(!(_>0&&$u(t[1][0])))return null;m=ws(gs(t[1][0]),_)}for(let b=0;b<_;b++){const E=t[1][b];let P;if(Array.isArray(E))P=r.parse(E,void 0,m.itemType);else{const R=cu(E);if(R!==m.itemType.kind)return r.error(`Expected ${m.itemType.kind} but found ${R}.`);P=r.registry.literal.parse(["literal",E===void 0?null:E],r)}if(!P)return null;u.push(P)}}else{if((l==="to-boolean"||l==="to-string")&&t.length!==2)return r.error("Expected one argument.");m=Uf[l];for(let _=1;_<t.length;_++){const b=r.parse(t[_],_,dn);if(!b)return null;u.push(b)}}return new dc(m,u)}evaluate(t){if(this.type.kind==="boolean")return!!this.args[0].evaluate(t);if(this.type.kind==="color"){let r,l;for(const u of this.args){if(r=u.evaluate(t),l=null,r instanceof Br)return r;if(typeof r=="string"){const m=t.parseColor(r);if(m)return m}else if(Array.isArray(r)&&(l=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:Ad(r[0],r[1],r[2],r[3]),!l))return new Br(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new Fo(l||`Could not parse color from value '${typeof r=="string"?r:String(JSON.stringify(r))}'`)}if(this.type.kind==="number"){let r=null;for(const l of this.args){if(r=l.evaluate(t),r===null)return 0;const u=Number(r);if(!isNaN(u))return u}throw new Fo(`Could not convert ${JSON.stringify(r)} to number.`)}return this.type.kind==="formatted"?Ts.fromString(Yl(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?Fa.build(Yl(this.args[0].evaluate(t))):this.type.kind==="array"?this.args.map(r=>r.evaluate(t)):Yl(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Fl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new hr(this.args[0]).serialize();const t=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(r=>{t.push(r.serialize())}),t}}const hu=["Unknown","Point","LineString","Polygon"];class Ss{constructor(t,r,l){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=t,this.options=r,this.iconImageUseTheme=l}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?hu[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(t){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,r=this.featureDistanceData.scale,{x:l,y:u}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(l*r-t[0])+this.featureDistanceData.bearing[1]*(u*r-t[1])}return 0}parseColor(t){let r=this._parseColorCache[t];return r||(r=this._parseColorCache[t]=Br.parse(t)),r}getConfig(t){return this.options?this.options.get(t):null}}class Ks{constructor(t,r,l,u,m){this.name=t,this.type=r,this._evaluate=l,this.args=u,this._overloadIndex=m}evaluate(t){if(!this._evaluate){const r=Ks.definitions[this.name];this._evaluate=Array.isArray(r)?r[2]:r.overloads[this._overloadIndex][1]}return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,r){const l=t[0],u=Ks.definitions[l];if(!u)return r.error(`Unknown expression "${l}". If you wanted a literal array, use ["literal", [...]].`,0);const m=Array.isArray(u)?u[0]:u.type,_=Array.isArray(u)?[[u[1],u[2]]]:u.overloads,b=[];let E=null,P=-1;for(const[R,F]of _){if(Array.isArray(R)&&R.length!==t.length-1)continue;b.push(R),P++,E=new jh(r.registry,r.path,null,r.scope,void 0,r._scope,r.options,r.iconImageUseTheme);const O=[];let $=!1;for(let q=1;q<t.length;q++){const Y=t[q],it=Array.isArray(R)?R[q-1]:R.type,at=E.parse(Y,1+O.length,it);if(!at){$=!0;break}O.push(at)}if(!$)if(Array.isArray(R)&&R.length!==O.length)E.error(`Expected ${R.length} arguments, but found ${O.length} instead.`);else{for(let q=0;q<O.length;q++){const Y=Array.isArray(R)?R[q]:R.type,it=O[q];E.concat(q+1).checkSubtype(Y,it.type)}if(E.errors.length===0)return new Ks(l,m,F,O,P)}}if(b.length===1)r.errors.push(...E.errors);else{const R=(b.length?b:_.map(([O])=>O)).map(Ch).join(" | "),F=[];for(let O=1;O<t.length;O++){const $=r.parse(t[O],1+F.length);if(!$)return null;F.push(Ho($.type))}r.error(`Expected arguments of type ${R}, but found (${F.join(", ")}) instead.`)}return null}static register(t,r){Ks.definitions=r;for(const l in r)t[l]=Ks}}function Ch(n){return Array.isArray(n)?`(${n.map(Ho).join(", ")})`:`(${Ho(n.type)}...)`}class Rc{constructor(t,r,l){this.type=ca,this.locale=l,this.caseSensitive=t,this.diacriticSensitive=r}static parse(t,r){if(t.length!==2)return r.error("Expected one argument.");const l=t[1];if(typeof l!="object"||Array.isArray(l))return r.error("Collator options argument must be an object.");const u=l["case-sensitive"]===void 0?r.parse(!1,1,mn):r.parseObjectValue(l["case-sensitive"],1,"case-sensitive",mn);if(!u)return null;const m=l["diacritic-sensitive"]===void 0?r.parse(!1,1,mn):r.parseObjectValue(l["diacritic-sensitive"],1,"diacritic-sensitive",mn);if(!m)return null;let _=null;return l.locale&&(_=r.parseObjectValue(l.locale,1,"locale",Jr),!_)?null:new Rc(u,m,_)}evaluate(t){return new hf(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}function ha(n,t,r=0,l=n.length-1,u=uf){for(;l>r;){if(l-r>600){const E=l-r+1,P=t-r+1,R=Math.log(E),F=.5*Math.exp(2*R/3),O=.5*Math.sqrt(R*F*(E-F)/E)*(P-E/2<0?-1:1);ha(n,t,Math.max(r,Math.floor(t-P*F/E+O)),Math.min(l,Math.floor(t+(E-P)*F/E+O)),u)}const m=n[t];let _=r,b=l;for(Is(n,r,t),u(n[l],m)>0&&Is(n,r,l);_<b;){for(Is(n,_,b),_++,b--;u(n[_],m)<0;)_++;for(;u(n[b],m)>0;)b--}u(n[r],m)===0?Is(n,r,b):(b++,Is(n,b,l)),b<=t&&(r=b+1),t<=b&&(l=b-1)}}function Is(n,t,r){const l=n[t];n[t]=n[r],n[r]=l}function uf(n,t){return n<t?-1:n>t?1:0}function df(n){let t=0;for(let r,l,u=0,m=n.length,_=m-1;u<m;_=u++)r=n[u],l=n[_],t+=(l.x-r.x)*(r.y+l.y);return t}function uu(n,t){n[0]=Math.min(n[0],t[0]),n[1]=Math.min(n[1],t[1]),n[2]=Math.max(n[2],t[0]),n[3]=Math.max(n[3],t[1])}function kc(n,t){return!(n[0]<=t[0]||n[2]>=t[2]||n[1]<=t[1]||n[3]>=t[3])}function Dh(n,t,r){const l=n[0]-t[0],u=n[1]-t[1],m=n[0]-r[0],_=n[1]-r[1];return l*_-m*u==0&&l*m<=0&&u*_<=0}function _l(n,t,r=!1){let l=!1;for(let b=0,E=t.length;b<E;b++){const P=t[b];for(let R=0,F=P.length,O=F-1;R<F;O=R++){const $=P[O],q=P[R];if(Dh(n,$,q))return r;(m=$)[1]>(u=n)[1]!=(_=q)[1]>u[1]&&u[0]<(_[0]-m[0])*(u[1]-m[1])/(_[1]-m[1])+m[0]&&(l=!l)}}var u,m,_;return l}function jf(n,t,r,l){const u=l[0]-r[0],m=l[1]-r[1],_=(n[0]-r[0])*m-u*(n[1]-r[1]),b=(t[0]-r[0])*m-u*(t[1]-r[1]);return _>0&&b<0||_<0&&b>0}function uo(n,t,r,l){return(u=[l[0]-r[0],l[1]-r[1]])[0]*(m=[t[0]-n[0],t[1]-n[1]])[1]-u[1]*m[0]!=0&&!(!jf(n,t,r,l)||!jf(r,l,n,t));var u,m}function Pd(n){const t=new Ae(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=new Ae(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const l of n[0])t.x>l.x&&(t.x=l.x),t.y>l.y&&(t.y=l.y),r.x<l.x&&(r.x=l.x),r.y<l.y&&(r.y=l.y);return{min:t,max:r}}const zh=8192;function Gf(n,t){const r=(180+n[0])/360,l=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,u=Math.pow(2,t.z);return[Math.round(r*u*zh),Math.round(l*u*zh)]}function $f(n,t){for(let r=0;r<t.length;r++)if(_l(n,t[r]))return!0;return!1}function qf(n,t,r){for(const l of r)for(let u=0,m=l.length,_=m-1;u<m;_=u++)if(uo(n,t,l[_],l[u]))return!0;return!1}function pc(n,t){for(let r=0;r<n.length;++r)if(!_l(n[r],t))return!1;for(let r=0;r<n.length-1;++r)if(qf(n[r],n[r+1],t))return!1;return!0}function mp(n,t){for(let r=0;r<t.length;r++)if(pc(n,t[r]))return!0;return!1}function qu(n,t,r){const l=[];for(let u=0;u<n.length;u++){const m=[];for(let _=0;_<n[u].length;_++){const b=Gf(n[u][_],r);uu(t,b),m.push(b)}l.push(m)}return l}function Zu(n,t,r){const l=[];for(let u=0;u<n.length;u++){const m=qu(n[u],t,r);l.push(m)}return l}function rh(n,t,r,l){if(n[0]<r[0]||n[0]>r[2]){const u=.5*l;let m=n[0]-r[0]>u?-l:r[0]-n[0]>u?l:0;m===0&&(m=n[0]-r[2]>u?-l:r[2]-n[0]>u?l:0),n[0]+=m}uu(t,n)}function du(n,t,r,l){const u=Math.pow(2,l.z)*zh,m=[l.x*zh,l.y*zh],_=[];if(!n)return _;for(const b of n)for(const E of b){const P=[E.x+m[0],E.y+m[1]];rh(P,t,r,u),_.push(P)}return _}function Ia(n,t,r,l){const u=Math.pow(2,l.z)*zh,m=[l.x*zh,l.y*zh],_=[];if(!n)return _;for(const E of n){const P=[];for(const R of E){const F=[R.x+m[0],R.y+m[1]];uu(t,F),P.push(F)}_.push(P)}if(t[2]-t[0]<=u/2){(b=t)[0]=b[1]=1/0,b[2]=b[3]=-1/0;for(const E of _)for(const P of E)rh(P,t,r,u)}var b;return _}class ua{constructor(t,r){this.type=mn,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if($u(t[1])){const l=t[1];if(l.type==="FeatureCollection")for(let u=0;u<l.features.length;++u){const m=l.features[u].geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new ua(l,l.features[u].geometry)}else if(l.type==="Feature"){const u=l.geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new ua(l,l.geometry)}else if(l.type==="Polygon"||l.type==="MultiPolygon")return new ua(l,l)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(r,l){const u=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=r.canonicalID();if(!_)return!1;if(l.type==="Polygon"){const b=qu(l.coordinates,m,_),E=du(r.geometry(),u,m,_);if(!kc(u,m))return!1;for(const P of E)if(!_l(P,b))return!1}if(l.type==="MultiPolygon"){const b=Zu(l.coordinates,m,_),E=du(r.geometry(),u,m,_);if(!kc(u,m))return!1;for(const P of E)if(!$f(P,b))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(r,l){const u=[1/0,1/0,-1/0,-1/0],m=[1/0,1/0,-1/0,-1/0],_=r.canonicalID();if(!_)return!1;if(l.type==="Polygon"){const b=qu(l.coordinates,m,_),E=Ia(r.geometry(),u,m,_);if(!kc(u,m))return!1;for(const P of E)if(!pc(P,b))return!1}if(l.type==="MultiPolygon"){const b=Zu(l.coordinates,m,_),E=Ia(r.geometry(),u,m,_);if(!kc(u,m))return!1;for(const P of E)if(!mp(P,b))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Hu={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},gp=1/298.257223563,Md=gp*(2-gp),Jl=Math.PI/180;class nh{static fromTile(t,r,l){const u=Math.PI*(1-2*(t+.5)/Math.pow(2,r)),m=Math.atan(.5*(Math.exp(u)-Math.exp(-u)))/Jl;return new nh(m,l)}static get units(){return Hu}constructor(t,r){if(t===void 0)throw new Error("No latitude given.");if(r&&!Hu[r])throw new Error(`Unknown unit ${r}. Use one of: ${Object.keys(Hu).join(", ")}`);const l=6378.137*Jl*(r?Hu[r]:1),u=Math.cos(t*Jl),m=1/(1-Md*(1-u*u)),_=Math.sqrt(m);this.kx=l*_*u,this.ky=l*_*m*(1-Md)}distance(t,r){const l=Ba(t[0]-r[0])*this.kx,u=(t[1]-r[1])*this.ky;return Math.sqrt(l*l+u*u)}bearing(t,r){const l=Ba(r[0]-t[0])*this.kx;return Math.atan2(l,(r[1]-t[1])*this.ky)/Jl}destination(t,r,l){const u=l*Jl;return this.offset(t,Math.sin(u)*r,Math.cos(u)*r)}offset(t,r,l){return[t[0]+r/this.kx,t[1]+l/this.ky]}lineDistance(t){let r=0;for(let l=0;l<t.length-1;l++)r+=this.distance(t[l],t[l+1]);return r}area(t){let r=0;for(let l=0;l<t.length;l++){const u=t[l];for(let m=0,_=u.length,b=_-1;m<_;b=m++)r+=Ba(u[m][0]-u[b][0])*(u[m][1]+u[b][1])*(l?-1:1)}return Math.abs(r)/2*this.kx*this.ky}along(t,r){let l=0;if(r<=0)return t[0];for(let u=0;u<t.length-1;u++){const m=t[u],_=t[u+1],b=this.distance(m,_);if(l+=b,l>r)return Lh(m,_,(r-(l-b))/b)}return t[t.length-1]}pointToSegmentDistance(t,r,l){let[u,m]=r,_=Ba(l[0]-u)*this.kx,b=(l[1]-m)*this.ky;if(_!==0||b!==0){const E=(Ba(t[0]-u)*this.kx*_+(t[1]-m)*this.ky*b)/(_*_+b*b);E>1?(u=l[0],m=l[1]):E>0&&(u+=_/this.kx*E,m+=b/this.ky*E)}return _=Ba(t[0]-u)*this.kx,b=(t[1]-m)*this.ky,Math.sqrt(_*_+b*b)}pointOnLine(t,r){let l=1/0,u=t[0][0],m=t[0][1],_=0,b=0;for(let E=0;E<t.length-1;E++){let P=t[E][0],R=t[E][1],F=Ba(t[E+1][0]-P)*this.kx,O=(t[E+1][1]-R)*this.ky,$=0;F===0&&O===0||($=(Ba(r[0]-P)*this.kx*F+(r[1]-R)*this.ky*O)/(F*F+O*O),$>1?(P=t[E+1][0],R=t[E+1][1]):$>0&&(P+=F/this.kx*$,R+=O/this.ky*$)),F=Ba(r[0]-P)*this.kx,O=(r[1]-R)*this.ky;const q=F*F+O*O;q<l&&(l=q,u=P,m=R,_=E,b=$)}return{point:[u,m],index:_,t:Math.max(0,Math.min(1,b))}}lineSlice(t,r,l){let u=this.pointOnLine(l,t),m=this.pointOnLine(l,r);if(u.index>m.index||u.index===m.index&&u.t>m.t){const P=u;u=m,m=P}const _=[u.point],b=u.index+1,E=m.index;!Wu(l[b],_[0])&&b<=E&&_.push(l[b]);for(let P=b+1;P<=E;P++)_.push(l[P]);return Wu(l[E],m.point)||_.push(m.point),_}lineSliceAlong(t,r,l){let u=0;const m=[];for(let _=0;_<l.length-1;_++){const b=l[_],E=l[_+1],P=this.distance(b,E);if(u+=P,u>t&&m.length===0&&m.push(Lh(b,E,(t-(u-P))/P)),u>=r)return m.push(Lh(b,E,(r-(u-P))/P)),m;u>t&&m.push(E)}return m}bufferPoint(t,r){const l=r/this.ky,u=r/this.kx;return[t[0]-u,t[1]-l,t[0]+u,t[1]+l]}bufferBBox(t,r){const l=r/this.ky,u=r/this.kx;return[t[0]-u,t[1]-l,t[2]+u,t[3]+l]}insideBBox(t,r){return Ba(t[0]-r[0])>=0&&Ba(t[0]-r[2])<=0&&t[1]>=r[1]&&t[1]<=r[3]}}function Wu(n,t){return n[0]===t[0]&&n[1]===t[1]}function Lh(n,t,r){const l=Ba(t[0]-n[0]);return[n[0]+l*r,n[1]+(t[1]-n[1])*r]}function Ba(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}class Cd{constructor(t=[],r=(l,u)=>l<u?-1:l>u?1:0){if(this.data=t,this.length=this.data.length,this.compare=r,this.length>0)for(let l=(this.length>>1)-1;l>=0;l--)this._down(l)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(this.length===0)return;const t=this.data[0],r=this.data.pop();return--this.length>0&&(this.data[0]=r,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:r,compare:l}=this,u=r[t];for(;t>0;){const m=t-1>>1,_=r[m];if(l(u,_)>=0)break;r[t]=_,t=m}r[t]=u}_down(t){const{data:r,compare:l}=this,u=this.length>>1,m=r[t];for(;t<u;){let _=1+(t<<1);const b=_+1;if(b<this.length&&l(r[b],r[_])<0&&(_=b),l(r[_],m)>=0)break;r[t]=r[_],t=_}r[t]=m}}var ri=8192;function Rh(n,t){return t.dist-n.dist}const pu=100,kh=50;function Pn(n){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==n[r])return!1;return!0}function Fh(n){return n[1]-n[0]+1}function Fc(n,t){const r=n[1]>=n[0]&&n[1]<t;return r||console.warn("Distance Expression: Index is out of range"),r}function Dd(n,t){if(n[0]>n[1])return[null,null];const r=Fh(n);if(t){if(r===2)return[n,null];const l=Math.floor(r/2);return[[n[0],n[0]+l],[n[0]+l,n[1]]]}{if(r===1)return[n,null];const l=Math.floor(r/2)-1;return[[n[0],n[0]+l],[n[0]+l+1,n[1]]]}}function Oa(n,t){const r=[1/0,1/0,-1/0,-1/0];if(!Fc(t,n.length))return r;for(let l=t[0];l<=t[1];++l)uu(r,n[l]);return r}function jr(n){const t=[1/0,1/0,-1/0,-1/0];for(let r=0;r<n.length;++r)for(let l=0;l<n[r].length;++l)uu(t,n[r][l]);return t}function Xu(n,t,r){if(Pn(n)||Pn(t))return NaN;let l=0,u=0;return n[2]<t[0]&&(l=t[0]-n[2]),n[0]>t[2]&&(l=n[0]-t[2]),n[1]>t[3]&&(u=n[1]-t[3]),n[3]<t[1]&&(u=t[1]-n[3]),r.distance([0,0],[l,u])}function Zf(n){return 360*n-180}function Cm(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function fu(n,t){const r=Math.pow(2,t.z),l=(n.y/ri+t.y)/r;return[Zf((n.x/ri+t.x)/r),Cm(l)]}function _p(n,t){const r=[];for(let l=0;l<n.length;++l)r.push(fu(n[l],t));return r}function lo(n,t,r){const l=r.pointOnLine(t,n).point;return r.distance(n,l)}function Bh(n,t,r,l,u){const m=r.slice(l[0],l[1]+1);let _=1/0;for(let b=t[0];b<=t[1];++b)if((_=Math.min(_,lo(n[b],m,u)))===0)return 0;return _}function Yu(n,t,r,l,u){const m=Math.min(u.pointToSegmentDistance(n,r,l),u.pointToSegmentDistance(t,r,l)),_=Math.min(u.pointToSegmentDistance(r,n,t),u.pointToSegmentDistance(l,n,t));return Math.min(m,_)}function Hf(n,t,r,l,u){if(!Fc(t,n.length)||!Fc(l,r.length))return NaN;let m=1/0;for(let _=t[0];_<t[1];++_)for(let b=l[0];b<l[1];++b){if(uo(n[_],n[_+1],r[b],r[b+1]))return 0;m=Math.min(m,Yu(n[_],n[_+1],r[b],r[b+1],u))}return m}function yp(n,t,r,l,u){if(!Fc(t,n.length)||!Fc(l,r.length))return NaN;let m=1/0;for(let _=t[0];_<=t[1];++_)for(let b=l[0];b<=l[1];++b)if((m=Math.min(m,u.distance(n[_],r[b])))===0)return m;return m}function xp(n,t,r){if(_l(n,t,!0))return 0;let l=1/0;for(const u of t){const m=u.length;if(m<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(u[0]!==u[m-1]&&(l=Math.min(l,r.pointToSegmentDistance(n,u[m-1],u[0])))===0||(l=Math.min(l,lo(n,u,r)))===0)return l}return l}function vp(n,t,r,l){if(!Fc(t,n.length))return NaN;for(let m=t[0];m<=t[1];++m)if(_l(n[m],r,!0))return 0;let u=1/0;for(let m=t[0];m<t[1];++m)for(const _ of r)for(let b=0,E=_.length,P=E-1;b<E;P=b++){if(uo(n[m],n[m+1],_[P],_[b]))return 0;u=Math.min(u,Yu(n[m],n[m+1],_[P],_[b],l))}return u}function mu(n,t){for(const r of n)for(let l=0;l<=r.length-1;++l)if(_l(r[l],t,!0))return!0;return!1}function bp(n,t,r,l=1/0){const u=jr(n),m=jr(t);if(l!==1/0&&Xu(u,m,r)>=l)return l;if(kc(u,m)){if(mu(n,t))return 0}else if(mu(t,n))return 0;let _=l;for(const b of n)for(let E=0,P=b.length,R=P-1;E<P;R=E++)for(const F of t)for(let O=0,$=F.length,q=$-1;O<$;q=O++){if(uo(b[R],b[E],F[q],F[O]))return 0;_=Math.min(_,Yu(b[R],b[E],F[q],F[O],r))}return _}function zd(n,t,r,l,u,m,_){if(m===null||_===null)return;const b=Xu(Oa(l,m),Oa(u,_),r);b<t&&n.push({dist:b,range1:m,range2:_})}function Ld(n,t,r,l,u=1/0){let m=Math.min(l.distance(n[0],r[0][0]),u);if(m===0)return m;const _=new Cd([{dist:0,range1:[0,n.length-1],range2:[0,0]}],Rh),b=t?kh:pu,E=jr(r);for(;_.length;){const P=_.pop();if(P.dist>=m)continue;const R=P.range1;if(Fh(R)<=b){if(!Fc(R,n.length))return NaN;if(t){const F=vp(n,R,r,l);if((m=Math.min(m,F))===0)return m}else for(let F=R[0];F<=R[1];++F){const O=xp(n[F],r,l);if((m=Math.min(m,O))===0)return m}}else{const F=Dd(R,t);if(F[0]!==null){const O=Xu(Oa(n,F[0]),E,l);O<m&&_.push({dist:O,range1:F[0],range2:[0,0]})}if(F[1]!==null){const O=Xu(Oa(n,F[1]),E,l);O<m&&_.push({dist:O,range1:F[1],range2:[0,0]})}}}return m}function Wf(n,t,r,l,u,m=1/0){let _=Math.min(m,u.distance(n[0],r[0]));if(_===0)return _;const b=new Cd([{dist:0,range1:[0,n.length-1],range2:[0,r.length-1]}],Rh),E=t?kh:pu,P=l?kh:pu;for(;b.length;){const R=b.pop();if(R.dist>=_)continue;const F=R.range1,O=R.range2;if(Fh(F)<=E&&Fh(O)<=P){if(!Fc(F,n.length)||!Fc(O,r.length))return NaN;if(t&&l?_=Math.min(_,Hf(n,F,r,O,u)):t||l?t&&!l?_=Math.min(_,Bh(r,O,n,F,u)):!t&&l&&(_=Math.min(_,Bh(n,F,r,O,u))):_=Math.min(_,yp(n,F,r,O,u)),_===0)return _}else{const $=Dd(F,t),q=Dd(O,l);zd(b,_,u,n,r,$[0],q[0]),zd(b,_,u,n,r,$[0],q[1]),zd(b,_,u,n,r,$[1],q[0]),zd(b,_,u,n,r,$[1],q[1])}}return _}function Rd(n,t,r,l,u=1/0){let m=u;const _=Oa(n,[0,n.length-1]);for(const b of r)if(!(m!==1/0&&Xu(_,Oa(b,[0,b.length-1]),l)>=m)&&(m=Math.min(m,Wf(n,t,b,!0,l,m)),m===0))return m;return m}function Oh(n,t,r,l,u=1/0){let m=u;const _=Oa(n,[0,n.length-1]);for(const b of r){if(m!==1/0&&Xu(_,jr(b),l)>=m)continue;const E=Ld(n,t,b,l,m);if(isNaN(E))return E;if((m=Math.min(m,E))===0)return m}return m}function Ju(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class Nh{constructor(t,r){this.type=Vi,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'distance' expression requires either one argument, but found ' ${t.length-1} instead.`);if($u(t[1])){const l=t[1];if(l.type==="FeatureCollection"){for(let u=0;u<l.features.length;++u)if(Ju(l.features[u].geometry.type))return new Nh(l,l.features[u].geometry)}else if(l.type==="Feature"){if(Ju(l.geometry.type))return new Nh(l,l.geometry)}else if(Ju(l.type))return new Nh(l,l)}return r.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(t){const r=t.geometry(),l=t.canonicalID();if(r!=null&&l!=null){if(t.geometryType()==="Point")return function(u,m,_){const b=[];for(const P of u)for(const R of P)b.push(fu(R,m));const E=new nh(b[0][1],"meters");return _.type==="Point"||_.type==="MultiPoint"||_.type==="LineString"?Wf(b,!1,_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",E):_.type==="MultiLineString"?Rd(b,!1,_.coordinates,E):_.type==="Polygon"||_.type==="MultiPolygon"?Oh(b,!1,_.type==="Polygon"?[_.coordinates]:_.coordinates,E):null}(r,l,this.geometries);if(t.geometryType()==="LineString")return function(u,m,_){const b=[];for(const P of u){const R=[];for(const F of P)R.push(fu(F,m));b.push(R)}const E=new nh(b[0][0][1],"meters");if(_.type==="Point"||_.type==="MultiPoint"||_.type==="LineString")return Rd(_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",b,E);if(_.type==="MultiLineString"){let P=1/0;for(let R=0;R<_.coordinates.length;R++){const F=Rd(_.coordinates[R],!0,b,E,P);if(isNaN(F))return F;if((P=Math.min(P,F))===0)return P}return P}if(_.type==="Polygon"||_.type==="MultiPolygon"){let P=1/0;for(let R=0;R<b.length;R++){const F=Oh(b[R],!0,_.type==="Polygon"?[_.coordinates]:_.coordinates,E,P);if(isNaN(F))return F;if((P=Math.min(P,F))===0)return P}return P}return null}(r,l,this.geometries);if(t.geometryType()==="Polygon")return function(u,m,_){const b=[];for(const P of function(R,F){const O=R.length;if(O<=1)return[R];const $=[];let q,Y;for(let it=0;it<O;it++){const at=df(R[it]);at!==0&&(R[it].area=Math.abs(at),Y===void 0&&(Y=at<0),Y===at<0?(q&&$.push(q),q=[R[it]]):q.push(R[it]))}return q&&$.push(q),$}(u)){const R=[];for(let F=0;F<P.length;++F)R.push(_p(P[F],m));b.push(R)}const E=new nh(b[0][0][0][1],"meters");if(_.type==="Point"||_.type==="MultiPoint"||_.type==="LineString")return Oh(_.type==="Point"?[_.coordinates]:_.coordinates,_.type==="LineString",b,E);if(_.type==="MultiLineString"){let P=1/0;for(let R=0;R<_.coordinates.length;R++){const F=Oh(_.coordinates[R],!0,b,E,P);if(isNaN(F))return F;if((P=Math.min(P,F))===0)return P}return P}return _.type==="Polygon"||_.type==="MultiPolygon"?function(P,R,F){let O=1/0;for(const $ of P)for(const q of R){const Y=bp($,q,F,O);if(isNaN(Y))return Y;if((O=Math.min(O,Y))===0)return O}return O}(_.type==="Polygon"?[_.coordinates]:_.coordinates,b,E):null}(r,l,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function gu(n){if(n instanceof Ks&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof ua||n instanceof Nh)return!1;if(n instanceof yl)return n.featureConstant;let t=!0;return n.eachChild(r=>{t&&!gu(r)&&(t=!1)}),t}function Vh(n){if(n instanceof Ks&&n.name==="feature-state")return!1;let t=!0;return n.eachChild(r=>{t&&!Vh(r)&&(t=!1)}),t}function Uh(n,t){if(n instanceof Ks&&t.indexOf(n.name)>=0)return!1;let r=!0;return n.eachChild(l=>{r&&!Uh(l,t)&&(r=!1)}),r}function pf(n,t,r){return[n,t,r].filter(Boolean).join("")}function kd(n,t){switch(n){case"string":return Yl(t);case"number":return+t;case"boolean":return!!t;case"color":return Br.parse(t);case"formatted":return Ts.fromString(Yl(t));case"resolvedImage":return Fa.build(Yl(t))}return t}function rs(n,t,r,l){return l!==void 0&&(n=l*Math.round(n/l)),t!==void 0&&n<t&&(n=t),r!==void 0&&n>r&&(n=r),n}class yl{constructor(t,r,l,u=!1){this.type=t,this.key=r,this.scope=l,this.featureConstant=u}static parse(t,r){let l=r.expectedType;if(l==null&&(l=dn),t.length<2||t.length>3)return r.error("Invalid number of arguments for 'config' expression.");const u=r.parse(t[1],1);if(!(u instanceof Lc))return r.error("Key name of 'config' expression must be a string literal.");let m,_=!0;const b=Yl(u.value);if(t.length>=3){const E=r.parse(t[2],2);if(!(E instanceof Lc))return r.error("Scope of 'config' expression must be a string literal.");m=Yl(E.value)}if(r.options){const E=pf(b,m,r._scope),P=r.options.get(E);P&&(_=gu(P.value||P.default))}return new yl(l,b,m,_)}evaluate(t){const r=pf(this.key,this.scope,t.scope),l=t.getConfig(r);if(!l)return null;const{type:u,value:m,values:_,minValue:b,maxValue:E,stepValue:P}=l,R=l.default.evaluate(t);let F=R;if(m){const O=t.scope;t.scope=(O||"").split("").slice(1).join(""),F=m.evaluate(t),t.scope=O}return u&&(F=kd(u,F)),F===void 0||b===void 0&&E===void 0&&P===void 0||(typeof F=="number"?F=rs(F,b,E,P):Array.isArray(F)&&(F=F.map(O=>typeof O=="number"?rs(O,b,E,P):O))),m!==void 0&&F!==void 0&&_&&!_.includes(F)&&(F=R,u&&(F=kd(u,F))),(u&&u!==this.type||F!==void 0&&!uc(gs(F),this.type))&&(F=kd(this.type.kind,F)),F}eachChild(){}outputDefined(){return!1}serialize(){const t=["config",this.key];return this.scope&&t.concat(this.scope),t}}class Ea{constructor(t,r){this.type=r.type,this.name=t,this.boundExpression=r}static parse(t,r){if(t.length!==2||typeof t[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const l=t[1];return r.scope.has(l)?new Ea(l,r.scope.get(l)):r.error(`Unknown variable "${l}". Make sure "${l}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class jh{constructor(t,r=[],l,u=new kl,m=[],_,b,E){this.registry=t,this.path=r,this.key=r.map(P=>typeof P=="string"?`['${P}']`:`[${P}]`).join(""),this.scope=u,this.errors=m,this.expectedType=l,this._scope=_,this.options=b,this.iconImageUseTheme=E}parse(t,r,l,u,m={}){return r||l?this.concat(r,null,l,u)._parse(t,m):this._parse(t,m)}parseObjectValue(t,r,l,u,m,_={}){return this.concat(r,l,u,m)._parse(t,_)}_parse(t,r){function l(u,m,_){return _==="assert"?new ki(m,[u]):_==="coerce"?new dc(m,[u]):u}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const u=typeof t[0]=="string"?this.registry[t[0]]:void 0;if(u){let m=u.parse(t,this);if(!m)return null;if(this.expectedType){const _=this.expectedType,b=m.type;if(_.kind!=="string"&&_.kind!=="number"&&_.kind!=="boolean"&&_.kind!=="object"&&_.kind!=="array"||b.kind!=="value")if(_.kind!=="color"&&_.kind!=="formatted"&&_.kind!=="resolvedImage"||b.kind!=="value"&&b.kind!=="string"){if(this.checkSubtype(_,b))return null}else m=l(m,_,r.typeAnnotation||"coerce");else m=l(m,_,r.typeAnnotation||"assert")}if(!(m instanceof Lc)&&m.type.kind!=="resolvedImage"&&oh(m)){const _=new Ss(this._scope,this.options,this.iconImageUseTheme);try{m=new Lc(m.type,m.evaluate(_))}catch(b){return this.error(b.message),null}}return m}return dc.parse(["to-array",t],this)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,r,l,u){let m=typeof t=="number"?this.path.concat(t):this.path;m=typeof r=="string"?m.concat(r):m;const _=u?this.scope.concat(u):this.scope;return new jh(this.registry,m,l||null,_,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(t,...r){const l=`${this.key}${r.map(u=>`[${u}]`).join("")}`;this.errors.push(new ml(l,t))}checkSubtype(t,r){const l=Id(t,r);return l&&this.error(l),l}}function oh(n){if(n instanceof Ea)return oh(n.boundExpression);if(n instanceof Ks&&n.name==="error"||n instanceof Rc||n instanceof ua||n instanceof Nh||n instanceof yl)return!1;const t=n instanceof dc||n instanceof ki;let r=!0;return n.eachChild(l=>{r=t?r&&oh(l):r&&l instanceof Lc}),!!r&&gu(n)&&Uh(n,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Fd(n,t){const r=n.length-1;let l,u,m=0,_=r,b=0;for(;m<=_;)if(b=Math.floor((m+_)/2),l=n[b],u=n[b+1],l<=t){if(b===r||t<u)return b;m=b+1}else{if(!(l>t))throw new Fo("Input is not a number.");_=b-1}return 0}class Bc{constructor(t,r,l){this.type=t,this.input=r,this.labels=[],this.outputs=[];for(const[u,m]of l)this.labels.push(u),this.outputs.push(m)}static parse(t,r){if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");const l=r.parse(t[1],1,Vi);if(!l)return null;const u=[];let m=null;r.expectedType&&r.expectedType.kind!=="value"&&(m=r.expectedType);for(let _=1;_<t.length;_+=2){const b=_===1?-1/0:t[_],E=t[_+1],P=_,R=_+1;if(typeof b!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',P);if(u.length&&u[u.length-1][0]>=b)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',P);const F=r.parse(E,R,m);if(!F)return null;m=m||F.type,u.push([b,F])}return new Bc(m,l,u)}evaluate(t){const r=this.labels,l=this.outputs;if(r.length===1)return l[0].evaluate(t);const u=this.input.evaluate(t);if(u<=r[0])return l[0].evaluate(t);const m=r.length;return u>=r[m-1]?l[m-1].evaluate(t):l[Fd(r,u)].evaluate(t)}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let r=0;r<this.labels.length;r++)r>0&&t.push(this.labels[r]),t.push(this.outputs[r].serialize());return t}}const wp=.95047,Ku=1.08883,Tp=4/29,_u=6/29,Qu=3*_u*_u,ff=_u*_u*_u,td=Math.PI/180,Xf=180/Math.PI;function Oc(n){return n>ff?Math.pow(n,1/3):n/Qu+Tp}function Bd(n){return n>_u?n*n*n:Qu*(n-Tp)}function Od(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function ed(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function sh(n){const t=ed(n.r),r=ed(n.g),l=ed(n.b),u=Oc((.4124564*t+.3575761*r+.1804375*l)/wp),m=Oc((.2126729*t+.7151522*r+.072175*l)/1);return{l:116*m-16,a:500*(u-m),b:200*(m-Oc((.0193339*t+.119192*r+.9503041*l)/Ku)),alpha:n.a}}function Gh(n){let t=(n.l+16)/116,r=isNaN(n.a)?t:t+n.a/500,l=isNaN(n.b)?t:t-n.b/200;return t=1*Bd(t),r=wp*Bd(r),l=Ku*Bd(l),new Br(Od(3.2404542*r-1.5371385*t-.4985314*l),Od(-.969266*r+1.8760108*t+.041556*l),Od(.0556434*r-.2040259*t+1.0572252*l),n.alpha)}function mf(n,t,r){const l=t-n;return n+r*(l>180||l<-180?l-360*Math.round(l/360):l)}const id={forward:sh,reverse:Gh,interpolate:function(n,t,r){return{l:Gi(n.l,t.l,r),a:Gi(n.a,t.a,r),b:Gi(n.b,t.b,r),alpha:Gi(n.alpha,t.alpha,r)}}},$h={forward:function(n){const{l:t,a:r,b:l}=sh(n),u=Math.atan2(l,r)*Xf;return{h:u<0?u+360:u,c:Math.sqrt(r*r+l*l),l:t,alpha:n.a}},reverse:function(n){const t=n.h*td,r=n.c;return Gh({l:n.l,a:Math.cos(t)*r,b:Math.sin(t)*r,alpha:n.alpha})},interpolate:function(n,t,r){return{h:mf(n.h,t.h,r),c:Gi(n.c,t.c,r),l:Gi(n.l,t.l,r),alpha:Gi(n.alpha,t.alpha,r)}}};var yu=Object.freeze({__proto__:null,hcl:$h,lab:id});class xl{constructor(t,r,l,u,m){this.type=t,this.operator=r,this.interpolation=l,this.input=u,this.labels=[],this.outputs=[];for(const[_,b]of m)this.labels.push(_),this.outputs.push(b)}static interpolationFactor(t,r,l,u){let m=0;if(t.name==="exponential")m=vl(r,t.base,l,u);else if(t.name==="linear")m=vl(r,1,l,u);else if(t.name==="cubic-bezier"){const _=t.controlPoints;m=new zr(_[0],_[1],_[2],_[3]).solve(vl(r,1,l,u))}return m}static parse(t,r){let[l,u,m,..._]=t;if(!Array.isArray(u)||u.length===0)return r.error("Expected an interpolation type expression.",1);if(u[0]==="linear")u={name:"linear"};else if(u[0]==="exponential"){const P=u[1];if(typeof P!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);u={name:"exponential",base:P}}else{if(u[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(u[0])}`,1,0);{const P=u.slice(1);if(P.length!==4||P.some(R=>typeof R!="number"||R<0||R>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);u={name:"cubic-bezier",controlPoints:P}}}if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length-1>3&&(t.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(m=r.parse(m,2,Vi),!m)return null;const b=[];let E=null;l==="interpolate-hcl"||l==="interpolate-lab"?E=il:r.expectedType&&r.expectedType.kind!=="value"&&(E=r.expectedType);for(let P=0;P<_.length;P+=2){const R=_[P],F=_[P+1],O=P+3,$=P+4;if(typeof R!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',O);if(b.length&&b[b.length-1][0]>=R)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',O);const q=r.parse(F,$,E);if(!q)return null;E=E||q.type,b.push([R,q])}return E.kind==="number"||E.kind==="color"||E.kind==="array"&&E.itemType.kind==="number"&&typeof E.N=="number"?new xl(E,l,u,m,b):r.error(`Type ${Ho(E)} is not interpolatable.`)}evaluate(t){const r=this.labels,l=this.outputs;if(r.length===1)return l[0].evaluate(t);const u=this.input.evaluate(t);if(u<=r[0])return l[0].evaluate(t);const m=r.length;if(u>=r[m-1])return l[m-1].evaluate(t);const _=Fd(r,u),b=xl.interpolationFactor(this.interpolation,u,r[_],r[_+1]),E=l[_].evaluate(t),P=l[_+1].evaluate(t);return this.operator==="interpolate"?fl[this.type.kind.toLowerCase()](E,P,b):this.operator==="interpolate-hcl"?$h.reverse($h.interpolate($h.forward(E),$h.forward(P),b)):id.reverse(id.interpolate(id.forward(E),id.forward(P),b))}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const r=[this.operator,t,this.input.serialize()];for(let l=0;l<this.labels.length;l++)r.push(this.labels[l],this.outputs[l].serialize());return r}}function vl(n,t,r,l){const u=l-r,m=n-r;return u===0?0:t===1?m/u:(Math.pow(t,m)-1)/(Math.pow(t,u)-1)}class Qs{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expectected at least one argument.");let l=null;const u=r.expectedType;u&&u.kind!=="value"&&(l=u);const m=[];for(const b of t.slice(1)){const E=r.parse(b,1+m.length,l,void 0,{typeAnnotation:"omit"});if(!E)return null;l=l||E.type,m.push(E)}const _=u&&m.some(b=>Id(u,b.type));return new Qs(_?dn:l,m)}evaluate(t){let r,l=null,u=0;for(const m of this.args){if(u++,l=m.evaluate(t),l&&l instanceof Fa&&!l.available&&(r||(r=l),l=null,u===this.args.length))return r;if(l!==null)break}return l}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(r=>{t.push(r.serialize())}),t}}class Nc{constructor(t,r){this.type=r.type,this.bindings=[].concat(t),this.result=r}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const r of this.bindings)t(r[1]);t(this.result)}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const l=[];for(let m=1;m<t.length-1;m+=2){const _=t[m];if(typeof _!="string")return r.error(`Expected string, but found ${typeof _} instead.`,m);if(/[^a-zA-Z0-9_]/.test(_))return r.error("Variable names must contain only alphanumeric characters or '_'.",m);const b=r.parse(t[m+1],m+1);if(!b)return null;l.push([_,b])}const u=r.parse(t[t.length-1],t.length-1,r.expectedType,l);return u?new Nc(l,u):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[r,l]of this.bindings)t.push(r,l.serialize());return t.push(this.result.serialize()),t}}class ns{constructor(t,r,l){this.type=t,this.index=r,this.input=l}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,Vi),u=r.parse(t[2],2,ws(r.expectedType||dn));return l&&u?new ns(u.type.itemType,l,u):null}evaluate(t){const r=this.index.evaluate(t),l=this.input.evaluate(t);if(r<0)throw new Fo("Array index out of bounds: negative index");if(r>=l.length)throw new Fo("Array index out of bounds: index exceeds array size");if(r!==Math.floor(r))throw new Fo("Array index must be an integer. Use at-interpolated for fractional indices");return l[r]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class xu{constructor(t,r,l){this.type=t,this.index=r,this.input=l}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,Vi),u=r.parse(t[2],2,ws(r.expectedType||dn));return l&&u?new xu(u.type.itemType,l,u):null}evaluate(t){const r=this.index.evaluate(t),l=this.input.evaluate(t);if(r<0)throw new Fo(`Array index out of bounds: ${r} < 0.`);if(r>l.length-1)throw new Fo(`Array index out of bounds: ${r} > ${l.length-1}.`);if(r===Math.floor(r))return l[r];const u=Math.floor(r),m=Math.ceil(r),_=l[u],b=l[m];if(typeof _!="number"||typeof b!="number")throw new Fo(`Cannot interpolate between non-number values at index ${r}.`);const E=r-u;return _*(1-E)+b*E}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class ah{constructor(t,r){this.type=mn,this.needle=t,this.haystack=r}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,dn),u=r.parse(t[2],2,dn);return l&&u?Ed(l.type,[mn,Jr,Vi,ka,dn])?new ah(l,u):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ho(l.type)} instead`):null}evaluate(t){const r=this.needle.evaluate(t),l=this.haystack.evaluate(t);if(l==null)return!1;if(!th(r,["boolean","string","number","null"]))throw new Fo(`Expected first argument to be of type boolean, string, number or null, but found ${Ho(gs(r))} instead.`);if(!th(l,["string","array"]))throw new Fo(`Expected second argument to be of type array or string, but found ${Ho(gs(l))} instead.`);return l.indexOf(r)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Nd{constructor(t,r,l){this.type=Vi,this.needle=t,this.haystack=r,this.fromIndex=l}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,dn),u=r.parse(t[2],2,dn);if(!l||!u)return null;if(!Ed(l.type,[mn,Jr,Vi,ka,dn]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ho(l.type)} instead`);if(t.length===4){const m=r.parse(t[3],3,Vi);return m?new Nd(l,u,m):null}return new Nd(l,u)}evaluate(t){const r=this.needle.evaluate(t),l=this.haystack.evaluate(t);if(!th(r,["boolean","string","number","null"]))throw new Fo(`Expected first argument to be of type boolean, string, number or null, but found ${Ho(gs(r))} instead.`);if(!th(l,["string","array"]))throw new Fo(`Expected second argument to be of type array or string, but found ${Ho(gs(l))} instead.`);if(this.fromIndex){const u=this.fromIndex.evaluate(t);return l.indexOf(r,u)}return l.indexOf(r)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Sp{constructor(t,r,l,u,m,_){this.inputType=t,this.type=r,this.input=l,this.cases=u,this.outputs=m,this.otherwise=_}static parse(t,r){if(t.length<5)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return r.error("Expected an even number of arguments.");let l,u;r.expectedType&&r.expectedType.kind!=="value"&&(u=r.expectedType);const m={},_=[];for(let P=2;P<t.length-1;P+=2){let R=t[P];const F=t[P+1];Array.isArray(R)||(R=[R]);const O=r.concat(P);if(R.length===0)return O.error("Expected at least one branch label.");for(const q of R){if(typeof q!="number"&&typeof q!="string")return O.error("Branch labels must be numbers or strings.");if(typeof q=="number"&&Math.abs(q)>Number.MAX_SAFE_INTEGER)return O.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof q=="number"&&Math.floor(q)!==q)return O.error("Numeric branch labels must be integer values.");if(l){if(O.checkSubtype(l,gs(q)))return null}else l=gs(q);if(m[String(q)]!==void 0)return O.error("Branch labels must be unique.");m[String(q)]=_.length}const $=r.parse(F,P,u);if(!$)return null;u=u||$.type,_.push($)}const b=r.parse(t[1],1,dn);if(!b)return null;const E=r.parse(t[t.length-1],t.length-1,u);return E?b.type.kind!=="value"&&r.concat(1).checkSubtype(l,b.type)?null:new Sp(l,u,b,m,_,E):null}evaluate(t){const r=this.input.evaluate(t);return(uc(gs(r),this.inputType)&&this.outputs[this.cases[r]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],r=Object.keys(this.cases).sort(),l=[],u={};for(const _ of r){const b=u[this.cases[_]];b===void 0?(u[this.cases[_]]=l.length,l.push([this.cases[_],[_]])):l[b][1].push(_)}const m=_=>this.inputType.kind==="number"?Number(_):_;for(const[_,b]of l)t.push(b.length===1?m(b[0]):b.map(m)),t.push(this.outputs[_].serialize());return t.push(this.otherwise.serialize()),t}}class Vc{constructor(t,r,l){this.type=t,this.branches=r,this.otherwise=l}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return r.error("Expected an odd number of arguments.");let l;r.expectedType&&r.expectedType.kind!=="value"&&(l=r.expectedType);const u=[];for(let _=1;_<t.length-1;_+=2){const b=r.parse(t[_],_,mn);if(!b)return null;const E=r.parse(t[_+1],_+1,l);if(!E)return null;u.push([b,E]),l=l||E.type}const m=r.parse(t[t.length-1],t.length-1,l);return m?new Vc(l,u,m):null}evaluate(t){for(const[r,l]of this.branches)if(r.evaluate(t))return l.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[r,l]of this.branches)t(r),t(l);t(this.otherwise)}outputDefined(){return this.branches.every(([t,r])=>r.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(r=>{t.push(r.serialize())}),t}}class Vd{constructor(t,r,l,u){this.type=t,this.input=r,this.beginIndex=l,this.endIndex=u}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,dn),u=r.parse(t[2],2,Vi);if(!l||!u)return null;if(!Ed(l.type,[ws(dn),Jr,dn]))return r.error(`Expected first argument to be of type array or string, but found ${Ho(l.type)} instead`);if(t.length===4){const m=r.parse(t[3],3,Vi);return m?new Vd(l.type,l,u,m):null}return new Vd(l.type,l,u)}evaluate(t){const r=this.input.evaluate(t),l=this.beginIndex.evaluate(t);if(!th(r,["string","array"]))throw new Fo(`Expected first argument to be of type array or string, but found ${Ho(gs(r))} instead.`);if(this.endIndex){const u=this.endIndex.evaluate(t);return r.slice(l,u)}return r.slice(l)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class vu{constructor(t,r){this.type=ws(Jr),this.str=t,this.delimiter=r}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const l=r.parse(t[1],1,Jr),u=r.parse(t[2],2,Jr);return l&&u?new vu(l,u):void 0}evaluate(t){const r=this.str.evaluate(t),l=this.delimiter.evaluate(t);return r.split(l)}eachChild(t){t(this.str),t(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function rd(n,t){return n==="=="||n==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function Kl(n,t,r,l){return l.compare(t,r)===0}function ir(n,t,r){const l=n!=="=="&&n!=="!=";return class Ab{constructor(m,_,b){this.type=mn,this.lhs=m,this.rhs=_,this.collator=b,this.hasUntypedArgument=m.type.kind==="value"||_.type.kind==="value"}static parse(m,_){if(m.length!==3&&m.length!==4)return _.error("Expected two or three arguments.");const b=m[0];let E=_.parse(m[1],1,dn);if(!E)return null;if(!rd(b,E.type))return _.concat(1).error(`"${b}" comparisons are not supported for type '${Ho(E.type)}'.`);let P=_.parse(m[2],2,dn);if(!P)return null;if(!rd(b,P.type))return _.concat(2).error(`"${b}" comparisons are not supported for type '${Ho(P.type)}'.`);if(E.type.kind!==P.type.kind&&E.type.kind!=="value"&&P.type.kind!=="value")return _.error(`Cannot compare types '${Ho(E.type)}' and '${Ho(P.type)}'.`);l&&(E.type.kind==="value"&&P.type.kind!=="value"?E=new ki(P.type,[E]):E.type.kind!=="value"&&P.type.kind==="value"&&(P=new ki(E.type,[P])));let R=null;if(m.length===4){if(E.type.kind!=="string"&&P.type.kind!=="string"&&E.type.kind!=="value"&&P.type.kind!=="value")return _.error("Cannot use collator to compare non-string types.");if(R=_.parse(m[3],3,ca),!R)return null}return new Ab(E,P,R)}evaluate(m){const _=this.lhs.evaluate(m),b=this.rhs.evaluate(m);if(l&&this.hasUntypedArgument){const E=gs(_),P=gs(b);if(E.kind!==P.kind||E.kind!=="string"&&E.kind!=="number")throw new Fo(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${E.kind}, ${P.kind}) instead.`)}if(this.collator&&!l&&this.hasUntypedArgument){const E=gs(_),P=gs(b);if(E.kind!=="string"||P.kind!=="string")return t(m,_,b)}return this.collator?r(m,_,b,this.collator.evaluate(m)):t(m,_,b)}eachChild(m){m(this.lhs),m(this.rhs),this.collator&&m(this.collator)}outputDefined(){return!0}serialize(){const m=[n];return this.eachChild(_=>{m.push(_.serialize())}),m}}}const bu=ir("==",function(n,t,r){return t===r},Kl),Ip=ir("!=",function(n,t,r){return t!==r},function(n,t,r,l){return!Kl(0,t,r,l)}),Yf=ir("<",function(n,t,r){return t<r},function(n,t,r,l){return l.compare(t,r)<0}),Ud=ir(">",function(n,t,r){return t>r},function(n,t,r,l){return l.compare(t,r)>0}),lh=ir("<=",function(n,t,r){return t<=r},function(n,t,r,l){return l.compare(t,r)<=0}),nd=ir(">=",function(n,t,r){return t>=r},function(n,t,r,l){return l.compare(t,r)>=0});class gf{constructor(t,r,l,u,m,_){this.type=Jr,this.number=t,this.locale=r,this.currency=l,this.unit=u,this.minFractionDigits=m,this.maxFractionDigits=_}static parse(t,r){if(t.length!==3)return r.error("Expected two arguments.");const l=r.parse(t[1],1,Vi);if(!l)return null;const u=t[2];if(typeof u!="object"||Array.isArray(u))return r.error("NumberFormat options argument must be an object.");let m=null;if(u.locale&&(m=r.parseObjectValue(u.locale,2,"locale",Jr),!m))return null;let _=null;if(u.currency&&(_=r.parseObjectValue(u.currency,2,"currency",Jr),!_))return null;let b=null;if(u.unit&&(b=r.parseObjectValue(u.unit,2,"unit",Jr),!b))return null;let E=null;if(u["min-fraction-digits"]&&(E=r.parseObjectValue(u["min-fraction-digits"],2,"min-fraction-digits",Vi),!E))return null;let P=null;return u["max-fraction-digits"]&&(P=r.parseObjectValue(u["max-fraction-digits"],2,"max-fraction-digits",Vi),!P)?null:new gf(l,m,_,b,E,P)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class qh{constructor(t){this.type=Vi,this.input=t}static parse(t,r){if(t.length!==2)return r.error(`Expected 1 argument, but found ${t.length-1} instead.`);const l=r.parse(t[1],1);return l?l.type.kind!=="array"&&l.type.kind!=="string"&&l.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${Ho(l.type)} instead.`):new qh(l):null}evaluate(t){const r=this.input.evaluate(t);if(typeof r=="string"||Array.isArray(r))return r.length;throw new Fo(`Expected value to be of type string or array, but found ${Ho(gs(r))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(r=>{t.push(r.serialize())}),t}}function _f(n){return function(){n=1831565813+(n|=0)|0;let t=Math.imul(n^n>>>15,1|n);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const Uc={"==":bu,"!=":Ip,">":Ud,"<":Yf,">=":nd,"<=":lh,array:ki,at:ns,"at-interpolated":xu,boolean:ki,case:Vc,coalesce:Qs,collator:Rc,format:Fl,image:hr,in:ah,"index-of":Nd,interpolate:xl,"interpolate-hcl":xl,"interpolate-lab":xl,length:qh,let:Nc,literal:Lc,match:Sp,number:ki,"number-format":gf,object:ki,slice:Vd,step:Bc,string:ki,"to-boolean":dc,"to-color":dc,"to-number":dc,"to-string":dc,var:Ea,within:ua,distance:Nh,config:yl,split:vu};function od(n,[t,r,l,u]){t=t.evaluate(n),r=r.evaluate(n),l=l.evaluate(n);const m=u?u.evaluate(n):1,_=Ad(t,r,l,m);if(_)throw new Fo(_);return new Br(t/255,r/255,l/255,m)}function Ep(n,[t,r,l,u]){t=t.evaluate(n),r=r.evaluate(n),l=l.evaluate(n);const m=u?u.evaluate(n):1,_=function(P,R,F,O){return typeof P=="number"&&P>=0&&P<=360?typeof R=="number"&&R>=0&&R<=100&&typeof F=="number"&&F>=0&&F<=100?O===void 0||typeof O=="number"&&O>=0&&O<=1?null:`Invalid hsla value [${[P,R,F,O].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof O=="number"?[P,R,F,O]:[P,R,F]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof O=="number"?[P,R,F,O]:[P,R,F]).join(", ")}]: 'h' must be between 0 and 360.`}(t,r,l,m);if(_)throw new Fo(_);const b=`hsla(${t}, ${r}%, ${l}%, ${m})`,E=Br.parse(b);if(!E)throw new Fo(`Failed to parse HSLA color: ${b}`);return E}function yf(n,t){return n in t}function jd(n,t){const r=t[n];return r===void 0?null:r}function fc(n){return{type:n}}function wu(n){if(n instanceof yl)return new Set([n.key]);let t=new Set;return n.eachChild(r=>{t=new Set([...t,...wu(r)])}),t}function sd(n){if(n instanceof Ks&&n.name==="is-active-floor")return!0;let t=!1;return n.eachChild(r=>{!t&&sd(r)&&(t=!0)}),t}function Tu(n){return{result:"success",value:n}}function ch(n){return{result:"error",value:n}}function jc(n,t){return!!n&&!!n.parameters&&n.parameters.indexOf(t)>-1}function wo(n){return n["property-type"]==="data-driven"}function xf(n){return jc(n.expression,"measure-light")}function Su(n){return jc(n.expression,"zoom")}function Zh(n){return!!n.expression&&n.expression.interpolated}function ad(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function Ap(n){return n}function ld(n,t){const r=t.type==="color",l=n.stops&&typeof n.stops[0][0]=="object",u=l||!(l||n.property!==void 0),m=n.type||(Zh(t)?"exponential":"interval");if(r&&((n=Object.assign({},n)).stops&&(n.stops=n.stops.map(P=>[P[0],Br.parse(P[1])])),n.default=Br.parse(n.default?n.default:t.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!yu[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let _,b,E;if(m==="exponential")_=Wh;else if(m==="interval")_=da;else if(m==="categorical"){_=Jf,b=Object.create(null);for(const P of n.stops)b[P[0]]=P[1];E=typeof n.stops[0][0]}else{if(m!=="identity")throw new Error(`Unknown function type "${m}"`);_=Ir}if(l){const P={},R=[];for(let $=0;$<n.stops.length;$++){const q=n.stops[$],Y=q[0].zoom;P[Y]===void 0&&(P[Y]={zoom:Y,type:n.type,property:n.property,default:n.default,stops:[]},R.push(Y)),P[Y].stops.push([q[0].value,q[1]])}const F=[];for(const $ of R)F.push([P[$].zoom,ld(P[$],t)]);const O={name:"linear"};return{kind:"composite",interpolationType:O,interpolationFactor:xl.interpolationFactor.bind(void 0,O),zoomStops:F.map($=>$[0]),evaluate:({zoom:$},q)=>Wh({stops:F,base:n.base},t,$).evaluate($,q)}}if(u){const P=m==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:P,interpolationFactor:xl.interpolationFactor.bind(void 0,P),zoomStops:n.stops.map(R=>R[0]),evaluate:({zoom:R})=>_(n,t,R,b,E)}}return{kind:"source",evaluate(P,R){const F=R&&R.properties?R.properties[n.property]:void 0;return F===void 0?Hh(n.default,t.default):_(n,t,F,b,E)}}}function Hh(n,t,r){return n!==void 0?n:t!==void 0?t:r!==void 0?r:void 0}function Jf(n,t,r,l,u){return Hh(typeof r===u?l[r]:void 0,n.default,t.default)}function da(n,t,r){if(!ih(r))return Hh(n.default,t.default);const l=n.stops.length;if(l===1||r<=n.stops[0][0])return n.stops[0][1];if(r>=n.stops[l-1][0])return n.stops[l-1][1];const u=Fd(n.stops.map(m=>m[0]),r);return n.stops[u][1]}function Wh(n,t,r){const l=n.base!==void 0?n.base:1;if(!ih(r))return Hh(n.default,t.default);const u=n.stops.length;if(u===1||r<=n.stops[0][0])return n.stops[0][1];if(r>=n.stops[u-1][0])return n.stops[u-1][1];const m=Fd(n.stops.map(R=>R[0]),r),_=function(R,F,O,$){const q=$-O,Y=R-O;return q===0?0:F===1?Y/q:(Math.pow(F,Y)-1)/(Math.pow(F,q)-1)}(r,l,n.stops[m][0],n.stops[m+1][0]),b=n.stops[m][1],E=n.stops[m+1][1];let P=fl[t.type]||Ap;if(n.colorSpace&&n.colorSpace!=="rgb"){const R=yu[n.colorSpace];P=(F,O)=>R.reverse(R.interpolate(R.forward(F),R.forward(O),_))}return typeof b.evaluate=="function"?{evaluate(...R){const F=b.evaluate.apply(void 0,R),O=E.evaluate.apply(void 0,R);if(F!==void 0&&O!==void 0)return P(F,O,_)}}:P(b,E,_)}function Ir(n,t,r){return t.type==="color"?r=Br.parse(r):t.type==="formatted"?r=Ts.fromString(r.toString()):t.type==="resolvedImage"?r=Fa.build(r.toString()):cu(r)===t.type||t.type==="enum"&&t.values[r]||(r=void 0),Hh(r,n.default,t.default)}Ks.register(Uc,{error:[{kind:"error"},[Jr],(n,[t])=>{throw new Fo(t.evaluate(n))}],typeof:[Jr,[dn],(n,[t])=>Ho(gs(t.evaluate(n)))],"to-rgba":[ws(Vi,4),[il],(n,[t])=>t.evaluate(n).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[ws(Vi,4),[il],(n,[t])=>t.evaluate(n).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[il,[Vi,Vi,Vi],od],rgba:[il,[Vi,Vi,Vi,Vi],od],hsl:[il,[Vi,Vi,Vi],Ep],hsla:[il,[Vi,Vi,Vi,Vi],Ep],has:{type:mn,overloads:[[[Jr],(n,[t])=>yf(t.evaluate(n),n.properties())],[[Jr,Qc],(n,[t,r])=>yf(t.evaluate(n),r.evaluate(n))]]},get:{type:dn,overloads:[[[Jr],(n,[t])=>jd(t.evaluate(n),n.properties())],[[Jr,Qc],(n,[t,r])=>jd(t.evaluate(n),r.evaluate(n))]]},"feature-state":[dn,[Jr],(n,[t])=>jd(t.evaluate(n),n.featureState||{})],properties:[Qc,[],n=>n.properties()],"geometry-type":[Jr,[],n=>n.geometryType()],worldview:[Jr,[],n=>n.globals.worldview||""],"is-active-floor":[mn,fc(Jr),(n,t)=>{if(!(n.globals.activeFloors&&n.globals.activeFloors.size>0))return!1;const r=n.globals.activeFloors;return t.some(l=>{const u=l.evaluate(n);return r.has(u)})}],id:[dn,[],n=>n.id()],zoom:[Vi,[],n=>n.globals.zoom],pitch:[Vi,[],n=>n.globals.pitch||0],"distance-from-center":[Vi,[],n=>n.distanceFromCenter()],"measure-light":[Vi,[Jr],(n,[t])=>n.measureLight(t.evaluate(n))],"heatmap-density":[Vi,[],n=>n.globals.heatmapDensity||0],"line-progress":[Vi,[],n=>n.globals.lineProgress||0],"raster-value":[Vi,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[Vi,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[Vi,[],n=>n.globals.skyRadialProgress||0],accumulated:[dn,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[Vi,fc(Vi),(n,t)=>{let r=0;for(const l of t)r+=l.evaluate(n);return r}],"*":[Vi,fc(Vi),(n,t)=>{let r=1;for(const l of t)r*=l.evaluate(n);return r}],"-":{type:Vi,overloads:[[[Vi,Vi],(n,[t,r])=>t.evaluate(n)-r.evaluate(n)],[[Vi],(n,[t])=>-t.evaluate(n)]]},"/":[Vi,[Vi,Vi],(n,[t,r])=>t.evaluate(n)/r.evaluate(n)],"%":[Vi,[Vi,Vi],(n,[t,r])=>t.evaluate(n)%r.evaluate(n)],ln2:[Vi,[],()=>Math.LN2],pi:[Vi,[],()=>Math.PI],e:[Vi,[],()=>Math.E],"^":[Vi,[Vi,Vi],(n,[t,r])=>Math.pow(t.evaluate(n),r.evaluate(n))],sqrt:[Vi,[Vi],(n,[t])=>Math.sqrt(t.evaluate(n))],log10:[Vi,[Vi],(n,[t])=>Math.log(t.evaluate(n))/Math.LN10],ln:[Vi,[Vi],(n,[t])=>Math.log(t.evaluate(n))],log2:[Vi,[Vi],(n,[t])=>Math.log2(t.evaluate(n))],sin:[Vi,[Vi],(n,[t])=>Math.sin(t.evaluate(n))],cos:[Vi,[Vi],(n,[t])=>Math.cos(t.evaluate(n))],tan:[Vi,[Vi],(n,[t])=>Math.tan(t.evaluate(n))],asin:[Vi,[Vi],(n,[t])=>Math.asin(t.evaluate(n))],acos:[Vi,[Vi],(n,[t])=>Math.acos(t.evaluate(n))],atan:[Vi,[Vi],(n,[t])=>Math.atan(t.evaluate(n))],min:[Vi,fc(Vi),(n,t)=>Math.min(...t.map(r=>r.evaluate(n)))],max:[Vi,fc(Vi),(n,t)=>Math.max(...t.map(r=>r.evaluate(n)))],abs:[Vi,[Vi],(n,[t])=>Math.abs(t.evaluate(n))],round:[Vi,[Vi],(n,[t])=>{const r=t.evaluate(n);return r<0?-Math.round(-r):Math.round(r)}],floor:[Vi,[Vi],(n,[t])=>Math.floor(t.evaluate(n))],ceil:[Vi,[Vi],(n,[t])=>Math.ceil(t.evaluate(n))],"filter-==":[mn,[Jr,dn],(n,[t,r])=>n.properties()[t.value]===r.value],"filter-id-==":[mn,[dn],(n,[t])=>n.id()===t.value],"filter-type-==":[mn,[Jr],(n,[t])=>n.geometryType()===t.value],"filter-<":[mn,[Jr,dn],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l<u}],"filter-id-<":[mn,[dn],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r<l}],"filter->":[mn,[Jr,dn],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l>u}],"filter-id->":[mn,[dn],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r>l}],"filter-<=":[mn,[Jr,dn],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l<=u}],"filter-id-<=":[mn,[dn],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r<=l}],"filter->=":[mn,[Jr,dn],(n,[t,r])=>{const l=n.properties()[t.value],u=r.value;return typeof l==typeof u&&l>=u}],"filter-id->=":[mn,[dn],(n,[t])=>{const r=n.id(),l=t.value;return typeof r==typeof l&&r>=l}],"filter-has":[mn,[dn],(n,[t])=>t.value in n.properties()],"filter-has-id":[mn,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[mn,[ws(Jr)],(n,[t])=>t.value.indexOf(n.geometryType())>=0],"filter-id-in":[mn,[ws(dn)],(n,[t])=>t.value.indexOf(n.id())>=0],"filter-in-small":[mn,[Jr,ws(dn)],(n,[t,r])=>r.value.indexOf(n.properties()[t.value])>=0],"filter-in-large":[mn,[Jr,ws(dn)],(n,[t,r])=>function(l,u,m,_){for(;m<=_;){const b=m+_>>1;if(u[b]===l)return!0;u[b]>l?_=b-1:m=b+1}return!1}(n.properties()[t.value],r.value,0,r.value.length-1)],all:{type:mn,overloads:[[[mn,mn],(n,[t,r])=>t.evaluate(n)&&r.evaluate(n)],[fc(mn),(n,t)=>{for(const r of t)if(!r.evaluate(n))return!1;return!0}]]},any:{type:mn,overloads:[[[mn,mn],(n,[t,r])=>t.evaluate(n)||r.evaluate(n)],[fc(mn),(n,t)=>{for(const r of t)if(r.evaluate(n))return!0;return!1}]]},"!":[mn,[mn],(n,[t])=>!t.evaluate(n)],"is-supported-script":[mn,[Jr],(n,[t])=>{const r=n.globals&&n.globals.isSupportedScript;return!r||r(t.evaluate(n))}],upcase:[Jr,[Jr],(n,[t])=>t.evaluate(n).toUpperCase()],downcase:[Jr,[Jr],(n,[t])=>t.evaluate(n).toLowerCase()],concat:[Jr,fc(dn),(n,t)=>t.map(r=>Yl(r.evaluate(n))).join("")],"resolved-locale":[Jr,[ca],(n,[t])=>t.evaluate(n).resolvedLocale()],random:[Vi,[Vi,Vi,dn],(n,t)=>{const[r,l,u]=t.map(_=>_.evaluate(n));if(r>l||r===l)return r;let m;if(typeof u=="string")m=function(_){let b=0;if(_.length===0)return b;for(let E=0;E<_.length;E++)b=(b<<5)-b+_.charCodeAt(E),b|=0;return b}(u);else{if(typeof u!="number")throw new Fo(`Invalid seed input: ${u}`);m=u}return r+_f(m)()*(l-r)}]});class Or{constructor(t,r,l,u,m){this.expression=t,this._warningHistory={},this._scope=l,this._options=u,this._iconImageUseTheme=m,this._evaluator=new Ss(l,u,m),this._defaultValue=r?function(_){return _.type==="color"&&(ad(_.default)||Array.isArray(_.default))?new Br(0,0,0,0):_.type==="color"?Br.parse(_.default)||null:_.default===void 0?null:_.default}(r):null,this._enumValues=r&&r.type==="enum"?r.values:null,this.configDependencies=wu(t),this.isIndoorDependent=sd(t)}evaluateWithoutErrorHandling(t,r,l,u,m,_,b,E){return this._evaluator.globals=t,this._evaluator.feature=r,this._evaluator.featureState=l,this._evaluator.canonical=u||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=E||null,this.expression.evaluate(this._evaluator)}evaluate(t,r,l,u,m,_,b,E,P){this._evaluator||(this._evaluator=new Ss(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=t,this._evaluator.feature=r||null,this._evaluator.featureState=l||null,this._evaluator.canonical=u||null,this._evaluator.availableImages=m||null,this._evaluator.formattedSection=_||null,this._evaluator.featureTileCoord=b||null,this._evaluator.featureDistanceData=E||null,this._evaluator.iconImageUseTheme=P||null;try{const R=this.expression.evaluate(this._evaluator);if(R==null||typeof R=="number"&&R!=R)return this._defaultValue;if(this._enumValues&&!(R in this._enumValues))throw new Fo(`Expected value to be one of ${Object.keys(this._enumValues).map(F=>JSON.stringify(F)).join(", ")}, but found ${JSON.stringify(R)} instead.`);return R}catch(R){return this._warningHistory[R.message]||(this._warningHistory[R.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${R.message}`)),this._defaultValue}}}function Xh(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in Uc}function mc(n,t,r,l,u){const m=new jh(Uc,[],t?function(b){const E={color:il,string:Jr,number:Vi,enum:Jr,boolean:mn,formatted:Dc,resolvedImage:hc};return b.type==="array"?ws(E[b.value]||dn,b.length):E[b.type]}(t):void 0,void 0,void 0,r,l,u),_=m.parse(n,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return _?Tu(new Or(_,t,r,l,u)):ch(m.errors)}class hh{constructor(t,r,l,u){this.kind=t,this._styleExpression=r,this.isLightConstant=l,this.isLineProgressConstant=u,this.isStateDependent=t!=="constant"&&!Vh(r.expression),this.configDependencies=wu(r.expression),this.isIndoorDependent=sd(r.expression)}evaluateWithoutErrorHandling(t,r,l,u,m,_){return this._styleExpression.evaluateWithoutErrorHandling(t,r,l,u,m,_)}evaluate(t,r,l,u,m,_,b){return this._styleExpression.evaluate(t,r,l,u,m,_,void 0,void 0,b)}}class _s{constructor(t,r,l,u,m,_){this.kind=t,this.zoomStops=l,this._styleExpression=r,this.isStateDependent=t!=="camera"&&!Vh(r.expression),this.isIndoorDependent=sd(r.expression),this.isLightConstant=m,this.isLineProgressConstant=_,this.configDependencies=wu(r.expression),this.interpolationType=u}evaluateWithoutErrorHandling(t,r,l,u,m,_){return this._styleExpression.evaluateWithoutErrorHandling(t,r,l,u,m,_)}evaluate(t,r,l,u,m,_){return this._styleExpression.evaluate(t,r,l,u,m,_)}interpolationFactor(t,r,l){return this.interpolationType?xl.interpolationFactor(this.interpolationType,t,r,l):0}}function bl(n,t,r,l,u){if((n=mc(n,t,r,l,u)).result==="error")return n;const m=n.value.expression,_=gu(m);if(!_&&!wo(t))return ch([new ml("","data expressions not supported")]);const b=Uh(m,["zoom","pitch","distance-from-center"]);if(!b&&!Su(t))return ch([new ml("","zoom expressions not supported")]);const E=Uh(m,["measure-light"]);if(!E&&!xf(t))return ch([new ml("","measure-light expression not supported")]);const P=Uh(m,["line-progress"]);if(!P&&!function(O){return jc(O.expression,"line-progress")}(t))return ch([new ml("","line-progress expression not supported")]);const R=t.expression&&t.expression.relaxZoomRestriction,F=Pp(m);return F||b||R?F instanceof ml?ch([F]):F instanceof xl&&!Zh(t)?ch([new ml("",'"interpolate" expressions cannot be used with this property')]):Tu(F?new _s(_&&P?"camera":"composite",n.value,F.labels,F instanceof xl?F.interpolation:void 0,E,P):new hh(_&&P?"constant":"source",n.value,E,P)):ch([new ml("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Gd{constructor(t,r){this._parameters=t,this._specification=r,Object.assign(this,ld(this._parameters,this._specification))}static deserialize(t){return new Gd(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Pp(n){let t=null;if(n instanceof Nc)t=Pp(n.result);else if(n instanceof Qs){for(const r of n.args)if(t=Pp(r),t)break}else(n instanceof Bc||n instanceof xl)&&n.input instanceof Ks&&n.input.name==="zoom"&&(t=n);return t instanceof ml||n.eachChild(r=>{const l=Pp(r);l instanceof ml?t=l:t&&l&&t!==l&&(t=new ml("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}var $d,Mp,cd=function(){if(Mp)return $d;Mp=1,$d=t;var n=3;function t(r,l,u){var m=this.cells=[];if(r instanceof ArrayBuffer){this.arrayBuffer=r;var _=new Int32Array(this.arrayBuffer);r=_[0],this.d=(l=_[1])+2*(u=_[2]);for(var b=0;b<this.d*this.d;b++){var E=_[n+b],P=_[n+b+1];m.push(E===P?null:_.subarray(E,P))}var R=_[n+m.length+1];this.keys=_.subarray(_[n+m.length],R),this.bboxes=_.subarray(R),this.insert=this._insertReadonly}else{this.d=l+2*u;for(var F=0;F<this.d*this.d;F++)m.push([]);this.keys=[],this.bboxes=[]}this.n=l,this.extent=r,this.padding=u,this.scale=l/r,this.uid=0;var O=u/l*r;this.min=-O,this.max=r+O}return t.prototype.insert=function(r,l,u,m,_){this._forEachCell(l,u,m,_,this._insertCell,this.uid++),this.keys.push(r),this.bboxes.push(l),this.bboxes.push(u),this.bboxes.push(m),this.bboxes.push(_)},t.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},t.prototype._insertCell=function(r,l,u,m,_,b){this.cells[_].push(b)},t.prototype.query=function(r,l,u,m,_){var b=this.min,E=this.max;if(r<=b&&l<=b&&E<=u&&E<=m&&!_)return Array.prototype.slice.call(this.keys);var P=[];return this._forEachCell(r,l,u,m,this._queryCell,P,{},_),P},t.prototype._queryCell=function(r,l,u,m,_,b,E,P){var R=this.cells[_];if(R!==null)for(var F=this.keys,O=this.bboxes,$=0;$<R.length;$++){var q=R[$];if(E[q]===void 0){var Y=4*q;(P?P(O[Y+0],O[Y+1],O[Y+2],O[Y+3]):r<=O[Y+2]&&l<=O[Y+3]&&u>=O[Y+0]&&m>=O[Y+1])?(E[q]=!0,b.push(F[q])):E[q]=!1}}},t.prototype._forEachCell=function(r,l,u,m,_,b,E,P){for(var R=this._convertToCellCoord(r),F=this._convertToCellCoord(l),O=this._convertToCellCoord(u),$=this._convertToCellCoord(m),q=R;q<=O;q++)for(var Y=F;Y<=$;Y++){var it=this.d*Y+q;if((!P||P(this._convertFromCellCoord(q),this._convertFromCellCoord(Y),this._convertFromCellCoord(q+1),this._convertFromCellCoord(Y+1)))&&_.call(this,r,l,u,m,it,b,E,P))return}},t.prototype._convertFromCellCoord=function(r){return(r-this.padding)/this.scale},t.prototype._convertToCellCoord=function(r){return Math.max(0,Math.min(this.d-1,Math.floor(r*this.scale)+this.padding))},t.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var r=this.cells,l=n+this.cells.length+1+1,u=0,m=0;m<this.cells.length;m++)u+=this.cells[m].length;var _=new Int32Array(l+u+this.keys.length+this.bboxes.length);_[0]=this.extent,_[1]=this.n,_[2]=this.padding;for(var b=l,E=0;E<r.length;E++){var P=r[E];_[n+E]=b,_.set(P,b),b+=P.length}return _[n+r.length]=b,_.set(this.keys,b),_[n+r.length+1]=b+=this.keys.length,_.set(this.bboxes,b),b+=this.bboxes.length,_.buffer},$d}(),po=ui(cd);const Ko={};function Ei(n,t,r={}){Object.defineProperty(n,"_classRegistryKey",{value:t,writable:!1}),Ko[t]={klass:n,omit:r.omit||[]}}Ei(Object,"Object"),po.serialize=function(n,t){const r=n.toArrayBuffer();return t&&t.add(r),{buffer:r}},po.deserialize=function(n){return new po(n.buffer)},Object.defineProperty(po,"name",{value:"Grid"}),Ei(po,"Grid"),delete Ae.prototype.constructor,typeof DOMMatrix<"u"&&Ei(DOMMatrix,"DOMMatrix"),Ei(Br,"Color"),Ei(Error,"Error"),Ei(Ts,"Formatted"),Ei(eh,"FormattedSection"),Ei(js,"AJAXError"),Ei(Fa,"ResolvedImage"),Ei(Gd,"StylePropertyFunction"),Ei(Or,"StyleExpression",{omit:["_evaluator"]}),Ei(es,"ImageId"),Ei(gl,"ImageVariant"),Ei(_s,"ZoomDependentExpression"),Ei(hh,"ZoomConstantExpression"),Ei(Ks,"CompoundExpression",{omit:["_evaluate"]});for(const n in Uc)Ko[Uc[n]._classRegistryKey]||Ei(Uc[n],`Expression${n}`);function Iu(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function Bl(n){return self.ImageBitmap&&n instanceof ImageBitmap}function Gc(n,t){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(Iu(n)||Bl(n))return t&&t.add(n),n;if(ArrayBuffer.isView(n))return t&&t.add(n.buffer),n;if(n instanceof ImageData)return t&&t.add(n.data.buffer),n;if(Array.isArray(n)){const r=[];for(const l of n)r.push(Gc(l,t));return r}if(n instanceof Map){const r={$name:"Map",entries:[]};for(const[l,u]of n.entries())r.entries.push(Gc(l),Gc(u,t));return r}if(n instanceof Set){const r={$name:"Set"};let l=0;for(const u of n.values())r[++l]=Gc(u);return r}if(n instanceof DOMMatrix){const r={$name:"DOMMatrix"},l=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const u of l)r[u]=n[u];return r}if(typeof n=="bigint")return{$name:"BigInt",value:n.toString()};if(typeof n=="object"){const r=n.constructor,l=r._classRegistryKey;if(!l)throw new Error(`Can't serialize object of unregistered class "${r.name}".`);const u=r.serialize?r.serialize(n,t):{};if(!r.serialize){for(const m in n)n.hasOwnProperty(m)&&(Ko[l].omit.indexOf(m)>=0||(u[m]=Gc(n[m],t)));n instanceof Error&&(u.message=n.message)}if(u.$name)throw new Error("$name property is reserved for worker serialization logic.");return l!=="Object"&&(u.$name=l),u}throw new Error("can't serialize object of type "+typeof n)}function $c(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||Iu(n)||Bl(n)||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map($c);if(typeof n=="object"){const t=n.$name||"Object";if(t==="Map"){const u=n.entries||[],m=new Map;for(let _=0;_<u.length;_+=2)m.set($c(u[_]),$c(u[_+1]));return m}if(t==="Set"){const u=new Set;for(const m of Object.keys(n))m!=="$name"&&u.add($c(n[m]));return u}if(t==="DOMMatrix"){let u;return u=n.is2D?[n.a,n.b,n.c,n.d,n.e,n.f]:[n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.m41,n.m42,n.m43,n.m44],new DOMMatrix(u)}if(t==="BigInt")return BigInt(n.value);const{klass:r}=Ko[t];if(!r)throw new Error(`Can't deserialize unregistered class "${t}".`);if(r.deserialize)return r.deserialize(n);const l=Object.create(r.prototype);for(const u of Object.keys(n))u!=="$name"&&(l[u]=$c(n[u]));return l}throw new Error("can't deserialize object of type "+typeof n)}const Zi={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,Osage:n=>n>=66736&&n<=66815,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function Yh(n){for(const t of n)if(Jh(t.charCodeAt(0)))return!0;return!1}function hd(n){for(const t of n)if(!Eu(t.charCodeAt(0)))return!1;return!0}function Eu(n){return!(Zi.Arabic(n)||Zi["Arabic Supplement"](n)||Zi["Arabic Extended-A"](n)||Zi["Arabic Presentation Forms-A"](n)||Zi["Arabic Presentation Forms-B"](n))}function Jh(n){return!(n!==746&&n!==747&&(n<4352||!(Zi["Bopomofo Extended"](n)||Zi.Bopomofo(n)||Zi["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||Zi["CJK Compatibility Ideographs"](n)||Zi["CJK Compatibility"](n)||Zi["CJK Radicals Supplement"](n)||Zi["CJK Strokes"](n)||!(!Zi["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||Zi["CJK Unified Ideographs Extension A"](n)||Zi["CJK Unified Ideographs"](n)||Zi["Enclosed CJK Letters and Months"](n)||Zi["Hangul Compatibility Jamo"](n)||Zi["Hangul Jamo Extended-A"](n)||Zi["Hangul Jamo Extended-B"](n)||Zi["Hangul Jamo"](n)||Zi["Hangul Syllables"](n)||Zi.Hiragana(n)||Zi["Ideographic Description Characters"](n)||Zi.Kanbun(n)||Zi["Kangxi Radicals"](n)||Zi["Katakana Phonetic Extensions"](n)||Zi.Katakana(n)&&n!==12540||!(!Zi["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!Zi["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||Zi["Unified Canadian Aboriginal Syllabics"](n)||Zi["Unified Canadian Aboriginal Syllabics Extended"](n)||Zi["Vertical Forms"](n)||Zi["Yijing Hexagram Symbols"](n)||Zi["Yi Syllables"](n)||Zi["Yi Radicals"](n))))}function qd(n){return!(Jh(n)||function(t){return!!(Zi["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||Zi["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||Zi["Letterlike Symbols"](t)||Zi["Number Forms"](t)||Zi["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||Zi["Control Pictures"](t)&&t!==9251||Zi["Optical Character Recognition"](t)||Zi["Enclosed Alphanumerics"](t)||Zi["Geometric Shapes"](t)||Zi["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||Zi["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Zi["CJK Symbols and Punctuation"](t)||Zi.Katakana(t)||Zi["Private Use Area"](t)||Zi["CJK Compatibility Forms"](t)||Zi["Small Form Variants"](t)||Zi["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(n))}function Kh(n){return Zi.Arabic(n)||Zi["Arabic Supplement"](n)||Zi["Arabic Extended-A"](n)||Zi["Arabic Presentation Forms-A"](n)||Zi["Arabic Presentation Forms-B"](n)}function Qh(n){return n>=1424&&n<=2303||Zi["Arabic Presentation Forms-A"](n)||Zi["Arabic Presentation Forms-B"](n)}function vf(n,t){return!(!t&&Qh(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||Zi.Khmer(n))}function Cp(n){for(const t of n)if(Qh(t.charCodeAt(0)))return!0;return!1}const Gs={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let ud=null,pa=Gs.unavailable,gc=null;const Zd=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&(pa=Gs.error),ud&&ud(n)};function C(){s.fire(new Sa("pluginStateChange",{pluginStatus:pa,pluginURL:gc}))}const s=new Rl,d=function(){return pa},v=function(){if(pa!==Gs.deferred||!gc)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");pa=Gs.loading,C(),gc&&Ll({url:gc},n=>{n?Zd(n):(pa=Gs.loaded,C())})},S={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>pa===Gs.loaded||S.applyArabicShaping!=null,isLoading:()=>pa===Gs.loading,setState(n){pa=n.pluginStatus,gc=n.pluginURL},isParsing:()=>pa===Gs.parsing,isParsed:()=>pa===Gs.parsed,getPluginURL:()=>gc};class D{constructor(t,r){this.zoom=t,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.transition=r.transition,this.pitch=r.pitch,this.brightness=r.brightness,this.worldview=r.worldview,this.activeFloors=r.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(t){return function(r,l){for(const u of r)if(!vf(u.charCodeAt(0),l))return!1;return!0}(t,S.isLoaded())}}class k{constructor(t,r,l,u,m){this.property=t,this.value=r,this.expression=function(_,b,E,P,R){if(ad(_))return new Gd(_,b);if(Xh(_)||Array.isArray(_)&&_.length>0){const F=bl(_,b,E,P,R);if(F.result==="error")throw new Error(F.value.map(O=>`${O.key}: ${O.message}`).join(", "));return F.value}{let F=_;return typeof _=="string"&&b.type==="color"&&(F=Br.parse(_)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>F}}}(r===void 0?t.specification.default:r,t.specification,l,u,m)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,r,l,u){return this.property.possiblyEvaluate(this,t,r,l,u)}}class j{constructor(t,r,l,u){this.property=t,this.value=new k(t,void 0,r,l,u)}transitioned(t,r){return new J(this.property,this.value,r,Object.assign({},t.transition,this.transition),t.now)}untransitioned(){return new J(this.property,this.value,null,{},0)}}class H{constructor(t,r,l,u){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues),this._scope=r,this._options=l,this._iconImageUseTheme=u,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(t){return Di(this._values[t].value.value)}setValue(t,r){this._values.hasOwnProperty(t)||(this._values[t]=new j(this._values[t].property,this._scope,this._options,this._iconImageUseTheme)),this._values[t].value=new k(this._values[t].property,r===null?void 0:Di(r),this._scope,this._options,this._iconImageUseTheme),this._values[t].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[t].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[t].value.isIndoorDependent())}setTransitionOrValue(t,r){r&&(this._options=r);const l=this._properties.properties;if(t)for(const u in t){const m=t[u];if(u.endsWith("-transition")){const _=u.slice(0,-11);l[_]&&this.setTransition(_,m)}else l.hasOwnProperty(u)&&this.setValue(u,m)}}getTransition(t){return Di(this._values[t].transition)}setTransition(t,r){this._values.hasOwnProperty(t)||(this._values[t]=new j(this._values[t].property)),this._values[t].transition=Di(r)||void 0}serialize(){const t={};for(const r of Object.keys(this._values)){const l=this.getValue(r);l!==void 0&&(t[r]=l);const u=this.getTransition(r);u!==void 0&&(t[`${r}-transition`]=u)}return t}transitioned(t,r){const l=new et(this._properties);for(const u of Object.keys(this._values))l._values[u]=this._values[u].transitioned(t,r._values[u]);return l}untransitioned(){const t=new et(this._properties);for(const r of Object.keys(this._values))t._values[r]=this._values[r].untransitioned();return t}isIndoorDependent(){return this._isIndoorDependent}}class J{constructor(t,r,l,u,m){const _=u.delay||0,b=u.duration||0;m=m||0,this.property=t,this.value=r,this.begin=m+_,this.end=this.begin+b,t.specification.transition&&(u.delay||u.duration)&&(this.prior=l)}possiblyEvaluate(t,r,l){const u=t.now||0,m=this.value.possiblyEvaluate(t,r,l),_=this.prior;if(_){if(u>this.end)return this.prior=null,m;if(this.value.isDataDriven())return this.prior=null,m;if(u<this.begin)return _.possiblyEvaluate(t,r,l);{const b=(u-this.begin)/(this.end-this.begin);return this.property.interpolate(_.possiblyEvaluate(t,r,l),m,zo(b))}}return m}}class et{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,r,l){const u=new Tt(this._properties);for(const m of Object.keys(this._values))u._values[m]=this._values[m].possiblyEvaluate(t,r,l);return u}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class mt{constructor(t,r,l,u){this._properties=t,this._values=Object.create(t.defaultPropertyValues),this._scope=r,this._options=l,this._iconImageUseTheme=u,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(t){return Di(this._values[t].value)}setValue(t,r){this._values[t]=new k(this._values[t].property,r===null?void 0:Di(r),this._scope,this._options,this._iconImageUseTheme),this._values[t].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[t].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[t].isIndoorDependent())}serialize(){const t={};for(const r of Object.keys(this._values)){const l=this.getValue(r);l!==void 0&&(t[r]=l)}return t}possiblyEvaluate(t,r,l,u){const m=new Tt(this._properties);for(const _ of Object.keys(this._values))m._values[_]=this._values[_].possiblyEvaluate(t,r,l,u);return m}isIndoorDependent(){return this._isIndoorDependent}}class dt{constructor(t,r,l,u){this.property=t,this.value=r,this.parameters=l,this.iconImageUseTheme=u}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,r,l,u){return this.property.evaluate(this.value,this.parameters,t,r,l,u,this.iconImageUseTheme)}}class Tt{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class pt{constructor(t){this.specification=t}possiblyEvaluate(t,r){return t.expression.evaluate(r)}interpolate(t,r,l){const u=fl[this.specification.type];return u?u(t,r,l):t}}class It{constructor(t,r){this.specification=t,this.overrides=r}possiblyEvaluate(t,r,l,u,m){return t.expression.kind==="constant"||t.expression.kind==="camera"?new dt(this,{kind:"constant",value:t.expression.evaluate(r,null,{},l,u,void 0,m)},r):new dt(this,t.expression,r,m)}interpolate(t,r,l){if(t.value.kind!=="constant"||r.value.kind!=="constant")return t;if(t.value.value===void 0||r.value.value===void 0)return new dt(this,{kind:"constant",value:void 0},t.parameters);const u=fl[this.specification.type];return u?new dt(this,{kind:"constant",value:u(t.value.value,r.value.value,l)},t.parameters):t}evaluate(t,r,l,u,m,_,b){return t.kind==="constant"?t.value:t.evaluate(r,l,u,m,_,void 0,b)}}class Kt{constructor(t){this.specification=t}possiblyEvaluate(t,r,l,u){return!!t.expression.evaluate(r,null,{},l,u)}interpolate(){return!1}}class Wt{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const r=new D(0,{});for(const l in t){const u=t[l];u.specification.overridable&&this.overridableProperties.push(l);const m=this.defaultPropertyValues[l]=new k(u,void 0),_=this.defaultTransitionablePropertyValues[l]=new j(u);this.defaultTransitioningPropertyValues[l]=_.untransitioned(),this.defaultPossiblyEvaluatedValues[l]=m.possiblyEvaluate(r)}}}Ei(It,"DataDrivenProperty"),Ei(pt,"DataConstantProperty"),Ei(Kt,"ColorRampProperty");var ft=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function _e(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function he(n){if(Array.isArray(n))return n.map(he);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){const t={};for(const r in n)t[r]=he(n[r]);return t}return _e(n)}function me(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const t of n.slice(1))if(!me(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}function be(n,t="",r=null,l="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};me(n)||(n=Ri(n));const u=n;let m=!0;try{m=function(R){if(!Qe(R))return R;let F=he(R);return Ce(F),F=de(F),F}(u)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(u,null,2)}
        `)}let _=null,b=null;if(l!=="background"&&l!=="sky"&&l!=="slot"){b=ft[`filter_${l}`];const R=mc(m,b,t,r);if(R.result==="error")throw new Error(R.value.map(F=>`${F.key}: ${F.message}`).join(", "));_=(F,O,$)=>R.value.evaluate(F,O,{},$)}let E=null,P=null;if(m!==u){const R=mc(u,b,t,r);if(R.result==="error")throw new Error(R.value.map(F=>`${F.key}: ${F.message}`).join(", "));E=(F,O,$,q,Y)=>R.value.evaluate(F,O,{},$,void 0,void 0,q,Y),P=!gu(R.value.expression)}return{filter:_,dynamicFilter:E||void 0,needGeometry:ii(m),needFeature:!!P}}function de(n){if(!Array.isArray(n))return n;const t=function(r){if(Xe.has(r[0])){for(let l=1;l<r.length;l++)if(Qe(r[l]))return!0}return r}(n);return t===!0?t:t.map(r=>de(r))}function Ce(n){let t=!1;const r=[];if(n[0]==="case"){for(let l=1;l<n.length-1;l+=2)t=t||Qe(n[l]),r.push(n[l+1]);r.push(n[n.length-1])}else if(n[0]==="match"){t=t||Qe(n[1]);for(let l=2;l<n.length-1;l+=2)r.push(n[l+1]);r.push(n[n.length-1])}else if(n[0]==="step"){t=t||Qe(n[1]);for(let l=1;l<n.length-1;l+=2)r.push(n[l+1])}t&&(n.length=0,n.push("any",...r));for(let l=1;l<n.length;l++)Ce(n[l])}function Qe(n){if(!Array.isArray(n))return!1;if((t=n[0])==="pitch"||t==="distance-from-center")return!0;var t;for(let r=1;r<n.length;r++)if(Qe(n[r]))return!0;return!1}const Xe=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Je(n,t){return n<t?-1:n>t?1:0}function ii(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let t=1;t<n.length;t++)if(ii(n[t]))return!0;return!1}function Ri(n){if(!n)return!0;const t=n[0];return n.length<=1?t!=="any":t==="=="?Oi(n[1],n[2],"=="):t==="!="?tn(Oi(n[1],n[2],"==")):t==="<"||t===">"||t==="<="||t===">="?Oi(n[1],n[2],t):t==="any"?(r=n.slice(1),["any"].concat(r.map(Ri))):t==="all"?["all"].concat(n.slice(1).map(Ri)):t==="none"?["all"].concat(n.slice(1).map(Ri).map(tn)):t==="in"?Ti(n[1],n.slice(2)):t==="!in"?tn(Ti(n[1],n.slice(2))):t==="has"?br(n[1]):t!=="!has"||tn(br(n[1]));var r}function Oi(n,t,r){switch(n){case"$type":return[`filter-type-${r}`,t];case"$id":return[`filter-id-${r}`,t];default:return[`filter-${r}`,n,t]}}function Ti(n,t){if(t.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(r=>typeof r!=typeof t[0])?["filter-in-large",n,["literal",t.sort(Je)]]:["filter-in-small",n,["literal",t]]}}function br(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function tn(n){return["!",n]}const Zr="";function vo(n,t){return t?`${n}${Zr}${t}`:n}let Wo;const os=()=>Wo||(Wo=new Wt({"icon-size":new It(ft.layout_symbol["icon-size"]),"icon-image":new It(ft.layout_symbol["icon-image"]),"icon-rotate":new It(ft.layout_symbol["icon-rotate"]),"icon-offset":new It(ft.layout_symbol["icon-offset"])}));class Xo{constructor(t,r,l,u,m,_){this.cachedIconPrimary=null;const b=mc(t,ft.appearance.condition);if(b.result==="success"&&(this.condition=b.value),this.name=r,l){this.properties=new Tt(os()),this.unevaluatedLayout=new mt(os(),u,m,_);for(const E in l)this.unevaluatedLayout.setValue(E,l[E])}}hasCachedIconPrimary(){return this.cachedIconPrimary!==null}setCachedIconPrimary(t){this.cachedIconPrimary=t}getCachedIconPrimary(){return this.cachedIconPrimary}isActive(t){return!(this.condition||!t.isHidden||this.name!=="hidden")||this.condition.evaluate(t.globals,t.feature,t.featureState,t.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(t){return this.properties.get(t)}getUnevaluatedProperties(){return this.unevaluatedLayout}recalculate(t,r,l){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(t,void 0,r,l))}serialize(){const t={};return t.condition=this.condition.expression.serialize(),this.name&&(t.name=this.name),this.unevaluatedLayout&&(t.properties=this.unevaluatedLayout.serialize()),t}}const zs="-transition",ss=new Set(["fill","line","background","hillshade","raster"]);class io extends Rl{constructor(t,r,l,u,m,_){if(super(),this.id=t.id,this.fqid=vo(this.id,l),this.type=t.type,this.scope=l,this.lut=u,this.options=m,this.iconImageUseTheme=_,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},t.type!=="custom"){if(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type&&t.type!=="background"&&t.type!=="sky"&&t.type!=="slot"){this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter;const b=mc(this.filter,ft[`filter_${t.type}`]);b.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...b.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||b.value.isIndoorDependent)}if(t.slot&&(this.slot=t.slot),t.appearances&&this.setAppearances(t.appearances),r.layout&&(this._unevaluatedLayout=new mt(r.layout,this.scope,m,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),r.paint){this._transitionablePaint=new H(r.paint,this.scope,m);for(const b in t.paint)this.setPaintProperty(b,t.paint[b]);for(const b in t.layout)this.setLayoutProperty(b,t.layout[b]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Tt(r.paint)}}}onAdd(t){}onRemove(t){}isDraped(t){return!this.is3D(!0)&&ss.has(this.type)}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,r){if(this.type==="custom"&&t==="visibility")return void(this.visibility=r);const l=this._unevaluatedLayout;l._properties.properties[t]&&(l.setValue(t,r),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...l.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||l.isIndoorDependent(),t==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(t){this.appearances=[],t.forEach(r=>{this.appearances.push(new Xo(r.condition,r.name,r.properties,this.scope,this.options,this.iconImageUseTheme))})}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(t){return t.endsWith(zs)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}isPaintProperty(t){return!!this._transitionablePaint._properties.properties[t]}setPaintProperty(t,r){const l=this._transitionablePaint,u=l._properties.properties;if(t.endsWith(zs)){const F=t.slice(0,-11);return u[F]&&l.setTransition(F,r||void 0),!1}if(!u[t])return!1;const m=l._values[t],_=m.value.isDataDriven(),b=m.value;l.setValue(t,r),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...l.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||l.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(t);const E=l._values[t].value,P=E.isDataDriven(),R=t.endsWith("pattern")||t==="line-dasharray";return P||_||R||this._handleOverridablePaintPropertyUpdate(t,b,E)}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getDefaultProgramParams(t,r,l){return null}_handleOverridablePaintPropertyUpdate(t,r,l){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,r){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,r,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,r)}serialize(){const t={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(t.appearances=this.appearances.map(r=>r.serialize())),$e(t,(r,l)=>!(r===void 0||l==="layout"&&!Object.keys(r).length||l==="paint"&&!Object.keys(r).length))}is3D(t){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const t in this.paint._values){const r=this.paint.get(t);if(r instanceof dt&&wo(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}for(const t of this.appearances)if(!Vh(t.condition.expression))return!0;return!1}compileFilter(t){this._filterCompiled||(this._featureFilter=be(this.filter,this.scope,t),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(t){this._stats&&(t.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(t,r,l){return{}}queryRadius(t){}queryIntersectsFeature(t,r,l,u,m,_,b,E,P){}}const Es={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class as{constructor(t,r){this._structArray=t,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class sn{constructor(){this.capacity=-1,this.resize(0)}static serialize(t,r){return t._trim(),r&&r.add(t.arrayBuffer),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const r=Object.create(this.prototype);return r.arrayBuffer=t.arrayBuffer,r.length=t.length,r.capacity=t.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...t){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...t){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Er(n,t=1){let r=0,l=0;return{members:n.map(u=>{const m=Es[u.type].BYTES_PER_ELEMENT,_=r=Ql(r,Math.max(t,m)),b=u.components||1;return l=Math.max(l,m),r+=m*b,{name:u.name,type:u.type,components:b,offset:_}}),size:Ql(r,Math.max(l,t)),alignment:t}}function Ql(n,t){return Math.ceil(n/t)*t}class As extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r){const l=this.length;return this.resize(l+1),this.emplace(l,t,r)}emplace(t,r,l){const u=2*t;return this.int16[u+0]=r,this.int16[u+1]=l,t}}As.prototype.bytesPerElement=4,Ei(As,"StructArrayLayout2i4");class wl extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=3*t;return this.int16[m+0]=r,this.int16[m+1]=l,this.int16[m+2]=u,t}}wl.prototype.bytesPerElement=6,Ei(wl,"StructArrayLayout3i6");class tc extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=4*t;return this.int16[_+0]=r,this.int16[_+1]=l,this.int16[_+2]=u,this.int16[_+3]=m,t}}tc.prototype.bytesPerElement=8,Ei(tc,"StructArrayLayout4i8");class $s extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.float32[1*t+0]=r,t}}$s.prototype.bytesPerElement=4,Ei($s,"StructArrayLayout1f4");class _c extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=4*t,_=2*t;return this.int16[m+0]=r,this.int16[m+1]=l,this.float32[_+1]=u,t}}_c.prototype.bytesPerElement=8,Ei(_c,"StructArrayLayout2i1f8");class rl extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=4*t;return this.int16[m+0]=r,this.int16[m+1]=l,this.int16[m+2]=u,t}}rl.prototype.bytesPerElement=8,Ei(rl,"StructArrayLayout3i8");class ec extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=5*t;return this.int16[b+0]=r,this.int16[b+1]=l,this.int16[b+2]=u,this.int16[b+3]=m,this.int16[b+4]=_,t}}ec.prototype.bytesPerElement=10,Ei(ec,"StructArrayLayout5i10");class qc extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=6*t,R=12*t,F=3*t;return this.int16[P+0]=r,this.int16[P+1]=l,this.uint8[R+4]=u,this.uint8[R+5]=m,this.uint8[R+6]=_,this.uint8[R+7]=b,this.float32[F+2]=E,t}}qc.prototype.bytesPerElement=12,Ei(qc,"StructArrayLayout2i4ub1f12");class ta extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=3*t;return this.float32[m+0]=r,this.float32[m+1]=l,this.float32[m+2]=u,t}}ta.prototype.bytesPerElement=12,Ei(ta,"StructArrayLayout3f12");class Bo extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=6*t,E=3*t;return this.uint16[b+0]=r,this.uint16[b+1]=l,this.uint16[b+2]=u,this.uint16[b+3]=m,this.float32[E+2]=_,t}}Bo.prototype.bytesPerElement=12,Ei(Bo,"StructArrayLayout4ui1f12");class Oo extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=4*t;return this.uint16[_+0]=r,this.uint16[_+1]=l,this.uint16[_+2]=u,this.uint16[_+3]=m,t}}Oo.prototype.bytesPerElement=8,Ei(Oo,"StructArrayLayout4ui8");class ys extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=6*t;return this.int16[E+0]=r,this.int16[E+1]=l,this.int16[E+2]=u,this.int16[E+3]=m,this.int16[E+4]=_,this.int16[E+5]=b,t}}ys.prototype.bytesPerElement=12,Ei(ys,"StructArrayLayout6i12");class Lo extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O){const $=this.length;return this.resize($+1),this.emplace($,t,r,l,u,m,_,b,E,P,R,F,O)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$){const q=12*t;return this.int16[q+0]=r,this.int16[q+1]=l,this.int16[q+2]=u,this.int16[q+3]=m,this.uint16[q+4]=_,this.uint16[q+5]=b,this.uint16[q+6]=E,this.uint16[q+7]=P,this.int16[q+8]=R,this.int16[q+9]=F,this.int16[q+10]=O,this.int16[q+11]=$,t}}Lo.prototype.bytesPerElement=24,Ei(Lo,"StructArrayLayout4i4ui4i24");class Ol extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=10*t,P=5*t;return this.int16[E+0]=r,this.int16[E+1]=l,this.int16[E+2]=u,this.float32[P+2]=m,this.float32[P+3]=_,this.float32[P+4]=b,t}}Ol.prototype.bytesPerElement=20,Ei(Ol,"StructArrayLayout3i3f20");class uh extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=4*t;return this.float32[_+0]=r,this.float32[_+1]=l,this.float32[_+2]=u,this.float32[_+3]=m,t}}uh.prototype.bytesPerElement=16,Ei(uh,"StructArrayLayout4f16");class Dp extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint32[1*t+0]=r,t}}Dp.prototype.bytesPerElement=4,Ei(Dp,"StructArrayLayout1ul4");class Nl extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r){const l=this.length;return this.resize(l+1),this.emplace(l,t,r)}emplace(t,r,l){const u=2*t;return this.uint16[u+0]=r,this.uint16[u+1]=l,t}}Nl.prototype.bytesPerElement=4,Ei(Nl,"StructArrayLayout2ui4");class dh extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$){const q=this.length;return this.resize(q+1),this.emplace(q,t,r,l,u,m,_,b,E,P,R,F,O,$)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q){const Y=20*t,it=10*t;return this.int16[Y+0]=r,this.int16[Y+1]=l,this.int16[Y+2]=u,this.int16[Y+3]=m,this.int16[Y+4]=_,this.float32[it+3]=b,this.float32[it+4]=E,this.float32[it+5]=P,this.float32[it+6]=R,this.int16[Y+14]=F,this.uint32[it+8]=O,this.uint16[Y+18]=$,this.uint16[Y+19]=q,t}}dh.prototype.bytesPerElement=40,Ei(dh,"StructArrayLayout5i4f1i1ul2ui40");class zp extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=8*t;return this.int16[P+0]=r,this.int16[P+1]=l,this.int16[P+2]=u,this.int16[P+4]=m,this.int16[P+5]=_,this.int16[P+6]=b,this.int16[P+7]=E,t}}zp.prototype.bytesPerElement=16,Ei(zp,"StructArrayLayout3i2i2i16");class Vl extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=4*t,E=8*t;return this.float32[b+0]=r,this.float32[b+1]=l,this.float32[b+2]=u,this.int16[E+6]=m,this.int16[E+7]=_,t}}Vl.prototype.bytesPerElement=16,Ei(Vl,"StructArrayLayout2f1f2i16");class ph extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=20*t,P=5*t;return this.uint8[E+0]=r,this.uint8[E+1]=l,this.float32[P+1]=u,this.float32[P+2]=m,this.float32[P+3]=_,this.float32[P+4]=b,t}}ph.prototype.bytesPerElement=20,Ei(ph,"StructArrayLayout2ub4f20");class ro extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l){const u=this.length;return this.resize(u+1),this.emplace(u,t,r,l)}emplace(t,r,l,u){const m=3*t;return this.uint16[m+0]=r,this.uint16[m+1]=l,this.uint16[m+2]=u,t}}ro.prototype.bytesPerElement=6,Ei(ro,"StructArrayLayout3ui6");class Ul extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt,yt,At,Gt){const kt=this.length;return this.resize(kt+1),this.emplace(kt,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt,yt,At,Gt)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt,yt,At,Gt,kt){const Xt=30*t,te=15*t,ne=60*t;return this.int16[Xt+0]=r,this.int16[Xt+1]=l,this.int16[Xt+2]=u,this.float32[te+2]=m,this.float32[te+3]=_,this.uint16[Xt+8]=b,this.uint16[Xt+9]=E,this.uint32[te+5]=P,this.uint32[te+6]=R,this.uint32[te+7]=F,this.uint16[Xt+16]=O,this.uint16[Xt+17]=$,this.uint16[Xt+18]=q,this.float32[te+10]=Y,this.float32[te+11]=it,this.uint8[ne+48]=at,this.uint8[ne+49]=gt,this.uint8[ne+50]=yt,this.uint32[te+13]=At,this.int16[Xt+28]=Gt,this.uint8[ne+58]=kt,t}}Ul.prototype.bytesPerElement=60,Ei(Ul,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class yc extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt,yt,At,Gt,kt,Xt,te,ne,ze,fe,ke,Ue,Ze,hi,Ke,je){const Ye=this.length;return this.resize(Ye+1),this.emplace(Ye,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt,yt,At,Gt,kt,Xt,te,ne,ze,fe,ke,Ue,Ze,hi,Ke,je)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt,yt,At,Gt,kt,Xt,te,ne,ze,fe,ke,Ue,Ze,hi,Ke,je,Ye){const Pe=20*t,Ie=40*t,He=80*t;return this.float32[Pe+0]=r,this.float32[Pe+1]=l,this.int16[Ie+4]=u,this.int16[Ie+5]=m,this.int16[Ie+6]=_,this.int16[Ie+7]=b,this.int16[Ie+8]=E,this.int16[Ie+9]=P,this.int16[Ie+10]=R,this.int16[Ie+11]=F,this.int16[Ie+12]=O,this.uint16[Ie+13]=$,this.uint16[Ie+14]=q,this.uint16[Ie+15]=Y,this.uint16[Ie+16]=it,this.uint16[Ie+17]=at,this.uint16[Ie+18]=gt,this.uint16[Ie+19]=yt,this.uint16[Ie+20]=At,this.uint16[Ie+21]=Gt,this.uint16[Ie+22]=kt,this.uint16[Ie+23]=Xt,this.uint16[Ie+24]=te,this.uint16[Ie+25]=ne,this.uint16[Ie+26]=ze,this.uint16[Ie+27]=fe,this.uint32[Pe+14]=ke,this.float32[Pe+15]=Ue,this.float32[Pe+16]=Ze,this.float32[Pe+17]=hi,this.float32[Pe+18]=Ke,this.uint8[He+76]=je,this.uint16[Ie+39]=Ye,t}}yc.prototype.bytesPerElement=80,Ei(yc,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Hd extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_){const b=this.length;return this.resize(b+1),this.emplace(b,t,r,l,u,m,_)}emplace(t,r,l,u,m,_,b){const E=6*t;return this.float32[E+0]=r,this.float32[E+1]=l,this.float32[E+2]=u,this.float32[E+3]=m,this.float32[E+4]=_,this.float32[E+5]=b,t}}Hd.prototype.bytesPerElement=24,Ei(Hd,"StructArrayLayout6f24");class fh extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m){const _=this.length;return this.resize(_+1),this.emplace(_,t,r,l,u,m)}emplace(t,r,l,u,m,_){const b=5*t;return this.float32[b+0]=r,this.float32[b+1]=l,this.float32[b+2]=u,this.float32[b+3]=m,this.float32[b+4]=_,t}}fh.prototype.bytesPerElement=20,Ei(fh,"StructArrayLayout5f20");class bf extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=7*t;return this.float32[P+0]=r,this.float32[P+1]=l,this.float32[P+2]=u,this.float32[P+3]=m,this.float32[P+4]=_,this.float32[P+5]=b,this.float32[P+6]=E,t}}bf.prototype.bytesPerElement=28,Ei(bf,"StructArrayLayout7f28");class Lp extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F){const O=this.length;return this.resize(O+1),this.emplace(O,t,r,l,u,m,_,b,E,P,R,F)}emplace(t,r,l,u,m,_,b,E,P,R,F,O){const $=11*t;return this.float32[$+0]=r,this.float32[$+1]=l,this.float32[$+2]=u,this.float32[$+3]=m,this.float32[$+4]=_,this.float32[$+5]=b,this.float32[$+6]=E,this.float32[$+7]=P,this.float32[$+8]=R,this.float32[$+9]=F,this.float32[$+10]=O,t}}Lp.prototype.bytesPerElement=44,Ei(Lp,"StructArrayLayout11f44");class Rp extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P){const R=this.length;return this.resize(R+1),this.emplace(R,t,r,l,u,m,_,b,E,P)}emplace(t,r,l,u,m,_,b,E,P,R){const F=9*t;return this.float32[F+0]=r,this.float32[F+1]=l,this.float32[F+2]=u,this.float32[F+3]=m,this.float32[F+4]=_,this.float32[F+5]=b,this.float32[F+6]=E,this.float32[F+7]=P,this.float32[F+8]=R,t}}Rp.prototype.bytesPerElement=36,Ei(Rp,"StructArrayLayout9f36");class Au extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r){const l=this.length;return this.resize(l+1),this.emplace(l,t,r)}emplace(t,r,l){const u=2*t;return this.float32[u+0]=r,this.float32[u+1]=l,t}}Au.prototype.bytesPerElement=8,Ei(Au,"StructArrayLayout2f8");class Dm extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,l,u){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,l,u)}emplace(t,r,l,u,m){const _=6*t;return this.uint32[3*t+0]=r,this.uint16[_+2]=l,this.uint16[_+3]=u,this.uint16[_+4]=m,t}}Dm.prototype.bytesPerElement=12,Ei(Dm,"StructArrayLayout1ul3ui12");class kp extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint16[1*t+0]=r,t}}kp.prototype.bytesPerElement=2,Ei(kp,"StructArrayLayout1ui2");class Kf extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it){const at=this.length;return this.resize(at+1),this.emplace(at,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it)}emplace(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at){const gt=16*t;return this.float32[gt+0]=r,this.float32[gt+1]=l,this.float32[gt+2]=u,this.float32[gt+3]=m,this.float32[gt+4]=_,this.float32[gt+5]=b,this.float32[gt+6]=E,this.float32[gt+7]=P,this.float32[gt+8]=R,this.float32[gt+9]=F,this.float32[gt+10]=O,this.float32[gt+11]=$,this.float32[gt+12]=q,this.float32[gt+13]=Y,this.float32[gt+14]=it,this.float32[gt+15]=at,t}}Kf.prototype.bytesPerElement=64,Ei(Kf,"StructArrayLayout16f64");class dd extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,l,u,m,_,b){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,l,u,m,_,b)}emplace(t,r,l,u,m,_,b,E){const P=10*t,R=5*t;return this.uint16[P+0]=r,this.uint16[P+1]=l,this.uint16[P+2]=u,this.uint16[P+3]=m,this.float32[R+2]=_,this.float32[R+3]=b,this.float32[R+4]=E,t}}dd.prototype.bytesPerElement=20,Ei(dd,"StructArrayLayout4ui3f20");class Qf extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.int16[1*t+0]=r,t}}Qf.prototype.bytesPerElement=2,Ei(Qf,"StructArrayLayout1i2");class wf extends sn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint8[1*t+0]=r,t}}wf.prototype.bytesPerElement=1,Ei(wf,"StructArrayLayout1ub1");class pd extends as{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}pd.prototype.size=40;class gg extends dh{get(t){return new pd(this,t)}}Ei(gg,"CollisionBoxArray");class Pu extends as{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}Pu.prototype.size=60;class fd extends Ul{get(t){return new Pu(this,t)}}Ei(fd,"PlacedSymbolArray");class Fp extends as{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(t){this._structArray.uint32[this._pos4+14]=t}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(t){this._structArray.float32[this._pos4+18]=t}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Fp.prototype.size=80;class _g extends yc{get(t){return new Fp(this,t)}}Ei(_g,"SymbolInstanceArray");class zm extends $s{getoffsetX(t){return this.float32[1*t+0]}}Ei(zm,"GlyphOffsetArray");class yg extends As{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}Ei(yg,"SymbolLineVertexArray");class tm extends as{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}tm.prototype.size=12;class Lm extends Dm{get(t){return new tm(this,t)}}Ei(Lm,"FeatureIndexArray");class em extends Nl{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}Ei(em,"FillExtrusionCentroidArray");class Rm extends as{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Rm.prototype.size=6;class km extends wl{get(t){return new Rm(this,t)}}Ei(km,"FillExtrusionWallArray");const xg=Er([{name:"a_pos",components:2,type:"Int16"}],4),g_=Er([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),vg=Er([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class To{constructor(t=[]){this.segments=t}_prepareSegment(t,r,l,u){let m=this.segments[this.segments.length-1];return t>To.MAX_VERTEX_ARRAY_LENGTH&&Hi(`Max vertices per segment is ${To.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!m||m.vertexLength+t>To.MAX_VERTEX_ARRAY_LENGTH||m.sortKey!==u)&&(m={vertexOffset:r,primitiveOffset:l,vertexLength:0,primitiveLength:0},u!==void 0&&(m.sortKey=u),this.segments.push(m)),m}prepareSegment(t,r,l,u){return this._prepareSegment(t,r.length,l.length,u)}get(){return this.segments}destroy(){for(const t of this.segments)for(const r in t.vaos)t.vaos[r].destroy()}static simpleSegment(t,r,l,u){return new To([{vertexOffset:t,primitiveOffset:r,vertexLength:l,primitiveLength:u,vaos:{},sortKey:0}])}}function bg(n,t){return 256*(n=tt(Math.floor(n),0,255))+tt(Math.floor(t),0,255)}To.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Ei(To,"SegmentVector");const Fm=Er([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),wg=Er([{name:"a_pattern_b",components:4,type:"Uint16"}]),Bm=Er([{name:"a_dash",components:4,type:"Uint16"}]);class Mu{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(t,r,l,u){this.ids.push(Aa(t)),this.positions.push(r,l,u)}eachPosition(t,r){const l=Aa(t);let u=0,m=this.ids.length-1;for(;u<m;){const _=u+m>>1;this.ids[_]>=l?m=_:u=_+1}for(;this.ids[u]===l;)r(this.positions[3*u],this.positions[3*u+1],this.positions[3*u+2]),u++}static serialize(t,r){const l=new Float64Array(t.ids),u=new Uint32Array(t.positions);return im(l,u,0,l.length-1),r&&(r.add(l.buffer),r.add(u.buffer)),{ids:l,positions:u}}static deserialize(t){const r=new Mu;let l;r.ids=t.ids,r.positions=t.positions;for(const u of r.ids)u!==l&&r.uniqueIds.push(u),l=u;return r.indexed=!0,r}}function Aa(n){const t=+n;return Number.isSafeInteger(t)?t:tl(String(n))}function im(n,t,r,l){for(;r<l;){const u=n[r+l>>1];let m=r-1,_=l+1;for(;;){do m++;while(n[m]<u);do _--;while(n[_]>u);if(m>=_)break;Bp(n,m,_),Bp(t,3*m,3*_),Bp(t,3*m+1,3*_+1),Bp(t,3*m+2,3*_+2)}_-r<l-_?(im(n,t,r,_),r=_+1):(im(n,t,_+1,l),l=_)}}function Bp(n,t,r){const l=n[t];n[t]=n[r],n[r]=l}Ei(Mu,"FeaturePositionMap");class Zc{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,r){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,r),this.initialized=!0),!!this.location}set(t,r,l){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Tf extends Zc{constructor(t){super(t),this.current=0}set(t,r,l){this.fetchUniformLocation(t,r)&&this.current!==l&&(this.current=l,this.gl.uniform1i(this.location,l))}}class ls extends Zc{constructor(t){super(t),this.current=0}set(t,r,l){this.fetchUniformLocation(t,r)&&this.current!==l&&(this.current=l,this.gl.uniform1f(this.location,l))}}class tu extends Zc{constructor(t){super(t),this.current=[0,0]}set(t,r,l){this.fetchUniformLocation(t,r)&&(l[0]===this.current[0]&&l[1]===this.current[1]||(this.current=l,this.gl.uniform2f(this.location,l[0],l[1])))}}class Wd extends Zc{constructor(t){super(t),this.current=[0,0,0]}set(t,r,l){this.fetchUniformLocation(t,r)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]||(this.current=l,this.gl.uniform3f(this.location,l[0],l[1],l[2])))}}class Sf extends Zc{constructor(t){super(t),this.current=[0,0,0,0]}set(t,r,l){this.fetchUniformLocation(t,r)&&(l[0]===this.current[0]&&l[1]===this.current[1]&&l[2]===this.current[2]&&l[3]===this.current[3]||(this.current=l,this.gl.uniform4f(this.location,l[0],l[1],l[2],l[3])))}}class If extends Zc{constructor(t){super(t),this.current=Br.transparent.toPremultipliedRenderColor(null)}set(t,r,l){this.fetchUniformLocation(t,r)&&(l.r===this.current.r&&l.g===this.current.g&&l.b===this.current.b&&l.a===this.current.a||(this.current=l,this.gl.uniform4f(this.location,l.r,l.g,l.b,l.a)))}}const Om=new Float32Array(16);class Op extends Zc{constructor(t){super(t),this.current=Om}set(t,r,l){if(this.fetchUniformLocation(t,r)){if(l[12]!==this.current[12]||l[0]!==this.current[0])return this.current=l,void this.gl.uniformMatrix4fv(this.location,!1,l);for(let u=1;u<16;u++)if(l[u]!==this.current[u]){this.current=l,this.gl.uniformMatrix4fv(this.location,!1,l);break}}}}const __=new Float32Array(9),Tg=new Float32Array(4);class Nm extends Zc{constructor(t){super(t),this.current=Tg}set(t,r,l){if(this.fetchUniformLocation(t,r)){for(let u=0;u<4;u++)if(l[u]!==this.current[u]){this.current=l,this.gl.uniformMatrix2fv(this.location,!1,l);break}}}}function Np(n){return[bg(255*n.r,255*n.g),bg(255*n.b,255*n.a)]}function Vp(n,t,r,l,u,m,_,b){return!!n&&(n.kind==="composite"||n.kind==="source"?n.evaluate(new D(0,{brightness:m,worldview:b}),t,r,u,l,_)==="none":n.value==="none")}class Ef{constructor(t,r,l,u){this.value=t,this.uniformNames=r.map(m=>`u_${m}`),this.type=l,this.context=u}setUniform(t,r,l,u,m){const _=u.constantOr(this.value);r.set(t,m,_ instanceof Br?_.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):_)}getBinding(t,r){return this.type==="color"?new If(t):new ls(t)}}class mh{constructor(t,r){this.uniformNames=r.map(l=>`u_${l}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(t,r){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br),this.patternTransition=r?r.tl.concat(r.br):this.pattern}setUniform(t,r,l,u,m){let _=null;m!=="u_pattern"&&m!=="u_dash"||(_=this.pattern),m==="u_pattern_b"&&(_=this.patternTransition),m==="u_pixel_ratio"&&(_=this.pixelRatio),_&&r.set(t,m,_)}getBinding(t,r){return r==="u_pattern"||r==="u_pattern_b"||r==="u_dash"?new Sf(t):new ls(t)}}class xc{constructor(t,r,l,u){this.expression=t,this.type=l,this.maxValue=0,this.paintVertexAttributes=r.map(m=>({name:`a_${m}`,type:"Float32",components:l==="color"?2:1,offset:0})),this.paintVertexArray=new u}populatePaintArray(t,r,l,u,m,_,b,E){const P=this.paintVertexArray.length,R=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new D(0,{brightness:_,worldview:E}),r,{},m,u,b):this.expression.kind==="constant"&&this.expression.value,F=Vp(this.lutExpression,r,{},u,m,_,b,E);this.paintVertexArray.resize(t),this._setPaintValue(P,t,R,F?null:this.context.lut)}updatePaintArray(t,r,l,u,m,_,b,E){const P=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:b,worldview:E},l,u,void 0,m):this.expression.kind==="constant"&&this.expression.value,R=Vp(this.lutExpression,l,u,m,void 0,b,void 0,E);this._setPaintValue(t,r,P,R?null:this.context.lut)}_setPaintValue(t,r,l,u){if(this.type==="color"){const m=Np(l.toPremultipliedRenderColor(u));for(let _=t;_<r;_++)this.paintVertexArray.emplace(_,m[0],m[1])}else{for(let m=t;m<r;m++)this.paintVertexArray.emplace(m,l);this.maxValue=Math.max(this.maxValue,Math.abs(l))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class gh{constructor(t,r,l,u,m,_){this.expression=t,this.uniformNames=r.map(b=>`u_${b}_t`),this.type=l,this.useIntegerZoom=u,this.context=m,this.maxValue=0,this.paintVertexAttributes=r.map(b=>({name:`a_${b}`,type:"Float32",components:l==="color"?4:2,offset:0})),this.paintVertexArray=new _}populatePaintArray(t,r,l,u,m,_,b,E){const P=this.expression.evaluate(new D(this.context.zoom,{brightness:_,worldview:E}),r,{},m,u,b),R=this.expression.evaluate(new D(this.context.zoom+1,{brightness:_,worldview:E}),r,{},m,u,b),F=Vp(this.lutExpression,r,{},u,m,_,b,E),O=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(O,t,P,R,F?null:this.context.lut)}updatePaintArray(t,r,l,u,m,_,b,E){const P=this.expression.evaluate({zoom:this.context.zoom,brightness:b,worldview:E},l,u,void 0,m),R=this.expression.evaluate({zoom:this.context.zoom+1,brightness:b,worldview:E},l,u,void 0,m),F=Vp(this.lutExpression,l,u,m,void 0,b,void 0,E);this._setPaintValue(t,r,P,R,F?null:this.context.lut)}_setPaintValue(t,r,l,u,m){if(this.type==="color"){const _=Np(l.toPremultipliedRenderColor(m)),b=Np(l.toPremultipliedRenderColor(m));for(let E=t;E<r;E++)this.paintVertexArray.emplace(E,_[0],_[1],b[0],b[1])}else{for(let _=t;_<r;_++)this.paintVertexArray.emplace(_,l,u);this.maxValue=Math.max(this.maxValue,Math.abs(l),Math.abs(u))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,r,l,u,m){const _=this.useIntegerZoom?Math.floor(l.zoom):l.zoom,b=tt(this.expression.interpolationFactor(_,this.context.zoom,this.context.zoom+1),0,1);r.set(t,m,b)}getBinding(t,r){return new ls(t)}}class Na{constructor(t,r,l,u,m){this.expression=t,this.layerId=m,this.paintVertexAttributes=(l==="array"?Bm:Fm).members;for(let _=0;_<r.length;++_);this.paintVertexArray=new u,this.paintTransitionVertexArray=new Oo}populatePaintArray(t,r,l,u){const m=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(m,t,r.patterns&&r.patterns[this.layerId],l)}updatePaintArray(t,r,l,u,m,_,b){this._setPaintValues(t,r,l.patterns&&l.patterns[this.layerId],_)}_setPaintValues(t,r,l,u){if(!u||!l)return;const m=u[l[0]],_=u[l[1]];if(m){if(m){const{tl:b,br:E,pixelRatio:P}=m;for(let R=t;R<r;R++)this.paintVertexArray.emplace(R,b[0],b[1],E[0],E[1],P)}if(_){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:b,br:E}=_;for(let P=t;P<r;P++)this.paintTransitionVertexArray.emplace(P,b[0],b[1],E[0],E[1])}}}upload(t){const r=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,r)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=t.createVertexBuffer(this.paintTransitionVertexArray,wg.members,r))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Cu{constructor(t,r,l=()=>!0){this.binders={},this._buffers=[],this.context=r;const u=[];for(const m in t.paint._values){const _=t.paint.get(m);if(m.endsWith("-use-theme")||!l(m)||!(_ instanceof dt&&wo(_.property.specification)))continue;const b=x_(m,t.type),E=_.value,P=_.property.specification.type,R=!!_.property.useIntegerZoom,F=m==="line-dasharray"||m.endsWith("pattern"),O=t.paint.get(`${m}-use-theme`),$=m==="line-dasharray"&&t.layout.get("line-cap").value.kind!=="constant"||O&&O.value.kind!=="constant";if(E.kind!=="constant"||$)if(E.kind==="source"||$||F){const q=Um(m,P,"source");this.binders[m]=F?new Na(E,b,P,q,t.id):new xc(E,b,P,q),u.push(`/a_${m}`)}else{const q=Um(m,P,"composite");this.binders[m]=new gh(E,b,P,R,r,q),u.push(`/z_${m}`)}else this.binders[m]=F?new mh(E.value,b):new Ef(E.value,b,P,r),u.push(`/u_${m}`);O&&(this.binders[m].lutExpression=O.value)}this.cacheKey=u.sort().join("")}getMaxValue(t){const r=this.binders[t];return r instanceof xc||r instanceof gh?r.maxValue:0}populatePaintArrays(t,r,l,u,m,_,b,E){for(const P in this.binders){const R=this.binders[P];R.context=this.context,(R instanceof xc||R instanceof gh||R instanceof Na)&&R.populatePaintArray(t,r,l,u,m,_,b,E)}}setConstantPatternPositions(t,r){for(const l in this.binders){const u=this.binders[l];u instanceof mh&&u.setConstantPatternPositions(t,r)}}getPatternTransitionVertexBuffer(t){const r=this.binders[t];return r instanceof Na?r.paintTransitionVertexBuffer:null}updatePaintArrays(t,r,l,u,m,_,b,E,P,R){let F=!1;const O=Object.keys(t),$=O.length!==0&&!E,q=$?O:r.uniqueIds;this.context.lut=m.lut;for(const Y in this.binders){const it=this.binders[Y];if(it.context=this.context,(it instanceof xc||it instanceof gh||it instanceof Na)&&it.expression&&it.expression.kind&&it.expression.kind!=="constant"&&(it.expression.isStateDependent===!0||it.expression.isLightConstant===!1)){const at=m.paint.get(Y);it.expression=at.value;for(const gt of q){const yt=t[gt.toString()];r.eachPosition(gt,(At,Gt,kt)=>{const Xt=u.feature(At);it.updatePaintArray(Gt,kt,Xt,yt,_,b,P,R)})}if(!$)for(const gt of l.uniqueIds){const yt=t[gt.toString()];l.eachPosition(gt,(At,Gt,kt)=>{const Xt=u.feature(At);it.updatePaintArray(Gt,kt,Xt,yt,_,b,P,R)})}F=!0}}return F}defines(){const t=[];for(const r in this.binders){const l=this.binders[r];(l instanceof Ef||l instanceof mh)&&t.push(...l.uniformNames.map(u=>`#define HAS_UNIFORM_${u}`))}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const r=[];for(const l in this.binders){const u=this.binders[l];if(u instanceof Ef||u instanceof mh||u instanceof gh)for(const m of u.uniformNames)r.push({name:m,property:l,binding:u.getBinding(t,m)})}return r}setUniforms(t,r,l,u,m){for(const{name:_,property:b,binding:E}of l)this.binders[b].setUniform(t,E,m,u.get(b),_)}updatePaintBuffers(){this._buffers=[];for(const t in this.binders){const r=this.binders[t];(r instanceof xc||r instanceof gh||r instanceof Na)&&r.paintVertexBuffer&&this._buffers.push(r.paintVertexBuffer),r instanceof Na&&r.paintTransitionVertexBuffer&&this._buffers.push(r.paintTransitionVertexBuffer)}}upload(t){for(const r in this.binders){const l=this.binders[r];(l instanceof xc||l instanceof gh||l instanceof Na)&&l.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const r=this.binders[t];(r instanceof xc||r instanceof gh||r instanceof Na)&&r.destroy()}}}class _h{constructor(t,r,l=()=>!0){this.programConfigurations={};for(const u of t)this.programConfigurations[u.id]=new Cu(u,r,l);this.needsUpload=!1,this._featureMap=new Mu,this._featureMapWithoutIds=new Mu,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(t,r,l,u,m,_,b,E,P){for(const R in this.programConfigurations)this.programConfigurations[R].populatePaintArrays(t,r,u,m,_,b,E,P);r.id!==void 0?this._featureMap.add(r.id,l,this._bufferOffset,t):(this._featureMapWithoutIds.add(this._idlessCounter,l,this._bufferOffset,t),this._idlessCounter+=1),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,r,l,u,m,_,b,E){for(const P of l)this.needsUpload=this.programConfigurations[P.id].updatePaintArrays(t,this._featureMap,this._featureMapWithoutIds,r,P,u,m,_,b||0,E)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const y_={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function x_(n,t){return y_[n]||[n.replace(`${t}-`,"").replace(/-/g,"_")]}const v_={"line-pattern":{source:Bo,composite:Bo},"fill-pattern":{source:Bo,composite:Bo},"fill-extrusion-pattern":{source:Bo,composite:Bo},"line-dasharray":{source:Oo,composite:Oo}},Vm={color:{source:Au,composite:uh},number:{source:$s,composite:Au}};function Um(n,t,r){const l=v_[n];return l&&l[r]||Vm[t][r]}Ei(Ef,"ConstantBinder"),Ei(mh,"PatternConstantBinder"),Ei(xc,"SourceExpressionBinder"),Ei(Na,"PatternCompositeBinder"),Ei(gh,"CompositeExpressionBinder"),Ei(Cu,"ProgramConfiguration",{omit:["_buffers"]}),Ei(_h,"ProgramConfigurationSet");const Tl=ri/Math.PI/2,p=5,e=6,a=16383,f=64,y=[f,32,16],w=-Tl,I=Tl;function M(n,t,r,l=Tl){return r=ar(r),[n*Math.sin(r)*l,-t*l,n*Math.cos(r)*l]}function L(n,t,r){return M(Math.cos(ar(n)),Math.sin(ar(n)),t,r)}const N=63710088e-1,V=2*Math.PI*N;class Z{constructor(t,r){if(isNaN(t)||isNaN(r))throw new Error(`Invalid LngLat object: (${t}, ${r})`);if(this.lng=+t,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Z(Bt(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const r=Math.PI/180,l=this.lat*r,u=t.lat*r,m=Math.sin(l)*Math.sin(u)+Math.cos(l)*Math.cos(u)*Math.cos((t.lng-this.lng)*r);return N*Math.acos(Math.min(m,1))}toBounds(t=0){const r=360*t/40075017,l=r/Math.cos(Math.PI/180*this.lat);return new U({lng:this.lng-l,lat:this.lat-r},{lng:this.lng+l,lat:this.lat+r})}toEcef(t){return L(this.lat,this.lng,Tl+t*Tl/N)}static convert(t){if(t instanceof Z)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new Z(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new Z(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class U{constructor(t,r){t&&(r?this.setSouthWest(t).setNorthEast(r):Array.isArray(t)&&t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof Z?new Z(t.lng,t.lat):Z.convert(t),this}setSouthWest(t){return this._sw=t instanceof Z?new Z(t.lng,t.lat):Z.convert(t),this}extend(t){const r=this._sw,l=this._ne;let u,m;if(t instanceof Z)u=t,m=t;else{if(!(t instanceof U))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(U.convert(t)):this.extend(Z.convert(t)):typeof t=="object"&&t!==null&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(Z.convert(t)):this;if(u=t._sw,m=t._ne,!u||!m)return this}return r||l?(r.lng=Math.min(u.lng,r.lng),r.lat=Math.min(u.lat,r.lat),l.lng=Math.max(m.lng,l.lng),l.lat=Math.max(m.lat,l.lat)):(this._sw=new Z(u.lng,u.lat),this._ne=new Z(m.lng,m.lat)),this}getCenter(){return new Z((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Z(this.getWest(),this.getNorth())}getSouthEast(){return new Z(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:r,lat:l}=Z.convert(t);let u=this._sw.lng<=r&&r<=this._ne.lng;return this._sw.lng>this._ne.lng&&(u=this._sw.lng>=r&&r>=this._ne.lng),this._sw.lat<=l&&l<=this._ne.lat&&u}static convert(t){if(t)return t instanceof U?t:new U(t)}}const X=0,K=25.5;function rt(n){return V*Math.cos(n*Math.PI/180)}function ht(n){return(180+n)/360}function lt(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function _t(n,t){return n/rt(t)}function Mt(n){return 360*n-180}function vt(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function Ut(n,t){return n*rt(vt(t))}const Ct=85.051129;function $t(n){return Math.cos(ar(tt(n,-Ct,Ct)))}function Ot(n,t){const r=tt(t,X,K),l=Math.pow(2,r);return $t(n)*V/(512*l)}function Rt(n){return 1/Math.cos(n*Math.PI/180)}function Zt(n,t=0){const r=Math.exp(Math.PI*(1-(n.y+t/ri)/(1<<n.z)*2));return 80150034*r/(r*r+1)/ri/(1<<n.z)}class pe{constructor(t,r,l=0){this.x=+t,this.y=+r,this.z=+l}static fromLngLat(t,r=0){const l=Z.convert(t);return new pe(ht(l.lng),lt(l.lat),_t(r,l.lat))}toLngLat(){return new Z(Mt(this.x),vt(this.y))}toAltitude(){return Ut(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/V*Rt(vt(this.y))}}function le(n,t,r,l,u,m,_,b,E){const P=(t+l)/2,R=(r+u)/2,F=new Ae(P,R);b(F),function(O,$,q,Y,it,at){const gt=q-it,yt=Y-at;return Math.abs((Y-$)*gt-(q-O)*yt)/Math.hypot(gt,yt)}(F.x,F.y,m.x,m.y,_.x,_.y)>=E?(le(n,t,r,P,R,m,F,b,E),le(n,P,R,l,u,F,_,b,E)):n.push(_)}function Me(n,t,r){let l=n[0],u=l.x,m=l.y;t(l);const _=[l];for(let b=1;b<n.length;b++){const E=n[b],{x:P,y:R}=E;t(E),le(_,u,m,P,R,l,E,t,r),u=P,m=R,l=E}return _}function ve(n,t,r,l){if(l(t,r)){const u=t.add(r)._mult(.5);ve(n,t,u,l),ve(n,u,r,l)}else n.push(r)}function Be(n,t){let r=n[0];const l=[r];for(let u=1;u<n.length;u++){const m=n[u];ve(l,r,m,t),r=m}return l}const oi=Math.pow(2,14)-1,ge=-oi-1;function ie(n,t){const r=Math.round(n.x*t),l=Math.round(n.y*t);return n.x=tt(r,ge,oi),n.y=tt(l,ge,oi),(r<n.x||r>n.x+1||l<n.y||l>n.y+1)&&Hi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function Oe(n,t,r){const l=n.loadGeometry(),u=n.extent,m=ri/u;if(t&&r&&r.projection.isReprojectedInTileSpace){const _=1<<t.z,{scale:b,x:E,y:P,projection:R}=r,F=O=>{const $=Mt((t.x+O.x/u)/_),q=vt((t.y+O.y/u)/_),Y=R.project($,q);O.x=(Y.x*b-E)*u,O.y=(Y.y*b-P)*u};for(let O=0;O<l.length;O++)if(n.type!==1)l[O]=Me(l[O],F,1);else{const $=[];for(const q of l[O])q.x<0||q.x>=u||q.y<0||q.y>=u||(F(q),$.push(q));l[O]=$}}for(const _ of l)for(const b of _)ie(b,m);return l}function Te(n,t){return{type:n.type,id:n.id,properties:n.properties,geometry:t?Oe(n):[]}}class qe{constructor(t,r,l,u,m){this.properties={},this.extent=l,this.type=0,this.id=void 0,this._pbf=t,this._geometry=-1,this._keys=u,this._values=m,t.readFields(si,this,r)}loadGeometry(){const t=this._pbf;t.pos=this._geometry;const r=t.readVarint()+t.pos,l=[];let u,m=1,_=0,b=0,E=0;for(;t.pos<r;){if(_<=0){const P=t.readVarint();m=7&P,_=P>>3}if(_--,m===1||m===2)b+=t.readSVarint(),E+=t.readSVarint(),m===1&&(u&&l.push(u),u=[]),u&&u.push(new Ae(b,E));else{if(m!==7)throw new Error(`unknown command ${m}`);u&&u.push(u[0].clone())}}return u&&l.push(u),l}bbox(){const t=this._pbf;t.pos=this._geometry;const r=t.readVarint()+t.pos;let l=1,u=0,m=0,_=0,b=1/0,E=-1/0,P=1/0,R=-1/0;for(;t.pos<r;){if(u<=0){const F=t.readVarint();l=7&F,u=F>>3}if(u--,l===1||l===2)m+=t.readSVarint(),_+=t.readSVarint(),m<b&&(b=m),m>E&&(E=m),_<P&&(P=_),_>R&&(R=_);else if(l!==7)throw new Error(`unknown command ${l}`)}return[b,P,E,R]}toGeoJSON(t,r,l){const u=this.extent*Math.pow(2,l),m=this.extent*t,_=this.extent*r,b=this.loadGeometry();function E(O){return[360*(O.x+m)/u-180,360/Math.PI*Math.atan(Math.exp((1-2*(O.y+_)/u)*Math.PI))-90]}function P(O){return O.map(E)}let R;if(this.type===1){const O=[];for(const q of b)O.push(q[0]);const $=P(O);R=O.length===1?{type:"Point",coordinates:$[0]}:{type:"MultiPoint",coordinates:$}}else if(this.type===2){const O=b.map(P);R=O.length===1?{type:"LineString",coordinates:O[0]}:{type:"MultiLineString",coordinates:O}}else{if(this.type!==3)throw new Error("unknown feature type");{const O=function(q){const Y=q.length;if(Y<=1)return[q];const it=[];let at,gt;for(let yt=0;yt<Y;yt++){const At=Li(q[yt]);At!==0&&(gt===void 0&&(gt=At<0),gt===At<0?(at&&it.push(at),at=[q[yt]]):at&&at.push(q[yt]))}return at&&it.push(at),it}(b),$=[];for(const q of O)$.push(q.map(P));R=$.length===1?{type:"Polygon",coordinates:$[0]}:{type:"MultiPolygon",coordinates:$}}}const F={type:"Feature",geometry:R,properties:this.properties};return this.id!=null&&(F.id=this.id),F}}function si(n,t,r){n===1?t.id=r.readVarint():n===2?function(l,u){const m=l.readVarint()+l.pos;for(;l.pos<m;){const _=u._keys[l.readVarint()],b=u._values[l.readVarint()];u.properties[_]=b}}(r,t):n===3?t.type=r.readVarint():n===4&&(t._geometry=r.pos)}function Li(n){let t=0;for(let r,l,u=0,m=n.length,_=m-1;u<m;_=u++)r=n[u],l=n[_],t+=(l.x-r.x)*(r.y+l.y);return t}qe.types=["Unknown","Point","LineString","Polygon"];class ni{constructor(t,r){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(li,this,r),this.length=this._features.length}feature(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];const r=this._pbf.readVarint()+this._pbf.pos;return new qe(this._pbf,r,this.extent,this._keys,this._values)}}function li(n,t,r){n===15?t.version=r.readVarint():n===1?t.name=r.readString():n===5?t.extent=r.readVarint():n===2?t._features.push(r.pos):n===3?t._keys.push(r.readString()):n===4&&t._values.push(function(l){let u=null;const m=l.readVarint()+l.pos;for(;l.pos<m;){const _=l.readVarint()>>3;u=_===1?l.readString():_===2?l.readFloat():_===3?l.readDouble():_===4?l.readVarint64():_===5?l.readVarint():_===6?l.readSVarint():_===7?l.readBoolean():null}if(u==null)throw new Error("unknown feature value");return u}(r))}class Fi{constructor(t,r){this.layers=t.readFields(Si,{},r)}}function Si(n,t,r){if(n===3){const l=new ni(r,r.readVarint()+r.pos);l.length&&(t[l.name]=l)}}const xi="3d_elevation_id",Ai="level";class Wi{constructor(){this._valid=!1}reset(t){return this.feature=t,this._valid=!0,this._geometry=t.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(t,r){return this._valid&&t(r(this._geometry)),this}require(t,r,l){return this.get(t,!0,r,l)}optional(t,r,l){return this.get(t,!1,r,l)}success(){return this._valid}get(t,r,l,u){const m=this.feature.properties.hasOwnProperty(t)?+this.feature.properties[t]:void 0;return this._valid&&m!==void 0&&!Number.isNaN(m)?l(u?u(m):m):r&&(this._valid=!1),this}}class Gr{constructor(t,r){this.featureFunc=t,this.vertexFunc=r}parseFeature(t,r,l){return this.featureFunc(t,r,l)}parseVertex(t,r,l){return this.vertexFunc(t,r,l)}}const en=new Gr((n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).optional("fixed_height_relative",l=>{r.constantHeight=l},ur.decodeRelativeHeight).geometry(l=>{r.bounds=l},Pd).success(),(n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).require("elevation_idx",l=>{r.idx=l}).require("extent",l=>{r.extent=l}).require("height_relative",l=>{r.height=l},ur.decodeRelativeHeight).geometry(l=>{r.position=l},ur.getPoint).success()),kn=new Gr((n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).optional("fixed_height",l=>{r.constantHeight=l},ur.decodeMetricHeight).geometry(l=>{r.bounds=l},Pd).success(),(n,t,r)=>n.reset(t).require(xi,l=>{r.id=l}).require("elevation_idx",l=>{r.idx=l}).require("extent",l=>{r.extent=l}).require("height",l=>{r.height=l},ur.decodeMetricHeight).geometry(l=>{r.position=l},ur.getPoint).success());class ur{static getPoint(t){return we(t[0][0].x,t[0][0].y)}static decodeRelativeHeight(t){return 1e-4*t*5}static decodeMetricHeight(t){return 1e-4*t}static getVersionSchema(t){return t?t==="1.0.1"?kn:void 0:en}static parse(t){const r=[],l=[],u=t.length,m=new Wi;for(let _=0;_<u;_++){const b=t.feature(_),E=b.properties.version,P=ur.getVersionSchema(E);if(P===void 0){Hi(`Unknown elevation feature version number ${E||"(unknown)"}`);continue}const R=b.properties.type;if(!R)continue;const F=qe.types[b.type];if(F==="Point"&&R==="curve_point"){const O={};P.parseVertex(m,b,O)&&r.push(O)}else if(F==="Polygon"&&R==="curve_meta"){const O={};P.parseFeature(m,b,O)&&l.push(O)}}return{vertices:r,features:l}}}class Kr{constructor(t,r){this.pos=t,this.dir=r}intersectsPlane(t,r,l){const u=Jt(r,this.dir);if(Math.abs(u)<1e-6)return!1;const m=((t[0]-this.pos[0])*r[0]+(t[1]-this.pos[1])*r[1])/u;return l[0]=this.pos[0]+this.dir[0]*m,l[1]=this.pos[1]+this.dir[1]*m,!0}}class Pr{constructor(t,r){this.pos=t,this.dir=r}intersectsPlane(t,r,l){const u=Xr(r,this.dir);if(Math.abs(u)<1e-6)return!1;const m=((t[0]-this.pos[0])*r[0]+(t[1]-this.pos[1])*r[1]+(t[2]-this.pos[2])*r[2])/u;return l[0]=this.pos[0]+this.dir[0]*m,l[1]=this.pos[1]+this.dir[1]*m,l[2]=this.pos[2]+this.dir[2]*m,!0}closestPointOnSphere(t,r,l){if(function($,q){var Y=$[0],it=$[1],at=$[2],gt=q[0],yt=q[1],At=q[2];return Math.abs(Y-gt)<=Le*Math.max(1,Math.abs(Y),Math.abs(gt))&&Math.abs(it-yt)<=Le*Math.max(1,Math.abs(it),Math.abs(yt))&&Math.abs(at-At)<=Le*Math.max(1,Math.abs(at),Math.abs(At))}(this.pos,t)||r===0)return l[0]=l[1]=l[2]=0,!1;const[u,m,_]=this.dir,b=this.pos[0]-t[0],E=this.pos[1]-t[1],P=this.pos[2]-t[2],R=u*u+m*m+_*_,F=2*(b*u+E*m+P*_),O=F*F-4*R*(b*b+E*E+P*P-r*r);if(O<0){const $=Math.max(-F/2,0),q=b+u*$,Y=E+m*$,it=P+_*$,at=Math.hypot(q,Y,it);return l[0]=q*r/at,l[1]=Y*r/at,l[2]=it*r/at,!1}{const $=(-F-Math.sqrt(O))/(2*R);if($<0){const q=Math.hypot(b,E,P);return l[0]=b*r/q,l[1]=E*r/q,l[2]=P*r/q,!1}return l[0]=b+u*$,l[1]=E+m*$,l[2]=P+_*$,!0}}}class Mn{constructor(t,r,l,u,m){this.TL=t,this.TR=r,this.BR=l,this.BL=u,this.horizon=m}static fromInvProjectionMatrix(t,r,l){const u=[-1,1,1],m=[1,1,1],_=[1,-1,1],b=[-1,-1,1],E=On(u,u,t),P=On(m,m,t),R=On(_,_,t),F=On(b,b,t);return new Mn(E,P,R,F,r/l)}}function Yr(n,t,r){let l=1/0,u=-1/0;const m=[];for(const _ of n){oo(m,_,t);const b=Xr(m,r);l=Math.min(l,b),u=Math.max(u,b)}return[l,u]}function Zn(n,t){let r=!0;for(let l=0;l<n.planes.length;l++){const u=n.planes[l];let m=0;for(let _=0;_<t.length;_++)m+=+(Xr(u,t[_])+u[3]>=0);if(m===0)return 0;m!==t.length&&(r=!1)}return r?2:1}function an(n,t){for(const r of n.projections){const l=Yr(t,n.points[0],r.axis);if(r.projection[1]<l[0]||r.projection[0]>l[1])return 0}return 1}function Mr(n,t){let r=0;const l=[0,0,0,0];for(let _=0;_<n.length;_++)l[0]=n[_][0],l[1]=n[_][1],l[2]=n[_][2],l[3]=1,(u=l)[0]*(m=t)[0]+u[1]*m[1]+u[2]*m[2]+u[3]*m[3]>=0&&r++;var u,m;return r}class _n{constructor(t,r){this.points=t||new Array(8).fill([0,0,0]),this.planes=r||new Array(6).fill([0,0,0,0]),this.bounds=Lr.fromPoints(this.points),this.projections=[],this.frustumEdges=[oo([],this.points[2],this.points[3]),oo([],this.points[0],this.points[3]),oo([],this.points[4],this.points[0]),oo([],this.points[5],this.points[1]),oo([],this.points[6],this.points[2]),oo([],this.points[7],this.points[3])];for(const l of this.frustumEdges){const u=[0,-l[2],l[1]],m=[l[2],0,-l[0]];this.projections.push({axis:u,projection:Yr(this.points,this.points[0],u)}),this.projections.push({axis:m,projection:Yr(this.points,this.points[0],m)})}}static fromInvProjectionMatrix(t,r,l,u){const m=Math.pow(2,l),_=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(P=>{const R=bs([],P,t),F=1/R[3]/r*m;return(O=R)[0]=($=R)[0]*(q=[F,F,u?1/R[3]:F,F])[0],O[1]=$[1]*q[1],O[2]=$[2]*q[2],O[3]=$[3]*q[3],O;var O,$,q}),b=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(P=>{const R=Xi([],$n([],oo([],_[P[0]],_[P[1]]),oo([],_[P[2]],_[P[1]]))),F=-Xr(R,_[P[1]]);return R.concat(F)}),E=[];for(let P=0;P<_.length;P++)E.push([_[P][0],_[P][1],_[P][2]]);return new _n(E,b)}intersectsPrecise(t,r,l){for(let u=0;u<r.length;u++)if(!Mr(t,r[u]))return 0;for(let u=0;u<this.planes.length;u++)if(!Mr(t,this.planes[u]))return 0;for(const u of l)for(const m of this.frustumEdges){const _=$n([],u,m),b=cs(_);if(b===0)continue;Hn(_,_,1/b);const E=Yr(this.points,this.points[0],_),P=Yr(t,this.points[0],_);if(E[0]>P[1]||P[0]>E[1])return 0}return 1}containsPoint(t){for(const r of this.planes){const l=r[3];if(Xr([r[0],r[1],r[2]],t)+l<0)return!1}return!0}}class Lr{static fromPoints(t){const r=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(const u of t)vs(r,r,u),Ps(l,l,u);return new Lr(r,l)}static fromTileIdAndHeight(t,r,l){const u=1<<t.canonical.z,m=t.canonical.x,_=t.canonical.y;return new Lr([m/u,_/u,r],[(m+1)/u,(_+1)/u,l])}static applyTransform(t,r){const l=t.getCorners();for(let u=0;u<l.length;++u)On(l[u],l[u],r);return Lr.fromPoints(l)}static applyTransformFast(t,r){const l=[r[12],r[13],r[14]],u=[...l];for(let m=0;m<3;m++)for(let _=0;_<3;_++){const b=r[4*_+m],E=b*t.min[_],P=b*t.max[_];l[m]+=Math.min(E,P),u[m]+=Math.max(E,P)}return new Lr(l,u)}static projectAabbCorners(t,r){const l=t.getCorners();for(let u=0;u<l.length;++u)On(l[u],l[u],r);return l}constructor(t,r){this.min=t,this.max=r,this.center=Hn([],Co([],this.min,this.max),.5)}quadrant(t){const r=[t%2==0,t<2],l=sc(this.min),u=sc(this.max);for(let m=0;m<r.length;m++)l[m]=r[m]?this.min[m]:this.center[m],u[m]=r[m]?this.center[m]:this.max[m];return u[2]=this.max[2],new Lr(l,u)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,r=this.max;return[[t[0],t[1],t[2]],[r[0],t[1],t[2]],[r[0],r[1],t[2]],[t[0],r[1],t[2]],[t[0],t[1],r[2]],[r[0],t[1],r[2]],[r[0],r[1],r[2]],[t[0],r[1],r[2]]]}intersects(t){return this.intersectsAabb(t.bounds)?Zn(t,this.getCorners()):0}intersectsFlat(t){return this.intersectsAabb(t.bounds)?Zn(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(t,r){return r||this.intersects(t)?an(t,this.getCorners()):0}intersectsPreciseFlat(t,r){return r||this.intersectsFlat(t)?an(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(t){for(let r=0;r<3;++r)if(this.min[r]>t.max[r]||t.min[r]>this.max[r])return!1;return!0}intersectsAabbXY(t){return!(this.min[0]>t.max[0]||t.min[0]>this.max[0]||this.min[1]>t.max[1]||t.min[1]>this.max[1])}encapsulate(t){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],t.min[r]),this.max[r]=Math.max(this.max[r],t.max[r])}encapsulatePoint(t){for(let r=0;r<3;r++)this.min[r]=Math.min(this.min[r],t[r]),this.max[r]=Math.max(this.max[r],t[r])}closestPoint(t){return[Math.max(Math.min(this.max[0],t[0]),this.min[0]),Math.max(Math.min(this.max[1],t[1]),this.min[1]),Math.max(Math.min(this.max[2],t[2]),this.min[2])]}}Ei(Lr,"Aabb");class fo{constructor(t,r){this.feature=t,this.metersToTile=r,this.index=0}get(){const t=this.feature.vertices[this.index],r=this.feature.vertexProps[this.index].dir,l=r[1],u=-r[0],m=(t.extent+1)*this.metersToTile;return[new Ae(Math.trunc(t.position[0]+l*m),Math.trunc(t.position[1]+u*m)),new Ae(Math.trunc(t.position[0]-l*m),Math.trunc(t.position[1]-u*m))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class yn{constructor(t,r,l,u,m,_){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[so(),so(),so(),so(),so(),so(),so()],this.id=t,this.heightRange={min:l,max:l},this.safeArea=r,this.constantHeight=l,this.constantHeight==null&&(this.constantHeight!=null||u.length!==0)){this.vertices=u,this.edges=m,this.edges=this.edges.filter(b=>{return b.a<this.vertices.length&&b.b<this.vertices.length&&!((E=this.vertices[b.a].position)[0]===(P=this.vertices[b.b].position)[0]&&E[1]===P[1]);var E,P}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const b of this.vertices)this.vertexProps.push({dir:we(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,b.height),this.heightRange.max=Math.max(this.heightRange.max,b.height);for(const b of this.edges){const E=this.vertices[b.a].position,P=this.vertices[b.b].position,R=Nt(so(),P,E),F=ae(R),O=ce(so(),R,1/F);this.edgeProps.push({vec:R,dir:O,len:F});const $=this.vertexProps[b.a].dir,q=this.vertexProps[b.b].dir;Pt($,$,O),Pt(q,q,O)}for(const b of this.vertexProps)b.dir[0]===0&&b.dir[1]===0||Fe(b.dir,b.dir);this.tessellate(_)}}pointElevation(t){if(this.constantHeight!=null)return this.constantHeight;const r=this.getClosestEdge(t);if(r==null)return 0;const[l,u]=r;return Gi(this.vertices[this.edges[l].a].height,this.vertices[this.edges[l].b].height,u)}computeSlopeNormal(t,r){const l=this.getClosestEdge(t);if(!l)return Kn(0,0,1);const u=l[0],m=this.edges[u],_=this.edgeProps[u].vec,b=Kn(_[0],_[1],(this.vertices[m.b].height-this.vertices[m.a].height)*r),E=Kn(b[1],-b[0],0);$n(E,E,b);const P=cs(E);return P>0?Hn(E,E,1/P):hn(E,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(t){if(this.edges.length===0)return;let r=0,l=Number.POSITIVE_INFINITY,u=0;const[m,_,b,E,P,R,F]=this._tmpVec2;St(F,t.x,t.y);const O=new Kr(F,null);for(let $=0;$<this.edges.length;$++){const q=this.edges[$],Y=this.edgeProps[$].dir;O.dir=Y;const it=this.vertices[q.a].position,at=this.vertices[q.b].position,gt=O.intersectsPlane(it,this.vertexProps[q.a].dir,m),yt=O.intersectsPlane(at,this.vertexProps[q.b].dir,_);if(!gt||!yt)continue;Nt(b,_,m),Nt(E,F,m);const At=Jt(b,b),Gt=At>0?Jt(E,b)/At:0,kt=tt(Gt,0,1),Xt=Math.abs((Gt-kt)*this.edgeProps[$].len);Nt(P,F,it),St(R,Y[1],-Y[0]);const te=Xt+Math.abs(Jt(P,R));te<l&&(r=$,l=te,u=kt)}return[r,u]}tessellate(t){const r=Hr(),l=Hr(),u=Hr(),m=Hr();for(let _=this.edges.length-1;_>=0;--_){const b=this.edges[_].a,E=this.edges[_].b,{position:P,height:R,extent:F}=this.vertices[b],{position:O,height:$,extent:q}=this.vertices[E],Y=this.vertexProps[b].dir,it=this.vertexProps[E].dir;if(hn(r,P[0]/t,P[1]/t,R),hn(l,O[0]/t,O[1]/t,$),hn(u,Y[1],-Y[0],0),Hn(u,u,F),hn(m,it[1],-it[0],0),Hn(m,m,q),this.distSqLines(Kn(r[0]+.5*u[0],r[1]+.5*u[1],r[2]+.5*u[2]),Kn(l[0]-.5*m[0],l[1]-.5*m[1],l[2]-.5*m[2]),Kn(r[0]-.5*u[0],r[1]-.5*u[1],r[2]-.5*u[2]),Kn(l[0]+.5*m[0],l[1]+.5*m[1],l[2]+.5*m[2]))<=.0025000000000000005)continue;const at=this.vertices.length,gt=Pt(so(),P,O);this.vertices.push({position:ce(gt,gt,.5),height:.5*(R+$),extent:.5*(F+q)});const yt=Pt(so(),Y,it);this.vertexProps.push({dir:Fe(yt,yt)}),this.edges.splice(_,1),this.edgeProps.splice(_,1),this.edges.push({a:b,b:at}),this.edges.push({a:at,b:E});const At=Nt(so(),this.vertices[at].position,P),Gt=ae(At),kt={vec:At,dir:ce(so(),At,1/Gt),len:Gt};this.edgeProps.push(kt),this.edgeProps.push(kt)}}distSqLines(t,r,l,u){const m=zn(Hr(),r,t),_=zn(Hr(),u,l),b=zn(Hr(),t,l),E=Xr(m,m),P=Xr(m,_),R=Xr(m,b),F=Xr(_,_),O=Xr(_,b),$=E*F-P*P;if($===0)return fr(qo(m,l,u,Xr(b,_)/Xr(_,_)),t);const q=(E*O-P*R)/$;return fr(qo(m,t,r,(P*O-R*F)/$),qo(_,l,u,q))}}class mr{static parseFrom(t,r){const l=ur.parse(t);if(!l)return[];let{vertices:u,features:m}=l;const _=1/Zt(r);m.sort((R,F)=>R.id-F.id),u.sort((R,F)=>R.id-F.id||R.idx-F.idx),u=u.filter((R,F,O)=>F===O.findIndex($=>$.id===R.id&&$.idx===R.idx));const b=new Array;let E=0;const P=u.length;for(const R of m){if(R.constantHeight){b.push(new yn(R.id,R.bounds,R.constantHeight));continue}for(;E!==P&&u[E].id<R.id;)E++;if(E===P||u[E].id!==R.id)continue;const F=new Array,O=new Array,$=E;for(;E!==P&&u[E].id===R.id;){const q=u[E];if(F.push({position:q.position,height:q.height,extent:q.extent}),E!==$&&u[E-1].idx===q.idx-1){const Y=E-$;O.push({a:Y-1,b:Y})}E++}b.push(new yn(R.id,R.bounds,void 0,F,O,_))}return b}static getElevationFeature(t,r){if(!r)return;const l=+t.properties[xi];return Number.isNaN(l)?void 0:r.find(u=>u.id===l)}}class nn{constructor(t,r){this.zScale=1,this.xOffset=0,this.yOffset=0,t.equals(r)||(this.zScale=Math.pow(2,r.z-t.z),this.xOffset=(t.x*this.zScale-r.x)*ri,this.yOffset=(t.y*this.zScale-r.y)*ri)}constantElevation(t,r){if(t.constantHeight!=null)return this.computeBiasedHeight(t.constantHeight,r)}pointElevation(t,r,l){const u=this.constantElevation(r,l);return u??(t.x=t.x*this.zScale+this.xOffset,t.y=t.y*this.zScale+this.yOffset,this.computeBiasedHeight(r.pointElevation(t),l))}computeBiasedHeight(t,r){return r<=0?t:t+r*wt(0,r,t>=0?t:Math.abs(.5*t))}}Ei(yn,"ElevationFeature");class So{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new As,this.indexArray=new ro,this.segments=new To,this.programConfigurations=new _h(t.layers,{zoom:t.zoom,lut:t.lut}),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new $s),this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){const m=this.layers[0],_=[];let b=null;m.type==="circle"&&(b=m.layout.get("circle-sort-key"));for(const{feature:P,id:R,index:F,sourceLayerIndex:O}of t){const $=this.layers[0]._featureFilter.needGeometry,q=Te(P,$);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),q,l))continue;const Y=b?b.evaluate(q,{},l):void 0,it={id:R,properties:P.properties,type:P.type,sourceLayerIndex:O,index:F,geometry:$?q.geometry:Oe(P,l,u),patterns:{},sortKey:Y};_.push(it)}b&&_.sort((P,R)=>P.sortKey-R.sortKey);let E=null;u.projection.name==="globe"&&(this.globeExtVertexArray=new ys,E=u.projection);for(const P of _){const{geometry:R,index:F,sourceLayerIndex:O}=P,$=t[F].feature;this.addFeature(P,R,F,r.availableImages,l,E,r.brightness,r.elevationFeatures),r.featureIndex.insert($,R,F,O,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(t,r,l,u,m,_,b){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,xg.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,vg.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=t.createVertexBuffer(this.elevatedLayoutVertexArray,g_.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(t,r,l,u,m,_,b,E){let P;this.elevationMode!=="none"&&(P=mr.getElevationFeature(t,E));for(const R of r)for(const F of R){const O=F.x,$=F.y;if(O<0||O>=ri||$<0||$>=ri)continue;if(_){const it=_.projectTilePoint(O,$,m),at=_.upVector(m,O,$);this.addGlobeExtVertex(it,at),this.addGlobeExtVertex(it,at),this.addGlobeExtVertex(it,at),this.addGlobeExtVertex(it,at)}const q=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),Y=q.vertexLength;if(this.addCircleVertex(O,$,-1,-1),this.addCircleVertex(O,$,1,-1),this.addCircleVertex(O,$,1,1),this.addCircleVertex(O,$,-1,1),this.elevationMode!=="none"){const it=P?P.pointElevation(new Ae(O,$)):0;this.hasElevation=this.hasElevation||it!==0;for(let at=0;at<4;at++)this.elevatedLayoutVertexArray.emplaceBack(it)}this.indexArray.emplaceBack(Y,Y+1,Y+2),this.indexArray.emplaceBack(Y,Y+2,Y+3),q.vertexLength+=4,q.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,l,{},u,m,b,void 0,this.worldview)}addCircleVertex(t,r,l,u){this.layoutVertexArray.emplaceBack(2*t+(l+1)/2,2*r+(u+1)/2)}addGlobeExtVertex(t,r){this.globeExtVertexArray.emplaceBack(t.x,t.y,t.z,r[0]*16384,r[1]*16384,r[2]*16384)}}function Yo(n,t){for(let r=0;r<n.length;r++)if(qs(t,n[r]))return!0;for(let r=0;r<t.length;r++)if(qs(n,t[r]))return!0;return!!fa(n,t)}function Ro(n,t,r){return!!qs(n,t)||!!ma(t,n,r)}function jo(n,t){if(n.length===1)return bc(t,n[0]);for(let r=0;r<t.length;r++){const l=t[r];for(let u=0;u<l.length;u++)if(qs(n,l[u]))return!0}for(let r=0;r<n.length;r++)if(bc(t,n[r]))return!0;for(let r=0;r<t.length;r++)if(fa(n,t[r]))return!0;return!1}function Io(n,t,r){if(n.length>1){if(fa(n,t))return!0;for(let l=0;l<t.length;l++)if(ma(t[l],n,r))return!0}for(let l=0;l<n.length;l++)if(ma(n[l],t,r))return!0;return!1}function fa(n,t){if(n.length===0||t.length===0)return!1;for(let r=0;r<n.length-1;r++){const l=n[r],u=n[r+1];for(let m=0;m<t.length-1;m++)if(Pa(l,u,t[m],t[m+1]))return!0}return!1}function Pa(n,t,r,l){return gr(n,r,l)!==gr(t,r,l)&&gr(n,t,r)!==gr(n,t,l)}function Va(n,t,r){return(n.x-r.x)*(t.y-r.y)-(n.y-r.y)*(t.x-r.x)}function ic(n,t,r,l){const u=Va(n,t,l),m=Va(n,t,r);if(Math.sign(u)===Math.sign(m))return;const _=Va(r,l,n),b=_+m-u;return Math.sign(_)!==Math.sign(b)?[_/(_-b),m/(m-u)]:void 0}function ma(n,t,r){const l=r*r;if(t.length===1)return n.distSqr(t[0])<l;for(let u=1;u<t.length;u++)if(vc(n,t[u-1],t[u])<l)return!0;return!1}function vc(n,t,r){const l=t.distSqr(r);if(l===0)return n.distSqr(t);const u=((n.x-t.x)*(r.x-t.x)+(n.y-t.y)*(r.y-t.y))/l;return n.distSqr(u<0?t:u>1?r:r.sub(t)._mult(u)._add(t))}function bc(n,t){let r,l,u,m=!1;for(let _=0;_<n.length;_++){r=n[_];for(let b=0,E=r.length-1;b<r.length;E=b++)l=r[b],u=r[E],l.y>t.y!=u.y>t.y&&t.x<(u.x-l.x)*(t.y-l.y)/(u.y-l.y)+l.x&&(m=!m)}return m}function qs(n,t){let r=!1;for(let l=0,u=n.length-1;l<n.length;u=l++){const m=n[l],_=n[u];m.y>t.y!=_.y>t.y&&t.x<(_.x-m.x)*(t.y-m.y)/(_.y-m.y)+m.x&&(r=!r)}return r}function mo(n,t,r,l,u){for(const _ of n)if(t<=_.x&&r<=_.y&&l>=_.x&&u>=_.y)return!0;const m=[new Ae(t,r),new Ae(t,u),new Ae(l,u),new Ae(l,r)];if(n.length>2){for(const _ of m)if(qs(n,_))return!0}for(let _=0;_<n.length-1;_++)if(Go(n[_],n[_+1],m))return!0;return!1}function Go(n,t,r){const l=r[0],u=r[2];if(n.x<l.x&&t.x<l.x||n.x>u.x&&t.x>u.x||n.y<l.y&&t.y<l.y||n.y>u.y&&t.y>u.y)return!1;const m=gr(n,t,r[0]);return m!==gr(n,t,r[1])||m!==gr(n,t,r[2])||m!==gr(n,t,r[3])}function jn(n,t,r,l,u,m){let _=t.y-n.y,b=n.x-t.x;if(m=m||0){const E=_*_+b*b;if(E===0)return!0;const P=Math.sqrt(E);_/=P,b/=P}return!((r.x-n.x)*_+(r.y-n.y)*b-m<0||(l.x-n.x)*_+(l.y-n.y)*b-m<0||(u.x-n.x)*_+(u.y-n.y)*b-m<0)}function Qo(n,t,r,l,u,m,_){return!(jn(n,t,l,u,m,_)||jn(t,r,l,u,m,_)||jn(r,n,l,u,m,_)||jn(l,u,n,t,r,_)||jn(u,m,n,t,r,_)||jn(m,l,n,t,r,_))}function Ls(n,t,r){const l=t.paint.get(n).value;return l.kind==="constant"?l.value:r.programConfigurations.get(t.id).getMaxValue(n)}function go(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function rc(n,t,r,l,u){if(!t[0]&&!t[1])return n;const m=Ae.convert(t)._mult(u);r==="viewport"&&m._rotate(-l);const _=[];for(let b=0;b<n.length;b++)_.push(n[b].sub(m));return _}function Up(n,t,r,l){const u=Ae.convert(n)._mult(l);return t==="viewport"&&u._rotate(-r),u}let Du,jp;function Gp(n,t,r){var l=2*Math.PI*6378137/256/Math.pow(2,r);return[n*l-2*Math.PI*6378137/2,t*l-2*Math.PI*6378137/2]}Ei(So,"CircleBucket",{omit:["layers"]});class wc{constructor(t,r,l){this.z=t,this.x=r,this.y=l,this.key=Tc(0,t,t,r,l)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}isChildOf(t){const r=this.z-t.z;return t.z===0||t.z<this.z&&t.x===this.x>>r&&t.y===this.y>>r}url(t,r){const l=function(m,_,b){var E=Gp(256*m,256*(_=Math.pow(2,b)-_-1),b),P=Gp(256*(m+1),256*(_+1),b);return E[0]+","+E[1]+","+P[0]+","+P[1]}(this.x,this.y,this.z),u=function(m,_,b){let E,P="";for(let R=m;R>0;R--)E=1<<R-1,P+=(_&E?1:0)+(b&E?2:0);return P}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(r==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",u).replace("{bbox-epsg-3857}",l)}toString(){return`${this.z}/${this.x}/${this.y}`}}class eu{constructor(t,r){this.wrap=t,this.canonical=r,this.key=Tc(t,r.z,r.z,r.x,r.y)}}class Zs{constructor(t,r,l,u,m){this.overscaledZ=t,this.wrap=r,this.canonical=new wc(l,+u,+m),this.key=r===0&&t===l?this.canonical.key:Tc(r,t,l,u,m)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const r=this.canonical.z-t;return t>this.canonical.z?new Zs(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Zs(t,this.wrap,t,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(t,r=!0){if(this.overscaledZ===t&&r)return this.key;if(t>this.canonical.z)return Tc(this.wrap*+r,t,this.canonical.z,this.canonical.x,this.canonical.y);{const l=this.canonical.z-t;return Tc(this.wrap*+r,t,t,this.canonical.x>>l,this.canonical.y>>l)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const r=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.z<this.canonical.z&&t.canonical.x===this.canonical.x>>r&&t.canonical.y===this.canonical.y>>r}children(t){if(this.overscaledZ>=t)return[new Zs(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,l=2*this.canonical.x,u=2*this.canonical.y;return[new Zs(r,this.wrap,r,l,u),new Zs(r,this.wrap,r,l+1,u),new Zs(r,this.wrap,r,l,u+1),new Zs(r,this.wrap,r,l+1,u+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new Zs(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new Zs(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new eu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Tc(n,t,r,l,u){const m=1<<Math.min(r,22);let _=m*(u%m)+l%m;return n&&r<22&&(_+=m*m*((n<0?-2*n-1:2*n)%(1<<2*(22-r)))),16*(32*_+r)+(t-r)}const Xd=[n=>{let t=n.canonical.x-1,r=n.wrap;return t<0&&(t=(1<<n.canonical.z)-1,r--),new Zs(n.overscaledZ,r,n.canonical.z,t,n.canonical.y)},n=>{let t=n.canonical.x+1,r=n.wrap;return t===1<<n.canonical.z&&(t=0,r++),new Zs(n.overscaledZ,r,n.canonical.z,t,n.canonical.y)},n=>new Zs(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new Zs(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];Ei(wc,"CanonicalTileID"),Ei(Zs,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Sg=Er([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:rm}=Sg,rx=Er([{name:"a_pos_3",components:3,type:"Int16"}]);var b_=Er([{name:"a_pos",type:"Int16",components:2}]);function nm(n){return n*Tl/N}const Ly=[new Lr([w,w,w],[I,I,I]),new Lr([w,w,w],[0,0,I]),new Lr([0,w,w],[I,0,I]),new Lr([w,0,w],[0,I,I]),new Lr([0,0,w],[I,I,I])];function Yd(n,t,r,l=!0){const u=Hn([],n._camera.position,n.worldSize),m=[t,r,1,1];bs(m,m,n.pixelMatrixInverse),wa(m,m,1/m[3]);const _=Xi([],oo([],m,u)),b=n.globeMatrix,E=[b[12],b[13],b[14]],P=oo([],E,u),R=cs(P),F=Xi([],P),O=n.worldSize/(2*Math.PI),$=Xr(F,_),q=Math.asin(O/R);if(q<Math.acos($)){if(!l)return null;const ze=[],fe=[];Hn(ze,_,R/$),Xi(fe,oo(fe,ze,P)),Xi(_,Co(_,P,Hn(_,fe,Math.tan(q)*R)))}const Y=[];new Pr(u,_).closestPointOnSphere(E,O,Y);const it=Xi([],ao(b,0)),at=Xi([],ao(b,1)),gt=Xi([],ao(b,2)),yt=Xr(it,Y),At=Xr(at,Y),Gt=Xr(gt,Y),kt=bi(Math.asin(-At/O));let Xt=bi(Math.atan2(yt,Gt));Xt=n.center.lng+function(ze,fe){const ke=(fe-ze+180)%360-180;return ke<-180?ke+360:ke}(n.center.lng,Xt);const te=ht(Xt),ne=tt(lt(kt),0,1);return new pe(te,ne)}class Ig{constructor(t,r,l){this.a=oo([],t,l),this.b=oo([],r,l),this.center=l;const u=Xi([],this.a),m=Xi([],this.b);this.angle=Math.acos(Xr(u,m))}}function jm(n,t){if(n.angle===0)return null;let r;return r=n.a[t]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[t]/n.a[t]/Math.sin(n.angle)-1/Math.tan(n.angle)),r<0||r>1?null:function(l,u,m,_){const b=Math.sin(m);return l*(Math.sin((1-_)*m)/b)+u*(Math.sin(_*m)/b)}(n.a[t],n.b[t],n.angle,tt(r,0,1))+n.center[t]}function md(n){if(n.z<=1)return Ly[n.z+2*n.y+n.x];const t=w_(Eg(n));return Lr.fromPoints(t)}function gd(n,t,r){return Hn(n,n,1-r),di(n,n,t,r)}function Ry(n,t,r){for(const l of n)On(l,l,t),Hn(l,l,r)}function ky(n,t,r,l){const u=t/n.worldSize,m=n.globeMatrix;if(r.z<=1){const ne=md(r).getCorners();return Ry(ne,m,u),Lr.fromPoints(ne)}const _=Eg(r,l),b=w_(_,Tl+nm(n._tileCoverLift));Ry(b,m,u);const E=Number.MAX_VALUE,P=[-E,-E,-E],R=[E,E,E];if(_.contains(n.center)){for(const fe of b)vs(R,R,fe),Ps(P,P,fe);P[2]=0;const ne=n.point,ze=[ne.x*u,ne.y*u,0];return vs(R,R,ze),Ps(P,P,ze),new Lr(R,P)}if(n._tileCoverLift>0){for(const ne of b)vs(R,R,ne),Ps(P,P,ne);return new Lr(R,P)}const F=[m[12]*u,m[13]*u,m[14]*u],O=_.getCenter(),$=tt(n.center.lat,-Ct,Ct),q=tt(O.lat,-Ct,Ct),Y=ht(n.center.lng),it=lt($);let at=Y-ht(O.lng);const gt=it-lt(q);at>.5?at-=1:at<-.5&&(at+=1);let yt=0;Math.abs(at)>Math.abs(gt)?yt=at>=0?1:3:(yt=gt>=0?0:2,di(F,F,[m[4]*u,m[5]*u,m[6]*u],-Math.sin(ar(gt>=0?_.getSouth():_.getNorth()))*Tl));const At=b[yt],Gt=b[(yt+1)%4],kt=new Ig(At,Gt,F),Xt=[jm(kt,0)||At[0],jm(kt,1)||At[1],jm(kt,2)||At[2]],te=zu(n.zoom);if(te>0){const ne=function({x:fe,y:ke,z:Ue},Ze,hi,Ke,je){const Ye=1/(1<<Ue);let Pe=fe*Ye,Ie=Pe+Ye,He=ke*Ye,ai=He+Ye,Ge=0;const Pi=(Pe+Ie)/2-Ke;return Pi>.5?Ge=-1:Pi<-.5&&(Ge=1),Pe=((Pe+Ge)*Ze-(Ke*=Ze))*hi+Ke,Ie=((Ie+Ge)*Ze-Ke)*hi+Ke,He=(He*Ze-(je*=Ze))*hi+je,ai=(ai*Ze-je)*hi+je,[[Pe,ai,0],[Ie,ai,0],[Ie,He,0],[Pe,He,0]]}(r,t,n._pixelsPerMercatorPixel,Y,it);for(let fe=0;fe<b.length;fe++)gd(b[fe],ne[fe],te);const ze=Co([],ne[yt],ne[(yt+1)%4]);Hn(ze,ze,.5),gd(Xt,ze,te)}for(const ne of b)vs(R,R,ne),Ps(P,P,ne);return R[2]=Math.min(At[2],Gt[2]),vs(R,R,Xt),Ps(P,P,Xt),new Lr(R,P)}function Eg({x:n,y:t,z:r},l=!1){const u=1/(1<<r),m=new Z(Mt(n*u),t===(1<<r)-1&&l?-90:vt((t+1)*u)),_=new Z(Mt((n+1)*u),t===0&&l?90:vt(t*u));return new U(m,_)}function w_(n,t=Tl){const r=ar(n.getNorth()),l=ar(n.getSouth()),u=Math.cos(r),m=Math.cos(l),_=Math.sin(r),b=Math.sin(l),E=n.getWest(),P=n.getEast();return[M(m,b,E,t),M(m,b,P,t),M(u,_,P,t),M(u,_,E,t)]}function Gm(n,t,r,l){const u=1<<r.z,m=(n/ri+r.x)/u;return L(vt((t/ri+r.y)/u),Mt(m),l)}function $m({min:n,max:t}){return a/Math.max(t[0]-n[0],t[1]-n[1],t[2]-n[2])}const T_=new Float64Array(16);function iu(n){const t=$m(n),r=ba(T_,[t,t,t]);return $r(r,r,qr([],n.min))}function _d(n){const t=(l=n.min,(r=T_)[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=l[0],r[13]=l[1],r[14]=l[2],r[15]=1,r);var r,l;const u=1/$m(n);return En(t,t,[u,u,u])}function Ag(n){const t=ri/(2*Math.PI);return n/(2*Math.PI)/t}function Pg(n,t){return ri/(512*Math.pow(2,n))*$m(md(t))}function Fy(n,t,r,l,u){const m=Ag(r),_=[n,t,-r/(2*Math.PI)],b=Re(new Float64Array(16));return $r(b,b,_),En(b,b,[m,m,m]),$o(b,b,ar(-u)),no(b,b,ar(-l)),b}function zu(n){return wt(p,e,n)}function Mg(n,t){const r=L(t.lat,t.lng),l=function(q){const Y=L(q._center.lat,q._center.lng);let it=$n([],Kn(0,1,0),Y);const at=Os([],-q.angle,Y);it=On(it,it,at),Os(at,-q._pitch,it);const gt=Xi([],Y);return Hn(gt,gt,nm(q.cameraToCenterDistance/q.pixelsPerMeter)),On(gt,gt,at),Co([],Y,gt)}(n);return _=(u=zn([],l,r))[0],b=u[1],E=u[2],P=(m=r)[0],R=m[1],F=m[2],$=(O=Math.sqrt((_*_+b*b+E*E)*(P*P+R*R+F*F)))&&Xr(u,m)/O,Math.acos(Math.min(Math.max($,-1),1));var u,m,_,b,E,P,R,F,O,$}function S_(n,t){return Mg(n,t)>Math.PI/2*1.01}const Cg=ar(85),I_=Math.cos(Cg),om=Math.sin(Cg),By=xr(),E_=n=>{const t=[];return n.paint.get("circle-pitch-alignment")==="map"&&t.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&t.push("SCALE_WITH_MAP"),t};function Dg(n,t,r,l,u,m,_,b,E){if(m&&n.queryGeometry.isAboveHorizon)return!1;m&&(E*=n.pixelToTileUnitsFactor);const P=n.tileID.canonical,R=r.projection.upVectorScale(P,r.center.lat,r.worldSize).metersToTile;for(const F of t)for(const O of F){const $=O.add(b),q=u&&r.elevation?r.elevation.exaggeration()*u.getElevationAt($.x,$.y,!0):0,Y=r.projection.projectTilePoint($.x,$.y,P);if(q>0){const yt=r.projection.upVector(P,$.x,$.y);Y.x+=yt[0]*R*q,Y.y+=yt[1]*R*q,Y.z+=yt[2]*R*q}const it=m?$:Oy(Y.x,Y.y,Y.z,l),at=m?n.tilespaceRays.map(yt=>nx(yt,q)):n.queryGeometry.screenGeometry,gt=bs([],[Y.x,Y.y,Y.z,1],l);if(!_&&m?E*=gt[3]/r.cameraToCenterDistance:_&&!m&&(E*=r.cameraToCenterDistance/gt[3]),m){const yt=vt((O.y/ri+P.y)/(1<<P.z));E/=r.projection.pixelsPerMeter(yt,1)/_t(1,yt)}if(Ro(at,it,E))return!0}return!1}function Oy(n,t,r,l){const u=bs([],[n,t,r,1],l);return new Ae(u[0]/u[3],u[1]/u[3])}const qm=Kn(0,0,0),Ny=Kn(0,0,1);function nx(n,t){const r=Hr();return qm[2]=t,n.intersectsPlane(qm,Ny,r),new Ae(r[0],r[1])}class Vy extends So{}let Uy,jy,Gy,zg;function Jd(n,{width:t,height:r},l,u){if(u){if(u instanceof Uint8ClampedArray)u=new Uint8Array(u.buffer);else if(u.length!==t*r*l)throw new RangeError("mismatched image size")}else u=new Uint8Array(t*r*l);return n.width=t,n.height=r,n.data=u,n}function A_(n,t,r){const{width:l,height:u}=t;l===n.width&&u===n.height||(Lg(n,t,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,l),height:Math.min(n.height,u)},r,null),n.width=l,n.height=u,n.data=t.data)}function Lg(n,t,r,l,u,m,_,b){if(u.width===0||u.height===0)return t;if(u.width>n.width||u.height>n.height||r.x>n.width-u.width||r.y>n.height-u.height)throw new RangeError("out of range source coordinates for image copy");if(u.width>t.width||u.height>t.height||l.x>t.width-u.width||l.y>t.height-u.height)throw new RangeError("out of range destination coordinates for image copy");const E=n.data,P=t.data,R=m===4&&b;for(let F=0;F<u.height;F++){const O=((r.y+F)*n.width+r.x)*m,$=((l.y+F)*t.width+l.x)*m;if(R)for(let q=0;q<u.width;q++){const Y=O+q*m+3,it=$+q*m;P[it+0]=255,P[it+1]=255,P[it+2]=255,P[it+3]=E[Y]}else if(_)for(let q=0;q<u.width;q++){const Y=O+q*m,it=$+q*m,at=new Br(E[Y+0]/255,E[Y+1]/255,E[Y+2]/255,E[Y+3]).toNonPremultipliedRenderColor(_).toArray();P[it+0]=at[0],P[it+1]=at[1],P[it+2]=at[2],P[it+3]=at[3]}else for(let q=0;q<u.width*m;q++)P[$+q]=E[O+q]}return t}Ei(Vy,"HeatmapBucket",{omit:["layers"]});class Kd{constructor(t,r){Jd(this,t,1,r)}resize(t){A_(this,new Kd(t),1)}clone(){return new Kd({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,l,u,m){Lg(t,r,l,u,m,1,null)}}class Ma{constructor(t,r){Jd(this,t,4,r)}resize(t){A_(this,new Ma(t),4)}replace(t,r){r?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new Ma({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,l,u,m,_,b){Lg(t,r,l,u,m,4,_,b)}}class P_{constructor(t,r){this.width=t.width,this.height=t.height,this.data=r instanceof Uint8Array?new Float32Array(r.buffer):r}}function sm(n){const t={},r=n.resolution||256,l=n.clips?n.clips.length:1,u=n.image||new Ma({width:r,height:l}),m=(_,b,E)=>{t[n.evaluationKey]=E;const P=n.expression.evaluate(t),R=P?P.toNonPremultipliedRenderColor(null):null;R&&(u.data[_+b+0]=Math.floor(255*R.r),u.data[_+b+1]=Math.floor(255*R.g),u.data[_+b+2]=Math.floor(255*R.b),u.data[_+b+3]=Math.floor(255*R.a))};if(n.clips)for(let _=0,b=0;_<l;++_,b+=4*r)for(let E=0,P=0;E<r;E++,P+=4){const R=E/(r-1),{start:F,end:O}=n.clips[_];m(b,P,F*(1-R)+O*R)}else for(let _=0,b=0;_<r;_++,b+=4)m(0,b,_/(r-1));return u}Ei(Kd,"AlphaImage"),Ei(Ma,"RGBAImage");const Rg=Er([{name:"a_pos",components:2,type:"Int16"}],4),$y=Er([{name:"a_road_z_offset",components:1,type:"Float32"}],4),Zm=Er([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),qy=Er([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function $p(n,t,r=2){const l=t&&t.length,u=l?t[0]*r:n.length;let m=M_(n,0,u,r,!0);const _=[];if(!m||m.next===m.prev)return _;let b,E,P;if(l&&(m=function(R,F,O,$){const q=[];for(let Y=0,it=F.length;Y<it;Y++){const at=M_(R,F[Y]*$,Y<it-1?F[Y+1]*$:R.length,$,!1);at===at.next&&(at.steiner=!0),q.push(C_(at))}q.sort(Wy);for(let Y=0;Y<q.length;Y++)O=am(q[Y],O);return O}(n,t,m,r)),n.length>80*r){b=n[0],E=n[1];let R=b,F=E;for(let O=r;O<u;O+=r){const $=n[O],q=n[O+1];$<b&&(b=$),q<E&&(E=q),$>R&&(R=$),q>F&&(F=q)}P=Math.max(R-b,F-E),P=P!==0?32767/P:0}return yd(m,_,r,b,E,P,0),_}function M_(n,t,r,l,u){let m;if(u===function(_,b,E,P){let R=0;for(let F=b,O=E-P;F<E;F+=P)R+=(_[O]-_[F])*(_[F+1]+_[O+1]),O=F;return R}(n,t,r,l)>0)for(let _=t;_<r;_+=l)m=Ic(_/l|0,n[_],n[_+1],m);else for(let _=r-l;_>=t;_-=l)m=Ic(_/l|0,n[_],n[_+1],m);return m&&lm(m,m.next)&&(Hs(m),m=m.next),m}function nl(n,t){if(!n)return n;t||(t=n);let r,l=n;do if(r=!1,l.steiner||!lm(l,l.next)&&ea(l.prev,l,l.next)!==0)l=l.next;else{if(Hs(l),l=t=l.prev,l===l.next)break;r=!0}while(r||l!==t);return t}function yd(n,t,r,l,u,m,_){if(!n)return;!_&&m&&function(E,P,R,F){let O=E;do O.z===0&&(O.z=Wm(O.x,O.y,P,R,F)),O.prevZ=O.prev,O.nextZ=O.next,O=O.next;while(O!==E);O.prevZ.nextZ=null,O.prevZ=null,function($){let q,Y=1;do{let it,at=$;$=null;let gt=null;for(q=0;at;){q++;let yt=at,At=0;for(let kt=0;kt<Y&&(At++,yt=yt.nextZ,yt);kt++);let Gt=Y;for(;At>0||Gt>0&&yt;)At!==0&&(Gt===0||!yt||at.z<=yt.z)?(it=at,at=at.nextZ,At--):(it=yt,yt=yt.nextZ,Gt--),gt?gt.nextZ=it:$=it,it.prevZ=gt,gt=it;at=yt}gt.nextZ=null,Y*=2}while(q>1)}(O)}(n,l,u,m);let b=n;for(;n.prev!==n.next;){const E=n.prev,P=n.next;if(m?ox(n,l,u,m):Hm(n))t.push(E.i,n.i,P.i),Hs(n),n=P.next,b=P.next;else if((n=P)===b){_?_===1?yd(n=Zy(nl(n),t),t,r,l,u,m,2):_===2&&Hy(n,t,r,l,u,m):yd(nl(n),t,r,l,u,m,1);break}}}function Hm(n){const t=n.prev,r=n,l=n.next;if(ea(t,r,l)>=0)return!1;const u=t.x,m=r.x,_=l.x,b=t.y,E=r.y,P=l.y,R=Math.min(u,m,_),F=Math.min(b,E,P),O=Math.max(u,m,_),$=Math.max(b,E,P);let q=l.next;for(;q!==t;){if(q.x>=R&&q.x<=O&&q.y>=F&&q.y<=$&&Af(u,b,m,E,_,P,q.x,q.y)&&ea(q.prev,q,q.next)>=0)return!1;q=q.next}return!0}function ox(n,t,r,l){const u=n.prev,m=n,_=n.next;if(ea(u,m,_)>=0)return!1;const b=u.x,E=m.x,P=_.x,R=u.y,F=m.y,O=_.y,$=Math.min(b,E,P),q=Math.min(R,F,O),Y=Math.max(b,E,P),it=Math.max(R,F,O),at=Wm($,q,t,r,l),gt=Wm(Y,it,t,r,l);let yt=n.prevZ,At=n.nextZ;for(;yt&&yt.z>=at&&At&&At.z<=gt;){if(yt.x>=$&&yt.x<=Y&&yt.y>=q&&yt.y<=it&&yt!==u&&yt!==_&&Af(b,R,E,F,P,O,yt.x,yt.y)&&ea(yt.prev,yt,yt.next)>=0||(yt=yt.prevZ,At.x>=$&&At.x<=Y&&At.y>=q&&At.y<=it&&At!==u&&At!==_&&Af(b,R,E,F,P,O,At.x,At.y)&&ea(At.prev,At,At.next)>=0))return!1;At=At.nextZ}for(;yt&&yt.z>=at;){if(yt.x>=$&&yt.x<=Y&&yt.y>=q&&yt.y<=it&&yt!==u&&yt!==_&&Af(b,R,E,F,P,O,yt.x,yt.y)&&ea(yt.prev,yt,yt.next)>=0)return!1;yt=yt.prevZ}for(;At&&At.z<=gt;){if(At.x>=$&&At.x<=Y&&At.y>=q&&At.y<=it&&At!==u&&At!==_&&Af(b,R,E,F,P,O,At.x,At.y)&&ea(At.prev,At,At.next)>=0)return!1;At=At.nextZ}return!0}function Zy(n,t){let r=n;do{const l=r.prev,u=r.next.next;!lm(l,u)&&ol(l,r,r.next,u)&&Sc(l,u)&&Sc(u,l)&&(t.push(l.i,r.i,u.i),Hs(r),Hs(r.next),r=n=u),r=r.next}while(r!==n);return nl(r)}function Hy(n,t,r,l,u,m){let _=n;do{let b=_.next.next;for(;b!==_.prev;){if(_.i!==b.i&&z_(_,b)){let E=qp(_,b);return _=nl(_,_.next),E=nl(E,E.next),yd(_,t,r,l,u,m,0),void yd(E,t,r,l,u,m,0)}b=b.next}_=_.next}while(_!==n)}function Wy(n,t){let r=n.x-t.x;return r===0&&(r=n.y-t.y,r===0)&&(r=(n.next.y-n.y)/(n.next.x-n.x)-(t.next.y-t.y)/(t.next.x-t.x)),r}function am(n,t){const r=function(u,m){let _=m;const b=u.x,E=u.y;let P,R=-1/0;if(lm(u,_))return _;do{if(lm(u,_.next))return _.next;if(E<=_.y&&E>=_.next.y&&_.next.y!==_.y){const Y=_.x+(E-_.y)*(_.next.x-_.x)/(_.next.y-_.y);if(Y<=b&&Y>R&&(R=Y,P=_.x<_.next.x?_:_.next,Y===b))return P}_=_.next}while(_!==m);if(!P)return null;const F=P,O=P.x,$=P.y;let q=1/0;_=P;do{if(b>=_.x&&_.x>=O&&b!==_.x&&D_(E<$?b:R,E,O,$,E<$?R:b,E,_.x,_.y)){const Y=Math.abs(E-_.y)/(b-_.x);Sc(_,u)&&(Y<q||Y===q&&(_.x>P.x||_.x===P.x&&kg(P,_)))&&(P=_,q=Y)}_=_.next}while(_!==F);return P}(n,t);if(!r)return t;const l=qp(r,n);return nl(l,l.next),nl(r,r.next)}function kg(n,t){return ea(n.prev,n,t.prev)<0&&ea(t.next,n,n.next)<0}function Wm(n,t,r,l,u){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*u|0)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-l)*u|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function C_(n){let t=n,r=n;do(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next;while(t!==n);return r}function D_(n,t,r,l,u,m,_,b){return(u-_)*(t-b)>=(n-_)*(m-b)&&(n-_)*(l-b)>=(r-_)*(t-b)&&(r-_)*(m-b)>=(u-_)*(l-b)}function Af(n,t,r,l,u,m,_,b){return!(n===_&&t===b)&&D_(n,t,r,l,u,m,_,b)}function z_(n,t){return n.next.i!==t.i&&n.prev.i!==t.i&&!function(r,l){let u=r;do{if(u.i!==r.i&&u.next.i!==r.i&&u.i!==l.i&&u.next.i!==l.i&&ol(u,u.next,r,l))return!0;u=u.next}while(u!==r);return!1}(n,t)&&(Sc(n,t)&&Sc(t,n)&&function(r,l){let u=r,m=!1;const _=(r.x+l.x)/2,b=(r.y+l.y)/2;do u.y>b!=u.next.y>b&&u.next.y!==u.y&&_<(u.next.x-u.x)*(b-u.y)/(u.next.y-u.y)+u.x&&(m=!m),u=u.next;while(u!==r);return m}(n,t)&&(ea(n.prev,n,t.prev)||ea(n,t.prev,t))||lm(n,t)&&ea(n.prev,n,n.next)>0&&ea(t.prev,t,t.next)>0)}function ea(n,t,r){return(t.y-n.y)*(r.x-t.x)-(t.x-n.x)*(r.y-t.y)}function lm(n,t){return n.x===t.x&&n.y===t.y}function ol(n,t,r,l){const u=ru(ea(n,t,r)),m=ru(ea(n,t,l)),_=ru(ea(r,l,n)),b=ru(ea(r,l,t));return u!==m&&_!==b||!(u!==0||!Fn(n,r,t))||!(m!==0||!Fn(n,l,t))||!(_!==0||!Fn(r,n,l))||!(b!==0||!Fn(r,t,l))}function Fn(n,t,r){return t.x<=Math.max(n.x,r.x)&&t.x>=Math.min(n.x,r.x)&&t.y<=Math.max(n.y,r.y)&&t.y>=Math.min(n.y,r.y)}function ru(n){return n>0?1:n<0?-1:0}function Sc(n,t){return ea(n.prev,n,n.next)<0?ea(n,t,n.next)>=0&&ea(n,n.prev,t)>=0:ea(n,t,n.prev)<0||ea(n,n.next,t)<0}function qp(n,t){const r=ga(n.i,n.x,n.y),l=ga(t.i,t.x,t.y),u=n.next,m=t.prev;return n.next=t,t.prev=n,r.next=u,u.prev=r,l.next=r,r.prev=l,m.next=l,l.prev=m,l}function Ic(n,t,r,l){const u=ga(n,t,r);return l?(u.next=l.next,u.prev=l,l.next.prev=u,l.next=u):(u.prev=u,u.next=u),u}function Hs(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function ga(n,t,r){return{i:n,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function cm(n,t){const r=n.length;if(r<=1)return[n];const l=[];let u,m;for(let _=0;_<r;_++){const b=Qi(n[_]);b!==0&&(n[_].area=Math.abs(b),m===void 0&&(m=b<0),m===b<0?(u&&l.push(u),u=[n[_]]):u.push(n[_]))}if(u&&l.push(u),t>1)for(let _=0;_<l.length;_++)l[_].length<=t||(ha(l[_],t,1,l[_].length-1,yh),l[_]=l[_].slice(0,t));return l}function yh(n,t){return t.area-n.area}function Fg(n,t,r=1){if(!n)return null;const l=typeof n=="string"?Fa.from(n).getPrimary():n.getPrimary(),u=typeof n=="string"?null:n.getSecondary();for(const m of[l,u]){if(!m)continue;const _=m.id.toString();t.has(_)||t.set(_,[]),m.scaleSelf(r),t.get(_).push(m)}return{primary:l.toString(),secondary:u?u.toString():null}}function ia(n,t,r,l){const u=l.patternDependencies;let m=!1;for(const _ of t){const b=_.paint.get(`${n}-pattern`);b.isConstant()||(m=!0),Fg(b.constantOr(null),u,r)&&(m=!0)}return m}function hm(n,t,r,l,u,m){const _=m.patternDependencies;for(const b of t){const E=b.paint.get(`${n}-pattern`).value;if(E.kind!=="constant"){let P=E.evaluate({zoom:l},r,{},m.availableImages);P=P&&P.name?P.name:P;const R=Fg(P,_,u);if(!R)continue;const{primary:F,secondary:O}=R;F&&(r.patterns[b.id]=[F,O].filter(Boolean))}}return r}class Xy{constructor(){this.polygons=new Map}add(t,...r){const l=this.polygons.get(t);l?l.push(...r):this.polygons.set(t,r)}merge(t){for(const[r,l]of t.polygons)this.add(r,...l)}}class xd{constructor(){this.portals=[]}static isOnBorder(t,r){return t<=0&&r<=0||t>=ri&&r>=ri}static evaluate(t){if(t.length===0)return new xd;let r=[];for(const E of t)r.push(...E.portals);if(r.length===0)return new xd;for(const E of r){const P=E.va,R=E.vb;(xd.isOnBorder(P.x,R.x)||xd.isOnBorder(P.y,R.y))&&(E.type="border")}const l=r.filter(E=>E.type!=="unevaluated"),u=r.filter(E=>E.type==="unevaluated");if(u.length===0)return new xd;u.sort((E,P)=>E.hash===P.hash?E.isTunnel===P.isTunnel?0:E.isTunnel?-1:1:E.hash<P.hash?1:-1),r=l.concat(u);let m=l.length,_=m,b=m;do if(_++,_===r.length||r[m].hash!==r[_].hash){if(_-m==2){b<m&&(r[b]=r[m],r[m]=null);const E=r[b],P=r[_-1];E.type=E.isTunnel!==P.isTunnel?"tunnel":"polygon",E.connection={a:E.connection.a,b:P.connection.a},b++}m=_}while(m!==r.length);return r.splice(b),r.sort((E,P)=>E.hash<P.hash?1:-1),{portals:r}}}Ei(xd,"ElevationPortalGraph"),Ei(Xy,"ElevationPolygons");class Pf{constructor(t,r,l){this.outPositions=t,this.outNormals=r,this.outIndices=l,this.vertexLookup=new Map}addVertex(t,r,l){let u=t[2];l!=null&&(u*=l);const m=`${t[0]},${t[1]},${t[2]},${r[0]},${r[1]},${r[2]}`,_=this.vertexLookup.get(m);if(_!=null)return _;const b=this.outPositions.length;this.vertexLookup.set(m,b);const E=Math.trunc(16384*r[0]),P=Math.trunc(16384*r[1]),R=Math.trunc(16384*r[2]);return this.outPositions.emplaceBack(t[0],t[1],u),this.outNormals.emplaceBack(E,P,R),b}addTriangle(t,r,l){this.outIndices.emplaceBack(t,r,l)}addTriangles(t,r,l){if(t.length===0)return;const u=l.length===1,m=Hr(),_=Hr();for(let b=0;b<t.length;b+=3){const E=r[t[b+0]],P=r[t[b+1]],R=r[t[b+2]],F=u?l[0]:l[t[b+1]],O=u?l[0]:l[t[b+2]];hn(m,E.x,E.y,u?l[0]:l[t[b+0]]);const $=this.addVertex(m,_);hn(m,P.x,P.y,F);const q=this.addVertex(m,_);hn(m,R.x,R.y,O);const Y=this.addVertex(m,_);this.outIndices.emplaceBack($,q,Y)}}addQuad(t,r,l,u,m,_){const b=this.addVertex(t,m,_),E=this.addVertex(r,m,_),P=this.addVertex(l,m,_),R=this.addVertex(u,m,_);this.addTriangle(b,E,P),this.addTriangle(P,R,b)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class Ua{constructor(t,r,l,u){this.unevaluatedPortals=new xd,this.portalPolygons=new Xy,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new _c,this.vertexNormals=new rl,this.indexArray=new ro,this.tileToMeters=Zt(t),this.bridgeProgramConfigurations=new _h(r,{zoom:l,lut:u},m=>m!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new _h(r,{zoom:l,lut:u},m=>m!=="fill-bridge-guard-rail-color")}addVertices(t,r){const l=this.unevalVertices.length;for(let u=0;u<t.length;u++)this.unevalVertices.push(t[u]),this.unevalHeights.push(r[u]);return l}addTriangles(t,r,l){const u=l?this.unevalTunnelTriangles:this.unevalTriangles;for(const m of t)u.push(m+r)}addRenderableRing(t,r,l,u,m,_){const b=[new Ae(m.min.x,m.min.y),new Ae(m.max.x,m.min.y),new Ae(m.max.x,m.max.y),new Ae(m.min.x,m.max.y)];for(let E=0;E<l-1;E++){const P=r+E,R=P+1,F=this.unevalVertices[P],O=this.unevalVertices[R];if(!(F.x>=m.min.x&&F.x<=m.max.x&&F.y>=m.min.y&&F.y<=m.max.y||O.x>=m.min.x&&O.x<=m.max.x&&O.y>=m.min.y&&O.y<=m.max.y||Go(F,O,b))||this.isOnBorder(F.x,O.x)||this.isOnBorder(F.y,O.y))continue;const $=Ua.computeEdgeHash(this.unevalVertices[P],this.unevalVertices[R]);let q,Y=this.vertexHashLookup.get(Ua.computePosHash(F));Y!=null?q=Y.next:(Y=this.vertexHashLookup.get(Ua.computePosHash(O)),q=Y!=null?Y.prev:$),this.unevalEdges.push({polygonIdx:t,a:P,b:R,hash:$,portalHash:q,isTunnel:u,type:"unevaluated",featureInfo:_})}}addPortalCandidates(t,r,l,u,m){if(r.length===0)return;this.portalPolygons.add(t,{geometry:r,zLevel:m});const _=r[0];this.vertexHashLookup.clear();let b=Ua.computeEdgeHash(_[_.length-2],_[_.length-1]);for(let E=0;E<_.length-1;E++){const P=_[E+0],R=_[E+1],F=we(R.x-P.x,R.y-P.y),O=ae(F);if(O===0)continue;let $="unevaluated";const q=u.pointElevation(P),Y=u.pointElevation(R);Math.abs(q)<.01&&Math.abs(Y)<.01?$="entrance":(this.isOnBorder(P.x,R.x)||this.isOnBorder(P.y,R.y))&&($="border");const it=Ua.computeEdgeHash(P,R);this.unevaluatedPortals.portals.push({connection:{a:t,b:void 0},va:P,vb:R,vab:F,length:O,hash:it,isTunnel:l,type:$});const at=Ua.computePosHash(P);this.vertexHashLookup.set(at,{prev:b,next:it}),b=it}}construct(t){if(this.unevalVertices.length===0)return;const r=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),l=O=>{O.primitiveLength=this.indexArray.length-O.primitiveOffset},u=new Pf(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(t.portals,this.unevalEdges);const m=r(),_=r(),b=r(),E=(O,$)=>{O.sort((Y,it)=>Y.type===$&&it.type!==$?-1:Y.type!==$&&it.type===$?1:0);const q=O.findIndex(Y=>Y.type!==$);return q>=0?q:O.length};let P=0;this.unevalEdges.length>0&&(P=E(this.unevalEdges,"none"),this.constructBridgeStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:P},this.tileToMeters)),l(b);const R=r(),F=r();if(this.unevalEdges.length>0){const O=this.unevalEdges.splice(P),$=E(O,"tunnel")+P;this.unevalEdges.push(...O),this.constructTunnelStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:P},{min:P,max:$})}l(R),u.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),l(F),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),l(_),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),l(m),this.maskSegments=To.simpleSegment(0,F.primitiveOffset,0,F.primitiveLength),this.depthSegments=To.simpleSegment(0,_.primitiveOffset,0,_.primitiveLength),this.renderableBridgeSegments=To.simpleSegment(0,b.primitiveOffset,0,b.primitiveLength),this.renderableTunnelSegments=To.simpleSegment(0,R.primitiveOffset,0,R.primitiveLength),this.shadowCasterSegments=To.simpleSegment(0,m.primitiveOffset,0,m.primitiveLength)}update(t,r,l,u,m,_,b,E){this.bridgeProgramConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E),this.tunnelProgramConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E)}upload(t){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=t.createVertexBuffer(this.vertexPositions,Zm.members),this.vertexBufferNormal=t.createVertexBuffer(this.vertexNormals,qy.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(t),this.tunnelProgramConfigurations.upload(t))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(t,r,l,u,m){const _=(b,E)=>{for(let P=0;P<E.length-1;P++){const R=E[P].featureIndex,F=E[P+1].vertexStart,O=t.feature(R);b.populatePaintArrays(F,O,R,{},l,r,u,void 0,m)}};_(this.bridgeProgramConfigurations,this.bridgeFeatureSections),_(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(t,r,l,u,m){const _=new Map;for(let b=u;b<m;b++){const E=l[b],P=E.a,R=E.b,F=Ua.computePosHash(t[P]),O=Ua.computePosHash(t[R]);let $=_.get(F);$||($={},_.set(F,$));let q=_.get(O);q||(q={},_.set(O,q)),r[P]<=0&&r[R]<=0||($.to=R,q.from=P)}return _}isTerminalVertex(t,r){const l=Ua.computePosHash(this.unevalVertices[t]),u=r.get(l);return!u||!u.from||!u.to}constructBridgeStructures(t,r,l,u,m,_){t.clearVertexLookup();const b=this.computeVertexConnections(r,l,u,m.min,m.max),E=1/_,P=.5*E,R=(hi,Ke)=>hn(hi,r[Ke].x,r[Ke].y,l[Ke]*E),F=Hr(),O=Hr(),$=Hr(),q=Hr(),Y=Hr(),it=(hi,Ke)=>{const je=b.get(Ua.computePosHash(r[Ke])),Ye=je.from,Pe=je.to;if(!Ye||!Pe)return;R(F,Ye),R(O,Ke),R($,Pe),Ns(q),xo(F,O)||(oo(Y,O,F),Xi(q,Y)),xo($,O)||(oo(Y,$,O),Co(q,q,Xi(Y,Y)));const Ie=$l(q);return Ie>0?Hn(hi,q,1/Ie):void 0};let at=Number.POSITIVE_INFINITY;this.sortSubarray(u,m.min,m.max,(hi,Ke)=>hi.featureInfo.featureIndex-Ke.featureInfo.featureIndex);const gt=Hr(),yt=Hr(),At=Hr(),Gt=Hr(),kt=Hr(),Xt=Hr(),te=Hr(),ne=Hr(),ze=Hr(),fe=[Hr(),Hr(),Hr(),Hr()],ke=[Hr(),Hr(),Hr(),Hr()],Ue=[{coord:new Ae(0,0),height:0},{coord:new Ae(0,0),height:0}],Ze=(hi,Ke)=>hi>Ke;for(let hi=m.min;hi<m.max;hi++){const Ke=u[hi];if(!Ke.featureInfo.guardRailEnabled||!this.prepareEdgePoints(Ue,r,l,Ke,Ze))continue;const[je,Ye]=Ue;if(hn(gt,je.coord.x,je.coord.y,E*je.height),hn(yt,Ye.coord.x,Ye.coord.y,E*Ye.height),xo(gt,yt))continue;oo(At,yt,gt),Xi(At,At);const Pe=it(ne,Ke.a)||At,Ie=it(ze,Ke.b)||At;hn(Gt,Pe[1],-Pe[0],0),Xi(Gt,Gt),hn(kt,Ie[1],-Ie[0],0),Xi(kt,kt),$n(ne,Gt,Pe),Xi(Xt,ne),$n(ne,kt,Ie),Xi(te,ne),Co(fe[0],gt,Hn(ne,oo(ne,Gt,Xt),P)),Co(fe[1],gt,Hn(ne,Co(ne,Gt,Xt),P)),Co(fe[2],gt,Hn(ne,Xt,P)),fe[3]=gt,Co(ke[0],yt,Hn(ne,oo(ne,kt,te),P)),Co(ke[1],yt,Hn(ne,Co(ne,kt,te),P)),Co(ke[2],yt,Hn(ne,te,P)),ke[3]=yt,at=this.addFeatureSection(Ke.featureInfo.featureIndex,at,this.bridgeFeatureSections,t);const He=t.addVertex(fe[0],Gt,_),ai=t.addVertex(fe[1],Gt,_),Ge=t.addVertex(ke[0],kt,_),Pi=t.addVertex(ke[1],kt,_);t.addTriangle(He,ai,Ge),t.addTriangle(ai,Pi,Ge);const Bi=t.addVertex(fe[1],Xt,_),vi=t.addVertex(fe[2],Xt,_),mi=t.addVertex(ke[1],te,_),_r=t.addVertex(ke[2],te,_);t.addTriangle(Bi,vi,mi),t.addTriangle(vi,_r,mi),qr(Gt,Gt),qr(kt,kt);const yi=t.addVertex(fe[2],Gt,_),Yi=t.addVertex(fe[3],Gt,_),wr=t.addVertex(ke[2],kt,_),Vr=t.addVertex(ke[3],kt,_);t.addTriangle(yi,Yi,wr),t.addTriangle(Yi,Vr,wr);const pn=this.isTerminalVertex(Ke.a,b),Tr=this.isTerminalVertex(Ke.b,b);je.height<.01&&pn&&t.addQuad(fe[3],fe[2],fe[1],fe[0],qr(Pe,Pe),_),Ye.height<.01&&Tr&&t.addQuad(ke[0],ke[1],ke[2],ke[3],Ie,_)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:t.getVertexCount()})}constructTunnelStructures(t,r,l,u,m,_){t.clearVertexLookup();let b=Number.POSITIVE_INFINITY;const E=(at,gt)=>at.featureInfo.featureIndex-gt.featureInfo.featureIndex;this.sortSubarray(u,m.min,m.max,E),this.sortSubarray(u,_.min,_.max,E);const P=at=>Xi(at,at),R=[{coord:new Ae(0,0),height:0},{coord:new Ae(0,0),height:0}],F=(at,gt)=>at<gt,O=Hr(),$=Hr(),q=Hr(),Y=Hr(),it=Hr();for(let at=m.min;at<m.max;at++){if(!this.prepareEdgePoints(R,r,l,u[at],F))continue;const[gt,yt]=R,At=P(hn(it,-(yt.coord.y-gt.coord.y),yt.coord.x-gt.coord.x,0));b=this.addFeatureSection(u[at].featureInfo.featureIndex,b,this.tunnelFeatureSections,t),t.addQuad(hn(O,gt.coord.x,gt.coord.y,gt.height),hn($,yt.coord.x,yt.coord.y,yt.height),hn(q,yt.coord.x,yt.coord.y,u[at].isTunnel?-.1:0),hn(Y,gt.coord.x,gt.coord.y,u[at].isTunnel?-.1:0),At)}for(let at=_.min;at<_.max;at++){const gt=u[at];gt.isTunnel&&([gt.a,gt.b]=[gt.b,gt.a]);const yt=r[gt.a],At=r[gt.b],Gt=P(hn(it,-(At.y-yt.y),At.x-yt.x,0));b=this.addFeatureSection(gt.featureInfo.featureIndex,b,this.tunnelFeatureSections,t),t.addQuad(hn(O,At.x,At.y,0),hn($,yt.x,yt.y,0),hn(q,yt.x,yt.y,l[gt.a]+4),hn(Y,At.x,At.y,l[gt.b]+4),Gt),t.addQuad(hn(O,yt.x,yt.y,0),hn($,At.x,At.y,0),hn(q,At.x,At.y,l[gt.b]+4),hn(Y,yt.x,yt.y,l[gt.a]+4),Gt)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:t.getVertexCount()})}setElevatedPoint(t,r,l,u){t.coord.x=r,t.coord.y=l,t.height=u}prepareEdgePoints(t,r,l,u,m){let _=r[u.a].x,b=r[u.a].y,E=r[u.b].x,P=r[u.b].y,R=l[u.a],F=l[u.b];const O=m(R,0),$=m(F,0);if(O&&$)return this.setElevatedPoint(t[0],_,b,R),this.setElevatedPoint(t[1],E,P,F),!0;if(!O&&!$)return!1;if(O){if(!$){const q=F/(F-R);E=Gi(E,_,q),P=Gi(P,b,q),F=Gi(F,R,q)}}else{const q=R/(R-F);_=Gi(_,E,q),b=Gi(b,P,q),R=Gi(R,F,q)}return this.setElevatedPoint(t[0],_,b,R),this.setElevatedPoint(t[1],E,P,F),!0}prepareEdges(t,r){if(r.length===0)return;r.sort((b,E)=>b.hash===E.hash?E.polygonIdx-b.polygonIdx:E.hash>b.hash?1:-1);let l=0,u=0,m=0,_=r[l].polygonIdx;do u++,(u===r.length||r[l].hash!==r[u].hash)&&((u-l==1||r[u-1].polygonIdx!==_)&&(m<l&&(r[m]=r[l],r[l]=null),r[m].type="none",m++),l=u,l!==r.length&&(_=r[l].polygonIdx));while(l!==r.length);if(r.splice(m),r.length!==0&&t.length!==0){r.sort((P,R)=>P.portalHash<R.portalHash?1:-1);let b=0,E=0;for(;b!==r.length&&E!==t.length;){const P=r[b],R=t[E];P.portalHash>R.hash?b++:R.hash>P.portalHash?E++:(P.type=R.type,b++)}}}isOnBorder(t,r){return t<=0&&r<=0||t>=ri&&r>=ri}addFeatureSection(t,r,l,u){return t!==r&&(r=t,l.push({featureIndex:t,vertexStart:u.getVertexCount()}),u.clearVertexLookup()),r}sortSubarray(t,r,l,u){const m=t.slice(r,l);m.sort(u),t.splice(r,m.length,...m)}static computeEdgeHash(t,r){return(t.y===r.y&&t.x>r.x||t.y>r.y)&&([t,r]=[r,t]),BigInt(Ua.computePosHash(t))<<32n|BigInt(Ua.computePosHash(r))}static computePosHash(t){return((65535&t.x)<<16|65535&t.y)>>>0}}var Yy,L_={exports:{}},R_=(Yy||(Yy=1,function(n,t){(function(r){function l(Ft,zt){return Ft>zt?1:Ft<zt?-1:0}var u=function(Ft,zt){Ft===void 0&&(Ft=l),zt===void 0&&(zt=!1),this._compare=Ft,this._root=null,this._size=0,this._noDuplicates=!!zt},m={size:{configurable:!0}};function _(Ft,zt,Ne,pi,Ve){var gi=Ve-pi;if(gi>0){var qi=pi+Math.floor(gi/2),ji={key:zt[qi],data:Ne[qi],parent:Ft};return ji.left=_(ji,zt,Ne,pi,qi),ji.right=_(ji,zt,Ne,qi+1,Ve),ji}return null}function b(Ft,zt,Ne,pi,Ve){if(!(Ne>=pi)){for(var gi=Ft[Ne+pi>>1],qi=Ne-1,ji=pi+1;;){do qi++;while(Ve(Ft[qi],gi)<0);do ji--;while(Ve(Ft[ji],gi)>0);if(qi>=ji)break;var Cr=Ft[qi];Ft[qi]=Ft[ji],Ft[ji]=Cr,Cr=zt[qi],zt[qi]=zt[ji],zt[ji]=Cr}b(Ft,zt,Ne,ji,Ve),b(Ft,zt,ji+1,pi,Ve)}}u.prototype.rotateLeft=function(Ft){var zt=Ft.right;zt&&(Ft.right=zt.left,zt.left&&(zt.left.parent=Ft),zt.parent=Ft.parent),Ft.parent?Ft===Ft.parent.left?Ft.parent.left=zt:Ft.parent.right=zt:this._root=zt,zt&&(zt.left=Ft),Ft.parent=zt},u.prototype.rotateRight=function(Ft){var zt=Ft.left;zt&&(Ft.left=zt.right,zt.right&&(zt.right.parent=Ft),zt.parent=Ft.parent),Ft.parent?Ft===Ft.parent.left?Ft.parent.left=zt:Ft.parent.right=zt:this._root=zt,zt&&(zt.right=Ft),Ft.parent=zt},u.prototype._splay=function(Ft){for(;Ft.parent;){var zt=Ft.parent;zt.parent?zt.left===Ft&&zt.parent.left===zt?(this.rotateRight(zt.parent),this.rotateRight(zt)):zt.right===Ft&&zt.parent.right===zt?(this.rotateLeft(zt.parent),this.rotateLeft(zt)):zt.left===Ft&&zt.parent.right===zt?(this.rotateRight(zt),this.rotateLeft(zt)):(this.rotateLeft(zt),this.rotateRight(zt)):zt.left===Ft?this.rotateRight(zt):this.rotateLeft(zt)}},u.prototype.splay=function(Ft){for(var zt,Ne,pi,Ve,gi;Ft.parent;)(Ne=(zt=Ft.parent).parent)&&Ne.parent?((pi=Ne.parent).left===Ne?pi.left=Ft:pi.right=Ft,Ft.parent=pi):(Ft.parent=null,this._root=Ft),Ve=Ft.left,gi=Ft.right,Ft===zt.left?(Ne&&(Ne.left===zt?(zt.right?(Ne.left=zt.right,Ne.left.parent=Ne):Ne.left=null,zt.right=Ne,Ne.parent=zt):(Ve?(Ne.right=Ve,Ve.parent=Ne):Ne.right=null,Ft.left=Ne,Ne.parent=Ft)),gi?(zt.left=gi,gi.parent=zt):zt.left=null,Ft.right=zt,zt.parent=Ft):(Ne&&(Ne.right===zt?(zt.left?(Ne.right=zt.left,Ne.right.parent=Ne):Ne.right=null,zt.left=Ne,Ne.parent=zt):(gi?(Ne.left=gi,gi.parent=Ne):Ne.left=null,Ft.right=Ne,Ne.parent=Ft)),Ve?(zt.right=Ve,Ve.parent=zt):zt.right=null,Ft.left=zt,zt.parent=Ft)},u.prototype.replace=function(Ft,zt){Ft.parent?Ft===Ft.parent.left?Ft.parent.left=zt:Ft.parent.right=zt:this._root=zt,zt&&(zt.parent=Ft.parent)},u.prototype.minNode=function(Ft){if(Ft===void 0&&(Ft=this._root),Ft)for(;Ft.left;)Ft=Ft.left;return Ft},u.prototype.maxNode=function(Ft){if(Ft===void 0&&(Ft=this._root),Ft)for(;Ft.right;)Ft=Ft.right;return Ft},u.prototype.insert=function(Ft,zt){var Ne=this._root,pi=null,Ve=this._compare;if(this._noDuplicates)for(;Ne;){if(pi=Ne,Ve(Ne.key,Ft)===0)return;Ne=Ve(Ne.key,Ft)<0?Ne.right:Ne.left}else for(;Ne;)pi=Ne,Ne=Ve(Ne.key,Ft)<0?Ne.right:Ne.left;return Ne={key:Ft,data:zt,left:null,right:null,parent:pi},pi?Ve(pi.key,Ne.key)<0?pi.right=Ne:pi.left=Ne:this._root=Ne,this.splay(Ne),this._size++,Ne},u.prototype.find=function(Ft){for(var zt=this._root,Ne=this._compare;zt;){var pi=Ne(zt.key,Ft);if(pi<0)zt=zt.right;else{if(!(pi>0))return zt;zt=zt.left}}return null},u.prototype.contains=function(Ft){for(var zt=this._root,Ne=this._compare;zt;){var pi=Ne(Ft,zt.key);if(pi===0)return!0;zt=pi<0?zt.left:zt.right}return!1},u.prototype.remove=function(Ft){var zt=this.find(Ft);if(!zt)return!1;if(this.splay(zt),zt.left)if(zt.right){var Ne=this.minNode(zt.right);Ne.parent!==zt&&(this.replace(Ne,Ne.right),Ne.right=zt.right,Ne.right.parent=Ne),this.replace(zt,Ne),Ne.left=zt.left,Ne.left.parent=Ne}else this.replace(zt,zt.left);else this.replace(zt,zt.right);return this._size--,!0},u.prototype.removeNode=function(Ft){if(!Ft)return!1;if(this.splay(Ft),Ft.left)if(Ft.right){var zt=this.minNode(Ft.right);zt.parent!==Ft&&(this.replace(zt,zt.right),zt.right=Ft.right,zt.right.parent=zt),this.replace(Ft,zt),zt.left=Ft.left,zt.left.parent=zt}else this.replace(Ft,Ft.left);else this.replace(Ft,Ft.right);return this._size--,!0},u.prototype.erase=function(Ft){var zt=this.find(Ft);if(zt){this.splay(zt);var Ne=zt.left,pi=zt.right,Ve=null;Ne&&(Ne.parent=null,Ve=this.maxNode(Ne),this.splay(Ve),this._root=Ve),pi&&(Ne?Ve.right=pi:this._root=pi,pi.parent=Ve),this._size--}},u.prototype.pop=function(){var Ft=this._root,zt=null;if(Ft){for(;Ft.left;)Ft=Ft.left;zt={key:Ft.key,data:Ft.data},this.remove(Ft.key)}return zt},u.prototype.next=function(Ft){var zt=Ft;if(zt)if(zt.right)for(zt=zt.right;zt&&zt.left;)zt=zt.left;else for(zt=Ft.parent;zt&&zt.right===Ft;)Ft=zt,zt=zt.parent;return zt},u.prototype.prev=function(Ft){var zt=Ft;if(zt)if(zt.left)for(zt=zt.left;zt&&zt.right;)zt=zt.right;else for(zt=Ft.parent;zt&&zt.left===Ft;)Ft=zt,zt=zt.parent;return zt},u.prototype.forEach=function(Ft){for(var zt=this._root,Ne=[],pi=!1,Ve=0;!pi;)zt?(Ne.push(zt),zt=zt.left):Ne.length>0?(Ft(zt=Ne.pop(),Ve++),zt=zt.right):pi=!0;return this},u.prototype.range=function(Ft,zt,Ne,pi){for(var Ve=[],gi=this._compare,qi=this._root;Ve.length!==0||qi;)if(qi)Ve.push(qi),qi=qi.left;else{if(gi((qi=Ve.pop()).key,zt)>0)break;if(gi(qi.key,Ft)>=0&&Ne.call(pi,qi))return this;qi=qi.right}return this},u.prototype.keys=function(){for(var Ft=this._root,zt=[],Ne=[],pi=!1;!pi;)Ft?(zt.push(Ft),Ft=Ft.left):zt.length>0?(Ft=zt.pop(),Ne.push(Ft.key),Ft=Ft.right):pi=!0;return Ne},u.prototype.values=function(){for(var Ft=this._root,zt=[],Ne=[],pi=!1;!pi;)Ft?(zt.push(Ft),Ft=Ft.left):zt.length>0?(Ft=zt.pop(),Ne.push(Ft.data),Ft=Ft.right):pi=!0;return Ne},u.prototype.at=function(Ft){for(var zt=this._root,Ne=[],pi=!1,Ve=0;!pi;)if(zt)Ne.push(zt),zt=zt.left;else if(Ne.length>0){if(zt=Ne.pop(),Ve===Ft)return zt;Ve++,zt=zt.right}else pi=!0;return null},u.prototype.load=function(Ft,zt,Ne){if(Ft===void 0&&(Ft=[]),zt===void 0&&(zt=[]),Ne===void 0&&(Ne=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var pi=Ft.length;return Ne&&b(Ft,zt,0,pi-1,this._compare),this._root=_(null,Ft,zt,0,pi),this._size=pi,this},u.prototype.min=function(){var Ft=this.minNode(this._root);return Ft?Ft.key:null},u.prototype.max=function(){var Ft=this.maxNode(this._root);return Ft?Ft.key:null},u.prototype.isEmpty=function(){return this._root===null},m.size.get=function(){return this._size},u.createTree=function(Ft,zt,Ne,pi,Ve){return new u(Ne,Ve).load(Ft,zt,pi)},Object.defineProperties(u.prototype,m);var E=0,P=1,R=2,F=3,O=0,$=1,q=2,Y=3;function it(Ft,zt,Ne){zt===null?(Ft.inOut=!1,Ft.otherInOut=!0):(Ft.isSubject===zt.isSubject?(Ft.inOut=!zt.inOut,Ft.otherInOut=zt.otherInOut):(Ft.inOut=!zt.otherInOut,Ft.otherInOut=zt.isVertical()?!zt.inOut:zt.inOut),zt&&(Ft.prevInResult=!at(zt,Ne)||zt.isVertical()?zt.prevInResult:zt));var pi=at(Ft,Ne);Ft.resultTransition=pi?function(Ve,gi){var qi,ji=!Ve.inOut,Cr=!Ve.otherInOut;switch(gi){case O:qi=ji&&Cr;break;case $:qi=ji||Cr;break;case Y:qi=ji^Cr;break;case q:qi=Ve.isSubject?ji&&!Cr:Cr&&!ji}return qi?1:-1}(Ft,Ne):0}function at(Ft,zt){switch(Ft.type){case E:switch(zt){case O:return!Ft.otherInOut;case $:return Ft.otherInOut;case q:return Ft.isSubject&&Ft.otherInOut||!Ft.isSubject&&!Ft.otherInOut;case Y:return!0}break;case R:return zt===O||zt===$;case F:return zt===q;case P:return!1}return!1}var gt=function(Ft,zt,Ne,pi,Ve){this.left=zt,this.point=Ft,this.otherEvent=Ne,this.isSubject=pi,this.type=Ve||E,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},yt={inResult:{configurable:!0}};function At(Ft,zt){return Ft[0]===zt[0]&&Ft[1]===zt[1]}gt.prototype.isBelow=function(Ft){var zt=this.point,Ne=this.otherEvent.point;return this.left?(zt[0]-Ft[0])*(Ne[1]-Ft[1])-(Ne[0]-Ft[0])*(zt[1]-Ft[1])>0:(Ne[0]-Ft[0])*(zt[1]-Ft[1])-(zt[0]-Ft[0])*(Ne[1]-Ft[1])>0},gt.prototype.isAbove=function(Ft){return!this.isBelow(Ft)},gt.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},yt.inResult.get=function(){return this.resultTransition!==0},gt.prototype.clone=function(){var Ft=new gt(this.point,this.left,this.otherEvent,this.isSubject,this.type);return Ft.contourId=this.contourId,Ft.resultTransition=this.resultTransition,Ft.prevInResult=this.prevInResult,Ft.isExteriorRing=this.isExteriorRing,Ft.inOut=this.inOut,Ft.otherInOut=this.otherInOut,Ft},Object.defineProperties(gt.prototype,yt);var Gt=11102230246251565e-32,kt=134217729,Xt=(3+8*Gt)*Gt;function te(Ft,zt,Ne,pi,Ve){var gi,qi,ji,Cr,or=zt[0],Ni=pi[0],vn=0,Yn=0;Ni>or==Ni>-or?(gi=or,or=zt[++vn]):(gi=Ni,Ni=pi[++Yn]);var lr=0;if(vn<Ft&&Yn<Ne)for(Ni>or==Ni>-or?(ji=gi-((qi=or+gi)-or),or=zt[++vn]):(ji=gi-((qi=Ni+gi)-Ni),Ni=pi[++Yn]),gi=qi,ji!==0&&(Ve[lr++]=ji);vn<Ft&&Yn<Ne;)Ni>or==Ni>-or?(ji=gi-((qi=gi+or)-(Cr=qi-gi))+(or-Cr),or=zt[++vn]):(ji=gi-((qi=gi+Ni)-(Cr=qi-gi))+(Ni-Cr),Ni=pi[++Yn]),gi=qi,ji!==0&&(Ve[lr++]=ji);for(;vn<Ft;)ji=gi-((qi=gi+or)-(Cr=qi-gi))+(or-Cr),or=zt[++vn],gi=qi,ji!==0&&(Ve[lr++]=ji);for(;Yn<Ne;)ji=gi-((qi=gi+Ni)-(Cr=qi-gi))+(Ni-Cr),Ni=pi[++Yn],gi=qi,ji!==0&&(Ve[lr++]=ji);return gi===0&&lr!==0||(Ve[lr++]=gi),lr}function ne(Ft){return new Float64Array(Ft)}var ze=33306690738754716e-32,fe=22204460492503146e-32,ke=11093356479670487e-47,Ue=ne(4),Ze=ne(8),hi=ne(12),Ke=ne(16),je=ne(4);function Ye(Ft,zt,Ne){var pi=function(Ve,gi,qi,ji,Cr,or){var Ni=(gi-or)*(qi-Cr),vn=(Ve-Cr)*(ji-or),Yn=Ni-vn;if(Ni===0||vn===0||Ni>0!=vn>0)return Yn;var lr=Math.abs(Ni+vn);return Math.abs(Yn)>=ze*lr?Yn:-function(ln,Jn,Ln,Jo,Eo,_o,Gn){var Sn,Dr,In,yo,sr,fn,Ao,is,us,Xs,Po,Fs,Wc,Bs,wh,Al,Fu,Xc,Th=ln-Eo,Pl=Ln-Eo,Sh=Jn-_o,Bu=Jo-_o;Ue[0]=(wh=(is=Th-(Ao=(fn=kt*Th)-(fn-Th)))*(Xs=Bu-(us=(fn=kt*Bu)-(fn-Bu)))-((Bs=Th*Bu)-Ao*us-is*us-Ao*Xs))-((Po=wh-(Fu=(is=Sh-(Ao=(fn=kt*Sh)-(fn-Sh)))*(Xs=Pl-(us=(fn=kt*Pl)-(fn-Pl)))-((Al=Sh*Pl)-Ao*us-is*us-Ao*Xs)))+(sr=wh-Po))+(sr-Fu),Ue[1]=(Wc=Bs-((Fs=Bs+Po)-(sr=Fs-Bs))+(Po-sr))-((Po=Wc-Al)+(sr=Wc-Po))+(sr-Al),Ue[2]=Fs-((Xc=Fs+Po)-(sr=Xc-Fs))+(Po-sr),Ue[3]=Xc;var Xa=function(Im,nf){for(var W0=nf[0],d_=1;d_<4;d_++)W0+=nf[d_];return W0}(0,Ue),nc=fe*Gn;if(Xa>=nc||-Xa>=nc||(Sn=ln-(Th+(sr=ln-Th))+(sr-Eo),In=Ln-(Pl+(sr=Ln-Pl))+(sr-Eo),Dr=Jn-(Sh+(sr=Jn-Sh))+(sr-_o),yo=Jo-(Bu+(sr=Jo-Bu))+(sr-_o),Sn===0&&Dr===0&&In===0&&yo===0)||(nc=ke*Gn+Xt*Math.abs(Xa),(Xa+=Th*yo+Bu*Sn-(Sh*In+Pl*Dr))>=nc||-Xa>=nc))return Xa;je[0]=(wh=(is=Sn-(Ao=(fn=kt*Sn)-(fn-Sn)))*(Xs=Bu-(us=(fn=kt*Bu)-(fn-Bu)))-((Bs=Sn*Bu)-Ao*us-is*us-Ao*Xs))-((Po=wh-(Fu=(is=Dr-(Ao=(fn=kt*Dr)-(fn-Dr)))*(Xs=Pl-(us=(fn=kt*Pl)-(fn-Pl)))-((Al=Dr*Pl)-Ao*us-is*us-Ao*Xs)))+(sr=wh-Po))+(sr-Fu),je[1]=(Wc=Bs-((Fs=Bs+Po)-(sr=Fs-Bs))+(Po-sr))-((Po=Wc-Al)+(sr=Wc-Po))+(sr-Al),je[2]=Fs-((Xc=Fs+Po)-(sr=Xc-Fs))+(Po-sr),je[3]=Xc;var rf=te(4,Ue,4,je,Ze);je[0]=(wh=(is=Th-(Ao=(fn=kt*Th)-(fn-Th)))*(Xs=yo-(us=(fn=kt*yo)-(fn-yo)))-((Bs=Th*yo)-Ao*us-is*us-Ao*Xs))-((Po=wh-(Fu=(is=Sh-(Ao=(fn=kt*Sh)-(fn-Sh)))*(Xs=In-(us=(fn=kt*In)-(fn-In)))-((Al=Sh*In)-Ao*us-is*us-Ao*Xs)))+(sr=wh-Po))+(sr-Fu),je[1]=(Wc=Bs-((Fs=Bs+Po)-(sr=Fs-Bs))+(Po-sr))-((Po=Wc-Al)+(sr=Wc-Po))+(sr-Al),je[2]=Fs-((Xc=Fs+Po)-(sr=Xc-Fs))+(Po-sr),je[3]=Xc;var Sm=te(rf,Ze,4,je,hi);je[0]=(wh=(is=Sn-(Ao=(fn=kt*Sn)-(fn-Sn)))*(Xs=yo-(us=(fn=kt*yo)-(fn-yo)))-((Bs=Sn*yo)-Ao*us-is*us-Ao*Xs))-((Po=wh-(Fu=(is=Dr-(Ao=(fn=kt*Dr)-(fn-Dr)))*(Xs=In-(us=(fn=kt*In)-(fn-In)))-((Al=Dr*In)-Ao*us-is*us-Ao*Xs)))+(sr=wh-Po))+(sr-Fu),je[1]=(Wc=Bs-((Fs=Bs+Po)-(sr=Fs-Bs))+(Po-sr))-((Po=Wc-Al)+(sr=Wc-Po))+(sr-Al),je[2]=Fs-((Xc=Fs+Po)-(sr=Xc-Fs))+(Po-sr),je[3]=Xc;var u_=te(Sm,hi,4,je,Ke);return Ke[u_-1]}(Ve,gi,qi,ji,Cr,or,lr)}(Ft[0],Ft[1],zt[0],zt[1],Ne[0],Ne[1]);return pi>0?-1:pi<0?1:0}function Pe(Ft,zt){var Ne=Ft.point,pi=zt.point;return Ne[0]>pi[0]?1:Ne[0]<pi[0]?-1:Ne[1]!==pi[1]?Ne[1]>pi[1]?1:-1:function(Ve,gi,qi,ji){return Ve.left!==gi.left?Ve.left?1:-1:Ye(qi,Ve.otherEvent.point,gi.otherEvent.point)!==0?Ve.isBelow(gi.otherEvent.point)?-1:1:!Ve.isSubject&&gi.isSubject?1:-1}(Ft,zt,Ne)}function Ie(Ft,zt,Ne){var pi=new gt(zt,!1,Ft,Ft.isSubject),Ve=new gt(zt,!0,Ft.otherEvent,Ft.isSubject);return At(Ft.point,Ft.otherEvent.point)&&console.warn("what is that, a collapsed segment?",Ft),pi.contourId=Ve.contourId=Ft.contourId,Pe(Ve,Ft.otherEvent)>0&&(Ft.otherEvent.left=!0,Ve.left=!1),Ft.otherEvent.otherEvent=Ve,Ft.otherEvent=pi,Ne.push(Ve),Ne.push(pi),Ne}function He(Ft,zt){return Ft[0]*zt[1]-Ft[1]*zt[0]}function ai(Ft,zt){return Ft[0]*zt[0]+Ft[1]*zt[1]}function Ge(Ft,zt,Ne){var pi=function(Cr,or,Ni,vn,Yn){var lr=[or[0]-Cr[0],or[1]-Cr[1]],ln=[vn[0]-Ni[0],vn[1]-Ni[1]];function Jn(fn,Ao,is){return[fn[0]+Ao*is[0],fn[1]+Ao*is[1]]}var Ln=[Ni[0]-Cr[0],Ni[1]-Cr[1]],Jo=He(lr,ln),Eo=Jo*Jo,_o=ai(lr,lr);if(Eo>0){var Gn=He(Ln,ln)/Jo;if(Gn<0||Gn>1)return null;var Sn=He(Ln,lr)/Jo;return Sn<0||Sn>1?null:Gn===0||Gn===1?[Jn(Cr,Gn,lr)]:Sn===0||Sn===1?[Jn(Ni,Sn,ln)]:[Jn(Cr,Gn,lr)]}if((Eo=(Jo=He(Ln,lr))*Jo)>0)return null;var Dr=ai(lr,Ln)/_o,In=Dr+ai(lr,ln)/_o,yo=Math.min(Dr,In),sr=Math.max(Dr,In);return yo<=1&&sr>=0?yo===1?[Jn(Cr,yo>0?yo:0,lr)]:sr===0?[Jn(Cr,sr<1?sr:1,lr)]:[Jn(Cr,yo>0?yo:0,lr),Jn(Cr,sr<1?sr:1,lr)]:null}(Ft.point,Ft.otherEvent.point,zt.point,zt.otherEvent.point),Ve=pi?pi.length:0;if(Ve===0||Ve===1&&(At(Ft.point,zt.point)||At(Ft.otherEvent.point,zt.otherEvent.point))||Ve===2&&Ft.isSubject===zt.isSubject)return 0;if(Ve===1)return At(Ft.point,pi[0])||At(Ft.otherEvent.point,pi[0])||Ie(Ft,pi[0],Ne),At(zt.point,pi[0])||At(zt.otherEvent.point,pi[0])||Ie(zt,pi[0],Ne),1;var gi=[],qi=!1,ji=!1;return At(Ft.point,zt.point)?qi=!0:Pe(Ft,zt)===1?gi.push(zt,Ft):gi.push(Ft,zt),At(Ft.otherEvent.point,zt.otherEvent.point)?ji=!0:Pe(Ft.otherEvent,zt.otherEvent)===1?gi.push(zt.otherEvent,Ft.otherEvent):gi.push(Ft.otherEvent,zt.otherEvent),qi&&ji||qi?(zt.type=P,Ft.type=zt.inOut===Ft.inOut?R:F,qi&&!ji&&Ie(gi[1].otherEvent,gi[0].point,Ne),2):ji?(Ie(gi[0],gi[1].point,Ne),3):gi[0]!==gi[3].otherEvent?(Ie(gi[0],gi[1].point,Ne),Ie(gi[1],gi[2].point,Ne),3):(Ie(gi[0],gi[1].point,Ne),Ie(gi[3].otherEvent,gi[2].point,Ne),3)}function Pi(Ft,zt){if(Ft===zt)return 0;if(Ye(Ft.point,Ft.otherEvent.point,zt.point)!==0||Ye(Ft.point,Ft.otherEvent.point,zt.otherEvent.point)!==0)return At(Ft.point,zt.point)?Ft.isBelow(zt.otherEvent.point)?-1:1:Ft.point[0]===zt.point[0]?Ft.point[1]<zt.point[1]?-1:1:Pe(Ft,zt)===1?zt.isAbove(Ft.point)?-1:1:Ft.isBelow(zt.point)?-1:1;if(Ft.isSubject!==zt.isSubject)return Ft.isSubject?-1:1;var Ne=Ft.point,pi=zt.point;return Ne[0]===pi[0]&&Ne[1]===pi[1]?(Ne=Ft.otherEvent.point)[0]===(pi=zt.otherEvent.point)[0]&&Ne[1]===pi[1]?0:Ft.contourId>zt.contourId?1:-1:Pe(Ft,zt)===1?1:-1}var Bi=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function vi(Ft,zt,Ne,pi){var Ve,gi=Ft+1,qi=zt[Ft].point,ji=zt.length;for(gi<ji&&(Ve=zt[gi].point);gi<ji&&Ve[0]===qi[0]&&Ve[1]===qi[1];){if(!Ne[gi])return gi;++gi<ji&&(Ve=zt[gi].point)}for(gi=Ft-1;Ne[gi]&&gi>pi;)gi--;return gi}Bi.prototype.isExterior=function(){return this.holeOf==null};var mi=yi,_r=yi;function yi(Ft,zt){if(!(this instanceof yi))return new yi(Ft,zt);if(this.data=Ft||[],this.length=this.data.length,this.compare=zt||Yi,this.length>0)for(var Ne=(this.length>>1)-1;Ne>=0;Ne--)this._down(Ne)}function Yi(Ft,zt){return Ft<zt?-1:Ft>zt?1:0}yi.prototype={push:function(Ft){this.data.push(Ft),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var Ft=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),Ft}},peek:function(){return this.data[0]},_up:function(Ft){for(var zt=this.data,Ne=this.compare,pi=zt[Ft];Ft>0;){var Ve=Ft-1>>1,gi=zt[Ve];if(Ne(pi,gi)>=0)break;zt[Ft]=gi,Ft=Ve}zt[Ft]=pi},_down:function(Ft){for(var zt=this.data,Ne=this.compare,pi=this.length>>1,Ve=zt[Ft];Ft<pi;){var gi=1+(Ft<<1),qi=gi+1,ji=zt[gi];if(qi<this.length&&Ne(zt[qi],ji)<0&&(gi=qi,ji=zt[qi]),Ne(ji,Ve)>=0)break;zt[Ft]=ji,Ft=gi}zt[Ft]=Ve}},mi.default=_r;var wr=Math.max,Vr=Math.min,pn=0;function Tr(Ft,zt,Ne,pi,Ve,gi){var qi,ji,Cr,or,Ni,vn;for(qi=0,ji=Ft.length-1;qi<ji;qi++)if(or=Ft[qi+1],Ni=new gt(Cr=Ft[qi],!1,void 0,zt),vn=new gt(or,!1,Ni,zt),Ni.otherEvent=vn,Cr[0]!==or[0]||Cr[1]!==or[1]){Ni.contourId=vn.contourId=Ne,gi||(Ni.isExteriorRing=!1,vn.isExteriorRing=!1),Pe(Ni,vn)>0?vn.left=!0:Ni.left=!0;var Yn=Cr[0],lr=Cr[1];Ve[0]=Vr(Ve[0],Yn),Ve[1]=Vr(Ve[1],lr),Ve[2]=wr(Ve[2],Yn),Ve[3]=wr(Ve[3],lr),pi.push(Ni),pi.push(vn)}}var wn=[];function Tn(Ft,zt,Ne){typeof Ft[0][0][0]=="number"&&(Ft=[Ft]),typeof zt[0][0][0]=="number"&&(zt=[zt]);var pi=function(lr,ln,Jn){var Ln=null;return lr.length*ln.length==0&&(Jn===O?Ln=wn:Jn===q?Ln=lr:Jn!==$&&Jn!==Y||(Ln=lr.length===0?ln:lr)),Ln}(Ft,zt,Ne);if(pi)return pi===wn?null:pi;var Ve=[1/0,1/0,-1/0,-1/0],gi=[1/0,1/0,-1/0,-1/0],qi=function(lr,ln,Jn,Ln,Jo){var Eo,_o,Gn,Sn,Dr,In,yo=new mi(null,Pe);for(Gn=0,Sn=lr.length;Gn<Sn;Gn++)for(Dr=0,In=(Eo=lr[Gn]).length;Dr<In;Dr++)(_o=Dr===0)&&pn++,Tr(Eo[Dr],!0,pn,yo,Jn,_o);for(Gn=0,Sn=ln.length;Gn<Sn;Gn++)for(Dr=0,In=(Eo=ln[Gn]).length;Dr<In;Dr++)_o=Dr===0,Jo===q&&(_o=!1),_o&&pn++,Tr(Eo[Dr],!1,pn,yo,Ln,_o);return yo}(Ft,zt,Ve,gi,Ne);if(pi=function(lr,ln,Jn,Ln,Jo){var Eo=null;return(Jn[0]>Ln[2]||Ln[0]>Jn[2]||Jn[1]>Ln[3]||Ln[1]>Jn[3])&&(Jo===O?Eo=wn:Jo===q?Eo=lr:Jo!==$&&Jo!==Y||(Eo=lr.concat(ln))),Eo}(Ft,zt,Ve,gi,Ne))return pi===wn?null:pi;for(var ji=function(lr){var ln,Jn,Ln=function(Gn){var Sn,Dr,In,yo,sr=[];for(Dr=0,In=Gn.length;Dr<In;Dr++)((Sn=Gn[Dr]).left&&Sn.inResult||!Sn.left&&Sn.otherEvent.inResult)&&sr.push(Sn);for(var fn=!1;!fn;)for(fn=!0,Dr=0,In=sr.length;Dr<In;Dr++)Dr+1<In&&Pe(sr[Dr],sr[Dr+1])===1&&(yo=sr[Dr],sr[Dr]=sr[Dr+1],sr[Dr+1]=yo,fn=!1);for(Dr=0,In=sr.length;Dr<In;Dr++)(Sn=sr[Dr]).otherPos=Dr;for(Dr=0,In=sr.length;Dr<In;Dr++)(Sn=sr[Dr]).left||(yo=Sn.otherPos,Sn.otherPos=Sn.otherEvent.otherPos,Sn.otherEvent.otherPos=yo);return sr}(lr),Jo={},Eo=[],_o=function(){if(!Jo[ln]){var Gn=Eo.length,Sn=function(sr,fn,Ao){var is=new Bi;if(sr.prevInResult!=null){var us=sr.prevInResult,Xs=us.outputContourId;if(us.resultTransition>0){var Po=fn[Xs];if(Po.holeOf!=null){var Fs=Po.holeOf;fn[Fs].holeIds.push(Ao),is.holeOf=Fs,is.depth=fn[Xs].depth}else fn[Xs].holeIds.push(Ao),is.holeOf=Xs,is.depth=fn[Xs].depth+1}else is.holeOf=null,is.depth=fn[Xs].depth}else is.holeOf=null,is.depth=0;return is}(Ln[ln],Eo,Gn),Dr=function(sr){Jo[sr]=!0,sr<Ln.length&&Ln[sr]&&(Ln[sr].outputContourId=Gn)},In=ln,yo=ln;for(Sn.points.push(Ln[ln].point);Dr(In),Dr(In=Ln[In].otherPos),Sn.points.push(Ln[In].point),!((In=vi(In,Ln,Jo,yo))==yo||In>=Ln.length)&&Ln[In];);Eo.push(Sn)}};for(ln=0,Jn=Ln.length;ln<Jn;ln++)_o();return Eo}(function(lr,ln,Jn,Ln,Jo,Eo){for(var _o,Gn,Sn,Dr=new u(Pi),In=[],yo=Math.min(Ln[2],Jo[2]);lr.length!==0;){var sr=lr.pop();if(In.push(sr),Eo===O&&sr.point[0]>yo||Eo===q&&sr.point[0]>Ln[2])break;if(sr.left){Gn=_o=Dr.insert(sr),_o=_o!==(Sn=Dr.minNode())?Dr.prev(_o):null,Gn=Dr.next(Gn);var fn=_o?_o.key:null;if(it(sr,fn,Eo),Gn&&Ge(sr,Gn.key,lr)===2&&(it(sr,fn,Eo),it(Gn.key,sr,Eo)),_o&&Ge(_o.key,sr,lr)===2){var Ao=_o;it(fn,(Ao=Ao!==Sn?Dr.prev(Ao):null)?Ao.key:null,Eo),it(sr,fn,Eo)}}else Gn=_o=Dr.find(sr=sr.otherEvent),_o&&Gn&&(_o=_o!==Sn?Dr.prev(_o):null,Gn=Dr.next(Gn),Dr.remove(sr),Gn&&_o&&Ge(_o.key,Gn.key,lr))}return In}(qi,0,0,Ve,gi,Ne)),Cr=[],or=0;or<ji.length;or++){var Ni=ji[or];if(Ni.isExterior()){for(var vn=[Ni.points],Yn=0;Yn<Ni.holeIds.length;Yn++)vn.push(ji[Ni.holeIds[Yn]].points);Cr.push(vn)}}return Cr}var No={UNION:$,DIFFERENCE:q,INTERSECTION:O,XOR:Y};r.diff=function(Ft,zt){return Tn(Ft,zt,q)},r.intersection=function(Ft,zt){return Tn(Ft,zt,O)},r.operations=No,r.union=function(Ft,zt){return Tn(Ft,zt,$)},r.xor=function(Ft,zt){return Tn(Ft,zt,Y)},Object.defineProperty(r,"__esModule",{value:!0})})(t)}(0,L_.exports)),L_.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function Xm(n,t,r,l){const u=[],m=l===0?(_,b,E,P,R,F)=>{_.push(new Ae(F,E+(F-b)/(P-b)*(R-E)))}:(_,b,E,P,R,F)=>{_.push(new Ae(b+(F-E)/(R-E)*(P-b),F))};for(const _ of n){const b=[];for(const E of _){if(E.length<=2)continue;const P=[];for(let O=0;O<E.length-1;O++){const $=E[O].x,q=E[O].y,Y=E[O+1].x,it=E[O+1].y,at=l===0?$:q,gt=l===0?Y:it;at<t?gt>t&&m(P,$,q,Y,it,t):at>r?gt<r&&m(P,$,q,Y,it,r):P.push(E[O]),gt<t&&at>=t&&m(P,$,q,Y,it,t),gt>r&&at<=r&&m(P,$,q,Y,it,r)}let R=E[E.length-1];const F=l===0?R.x:R.y;F>=t&&F<=r&&P.push(R),P.length&&(R=P[P.length-1],P[0].x===R.x&&P[0].y===R.y||P.push(P[0]),b.push(P))}b.length&&u.push(b)}return u}function k_(n,t){const r=vd(n),l=vd([t]),u=R_.intersection(r,l);return u==null?[]:Zp(u)}function Jy(n,t){let l=vd(n,65536);const u=[];for(;t.valid();t.next()){const[m,_]=t.get(),b=m.x*65536,E=m.y*65536,P=_.x*65536,R=_.y*65536,F=P-b,O=R-E,$=Math.hypot(F,O);if($===0)continue;const q=Math.trunc(O/$*3),Y=-Math.trunc(F/$*3);u.push([[[b,E],[P,R],[P+q,R+Y],[b+q,E+Y],[b,E]]])}return u.length>0&&(l=R_.diff(l,u)),Zp(l,1/65536)}function vd(n,t=1){return[n.map(r=>r.map(l=>[l.x*t,l.y*t]))]}function Zp(n,t=1){return n.map(r=>r.map((l,u)=>{const m=l.map(_=>new Ae(_[0]*t,_[1]*t).round());return u>0&&m.reverse(),m}))}class um{constructor(t,r){this.layoutVertexArray=new As,this.indexArray=new ro,this.lineIndexArray=new Nl,this.triangleSegments=new To,this.lineSegments=new To,this.programConfigurations=new _h(t.layers,{zoom:t.zoom,lut:t.lut}),this.uploaded=!1,r&&(this.elevatedLayoutVertexArray=new $s)}update(t,r,l,u,m,_,b,E){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Rg.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.lineIndexBuffer=t.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=t.createVertexBuffer(this.elevatedLayoutVertexArray,$y.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(t,r,l,u,m,_,b){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,l,u,m,_,void 0,b)}}class Mf{constructor(t){this.zoom=t.zoom,this.pixelRatio=t.pixelRatio,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=t.lut,this.bufferData=new um(t,!1),this.elevationBufferData=new um(t,!0),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.projection=t.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=t.sourceLayerIndex,this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.hasPattern=ia("fill",this.layers,this.pixelRatio,r);const m=this.layers[0].layout.get("fill-sort-key"),_=[];for(const{feature:b,id:E,index:P,sourceLayerIndex:R}of t){const F=this.layers[0]._featureFilter.needGeometry,O=Te(b,F);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),O,l))continue;const $=m?m.evaluate(O,{},l,r.availableImages):void 0,q={id:E,properties:b.properties,type:b.type,sourceLayerIndex:R,index:P,geometry:F?O.geometry:Oe(b,l,u),patterns:{},sortKey:$};_.push(q)}m&&_.sort((b,E)=>b.sortKey-E.sortKey);for(const b of _){const{geometry:E,index:P,sourceLayerIndex:R}=b;if(this.hasPattern){const F=hm("fill",this.layers,b,this.zoom,this.pixelRatio,r);this.patternFeatures.push(F)}else this.addFeature(b,E,P,l,{},r.availableImages,r.brightness,r.elevationFeatures);r.featureIndex.insert(t[P].feature,E,P,R,this.index)}}update(t,r,l,u,m,_,b){this.bufferData.update(t,r,l,u,m,_,b,this.worldview),this.elevationBufferData.update(t,r,l,u,m,_,b,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(t,r,l,u,m,_,b,this.worldview)}addFeatures(t,r,l,u,m,_){for(const b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,r,l,u,_,t.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(t){this.bufferData.upload(t),this.elevationBufferData.upload(t),this.elevatedStructures&&this.elevatedStructures.upload(t)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(t,r,l,u,m,_=[],b,E){const P=cm(r,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(t,P,u,l,E):this.addGeometry(P,this.bufferData),this.bufferData.populatePaintArrays(t,l,m,_,u,b,this.worldview),this.elevationBufferData.populatePaintArrays(t,l,m,_,u,b,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(t,r,l,u,m){this.elevatedStructures&&(this.elevatedStructures.construct(t),this.elevatedStructures.populatePaintArrays(r,l,u,m,this.worldview))}addElevatedRoadFeature(t,r,l,u,m){const _=new Array,b=mr.getElevationFeature(t,m);if(!b)return void this.addGeometry(r,this.bufferData);{const P=this.clipPolygonsToTile(r,1);P.length>0&&_.push({polygons:P,elevationFeature:b,elevationTileID:l})}const E={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(t,{},l),featureIndex:u};for(const P of _)if(P.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Ua(P.elevationTileID,this.layers,this.zoom,this.lut));const F=P.elevationFeature.isTunnel();let O=0;t.properties.hasOwnProperty(Ai)&&(O=+t.properties[Ai]);for(const $ of P.polygons)this.elevatedStructures.addPortalCandidates(P.elevationFeature.id,$,F,P.elevationFeature,O)}P.elevationFeature.constantHeight==null&&(P.polygons=this.prepareElevatedPolygons(P.polygons,P.elevationFeature,P.elevationTileID));const R=new nn(l,P.elevationTileID);this.addElevatedGeometry(P.polygons,R,P.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,u,E)}}addElevatedGeometry(t,r,l,u,m,_){const b={elevation:l,elevationSampler:r,bias:u,index:m,featureInfo:_},[E,P]=this.addGeometry(t,this.elevationBufferData,b);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:E,max:P}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,E),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,P))}addGeometry(t,r,l){let u=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,_=null;l&&(_=l.elevationSampler.constantElevation(l.elevation,l.bias),_!=null&&(u=_,m=_));const b=(E,P,R)=>{if(l!=null)if(P.push(E),_!=null)r.elevatedLayoutVertexArray.emplaceBack(_),R.push(_);else{const F=l.elevationSampler.pointElevation(E,l.elevation,l.bias);r.elevatedLayoutVertexArray.emplaceBack(F),R.push(F),u=Math.min(u,F),m=Math.max(m,F)}};for(const E of t){let P=0;for(const yt of E)P+=yt.length;const R=r.triangleSegments.prepareSegment(P,r.layoutVertexArray,r.indexArray),F=R.vertexLength,O=[],$=[],q=[],Y=[],it=[],at=r.layoutVertexArray.length;for(const yt of E){if(yt.length===0)continue;yt!==E[0]&&$.push(O.length/2);const At=r.lineSegments.prepareSegment(yt.length,r.layoutVertexArray,r.lineIndexArray),Gt=At.vertexLength;l&&it.push(r.layoutVertexArray.length-at),b(yt[0],q,Y),r.layoutVertexArray.emplaceBack(yt[0].x,yt[0].y),r.lineIndexArray.emplaceBack(Gt+yt.length-1,Gt),O.push(yt[0].x),O.push(yt[0].y);for(let kt=1;kt<yt.length;kt++)b(yt[kt],q,Y),r.layoutVertexArray.emplaceBack(yt[kt].x,yt[kt].y),r.lineIndexArray.emplaceBack(Gt+kt-1,Gt+kt),O.push(yt[kt].x),O.push(yt[kt].y);At.vertexLength+=yt.length,At.primitiveLength+=yt.length}const gt=$p(O,$);for(let yt=0;yt<gt.length;yt+=3)r.indexArray.emplaceBack(F+gt[yt],F+gt[yt+1],F+gt[yt+2]);if(gt.length>0&&l&&this.elevationMode==="hd-road-base"){const yt=l.elevation.isTunnel(),At=l.elevation.safeArea,Gt=this.elevatedStructures.addVertices(q,Y);this.elevatedStructures.addTriangles(gt,Gt,yt);const kt=it.length;if(kt>0){for(let Xt=0;Xt<kt-1;Xt++)this.elevatedStructures.addRenderableRing(l.index,it[Xt]+Gt,it[Xt+1]-it[Xt],yt,At,l.featureInfo);this.elevatedStructures.addRenderableRing(l.index,it[kt-1]+Gt,q.length-it[kt-1],yt,At,l.featureInfo)}}R.vertexLength+=P,R.primitiveLength+=gt.length/3}return[u,m]}prepareElevatedPolygons(t,r,l){const u=1/Zt(l),m=[];for(const _ of t){const b=Jy(_,new fo(r,u));m.push(...b)}return m}clipPolygonsToTile(t,r){const l=-r,u=-r,m=ri+r,_=ri+r;let b=0;const E=[],P=[];for(;b<t.length;b++){const O=t[b],$=Pd(O);($.min.x>=l&&$.max.x<=m&&$.min.y>=u&&$.max.y<=_?E:P).push(O)}if(E.length===t.length)return t;const R=[new Ae(l,u),new Ae(m,u),new Ae(m,_),new Ae(l,_),new Ae(l,u)],F=E;for(const O of P)F.push(...k_(O,R));return F}}let Sl,nu,xn,F_;Ei(Mf,"FillBucket",{omit:["layers","patternFeatures"]}),Ei(um,"FillBufferData"),Ei(Ua,"ElevatedStructures");class Ym{constructor(t,r,l,u){if(this.triangleCount=r.length/3,this.min=new Ae(0,0),this.max=new Ae(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||t.length===0)return;const[m,_]=[t[0].clone(),t[0].clone()];for(let F=1;F<t.length;++F){const O=t[F];m.x=Math.min(m.x,O.x),m.y=Math.min(m.y,O.y),_.x=Math.max(_.x,O.x),_.y=Math.max(_.y,O.y)}if(u){const F=Math.ceil(Math.max(_.x-m.x,_.y-m.y)/u);l=Math.max(l,F)}if(l===0)return;this.min=m,this.max=_;const b=this.max.sub(this.min);b.x=Math.max(b.x,1),b.y=Math.max(b.y,1);const E=Math.max(b.x,b.y)/l;this.cellsX=Math.max(1,Math.ceil(b.x/E)),this.cellsY=Math.max(1,Math.ceil(b.y/E)),this.xScale=1/E,this.yScale=1/E;const P=[];for(let F=0;F<this.triangleCount;F++){const O=t[r[3*F+0]].sub(this.min),$=t[r[3*F+1]].sub(this.min),q=t[r[3*F+2]].sub(this.min),Y=Ec(Math.floor(Math.min(O.x,$.x,q.x)),this.xScale,this.cellsX),it=Ec(Math.floor(Math.max(O.x,$.x,q.x)),this.xScale,this.cellsX),at=Ec(Math.floor(Math.min(O.y,$.y,q.y)),this.yScale,this.cellsY),gt=Ec(Math.floor(Math.max(O.y,$.y,q.y)),this.yScale,this.cellsY),yt=new Ae(0,0),At=new Ae(0,0),Gt=new Ae(0,0),kt=new Ae(0,0);for(let Xt=at;Xt<=gt;++Xt){yt.y=At.y=Xt*E,Gt.y=kt.y=(Xt+1)*E;for(let te=Y;te<=it;++te)yt.x=Gt.x=te*E,At.x=kt.x=(te+1)*E,(Qo(O,$,q,yt,At,kt)||Qo(O,$,q,yt,kt,Gt))&&P.push({cellIdx:Xt*this.cellsX+te,triIdx:F})}}if(P.length===0)return;P.sort((F,O)=>F.cellIdx-O.cellIdx||F.triIdx-O.triIdx);let R=0;for(;R<P.length;){const F=P[R].cellIdx,O={start:this.payload.length,len:0};for(;R<P.length&&P[R].cellIdx===F;)++O.len,this.payload.push(P[R++].triIdx);this.cells[F]=O}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(t,r){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>t.x||t.y>this.max.y||this.min.y>t.y)return;const l=Ec(t.x-this.min.x,this.xScale,this.cellsX),u=Ec(t.y-this.min.y,this.yScale,this.cellsY),m=this.cells[u*this.cellsX+l];if(m){this._lazyInitLookup();for(let _=0;_<m.len;_++){const b=this.payload[m.start+_],E=Math.floor(b/8),P=1<<b%8;if(!(this.lookup[E]&P)&&(this.lookup[E]|=P,r.push(b),r.length===this.triangleCount))return}}}query(t,r,l){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>r.x||t.y>this.max.y||this.min.y>r.y)return;this._lazyInitLookup();const u=Ec(t.x-this.min.x,this.xScale,this.cellsX),m=Ec(r.x-this.min.x,this.xScale,this.cellsX),_=Ec(t.y-this.min.y,this.yScale,this.cellsY),b=Ec(r.y-this.min.y,this.yScale,this.cellsY);for(let E=_;E<=b;E++)for(let P=u;P<=m;P++){const R=this.cells[E*this.cellsX+P];if(R)for(let F=0;F<R.len;F++){const O=this.payload[R.start+F],$=Math.floor(O/8),q=1<<O%8;if(!(this.lookup[$]&q)&&(this.lookup[$]|=q,l.push(O),l.length===this.triangleCount))return}}}}function Ec(n,t,r){return Math.max(0,Math.min(r-1,Math.floor(n*t)))}Ei(Ym,"TriangleGridIndex");class Ky{constructor(t){this.zoom=t.zoom,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.footprints=[],this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){for(const l of this.footprints)r.push({footprint:l,id:t})}updateAppearances(t,r,l,u){}populate(t,r,l,u){const m=[];for(const{feature:_,id:b,index:E,sourceLayerIndex:P}of t){const R=this.layers[0]._featureFilter.needGeometry,F=Te(_,R);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),F,l))continue;const O={id:b,properties:_.properties,type:_.type,sourceLayerIndex:P,index:E,geometry:R?F.geometry:Oe(_,l,u),patterns:{}};m.push(O)}for(const _ of m){const{geometry:b,index:E,sourceLayerIndex:P}=_;this.addFeature(_,b,E,l,{},r.availableImages,r.brightness),r.featureIndex.insert(t[E].feature,b,E,P,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(t){}update(t,r,l,u,m,_,b){}destroy(){}addFeature(t,r,l,u,m,_=[],b){for(const E of cm(r,2)){const P=[],R=[],F=[],O=new Ae(1/0,1/0),$=new Ae(-1/0,-1/0);for(const it of E)if(it.length!==0){it!==E[0]&&F.push(R.length/2);for(let at=0;at<it.length;at++)R.push(it[at].x),R.push(it[at].y),P.push(it[at]),O.x=Math.min(O.x,it[at].x),O.y=Math.min(O.y,it[at].y),$.x=Math.max($.x,it[at].x),$.y=Math.max($.y,it[at].y)}const q=$p(R,F),Y=new Ym(P,q,8,256);this.footprints.push({vertices:P,indices:q,grid:Y,min:O,max:$})}}}Ei(Ky,"ClipBucket",{omit:["layers"]});const dm=Er([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),sx=Er([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Qy=Er([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),Bg=Er([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Og=Er([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Ng=Er([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),B_=Er([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:O_}=dm,Cf=Number.MAX_SAFE_INTEGER,N_=Cf-1;function pm(n,t,r,l){return n.order<t||n.order===Cf||!(n.clipMask&r)||function(u,m){return m.length!==0&&m.find(_=>_===u)===void 0}(l,n.clipScope)}function Hp(n,t){return n.x-t.x||n.y-t.y}function V_(n,t){return Hp(n.min,t.min)===0&&Hp(n.max,t.max)===0}function fm(n,t){return!(n.min.x>t.max.x||n.max.x<t.min.x||n.min.y>t.max.y||n.max.y<t.min.y)}function Df(n,t){if(n.length!==t.length)return!1;for(let r=0;r<n.length;r++)if(n[r].sourceId!==t[r].sourceId||!V_(n[r],t[r])||n[r].order!==t[r].order||n[r].clipMask!==t[r].clipMask||!Do(n[r].clipScope,t[r].clipScope))return!1;return!0}function t0(n,t,r){const l=1/ri,u=1/(1<<r.canonical.z),m=(t.x*l+r.canonical.x)*u+r.wrap,_=(t.y*l+r.canonical.y)*u;return{min:new Ae((n.x*l+r.canonical.x)*u+r.wrap,(n.y*l+r.canonical.y)*u),max:new Ae(m,_)}}function U_(n,t,r){const l=1<<r.canonical.z,u=((t.x-r.wrap)*l-r.canonical.x)*ri,m=(t.y*l-r.canonical.y)*ri;return{min:new Ae(((n.x-r.wrap)*l-r.canonical.x)*ri,(n.y*l-r.canonical.y)*ri),max:new Ae(u,m)}}function Vg(n,t,r,l,u,m,_){const b=n.indices,E=n.vertices,P=[];for(let R=l;R<l+u;R+=3){const F=t[r[R+0]+m],O=t[r[R+1]+m],$=t[r[R+2]+m],q=Math.min(F.x,O.x,$.x),Y=Math.max(F.x,O.x,$.x),it=Math.min(F.y,O.y,$.y),at=Math.max(F.y,O.y,$.y);P.length=0,n.grid.query(new Ae(q,it),new Ae(Y,at),P);for(let gt=0;gt<P.length;gt++){const yt=P[gt];if(Qo(E[b[3*yt+0]],E[b[3*yt+1]],E[b[3*yt+2]],F,O,$,_))return!0}}return!1}function e0(n,t,r,l){if(!n||!r)return!1;let u=n.vertices;if(!t.canonical.equals(l.canonical)||t.wrap!==l.wrap){if(r.vertices.length<n.vertices.length)return e0(r,l,n,t);const m=t.canonical,_=l.canonical,b=Math.pow(2,_.z-m.z);u=n.vertices.map(E=>new Ae((E.x+m.x*ri)*b-_.x*ri,(E.y+m.y*ri)*b-_.y*ri))}return Vg(r,u,n.indices,0,n.indices.length,0,0)}function i0(n,t,r,l){const u=Math.pow(2,l.z-r.z);return new Ae((n+r.x*ri)*u-l.x*ri,(t+r.y*ri)*u-l.y*ri)}function Ug(n,t){const r=[];t.grid.queryPoint(n,r);const l=t.indices,u=t.vertices;for(let m=0;m<r.length;m++){const _=r[m];if(qs([u[l[3*_+0]],u[l[3*_+1]],u[l[3*_+2]]],n))return!0}return!1}const j_=[new Ae(0,0),new Ae(ri,0),new Ae(ri,ri),new Ae(0,ri)];function mm(n,t){const r=[];let l=[];if(!t||n.length<2)return[n];if(n.length===2)return Go(n[0],n[1],j_)?[n]:[];for(let u=0;u<n.length+2;u++){const m=n[u%n.length],_=n[(u+1)%n.length],b=Go(u===0?n[n.length-1]:n[(u-1)%n.length],m,j_),E=Go(m,_,j_),P=b||E;P&&l.push(m),P&&E||l.length>0&&(l.length>1&&r.push(l),l=[])}return l.length>1&&r.push(l),r}const jg=qe.types,ax=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],G_=["fill-extrusion-flood-light-ground-radius"],$_=Math.pow(2,13),r0=Math.pow(2,15)-1,zf=new Ae(0,1),Qd=2147483648,Jm=7,n0=450;function tp(n,t,r,l,u,m,_,b){n.emplaceBack((t<<1)+_,(r<<1)+m,(Math.floor(l*$_)<<1)+u,Math.round(b))}function Wp(n,t,r){n.emplaceBack(t.x*ri,t.y*ri,r?1:0)}function Gg(n,t,r,l,u,m){n.emplaceBack(t.x,t.y,(r.x<<1)+l,(r.y<<1)+u,m)}function gm(n,t,r){n.emplaceBack(t.x,t.y,t.z,r[0]*16384,r[1]*16384,r[2]*16384)}class q_{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class o0{constructor(){this.centroidXY=new Ae(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Ae(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Ae(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Ae(this.max.x-this.min.x,this.max.y-this.min.y)}}class s0{constructor(){this.acc=new Ae(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(t,r){t.min.x===Number.MAX_VALUE&&(t.min.x=t.max.x=r.x,t.min.y=t.max.y=r.y)}appendEdge(t,r,l){this.accCount++,this.acc._add(r);let u=!!this.borders;r.x<t.min.x?(t.min.x=r.x,u=!0):r.x>t.max.x&&(t.max.x=r.x,u=!0),r.y<t.min.y?(t.min.y=r.y,u=!0):r.y>t.max.y&&(t.max.y=r.y,u=!0),((r.x===0||r.x===ri)&&r.x===l.x)!=((r.y===0||r.y===ri)&&r.y===l.y)&&this.processBorderOverlap(r,l),u&&this.checkBorderIntersection(r,l)}checkBorderIntersection(t,r){r.x<0!=t.x<0&&this.addBorderIntersection(0,Gi(r.y,t.y,(0-r.x)/(t.x-r.x))),r.x>ri!=t.x>ri&&this.addBorderIntersection(1,Gi(r.y,t.y,(ri-r.x)/(t.x-r.x))),r.y<0!=t.y<0&&this.addBorderIntersection(2,Gi(r.x,t.x,(0-r.y)/(t.y-r.y))),r.y>ri!=t.y>ri&&this.addBorderIntersection(3,Gi(r.x,t.x,(ri-r.y)/(t.y-r.y)))}addBorderIntersection(t,r){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const l=this.borders[t];r<l[0]&&(l[0]=r),r>l[1]&&(l[1]=r)}processBorderOverlap(t,r){if(t.x===r.x){if(t.y===r.y)return;const l=t.x===0?0:1;this.addBorderIntersection(l,r.y),this.addBorderIntersection(l,t.y)}else{const l=t.y===0?2:3;this.addBorderIntersection(l,r.x),this.addBorderIntersection(l,t.x)}}centroid(){return this.accCount===0?new Ae(0,0):new Ae(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((t,r)=>t+ +(r[0]!==Number.MAX_VALUE),0):0}}function a0(n,t){const r=n.add(t)._unit(),l=tt(n.x*r.x+n.y*r.y,-1,1);var u,m,_;return u=Math.acos(l),Math.min(4,Math.max(-4,Math.tan(u)))/4*r0*((m=n).x*(_=t).y-m.y*_.x<0?-1:1)}const lx=[n=>n.x<0,n=>n.x>ri,n=>n.y<0,n=>n.y>ri];function cx(n,t,r,l){const u=[4];if(l===0)return u;r._mult(l);const m=n.sub(r),_=t.sub(r),b=[n,t,m,_];for(let E=0;E<4;E++)for(const P of b)if(lx[E](P)){u.push(E);break}return u}class $g{constructor(t){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new ec,this.indexArray=new ro,this.programConfigurations=new _h(t.layers,{zoom:t.zoom,lut:t.lut},r=>G_.includes(r)),this._segments=new To,this.hiddenByLandmarkVertexArray=new wf,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new To}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(t,r,l,u=!1){const m=t.length;if(m>2){let _=Math.max(0,this._segments.get().length-1);const b=this._segments._prepareSegment(4*m,this.vertexArray.length,2*this._segmentToGroundQuads[_].length);let E;_!==this._segments.get().length-1&&(_++,this._segmentToGroundQuads[_]=[],this._segmentToRegionTriCounts[_]=[0,0,0,0,0]);{const P=t[0],R=t[1];E=a0(P.sub(t[m-1])._perp()._unit(),R.sub(P)._perp()._unit())}for(let P=0;P<m;P++){const R=P===m-1?0:P+1,F=t[P],O=t[R],$=t[R===m-1?0:R+1],q=O.sub(F)._perp()._unit(),Y=a0(q,$.sub(O)._perp()._unit()),it=E,at=Y;if(H_(F,O,r)||u&&W_(F,r)&&W_(O,r)){E=Y;continue}const gt=b.vertexLength;Gg(this.vertexArray,F,O,1,1,it),Gg(this.vertexArray,F,O,1,0,it),Gg(this.vertexArray,F,O,0,1,at),Gg(this.vertexArray,F,O,0,0,at),b.vertexLength+=4;const yt=cx(F,O,q,l);for(const At of yt)this._segmentToGroundQuads[_].push({id:gt,region:At}),this._segmentToRegionTriCounts[_][At]+=2,b.primitiveLength+=2;E=Y}}}prepareBorderSegments(){if(!this.hasData())return;const t=this._segments.get(),r=t.length;for(let l=0;l<r;l++)this._segmentToGroundQuads[l].sort((u,m)=>u.region-m.region);for(let l=0;l<r;l++){const u=this._segmentToGroundQuads[l],m=t[l],_=this._segmentToRegionTriCounts[l];_.reduce((E,P)=>E+P,0);let b=0;for(let E=0;E<=4;E++){const P=_[E];if(P!==0){let R=this.regionSegments[E];R||(R=this.regionSegments[E]=new To);const F={vertexOffset:m.vertexOffset,primitiveOffset:m.primitiveOffset+b,vertexLength:m.vertexLength,primitiveLength:P};R.get().push(F)}b+=P}for(let E=0;E<u.length;E++){const P=u[E].id;this.indexArray.emplaceBack(P,P+1,P+3),this.indexArray.emplaceBack(P,P+3,P+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(t,r,l,u,m,_,b){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,t,r,l,u,m,_,void 0,b)}upload(t){this.hasData()&&(this.vertexBuffer=t.createVertexBuffer(this.vertexArray,sx.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=t.createVertexBuffer(this.groundRadiusArray,Qy.members)))}uploadPaintProperties(t){this.hasData()&&this.programConfigurations.upload(t)}update(t,r,l,u,m,_,b,E){this.hasData()&&this.programConfigurations.updatePaintArrays(t,r,l,u,m,_,b,E)}updateHiddenByLandmark(t){this.updateHiddenByLandmarkRange(t.groundVertexArrayOffset,t.groundVertexCount,!!(t.flags&Qd))}updateHiddenByLandmarkRange(t,r,l){if(!this.hasData())return;const u=r+t;if(r!==0){for(let m=t;m<u;++m)this.hiddenByLandmarkVertexArray.emplace(m,l?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(t){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=t.createVertexBuffer(this.hiddenByLandmarkVertexArray,Ng.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let t=0;t<=4;t++){const r=this.regionSegments[t];r&&r.destroy()}}}}class bd{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.pixelRatio=t.pixelRatio,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ro,this.footprintVertices=new As,this.footprintSegments=[],this.layoutVertexArray=new tc,this.centroidVertexArray=new em,this.wallVertexArray=new km,this.indexArray=new ro,this.programConfigurations=new _h(t.layers,{zoom:t.zoom,lut:t.lut},r=>ax.includes(r)),this.segments=new To,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.groundEffect=new $g(t),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.features=[],this.hasPattern=ia("fill-extrusion",this.layers,this.pixelRatio,r),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Zt(l),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:m,id:_,index:b,sourceLayerIndex:E}of t){const P=this.layers[0]._featureFilter.needGeometry,R=Te(m,P);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),R,l))continue;const F={id:_,sourceLayerIndex:E,index:b,geometry:P?R.geometry:Oe(m,l,u),properties:m.properties,type:m.type,patterns:{}},O=this.layoutVertexArray.length,$=jg[F.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:m.id,feature:hm("fill-extrusion",this.layers,F,this.zoom,this.pixelRatio,r)});else if(this.wallMode)for(const q of F.geometry)for(const Y of mm(q,$))this.addFeature(m.id,F,[Y],b,l,{},r.availableImages,u,r.brightness);else this.addFeature(m.id,F,F.geometry,b,l,{},r.availableImages,u,r.brightness);r.featureIndex.insert(m,F.geometry,b,E,this.index,O)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(t,r,l,u,m,_){for(const{featureId:b,feature:E}of this.features){const P=jg[E.type]==="Polygon",{geometry:R}=E;if(this.wallMode)for(const F of R)for(const O of mm(F,P))this.addFeature(b,E,[O],E.index,r,l,u,m,_);else this.addFeature(b,E,R,E.index,r,l,u,m,_)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(t,r,l,u,m,_,b){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview),this.groundEffect.update(t,r,m,l,u,_,b,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,O_),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.wallVertexBuffer=t.createVertexBuffer(this.wallVertexArray,Og.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,B_.members,!0)),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.groundEffect.uploadHiddenByLandmark(t),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,Bg.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,r,l,u,m,_,b,E,P){const R=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(r,{})/this.tileToMeter,F=[new Ae(0,0),new Ae(ri,ri)],O=E.projection,$=O.name==="globe",q=this.wallMode||jg[r.type]==="Polygon",Y=new s0;Y.centroidDataIndex=this.centroidData.length;const it=new o0;it.buildingId=t,r.properties&&r.properties.hasOwnProperty("building_id")&&(it.buildingId=r.properties.building_id);const at=this.layers[0].paint.get("fill-extrusion-base").evaluate(r,{},m)<=0,gt=this.layers[0].paint.get("fill-extrusion-height").evaluate(r,{},m);let yt;if(it.height=gt,it.vertexArrayOffset=this.layoutVertexArray.length,it.groundVertexArrayOffset=this.groundEffect.vertexArray.length,$&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ys),this.wallMode){if($)return void Hi("Non zero fill-extrusion-line-width is not yet supported on globe.");if(l.length!==1)return;yt=function(fe){const ke=fe[0].x===fe[fe.length-1].x&&fe[0].y===fe[fe.length-1].y;(function(vi){let mi=0;const _r=vi.length;for(let yi=0;yi<_r;yi++)mi+=(vi[(yi+1)%_r].x-vi[yi].x)*(vi[(yi+1)%_r].y+vi[yi].y);return mi>=0})(fe)||(fe=fe.reverse());const Ze={geometry:[],joinNormals:[],indices:[]},hi=[],Ke=[],je=[];let Ye=fe.length;for(;Ye>=2&&fe[Ye-1].equals(fe[Ye-2]);)Ye--;if(Ye<(ke?3:2))return Ze;let Pe,Ie,He,ai,Ge,Pi=0;for(;Pi<Ye-1&&fe[Pi].equals(fe[Pi+1]);)Pi++;ke&&(Pe=fe[Ye-2],Ge=fe[Pi].sub(Pe)._unit()._perp());for(let vi=Pi;vi<Ye;vi++){if(He=vi===Ye-1?ke?fe[Pi+1]:void 0:fe[vi+1],He&&fe[vi].equals(He))continue;Ge&&(ai=Ge),Pe&&(Ie=Pe),Pe=fe[vi],Ge=He?He.sub(Pe)._unit()._perp():ai,ai=ai||Ge;let mi=ai.add(Ge);mi.x===0&&mi.y===0||mi._unit();const _r=mi.x*Ge.x+mi.y*Ge.y,yi=_r!==0?1/_r:1/0,Yi=ai.x*Ge.y-ai.y*Ge.x>0;let wr="miter";const Vr=2;wr==="miter"&&yi>Vr&&(wr="bevel"),wr==="bevel"&&(yi>100&&(wr="flipbevel"),yi<Vr&&(wr="miter"));const pn=(Tr,wn,Tn,No)=>{const Ft=new Ae(Tr.x,Tr.y),zt=new Ae(Tr.x,Tr.y);Ft.x+=wn.x*No,Ft.y+=wn.y*No,zt.x-=wn.x*Math.max(Tn,1),zt.y-=wn.y*Math.max(Tn,1),je.push(wn),hi.push(Ft),Ke.push(zt)};if(wr==="miter")mi._mult(yi),pn(Pe,mi,0,0);else if(wr==="flipbevel")mi=Ge.mult(-1),pn(Pe,mi,0,0),pn(Pe,mi.mult(-1),0,0);else{const Tr=-Math.sqrt(yi*yi-1),wn=Yi?Tr:0,Tn=Yi?0:Tr;Ie&&pn(Pe,ai,wn,Tn),He&&pn(Pe,Ge,wn,Tn)}}Ze.geometry=[...hi,...Ke.reverse(),hi[0]],Ze.joinNormals=[...je,...je.reverse(),je[je.length-1]];const Bi=Ze.geometry.length-1;for(let vi=0;vi<Bi/2;vi++)if(vi+1<Bi/2){let mi=vi,_r=vi+1,yi=Bi-1-vi,Yi=Bi-2-vi;mi=mi===0?Bi-1:mi-1,_r=_r===0?Bi-1:_r-1,yi=yi===0?Bi-1:yi-1,Yi=Yi===0?Bi-1:Yi-1,Ze.indices.push(yi),Ze.indices.push(_r),Ze.indices.push(mi),Ze.indices.push(yi),Ze.indices.push(Yi),Ze.indices.push(_r)}return Ze}(l[0]),l=[yt.geometry]}const At=(fe,ke)=>fe<(ke.length-1)/2||fe===ke.length-1,Gt=this.wallMode?[l]:cm(l,500);for(let fe=Gt.length-1;fe>=0;fe--){const ke=Gt[fe];(ke.length===0||(kt=ke[0]).every(Ue=>Ue.x<=0)||kt.every(Ue=>Ue.x>=ri)||kt.every(Ue=>Ue.y<=0)||kt.every(Ue=>Ue.y>=ri))&&Gt.splice(fe,1)}var kt;let Xt;if($)Xt=h0(Gt,F,m);else{Xt=[];for(const fe of Gt)Xt.push({polygon:fe,bounds:F})}const te=q?this.edgeRadius:0,ne=te>0&&this.zoom<17,ze=(fe,ke)=>{if(fe.length===0)return!1;const Ue=fe[fe.length-1];return ke.x===Ue.x&&ke.y===Ue.y};for(const{polygon:fe,bounds:ke}of Xt){let Ue=0,Ze=0;for(const Ye of fe)q&&!Ye[0].equals(Ye[Ye.length-1])&&Ye.push(Ye[0]),Ze+=q?Ye.length-1:Ye.length;const hi=this.segments.prepareSegment((q?5:4)*Ze,this.layoutVertexArray,this.indexArray);it.footprintSegIdx<0&&(it.footprintSegIdx=this.footprintSegments.length),it.polygonSegIdx<0&&(it.polygonSegIdx=this.polygonSegments.length);const Ke={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},je=new q_;if(je.vertexOffset=this.footprintVertices.length,je.indexOffset=3*this.footprintIndices.length,je.ringIndices=[],q){const Ye=[],Pe=[];Ue=hi.vertexLength;for(let He=0;He<fe.length;He++){const ai=fe[He];ai.length&&He!==0&&Pe.push(Ye.length/2);const Ge=[];let Pi,Bi;Pi=ai[1].sub(ai[0])._perp()._unit(),je.ringIndices.push(ai.length-1);for(let vi=1;vi<ai.length;vi++){const mi=ai[vi],_r=ai[vi===ai.length-1?1:vi+1],yi=mi.clone();if(te){Bi=_r.sub(mi)._perp()._unit();const Yi=Pi.add(Bi)._unit(),wr=te*Math.min(4,1/(Pi.x*Yi.x+Pi.y*Yi.y));yi.x+=wr*Yi.x,yi.y+=wr*Yi.y,yi.x=Math.round(yi.x),yi.y=Math.round(yi.y),Pi=Bi}if(!at||te!==0&&!ne||ze(Ge,yi)||Ge.push(yi),tp(this.layoutVertexArray,yi.x,yi.y,0,0,1,1,0),this.wallMode){const Yi=At(vi,ai);Wp(this.wallVertexArray,yt.joinNormals[vi],!Yi)}hi.vertexLength++,this.footprintVertices.emplaceBack(mi.x,mi.y),Ye.push(mi.x,mi.y),$&&gm(this.layoutVertexExtArray,O.projectTilePoint(yi.x,yi.y,m),O.upVector(m,yi.x,yi.y))}at&&(te===0||ne)&&(Ge.length!==0&&ze(Ge,Ge[0])&&Ge.pop(),this.groundEffect.addData(Ge,ke,R))}const Ie=this.wallMode?yt.indices:$p(Ye,Pe);for(let He=0;He<Ie.length;He+=3)this.footprintIndices.emplaceBack(je.vertexOffset+Ie[He+0],je.vertexOffset+Ie[He+1],je.vertexOffset+Ie[He+2]),this.indexArray.emplaceBack(Ue+Ie[He],Ue+Ie[He+2],Ue+Ie[He+1]),hi.primitiveLength++;je.indexCount+=Ie.length,je.vertexCount+=this.footprintVertices.length-je.vertexOffset}for(let Ye=0;Ye<fe.length;Ye++){const Pe=fe[Ye];Y.startRing(it,Pe[0]);let Ie=Pe.length>4&&X_(Pe[Pe.length-2],Pe[0],Pe[1]),He=te?l0(Pe[Pe.length-2],Pe[0],Pe[1],te):0;const ai=[];let Ge,Pi,Bi;Pi=Pe[1].sub(Pe[0])._perp()._unit();let vi=!0;for(let mi=1,_r=0;mi<Pe.length;mi++){let yi=Pe[mi-1],Yi=Pe[mi];const wr=Pe[mi===Pe.length-1?1:mi+1];if(Y.appendEdge(it,Yi,yi),H_(Yi,yi,ke)){te&&(Pi=wr.sub(Yi)._perp()._unit(),vi=!vi);continue}const Vr=Yi.sub(yi)._perp(),pn=Vr.x/(Math.abs(Vr.x)+Math.abs(Vr.y)),Tr=Vr.y>0?1:0,wn=yi.dist(Yi);if(_r+wn>32768&&(_r=0),te){Bi=wr.sub(Yi)._perp()._unit();let zt=Z_(yi,Yi,wr,qg(Pi,Bi),te);isNaN(zt)&&(zt=0);const Ne=Yi.sub(yi)._unit();yi=yi.add(Ne.mult(He))._round(),Yi=Yi.add(Ne.mult(-zt))._round(),He=zt,Pi=Bi,at&&this.zoom>=17&&(ze(ai,yi)||ai.push(yi),ze(ai,Yi)||ai.push(Yi))}const Tn=hi.vertexLength,No=Pe.length>4&&X_(yi,Yi,wr);let Ft=c0(_r,Ie,vi);if(tp(this.layoutVertexArray,yi.x,yi.y,pn,Tr,0,0,Ft),tp(this.layoutVertexArray,yi.x,yi.y,pn,Tr,0,1,Ft),this.wallMode){const zt=At(mi-1,Pe),Ne=yt.joinNormals[mi-1];Wp(this.wallVertexArray,Ne,zt),Wp(this.wallVertexArray,Ne,zt)}if(_r+=wn,Ft=c0(_r,No,!vi),Ie=No,tp(this.layoutVertexArray,Yi.x,Yi.y,pn,Tr,0,0,Ft),tp(this.layoutVertexArray,Yi.x,Yi.y,pn,Tr,0,1,Ft),this.wallMode){const zt=At(mi,Pe),Ne=yt.joinNormals[mi];Wp(this.wallVertexArray,Ne,zt),Wp(this.wallVertexArray,Ne,zt)}if(hi.vertexLength+=4,this.indexArray.emplaceBack(Tn+0,Tn+1,Tn+2),this.indexArray.emplaceBack(Tn+1,Tn+3,Tn+2),hi.primitiveLength+=2,te){const zt=Ue+(mi===1?Pe.length-2:mi-2),Ne=mi===1?Ue:zt+1;if(this.indexArray.emplaceBack(Tn+1,zt,Tn+3),this.indexArray.emplaceBack(zt,Ne,Tn+3),hi.primitiveLength+=2,Ge===void 0&&(Ge=Tn),!H_(wr,Pe[mi],ke)){const pi=mi===Pe.length-1?Ge:hi.vertexLength;this.indexArray.emplaceBack(Tn+2,Tn+3,pi),this.indexArray.emplaceBack(Tn+3,pi+1,pi),this.indexArray.emplaceBack(Tn+3,Ne,pi+1),hi.primitiveLength+=3}vi=!vi}if($){const zt=this.layoutVertexExtArray,Ne=O.projectTilePoint(yi.x,yi.y,m),pi=O.projectTilePoint(Yi.x,Yi.y,m),Ve=O.upVector(m,yi.x,yi.y),gi=O.upVector(m,Yi.x,Yi.y);gm(zt,Ne,Ve),gm(zt,Ne,Ve),gm(zt,pi,gi),gm(zt,pi,gi)}}q&&(Ue+=Pe.length-1),at&&te&&this.zoom>=17&&(ai.length!==0&&ze(ai,ai[0])&&ai.pop(),this.groundEffect.addData(ai,ke,R,te>0))}this.footprintSegments.push(je),Ke.triangleCount=this.indexArray.length-Ke.triangleArrayOffset,this.polygonSegments.push(Ke),++it.footprintSegLen,++it.polygonSegLen}if(it.vertexCount=this.layoutVertexArray.length-it.vertexArrayOffset,it.groundVertexCount=this.groundEffect.vertexArray.length-it.groundVertexArrayOffset,it.vertexCount!==0){if(it.centroidXY=Y.borders?zf:this.encodeCentroid(Y,it),this.centroidData.push(it),Y.borders){this.featuresOnBorder.push(Y);const fe=this.featuresOnBorder.length-1;for(let ke=0;ke<Y.borders.length;ke++)Y.borders[ke][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ke].push(fe)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,r,u,_,b,m,P,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(r,u,_,b,m,P,this.worldview),this.maxHeight=Math.max(this.maxHeight,gt)}}sortBorders(){for(let t=0;t<this.borderFeatureIndices.length;t++)this.borderFeatureIndices[t].sort((r,l)=>this.featuresOnBorder[r].borders[t][0]-this.featuresOnBorder[l].borders[t][0])}splitToSubtiles(){const t=[];for(let b=0;b<this.centroidData.length;b++){const E=this.centroidData[b],P=+(E.min.y+E.max.y>ri),R=2*P+(+(E.min.x+E.max.x>ri)^P);for(let F=0;F<E.polygonSegLen;F++){const O=E.polygonSegIdx+F;t.push({centroidIdx:b,subtile:R,polygonSegmentIdx:O,triangleSegmentIdx:this.polygonSegments[O].triangleSegIdx})}}const r=new ro;t.sort((b,E)=>b.triangleSegmentIdx===E.triangleSegmentIdx?b.subtile-E.subtile:b.triangleSegmentIdx-E.triangleSegmentIdx);let l=0,u=0,m=0;for(const b of t){if(b.triangleSegmentIdx!==l)break;m++}const _=t.length;for(;u!==t.length;){l=t[u].triangleSegmentIdx;let b=0,E=u,P=u;for(let R=E;R<m&&t[R].subtile===b;R++)P++;for(;E!==m;){const R=t[E];b=R.subtile;const F=this.centroidData[R.centroidIdx].min.clone(),O=this.centroidData[R.centroidIdx].max.clone(),$={vertexOffset:this.segments.segments[l].vertexOffset,primitiveOffset:r.length,vertexLength:this.segments.segments[l].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let q=E;q<P;q++){const Y=t[q],it=this.polygonSegments[Y.polygonSegmentIdx],at=this.centroidData[Y.centroidIdx].min,gt=this.centroidData[Y.centroidIdx].max,yt=this.indexArray.uint16;for(let At=it.triangleArrayOffset;At<it.triangleArrayOffset+it.triangleCount;At++)r.emplaceBack(yt[3*At],yt[3*At+1],yt[3*At+2]);$.primitiveLength+=it.triangleCount,F.x=Math.min(F.x,at.x),F.y=Math.min(F.y,at.y),O.x=Math.max(O.x,gt.x),O.y=Math.max(O.y,gt.y)}$.primitiveLength>0&&this.triangleSubSegments.push({segment:$,min:F,max:O}),E=P;for(let q=E;q<m&&t[q].subtile===t[E].subtile;q++)P++}u=m;for(let R=u;R<_&&t[R].triangleSegmentIdx===t[u].triangleSegmentIdx;R++)m++}r._trim(),this.indexArray=r}getVisibleSegments(t,r,l){const u=new To;if(this.wallMode){for(const Y of this.triangleSubSegments)u.segments.push(Y.segment);return u}let m=0,_=0;const b=1<<t.canonical.z;if(r){const Y=r.getMinMaxForTile(t);Y&&(m=Y.min,_=Y.max)}_+=this.maxHeight;const E=t.toUnwrapped();let P;const R=[E.canonical.x/b+E.wrap,E.canonical.y/b],F=[(E.canonical.x+1)/b+E.wrap,(E.canonical.y+1)/b],O=(Y,it,at)=>[Y[0]*(1-at[0])+it[0]*at[0],Y[1]*(1-at[1])+it[1]*at[1]],$=[],q=[];for(const Y of this.triangleSubSegments){$[0]=Y.min.x/ri,$[1]=Y.min.y/ri,q[0]=Y.max.x/ri,q[1]=Y.max.y/ri;const it=O(R,F,$),at=O(R,F,q);if(new Lr([it[0],it[1],m],[at[0],at[1],_]).intersectsPrecise(l)===0){P&&(u.segments.push(P),P=void 0);continue}const gt=Y.segment;P&&P.vertexOffset!==gt.vertexOffset&&(u.segments.push(P),P=void 0),P?(P.vertexLength+=gt.vertexLength,P.primitiveLength+=gt.primitiveLength):P={vertexOffset:gt.vertexOffset,primitiveLength:gt.primitiveLength,vertexLength:gt.vertexLength,primitiveOffset:gt.primitiveOffset,sortKey:void 0,vaos:{}}}return P&&u.segments.push(P),u}encodeCentroid(t,r){const l=t.centroid(),u=r.span(),m=Math.min(7,Math.round(u.x*this.tileToMeter/10)),_=Math.min(7,Math.round(u.y*this.tileToMeter/10));return new Ae(tt(l.x,1,ri-1)<<3|m,tt(l.y,1,ri-1)<<3|_)}encodeBorderCentroid(t){if(!t.borders)return new Ae(0,0);const r=t.borders,l=Number.MAX_VALUE;if(r[0][0]!==l||r[1][0]!==l){const u=r[0][0]!==l?0:1;return new Ae(6|(r[0][0]!==l?0:65528),(r[u][0]+r[u][1])/2<<3|6)}{const u=r[2][0]!==l?2:3;return new Ae((r[u][0]+r[u][1])/2<<3|6,6|(r[2][0]!==l?0:65528))}}showCentroid(t){const r=this.centroidData[t.centroidDataIndex];r.flags&=2147483647,r.centroidXY.x=0,r.centroidXY.y=0,this.writeCentroidToBuffer(r)}writeCentroidToBuffer(t){this.groundEffect.updateHiddenByLandmark(t);const r=t.vertexArrayOffset,l=t.vertexCount+t.vertexArrayOffset,u=t.flags&Qd?zf:t.centroidXY,m=this.centroidVertexArray.geta_centroid_pos0(r);if(this.centroidVertexArray.geta_centroid_pos1(r)!==u.y||m!==u.x){for(let _=r;_<l;++_)this.centroidVertexArray.emplace(_,u.x,u.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of this.centroidData)this.writeCentroidToBuffer(t)}updateReplacement(t,r,l){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const u=r.getReplacementRegionsForTile(t.toUnwrapped());if(Df(this.activeReplacements,u))return;if(this.activeReplacements=u,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const _ of this.centroidData)_.flags&=2147483647;const m=[];for(const _ of this.activeReplacements){if(_.order<l)continue;const b=Math.max(1,Math.pow(2,_.footprintTileId.canonical.z-t.canonical.z));if(_.footprint.buildingId){const E=_.footprint.buildingId;for(const P of this.centroidData)P.buildingId===E&&(P.flags|=Qd)}else for(const E of this.centroidData)if(!(E.flags&Qd||_.min.x>E.max.x||E.min.x>_.max.x||_.min.y>E.max.y||E.min.y>_.max.y))for(let P=0;P<E.footprintSegLen;P++){const R=this.footprintSegments[E.footprintSegIdx+P];if(m.length=0,hx(this.footprintVertices,R.vertexOffset,R.vertexCount,_.footprintTileId.canonical,t.canonical,m),Vg(_.footprint,m,this.footprintIndices.uint16,R.indexOffset,R.indexCount,-R.vertexOffset,-b)){E.flags|=Qd;break}}}for(const _ of this.centroidData)this.writeCentroidToBuffer(_);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(t,r,l){let u=!1;for(let m=0;m<l.footprintSegLen;m++){const _=this.footprintSegments[l.footprintSegIdx+m];let b=0;for(const E of _.ringIndices){for(let P=b,R=E+b-1;P<E+b;R=P++){const F=this.footprintVertices.int16[2*(P+_.vertexOffset)+0],O=this.footprintVertices.int16[2*(P+_.vertexOffset)+1],$=this.footprintVertices.int16[2*(R+_.vertexOffset)+1];O>r!=$>r&&t<(this.footprintVertices.int16[2*(R+_.vertexOffset)+0]-F)*(r-O)/($-O)+F&&(u=!u)}b=E}}return u}getHeightAtTileCoord(t,r){let l=Number.NEGATIVE_INFINITY,u=!0;const m=4*(t+ri)*ri+(r+ri);if(this.partLookup.hasOwnProperty(m)){const _=this.partLookup[m];return _?{height:_.height,hidden:!!(_.flags&Qd)}:void 0}for(const _ of this.centroidData)t>_.max.x||_.min.x>t||r>_.max.y||_.min.y>r||_.height<=l||this.footprintContainsPoint(t,r,_)&&(l=_.height,this.partLookup[m]=_,u=!!(_.flags&Qd));if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:u};this.partLookup[m]=void 0}}function qg(n,t){const r=n.add(t)._unit();return n.x*r.x+n.y*r.y}function l0(n,t,r,l){const u=t.sub(n)._perp()._unit(),m=r.sub(t)._perp()._unit();return Z_(n,t,r,qg(u,m),l)}function Z_(n,t,r,l,u){const m=Math.sqrt(1-l*l);return Math.min(n.dist(t)/3,t.dist(r)/3,u*m/l)}function H_(n,t,r){return n.x<r[0].x&&t.x<r[0].x||n.x>r[1].x&&t.x>r[1].x||n.y<r[0].y&&t.y<r[0].y||n.y>r[1].y&&t.y>r[1].y}function W_(n,t){return n.x<t[0].x||n.x>t[1].x||n.y<t[0].y||n.y>t[1].y}function X_(n,t,r){if(n.x<0||n.x>=ri||t.x<0||t.x>=ri||r.x<0||r.x>=ri)return!1;const l=r.sub(t),u=l.perp(),m=n.sub(t);return(l.x*m.x+l.y*m.y)/Math.sqrt((l.x*l.x+l.y*l.y)*(m.x*m.x+m.y*m.y))>-.866&&u.x*m.x+u.y*m.y<0}function c0(n,t,r){const l=t?2|n:-3&n;return r?1|l:-2&l}function Y_(){const n=Math.PI/32,t=Math.tan(n),r=N;return r*Math.sqrt(1+2*t*t)-r}function h0(n,t,r){const l=1<<r.z,u=Mt(r.x/l),m=Mt((r.x+1)/l),_=vt(r.y/l),b=vt((r.y+1)/l);return function(E,P,R,F,O=0,$){const q=[];if(!E.length||!R||!F)return q;const Y=(kt,Xt)=>{for(const te of kt)q.push({polygon:te,bounds:Xt})},it=Math.ceil(Math.log2(R)),at=Math.ceil(Math.log2(F)),gt=it-at,yt=[];for(let kt=0;kt<Math.abs(gt);kt++)yt.push(gt>0?0:1);for(let kt=0;kt<Math.min(it,at);kt++)yt.push(0),yt.push(1);let At=E;if(At=Xm(At,P[0].y-O,P[1].y+O,1),At=Xm(At,P[0].x-O,P[1].x+O,0),!At.length)return q;const Gt=[];for(yt.length?Gt.push({polygons:At,bounds:P,depth:0}):Y(At,P);Gt.length;){const kt=Gt.pop(),Xt=kt.depth,te=yt[Xt],ne=kt.bounds[0],ze=kt.bounds[1],fe=te===0?ne.x:ne.y,ke=te===0?ze.x:ze.y,Ue=$(te,fe,ke),Ze=Xm(kt.polygons,fe-O,Ue+O,te),hi=Xm(kt.polygons,Ue-O,ke+O,te);if(Ze.length){const Ke=[ne,new Ae(te===0?Ue:ze.x,te===1?Ue:ze.y)];yt.length>Xt+1?Gt.push({polygons:Ze,bounds:Ke,depth:Xt+1}):Y(Ze,Ke)}if(hi.length){const Ke=[new Ae(te===0?Ue:ne.x,te===1?Ue:ne.y),ze];yt.length>Xt+1?Gt.push({polygons:hi,bounds:Ke,depth:Xt+1}):Y(hi,Ke)}}return q}(n,t,Math.ceil((m-u)/11.25),Math.ceil((_-b)/11.25),1,(E,P,R)=>{if(E===0)return .5*(P+R);{const F=vt((r.y+P/ri)/l);return(lt(.5*(vt((r.y+R/ri)/l)+F))*l-r.y)*ri}})}function hx(n,t,r,l,u,m){const _=Math.pow(2,l.z-u.z);for(let b=0;b<r;b++){let E=n.int16[2*(b+t)+0],P=n.int16[2*(b+t)+1];E=(E+u.x*ri)*_-l.x*ri,P=(P+u.y*ri)*_-l.y*ri,m.push(new Ae(E,P))}}let ep,J_;Ei(bd,"FillExtrusionBucket",{omit:["layers","features"]}),Ei(o0,"PartData"),Ei(q_,"FootprintSegment"),Ei(s0,"BorderCentroidData"),Ei($g,"GroundEffect");class Xp extends Ae{constructor(t,r,l){super(t,r),this.z=l}}class K_ extends Xp{constructor(t,r,l,u){super(t,r,l),this.w=u}}function Q_(n,t,r,l){const u=r==="x"?"y":"x",m=(l-n[r])/(t[r]-n[r]);n[u]=Math.round(n[u]+(t[u]-n[u])*m),n[r]=l,n.hasOwnProperty("z")&&(n.z=Gi(n.z,t.z,m)),n.hasOwnProperty("w")&&(n.w=Gi(n.w,t.w,m))}function u0(n,t,r,l){const u=r,m=l;for(const _ of["x","y"]){let b=n,E=t;b[_]>=E[_]&&(b=t,E=n),b[_]<u&&E[_]>u&&Q_(b,E,_,u),b[_]<m&&E[_]>m&&Q_(E,b,_,m)}}function Zg(n,t,r,l,u,m){const _=[];for(let b=0;b<n.length;b++){const E=n[b];let P;const R=_.length;let F=0;for(let O=0;O<E.length-1;O++){let $=E[O],q=E[O+1],Y=0;const it=F;let at,gt;m&&(Y=Math.hypot(q.x-$.x,q.y-$.y),F+=Y,at=$,gt=q),$.x<t&&q.x<t||($.x<t?$=new Ae(t,$.y+(t-$.x)/(q.x-$.x)*(q.y-$.y))._round():q.x<t&&(q=new Ae(t,$.y+(t-$.x)/(q.x-$.x)*(q.y-$.y))._round()),$.y<r&&q.y<r||($.y<r?$=new Ae($.x+(r-$.y)/(q.y-$.y)*(q.x-$.x),r)._round():q.y<r&&(q=new Ae($.x+(r-$.y)/(q.y-$.y)*(q.x-$.x),r)._round()),$.x>=l&&q.x>=l||($.x>=l?$=new Ae(l,$.y+(l-$.x)/(q.x-$.x)*(q.y-$.y))._round():q.x>=l&&(q=new Ae(l,$.y+(l-$.x)/(q.x-$.x)*(q.y-$.y))._round()),$.y>=u&&q.y>=u||($.y>=u?$=new Ae($.x+(u-$.y)/(q.y-$.y)*(q.x-$.x),u)._round():q.y>=u&&(q=new Ae($.x+(u-$.y)/(q.y-$.y)*(q.x-$.x),u)._round()),P&&$.equals(P[P.length-1])||(P=[$],_.push(P),m&&m.push({progress:{min:it+ty(at,gt,$)*Y,max:1},parentIndex:b,prevPoint:at,nextPoint:gt})),P.push(q),m&&(m[m.length-1].progress.max=it+ty(at,gt,q)*Y,m[m.length-1].nextPoint=gt)))))}if(m&&F>0)for(let O=R;O<_.length;O++)m[O].progress.min/=F,m[O].progress.max/=F}return _}function d0(n,t,r,l,u){if(n.length<2)return void l.push(n);const m=[];for(;t.valid();){const[P,R]=t.get();for(let F=0;F<n.length-1;F++){const O=n[F],$=n[F+1],q=ic(O,$,P,R);if(q){const[Y]=q,it=new Ae(Gi(O.x,$.x,Y),Gi(O.y,$.y,Y));m.push({t:F+Y,distance:0,point:it})}}t.next()}if(m.length===0)return void l.push(n);m.sort((P,R)=>P.t-R.t);let _=0,b=0,E=[];for(l.push(E);_!==n.length;){if(b===m.length){for(;_!==n.length;)E.length!==0&&E[E.length-1].equals(n[_])||E.push(n[_]),_++;break}m[b].t<=_?(E.length!==0&&E[E.length-1].equals(m[b].point)||E.push(m[b].point),Math.trunc(m[b].t),b++):(E.length!==0&&E[E.length-1].equals(n[_])||E.push(n[_]),_++)}}function ty(n,t,r){return n.x!==t.x?(r.x-n.x)/(t.x-n.x):n.y!==t.y?(r.y-n.y)/(t.y-n.y):0}function Yp(n,t){return n.x*t.x+n.y*t.y}function ey(n,t){if(n.length===1){let r=0;const l=t[r++];let u;for(;!u||l.equals(u);)if(u=t[r++],!u)return 1/0;for(;r<t.length;r++){const m=t[r],_=n[0],b=u.sub(l),E=m.sub(l),P=_.sub(l),R=Yp(b,b),F=Yp(b,E),O=Yp(E,E),$=Yp(P,b),q=Yp(P,E),Y=R*O-F*F,it=(O*$-F*q)/Y,at=(R*q-F*$)/Y,gt=l.z*(1-it-at)+u.z*it+m.z*at;if(isFinite(gt))return gt}return 1/0}{let r=1/0;for(const l of t)r=Math.min(r,l.z);return r}}function Km(n,t,r){let l=1/0;jo(r,t)&&(l=ey(r,t[0]));for(let u=0;u<t.length;u++){const m=t[u],_=n[u];for(let b=0;b<m.length-1;b++){const E=m[b],P=[E,m[b+1],_[b+1],_[b],E];Yo(r,P)&&(l=Math.min(l,ey(r,P)))}}return l!==1/0&&l}function Qm(n,t,r,l,u,m,_,b,E,P,R){return n.projection.name==="globe"?function(F,O,$,q,Y,it,at,gt,yt,At,Gt){const kt=[],Xt=[],te=F.projection.upVectorScale(Gt,F.center.lat,F.worldSize).metersToTile,ne=[0,0,0,1],ze=[0,0,0,1],fe=(Ue,Ze,hi,Ke)=>{Ue[0]=Ze,Ue[1]=hi,Ue[2]=Ke,Ue[3]=1},ke=Y_();$>0&&($+=ke),q+=ke;for(const Ue of O){const Ze=[],hi=[];for(const Ke of Ue){const je=Ke.x+Y.x,Ye=Ke.y+Y.y,Pe=F.projection.projectTilePoint(je,Ye,Gt),Ie=F.projection.upVector(Gt,Ke.x,Ke.y);let He=$,ai=q;if(at){const Ge=tg(je,Ye,$,q,at,gt,yt,At);He+=Ge.base,ai+=Ge.top}$!==0?fe(ne,Pe.x+Ie[0]*te*He,Pe.y+Ie[1]*te*He,Pe.z+Ie[2]*te*He):fe(ne,Pe.x,Pe.y,Pe.z),fe(ze,Pe.x+Ie[0]*te*ai,Pe.y+Ie[1]*te*ai,Pe.z+Ie[2]*te*ai),On(ne,ne,it),On(ze,ze,it),Ze.push(new Xp(ne[0],ne[1],ne[2])),hi.push(new Xp(ze[0],ze[1],ze[2]))}kt.push(Ze),Xt.push(hi)}return[kt,Xt]}(n,t,r,l,u,m,_,b,E,P,R):_?function(F,O,$,q,Y,it,at,gt,yt){const At=[],Gt=[],kt=[0,0,0,1];for(const Xt of F){const te=[],ne=[];for(const ze of Xt){const fe=ze.x+q.x,ke=ze.y+q.y,Ue=tg(fe,ke,O,$,it,at,gt,yt);kt[0]=fe,kt[1]=ke,kt[2]=Ue.base,kt[3]=1,bs(kt,kt,Y),kt[3]=Math.max(kt[3],1e-5);const Ze=new Xp(kt[0]/kt[3],kt[1]/kt[3],kt[2]/kt[3]);kt[0]=fe,kt[1]=ke,kt[2]=Ue.top,kt[3]=1,bs(kt,kt,Y),kt[3]=Math.max(kt[3],1e-5);const hi=new Xp(kt[0]/kt[3],kt[1]/kt[3],kt[2]/kt[3]);te.push(Ze),ne.push(hi)}At.push(te),Gt.push(ne)}return[At,Gt]}(t,r,l,u,m,_,b,E,P):function(F,O,$,q,Y){const it=[],at=[],gt=Y[8]*O,yt=Y[9]*O,At=Y[10]*O,Gt=Y[11]*O,kt=Y[8]*$,Xt=Y[9]*$,te=Y[10]*$,ne=Y[11]*$;for(const ze of F){const fe=[],ke=[];for(const Ue of ze){const Ze=Ue.x+q.x,hi=Ue.y+q.y,Ke=Y[0]*Ze+Y[4]*hi+Y[12],je=Y[1]*Ze+Y[5]*hi+Y[13],Ye=Y[2]*Ze+Y[6]*hi+Y[14],Pe=Y[3]*Ze+Y[7]*hi+Y[15],Ie=Ke+gt,He=je+yt,ai=Ye+At,Ge=Math.max(Pe+Gt,1e-5),Pi=Ke+kt,Bi=je+Xt,vi=Ye+te,mi=Math.max(Pe+ne,1e-5);fe.push(new Xp(Ie/Ge,He/Ge,ai/Ge)),ke.push(new Xp(Pi/mi,Bi/mi,vi/mi))}it.push(fe),at.push(ke)}return[it,at]}(t,r,l,u,m)}function tg(n,t,r,l,u,m,_,b){const E=_*u.getElevationAt(n,t,!0,!0),P=m[0]!==0,R=P?m[1]===0?_*(m[0]/Jm-n0):_*function(F,O,$){const q=Math.floor(O[0]/8),Y=Math.floor(O[1]/8),it=10*(O[0]-8*q),at=10*(O[1]-8*Y),gt=F.getElevationAt(q,Y,!0,!0),yt=F.getMeterToDEM($),At=Math.floor(.5*(it*yt-1)),Gt=Math.floor(.5*(at*yt-1)),kt=F.tileCoordToPixel(q,Y),Xt=2*At+1,te=2*Gt+1,ne=function(hi,Ke,je,Ye,Pe){return[hi.getElevationAtPixel(Ke,je,!0),hi.getElevationAtPixel(Ke+Pe,je,!0),hi.getElevationAtPixel(Ke,je+Pe,!0),hi.getElevationAtPixel(Ke+Ye,je+Pe,!0)]}(F,kt.x-At,kt.y-Gt,Xt,te),ze=Math.abs(ne[0]-ne[1]),fe=Math.abs(ne[2]-ne[3]),ke=Math.abs(ne[0]-ne[2])+Math.abs(ne[1]-ne[3]),Ue=Math.min(.25,.5*yt*(ze+fe)/Xt),Ze=Math.min(.25,.5*yt*ke/te);return gt+Math.max(Ue*it,Ze*at)}(u,m,b):E;return{base:E+(r===0?-1:r),top:P?Math.max(R+l,E+r+2):E+l}}class ux{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class dx{constructor(){this.tasks={},this.taskQueue=[],xe(["process"],this),this.invoker=new ux(this.process),this.nextId=0}add(t,r){const l=this.nextId++,u=function({type:m,isSymbolTile:_,zoom:b}){return b=b||0,m==="message"?0:m!=="maybePrepare"||_?m!=="parseTile"||_?m==="parseTile"&&_?300-b:m==="maybePrepare"&&_?400-b:500:200-b:100-b}(r);if(u===0){try{t()}finally{}return null}return this.tasks[l]={fn:t,metadata:r,priority:u,id:l},this.taskQueue.push(l),this.invoker.trigger(),{cancel:()=>{delete this.tasks[l]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(l=>!!this.tasks[l]),!this.taskQueue.length)return;const t=this.pick();if(t===null)return;const r=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!r)return;r.fn()}finally{}}pick(){let t=null,r=1/0;for(let u=0;u<this.taskQueue.length;u++){const m=this.tasks[this.taskQueue[u]];m.priority<r&&(r=m.priority,t=u)}if(t===null)return null;const l=this.taskQueue[t];return this.taskQueue.splice(t,1),l}remove(){this.invoker.remove()}}class p0{constructor(t,r,l){this.target=t,this.parent=r,this.mapId=l,this.callbacks={},this.cancelCallbacks={},xe(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new dx}send(t,r,l,u,m=!1,_){const b=Math.round(1e18*Math.random()).toString(36).substring(0,10);l&&(l.metadata=_,this.callbacks[b]=l);const E=new Set;return this.target.postMessage({id:b,type:t,hasCallback:!!l,targetMapId:u,mustQueue:m,sourceMapId:this.mapId,data:Gc(r,E)},E),{cancel:()=>{l&&delete this.callbacks[b],this.target.postMessage({id:b,type:"<cancel>",targetMapId:u,sourceMapId:this.mapId})}}}receive(t){const r=t.data;if(!r)return;const l=r.id;if(l&&(!r.targetMapId||this.mapId===r.targetMapId))if(r.type==="<cancel>"){const u=this.cancelCallbacks[l];delete this.cancelCallbacks[l],u&&u.cancel()}else if(r.mustQueue||Nn(self)){const u=this.callbacks[l],m=this.scheduler.add(()=>this.processTask(l,r),u&&u.metadata||{type:"message"});m&&(this.cancelCallbacks[l]=m)}else this.processTask(l,r)}processTask(t,r){if(delete this.cancelCallbacks[t],r.type==="<response>"){const l=this.callbacks[t];delete this.callbacks[t],l&&(r.error?l($c(r.error)):l(null,$c(r.data)))}else{const l=new Set,u=r.hasCallback?(_,b)=>{this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:_?Gc(_):null,data:Gc(b,l)},l)}:()=>{},m=$c(r.data);if(this.parent[r.type])this.parent[r.type](r.sourceMapId,m,u);else if(this.parent.getWorkerSource){const _=r.type.split("."),{source:b,scope:E}=m;this.parent.getWorkerSource(r.sourceMapId,_[0],b,E)[_[1]](m,u)}else u(new Error(`Could not find function ${r.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var wd={workerUrl:"",workerClass:null,workerParams:void 0};const ja="mapboxgl_preloaded_worker_pool";class ip{constructor(){this.active={}}acquire(t,r=ip.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<r;)this.workers.push(wd.workerClass!=null?new wd.workerClass:new self.Worker(wd.workerUrl,wd.workerParams));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.workers&&this.numActive()===0&&(this.workers.forEach(r=>{r.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[ja]}numActive(){return Object.keys(this.active).length}}ip.workerCount=2;class Lf{constructor(t,r,l="Worker",u=ip.workerCount){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=ye();const m=this.workerPool.acquire(this.id,u);for(let _=0;_<m.length;_++){const b=new Lf.Actor(m[_],r,this.id);b.name=`${l} ${_}`,this.actors.push(b)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(t,r,l){Ht(this.actors,(u,m)=>{u.send(t,r,m)},l=l||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(t=>{t.remove()}),this.actors=[],this.workerPool.release(this.id)}}let _m,eg;function Hg(){return _m||(_m=new ip),_m}Lf.Actor=p0;class f0{constructor(t){this.module=t}createIntArray(t){const r=new Int32Array(t),l=this.module.malloc(r.length*r.BYTES_PER_ELEMENT);return this.module.heap32.set(r,l/r.BYTES_PER_ELEMENT),l}createFloatArray(t){const r=new Float32Array(t),l=this.module.malloc(r.length*r.BYTES_PER_ELEMENT);return this.module.heapF32.set(r,l/r.BYTES_PER_ELEMENT),l}createStringBuffer(t){const r=this.module.malloc(t.length+1);for(let l=0;l<t.length;++l)this.module.heapU8[r+l]=t.charCodeAt(l);return this.module.heapU8[r+t.length]=0,r}readStringBuffer(t){let r="";for(;this.module.heapU8[t]!==0;)r+=String.fromCharCode(this.module.heapU8[t]),++t;return r}setStyle(t){const r=t.entranceColorRgb,l=t.facadeGlazingColorRgb,u=t.roofColorRgb,m=t.wallColorRgb,_=t.normalScale;this.module.setStyle(r[0],r[1],r[2],l[0],l[1],l[2],u[0],u[1],u[2],m[0],m[1],m[2],_[0],_[1],_[2],t.tileToMeters)}setAOOptions(t,r){this.module.setAOOptions(t?1:0,r)}setMetricOptions(t,r){this.module.setMetricOptions(t?1:0,r)}setStructuralOptions(t){this.module.setStructuralOptions(t?1:0)}setFacadeOptions(t,r){this.module.setFacadeOptions(t,r?1:0)}setFauxFacadeOptions(t,r,l){this.module.setFauxFacadeOptions(t?1:0,r?1:0,l)}setFacadeClassifierOptions(t){this.module.setFacadeClassifierOptions(t)}generateMesh(t,r){for(const b of t){const E=this.createStringBuffer(b.roofType),P=[0],R=[];for(const $ of b.coordinates)if(Array.isArray($)){for(const q of $)R.push(q.x),R.push(q.y);P.push(R.length)}const F=this.createIntArray(P),O=this.createFloatArray(R);this.module.addFeature(b.id,b.sourceId,b.minHeight,b.height,E,b.roofType.length,O,F,P.length-1),this.module.free(E),this.module.free(F),this.module.free(O)}for(const b of r){let E;E=b.entrances?JSON.parse(b.entrances):[];const P=this.createFloatArray(E),R=[];for(const O of b.coordinates)R.push(O.x),R.push(O.y);const F=this.createFloatArray(R);this.module.addFacade(b.sourceId,b.crossPerc,b.distanceToRoad,P,E.length,F,R.length),this.module.free(P),this.module.free(F)}if(!this.module.generateMesh()){const b=this.module.getLastError();return this.readStringBuffer(b)}const l=this.module.getMeshCount(),u=new Array(l);for(let b=0;b<l;b++){const E=this.module.getPositionsPtr(b),P=this.module.getPositionsLength(b),R=new Float32Array(this.module.heapF32.buffer,E,P),F=this.module.getNormalsPtr(b),O=this.module.getNormalsLength(b),$=new Float32Array(this.module.heapF32.buffer,F,O),q=this.module.getColorsPtr(b),Y=this.module.getColorsLength(b),it=new Uint8Array(this.module.heapU8.buffer,q,Y),at=this.module.getAOPtr(b),gt=this.module.getAOLength(b),yt=new Float32Array(this.module.heapF32.buffer,at,gt),At=this.module.getUVPtr(b),Gt=this.module.getUVLength(b),kt=new Float32Array(this.module.heapF32.buffer,At,Gt),Xt=this.module.getFauxFacadePtr(b),te=this.module.getFauxFacadeLength(b),ne=new Uint8Array(this.module.heapU8.buffer,Xt,te),ze=this.module.getIndicesPtr(b),fe=this.module.getIndicesLength(b),ke=new Int32Array(this.module.heap32.buffer,ze,fe),Ue=this.module.getBuildingPart(b),Ze=this.readStringBuffer(Ue);u[b]={positions:R,normals:$,colors:it,ao:yt,uv:kt,isFauxFacade:ne,indices:ke,buildingPart:Ze}}const m=this.module.getRingCount(),_=[];for(let b=0;b<m;b++){const E=this.module.getRingPtr(b),P=this.module.getRingLength(b),R=new Float32Array(this.module.heapF32.buffer,E,P);_.push(R)}return{meshes:u,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:_}}}let ym,iy,ou,Jp,ig,Rf=null,Td=null,Wg=null,rg=null;function Xg(){return Nn(self)&&self.worker.dracoUrl?self.worker.dracoUrl:iy||eo.DRACO_URL}function ng(){if(Nn(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Jp)return Jp;const n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Jp=WebAssembly.validate(n)?eo.MESHOPT_SIMD_URL:eo.MESHOPT_URL,Jp}function og(){return rg}const xm={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ry={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},kf={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function m0(n,t,r){const l=r.json.bufferViews.length,u=r.buffers.length;t.bufferView=l,r.json.bufferViews[l]={buffer:u,byteLength:n.byteLength},r.buffers[u]=n}const Kp="KHR_draco_mesh_compression";function h(n,t){const r=n.extensions&&n.extensions[Kp];if(!r)return;const l=new ou.Decoder,u=z(t,r.bufferView),m=new ou.Mesh;if(!l.DecodeArrayToMesh(u,u.byteLength,m))throw new Error("Failed to decode Draco mesh");const _=t.json.accessors[n.indices],b=xm[_.componentType],E=_.count*b.BYTES_PER_ELEMENT,P=ou._malloc(E);b===Uint16Array?l.GetTrianglesUInt16Array(m,E,P):l.GetTrianglesUInt32Array(m,E,P),m0(ou.memory.buffer.slice(P,P+E),_,t),ou._free(P);for(const R of Object.keys(r.attributes)){const F=l.GetAttributeByUniqueId(m,r.attributes[R]),O=t.json.accessors[n.attributes[R]],$=ry[O.componentType],q=O.count*kf[O.type]*xm[O.componentType].BYTES_PER_ELEMENT,Y=ou._malloc(q);l.GetAttributeDataArrayForAllPoints(m,F,ou[$],q,Y),m0(ou.memory.buffer.slice(Y,Y+q),O,t),ou._free(Y)}l.destroy(),m.destroy(),delete n.extensions[Kp]}const o="EXT_meshopt_compression";function c(n,t){if(!n.extensions||!n.extensions[o])return;const r=n.extensions[o],l=new Uint8Array(t.buffers[r.buffer],r.byteOffset||0,r.byteLength||0),u=new Uint8Array(r.count*r.byteStride);ig.decodeGltfBuffer(u,r.count,r.byteStride,l,r.mode,r.filter),n.buffer=t.buffers.length,n.byteOffset=0,t.buffers[n.buffer]=u.buffer,delete n.extensions[o]}const g=1179937895,x=new TextDecoder("utf8");function T(n,t){return new URL(n,t).href}function A(n,t,r,l){return fetch(T(n.uri,l)).then(u=>u.arrayBuffer()).then(u=>{t.buffers[r]=u})}function z(n,t){const r=n.json.bufferViews[t];return new Uint8Array(n.buffers[r.buffer],r.byteOffset||0,r.byteLength)}function B(n,t,r,l){if(n.uri){const u=T(n.uri,l);return fetch(u).then(m=>m.blob()).then(m=>createImageBitmap(m)).then(m=>{t.images[r]=m})}if(n.bufferView!==void 0){const u=z(t,n.bufferView),m=new Blob([u],{type:n.mimeType});return createImageBitmap(m).then(_=>{t.images[r]=_})}}function G(n,t=0,r){const l={json:null,images:[],buffers:[]};if(new Uint32Array(n,t,1)[0]===g){const R=new Uint32Array(n,t);let F=2;const O=(R[F++]>>2)-3,$=R[F++]>>2;if(F++,l.json=JSON.parse(x.decode(R.subarray(F,F+$))),F+=$,F<O){const q=R[F++];F++;const Y=t+(F<<2);l.buffers[0]=n.slice(Y,Y+q)}}else l.json=JSON.parse(x.decode(new Uint8Array(n,t)));const{buffers:u,images:m,meshes:_,extensionsUsed:b,bufferViews:E}=l.json;let P=Promise.resolve();if(u){const R=[];for(let F=0;F<u.length;F++){const O=u[F];O.uri?R.push(A(O,l,F,r)):l.buffers[F]||(l.buffers[F]=null)}P=Promise.all(R)}return P.then(()=>{const R=[],F=b&&b.includes(Kp),O=b&&b.includes(o);if(F&&R.push(function(){if(!ou)return ym??(ym=function($){let q,Y=null;function it(){q=new Uint8Array(Y.buffer)}function at(){throw new Error("Unexpected Draco error.")}const gt={a:{a:at,d:function(yt,At,Gt){return q.copyWithin(yt,At,At+Gt)},c:function(yt){const At=q.length,Gt=Math.max(yt>>>0,Math.ceil(1.2*At)),kt=Math.ceil((Gt-At)/65536);try{return Y.grow(kt),it(),!0}catch{return!1}},b:at}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming($,gt):$.then(yt=>yt.arrayBuffer()).then(yt=>WebAssembly.instantiate(yt,gt))).then(yt=>{const{Rb:At,Qb:Gt,P:kt,T:Xt,X:te,Ja:ne,La:ze,Qa:fe,Va:ke,Wa:Ue,eb:Ze,jb:hi,f:Ke,e:je,yb:Ye,zb:Pe,Ab:Ie,Bb:He,Db:ai,Gb:Ge}=yt.instance.exports;Y=je;const Pi=(()=>{let Bi=0,vi=0,mi=0,_r=0;return yi=>{mi&&(At(_r),At(Bi),vi+=mi,mi=Bi=0),Bi||(vi+=128,Bi=Gt(vi));const Yi=yi.length+7&-8;let wr=Bi;Yi>=vi&&(mi=Yi,wr=_r=Gt(Yi));for(let Vr=0;Vr<yi.length;Vr++)q[wr+Vr]=yi[Vr];return wr}})();return it(),Ke(),{memory:je,_free:At,_malloc:Gt,Mesh:class{constructor(){this.ptr=kt()}destroy(){Xt(this.ptr)}},Decoder:class{constructor(){this.ptr=ne()}destroy(){hi(this.ptr)}DecodeArrayToMesh(Bi,vi,mi){const _r=Pi(Bi),yi=ze(this.ptr,_r,vi,mi.ptr);return!!te(yi)}GetAttributeByUniqueId(Bi,vi){return{ptr:fe(this.ptr,Bi.ptr,vi)}}GetTrianglesUInt16Array(Bi,vi,mi){ke(this.ptr,Bi.ptr,vi,mi)}GetTrianglesUInt32Array(Bi,vi,mi){Ue(this.ptr,Bi.ptr,vi,mi)}GetAttributeDataArrayForAllPoints(Bi,vi,mi,_r,yi){Ze(this.ptr,Bi.ptr,vi.ptr,mi,_r,yi)}},DT_INT8:Ye(),DT_UINT8:Pe(),DT_INT16:Ie(),DT_UINT16:He(),DT_UINT32:ai(),DT_FLOAT32:Ge()}})}(fetch(Xg())),ym.then($=>{ou=$,ym=void 0}))}()),O&&R.push(function(){if(ig)return;const $=function(q){let Y;const it=WebAssembly.instantiateStreaming(q,{}).then(yt=>{Y=yt.instance,Y.exports.__wasm_call_ctors()}),at={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},gt={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:it,supported:!0,decodeGltfBuffer(yt,At,Gt,kt,Xt,te){(function(ne,ze,fe,ke,Ue,Ze,hi){const Ke=ne.exports.sbrk,je=ke+3&-4,Ye=Ke(je*Ue),Pe=Ke(Ze.length),Ie=new Uint8Array(ne.exports.memory.buffer);Ie.set(Ze,Pe);const He=ze(Ye,ke,Ue,Pe,Ze.length);if(He===0&&hi&&hi(Ye,je,Ue),fe.set(Ie.subarray(Ye,Ye+ke*Ue)),Ke(Ye-Ke(0)),He!==0)throw new Error(`Malformed buffer data: ${He}`)})(Y,Y.exports[gt[Xt]],yt,At,Gt,kt,Y.exports[at[te]])}}}(fetch(ng()));return $.ready.then(()=>{ig=$})}()),m)for(let $=0;$<m.length;$++)R.push(B(m[$],l,$,r));return(R.length?Promise.all(R):Promise.resolve()).then(()=>{if(F&&_)for(const{primitives:$}of _)for(const q of $)h(q,l);if(O&&_&&E)for(const $ of E)c($,l);return l})})}function W(n){return fetch(n).then(t=>t.arrayBuffer()).then(t=>G(t,0,n))}function Q(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function ot(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class ct{constructor(t,r,l,u){this.context=t,this.format=l,this.useMipmap=u&&u.useMipmap,this.texture=t.gl.createTexture(),this.update(r,{premultiply:u&&u.premultiply})}update(t,r){const l=t&&t instanceof HTMLVideoElement&&t.width===0?t.videoWidth:t.width,u=t&&t instanceof HTMLVideoElement&&t.height===0?t.videoHeight:t.height,{context:m}=this,{gl:_}=m,{x:b,y:E}=r&&r.position?r.position:{x:0,y:0},P=b+l,R=E+u;!this.size||this.size[0]===P&&this.size[1]===R||(_.bindTexture(_.TEXTURE_2D,null),_.deleteTexture(this.texture),this.texture=_.createTexture(),this.size=null),_.bindTexture(_.TEXTURE_2D,this.texture),m.pixelStoreUnpackFlipY.set(!1),m.pixelStoreUnpack.set(1),m.pixelStoreUnpackPremultiplyAlpha.set(this.format===_.RGBA8&&(!r||r.premultiply!==!1));const F=t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||t instanceof ImageData||ImageBitmap&&t instanceof ImageBitmap;if(!this.size&&P>0&&R>0){const O=this.useMipmap?Math.floor(Math.log2(Math.max(P,R)))+1:1;_.texStorage2D(_.TEXTURE_2D,O,this.format,P,R),this.size=[P,R]}this.size&&(F?_.texSubImage2D(_.TEXTURE_2D,0,b,E,Q(this.format),ot(this.format),t):"data"in t&&t.data&&_.texSubImage2D(_.TEXTURE_2D,0,b,E,l,u,Q(this.format),ot(this.format),t.data)),this.useMipmap&&_.generateMipmap(_.TEXTURE_2D)}bind(t,r,l=!1){const{context:u}=this,{gl:m}=u;m.bindTexture(m.TEXTURE_2D,this.texture),t!==this.minFilter&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,t),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,this.useMipmap&&!l?t===m.NEAREST?m.NEAREST_MIPMAP_NEAREST:m.LINEAR_MIPMAP_LINEAR:t),this.minFilter=t),r!==this.wrapS&&(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,r),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,r),this.wrapS=r)}bindExtraParam(t,r,l,u,m){const{context:_}=this,{gl:b}=_;b.bindTexture(b.TEXTURE_2D,this.texture),r!==this.magFilter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,r),this.magFilter=r),t!==this.minFilter&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,this.useMipmap?t===b.NEAREST?b.NEAREST_MIPMAP_NEAREST:b.LINEAR_MIPMAP_LINEAR:t),this.minFilter=t),l!==this.wrapS&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,l),this.wrapS=l),u!==this.wrapT&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,u),this.wrapT=u),m!==this.compareMode&&(m?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_COMPARE_MODE,b.COMPARE_REF_TO_TEXTURE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_COMPARE_FUNC,m)):b.texParameteri(b.TEXTURE_2D,b.TEXTURE_COMPARE_MODE,b.NONE),this.compareMode=m)}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class ut{constructor(t,r){this.context=t,this.texture=r}bind(t,r){const{context:l}=this,{gl:u}=l;u.bindTexture(u.TEXTURE_2D,this.texture),t!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,t),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,t),this.minFilter=t),r!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,r),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,r),this.wrapS=r)}}const xt=Er([{name:"a_pos_3f",components:3,type:"Float32"}]),Et=Er([{name:"a_color_3f",components:3,type:"Float32"}]),Vt=Er([{name:"a_color_4f",components:4,type:"Float32"}]),ue=Er([{name:"a_uv_2f",components:2,type:"Float32"}]),Qt=Er([{name:"a_normal_3f",components:3,type:"Float32"}]),ee=Er([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Se=Er([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function Ee(n,t){const r=Ii(n.projection,n.zoom,n.width,n.height),l=function(m,_,b,E,P){const R=new Z(b.lng-180*fi,b.lat),F=new Z(b.lng+180*fi,b.lat),O=m.project(R.lng,R.lat),$=m.project(F.lng,F.lat),q=-Math.atan2($.y-O.y,$.x-O.x),Y=pe.fromLngLat(b);Y.y=tt(Y.y,-1+fi,1-fi);const it=Y.toLngLat(),at=m.project(it.lng,it.lat),gt=pe.fromLngLat(it);gt.x+=fi;const yt=gt.toLngLat(),At=m.project(yt.lng,yt.lat),Gt=Ji(At.x-at.x,At.y-at.y,q),kt=pe.fromLngLat(it);kt.y+=fi;const Xt=kt.toLngLat(),te=m.project(Xt.lng,Xt.lat),ne=Ji(te.x-at.x,te.y-at.y,q),ze=Math.abs(Gt.x)/Math.abs(ne.y),fe=Re([]);bo(fe,fe,-q*(1-(P?0:E)));const ke=Re([]);return En(ke,ke,[1,1-(1-ze)*E,1]),ke[4]=-ne.x/ne.y*E,bo(ke,ke,q),pr(ke,fe,ke),ke}(n.projection,0,n.center,r,t),u=ei(n);return En(l,l,[u,u,1]),l}function ei(n){const t=n.projection,r=Ii(n.projection,n.zoom,n.width,n.height),l=zi(t,n.center),u=zi(t,Z.convert(t.center));return Math.pow(2,l*r+(1-r)*u)}function Ii(n,t,r,l,u=1/0){const m=n.range;if(!m)return 0;const _=Math.min(u,Math.max(r,l)),b=Math.log2(_/1024);return wt(m[0]+b,m[1]+b,t)}const fi=1/4e4;function zi(n,t){const r=tt(t.lat,-Ct,Ct),l=new Z(t.lng-180*fi,r),u=new Z(t.lng+180*fi,r),m=n.project(l.lng,r),_=n.project(u.lng,r),b=pe.fromLngLat(l),E=pe.fromLngLat(u),P=_.x-m.x,R=_.y-m.y,F=E.x-b.x,O=E.y-b.y,$=Math.sqrt((F*F+O*O)/(P*P+R*R));return Math.log2($)}function Ji(n,t,r){const l=Math.cos(r),u=Math.sin(r);return{x:n*l-t*u,y:n*u+t*l}}function $i(n,t,r){Re(n),bo(n,n,ar(t[2])),$o(n,n,ar(t[0])),no(n,n,ar(t[1])),En(n,n,r),pr(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Ui(n,t,r,l,u,m,_,b){const E=[r[0]-t[0],r[1]-t[1],0],P=[l[0]-t[0],l[1]-t[1],0];if(cs(E)<1e-12||cs(P)<1e-12)return cl(n);const R=$n([],E,P);Xi(R,R),zn(P,l,t),E[2]=(m-u)*b,P[2]=(_-u)*b;const F=E;return $n(F,E,P),Xi(F,F),Da(n,R,F)}function _i(n,t,r=!1){const l=zu(t.zoom),u=function(m,_,b){const E=_.worldSize,P=[m[12],m[13],m[14]],R=vt(P[1]/E),F=Mt(P[0]/E),O=Re([]),$=_t(1,R)*E,q=_t(1,0)*E*Ot(R,_.zoom),Y=1/Ag(E);let it=q*Y;if(b){const At=Ii(_.projection,_.zoom,_.width,_.height,1024);it=Y*_.projection.pixelSpaceConversion(_.center.lat,E,At)}const at=L(R,F);Co(at,at,Hn([],Xi([],at),$*it*P[2]));const gt=function(At){const Gt=[At[0],At[1],At[2]];let kt=[0,1,0];const Xt=$n([],kt,Gt);return $n(kt,Gt,Xt),Wr(kt)===0&&(kt=[0,1,0],$n(Xt,Gt,kt)),Xi(Xt,Xt),Xi(kt,kt),Xi(Gt,Gt),[Xt[0],Xt[1],Xt[2],0,kt[0],kt[1],kt[2],0,Gt[0],Gt[1],Gt[2],0,At[0],At[1],At[2],1]}(at);En(O,O,[it,it,it*$]),$r(O,O,[-P[0],-P[1],-P[2]]);const yt=pr([],_.globeMatrix,gt);return pr(yt,yt,O),pr(yt,yt,m),yt}(n,t,r);if(l>0){const m=function(_,b){const E=b.worldSize,P=_t(1,0)*E*Ot(b.center.lat,b.zoom)/Ag(E),R=_t(1,b.center.lat)*E,F=Re([]);no(F,F,ar(b.center.lng)),$o(F,F,ar(b.center.lat)),$r(F,F,[0,0,Tl]),En(F,F,[P,P,P*R]);const O=b.point;return $r(F,F,[-O.x,-O.y,0]),pr(F,F,_),pr(F,b.globeMatrix,F)}(n,t);return function(_,b,E){const P=(q,Y,it)=>{const at=cs(q),gt=cs(Y),yt=gd(q,Y,it);return Hn(yt,yt,1/cs(yt)*Gi(at,gt,it))},R=P([_[0],_[1],_[2]],[b[0],b[1],b[2]],E),F=P([_[4],_[5],_[6]],[b[4],b[5],b[6]],E),O=P([_[8],_[9],_[10]],[b[8],b[9],b[10]],E),$=gd([_[12],_[13],_[14]],[b[12],b[13],b[14]],E);return[R[0],R[1],R[2],0,F[0],F[1],F[2],0,O[0],O[1],O[2],0,$[0],$[1],$[2],1]}(u,m,l)}return u}function kr(n,t,r,l){const u=Lr.projectAabbCorners(l,r);let m=Number.MAX_VALUE;for(let b=0;b<u.length;++b){const E=u[b];E[0]=(.5*E[0]+.5)*t.width,E[1]=(.5-.5*E[1])*t.height,E[2]<m&&(m=E[2])}const _=function(b){const E=[];let P=0;for(let $=1;$<b.length;$++)(b[$][0]<b[P][0]||b[$][0]===b[P][0]&&b[$][1]<b[P][1])&&(P=$);let R,F=P;const O=new Uint8Array(b.length);do{if(O[F])break;E.push(new Ae(b[F][0],b[F][1])),O[F]=1,R=(F+1)%b.length;for(let $=0;$<b.length;$++){if(b[$][0]===b[R][0]&&b[$][1]===b[R][1]||b[$][0]===b[F][0]&&b[$][1]===b[F][1])continue;const q=[b[$][0]-b[F][0],b[$][1]-b[F][1]],Y=[b[R][0]-b[F][0],b[R][1]-b[F][1]],it=q[0]*Y[1]-q[1]*Y[0];(it>0||it===0&&q[0]*Y[0]+q[1]*Y[1]>=0&&q[0]*q[0]+q[1]*q[1]>Y[0]*Y[0]+Y[1]*Y[1])&&(R=$)}F=R}while(F!==P);return E.length>0&&E.push(E[0]),E}(u);if(Yo(n,_))return m}const Ar=64,Nr={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function yr(n,t,r,l,u,m,_,b,E,P=!1){const R=r.zoom,F=r.project(l),O=Ot(l.lat,R),$=1/O;Re(n),$r(n,n,[F.x+_[0]*$,F.y+_[1]*$,_[2]]);let q=1,Y=1;const it=r.worldSize;if(P){if(r.projection.name==="mercator"){let At=0;r.elevation&&(At=r.elevation.getAtPointOrZero(new pe(F.x/it,F.y/it),0));const Gt=bs([],[F.x,F.y,At,1],r.projMatrix)[3]/r.cameraToCenterDistance;q=Gt,Y=Gt*Ot(r.center.lat,R)}else if(r.projection.name==="globe"){const At=_i(n,r),Gt=[0,0,0,1];bs(Gt,Gt,pr([],r.projMatrix,At));const kt=Gt[3]/r.cameraToCenterDistance,Xt=zu(R),te=r.projection.pixelsPerMeter(l.lat,it)*Ot(l.lat,R),ne=r.projection.pixelsPerMeter(r.center.lat,it)*Ot(r.center.lat,R);q=kt/Gi(te,$t(r.center.lat),Xt),Y=kt*O/te,q*=ne,Y*=ne}}else q=$;En(n,n,[q,q,Y]);const at=[...n],gt=t.orientation,yt=[];if($i(yt,[gt[0]+(u?u[0]:0),gt[1]+(u?u[1]:0),gt[2]+(u?u[2]:0)],m),pr(n,at,yt),b&&r.elevation){let At=0;const Gt=[];if(E&&r.elevation){At=function(Xt,te,ne,ze,fe){const ke=te.elevation;if(!ke)return 0;const Ue=Lr.projectAabbCorners(ne,ze),Ze=_t(1,fe.lat)*te.worldSize,hi=function(vi,mi){const _r=[0,0,1],yi=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Yi of yi){const wr=vi[Yi.corners[0]],Vr=vi[Yi.corners[1]],pn=vi[Yi.corners[2]],Tr=[Vr[0]-wr[0],Vr[1]-wr[1],mi*(Vr[2]-wr[2])],wn=$n(Tr,Tr,[pn[0]-wr[0],pn[1]-wr[1],mi*(pn[2]-wr[2])]);Xi(wn,wn),Yi.dotProductWithUp=Xr(wn,_r)}return yi.sort((Yi,wr)=>Yi.dotProductWithUp-wr.dotProductWithUp),yi[0].corners}(Ue,Ze),Ke=Ue[hi[0]],je=Ue[hi[1]],Ye=Ue[hi[2]],Pe=Ue[hi[3]],Ie=ke.getAtPointOrZero(new pe(Ke[0]/te.worldSize,Ke[1]/te.worldSize),0),He=ke.getAtPointOrZero(new pe(je[0]/te.worldSize,je[1]/te.worldSize),0),ai=ke.getAtPointOrZero(new pe(Ye[0]/te.worldSize,Ye[1]/te.worldSize),0),Ge=ke.getAtPointOrZero(new pe(Pe[0]/te.worldSize,Pe[1]/te.worldSize),0),Pi=(Ie+Ge)/2,Bi=(He+ai)/2;return Pi>Bi?He<ai?Ui(Xt,je,Pe,Ke,He,Ge,Ie,Ze):Ui(Xt,Ye,Ke,Pe,ai,Ie,Ge,Ze):Ie<Ge?Ui(Xt,Ke,je,Ye,Ie,He,ai,Ze):Ui(Xt,Pe,Ye,je,Ge,ai,He,Ze),Math.max(Pi,Bi)}(Gt,r,t.aabb,n,l);const kt=pr([],al([],Gt),yt);pr(n,at,kt)}else At=r.elevation.getAtPointOrZero(new pe(F.x/it,F.y/it),0);At!==0&&(n[14]+=At)}}class Bn{constructor(t,r,l,u,m){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=t,this.uri=r,this.position=l!=null?new Z(l[0],l[1]):new Z(0,0),this.orientation=u??[0,0,0],this.nodes=m,this.uploaded=!1,this.aabb=new Lr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,r){pr(t.globalMatrix,r,t.localMatrix);const l=this.nodeOverrides.get(t.name);if(l!==void 0){const _=[];m=l.orientation,Re(u=_),no(u,u,ar(m[1])),bo(u,u,ar(m[2])),$o(u,u,ar(m[0])),pr(t.globalMatrix,t.globalMatrix,_)}var u,m;if(t.meshes)for(const _ of t.meshes){const b=Lr.applyTransformFast(_.aabb,t.globalMatrix);this.aabb.encapsulate(b)}if(t.children)for(const _ of t.children)this._applyTransformations(_,t.globalMatrix)}computeBoundsAndApplyParent(){const t=Re([]);this.aabb=new Lr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const r of this.nodes)this._applyTransformations(r,t)}computeModelMatrix(t,r,l,u,m,_,b=!1){yr(this.matrix,this,t.transform,this.position,r,l,u,m,_,b)}upload(t){if(!this.uploaded){for(const r of this.nodes)Ga(r,t);for(const r of this.nodes)Ac(r);this.uploaded=!0}}destroy(){for(const t of this.nodes)Il(t)}}function ts(n,t,r=!1){n.uploaded||(n.gfxTexture=new ct(t,n.image,r?t.gl.R8:t.gl.RGBA8,{useMipmap:n.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function _a(n,t,r){n.indexBuffer=t.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=t.createVertexBuffer(n.vertexArray,xt.members,!1,!0),n.normalArray&&(n.normalBuffer=t.createVertexBuffer(n.normalArray,Qt.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=t.createVertexBuffer(n.texcoordArray,ue.members,!1,!0)),n.colorArray&&(n.colorBuffer=t.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?Et:Vt).members,!1,!0)),n.featureArray&&(n.pbrBuffer=t.createVertexBuffer(n.featureArray,Se.members,!0)),n.segments=To.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);const l=n.material;l.pbrMetallicRoughness.baseColorTexture&&ts(l.pbrMetallicRoughness.baseColorTexture,t),l.pbrMetallicRoughness.metallicRoughnessTexture&&ts(l.pbrMetallicRoughness.metallicRoughnessTexture,t),l.normalTexture&&ts(l.normalTexture,t),l.occlusionTexture&&ts(l.occlusionTexture,t,r),l.emissionTexture&&ts(l.emissionTexture,t)}function Ga(n,t,r){if(n.meshes)for(const l of n.meshes)_a(l,t,r);if(n.children)for(const l of n.children)Ga(l,t,r)}function Ac(n){if(n.meshes)for(const t of n.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(n.children)for(const t of n.children)Ac(t)}function Il(n){if(n.meshes)for(const r of n.meshes)r.vertexBuffer&&(r.vertexBuffer.destroy(),r.indexBuffer.destroy(),r.normalBuffer&&r.normalBuffer.destroy(),r.texcoordBuffer&&r.texcoordBuffer.destroy(),r.colorBuffer&&r.colorBuffer.destroy(),r.pbrBuffer&&r.pbrBuffer.destroy(),r.segments.destroy(),r.material&&((t=r.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(n.children)for(const r of n.children)Il(r)}function Rs(n,t){const r=n.json.bufferViews[t.bufferView],l=xm[t.componentType];return new l(n.buffers[r.buffer],(t.byteOffset||0)+(r.byteOffset||0),t.count*(r.byteStride&&r.byteStride!==kf[t.type]*l.BYTES_PER_ELEMENT?r.byteStride/l.BYTES_PER_ELEMENT:kf[t.type]))}function $a(n,t,r,l){const u=xm[t.componentType],m=function(R){switch(R){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(u),_=n.json.bufferViews[t.bufferView],b=_.byteStride?_.byteStride/u.BYTES_PER_ELEMENT:kf[t.type],E=r.float32,P=E.length/r.capacity;for(let R=0,F=0;R<t.count*b;R+=b,F+=P)for(let O=0;O<P;O++)E[F+O]=l[R+O]*m;r._trim()}function Ws(n,t,r){const l=n.indices,u=n.attributes,m={};m.indexArray=new ro;const _=t.json.accessors[l],b=_.count/3;m.indexArray.reserve(b);const E=Rs(t,_);for(let O=0;O<b;O++)m.indexArray.emplaceBack(E[3*O],E[3*O+1],E[3*O+2]);m.indexArray._trim(),m.vertexArray=new ta;const P=t.json.accessors[u.POSITION];m.vertexArray.reserve(P.count);const R=Rs(t,P);for(let O=0;O<P.count;O++)m.vertexArray.emplaceBack(R[3*O],R[3*O+1],R[3*O+2]);if(m.vertexArray._trim(),m.aabb=new Lr(P.min,P.max),m.centroid=function(O,$){const q=[0,0,0],Y=O.length;if(Y>0){for(let it=0;it<Y;it++){const at=3*O[it];q[0]+=$[at],q[1]+=$[at+1],q[2]+=$[at+2]}q[0]/=Y,q[1]/=Y,q[2]/=Y}return q}(E,R),u.COLOR_0!==void 0){const O=t.json.accessors[u.COLOR_0],$=kf[O.type],q=Rs(t,O);m.colorArray=$===3?new ta:new uh,m.colorArray.resize(O.count),$a(t,O,m.colorArray,q)}if(u.NORMAL!==void 0){m.normalArray=new ta;const O=t.json.accessors[u.NORMAL];m.normalArray.resize(O.count);const $=Rs(t,O);$a(t,O,m.normalArray,$)}if(u.TEXCOORD_0!==void 0&&r.length>0){m.texcoordArray=new Au;const O=t.json.accessors[u.TEXCOORD_0];m.texcoordArray.resize(O.count);const $=Rs(t,O);$a(t,O,m.texcoordArray,$)}if(u._FEATURE_ID_RGBA4444!==void 0){const O=t.json.accessors[u._FEATURE_ID_RGBA4444];t.json.extensionsUsed&&t.json.extensionsUsed.includes("EXT_meshopt_compression")&&(m.featureData=Rs(t,O))}u._FEATURE_RGBA4444!==void 0&&(m.featureData=new Uint32Array(Rs(t,t.json.accessors[u._FEATURE_RGBA4444]).buffer));const F=n.material;return m.material=function(O,$){const{emissiveFactor:q=[0,0,0],alphaMode:Y="OPAQUE",alphaCutoff:it=.5,normalTexture:at,occlusionTexture:gt,emissiveTexture:yt,doubleSided:At,name:Gt}=O,{baseColorFactor:kt=[1,1,1,1],metallicFactor:Xt=1,roughnessFactor:te=1,baseColorTexture:ne,metallicRoughnessTexture:ze}=O.pbrMetallicRoughness||{},fe=gt?$[gt.index]:void 0;if(gt&&gt.extensions&&gt.extensions.KHR_texture_transform&&fe){const ke=gt.extensions.KHR_texture_transform;fe.offsetScale=[ke.offset[0],ke.offset[1],ke.scale[0],ke.scale[1]]}return{name:Gt,pbrMetallicRoughness:{baseColorFactor:new Br(...kt),metallicFactor:Xt,roughnessFactor:te,baseColorTexture:ne?$[ne.index]:void 0,metallicRoughnessTexture:ze?$[ze.index]:void 0},doubleSided:At,emissiveFactor:new Br(...q),alphaMode:Y,alphaCutoff:it,normalTexture:at?$[at.index]:void 0,occlusionTexture:fe,emissionTexture:yt?$[yt.index]:void 0,defined:O.defined===void 0}}(F!==void 0?t.json.materials[F]:{defined:!1},r),m}function qa(n,t,r){const{matrix:l,rotation:u,translation:m,scale:_,mesh:b,extras:E,children:P,name:R}=n,F={};if(F.name=R,F.localMatrix=l||function(O,$,q,Y){var it=$[0],at=$[1],gt=$[2],yt=$[3],At=it+it,Gt=at+at,kt=gt+gt,Xt=it*At,te=it*Gt,ne=it*kt,ze=at*Gt,fe=at*kt,ke=gt*kt,Ue=yt*At,Ze=yt*Gt,hi=yt*kt,Ke=Y[0],je=Y[1],Ye=Y[2];return O[0]=(1-(ze+ke))*Ke,O[1]=(te+hi)*Ke,O[2]=(ne-Ze)*Ke,O[3]=0,O[4]=(te-hi)*je,O[5]=(1-(Xt+ke))*je,O[6]=(fe+Ue)*je,O[7]=0,O[8]=(ne+Ze)*Ye,O[9]=(fe-Ue)*Ye,O[10]=(1-(Xt+ze))*Ye,O[11]=0,O[12]=q[0],O[13]=q[1],O[14]=q[2],O[15]=1,O}([],u||[0,0,0,1],m||[0,0,0],_||[1,1,1]),F.globalMatrix=Ci(F.localMatrix),b!==void 0){F.meshes=r[b];const O=F.anchor=[0,0];for(const $ of F.meshes){const{min:q,max:Y}=$.aabb;O[0]+=q[0]+Y[0],O[1]+=q[1]+Y[1]}O[0]=Math.floor(O[0]/F.meshes.length/2),O[1]=Math.floor(O[1]/F.meshes.length/2)}if(E&&(E.id&&(F.id=E.id),E.lights&&(F.lights=function(O){if(!O.length)return[];const $=function(gt){const yt=atob(gt),At=new Uint8Array(yt.length);for(let Gt=0;Gt<yt.length;Gt++)At[Gt]=yt.codePointAt(Gt);return At}(O),q=[],Y=$.length/24,it=new Uint16Array($.buffer),at=new Float32Array($.buffer);for(let gt=0;gt<Y;gt++){const yt=it[2*gt*6]/30,At=it[2*gt*6+1]/30,Gt=it[2*gt*6+10]/100,kt=at[6*gt+1],Xt=at[6*gt+2],te=at[6*gt+3],ne=at[6*gt+4],ze=te-kt,fe=ne-Xt,ke=Math.hypot(ze,fe);q.push({pos:[kt+.5*ze,Xt+.5*fe,At],normal:[fe/ke,-ze/ke,0],width:ke,height:yt,depth:Gt,points:[kt,Xt,te,ne]})}return q}(E.lights)),E.MAPBOX_geometry_bloom&&(F.isGeometryBloom=E.MAPBOX_geometry_bloom)),P){const O=[];for(const $ of P)O.push(qa(t.json.nodes[$],t,r));F.children=O}return F}function jl(n){if(n.vertices.length===0||n.indices.length===0)return null;const t=new Ym(n.vertices,n.indices,8,256),[r,l]=[t.min.clone(),t.max.clone()];return{vertices:n.vertices,indices:n.indices,grid:t,min:r,max:l}}function Gl(n){if(!n.extras||!n.extras.ground)return null;const t=n.extras.ground;if(!t||!Array.isArray(t)||t.length===0)return null;const r=t[0];if(!r||!Array.isArray(r)||r.length===0)return null;const l=[];for(const _ of r){if(!Array.isArray(_)||_.length!==2)continue;const b=_[0],E=_[1];typeof b=="number"&&typeof E=="number"&&l.push(new Ae(b,E))}if(l.length<3)return null;l.length>1&&l[l.length-1].equals(l[0])&&l.pop();let u=0;for(let _=0;_<l.length;_++){const b=l[_],E=l[(_+1)%l.length],P=l[(_+2)%l.length];u+=(b.x-E.x)*(P.y-E.y)-(P.x-E.x)*(b.y-E.y)}u>0&&l.reverse();const m=$p(l.flatMap(_=>[_.x,_.y]),[]);return m.length===0?null:{vertices:l,indices:m}}function Pc(n,t){const r=[],l=[];let u=0;const m=[];for(const _ of n){u=r.length;const b=_.vertexArray.float32,E=_.indexArray.uint16;for(let P=0;P<_.vertexArray.length;P++)m[0]=b[3*P+0],m[1]=b[3*P+1],m[2]=b[3*P+2],On(m,m,t),r.push(new Ae(m[0],m[1]));for(let P=0;P<3*_.indexArray.length;P++)l.push(E[P]+u)}if(l.length%3!=0)return null;for(let _=0;_<l.length;_+=3){const b=r[l[_+0]],E=r[l[_+1]],P=r[l[_+2]];(b.x-E.x)*(P.y-E.y)-(P.x-E.x)*(b.y-E.y)>0&&([l[_+1],l[_+2]]=[l[_+2],l[_+1]])}return{vertices:r,indices:l}}function Za(n){const t=function(E,P){const R=[],F=WebGL2RenderingContext;if(E.json.textures)for(const O of E.json.textures){const $={magFilter:F.LINEAR,minFilter:F.NEAREST,wrapS:F.REPEAT,wrapT:F.REPEAT};O.sampler!==void 0&&Object.assign($,E.json.samplers[O.sampler]),R.push({image:P[O.source],sampler:$,uploaded:!1})}return R}(n,n.images),r=function(E,P){const R=[];for(const F of E.json.meshes){const O=[];for(const $ of F.primitives)O.push(Ws($,E,P));R.push(O)}return R}(n,t),{scenes:l,scene:u,nodes:m}=n.json,_=l?l[u||0].nodes:[...m.keys()],b=[];for(const E of _)b.push(qa(m[E],n,r));return function(E,P,R){const F={},O=new Set;for(let $=0;$<E.length;$++){const q=R[P[$]];if(!q.extras)continue;const Y=q.extras["mapbox:footprint:version"],it=q.extras["mapbox:footprint:id"];(Y||it)&&O.add($),Y==="1.0.0"&&it&&(F[it]=$)}for(let $=0;$<E.length;$++){if(O.has($))continue;const q=E[$],Y=R[P[$]];if(!Y.extras)continue;let it=null;q.id in F&&(it=Pc(E[F[q.id]].meshes,q.localMatrix)),it||(it=Gl(Y)),it&&(q.footprint=jl(it))}if(O.size>0){const $=Array.from(O.values()).sort((q,Y)=>q-Y);for(let q=$.length-1;q>=0;q--)E.splice($[q],1)}}(b,_,n.json.nodes),b}function Mc(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);const t=n.vertexArray.float32,r=n.aabb.min[0]-1,l=n.aabb.min[1]-1,u=Ar/(n.aabb.max[0]-r+2),m=Ar/(n.aabb.max[1]-l+2);for(let _=0;_<t.length;_+=3){const b=t[_+2],E=(t[_+0]-r)*u|0,P=(t[_+1]-l)*m|0;b>n.heightmap[P*Ar+E]&&(n.heightmap[P*Ar+E]=b)}}function xh(n,t,r,l,u){r.reserve(r.length+4*n.length),l.reserve(l.length+10*n.length),u.reserve(u.length+10*n.length);let m=l.length;for(const _ of n){const b=Math.min(10,Math.max(4,1.3*_.height))*t,E=[-_.normal[1],_.normal[0],0],P=Math.min(.29,.1*_.width/_.depth),R=_.width-2*_.depth*t*(P+.01),F=di([],_.pos,E,R/2),O=di([],_.pos,E,-R/2),$=[F[0],F[1],F[2]+_.height],q=[O[0],O[1],O[2]+_.height],Y=di([],_.normal,E,P);Hn(Y,Y,b);const it=di([],_.normal,E,-P);Hn(it,it,b),Co(Y,F,Y),Co(it,O,it),F[2]+=.1,O[2]+=.1,l.emplaceBack(Y[0],Y[1],Y[2]),l.emplaceBack(it[0],it[1],it[2]),l.emplaceBack(F[0],F[1],F[2]),l.emplaceBack(O[0],O[1],O[2]),l.emplaceBack($[0],$[1],$[2]),l.emplaceBack(q[0],q[1],q[2]),l.emplaceBack(F[0],F[1],F[2]),l.emplaceBack(O[0],O[1],O[2]),l.emplaceBack(Y[0],Y[1],Y[2]),l.emplaceBack(it[0],it[1],it[2]);const at=R/b/2;u.emplaceBack(-at-P,-1,at,.8),u.emplaceBack(at+P,-1,at,.8),u.emplaceBack(-at,0,at,1.3),u.emplaceBack(at,0,at,1.3),u.emplaceBack(at+P,-.8,at,.7),u.emplaceBack(at+P,-.8,at,.7),u.emplaceBack(0,0,at,1.3),u.emplaceBack(0,0,at,1.3),u.emplaceBack(at+P,-1.2,at,.8),u.emplaceBack(at+P,-1.2,at,.8),r.emplaceBack(6+m,4+m,8+m),r.emplaceBack(7+m,9+m,5+m),r.emplaceBack(0+m,1+m,2+m),r.emplaceBack(1+m,3+m,2+m),m+=10}}function Ha(n,t){const r={};r.indexArray=new ro,r.vertexArray=new ta,r.colorArray=new uh,xh(n,t,r.indexArray,r.vertexArray,r.colorArray);const l={defined:!0};l.emissiveFactor=Br.black;const u={};return u.baseColorFactor=Br.white,l.pbrMetallicRoughness=u,r.material=l,r.aabb=new Lr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),r}const xs=Er([{name:"a_pos_3f",components:3,type:"Float32"}]),ya=Er([{name:"a_normal_3",components:3,type:"Int16"}]),ks=Er([{name:"a_centroid_3",components:3,type:"Int16"}]),Ca=Er([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),rp=Er([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),Lu=Er([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),sg=Er([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),Qp=Er([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),Ff=Er([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),Bf=qe.types,np=32767;function vm(n,t){const r=ri+t;for(const l of n)for(const u of l)if(u.x<-t||u.x>r||u.y<-t||u.y>r)return!1;return!0}class ny{constructor(){this.layoutVertexArray=new ta,this.layoutAttenuationArray=new uh,this.layoutColorArray=new Nl,this.indexArray=new ro,this.indexArrayForConflation=new ro,this.segmentsBucket=new To}}class Yg{constructor(){this.layoutVertexArray=new ta,this.layoutNormalArray=new wl,this.layoutCentroidArray=new wl,this.layoutColorArray=new Nl,this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.layoutFloodLightDataArray=new kp,this.layoutAOArray=new $s,this.indexArray=new ro,this.indexArrayForConflation=new ro,this.segmentsBucket=new To,this.entranceBloom=new ny}}class oy{constructor(t){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.buildingWithoutFacade=new Yg,this.buildingWithFacade=new Yg,this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.footprintLookup={},this.zoom=t.zoom,this.canonical=t.canonical,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.hasPattern=!1,this.worldview=t.worldview,this.lut=t.lut,this.buildingWithFacade.layoutFacadePaintArray=new Nl,this.buildingWithFacade.layoutFacadeDataArray=new Oo,this.buildingWithFacade.layoutFacadeVerticalRangeArray=new Nl,this.programConfigurations=new _h(t.layers,{zoom:t.zoom,lut:t.lut}),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.projection=t.projection,this.groundEffect=new $g(t),this.groundEffect.groundRadiusArray=new $s,this.hasAppearances=null}updateFootprints(t,r){for(const l of this.footprints)r.push({footprint:l,id:t})}updateAppearances(t,r,l,u){}prepare(){return function(){if(rg!=null||Wg!=null)return null;if(Td!=null)return Td;const t=fetch(eo.BUILDING_GEN_URL);return Td=function(r){let l,u,m,_;function b(){l=new Uint8Array(_.buffer),u=new Int32Array(_.buffer),m=new Float32Array(_.buffer)}function E(){throw new Error("Unexpected BuildingGen error.")}const P=()=>{},R={a:{a:E,f:function(F){const O=l.length,$=Math.max(F>>>0,Math.ceil(1.2*O)),q=Math.ceil(($-O)/65536);try{return _.grow(q),b(),!0}catch{return!1}},g:E,b:P,c:P,d:P,e:P}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(r,R):r.then(F=>F.arrayBuffer()).then(F=>WebAssembly.instantiate(F,R))).then(F=>{const O=F.instance.exports;return(0,O.g)(),_=O.f,b(),new f0({setStyle:O.h,setAOOptions:O.i,setMetricOptions:O.j,setStructuralOptions:O.k,setFacadeOptions:O.l,setFauxFacadeOptions:O.m,setFacadeClassifierOptions:O.n,addFeature:O.o,addFacade:O.p,generateMesh:O.q,getLastError:O.r,getOuterRingLength:O.s,getMeshCount:O.t,getPositionsPtr:O.u,getPositionsLength:O.v,getNormalsPtr:O.w,getNormalsLength:O.x,getColorsPtr:O.y,getColorsLength:O.z,getAOPtr:O.A,getAOLength:O.B,getUVPtr:O.C,getUVLength:O.D,getFauxFacadePtr:O.E,getFauxFacadeLength:O.F,getIndicesPtr:O.G,getIndicesLength:O.H,getBuildingPart:O.I,getRingCount:O.J,getRingPtr:O.K,getRingLength:O.L,free:O.M,malloc:O.N,heapU8:l,heap32:u,heapF32:m})})}(t).then(r=>(Td=null,rg=r,rg)).catch(r=>{Hi("Could not load building-gen"),Td=null,Wg=r}),Td}()}populate(t,r,l,u){const m=og();if(!m)return;const _=Zt(l);this.tileToMeter=_,this.brightness=r.brightness,m.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,_],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:_,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),m.setAOOptions(!1,.3),m.setMetricOptions(!1,16),m.setStructuralOptions(!0),m.setFacadeClassifierOptions(3);const b=new Map,E=new Map;for(const{feature:P}of t){if(Bf[P.type]!=="LineString"){b.set(P.id,P.properties.source_id);continue}const R=this.layers[0]._featureFilter.needGeometry,F=Te(P,R);if(!this.layers[0]._featureFilter.filter(new D(this.zoom),F,l))continue;const O=R?F.geometry:Oe(P,l,u),$=[];for(const at of O)for(const gt of at)$.push({x:gt.x,y:gt.y});const q={coordinates:$,crossPerc:P.properties.cross_perc,distanceToRoad:P.properties.distance_to_road,entrances:P.properties.entrances,sourceId:0},Y=P.properties.source_id;let it=E.get(Y);it||(it=[],E.set(Y,it)),it.push(q)}this.maxHeight=0;for(const{feature:P,id:R,index:F,sourceLayerIndex:O}of t){if(Bf[P.type]==="LineString")continue;const $=this.layers[0]._featureFilter.needGeometry,q=Te(P,$);if(!this.layers[0]._featureFilter.filter(new D(this.zoom),q,l))continue;const Y=$?q.geometry:Oe(P,l,u),it=cm(Y,500);if(!vm(Y,163))continue;const at=this.layers[0],gt=at.layout.get("building-roof-shape").evaluate(P,{},l);if(gt==="flat")continue;const yt=at.layout.get("building-base").evaluate(P,{},l),At=at.layout.get("building-height").evaluate(P,{},l),Gt=at.layout.get("building-flood-light-ground-radius").evaluate(P,{},l),kt=at.paint.get("building-ambient-occlusion-intensity"),Xt=Gt/this.tileToMeter;let te=at.layout.get("building-flood-light-wall-radius").evaluate(P,{},l);te=tt(te,0,2048);const ne=te/2048*np,ze=b.get(R);let fe;fe=E.has(ze)?E.get(ze):[];const ke=fe.length!==0&&at.layout.get("building-facade").evaluate(P,{},l);m.setFacadeOptions(4,!0),m.setFauxFacadeOptions(ke,!1,1);let Ue=0,Ze=0,hi=0,Ke=0,je=0,Ye=0;if(ke){let Ve=Math.round(at.layout.get("building-facade-floors").evaluate(P,{},l));if(yt===0){Ve=Math.max(1,Ve-(fe.length>0?1:0));let qi=4;if(At>100){const ji=[10,13,15];qi=ji[P.id?P.id%ji.length:0],m.setFacadeOptions(qi,!0)}je=1.6803*qi/_}else je=yt/_;Ye=At/_,je=Math.min(je,Ye),hi=at.layout.get("building-facade-unit-width").evaluate(P,{},l)/_,Ke=(Ye-je)/Ve,m.setFauxFacadeOptions(!0,!0,hi);const gi=at.layout.get("building-facade-window").evaluate(P,{},l);Ue=gi[0],Ze=gi[1]}const Pe=[],Ie=new Ae(1/0,1/0),He=new Ae(-1/0,-1/0),ai=new Ae(0,0);let Ge=0;for(const Ve of it)if(Ve.length>0){const gi=[];for(const qi of Ve){const ji=[];for(let Cr=qi.length-1;Cr>=0;Cr--){const or=qi[Cr];ji.push({x:or.x,y:or.y}),Ie.x=Math.min(Ie.x,or.x),Ie.y=Math.min(Ie.y,or.y),He.x=Math.max(He.x,or.x),He.y=Math.max(He.y,or.y),ai.x+=or.x,ai.y+=or.y,Ge++}gi.push(ji)}Pe.push({id:P.id?P.id:0,height:At,minHeight:yt,sourceId:0,roofType:gt,coordinates:gi})}ai.x/=Ge||1,ai.y/=Ge||1;const Pi=m.generateMesh(Pe,fe);if(typeof Pi=="string"){Hi(`Unable to generate building ${P.id}: ${Pi}`);continue}if(Pi.meshes.length===0||Pi.modifiedPolygonRings.length===0)continue;let Bi=0;for(const Ve of Pi.meshes)Bi+=Ve.positions.length/3;const vi=ke?this.buildingWithFacade:this.buildingWithoutFacade,mi=vi.segmentsBucket.prepareSegment(Bi,vi.layoutVertexArray,vi.indexArray),_r=[];let yi=null,Yi=0,wr=-1;const Vr=vi.layoutVertexArray.length,pn=vi.indexArray.length;let Tr=0;for(const Ve of Pi.meshes){const gi=vi.layoutVertexArray.length;if(Ve.buildingPart==="entrance"){const Ni=new Array;for(let ln=0;ln<Ve.positions.length;ln+=12){const Jn=Ve.positions[ln+0],Ln=Ve.positions[ln+1],Jo=Ve.positions[ln+3],Eo=Ve.positions[ln+4],_o=Ve.positions[ln+2],Gn=Ve.positions[ln+8]-_o,Sn=1,Dr=Jo-Jn,In=Eo-Ln,yo=Math.hypot(Dr,In);Ni.push({pos:[Jn+.5*Dr,Ln+.5*In,_o],normal:[In/yo,-Dr/yo,0],width:yo,height:Gn,depth:Sn,points:[Jn,Ln,Jo,Eo]})}const vn=vi.entranceBloom.segmentsBucket.prepareSegment(10*Ni.length,vi.entranceBloom.layoutVertexArray,vi.entranceBloom.indexArray),Yn=vi.entranceBloom.layoutVertexArray.length;Yi=vi.entranceBloom.indexArray.length,xh(Ni,.5/this.tileToMeter,vi.entranceBloom.indexArray,vi.entranceBloom.layoutVertexArray,vi.entranceBloom.layoutAttenuationArray);const lr=vi.entranceBloom.layoutVertexArray.length-Yn;wr=vi.entranceBloom.indexArray.length-Yi;for(let ln=0;ln<lr;ln++)vi.entranceBloom.layoutColorArray.emplaceBack(65535,65535);vn.vertexLength+=lr,vn.primitiveLength+=wr,yi={part:Ve.buildingPart,vertexOffset:Yn,vertexLength:lr}}for(let Ni=0;Ni<Ve.positions.length;Ni+=3)Tr=Math.max(Tr,Ve.positions[Ni+2]),vi.layoutVertexArray.emplaceBack(Ve.positions[Ni],Ve.positions[Ni+1],Ve.positions[Ni+2]);const qi=Math.floor(ai.x),ji=Math.floor(ai.y),Cr=Math.floor(Tr);for(let Ni=0;Ni<Ve.positions.length;Ni+=3)vi.layoutCentroidArray.emplaceBack(qi,ji,Cr),vi.layoutFloodLightDataArray.emplaceBack(Ve.buildingPart==="wall"?ne:0);for(let Ni=0;Ni<Ve.normals.length;Ni+=3)vi.layoutNormalArray.emplaceBack(Ve.normals[Ni+0]*np,Ve.normals[Ni+1]*np,Ve.normals[Ni+2]*np);for(let Ni=0;Ni<Ve.ao.length;Ni++)vi.layoutAOArray.emplaceBack(Ve.ao[Ni]);for(let Ni=0;Ni<Ve.colors.length;Ni+=3){const vn=1+(Ve.ao[Ni/3]-1)*kt;vi.layoutColorArray.emplaceBack(Ve.colors[Ni]*vn<<8|Ve.colors[Ni+1]*vn,Ve.colors[Ni+2]*vn<<8)}if(ke){for(let Ni=0;Ni<Ve.positions.length;Ni+=3)vi.layoutFacadePaintArray.emplaceBack(65535,255);for(let Ni=0;Ni<Ve.isFauxFacade.length;Ni++)if(Ve.isFauxFacade[Ni]){const vn=1|Math.min(65535,Math.floor(Ve.uv[2*Ni]*Pi.outerRingLength)),Yn=Math.floor(255*Ue)<<8|Math.floor(255*Ze),lr=Math.floor(65535*Math.min(1,hi/ri)),ln=Math.floor(65535*Math.min(1,Ke/ri));vi.layoutFacadeDataArray.emplaceBack(vn,Yn,lr,ln);const Jn=Math.floor(65535*Math.min(1,je/ri)),Ln=Math.floor(65535*Math.min(1,Ye/ri));vi.layoutFacadeVerticalRangeArray.emplaceBack(Jn,Ln)}else vi.layoutFacadeDataArray.emplaceBack(0,0,0,0),vi.layoutFacadeVerticalRangeArray.emplaceBack(0,0)}const or=mi.vertexLength;for(let Ni=0;Ni<Ve.indices.length;Ni+=3)vi.indexArray.emplaceBack(or+Ve.indices[Ni],or+Ve.indices[Ni+1],or+Ve.indices[Ni+2]);mi.vertexLength+=Ve.positions.length/3,mi.primitiveLength+=Ve.indices.length/3,(Ve.buildingPart==="roof"||Ve.buildingPart==="wall"||Ve.buildingPart==="facade_glazing"||Ve.buildingPart==="entrance")&&_r.push({part:Ve.buildingPart,vertexOffset:gi,vertexLength:Ve.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Tr),this.buildingFeatures.push({promoteId:R,feature:q,hasFauxFacade:ke,segment:mi,parts:_r,buildingBloom:yi});const wn=vi.indexArray.length-pn,Tn=[],No=[],Ft=new Ae(1/0,1/0),zt=new Ae(-1/0,-1/0),Ne=this.groundEffect.vertexArray.length;for(const Ve of Pi.modifiedPolygonRings){const gi=[],qi=new Ae(1/0,1/0),ji=new Ae(-1/0,-1/0);for(let Cr=0;Cr<Ve.length;Cr+=2){const or=Ve.length-Cr-2;qi.x=Math.min(qi.x,Ve[or]),qi.y=Math.min(qi.y,Ve[or+1]),ji.x=Math.max(ji.x,Ve[or]),ji.y=Math.max(ji.y,Ve[or+1]);const Ni=new Ae(Ve[or],Ve[or+1]);gi.push(Ni),Tn.push(Ni.x,Ni.y),No.push(Ni.clone())}Ft.x=Math.min(Ft.x,qi.x),Ft.y=Math.min(Ft.y,qi.y),zt.x=Math.max(zt.x,ji.x),zt.y=Math.max(zt.y,ji.y),this.groundEffect.addData(gi,[qi,ji],Xt)}const pi=this.groundEffect.vertexArray.length-Ne;for(let Ve=0;Ve<pi;Ve++)this.groundEffect.groundRadiusArray.emplaceBack(Gt);(Ie.x<0||He.x>ri||Ie.y<0||He.y>ri)&&this.featuresOnBorder.push({featureId:P.id,footprintIndex:this.footprints.length});{const Ve=$p(Tn,null,2),gi=new Ym(No,Ve,8,256);let qi=P.id;P.properties&&P.properties.hasOwnProperty("building_id")&&(qi=P.properties.building_id);const ji={vertices:No,indices:Ve,grid:gi,min:Ft,max:zt,buildingId:qi,hiddenFlags:0,indicesOffset:pn,indicesLength:wn,bloomIndicesOffset:Yi,bloomIndicesLength:wr,groundEffectVertexOffset:Ne,groundEffectVertexLength:pi,hasFauxFacade:ke,segment:mi,height:Tr};P.id!==void 0&&this.featureFootprintLookup.set(P.id,this.footprints.length),this.footprints.push(ji)}this.programConfigurations.populatePaintArrays(vi.layoutVertexArray.length,P,F,{},r.availableImages,l,r.brightness),this.groundEffect.addPaintPropertiesData(P,F,{},r.availableImages,l,r.brightness),r.featureIndex.insert(P,Y,F,O,this.index,Vr)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0],{})}update(t,r,l,u,m,_,b){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b),this.groundEffect.update(t,r,m,l,u,_,b),this.evaluate(this.layers[0],t),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){const r=l=>{l.layoutVertexBuffer=t.createVertexBuffer(l.layoutVertexArray,xs.members),l.layoutNormalBuffer=t.createVertexBuffer(l.layoutNormalArray,ya.members),l.layoutCentroidBuffer=t.createVertexBuffer(l.layoutCentroidArray,ks.members),l.layoutFloodLightDataBuffer=t.createVertexBuffer(l.layoutFloodLightDataArray,Ff.members),l.layoutFacadeDataArray&&l.layoutFacadeDataArray.length&&(l.layoutFacadeDataBuffer=t.createVertexBuffer(l.layoutFacadeDataArray,Lu.members)),l.layoutFacadeVerticalRangeArray&&l.layoutFacadeVerticalRangeArray.length&&(l.layoutFacadeVerticalRangeBuffer=t.createVertexBuffer(l.layoutFacadeVerticalRangeArray,sg.members)),l.entranceBloom.layoutVertexArray.length&&(l.entranceBloom.layoutVertexBuffer=t.createVertexBuffer(l.entranceBloom.layoutVertexArray,xs.members),l.entranceBloom.layoutAttenuationBuffer=t.createVertexBuffer(l.entranceBloom.layoutAttenuationArray,Qp.members)),this.uploadUpdatedColorBuffer(t),this.uploadUpdatedIndexBuffer(t)};this.uploaded||(r(this.buildingWithoutFacade),r(this.buildingWithFacade),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){const t=r=>{r.layoutVertexBuffer&&(r.layoutVertexBuffer.destroy(),r.layoutNormalBuffer.destroy(),r.layoutColorBuffer.destroy(),r.segmentsBucket.destroy(),r.indexBuffer&&r.indexBuffer.destroy(),r.entranceBloom.layoutVertexBuffer&&(r.entranceBloom.layoutVertexBuffer.destroy(),r.entranceBloom.layoutColorBuffer.destroy(),r.entranceBloom.layoutAttenuationBuffer.destroy(),r.entranceBloom.indexBuffer.destroy(),r.entranceBloom.segmentsBucket.destroy()))};t(this.buildingWithoutFacade),t(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(t,r,l=!0){let u=!1;const m=l?r:0,_=0|(l?-1:~r);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const b of t){const E=this.footprints[b],P=E.hiddenFlags&_|m;E.hiddenFlags!==P&&(E.hiddenFlags=P,u=!0,this.groundEffect.updateHiddenByLandmarkRange(E.groundEffectVertexOffset,E.groundEffectVertexLength,E.hiddenFlags!==0))}return u&&(this.indexArrayForConflationUploaded=!1),u}uploadUpdatedIndexBuffer(t){if(this.groundEffect.uploadHiddenByLandmark(t),this.indexArrayForConflationUploaded)return;const r=u=>{u.indexArray.length!==0&&(u.indexArrayForConflation.resize(u.indexArray.length),u.indexArrayForConflation.uint16.set(u.indexArray.uint16),u.entranceBloom.indexArrayForConflation.resize(u.entranceBloom.indexArray.length),u.entranceBloom.indexArrayForConflation.uint16.set(u.entranceBloom.indexArray.uint16))};r(this.buildingWithoutFacade),r(this.buildingWithFacade);for(const u of this.footprints){const m=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,_=u.indicesOffset+u.indicesLength;if(u.hiddenFlags!==0){for(let E=u.indicesOffset;E<_;E++)m.indexArrayForConflation.uint16[3*E+0]=0,m.indexArrayForConflation.uint16[3*E+1]=0,m.indexArrayForConflation.uint16[3*E+2]=0;const b=u.bloomIndicesOffset+u.bloomIndicesLength;for(let E=u.bloomIndicesOffset;E<b;E++)m.entranceBloom.indexArrayForConflation.uint16[3*E+0]=0,m.entranceBloom.indexArrayForConflation.uint16[3*E+1]=0,m.entranceBloom.indexArrayForConflation.uint16[3*E+2]=0}}const l=u=>{u.indexArray.length!==0&&(u.indexBuffer?u.indexBuffer.updateData(u.indexArrayForConflation):u.indexBuffer=t.createIndexBuffer(u.indexArrayForConflation,!0),u.entranceBloom.indexBuffer?u.entranceBloom.indexBuffer.updateData(u.entranceBloom.indexArrayForConflation):u.entranceBloom.indexBuffer=t.createIndexBuffer(u.entranceBloom.indexArrayForConflation,!0))};l(this.buildingWithoutFacade),l(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(t){const r=l=>{l.layoutColorBuffer?l.layoutColorBuffer.updateData(l.layoutColorArray):l.layoutColorBuffer=t.createVertexBuffer(l.layoutColorArray,Ca.members,!0),l.layoutFacadePaintArray&&(l.layoutFacadePaintBuffer?l.layoutFacadePaintBuffer.updateData(l.layoutFacadePaintArray):l.layoutFacadePaintBuffer=t.createVertexBuffer(l.layoutFacadePaintArray,rp.members,!0)),l.entranceBloom.layoutColorBuffer?l.entranceBloom.layoutColorBuffer.updateData(l.entranceBloom.layoutColorArray):l.entranceBloom.layoutColorBuffer=t.createVertexBuffer(l.entranceBloom.layoutColorArray,Ca.members,!0)};r(this.buildingWithoutFacade),r(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(t,r){const l=t.paint.get("building-ambient-occlusion-intensity");for(const u of this.buildingFeatures){const m=r[u.promoteId],_=u.feature;_.properties["building-part"]="roof";const b=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),E=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical);_.properties["building-part"]="wall";const P=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),R=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical);_.properties["building-part"]="window";const F=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),O=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical);_.properties["building-part"]="door";const $=t.paint.get("building-color").evaluate(_,m,this.canonical).toPremultipliedRenderColor(this.lut),q=t.paint.get("building-emissive-strength").evaluate(_,m,this.canonical),Y=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const at of u.parts){let gt,yt=b;at.part==="roof"?(yt=b,gt=E):at.part==="wall"?(yt=P,gt=R):at.part==="facade_glazing"?(yt=F,gt=O):at.part==="entrance"&&(yt=$,gt=q),gt=tt(gt,0,1);for(let At=0;At<at.vertexLength;At++){const Gt=at.vertexOffset+At,kt=1+(Y.layoutAOArray.float32[Gt]-1)*l;Y.layoutColorArray.emplace(Gt,yt.r*kt*255<<8|yt.g*kt*255,yt.b*kt*255<<8|255*gt),u.hasFauxFacade&&Y.layoutFacadePaintArray.emplace(Gt,255*F.r<<8|255*F.g,255*F.b<<8|255*O)}}const it=u.buildingBloom;if(it)for(let at=0;at<it.vertexLength;at++)Y.entranceBloom.layoutColorArray.emplace(it.vertexOffset+at,255*$.r<<8|255*$.g,255*$.b<<8|51*q)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(t,r,l){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const u=r.getReplacementRegionsForTile(t.toUnwrapped());if(Df(this.activeReplacements,u))return;this.activeReplacements=u;for(const _ of this.footprints)_.hiddenFlags&=-2;const m=[];for(const _ of this.activeReplacements){if(_.order<=N_)continue;const b=Math.max(1,Math.pow(2,_.footprintTileId.canonical.z-t.canonical.z));for(const E of this.footprints)E.min.x>_.max.x||E.max.x<_.min.x||E.min.y>_.max.y||E.max.y<_.min.y||(m.length=0,g0(E.vertices,0,E.vertices.length,_.footprintTileId.canonical,t.canonical,m),Vg(_.footprint,m,E.indices,0,E.indices.length,0,-b)&&(E.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const _ of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(_.groundEffectVertexOffset,_.groundEffectVertexLength,_.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(t){if(t.id!==void 0){const r=this.featureFootprintLookup.get(t.id);return this.footprints[r]}return null}getHeightAtTileCoord(t,r){let l=Number.NEGATIVE_INFINITY,u=!0;const m=4*(t+ri)*ri+(r+ri);if(this.footprintLookup.hasOwnProperty(m)){const b=this.footprintLookup[m];return b?{height:b.height,hidden:b.hiddenFlags!==0}:void 0}const _=new Ae(t,r);for(const b of this.footprints)t>b.max.x||b.min.x>t||r>b.max.y||b.min.y>r||b.height<=l||Ug(_,b)&&(l=b.height,this.footprintLookup[m]=b,u=b.hiddenFlags!==0);if(l!==Number.NEGATIVE_INFINITY)return{height:l,hidden:u};this.footprintLookup[m]=void 0}}function g0(n,t,r,l,u,m){const _=Math.pow(2,l.z-u.z);for(let b=0;b<r;b++){let E=n[b+t].x,P=n[b+t].y;E=(E+u.x*ri)*_-l.x*ri,P=(P+u.y*ri)*_-l.y*ri,m.push(new Ae(E,P))}}let Jg,Kg;Ei(oy,"BuildingBucket",{omit:["layers"]}),Ei(Yg,"BuildingGeometry"),Ei(ny,"BuildingBloomGeometry");const op=Er([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),_0=Er([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:y0}=op,px=Er([{name:"a_packed",components:3,type:"Float32"}]),{members:fx}=px,mx=Er([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:gx}=mx;class x0{constructor(t,r){this.width=t,this.height=r,this.nextRow=0,this.image=new Kd({width:t,height:r}),this.positions={},this.uploaded=!1}getDash(t,r){const l=this.getKey(t,r);return this.positions[l]}trim(){const t=this.width,r=this.height=Yt(this.nextRow);this.image.resize({width:t,height:r})}getKey(t,r){return t.join(",")+r}getDashRanges(t,r,l){const u=[];let m=t.length%2==1?-t[t.length-1]*l:0,_=t[0]*l,b=!0;u.push({left:m,right:_,isDash:b,zeroLength:t[0]===0});let E=t[0];for(let P=1;P<t.length;P++){b=!b;const R=t[P];m=E*l,E+=R,_=E*l,u.push({left:m,right:_,isDash:b,zeroLength:R===0})}return u}addRoundDash(t,r,l){const u=r/2;for(let m=-l;m<=l;m++){const _=this.width*(this.nextRow+l+m);let b=0,E=t[b];for(let P=0;P<this.width;P++){P/E.right>1&&(E=t[++b]);const R=Math.abs(P-E.left),F=Math.abs(P-E.right),O=Math.min(R,F);let $;const q=m/l*(u+1);if(E.isDash){const Y=u-Math.abs(q);$=Math.sqrt(O*O+Y*Y)}else $=u-Math.sqrt(O*O+q*q);this.image.data[_+P]=Math.max(0,Math.min(255,$+128))}}}addRegularDash(t,r){for(let E=t.length-1;E>=0;--E){const P=t[E],R=t[E+1];P.zeroLength?t.splice(E,1):R&&R.isDash===P.isDash&&(R.left=P.left,t.splice(E,1))}const l=t[0],u=t[t.length-1];l.isDash===u.isDash&&(l.left=u.left-this.width,u.right=l.right+this.width);const m=this.width*this.nextRow;let _=0,b=t[_];for(let E=0;E<this.width;E++){E/b.right>1&&(b=t[++_]);const P=Math.abs(E-b.left),R=Math.abs(E-b.right),F=Math.min(P,R);this.image.data[m+E]=Math.max(0,Math.min(255,(b.isDash?F:-F)+r+128))}}addDash(t,r){const l=this.getKey(t,r);if(this.positions[l])return this.positions[l];const u=r==="round",m=u?7:0,_=2*m+1;if(this.nextRow+_>this.height)return Hi("LineAtlas out of space"),null;t.length===0&&t.push(1);let b=0;for(let R=0;R<t.length;R++)t[R]<0&&(Hi("Negative value is found in line dasharray, replacing values with 0"),t[R]=0),b+=t[R];if(b!==0){const R=this.width/b,F=this.getDashRanges(t,this.width,R);u?this.addRoundDash(F,R,m):this.addRegularDash(F,r==="square"?.5*R:0)}const E=this.nextRow+m;this.nextRow+=_;const P={tl:[E,m],br:[b,0]};return this.positions[l]=P,P}}Ei(x0,"LineAtlas");const _x=qe.types,yx=Math.cos(Math.PI/180*37.5),xx=Math.cos(Math.PI/180*5);class vh{constructor(t){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=t.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=t.overscaling,this.pixelRatio=t.pixelRatio,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new qc,this.layoutVertexArray2=new ta,this.patternVertexArray=new ta,this.indexArray=new ro,this.programConfigurations=new _h(t.layers,{zoom:t.zoom,lut:t.lut}),this.segments=new To,this.maxLineLength=0,this.zOffsetVertexArray=new ta,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.tessellationStep=t.tessellationStep?t.tessellationStep:ri/64,this.worldview=t.worldview,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.hasPattern=ia("line",this.layers,this.pixelRatio,r);const m=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Zt(l);const _=this.layers[0].layout.get("line-elevation-reference");if(_==="hd-road-markup")this.elevationType="road";else{const O=this.layers[0].layout.get("line-z-offset"),$=O.isConstant()&&!O.constantOr(0);this.elevationType=_!=="sea"&&_!=="ground"&&$?"none":"offset",this.elevationType==="offset"&&_==="none"&&Hi(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const b=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&b!==void 0;const E=[];for(const{feature:O,id:$,index:q,sourceLayerIndex:Y}of t){const it=this.layers[0]._featureFilter.needGeometry,at=Te(O,it);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),at,l))continue;const gt=m?m.evaluate(at,{},l):void 0,yt={id:$,properties:O.properties,type:O.type,sourceLayerIndex:Y,index:q,geometry:it?at.geometry:Oe(O,l,u),patterns:{},sortKey:gt};E.push(yt)}m&&E.sort((O,$)=>O.sortKey-$.sortKey);const{lineAtlas:P,featureIndex:R}=r,F=this.addConstantDashes(P);for(const O of E){const{geometry:$,index:q,sourceLayerIndex:Y}=O;if(F&&this.addFeatureDashes(O,P),this.hasPattern){const it=hm("line",this.layers,O,this.zoom,this.pixelRatio,r);this.patternFeatures.push(it)}else this.addFeature(O,$,q,l,P.positions,r.availableImages,r.brightness,r.elevationFeatures);R.insert(t[q].feature,$,q,Y,this.index)}}addConstantDashes(t){let r=!1;for(const l of this.layers){const u=l.paint.get("line-dasharray").value,m=l.layout.get("line-cap").value;if(u.kind!=="constant"||m.kind!=="constant")r=!0;else{const _=m.value,b=u.value;if(!b)continue;t.addDash(b,_)}}return r}addFeatureDashes(t,r){const l=this.zoom;for(const u of this.layers){const m=u.paint.get("line-dasharray").value,_=u.layout.get("line-cap").value;if(m.kind==="constant"&&_.kind==="constant")continue;let b,E;if(m.kind==="constant"){if(b=m.value,!b)continue}else b=m.evaluate({zoom:l},t);E=_.kind==="constant"?_.value:_.evaluate({zoom:l},t),r.addDash(b,E),t.patterns[u.id]=[r.getKey(b,E)]}}update(t,r,l,u,m,_,b,E){this.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,E)}addFeatures(t,r,l,u,m,_){for(const b of this.patternFeatures)this.addFeature(b,b.geometry,b.index,r,l,u,_)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,fx)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=t.createVertexBuffer(this.patternVertexArray,gx)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,_0.members,!0)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,y0),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t,r){let l,u;if(r&&r>0?(l=`mapbox_clip_start_${r}`,u=`mapbox_clip_end_${r}`):(l="mapbox_clip_start",u="mapbox_clip_end"),t.properties&&t.properties.hasOwnProperty(l)&&t.properties.hasOwnProperty(u))return{start:+t.properties[l],end:+t.properties[u]}}addFeature(t,r,l,u,m,_,b,E){const P=this.layers[0].layout,R=P.get("line-join").evaluate(t,{}),F=P.get("line-cap").evaluate(t,{}),O=P.get("line-miter-limit"),$=P.get("line-round-limit");this.lineClips=this.lineFeatureClips(t),this.lineFeature=t;const q=!(!t.properties||!t.properties.hasOwnProperty("mapbox_line_metrics"))&&t.properties.mapbox_line_metrics;this.zOffsetValue=P.get("line-z-offset").value;const Y=this.layers[0].paint.get("line-width").value;if(Y.kind!=="constant"&&Y.isLineProgressConstant===!1&&(this.variableWidthValue=Y),this.elevationType==="road"){const it=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(t,r,u,E,R,F,O,$)){const[at,gt]=this.clipRuntimeLinesToTile(r,1);for(let yt=0;yt<at.length;yt++){const At=at[yt],Gt=gt[yt],kt={progress:{min:Gt.progress.min,max:Gt.progress.max},nextDir:this.computeSegNextDir(Gt,At),prevDir:this.computeSegPrevDir(Gt,At)};this.addLine(At,t,u,R,F,O,$,kt,q&&Gt.parentIndex>0?Gt.parentIndex:null)}this.fillNonElevatedRoadSegment(it)}}else for(let it=0;it<r.length;it++)this.addLine(r[it],t,u,R,F,O,$,void 0,q&&it>0?it:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,l,m,_,u,b,void 0,this.worldview)}computeSegNextDir(t,r){return t.nextPoint.sub(r.at(-2)).unit()}computeSegPrevDir(t,r){return r[1].sub(t.prevPoint).unit()}clipLinesToTile(t,r){return Zg(t,-r,-r,ri+r,ri+r)}clipRuntimeLinesToTile(t,r){const l=[];return[Zg(t,-r,-r,ri+r,ri+r,l),l]}addElevatedRoadFeature(t,r,l,u,m,_,b,E){const P=[],R=mr.getElevationFeature(t,u);if(R){const F=this.clipLinesToTile(r,1),O=this.prepareElevatedLines(F,R,l);for(const $ of O)P.push({geometry:$,elevation:R,elevationTileID:l,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(P.length===0)return!1;for(const F of P){const O=this.layoutVertexArray.length;this.addLine(F.geometry,t,l,m,_,b,E);const $=new nn(l,F.elevationTileID);if(F.elevation)for(let q=O;q<this.layoutVertexArray.length;q++){const Y=new Ae(this.layoutVertexArray.int16[6*q]>>1,this.layoutVertexArray.int16[6*q+1]>>1),it=$.pointElevation(Y,F.elevation,.05);this.updateHeightRange(it),this.zOffsetVertexArray.emplaceBack(it,0,0)}else this.fillNonElevatedRoadSegment(O)}return!0}prepareElevatedLines(t,r,l){if(r.constantHeight!=null)return t;const u=[],m=1/Zt(l);for(const _ of t)d0(_,new fo(r,m),0,u);return u}fillNonElevatedRoadSegment(t){for(let r=t;r<this.layoutVertexArray.length;r++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(t){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,t),this.heightRange.max=Math.max(this.heightRange.max,t)):this.heightRange={min:t,max:t}}addLine(t,r,l,u,m,_,b,E,P){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=P?this.lineFeatureClips(r,P):this.lineClips;const R=u==="none";this.patternJoinNone=this.hasPattern&&R,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const F=E&&E.progress.min>0,O=E&&E.progress.max<1;if(this.lineClips){let ne={min:this.lineClips.start,max:this.lineClips.end},ze=1;if(E){const Ue=this.lineClips.end-this.lineClips.start;ne=function(Ze,hi,Ke){return{min:Dn(Ze.min,hi,Ke),max:Dn(Ze.max,hi,Ke)}}(E.progress,{min:0,max:1},ne),Ue>0&&(ze=(ne.max-ne.min)/Ue)}const fe=+r.properties.mapbox_clip_feature_len,ke=+r.properties.mapbox_clip_seg_len;if(Number.isNaN(fe)||Number.isNaN(ke)){for(let Ze=0;Ze<t.length-1;Ze++)this.totalDistance+=t[Ze].dist(t[Ze+1]);const Ue=this.totalDistance/(ne.max-ne.min);this.totalFeatureLength=Number.isFinite(Ue)?Ue:0,this.lineClips.start=ne.min,this.lineClips.end=ne.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=fe,this.distance=ke*ze,this.lineClips.start=ne.min,this.lineClips.end=ne.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const $=_x[r.type]==="Polygon";let q=t.length;for(;q>=2&&t[q-1].equals(t[q-2]);)q--;let Y=0;for(;Y<q-1&&t[Y].equals(t[Y+1]);)Y++;if(q<($?3:2))return;u==="bevel"&&(_=1.05);const it=this.segments.prepareSegment(10*q,this.layoutVertexArray,this.indexArray);let at,gt,yt,At,Gt,kt,Xt,te;E&&E.prevDir&&(kt=E.prevDir.perp()),E&&E.nextDir&&(Xt=E.nextDir.perp()),this.e1=this.e2=-1,$&&(at=t[q-2],Gt=t[Y].sub(at)._unit()._perp());for(let ne=Y;ne<q;ne++){if(yt=ne===q-1?$?t[Y+1]:void 0:t[ne+1],yt&&t[ne].equals(yt))continue;Gt&&(At=Gt),at&&(gt=at),at=t[ne],te=this.evaluateLineProgressFeatures(gt?gt.dist(at):0),Gt=yt?yt.sub(at)._unit()._perp():At,At=At||Gt;const ze=gt&&yt;let fe=ze?u:$||R?"butt":m;const ke=At.x*Gt.x+At.y*Gt.y;if(R){const Ie=function(He){if(He.patternJoinNone){const ai=He.segmentPoints.length/2,Ge=He.lineSoFar-He.segmentStart;for(let Pi=0;Pi<ai;++Pi){const Bi=He.segmentPoints[2*Pi+1],vi=Math.round(He.segmentPoints[2*Pi])+.5+.25*Bi;He.patternVertexArray.emplaceBack(vi,Ge,He.segmentStart),He.patternVertexArray.emplaceBack(vi,Ge,He.segmentStart)}He.segmentPoints.length=0}He.e1=He.e2=-1};if(ze&&ke<xx){this.updateDistance(gt,at),this.addCurrentVertex(at,At,1,1,it,te),Ie(this),this.addCurrentVertex(at,Gt,-1,-1,it,te);continue}if(gt){if(!yt){this.updateDistance(gt,at),this.addCurrentVertex(at,At,1,1,it,te),Ie(this);continue}fe="miter"}}let Ue=At.add(Gt);Ue.x===0&&Ue.y===0||Ue._unit();const Ze=Ue.x*Gt.x+Ue.y*Gt.y,hi=Ze!==0?1/Ze:1/0,Ke=2*Math.sqrt(2-2*Ze),je=Ze<yx&&gt&&yt,Ye=At.x*Gt.y-At.y*Gt.x>0,Pe=this.overscaling<=16?15*ri/(512*this.overscaling):0;if(ze&&fe==="round"){if(hi<b)fe="miter";else if(hi<=2){const Ie=bm(at,-10,ri+10);fe=this.elevationType==="offset"&&(Ie||this.hasCrossSlope)?"miter":"fakeround"}}if(fe==="miter"&&hi>_&&(fe="bevel"),fe==="bevel"&&(hi>2&&(fe="flipbevel"),hi<_&&(fe="miter")),gt&&!(fe==="miter"&&je)&&this.updateDistance(gt,at),fe==="miter")if(je){const Ie=at.dist(gt);if(Ie>2*Pe){const ai=at.sub(at.sub(gt)._mult(Pe/Ie)._round());this.updateDistance(gt,ai),this.addCurrentVertex(ai,At,0,0,it,te),gt=ai}this.updateDistance(gt,at),Ue._mult(hi),this.addCurrentVertex(at,Ue,0,0,it,te);const He=at.dist(yt);if(He>2*Pe){const ai=at.add(yt.sub(at)._mult(Pe/He)._round());this.updateDistance(at,ai),this.addCurrentVertex(ai,Gt,0,0,it,te),at=ai}}else Ue._mult(hi),this.addCurrentVertex(at,Ue,0,0,it,te);else if(fe==="flipbevel"){if(hi>100)Ue=Gt.mult(-1);else{const Ie=hi*At.add(Gt).mag()/At.sub(Gt).mag();Ue._perp()._mult(Ie*(Ye?-1:1))}this.addCurrentVertex(at,Ue,0,0,it,te),this.addCurrentVertex(at,Ue.mult(-1),0,0,it,te)}else if(fe==="bevel"||fe==="fakeround"){te!=null&&gt&&this.addCurrentVertex(at,Xt||At,-1,-1,it,te);const Ie=at.dist(gt)<=2*Pe&&fe!=="bevel",He=Ue.mult(Ye?1:-1);He._mult(hi);const ai=Gt.mult(Ye?-1:1),Ge=At.mult(Ye?-1:1),Pi=this.evaluateLineProgressFeatures(this.distance);if(te==null&&(this.addHalfVertex(at,He.x,He.y,!1,!Ye,0,it,Pi),Ie||this.addHalfVertex(at,He.x+2*Ge.x,He.y+2*Ge.y,!1,Ye,0,it,Pi)),fe==="fakeround"){const Bi=Math.round(180*Ke/Math.PI/20);this.addHalfVertex(at,Ge.x,Ge.y,!1,Ye,0,it,Pi);for(let vi=0;vi<Bi;vi++){let mi=vi/Bi;if(mi!==.5){const yi=mi-.5;mi+=mi*yi*(mi-1)*((1.0904+ke*(ke*(3.55645-1.43519*ke)-3.2452))*yi*yi+(.848013+ke*(.215638*ke-1.06021)))}const _r=ai.sub(Ge)._mult(mi)._add(Ge)._unit();this.addHalfVertex(at,_r.x,_r.y,!1,Ye,0,it,Pi)}this.addHalfVertex(at,ai.x,ai.y,!1,Ye,0,it,Pi)}Ie||te!=null||this.addHalfVertex(at,He.x+2*ai.x,He.y+2*ai.y,!1,Ye,0,it,Pi),te!=null&&yt&&this.addCurrentVertex(at,kt||Gt,1,1,it,te)}else if(fe==="butt")this.addCurrentVertex(at,Ue,0,0,it,te);else if(fe==="square"){if(!gt){const Ie=F?0:-1;this.addCurrentVertex(at,Ue,Ie,Ie,it,te)}if(this.addCurrentVertex(at,Ue,0,0,it,te),gt){const Ie=O?0:1;this.addCurrentVertex(at,Ue,Ie,Ie,it,te)}}else if(fe==="round"){if(gt){const Ie=!ze&&Xt?Xt:At;this.addCurrentVertex(at,Ie,0,0,it,te),!ze&&O||this.addCurrentVertex(at,Ie,1,1,it,te,!0)}if(yt){const Ie=!ze&&kt?kt:Gt;!ze&&F||this.addCurrentVertex(at,Ie,-1,-1,it,te,!0),this.addCurrentVertex(at,Ie,0,0,it,te)}}}}addVerticesTo(t,r,l,u,m,_,b,E,P,R){const F=(r.w-t.w)/this.tessellationStep|0;let O=0;const $=this.scaledDistance;if(F>1){this.lineSoFar=t.w;const Y=(r.x-t.x)/F,it=(r.y-t.y)/F,at=(r.z-t.z)/F,gt=(r.w-t.w)/F;for(let yt=1;yt<F;++yt){t.x+=Y,t.y+=it,t.z+=at,this.lineSoFar+=gt,O+=gt;const At=this.evaluateLineProgressFeatures(this.prevDistance+O);this.scaledDistance=(this.prevDistance+O)/this.totalDistance,this.addHalfVertex(t,l,u,R,!1,b,P,At),this.addHalfVertex(t,m,_,R,!0,-E,P,At)}}this.lineSoFar=r.w,this.scaledDistance=$;const q=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(r,l,u,R,!1,b,P,q),this.addHalfVertex(r,m,_,R,!0,-E,P,q)}evaluateLineProgressFeatures(t){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+t)/this.totalFeatureLength):Hi(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let r=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(r=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:r}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:r}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:r}}addCurrentVertex(t,r,l,u,m,_,b=!1){const E=r.x+r.y*l,P=r.y-r.x*l,R=r.y*u-r.x,F=-r.y-r.x*u;if(_!=null){const O=this.elevationType==="offset",$=-10,q=ri+10,Y=_.zOffset,it=new K_(t.x,t.y,Y,this.lineSoFar),at=!!O&&bm(t,$,q),gt=this.lineSoFar,yt=this.distance;if(this.currentVertex)if(at){const At=this.currentVertexIsOutside,Gt=this.currentVertex,kt=new K_(t.x,t.y,Y,this.lineSoFar);if(u0(Gt,kt,$,q),!bm(kt,$,q)){if(At){this.e1=this.e2=-1,this.distance-=Gt.dist(it),this.lineSoFar=Gt.w;const Xt=this.evaluateLineProgressFeatures(Gt.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(Gt,E,P,b,!1,l,m,Xt),this.addHalfVertex(Gt,R,F,b,!0,-u,m,Xt),this.prevDistance=this.distance}this.distance=this.prevDistance+Gt.dist(kt),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(Gt,kt,E,P,R,F,l,u,m,b),this.distance=yt,this.scaledDistance=this.distance/this.totalDistance}}else{const At=this.currentVertex;if(this.currentVertexIsOutside){u0(At,it,$,q),this.e1=this.e2=-1,this.distance-=At.dist(it),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=At.w;const Gt=this.evaluateLineProgressFeatures(At.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(At,E,P,b,!1,l,m,Gt),this.addHalfVertex(At,R,F,b,!0,-u,m,Gt),this.prevDistance=this.distance,this.distance=yt,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(At,it,E,P,R,F,l,u,m,b)}else at||(this.addHalfVertex(t,E,P,b,!1,l,m,_),this.addHalfVertex(t,R,F,b,!0,-u,m,_));this.currentVertex=it,this.currentVertexIsOutside=at,this.lineSoFar=gt}else this.addHalfVertex(t,E,P,b,!1,l,m,_),this.addHalfVertex(t,R,F,b,!0,-u,m,_)}addHalfVertex({x:t,y:r},l,u,m,_,b,E,P){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),_||this.segmentPoints.push(this.lineSoFar-this.segmentStart,b)),this.layoutVertexArray.emplaceBack((t<<1)+(m?1:0),(r<<1)+(_?1:0),Math.round(63*l)+128,Math.round(63*u)+128,1+(b===0?0:b<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const F=Gi(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,F)}const R=E.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,R),E.primitiveLength++),_?this.e2=R:this.e1=R,P!=null&&this.zOffsetVertexArray.emplaceBack(P.zOffset,P.variableWidth,P.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(t,r){this.prevDistance=this.distance,this.distance+=t.dist(r),this.updateScaledDistance()}}function bm(n,t,r){return n.x<t||n.x>r||n.y<t||n.y>r}let sy,v0;function b0(n,t,r){return t*(ri/(n.tileSize*Math.pow(2,r-n.tileID.overscaledZ)))}Ei(vh,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const w0=(n,t,r)=>(1-r)*n+r*t;function El(n,t){return 1/b0(n,1,t.tileZoom)}function Hc(n,t,r,l){return n.translatePosMatrix(l||t.tileID.projMatrix,t,r.paint.get("line-translate"),r.paint.get("line-translate-anchor"))}const tf=n=>{const t=[];su(n)&&t.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const r=n.paint.get("line-trim-offset");r[0]===0&&r[1]===0||t.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&t.push("RENDER_LINE_BORDER");const l=n.layout.get("line-join").constantOr("miter")==="none",u=!!n.paint.get("line-pattern").constantOr(1);return l&&u&&t.push("LINE_JOIN_NONE"),t};function su(n){const t=n.paint.get("line-dasharray").value;return t.kind!=="constant"||t.value}let sp;const Ru=()=>sp||(sp={layout:sy||(sy=new Wt({"line-cap":new It(ft.layout_line["line-cap"]),"line-join":new It(ft.layout_line["line-join"]),"line-miter-limit":new pt(ft.layout_line["line-miter-limit"]),"line-round-limit":new pt(ft.layout_line["line-round-limit"]),"line-sort-key":new It(ft.layout_line["line-sort-key"]),"line-z-offset":new It(ft.layout_line["line-z-offset"]),"line-elevation-reference":new pt(ft.layout_line["line-elevation-reference"]),"line-cross-slope":new pt(ft.layout_line["line-cross-slope"]),visibility:new pt(ft.layout_line.visibility),"line-width-unit":new pt(ft.layout_line["line-width-unit"])})),paint:v0||(v0=new Wt({"line-opacity":new It(ft.paint_line["line-opacity"]),"line-color":new It(ft.paint_line["line-color"]),"line-translate":new pt(ft.paint_line["line-translate"]),"line-translate-anchor":new pt(ft.paint_line["line-translate-anchor"]),"line-width":new It(ft.paint_line["line-width"]),"line-gap-width":new It(ft.paint_line["line-gap-width"]),"line-offset":new It(ft.paint_line["line-offset"]),"line-blur":new It(ft.paint_line["line-blur"]),"line-dasharray":new It(ft.paint_line["line-dasharray"]),"line-pattern":new It(ft.paint_line["line-pattern"]),"line-pattern-cross-fade":new pt(ft.paint_line["line-pattern-cross-fade"]),"line-gradient":new Kt(ft.paint_line["line-gradient"]),"line-trim-offset":new pt(ft.paint_line["line-trim-offset"]),"line-trim-fade-range":new pt(ft.paint_line["line-trim-fade-range"]),"line-trim-color":new pt(ft.paint_line["line-trim-color"]),"line-emissive-strength":new pt(ft.paint_line["line-emissive-strength"]),"line-border-width":new It(ft.paint_line["line-border-width"]),"line-border-color":new It(ft.paint_line["line-border-color"]),"line-occlusion-opacity":new pt(ft.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},sp);class zb extends It{possiblyEvaluate(t,r){return r=new D(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,transition:r.transition,worldview:r.worldview}),super.possiblyEvaluate(t,r)}evaluate(t,r,l,u){return r=Object.assign({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(t,r,l,u)}}let ay;function cv(n,t){return t>0?t+2*n:n}const Lb=Er([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Rb=Er([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),kb=Er([{name:"a_projected_pos",components:4,type:"Float32"}],4);Er([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Fb=Er([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Bb=Er([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),Ob=Er([{name:"a_texb",components:2,type:"Uint16"}]),Nb=Er([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Vb=Er([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Er([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const hv=Er([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Ub=Er([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Er([{name:"triangle",components:3,type:"Uint16"}]),Er([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Er([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),Er([{type:"Float32",name:"offsetX"}]),Er([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Wa=24;function jb(n,t,r){return n.sections.forEach(l=>{l.text=function(u,m,_){const b=m.layout.get("text-transform").evaluate(_,{});return b==="uppercase"?u=u.toLocaleUpperCase():b==="lowercase"&&(u=u.toLocaleLowerCase()),S.applyArabicShaping&&(u=S.applyArabicShaping(u)),u}(l.text,t,r)}),n}const ly={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function Gb(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}function $b(n){return n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""||n===""}const vx=4294967296,uv=1/vx,dv=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let T0=class{constructor(n=new Uint8Array(16)){this.buf=ArrayBuffer.isView(n)?n:new Uint8Array(n),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(n,t,r=this.length){for(;this.pos<r;){const l=this.readVarint(),u=l>>3,m=this.pos;this.type=7&l,n(u,t,this),this.pos===m&&this.skip(l)}return t}readMessage(n,t){return this.readFields(n,t,this.readVarint()+this.pos)}readFixed32(){const n=this.dataView.getUint32(this.pos,!0);return this.pos+=4,n}readSFixed32(){const n=this.dataView.getInt32(this.pos,!0);return this.pos+=4,n}readFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*vx;return this.pos+=8,n}readSFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*vx;return this.pos+=8,n}readFloat(){const n=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,n}readDouble(){const n=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,n}readVarint(n){const t=this.buf;let r,l;return l=t[this.pos++],r=127&l,l<128?r:(l=t[this.pos++],r|=(127&l)<<7,l<128?r:(l=t[this.pos++],r|=(127&l)<<14,l<128?r:(l=t[this.pos++],r|=(127&l)<<21,l<128?r:(l=t[this.pos],r|=(15&l)<<28,function(u,m,_){const b=_.buf;let E,P;if(P=b[_.pos++],E=(112&P)>>4,P<128||(P=b[_.pos++],E|=(127&P)<<3,P<128)||(P=b[_.pos++],E|=(127&P)<<10,P<128)||(P=b[_.pos++],E|=(127&P)<<17,P<128)||(P=b[_.pos++],E|=(127&P)<<24,P<128)||(P=b[_.pos++],E|=(1&P)<<31,P<128))return Qg(u,E,m);throw new Error("Expected varint not more than 10 bytes")}(r,n,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const n=this.readVarint();return n%2==1?(n+1)/-2:n/2}readBoolean(){return!!this.readVarint()}readString(){const n=this.readVarint()+this.pos,t=this.pos;return this.pos=n,n-t>=12&&dv?dv.decode(this.buf.subarray(t,n)):function(r,l,u){let m="",_=l;for(;_<u;){const b=r[_];let E,P,R,F=null,O=b>239?4:b>223?3:b>191?2:1;if(_+O>u)break;O===1?b<128&&(F=b):O===2?(E=r[_+1],(192&E)==128&&(F=(31&b)<<6|63&E,F<=127&&(F=null))):O===3?(E=r[_+1],P=r[_+2],(192&E)==128&&(192&P)==128&&(F=(15&b)<<12|(63&E)<<6|63&P,(F<=2047||F>=55296&&F<=57343)&&(F=null))):O===4&&(E=r[_+1],P=r[_+2],R=r[_+3],(192&E)==128&&(192&P)==128&&(192&R)==128&&(F=(15&b)<<18|(63&E)<<12|(63&P)<<6|63&R,(F<=65535||F>=1114112)&&(F=null))),F===null?(F=65533,O=1):F>65535&&(F-=65536,m+=String.fromCharCode(F>>>10&1023|55296),F=56320|1023&F),m+=String.fromCharCode(F),_+=O}return m}(this.buf,t,n)}readBytes(){const n=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,n);return this.pos=n,t}readPackedVarint(n=[],t){const r=this.readPackedEnd();for(;this.pos<r;)n.push(this.readVarint(t));return n}readPackedSVarint(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readSVarint());return n}readPackedBoolean(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readBoolean());return n}readPackedFloat(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readFloat());return n}readPackedDouble(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readDouble());return n}readPackedFixed32(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readFixed32());return n}readPackedSFixed32(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readSFixed32());return n}readPackedFixed64(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readFixed64());return n}readPackedSFixed64(n=[]){const t=this.readPackedEnd();for(;this.pos<t;)n.push(this.readSFixed64());return n}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(n){const t=7&n;if(t===0)for(;this.buf[this.pos++]>127;);else if(t===2)this.pos=this.readVarint()+this.pos;else if(t===5)this.pos+=4;else{if(t!==1)throw new Error(`Unimplemented type: ${t}`);this.pos+=8}}writeTag(n,t){this.writeVarint(n<<3|t)}realloc(n){let t=this.length||16;for(;t<this.pos+n;)t*=2;if(t!==this.length){const r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.dataView=new DataView(r.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeSFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*uv),!0),this.pos+=8}writeSFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*uv),!0),this.pos+=8}writeVarint(n){(n=+n||0)>268435455||n<0?function(t,r){let l,u;if(t>=0?(l=t%4294967296|0,u=t/4294967296|0):(l=~(-t%4294967296),u=~(-t/4294967296),4294967295^l?l=l+1|0:(l=0,u=u+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(m,_,b){b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,m>>>=7,b.buf[b.pos++]=127&m|128,b.buf[b.pos]=127&(m>>>=7)}(l,0,r),function(m,_){const b=(7&m)<<4;_.buf[_.pos++]|=b|((m>>>=3)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m|((m>>>=7)?128:0),m&&(_.buf[_.pos++]=127&m)))))}(u,r)}(n,this):(this.realloc(4),this.buf[this.pos++]=127&n|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=n>>>7&127))))}writeSVarint(n){this.writeVarint(n<0?2*-n-1:2*n)}writeBoolean(n){this.writeVarint(+n)}writeString(n){n=String(n),this.realloc(4*n.length),this.pos++;const t=this.pos;this.pos=function(l,u,m){for(let _,b,E=0;E<u.length;E++){if(_=u.charCodeAt(E),_>55295&&_<57344){if(!b){_>56319||E+1===u.length?(l[m++]=239,l[m++]=191,l[m++]=189):b=_;continue}if(_<56320){l[m++]=239,l[m++]=191,l[m++]=189,b=_;continue}_=b-55296<<10|_-56320|65536,b=null}else b&&(l[m++]=239,l[m++]=191,l[m++]=189,b=null);_<128?l[m++]=_:(_<2048?l[m++]=_>>6|192:(_<65536?l[m++]=_>>12|224:(l[m++]=_>>18|240,l[m++]=_>>12&63|128),l[m++]=_>>6&63|128),l[m++]=63&_|128)}return m}(this.buf,n,this.pos);const r=this.pos-t;r>=128&&pv(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r}writeFloat(n){this.realloc(4),this.dataView.setFloat32(this.pos,n,!0),this.pos+=4}writeDouble(n){this.realloc(8),this.dataView.setFloat64(this.pos,n,!0),this.pos+=8}writeBytes(n){const t=n.length;this.writeVarint(t),this.realloc(t);for(let r=0;r<t;r++)this.buf[this.pos++]=n[r]}writeRawMessage(n,t){this.pos++;const r=this.pos;n(t,this);const l=this.pos-r;l>=128&&pv(r,l,this),this.pos=r-1,this.writeVarint(l),this.pos+=l}writeMessage(n,t,r){this.writeTag(n,2),this.writeRawMessage(t,r)}writePackedVarint(n,t){t.length&&this.writeMessage(n,qb,t)}writePackedSVarint(n,t){t.length&&this.writeMessage(n,Zb,t)}writePackedBoolean(n,t){t.length&&this.writeMessage(n,Xb,t)}writePackedFloat(n,t){t.length&&this.writeMessage(n,Hb,t)}writePackedDouble(n,t){t.length&&this.writeMessage(n,Wb,t)}writePackedFixed32(n,t){t.length&&this.writeMessage(n,Yb,t)}writePackedSFixed32(n,t){t.length&&this.writeMessage(n,Jb,t)}writePackedFixed64(n,t){t.length&&this.writeMessage(n,Kb,t)}writePackedSFixed64(n,t){t.length&&this.writeMessage(n,Qb,t)}writeBytesField(n,t){this.writeTag(n,2),this.writeBytes(t)}writeFixed32Field(n,t){this.writeTag(n,5),this.writeFixed32(t)}writeSFixed32Field(n,t){this.writeTag(n,5),this.writeSFixed32(t)}writeFixed64Field(n,t){this.writeTag(n,1),this.writeFixed64(t)}writeSFixed64Field(n,t){this.writeTag(n,1),this.writeSFixed64(t)}writeVarintField(n,t){this.writeTag(n,0),this.writeVarint(t)}writeSVarintField(n,t){this.writeTag(n,0),this.writeSVarint(t)}writeStringField(n,t){this.writeTag(n,2),this.writeString(t)}writeFloatField(n,t){this.writeTag(n,5),this.writeFloat(t)}writeDoubleField(n,t){this.writeTag(n,1),this.writeDouble(t)}writeBooleanField(n,t){this.writeVarintField(n,+t)}};function Qg(n,t,r){return r?4294967296*t+(n>>>0):4294967296*(t>>>0)+(n>>>0)}function pv(n,t,r){const l=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(l);for(let u=r.pos-1;u>=n;u--)r.buf[u+l]=r.buf[u]}function qb(n,t){for(let r=0;r<n.length;r++)t.writeVarint(n[r])}function Zb(n,t){for(let r=0;r<n.length;r++)t.writeSVarint(n[r])}function Hb(n,t){for(let r=0;r<n.length;r++)t.writeFloat(n[r])}function Wb(n,t){for(let r=0;r<n.length;r++)t.writeDouble(n[r])}function Xb(n,t){for(let r=0;r<n.length;r++)t.writeBoolean(n[r])}function Yb(n,t){for(let r=0;r<n.length;r++)t.writeFixed32(n[r])}function Jb(n,t){for(let r=0;r<n.length;r++)t.writeSFixed32(n[r])}function Kb(n,t){for(let r=0;r<n.length;r++)t.writeFixed64(n[r])}function Qb(n,t){for(let r=0;r<n.length;r++)t.writeSFixed64(n[r])}const bx=3;function tw(n,t,r){t.glyphs=[],n===1&&r.readMessage(ew,t)}function ew(n,t,r){if(n===3){const{id:l,bitmap:u,width:m,height:_,left:b,top:E,advance:P}=r.readMessage(iw,{});t.glyphs.push({id:l,bitmap:new Kd({width:m+2*bx,height:_+2*bx},u),metrics:{width:m,height:_,left:b,top:E,advance:P}})}else n===4?t.ascender=r.readSVarint():n===5&&(t.descender=r.readSVarint())}function iw(n,t,r){n===1?t.id=r.readVarint():n===2?t.bitmap=r.readBytes():n===3?t.width=r.readVarint():n===4?t.height=r.readVarint():n===5?t.left=r.readSVarint():n===6?t.top=r.readSVarint():n===7&&(t.advance=r.readVarint())}const fv=bx,bh={horizontal:1,vertical:2,horizontalOnly:3};class cy{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(t,r){const l=new cy;return l.scale=t||1,l.fontStack=r,l}static forImage(t){const r=new cy;return r.image=t,r}}class t_{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,r,l){const u=new t_;for(let m=0;m<t.sections.length;m++){const _=t.sections[m];_.image?u.addImageSection(_,l):u.addTextSection(_,r)}return u}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCodePoint(t){return this.text.codePointAt(t)}verticalizePunctuation(t){this.text=function(r,l){let u="";for(let m=0;m<r.length;m++){const _=r.charCodeAt(m+1)||null,b=r.charCodeAt(m-1)||null;u+=!l&&(_&&qd(_)&&!ly[r[m+1]]||b&&qd(b)&&!ly[r[m-1]])||!ly[r[m]]?r[m]:ly[r[m]]}return u}(this.text,t)}trim(){let t=0;for(let l=0;l<this.text.length&&S0[this.text.charCodeAt(l)];l++)t++;let r=this.text.length;for(let l=this.text.length-1;l>=0&&l>=t&&S0[this.text.charCodeAt(l)];l--)r--;this.text=this.text.substring(t,r),this.sectionIndex=this.sectionIndex.slice(t,r)}substring(t,r){const l=new t_;return l.text=this.text.substring(t,r),l.sectionIndex=this.sectionIndex.slice(t,r),l.sections=this.sections,l}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,r)=>Math.max(t,this.sections[r].scale),0)}addTextSection(t,r){this.text+=t.text,this.sections.push(cy.forText(t.scale,t.fontStack||r));const l=this.sections.length-1;for(let u=0;u<t.text.length;++u)this.sectionIndex.push(l)}addImageSection(t,r){const l=t.image?t.image.getPrimary():null;if(!l)return void Hi("Can't add FormattedSection with an empty image.");l.scaleSelf(r);const u=this.getNextImageSectionCharCode();u?(this.text+=String.fromCodePoint(u),this.sections.push(cy.forImage(l)),this.sectionIndex.push(this.sections.length-1)):Hi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function wx(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y=1){const it=t_.fromFeature(n,u,Y);F===bh.vertical&&it.verticalizePunctuation(O);let at=[];const gt=function(Xt,te,ne,ze,fe,ke){if(!Xt)return[];const Ue=[],Ze=function(Ye,Pe,Ie,He,ai,Ge){let Pi=0;for(let Bi=0;Bi<Ye.length();Bi++){const vi=Ye.getSection(Bi);Pi+=mv(Ye.getCodePoint(Bi),vi,He,ai,Pe,Ge)}return Pi/Math.max(1,Math.ceil(Pi/Ie))}(Xt,te,ne,ze,fe,ke),hi=Xt.text.indexOf("")>=0;let Ke=0;for(let Ye=0;Ye<Xt.length();Ye++){const Pe=Xt.getSection(Ye),Ie=Xt.getCodePoint(Ye);if(S0[Ie]||(Ke+=mv(Ie,Pe,ze,fe,te,ke)),Ye<Xt.length()-1){const He=!((je=Ie)<11904||!(Zi["Bopomofo Extended"](je)||Zi.Bopomofo(je)||Zi["CJK Compatibility Forms"](je)||Zi["CJK Compatibility Ideographs"](je)||Zi["CJK Compatibility"](je)||Zi["CJK Radicals Supplement"](je)||Zi["CJK Strokes"](je)||Zi["CJK Symbols and Punctuation"](je)||Zi["CJK Unified Ideographs Extension A"](je)||Zi["CJK Unified Ideographs"](je)||Zi["Enclosed CJK Letters and Months"](je)||Zi["Halfwidth and Fullwidth Forms"](je)||Zi.Hiragana(je)||Zi["Ideographic Description Characters"](je)||Zi["Kangxi Radicals"](je)||Zi["Katakana Phonetic Extensions"](je)||Zi.Katakana(je)||Zi["Vertical Forms"](je)||Zi["Yi Radicals"](je)||Zi["Yi Syllables"](je)));(rw[Ie]||He||Pe.image)&&Ue.push(_v(Ye+1,Ke,Ze,Ue,nw(Ie,Xt.getCodePoint(Ye+1),He&&hi),!1))}}var je;return yv(_v(Xt.length(),Ke,Ze,Ue,0,!0))}(it,P,m,t,l,$),{processBidirectionalText:yt,processStyledBidirectionalText:At}=S;if(yt&&it.sections.length===1){const Xt=yt(it.toString(),gt);for(const te of Xt){const ne=new t_;ne.text=te,ne.sections=it.sections;for(let ze=0;ze<te.length;ze++)ne.sectionIndex.push(0);at.push(ne)}}else if(At){const Xt=At(it.text,it.sectionIndex,gt);for(const te of Xt){const ne=new t_;ne.text=te[0],ne.sectionIndex=te[1],ne.sections=it.sections,at.push(ne)}}else at=function(Xt,te){const ne=[],ze=Xt.text;let fe=0;for(const ke of te)ne.push(Xt.substring(fe,ke)),fe=ke;return fe<ze.length&&ne.push(Xt.substring(fe,ze.length)),ne}(it,gt);const Gt=[],kt={positionedLines:Gt,text:it.toString(),top:R[1],bottom:R[1],left:R[0],right:R[0],writingMode:F,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(Xt,te,ne,ze,fe,ke,Ue,Ze,hi,Ke,je,Ye){let Pe=0,Ie=0,He=0;const ai=Ze==="right"?1:Ze==="left"?0:.5;let Ge=!1;for(const yi of fe){const Yi=yi.getSections();for(const wr of Yi){if(wr.image)continue;const Vr=te[wr.fontStack];if(Vr&&(Ge=Vr.ascender!==void 0&&Vr.descender!==void 0,!Ge))break}if(!Ge)break}let Pi=0;for(const yi of fe){yi.trim();const Yi=yi.getMaxScale(),wr=(Yi-1)*Wa,Vr={positionedGlyphs:[],lineOffset:0};Xt.positionedLines[Pi]=Vr;const pn=Vr.positionedGlyphs;let Tr=0;if(!yi.length()){Ie+=ke,++Pi;continue}let wn=0,Tn=0;for(let Ft=0;Ft<yi.length();Ft++){const zt=yi.getSection(Ft),Ne=yi.getSectionIndex(Ft),pi=yi.getCodePoint(Ft);let Ve=zt.scale,gi=null,qi=null,ji=null,Cr=Wa,or=0,Ni=hi;Ni===bh.vertical&&((Bi=pi)===12312||Bi===12313||Bi===12316||Bi===12540||Bi===12448)&&(Ni=bh.horizontal);const vn=!(Ni===bh.horizontal||!je&&!Jh(pi)||je&&(S0[pi]||Kh(pi)));if(zt.image){const Yn=ze.get(zt.image.toString());if(!Yn)continue;ji=zt.image,Xt.iconsInText=Xt.iconsInText||!0,qi=Yn.paddedRect;const lr=Yn.displaySize;Ve=Ve*Wa/Ye,gi={width:lr[0],height:lr[1],left:0,top:-fv,advance:vn?lr[1]:lr[0],localGlyph:!1},or=Ge?-gi.height*Ve:Yi*Wa-17-lr[1]*Ve,Cr=gi.advance;const ln=(vn?lr[0]:lr[1])*Ve-Wa*Yi;ln>0&&ln>Tr&&(Tr=ln)}else{const Yn=ne[zt.fontStack];if(!Yn)continue;Yn[pi]&&(qi=Yn[pi]);const lr=te[zt.fontStack];if(!lr)continue;const ln=lr.glyphs[pi];if(!ln)continue;if(gi=ln.metrics,Cr=pi!==8203?Wa:0,Ge){const Jn=lr.ascender!==void 0?Math.abs(lr.ascender):0,Ln=lr.descender!==void 0?Math.abs(lr.descender):0,Jo=(Jn+Ln)*Ve;wn<Jo&&(wn=Jo,Tn=(Jn-Ln)/2*Ve),or=-Jn*Ve}else or=(Yi-Ve)*Wa-17}vn?(Xt.verticalizable=!0,pn.push({glyph:pi,image:ji,x:Pe,y:Ie+or,vertical:vn,scale:Ve,localGlyph:gi.localGlyph,fontStack:zt.fontStack,sectionIndex:Ne,metrics:gi,rect:qi}),Pe+=Cr*Ve+Ke):(pn.push({glyph:pi,image:ji,x:Pe,y:Ie+or,vertical:vn,scale:Ve,localGlyph:gi.localGlyph,fontStack:zt.fontStack,sectionIndex:Ne,metrics:gi,rect:qi}),Pe+=gi.advance*Ve+Ke)}pn.length!==0&&(He=Math.max(Pe-Ke,He),Ge?xv(pn,ai,Tr,Tn,ke*Yi/2):xv(pn,ai,Tr,0,ke/2)),Pe=0;const No=ke*Yi+Tr;Vr.lineOffset=Math.max(Tr,wr),Ie+=No,++Pi}var Bi;const vi=Ie,{horizontalAlign:mi,verticalAlign:_r}=Tx(Ue);(function(yi,Yi,wr,Vr,pn,Tr){const wn=(Yi-wr)*pn,Tn=-Tr*Vr;for(const No of yi)for(const Ft of No.positionedGlyphs)Ft.x+=wn,Ft.y+=Tn})(Xt.positionedLines,ai,mi,_r,He,vi),Xt.top+=-_r*vi,Xt.bottom=Xt.top+vi,Xt.left+=-mi*He,Xt.right=Xt.left+He,Xt.hasBaseline=Ge}(kt,t,r,l,at,_,b,E,F,P,O,q),!function(Xt){for(const te of Xt)if(te.positionedGlyphs.length!==0)return!1;return!0}(Gt))return kt}const S0={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},rw={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function mv(n,t,r,l,u,m){if(t.image){const _=l.get(t.image.toString());return _?_.displaySize[0]*t.scale*Wa/m+u:0}{const _=r[t.fontStack],b=_&&_.glyphs[n];return b?b.metrics.advance*t.scale+u:0}}function gv(n,t,r,l){const u=Math.pow(n-t,2);return l?n<t?u/2:2*u:u+Math.abs(r)*r}function nw(n,t,r){let l=0;return n===10&&(l-=1e4),r&&(l+=150),n!==40&&n!==65288||(l+=50),t!==41&&t!==65289||(l+=50),l}function _v(n,t,r,l,u,m){let _=null,b=gv(t,r,u,m);for(const E of l){const P=gv(t-E.x,r,u,m)+E.badness;P<=b&&(_=E,b=P)}return{index:n,x:t,priorBreak:_,badness:b}}function yv(n){return n?yv(n.priorBreak).concat(n.index):[]}function Tx(n){let t=.5,r=.5;switch(n){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:t,verticalAlign:r}}function xv(n,t,r,l,u){if(!(t||r||l||u))return;const m=n.length-1,_=n[m],b=(_.x+_.metrics.advance*_.scale)*t;for(let E=0;E<=m;E++)n[E].x-=b,n[E].y+=r+l+u}function vv(n){return n.imagePrimary!==void 0&&n.top!==void 0&&n.bottom!==void 0&&n.left!==void 0&&n.right!==void 0}function I0(n,t,r,l){const{horizontalAlign:u,verticalAlign:m}=Tx(l),_=r[0]-n.displaySize[0]*u,b=r[1]-n.displaySize[1]*m;return{imagePrimary:n,imageSecondary:t,top:b,bottom:b+n.displaySize[1],left:_,right:_+n.displaySize[0]}}function Sx(n,t,r,l,u,m){const _=n.imagePrimary;let b;if(_.content){const it=_.content,at=_.pixelRatio||1;b=[it[0]/at,it[1]/at,_.displaySize[0]-it[2]/at,_.displaySize[1]-it[3]/at]}const E=t.left*m,P=t.right*m;let R,F,O,$;r==="width"||r==="both"?($=u[0]+E-l[3],F=u[0]+P+l[1]):($=u[0]+(E+P-_.displaySize[0])/2,F=$+_.displaySize[0]);const q=t.top*m,Y=t.bottom*m;return r==="height"||r==="both"?(R=u[1]+q-l[0],O=u[1]+Y+l[2]):(R=u[1]+(q+Y-_.displaySize[1])/2,O=R+_.displaySize[1]),{imagePrimary:_,imageSecondary:void 0,top:R,right:F,bottom:O,left:$,collisionPadding:b}}function bv(n){return!n.imagePrimary.stretchX}function wv(n){return!n.imagePrimary.stretchY}function Tv(n){return{width:n.right-n.left,height:n.bottom-n.top}}const ap=128;function e_(n,t,r){const{expression:l}=t;if(l.kind==="constant")return{kind:"constant",layoutSize:l.evaluate(new D(n+1,{worldview:r}))};if(l.kind==="source")return{kind:"source"};{const{zoomStops:u,interpolationType:m}=l;let _=0;for(;_<u.length&&u[_]<=n;)_++;_=Math.max(0,_-1);let b=_;for(;b<u.length&&u[b]<n+1;)b++;b=Math.min(u.length-1,b);const E=u[_],P=u[b];return l.kind==="composite"?{kind:"composite",minZoom:E,maxZoom:P,interpolationType:m}:{kind:"camera",minZoom:E,maxZoom:P,minSize:l.evaluate(new D(E,{worldview:r})),maxSize:l.evaluate(new D(P,{worldview:r})),interpolationType:m}}}function Ix(n,{uSize:t,uSizeT:r},{lowerSize:l,upperSize:u}){return n.kind==="source"?l/ap:n.kind==="composite"?Gi(l/ap,u/ap,r):t}function i_(n,t,r=1){let l=0,u=0;if(n.kind==="constant")u=n.layoutSize*r;else if(n.kind!=="source"){const{interpolationType:m,minZoom:_,maxZoom:b}=n,E=m?tt(xl.interpolationFactor(m,t,_,b),0,1):0;n.kind==="camera"?u=Gi(n.minSize,n.maxSize,E)*r:l=E*r}return{uSizeT:l,uSize:u}}class Of extends Ae{constructor(t,r,l,u,m){super(t,r),this.angle=u,this.z=l,m!==void 0&&(this.segment=m)}clone(){return new Of(this.x,this.y,this.z,this.angle,this.segment)}}function Sv(n,t,r,l,u){if(t.segment===void 0)return!0;let m=t,_=t.segment+1,b=0;for(;b>-r/2;){if(_--,_<0)return!1;b-=n[_].dist(m),m=n[_]}b+=n[_].dist(n[_+1]),_++;const E=[];let P=0;for(;b<r/2;){const R=n[_],F=n[_+1];if(!F)return!1;let O=n[_-1].angleTo(R)-R.angleTo(F);for(O=Math.abs((O+3*Math.PI)%(2*Math.PI)-Math.PI),E.push({distance:b,angleDelta:O}),P+=O;b-E[0].distance>l;)P-=E.shift().angleDelta;if(P>u)return!1;_++,b+=R.dist(F)}return!0}function Iv(n){let t=0;for(let r=0;r<n.length-1;r++)t+=n[r].dist(n[r+1]);return t}function Ev(n,t,r){return n?.6*t*r:0}function Av(n,t){return Math.max(n?n.right-n.left:0,t?t.right-t.left:0)}function ow(n,t,r,l,u,m){const _=Ev(r,u,m),b=Av(r,l)*m;let E=0;const P=Iv(n)/2;for(let R=0;R<n.length-1;R++){const F=n[R],O=n[R+1],$=F.dist(O);if(E+$>P){const q=(P-E)/$,Y=Gi(F.x,O.x,q),it=Gi(F.y,O.y,q),at=new Of(Y,it,0,O.angleTo(F),R);return!_||Sv(n,at,b,_,t)?at:void 0}E+=$}}function sw(n,t,r,l,u,m,_,b,E){const P=Ev(l,m,_),R=Av(l,u),F=R*_,O=n[0].x===0||n[0].x===E||n[0].y===0||n[0].y===E;return t-F<t/4&&(t=F+t/4),Pv(n,O?t/2*b%t:(R/2+2*m)*_*b%t,t,P,r,F,O,!1,E)}function Pv(n,t,r,l,u,m,_,b,E){const P=m/2,R=Iv(n);let F=0,O=t-r,$=[];for(let q=0;q<n.length-1;q++){const Y=n[q],it=n[q+1],at=Y.dist(it),gt=it.angleTo(Y);for(;O+r<F+at;){O+=r;const yt=(O-F)/at,At=Gi(Y.x,it.x,yt),Gt=Gi(Y.y,it.y,yt);if(At>=0&&At<E&&Gt>=0&&Gt<E&&O-P>=0&&O+P<=R){const kt=new Of(At,Gt,0,gt,q);l&&!Sv(n,kt,m,l,u)||$.push(kt)}}F+=at}return b||$.length||_||($=Pv(n,F/2,r,l,u,m,_,!0,E)),$}function Mv(n){let t=0,r=0;for(const _ of n)t+=_.w*_.h,r=Math.max(r,_.w);n.sort((_,b)=>b.h-_.h);const l=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),r),h:1/0}];let u=0,m=0;for(const _ of n)for(let b=l.length-1;b>=0;b--){const E=l[b];if(!(_.w>E.w||_.h>E.h)){if(_.x=E.x,_.y=E.y,m=Math.max(m,_.y+_.h),u=Math.max(u,_.x+_.w),_.w===E.w&&_.h===E.h){const P=l.pop();P&&b<l.length&&(l[b]=P)}else _.h===E.h?(E.x+=_.w,E.w-=_.w):_.w===E.w?(E.y+=_.h,E.h-=_.h):(l.push({x:E.x+_.w,y:E.y,w:E.w-_.w,h:_.h}),E.y+=_.h,E.h-=_.h);break}}return{w:u,h:m,fill:t/(u*m)||0}}Ei(Of,"Anchor");const ag=1;class hy{static getImagePositionScale(t,r,l){if(r&&t&&t.options&&t.options.transform){const u=t.options.transform;return{x:u.a,y:u.d}}return{x:l,y:l}}constructor(t,r,l,u){this.paddedRect=t;const{pixelRatio:m,version:_,stretchX:b,stretchY:E,content:P,sdf:R,usvg:F}=r;this.pixelRatio=m,this.stretchX=b,this.stretchY=E,this.content=P,this.version=_,this.padding=l,this.sdf=R,this.usvg=F,this.scale=hy.getImagePositionScale(u,F,m)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function Ex(n,t,r){const l=gl.parse(n),u=function(m,_,b=[1,1]){return{x:0,y:0,w:(m.data?m.data.width:m.width*b[0])+2*_,h:(m.data?m.data.height:m.height*b[1])+2*_}}(t,r,[l.options.transform.a,l.options.transform.d]);return{bin:u,imagePosition:new hy(u,t,r,l),imageVariant:l}}class Cv{constructor(t,r,l){const u=new Map,m=new Map;this.haveRenderCallbacks=[];const _=[];this.addImages(t,u,ag,_),this.addImages(r,m,2,_);const{w:b,h:E}=Mv(_),P=new Ma({width:b||1,height:E||1});for(const[R,F]of t.entries()){const O=u.get(R).paddedRect;Ma.copy(F.data,P,{x:0,y:0},{x:O.x+ag,y:O.y+ag},F.data,null,F.sdf)}for(const[R,F]of r.entries()){const O=m.get(R),$=O.paddedRect;let q=O.padding;const Y=$.x+q,it=$.y+q,at=F.data.width,gt=F.data.height;q=q>1?q-1:q,Ma.copy(F.data,P,{x:0,y:0},{x:Y,y:it},F.data,l),Ma.copy(F.data,P,{x:0,y:gt-q},{x:Y,y:it-q},{width:at,height:q},l),Ma.copy(F.data,P,{x:0,y:0},{x:Y,y:it+gt},{width:at,height:q},l),Ma.copy(F.data,P,{x:at-q,y:0},{x:Y-q,y:it},{width:q,height:gt},l),Ma.copy(F.data,P,{x:0,y:0},{x:Y+at,y:it},{width:q,height:gt},l),Ma.copy(F.data,P,{x:at-q,y:gt-q},{x:Y-q,y:it-q},{width:q,height:q},l),Ma.copy(F.data,P,{x:0,y:gt-q},{x:Y+at,y:it-q},{width:q,height:q},l),Ma.copy(F.data,P,{x:0,y:0},{x:Y+at,y:it+gt},{width:q,height:q},l),Ma.copy(F.data,P,{x:at-q,y:0},{x:Y-q,y:it+gt},{width:q,height:q},l)}this.lut=l,this.image=P,this.iconPositions=u,this.patternPositions=m}addImages(t,r,l,u){for(const[m,_]of t.entries()){const{bin:b,imagePosition:E,imageVariant:P}=Ex(m,_,l);r.set(m,E),u.push(b),_.hasRenderCallback&&this.haveRenderCallbacks.push(P.id)}}patchUpdatedImages(t,r,l){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(u=>t.hasImage(u,l)),t.dispatchRenderCallbacks(this.haveRenderCallbacks,l);for(const u of t.getUpdatedImages(l)){for(const m of this.iconPositions.keys()){const _=gl.parse(m);if(es.isEqual(_.id,u)){const b=t.getImage(u,l);this.patchUpdatedImage(this.iconPositions.get(m),b,r,null)}}for(const m of this.patternPositions.keys()){const _=gl.parse(m);if(es.isEqual(_.id,u)){const b=t.getImage(u,l);this.patchUpdatedImage(this.patternPositions.get(m),b,r,this.lut)}}}}patchUpdatedImage(t,r,l,u=null){if(!t||!r||t.version===r.version)return;t.version=r.version;const[m,_]=t.tl,b=t.sdf;if(this.lut||b){const E={width:r.data.width,height:r.data.height},P=new Ma(E);Ma.copy(r.data,P,{x:0,y:0},{x:0,y:0},E,u,b),l.update(P,{position:{x:m,y:_}})}else l.update(r.data,{position:{x:m,y:_}})}}Ei(hy,"ImagePosition"),Ei(Cv,"ImageAtlas");const uy=1e20;function Dv(n,t,r,l,u,m,_,b,E){for(let P=t;P<t+l;P++)zv(n,r*m+P,m,u,_,b,E);for(let P=r;P<r+u;P++)zv(n,P*m+t,1,l,_,b,E)}function zv(n,t,r,l,u,m,_){m[0]=0,_[0]=-uy,_[1]=uy,u[0]=n[t];for(let b=1,E=0,P=0;b<l;b++){u[b]=n[t+b*r];const R=b*b;do{const F=m[E];P=(u[b]-u[F]+R-F*F)/(b-F)/2}while(P<=_[E]&&--E>-1);E++,m[E]=b,_[E]=P,_[E+1]=uy}for(let b=0,E=0;b<l;b++){for(;_[E+1]<b;)E++;const P=m[E],R=b-P;n[t+b*r]=u[P]+R*R}}const lp=2,Ax={none:0,ideographs:1,all:2};class r_{constructor(t,r,l){this.requestManager=t,this.localGlyphMode=r,this.localFontFamily=l,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t){this.url=t}getGlyphs(t,r){const l=[],u=this.url||eo.GLYPHS_URL;for(const m in t)for(const _ of t[m])l.push({stack:m,id:_});Ht(l,({stack:m,id:_},b)=>{let E=this.entries[m];E||(E=this.entries[m]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let P=E.glyphs[_];if(P!==void 0)return void b(null,{stack:m,id:_,glyph:P});if(P=this._tinySDF(E,m,_),P)return E.glyphs[_]=P,void b(null,{stack:m,id:_,glyph:P});const R=Math.floor(_/256);if(256*R>65535)return Hi("glyphs > 65535 not supported"),void b(null,{stack:m,id:_,glyph:P});if(E.ranges[R])return void b(null,{stack:m,id:_,glyph:P});let F=E.requests[R];F||(F=E.requests[R]=[],r_.loadGlyphRange(m,R,u,this.requestManager,(O,$)=>{if($){E.ascender=$.ascender,E.descender=$.descender;for(const q in $.glyphs)this._doesCharSupportLocalGlyph(+q)||(E.glyphs[+q]=$.glyphs[+q]);E.ranges[R]=!0}for(const q of F)q(O,$);delete E.requests[R]})),F.push((O,$)=>{O?b(O):$&&b(null,{stack:m,id:_,glyph:$.glyphs[_]||null})})},(m,_)=>{if(m)r(m);else if(_){const b={};for(const{stack:E,id:P,glyph:R}of _)b[E]===void 0&&(b[E]={}),b[E].glyphs===void 0&&(b[E].glyphs={}),b[E].glyphs[P]=R&&{id:R.id,bitmap:R.bitmap.clone(),metrics:R.metrics},b[E].ascender=this.entries[E].ascender,b[E].descender=this.entries[E].descender;r(null,b)}})}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==Ax.none&&(this.localGlyphMode===Ax.all?!!this.localFontFamily:!!this.localFontFamily&&(Zi["CJK Unified Ideographs"](t)||Zi["Hangul Syllables"](t)||Zi.Hiragana(t)||Zi.Katakana(t)||Zi["CJK Symbols and Punctuation"](t)||Zi["CJK Unified Ideographs Extension A"](t)||Zi["CJK Unified Ideographs Extension B"](t)||Zi.Osage(t)))}_tinySDF(t,r,l){const u=this.localFontFamily;if(!u||!this._doesCharSupportLocalGlyph(l))return;let m=t.tinySDF;if(!m){let Y="400";/bold/i.test(r)?Y="900":/medium/i.test(r)?Y="500":/light/i.test(r)&&(Y="200"),m=t.tinySDF=new r_.TinySDF({fontFamily:u,fontWeight:Y,fontSize:24*lp,buffer:3*lp,radius:8*lp}),m.fontWeight=Y}if(this.localGlyphs[m.fontWeight][l])return this.localGlyphs[m.fontWeight][l];const _=String.fromCodePoint(l),{data:b,width:E,height:P,glyphWidth:R,glyphHeight:F,glyphLeft:O,glyphTop:$,glyphAdvance:q}=m.draw(_);return this.localGlyphs[m.fontWeight][l]={id:l,bitmap:new Kd({width:E,height:P},b),metrics:{width:R/lp,height:F/lp,left:O/lp,top:$/lp-27,advance:q/lp,localGlyph:!0}}}}r_.loadGlyphRange=function(n,t,r,l,u){const m=256*t,_=m+255,b=l.transformRequest(l.normalizeGlyphsURL(r).replace("{fontstack}",n).replace("{range}",`${m}-${_}`),Ds.Glyphs);Ll(b,(E,P)=>{if(E)u(E);else if(P){const R={},F=function(O){return new T0(O).readFields(tw,{})}(P);for(const O of F.glyphs)R[O.id]=O;u(null,{glyphs:R,ascender:F.ascender,descender:F.descender})}})},r_.TinySDF=class{constructor({fontSize:n=24,buffer:t=3,radius:r=8,cutoff:l=.25,fontFamily:u="sans-serif",fontWeight:m="normal",fontStyle:_="normal",lang:b=null}={}){this.buffer=t,this.cutoff=l,this.radius=r,this.lang=b;const E=this.size=n+4*t,P=this._createCanvas(E),R=this.ctx=P.getContext("2d",{willReadFrequently:!0});R.font=`${_} ${m} ${n}px ${u}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(E*E),this.gridInner=new Float64Array(E*E),this.f=new Float64Array(E),this.z=new Float64Array(E+1),this.v=new Uint16Array(E)}_createCanvas(n){const t=document.createElement("canvas");return t.width=t.height=n,t}draw(n){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:l,actualBoundingBoxLeft:u,actualBoundingBoxRight:m}=this.ctx.measureText(n),_=Math.ceil(r),b=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(m-u))),E=Math.min(this.size-this.buffer,_+Math.ceil(l)),P=b+2*this.buffer,R=E+2*this.buffer,F=Math.max(P*R,0),O=new Uint8ClampedArray(F),$={data:O,width:P,height:R,glyphWidth:b,glyphHeight:E,glyphTop:_,glyphLeft:0,glyphAdvance:t};if(b===0||E===0)return $;const{ctx:q,buffer:Y,gridInner:it,gridOuter:at}=this;this.lang&&(q.lang=this.lang),q.clearRect(Y,Y,b,E),q.fillText(n,Y,Y+_);const gt=q.getImageData(Y,Y,b,E);at.fill(uy,0,F),it.fill(0,0,F);for(let yt=0;yt<E;yt++)for(let At=0;At<b;At++){const Gt=gt.data[4*(yt*b+At)+3]/255;if(Gt===0)continue;const kt=(yt+Y)*P+At+Y;if(Gt===1)at[kt]=0,it[kt]=uy;else{const Xt=.5-Gt;at[kt]=Xt>0?Xt*Xt:0,it[kt]=Xt<0?Xt*Xt:0}}Dv(at,0,0,P,R,P,this.f,this.v,this.z),Dv(it,Y,Y,b,E,P,this.f,this.v,this.z);for(let yt=0;yt<F;yt++){const At=Math.sqrt(at[yt])-Math.sqrt(it[yt]);O[yt]=Math.round(255-255*(At/this.radius+this.cutoff))}return $}};const ef=ag;function Lv(n,t){return n+t[1]-t[0]}function Px(n,t,r,l,u=1){const m=[],_=n.imagePrimary,b=_.pixelRatio,E=_.paddedRect.w-2*ef,P=_.paddedRect.h-2*ef,R=(n.right-n.left)*u,F=(n.bottom-n.top)*u,O=_.stretchX||[[0,E]],$=_.stretchY||[[0,P]],q=O.reduce(Lv,0),Y=$.reduce(Lv,0),it=E-q,at=P-Y;let gt=0,yt=q,At=0,Gt=Y,kt=0,Xt=it,te=0,ne=at;if(_.content&&l){const fe=_.content;gt=E0(O,0,fe[0]),At=E0($,0,fe[1]),yt=E0(O,fe[0],fe[2]),Gt=E0($,fe[1],fe[3]),kt=fe[0]-gt,te=fe[1]-At,Xt=fe[2]-fe[0]-yt,ne=fe[3]-fe[1]-Gt}const ze=(fe,ke,Ue,Ze)=>{const hi=A0(fe.stretch-gt,yt,R,n.left*u),Ke=P0(fe.fixed-kt,Xt,fe.stretch,q),je=A0(ke.stretch-At,Gt,F,n.top*u),Ye=P0(ke.fixed-te,ne,ke.stretch,Y),Pe=A0(Ue.stretch-gt,yt,R,n.left*u),Ie=P0(Ue.fixed-kt,Xt,Ue.stretch,q),He=A0(Ze.stretch-At,Gt,F,n.top*u),ai=P0(Ze.fixed-te,ne,Ze.stretch,Y),Ge=new Ae(hi,je),Pi=new Ae(Pe,je),Bi=new Ae(Pe,He),vi=new Ae(hi,He),mi=new Ae(Ke/b,Ye/b),_r=new Ae(Ie/b,ai/b),yi=t*Math.PI/180;if(yi){const wn=Math.sin(yi),Tn=Math.cos(yi),No=[Tn,-wn,wn,Tn];Ge._matMult(No),Pi._matMult(No),vi._matMult(No),Bi._matMult(No)}const Yi=fe.stretch+fe.fixed,wr=Ue.stretch+Ue.fixed,Vr=ke.stretch+ke.fixed,pn=Ze.stretch+Ze.fixed,Tr=n.imageSecondary;return{tl:Ge,tr:Pi,bl:vi,br:Bi,texPrimary:{x:_.paddedRect.x+ef+Yi,y:_.paddedRect.y+ef+Vr,w:wr-Yi,h:pn-Vr},texSecondary:Tr?{x:Tr.paddedRect.x+ef+Yi,y:Tr.paddedRect.y+ef+Vr,w:wr-Yi,h:pn-Vr}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:mi,pixelOffsetBR:_r,minFontScaleX:Xt/b/R,minFontScaleY:ne/b/F,isSDF:r}};if(l&&(_.stretchX||_.stretchY)){const fe=Rv(O,it,q),ke=Rv($,at,Y);for(let Ue=0;Ue<fe.length-1;Ue++){const Ze=fe[Ue],hi=fe[Ue+1];for(let Ke=0;Ke<ke.length-1;Ke++)m.push(ze(Ze,ke[Ke],hi,ke[Ke+1]))}}else m.push(ze({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:E+1},{fixed:0,stretch:P+1}));return m}function aw(n,t){const r=n.stretchY||[[0,n.paddedRect.h-2*ef]];return t&&(n.stretchX||n.stretchY)?kv(n.stretchX||[[0,n.paddedRect.w-2*ef]])*kv(r):1}function E0(n,t,r){let l=0;for(const u of n)l+=Math.max(t,Math.min(r,u[1]))-Math.max(t,Math.min(r,u[0]));return l}function Rv(n,t,r){const l=[{fixed:-ef,stretch:0}];for(const[u,m]of n){const _=l[l.length-1];l.push({fixed:u-_.stretch,stretch:_.stretch}),l.push({fixed:u-_.stretch,stretch:_.stretch+(m-u)})}return l.push({fixed:t+ef,stretch:r}),l}function kv(n){return 2*n.length+1}function A0(n,t,r,l){return n/t*r+l}function P0(n,t,r,l){return n-t*r/l}function lw(n,t,r,l){const u=t+n.positionedLines[l].lineOffset;return l===0?r+u/2:r+(u+(t+n.positionedLines[l-1].lineOffset))/2}function cw(n,t=1,r=!1){let l=1/0,u=1/0,m=-1/0,_=-1/0;const b=n[0];for(let $=0;$<b.length;$++){const q=b[$];(!$||q.x<l)&&(l=q.x),(!$||q.y<u)&&(u=q.y),(!$||q.x>m)&&(m=q.x),(!$||q.y>_)&&(_=q.y)}const E=Math.min(m-l,_-u);let P=E/2;const R=new Cd([],hw);if(E===0)return new Ae(l,u);for(let $=l;$<m;$+=E)for(let q=u;q<_;q+=E)R.push(new n_($+P,q+P,P,n));let F=function($){let q=0,Y=0,it=0;const at=$[0];for(let gt=0,yt=at.length,At=yt-1;gt<yt;At=gt++){const Gt=at[gt],kt=at[At],Xt=Gt.x*kt.y-kt.x*Gt.y;Y+=(Gt.x+kt.x)*Xt,it+=(Gt.y+kt.y)*Xt,q+=3*Xt}return new n_(Y/q,it/q,0,$)}(n),O=R.length;for(;R.length;){const $=R.pop();($.d>F.d||!F.d)&&(F=$,r&&console.log("found best %d after %d probes",Math.round(1e4*$.d)/1e4,O)),$.max-F.d<=t||(P=$.h/2,R.push(new n_($.p.x-P,$.p.y-P,P,n)),R.push(new n_($.p.x+P,$.p.y-P,P,n)),R.push(new n_($.p.x-P,$.p.y+P,P,n)),R.push(new n_($.p.x+P,$.p.y+P,P,n)),O+=4)}return r&&(console.log(`num probes: ${O}`),console.log(`best distance: ${F.d}`)),F.p}function hw(n,t){return t.max-n.max}class n_{constructor(t,r,l,u){this.p=new Ae(t,r),this.h=l,this.d=function(m,_){let b=!1,E=1/0;for(let P=0;P<_.length;P++){const R=_[P];for(let F=0,O=R.length,$=O-1;F<O;$=F++){const q=R[F],Y=R[$];q.y>m.y!=Y.y>m.y&&m.x<(Y.x-q.x)*(m.y-q.y)/(Y.y-q.y)+q.x&&(b=!b),E=Math.min(E,vc(m,q,Y))}}return(b?1:-1)*Math.sqrt(E)}(this.p,u),this.max=this.d+this.h*Math.SQRT2}}const uw=Object.keys,Mx=Number.POSITIVE_INFINITY,dw=Math.sqrt(2);function M0(n,t,r,l){const u=n.collisionPadding||[0,0,0,0],m={top:n.top-u[1],bottom:n.bottom+u[3],left:n.left-u[0],right:n.right+u[2],scaled:!1};return l!==void 0&&function(_,b){_.top*=b,_.bottom*=b,_.left*=b,_.right*=b,_.scaled=!0}(m,l),r&&function(_,b){if(!b)return;const E=ar(b),P=new Ae(_.left,_.top),R=new Ae(_.right,_.top),F=new Ae(_.left,_.bottom),O=new Ae(_.right,_.bottom);P._rotateAround(E,new Ae(0,0)),R._rotateAround(E,new Ae(0,0)),F._rotateAround(E,new Ae(0,0)),O._rotateAround(E,new Ae(0,0)),_.left=Math.min(P.x,R.x,F.x,O.x),_.right=Math.max(P.x,R.x,F.x,O.x),_.top=Math.min(P.y,R.y,F.y,O.y),_.bottom=Math.max(P.y,R.y,F.y,O.y)}(m,r),t?{top:Math.min(t.top,m.top),bottom:Math.max(t.bottom,m.bottom),left:Math.min(t.left,m.left),right:Math.max(t.right,m.right),scaled:t.scaled||m.scaled}:m}function Fv(n,[t,r]){let l=0,u=0;if(r===Mx){t<0&&(t=0);const m=t/dw;switch(n){case"top-right":case"top-left":u=m-7;break;case"bottom-right":case"bottom-left":u=7-m;break;case"bottom":u=7-t;break;case"top":u=t-7}switch(n){case"top-right":case"bottom-right":l=-m;break;case"top-left":case"bottom-left":l=m;break;case"left":l=t;break;case"right":l=-t}}else{switch(t=Math.abs(t),r=Math.abs(r),n){case"top-right":case"top-left":case"top":u=r-7;break;case"bottom-right":case"bottom-left":case"bottom":u=7-r}switch(n){case"top-right":case"bottom-right":case"right":l=-t;break;case"top-left":case"bottom-left":case"left":l=t}}return[l,u]}function pw(n,t,r,l,u,m,_,b,E,P,R){const F=n.layers[0],O=F.appearances;if(O.length===0)return{iconBBox:null,iconVerticalBBox:null};let $=null,q=null;const Y=l.get("icon-rotate").evaluate(u,{},m);t&&($=M0(t,$,Y,_),r)&&(q=M0(r,q,Y+90,_));const[it,at]=l.get("icon-size-scale-range"),gt=tt(1,it,at);for(const yt of O){const At=yt.getUnevaluatedProperties(),Gt=At._values["icon-image"].value!==void 0,kt=At._values["icon-size"].value!==void 0,Xt=At._values["icon-offset"].value!==void 0,te=At._values["icon-rotate"].value!==void 0;if(Gt||kt||Xt||te){const ne=Xt?F.getAppearanceValueAndResolveTokens(yt,"icon-offset",u,m,[]):null,ze=ne&&Array.isArray(ne)?ne:b,fe=te?F.getAppearanceValueAndResolveTokens(yt,"icon-rotate",u,m,[]):null,ke=typeof fe=="number"?fe:Y,Ue=kt?F.getAppearanceValueAndResolveTokens(yt,"icon-size",u,m,[]):null,Ze=typeof Ue=="number"?Ue*E.iconScaleFactor:_;let hi=null,Ke=null,je=null;if(Gt){const Ye=F.getAppearanceValueAndResolveTokens(yt,"icon-image",u,m,[]);if(Ye){const Pe=n.getResolvedImageFromTokens(Ye),Ie=At._values["icon-size"],He=dy(Pe,e_(n.zoom,Ie,n.worldview),Ie,m,n.zoom,u,n.pixelRatio,gt,n.worldview);je=P.get(He.iconPrimary.toString())}}else t&&(je=t.imagePrimary);je&&(hi=I0(je,null,ze,R),n.allowVerticalPlacement&&(Ke=I0(je,null,ze,R))),hi&&($=M0(hi,$,ke,Ze)),Ke&&(q=M0(Ke,q,ke+90,Ze))}}return{iconBBox:$,iconVerticalBBox:q}}function C0(n,t,r,l,u,m,_,b,E){if(!t||!t.usvg)return;const P=Tv(l),R=Tv(u),F=m!=="both"&&m!=="width"||!bv(l)?1:R.width/P.width,O=m!=="both"&&m!=="height"||!wv(l)?1:R.height/P.height;r.scaleSelf(F,O);const $=r.toString();_.set($,r),b.set($,t);const{imagePosition:q}=Ex($,t,ag);E.set($,q)}function Bv(n,t,r,l,u,m,_,b,E){if(!n)return;const P=function(R,F,O,$,q,Y){if(R.kind==="camera")return R.maxSize;if(R.kind==="composite"){const it=F.possiblyEvaluate(new D(R.maxZoom,{worldview:Y}),O).evaluate(q,{},O),at=F.possiblyEvaluate(new D(R.minZoom,{worldview:Y}),O).evaluate(q,{},O);return Math.max(it,at)}return F.possiblyEvaluate(new D($,{worldview:Y})).evaluate(q,{},O)}(t,r,l,u,m,E);return n.scaleSelf(P*b*_)}function dy(n,t,r,l,u,m,_,b,E){return{iconPrimary:Bv(n.getPrimary(),t,r,l,u,m,_,b,E),iconSecondary:Bv(n.getSecondary(),t,r,l,u,m,_,b,E)}}function fw(n,t,r){if(!t)return;const l=r.get(n.toString()),u=r.get(t.toString());l&&u&&(l.paddedRect.w===u.paddedRect.w&&l.paddedRect.h===u.paddedRect.h||Hi(`Mismatch in icon variant sizes: ${n.toString()} and ${t.toString()}`),l.usvg!==u.usvg&&Hi(`Mismatch in icon variant image types: ${n.id} and ${t.id}`))}function Ov(n,t,r,l){if(!n)return;const u=t.get(r.toString());if(n.imagePrimary=u,l){const m=t.get(l.toString());n.imageSecondary=m}}function mw(n,t){for(const r in n.horizontal)Nv(n.horizontal[r],t);Nv(n.vertical,t)}function Nv(n,t){if(n){for(const r of n.positionedLines)for(const l of r.positionedGlyphs)if(l.image!==null){const u=l.image.toString();l.rect=t.get(u).paddedRect}}}function Cx(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function gw(n,t,r,l,u,m,_,b,E){const P=Dx(m.horizontal)||m.vertical,R=r.get("icon-text-fit-padding").evaluate(l,{},u);let F,O=t;return t&&E!=="none"&&(n.allowVerticalPlacement&&m.vertical&&(F=Sx(t,m.vertical,E,R,b,_)),P&&(O=Sx(t,P,E,R,b,_))),{defaultShapedIcon:O,verticallyShapedIcon:F}}function _w(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt,yt,At,Gt){let kt=_.textMaxSize.evaluate(t,{},O);kt===void 0?kt=b*_.textScaleFactor:kt*=_.textScaleFactor;const Xt=n.layers[0].layout,te=Wa,ne=b*_.textScaleFactor/te,ze=Dx(r.horizontal)||r.vertical;if(it!=="none"&&n.appearanceFeatureData&&t.index<n.appearanceFeatureData.length){const Ge=n.appearanceFeatureData[t.index];Ge&&(Ge.textShaping=ze,Ge.iconTextFitPadding=Xt.get("icon-text-fit-padding").evaluate(t,{},O),Ge.fontScale=ne)}const fe=$.name==="globe",ke=n.tilePixelRatio*kt/te,Ue=(Pe=n.overscaling,n.zoom>18&&Pe>2&&(Pe>>=1),Math.max(ri/(512*Pe),1)*Xt.get("symbol-spacing")),Ze=Xt.get("text-padding")*n.tilePixelRatio,hi=Xt.get("icon-padding")*n.tilePixelRatio,Ke=ar(Xt.get("text-max-angle")),je=Xt.get("icon-rotation-alignment")==="map"&&yt!=="point",Ye=Ue/2;var Pe;n.hasAnyIconTextFit===!1&&it!=="none"&&(n.hasAnyIconTextFit=!0);const Ie=t.properties?+t.properties[xi]:null,He=Ie&&n.elevationFeatureIdToIndex?n.elevationFeatureIdToIndex.get(Ie):65535,ai=(Ge,Pi,Bi)=>{if(Pi.x<0||Pi.x>=ri||Pi.y<0||Pi.y>=ri)return;let vi=null;if(fe){const{x:mi,y:_r,z:yi}=$.projectTilePoint(Pi.x,Pi.y,Bi);vi={anchor:new Of(mi,_r,yi,0,void 0),up:$.upVector(Bi,Pi.x,Pi.y)}}(function(mi,_r,yi,Yi,wr,Vr,pn,Tr,wn,Tn,No,Ft,zt,Ne,pi,Ve,gi,qi,ji,Cr,or,Ni,vn,Yn,lr,ln,Jn,Ln,Jo,Eo,_o){const Gn=mi.addToLineVertexArray(_r,Yi);let Sn,Dr,In,yo,sr,fn,Ao,is=0,us=0,Xs=0,Po=0,Fs=-1,Wc=-1;const Bs={};let wh=tl("");const Al=yi?yi.anchor:_r,Fu=Ln!=="none";let Xc=0,Th=0;if(wn._unevaluatedLayout.getValue("text-radial-offset")===void 0){const Xa=wn.layout.get("text-offset").evaluate(or,{},lr);Xc=Xa[0]*Wa,Th=Xa[1]*Wa}else Xc=wn.layout.get("text-radial-offset").evaluate(or,{},lr)*Wa,Th=Mx;if(mi.allowVerticalPlacement&&wr.vertical){const Xa=wr.vertical;if(pi)fn=zx(Xa),Tr&&(Ao=zx(Tr));else{const nc=wn.layout.get("text-rotate").evaluate(or,{},lr)+90;In=D0(Tn,Al,_r,No,Ft,zt,Xa,Ne,nc,Ve),Tr&&(yo=D0(Tn,Al,_r,No,Ft,zt,Tr,qi,nc,null,_o))}}if(Vr){const Xa=mi.iconSizeData,nc=wn.layout.get("icon-rotate").evaluate(or,{},lr),rf=Px(Vr,nc,vn,Fu,Ni.iconScaleFactor),Sm=Tr?Px(Tr,nc,vn,Fu,Ni.iconScaleFactor):void 0;Dr=D0(Tn,Al,_r,No,Ft,zt,Vr,qi,nc,null,Eo);const u_=function(nf,W0,d_,CT,nb,ob,DT,zT){const sb=nf.layers[0],ab=sb.appearances;let p_=W0.length;if(d_&&(p_=Math.max(p_,d_.length)),ab.length===0)return p_;const[LT,RT]=CT.get("icon-size-scale-range"),kT=tt(1,LT,RT);for(const lb of ab){const cb=lb.getUnevaluatedProperties();if(cb._values["icon-image"].value!==void 0){const hb=sb.getAppearanceValueAndResolveTokens(lb,"icon-image",nb,ob,[]);if(hb){const ub=nf.getResolvedImageFromTokens(hb);if(ub){const db=cb._values["icon-size"],FT=dy(ub,e_(nf.zoom,db,nf.worldview),db,ob,nf.zoom,nb,nf.pixelRatio,kT,nf.worldview),BT=DT.get(FT.iconPrimary.toString());p_=Math.max(p_,aw(BT,zT))}}}}return p_}(mi,rf,Sm,wn.layout,or,lr,mi.iconAtlasPositions,Fu);is=4*u_;let Im=null;Xa.kind==="source"?(Im=[ap*wn.layout.get("icon-size").evaluate(or,{},lr)*Ni.iconScaleFactor],Im[0]>Nf&&Hi(`${mi.layerIds[0]}: Value for "icon-size" is >= ${py}. Reduce your "icon-size".`)):Xa.kind==="composite"&&(Im=[ap*Ni.compositeIconSizes[0].evaluate(or,{},lr)*Ni.iconScaleFactor,ap*Ni.compositeIconSizes[1].evaluate(or,{},lr)*Ni.iconScaleFactor],(Im[0]>Nf||Im[1]>Nf)&&Hi(`${mi.layerIds[0]}: Value for "icon-size" is >= ${py}. Reduce your "icon-size".`)),mi.addSymbols(mi.icon,rf,Im,Cr,ji,or,void 0,yi,_r,Gn.lineStartIndex,Gn.lineLength,-1,Yn,lr,ln,Jn,mi.symbolInstances.length,u_),Fs=mi.icon.placedSymbolArray.length-1,Sm&&(us=4*u_,mi.addSymbols(mi.icon,Sm,Im,Cr,ji,or,bh.vertical,yi,_r,Gn.lineStartIndex,Gn.lineLength,-1,Yn,lr,ln,Jn,mi.symbolInstances.length,u_),Wc=mi.icon.placedSymbolArray.length-1)}for(const Xa in wr.horizontal){const nc=Xa,rf=wr.horizontal[nc];Sn||(wh=tl(rf.text),pi?sr=zx(rf):Sn=D0(Tn,Al,_r,No,Ft,zt,rf,Ne,wn.layout.get("text-rotate").evaluate(or,{},lr),Ve));const Sm=rf.positionedLines.length===1;if(Xs+=Vv(mi,yi,_r,rf,pn,wn,pi,or,Ve,Gn,wr.vertical?bh.horizontal:bh.horizontalOnly,Sm?uw(wr.horizontal):[nc],Bs,Fs,Ni,Yn,lr,mi.symbolInstances.length,ln),Sm)break}wr.vertical&&(Po+=Vv(mi,yi,_r,wr.vertical,pn,wn,pi,or,Ve,Gn,bh.vertical,["vertical"],Bs,Wc,Ni,Yn,lr,mi.symbolInstances.length,ln));let Pl=-1;const Sh=(Xa,nc)=>Xa?Math.max(Xa,nc):nc;Pl=Sh(sr,Pl),Pl=Sh(fn,Pl),Pl=Sh(Ao,Pl);const Bu=Pl>-1?1:0;mi.glyphOffsetArray.length>=65535&&Hi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),or.sortKey!==void 0&&mi.addToSortKeyRanges(mi.symbolInstances.length,or.sortKey),mi.symbolInstances.emplaceBack(_r.x,_r.y,Al.x,Al.y,Al.z,Bs.right>=0?Bs.right:-1,Bs.center>=0?Bs.center:-1,Bs.left>=0?Bs.left:-1,Bs.vertical>=0?Bs.vertical:-1,Fs,Wc,wh,Sn!==void 0?Sn:mi.collisionBoxArray.length,Sn!==void 0?Sn+1:mi.collisionBoxArray.length,In!==void 0?In:mi.collisionBoxArray.length,In!==void 0?In+1:mi.collisionBoxArray.length,Dr!==void 0?Dr:mi.collisionBoxArray.length,Dr!==void 0?Dr+1:mi.collisionBoxArray.length,yo||mi.collisionBoxArray.length,yo?yo+1:mi.collisionBoxArray.length,No,Xs,Po,is,us,Bu,0,Xc,Th,Pl,0,Fu?1:0,Jo)})(n,Pi,vi,Ge,r,l,m,u,n.layers[0],n.collisionBoxArray,t.index,t.sourceLayerIndex,n.index,Ze,gt,P,0,hi,je,at,t,_,R,F,O,q,Y,it,He,At,Gt)};if(yt==="line")for(const Ge of Zg(t.geometry,0,0,ri,ri)){const Pi=sw(Ge,Ue,Ke,r.vertical||ze,l,te,ke,n.overscaling,ri);for(const Bi of Pi)ze&&yw(n,ze.text,Ye,Bi)||ai(Ge,Bi,O)}else if(yt==="line-center"){for(const Ge of t.geometry)if(Ge.length>1){const Pi=ow(Ge,Ke,r.vertical||ze,l,te,ke);Pi&&ai(Ge,Pi,O)}}else if(t.type==="Polygon")for(const Ge of cm(t.geometry,0)){const Pi=cw(Ge,16);ai(Ge[0],new Of(Pi.x,Pi.y,0,0,void 0),O)}else if(t.type==="LineString")for(const Ge of t.geometry)ai(Ge,new Of(Ge[0].x,Ge[0].y,0,0,void 0),O);else if(t.type==="Point")for(const Ge of t.geometry)for(const Pi of Ge)ai([Pi],new Of(Pi.x,Pi.y,0,0,void 0),O)}const py=255,Nf=py*ap;function Vv(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt){const yt=function(kt,Xt,te,ne,ze,fe,ke,Ue){const Ze=[];if(Xt.positionedLines.length===0)return Ze;const hi=ne.layout.get("text-rotate").evaluate(fe,{})*Math.PI/180,Ke=function(He){const ai=He[0],Ge=He[1],Pi=ai*Ge;return Pi>0?[ai,-Ge]:Pi<0?[-ai,Ge]:ai===0?[Ge,ai]:[Ge,-ai]}(te);let je=Math.abs(Xt.top-Xt.bottom);for(const He of Xt.positionedLines)je-=He.lineOffset;const Ye=Xt.positionedLines.length,Pe=je/Ye;let Ie=Xt.top-te[1];for(let He=0;He<Ye;++He){const ai=Xt.positionedLines[He];Ie=lw(Xt,Pe,Ie,He);for(const Ge of ai.positionedGlyphs){if(!Ge.rect)continue;const Pi=Ge.rect||{};let Bi=fv+1,vi=!0,mi=1,_r=0;if(Ge.image){const ji=ke.get(Ge.image.toString());if(!ji)continue;if(ji.sdf){Hi("SDF images are not supported in formatted text and will be ignored.");continue}vi=!1,mi=ji.pixelRatio,Bi=ag/mi}const yi=(ze||Ue)&&Ge.vertical,Yi=Ge.metrics.advance*Ge.scale/2,wr=Ge.metrics,Vr=Ge.rect;if(Vr===null)continue;Ue&&Xt.verticalizable&&(_r=Ge.image?Yi-Ge.metrics.width*Ge.scale/2:0);const pn=ze?[Ge.x+Yi,Ge.y]:[0,0];let Tr=[0,0],wn=[0,0],Tn=!1;ze||(yi?(wn=[Ge.x+Yi+Ke[0],Ge.y+Ke[1]-_r],Tn=!0):Tr=[Ge.x+Yi+te[0],Ge.y+te[1]-_r]);const No=Vr.w*Ge.scale/(mi*(Ge.localGlyph?lp:1)),Ft=Vr.h*Ge.scale/(mi*(Ge.localGlyph?lp:1));let zt,Ne,pi,Ve;if(yi){const ji=Ge.y-Ie,Cr=new Ae(-Yi,Yi-ji),or=-Math.PI/2,Ni=new Ae(...wn);zt=new Ae(-Yi+Tr[0],Tr[1]),zt._rotateAround(or,Cr)._add(Ni),zt.x+=-ji+Yi,zt.y-=(wr.left-Bi)*Ge.scale;const vn=Ge.image?wr.advance*Ge.scale:Wa*Ge.scale,Yn=String.fromCodePoint(Ge.glyph);Gb(Yn)?zt.x+=(1-Bi)*Ge.scale:$b(Yn)?zt.x+=vn-wr.height*Ge.scale+(-Bi-1)*Ge.scale:zt.x+=Ge.image||wr.width+2*Bi===Vr.w&&wr.height+2*Bi===Vr.h?(vn-Ft)/2:(vn-(wr.height+2*Bi)*Ge.scale)/2,Ne=new Ae(zt.x,zt.y-No),pi=new Ae(zt.x+Ft,zt.y),Ve=new Ae(zt.x+Ft,zt.y-No)}else{const ji=(wr.left-Bi)*Ge.scale-Yi+Tr[0],Cr=(-wr.top-Bi)*Ge.scale+Tr[1],or=ji+No,Ni=Cr+Ft;zt=new Ae(ji,Cr),Ne=new Ae(or,Cr),pi=new Ae(ji,Ni),Ve=new Ae(or,Ni)}if(hi){let ji;ji=ze?new Ae(0,0):Tn?new Ae(Ke[0],Ke[1]):new Ae(te[0],te[1]),zt._rotateAround(hi,ji),Ne._rotateAround(hi,ji),pi._rotateAround(hi,ji),Ve._rotateAround(hi,ji)}const gi=new Ae(0,0),qi=new Ae(0,0);Ze.push({tl:zt,tr:Ne,bl:pi,br:Ve,texPrimary:Pi,texSecondary:void 0,writingMode:Xt.writingMode,glyphOffset:pn,sectionIndex:Ge.sectionIndex,isSDF:vi,pixelOffsetTL:gi,pixelOffsetBR:qi,minFontScaleX:0,minFontScaleY:0})}}return Ze}(0,l,E,m,_,b,u,n.allowVerticalPlacement),At=n.textSizeData;let Gt=null;At.kind==="source"?(Gt=[ap*m.layout.get("text-size").evaluate(b,{},it)*q.textScaleFactor],Gt[0]>Nf&&Hi(`${n.layerIds[0]}: Value for "text-size" is >= ${py}. Reduce your "text-size".`)):At.kind==="composite"&&(Gt=[ap*q.compositeTextSizes[0].evaluate(b,{},it)*q.textScaleFactor,ap*q.compositeTextSizes[1].evaluate(b,{},it)*q.textScaleFactor],(Gt[0]>Nf||Gt[1]>Nf)&&Hi(`${n.layerIds[0]}: Value for "text-size" is >= ${py}. Reduce your "text-size".`)),n.addSymbols(n.text,yt,Gt,E,_,b,R,t,r,P.lineStartIndex,P.lineLength,$,Y,it,gt,!1,at,yt.length);for(const kt of F)O[kt]=n.text.placedSymbolArray.length-1;return 4*yt.length}function Dx(n){for(const t in n)return n[t];return null}function D0(n,t,r,l,u,m,_,b,E,P,R){let F,O,$,q;if(F=R?R.top:_.top,O=R?R.bottom:_.bottom,$=R?R.left:_.left,q=R?R.right:_.right,vv(_)&&_.collisionPadding){const Y=_.collisionPadding;$-=Y[0],F-=Y[1],q+=Y[2],O+=Y[3]}if(E){const Y=new Ae($,F),it=new Ae(q,F),at=new Ae($,O),gt=new Ae(q,O),yt=ar(E);let At=new Ae(0,0);P&&(At=new Ae(P[0],P[1])),Y._rotateAround(yt,At),it._rotateAround(yt,At),at._rotateAround(yt,At),gt._rotateAround(yt,At),$=Math.min(Y.x,it.x,at.x,gt.x),q=Math.max(Y.x,it.x,at.x,gt.x),F=Math.min(Y.y,it.y,at.y,gt.y),O=Math.max(Y.y,it.y,at.y,gt.y)}return n.emplaceBack(t.x,t.y,t.z,r.x,r.y,$,F,q,O,b,l,u,m),n.length-1}function zx(n){vv(n)&&n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);const t=n.bottom-n.top;return t>0?Math.max(10,t):null}function yw(n,t,r,l){const u=n.compareText;if(t in u){const m=u[t];for(let _=m.length-1;_>=0;_--)if(l.dist(m[_])<r)return!0}else u[t]=[];return u[t].push(l),!1}function Uv(n,t){const r=n.fovAboveCenter,l=n.elevation?n.elevation.getMinElevationBelowMSL()*t:0,u=(n._camera.position[2]*n.worldSize-l)/Math.cos(n._pitch),m=Math.sin(r)*u/Math.sin(Math.max(Math.PI/2-n._pitch-r,.01));let _=Math.sin(n._pitch)*m+u;const b=u*(1/n._horizonShift);if(!n.elevation||n.elevation.exaggeration()===0){let E=Math.max(n.zoom-17,0);n.isOrthographic&&(E/=10),_*=1+E}return Math.min(1.01*_,b)}function fy(n,t){if(!t.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:t};const r=Math.pow(2,-n.z),l=n.x*r,u=(n.x+1)*r,m=n.y*r,_=(n.y+1)*r,b=Mt(l),E=Mt(u),P=vt(m),R=vt(_),F=t.project(b,P),O=t.project(E,P),$=t.project(E,R),q=t.project(b,R);let Y=Math.min(F.x,O.x,$.x,q.x),it=Math.min(F.y,O.y,$.y,q.y),at=Math.max(F.x,O.x,$.x,q.x),gt=Math.max(F.y,O.y,$.y,q.y);const yt=r/16;function At(kt,Xt,te,ne,ze,fe){const ke=(te+ze)/2,Ue=(ne+fe)/2,Ze=t.project(Mt(ke),vt(Ue)),hi=Math.max(0,Y-Ze.x,it-Ze.y,Ze.x-at,Ze.y-gt);Y=Math.min(Y,Ze.x),at=Math.max(at,Ze.x),it=Math.min(it,Ze.y),gt=Math.max(gt,Ze.y),hi>yt&&(At(kt,Ze,te,ne,ke,Ue),At(Ze,Xt,ke,Ue,ze,fe))}At(F,O,l,m,u,m),At(O,$,u,m,u,_),At($,q,u,_,l,_),At(q,F,l,_,l,m),Y-=yt,it-=yt,at+=yt,gt+=yt;const Gt=1/Math.max(at-Y,gt-it);return{scale:Gt,x:Y*Gt,y:it*Gt,x2:at*Gt,y2:gt*Gt,projection:t}}function jv(n,{x:t,y:r},l=0){return new Ae(((t-l)*n.scale-n.x)*ri,(r*n.scale-n.y)*ri)}const xw=Re(new Float32Array(16));class wm{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,r){return{x:0,y:0,z:0}}unproject(t,r){return new Z(0,0)}projectTilePoint(t,r,l){return{x:t,y:r,z:0}}locationPoint(t,r,l,u=!0){return t._coordinatePoint(t.locationCoordinate(r,l),u)}pixelsPerMeter(t,r){return _t(1,t)*r}pixelSpaceConversion(t,r,l){return 1}farthestPixelDistance(t){return Uv(t,t.pixelsPerMeter)}pointCoordinate(t,r,l,u){const m=t.horizonLineFromTop(!1),_=new Ae(r,Math.max(m,l));return t.rayIntersectionCoordinate(t.pointRayIntersection(_,u))}pointCoordinate3D(t,r,l){const u=new Ae(r,l);if(t.elevation)return t.elevation.pointCoordinate(u);{const m=this.pointCoordinate(t,u.x,u.y,0);return[m.x,m.y,m.z]}}isPointAboveHorizon(t,r){if(t.elevation&&t.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(t,r.x,r.y);const l=t.horizonLineFromTop();return r.y<l}createInversionMatrix(t,r){return xw}createTileMatrix(t,r,l){let u,m,_;const b=l.canonical,E=Re(new Float64Array(16));if(this.isReprojectedInTileSpace){const P=fy(b,this);u=1,m=P.x+l.wrap*P.scale,_=P.y,En(E,E,[u/P.scale,u/P.scale,t.pixelsPerMeter/r])}else u=r/t.zoomScale(b.z),m=(b.x+Math.pow(2,b.z)*l.wrap)*u,_=b.y*u;return $r(E,E,[m,_,0]),En(E,E,[u/ri,u/ri,1]),E}upVector(t,r,l){return[0,0,1]}upVectorScale(t,r,l){return{metersToTile:1}}}class vw extends wm{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[r,l]=this.parallels=t.parallels||[29.5,45.5],u=Math.sin(ar(r));this.n=(u+Math.sin(ar(l)))/2,this.c=1+u*(2*this.n-u),this.r0=Math.sqrt(this.c)/this.n}project(t,r){const{n:l,c:u,r0:m}=this,_=ar(t-this.center[0]),b=ar(r),E=Math.sqrt(u-2*l*Math.sin(b))/l;return{x:E*Math.sin(_*l),y:E*Math.cos(_*l)-m,z:0}}unproject(t,r){const{n:l,c:u,r0:m}=this,_=m+r;let b=Math.atan2(t,Math.abs(_))*Math.sign(_);_*l<0&&(b-=Math.PI*Math.sign(t)*Math.sign(_));const E=ar(this.center[0])*l;b=Bt(b,-Math.PI-E,Math.PI-E);const P=tt(bi(b/l)+this.center[0],-180,180),R=Math.asin(tt((u-(t*t+_*_)*l*l)/(2*l),-1,1)),F=tt(bi(R),-Ct,Ct);return new Z(P,F)}}const my=1.340264,gy=-.081106,_y=893e-6,yy=.003796,z0=Math.sqrt(3)/2;class bw extends wm{project(t,r){r=r/180*Math.PI,t=t/180*Math.PI;const l=Math.asin(z0*Math.sin(r)),u=l*l,m=u*u*u;return{x:.5*(t*Math.cos(l)/(z0*(my+3*gy*u+m*(7*_y+9*yy*u)))/Math.PI+.5),y:1-.5*(l*(my+gy*u+m*(_y+yy*u))/Math.PI+1),z:0}}unproject(t,r){t=(2*t-.5)*Math.PI;let l=r=(2*(1-r)-1)*Math.PI,u=l*l,m=u*u*u;for(let R,F,O,$=0;$<12&&(F=l*(my+gy*u+m*(_y+yy*u))-r,O=my+3*gy*u+m*(7*_y+9*yy*u),R=F/O,l=tt(l-R,-Math.PI/3,Math.PI/3),u=l*l,m=u*u*u,!(Math.abs(R)<1e-12));++$);const _=z0*t*(my+3*gy*u+m*(7*_y+9*yy*u))/Math.cos(l),b=Math.asin(Math.sin(l)/z0),E=tt(180*_/Math.PI,-180,180),P=tt(180*b/Math.PI,-Ct,Ct);return new Z(E,P)}}class ww extends wm{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,r){return{x:.5+t/360,y:.5-r/360,z:0}}unproject(t,r){const l=360*(t-.5),u=tt(360*(.5-r),-Ct,Ct);return new Z(l,u)}}const o_=Math.PI/2;function L0(n){return Math.tan((o_+n)/2)}class Tw extends wm{constructor(t){super(t),this.center=t.center||[0,30];const[r,l]=this.parallels=t.parallels||[30,30];let u=ar(r),m=ar(l);this.southernCenter=u+m<0,this.southernCenter&&(u=-u,m=-m);const _=Math.cos(u),b=L0(u);this.n=u===m?Math.sin(u):Math.log(_/Math.cos(m))/Math.log(L0(m)/b),this.f=_*Math.pow(L0(u),this.n)/this.n}project(t,r){r=ar(r),this.southernCenter&&(r=-r),t=ar(t-this.center[0]);const l=1e-6,{n:u,f:m}=this;m>0?r<-o_+l&&(r=-o_+l):r>o_-l&&(r=o_-l);const _=m/Math.pow(L0(r),u);let b=_*Math.sin(u*t),E=m-_*Math.cos(u*t);return b=.5*(b/Math.PI+.5),E=.5*(E/Math.PI+.5),{x:b,y:this.southernCenter?E:1-E,z:0}}unproject(t,r){t=(2*t-.5)*Math.PI,this.southernCenter&&(r=1-r),r=(2*(1-r)-.5)*Math.PI;const{n:l,f:u}=this,m=u-r,_=Math.sign(m),b=Math.sign(l)*Math.sqrt(t*t+m*m);let E=Math.atan2(t,Math.abs(m))*_;m*l<0&&(E-=Math.PI*Math.sign(t)*_);const P=tt(bi(E/l)+this.center[0],-180,180),R=tt(bi(2*Math.atan(Math.pow(u/b,1/l))-o_),-Ct,Ct);return new Z(P,this.southernCenter?-R:R)}}class Gv extends wm{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,r){return{x:ht(t),y:lt(r),z:0}}unproject(t,r){const l=Mt(t),u=vt(r);return new Z(l,u)}}const $v=ar(Ct);class Sw extends wm{project(t,r){const l=(r=ar(r))*r,u=l*l;return{x:.5*((t=ar(t))*(.8707-.131979*l+u*(u*(.003971*l-.001529*u)-.013791))/Math.PI+.5),y:1-.5*(r*(1.007226+l*(.015085+u*(.028874*l-.044475-.005916*u)))/Math.PI+1),z:0}}unproject(t,r){t=(2*t-.5)*Math.PI;let l=r=(2*(1-r)-1)*Math.PI,u=25,m=0,_=l*l;do{_=l*l;const P=_*_;m=(l*(1.007226+_*(.015085+P*(.028874*_-.044475-.005916*P)))-r)/(1.007226+_*(.045255+P*(.259866*_-.311325-.005916*11*P))),l=tt(l-m,-$v,$v)}while(Math.abs(m)>1e-6&&--u>0);_=l*l;const b=tt(bi(t/(.8707+_*(_*(_*_*_*(.003971-.001529*_)-.013791)-.131979))),-180,180),E=bi(l);return new Z(b,E)}}const qv=ar(Ct);class Iw extends wm{project(t,r){r=ar(r),t=ar(t);const l=Math.cos(r),u=2/Math.PI,m=Math.acos(l*Math.cos(t/2)),_=Math.sin(m)/m,b=.5*(t*u+2*l*Math.sin(t/2)/_)||0,E=.5*(r+Math.sin(r)/_)||0;return{x:.5*(b/Math.PI+.5),y:1-.5*(E/Math.PI+1),z:0}}unproject(t,r){let l=t=(2*t-.5)*Math.PI,u=r=(2*(1-r)-1)*Math.PI,m=25;const _=1e-6;let b=0,E=0;do{const P=Math.cos(u),R=Math.sin(u),F=2*R*P,O=R*R,$=P*P,q=Math.cos(l/2),Y=Math.sin(l/2),it=2*q*Y,at=Y*Y,gt=1-$*q*q,yt=gt?1/gt:0,At=gt?Math.acos(P*q)*Math.sqrt(1/gt):0,Gt=.5*(2*At*P*Y+2*l/Math.PI)-t,kt=.5*(At*R+u)-r,Xt=.5*yt*($*at+At*P*q*O)+1/Math.PI,te=yt*(it*F/4-At*R*Y),ne=.125*yt*(F*Y-At*R*$*it),ze=.5*yt*(O*q+At*at*P)+.5,fe=te*ne-ze*Xt;b=(kt*te-Gt*ze)/fe,E=(Gt*ne-kt*Xt)/fe,l=tt(l-b,-Math.PI,Math.PI),u=tt(u-E,-qv,qv)}while((Math.abs(b)>_||Math.abs(E)>_)&&--m>0);return new Z(bi(l),bi(u))}}class Zv extends wm{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(ar(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,r){const{scale:l,cosPhi:u}=this;return{x:ar(t)*u*l+.5,y:-Math.sin(ar(r))/u*l+.5,z:0}}unproject(t,r){const{scale:l,cosPhi:u}=this,m=-(r-.5)/l,_=tt(bi((t-.5)/l)/u,-180,180),b=Math.asin(tt(m*u,-1,1)),E=tt(bi(b),-Ct,Ct);return new Z(_,E)}}class Ew extends Gv{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,r,l){const u=Gm(t,r,l);return On(u,u,iu(md(l))),{x:u[0],y:u[1],z:u[2]}}locationPoint(t,r,l){const u=L(r.lat,r.lng),m=Xi([],u),_=l?t._centerAltitude+l:t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(r),t._centerAltitude):t._centerAltitude;di(u,u,m,_t(1,0)*ri*_);const b=Re(new Float64Array(16));return pr(b,t.pixelMatrix,t.globeMatrix),On(u,u,b),new Ae(u[0],u[1])}pixelsPerMeter(t,r){return _t(1,0)*r}pixelSpaceConversion(t,r,l){const u=_t(1,t)*r,m=Gi(_t(1,45)*r,u,l);return this.pixelsPerMeter(t,r)/m}createTileMatrix(t,r,l){const u=_d(md(l.canonical));return pr(new Float64Array(16),t.globeMatrix,u)}createInversionMatrix(t,r){const{center:l}=t,u=iu(md(r));return no(u,u,ar(l.lng)),$o(u,u,ar(l.lat)),En(u,u,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(u)}pointCoordinate(t,r,l,u){return Yd(t,r,l,!0)||new pe(0,0)}pointCoordinate3D(t,r,l){const u=this.pointCoordinate(t,r,l,0);return[u.x,u.y,u.z]}isPointAboveHorizon(t,r){return!Yd(t,r.x,r.y,!1)}farthestPixelDistance(t){const r=function(u,m){const _=u.cameraToCenterDistance,b=u._centerAltitude*m,E=u._camera,P=u._camera.forward(),R=Co([],Hn([],P,-_),[0,0,b]),F=u.worldSize/(2*Math.PI),O=[0,0,-F],$=u.width/u.height,q=Math.tan(u.fovAboveCenter),Y=Hn([],E.up(),q),it=Hn([],E.right(),q*$),at=Xi([],Co([],Co([],P,Y),it)),gt=[];let yt;if(new Pr(R,at).closestPointOnSphere(O,F,gt)){const At=Co([],gt,O),Gt=oo([],At,R);yt=Math.cos(u.fovAboveCenter)*cs(Gt)}else{const At=oo([],R,O),Gt=oo([],O,R);Xi(Gt,Gt);const kt=cs(At)-F;yt=Math.sqrt(kt*(kt+2*F));const Xt=Math.acos(yt/(F+kt))-Math.acos(Xr(P,Gt));yt*=Math.cos(Xt)}return 1.01*yt}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),l=zu(t.zoom);if(l>0){const u=Uv(t,_t(1,t.center.lat)*t.worldSize),m=t.worldSize/(2*Math.PI),_=Math.max(t.width,t.height)/t.worldSize*Math.PI;return Gi(r,u+m*(1-Math.cos(_)),Math.pow(l,10))}return r}upVector(t,r,l){return Gm(r,l,t,1)}upVectorScale(t){return{metersToTile:nm($m(md(t)))}}}function Hv(n){const t=n.parallels,r=!!t&&Math.abs(t[0]+t[1])<.01;switch(n.name){case"mercator":return new Gv(n);case"equirectangular":return new ww(n);case"naturalEarth":return new Sw(n);case"equalEarth":return new bw(n);case"winkelTripel":return new Iw(n);case"albers":return r?new Zv(n):new vw(n);case"lambertConformalConic":return r?new Zv(n):new Tw(n);case"globe":return new Ew(n)}throw new Error(`Invalid projection name: ${n.name}`)}const Aw=qe.types,Pw=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function xy(n,t,r,l,u,m,_,b,E,P,R,F,O){const $=b?Math.min(Nf,Math.round(b[0])):0,q=b?Math.min(Nf,Math.round(b[1])):0;n.emplaceBack(t,r,Math.round(32*l),Math.round(32*u),m,_,($<<1)+(E?1:0),0+(q<<1),16*P,16*R,256*F,256*O)}function vy(n,t,r){n.emplaceBack(t,r)}function by(n,t,r,l,u,m,_){n.emplaceBack(t,r,l,u,m,_)}const R0=(n,t,r,l)=>{for(let u=0;u<t;u++)n.emplaceBack(r[0],r[1],r[2],l[0],l[1],l[2])};function s_(n,t,r,l,u){n.emplaceBack(t,r,l,u),n.emplaceBack(t,r,l,u),n.emplaceBack(t,r,l,u),n.emplaceBack(t,r,l,u)}function Mw(n){for(const t of n.sections)if(Cp(t.text))return!0;return!1}class Lx{constructor(t){this.layoutVertexArray=new Lo,this.indexArray=new ro,this.programConfigurations=t,this.segments=new To,this.dynamicLayoutVertexArray=new uh,this.opacityVertexArray=new Dp,this.placedSymbolArray=new fd,this.iconTransitioningVertexArray=new Nl,this.globeExtVertexArray=new Ol,this.zOffsetVertexArray=new $s,this.orientationVertexArray=new Hd,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getIconVertexData(t,r){const l=[],u=this.layoutVertexArray.uint16;for(let m=0;m<r;++m){const _=12*(t+m);l.push(...u.slice(_,_+12))}return l}updateIconVertexData(t,r,l,u,m,_,b,E,P,R,F,O,$){const q=this.layoutVertexArray.uint16,Y=12*t;q[Y]=r,q[Y+1]=l,q[Y+2]=u,q[Y+3]=m,q[Y+4]=_,q[Y+5]=b,q[Y+6]=E,q[Y+7]=P,q[Y+8]=R,q[Y+9]=F,q[Y+10]=O,q[Y+11]=$}upload(t,r,l,u,m,_){this.isEmpty()||(l&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Lb.members,!!_),this.indexBuffer=t.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,kb.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,Pw,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=t.createVertexBuffer(this.iconTransitioningVertexArray,Ob.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,Rb.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||m)&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,Fb.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=t.createVertexBuffer(this.orientationVertexArray,Bb.members,!0)),this.opacityVertexBuffer.itemSize=1),(l||u)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Ei(Lx,"SymbolBuffers");class Rx{constructor(t,r,l){this.layoutVertexArray=new t,this.layoutAttributes=r,this.indexArray=new l,this.segments=new To,this.collisionVertexArray=new ph,this.collisionVertexArrayExt=new uh}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,Nb.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,Vb.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Ei(Rx,"CollisionBuffers");class k0{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(_=>_.fqid),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Re([]),this.placementViewportMatrix=Re([]);const r=this.layers[0]._unevaluatedLayout._values;this.worldview=t.worldview,this.textSizeData=e_(this.zoom,r["text-size"],this.worldview),this.iconSizeData=e_(this.zoom,r["icon-size"],this.worldview);const l=this.layers[0].layout,u=l.get("symbol-sort-key"),m=l.get("symbol-z-order");this.lut=t.lut,this.canOverlap=l.get("text-allow-overlap")||l.get("icon-allow-overlap")||l.get("text-ignore-placement")||l.get("icon-ignore-placement"),this.sortFeaturesByKey=m!=="viewport-y"&&u.constantOr(1)!==void 0,this.sortFeaturesByY=(m==="viewport-y"||m==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=l.get("text-writing-mode").map(_=>bh[_]),this.stateDependentLayerIds=this.layers.filter(_=>_.isStateDependent()).map(_=>_.id),this.sourceID=t.sourceID,this.projection=t.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null}hasAnyAppearanceProperty(t){const r=this.layers[0].getAppearances();return!(!r||r.length===0)&&r.some(l=>l.getProperty(t)!=null)}createArrays(){this.text=new Lx(new _h(this.layers,{zoom:this.zoom,lut:this.lut},t=>t.startsWith("text")||t.startsWith("symbol"))),this.icon=new Lx(new _h(this.layers,{zoom:this.zoom,lut:this.lut},t=>t.startsWith("icon")||t.startsWith("symbol"))),this.glyphOffsetArray=new zm,this.lineVertexArray=new yg,this.symbolInstances=new _g}calculateGlyphDependencies(t,r,l,u,m){for(const _ of t){const b=_.codePointAt(0);if(b===void 0)break;if(r[b]=!0,u&&m&&b<=65535){const E=ly[_];E&&(r[E.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(t,r,l,u,m,_){let b=1;const E=t.getUnevaluatedProperties()._values["icon-size"],P=e_(this.zoom,E,this.worldview),R=i_(P,r);if(P.kind!=="constant"&&P.kind!=="camera"||(b=R.uSize),P.kind==="composite"){const{minZoom:F,maxZoom:O}=P,$=E.possiblyEvaluate(new D(F,{worldview:this.worldview}),u),q=E.possiblyEvaluate(new D(O,{worldview:this.worldview}),u),Y=$.evaluate(l,{},u,m);b=Y+(q.evaluate(l,{},u,m)-Y)*R.uSizeT}return P.kind==="source"&&(b=E.possiblyEvaluate(new D(this.zoom,{worldview:this.worldview}),u).evaluate(l,{},u,m)),b*_}updateFootprints(t,r){}updateReplacement(t,r){if(r.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=r.updateTime;const l=r.getReplacementRegionsForTile(t.toUnwrapped(),!0);return!Df(this.activeReplacements,l)&&(this.activeReplacements=l,!0)}getResolvedImageFromTokens(t){return typeof t=="string"?Fa.build(t):t}populate(t,r,l,u){const m=this.layers[0],_=m.layout,b=this.projection.name==="globe",E=_.get("text-font"),P=_.get("text-field"),R=_.get("icon-image"),[F,O]=_.get("icon-size-scale-range"),$=tt(r.scaleFactor||1,F,O),q=(P.value.kind!=="constant"||P.value.value instanceof Ts&&!P.value.value.isEmpty()||P.value.value.toString().length>0)&&(E.value.kind!=="constant"||E.value.value.length>0),Y=R.value.kind!=="constant"||!!R.value.value||Object.keys(R.parameters).length>0,it=this.hasAnyAppearanceProperty("icon-image"),at=_.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!q&&!Y&&!it)return;const gt=r.iconDependencies,yt=r.glyphDependencies,At=r.availableImages,Gt=new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),kt=Xt=>{const te=Xt.id.toString();gt.has(te)?gt.get(te).push(Xt):gt.set(te,[Xt])};for(const Xt of t){const{feature:te,id:ne,index:ze,sourceLayerIndex:fe}=Xt,ke=m._featureFilter.needGeometry,Ue=Te(te,ke);if(!m._featureFilter.filter(Gt,Ue,l))continue;if(ke||(Ue.geometry=Oe(te,l,u)),b&&te.type!==1&&l.z<=5){const He=Ue.geometry,ai=.98078528056,Ge=(Pi,Bi)=>Xr(Gm(Pi.x,Pi.y,l,1),Gm(Bi.x,Bi.y,l,1))<ai;for(let Pi=0;Pi<He.length;Pi++)He[Pi]=Be(He[Pi],Ge)}let Ze,hi;if(q){const He=m.getValueAndResolveTokens("text-field",Ue,l,At),ai=Ts.factory(He);Mw(ai)&&(this.hasRTLText=!0),(!this.hasRTLText||d()==="unavailable"||this.hasRTLText&&S.isParsed())&&(Ze=jb(ai,m,Ue))}if(Y){const He=m.getValueAndResolveTokens("icon-image",Ue,l,At);hi=this.getResolvedImageFromTokens(He)}const Ke=this.layers[0];let je=!1;if(!hi&&it){const He=Ke.getAppearances();for(const ai of He)if(ai.getProperty("icon-image")){const Ge=Ke.getAppearanceValueAndResolveTokens(ai,"icon-image",Ue,l,At);if(Ge){hi=this.getResolvedImageFromTokens(Ge),je=!0;break}}}if(!Ze&&!hi)continue;const Ye=this.sortFeaturesByKey?at.evaluate(Ue,{},l):void 0,Pe={id:ne,text:Ze,icon:hi,index:ze,sourceLayerIndex:fe,geometry:Ue.geometry,properties:te.properties,type:Aw[te.type],sortKey:Ye};if(this.features.push(Pe),this.appearanceFeatureData.push({id:ne,properties:te.properties,usesAppearanceIconAsPlaceholder:je,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),hi){const He=Ke._unevaluatedLayout._values,{iconPrimary:ai,iconSecondary:Ge}=dy(hi,this.iconSizeData,He["icon-size"],l,this.zoom,Pe,this.pixelRatio,$,this.worldview);kt(ai),Ge&&(this.hasAnySecondaryIcon=!0,kt(Ge))}const Ie=Ke.getAppearances();if(Ie.length!==0&&Ie.forEach(He=>{if(!He.getProperty("icon-image"))return;const ai=this.getCombinedIconPrimary(He,Ke,Ue,l,At,Pe,$);ai&&kt(ai)}),Ze){const He=E.evaluate(Ue,{},l).join(","),ai=_.get("text-rotation-alignment")==="map"&&_.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(bh.vertical)>=0;for(const Ge of Ze.sections)if(Ge.image){const Pi=Ge.image.getPrimary().scaleSelf(this.pixelRatio),Bi=Pi.id.toString(),vi=gt.get(Bi)||[];vi.push(Pi),gt.set(Bi,vi)}else{const Pi=Yh(Ze.toString()),Bi=Ge.fontStack||He,vi=yt[Bi]=yt[Bi]||{};this.calculateGlyphDependencies(Ge.text,vi,ai,this.allowVerticalPlacement,Pi)}}}if(_.get("symbol-placement")==="line"&&(this.features=function(Xt){const te={},ne={},ze=[];let fe=0;function ke(Ke){ze.push(Xt[Ke]),fe++}function Ue(Ke,je,Ye){const Pe=ne[Ke];return delete ne[Ke],ne[je]=Pe,ze[Pe].geometry[0].pop(),ze[Pe].geometry[0]=ze[Pe].geometry[0].concat(Ye[0]),Pe}function Ze(Ke,je,Ye){const Pe=te[je];return delete te[je],te[Ke]=Pe,ze[Pe].geometry[0].shift(),ze[Pe].geometry[0]=Ye[0].concat(ze[Pe].geometry[0]),Pe}function hi(Ke,je,Ye){const Pe=Ye?je[0][je[0].length-1]:je[0][0];return`${Ke}:${Pe.x}:${Pe.y}`}for(let Ke=0;Ke<Xt.length;Ke++){const je=Xt[Ke],Ye=je.geometry,Pe=je.text?je.text.toString():null;if(!Pe){ke(Ke);continue}const Ie=hi(Pe,Ye),He=hi(Pe,Ye,!0);if(Ie in ne&&He in te&&ne[Ie]!==te[He]){const ai=Ze(Ie,He,Ye),Ge=Ue(Ie,He,ze[ai].geometry);delete te[Ie],delete ne[He],ne[hi(Pe,ze[Ge].geometry,!0)]=Ge,ze[ai].geometry=null}else Ie in ne?Ue(Ie,He,Ye):He in te?Ze(Ie,He,Ye):(ke(Ke),te[Ie]=fe-1,ne[He]=fe-1)}return ze.filter(Ke=>Ke.geometry)}(this.features)),_.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",r.elevationFeatures){!this.elevationFeatures&&r.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const Xt of r.elevationFeatures)this.elevationFeatureIdToIndex.set(Xt.id,this.elevationFeatures.length),this.elevationFeatures.push(Xt)}}else _.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((Xt,te)=>Xt.sortKey-te.sortKey)}getCombinedIconPrimary(t,r,l,u,m,_,b){let E,P;const R=t.getUnevaluatedProperties();if(R._values["icon-image"].value!==void 0){const F=r.getAppearanceValueAndResolveTokens(t,"icon-image",l,u,m);E=this.getResolvedImageFromTokens(F)}else{const F=r.getValueAndResolveTokens("icon-image",l,u,m);E=this.getResolvedImageFromTokens(F)}if(E){const F=R._values["icon-size"]||r._unevaluatedLayout._values["icon-size"];P=dy(E,e_(this.zoom,F,this.worldview),F,u,this.zoom,_,this.pixelRatio,b,this.worldview).iconPrimary}return P}updateAppearanceBasedIconTextures(t,r,l,u){if(!this.appearanceFeatureData||!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)return!1;const m=this.layers[0];let _=!1,b=0;const E=m.layout,[P,R]=E.get("icon-size-scale-range"),F=tt(1,P,R);for(let O=0;O<this.symbolInstances.length;O++){const $=this.symbolInstances.get(O),q=this.appearanceFeatureData[$.featureIndex];if(q&&$.placedIconSymbolIndex>=0){const Y=q.id,it=r&&Y!==void 0?r[String(Y)]:void 0,at={type:"Point",id:q.id,properties:q.properties,geometry:[]},gt=this.layers[0].appearances&&this.layers[0].appearances.find(yt=>yt.isActive({globals:u,feature:at,canonical:t,featureState:it}));if(q.activeAppearance===gt)continue;if(gt){q.activeAppearance=gt;const yt={sortKey:void 0,text:void 0,icon:null,index:$.featureIndex,sourceLayerIndex:$.featureIndex,geometry:[],properties:q.properties,type:"Point",id:q.id};if(!gt.hasCachedIconPrimary()){const Xt=this.getCombinedIconPrimary(gt,m,at,t,l,yt,F);gt.setCachedIconPrimary(Xt)}const At=gt.getCachedIconPrimary();if(!At)continue;const Gt=At.toString(),kt=this.iconAtlasPositions&&this.iconAtlasPositions.get(Gt);if(kt){const Xt=m.getAppearanceValueAndResolveTokens(gt,"icon-offset",at,t,l),te=Xt&&Array.isArray(Xt)?Xt:[0,0];let ne=I0(kt,void 0,te,m.layout.get("icon-anchor").evaluate(at,{},t));const ze=m.getAppearanceValueAndResolveTokens(gt,"icon-rotate",at,t,l),fe=typeof ze=="number"?ze:0,ke=kt.sdf,Ue=m.layout.get("icon-text-fit").constantOr("none");Ue!=="none"&&q.textShaping&&q.iconTextFitPadding&&q.fontScale&&(ne=Sx(ne,q.textShaping,Ue,q.iconTextFitPadding,te,q.fontScale));const Ze=this.calculateEffectiveAppearanceIconSize(gt,u.zoom,at,t,l,F),hi=0,Ke=1+(Math.min(Nf,Math.round(Ze*ap))<<1),je=Px(ne,fe,ke,Ue!=="none",F);q.isUsingAppearanceVertexData||(q.isUsingAppearanceVertexData=!0,q.layoutBasedVertexData=this.icon.getIconVertexData(b,$.numIconVertices));for(let Pe=0;Pe<je.length;++Pe){const Ie=je[Pe],He=q.layoutBasedVertexData[0]||$.tileAnchorX,ai=q.layoutBasedVertexData[1]||$.tileAnchorY,Ge=16*Ie.pixelOffsetTL.x,Pi=16*Ie.pixelOffsetTL.y,Bi=16*Ie.pixelOffsetBR.x,vi=16*Ie.pixelOffsetBR.y,mi=16*Ie.minFontScaleX,_r=16*Ie.minFontScaleY;this.icon.updateIconVertexData(b,He,ai,Math.round(32*Ie.tl.x),Math.round(32*Ie.tl.y),Ie.texPrimary.x,Ie.texPrimary.y,hi,Ke,Ge,Pi,mi,_r),this.icon.updateIconVertexData(b+1,He,ai,Math.round(32*Ie.tr.x),Math.round(32*Ie.tr.y),Ie.texPrimary.x+Ie.texPrimary.w,Ie.texPrimary.y,hi,Ke,Bi,Pi,mi,_r),this.icon.updateIconVertexData(b+2,He,ai,Math.round(32*Ie.bl.x),Math.round(32*Ie.bl.y),Ie.texPrimary.x,Ie.texPrimary.y+Ie.texPrimary.h,hi,Ke,Ge,vi,mi,_r),this.icon.updateIconVertexData(b+3,He,ai,Math.round(32*Ie.br.x),Math.round(32*Ie.br.y),Ie.texPrimary.x+Ie.texPrimary.w,Ie.texPrimary.y+Ie.texPrimary.h,hi,Ke,Bi,vi,mi,_r),b+=4}const Ye=$.numIconVertices-4*je.length;for(let Pe=0;Pe<Ye;++Pe)this.icon.updateIconVertexData(b+Pe,0,0,0,0,0,0,0,0,0,0,0,0);_=!0}else b+=$.numIconVertices}else if(q.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(b,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(b+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(b+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(b+3,0,0,0,0,0,0,0,0,0,0,0,0),_=!0),b+=$.numIconVertices,q.activeAppearance=null;else if(q.isUsingAppearanceVertexData){const At=q.layoutBasedVertexData.length/12;for(let Gt=0;Gt<At;++Gt){const kt=Gt*12;this.icon.updateIconVertexData(b+Gt,q.layoutBasedVertexData[kt+0],q.layoutBasedVertexData[kt+1],q.layoutBasedVertexData[kt+2],q.layoutBasedVertexData[kt+3],q.layoutBasedVertexData[kt+4],q.layoutBasedVertexData[kt+5],q.layoutBasedVertexData[kt+6],q.layoutBasedVertexData[kt+7],q.layoutBasedVertexData[kt+8],q.layoutBasedVertexData[kt+9],q.layoutBasedVertexData[kt+10],q.layoutBasedVertexData[kt+11])}b+=At,q.isUsingAppearanceVertexData=!1,q.activeAppearance=null,_=!0}else b+=$.numIconVertices,q.activeAppearance=null}}return _}update(t,r,l,u,m,_,b){this.text.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview),this.icon.programConfigurations.updatePaintArrays(t,r,m,l,u,_,b,this.worldview)}updateRoadElevation(t){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let r=!1;const l=Zt(t),u=1/l;let m=!1,_=!1;for(let b=0;b<this.symbolInstances.length;b++){const E=this.symbolInstances.get(b),P=Kn(1,0,0),R=Kn(0,1,0),{numHorizontalGlyphVertices:F,numVerticalGlyphVertices:O,numIconVertices:$,numVerticalIconVertices:q}=E,Y=F>0||O>0,it=$>0,at=this.elevationFeatures[E.elevationFeatureIndex];if(at){const gt=new Ae(E.tileAnchorX,E.tileAnchorY),yt=.075+at.pointElevation(gt);E.zOffset!==yt&&(r=!0,E.zOffset=yt),yt!==0&&(this.hasAnyZOffset=!0);const At=at.computeSlopeNormal(gt,u),Gt=Da(Cs(),Kn(0,0,1),At);ds(P,P,Gt),ds(R,R,Gt),P[2]*=l,R[2]*=l,P[0]===1&&P[1]===0&&P[2]===0&&R[0]===0&&R[1]===1&&R[2]===0||(m=m||Y,_=_||it)}if(Y&&(R0(this.text.orientationVertexArray,F,P,R),R0(this.text.orientationVertexArray,O,P,R)),it){const{placedIconSymbolIndex:gt,verticalPlacedIconSymbolIndex:yt}=E;gt>=0&&R0(this.icon.orientationVertexArray,$,P,R),yt>=0&&R0(this.icon.orientationVertexArray,q,P,R)}}m||(this.text.orientationVertexArray=void 0),_||(this.icon.orientationVertexArray=void 0),r&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const t=(m,_,b)=>{l+=_,l>m.length&&m.resize(l);for(let E=-_;E<0;E++)m.emplace(E+l,b)},r=(m,_,b)=>{u+=_,u>m.length&&m.resize(u);for(let E=-_;E<0;E++)m.emplace(E+u,b)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let l=0,u=0;for(let m=0;m<this.symbolInstances.length;m++){const _=this.symbolInstances.get(m),{numHorizontalGlyphVertices:b,numVerticalGlyphVertices:E,numIconVertices:P}=_,R=_.zOffset,F=P>0;if((b>0||E>0)&&(t(this.text.zOffsetVertexArray,b,R),t(this.text.zOffsetVertexArray,E,R)),F){const{placedIconSymbolIndex:O,verticalPlacedIconSymbolIndex:$}=_;O>=0&&r(this.icon.zOffsetVertexArray,P,R),$>=0&&r(this.icon.zOffsetVertexArray,_.numVerticalIconVertices,R)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t,r,l,u,m){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),this.hasAppearances===null&&(this.hasAppearances=this.layers.some(_=>_.appearances&&_.appearances.length>0)),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(t,r,l,u){return!!(t&&r&&l)&&!(!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(t,r,l,u)&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Hv(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,r){const l=this.lineVertexArray.length;if(t.segment!==void 0)for(const{x:u,y:m}of r)this.lineVertexArray.emplaceBack(u,m);return{lineStartIndex:l,lineLength:this.lineVertexArray.length-l}}addSymbols(t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y,it,at,gt){const yt=t.indexArray,At=t.layoutVertexArray,Gt=t.globeExtVertexArray,kt=t.segments.prepareSegment(4*gt,At,yt,this.canOverlap?_.sortKey:void 0),Xt=this.glyphOffsetArray.length,te=kt.vertexLength,ne=this.allowVerticalPlacement&&b===bh.vertical?Math.PI/2:0,ze=_.text&&_.text.sections;for(let Ue=0;Ue<r.length;Ue++){const{tl:Ze,tr:hi,bl:Ke,br:je,texPrimary:Ye,texSecondary:Pe,pixelOffsetTL:Ie,pixelOffsetBR:He,minFontScaleX:ai,minFontScaleY:Ge,glyphOffset:Pi,isSDF:Bi,sectionIndex:vi}=r[Ue],mi=kt.vertexLength,_r=Pi[1];if(xy(At,P.x,P.y,Ze.x,_r+Ze.y,Ye.x,Ye.y,l,Bi,Ie.x,Ie.y,ai,Ge),xy(At,P.x,P.y,hi.x,_r+hi.y,Ye.x+Ye.w,Ye.y,l,Bi,He.x,Ie.y,ai,Ge),xy(At,P.x,P.y,Ke.x,_r+Ke.y,Ye.x,Ye.y+Ye.h,l,Bi,Ie.x,He.y,ai,Ge),xy(At,P.x,P.y,je.x,_r+je.y,Ye.x+Ye.w,Ye.y+Ye.h,l,Bi,He.x,He.y,ai,Ge),E){const{x:yi,y:Yi,z:wr}=E.anchor,[Vr,pn,Tr]=E.up;by(Gt,yi,Yi,wr,Vr,pn,Tr),by(Gt,yi,Yi,wr,Vr,pn,Tr),by(Gt,yi,Yi,wr,Vr,pn,Tr),by(Gt,yi,Yi,wr,Vr,pn,Tr),s_(t.dynamicLayoutVertexArray,yi,Yi,wr,ne)}else s_(t.dynamicLayoutVertexArray,P.x,P.y,P.z,ne);if(it){const yi=Pe||Ye;vy(t.iconTransitioningVertexArray,yi.x,yi.y),vy(t.iconTransitioningVertexArray,yi.x+yi.w,yi.y),vy(t.iconTransitioningVertexArray,yi.x,yi.y+yi.h),vy(t.iconTransitioningVertexArray,yi.x+yi.w,yi.y+yi.h)}yt.emplaceBack(mi,mi+1,mi+2),yt.emplaceBack(mi+1,mi+2,mi+3),kt.vertexLength+=4,kt.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Pi[0]),Ue!==r.length-1&&vi===r[Ue+1].sectionIndex||t.programConfigurations.populatePaintArrays(At.length,_,_.index,{},$,q,Y,ze&&ze[vi],this.worldview)}const fe=gt-r.length;fe!==0&&this._addNullVertices(fe,At,l,E,Gt,t,it,kt,yt);const ke=E?E.anchor:P;t.placedSymbolArray.emplaceBack(ke.x,ke.y,ke.z,P.x,P.y,Xt,this.glyphOffsetArray.length-Xt,te,R,F,P.segment,l?l[0]:0,l?l[1]:0,u[0],u[1],b,0,0,0,O,0),t.symbolInstanceIndices.push(at)}_addNullVertices(t,r,l,u,m,_,b,E,P){for(let R=0;R<t;R++){for(let O=0;O<4;O++)xy(r,0,0,0,0,0,0,l,!1,0,0,0,0),u&&by(m,0,0,0,0,0,0),s_(_.dynamicLayoutVertexArray,0,0,0,0),b&&vy(_.iconTransitioningVertexArray,0,0);const F=E.vertexLength;P.emplaceBack(F,F+1,F+2),P.emplaceBack(F+1,F+2,F+3),E.vertexLength+=4,E.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(t,r,l,u,m,_,b){t.emplaceBack(r,l,u,m,_,Math.round(b.x),Math.round(b.y))}_addCollisionDebugVertices(t,r,l,u,m,_,b){const E=l.segments.prepareSegment(4,l.layoutVertexArray,l.indexArray),P=E.vertexLength,R=b.tileAnchorX,F=b.tileAnchorY;for(let $=0;$<4;$++)l.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(l.collisionVertexArrayExt,r,t.padding,b.zOffset),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x1,t.y1)),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x2,t.y1)),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x2,t.y2)),this._commitLayoutVertex(l.layoutVertexArray,u,m,_,R,F,new Ae(t.x1,t.y2)),E.vertexLength+=4;const O=l.indexArray;O.emplaceBack(P,P+1),O.emplaceBack(P+1,P+2),O.emplaceBack(P+2,P+3),O.emplaceBack(P+3,P),E.primitiveLength+=4}_addTextDebugCollisionBoxes(t,r,l,u,m,_){for(let b=u;b<m;b++){const E=l.get(b),P=this.getSymbolInstanceTextSize(t,_,r,b);this._addCollisionDebugVertices(E,P,this.textCollisionBox,E.projectedAnchorX,E.projectedAnchorY,E.projectedAnchorZ,_)}}_addIconDebugCollisionBoxes(t,r,l,u,m,_){for(let b=u;b<m;b++){const E=l.get(b),P=this.getSymbolInstanceIconSize(t,r,_.placedIconSymbolIndex);this._addCollisionDebugVertices(E,P,this.iconCollisionBox,E.projectedAnchorX,E.projectedAnchorY,E.projectedAnchorZ,_)}}generateCollisionDebugBuffers(t,r,l){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Rx(zp,hv.members,Nl),this.iconCollisionBox=new Rx(zp,hv.members,Nl);const u=i_(this.iconSizeData,t),m=i_(this.textSizeData,t,l);for(let _=0;_<this.symbolInstances.length;_++){const b=this.symbolInstances.get(_);this._addTextDebugCollisionBoxes(m,t,r,b.textBoxStartIndex,b.textBoxEndIndex,b),this._addTextDebugCollisionBoxes(m,t,r,b.verticalTextBoxStartIndex,b.verticalTextBoxEndIndex,b),this._addIconDebugCollisionBoxes(u,t,r,b.iconBoxStartIndex,b.iconBoxEndIndex,b),this._addIconDebugCollisionBoxes(u,t,r,b.verticalIconBoxStartIndex,b.verticalIconBoxEndIndex,b)}}getSymbolInstanceTextSize(t,r,l,u){const m=this.text.placedSymbolArray.get(r.rightJustifiedTextSymbolIndex>=0?r.rightJustifiedTextSymbolIndex:r.centerJustifiedTextSymbolIndex>=0?r.centerJustifiedTextSymbolIndex:r.leftJustifiedTextSymbolIndex>=0?r.leftJustifiedTextSymbolIndex:r.verticalPlacedTextSymbolIndex>=0?r.verticalPlacedTextSymbolIndex:u),_=Ix(this.textSizeData,t,m)/Wa;return this.tilePixelRatio*_}getSymbolInstanceIconSize(t,r,l){const u=this.icon.placedSymbolArray.get(l),m=Ix(this.iconSizeData,t,u);return this.tilePixelRatio*m}_commitDebugCollisionVertexUpdate(t,r,l,u){t.emplaceBack(r,-l,-l,u),t.emplaceBack(r,l,-l,u),t.emplaceBack(r,l,l,u),t.emplaceBack(r,-l,l,u)}_updateTextDebugCollisionBoxes(t,r,l,u,m,_,b){for(let E=u;E<m;E++){const P=l.get(E),R=this.getSymbolInstanceTextSize(t,_,r,E);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,R,P.padding,_.zOffset)}}_updateIconDebugCollisionBoxes(t,r,l,u,m,_,b){for(let E=u;E<m;E++){const P=l.get(E),R=this.getSymbolInstanceIconSize(t,r,_.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,R,P.padding,_.zOffset)}}updateCollisionDebugBuffers(t,r,l,u){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const m=i_(this.iconSizeData,t,u),_=i_(this.textSizeData,t,l);for(let b=0;b<this.symbolInstances.length;b++){const E=this.symbolInstances.get(b);this._updateTextDebugCollisionBoxes(_,t,r,E.textBoxStartIndex,E.textBoxEndIndex,E,l),this._updateTextDebugCollisionBoxes(_,t,r,E.verticalTextBoxStartIndex,E.verticalTextBoxEndIndex,E,l),this._updateIconDebugCollisionBoxes(m,t,r,E.iconBoxStartIndex,E.iconBoxEndIndex,E,u),this._updateIconDebugCollisionBoxes(m,t,r,E.verticalIconBoxStartIndex,E.verticalIconBoxEndIndex,E,u)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,r,l,u,m,_,b,E,P){const R={};if(r<l){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At,featureIndex:Gt}=t.get(r);R.textBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At},R.textFeatureIndex=Gt}if(u<m){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At,featureIndex:Gt}=t.get(u);R.verticalTextBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At},R.verticalTextFeatureIndex=Gt}if(_<b){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At,featureIndex:Gt}=t.get(_);R.iconBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At},R.iconFeatureIndex=Gt}if(E<P){const{x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At,featureIndex:Gt}=t.get(E);R.verticalIconBox={x1:F,y1:O,x2:$,y2:q,padding:Y,projectedAnchorX:it,projectedAnchorY:at,projectedAnchorZ:gt,tileAnchorX:yt,tileAnchorY:At},R.verticalIconFeatureIndex=Gt}return R}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const l=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,l.textBoxStartIndex,l.textBoxEndIndex,l.verticalTextBoxStartIndex,l.verticalTextBoxEndIndex,l.iconBoxStartIndex,l.iconBoxEndIndex,l.verticalIconBoxStartIndex,l.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(t,r){const l=t.placedSymbolArray.get(r),u=l.vertexStartIndex+4*l.numGlyphs;for(let m=l.vertexStartIndex;m<u;m+=4)t.indexArray.emplaceBack(m,m+1,m+2),t.indexArray.emplaceBack(m+1,m+2,m+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(t),l=Math.cos(t),u=[],m=[],_=[];for(let b=0;b<this.symbolInstances.length;++b){_.push(b);const E=this.symbolInstances.get(b);u.push(0|Math.round(r*E.tileAnchorX+l*E.tileAnchorY)),m.push(E.featureIndex)}return _.sort((b,E)=>u[b]-u[E]||m[E]-m[b]),_}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let t=0;t<this.symbolInstances.length;++t)this.symbolInstanceIndexesSortedZOffset.push(t)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((t,r)=>this.symbolInstances.get(r).zOffset-this.symbolInstances.get(t).zOffset)}addToSortKeyRanges(t,r){const l=this.sortKeyRanges[this.sortKeyRanges.length-1];l&&l.sortKey===r?l.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const l=this.symbolInstances.get(r);this.featureSortOrder.push(l.featureIndex);const{rightJustifiedTextSymbolIndex:u,centerJustifiedTextSymbolIndex:m,leftJustifiedTextSymbolIndex:_,verticalPlacedTextSymbolIndex:b,placedIconSymbolIndex:E,verticalPlacedIconSymbolIndex:P}=l;u>=0&&this.addIndicesForPlacedSymbol(this.text,u),m>=0&&m!==u&&this.addIndicesForPlacedSymbol(this.text,m),_>=0&&_!==m&&_!==u&&this.addIndicesForPlacedSymbol(this.text,_),b>=0&&this.addIndicesForPlacedSymbol(this.text,b),E>=0&&this.addIndicesForPlacedSymbol(this.icon,E),P>=0&&this.addIndicesForPlacedSymbol(this.icon,P)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(t){const r=this.symbolInstances.get(this.text.symbolInstanceIndices[t]).elevationFeatureIndex;let l;return this.elevationFeatures&&r<this.elevationFeatures.length&&(l=this.elevationFeatures[r]),l}}function Wv(n,t){return t.replace(/{([^{}]+)}/g,(r,l)=>l in n?String(n[l]):"")}let Xv,Yv,kx;Ei(k0,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),k0.addDynamicAttributes=s_;class Jv{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:ka,this.defaultValue=t}evaluate(t){if(t.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(t.formattedSection))return r.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Ei(Jv,"FormatSectionOverride",{omit:["defaultValue"]});const Fx=()=>kx||(kx={layout:Xv||(Xv=new Wt({"symbol-placement":new pt(ft.layout_symbol["symbol-placement"]),"symbol-spacing":new pt(ft.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new pt(ft.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new It(ft.layout_symbol["symbol-sort-key"]),"symbol-z-order":new pt(ft.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new pt(ft.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new pt(ft.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new pt(ft.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new pt(ft.layout_symbol["icon-ignore-placement"]),"icon-optional":new pt(ft.layout_symbol["icon-optional"]),"icon-rotation-alignment":new pt(ft.layout_symbol["icon-rotation-alignment"]),"icon-size":new It(ft.layout_symbol["icon-size"]),"icon-size-scale-range":new pt(ft.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new It(ft.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new It(ft.layout_symbol["icon-text-fit-padding"]),"icon-image":new It(ft.layout_symbol["icon-image"]),"icon-image-use-theme":new pt({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new It(ft.layout_symbol["icon-rotate"]),"icon-padding":new pt(ft.layout_symbol["icon-padding"]),"icon-keep-upright":new pt(ft.layout_symbol["icon-keep-upright"]),"icon-offset":new It(ft.layout_symbol["icon-offset"]),"icon-anchor":new It(ft.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new pt(ft.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new pt(ft.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new pt(ft.layout_symbol["text-rotation-alignment"]),"text-field":new It(ft.layout_symbol["text-field"]),"text-font":new It(ft.layout_symbol["text-font"]),"text-size":new It(ft.layout_symbol["text-size"]),"text-size-scale-range":new pt(ft.layout_symbol["text-size-scale-range"]),"text-max-width":new It(ft.layout_symbol["text-max-width"]),"text-line-height":new It(ft.layout_symbol["text-line-height"]),"text-letter-spacing":new It(ft.layout_symbol["text-letter-spacing"]),"text-justify":new It(ft.layout_symbol["text-justify"]),"text-radial-offset":new It(ft.layout_symbol["text-radial-offset"]),"text-variable-anchor":new pt(ft.layout_symbol["text-variable-anchor"]),"text-anchor":new It(ft.layout_symbol["text-anchor"]),"text-max-angle":new pt(ft.layout_symbol["text-max-angle"]),"text-writing-mode":new pt(ft.layout_symbol["text-writing-mode"]),"text-rotate":new It(ft.layout_symbol["text-rotate"]),"text-padding":new pt(ft.layout_symbol["text-padding"]),"text-keep-upright":new pt(ft.layout_symbol["text-keep-upright"]),"text-transform":new It(ft.layout_symbol["text-transform"]),"text-offset":new It(ft.layout_symbol["text-offset"]),"text-allow-overlap":new pt(ft.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new pt(ft.layout_symbol["text-ignore-placement"]),"text-optional":new pt(ft.layout_symbol["text-optional"]),visibility:new pt(ft.layout_symbol.visibility)})),paint:Yv||(Yv=new Wt({"icon-opacity":new It(ft.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new It(ft.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new It(ft.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new It(ft.paint_symbol["text-emissive-strength"]),"icon-color":new It(ft.paint_symbol["icon-color"]),"icon-halo-color":new It(ft.paint_symbol["icon-halo-color"]),"icon-halo-width":new It(ft.paint_symbol["icon-halo-width"]),"icon-halo-blur":new It(ft.paint_symbol["icon-halo-blur"]),"icon-translate":new pt(ft.paint_symbol["icon-translate"]),"icon-translate-anchor":new pt(ft.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new pt(ft.paint_symbol["icon-image-cross-fade"]),"text-opacity":new It(ft.paint_symbol["text-opacity"]),"text-occlusion-opacity":new It(ft.paint_symbol["text-occlusion-opacity"]),"text-color":new It(ft.paint_symbol["text-color"],{runtimeType:il,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new It(ft.paint_symbol["text-halo-color"]),"text-halo-width":new It(ft.paint_symbol["text-halo-width"]),"text-halo-blur":new It(ft.paint_symbol["text-halo-blur"]),"text-translate":new pt(ft.paint_symbol["text-translate"]),"text-translate-anchor":new pt(ft.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new pt(ft.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new pt(ft.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new pt(ft.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new pt(ft.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new It(ft.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},kx);class F0 extends io{constructor(t,r,l,u){super(t,Fx(),r,l,u,t.layout?t.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=Re([]),this.hasOcclusionOpacityProperties=t.paint!==void 0&&("icon-occlusion-opacity"in t.paint||"text-occlusion-opacity"in t.paint)}_handleSpecialPaintPropertyUpdate(t){t!=="icon-occlusion-opacity"&&t!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(t,r){super.recalculate(t,r),this.appearances&&this.appearances.forEach(u=>{u.recalculate(t,r,this.iconImageUseTheme)}),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const l=this.layout.get("text-writing-mode");if(l){const u=[];for(const m of l)u.indexOf(m)<0&&u.push(m);this.layout._values["text-writing-mode"]=u}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(t,r,l,u){return this._saturation===t&&this._contrast===r&&this._brightnessMin===l&&this._brightnessMax===u||(this._colorAdjustmentMatrix=function(m,_,b,E){m=to(m),_=Wn(_);const P=xr(),R=m/3,F=1-2*R,O=[F,R,R,0,R,F,R,0,R,R,F,0,0,0,0,1],$=.5-.5*_,q=E-b;return pr(P,[q,0,0,0,0,q,0,0,0,0,q,0,b,b,b,1],[_,0,0,0,0,_,0,0,0,0,_,0,$,$,$,1]),pr(P,P,O),P}(t,r,l,u),this._saturation=t,this._contrast=r,this._brightnessMin=l,this._brightnessMax=u),this._colorAdjustmentMatrix}getValueAndResolveTokens(t,r,l,u){const m=this.layout.get(t).evaluate(r,{},l,u),_=this._unevaluatedLayout._values[t];return _.isDataDriven()||Xh(_.value)||!m?m:Wv(r.properties,m)}getAppearanceValueAndResolveTokens(t,r,l,u,m){const _=t.getProperty(r);if(!_)return;const b=_.evaluate(l,{},u,m),E=t.getUnevaluatedProperties()._values[r];return E.isDataDriven()||Xh(E.value)||!b||typeof b!="string"?b:Wv(l.properties,b)}createBucket(t){return new k0(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of Fx().paint.overridableProperties){if(!F0.hasPaintOverride(this.layout,t))continue;const r=this.paint.get(t),l=new Jv(r),u=new Or(l,r.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let m=null;m=r.value.kind==="constant"||r.value.kind==="source"?new hh("source",u):new _s("composite",u,r.value.zoomStops,r.value.interpolationType),this.paint._values[t]=new dt(r.property,m,r.parameters)}}_handleOverridablePaintPropertyUpdate(t,r,l){return!(!this.layout||r.isDataDriven()||l.isDataDriven())&&F0.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,r){const l=t.get("text-field"),u=Fx().paint.properties[r];let m=!1;const _=b=>{for(const E of b)if(u.overrides&&u.overrides.hasOverride(E))return void(m=!0)};if(l.value.kind==="constant"&&l.value.value instanceof Ts)_(l.value.value.sections);else if(l.value.kind==="source"){const b=P=>{m||(P instanceof Lc&&gs(P.value)===Dc?_(P.value.sections):P instanceof Fl?_(P.sections):P.eachChild(b))},E=l.value;E._styleExpression&&b(E._styleExpression.expression)}return m}getProgramIds(){return["symbol"]}getDefaultProgramParams(t,r,l){return{config:new Cu(this,{zoom:r,lut:l}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let Kv,Qv,t1,e1;var Bx=Er([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function B0(n,t,r,l,u,m,_,b){const E=[n,t,1,r,l,1,u,m,1],P=[_,b,1],R=cn([],E),[F,O,$]=ho(P,P,R);return Rr(E,E,[F,0,0,0,O,0,0,0,$])}function i1(n,t,r,l,u,m,_,b){const E=function(P,R,F,O,$,q,Y,it){const at=B0(0,0,1,0,1,1,0,1),gt=B0(P,R,F,O,$,q,Y,it);return Rr(gt,gt,cn([],at))}(n,t,r,l,u,m,_,b);return[E[2]/E[8]/ri,E[5]/E[8]/ri]}function O0(n){return[n[0],Math.min(Math.max(n[1],-Ct),Ct)]}class r1 extends Rl{constructor(t,r,l,u){super(),this.id=t,this.dispatcher=l,this.coordinates=r.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(u),this.options=r,this._dirty=!1}load(t,r){if(this._loaded=r||!1,this.fire(new Sa("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return t&&(this.coordinates=t),this._loaded=!0,void this._finishLoading();this._imageRequest=Ra(this.map._requestManager.transformRequest(this.url,Ds.Image),(l,u)=>{this._imageRequest=null,this._loaded=!0,l?this.fire(new cc(l)):u&&(this.image=u instanceof HTMLImageElement?Qa.getImageData(u):u,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),this._finishLoading())})}loaded(){return this._loaded}updateImage(t){return t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}setTexture(t){if(!(t.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new ut(this.map.painter.context,t.handle),this.width=t.dimensions[0],this.height=t.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Sa("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(t){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof ut||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(t){if(this.coordinates=t,this._boundsArray=void 0,this._unsupportedCoords=!1,!t.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let r=t[0][1],l=t[0][1];for(const m of t)m[1]>l&&(l=m[1]),m[1]<r&&(r=m[1]);const u=(l+r)/2;if(u>Ct?this.onNorthPole=!0:u<-Ct&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const m=t.map(pe.fromLngLat);this.tileID=function(_){let b=1/0,E=1/0,P=-1/0,R=-1/0;for(const Y of _)b=Math.min(b,Y.x),E=Math.min(E,Y.y),P=Math.max(P,Y.x),R=Math.max(R,Y.y);const F=Math.max(P-b,R-E),O=Math.max(0,Math.floor(-Math.log2(F))),$=Math.pow(2,O);let q=Math.floor((b+P)/2*$);return q>1&&(q-=1),new wc(O,q,Math.floor((E+R)/2*$))}(m),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Sa("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof ut||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(t){for(const at in this.tiles){const gt=this.tiles[at];gt.state!=="loaded"&&(gt.state="loaded",gt.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const r=fy(new wc(0,0,0),this.map.transform.projection),l=[r.projection.project(this.coordinates[0][0],this.coordinates[0][1]),r.projection.project(this.coordinates[1][0],this.coordinates[1][1]),r.projection.project(this.coordinates[2][0],this.coordinates[2][1]),r.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(at){const gt=at[1].x-at[0].x,yt=at[1].y-at[0].y,At=at[2].x-at[1].x,Gt=at[2].y-at[1].y,kt=at[3].x-at[2].x,Xt=at[3].y-at[2].y,te=at[0].x-at[3].x,ne=at[0].y-at[3].y,ze=gt*Gt-At*yt,fe=At*Xt-kt*Gt,ke=kt*ne-te*Xt,Ue=te*yt-gt*ne;return ze>0&&fe>0&&ke>0&&Ue>0||ze<0&&fe<0&&ke<0&&Ue<0}(l))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const u=fy(this.tileID,this.map.transform.projection),[m,_,b,E]=this.coordinates.map(at=>{const gt=u.projection.project(at[0],at[1]);return jv(u,gt)._round()});this.perspectiveTransform=i1(m.x,m.y,_.x,_.y,b.x,b.y,E.x,E.y);const P=this._boundsArray=new tc;P.emplaceBack(m.x,m.y,0,0),P.emplaceBack(_.x,_.y,ri,0),P.emplaceBack(E.x,E.y,0,ri),P.emplaceBack(b.x,b.y,ri,ri),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=t.createVertexBuffer(P,Bx.members),this.boundsSegments=To.simpleSegment(0,0,4,2);const R=[],F=[O0((O=this.coordinates)[0]),O0(O[1]),O0(O[2]),O0(O[3])];var O;const[$,q,Y,it]=function(at){let gt=at[0][0],yt=gt,At=at[0][1],Gt=At;for(let kt=1;kt<at.length;kt++)at[kt][0]<gt?gt=at[kt][0]:at[kt][0]>yt&&(yt=at[kt][0]),at[kt][1]<At?At=at[kt][1]:at[kt][1]>Gt&&(Gt=at[kt][1]);return[gt,At,yt-gt,Gt-At]}(F);{const at=new tc,[gt,yt,At,Gt]=function(je){let Ye=je[0].x,Pe=Ye,Ie=je[0].y,He=Ie;for(let ai=1;ai<je.length;ai++)je[ai].x<Ye?Ye=je[ai].x:je[ai].x>Pe&&(Pe=je[ai].x),je[ai].y<Ie?Ie=je[ai].y:je[ai].y>He&&(He=je[ai].y);return[Ye,Ie,Pe-Ye,He-Ie]}(l),kt=je=>[(je.x-gt)/At,(je.y-yt)/Gt],[Xt,te,ne,ze]=l.map(kt),fe=function(je,Ye,Pe,Ie,He,ai,Ge,Pi){const Bi=B0(0,0,1,0,1,1,0,1);return Rr(Bi,Bi,cn([],B0(je,Ye,Pe,Ie,He,ai,Ge,Pi)))}(Xt[0],Xt[1],te[0],te[1],ne[0],ne[1],ze[0],ze[1]);this.elevatedGlobePerspectiveTransform=i1(Xt[0],Xt[1],te[0],te[1],ne[0],ne[1],ze[0],ze[1]);const ke=(je,Ye)=>{R.push(je.lng);const Pe=Math.round((je.lng-$)/Y*ri),Ie=Math.round((je.lat-q)/it*ri),He=kt(Ye),ai=ho([],[He[0],He[1],1],fe),Ge=Math.round(ai[0]/ai[2]*ri),Pi=Math.round(ai[1]/ai[2]*ri);at.emplaceBack(Pe,Ie,Ge,Pi)},Ue=l[3].x-l[0].x,Ze=l[3].y-l[0].y,hi=l[2].x-l[1].x,Ke=l[2].y-l[1].y;for(let je=0;je<65;je++){const Ye=je/64,Pe=[l[0].x+Ye*Ue,l[0].y+Ye*Ze],Ie=[l[1].x+Ye*hi,l[1].y+Ye*Ke],He=Ie[0]-Pe[0],ai=Ie[1]-Pe[1];for(let Ge=0;Ge<65;Ge++){const Pi=Ge/64,Bi={x:Pe[0]+He*Pi,y:Pe[1]+ai*Pi};ke(r.projection.unproject(Bi.x,Bi.y),Bi)}}this.elevatedGlobeVertexBuffer=t.createVertexBuffer(at,Bx.members)}{this.maxLongitudeTriangleSize=0;let at=[],gt=new ro;const yt=(At,Gt,kt)=>{gt.emplaceBack(At,Gt,kt);const Xt=R[At],te=R[Gt],ne=R[kt],ze=Math.min(Math.min(Xt,te),ne),fe=Math.max(Math.max(Xt,te),ne)-ze;fe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=fe),at.push(ze+fe/2)};for(let At=0;At<64;At++)for(let Gt=0;Gt<64;Gt++){const kt=65*At+Gt,Xt=kt+1,te=kt+65,ne=te+1;yt(kt,te,Xt),yt(Xt,te,ne)}[at,gt]=function(At,Gt){const kt=Array.from({length:At.length},(ne,ze)=>ze);kt.sort((ne,ze)=>At[ne]-At[ze]);const Xt=[],te=new ro;for(let ne=0;ne<kt.length;ne++){const ze=kt[ne];Xt.push(At[ze]);const fe=3*ze,ke=fe+1;te.emplaceBack(Gt.uint16[fe],Gt.uint16[ke],Gt.uint16[ke+1])}return[Xt,te]}(at,gt),this.elevatedGlobeTrianglesCenterLongitudes=at,this.elevatedGlobeIndexBuffer=t.createIndexBuffer(gt)}this.elevatedGlobeSegments=To.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,Y/ri,0,it/ri,0,0,q,$,0])}prepare(){const t=Object.keys(this.tiles).length!==0;if(this.tileID&&!t)return;const r=this.map.painter.context,l=r.gl;!this._dirty||this.texture instanceof ut||(this.texture?this.texture.update(this.image):(this.texture=new ct(r,this.image,l.RGBA8),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE)),this._dirty=!1),t&&this._prepareData(r)}loadTile(t,r){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},r(null)):(t.state="errored",r(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(t){const r=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!r)return null;const l=this.elevatedGlobeTrianglesCenterLongitudes;let u=(m=t+180)+360*Math.round((l[0]-m)/360);var m;const _=new To,b=(F,O)=>{_.segments.push({vertexOffset:0,primitiveOffset:F,vertexLength:r.segments[0].vertexLength,primitiveLength:O,sortKey:void 0,vaos:{}})},E=.51*this.maxLongitudeTriangleSize;if(Math.abs(l[0]-u)<=E){const F=Ur(l,0,l.length,u+E);return F===l.length||b(F,gn(l,F+1,l.length,u+360-E)-F),_}u<l[0]&&(u+=360);const P=gn(l,0,l.length,u-E);if(P===l.length)return b(0,l.length),_;b(0,P-0);const R=Ur(l,P+1,l.length,u+E);return R!==l.length&&b(R,l.length-R),_}}const Cw=(Math.pow(256,2)-1)/16907520;class n1 extends io{constructor(t,r,l,u){super(t,{layout:t1||(t1=new Wt({visibility:new pt(ft.layout_raster.visibility)})),paint:e1||(e1=new Wt({"raster-opacity":new pt(ft.paint_raster["raster-opacity"]),"raster-color":new Kt(ft.paint_raster["raster-color"]),"raster-color-mix":new pt(ft.paint_raster["raster-color-mix"]),"raster-color-range":new pt(ft.paint_raster["raster-color-range"]),"raster-hue-rotate":new pt(ft.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new pt(ft.paint_raster["raster-brightness-min"]),"raster-brightness-max":new pt(ft.paint_raster["raster-brightness-max"]),"raster-saturation":new pt(ft.paint_raster["raster-saturation"]),"raster-contrast":new pt(ft.paint_raster["raster-contrast"]),"raster-resampling":new pt(ft.paint_raster["raster-resampling"]),"raster-fade-duration":new pt(ft.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new pt(ft.paint_raster["raster-emissive-strength"]),"raster-array-band":new pt(ft.paint_raster["raster-array-band"]),"raster-elevation":new pt(ft.paint_raster["raster-elevation"]),"raster-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},r,l,u),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(t){return!(t&&t._source instanceof r1&&(t._source.onNorthPole||t._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(t){t!=="raster-color"&&t!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(t){if(!this.hasColorMap()||!this._curRampRange)return;const r=this._transitionablePaint._values["raster-color"].value.expression,[l,u]=t||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(l)&&isNaN(u)||l===this._curRampRange[0]&&u===this._curRampRange[1]||(this.colorRamp=sm({expression:r,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:l,end:u}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[l,u])}}let o1,s1,a1,l1,c1;class h1 extends io{constructor(t,r,l,u){super(t,{layout:o1||(o1=new Wt({visibility:new pt(ft["layout_raster-particle"].visibility)})),paint:s1||(s1=new Wt({"raster-particle-array-band":new pt(ft["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new pt(ft["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Kt(ft["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new pt(ft["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new pt(ft["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new pt(ft["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new pt(ft["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new pt(ft["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},r,l,u),this._updateColorRamp(),this.lastInvalidatedAt=Qa.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(t){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(t){return!1}_handleSpecialPaintPropertyUpdate(t){t!=="raster-particle-color"&&t!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),t==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const t=this._transitionablePaint._values["raster-particle-color"].value.expression,r=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=sm({expression:t,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:r}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Qa.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class Dw extends io{constructor(t,r){super(t,{},r,null),this.implementation=t,t.slot&&(this.slot=t.slot)}is3D(t){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(t){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}function Ox(n,t,r){const l=[0,0,1],u=cl([]);return Cl(u,u,r?-ar(n)+Math.PI:ar(n)),Ml(u,u,-ar(t)),ds(l,l,u),Xi(l,l)}const u1={None:0,Model:1,Symbol:2,FillExtrusion:4};class N0{constructor(t,r,l,u){this.message=(t?`${t}: `:"")+l,u&&(this.identifier=u),r!=null&&r.__line__&&(this.line=r.__line__)}}function Nx(n,t){const r=n.indexOf("://")===-1;try{return new URL(n,r&&t?"http://example.com":void 0),!0}catch{return!1}}class d1{constructor(t,r){this.feature=t,this.instancedDataOffset=r,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class p1{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new Kf,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(t){const r=16*t,l=this.instancedDataArray.float32;let u=Math.floor(l[r+2]);const m=1.05*(l[r+2]-u);return u/=100,[l[r]%1*1.05,l[r+1]%1*1.05,m,u]}tileCoordinatesForInstance(t){const r=16*t,l=this.instancedDataArray.float32;let u=l[r+0];return u=u>ri?u-ri:u,new Ae(Math.trunc(u),Math.trunc(l[r+1]))}translationForInstance(t){const r=16*t,l=this.instancedDataArray.float32;return[l[r+4],l[r+5],l[r+6]]}rotationScaleForInstance(t){const r=16*t,l=this.instancedDataArray.float32;return[l[r+7],l[r+8],l[r+9],l[r+10],l[r+11],l[r+12],l[r+13],l[r+14],l[r+15]]}transformForInstance(t){const r=16*t,l=this.instancedDataArray.float32;return[l[r+7],l[r+8],l[r+9],l[r+4],l[r+10],l[r+11],l[r+12],l[r+5],l[r+13],l[r+14],l[r+15],l[r+6],0,0,0,1]}}class Vx{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaledZ=this.canonical.z+Math.log2(t.overscaling),this.layers=t.layers,this.layerIds=this.layers.map(r=>r.fqid),this.projection=t.projection,this.index=t.index,this.worldview=t.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=t.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(t,r){}updateAppearances(t,r,l,u){}populate(t,r,l,u){this.tileToMeter=Zt(l);const m=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:_,id:b,index:E,sourceLayerIndex:P}of t){const R=b??(_.properties&&_.properties.hasOwnProperty("id")?_.properties.id:void 0),F=Te(_,m);if(!this.layers[0]._featureFilter.filter(new D(this.zoom,{worldview:this.worldview,activeFloors:r.activeFloors}),F,l))continue;const O={id:R,sourceLayerIndex:P,index:E,geometry:m?F.geometry:Oe(_,l,u),properties:_.properties,type:_.type,patterns:{}},$=this.addFeature(O,O.geometry,F);$&&r.featureIndex.insert(_,O.geometry,E,P,this.index,this.instancesPerModel[$].instancedDataArray.length,ri/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const t=this.layers[0].modelManager,r=this.layers[0].scope;let l=0;for(const u of this.modelUris){const m=t.getModel(u,r);if(!m)continue;const _=this.instancesPerModel[u];if(_){const b=.5*tr(m.aabb.max,m.aabb.min)*_.maxScale+_.maxXYTranslationDistance,E=Math.min(ri,Math.max(b/this.tileToMeter,ri/32));l=Math.max(E,l)}}return l}update(t,r,l,u){for(const m in this.instancesPerModel){const _=this.instancesPerModel[m];for(const b in t)_.idToFeaturesIndex.hasOwnProperty(b)&&(this.evaluate(_.features[_.idToFeaturesIndex[b]],t[b],_,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let t=!1;for(const r in this.instancesPerModel){const l=this.instancesPerModel[r];for(const u of l.features){const m=this.layers[0],_=u.feature,b=this.canonical,E=m.paint.get("model-rotation").evaluate(_,{},b),P=m.paint.get("model-scale").evaluate(_,{},b),R=m.paint.get("model-translation").evaluate(_,{},b);xo(u.rotation,E)&&xo(u.scale,P)&&xo(u.translation,R)||(this.evaluate(u,u.featureStates,l,!0),t=!0)}}return t}updateReplacement(t,r,l,u){if(r.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=r.updateTime;const m=r.getReplacementRegionsForTile(t.toUnwrapped(),!0);if(Df(this.activeReplacements,m))return!1;this.activeReplacements=m;let _=!1;for(const b in this.instancesPerModel){const E=this.instancesPerModel[b],P=E.instancedDataArray;for(const R of E.features){const F=R.instancedDataOffset,O=R.instancedDataCount;for(let $=0;$<O;$++){const q=16*($+F);let Y=P.float32[q+0];const it=Y>ri;Y=it?Y-ri:Y;const at=Math.floor(Y),gt=Math.floor(P.float32[q+1]);let yt=!1;for(const At of this.activeReplacements)if(!pm(At,l,u1.Model,u)&&!(At.min.x>at||at>At.max.x||At.min.y>gt||gt>At.max.y)&&(yt=Ug(i0(at,gt,t.canonical,At.footprintTileId.canonical),At.footprint),yt))break;P.float32[q]=yt?Y+ri:Y,_=_||yt!==it}}}return _}isEmpty(){for(const t in this.instancesPerModel)if(this.instancesPerModel[t].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(t){if(!this.uploaded)for(const r in this.instancesPerModel){const l=this.instancesPerModel[r];l.instancedDataArray.length<0||l.instancedDataArray.length===0||(l.instancedDataBuffer?l.instancedDataBuffer.updateData(l.instancedDataArray):l.instancedDataBuffer=t.createVertexBuffer(l.instancedDataArray,ee.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const r in this.instancesPerModel){const l=this.instancesPerModel[r];l.instancedDataArray.length!==0&&l.instancedDataBuffer&&l.instancedDataBuffer.destroy()}const t=this.layers[0].modelManager;if(t&&this.modelUris&&this.modelsRequested)for(const r of this.modelUris)t.removeModel(r,"",!0)}addFeature(t,r,l){const u=this.layers[0],m=u.layout.get("model-id").evaluate(l,{},this.canonical);if(!m)return Hi(`modelId is not evaluated for layer ${u.id} and it is not going to get rendered.`),m;(Nx(m,!1)||this.styleDefinedModelURLs[m]!==void 0)&&(this.modelUris.includes(m)||this.modelUris.push(m)),this.instancesPerModel[m]||(this.instancesPerModel[m]=new p1);const _=this.instancesPerModel[m],b=_.instancedDataArray,E=new d1(l,b.length);for(const P of r)for(const R of P){if(R.x<0||R.x>=ri||R.y<0||R.y>=ri)continue;if(this.lookupDim!==0){const O=(this.lookupDim-1)/ri,$=this.lookupDim*(R.y*O|0)+R.x*O|0;if(this.lookup){if(this.lookup[$]!==0)continue;this.lookup[$]=1}}this.instanceCount++;const F=b.length;b.resize(F+1),_.instancesEvaluatedElevation.push(0),b.float32[16*F]=R.x,b.float32[16*F+1]=R.y}return E.instancedDataCount=_.instancedDataArray.length-E.instancedDataOffset,E.instancedDataCount>0&&(t.id&&(_.idToFeaturesIndex[t.id]=_.features.length),_.features.push(E),this.evaluate(E,{},_,!1)),m}getModelUris(){return this.modelUris}evaluate(t,r,l,u){const m=this.layers[0],_=t.feature,b=this.canonical,E=t.rotation=m.paint.get("model-rotation").evaluate(_,r,b),P=t.scale=m.paint.get("model-scale").evaluate(_,r,b),R=t.translation=m.paint.get("model-translation").evaluate(_,r,b),F=Object.assign({},m.paint.get("model-color").evaluate(_,r,b));F.a=m.paint.get("model-color-mix-intensity").evaluate(_,r,b);const O=[];this.maxVerticalOffset<R[2]&&(this.maxVerticalOffset=R[2]);const $=R[0]*R[0]+R[1]*R[1],q=$>0?Math.sqrt($):0;l.maxScale=Math.max(Math.max(l.maxScale,P[0]),Math.max(P[1],P[2])),l.maxXYTranslationDistance=Math.max(l.maxXYTranslationDistance,q),this.maxScale=Math.max(Math.max(this.maxScale,P[0]),Math.max(P[1],P[2])),$i(O,E,P);const Y=Math.round(100*F.a)+F.b/1.05;for(let it=0;it<t.instancedDataCount;++it){const at=t.instancedDataOffset+it,gt=16*at,yt=l.instancedDataArray.float32;let At=0;u&&(At=yt[gt+6]-l.instancesEvaluatedElevation[at]);const Gt=0|yt[gt+1];yt[gt]=(0|yt[gt])+F.r/1.05,yt[gt+1]=Gt+F.g/1.05,yt[gt+2]=Y,yt[gt+3]=1/(b.z>10?this.tileToMeter:Zt(b,Gt)),yt[gt+4]=R[0],yt[gt+5]=R[1],yt[gt+6]=R[2]+At,yt[gt+7]=O[0],yt[gt+8]=O[1],yt[gt+9]=O[2],yt[gt+10]=O[4],yt[gt+11]=O[5],yt[gt+12]=O[6],yt[gt+13]=O[8],yt[gt+14]=O[9],yt[gt+15]=O[10],l.instancesEvaluatedElevation[at]=R[2]}}}let f1,m1;Ei(Vx,"ModelBucket",{omit:["layers"]}),Ei(p1,"PerModelAttributes"),Ei(d1,"ModelFeature");class a_{constructor(t,r,l){this._demTile=t,this._dem=this._demTile.dem,this._scale=r,this._offset=l}static create(t,r,l){const u=l||t.findDEMTileFor(r);if(!u||!u.dem)return;const m=u.dem,_=u.tileID,b=1<<r.canonical.z-_.canonical.z;return new a_(u,m.dim/ri/b,[(r.canonical.x/b-_.canonical.x)*m.dim,(r.canonical.y/b-_.canonical.y)*m.dim])}tileCoordToPixel(t,r){const l=r*this._scale+this._offset[1];return new Ae(Math.floor(t*this._scale+this._offset[0]),Math.floor(l))}getElevationAt(t,r,l,u){const m=t*this._scale+this._offset[0],_=r*this._scale+this._offset[1],b=Math.floor(m),E=Math.floor(_),P=this._dem;return u=!!u,l?Gi(Gi(P.get(b,E,u),P.get(b,E+1,u),_-E),Gi(P.get(b+1,E,u),P.get(b+1,E+1,u),_-E),m-b):P.get(b,E,u)}getElevationAtPixel(t,r,l){return this._dem.get(t,r,!!l)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*_t(1,t)*this._dem.stride}}const Ux=new Float32Array(262144),lg=new Uint8Array(262144);function g1(n){let t=0;if(n.meshes)for(const r of n.meshes)t=Math.max(t,r.aabb.max[2]);if(n.children)for(const r of n.children)t=Math.max(t,g1(r));return t}function _1(n,t,r){if(n.meshes)for(const l of n.meshes){if(l.aabb.min[0]===1/0)continue;const u=Lr.applyTransform(l.aabb,n.globalMatrix);r.insert(t,u.min[0],u.min[1],u.max[0],u.max[1])}if(n.children)for(const l of n.children)_1(l,t,r)}const y1=["","wall","door","roof","window","lamp","logo"];class x1{constructor(t){this.node=t,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:t.id,geometry:[],properties:{height:g1(t)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Lr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let t=0;const r=new Lr([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const l of this.node.meshes)this.node.lightMeshIndex!==t&&(l.transformedAabb=Lr.applyTransformFast(l.aabb,this.node.globalMatrix),r.encapsulate(l.transformedAabb)),t++;this.aabb=r}return this.aabb}}class V0{constructor(t,r,l,u,m,_,b,E){this.id=l,this.layers=t,this.layerIds=this.layers.map(P=>P.fqid),this.stateDependentLayerIds=this.layers.filter(P=>P.isStateDependent()).map(P=>P.id),this.modelTraits|=Nr.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,u&&(this.modelTraits|=Nr.HasMapboxMeshFeatures),m&&(this.modelTraits|=Nr.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=_,this.worldview=E,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const P of r)this.nodesInfo.push(new x1(P)),_1(P,b.featureIndexArray.length,b.grid),b.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,b.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(t,r){for(const l of this.getNodesInfo()){const u=l.node;u.footprint&&r.push({footprint:u.footprint,id:t})}}updateAppearances(t,r,l,u){}update(t){const r=Object.keys(t).length!==0;if(r&&!this.stateDependentLayers.length)return;const l=r?this.stateDependentLayers:this.layers;if(!Do(t,this.states))for(const u of l)this.evaluate(u,t);this.states=structuredClone(t)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(t){if(!this.needsUpload)return;const r=this.getNodesInfo();for(const l of r){const u=l.node;this.uploaded?this.updatePbrBuffer(u):Ga(u,t,!0)}for(const l of r)Ac(l.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(t){let r=!1;if(!t.meshes)return r;for(const l of t.meshes)l.pbrBuffer&&(l.pbrBuffer.updateData(l.featureArray),r=!0);return r}needsReEvaluation(t,r,l){const u=t.transform.projectionOptions,m=t.style.getBrightness(),_=this.brightness!==m;if(!this.uploaded||this.dirty||u.name!==this.projection.name||wy(l.paint.get("model-color").value,_)||wy(l.paint.get("model-color-mix-intensity").value,_)||wy(l.paint.get("model-roughness").value,_)||wy(l.paint.get("model-emissive-strength").value,_)||wy(l.paint.get("model-height-based-emissive-strength-multiplier").value,_)){this.projection=u,this.brightness=m;const b=this.getNodesInfo();for(const E of b)E.state=null;return!0}return!1}evaluateTransform(t,r){if(t.transform.zoom===this.zoom)return;this.zoom=t.transform.zoom;const l=this.getNodesInfo(),u=this.id.canonical;for(const m of l){const _=m.feature;m.evaluatedTranslation=r.paint.get("model-translation").evaluate(_,{},u),m.evaluatedScale=r.paint.get("model-scale").evaluate(_,{},u)}}evaluate(t,r){const l=this.getNodesInfo();for(const u of l){if(!u.node.meshes)continue;const m=u.feature,_=r&&r[m.id];if(Do(_,u.state))continue;u.state=structuredClone(_);const b=u.node.meshes&&u.node.meshes[0].featureData,E=u.evaluatedColor[2],P=u.evaluatedRMEA[2],R=this.id.canonical;if(u.hasTranslucentParts=!1,b){for(let F=0;F<y1.length;F++){const O=y1[F];O.length&&(m.properties.part=O);const $=t.paint.get("model-color").evaluate(m,_,R).toPremultipliedRenderColor(null),q=t.paint.get("model-color-mix-intensity").evaluate(m,_,R);u.evaluatedColor[F]=[$.r,$.g,$.b,q],u.evaluatedRMEA[F][0]=t.paint.get("model-roughness").evaluate(m,_,R),u.evaluatedRMEA[F][2]=t.paint.get("model-emissive-strength").evaluate(m,_,R),u.evaluatedRMEA[F][3]=$.a,u.emissionHeightBasedParams[F]=t.paint.get("model-height-based-emissive-strength-multiplier").evaluate(m,_,R),!u.hasTranslucentParts&&$.a<1&&(u.hasTranslucentParts=!0)}delete m.properties.part,Lw(u,E!==u.evaluatedColor[2]||P!==u.evaluatedRMEA[2],this.modelTraits)}else u.evaluatedRMEA[0][2]=t.paint.get("model-emissive-strength").evaluate(m,_,R);u.evaluatedTranslation=t.paint.get("model-translation").evaluate(m,_,R),u.evaluatedScale=t.paint.get("model-scale").evaluate(m,_,R),this.updatePbrBuffer(u.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(t,r,l,u){const m=t.findDEMTileFor(l);if(m&&(m.tileID.canonical!==this.terrainTile||r!==this.terrainExaggeration)){if(m.dem&&m.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=m.tileID.overscaledZ;const _=a_.create(t,l,m);if(!_)return;this.modelTraits&Nr.HasMapboxMeshFeatures&&this.updateDEM(t,_,l,u);for(const b of this.getNodesInfo()){const E=b.node;if(!E.footprint||!E.footprint.vertices||!E.footprint.vertices.length)continue;const P=E.footprint.vertices;let R=_.getElevationAt(P[0].x,P[0].y,!0,!0);for(let F=1;F<P.length;F++)R=Math.min(R,_.getElevationAt(P[F].x,P[F].y,!0,!0));E.elevation=R}}this.terrainTile=m.tileID.canonical,this.terrainExaggeration=r}}updateDEM(t,r,l,u){let m=r._dem._modifiedForSources[u];if(m===void 0&&(r._dem._modifiedForSources[u]=[],m=r._dem._modifiedForSources[u]),m.includes(l.canonical))return;const _=r._dem.dim;m.push(l.canonical);let b=!1;for(const E of this.getNodesInfo()){const P=E.node;if(!P.footprint||!P.footprint.grid)continue;const R=P.footprint.grid,F=r.tileCoordToPixel(R.min.x,R.min.y),O=r.tileCoordToPixel(R.max.x,R.max.y),$=Math.min(Math.min(_-O.y,F.x),Math.min(F.y,_-O.x));if($<0)continue;const q=tt($,2,5);let Y=Math.max(0,F.x-q),it=Math.max(0,F.y-q),at=Math.min(O.x+q,_-1),gt=Math.min(O.y+q,_-1);for(let kt=it;kt<=gt;++kt)for(let Xt=Y;Xt<=at;++Xt)lg[kt*_+Xt]=255;let yt=0,At=0;for(let kt=0;kt<R.cellsY;++kt)for(let Xt=0;Xt<R.cellsX;++Xt){if(!R.cells[kt*R.cellsX+Xt])continue;const te=r.tileCoordToPixel(R.min.x+Xt/R.xScale,R.min.y+kt/R.yScale),ne=r.tileCoordToPixel(R.min.x+(Xt+1)/R.xScale,R.min.y+(kt+1)/R.yScale);for(let ze=te.y;ze<=Math.min(ne.y+1,_-1);++ze)for(let fe=te.x;fe<=Math.min(ne.x+1,_-1);++fe)lg[ze*_+fe]===255&&(lg[ze*_+fe]=0,yt+=r.getElevationAtPixel(fe,ze),At++)}const Gt=yt/At;Y=Math.max(1,F.x-q),it=Math.max(1,F.y-q),at=Math.min(O.x+q,_-2),gt=Math.min(O.y+q,_-2),b=!0;for(let kt=it;kt<=gt;++kt)for(let Xt=Y;Xt<=at;++Xt)lg[kt*_+Xt]===0&&(Ux[kt*_+Xt]=r._dem.set(Xt,kt,Gt));for(let kt=1;kt<q;++kt){Y=Math.max(1,F.x-kt),it=Math.max(1,F.y-kt),at=Math.min(O.x+kt,_-2),gt=Math.min(O.y+kt,_-2);for(let Xt=it;Xt<=gt;++Xt)for(let te=Y;te<=at;++te){const ne=Xt*_+te;if(lg[ne]===255){let ze=0,fe=0,ke=-1,Ue=-1;for(let Ze=-1;Ze<=1;++Ze)for(let hi=-1;hi<=1;++hi){const Ke=(Xt+Ze)*_+te+hi;if(lg[Ke]>=kt)continue;const je=Ux[Ke],Ye=Math.abs(je);Ye>fe&&(ze=je,fe=Ye,ke=hi,Ue=Ze)}if(fe>.1){const Ze=1-(kt+.5*Math.abs(ke*Ue))/q;let hi=r._dem.get(te,Xt)+ze*Ze;const Ke=r._dem.get(te+ke,Xt+Ue),je=r._dem.get(te-ke,Xt-Ue,!0);(hi-Ke)*(hi-je)>0&&(hi=(Ke+je)/2),Ux[ne]=r._dem.set(te,Xt,hi),lg[ne]=kt}}}}}b&&(r._demTile.needsDEMTextureUpload=!0,r._dem._timestamp=Qa.now())}setFilter(t){this.filter=t?be(t):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(t=>this.filter.filter(new D(this.id.overscaledZ,{worldview:this.worldview}),t.feature,this.id.canonical)):this.nodesInfo}destroy(){const t=this.getNodesInfo();for(const r of t)Ac(r.node),Il(r.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(t,r){if(r.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=r.updateTime;const l=r.getReplacementRegionsForTile(t.toUnwrapped());for(const u of this.getNodesInfo()){const m=u.node.footprint;u.hiddenByReplacement=!!m&&!l.find(_=>_.footprint===m)}}getHeightAtTileCoord(t,r){const l=[],u=[0,0,0],m=Re([]);for(const _ of this.getNodesInfo()){const b=_.node.meshes[0],E=b.transformedAabb;if(t<E.min[0]||r<E.min[1]||t>E.max[0]||r>E.max[1])continue;if(_.node.hidden===!0)return{height:1/0,maxHeight:_.feature.properties.height,hidden:!1,verticalScale:_.evaluatedScale[2]};Rn(m,_.node.globalMatrix),u[0]=t,u[1]=r,On(u,u,m);const P=(u[0]-b.aabb.min[0])/(b.aabb.max[0]-b.aabb.min[0])*Ar|0,R=Math.min(63,(u[1]-b.aabb.min[1])/(b.aabb.max[1]-b.aabb.min[1])*Ar|0)*Ar+Math.min(63,P),F=b.heightmap[R];if(!(F<0&&_.node.footprint))return _.hiddenByReplacement?void 0:{height:F,maxHeight:_.feature.properties.height,hidden:!1,verticalScale:_.evaluatedScale[2]};if(_.node.footprint.grid.query(new Ae(t,r),new Ae(t,r),l),l.length>0)return{height:void 0,maxHeight:_.feature.properties.height,hidden:_.hiddenByReplacement,verticalScale:_.evaluatedScale[2]}}}}function wy(n,t){return n instanceof hh&&!n.isLightConstant&&t}function zw(n,t,r,l,u,m,_,b){let E=(61440&t|(61440&t)>>4)>>8,P=(3840&t|(3840&t)>>4)>>4,R=240&t|(240&t)>>4;r[3]>0&&(E=Gi(E,255*r[0],r[3]),P=Gi(P,255*r[1],r[3]),R=Gi(R,255*r[2],r[3]));const F=E<<8|P,O=R<<8|Math.floor(255*l[3]),$=function(kt){const Xt=tt(kt,0,2);return Math.min(Math.round(.5*Xt*255),255)}(l[2])<<8|15*l[0]<<4|15*l[1],q=tt(u[0],0,1),Y=tt(u[1],0,1),it=tt(u[2],0,1),at=tt(u[3],0,1);let gt,yt,At,Gt;if(q!==Y&&_!==m&&Y!==q){const kt=_-m;yt=1/(kt*(Y-q)),At=-(m+kt*q)/(kt*(Y-q));const Xt=tt(u[4],-1,1);Gt=Math.pow(10,Xt),gt=255*it<<8|255*at}else gt=65535,yt=0,At=1,Gt=1;if(n.emplaceBack(F,O,$,gt,yt,At,Gt),b){const kt=b.length;b.clear();for(let Xt=0;Xt<kt;Xt++)b.emplaceBack(F,O,$,gt,yt,At,Gt)}}function Lw(n,t,r){const l=n.node;let u=0;const m=r&Nr.HasMeshoptCompression;for(const _ of l.meshes){if(l.lights&&l.lightMeshIndex===u||!_.featureData)continue;_.featureArray=new dd,_.featureArray.reserve(_.featureData.length);let b=t;for(const E of _.featureData){const P=m?65535&E:E>>16&65535,R=m?E>>16&65535:65535&E,F=(15&R)<8?15&R:0,O=n.evaluatedRMEA[F],$=n.evaluatedColor[F],q=n.emissionHeightBasedParams[F];let Y;if(b&&F===2&&l.lights&&(Y=new dd,Y.resize(10*l.lights.length)),zw(_.featureArray,P,$,O,q,_.aabb.min[2],_.aabb.max[2],Y),Y&&b){b=!1;const it=l.meshes[l.lightMeshIndex];it.featureArray=Y,it.featureArray._trim()}}_.featureArray._trim(),u++}}Ei(V0,"Tiled3dModelBucket",{omit:["layers"]}),Ei(x1,"Tiled3dModelFeature");const Rw=["id","tile","layer","source","sourceLayer","state"];class cg{constructor(t,r,l,u,m){this.type="Feature",this._vectorTileFeature=t,this._z=r,this._x=l,this._y=u,this.properties=t?t.properties:{},this.id=m}clone(){const t=new cg(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(t.state=Object.assign({},this.state)),this.layer&&(t.layer=Object.assign({},this.layer)),this.source&&(t.source=this.source),this.sourceLayer&&(t.sourceLayer=this.sourceLayer),t}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const r of Rw)this[r]!==void 0&&(t[r]=this[r]);return t}}class hg extends Rl{constructor(t,r,l,u){super(),this.id=t,this.type="model",this.models=[],this._loaded=!1,this._options=r,this._modelsInfo=new Map}load(){const t=[];for(const r in this._options.models){const l=this._options.models[r],u=this._modelsInfo.get(r);if(u){const m=u.model;m.position=l.position!=null?new Z(l.position[0],l.position[1]):new Z(0,0),m.orientation=l.orientation!=null?l.orientation:[0,0,0],u.modelSpec=l,hg.applyModelSpecification(m,l),m.computeBoundsAndApplyParent(),this.models.push(m)}else{const m=W(this.map._requestManager.transformRequest(l.uri,Ds.Model).url).then(_=>{if(!_)return;const b=Za(_),E=new Bn(r,l.uri,l.position,l.orientation,b);hg.applyModelSpecification(E,l),E.computeBoundsAndApplyParent(),this.models.push(E),this._modelsInfo.set(r,{modelSpec:l,model:E})}).catch(_=>{this.fire(new cc(new Error(`Could not load model ${r} from ${l.uri}: ${_.message}`)))});t.push(m)}}Promise.allSettled(t).then(()=>{this._loaded=!0,this.fire(new Sa("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(r=>{this._loaded=!0,this.fire(new cc(new Error(`Could not load models: ${r.message}`)))})}static applyModelSpecification(t,r){r.nodeOverrides&&hg.convertNodeOverrides(t,r.nodeOverrides),r.materialOverrides&&hg.convertMaterialOverrides(t,r.materialOverrides),r.nodeOverrideNames&&(t.nodeOverrideNames=[...r.nodeOverrideNames]),r.materialOverrideNames&&(t.materialOverrideNames=[...r.materialOverrideNames]),r.featureProperties&&(t.featureProperties=r.featureProperties)}static convertNodeOverrides(t,r){if(Array.isArray(r)&&r.every(l=>typeof l=="string")){t.nodeOverrideNames=[];for(const l of r)t.nodeOverrideNames.push(l)}else Object.entries(r).forEach(([l,u])=>{const m={orientation:[0,0,0]};if(u.hasOwnProperty("orientation")){const _=u.orientation;_&&(m.orientation=_)}t.nodeOverrides.set(l,m)})}static convertMaterialOverrides(t,r){if(Array.isArray(r)&&r.every(l=>typeof l=="string")){t.materialOverrideNames=[];for(const l of r)t.materialOverrideNames.push(l)}else Object.entries(r).forEach(([l,u])=>{const m={color:new Br(1,1,1),colorMix:0,emissionStrength:0,opacity:1},_=u["model-color"];_!==void 0&&(m.color.r=_[0],m.color.g=_[1],m.color.b=_[2]);const b=u["model-color-mix-intensity"];b!==void 0&&(m.colorMix=b);const E=u["model-emissive-strength"];E!==void 0&&(m.emissionStrength=E);const P=u["model-opacity"];P!==void 0&&(m.opacity=P),t.materialOverrides.set(l,m)})}onAdd(t){this.map=t,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(t,r){}serialize(){return this._options}setProperty(t,r){return!1}reload(){const t=vo(this.id,this.scope);this.map.style.clearSource(t),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(t){this.models=[];const r=new Map;for(const l in t){const u=t[l];if(this._modelsInfo.has(l)){const m=this._modelsInfo.get(l);m&&m.modelSpec.uri===u.uri&&r.set(l,m)}}this._modelsInfo=r,this._options.models=t,this._loaded=!1,this.load()}}function jx(n,t,r,l){const u=1<<n.z;t.lat=vt((l/ri+n.y)/u),t.lng=Mt((r/ri+n.x)/u)}function kw(n,t,r,l){const u=n.getNodesInfo()[t];if(!u||u.hiddenByReplacement||!u.node.meshes)return;let m=Number.MAX_VALUE;const _=u.node,b=r.tile,E=l.calculatePosMatrix(b.tileID.toUnwrapped(),l.worldSize),P=u.evaluatedScale;let R=0;l.elevation&&_.elevation&&(R=_.elevation*l.elevation.exaggeration()),$r(E,E,[(_.anchor?_.anchor[0]:0)*(P[0]-1),(_.anchor?_.anchor[1]:0)*(P[1]-1),R]),En(E,E,P);const F=r.queryGeometry,O=F.isPointQuery()?F.screenBounds:F.screenGeometry,$=function(Y){const it=pr([],E,Y.globalMatrix);pr(it,l.expandedFarZProjMatrix,it);for(let at=0;at<Y.meshes.length;++at){const gt=Y.meshes[at];if(at===Y.lightMeshIndex)continue;const yt=kr(O,l,it,gt.aabb);yt!=null&&(m=Math.min(yt,m))}if(Y.children)for(const at of Y.children)$(at)};if($(_),m===Number.MAX_VALUE)return;const q=new Z(0,0);return jx(b.tileID.canonical,q,u.node.anchor[0],u.node.anchor[1]),{intersectionZ:m,position:q,feature:u.feature}}const Fw={circle:class extends io{constructor(n,t,r,l){super(n,{layout:Du||(Du=new Wt({"circle-sort-key":new It(ft.layout_circle["circle-sort-key"]),"circle-elevation-reference":new pt(ft.layout_circle["circle-elevation-reference"]),visibility:new pt(ft.layout_circle.visibility)})),paint:jp||(jp=new Wt({"circle-radius":new It(ft.paint_circle["circle-radius"]),"circle-color":new It(ft.paint_circle["circle-color"]),"circle-blur":new It(ft.paint_circle["circle-blur"]),"circle-opacity":new It(ft.paint_circle["circle-opacity"]),"circle-translate":new pt(ft.paint_circle["circle-translate"]),"circle-translate-anchor":new pt(ft.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new pt(ft.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new pt(ft.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new It(ft.paint_circle["circle-stroke-width"]),"circle-stroke-color":new It(ft.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new It(ft.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new pt(ft.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}createBucket(n){return new So(n)}queryRadius(n){const t=n;return Ls("circle-radius",this,t)+Ls("circle-stroke-width",this,t)+go(this.paint.get("circle-translate"))}queryIntersectsFeature(n,t,r,l,u,m,_,b){const E=Up(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),P=this.paint.get("circle-radius").evaluate(t,r)+this.paint.get("circle-stroke-width").evaluate(t,r);return Dg(n,l,m,_,b,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",E,P)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,t,r){const l=E_(this);return{config:new Cu(this,{zoom:t,lut:r}),defines:l,overrideFog:!1}}is3D(n){return!n&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends io{createBucket(n){return new Vy(n)}constructor(n,t,r,l){super(n,{layout:Uy||(Uy=new Wt({visibility:new pt(ft.layout_heatmap.visibility)})),paint:jy||(jy=new Wt({"heatmap-radius":new It(ft.paint_heatmap["heatmap-radius"]),"heatmap-weight":new It(ft.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new pt(ft.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Kt(ft.paint_heatmap["heatmap-color"]),"heatmap-opacity":new pt(ft.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=sm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(n){return Ls("heatmap-radius",this,n)}queryIntersectsFeature(n,t,r,l,u,m,_,b){const E=this.paint.get("heatmap-radius").evaluate(t,r);return Dg(n,l,m,_,b,!0,!0,new Ae(0,0),E)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,t,r){return n==="heatmap"?{config:new Cu(this,{zoom:t,lut:r}),overrideFog:!1}:{}}},hillshade:class extends io{constructor(n,t,r,l){super(n,{layout:Gy||(Gy=new Wt({visibility:new pt(ft.layout_hillshade.visibility)})),paint:zg||(zg=new Wt({"hillshade-illumination-direction":new pt(ft.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new pt(ft.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new pt(ft.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new pt(ft.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new pt(ft.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new pt(ft.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new pt(ft.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,t,r){return{overrideFog:!1}}},fill:class extends io{constructor(n,t,r,l){super(n,{layout:Sl||(Sl=new Wt({"fill-sort-key":new It(ft.layout_fill["fill-sort-key"]),visibility:new pt(ft.layout_fill.visibility),"fill-elevation-reference":new pt(ft.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new It(ft.layout_fill["fill-construct-bridge-guard-rail"])})),paint:nu||(nu=new Wt({"fill-antialias":new pt(ft.paint_fill["fill-antialias"]),"fill-opacity":new It(ft.paint_fill["fill-opacity"]),"fill-color":new It(ft.paint_fill["fill-color"]),"fill-outline-color":new It(ft.paint_fill["fill-outline-color"]),"fill-translate":new pt(ft.paint_fill["fill-translate"]),"fill-translate-anchor":new pt(ft.paint_fill["fill-translate-anchor"]),"fill-pattern":new It(ft.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new pt(ft.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new pt(ft.paint_fill["fill-emissive-strength"]),"fill-z-offset":new It(ft.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new It(ft.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new It(ft.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}getProgramIds(){const n=this.paint.get("fill-pattern"),t=n&&n.constantOr(1),r=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&r.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),r}getDefaultProgramParams(n,t,r){return{config:new Cu(this,{zoom:t,lut:r}),overrideFog:!1}}recalculate(n,t){super.recalculate(n,t);const r=this.paint._values["fill-outline-color"];r.value.kind==="constant"&&r.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new Mf(n)}queryRadius(){return go(this.paint.get("fill-translate"))}queryIntersectsFeature(n,t,r,l,u,m){return!n.queryGeometry.isAboveHorizon&&jo(rc(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),l)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(n){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const t=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return n!=null?t&&!n:t}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends io{constructor(n,t,r,l){super(n,{layout:ep||(ep=new Wt({visibility:new pt(ft["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new pt(ft["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:J_||(J_=new Wt({"fill-extrusion-opacity":new pt(ft["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new It(ft["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new pt(ft["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new pt(ft["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new It(ft["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new pt(ft["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new It(ft["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new It(ft["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new pt(ft["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new pt(ft["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new pt(ft["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new pt(ft["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new pt(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new pt(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new It(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new It(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new pt(ft["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new pt(ft["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new pt(ft["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new pt(ft["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new It(ft["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new It(ft["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new pt(ft["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new bd(n)}queryRadius(){return go(this.paint.get("fill-extrusion-translate"))}is3D(n){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,t,r,l,u,m,_,b,E){const P=Up(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),R=this.paint.get("fill-extrusion-height").evaluate(t,r),F=this.paint.get("fill-extrusion-base").evaluate(t,r),O=[0,0],$=b&&m.elevation,q=m.elevation?m.elevation.exaggeration():1,Y=n.tile.getBucket(this);if($&&Y instanceof bd){const At=Y.centroidVertexArray,Gt=E+1;Gt<At.length&&(O[0]=At.geta_centroid_pos0(Gt),O[1]=At.geta_centroid_pos1(Gt))}if(O[0]===0&&O[1]===1)return!1;m.projection.name==="globe"&&(l=h0([l],[new Ae(0,0),new Ae(ri,ri)],n.tileID.canonical).map(At=>At.polygon).flat());const it=$?b:null,[at,gt]=Qm(m,l,F,R,P,_,it,O,q,m.center.lat,n.tileID.canonical),yt=n.queryGeometry;return Km(at,gt,yt.isPointQuery()?yt.screenBounds:yt.screenGeometry)}},building:class extends io{constructor(n,t,r,l){super(n,{layout:Jg||(Jg=new Wt({visibility:new pt(ft.layout_building.visibility),"building-facade":new It(ft.layout_building["building-facade"]),"building-facade-floors":new It(ft.layout_building["building-facade-floors"]),"building-facade-unit-width":new It(ft.layout_building["building-facade-unit-width"]),"building-facade-window":new It(ft.layout_building["building-facade-window"]),"building-roof-shape":new It(ft.layout_building["building-roof-shape"]),"building-height":new It(ft.layout_building["building-height"]),"building-base":new It(ft.layout_building["building-base"]),"building-flood-light-wall-radius":new It(ft.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new It(ft.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new It(ft.layout_building["building-flip-roof-orientation"])})),paint:Kg||(Kg=new Wt({"building-opacity":new pt(ft.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new pt(ft.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new pt(ft.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new pt(ft.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new pt(ft.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new pt(ft.paint_building["building-vertical-scale"]),"building-cast-shadows":new pt(ft.paint_building["building-cast-shadows"]),"building-color":new It(ft.paint_building["building-color"]),"building-emissive-strength":new It(ft.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new pt(ft.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new pt(ft.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new pt(ft.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new pt(ft.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new pt(ft.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new oy(n)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(n){return!0}queryRadius(n){return 0}queryIntersectsFeature(n,t,r,l,u,m,_,b,E){let P=this.layout.get("building-height").evaluate(t,r);const R=this.layout.get("building-base").evaluate(t,r),F=n.tile.getBucket(this).getFootprint(t);if(F){if(F.hiddenFlags!==0)return!1;P=F.height}const[O,$]=Qm(m,l,R,P,new Ae(0,0),_,null,[0,0],1,m.center.lat,n.tileID.canonical),q=n.queryGeometry;return Km(O,$,q.isPointQuery()?q.screenBounds:q.screenGeometry)}},line:class extends io{constructor(n,t,r,l){const u=Ru();super(n,u,t,r,l),u.layout&&(this.layout=new Tt(u.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof Bc,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(n,t){super.recalculate(n,t),this.paint._values["line-floorwidth"]=(()=>{if(ay)return ay;const r=Ru();return ay=new zb(r.paint.properties["line-width"].specification),ay.useIntegerZoom=!0,ay})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new vh(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,t,r){const l=tf(this);return{config:new Cu(this,{zoom:t,lut:r}),defines:l,overrideFog:!1}}queryRadius(n){const t=n,r=cv(Ls("line-width",this,t),Ls("line-gap-width",this,t)),l=Ls("line-offset",this,t);return r/2+Math.abs(l)+go(this.paint.get("line-translate"))}queryIntersectsFeature(n,t,r,l,u,m){if(n.queryGeometry.isAboveHorizon)return!1;const _=rc(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,n.pixelToTileUnitsFactor),b=n.pixelToTileUnitsFactor/2*cv(this.paint.get("line-width").evaluate(t,r),this.paint.get("line-gap-width").evaluate(t,r)),E=this.paint.get("line-offset").evaluate(t,r);return E&&(l=function(P,R){const F=[],O=new Ae(0,0);for(let $=0;$<P.length;$++){const q=P[$],Y=[];for(let it=0;it<q.length;it++){const at=q[it],gt=q[it+1],yt=it===0?O:at.sub(q[it-1])._unit()._perp(),At=it===q.length-1?O:gt.sub(at)._unit()._perp(),Gt=yt._add(At)._unit();Gt._mult(1/(Gt.x*At.x+Gt.y*At.y)),Y.push(Gt._mult(R)._add(at))}F.push(Y)}return F}(l,E*n.pixelToTileUnitsFactor)),function(P,R,F){for(let O=0;O<R.length;O++){const $=R[O];if(P.length>=3){for(let q=0;q<$.length;q++)if(qs(P,$[q]))return!0}if(Io(P,$,F))return!0}return!1}(_,l,b)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(n){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:F0,background:class extends io{constructor(n,t,r,l){super(n,{layout:Kv||(Kv=new Wt({visibility:new pt(ft.layout_background.visibility)})),paint:Qv||(Qv=new Wt({"background-pitch-alignment":new pt(ft.paint_background["background-pitch-alignment"]),"background-color":new pt(ft.paint_background["background-color"]),"background-pattern":new pt(ft.paint_background["background-pattern"]),"background-opacity":new pt(ft.paint_background["background-opacity"]),"background-emissive-strength":new pt(ft.paint_background["background-emissive-strength"]),"background-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,t,r){return{overrideFog:!1}}is3D(n){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:n1,"raster-particle":h1,sky:class extends io{constructor(n,t,r,l){super(n,{layout:a1||(a1=new Wt({visibility:new pt(ft.layout_sky.visibility)})),paint:l1||(l1=new Wt({"sky-type":new pt(ft.paint_sky["sky-type"]),"sky-atmosphere-sun":new pt(ft.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new pt(ft.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new pt(ft.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new pt(ft.paint_sky["sky-gradient-radius"]),"sky-gradient":new Kt(ft.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new pt(ft.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new pt(ft.paint_sky["sky-atmosphere-color"]),"sky-opacity":new pt(ft.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=sm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(n,t){if(this.paint.get("sky-type")==="atmosphere"){const l=this.paint.get("sky-atmosphere-sun"),u=!l,m=n.style.light,_=m.properties.get("position");return u&&m.properties.get("anchor")==="viewport"&&Hi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),u?Ox(_.azimuthal,90-_.polar,t):Ox(l[0],90-l[1],t)}const r=this.paint.get("sky-gradient-center");return Ox(r[0],90-r[1],t)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends io{constructor(n,t,r,l){super(n,{paint:c1||(c1=new Wt({}))},t,null)}},model:class extends io{constructor(n,t,r,l){super(n,{layout:f1||(f1=new Wt({visibility:new pt(ft.layout_model.visibility),"model-id":new It(ft.layout_model["model-id"])})),paint:m1||(m1=new Wt({"model-opacity":new It(ft.paint_model["model-opacity"]),"model-rotation":new It(ft.paint_model["model-rotation"]),"model-scale":new It(ft.paint_model["model-scale"]),"model-translation":new It(ft.paint_model["model-translation"]),"model-color":new It(ft.paint_model["model-color"]),"model-color-mix-intensity":new It(ft.paint_model["model-color-mix-intensity"]),"model-type":new pt(ft.paint_model["model-type"]),"model-cast-shadows":new pt(ft.paint_model["model-cast-shadows"]),"model-receive-shadows":new pt(ft.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new pt(ft.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new It(ft.paint_model["model-emissive-strength"]),"model-roughness":new It(ft.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new It(ft.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new pt(ft.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new pt(ft.paint_model["model-front-cutoff"]),"model-elevation-reference":new pt(ft.paint_model["model-elevation-reference"]),"model-color-use-theme":new It({type:"string",default:"default","property-type":"data-driven"})}))},t,r,l),this.layer=n,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new Vx(n)}getProgramIds(){return["model"]}is3D(n){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof V0?ri-1:0}queryRenderedFeatures(n,t,r){const l=t.getSource();if(!(l&&l instanceof hg))return{};const u=l,m={};m[this.id]=[];const _=m[this.id];let b=0;for(const E of u.models){const P=t.getFeatureState(this.sourceLayer,E.id),R={type:"Unknown",id:E.id,properties:E.featureProperties},F=this.paint.get("model-rotation").evaluate(R,P),O=this.paint.get("model-scale").evaluate(R,P),$=this.paint.get("model-translation").evaluate(R,P),q=this.paint.get("model-elevation-reference");let Y=[];yr(Y,E,r,E.position,F,O,$,q==="ground",q==="ground",!1),r.projection.name==="globe"&&(Y=_i(Y,r));const it=pr([],r.projMatrix,Y),at=kr(n.isPointQuery()?n.screenBounds:n.screenGeometry,r,it,E.aabb);if(at!=null){const gt=new cg(void 0,0,0,0,E.id);gt.layer=this.layer,gt.properties=structuredClone(E.featureProperties),gt.properties.layer=this.id,gt.properties.uri=E.uri,gt.properties.orientation=E.orientation,gt.sourceLayer=this.sourceLayer,gt.geometry={type:"Point",coordinates:[E.position.lng,E.position.lat]},gt.state=P,gt.source=this.source,_.push({featureIndex:b,feature:gt,intersectionZ:at})}++b}return m}queryIntersectsFeature(n,t,r,l,u,m){if(!this.modelManager)return!1;const _=this.modelManager,b=n.tile.getBucket(this);if(!(b&&b instanceof Vx))return!1;for(const E in b.instancesPerModel){const P=b.instancesPerModel[E],R=t.id!==void 0?t.id:t.properties&&t.properties.hasOwnProperty("id")?t.properties.id:void 0;if(P.idToFeaturesIndex.hasOwnProperty(R)){const F=P.features[P.idToFeaturesIndex[R]],O=_.getModel(E,this.scope);if(!O)return!1;let $=[];const q=new Z(0,0),Y=b.canonical;let it=Number.MAX_VALUE;for(let at=0;at<F.instancedDataCount;++at){const gt=16*(F.instancedDataOffset+at),yt=P.instancedDataArray.float32,At=[yt[gt+4],yt[gt+5],yt[gt+6]];jx(Y,q,Math.floor(yt[gt]),Math.floor(yt[gt+1])),yr($,O,m,q,F.rotation,F.scale,At,!1,!1,!1),m.projection.name==="globe"&&($=_i($,m));const Gt=pr([],m.projMatrix,$),kt=n.queryGeometry,Xt=kr(kt.isPointQuery()?kt.screenBounds:kt.screenGeometry,m,Gt,O.aabb);Xt!=null&&(it=Math.min(Xt,it))}return it!==Number.MAX_VALUE&&it}}return!1}_handleOverridablePaintPropertyUpdate(n,t,r){return!(!this.layout||t.isDataDriven()||r.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){const t=this._transitionablePaint._values[n];return t!=null&&t.value!=null&&t.value.expression!=null&&t.value.expression instanceof _s}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends io{constructor(n,t,r,l){super(n,{layout:xn||(xn=new Wt({"clip-layer-types":new pt(ft.layout_clip["clip-layer-types"]),"clip-layer-scope":new pt(ft.layout_clip["clip-layer-scope"])})),paint:F_||(F_=new Wt({}))},t,r,l)}recalculate(n,t){super.recalculate(n,t)}createBucket(n){return new Ky(n)}is3D(n){return!0}}},Gx=new Br(0,0,0),$x={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},qx={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},U0={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},Bw={PAINT_ORDER_FILL_AND_STROKE:1},Ty={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},v1={MASK_TYPE_LUMINANCE:1};function Ow(n,t,r){n===1&&t.icons.push(function(l,u){return function(m){if(m.usvg_tree.height||(m.usvg_tree.height=m.usvg_tree.width),!m.metadata)return m;const{metadata:_}=m;if(_.content_area){const{content_area:b}=_;b.left==null&&(b.left=0),b.top==null&&(b.top=b.left),b.width==null&&(b.width=m.usvg_tree.width),b.height==null&&(b.height=b.width)}if(_.text_placeholder){const{text_placeholder:b}=_;b.top==null&&(b.top=b.left),b.height==null&&(b.height=b.width)}return _.stretch_x&&_.stretch_x.length&&b1(_,"x"),_.stretch_y&&_.stretch_y.length&&b1(_,"y"),m}(l.readFields(Nw,{name:void 0},u))}(r,r.readVarint()+r.pos))}function b1(n,t){const r=[],l=n[`stretch_${t}`];let u=null;for(let m=0;m<l.length;m++)u===null?u=r.length===0?l[0]:r[r.length-1][1]+l[m]:(r.push([u,u+l[m]]),u=null);n[`stretch_${t}_areas`]=r}function Nw(n,t,r){n===1?t.name=r.readString():n===2?t.metadata=function(l,u){return l.readFields(Vw,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},u)}(r,r.readVarint()+r.pos):n===3&&(t.usvg_tree=function(l,u){return l.readFields(Gw,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},u)}(r,r.readVarint()+r.pos),t.data="usvg_tree")}function Vw(n,t,r){n===1?t.stretch_x=r.readPackedVarint():n===2?t.stretch_y=r.readPackedVarint():n===3?t.content_area=w1(r,r.readVarint()+r.pos):n===4?t.variables.push(function(l,u){return l.readFields(jw,{name:void 0},u)}(r,r.readVarint()+r.pos)):n===5&&(t.text_placeholder=w1(r,r.readVarint()+r.pos))}function w1(n,t){return n.readFields(Uw,{},t)}function Uw(n,t,r){n===1?t.left=r.readVarint():n===2?t.width=r.readVarint():n===3?t.top=r.readVarint():n===4&&(t.height=r.readVarint())}function jw(n,t,r){n===1?t.name=r.readString():n===2&&(t.rgb_color=$0(r.readVarint()),t.value="rgb_color")}function Gw(n,t,r){n===1?t.width=t.height=r.readVarint():n===2?t.height=r.readVarint():n===3?t.children.push(j0(r,r.readVarint()+r.pos)):n===4?t.linear_gradients.push(function(l,u){return l.readFields(Yw,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},u)}(r,r.readVarint()+r.pos)):n===5?t.radial_gradients.push(function(l,u){return l.readFields(Kw,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},u)}(r,r.readVarint()+r.pos)):n===7?t.clip_paths.push(function(l,u){return l.readFields(Qw,{children:[]},u)}(r,r.readVarint()+r.pos)):n===8&&t.masks.push(function(l,u){const m=l.readFields(tT,{left:0,width:20,mask_type:v1.MASK_TYPE_LUMINANCE,children:[]},u);return m.height==null&&(m.height=m.width),m.top==null&&(m.top=m.left),m}(r,r.readVarint()+r.pos))}function j0(n,t){return n.readFields($w,{},t)}function $w(n,t,r){n===1?(t.group=function(l,u){return l.readFields(qw,{opacity:255,children:[]},u)}(r,r.readVarint()+r.pos),t.node="group"):n===2&&(t.path=function(l,u){return l.readFields(Hw,{paint_order:1,commands:[],step:1,diffs:[],rule:$x.PATH_RULE_NON_ZERO},u)}(r,r.readVarint()+r.pos),t.node="path")}function qw(n,t,r){n===1?t.transform=G0(r,r.readVarint()+r.pos):n===2?t.opacity=r.readVarint():n===5?t.clip_path_idx=r.readVarint():n===6?t.mask_idx=r.readVarint():n===7&&t.children.push(j0(r,r.readVarint()+r.pos))}function G0(n,t){return n.readFields(Zw,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},t)}function Zw(n,t,r){n===1?t.sx=r.readFloat():n===2?t.ky=r.readFloat():n===3?t.kx=r.readFloat():n===4?t.sy=r.readFloat():n===5?t.tx=r.readFloat():n===6&&(t.ty=r.readFloat())}function Hw(n,t,r){n===1?t.fill=function(l,u){return l.readFields(Ww,{rgb_color:Gx,paint:"rgb_color",opacity:255},u)}(r,r.readVarint()+r.pos):n===2?t.stroke=function(l,u){return l.readFields(Xw,{rgb_color:Gx,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},u)}(r,r.readVarint()+r.pos):n===3?t.paint_order=r.readVarint():n===5?r.readPackedVarint(t.commands):n===6?t.step=r.readFloat():n===7?r.readPackedSVarint(t.diffs):n===8&&(t.rule=r.readVarint())}function Ww(n,t,r){n===1?(t.rgb_color=$0(r.readVarint()),t.paint="rgb_color"):n===2?(t.linear_gradient_idx=r.readVarint(),t.paint="linear_gradient_idx"):n===3?(t.radial_gradient_idx=r.readVarint(),t.paint="radial_gradient_idx"):n===5&&(t.opacity=r.readVarint())}function $0(n){return new Br((n>>16&255)/255,(n>>8&255)/255,(255&n)/255,1)}function Xw(n,t,r){n===1?(t.rgb_color=$0(r.readVarint()),t.paint="rgb_color"):n===2?(t.linear_gradient_idx=r.readVarint(),t.paint="linear_gradient_idx"):n===3?(t.radial_gradient_idx=r.readVarint(),t.paint="radial_gradient_idx"):n===5?r.readPackedFloat(t.dasharray):n===6?t.dashoffset=r.readFloat():n===7?t.miterlimit=r.readFloat():n===8?t.opacity=r.readVarint():n===9?t.width=r.readFloat():n===10?t.linecap=r.readVarint():n===11&&(t.linejoin=r.readVarint())}function Yw(n,t,r){n===1?t.transform=G0(r,r.readVarint()+r.pos):n===2?t.spread_method=r.readVarint():n===3?t.stops.push(T1(r,r.readVarint()+r.pos)):n===4?t.x1=r.readFloat():n===5?t.y1=r.readFloat():n===6?t.x2=r.readFloat():n===7&&(t.y2=r.readFloat())}function T1(n,t){return n.readFields(Jw,{offset:0,opacity:255,rgb_color:Gx},t)}function Jw(n,t,r){n===1?t.offset=r.readFloat():n===2?t.opacity=r.readVarint():n===3&&(t.rgb_color=$0(r.readVarint()))}function Kw(n,t,r){n===1?t.transform=G0(r,r.readVarint()+r.pos):n===2?t.spread_method=r.readVarint():n===3?t.stops.push(T1(r,r.readVarint()+r.pos)):n===4?t.cx=r.readFloat():n===5?t.cy=r.readFloat():n===6?t.r=r.readFloat():n===7?t.fx=r.readFloat():n===8?t.fy=r.readFloat():n===9&&(t.fr=r.readFloat())}function Qw(n,t,r){n===1?t.transform=G0(r,r.readVarint()+r.pos):n===2?t.clip_path_idx=r.readVarint():n===3&&t.children.push(j0(r,r.readVarint()+r.pos))}function tT(n,t,r){n===1?t.left=t.top=r.readFloat():n===2?t.width=t.height=r.readFloat():n===3?t.top=r.readFloat():n===4?t.height=r.readFloat():n===5?t.mask_type=r.readVarint():n===6?t.mask_idx=r.readVarint():n===7&&t.children.push(j0(r,r.readVarint()+r.pos))}class eT{static calculate(t={},r=[]){const l=new Map,u=new Map;if(Object.keys(t).length===0)return l;r.forEach(m=>{u.set(m.name,m.rgb_color||new Br(0,0,0))});for(const[m,_]of Object.entries(t))u.has(m)?l.set(u.get(m).toString(),_):console.warn(`Ignoring unknown image variable "${m}"`);return l}}function l_(n,t=255,r){const l=t/255,u=n.toString(),m=r.has(u)?r.get(u).clone():n.clone();return m.a*=l,m.toString()}function Sy(n,t){if(!za()){const r=document.createElement("canvas");return r.width=n,r.height=t,r}return new OffscreenCanvas(n,t)}function iT(n,t){const r=eT.calculate(t.params,n.metadata?n.metadata.variables:[]),l=n.usvg_tree,u=l.width,m=l.height,_=t.transform?t.transform:new DOMMatrix,b=Math.max(1,Math.round(u*_.a)),E=Math.max(1,Math.round(m*_.d)),P=new DOMMatrix([b/u,0,0,E/m,0,0]),R=Sy(b,E).getContext("2d");return Zx(R,P,l,l,r),R.getImageData(0,0,b,E)}function Zx(n,t,r,l,u){for(const m of l.children)S1(n,t,r,m,u)}function S1(n,t,r,l,u){l.group?(n.save(),function(m,_,b,E,P){const R=E.mask_idx!=null?b.masks[E.mask_idx]:null,F=E.clip_path_idx!=null?b.clip_paths[E.clip_path_idx]:null;if(E.transform&&(_=c_(E.transform).preMultiplySelf(_)),!function(q,Y,it){return q.opacity!==255||Y||it}(E,F!=null,R!=null))return void Zx(m,_,b,E,P);const O=Sy(m.canvas.width,m.canvas.height),$=O.getContext("2d");Zx($,_,b,E,P),F&&D1($,_,b,F),R&&z1($,_,b,R,P),m.globalAlpha=E.opacity/255,m.drawImage(O,0,0)}(n,t,r,l.group,u),n.restore()):l.path&&(n.save(),function(m,_,b,E,P){m.setTransform(_),E.paint_order===Bw.PAINT_ORDER_FILL_AND_STROKE?(I1(m,b,E,P),A1(m,b,E,P)):(A1(m,b,E,P),I1(m,b,E,P))}(n,t,r,l.path,u),n.restore())}function I1(n,t,r,l){const u=r.fill;if(!u)return;const m=u.opacity/255;switch(n.save(),n.beginPath(),L1(r,n),u.paint){case"rgb_color":n.fillStyle=l_(u.rgb_color,u.opacity,l);break;case"linear_gradient_idx":{const _=t.linear_gradients[u.linear_gradient_idx];_.transform&&n.setTransform(c_(_.transform).preMultiplySelf(n.getTransform())),n.fillStyle=P1(n,_,m,l);break}case"radial_gradient_idx":{const _=t.radial_gradients[u.radial_gradient_idx];_.transform&&n.setTransform(c_(_.transform).preMultiplySelf(n.getTransform())),n.fillStyle=M1(n,_,m,l)}}n.fill(E1(r)),n.restore()}function E1(n){return n.rule===$x.PATH_RULE_NON_ZERO?"nonzero":n.rule===$x.PATH_RULE_EVEN_ODD?"evenodd":void 0}function A1(n,t,r,l){const u=r.stroke;if(!u)return;const m=R1(r);n.lineWidth=u.width,n.miterLimit=u.miterlimit,n.setLineDash(u.dasharray),n.lineDashOffset=u.dashoffset;const _=u.opacity/255;switch(u.paint){case"rgb_color":n.strokeStyle=l_(u.rgb_color,u.opacity,l);break;case"linear_gradient_idx":n.strokeStyle=P1(n,t.linear_gradients[u.linear_gradient_idx],_,l,!0);break;case"radial_gradient_idx":n.strokeStyle=M1(n,t.radial_gradients[u.radial_gradient_idx],_,l,!0)}switch(u.linejoin){case U0.LINE_JOIN_MITER_CLIP:case U0.LINE_JOIN_MITER:n.lineJoin="miter";break;case U0.LINE_JOIN_ROUND:n.lineJoin="round";break;case U0.LINE_JOIN_BEVEL:n.lineJoin="bevel"}switch(u.linecap){case qx.LINE_CAP_BUTT:n.lineCap="butt";break;case qx.LINE_CAP_ROUND:n.lineCap="round";break;case qx.LINE_CAP_SQUARE:n.lineCap="square"}n.stroke(m)}function P1(n,t,r,l,u=!1){if(t.stops.length===1){const O=t.stops[0];return l_(O.rgb_color,O.opacity*r,l)}const{x1:m,y1:_,x2:b,y2:E}=t;let P=new DOMPoint(m,_),R=new DOMPoint(b,E);if(u){const O=c_(t.transform);P=O.transformPoint(P),R=O.transformPoint(R)}const F=n.createLinearGradient(P.x,P.y,R.x,R.y);for(const O of t.stops)F.addColorStop(O.offset,l_(O.rgb_color,O.opacity*r,l));return F}function M1(n,t,r,l,u=!1){if(t.stops.length===1){const at=t.stops[0];return l_(at.rgb_color,at.opacity*r,l)}const m=c_(t.transform),{fx:_,fy:b,fr:E,cx:P,cy:R,r:F}=t;let O=new DOMPoint(_,b),$=new DOMPoint(P,R),q=E,Y=F;if(u){O=m.transformPoint(O),$=m.transformPoint($);const at=(m.a+m.d)/2;q=E*at,Y=t.r*at}const it=n.createRadialGradient(O.x,O.y,q,$.x,$.y,Y);for(const at of t.stops)it.addColorStop(at.offset,l_(at.rgb_color,at.opacity*r,l));return it}function C1(n,t,r,l){const u=l.transform?c_(l.transform).preMultiplySelf(t):t,m=Sy(n.canvas.width,n.canvas.height),_=m.getContext("2d");for(const E of l.children)if(E.group)C1(_,u,r,E.group);else if(E.path){const P=E.path,R=new Path2D;R.addPath(R1(P),u),_.fill(R,E1(P))}const b=l.clip_path_idx!=null?r.clip_paths[l.clip_path_idx]:null;b&&D1(_,u,r,b),n.globalCompositeOperation="source-over",n.drawImage(m,0,0)}function D1(n,t,r,l){const u=Sy(n.canvas.width,n.canvas.height);C1(u.getContext("2d"),t,r,l),n.globalCompositeOperation="destination-in",n.drawImage(u,0,0)}function z1(n,t,r,l,u){if(l.children.length===0)return;const m=l.mask_idx!=null?r.masks[l.mask_idx]:null;m&&z1(n,t,r,m,u);const _=n.canvas.width,b=n.canvas.height,E=Sy(_,b),P=E.getContext("2d"),R=l.width,F=l.height,O=l.left,$=l.top,q=new Path2D,Y=new Path2D;Y.rect(O,$,R,F),q.addPath(Y,t),P.clip(q);for(const gt of l.children)S1(P,t,r,gt,u);const it=P.getImageData(0,0,_,b),at=it.data;if(l.mask_type===v1.MASK_TYPE_LUMINANCE)for(let gt=0;gt<at.length;gt+=4)at[gt+3]=at[gt+3]/255*(.2126*at[gt]+.7152*at[gt+1]+.0722*at[gt+2]);P.putImageData(it,0,0),n.globalCompositeOperation="destination-in",n.drawImage(E,0,0)}function c_(n){return n?new DOMMatrix([n.sx,n.ky,n.kx,n.sy,n.tx,n.ty]):new DOMMatrix}function L1(n,t){const r=n.step;let l=n.diffs[0]*r,u=n.diffs[1]*r;t.moveTo(l,u);for(let m=0,_=2;m<n.commands.length;m++)switch(n.commands[m]){case Ty.PATH_COMMAND_MOVE:l+=n.diffs[_++]*r,u+=n.diffs[_++]*r,t.moveTo(l,u);break;case Ty.PATH_COMMAND_LINE:l+=n.diffs[_++]*r,u+=n.diffs[_++]*r,t.lineTo(l,u);break;case Ty.PATH_COMMAND_QUAD:{const b=l+n.diffs[_++]*r,E=u+n.diffs[_++]*r;l=b+n.diffs[_++]*r,u=E+n.diffs[_++]*r,t.quadraticCurveTo(b,E,l,u);break}case Ty.PATH_COMMAND_CUBIC:{const b=l+n.diffs[_++]*r,E=u+n.diffs[_++]*r,P=b+n.diffs[_++]*r,R=E+n.diffs[_++]*r;l=P+n.diffs[_++]*r,u=R+n.diffs[_++]*r,t.bezierCurveTo(b,E,P,R,l,u);break}case Ty.PATH_COMMAND_CLOSE:t.closePath()}return t}function R1(n){return L1(n,new Path2D)}class q0{constructor(t){this.capacity=t,this.cache=new Map}get(t){if(!this.cache.has(t))return;const r=this.cache.get(t);return this.cache.delete(t),this.cache.set(t,r),r}put(t,r){this.cache.has(t)?this.cache.delete(t):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(t,r)}delete(t){this.cache.delete(t)}}Ei(q0,"LRUCache");class Hx{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(t){return new Ma(t,t.data)}getFromCache(t,r,l){return this.cacheMap.has(l)||this.cacheMap.set(l,new q0(150)),this.cacheMap.get(l).get(vo(t.toString(),r))}setInCache(t,r,l,u){this.cacheDependenciesMap.has(u)||this.cacheDependenciesMap.set(u,new Map),this.cacheMap.has(u)||this.cacheMap.set(u,new q0(150));const m=this.cacheDependenciesMap.get(u),_=vo(t.id.toString(),l);m.get(_)||m.set(_,new Set);const b=this.cacheMap.get(u),E=t.toString();m.get(_).add(E),b.put(vo(t.toString(),l),r)}removeImagesFromCacheByIds(t,r,l=0){if(!this.cacheMap.has(l)||!this.cacheDependenciesMap.has(l))return;const u=this.cacheMap.get(l),m=this.cacheDependenciesMap.get(l);for(const _ of t){const b=vo(_.toString(),r);if(m.has(b)){for(const E of m.get(b))u.delete(E);m.delete(b)}}}rasterize(t,r,l,u,m=iT){const _=this.getFromCache(t,l,u);if(_)return _.clone();const b=m(r.icon,t.options),E=Hx._getImage(b);return this.setInCache(t,E,l,u),E.clone()}}class k1{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,r){const l=this.toIdx(t,r);return{min:this.minimums[l],max:this.maximums[l]}}isLeaf(t,r){return this.leaves[this.toIdx(t,r)]}toIdx(t,r){return r*this.size+t}}function F1(n,t,r,l){let u=0,m=Number.MAX_VALUE;for(let _=0;_<3;_++)if(Math.abs(l[_])<1e-15){if(r[_]<n[_]||r[_]>t[_])return null}else{const b=1/l[_];let E=(n[_]-r[_])*b,P=(t[_]-r[_])*b;if(E>P){const R=E;E=P,P=R}if(E>u&&(u=E),P<m&&(m=P),u>m)return null}return u}function B1(n,t,r,l,u,m,_,b,E,P,R){const F=l-n,O=u-t,$=m-r,q=_-n,Y=b-t,it=E-r,at=R[1]*it-R[2]*Y,gt=R[2]*q-R[0]*it,yt=R[0]*Y-R[1]*q,At=F*at+O*gt+$*yt;if(Math.abs(At)<1e-15)return null;const Gt=1/At,kt=P[0]-n,Xt=P[1]-t,te=P[2]-r,ne=(kt*at+Xt*gt+te*yt)*Gt;if(ne<0||ne>1)return null;const ze=Xt*$-te*O,fe=te*F-kt*$,ke=kt*O-Xt*F,Ue=(R[0]*ze+R[1]*fe+R[2]*ke)*Gt;return Ue<0||ne+Ue>1?null:(q*ze+Y*fe+it*ke)*Gt}function O1(n,t,r){return(n-t)/(r-t)}function N1(n,t,r,l,u,m,_,b,E){const P=1<<r,R=m-l,F=_-u,O=(n+1)/P*R+l,$=(t+0)/P*F+u,q=(t+1)/P*F+u;b[0]=(n+0)/P*R+l,b[1]=$,E[0]=O,E[1]=q}class V1{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const r=function(m){const _=Math.ceil(Math.log2(m.dim/8)),b=[];let E=Math.ceil(Math.pow(2,_));const P=1/E,R=($,q,Y,it,at)=>{const gt=it?1:0,yt=($+1)*Y-gt,At=q*Y,Gt=(q+1)*Y-gt;at[0]=$*Y,at[1]=At,at[2]=yt,at[3]=Gt};let F=new k1(E);const O=[];for(let $=0;$<E*E;$++){R($%E,Math.floor($/E),P,!1,O);const q=Tm(O[0],O[1],m),Y=Tm(O[2],O[1],m),it=Tm(O[2],O[3],m),at=Tm(O[0],O[3],m);F.minimums.push(Math.min(q,Y,it,at)),F.maximums.push(Math.max(q,Y,it,at)),F.leaves.push(1)}for(b.push(F),E/=2;E>=1;E/=2){const $=b[b.length-1];F=new k1(E);for(let q=0;q<E*E;q++){R(q%E,Math.floor(q/E),2,!0,O);const Y=$.getElevation(O[0],O[1]),it=$.getElevation(O[2],O[1]),at=$.getElevation(O[2],O[3]),gt=$.getElevation(O[0],O[3]),yt=$.isLeaf(O[0],O[1]),At=$.isLeaf(O[2],O[1]),Gt=$.isLeaf(O[2],O[3]),kt=$.isLeaf(O[0],O[3]),Xt=Math.min(Y.min,it.min,at.min,gt.min),te=Math.max(Y.max,it.max,at.max,gt.max),ne=yt&&At&&Gt&&kt;F.maximums.push(te),F.minimums.push(Xt),F.leaves.push(te-Xt<=5&&ne?1:0)}b.push(F)}return b}(this.dem),l=r.length-1,u=r[l];this._addNode(u.minimums[0],u.maximums[0],u.leaves[0]),this._construct(r,0,0,l,0)}raycastRoot(t,r,l,u,m,_,b=1){return F1([t,r,-100],[l,u,this.maximums[0]*b],m,_)}raycast(t,r,l,u,m,_,b=1){if(!this.nodeCount)return null;const E=this.raycastRoot(t,r,l,u,m,_,b);if(E==null)return null;const P=[],R=[],F=[],O=[],$=[{idx:0,t:E,nodex:0,nodey:0,depth:0}];for(;$.length>0;){const{idx:q,t:Y,nodex:it,nodey:at,depth:gt}=$.pop();if(this.leaves[q]){N1(it,at,gt,t,r,l,u,F,O);const At=1<<gt,Gt=(it+0)/At,kt=(it+1)/At,Xt=(at+0)/At,te=(at+1)/At,ne=Tm(Gt,Xt,this.dem)*b,ze=Tm(kt,Xt,this.dem)*b,fe=Tm(kt,te,this.dem)*b,ke=Tm(Gt,te,this.dem)*b,Ue=B1(F[0],F[1],ne,O[0],F[1],ze,O[0],O[1],fe,m,_),Ze=B1(O[0],O[1],fe,F[0],O[1],ke,F[0],F[1],ne,m,_),hi=Math.min(Ue!==null?Ue:Number.MAX_VALUE,Ze!==null?Ze:Number.MAX_VALUE);if(hi!==Number.MAX_VALUE)return hi;{const Ke=di([],m,_,Y);if(U1(ne,ze,ke,fe,O1(Ke[0],F[0],O[0]),O1(Ke[1],F[1],O[1]))>=Ke[2])return Y}continue}let yt=0;for(let At=0;At<this._siblingOffset.length;At++){N1((it<<1)+this._siblingOffset[At][0],(at<<1)+this._siblingOffset[At][1],gt+1,t,r,l,u,F,O),F[2]=-100,O[2]=this.maximums[this.childOffsets[q]+At]*b;const Gt=F1(F,O,m,_);if(Gt!=null){const kt=Gt;P[At]=kt;let Xt=!1;for(let te=0;te<yt&&!Xt;te++)kt>=P[R[te]]&&(R.splice(te,0,At),Xt=!0);Xt||(R[yt]=At),yt++}}for(let At=0;At<yt;At++){const Gt=R[At];$.push({idx:this.childOffsets[q]+Gt,t:P[Gt],nodex:(it<<1)+this._siblingOffset[Gt][0],nodey:(at<<1)+this._siblingOffset[Gt][1],depth:gt+1})}}return null}_addNode(t,r,l){return this.minimums.push(t),this.maximums.push(r),this.leaves.push(l),this.childOffsets.push(0),this.nodeCount++}_construct(t,r,l,u,m){if(t[u].isLeaf(r,l)===1)return;this.childOffsets[m]||(this.childOffsets[m]=this.nodeCount);const _=u-1,b=t[_];let E=0,P=0;for(let R=0;R<this._siblingOffset.length;R++){const F=2*r+this._siblingOffset[R][0],O=2*l+this._siblingOffset[R][1],$=b.getElevation(F,O),q=b.isLeaf(F,O),Y=this._addNode($.min,$.max,q);q&&(E|=1<<R),P||(P=Y)}for(let R=0;R<this._siblingOffset.length;R++)E&1<<R||this._construct(t,2*r+this._siblingOffset[R][0],2*l+this._siblingOffset[R][1],_,P+R)}}function U1(n,t,r,l,u,m){return Gi(Gi(n,r,m),Gi(t,l,m),u)}function Tm(n,t,r){const l=r.dim,u=tt(n*l-.5,0,l-1),m=tt(t*l-.5,0,l-1),_=Math.floor(u),b=Math.floor(m),E=Math.min(_+1,l-1),P=Math.min(b+1,l-1);return U1(r.get(_,b),r.get(E,b),r.get(_,P),r.get(E,P),u-_,m-b)}const rT={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function nT(n,t,r){return(256*n*256+256*t+r)/10-1e4}function oT(n,t,r){return 256*n+t+r/256-32768}class Z0{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,r,l,u=!1){if(this.uid=t,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(l&&l!=="mapbox"&&l!=="terrarium")return void Hi(`"${l}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=r.height;const m=this.dim=r.height-2,_=new Uint32Array(r.data.buffer);if(this.pixels=new Uint8Array(r.data.buffer),this.floatView=new Float32Array(r.data.buffer),this.borderReady=u,this._modifiedForSources={},!u){for(let E=0;E<m;E++)_[this._idx(-1,E)]=_[this._idx(0,E)],_[this._idx(m,E)]=_[this._idx(m-1,E)],_[this._idx(E,-1)]=_[this._idx(E,0)],_[this._idx(E,m)]=_[this._idx(E,m-1)];_[this._idx(-1,-1)]=_[this._idx(0,0)],_[this._idx(m,-1)]=_[this._idx(m-1,0)],_[this._idx(-1,m)]=_[this._idx(0,m-1)],_[this._idx(m,m)]=_[this._idx(m-1,m-1)]}const b=l==="terrarium"?oT:nT;for(let E=0;E<_.length;++E){const P=4*E;this.floatView[E]=b(this.pixels[P],this.pixels[P+1],this.pixels[P+2])}this._timestamp=Qa.now()}_buildQuadTree(){this._tree=new V1(this)}get(t,r,l=!1){l&&(t=tt(t,-1,this.dim),r=tt(r,-1,this.dim));const u=this._idx(t,r);return this.floatView[u]}set(t,r,l){const u=this._idx(t,r),m=this.floatView[u];return this.floatView[u]=l,l-m}static getUnpackVector(t){return rT[t]}_idx(t,r){if(t<-1||t>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(t+1)}static pack(t,r){const l=[0,0,0,0],u=Z0.getUnpackVector(r);let m=Math.floor((t+u[3])/u[2]);return l[2]=m%256,m=Math.floor(m/256),l[1]=m%256,m=Math.floor(m/256),l[0]=m,l}getPixels(){return new P_({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,r,l){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let u=r*this.dim,m=r*this.dim+this.dim,_=l*this.dim,b=l*this.dim+this.dim;switch(r){case-1:u=m-1;break;case 1:m=u+1}switch(l){case-1:_=b-1;break;case 1:b=_+1}const E=-r*this.dim,P=-l*this.dim;for(let R=_;R<b;R++)for(let F=u;F<m;F++){const O=4*this._idx(F,R),$=4*this._idx(F+E,R+P);this.pixels[O+0]=t.pixels[$+0],this.pixels[O+1]=t.pixels[$+1],this.pixels[O+2]=t.pixels[$+2],this.pixels[O+3]=t.pixels[$+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function sT(n,t,r){n===1?t.headerLength=r.readFixed32():n===2?t.x=r.readVarint():n===3?t.y=r.readVarint():n===4?t.z=r.readVarint():n===5&&t.layers.push(function(l,u){return l.readFields(uT,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},u)}(r,r.readVarint()+r.pos))}function aT(n,t,r){n===1?(t.delta_filter=function(l,u){return l.readFields(lT,{blockSize:0},u)}(r,r.readVarint()+r.pos),t.filter="delta_filter"):n===2?(r.readVarint(),t.filter="zigzag_filter"):n===3?(r.readVarint(),t.filter="bitshuffle_filter"):n===4&&(r.readVarint(),t.filter="byteshuffle_filter")}function lT(n,t,r){n===1&&(t.blockSize=r.readVarint())}function cT(n,t,r){n===1?(r.readVarint(),t.codec="gzip_data"):n===2?(r.readVarint(),t.codec="jpeg_image"):n===3?(r.readVarint(),t.codec="webp_image"):n===4&&(r.readVarint(),t.codec="png_image")}function hT(n,t,r){let l=0,u=0;n===1?t.firstByte=r.readFixed64():n===2?t.lastByte=r.readFixed64():n===3?t.filters.push(function(m,_){return m.readFields(aT,{},_)}(r,r.readVarint()+r.pos)):n===4?t.codec=function(m,_){return m.readFields(cT,{},_)}(r,r.readVarint()+r.pos):n===5?u=r.readFloat():n===6?l=r.readFloat():n===7?t.bands.push(r.readString()):n===8?t.offset=r.readDouble():n===9&&(t.scale=r.readDouble()),t.offset===0&&(t.offset=u),t.scale===0&&(t.scale=l)}function uT(n,t,r){n===1?t.version=r.readVarint():n===2?t.name=r.readString():n===3?t.units=r.readString():n===4?t.tileSize=r.readVarint():n===5?t.buffer=r.readVarint():n===6?t.pixelFormat=r.readVarint():n===7&&t.dataIndex.push(function(l,u){return l.readFields(hT,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},u)}(r,r.readVarint()+r.pos))}function dT(n,t,r){if(n===2)(function(l,u,m){l.readFields(pT,m,u)})(r,r.readVarint()+r.pos,t);else if(n===3)throw new Error("Not implemented")}function pT(n,t,r){if(n===1){let l=0;const u=r.readVarint()+r.pos;for(;r.pos<u;)t[l++]=r.readVarint()}}function fT(n,t){if(t.length!==4)throw new Error(`Expected data of dimension 4 but got ${t.length}.`);let r=t[3];for(let l=2;l>=1;l--){const u=l===1?1:0,m=l===2?1:0;for(let _=0;_<t[0];_++){const b=t[1]*_;for(let E=u;E<t[1];E++){const P=t[2]*(E+b);for(let R=m;R<t[2];R++){const F=t[3]*(R+P);for(let O=0;O<t[3];O++){const $=F+O;n[$]+=n[$-r]}}}}r*=t[l]}return n}function mT(n){for(let t=0,r=n.length;t<r;t++)n[t]=n[t]>>>1^-(1&n[t]);return n}function gT(n,t){switch(t){case"uint32":return n;case"uint16":for(let r=0;r<n.length;r+=2){const l=n[r],u=n[r+1];n[r]=(240&l)>>4|(61440&l)>>8|(240&u)<<4|61440&u,n[r+1]=15&l|(3840&l)>>4|(15&u)<<8|(3840&u)<<4}return n;case"uint8":for(let r=0;r<n.length;r+=4){const l=n[r],u=n[r+1],m=n[r+2],_=n[r+3];n[r+0]=(192&l)>>6|(192&u)>>4|(192&m)>>2|192&_,n[r+1]=(48&l)>>4|(48&u)>>2|48&m|(48&_)<<2,n[r+2]=(12&l)>>2|12&u|(12&m)<<2|(12&_)<<4,n[r+3]=3&l|(3&u)<<2|(3&m)<<4|(3&_)<<6}return n;default:throw new Error(`Invalid pixel format, "${t}"`)}}Ei(Z0,"DEMData"),Ei(V1,"DemMinMaxQuadTree",{omit:["dem"]});var ku=Uint8Array,Iy=Uint16Array,_T=Int32Array,j1=new ku([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),G1=new ku([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),yT=new ku([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),$1=function(n,t){for(var r=new Iy(31),l=0;l<31;++l)r[l]=t+=1<<n[l-1];var u=new _T(r[30]);for(l=1;l<30;++l)for(var m=r[l];m<r[l+1];++m)u[m]=m-r[l]<<5|l;return{b:r,r:u}},q1=$1(j1,2),Z1=q1.b,xT=q1.r;Z1[28]=258,xT[258]=28;for(var vT=$1(G1,0).b,H1=new Iy(32768),ra=0;ra<32768;++ra){var h_=(43690&ra)>>1|(21845&ra)<<1;H1[ra]=((65280&(h_=(61680&(h_=(52428&h_)>>2|(13107&h_)<<2))>>4|(3855&h_)<<4))>>8|(255&h_)<<8)>>1}var Ey=function(n,t,r){for(var l=n.length,u=0,m=new Iy(t);u<l;++u)n[u]&&++m[n[u]-1];var _,b=new Iy(t);for(u=1;u<t;++u)b[u]=b[u-1]+m[u-1]<<1;_=new Iy(1<<t);var E=15-t;for(u=0;u<l;++u)if(n[u])for(var P=u<<4|n[u],R=t-n[u],F=b[n[u]-1]++<<R,O=F|(1<<R)-1;F<=O;++F)_[H1[F]>>E]=P;return _},Ay=new ku(288);for(ra=0;ra<144;++ra)Ay[ra]=8;for(ra=144;ra<256;++ra)Ay[ra]=9;for(ra=256;ra<280;++ra)Ay[ra]=7;for(ra=280;ra<288;++ra)Ay[ra]=8;var W1=new ku(32);for(ra=0;ra<32;++ra)W1[ra]=5;var bT=Ey(Ay,9),wT=Ey(W1,5),Wx=function(n){for(var t=n[0],r=1;r<n.length;++r)n[r]>t&&(t=n[r]);return t},cp=function(n,t,r){var l=t/8|0;return(n[l]|n[l+1]<<8)>>(7&t)&r},Xx=function(n,t){var r=t/8|0;return(n[r]|n[r+1]<<8|n[r+2]<<16)>>(7&t)},TT=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],hp=function(n,t,r){var l=new Error(t||TT[n]);if(l.code=n,Error.captureStackTrace&&Error.captureStackTrace(l,hp),!r)throw l;return l},ST=new ku(0),IT=typeof TextDecoder<"u"&&new TextDecoder;try{IT.decode(ST,{stream:!0})}catch{}const ET={gzip_data:"gzip"};class Sd extends Error{constructor(t){super(t),this.name="MRTError"}}const AT={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},X1={uint32:1,uint16:2,uint8:4},PT={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Yx;class H0{constructor(t=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=t}getLayer(t){const r=this.layers[t];if(!r)throw new Sd(`Layer '${t}' not found`);return r}getHeaderLength(t){const r=new Uint8Array(t),l=new DataView(t);if(r[0]!==13)throw new Sd("File is not a valid MRT.");return l.getUint32(1,!0)}parseHeader(t){const r=new Uint8Array(t),l=this.getHeaderLength(t);if(r.length<l)throw new Sd(`Expected header with length >= ${l} but got buffer of length ${r.length}`);const u=new Yx(r.subarray(0,l)).readFields(sT,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==u.x||this.y!==u.y||this.z!==u.z))throw new Sd(`Invalid attempt to parse header ${u.z}/${u.x}/${u.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=u.x,this.y=u.y,this.z=u.z;for(const m of u.layers)this.layers[m.name]=new Y1(m,{cacheSize:this._cacheSize});return this}createDecodingTask(t){const r=[],l=this.getLayer(t.layerName);for(let u of t.blockIndices){const m=l.dataIndex[u],_=m.firstByte-t.firstByte,b=m.lastByte-t.firstByte;if(l._blocksInProgress.has(u))continue;const E={layerName:l.name,firstByte:_,lastByte:b,pixelFormat:l.pixelFormat,blockIndex:u,blockShape:[m.bands.length].concat(l.bandShape),buffer:l.buffer,codec:m.codec.codec,filters:m.filters.map(P=>P.filter)};l._blocksInProgress.add(u),r.push(E)}return new J1(r,()=>{r.forEach(u=>l._blocksInProgress.delete(u.blockIndex))},(u,m)=>{if(r.forEach(_=>l._blocksInProgress.delete(_.blockIndex)),u)throw u;m.forEach(_=>{this.getLayer(_.layerName).processDecodedData(_)})})}}class Y1{constructor({version:t,name:r,units:l,tileSize:u,pixelFormat:m,buffer:_,dataIndex:b},E){if(this.version=t,this.version!==1)throw new Sd(`Cannot parse raster layer encoded with MRT version ${t}`);this.name=r,this.units=l,this.tileSize=u,this.buffer=_,this.pixelFormat=AT[m],this.dataIndex=b,this.bandShape=[u+2*_,u+2*_,X1[this.pixelFormat]],this._decodedBlocks=new q0(E?E.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return X1[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:t})=>t).flat()}processDecodedData(t){const r=t.blockIndex.toString();this._decodedBlocks.get(r)||this._decodedBlocks.put(r,t.data)}getBlockForBand(t){let r=0;switch(typeof t){case"string":for(const[l,u]of this.dataIndex.entries()){for(const[m,_]of u.bands.entries())if(_===t)return{bandIndex:r+m,blockIndex:l,blockBandIndex:m};r+=u.bands.length}break;case"number":for(const[l,u]of this.dataIndex.entries()){if(t>=r&&t<r+u.bands.length)return{bandIndex:t,blockIndex:l,blockBandIndex:t-r};r+=u.bands.length}break;default:throw new Sd(`Invalid band \`${JSON.stringify(t)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(t){let r=1/0,l=-1/0;const u=[],m=new Set;for(const _ of t){const{blockIndex:b}=this.getBlockForBand(_);if(b<0)throw new Sd(`Invalid band: ${JSON.stringify(_)}`);const E=this.dataIndex[b];u.includes(b)||u.push(b),m.add(b),r=Math.min(r,E.firstByte),l=Math.max(l,E.lastByte)}if(m.size>this.cacheSize)throw new Sd(`Number of blocks to decode (${m.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:r,lastByte:l,blockIndices:u}}hasBand(t){const{blockIndex:r}=this.getBlockForBand(t);return r>=0}hasDataForBand(t){const{blockIndex:r}=this.getBlockForBand(t);return r>=0&&!!this._decodedBlocks.get(r.toString())}getBandView(t){const{blockIndex:r,blockBandIndex:l}=this.getBlockForBand(t);if(r<0)throw new Sd(`Band not found: ${JSON.stringify(t)}`);const u=this._decodedBlocks.get(r.toString());if(!u)throw new Sd(`Data for band ${JSON.stringify(t)} of layer "${this.name}" not decoded.`);const m=this.dataIndex[r],_=this.bandShape.reduce((P,R)=>P*R,1),b=l*_,E=u.subarray(b,b+_);return{data:E,bytes:new Uint8Array(E.buffer).subarray(E.byteOffset,E.byteOffset+E.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:m.offset,scale:m.scale}}}H0.setPbf=function(n){Yx=n};class J1{constructor(t,r,l){this.tasks=t,this._onCancel=r,this._onComplete=l,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(t,r){this._finalized||(this._onComplete(t,r),this._finalized=!0)}}H0.performDecoding=function(n,t){const r=new Uint8Array(n);return Promise.all(t.tasks.map(l=>{const{layerName:u,firstByte:m,lastByte:_,pixelFormat:b,blockShape:E,blockIndex:P,filters:R,codec:F}=l,O=r.subarray(m,_+1),$=new Uint32Array(E[0]*E[1]*E[2]);let q;if(F!=="gzip_data")throw new Sd(`Unhandled codec: ${F}`);return q=function(Y,it){if(!globalThis.DecompressionStream&&it==="gzip_data")return Promise.resolve(((At=function(Xt){Xt[0]==31&&Xt[1]==139&&Xt[2]==8||hp(6,"invalid gzip data");var te=Xt[3],ne=10;4&te&&(ne+=2+(Xt[10]|Xt[11]<<8));for(var ze=(te>>3&1)+(te>>4&1);ze>0;ze-=!Xt[ne++]);return ne+(2&te)}(yt=Y))+8>yt.length&&hp(6,"invalid gzip data"),function(Xt,te,ne,ze){var fe=Xt.length;if(!fe||te.f&&!te.l)return ne||new ku(0);var ke=!ne,Ue=ke||te.i!=2,Ze=te.i;ke&&(ne=new ku(3*fe));var hi,Ke,je=function(Jo){var Eo=ne.length;if(Jo>Eo){var _o=new ku(Math.max(2*Eo,Jo));_o.set(ne),ne=_o}},Ye=te.f||0,Pe=te.p||0,Ie=te.b||0,He=te.l,ai=te.d,Ge=te.m,Pi=te.n,Bi=8*fe;do{if(!He){Ye=cp(Xt,Pe,1);var vi=cp(Xt,Pe+1,3);if(Pe+=3,!vi){var mi=Xt[(Ft=4+((Pe+7)/8|0))-4]|Xt[Ft-3]<<8,_r=Ft+mi;if(_r>fe){Ze&&hp(0);break}Ue&&je(Ie+mi),ne.set(Xt.subarray(Ft,_r),Ie),te.b=Ie+=mi,te.p=Pe=8*_r,te.f=Ye;continue}if(vi==1)He=bT,ai=wT,Ge=9,Pi=5;else if(vi==2){var yi=cp(Xt,Pe,31)+257,Yi=cp(Xt,Pe+10,15)+4,wr=yi+cp(Xt,Pe+5,31)+1;Pe+=14;for(var Vr=new ku(wr),pn=new ku(19),Tr=0;Tr<Yi;++Tr)pn[yT[Tr]]=cp(Xt,Pe+3*Tr,7);Pe+=3*Yi;var wn=Wx(pn),Tn=(1<<wn)-1,No=Ey(pn,wn);for(Tr=0;Tr<wr;){var Ft,zt=No[cp(Xt,Pe,Tn)];if(Pe+=15&zt,(Ft=zt>>4)<16)Vr[Tr++]=Ft;else{var Ne=0,pi=0;for(Ft==16?(pi=3+cp(Xt,Pe,3),Pe+=2,Ne=Vr[Tr-1]):Ft==17?(pi=3+cp(Xt,Pe,7),Pe+=3):Ft==18&&(pi=11+cp(Xt,Pe,127),Pe+=7);pi--;)Vr[Tr++]=Ne}}var Ve=Vr.subarray(0,yi),gi=Vr.subarray(yi);Ge=Wx(Ve),Pi=Wx(gi),He=Ey(Ve,Ge),ai=Ey(gi,Pi)}else hp(1);if(Pe>Bi){Ze&&hp(0);break}}Ue&&je(Ie+131072);for(var qi=(1<<Ge)-1,ji=(1<<Pi)-1,Cr=Pe;;Cr=Pe){var or=(Ne=He[Xx(Xt,Pe)&qi])>>4;if((Pe+=15&Ne)>Bi){Ze&&hp(0);break}if(Ne||hp(2),or<256)ne[Ie++]=or;else{if(or==256){Cr=Pe,He=null;break}var Ni=or-254;or>264&&(Ni=cp(Xt,Pe,(1<<(lr=j1[Tr=or-257]))-1)+Z1[Tr],Pe+=lr);var vn=ai[Xx(Xt,Pe)&ji],Yn=vn>>4;if(vn||hp(3),Pe+=15&vn,gi=vT[Yn],Yn>3){var lr=G1[Yn];gi+=Xx(Xt,Pe)&(1<<lr)-1,Pe+=lr}if(Pe>Bi){Ze&&hp(0);break}Ue&&je(Ie+131072);var ln=Ie+Ni;if(Ie<gi){var Jn=0-gi,Ln=Math.min(gi,ln);for(Jn+Ie<0&&hp(3);Ie<Ln;++Ie)ne[Ie]=(void 0)[Jn+Ie]}for(;Ie<ln;++Ie)ne[Ie]=ne[Ie-gi]}}te.l=He,te.p=Cr,te.b=Ie,te.f=Ye,He&&(Ye=1,te.m=Ge,te.d=ai,te.n=Pi)}while(!Ye);return Ie!=ne.length&&ke?(hi=ne,((Ke=Ie)==null||Ke>hi.length)&&(Ke=hi.length),new ku(hi.subarray(0,Ke))):ne.subarray(0,Ie)}(yt.subarray(At,-8),{i:2},new ku(((at=yt)[(gt=at.length)-4]|at[gt-3]<<8|at[gt-2]<<16|at[gt-1]<<24)>>>0))));var at,gt,yt,At;const Gt=ET[it];if(!Gt)throw new Error(`Unhandled codec: ${it}`);const kt=new globalThis.DecompressionStream(Gt);return new Response(new Blob([Y]).stream().pipeThrough(kt)).arrayBuffer().then(Xt=>new Uint8Array(Xt))}(O,F).then(Y=>(function(it,at){it.readFields(dT,at)}(new Yx(Y),$),new PT[b]($.buffer))),q.then(Y=>{for(let it=R.length-1;it>=0;it--)switch(R[it]){case"delta_filter":fT(Y,E);break;case"zigzag_filter":mT(Y);break;case"bitshuffle_filter":gT(Y,b);break;default:throw new Sd(`Unhandled filter "${R[it]}"`)}return{layerName:u,blockIndex:P,data:Y}}).catch(Y=>{throw Y})}))},Ei(J1,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Ei(H0,"MapboxRasterTile"),Ei(Y1,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class K1{constructor(t){this._stringToNumber={},this._numberToString=[];for(let r=0;r<t.length;r++){const l=t[r];this._stringToNumber[l]=r,this._numberToString[r]=l}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}class Q1{constructor(t,r){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new po(ri,16,0),this.featureIndexArray=new Lm,this.promoteId=r,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(t,r,l,u,m,_=0,b=0){const E=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(l,u,m,_);const P=this.grid;for(let R=0;R<r.length;R++){const F=r[R],O=[1/0,1/0,-1/0,-1/0];for(let $=0;$<F.length;$++){const q=F[$];O[0]=Math.min(O[0],q.x),O[1]=Math.min(O[1],q.y),O[2]=Math.max(O[2],q.x),O[3]=Math.max(O[3],q.y)}b!==0&&(O[0]-=b,O[1]-=b,O[2]+=b,O[3]+=b),O[0]<ri&&O[1]<ri&&O[2]>=0&&O[3]>=0&&P.insert(E,O[0],O[1],O[2],O[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Fi(new T0(this.rawTileData)).layers,this.sourceLayerCoder=new K1(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,r){const{tilespaceGeometry:l,transform:u,tileTransform:m,pixelPosMatrix:_,availableImages:b,worldview:E}=r;this.loadVTLayers(),this.serializedLayersCache.clear();const P=r.queryRadius?r.queryRadius:0,R=l.bufferedTilespaceBounds,F=this.grid.query(R.min.x,R.min.y,R.max.x,R.max.y,(Y,it,at,gt)=>mo(l.bufferedTilespaceGeometry,Y-P,it-P,at+P,gt+P));F.sort(MT);let O=null;u.elevation&&F.length>0&&(O=a_.create(u.elevation,this.tileID));const $={};let q;for(let Y=0;Y<F.length;Y++){const it=F[Y];if(it===q)continue;q=it;const at=this.featureIndexArray.get(it);let gt=null;this.is3DTile?this.loadMatchingModelFeature($,at,t,l,u,E):this.loadMatchingFeature($,at,t,b,E,(yt,At,Gt,kt=0)=>(gt||(gt=Oe(yt,this.tileID.canonical,m)),At.queryIntersectsFeature(l,yt,Gt,gt,this.z,u,_,O,kt)))}return $}loadMatchingFeature(t,r,l,u,m,_){const{featureIndex:b,bucketIndex:E,sourceLayerIndex:P,layoutVertexArrayOffset:R}=r,F=this.bucketLayerIDs[E],O=l.layers,$=Object.keys(O);if($.length&&!er($,F))return;const q=l.sourceCache,Y=this.sourceLayerCoder.decode(P),it=this.vtLayers[Y].feature(b),at=this.getId(it,Y);for(let gt=0;gt<F.length;gt++){const yt=F[gt];if(!O[yt])continue;const{styleLayer:At,targets:Gt}=O[yt];let kt={};at!==void 0&&(kt=q.getFeatureState(At.sourceLayer,at));const Xt=!_||_(it,At,kt,R);if(!Xt)continue;const te=new cg(it,this.z,this.x,this.y,at);te.tile=this.tileID.canonical,te.state=kt;let ne=this.serializedLayersCache.get(yt);ne||(ne=At.serialize(),ne.id=yt,this.serializedLayersCache.set(yt,ne)),te.source=ne.source,te.sourceLayer=ne["source-layer"],te.layer=Object.assign({},ne),te.layer.paint=tb(ne.paint,At.paint,it,kt,u),te.layer.layout=tb(ne.layout,At.layout,it,kt,u);let ze=!1;for(const fe of Gt){this.updateFeatureProperties(te,fe);const{filter:ke}=fe;if(ke){if(it.properties=te.properties,ke.needGeometry){const Ue=Te(it,!0);if(!ke.filter(new D(this.tileID.overscaledZ,{worldview:m}),Ue,this.tileID.canonical))continue}else if(!ke.filter(new D(this.tileID.overscaledZ,{worldview:m}),it))continue}ze=!0,fe.targetId&&this.addFeatureVariant(te,fe)}ze&&this.appendToResult(t,yt,b,te,Xt)}}loadMatchingModelFeature(t,r,l,u,m,_){const{featureIndex:b,bucketIndex:E}=r,P=this.bucketLayerIDs[E],R=l.layers,F=Object.keys(R);if(!F.length||er(F,P))for(let O=0;O<P.length;O++){const $=P[O],{styleLayer:q,targets:Y}=R[$];if(q.type!=="model")continue;const it=u.tile,at=it.getBucket(q);if(!(at&&at instanceof V0))continue;const gt=kw(at,b,u,m);if(!gt)continue;const{z:yt,x:At,y:Gt}=it.tileID.canonical,{feature:kt,intersectionZ:Xt,position:te}=gt;let ne={};kt.id!==void 0&&(ne=l.sourceCache.getFeatureState(q.sourceLayer,kt.id));const ze=new cg({},yt,At,Gt,kt.id);ze.tile=this.tileID.canonical,ze.state=ne,ze.properties=kt.properties,ze.geometry={type:"Point",coordinates:[te.lng,te.lat]};let fe=this.serializedLayersCache.get($);fe||(fe=q.serialize(),fe.id=$,this.serializedLayersCache.set($,fe)),ze.source=fe.source,ze.sourceLayer=fe["source-layer"],ze.layer=Object.assign({},fe);let ke=!1;for(const Ue of Y){this.updateFeatureProperties(ze,Ue);const{filter:Ze}=Ue;if(Ze){if(kt.properties=ze.properties,Ze.needGeometry){if(!Ze.filter(new D(this.tileID.overscaledZ,{worldview:_}),kt,this.tileID.canonical))continue}else if(!Ze.filter(new D(this.tileID.overscaledZ,{worldview:_}),kt))continue}ke=!0,Ue.targetId&&this.addFeatureVariant(ze,Ue)}ke&&this.appendToResult(t,$,b,ze,Xt)}}updateFeatureProperties(t,r,l){if(r.properties){const u={};for(const m in r.properties){const _=r.properties[m].evaluate({zoom:this.z},t._vectorTileFeature,t.state,t.tile,l);_!=null&&(u[m]=_)}t.properties=u}}addFeatureVariant(t,r,l){const u={target:r.target,namespace:r.namespace,uniqueFeatureID:r.uniqueFeatureID};r.properties&&(u.properties=t.properties),t.variants=t.variants||{},t.variants[r.targetId]=t.variants[r.targetId]||[],t.variants[r.targetId].push(u)}appendToResult(t,r,l,u,m){let _=t[r];_===void 0&&(_=t[r]=[]),_.push({featureIndex:l,feature:u,intersectionZ:m})}lookupSymbolFeatures(t,r,l,u,m,_){const b={};this.loadVTLayers();for(const E of t)this.loadMatchingFeature(b,{bucketIndex:r,sourceLayerIndex:l,featureIndex:E,layoutVertexArrayOffset:0},u,m,_);return b}loadFeature(t){const{featureIndex:r,sourceLayerIndex:l}=t;this.loadVTLayers();const u=this.sourceLayerCoder.decode(l),m=this.vtFeatures[u];if(m[r])return m[r];const _=this.vtLayers[u].feature(r);return m[r]=_,_}hasLayer(t){for(const r of this.bucketLayerIDs)for(const l of r)if(t===l)return!0;return!1}getId(t,r){let l=t.id;if(this.promoteId){const u=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[r];if(u!=null)if(Array.isArray(u)){if(!this.promoteIdExpression){const m=mc(u);if(m.result!=="success"){const _=m.value.map(b=>`${b.key}: ${b.message}`).join(", ");return void Hi(`Failed to create expression for promoteId: ${_}`)}this.promoteIdExpression=m.value}l=this.promoteIdExpression.evaluate({zoom:0},t)}else l=t.properties[u];typeof l=="boolean"&&(l=Number(l))}return l}}function tb(n,t,r,l,u){return ti(n,(m,_)=>{const b=t instanceof Tt?t.get(_):null;return b&&b.evaluate?b.evaluate(r,l,void 0,u):b})}function MT(n,t){return t-n}Ei(Q1,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const eb=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Jx{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,l]=new Uint8Array(t,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const u=l>>4;if(u!==1)throw new Error(`Got v${u} data when expected v1.`);const m=eb[15&l];if(!m)throw new Error("Unrecognized array type.");const[_]=new Uint16Array(t,2,1),[b]=new Uint32Array(t,4,1);return new Jx(b,_,m,t)}constructor(t,r=64,l=Float64Array,u){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=l,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const m=eb.indexOf(this.ArrayType),_=2*t*this.ArrayType.BYTES_PER_ELEMENT,b=t*this.IndexArrayType.BYTES_PER_ELEMENT,E=(8-b%8)%8;if(m<0)throw new Error(`Unexpected typed array class: ${l}.`);u&&u instanceof ArrayBuffer?(this.data=u,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+b+E,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+_+b+E),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+b+E,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+m]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=t)}add(t,r){const l=this._pos>>1;return this.ids[l]=l,this.coords[this._pos++]=t,this.coords[this._pos++]=r,l}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Kx(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,r,l,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:_,nodeSize:b}=this,E=[0,m.length-1,0],P=[];for(;E.length;){const R=E.pop()||0,F=E.pop()||0,O=E.pop()||0;if(F-O<=b){for(let it=O;it<=F;it++){const at=_[2*it],gt=_[2*it+1];at>=t&&at<=l&&gt>=r&&gt<=u&&P.push(m[it])}continue}const $=O+F>>1,q=_[2*$],Y=_[2*$+1];q>=t&&q<=l&&Y>=r&&Y<=u&&P.push(m[$]),(R===0?t<=q:r<=Y)&&(E.push(O),E.push($-1),E.push(1-R)),(R===0?l>=q:u>=Y)&&(E.push($+1),E.push(F),E.push(1-R))}return P}within(t,r,l){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:u,coords:m,nodeSize:_}=this,b=[0,u.length-1,0],E=[],P=l*l;for(;b.length;){const R=b.pop()||0,F=b.pop()||0,O=b.pop()||0;if(F-O<=_){for(let it=O;it<=F;it++)rb(m[2*it],m[2*it+1],t,r)<=P&&E.push(u[it]);continue}const $=O+F>>1,q=m[2*$],Y=m[2*$+1];rb(q,Y,t,r)<=P&&E.push(u[$]),(R===0?t-l<=q:r-l<=Y)&&(b.push(O),b.push($-1),b.push(1-R)),(R===0?t+l>=q:r+l>=Y)&&(b.push($+1),b.push(F),b.push(1-R))}return E}}function Kx(n,t,r,l,u,m){if(u-l<=r)return;const _=l+u>>1;ib(n,t,_,l,u,m),Kx(n,t,r,l,_-1,1-m),Kx(n,t,r,_+1,u,1-m)}function ib(n,t,r,l,u,m){for(;u>l;){if(u-l>600){const P=u-l+1,R=r-l+1,F=Math.log(P),O=.5*Math.exp(2*F/3),$=.5*Math.sqrt(F*O*(P-O)/P)*(R-P/2<0?-1:1);ib(n,t,r,Math.max(l,Math.floor(r-R*O/P+$)),Math.min(u,Math.floor(r+(P-R)*O/P+$)),m)}const _=t[2*r+m];let b=l,E=u;for(Py(n,t,l,r),t[2*u+m]>_&&Py(n,t,l,u);b<E;){for(Py(n,t,b,E),b++,E--;t[2*b+m]<_;)b++;for(;t[2*E+m]>_;)E--}t[2*l+m]===_?Py(n,t,l,E):(E++,Py(n,t,E,u)),E<=r&&(l=E+1),r<=E&&(u=E-1)}}function Py(n,t,r,l){Qx(n,r,l),Qx(t,2*r,2*l),Qx(t,2*r+1,2*l+1)}function Qx(n,t,r){const l=n[t];n[t]=n[r],n[r]=l}function rb(n,t,r,l){const u=n-r,m=t-l;return u*u+m*m}i.$=fp,i.A=gl,i.B=vo,i.C=2,i.D=Lf,i.E=Rl,i.F=hy,i.G=Mv,i.H=Mh,i.I=es,i.J=_e,i.K=cu,i.L=ih,i.M=Zh,i.N=wo,i.O=Su,i.P=Ae,i.Q=Xh,i.R=Ds,i.S=he,i.T=ct,i.U=mc,i.V=N0,i.W=bl,i.X=Uh,i.Y=gu,i.Z=Vh,i._=Ks,i.a=function(n){return eo.API_CDN_URL_REGEX.test(n)},i.a$=tc,i.a0=rr,i.a1=Xl,i.a2=me,i.a3=class extends N0{},i.a4=ad,i.a5=xf,i.a6=ft,i.a7=function(n){const t=n.value;return t?rr(t)?Nx(t,!0)?[]:[new N0(n.key,t,`invalid url "${t}"`)]:[new N0(n.key,t,`string expected, "${cu(t)}" found`)]:[]},i.a8=H,i.a9=Wt,i.aA=tt,i.aB=pr,i.aC=bs,i.aD=Tl,i.aE=qs,i.aF=ht,i.aG=Me,i.aH=function(n,t){const r={};for(let l=0;l<t.length;l++){const u=t[l];u in n&&(r[u]=n[u])}return r},i.aI=U,i.aJ=lt,i.aK=class{constructor(n){this.entries={},this.scheduler=n}request(n,t,r,l){const u=this.entries[n]=this.entries[n]||{callbacks:[]};if(u.result){const[m,_]=u.result;return this.scheduler?this.scheduler.add(()=>{l(m,_)},t):l(m,_),()=>{}}return u.callbacks.push(l),u.cancel||(u.cancel=r((m,_)=>{u.result=[m,_];for(const b of u.callbacks)this.scheduler?this.scheduler.add(()=>{b(m,_)},t):b(m,_);setTimeout(()=>delete this.entries[n],3e3)})),()=>{u.result||(u.callbacks=u.callbacks.filter(m=>m!==l),u.callbacks.length||(u.cancel(),delete this.entries[n]))}}},i.aL=function(n,t,r){const l=JSON.stringify(n.request);return n.data&&(this.deduped.entries[l]={result:[null,n.data]}),this.deduped.request(l,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},u=>{const m=Ll(n.request,(_,b,E)=>{_?u(_):b&&u(null,{vectorTile:r?void 0:new Fi(new T0(b)),rawData:b,responseHeaders:new Map(E.entries())})});return()=>{m.cancel(),u()}},t)},i.aM=function(n){return n?{cacheControl:n.get("Cache-Control"),expires:n.get("Expires")}:{cacheControl:void 0,expires:void 0}},i.aN=function(n){Vn++,Vn>La&&(n.getActor().send("enforceCacheSizeLimit",dl),Vn=0)},i.aO=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log2(n)))},i.aP=Zs,i.aQ=n1,i.aR=h1,i.aS=Z,i.aT=r1,i.aU=function(n,t){const r=document.createElement("video");r.muted=!0,r.onloadstart=function(){t(null,r)};for(let l=0;l<n.length;l++){const u=document.createElement("source");vr(n[l])||(r.crossOrigin="Anonymous"),u.src=n[l],r.appendChild(u)}return{cancel:()=>{}}},i.aV=ut,i.aW=hg,i.aX=xe,i.aY=fy,i.aZ=Mt,i.a_=vt,i.aa=pt,i.ab=class{constructor(n){this.specification=n}possiblyEvaluate(n,t){return Cn(n.expression.evaluate(t))}interpolate(n,t,r){return{x:Gi(n.x,t.x,r),y:Gi(n.y,t.y,r),z:Gi(n.z,t.z,r),azimuthal:Gi(n.azimuthal,t.azimuthal,r),polar:Gi(n.polar,t.polar,r)}}},i.ac=D,i.ad=_s,i.ae=pe,i.af=On,i.ag=cs,i.ah=wt,i.ai=Tt,i.aj=zu,i.ak=Gi,i.al=ri,i.am=el,i.an=ar,i.ao=Br,i.ap=class{constructor(n){this.specification=n}possiblyEvaluate(n,t){return function([r,l]){const u=Cn([1,r,l]);return{x:u.x,y:u.y,z:u.z}}(n.expression.evaluate(t))}interpolate(n,t,r){return{x:Gi(n.x,t.x,r),y:Gi(n.y,t.y,r),z:Gi(n.z,t.z,r)}}},i.aq=function(n,t,r=0,l=!0){const u=new Ae(r,r),m=n.sub(u),_=t.add(u),b=[m,new Ae(_.x,m.y),_,new Ae(m.x,_.y)];return l&&b.push(m.clone()),b},i.ar=function(n,t){const r=[];for(let l=0;l<n.length;l++){const u=Bt(l-1,-1,n.length-1),m=Bt(l+1,-1,n.length-1),_=n[l],b=n[m],E=n[u].sub(_).unit(),P=b.sub(_).unit(),R=P.angleWithSep(E.x,E.y),F=E.add(P).unit().mult(-1*t/Math.sin(R/2));r.push(_.add(F))}return r},i.as=jv,i.at=mo,i.au=function(n,t,r=0){return Kn(((t.x-r)*n.scale-n.x)*ri,(t.y*n.scale-n.y)*ri,Ut(t.z,t.y))},i.av=oo,i.aw=Xi,i.ax=Pr,i.ay=b0,i.az=function(n){let t=1/0,r=1/0,l=-1/0,u=-1/0;for(const m of n)t=Math.min(t,m.x),r=Math.min(r,m.y),l=Math.max(l,m.x),u=Math.max(u,m.y);return{min:new Ae(t,r),max:new Ae(l,u)}},i.b=function(n){return eo.API_FONTS_REGEX.test(n)},i.b$=Ug,i.b0=ro,i.b1=ye,i.b2=gg,i.b3=k0,i.b4=function(){S.isLoading()||S.isLoaded()||d()!=="deferred"||v()},i.b5=be,i.b6=Te,i.b7=cg,i.b8=Vo,i.b9=vh,i.bA=bo,i.bB=xr,i.bC=function(n,t){const{x:r,y:l}=n.point,u=Fy(r,l,n.worldSize/n._pixelsPerMercatorPixel,0,0);return pr(u,u,_d(md(t)))},i.bD=nr,i.bE=Ns,i.bF=tr,i.bG=di,i.bH=$n,i.bI=Xr,i.bJ=i_,i.bK=bh,i.bL=Ix,i.bM=function(n,t,r,l,u){const m=5*t+2;n.float32[m+0]=r,n.float32[m+1]=l,n.float32[m+2]=u},i.bN=s_,i.bO=we,i.bP=ce,i.bQ=Pt,i.bR=ci,i.bS=Bt,i.bT=function(n,t,r,l){var u=new wi(4);return u[0]=n,u[1]=t,u[2]=r,u[3]=l,u},i.bU=class{isDataAvailableAtPoint(n){const t=this._source();if(this.isUsingMockSource()||!t||n.y<0||n.y>1)return!1;const r=t.getSource().maxzoom,l=1<<r,u=Math.floor(n.x),m=Math.floor((n.x-u)*l),_=Math.floor(n.y*l),b=this.findDEMTileFor(new Zs(r,u,r,m,_));return!(!b||!b.dem)}getAtPointOrZero(n,t=0){return this.getAtPoint(n,t)||0}getAtPoint(n,t,r=!0){if(this.isUsingMockSource())return null;t==null&&(t=null);const l=this._source();if(!l||n.y<0||n.y>1)return t;const u=l.getSource().maxzoom,m=1<<u,_=Math.floor(n.x),b=n.x-_,E=new Zs(u,_,u,Math.floor(b*m),Math.floor(n.y*m)),P=this.findDEMTileFor(E);if(!P||!P.dem)return t;const R=P.dem,F=1<<P.tileID.canonical.z,O=(b*F-P.tileID.canonical.x)*R.dim,$=(n.y*F-P.tileID.canonical.y)*R.dim,q=Math.floor(O),Y=Math.floor($);return(r?this.exaggeration():1)*Gi(Gi(R.get(q,Y),R.get(q,Y+1),$-Y),Gi(R.get(q+1,Y),R.get(q+1,Y+1),$-Y),O-q)}static getAtTileOffset(n,t,r,l){const u=1<<n.canonical.z;return l?l.pointElevation(t):r?r.getAtPointOrZero(new pe(n.wrap+(n.canonical.x+t.x/ri)/u,(n.canonical.y+t.y/ri)/u)):0}static getAtTileOffsetFunc(n,t,r,l){return(u,m,_)=>{const b=this.getAtTileOffset(n,u,m,_),E=l.upVector(n.canonical,u.x,u.y);return Hn(E,E,b*l.upVectorScale(n.canonical,t,r).metersToTile),E}}getForTilePoints(n,t,r,l){if(this.isUsingMockSource())return!1;const u=a_.create(this,n,l);return!!u&&(t.forEach(m=>{m[2]=this.exaggeration()*u.getElevationAt(m[0],m[1],r)}),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;const t=this.findDEMTileFor(n);if(!t||!t.dem)return null;const r=t.dem.tree,l=t.tileID,u=1<<n.canonical.z-l.canonical.z;let m=n.canonical.x/u-l.canonical.x,_=n.canonical.y/u-l.canonical.y,b=0;for(let E=0;E<n.canonical.z-l.canonical.z&&!r.leaves[b];E++){m*=2,_*=2;const P=2*Math.floor(_)+Math.floor(m);b=r.childOffsets[b]+P,m%=1,_%=1}return{min:this.exaggeration()*r.minimums[b],max:this.exaggeration()*r.maximums[b]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,t,r){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const n=this.visibleDemTiles;if(n.length===0)return null;let t=!1,r=Number.MAX_VALUE,l=Number.MIN_VALUE;for(const u of n){const m=this.getMinMaxForTile(u.tileID);m&&(r=Math.min(r,m.min),l=Math.max(l,m.max),t=!0)}return t?{min:r,max:l}:null}},i.bV=Zg,i.bW=Yo,i.bX=Wa,i.bY=pm,i.bZ=u1,i.b_=i0,i.ba=Mf,i.bb=Oe,i.bc=As,i.bd=kp,i.be=b_,i.bf=To,i.bg=$p,i.bh=Bx,i.bi=function(n,t){const r=zu(t.zoom);if(r===0)return md(n);const l=Eg(n),u=w_(l),m=ht(l.getWest())*t.worldSize,_=ht(l.getEast())*t.worldSize,b=lt(l.getNorth())*t.worldSize,E=lt(l.getSouth())*t.worldSize,P=[m,b,0],R=[_,b,0],F=[m,E,0],O=[_,E,0],$=Rn([],t.globeMatrix);return On(P,P,$),On(R,R,$),On(F,F,$),On(O,O,$),u[0]=gd(u[0],F,r),u[1]=gd(u[1],O,r),u[2]=gd(u[2],R,r),u[3]=gd(u[3],P,r),Lr.fromPoints(u)},i.bj=iu,i.bk=Rn,i.bl=Gm,i.bm=gd,i.bn=wl,i.bo=rx,i.bp=ba,i.bq=$r,i.br=H0,i.bs=T0,i.bt=Ll,i.bu=function(n,t){const r=[];for(const l in n)l in t||r.push(l);return r},i.bv=Ht,i.bw=["type","source","source-layer","minzoom","maxzoom","filter","layout"],i.bx=Do,i.by=Ci,i.bz=Re,i.c=na,i.c$=function(n){return n*n*n*n*n},i.c0=Tx,i.c1=Fv,i.c2=Cx,i.c3=Jx,i.c4=Hn,i.c5=$l,i.c6=cl,i.c7=function(n,t,r){r*=.5;var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E+u*b,n[1]=u*E-l*b,n[2]=m*E+_*b,n[3]=_*E-m*b,n},i.c8=Ml,i.c9=ao,i.cA=_n,i.cB=ei,i.cC=wc,i.cD=ky,i.cE=function(n,t,r,l,u,m,_,b,E){if(E.name==="globe")return ky(n,t,new wc(r,l,u),!1);const P=fy({z:r,x:l,y:u},E);return new Lr([(m+P.x/P.scale)*t,t*(P.y/P.scale),_],[(m+P.x2/P.scale)*t,t*(P.y2/P.scale),b])},i.cF=function(n,t,r){return n[0]=Math.min(t[0],r[0]),n[1]=Math.min(t[1],r[1]),n[2]=Math.min(t[2],r[2]),n[3]=Math.min(t[3],r[3]),n},i.cG=function(n,t,r){return n[0]=Math.max(t[0],r[0]),n[1]=Math.max(t[1],r[1]),n[2]=Math.max(t[2],r[2]),n[3]=Math.max(t[3],r[3]),n},i.cH=function(n){const t=Math.round((n+45+360)%360/90)%4;return Zo[t]},i.cI=Ct,i.cJ=wa,i.cK=e,i.cL=function(n){const t=Re(new Float64Array(16));pr(t,n.pixelMatrix,n.globeMatrix);const r=[0,w,0],l=[0,I,0];return On(r,r,t),On(l,l,t),[r[0]>0&&r[0]<=n.width&&r[1]>0&&r[1]<=n.height&&!S_(n,new Z(n.center.lat,90)),l[0]>0&&l[0]<=n.width&&l[1]>0&&l[1]<=n.height&&!S_(n,new Z(n.center.lat,-90))]},i.cM=function(n,t){const{scale:r}=n.tileTransform,l=r*ri/(n.tileSize*Math.pow(2,t.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return function(u,m,_){var b=m[1],E=m[2],P=m[3],R=_[0],F=_[1];return u[0]=m[0]*R,u[1]=b*R,u[2]=E*F,u[3]=P*F,u}(new Float32Array(4),t.inverseAdjustmentMatrix,[l,l])},i.cN=Ii,i.cO=Ja,i.cP=Ee,i.cQ=function(n){const t=Ee(n,!0);return nr([],[t[0],t[1],t[4],t[5]])},i.cR=En,i.cS=Mn,i.cT=$o,i.cU=function(n){const{x:t,y:r}=n.point,{lng:l,lat:u}=n._center;return Fy(t,r,n.worldSize,l,u)},i.cV=Ys,i.cW=bi,i.cX=Tc,i.cY=Go,i.cZ=p,i.c_=function(n,t,r){let l=0;for(let u=0;u<2;++u)n[u]>0&&(l+=(n[u]-0)*(n[u]-0)),t[u]<0&&(l+=(0-t[u])*(0-t[u]));return l},i.ca=function(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n[3]=t[3],n},i.cb=al,i.cc=function(n,t,r,l,u){var m=1/Math.tan(t/2);if(n[0]=m/r,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=m,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,u!=null&&u!==1/0){var _=1/(l-u);n[10]=(u+l)*_,n[14]=2*u*l*_}else n[10]=-1,n[14]=-2*l;return n},i.cd=function(n,t,r,l,u,m,_){var b=1/(t-r),E=1/(l-u),P=1/(m-_);return n[0]=-2*b,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*E,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*P,n[11]=0,n[12]=(t+r)*b,n[13]=(u+l)*E,n[14]=(_+m)*P,n[15]=1,n},i.ce=_t,i.cf=function(n,t,r){n[4*t+0]=r[0],n[4*t+1]=r[1],n[4*t+2]=r[2],n[4*t+3]=r[3]},i.cg=Tf,i.ch=Wd,i.ci=ls,i.cj=tu,i.ck=Op,i.cl=Hv,i.cm=function(){var n=new wi(4);return wi!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n},i.cn=function(n,t,r){var l=t[0],u=t[1],m=t[2],_=t[3],b=Math.sin(r),E=Math.cos(r);return n[0]=l*E+m*b,n[1]=u*E+_*b,n[2]=l*-b+m*E,n[3]=u*-b+_*E,n},i.co=function(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]&&n[3]===t[3]},i.cp=xo,i.cq=function(n){var t=n[0],r=n[1],l=n[2],u=n[3];return Math.sqrt(t*t+r*r+l*l+u*u)},i.cr=Zl,i.cs=ds,i.ct=eu,i.cu=3,i.cv=2,i.cw=7,i.cx=6,i.cy=qo,i.cz=Hr,i.d=function(n){return eo.API_TILEJSON_REGEX.test(n)},i.d$=E_,i.d0=rt,i.d1=45,i.d2=Sf,i.d3=function(n,t,r){const l=Math.sqrt(n*n+t*t+r*r),u=l>0?Math.acos(r/l)*Qn:0;let m=n!==0||t!==0?Math.atan2(-t,-n)*Qn+90:0;return m<0&&(m+=360),[l,m,u]},i.d4=Kn,i.d5=Cn,i.d6=Zt,i.d7=Co,i.d8=Lr,i.d9=zn,i.dA=If,i.dB=class extends Zc{constructor(n){super(n),this.current=__}set(n,t,r){if(this.fetchUniformLocation(n,t)){for(let l=0;l<9;l++)if(r[l]!==this.current[l]){this.current=r,this.gl.uniformMatrix3fv(this.location,!1,r);break}}}},i.dC=zo,i.dD=function(n,t,r){const l=zu(r.zoom),u=n.style.map._antialias,m=n.terrain&&n.terrain.exaggeration()>0;return l===0&&!u&&!m},i.dE=function(n){const t=n.pixelsPerMeter,r=t/_t(1,n.center.lat),l=Re(new Float64Array(16));return $r(l,l,[n.point.x,n.point.y,0]),En(l,l,[r,r,t]),Float32Array.from(l)},i.dF=Eg,i.dG=function(n){const t=Ct-5;n=tt(n,-t,t)/t*90;const r=Math.pow(Math.abs(Math.sin(ar(n))),3);return Math.round(r*(y.length-1))},i.dH=function(n,t,r,l){const u=t.getNorth(),m=t.getSouth(),_=t.getWest(),b=t.getEast(),E=1<<n.z,P=b-_,R=u-m,F=P/f,O=-R/y[r],$=[0,F,0,O,0,0,u,_,0];if(n.z>0){const q=180/l;Rr($,$,[q/P+1,0,0,0,q/R+1,0,-.5*q/F,.5*q/O,1])}return $[2]=E,$[5]=n.x,$[8]=n.y,$},i.dI=md,i.dJ=function(n,t,r){const l=Re(new Float64Array(16)),u=(t/(1<<n)-.5)*Math.PI*2;return no(l,r.globeMatrix,u),Float32Array.from(l)},i.dK=P_,i.dL=nm,i.dM=function(n,t){return[Math.pow(n[0],2.2)*t,Math.pow(n[1],2.2)*t,Math.pow(n[2],2.2)*t]},i.dN=bn,i.dO=function(n,t){var r=Math.sin(t),l=Math.cos(t);return n[0]=l,n[1]=r,n[2]=0,n[3]=-r,n[4]=l,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},i.dP=ho,i.dQ=Pg,i.dR=Wn,i.dS=to,i.dT=256,i.dU=function(n,t){const r=[0,0,0];return On(r,r,iu(md(t.canonical))),On(r,r,n),r},i.dV=n=>({u_matrix:new Op(n),u_texsize:new tu(n),u_pixels_to_tile_units:new Nm(n),u_device_pixel_ratio:new ls(n),u_width_scale:new ls(n),u_floor_width_scale:new ls(n),u_image:new Tf(n),u_units_to_pixels:new tu(n),u_tile_units_to_pixels:new ls(n),u_alpha_discard_threshold:new ls(n),u_trim_offset:new tu(n),u_trim_fade_range:new tu(n),u_trim_color:new Sf(n),u_emissive_strength:new ls(n),u_zbias_factor:new ls(n),u_tile_to_meter:new ls(n),u_ground_shadow_factor:new Wd(n),u_pattern_transition:new ls(n)}),i.dW=n=>({u_matrix:new Op(n),u_pixels_to_tile_units:new Nm(n),u_device_pixel_ratio:new ls(n),u_width_scale:new ls(n),u_floor_width_scale:new ls(n),u_units_to_pixels:new tu(n),u_dash_image:new Tf(n),u_gradient_image:new Tf(n),u_image_height:new ls(n),u_texsize:new tu(n),u_tile_units_to_pixels:new ls(n),u_alpha_discard_threshold:new ls(n),u_trim_offset:new tu(n),u_trim_fade_range:new tu(n),u_trim_color:new Sf(n),u_emissive_strength:new ls(n),u_zbias_factor:new ls(n),u_tile_to_meter:new ls(n),u_ground_shadow_factor:new Wd(n)}),i.dX=n=>({u_camera_to_center_distance:new ls(n),u_extrude_scale:new Nm(n),u_device_pixel_ratio:new ls(n),u_matrix:new Op(n),u_inv_rot_matrix:new Op(n),u_merc_center:new tu(n),u_tile_id:new Wd(n),u_zoom_transition:new ls(n),u_up_dir:new Wd(n),u_emissive_strength:new ls(n)}),i.dY=Vl,i.dZ=Ub,i.d_=class{constructor(n,t,r,l){this.context=n,this.format=l,this.size=r,this.texture=n.gl.createTexture();const[u,m,_]=this.size,{gl:b}=n;b.bindTexture(b.TEXTURE_3D,this.texture),n.pixelStoreUnpackFlipY.set(!1),n.pixelStoreUnpack.set(1),n.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in t&&t.data&&b.texImage3D(b.TEXTURE_3D,0,this.format,u,m,_,0,Q(this.format),ot(this.format),t.data)}bind(n,t){const{context:r}=this,{gl:l}=r;l.bindTexture(l.TEXTURE_3D,this.texture),n!==this.minFilter&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MAG_FILTER,n),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_MIN_FILTER,n),this.minFilter=n),t!==this.wrapS&&(l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_S,t),l.texParameteri(l.TEXTURE_3D,l.TEXTURE_WRAP_T,t),this.wrapS=t)}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}},i.da=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},i.db=W,i.dc=Za,i.dd=Bn,i.de=Nx,i.df=function(n,t){return n.readFields(Ow,{icons:[]},t)},i.dg=Hg,i.dh=r_,i.di=Ax,i.dj=aa,i.dk=Zd,i.dl=Eh,i.dm=tl,i.dn=Di,i.dp=function(n){const t=n.indexOf(Zr);return t>=0?n.slice(0,t):n},i.dq=function(n){return n.indexOf(Zr)>=0},i.dr=function(n){const t=n.lastIndexOf(Zr);return t>=0?n.slice(t+1):""},i.ds=function(n){const t=[],r=n.id;return r===void 0&&t.push({message:`layers.${r}: missing required property "id"`}),n.render===void 0&&t.push({message:`layers.${r}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&t.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),t},i.dt=function(n,t,r,l){return n.type==="custom"?new Dw(n,t):new Fw[n.type](n,t,r,l)},i.du=$e,i.dv=function(n){const t=n.indexOf(Zr);return t>=0?n.slice(t+1):""},i.dw=class extends cg{constructor(n,t){super(n._vectorTileFeature,n._z,n._x,n._y,n.id),n.state&&(this.state=Object.assign({},n.state)),this.target=t.target,this.namespace=t.namespace,t.properties&&(this.properties=t.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=n.source,this.sourceLayer=n.sourceLayer,this.layer=n.layer)}toJSON(){const n=super.toJSON();return n.target=this.target,n.namespace=this.namespace,n}},i.dx=s,i.dy=Uu,i.dz=function(n){return n({pluginStatus:pa,pluginURL:gc}),s.on("pluginStateChange",n),n},i.e=eo,i.e$=function([n,t,r]){const l=Math.hypot(n,t,r),u=Math.atan2(n,r),m=.5*Math.PI-Math.acos(-t/l);return new Z(bi(u),bi(m))},i.e0=(n,t,r,l,u,m)=>{const _=n.transform,b=_.projection.name==="globe";let E;if(m.paint.get("circle-pitch-alignment")==="map")if(b){const R=Pg(_.zoom,t.canonical)*_._pixelsPerMercatorPixel;E=Float32Array.from([R,0,0,R])}else E=_.calculatePixelsToTileUnitsMatrix(r);else E=new Float32Array([_.pixelsToGLUnits[0],0,0,_.pixelsToGLUnits[1]]);const P={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(_.projection),u_matrix:n.translatePosMatrix(t.projMatrix,r,m.paint.get("circle-translate"),m.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Qa.devicePixelRatio,u_extrude_scale:E,u_inv_rot_matrix:By,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:m.paint.get("circle-emissive-strength")};if(b){P.u_inv_rot_matrix=l,P.u_merc_center=u,P.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],P.u_zoom_transition=zu(_.zoom);const R=u[0]*ri,F=u[1]*ri;P.u_up_dir=_.projection.upVector(new wc(0,0,0),R,F)}return P},i.e1=tf,i.e2=Fa,i.e3=(n,t,r,l,u,m,_,b,E,P)=>{const R=n.transform,F=R.pitch<15?w0(.07,.7,tt((14-R.zoom)/5,0,1)):.07,O=r.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:Hc(n,t,r,l),u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:R.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:u,u_width_scale:m,u_floor_width_scale:_,u_image:0,u_tile_units_to_pixels:El(t,R),u_units_to_pixels:[1/R.pixelsToGLUnits[0],1/R.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:b,u_trim_fade_range:r.paint.get("line-trim-fade-range"),u_trim_color:r.paint.get("line-trim-color").toPremultipliedRenderColor(O?null:r.lut).toArray01(),u_emissive_strength:r.paint.get("line-emissive-strength"),u_zbias_factor:F,u_tile_to_meter:Zt(t.tileID.canonical,0),u_ground_shadow_factor:E,u_pattern_transition:P}},i.e4=(n,t,r,l,u,m,_,b,E,P)=>{const R=n.transform,F=R.calculatePixelsToTileUnitsMatrix(t),O=r.paint.get("line-trim-color-use-theme").constantOr("default")==="none",$=R.pitch<15?w0(.07,.7,tt((14-R.zoom)/5,0,1)):.07;return{u_matrix:Hc(n,t,r,l),u_pixels_to_tile_units:F,u_device_pixel_ratio:m,u_width_scale:_,u_floor_width_scale:b,u_units_to_pixels:[1/R.pixelsToGLUnits[0],1/R.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:u,u_texsize:su(r)&&t.lineAtlasTexture?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:El(t,n.transform),u_alpha_discard_threshold:0,u_trim_offset:E,u_trim_fade_range:r.paint.get("line-trim-fade-range"),u_trim_color:r.paint.get("line-trim-color").toPremultipliedRenderColor(O?null:r.lut).toArray01(),u_emissive_strength:r.paint.get("line-emissive-strength"),u_zbias_factor:$,u_tile_to_meter:Zt(t.tileID.canonical,0),u_ground_shadow_factor:P}},i.e5=Yt,i.e6=sm,i.e7=Ut,i.e8=Xd,i.e9=bd,i.eA=jx,i.eB=yr,i.eC=_i,i.eD=[1,1,1],i.eE=a_,i.eF=Ms,i.eG=function(n,t,r,l){var u=t[0],m=t[1],_=t[2],b=t[3];return n[0]=u+l*(r[0]-u),n[1]=m+l*(r[1]-m),n[2]=_+l*(r[2]-_),n[3]=b+l*(r[3]-b),n},i.eH=Nr,i.eI=Nl,i.eJ=Au,i.eK=function(n,t,r,l,u,m,_,b,E,P,R,F,O,$,q,Y){var it=new wi(16);return it[0]=n,it[1]=t,it[2]=r,it[3]=l,it[4]=u,it[5]=m,it[6]=_,it[7]=b,it[8]=E,it[9]=P,it[10]=R,it[11]=F,it[12]=O,it[13]=$,it[14]=q,it[15]=Y,it},i.eL=N,i.eM=Rp,i.eN=Lp,i.eO=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Ae(1/0,1/0),max:new Ae(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n,t=!1){const r=t0(new Ae(0,0),new Ae(ri,ri),n),l=[];if(t&&!fm(r,this._globalClipBounds))return l;for(const u of this._activeRegions){if(u.hiddenByOverlap||!fm(r,u))continue;const m=U_(u.min,u.max,n);l.push({min:m.min,max:m.max,sourceId:this._sourceIds[u.priority],footprint:u.footprint,footprintTileId:u.tileId,order:u.order,clipMask:u.clipMask,clipScope:u.clipScope})}return l}setSources(n){this._setSources(n.map(t=>({getSourceId:()=>t.cache.id,getFootprints:()=>{const r=[];for(const l of t.cache.getVisibleCoordinates()){const u=t.cache.getTile(l).buckets[t.layer];u&&u.updateFootprints(l.toUnwrapped(),r)}return r},getOrder:()=>t.order,getClipMask:()=>t.clipMask,getClipScope:()=>t.clipScope})))}_addSource(n){const t=n.getFootprints();if(t.length===0)return;const r=n.getOrder(),l=n.getClipMask(),u=n.getClipScope();for(const m of t){if(!m.footprint)continue;const _=t0(m.footprint.min,m.footprint.max,m.id);this._activeRegions.push({min:_.min,max:_.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:m.id,footprint:m.footprint,order:r,clipMask:l,clipScope:u})}this._sourceIds.push(n.getSourceId())}_computeReplacement(){this._activeRegions.sort((t,r)=>t.priority-r.priority||Hp(t.min,r.min)||Hp(t.max,r.max)||t.order-r.order||t.clipMask-r.clipMask||function(l,u){const m=(_,b)=>_+b;return l.length-u.length||l.reduce(m,"").localeCompare(u.reduce(m,""))}(t.clipScope,r.clipScope));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let t=0;for(;!n&&t!==this._activeRegions.length;){const r=this._activeRegions[t],l=this._prevRegions[t];n=r.priority!==l.priority||!V_(r,l)||r.order!==l.order||r.clipMask!==l.clipMask||!Do(r.clipScope,l.clipScope),this._activeRegions[t].hiddenByOverlap=l.hiddenByOverlap,++t}}if(n){++this._updateTime;for(const r of this._activeRegions)r.order!==Cf&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,r.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,r.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,r.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,r.max.y));const t=r=>{const l=this._activeRegions;if(r>=l.length)return r;const u=l[r].priority;for(;r<l.length&&l[r].priority===u;)++r;return r};if(this._sourceIds.length>1){let r=0,l=t(r);for(;r!==l;){let u=r;const m=r;for(;u!==l;){const _=this._activeRegions[u];_.hiddenByOverlap=!1;for(let b=0;b<m;b++){const E=this._activeRegions[b];if(!E.hiddenByOverlap&&_.order===Cf&&fm(_,E)&&(_.hiddenByOverlap=e0(_.footprint,_.tileId,E.footprint,E.tileId),_.hiddenByOverlap))break}++u}r=l,l=t(r)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let t=n.length-1;t>=0;t--)this._addSource(n[t]);this._computeReplacement()}},i.eP=Cf,i.eQ=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const n of this._poleSegments)n.destroy();for(const n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,t){const r=new As,l=new ro,u=[],m=n+1+2,_=t[0]+1,b=t[0]+1+(1+t.length),E=(P,R,F)=>{let O=P===m-1?P-2:P===0?P:P-1;return O+=F?24575:0,[O,R]};for(let P=0;P<m;++P)r.emplaceBack(...E(P,0,!0));for(let P=0;P<_;++P)for(let R=0;R<m;++R)r.emplaceBack(...E(R,P,(R===0||R===m-1)&&!0));for(let P=0;P<t.length;++P){const R=t[P];for(let F=0;F<m;++F)r.emplaceBack(...E(F,R,!0))}for(let P=0;P<t.length;++P){const R=l.length,F=t[P]+1+2,O=new ro;for(let Y=0;Y<F-1;Y++){const it=Y===F-2,at=it?m*(b-t.length+P-Y):m;for(let gt=0;gt<m-1;gt++){const yt=Y*m+gt;Y===0||it||gt===0||gt===m-2?(O.emplaceBack(yt+1,yt,yt+at),O.emplaceBack(yt+at,yt+at+1,yt+1)):(l.emplaceBack(yt+1,yt,yt+at),l.emplaceBack(yt+at,yt+at+1,yt+1))}}const $=To.simpleSegment(0,R,r.length,l.length-R);for(let Y=0;Y<O.uint16.length;Y+=3)l.emplaceBack(O.uint16[Y],O.uint16[Y+1],O.uint16[Y+2]);const q=To.simpleSegment(0,R,r.length,l.length-R);u.push({withoutSkirts:$,withSkirts:q})}return{vertices:r,indices:l,segments:u}}_createGrid(n){const t=this._fillGridMeshWithLods(f,y);this._gridSegments=t.segments,this._gridBuffer=n.createVertexBuffer(t.vertices,b_.members),this._gridIndexBuffer=n.createIndexBuffer(t.indices,!0)}_createPoles(n){const t=new ro;for(let _=0;_<=f;_++)t.emplaceBack(0,_+1,_+2);this._poleIndexBuffer=n.createIndexBuffer(t,!0);const r=new fh,l=new fh,u=new fh,m=new fh;this._poleSegments=[];for(let _=0,b=0;_<p;_++){const E=360/(1<<_);r.emplaceBack(0,-Tl,0,.5,0),l.emplaceBack(0,-Tl,0,.5,1),u.emplaceBack(0,-Tl,0,.5,.5),m.emplaceBack(0,-Tl,0,.5,.5);for(let P=0;P<=f;P++){let R=P/f,F=0;const O=Gi(0,E,R),[$,q,Y]=M(I_,om,O,Tl);r.emplaceBack($,q,Y,R,F),l.emplaceBack($,q,Y,R,1-F);const it=ar(O);R=.5+.5*Math.sin(it),F=.5+.5*Math.cos(it),u.emplaceBack($,q,Y,R,F),m.emplaceBack($,q,Y,R,1-F)}this._poleSegments.push(To.simpleSegment(b,0,66,64)),b+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(r,rm,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(l,rm,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(u,rm,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(m,rm,!1)}getGridBuffers(n,t){return[this._gridBuffer,this._gridIndexBuffer,t?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,t){return[t?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,t?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},i.eR=N_,i.eS=se,i.eT=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},i.eU=st,i.eV=Rt,i.eW=function(n,t,r){return n[0]=t[0]/r[0],n[1]=t[1]/r[1],n[2]=t[2]/r[2],n},i.eX=ll,i.eY=L,i.eZ=Wr,i.e_=hn,i.ea=Y_,i.eb=Qd,i.ec=n0,i.ed=Jm,i.ee=Ot,i.ef=function(n,t){if(n===t){var r=t[1],l=t[2],u=t[3],m=t[6],_=t[7],b=t[11];n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=r,n[6]=t[9],n[7]=t[13],n[8]=l,n[9]=m,n[11]=t[14],n[12]=u,n[13]=_,n[14]=b}else n[0]=t[0],n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=t[1],n[5]=t[5],n[6]=t[9],n[7]=t[13],n[8]=t[2],n[9]=t[6],n[10]=t[10],n[11]=t[14],n[12]=t[3],n[13]=t[7],n[14]=t[11],n[15]=t[15];return n},i.eg=Cw,i.eh=Er,i.ei=Qf,i.ej=256,i.ek=_d,i.el=ta,i.em=no,i.en=function(n,t){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],n},i.eo=fh,i.ep=bf,i.eq=_f,i.er=function(n,t,r,l,u){return tt((n-t)/(r-t)*(u-l)+l,l,u)},i.es=Cl,i.et=function(n,t){var r=t[0],l=t[1],u=t[2],m=t[3],_=t[4],b=t[5],E=t[6],P=t[7],R=t[8],F=R*_-b*P,O=-R*m+b*E,$=P*m-_*E,q=r*F+l*O+u*$;return q?(n[0]=F*(q=1/q),n[1]=(-R*l+u*P)*q,n[2]=(b*l-u*_)*q,n[3]=O*q,n[4]=(R*r-u*E)*q,n[5]=(-b*r+u*m)*q,n[6]=$*q,n[7]=(-P*r+l*E)*q,n[8]=(_*r-l*m)*q,n):null},i.eu=2,i.ev=qr,i.ew=Cs,i.ex=Ya,i.ey=function(n,t){var r=new wi(3);Ya(r,t);var l=1/r[0],u=1/r[1],m=1/r[2],_=t[0]*l,b=t[1]*u,E=t[2]*m,P=t[4]*l,R=t[5]*u,F=t[6]*m,O=t[8]*l,$=t[9]*u,q=t[10]*m,Y=_+R+q,it=0;return Y>0?(it=2*Math.sqrt(Y+1),n[3]=.25*it,n[0]=(F-$)/it,n[1]=(O-E)/it,n[2]=(b-P)/it):_>R&&_>q?(it=2*Math.sqrt(1+_-R-q),n[3]=(F-$)/it,n[0]=.25*it,n[1]=(b+P)/it,n[2]=(O+E)/it):R>q?(it=2*Math.sqrt(1+R-_-q),n[3]=(O-E)/it,n[0]=(b+P)/it,n[1]=.25*it,n[2]=(F+$)/it):(it=2*Math.sqrt(1+q-_-R),n[3]=(b-P)/it,n[0]=(O+E)/it,n[1]=(F+$)/it,n[2]=.25*it),n},i.ez=function(n,t){var r=2*Math.acos(t[3]),l=Math.sin(r/2);return l>Le?(n[0]=t[0]/l,n[1]=t[1]/l,n[2]=t[2]/l):(n[0]=1,n[1]=0,n[2]=0),r},i.f=function(n){return btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,(t,r)=>String.fromCharCode(+("0x"+r))))},i.f0=ql,i.f1=zi,i.f2=function(n){const t=n.navigator?n.navigator.userAgent:null;return!!function(r){if(Qr==null){const l=r.navigator?r.navigator.userAgent:null;Qr=!!r.safari||!(!l||!(/\b(iPad|iPhone|iPod)\b/.test(l)||l.match("Safari")&&!l.match("Chrome")))}return Qr}(n)&&!(!t||!(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},i.f3=function(n,t){dl=n,La=t},i.f4=S_,i.f5=Mg,i.f6=function(n){const t=[0,0,0],r=Re(new Float64Array(16));return pr(r,n.pixelMatrix,n.globeMatrix),On(t,t,r),new Ae(t[0],t[1])},i.f7=function(){const n=_m;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(ja),_m=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},i.f8=function(){Hg().acquire(ja)},i.f9=d,i.fA=qe,i.fB=function(n){let t=0;if(new Uint32Array(n,0,1)[0]!==g){const r=new Uint32Array(n,0,7),[,,l,u,m,_]=r;t=r.byteLength+u+m+_+m,(l!==n.byteLength||t>=n.byteLength)&&Hi("Invalid b3dm header information.")}return G(n,t)},i.fC=function(n,t){const r=Za(n);for(const l of r){for(const u of l.meshes)Mc(u);l.lights&&(l.lightMeshIndex=l.meshes.length,l.meshes.push(Ha(l.lights,t)))}return r},i.fD=V0,i.fE=Nn,i.fF=p0,i.fG=S,i.fH=Gs,i.fI=function(n){oa(),fs!=null&&fs.then(t=>{t.keys().then(r=>{for(let l=0;l<r.length-n;l++)t.delete(r[l]).catch(u=>Hi(u.message))}).catch(r=>Hi(r.message))}).catch(t=>Hi(t.message))},i.fa=function(n,t,r=!1){if(pa===Gs.deferred||pa===Gs.loading||pa===Gs.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");gc=Qa.resolveURL(n),pa=Gs.deferred,ud=t,C(),r||v()},i.fb=function(n){Jp=Qa.resolveURL(n),Rf||(Rf=new Lf(Hg(),new Rl)),Rf.broadcast("setMeshoptUrl",Jp)},i.fc=ng,i.fd=function(n){iy=Qa.resolveURL(n),Rf||(Rf=new Lf(Hg(),new Rl)),Rf.broadcast("setDracoUrl",iy)},i.fe=Xg,i.ff=wd,i.fg=function(n){const t=un();if(!t)return;const r=t.delete(Nu);n&&r.then(()=>n()).catch(n)},i.fh=ip,i.fi=Ei,i.fj=Kd,i.fk=lp,i.fl=K1,i.fm=Q1,i.fn=x0,i.fo=xi,i.fp="hd_road_elevation",i.fq=mr,i.fr=ti,i.fs=xd,i.ft=Ex,i.fu=ag,i.fv=function(n,t,r,l,u,m,_,b=1,E,P,R){n.createArrays(),n.tilePixelRatio=ri/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;const F=n.layers[0].layout,O=n.layers[0]._unevaluatedLayout._values,$={};$.scaleFactor=b,$.textSizeScaleRange=F.get("text-size-scale-range"),$.iconSizeScaleRange=F.get("icon-size-scale-range");const[q,Y]=$.textSizeScaleRange,[it,at]=$.iconSizeScaleRange;$.textScaleFactor=tt($.scaleFactor,q,Y),$.iconScaleFactor=tt($.scaleFactor,it,at);const gt=O["text-size"],yt=O["icon-size"];if(n.textSizeData.kind==="composite"){const{minZoom:ne,maxZoom:ze}=n.textSizeData;$.compositeTextSizes=[gt.possiblyEvaluate(new D(ne,{worldview:R}),m),gt.possiblyEvaluate(new D(ze,{worldview:R}),m)]}if(n.iconSizeData.kind==="composite"){const{minZoom:ne,maxZoom:ze}=n.iconSizeData;$.compositeIconSizes=[yt.possiblyEvaluate(new D(ne,{worldview:R}),m),yt.possiblyEvaluate(new D(ze,{worldview:R}),m)]}$.layoutTextSize=gt.possiblyEvaluate(new D(_+1,{worldview:R}),m),$.layoutIconSize=yt.possiblyEvaluate(new D(_+1,{worldview:R}),m),$.textMaxSize=gt.possiblyEvaluate(new D(18,{worldview:R}),m);const At=F.get("symbol-placement"),Gt=F.get("text-rotation-alignment")==="map"&&At!=="point",kt=F.get("text-size");let Xt=!1;const te=[];for(const ne of n.features){const ze=F.get("text-font").evaluate(ne,{},m).join(","),fe=kt.evaluate(ne,{},m)*$.textScaleFactor,ke=$.layoutTextSize.evaluate(ne,{},m)*$.textScaleFactor,Ue=$.layoutIconSize.evaluate(ne,{},m)*$.iconScaleFactor,Ze={horizontal:{},vertical:void 0},hi=ne.text;let Ke,je=[0,0];if(hi){const Vr=hi.toString(),pn=F.get("text-letter-spacing").evaluate(ne,{},m)*Wa,Tr=F.get("text-line-height").evaluate(ne,{},m)*Wa,wn=hd(Vr)?pn:0,Tn=F.get("text-anchor").evaluate(ne,{},m),No=F.get("text-variable-anchor");if(!No){const Ve=F.get("text-radial-offset").evaluate(ne,{},m);if(Ve)je=Fv(Tn,[Ve*Wa,Mx]);else{const gi=F.get("text-offset").evaluate(ne,{},m);je=[gi[0]*Wa,gi[1]*Wa]}}let Ft=Gt?"center":F.get("text-justify").evaluate(ne,{},m);const zt=At==="point",Ne=zt?F.get("text-max-width").evaluate(ne,{},m)*Wa:1/0,pi=Ve=>{n.allowVerticalPlacement&&Yh(Vr)&&(Ze.vertical=wx(hi,t,r,u,ze,Ne,Tr,Tn,Ve,wn,je,bh.vertical,!0,ke,fe,E))};if(!Gt&&No){const Ve=Ft==="auto"?No.map(qi=>Cx(qi)):[Ft];let gi=!1;for(let qi=0;qi<Ve.length;qi++){const ji=Ve[qi];if(!Ze.horizontal[ji])if(gi)Ze.horizontal[ji]=Ze.horizontal[0];else{const Cr=wx(hi,t,r,u,ze,Ne,Tr,"center",ji,wn,je,bh.horizontal,!1,ke,fe,E);Cr&&(Ze.horizontal[ji]=Cr,gi=Cr.positionedLines.length===1)}}pi("left")}else{if(Ft==="auto"&&(Ft=Cx(Tn)),zt||F.get("text-writing-mode").indexOf("horizontal")>=0||!Yh(Vr)){const Ve=wx(hi,t,r,u,ze,Ne,Tr,Tn,Ft,wn,je,bh.horizontal,!1,ke,fe,E);Ve&&(Ze.horizontal[Ft]=Ve)}pi(zt?"left":Ft)}}let Ye,Pe,Ie,He,ai,Ge,Pi=!1;const Bi=F.get("icon-text-fit").evaluate(ne,{},m);if(ne.icon&&ne.icon.hasPrimary()){const Vr=dy(ne.icon,n.iconSizeData,O["icon-size"],m,n.zoom,ne,E,$.iconScaleFactor,R);Ye=Vr.iconPrimary,Ie=Vr.iconSecondary;const pn=Ye.toString();if(Pe=l.get(pn),Pe&&(ai=F.get("icon-offset").evaluate(ne,{},m),Ge=F.get("icon-anchor").evaluate(ne,{},m),Ke=I0(u.get(pn),Ie?u.get(Ie.toString()):void 0,ai,Ge),Pi=Pe.sdf,n.sdfIcons===void 0?n.sdfIcons=Pe.sdf:n.sdfIcons!==Pe.sdf&&Hi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Pe.pixelRatio!==n.pixelRatio||F.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0)),Ie){const Tr=Ie.toString();He=l.get(Tr)}}Xt=Xt||!(!ne.icon||!ne.icon.hasSecondary());const vi=Dx(Ze.horizontal)||Ze.vertical;n.iconsInText||(n.iconsInText=!!vi&&vi.iconsInText);const mi=ke*$.textScaleFactor/Wa,{defaultShapedIcon:_r,verticallyShapedIcon:yi}=gw(n,Ke,F,ne,m,Ze,mi,ai,Bi);Bi!=="none"&&Ke&&(bv(Ke)||wv(Ke))&&(C0(0,Pe,Ye,Ke,_r,Bi,P,l,u),C0(0,He,Ie,Ke,_r,Bi,P,l,u),yi&&(C0(0,Pe,Ye,Ke,yi,Bi,P,l,u),C0(0,He,Ie,Ke,yi,Bi,P,l,u))),Ke=_r;const{iconBBox:Yi,iconVerticalBBox:wr}=pw(n,Ke,yi,F,ne,m,Ue,ai,$,u,Ge);te.push({feature:ne,shapedTextOrientations:Ze,shapedText:vi,shapedIcon:Ke,iconPrimary:Ye,iconSecondary:Ie,iconOffset:ai,iconAnchor:Ge,verticallyShapedIcon:yi,layoutTextSize:ke,layoutIconSize:Ue,textOffset:je,isSDFIcon:Pi,iconTextFit:Bi,iconCollisionBounds:Yi,iconVerticalCollisionBounds:wr})}return{featureData:te,sizes:$,hasAnySecondaryIcon:Xt,textAlongLine:Gt,symbolPlacement:At}},i.fw=Cv,i.fx=function(n,t,r,l,u,m,_,b,E,P){n.iconAtlasPositions=P.iconPositions;const{featureData:R,hasAnySecondaryIcon:F,sizes:O,textAlongLine:$,symbolPlacement:q}=t;for(const Y of R){const{shapedIcon:it,verticallyShapedIcon:at,feature:gt,shapedTextOrientations:yt,shapedText:At,layoutTextSize:Gt,textOffset:kt,isSDFIcon:Xt,iconPrimary:te,iconSecondary:ne,iconTextFit:ze,iconOffset:fe,iconCollisionBounds:ke,iconVerticalCollisionBounds:Ue}=Y;Ov(it,P.iconPositions,te,ne),Ov(at,P.iconPositions,te,ne),mw(yt,P.iconPositions),fw(te,ne,P.iconPositions),(At||it)&&_w(n,gt,yt,it,at,E,O,Gt,0,kt,Xt,l,u,_,b,F,ze,fe,$,q,ke,Ue)}r&&n.generateCollisionDebugBuffers(m,n.collisionBoxArray,O.textScaleFactor)},i.fy=Fi,i.fz=Z0,i.g=function(n,t){return Uu(Object.assign(n,{method:"GET"}),t)},i.h=function(n){return n.indexOf("mapbox:")===0},i.i=function(n){return eo.API_STYLE_REGEX.test(n)&&!na(n)},i.j=ps,i.k=lc,i.l=function(n){return decodeURIComponent(atob(n).split("").map(t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)).join(""))},i.m=function(n,t){return Uu(Object.assign(n,{type:"json"}),t)},i.n=Ra,i.o=Qa,i.p=function(n,t){return Uu(Object.assign(n,{method:"POST"}),t)},i.q=Ma,i.r=za,i.s=function(n){try{const t=self[n];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}},i.t=function(){return eg||(eg=new ip),eg},i.u=function(){return function n(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)}()},i.v=function(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)},i.w=Hi,i.x=Hx,i.y=cc,i.z=Sa}),qt(["./shared"],function(i){function Le(se){const st=se?se.url.toString():void 0;return st?performance.getEntriesByName(st):[]}function wi(se){if(typeof se=="number"||typeof se=="boolean"||typeof se=="string"||se==null)return JSON.stringify(se);if(Array.isArray(se)){let tt="[";for(const wt of se)tt+=`${wi(wt)},`;return`${tt}]`}let st="{";for(const tt of Object.keys(se).sort())st+=`${tt}:${wi(se[tt])},`;return`${st}}`}function nr(se){let st="";for(const tt of i.bw)st+=`/${wi(se[tt])}`;return st}class bn{constructor(st){this.keyCache={},this._layers={},this._layerConfigs={},st&&this.replace(st)}replace(st,tt){this._layerConfigs={},this._layers={},this.update(st,[],tt)}update(st,tt,wt){this._options=wt;for(const Ht of st)this._layerConfigs[Ht.id]=Ht,(this._layers[Ht.id]=i.dt(Ht,this.scope,null,this._options)).compileFilter(wt),this.keyCache[Ht.id]&&delete this.keyCache[Ht.id];for(const Ht of tt)delete this.keyCache[Ht],delete this._layerConfigs[Ht],delete this._layers[Ht];this.familiesBySource={};const Bt=function(Ht,oe){const ye={};for(let xe=0;xe<Ht.length;xe++){const ti=Ht[xe];let $e=oe&&oe[ti.id];$e||(ti.type==="symbol"?$e=ti.id:($e=nr(ti),ti.type==="line"&&ti.paint&&function er(Ki){return typeof Ki=="string"&&Ki==="line-progress"||(Array.isArray(Ki)?Ki.some(er):!(!Ki||typeof Ki!="object")&&Object.values(Ki).some(er))}(ti.paint["line-width"])&&($e+=`/${wi(ti.paint["line-width"])}`))),oe&&(oe[ti.id]=$e);let Di=ye[$e];Di||(Di=ye[$e]=[]),Di.push(ti)}const Yt=[];for(const xe in ye)Yt.push(ye[xe]);return Yt}(Object.values(this._layerConfigs),this.keyCache);for(const Ht of Bt){const oe=Ht.map(Di=>this._layers[Di.id]),ye=oe[0];if(ye.visibility==="none")continue;const Yt=ye.source||"";let xe=this.familiesBySource[Yt];xe||(xe=this.familiesBySource[Yt]={});const ti=ye.sourceLayer||"_geojsonTileLayer";let $e=xe[ti];$e||($e=xe[ti]=[]),$e.push(oe)}}}const cn=1*i.fk;class Rr{constructor(st){const tt={},wt=[];for(const ye in st){const Yt=st[ye],xe=tt[ye]={};for(const ti in Yt.glyphs){const $e=Yt.glyphs[+ti];if(!$e||$e.bitmap.width===0||$e.bitmap.height===0)continue;const Di=$e.metrics.localGlyph?cn:1,er={x:0,y:0,w:$e.bitmap.width+2*Di,h:$e.bitmap.height+2*Di};wt.push(er),xe[ti]=er}}const{w:Bt,h:Ht}=i.G(wt),oe=new i.fj({width:Bt||1,height:Ht||1});for(const ye in st){const Yt=st[ye];for(const xe in Yt.glyphs){const ti=Yt.glyphs[+xe];if(!ti||ti.bitmap.width===0||ti.bitmap.height===0)continue;const $e=tt[ye][xe],Di=ti.metrics.localGlyph?cn:1;i.fj.copy(ti.bitmap,oe,{x:0,y:0},{x:$e.x+Di,y:$e.y+Di},ti.bitmap)}}this.image=oe,this.positions=tt}}function xr(se,st,tt){se[st]?tt&&(se[st].center=tt):se[st]={floorIds:new Set,center:tt||[0,0],floors:{}}}function Ci(se,st,tt,wt){for(const Bt of st)xr(se,Bt),se[Bt].floors[tt]=wt,se[Bt].floorIds.add(tt)}function Re(se){return{id:se.properties.id.toString(),center:se.properties.center.toString().split(";").map(Number)}}function Rn(se){return{id:se.properties.id.toString(),isDefault:!!se.properties.is_default&&se.properties.is_default,connections:se.properties.connected_floor_ids?new Set(se.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:se.properties.conflicted_floor_ids?new Set(se.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:se.properties.building_ids?new Set(se.properties.building_ids.toString().split(";")):new Set,name:se.properties.name.toString(),zIndex:se.properties.z_index}}function pr(se,st){return st.every(tt=>se.properties&&se.properties[tt]!=null)}function $r(se){return pr(se,["type","id","name"])&&se.properties.type==="building"}function En(se){return pr(se,["type","id","name","z_index"])&&se.properties.type==="floor"}i.fi(Rr,"GlyphAtlas");class $o{constructor(st){this.tileID=new i.aP(st.tileID.overscaledZ,st.tileID.wrap,st.tileID.canonical.z,st.tileID.canonical.x,st.tileID.canonical.y),this.tileZoom=st.tileZoom,this.uid=st.uid,this.zoom=st.zoom,this.lut=st.lut,this.canonical=st.tileID.canonical,this.pixelRatio=st.pixelRatio,this.tileSize=st.tileSize,this.source=st.source,this.scope=st.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=st.showCollisionBoxes,this.collectResourceTiming=!!st.request&&st.request.collectResourceTiming,this.promoteId=st.promoteId,this.isSymbolTile=st.isSymbolTile,this.tileTransform=i.aY(st.tileID.canonical,st.projection),this.projection=st.projection,this.worldview=st.worldview,this.localizableLayerIds=st.localizableLayerIds,this.brightness=st.brightness,this.extraShadowCaster=!!st.extraShadowCaster,this.tessellationStep=st.tessellationStep,this.scaleFactor=st.scaleFactor,this.worldview=st.worldview,this.indoor=st.indoor}parse(st,tt,wt,Bt,Ht,oe){this.status="parsing",this.data=st,this.collisionBoxArray=new i.b2;const ye=new i.fl(Object.keys(st.layers).sort()),Yt=new i.fm(this.tileID,this.promoteId);Yt.bucketLayerIDs=[];const xe={},ti=new i.fn(256,256),$e={featureIndex:Yt,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:ti,availableImages:wt,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const Hi=this.indoor.indoorState.activeFloorsVisible,gr=function(Qi,Cn,Nn){const Vo=function(gn,Ur){if(!gn)return i.w("No source layers defined in indoor specification"),Ur;if(gn.size===0)return Ur;const Wn=gn.difference(Ur);for(const to of Wn)i.w(`Missing source layer required in indoor specification: ${to}`);return Ur.intersection(Ur)}(Cn.sourceLayers,new Set(Object.keys(Qi.layers))),Qr=Cn.indoorState,ao=function(gn,Ur,Wn,to){const Dn=new Set,eo=new Set,ps=new Set,na=new Map,Dl={},Ih=hs=>{const ul=na.get(hs)||new Set;for(const Ta of Dn)if((na.get(Ta)||new Set).has(hs)||ul.has(Ta))return!0;return!1};for(const hs of Ur){const ul=gn.layers[hs];if(ul)for(let Ta=0;Ta<ul.length;Ta++){const zl=ul.feature(Ta);if($r(zl)){const{id:za,center:Qa}=Re(zl);xr(Dl,za,Qa),Dn.add(za)}else if(En(zl)){const{id:za,isDefault:Qa,connections:Hl,conflicts:Eh,buildings:Nu,name:dl,zIndex:La}=Rn(zl);Ci(Dl,Nu,za,{name:dl,zIndex:La}),na.set(za,Eh),(za===to||Hl.has(to))&&Dn.add(za),eo.add(za),Qa&&ps.add(za)}}else i.w(`indoor source layer not found: ${hs}`)}if(Wn)for(const hs of Wn)eo.has(hs)&&(Ih(hs)||Dn.add(hs));for(const hs of ps)Dn.has(hs)||Ih(hs)||Dn.add(hs);return{buildings:Dl,activeFloors:Dn}}(Qi,Vo,Qr.lastActiveFloors,Qr.selectedFloorId);return Nn.send("setIndoorData",ao),ao}(st,this.indoor,Ht);$e.activeFloors=Hi?gr.activeFloors:void 0}const Di=[],er=tt.familiesBySource[this.source];for(const Hi in er){const gr=st.layers[Hi];if(!gr)continue;let Qi=!1,Cn=!1,Nn=!1;for(const gn of er[Hi])gn[0].type==="symbol"?Qi=!0:Cn=!0,gn[0].is3D()&&gn[0].type!=="model"&&(Nn=!0);if(this.extraShadowCaster&&!Nn||this.isSymbolTile===!0&&!Qi||this.isSymbolTile===!1&&!Cn)continue;gr.version===1&&i.w(`Vector tile source "${this.source}" layer "${Hi}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Vo=ye.encode(Hi),Qr=[];let ao=!1;for(let gn=0,Ur=0;gn<gr.length;gn++){const Wn=gr.feature(gn),to=Yt.getId(Wn,Hi);if(this.localizableLayerIds&&this.localizableLayerIds.has(Hi)){const Dn=Wn.properties?Wn.properties.worldview:null;if(this.worldview&&typeof Dn=="string")if(Dn==="all")Wn.properties.$localized=!0;else{if(!Dn.split(",").includes(this.worldview))continue;Wn.properties.$localized=!0,Wn.properties.worldview=this.worldview}}!ao&&Wn.properties&&Wn.properties.hasOwnProperty(i.fo)&&(ao=!0),Qr.push({feature:Wn,id:to,index:Ur,sourceLayerIndex:Vo}),Ur++}ao&&!$e.elevationFeatures&&st.layers.hasOwnProperty(i.fp)&&($e.elevationFeatures=i.fq.parseFrom(st.layers[i.fp],this.canonical));for(const gn of er[Hi]){const Ur=gn[0];if(this.extraShadowCaster&&(!Ur.is3D()||Ur.type==="model")||this.isSymbolTile!==void 0&&Ur.type==="symbol"!==this.isSymbolTile||Ur.minzoom&&this.zoom<Math.floor(Ur.minzoom)||Ur.maxzoom&&this.zoom>=Ur.maxzoom||Ur.visibility==="none")continue;no(gn,this.zoom,$e.brightness,wt,this.worldview);const Wn=xe[Ur.id]=Ur.createBucket({index:Yt.bucketLayerIDs.length,layers:gn,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Vo,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:Bt,worldview:this.worldview});Yt.bucketLayerIDs.push(gn.map(Dn=>i.B(Dn.id,Dn.scope)));let to=Wn.prepare?Wn.prepare():null;to!=null?(to=to.then(()=>Wn.populate(Qr,$e,this.tileID.canonical,this.tileTransform)),Di.push(to)):Wn.populate(Qr,$e,this.tileID.canonical,this.tileTransform)}}const Ki=()=>{let Hi,gr,Qi,Cn,Nn,Vo;ti.trim();const Qr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},ao=()=>{if(Hi)return this.status="done",oe(Hi);if(this.extraShadowCaster)this.status="done",oe(null,{buckets:Object.values(xe).filter(Ur=>!Ur.isEmpty()),featureIndex:Yt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:$e.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(gr&&Qi&&Cn){const Ur=new Rr(gr),Wn=new Map;for(const[eo,ps]of Qi.entries()){const{imagePosition:na}=i.ft(eo,ps,i.fu);Wn.set(eo,na)}const to={};for(const eo in xe){const ps=xe[eo];ps instanceof i.b3&&(no(ps.layers,this.zoom,$e.brightness,wt,this.worldview),to[eo]=i.fv(ps,gr,Ur.positions,Qi,Wn,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Nn,this.worldview))}const Dn={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(Ht,Qi,Nn,()=>{Dn.iconsPending=!1,gn(to,Ur,Dn)}),this.rasterizeIfNeeded(Ht,Cn,Vo,()=>{Dn.patternsPending=!1,gn(to,Ur,Dn)})}},gn=(Ur,Wn,to,Dn)=>{if(to.iconsPending||to.patternsPending)return;const eo=new i.fw(Qi,Cn,this.lut);for(const ps in xe){const na=xe[ps];if(ps in Ur)i.fx(na,Ur[ps],this.showCollisionBoxes,wt,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Qi,eo);else if(na.hasPattern&&(na instanceof i.b9||na instanceof i.ba||na instanceof i.e9)){no(na.layers,this.zoom,$e.brightness,wt,this.worldview);const Dl=Object.fromEntries(eo.patternPositions);na.addFeatures($e,this.tileID.canonical,Dl,wt,this.tileTransform,this.brightness)}}this.status="done",oe(null,{buckets:Object.values(xe).filter(ps=>!ps.isEmpty()),featureIndex:Yt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Wn.image,lineAtlas:ti,imageAtlas:eo,brightness:$e.brightness})};if(!this.extraShadowCaster){const Ur=i.fr($e.glyphDependencies,Dn=>Object.keys(Dn).map(Number));Object.keys(Ur).length?Ht.send("getGlyphs",{uid:this.uid,stacks:Ur},(Dn,eo)=>{Hi||(Hi=Dn,gr=eo,ao())},void 0,!1,Qr):gr={};const Wn=Array.from($e.iconDependencies.keys()).map(Dn=>i.I.parse(Dn));Wn.length?Ht.send("getImages",{images:Wn,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Dn,eo)=>{Hi||(Hi=Dn,Qi=new Map,Nn=this.updateImageMapAndGetImageTaskQueue(Qi,eo,$e.iconDependencies),ao())},void 0,!1,Qr):(Qi=new Map,Nn=new Map);const to=Array.from($e.patternDependencies.keys()).map(Dn=>i.I.parse(Dn));to.length?Ht.send("getImages",{images:to,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Dn,eo)=>{Hi||(Hi=Dn,Cn=new Map,Vo=this.updateImageMapAndGetImageTaskQueue(Cn,eo,$e.patternDependencies),ao())},void 0,!1,Qr):(Cn=new Map,Vo=new Map)}if($e.elevationFeatures&&$e.elevationFeatures.length>0){const Ur=[];for(const to of Object.values(xe))if(to instanceof i.ba){const Dn=to.getUnevaluatedPortalGraph();Dn&&Ur.push(Dn)}const Wn=i.fs.evaluate(Ur);for(const to of Object.values(xe))if(to instanceof i.ba){const Dn=st.layers[ye.decode(to.sourceLayerIndex)];to.setEvaluatedPortalGraph(Wn,Dn,this.tileID.canonical,$e.availableImages,$e.brightness)}}ao()};Di.length>0?Promise.allSettled(Di).then(Ki).catch(oe):Ki()}updateParameters(st){this.scaleFactor=st.scaleFactor,this.showCollisionBoxes=st.showCollisionBoxes,this.projection=st.projection,this.brightness=st.brightness,this.tileTransform=i.aY(st.tileID.canonical,st.projection),this.extraShadowCaster=st.extraShadowCaster,this.lut=st.lut,this.worldview=st.worldview,this.indoor=st.indoor}rasterizeIfNeeded(st,tt,wt,Bt){Array.from(tt.values()).some(Ht=>Ht.usvg)?this.rasterize(st,tt,wt,Bt):Bt()}updateImageMapAndGetImageTaskQueue(st,tt,wt){const Bt=new Map;for(const Ht of tt.keys()){const oe=wt.get(Ht)||[];for(const ye of oe){const Yt=ye.toString(),xe=tt.get(ye.id.toString());xe.usvg?Bt.has(Yt)||(Bt.set(Yt,ye),st.set(Yt,Object.assign({},xe))):st.set(Yt,xe)}}return Bt}rasterize(st,tt,wt,Bt){this.rasterizeTask=st.send("rasterizeImages",{scope:this.scope,tasks:wt},(Ht,oe)=>{if(!Ht)for(const[ye,Yt]of oe.entries()){const xe=Object.assign(tt.get(ye),{data:Yt});tt.set(ye,xe)}Bt()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function no(se,st,tt,wt,Bt){const Ht=new i.ac(st,{brightness:tt,worldview:Bt});for(const oe of se)oe.recalculate(Ht,wt)}class bo extends i.E{constructor(st,tt,wt,Bt,Ht,oe,ye){super(),this.actor=st,this.layerIndex=tt,this.availableImages=wt,this.availableModels=Bt,this.loadVectorData=oe||i.aL,this.loading={},this.loaded={},this.deduped=new i.aK(st.scheduler),this.isSpriteLoaded=Ht,this.scheduler=st.scheduler,this.brightness=ye}loadTile(st,tt){const wt=st.uid,Bt=st&&st.request,Ht=Bt&&Bt.collectResourceTiming,oe=this.loading[wt]=new $o(st);oe.abort=this.loadVectorData(st,(ye,Yt)=>{const xe=!this.loading[wt];if(delete this.loading[wt],oe.cancelRasterize(),xe||ye||!Yt)return oe.status="done",xe||(this.loaded[wt]=oe),tt(ye);const ti=Yt.rawData,$e={},Di=i.aM(Yt.responseHeaders);Di&&Di.expires&&($e.expires=Di.expires),Di&&Di.cacheControl&&($e.cacheControl=Di.cacheControl),oe.vectorTile=Yt.vectorTile||new i.fy(new i.bs(ti));const er=()=>{oe.parse(oe.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Ki,Hi)=>{if(Ki||!Hi)return tt(Ki);const gr={};if(Ht){const Qi=Le(Bt);Qi.length>0&&(gr.resourceTiming=JSON.parse(JSON.stringify(Qi)))}tt(null,Object.assign({rawTileData:ti.slice(0),responseHeaders:Yt.responseHeaders},Hi,$e,gr))})};this.isSpriteLoaded?er():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(er,{type:"parseTile",isSymbolTile:st.isSymbolTile,zoom:st.tileZoom}):er()}),this.loaded=this.loaded||{},this.loaded[wt]=oe})}reloadTile(st,tt){const wt=this.loaded,Bt=st.uid;if(wt&&wt[Bt]){const Ht=wt[Bt];Ht.updateParameters(st);const oe=(ye,Yt)=>{const xe=Ht.reloadCallback;xe&&(delete Ht.reloadCallback,Ht.parse(Ht.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,xe)),tt(ye,Yt)};Ht.status==="parsing"?Ht.reloadCallback=oe:Ht.status==="done"&&(Ht.vectorTile?Ht.parse(Ht.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,oe):oe())}else tt(null,void 0)}abortTile(st,tt){const wt=st.uid,Bt=this.loading[wt];Bt&&(Bt.abort&&Bt.abort(),delete this.loading[wt]),tt()}removeTile(st,tt){const wt=this.loaded,Bt=st.uid;wt&&wt[Bt]&&delete wt[Bt],tt()}}class ba{loadTile(st,tt){const{uid:wt,encoding:Bt,rawImageData:Ht,padding:oe}=st,ye=ImageBitmap&&Ht instanceof ImageBitmap?this.getImageData(Ht,oe):Ht;tt(null,new i.fz(wt,ye,Bt,oe<1))}reloadTile(st,tt){tt(null,null)}abortTile(st,tt){tt()}removeTile(st,tt){tt()}getImageData(st,tt){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(st.width,st.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=st.width,this.offscreenCanvas.height=st.height,this.offscreenCanvasContext.drawImage(st,0,0,st.width,st.height);const wt=this.offscreenCanvasContext.getImageData(-tt,-tt,st.width+2*tt,st.height+2*tt);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),wt}}i.br.setPbf(i.bs);class Os{constructor(st){this._mrt=new i.br(st.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=st.uid,this.tileID=st.tileID,this.source=st.source}parse(st,tt){const wt=this._mrt;this.status="parsing",this._entireBuffer=st;try{wt.parseHeader(st),this._isHeaderLoaded=!0;const Bt=[];for(const Ht in wt.layers){const oe=wt.getLayer(Ht),ye=oe.getDataRange(oe.getBandList()),Yt=wt.createDecodingTask(ye),xe=st.slice(ye.firstByte,ye.lastByte+1),ti=i.br.performDecoding(xe,Yt).then($e=>Yt.complete(null,$e)).catch($e=>Yt.complete($e,null));Bt.push(ti)}Promise.allSettled(Bt).then(()=>tt(null,wt)).catch(Ht=>tt(Ht))}catch(Bt){tt(Bt)}}}class Ya{constructor(st){this.actor=st,this.loading={},this.loaded={}}loadTile(st,tt){const wt=st.uid,Bt=st.request,Ht=this.loading[wt]=new Os(st),{cancel:oe}=i.bt(Bt,(ye,Yt,xe)=>{const ti=!this.loading[wt];if(delete this.loading[wt],ti||ye||!Yt)return Ht.status="done",ti||(this.loaded[wt]=Ht),tt(ye);Ht.parse(Yt,($e,Di)=>{if($e||!Di)return tt($e);tt(null,Di,xe)}),this.loaded[wt]=Ht});Ht.abort=oe}reloadTile(st,tt){tt(null,void 0)}abortTile(st,tt){const wt=st.uid,Bt=this.loading[wt];Bt&&(Bt.abort&&Bt.abort(),delete this.loading[wt]),tt()}removeTile(st,tt){const wt=st.uid;this.loaded[wt]&&delete this.loaded[wt],tt()}decodeRasterArray(st,tt){i.br.performDecoding(st.buffer,st.task).then(wt=>tt(null,wt)).catch(wt=>tt(wt))}}const al=i.fA.prototype.toGeoJSON;class Ja{constructor(st){this._feature=st,this.extent=i.al,this.type=st.type,this.properties=st.tags,"id"in st&&!isNaN(st.id)&&(this.id=parseInt(st.id,10))}loadGeometry(){if(this._feature.type===1){const st=[];for(const tt of this._feature.geometry)st.push([new i.P(tt[0],tt[1])]);return st}{const st=[];for(const tt of this._feature.geometry){const wt=[];for(const Bt of tt)wt.push(new i.P(Bt[0],Bt[1]));st.push(wt)}return st}}toGeoJSON(st,tt,wt){return al.call(this,st,tt,wt)}}class Hr{constructor(st,tt){this.name=st,this.extent=i.al,this.length=tt.length,this._jsonFeatures=tt}feature(st){return new Ja(this._jsonFeatures[st])}}class sc{constructor(st){this.layers={},this.extent=i.al;for(const tt of Object.keys(st))this.layers[tt]=new Hr(tt,st[tt])}}const cs=64/4096,Kn=128;class hn{constructor(){this.features=new Map}clear(){this.features.clear()}load(st=[],tt){for(const wt of st){const Bt=wt.id;if(Bt==null)continue;let Ht=this.features.get(Bt);Ht&&this.updateCache(Ht,tt),wt.geometry?(Ht=zn(wt),this.updateCache(Ht,tt),this.features.set(Bt,Ht)):this.features.delete(Bt),this.updateCache(Ht,tt)}}updateCache(st,tt){for(const{canonical:wt,uid:Bt}of Object.values(tt)){const{z:Ht,x:oe,y:ye}=wt;Co(st,Math.pow(2,Ht),oe,ye)&&delete tt[Bt]}}getTile(st,tt,wt){const Bt=Math.pow(2,st),Ht=[];for(const oe of this.features.values())Co(oe,Bt,tt,wt)&&Ht.push(Hn(oe,Bt,tt,wt));return{features:Ht}}getFeatures(){return[...this.features.values()]}}function Co({minX:se,minY:st,maxX:tt,maxY:wt},Bt,Ht,oe){return se<(Ht+1+cs)/Bt&&st<(oe+1+cs)/Bt&&tt>(Ht-cs)/Bt&&wt>(oe-cs)/Bt}function zn(se){const{id:st,geometry:tt,properties:wt}=se;if(!tt)return;if(tt.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Bt,coordinates:Ht}=tt,oe={id:st,type:1,geometry:[],tags:wt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},ye=oe.geometry;if(Bt==="Point")Ys(Ht,ye,oe);else if(Bt==="MultiPoint")for(const Yt of Ht)Ys(Yt,ye,oe);else if(Bt==="LineString")oe.type=2,vs(Ht,ye,oe);else if(Bt==="MultiLineString")oe.type=2,Ps(Ht,ye,oe);else if(Bt==="Polygon")oe.type=3,Ps(Ht,ye,oe,!0);else{if(Bt!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");oe.type=3;for(const Yt of Ht)Ps(Yt,ye,oe,!0)}return oe}function Ys([se,st],tt,wt){const Bt=i.aF(se);let Ht=i.aJ(st);Ht=Ht<0?0:Ht>1?1:Ht,tt.push(Bt,Ht),wt.minX=Math.min(wt.minX,Bt),wt.minY=Math.min(wt.minY,Ht),wt.maxX=Math.max(wt.maxX,Bt),wt.maxY=Math.max(wt.maxY,Ht)}function vs(se,st,tt,wt=!1,Bt=!1){const Ht=[];for(const oe of se)Ys(oe,Ht,tt);st.push(Ht),wt&&function(oe,ye){let Yt=0;for(let xe=0,ti=oe.length,$e=ti-2;xe<ti;$e=xe,xe+=2)Yt+=(oe[xe]-oe[$e])*(oe[xe+1]+oe[$e+1]);if(Yt>0===ye)for(let xe=0,ti=oe.length;xe<ti/2;xe+=2){const $e=oe[xe],Di=oe[xe+1];oe[xe]=oe[ti-2-xe],oe[xe+1]=oe[ti-1-xe],oe[ti-2-xe]=$e,oe[ti-1-xe]=Di}}(Ht,Bt)}function Ps(se,st,tt,wt=!1){for(let Bt=0;Bt<se.length;Bt++)vs(se[Bt],st,tt,wt,Bt===0)}function Hn(se,st,tt,wt){const{id:Bt,type:Ht,geometry:oe,tags:ye}=se,Yt=[];if(Ht===1)(function(xe,ti,$e,Di,er){for(let Ki=0;Ki<xe.length;Ki+=2){const Hi=Math.round(i.al*(xe[Ki+0]*ti-$e)),gr=Math.round(i.al*(xe[Ki+1]*ti-Di));er.push([Hi,gr])}})(oe,st,tt,wt,Yt);else for(const xe of oe)di(xe,st,tt,wt,Yt);return{id:Bt,type:Ht,geometry:Yt,tags:ye}}function di(se,st,tt,wt,Bt){const Ht=-Kn,oe=i.al+Kn;let ye;for(let Yt=0;Yt<se.length-2;Yt+=2){let xe=Math.round(i.al*(se[Yt+0]*st-tt)),ti=Math.round(i.al*(se[Yt+1]*st-wt)),$e=Math.round(i.al*(se[Yt+2]*st-tt)),Di=Math.round(i.al*(se[Yt+3]*st-wt));const er=$e-xe,Ki=Di-ti;xe<Ht&&$e<Ht||(xe<Ht?(ti+=Math.round(Ki*((Ht-xe)/er)),xe=Ht):$e<Ht&&(Di=ti+Math.round(Ki*((Ht-xe)/er)),$e=Ht),ti<Ht&&Di<Ht||(ti<Ht?(xe+=Math.round(er*((Ht-ti)/Ki)),ti=Ht):Di<Ht&&($e=xe+Math.round(er*((Ht-ti)/Ki)),Di=Ht),xe>=oe&&$e>=oe||(xe>=oe?(ti+=Math.round(Ki*((oe-xe)/er)),xe=oe):$e>=oe&&(Di=ti+Math.round(Ki*((oe-xe)/er)),$e=oe),ti>=oe&&Di>=oe||(ti>=oe?(xe+=Math.round(er*((oe-ti)/Ki)),ti=oe):Di>=oe&&($e=xe+Math.round(er*((oe-ti)/Ki)),Di=oe),ye&&xe===ye[ye.length-1][0]&&ti===ye[ye.length-1][1]||(ye=[[xe,ti]],Bt.push(ye)),ye.push([$e,Di])))))}}function tr({name:se,features:st},tt){tt.writeStringField(1,se),tt.writeVarintField(5,i.al);const wt=new Map,Bt=new Map,Ht={keys:wt,values:Bt,feature:null};for(const oe of st)Ht.feature=oe,tt.writeMessage(2,fr,Ht);for(const oe of wt.keys())tt.writeStringField(3,oe);for(const oe of Bt.keys())tt.writeMessage(4,$n,oe)}function fr(se,st){const tt=se.feature;tt.id!==void 0&&Number.isSafeInteger(+tt.id)&&st.writeVarintField(1,+tt.id),tt.tags&&st.writeMessage(2,Wr,se),st.writeVarintField(3,tt.type),st.writeMessage(4,Xr,tt)}function Wr({keys:se,values:st,feature:tt},wt){for(const Bt of Object.keys(tt.tags)){let Ht=tt.tags[Bt];if(Ht===null)continue;let oe=se.get(Bt);oe===void 0&&(oe=se.size,se.set(Bt,oe)),wt.writeVarint(oe);const ye=typeof Ht;ye!=="string"&&ye!=="boolean"&&ye!=="number"&&(Ht=JSON.stringify(Ht));let Yt=st.get(Ht);Yt===void 0&&(Yt=st.size,st.set(Ht,Yt)),wt.writeVarint(Yt)}}function qr(se,st){return(st<<3)+(7&se)}function Xi(se){return se<<1^se>>31}function Xr(se,st){const{geometry:tt,type:wt}=se;let Bt=0,Ht=0;if(wt===1){st.writeVarint(qr(1,tt.length));for(const oe of tt){const ye=oe[0]-Bt,Yt=oe[1]-Ht;st.writeVarint(Xi(ye)),st.writeVarint(Xi(Yt)),Bt+=ye,Ht+=Yt}}else for(const oe of tt){st.writeVarint(qr(1,1));const ye=oe.length-(wt===3?1:0);for(let Yt=0;Yt<ye;Yt++){Yt===1&&st.writeVarint(qr(2,ye-1));const xe=oe[Yt][0]-Bt,ti=oe[Yt][1]-Ht;st.writeVarint(Xi(xe)),st.writeVarint(Xi(ti)),Bt+=xe,Ht+=ti}wt===3&&st.writeVarint(qr(7,1))}}function $n(se,st){const tt=typeof se;tt==="string"?st.writeStringField(1,se):tt==="boolean"?st.writeBooleanField(7,se):tt==="number"&&(se%1!=0?st.writeDoubleField(3,se):se<0?st.writeSVarintField(6,se):st.writeVarintField(5,se))}const qo={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:se=>se},On=Math.fround||(ho=new Float32Array(1),se=>(ho[0]=+se,ho[0]));var ho;const ds=3,Ns=5,xo=6;class oo{constructor(st){this.options=Object.assign(Object.create(qo),st),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(st){const{log:tt,minZoom:wt,maxZoom:Bt}=this.options;tt&&console.time("total time");const Ht=`prepare ${st.length} points`;tt&&console.time(Ht),this.points=st;const oe=[];for(let Yt=0;Yt<st.length;Yt++){const xe=st[Yt];if(!xe.geometry)continue;const[ti,$e]=xe.geometry.coordinates,Di=On(Ms(ti)),er=On(wa($e));oe.push(Di,er,1/0,Yt,-1,1),this.options.reduce&&oe.push(0)}let ye=this.trees[Bt+1]=this._createTree(oe);tt&&console.timeEnd(Ht);for(let Yt=Bt;Yt>=wt;Yt--){const xe=+Date.now();ye=this.trees[Yt]=this._createTree(this._cluster(ye,Yt)),tt&&console.log("z%d: %d clusters in %dms",Yt,ye.numItems,+Date.now()-xe)}return tt&&console.timeEnd("total time"),this}getClusters(st,tt){let wt=((st[0]+180)%360+360)%360-180;const Bt=Math.max(-90,Math.min(90,st[1]));let Ht=st[2]===180?180:((st[2]+180)%360+360)%360-180;const oe=Math.max(-90,Math.min(90,st[3]));if(st[2]-st[0]>=360)wt=-180,Ht=180;else if(wt>Ht){const $e=this.getClusters([wt,Bt,180,oe],tt),Di=this.getClusters([-180,Bt,Ht,oe],tt);return $e.concat(Di)}const ye=this.trees[this._limitZoom(tt)],Yt=ye.range(Ms(wt),wa(oe),Ms(Ht),wa(Bt)),xe=ye.data,ti=[];for(const $e of Yt){const Di=this.stride*$e;ti.push(xe[Di+Ns]>1?ll(xe,Di,this.clusterProps):this.points[xe[Di+ds]])}return ti}getChildren(st){const tt=this._getOriginId(st),wt=this._getOriginZoom(st),Bt="No cluster with the specified id.",Ht=this.trees[wt];if(!Ht)throw new Error(Bt);const oe=Ht.data;if(tt*this.stride>=oe.length)throw new Error(Bt);const ye=this.options.radius/(this.options.extent*Math.pow(2,wt-1)),Yt=Ht.within(oe[tt*this.stride],oe[tt*this.stride+1],ye),xe=[];for(const ti of Yt){const $e=ti*this.stride;oe[$e+4]===st&&xe.push(oe[$e+Ns]>1?ll(oe,$e,this.clusterProps):this.points[oe[$e+ds]])}if(xe.length===0)throw new Error(Bt);return xe}getLeaves(st,tt,wt){const Bt=[];return this._appendLeaves(Bt,st,tt=tt||10,wt=wt||0,0),Bt}getTile(st,tt,wt){const Bt=this.trees[this._limitZoom(st)],Ht=Math.pow(2,st),{extent:oe,radius:ye}=this.options,Yt=ye/oe,xe=(wt-Yt)/Ht,ti=(wt+1+Yt)/Ht,$e={features:[]};return this._addTileFeatures(Bt.range((tt-Yt)/Ht,xe,(tt+1+Yt)/Ht,ti),Bt.data,tt,wt,Ht,$e),tt===0&&this._addTileFeatures(Bt.range(1-Yt/Ht,xe,1,ti),Bt.data,Ht,wt,Ht,$e),tt===Ht-1&&this._addTileFeatures(Bt.range(0,xe,Yt/Ht,ti),Bt.data,-1,wt,Ht,$e),$e.features.length?$e:null}getClusterExpansionZoom(st){let tt=this._getOriginZoom(st)-1;for(;tt<=this.options.maxZoom;){const wt=this.getChildren(st);if(tt++,wt.length!==1)break;st=wt[0].properties.cluster_id}return tt}_appendLeaves(st,tt,wt,Bt,Ht){const oe=this.getChildren(tt);for(const ye of oe){const Yt=ye.properties;if(Yt&&Yt.cluster?Ht+Yt.point_count<=Bt?Ht+=Yt.point_count:Ht=this._appendLeaves(st,Yt.cluster_id,wt,Bt,Ht):Ht<Bt?Ht++:st.push(ye),st.length===wt)break}return Ht}_createTree(st){const tt=new i.c3(st.length/this.stride|0,this.options.nodeSize,Float32Array);for(let wt=0;wt<st.length;wt+=this.stride)tt.add(st[wt],st[wt+1]);return tt.finish(),tt.data=st,tt}_addTileFeatures(st,tt,wt,Bt,Ht,oe){for(const ye of st){const Yt=ye*this.stride,xe=tt[Yt+Ns]>1;let ti,$e,Di;if(xe)ti=$l(tt,Yt,this.clusterProps),$e=tt[Yt],Di=tt[Yt+1];else{const Hi=this.points[tt[Yt+ds]];ti=Hi.properties;const[gr,Qi]=Hi.geometry.coordinates;$e=Ms(gr),Di=wa(Qi)}const er={type:1,geometry:[[Math.round(this.options.extent*($e*Ht-wt)),Math.round(this.options.extent*(Di*Ht-Bt))]],tags:ti};let Ki;Ki=xe||this.options.generateId?tt[Yt+ds]:this.points[tt[Yt+ds]].id,Ki!==void 0&&(er.id=Ki),oe.features.push(er)}}_limitZoom(st){return Math.max(this.options.minZoom,Math.min(Math.floor(+st),this.options.maxZoom+1))}_cluster(st,tt){const{radius:wt,extent:Bt,reduce:Ht,minPoints:oe}=this.options,ye=wt/(Bt*Math.pow(2,tt)),Yt=st.data,xe=[],ti=this.stride;for(let $e=0;$e<Yt.length;$e+=ti){if(Yt[$e+2]<=tt)continue;Yt[$e+2]=tt;const Di=Yt[$e],er=Yt[$e+1],Ki=st.within(Yt[$e],Yt[$e+1],ye),Hi=Yt[$e+Ns];let gr=Hi;for(const Qi of Ki){const Cn=Qi*ti;Yt[Cn+2]>tt&&(gr+=Yt[Cn+Ns])}if(gr>Hi&&gr>=oe){let Qi,Cn=Di*Hi,Nn=er*Hi,Vo=-1;const Qr=($e/ti<<5)+(tt+1)+this.points.length;for(const ao of Ki){const gn=ao*ti;if(Yt[gn+2]<=tt)continue;Yt[gn+2]=tt;const Ur=Yt[gn+Ns];Cn+=Yt[gn]*Ur,Nn+=Yt[gn+1]*Ur,Yt[gn+4]=Qr,Ht&&(Qi||(Qi=this._map(Yt,$e,!0),Vo=this.clusterProps.length,this.clusterProps.push(Qi)),Ht(Qi,this._map(Yt,gn)))}Yt[$e+4]=Qr,xe.push(Cn/gr,Nn/gr,1/0,Qr,-1,gr),Ht&&xe.push(Vo)}else{for(let Qi=0;Qi<ti;Qi++)xe.push(Yt[$e+Qi]);if(gr>1)for(const Qi of Ki){const Cn=Qi*ti;if(!(Yt[Cn+2]<=tt)){Yt[Cn+2]=tt;for(let Nn=0;Nn<ti;Nn++)xe.push(Yt[Cn+Nn])}}}}return xe}_getOriginId(st){return st-this.points.length>>5}_getOriginZoom(st){return(st-this.points.length)%32}_map(st,tt,wt){if(st[tt+Ns]>1){const oe=this.clusterProps[st[tt+xo]];return wt?Object.assign({},oe):oe}const Bt=this.points[st[tt+ds]].properties,Ht=this.options.map(Bt);return wt&&Ht===Bt?Object.assign({},Ht):Ht}}function ll(se,st,tt){return{type:"Feature",id:se[st+ds],properties:$l(se,st,tt),geometry:{type:"Point",coordinates:[(wt=se[st],360*(wt-.5)),ql(se[st+1])]}};var wt}function $l(se,st,tt){const wt=se[st+Ns],Bt=wt>=1e4?`${Math.round(wt/1e3)}k`:wt>=1e3?Math.round(wt/100)/10+"k":wt,Ht=se[st+xo],oe=Ht===-1?{}:Object.assign({},tt[Ht]);return Object.assign(oe,{cluster:!0,cluster_id:se[st+ds],point_count:wt,point_count_abbreviated:Bt})}function Ms(se){return se/360+.5}function wa(se){const st=Math.sin(se*Math.PI/180),tt=.5-.25*Math.log((1+st)/(1-st))/Math.PI;return tt<0?0:tt>1?1:tt}function ql(se){const st=(180-360*se)*Math.PI/180;return 360*Math.atan(Math.exp(st))/Math.PI-90}function bs(se,st,tt,wt){let Bt=wt;const Ht=st+(tt-st>>1);let oe,ye=tt-st;const Yt=se[st],xe=se[st+1],ti=se[tt],$e=se[tt+1];for(let Di=st+3;Di<tt;Di+=3){const er=Cs(se[Di],se[Di+1],Yt,xe,ti,$e);if(er>Bt)oe=Di,Bt=er;else if(er===Bt){const Ki=Math.abs(Di-Ht);Ki<ye&&(oe=Di,ye=Ki)}}Bt>wt&&(oe-st>3&&bs(se,st,oe,wt),se[oe+2]=Bt,tt-oe>3&&bs(se,oe,tt,wt))}function Cs(se,st,tt,wt,Bt,Ht){let oe=Bt-tt,ye=Ht-wt;if(oe!==0||ye!==0){const Yt=((se-tt)*oe+(st-wt)*ye)/(oe*oe+ye*ye);Yt>1?(tt=Bt,wt=Ht):Yt>0&&(tt+=oe*Yt,wt+=ye*Yt)}return oe=se-tt,ye=st-wt,oe*oe+ye*ye}function cl(se,st,tt,wt){const Bt={id:se??null,type:st,geometry:tt,tags:wt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(st==="Point"||st==="MultiPoint"||st==="LineString")Ml(Bt,tt);else if(st==="Polygon")Ml(Bt,tt[0]);else if(st==="MultiLineString")for(const Ht of tt)Ml(Bt,Ht);else if(st==="MultiPolygon")for(const Ht of tt)Ml(Bt,Ht[0]);return Bt}function Ml(se,st){for(let tt=0;tt<st.length;tt+=3)se.minX=Math.min(se.minX,st[tt]),se.minY=Math.min(se.minY,st[tt+1]),se.maxX=Math.max(se.maxX,st[tt]),se.maxY=Math.max(se.maxY,st[tt+1])}function Cl(se,st,tt,wt){if(!st.geometry)return;const Bt=st.geometry.coordinates;if(Bt&&Bt.length===0)return;const Ht=st.geometry.type,oe=Math.pow(tt.tolerance/((1<<tt.maxZoom)*tt.extent),2);let ye=[],Yt=st.id;if(tt.promoteId?Yt=st.properties[tt.promoteId]:tt.generateId&&(Yt=wt||0),Ht==="Point")Vs(Bt,ye);else if(Ht==="MultiPoint")for(const xe of Bt)Vs(xe,ye);else if(Ht==="LineString")hl(Bt,ye,oe,!1);else if(Ht==="MultiLineString"){if(tt.lineMetrics){for(const xe of Bt)ye=[],hl(xe,ye,oe,!1),se.push(cl(Yt,"LineString",ye,st.properties));return}Ka(Bt,ye,oe,!1)}else if(Ht==="Polygon")Ka(Bt,ye,oe,!0);else{if(Ht!=="MultiPolygon"){if(Ht==="GeometryCollection"){for(const xe of st.geometry.geometries)Cl(se,{id:Yt,geometry:xe,properties:st.properties},tt,wt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const xe of Bt){const ti=[];Ka(xe,ti,oe,!0),ye.push(ti)}}se.push(cl(Yt,Ht,ye,st.properties))}function Vs(se,st){st.push(Zl(se[0]),Da(se[1]),0)}function hl(se,st,tt,wt){let Bt,Ht,oe=0;for(let Yt=0;Yt<se.length;Yt++){const xe=Zl(se[Yt][0]),ti=Da(se[Yt][1]);st.push(xe,ti,0),Yt>0&&(oe+=wt?(Bt*ti-xe*Ht)/2:Math.sqrt(Math.pow(xe-Bt,2)+Math.pow(ti-Ht,2))),Bt=xe,Ht=ti}const ye=st.length-3;st[2]=1,bs(st,0,ye,tt),st[ye+2]=1,st.size=Math.abs(oe),st.start=0,st.end=st.size}function Ka(se,st,tt,wt){for(let Bt=0;Bt<se.length;Bt++){const Ht=[];hl(se[Bt],Ht,tt,wt),st.push(Ht)}}function Zl(se){return se/360+.5}function Da(se){const st=Math.sin(se*Math.PI/180),tt=.5-.25*Math.log((1+st)/(1-st))/Math.PI;return tt<0?0:tt>1?1:tt}function so(se,st,tt,wt,Bt,Ht,oe,ye){if(wt/=st,Ht>=(tt/=st)&&oe<wt)return se;if(oe<tt||Ht>=wt)return null;const Yt=[];for(const xe of se){const ti=xe.geometry;let $e=xe.type;const Di=Bt===0?xe.minX:xe.minY,er=Bt===0?xe.maxX:xe.maxY;if(Di>=tt&&er<wt){Yt.push(xe);continue}if(er<tt||Di>=wt)continue;let Ki=[];if($e==="Point"||$e==="MultiPoint")we(ti,Ki,tt,wt,Bt);else if($e==="LineString")St(ti,Ki,tt,wt,Bt,!1,ye.lineMetrics);else if($e==="MultiLineString")Nt(ti,Ki,tt,wt,Bt,!1);else if($e==="Polygon")Nt(ti,Ki,tt,wt,Bt,!0);else if($e==="MultiPolygon")for(const Hi of ti){const gr=[];Nt(Hi,gr,tt,wt,Bt,!0),gr.length&&Ki.push(gr)}if(Ki.length){if(ye.lineMetrics&&$e==="LineString"){for(const Hi of Ki)Yt.push(cl(xe.id,$e,Hi,xe.tags));continue}$e!=="LineString"&&$e!=="MultiLineString"||(Ki.length===1?($e="LineString",Ki=Ki[0]):$e="MultiLineString"),$e!=="Point"&&$e!=="MultiPoint"||($e=Ki.length===3?"Point":"MultiPoint"),Yt.push(cl(xe.id,$e,Ki,xe.tags))}}return Yt.length?Yt:null}function we(se,st,tt,wt,Bt){for(let Ht=0;Ht<se.length;Ht+=3){const oe=se[Ht+Bt];oe>=tt&&oe<=wt&&ce(st,se[Ht],se[Ht+1],se[Ht+2])}}function St(se,st,tt,wt,Bt,Ht,oe){let ye=Pt(se);const Yt=Bt===0?ae:Fe;let xe,ti,$e=se.start;for(let gr=0;gr<se.length-3;gr+=3){const Qi=se[gr],Cn=se[gr+1],Nn=se[gr+2],Vo=se[gr+3],Qr=se[gr+4],ao=Bt===0?Qi:Cn,gn=Bt===0?Vo:Qr;let Ur=!1;oe&&(xe=Math.sqrt(Math.pow(Qi-Vo,2)+Math.pow(Cn-Qr,2))),ao<tt?gn>tt&&(ti=Yt(ye,Qi,Cn,Vo,Qr,tt),oe&&(ye.start=$e+xe*ti)):ao>wt?gn<wt&&(ti=Yt(ye,Qi,Cn,Vo,Qr,wt),oe&&(ye.start=$e+xe*ti)):ce(ye,Qi,Cn,Nn),gn<tt&&ao>=tt&&(ti=Yt(ye,Qi,Cn,Vo,Qr,tt),Ur=!0),gn>wt&&ao<=wt&&(ti=Yt(ye,Qi,Cn,Vo,Qr,wt),Ur=!0),!Ht&&Ur&&(oe&&(ye.end=$e+xe*ti),st.push(ye),ye=Pt(se)),oe&&($e+=xe)}let Di=se.length-3;const er=se[Di],Ki=se[Di+1],Hi=Bt===0?er:Ki;Hi>=tt&&Hi<=wt&&ce(ye,er,Ki,se[Di+2]),Di=ye.length-3,Ht&&Di>=3&&(ye[Di]!==ye[0]||ye[Di+1]!==ye[1])&&ce(ye,ye[0],ye[1],ye[2]),ye.length&&st.push(ye)}function Pt(se){const st=[];return st.size=se.size,st.start=se.start,st.end=se.end,st}function Nt(se,st,tt,wt,Bt,Ht){for(const oe of se)St(oe,st,tt,wt,Bt,Ht,!1)}function ce(se,st,tt,wt){se.push(st,tt,wt)}function ae(se,st,tt,wt,Bt,Ht){const oe=(Ht-st)/(wt-st);return ce(se,Ht,tt+(Bt-tt)*oe,1),oe}function Fe(se,st,tt,wt,Bt,Ht){const oe=(Ht-tt)/(Bt-tt);return ce(se,st+(wt-st)*oe,Ht,1),oe}function Jt(se,st){const tt=[];for(let wt=0;wt<se.length;wt++){const Bt=se[wt],Ht=Bt.type;let oe;if(Ht==="Point"||Ht==="MultiPoint"||Ht==="LineString")oe=De(Bt.geometry,st);else if(Ht==="MultiLineString"||Ht==="Polygon"){oe=[];for(const ye of Bt.geometry)oe.push(De(ye,st))}else if(Ht==="MultiPolygon"){oe=[];for(const ye of Bt.geometry){const Yt=[];for(const xe of ye)Yt.push(De(xe,st));oe.push(Yt)}}tt.push(cl(Bt.id,Ht,oe,Bt.tags))}return tt}function De(se,st){const tt=[];tt.size=se.size,se.start!==void 0&&(tt.start=se.start,tt.end=se.end);for(let wt=0;wt<se.length;wt+=3)tt.push(se[wt]+st,se[wt+1],se[wt+2]);return tt}function We(se,st){if(se.transformed)return se;const tt=1<<se.z,wt=se.x,Bt=se.y;for(const Ht of se.features){const oe=Ht.geometry,ye=Ht.type;if(Ht.geometry=[],ye===1)for(let Yt=0;Yt<oe.length;Yt+=2)Ht.geometry.push(ci(oe[Yt],oe[Yt+1],st,tt,wt,Bt));else for(let Yt=0;Yt<oe.length;Yt++){const xe=[];for(let ti=0;ti<oe[Yt].length;ti+=2)xe.push(ci(oe[Yt][ti],oe[Yt][ti+1],st,tt,wt,Bt));Ht.geometry.push(xe)}}return se.transformed=!0,se}function ci(se,st,tt,wt,Bt,Ht){return[Math.round(tt*(se*wt-Bt)),Math.round(tt*(st*wt-Ht))]}function ui(se,st,tt,wt,Bt){const Ht=st===Bt.maxZoom?0:Bt.tolerance/((1<<st)*Bt.extent),oe={features:[],numPoints:0,numSimplified:0,numFeatures:se.length,source:null,x:tt,y:wt,z:st,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ye of se)cr(oe,ye,Ht,Bt);return oe}function cr(se,st,tt,wt){const Bt=st.geometry,Ht=st.type,oe=[];if(se.minX=Math.min(se.minX,st.minX),se.minY=Math.min(se.minY,st.minY),se.maxX=Math.max(se.maxX,st.maxX),se.maxY=Math.max(se.maxY,st.maxY),Ht==="Point"||Ht==="MultiPoint")for(let ye=0;ye<Bt.length;ye+=3)oe.push(Bt[ye],Bt[ye+1]),se.numPoints++,se.numSimplified++;else if(Ht==="LineString")zr(oe,Bt,se,tt,!1,!1);else if(Ht==="MultiLineString"||Ht==="Polygon")for(let ye=0;ye<Bt.length;ye++)zr(oe,Bt[ye],se,tt,Ht==="Polygon",ye===0);else if(Ht==="MultiPolygon")for(let ye=0;ye<Bt.length;ye++){const Yt=Bt[ye];for(let xe=0;xe<Yt.length;xe++)zr(oe,Yt[xe],se,tt,!0,xe===0)}if(oe.length){let ye=st.tags||null;if(Ht==="LineString"&&wt.lineMetrics){ye={};for(const xe in st.tags)ye[xe]=st.tags[xe];ye.mapbox_clip_start=Bt.start/Bt.size,ye.mapbox_clip_end=Bt.end/Bt.size}const Yt={geometry:oe,type:Ht==="Polygon"||Ht==="MultiPolygon"?3:Ht==="LineString"||Ht==="MultiLineString"?2:1,tags:ye};st.id!==null&&(Yt.id=st.id),se.features.push(Yt)}}function zr(se,st,tt,wt,Bt,Ht){const oe=wt*wt;if(wt>0&&st.size<(Bt?oe:wt))return void(tt.numPoints+=st.length/3);const ye=[];for(let Yt=0;Yt<st.length;Yt+=3)(wt===0||st[Yt+2]>oe)&&(tt.numSimplified++,ye.push(st[Yt],st[Yt+1])),tt.numPoints++;Bt&&function(Yt,xe){let ti=0;for(let $e=0,Di=Yt.length,er=Di-2;$e<Di;er=$e,$e+=2)ti+=(Yt[$e]-Yt[er])*(Yt[$e+1]+Yt[er+1]);if(ti>0===xe)for(let $e=0,Di=Yt.length;$e<Di/2;$e+=2){const er=Yt[$e],Ki=Yt[$e+1];Yt[$e]=Yt[Di-2-$e],Yt[$e+1]=Yt[Di-1-$e],Yt[Di-2-$e]=er,Yt[Di-1-$e]=Ki}}(ye,Ht),se.push(ye)}const Ae={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Do{constructor(st,tt){const wt=(tt=this.options=function(Ht,oe){for(const ye in oe)Ht[ye]=oe[ye];return Ht}(Object.create(Ae),tt)).debug;if(wt&&console.time("preprocess data"),tt.maxZoom<0||tt.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(tt.promoteId&&tt.generateId)throw new Error("promoteId and generateId cannot be used together.");let Bt=function(Ht,oe){const ye=[];if(Ht.type==="FeatureCollection")for(let Yt=0;Yt<Ht.features.length;Yt++)Cl(ye,Ht.features[Yt],oe,Yt);else Cl(ye,Ht.type==="Feature"?Ht:{geometry:Ht},oe);return ye}(st,tt);this.tiles={},this.tileCoords=[],wt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",tt.indexMaxZoom,tt.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Bt=function(Ht,oe){const ye=oe.buffer/oe.extent;let Yt=Ht;const xe=so(Ht,1,-1-ye,ye,0,-1,2,oe),ti=so(Ht,1,1-ye,2+ye,0,-1,2,oe);return(xe||ti)&&(Yt=so(Ht,1,-ye,1+ye,0,-1,2,oe)||[],xe&&(Yt=Jt(xe,1).concat(Yt)),ti&&(Yt=Yt.concat(Jt(ti,-1)))),Yt}(Bt,tt),Bt.length&&this.splitTile(Bt,0,0,0),wt&&(Bt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(st,tt,wt,Bt,Ht,oe,ye){const Yt=[st,tt,wt,Bt],xe=this.options,ti=xe.debug;for(;Yt.length;){Bt=Yt.pop(),wt=Yt.pop(),tt=Yt.pop(),st=Yt.pop();const $e=1<<tt,Di=An(tt,wt,Bt);let er=this.tiles[Di];if(!er&&(ti>1&&console.time("creation"),er=this.tiles[Di]=ui(st,tt,wt,Bt,xe),this.tileCoords.push({z:tt,x:wt,y:Bt}),ti)){ti>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",tt,wt,Bt,er.numFeatures,er.numPoints,er.numSimplified),console.timeEnd("creation"));const Ur=`z${tt}`;this.stats[Ur]=(this.stats[Ur]||0)+1,this.total++}if(er.source=st,Ht==null){if(tt===xe.indexMaxZoom||er.numPoints<=xe.indexMaxPoints)continue}else{if(tt===xe.maxZoom||tt===Ht)continue;if(Ht!=null){const Ur=Ht-tt;if(wt!==oe>>Ur||Bt!==ye>>Ur)continue}}if(er.source=null,st.length===0)continue;ti>1&&console.time("clipping");const Ki=.5*xe.buffer/xe.extent,Hi=.5-Ki,gr=.5+Ki,Qi=1+Ki;let Cn=null,Nn=null,Vo=null,Qr=null,ao=so(st,$e,wt-Ki,wt+gr,0,er.minX,er.maxX,xe),gn=so(st,$e,wt+Hi,wt+Qi,0,er.minX,er.maxX,xe);st=null,ao&&(Cn=so(ao,$e,Bt-Ki,Bt+gr,1,er.minY,er.maxY,xe),Nn=so(ao,$e,Bt+Hi,Bt+Qi,1,er.minY,er.maxY,xe),ao=null),gn&&(Vo=so(gn,$e,Bt-Ki,Bt+gr,1,er.minY,er.maxY,xe),Qr=so(gn,$e,Bt+Hi,Bt+Qi,1,er.minY,er.maxY,xe),gn=null),ti>1&&console.timeEnd("clipping"),Yt.push(Cn||[],tt+1,2*wt,2*Bt),Yt.push(Nn||[],tt+1,2*wt,2*Bt+1),Yt.push(Vo||[],tt+1,2*wt+1,2*Bt),Yt.push(Qr||[],tt+1,2*wt+1,2*Bt+1)}}getTile(st,tt,wt){st=+st,tt=+tt,wt=+wt;const Bt=this.options,{extent:Ht,debug:oe}=Bt;if(st<0||st>24)return null;const ye=1<<st,Yt=An(st,tt=tt+ye&ye-1,wt);if(this.tiles[Yt])return We(this.tiles[Yt],Ht);oe>1&&console.log("drilling down to z%d-%d-%d",st,tt,wt);let xe,ti=st,$e=tt,Di=wt;for(;!xe&&ti>0;)ti--,$e>>=1,Di>>=1,xe=this.tiles[An(ti,$e,Di)];return xe&&xe.source?(oe>1&&(console.log("found parent tile z%d-%d-%d",ti,$e,Di),console.time("drilling down")),this.splitTile(xe.source,ti,$e,Di,st,tt,wt),oe>1&&console.timeEnd("drilling down"),this.tiles[Yt]?We(this.tiles[Yt],Ht):null):null}}function An(se,st,tt){return 32*((1<<se)*tt+st)+se}function Qn(se,st){const tt=se.tileID.canonical;if(!this._geoJSONIndex)return void st(null,null);const wt=this._geoJSONIndex.getTile(tt.z,tt.x,tt.y);if(!wt)return void st(null,null);const Bt=xe=>xe.tags&&"3d_elevation_id"in xe.tags&&"source"in xe.tags&&xe.tags.source==="elevation",Ht=wt.features.filter(xe=>Bt(xe));let oe={_geojsonTileLayer:wt.features};Ht.length>0&&(oe={_geojsonTileLayer:wt.features.filter(xe=>!Bt(xe)),hd_road_elevation:Ht});const ye=new sc(oe),Yt=function(xe){const ti=new i.bs;for(const $e of Object.keys(xe))ti.writeMessage(3,tr,{name:$e,features:xe[$e]});return ti.finish()}(oe).buffer;st(null,{vectorTile:ye,rawData:Yt})}class ar extends bo{constructor(st,tt,wt,Bt,Ht,oe,ye){super(st,tt,wt,Bt,Ht,Qn,ye),oe&&(this.loadGeoJSON=oe),this._dynamicIndex=new hn}loadData(st,tt){const wt=st&&st.request,Bt=wt&&wt.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(st,(Ht,oe)=>{if(Ht||!oe)return tt(Ht);if(typeof oe!="object")return tt(new Error(`Input data given to '${st.source}' is not a valid GeoJSON object.`));{try{if(st.filter){const Yt=i.U(st.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Yt.result==="error")throw new Error(Yt.value.map(xe=>`${xe.key}: ${xe.message}`).join(", "));oe.features=oe.features.filter(xe=>Yt.value.evaluate({zoom:0},xe))}st.dynamic?(oe.type==="Feature"&&(oe={type:"FeatureCollection",features:[oe]}),st.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(oe.features,this.loaded),st.cluster&&(oe.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=st.cluster?new oo(function({superclusterOptions:Yt,clusterProperties:xe}){if(!xe||!Yt)return Yt;const ti={},$e={},Di={accumulated:null,zoom:0},er={properties:null},Ki=Object.keys(xe);for(const Hi of Ki){const[gr,Qi]=xe[Hi],Cn=i.U(Qi),Nn=i.U(typeof gr=="string"?[gr,["accumulated"],["get",Hi]]:gr);ti[Hi]=Cn.value,$e[Hi]=Nn.value}return Yt.map=Hi=>{er.properties=Hi;const gr={};for(const Qi of Ki)gr[Qi]=ti[Qi].evaluate(Di,er);return gr},Yt.reduce=(Hi,gr)=>{er.properties=gr;for(const Qi of Ki)Di.accumulated=Hi[Qi],Hi[Qi]=$e[Qi].evaluate(Di,er)},Yt}(st)).load(oe.features):st.dynamic?this._dynamicIndex:function(Yt,xe){return new Do(Yt,xe)}(oe,st.geojsonVtOptions)}catch(Yt){return tt(Yt)}const ye={};if(Bt){const Yt=Le(wt);Yt&&(ye.resourceTiming={},ye.resourceTiming[st.source]=JSON.parse(JSON.stringify(Yt)))}tt(null,ye)}})}reloadTile(st,tt){const wt=this.loaded;return wt&&wt[st.uid]?st.partial?tt(null,void 0):super.reloadTile(st,tt):this.loadTile(st,tt)}loadGeoJSON(st,tt){if(st.request)i.m(st.request,tt);else{if(typeof st.data!="string")return tt(new Error(`Input data given to '${st.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return tt(null,JSON.parse(st.data))}catch{return tt(new Error(`Input data given to '${st.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(st,tt){try{tt(null,this._geoJSONIndex.getClusterExpansionZoom(st.clusterId))}catch(wt){tt(wt)}}getClusterChildren(st,tt){try{tt(null,this._geoJSONIndex.getChildren(st.clusterId))}catch(wt){tt(wt)}}getClusterLeaves(st,tt){try{tt(null,this._geoJSONIndex.getLeaves(st.clusterId,st.limit,st.offset))}catch(wt){tt(wt)}}}class bi{constructor(st,tt,wt){this.tileID=new i.aP(st.tileID.overscaledZ,st.tileID.wrap,st.tileID.canonical.z,st.tileID.canonical.x,st.tileID.canonical.y),this.tileZoom=st.tileZoom,this.uid=st.uid,this.zoom=st.zoom,this.canonical=st.tileID.canonical,this.pixelRatio=st.pixelRatio,this.tileSize=st.tileSize,this.source=st.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=st.projection,this.brightness=tt,this.worldview=wt}parse(st,tt,wt,Bt){this.status="parsing";const Ht=new i.aP(wt.tileID.overscaledZ,wt.tileID.wrap,wt.tileID.canonical.z,wt.tileID.canonical.x,wt.tileID.canonical.y),oe=[],ye=tt.familiesBySource[wt.source],Yt=new i.fm(Ht,wt.promoteId);Yt.bucketLayerIDs=[],Yt.is3DTile=!0,i.fB(st).then(xe=>{if(!xe)return Bt(new Error("Could not parse tile"));const ti=xe.json.extensionsUsed&&xe.json.extensionsUsed.includes("MAPBOX_mesh_features")||xe.json.asset.extras&&xe.json.asset.extras.MAPBOX_mesh_features,$e=xe.json.extensionsUsed&&xe.json.extensionsUsed.includes("EXT_meshopt_compression"),Di=new i.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const er in ye)for(const Ki of ye[er]){const Hi=Ki[0];Yt.bucketLayerIDs.push(Ki.map(Cn=>i.B(Cn.id,Cn.scope))),Hi.recalculate(Di,[]);const gr=i.fC(xe,1/i.d6(wt.tileID.canonical)),Qi=new i.fD(Ki,gr,Ht,ti,$e,this.brightness,Yt,this.worldview);ti||(Qi.needsUpload=!0),oe.push(Qi),Qi.evaluate(Hi)}this.status="done",Bt(null,{buckets:oe,featureIndex:Yt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(xe=>Bt(new Error(xe.message)))}}class Zo{constructor(st,tt,wt,Bt,Ht,oe,ye,Yt){this.actor=st,this.layerIndex=tt,this.availableImages=wt,this.availableModels=Bt,this.brightness=ye,this.loading={},this.loaded={},this.worldview=Yt}loadTile(st,tt){const wt=st.uid,Bt=this.loading[wt]=new bi(st,this.brightness,this.worldview);i.bt(st.request,(Ht,oe)=>{const ye=!this.loading[wt];return delete this.loading[wt],ye||Ht?(Bt.status="done",ye||(this.loaded[wt]=Bt),tt(Ht)):oe&&oe.byteLength!==0?void Bt.parse(oe,this.layerIndex,st,(Yt,xe)=>{Bt.status="done",this.loaded=this.loaded||{},this.loaded[wt]=Bt,Yt||!xe?tt(Yt):tt(null,xe)}):(Bt.status="done",this.loaded[wt]=Bt,tt())})}reloadTile(st,tt){const wt=this.loaded,Bt=st.uid;if(wt&&wt[Bt]){const Ht=wt[Bt];Ht.projection=st.projection,Ht.brightness=st.brightness;const oe=(ye,Yt)=>{Ht.reloadCallback&&(delete Ht.reloadCallback,this.loadTile(st,tt)),tt(ye,Yt)};Ht.status==="parsing"?Ht.reloadCallback=oe:Ht.status==="done"&&this.loadTile(st,tt)}}abortTile(st,tt){const wt=st.uid;this.loading[wt]&&delete this.loading[wt],tt()}removeTile(st,tt){const wt=this.loaded,Bt=st.uid;wt&&wt[Bt]&&delete wt[Bt],tt()}}class zo{constructor(st){this.self=st,this.actor=new i.fF(st,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new i.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=i.cl({name:"mercator"}),this.workerSourceTypes={vector:bo,geojson:ar,"raster-dem":ba,"raster-array":Ya,"batched-model":Zo},this.workerSources={},this.self.registerWorkerSource=(tt,wt)=>{if(this.workerSourceTypes[tt])throw new Error(`Worker source with name "${tt}" already registered.`);this.workerSourceTypes[tt]=wt},this.self.registerRTLTextPlugin=tt=>{if(i.fG.isParsed())throw new Error("RTL text plugin already registered.");i.fG.setState({pluginStatus:i.fH.parsed,pluginURL:i.fG.getPluginURL()}),i.fG.applyArabicShaping=tt.applyArabicShaping,i.fG.processBidirectionalText=tt.processBidirectionalText,i.fG.processStyledBidirectionalText=tt.processStyledBidirectionalText;for(const wt of this.rtlPluginParsingListeners)wt(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(st,tt,wt){delete this.layerIndexes[st],delete this.availableImages[st],delete this.availableModels[st],delete this.workerSources[st],wt()}checkIfReady(st,tt,wt){wt()}setReferrer(st,tt){this.referrer=tt}spriteLoaded(st,tt){this.isSpriteLoaded[st]||(this.isSpriteLoaded[st]={});const{scope:wt,isLoaded:Bt}=tt;if(this.isSpriteLoaded[st][wt]=Bt,this.workerSources[st]&&this.workerSources[st][wt])for(const Ht in this.workerSources[st][wt]){const oe=this.workerSources[st][wt][Ht];for(const ye in oe){const Yt=oe[ye];Yt instanceof bo&&(Yt.isSpriteLoaded=Bt,Yt.fire(new i.z("isSpriteLoaded")))}}}setImages(st,tt,wt){this.availableImages[st]||(this.availableImages[st]={});const{scope:Bt,images:Ht}=tt;if(this.availableImages[st][Bt]=Ht,this.workerSources[st]&&this.workerSources[st][Bt]){for(const oe in this.workerSources[st][Bt]){const ye=this.workerSources[st][Bt][oe];for(const Yt in ye)ye[Yt].availableImages=Ht}wt()}else wt()}setModels(st,{scope:tt,models:wt},Bt){if(this.availableModels[st]||(this.availableModels[st]={}),this.availableModels[st][tt]=wt,this.workerSources[st]&&this.workerSources[st][tt]){for(const Ht in this.workerSources[st][tt]){const oe=this.workerSources[st][tt][Ht];for(const ye in oe)oe[ye].availableModels=wt}Bt()}else Bt()}setProjection(st,tt){this.projections[st]=i.cl(tt)}setBrightness(st,tt,wt){this.brightness=tt,wt()}setWorldview(st,tt,wt){this.worldview=tt,wt()}setLayers(st,tt,wt){this.getLayerIndex(st,tt.scope).replace(tt.layers,tt.options),wt()}updateLayers(st,tt,wt){this.getLayerIndex(st,tt.scope).update(tt.layers,tt.removedIds,tt.options),wt()}loadTile(st,tt,wt){tt.projection=this.projections[st]||this.defaultProjection,this.getWorkerSource(st,tt.type,tt.source,tt.scope).loadTile(tt,wt)}decodeRasterArray(st,tt,wt){this.getWorkerSource(st,tt.type,tt.source,tt.scope).decodeRasterArray(tt,wt)}reloadTile(st,tt,wt){tt.projection=this.projections[st]||this.defaultProjection,this.getWorkerSource(st,tt.type,tt.source,tt.scope).reloadTile(tt,wt)}abortTile(st,tt,wt){this.getWorkerSource(st,tt.type,tt.source,tt.scope).abortTile(tt,wt)}removeTile(st,tt,wt){this.getWorkerSource(st,tt.type,tt.source,tt.scope).removeTile(tt,wt)}removeSource(st,tt,wt){if(!(this.workerSources[st]&&this.workerSources[st][tt.scope]&&this.workerSources[st][tt.scope][tt.type]&&this.workerSources[st][tt.scope][tt.type][tt.source]))return;const Bt=this.workerSources[st][tt.scope][tt.type][tt.source];delete this.workerSources[st][tt.scope][tt.type][tt.source],Bt.removeSource!==void 0?Bt.removeSource(tt,wt):wt()}loadWorkerSource(st,tt,wt){try{this.self.importScripts(tt.url),wt()}catch(Bt){wt(Bt.toString())}}syncRTLPluginState(st,tt,wt){if(i.fG.isParsed())wt(null,!0);else if(i.fG.isParsing())this.rtlPluginParsingListeners.push(wt);else try{i.fG.setState(tt);const Bt=i.fG.getPluginURL();!i.fG.isLoaded()||i.fG.isParsed()||i.fG.isParsing()||Bt==null||(i.fG.setState({pluginStatus:i.fH.parsing,pluginURL:i.fG.getPluginURL()}),this.self.importScripts(Bt),i.fG.isParsed()?wt(null,!0):this.rtlPluginParsingListeners.push(wt))}catch(Bt){wt(Bt.toString())}}setDracoUrl(st,tt){this.dracoUrl=tt}getAvailableImages(st,tt){this.availableImages[st]||(this.availableImages[st]={});let wt=this.availableImages[st][tt];return wt||(wt=[]),wt}getAvailableModels(st,tt){this.availableModels[st]||(this.availableModels[st]={});let wt=this.availableModels[st][tt];return wt||(wt={}),wt}getLayerIndex(st,tt){this.layerIndexes[st]||(this.layerIndexes[st]={});let wt=this.layerIndexes[st][tt];return wt||(wt=this.layerIndexes[st][tt]=new bn,wt.scope=tt),wt}getWorkerSource(st,tt,wt,Bt){const Ht=this.workerSources;return Ht[st]||(Ht[st]={}),Ht[st][Bt]||(Ht[st][Bt]={}),Ht[st][Bt][tt]||(Ht[st][Bt][tt]={}),this.isSpriteLoaded[st]||(this.isSpriteLoaded[st]={}),Ht[st][Bt][tt][wt]||(Ht[st][Bt][tt][wt]=new this.workerSourceTypes[tt]({send:(oe,ye,Yt,xe,ti,$e)=>this.actor.send(oe,ye,Yt,st,ti,$e),scheduler:this.actor.scheduler},this.getLayerIndex(st,Bt),this.getAvailableImages(st,Bt),this.getAvailableModels(st,Bt),this.isSpriteLoaded[st][Bt],void 0,this.brightness,this.worldview)),Ht[st][Bt][tt][wt]}rasterizeImagesWorker(st,tt,wt){const Bt=new Map;for(const[Ht,{image:oe,imageVariant:ye}]of tt.tasks.entries()){const Yt=this.imageRasterizer.rasterize(ye,oe,tt.scope,st);Bt.set(Ht,Yt)}wt(void 0,Bt)}removeRasterizedImages(st,tt,wt){this.imageRasterizer.removeImagesFromCacheByIds(tt.imageIds,tt.scope,st),wt()}enforceCacheSizeLimit(st,tt){i.fI(tt)}getWorkerPerformanceMetrics(st,tt,wt){wt(void 0,void 0)}}return i.fE(self)&&(self.worker=new zo(self)),zo}),qt(["./shared"],function(i){var Le="3.16.0";const wi={create:"create",load:"load",fullLoad:"fullLoad"},nr={mark(p){performance.mark(p)},measure(p,e,a){performance.measure(p,e,a)}};function bn(p){const e=p.name.split("?")[0];return i.a(e)&&e.includes("mapbox-gl.js")?"javascript":i.a(e)&&e.includes("mapbox-gl.css")?"css":i.b(e)?"fontRange":i.c(e)?"sprite":i.i(e)?"style":i.d(e)?"tilejson":"other"}var cn,Rr={},xr=function(){if(cn)return Rr;function p(f){return!e(f)}function e(f){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var w,I,M=new Blob([""],{type:"text/javascript"}),L=URL.createObjectURL(M);try{I=new Worker(L),w=!0}catch{w=!1}return I&&I.terminate(),URL.revokeObjectURL(L),w}()?function(){var w=document.createElement("canvas");w.width=w.height=1;var I=w.getContext("2d");if(!I)return!1;var M=I.getImageData(0,0,1,1);return M&&M.width===w.width}()?(a[y=f&&f.failIfMajorPerformanceCaveat]===void 0&&(a[y]=function(w){var I,M=function(L){var N=document.createElement("canvas"),V=Object.create(p.webGLContextAttributes);return V.failIfMajorPerformanceCaveat=L,N.getContext("webgl2",V)}(w);if(!M)return!1;try{I=M.createShader(M.VERTEX_SHADER)}catch{return!1}return!(!I||M.isContextLost())&&(M.shaderSource(I,"void main() {}"),M.compileShader(I),M.getShaderParameter(I,M.COMPILE_STATUS)===!0)}(y)),a[y]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var y}cn=1,Rr.supported=p,Rr.notSupportedReason=e;var a={};return p.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Rr}();function Ci(p,e,a){const f=document.createElement(p);return e!=null&&(f.className=e),a&&a.appendChild(f),f}function Re(p,e,a){const f=document.createElementNS("http://www.w3.org/2000/svg",p);for(const y of Object.keys(e))f.setAttributeNS(null,y,String(e[y]));return a&&a.appendChild(f),f}const Rn=typeof document<"u"?document.documentElement&&document.documentElement.style:null,pr=Rn&&Rn.userSelect!==void 0?"userSelect":"WebkitUserSelect";let $r;function En(){Rn&&pr&&($r=Rn[pr],Rn[pr]="none")}function $o(){Rn&&pr&&(Rn[pr]=$r)}function no(p){p.preventDefault(),p.stopPropagation(),window.removeEventListener("click",no,!0)}function bo(){window.addEventListener("click",no,!0),window.setTimeout(()=>{window.removeEventListener("click",no,!0)},0)}function ba(p,e){const a=p.getBoundingClientRect();return al(p,a,e)}function Os(p,e){const a=p.getBoundingClientRect(),f=[];for(let y=0;y<e.length;y++)f.push(al(p,a,e[y]));return f}function Ya(p){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&p.button===2&&p.ctrlKey?0:p.button}function al(p,e,a){const f=p.offsetWidth===e.width?1:p.offsetWidth/e.width;return new i.P((a.clientX-e.left)*f,(a.clientY-e.top)*f)}const Ja="01",Hr="NO_ACCESS_TOKEN";class sc{constructor(e,a,f){this._transformRequestFn=e,this._customAccessToken=a,this._silenceAuthErrors=!!f,this._createSkuToken()}_createSkuToken(){const e=function(){let a="";for(let f=0;f<10;f++)a+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Ja,a].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=e.token,this._skuTokenExpiresAt=e.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(e,a){return this._transformRequestFn&&this._transformRequestFn(e,a)||{url:e}}normalizeStyleURL(e,a){if(!i.h(e))return e;const f=Kn(e);return f.params.push(`sdk=js-${Le}`),f.path=`/styles/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeGlyphsURL(e,a){if(!i.h(e))return e;const f=Kn(e);return f.path=`/fonts/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeModelURL(e,a){if(!i.h(e))return e;const f=Kn(e);return f.path=`/models/v1${f.path}`,this._makeAPIURL(f,this._customAccessToken||a)}normalizeSourceURL(e,a,f,y){if(!i.h(e))return e;const w=Kn(e);return w.path=`/v4/${w.authority}.json`,w.params.push("secure"),f&&w.params.push(`language=${f}`),y&&w.params.push(`worldview=${y}`),this._makeAPIURL(w,this._customAccessToken||a)}normalizeIconsetURL(e,a){const f=Kn(e);return i.h(e)?(f.path=`/styles/v1${f.path}/iconset.pbf`,this._makeAPIURL(f,this._customAccessToken||a)):hn(f)}normalizeSpriteURL(e,a,f,y){const w=Kn(e);return i.h(e)?(w.path=`/styles/v1${w.path}/sprite${a}${f}`,this._makeAPIURL(w,this._customAccessToken||y)):(w.path+=`${a}${f}`,hn(w))}normalizeTileURL(e,a,f){if(this._isSkuTokenExpired()&&this._createSkuToken(),e&&!i.h(e))return e;const y=Kn(e);y.path=y.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${a||f&&y.authority!=="raster"&&f===512?"@2x":""}${i.k.supported?".webp":"$1"}`),y.authority==="raster"?y.path=`/${i.e.RASTER_URL_PREFIX}${y.path}`:y.authority==="rasterarrays"?y.path=`/${i.e.RASTERARRAYS_URL_PREFIX}${y.path}`:y.authority==="3dtiles"?y.path=`/${i.e.TILES3D_URL_PREFIX}${y.path}`:(y.path=y.path.replace(/^.+\/v4\//,"/"),y.path=`/${i.e.TILE_URL_VERSION}${y.path}`);const w=this._customAccessToken||function(I){for(const M of I){const L=M.match(/^access_token=(.*)$/);if(L)return L[1]}return null}(y.params)||i.e.ACCESS_TOKEN;return i.e.REQUIRE_ACCESS_TOKEN&&w&&this._skuToken&&y.params.push(`sku=${this._skuToken}`),this._makeAPIURL(y,w)}canonicalizeTileURL(e,a){const f=Kn(e);if(!f.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!f.path.match(/\.[\w]+$/))return e;let y="mapbox://";f.path.match(/^\/raster\/v1\//)?y+=`raster/${f.path.replace(`/${i.e.RASTER_URL_PREFIX}/`,"")}`:f.path.match(/^\/rasterarrays\/v1\//)?y+=`rasterarrays/${f.path.replace(`/${i.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:y+=`tiles/${f.path.replace(`/${i.e.TILE_URL_VERSION}/`,"")}`;let w=f.params;return a&&(w=w.filter(I=>!I.match(/^access_token=/))),w.length&&(y+=`?${w.join("&")}`),y}canonicalizeTileset(e,a){const f=!!a&&i.h(a),y=[];for(const w of e.tiles||[])i.j(w)?y.push(this.canonicalizeTileURL(w,f)):y.push(w);return y}_makeAPIURL(e,a){const f="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",y=Kn(i.e.API_URL);if(e.protocol=y.protocol,e.authority=y.authority,e.protocol==="http"){const w=e.params.indexOf("secure");w>=0&&e.params.splice(w,1)}if(y.path!=="/"&&(e.path=`${y.path}${e.path}`),!i.e.REQUIRE_ACCESS_TOKEN)return hn(e);if(a=a||i.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!a)throw new Error(`An API access token is required to use Mapbox GL. ${f}`);if(a[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${f}`)}return e.params=e.params.filter(w=>w.indexOf("access_token")===-1),e.params.push(`access_token=${a||""}`),hn(e)}}const cs=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Kn(p){const e=p.match(cs);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function hn(p){const e=p.params.length?`?${p.params.join("&")}`:"";return`${p.protocol}://${p.authority}${p.path}${e}`}const Co="mapbox.eventData";function zn(p){if(!p)return null;const e=p.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(i.l(e[1]))}catch{return null}}class Ys{constructor(e){this.type=e,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const a=zn(i.e.ACCESS_TOKEN);let f="";return f=a&&a.u?i.f(a.u):i.e.ACCESS_TOKEN||"",e?`${Co}.${e}:${f}`:`${Co}:${f}`}fetchEventData(){const e=i.s("localStorage"),a=this.getStorageKey(),f=this.getStorageKey("uuid"),y=this.getStorageKey("uuidTimestamp");if(e)try{const w=localStorage.getItem(a);w&&(this.eventData=JSON.parse(w));const I=localStorage.getItem(f);I&&(this.anonId=I);const M=localStorage.getItem(y);M&&(this.anonIdTimestamp=Number(M));const L=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<L)&&this.refreshUUID()}catch{i.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=i.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const e=i.s("localStorage"),a=this.getStorageKey(),f=this.getStorageKey("uuid"),y=this.getStorageKey("uuidTimestamp"),w=this.anonId,I=this.anonIdTimestamp;if(e&&w)try{localStorage.setItem(f,w),Object.keys(this.eventData).length>=1&&localStorage.setItem(a,JSON.stringify(this.eventData)),I&&localStorage.setItem(y,I.toString())}catch{i.w("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,a,f,y){if(!i.e.EVENTS_URL)return;const w=Kn(i.e.EVENTS_URL);w.params.push(`access_token=${y||i.e.ACCESS_TOKEN||""}`);const I={event:this.type,created:new Date(e).toISOString()},M=a?Object.assign(I,a):I,L={url:hn(w),headers:{"Content-Type":"text/plain"},body:JSON.stringify([M])};this.pendingRequest=i.p(L,N=>{this.pendingRequest=null,f(N),this.saveEventData(),this.processRequests(y)})}queueRequest(e,a){this.queue.push(e),this.processRequests(a)}}const vs=new class extends Ys{constructor(p){super("appUserTurnstile"),this._customAccessToken=p}postTurnstileEvent(p,e){i.e.EVENTS_URL&&i.e.ACCESS_TOKEN&&Array.isArray(p)&&p.some(a=>i.h(a)||i.j(a))&&this.queueRequest(Date.now(),e)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=zn(i.e.ACCESS_TOKEN),a=e?e.u:i.e.ACCESS_TOKEN;let f=a!==this.eventData.tokenU;i.v(this.anonId)||(this.refreshUUID(),f=!0);const y=this.queue.shift();if(this.eventData.lastSuccess){const w=new Date(this.eventData.lastSuccess),I=new Date(y),M=(y-this.eventData.lastSuccess)/864e5;f=f||M>=1||M<-1||w.getDate()!==I.getDate()}else f=!0;f?this.postEvent(y,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Le,skuId:Ja,"enabled.telemetry":!1,userId:this.anonId},w=>{w||(this.eventData.lastSuccess=y,this.eventData.tokenU=a)},p):this.processRequests()}},Ps=vs.postTurnstileEvent.bind(vs),Hn=new class extends Ys{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(p,e,a,f){this.skuToken=e,this.errorCb=f,i.e.EVENTS_URL&&(a||i.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},a):this.errorCb(new Error(Hr)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:a}=this.queue.shift();e&&this.success[e]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),i.v(this.anonId)||this.refreshUUID(),this.postEvent(a,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Le,skuId:Ja,skuToken:this.skuToken,userId:this.anonId},f=>{f?this.errorCb(f):e&&(this.success[e]=!0)},p))}remove(){this.errorCb=null}},di=Hn.postMapLoadEvent.bind(Hn),tr=new class extends Ys{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(p){let e=this.mapInstanceIdMap.get(p);return e||(e=i.u(),this.mapInstanceIdMap.set(p,e)),e}getEventId(p){const e=this.eventIdPerMapInstanceMap.get(p)||0;return this.eventIdPerMapInstanceMap.set(p,e+1),e}postStyleLoadEvent(p,e){const{map:a,style:f,importedStyles:y}=e;if(!i.e.EVENTS_URL||!p&&!i.e.ACCESS_TOKEN)return;const w=this.getMapInstanceId(a),I={mapInstanceId:w,eventId:this.getEventId(w),style:f};y.length&&(I.importedStyles=y),this.queueRequest({timestamp:Date.now(),payload:I},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,payload:a}=this.queue.shift();this.postEvent(e,a,()=>{},p)}},fr=tr.postStyleLoadEvent.bind(tr),Wr=new class extends Ys{constructor(p){super("metrics"),p&&(this.data=p)}postMetricsEvent(p){if(!i.e.EVENTS_URL||!p&&!i.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),i.v(this.anonId)||this.refreshUUID();const e=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:e},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,payload:a}=this.queue.shift();this.postEvent(e,a,()=>{},p)}}({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),qr=Wr.postMetricsEvent.bind(Wr),Xi=new class extends Ys{constructor(){super("gljs.performance")}postPerformanceEvent(p,e){i.e.EVENTS_URL&&(p||i.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:e},p)}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,performanceData:a}=this.queue.shift(),f=function(y){const w=performance.getEntriesByType("resource"),I=performance.getEntriesByType("mark"),M=function(X){const K={};if(X){for(const rt in X)if(rt!=="other")for(const ht of X[rt]){const lt=`${rt}ResolveRangeMin`,_t=`${rt}ResolveRangeMax`,Mt=`${rt}RequestCount`,vt=`${rt}RequestCachedCount`;K[lt]=Math.min(K[lt]||1/0,ht.startTime),K[_t]=Math.max(K[_t]||-1/0,ht.responseEnd);const Ut=Ct=>{K[Ct]===void 0&&(K[Ct]=0),++K[Ct]};ht.transferSize!==void 0&&ht.transferSize===0&&Ut(vt),Ut(Mt)}}return K}(function(X,K){const rt={};if(X)for(const ht of X){const lt=K(ht);rt[lt]===void 0&&(rt[lt]=[]),rt[lt].push(ht)}return rt}(w,bn)),L=window.devicePixelRatio,N=navigator.connection||navigator.mozConnection||navigator.webkitConnection,V=N?N.effectiveType:void 0,Z={counters:[],metadata:[],attributes:[]},U=(X,K,rt)=>{rt!=null&&X.push({name:K,value:rt.toString()})};for(const X in M)U(Z.counters,X,M[X]);if(y.interactionRange[0]!==1/0&&y.interactionRange[1]!==-1/0&&(U(Z.counters,"interactionRangeMin",y.interactionRange[0]),U(Z.counters,"interactionRangeMax",y.interactionRange[1])),I)for(const X of Object.values(wi)){const K=I.find(rt=>rt.name===X);K&&U(Z.counters,X,K.startTime)}return U(Z.counters,"visibilityHidden",y.visibilityHidden),U(Z.attributes,"style",function(X){if(X)for(const K of X){const rt=K.name.split("?")[0];if(i.i(rt)){const ht=rt.split("/").slice(-2);if(ht.length===2)return`mapbox://styles/${ht[0]}/${ht[1]}`}}}(w)),U(Z.attributes,"terrainEnabled",y.terrainEnabled?"true":"false"),U(Z.attributes,"fogEnabled",y.fogEnabled?"true":"false"),U(Z.attributes,"projection",y.projection),U(Z.attributes,"zoom",y.zoom),U(Z.metadata,"devicePixelRatio",L),U(Z.metadata,"connectionEffectiveType",V),U(Z.metadata,"navigatorUserAgent",navigator.userAgent),U(Z.metadata,"screenWidth",window.screen.width),U(Z.metadata,"screenHeight",window.screen.height),U(Z.metadata,"windowWidth",window.innerWidth),U(Z.metadata,"windowHeight",window.innerHeight),U(Z.metadata,"mapWidth",y.width/L),U(Z.metadata,"mapHeight",y.height/L),U(Z.metadata,"webglRenderer",y.renderer),U(Z.metadata,"webglVendor",y.vendor),U(Z.metadata,"sdkVersion",Le),U(Z.metadata,"sdkIdentifier","mapbox-gl-js"),Z}(a);for(const y of f.metadata);for(const y of f.counters);for(const y of f.attributes);this.postEvent(e,f,()=>{},p)}},Xr=Xi.postPerformanceEvent.bind(Xi),$n=new class extends Ys{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(p,e,a,f){if(!i.e.API_URL||!i.e.SESSION_PATH)return;const y=Kn(i.e.API_URL+i.e.SESSION_PATH);y.params.push(`sku=${e||""}`),y.params.push(`access_token=${f||i.e.ACCESS_TOKEN||""}`);const w={url:hn(y),headers:{"Content-Type":"text/plain"}};this.pendingRequest=i.g(w,I=>{this.pendingRequest=null,a(I),this.saveEventData(),this.processRequests(f)})}getSessionAPI(p,e,a,f){this.skuToken=e,this.errorCb=f,i.e.SESSION_PATH&&i.e.API_URL&&(a||i.e.ACCESS_TOKEN?this.queueRequest({id:p,timestamp:Date.now()},a):this.errorCb(new Error(Hr)))}processRequests(p){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:a}=this.queue.shift();e&&this.success[e]||this.getSession(a,this.skuToken,f=>{f?this.errorCb(f):e&&(this.success[e]=!0)},p)}remove(){this.errorCb=null}},qo=$n.getSessionAPI.bind($n),On=new Set;function ho(p,e){e?On.add(p):On.delete(p)}class ds{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(e,a){this._updatedSourceCaches[e]=a,this.setDirty()}discardSourceCacheUpdate(e){delete this._updatedSourceCaches[e]}updateLayer(e){const a=e.scope;this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._updatedLayers[a].add(e.id),this.setDirty()}removeLayer(e){const a=e.scope;this._removedLayers[a]=this._removedLayers[a]||{},this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._removedLayers[a][e.id]=e,this._updatedLayers[a].delete(e.id),this._updatedPaintProps.delete(e.fqid),this.setDirty()}getRemovedLayer(e){return this._removedLayers[e.scope]?this._removedLayers[e.scope][e.id]:null}discardLayerRemoval(e){this._removedLayers[e.scope]&&delete this._removedLayers[e.scope][e.id]}getLayerUpdatesByScope(){const e={};for(const a in this._updatedLayers)e[a]=e[a]||{},e[a].updatedIds=Array.from(this._updatedLayers[a].values());for(const a in this._removedLayers)e[a]=e[a]||{},e[a].removedIds=Object.keys(this._removedLayers[a]);return e}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(e){this._updatedPaintProps.add(e.fqid),this.setDirty()}getUpdatedImages(e){return this._updatedImages[e]?Array.from(this._updatedImages[e].values()):[]}updateImage(e,a){this._updatedImages[a]=this._updatedImages[a]||new Set,this._updatedImages[a].add(i.I.toString(e)),this.setDirty()}resetUpdatedImages(e){this._updatedImages[e]&&this._updatedImages[e].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Ns(p){const{userImage:e}=p;return!!(e&&e.render&&e.render())&&(p.data.replace(new Uint8Array(e.data.buffer)),!0)}class xo extends i.E{constructor(e){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=e,e!=="raster"&&i.r()&&(this.imageRasterizerDispatcher=new i.D(i.t(),this,"Image Rasterizer Worker",1))}addScope(e){this.loaded.set(e,!1),this.imageProviders.set(e,new Map),this.images.set(e,new Map),this.updatedImages.set(e,new Set),this.callbackDispatchedThisFrame.set(e,new Set),this.patterns.set(e,new Map),this.atlasImage.set(e,new i.q({width:1,height:1}))}removeScope(e){this.loaded.delete(e),this.imageProviders.delete(e),this.images.delete(e),this.updatedImages.delete(e),this.callbackDispatchedThisFrame.delete(e),this.patterns.delete(e),this.atlasImage.delete(e);const a=this.atlasTexture.get(e);a&&(a.destroy(),this.atlasTexture.delete(e))}addImageProvider(e,a){this.imageProviders.has(a)||this.imageProviders.set(a,new Map),this.imageProviders.get(a).set(e.id,e)}removeImageProvider(e,a){this.imageProviders.has(a)&&this.imageProviders.get(a).delete(e)}getPendingImageProviders(){const e=[];for(const a of this.imageProviders.values())for(const f of a.values())f.hasPendingRequests()&&e.push(f);return e}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new i.x),this._imageRasterizer}isLoaded(){for(const e of this.loaded.keys())if(!this.loaded.get(e))return!1;return!0}setLoaded(e,a){if(this.loaded.get(a)!==e&&(this.loaded.set(a,e),e)){for(const{ids:f,callback:y}of this.requestors)this._notify(f,a,y);this.requestors=[]}}hasImage(e,a){return!!this.getImage(e,a)}getImage(e,a){return this.images.get(a).get(e.toString())}addImage(e,a,f){this._validate(e,f)&&this.images.get(a).set(e.toString(),f)}_validate(e,a){let f=!0;return this._validateStretch(a.stretchX,a.data&&a.data.width)||(this.fire(new i.y(new Error(`Image "${e.name}" has invalid "stretchX" value`))),f=!1),this._validateStretch(a.stretchY,a.data&&a.data.height)||(this.fire(new i.y(new Error(`Image "${e.name}" has invalid "stretchY" value`))),f=!1),this._validateContent(a.content,a)||(this.fire(new i.y(new Error(`Image "${e.name}" has invalid "content" value`))),f=!1),f}_validateStretch(e,a){if(!e)return!0;let f=0;for(const y of e){if(y[0]<f||y[1]<y[0]||a<y[1])return!1;f=y[1]}return!0}_validateContent(e,a){return e?e.length!==4||!a.usvg&&(e[0]<0||a.data.width<e[0]||e[1]<0||a.data.height<e[1]||e[2]<0||a.data.width<e[2]||e[3]<0||a.data.height<e[3])?!1:!(e[2]<e[0]||e[3]<e[1]):!0}updateImage(e,a,f){const y=this.images.get(a).get(e.toString());f.version=y.version+1,this.images.get(a).set(e.toString(),f),this.updatedImages.get(a).add(e),this.removeFromImageRasterizerCache(e,a)}clearUpdatedImages(e){this.updatedImages.get(e).clear()}removeFromImageRasterizerCache(e,a){this.spriteFormat!=="raster"&&(i.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[e],scope:a}):this.imageRasterizer.removeImagesFromCacheByIds([e],a))}removeImage(e,a){const f=this.images.get(a),y=f.get(e.toString());f.delete(e.toString()),this.patterns.get(a).delete(e.toString()),this.removeFromImageRasterizerCache(e,a),y.userImage&&y.userImage.onRemove&&y.userImage.onRemove()}listImages(e){return Array.from(this.images.get(e).keys()).map(a=>i.I.from(a))}getImages(e,a,f){const y=[],w=[],I=this.imageProviders.get(a);for(const V of e){if(!V.iconsetId){y.push(V);continue}const Z=I.get(V.iconsetId);Z&&(this.getImage(V,a)?w.push(V):Z.addPendingRequest(V))}if(y.length===0)return void this._notify(w,a,f);let M=!0;const L=!!this.loaded.get(a),N=this.images.get(a);if(!L)for(const V of y)N.has(V.toString())||(M=!1);L||M?this._notify(y,a,f):this.requestors.push({ids:y,scope:a,callback:f})}rasterizeImages(e,a){const f=new Map,{tasks:y,scope:w}=e;for(const[I,M]of y.entries()){const L=this.getImage(M.id,w);L&&f.set(I,{image:L,imageVariant:M})}this._rasterizeImages(w,f,a)}_rasterizeImages(e,a,f){if(i.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:a,scope:e},f);else{const y=new Map;for(const[w,{image:I,imageVariant:M}]of a.entries())y.set(w,this.imageRasterizer.rasterize(M,I,e,0));f(void 0,y)}}getUpdatedImages(e){return this.updatedImages.get(e)||new Set}_notify(e,a,f){const y=this.images.get(a),w=new Map;for(const I of e){if(!y.get(I.toString())){if(I.iconsetId)continue;this.fire(new i.z("styleimagemissing",{id:I.name}))}const M=y.get(I.toString());if(!M){i.w(`Image "${I.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const L={data:M.usvg?null:M.data.clone(),pixelRatio:M.pixelRatio,sdf:M.sdf,usvg:M.usvg,version:M.version,stretchX:M.stretchX,stretchY:M.stretchY,content:M.content,hasRenderCallback:!!(M.userImage&&M.userImage.render)};M.usvg&&Object.assign(L,{width:M.icon.usvg_tree.width,height:M.icon.usvg_tree.height}),w.set(i.I.toString(I),L)}f(null,w)}getPixelSize(e){const{width:a,height:f}=this.atlasImage.get(e);return{width:a,height:f}}getPattern(e,a,f){const y=e.toString(),w=this.patterns.get(a),I=w.get(y),M=this.getImage(e,a);if(!M)return null;if(I){if(I.position.version===M.version)return I.position;I.position.version=M.version}else{if(M.usvg&&!M.data){const L=this.getPatternInFlightId(y,a);if(this.patternsInFlight.has(L))return null;this.patternsInFlight.add(L);const N=new i.A(e).scaleSelf(i.o.devicePixelRatio),V=new Map([[N.toString(),{image:M,imageVariant:N}]]);return this._rasterizeImages(a,V,(Z,U)=>this.storePatternImage(N,a,M,f,U)),null}this.storePattern(e,a,M)}return this._updatePatternAtlas(a,f),w.get(y).position}getPatternInFlightId(e,a){return i.B(e,a)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(e,a,f,y,w){const I=e.toString(),M=w?w.get(I):void 0;M&&(f.data=M,this.storePattern(e.id,a,f),this._updatePatternAtlas(a,y),this.patternsInFlight.delete(this.getPatternInFlightId(e.id.toString(),a)))}storePattern(e,a,f){const y={w:f.data.width+2*i.C,h:f.data.height+2*i.C,x:0,y:0},w=new i.F(y,f,i.C);this.patterns.get(a).set(e.toString(),{bin:y,position:w})}destroyAtlasTextures(){for(const e of this.atlasTexture.values())e&&e.destroy();this.atlasTexture.clear()}bind(e,a){const f=e.gl;let y=this.atlasTexture.get(a);y?this.dirty&&(y.update(this.atlasImage.get(a)),this.dirty=!1):(y=new i.T(e,this.atlasImage.get(a),f.RGBA8),this.atlasTexture.set(a,y)),y.bind(f.LINEAR,f.CLAMP_TO_EDGE)}_updatePatternAtlas(e,a){const f=this.patterns.get(e),y=Array.from(f.values()).map(({bin:N})=>N),{w,h:I}=i.G(y),M=this.atlasImage.get(e);M.resize({width:w||1,height:I||1});const L=this.images.get(e);for(const[N,{bin:V,position:Z}]of f.entries()){let U=Z.padding;const X=V.x+U,K=V.y+U,rt=L.get(N).data,ht=rt.width,lt=rt.height;U=U>1?U-1:U,i.q.copy(rt,M,{x:0,y:0},{x:X,y:K},{width:ht,height:lt},a),i.q.copy(rt,M,{x:0,y:lt-U},{x:X,y:K-U},{width:ht,height:U},a),i.q.copy(rt,M,{x:0,y:0},{x:X,y:K+lt},{width:ht,height:U},a),i.q.copy(rt,M,{x:ht-U,y:0},{x:X-U,y:K},{width:U,height:lt},a),i.q.copy(rt,M,{x:0,y:0},{x:X+ht,y:K},{width:U,height:lt},a),i.q.copy(rt,M,{x:ht-U,y:lt-U},{x:X-U,y:K-U},{width:U,height:U},a),i.q.copy(rt,M,{x:0,y:lt-U},{x:X+ht,y:K-U},{width:U,height:U},a),i.q.copy(rt,M,{x:0,y:0},{x:X+ht,y:K+lt},{width:U,height:U},a),i.q.copy(rt,M,{x:ht-U,y:0},{x:X-U,y:K+lt},{width:U,height:U},a)}this.dirty=!0}beginFrame(){for(const e of this.images.keys())this.callbackDispatchedThisFrame.set(e,new Set)}dispatchRenderCallbacks(e,a){const f=this.images.get(a);for(const y of e){if(this.callbackDispatchedThisFrame.get(a).has(y.toString()))continue;this.callbackDispatchedThisFrame.get(a).add(y.toString());const w=f.get(y.toString());Ns(w)&&this.updateImage(y,a,w)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function oo(p){const e=p.value,a=p.valueSpec,f=p.style,y=p.styleSpec,w=p.key,I=p.arrayElementValidator||ae;if(!Array.isArray(e))return[new i.V(w,e,`array expected, ${i.K(e)} found`)];if(a.length&&e.length!==a.length)return[new i.V(w,e,`array length ${a.length} expected, length ${e.length} found`)];if(a["min-length"]&&e.length<a["min-length"])return[new i.V(w,e,`array length at least ${a["min-length"]} expected, length ${e.length} found`)];let M={type:a.value,values:a.values,minimum:a.minimum,maximum:a.maximum,function:void 0};y.$version<7&&(M.function=a.function),i.H(a.value)&&(M=a.value);let L=[];for(let N=0;N<e.length;N++)L=L.concat(I({array:e,arrayIndex:N,value:e[N],valueSpec:M,style:f,styleSpec:y,key:`${w}[${N}]`},!0));return L}function ll(p){const e=p.key,a=p.value,f=p.valueSpec;if(!i.L(a))return[new i.V(e,a,`number expected, ${i.K(a)} found`)];if(a!=a)return[new i.V(e,a,"number expected, NaN found")];if("minimum"in f){let y=f.minimum;if(Array.isArray(f.minimum)&&(y=f.minimum[p.arrayIndex]),a<y)return[new i.V(e,a,`${a} is less than the minimum value ${y}`)]}if("maximum"in f){let y=f.maximum;if(Array.isArray(f.maximum)&&(y=f.maximum[p.arrayIndex]),a>y)return[new i.V(e,a,`${a} is greater than the maximum value ${y}`)]}return[]}function $l(p){const e=p.key,a=p.value;if(!i.H(a))return[new i.V(e,a,`object expected, ${i.K(a)} found`)];const f=p.valueSpec,y=i.J(a.type);let w,I,M,L={};const N=y!=="categorical"&&a.property===void 0,V=!N,Z=function(rt){const ht=rt.stops;return Array.isArray(ht)&&Array.isArray(ht[0])&&i.H(ht[0][0])}(a),U=Fe({key:p.key,value:p.value,valueSpec:p.styleSpec.function,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{stops:function(rt){if(y==="identity")return[new i.V(rt.key,rt.value,'identity function may not have a "stops" property')];let ht=[];const lt=rt.value;return ht=ht.concat(oo({key:rt.key,value:lt,valueSpec:rt.valueSpec,style:rt.style,styleSpec:rt.styleSpec,arrayElementValidator:X})),Array.isArray(lt)&&lt.length===0&&ht.push(new i.V(rt.key,lt,"array must have at least one stop")),ht},default:function(rt){return ae({key:rt.key,value:rt.value,valueSpec:f,style:rt.style,styleSpec:rt.styleSpec})}}});return y==="identity"&&N&&U.push(new i.V(p.key,p.value,'missing required property "property"')),y==="identity"||a.stops||U.push(new i.V(p.key,p.value,'missing required property "stops"')),y==="exponential"&&f.expression&&!i.M(f)&&U.push(new i.V(p.key,p.value,"exponential functions not supported")),p.styleSpec.$version>=8&&(V&&!i.N(f)?U.push(new i.V(p.key,p.value,"property functions not supported")):N&&!i.O(f)&&U.push(new i.V(p.key,p.value,"zoom functions not supported"))),y!=="categorical"&&!Z||a.property!==void 0||U.push(new i.V(p.key,p.value,'"property" property is required')),U;function X(rt){let ht=[];const lt=rt.value,_t=rt.key;if(!Array.isArray(lt))return[new i.V(_t,lt,`array expected, ${i.K(lt)} found`)];if(lt.length!==2)return[new i.V(_t,lt,`array length 2 expected, length ${lt.length} found`)];if(Z){if(!i.H(lt[0]))return[new i.V(_t,lt,`object expected, ${i.K(lt[0])} found`)];const Mt=lt[0];if(Mt.zoom===void 0)return[new i.V(_t,lt,"object stop key must have zoom")];if(Mt.value===void 0)return[new i.V(_t,lt,"object stop key must have value")];const vt=i.J(Mt.zoom);if(typeof vt!="number")return[new i.V(_t,Mt.zoom,"stop zoom values must be numbers")];if(M&&M>vt)return[new i.V(_t,Mt.zoom,"stop zoom values must appear in ascending order")];vt!==M&&(M=vt,I=void 0,L={}),ht=ht.concat(Fe({key:`${_t}[0]`,value:lt[0],valueSpec:{zoom:{}},style:rt.style,styleSpec:rt.styleSpec,objectElementValidators:{zoom:ll,value:K}}))}else ht=ht.concat(K({key:`${_t}[0]`,value:lt[0],style:rt.style,styleSpec:rt.styleSpec},lt));return i.Q(i.S(lt[1]))?ht.concat([new i.V(`${_t}[1]`,lt[1],"expressions are not allowed in function stops.")]):ht.concat(ae({key:`${_t}[1]`,value:lt[1],valueSpec:f,style:rt.style,styleSpec:rt.styleSpec}))}function K(rt,ht){const lt=i.K(rt.value),_t=i.J(rt.value),Mt=rt.value!==null?rt.value:ht;if(w){if(lt!==w)return[new i.V(rt.key,Mt,`${lt} stop domain type must match previous stop domain type ${w}`)]}else w=lt;if(lt!=="number"&&lt!=="string"&&lt!=="boolean"&&typeof _t!="number"&&typeof _t!="string"&&typeof _t!="boolean")return[new i.V(rt.key,Mt,"stop domain value must be a number, string, or boolean")];if(lt!=="number"&&y!=="categorical"){let vt=`number expected, ${lt} found`;return i.N(f)&&y===void 0&&(vt+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new i.V(rt.key,Mt,vt)]}return y!=="categorical"||lt!=="number"||typeof _t=="number"&&isFinite(_t)&&Math.floor(_t)===_t?y!=="categorical"&&lt==="number"&&typeof _t=="number"&&typeof I=="number"&&I!==void 0&&_t<I?[new i.V(rt.key,Mt,"stop domain values must appear in ascending order")]:(I=_t,y==="categorical"&&_t in L?[new i.V(rt.key,Mt,"stop domain values must be unique")]:(L[_t]=!0,[])):[new i.V(rt.key,Mt,`integer expected, found ${String(_t)}`)]}}function Ms(p){const e=(p.expressionContext==="property"?i.W:i.U)(i.S(p.value),p.valueSpec);if(e.result==="error")return e.value.map(f=>new i.V(`${p.key}${f.key}`,p.value,f.message));const a=e.value.expression||e.value._styleExpression.expression;if(p.expressionContext==="property"&&p.propertyKey==="text-font"&&!a.outputDefined())return[new i.V(p.key,p.value,`Invalid data expression for "${p.propertyKey}". Output values must be contained as literals within the expression.`)];if(p.expressionContext==="property"&&p.propertyType==="layout"&&!i.Z(a))return[new i.V(p.key,p.value,'"feature-state" data expressions are not supported with layout properties.')];if(p.expressionContext==="filter")return wa(a,p);if(p.expressionContext==="appearance")return ql(a,p);if(p.expressionContext&&p.expressionContext.indexOf("cluster")===0){if(!i.X(a,["zoom","feature-state"]))return[new i.V(p.key,p.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(p.expressionContext==="cluster-initial"&&!i.Y(a))return[new i.V(p.key,p.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function wa(p,e){const a=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(e.valueSpec&&e.valueSpec.expression)for(const y of e.valueSpec.expression.parameters)a.delete(y);if(a.size===0)return[];const f=[];return p instanceof i._&&a.has(p.name)?[new i.V(e.key,e.value,`["${p.name}"] expression is not supported in a filter for a ${e.object.type} layer with id: ${e.object.id}`)]:(p.eachChild(y=>{f.push(...wa(y,e))}),f)}function ql(p,e){const a=new Set;if(e.valueSpec&&e.valueSpec.expression)for(const y of e.valueSpec.expression.parameters)a.add(y);if(a.size===0)return[];const f=[];return p instanceof i._&&!a.has(p.name)?[new i.V(e.key,e.value,`["${p.name}"] is not an allowed parameter`)]:(p.eachChild(y=>{f.push(...ql(y,e))}),f)}function bs(p){const e=p.key,a=p.value,f=p.valueSpec,y=[];return Array.isArray(f.values)?f.values.indexOf(i.J(a))===-1&&y.push(new i.V(e,a,`expected one of [${f.values.join(", ")}], ${JSON.stringify(a)} found`)):Object.keys(f.values).indexOf(i.J(a))===-1&&y.push(new i.V(e,a,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(a)} found`)),y}function Cs(p){return i.a2(i.S(p.value))?Ms(Object.assign({},p,{expressionContext:"filter",valueSpec:p.styleSpec[`filter_${p.layerType||"fill"}`]})):cl(p)}function cl(p){const e=p.value,a=p.key;if(!Array.isArray(e))return[new i.V(a,e,`array expected, ${i.K(e)} found`)];if(e.length<1)return[new i.V(a,e,"filter array must have at least 1 element")];const f=p.styleSpec;let y=bs({key:`${a}[0]`,value:e[0],valueSpec:f.filter_operator});switch(i.J(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&i.J(e[1])==="$type"&&y.push(new i.V(a,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&y.push(new i.V(a,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(i.a0(e[1])||y.push(new i.V(`${a}[1]`,e[1],`string expected, ${i.K(e[1])} found`)));for(let w=2;w<e.length;w++)i.J(e[1])==="$type"?y=y.concat(bs({key:`${a}[${w}]`,value:e[w],valueSpec:f.geometry_type})):i.a0(e[w])||i.L(e[w])||i.$(e[w])||y.push(new i.V(`${a}[${w}]`,e[w],`string, number, or boolean expected, ${i.K(e[w])} found.`));break;case"any":case"all":case"none":for(let w=1;w<e.length;w++)y=y.concat(cl({key:`${a}[${w}]`,value:e[w],style:p.style,styleSpec:p.styleSpec}));break;case"has":case"!has":e.length!==2?y.push(new i.V(a,e,`filter array for "${e[0]}" operator must have 2 elements`)):i.a0(e[1])||y.push(new i.V(`${a}[1]`,e[1],`string expected, ${i.K(e[1])} found`))}return y}function Ml(p,e){const a=p.key,f=p.style,y=p.layer,w=p.styleSpec,I=p.value,M=p.objectKey,L=w[`${e}_${p.layerType}`];if(!L)return[];const N=M.match(/^(.*)-use-theme$/);if(N&&L[N[1]])return i.Q(i.S(I))?[].concat(ae({key:a,value:I,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:f,styleSpec:w,expressionContext:"property",propertyType:e,propertyKey:M})):ae({key:a,value:I,valueSpec:{type:"string"},style:f,styleSpec:w});const V=M.match(/^(.*)-transition$/);if(e==="paint"&&V&&L[V[1]]&&L[V[1]].transition)return ae({key:a,value:I,valueSpec:w.transition,style:f,styleSpec:w});const Z=p.valueSpec||L[M];if(!Z)return[new i.a3(a,I,`unknown property "${M}"`)];let U;if(i.a0(I)&&i.N(Z)&&!Z.tokens&&(U=/^{([^}]+)}$/.exec(I))){const K=`\`{ "type": "identity", "property": ${U?JSON.stringify(U[1]):'"_"'} }\``;return[new i.V(a,I,`"${M}" does not support interpolation syntax
Use an identity property function instead: ${K}.`)]}const X=[];if(p.layerType==="symbol")M!=="text-field"||!f||f.glyphs||f.imports||X.push(new i.V(a,I,'use of "text-field" requires a style "glyphs" property')),M==="text-font"&&i.a4(i.S(I))&&i.J(I.type)==="identity"&&X.push(new i.V(a,I,'"text-font" does not support identity functions'));else if(p.layerType==="model"&&e==="paint"&&y&&y.layout&&y.layout.hasOwnProperty("model-id")&&i.N(Z)&&(i.a5(Z)||i.O(Z))){const K=i.W(i.S(I),Z).value,rt="expression"in K&&K.expression||"_styleExpression"in K&&K._styleExpression&&K._styleExpression.expression;rt&&!i.X(rt,["measure-light"])&&(M==="model-emissive-strength"&&i.Y(rt)&&i.Z(rt)||X.push(new i.V(a,I,`${M} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return X.concat(ae({key:p.key,value:I,valueSpec:Z,style:f,styleSpec:w,expressionContext:"property",propertyType:e,propertyKey:M}))}function Cl(p){return Ml(p,"paint")}function Vs(p){return Ml(p,"layout")}function hl(p){let e=[];const a=p.value,f=p.key,y=p.style,w=p.styleSpec;if(!i.H(a))return[new i.V(f,a,"object expected")];a.type||a.ref||e.push(new i.V(f,a,'either "type" or "ref" is required'));let I=i.J(a.type);const M=i.J(a.ref);if(a.id){const L=i.J(a.id);for(let N=0;N<p.arrayIndex;N++){const V=y.layers[N];i.J(V.id)===L&&e.push(new i.V(f,a.id,`duplicate layer id "${L}", previously used at line ${V.id.__line__}`))}}if("ref"in a){let L;["type","source","source-layer","filter","layout"].forEach(N=>{N in a&&e.push(new i.V(f,a[N],`"${N}" is prohibited for ref layers`))}),y.layers.forEach(N=>{i.J(N.id)===M&&(L=N)}),L?L.ref?e.push(new i.V(f,a.ref,"ref cannot reference another ref layer")):I=i.J(L.type):typeof M=="string"&&e.push(new i.V(f,a.ref,`ref layer "${M}" not found`))}else if(I!=="background"&&I!=="sky"&&I!=="slot")if(a.source)if(i.a0(a.source)){const L=y.sources&&y.sources[a.source],N=L&&i.J(L.type);L?N==="vector"&&I==="raster"?e.push(new i.V(f,a.source,`layer "${a.id}" requires a raster source`)):N==="raster"&&I!=="raster"?e.push(new i.V(f,a.source,`layer "${a.id}" requires a vector source`)):N!=="vector"||a["source-layer"]?N==="raster-dem"&&I!=="hillshade"?e.push(new i.V(f,a.source,"raster-dem source can only be used with layer type 'hillshade'.")):N!=="raster-array"||["raster","raster-particle"].includes(I)?I==="line"&&a.paint&&(a.paint["line-gradient"]||a.paint["line-trim-offset"])&&N==="geojson"&&!L.lineMetrics?e.push(new i.V(f,a,`layer "${a.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):I==="raster-particle"&&N!=="raster-array"&&e.push(new i.V(f,a.source,`layer "${a.id}" requires a 'raster-array' source.`)):e.push(new i.V(f,a.source,"raster-array source can only be used with layer type 'raster'.")):e.push(new i.V(f,a,`layer "${a.id}" must specify a "source-layer"`)):e.push(new i.V(f,a.source,`source "${a.source}" not found`))}else e.push(new i.V(`${f}.source`,a.source,'"source" must be a string'));else e.push(new i.V(f,a,'missing required property "source"'));return e=e.concat(Fe({key:f,value:a,valueSpec:w.layer,style:p.style,styleSpec:p.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ae({key:`${f}.type`,value:a.type,valueSpec:w.layer.type,style:p.style,styleSpec:p.styleSpec,object:a,objectKey:"type"}),filter:L=>Cs(Object.assign({layerType:I},L)),layout:L=>Fe({layer:a,key:L.key,value:L.value,valueSpec:{},style:L.style,styleSpec:L.styleSpec,objectElementValidators:{"*":N=>Vs(Object.assign({layerType:I},N))}}),paint:L=>Fe({layer:a,key:L.key,value:L.value,valueSpec:{},style:L.style,styleSpec:L.styleSpec,objectElementValidators:{"*":N=>Cl(Object.assign({layerType:I,layer:a},N))}}),appearances(L){const N=oo({key:L.key,value:L.value,valueSpec:L.valueSpec,style:L.style,styleSpec:L.styleSpec,arrayElementValidator:U=>function(X){const{key:K,layer:rt,layerType:ht}=X,lt=i.J(X.value),_t=i.J(lt.name),Mt=i.J(lt.condition),vt=Fe({key:K,value:lt,valueSpec:X.styleSpec.appearance,style:X.style,styleSpec:X.styleSpec,objectElementValidators:{condition:Ut=>function(Ct){const $t=[];return $t.push(...Ms({key:Ct.key,value:Ct.object.condition,valueSpec:i.a6.appearance.condition,expressionContext:"appearance"})),$t}(Object.assign({layer:rt,layerType:ht},Ut)),properties:Ut=>function(Ct){const $t=[],{styleSpec:Ot,layer:Rt,layerType:Zt}=Ct,pe=Ot[`paint_${Zt}`],le=Ot[`layout_${Zt}`],Me=Ct.object[Ct.objectKey];for(const ve in Me){const Be=ve in pe?"paint":ve in le?"layout":void 0;if(!Be){$t.push(new i.V(Ct.key,ve,`unknown property "${ve}" for layer type "${Zt}"`));continue}const oi=Object.assign({},Ct,{key:`${Ct.key}.${ve}`,object:Me,objectKey:ve,layer:Rt,layerType:Zt,value:Me[ve],valueSpec:Be==="paint"?pe[ve]:le[ve]});$t.push(...Ml(oi,Be))}return $t}(Object.assign({layer:rt,layerType:ht},Ut))}});return _t!=="hidden"&&Mt===void 0&&vt.push(new i.V(X.key,"name",'Appearance with name different than "hidden" must have a condition')),vt}(Object.assign({layerType:I,layer:a},U))}),V=Array.isArray(L.value)?L.value:[],Z=new Set;return V.forEach((U,X)=>{const K=i.J(U.name);if(K)if(Z.has(K)){const rt=i.J(a.id);N.push(new i.V(L.key,K,`Duplicated appearance name "${K}" for layer "${rt}"`))}else Z.add(K)}),N}}})),e}function Ka({key:p,value:e}){return i.a0(e)?[]:[new i.V(p,e,`string expected, ${i.K(e)} found`)]}const Zl={promoteId:function p({key:e,value:a}){if(i.a0(a))return Ka({key:e,value:a});if(Array.isArray(a)){const y=[],w=i.S(a),I=i.U(w);return I.result==="error"&&I.value.forEach(M=>{y.push(new i.V(`${e}${M.key}`,null,`${M.message}`))}),i.X(I.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||y.push(new i.V(`${e}`,null,"promoteId expression should be only feature dependent")),y}if(!i.H(a))return[new i.V(e,a,`string, expression or object expected, "${i.K(a)}" found`)];const f=[];for(const y in a)f.push(...p({key:`${e}.${y}`,value:a[y]}));return f}};function Da(p){const e=p.value,a=p.key,f=p.styleSpec,y=p.style;if(!i.H(e))return[new i.V(a,e,`object expected, ${i.K(e)} found`)];if(!("type"in e))return[new i.V(a,e,'"type" is required')];const w=i.J(e.type);let I=[];switch(["vector","raster","raster-dem","raster-array"].includes(w)&&("url"in e||"tiles"in e||I.push(new i.a3(a,e,'Either "url" or "tiles" is required.'))),w){case"vector":case"raster":case"raster-dem":case"raster-array":return I=I.concat(Fe({key:a,value:e,valueSpec:f[`source_${w.replace("-","_")}`],style:p.style,styleSpec:f,objectElementValidators:Zl})),I;case"geojson":if(I=Fe({key:a,value:e,valueSpec:f.source_geojson,style:y,styleSpec:f,objectElementValidators:Zl}),"cluster"in e&&"clusterProperties"in e){if(!i.H(e.clusterProperties))return[new i.V(`${a}.clusterProperties`,e,`object expected, ${i.K(e)} found`)];for(const M in e.clusterProperties){const L=e.clusterProperties[M];if(!Array.isArray(L))return[new i.V(`${a}.clusterProperties.${M}`,L,"array expected")];const[N,V]=L,Z=typeof N=="string"?[N,["accumulated"],["get",M]]:N;I.push(...Ms({key:`${a}.${M}.map`,value:V,expressionContext:"cluster-map"})),I.push(...Ms({key:`${a}.${M}.reduce`,value:Z,expressionContext:"cluster-reduce"}))}}return I;case"video":return Fe({key:a,value:e,valueSpec:f.source_video,style:y,styleSpec:f});case"image":return Fe({key:a,value:e,valueSpec:f.source_image,style:y,styleSpec:f});case"canvas":return[new i.V(a,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return bs({key:`${a}.type`,value:e.type,valueSpec:{values:so(f)}})}}function so(p){return p.source.reduce((e,a)=>{const f=p[a];return f.type.type==="enum"&&(e=e.concat(Object.keys(f.type.values||{}))),e},[])}function we(p){const e=p.value,a=p.styleSpec,f=a.light,y=p.style;if(e===void 0)return[];if(!i.H(e))return[new i.V("light",e,`object expected, ${i.K(e)} found`)];let w=[];for(const I in e){const M=I.match(/^(.*)-transition$/),L=I.match(/^(.*)-use-theme$/);w=w.concat(L&&f[L[1]]?ae({key:I,value:e[I],valueSpec:{type:"string"},style:y,styleSpec:a}):M&&f[M[1]]&&f[M[1]].transition?ae({key:I,value:e[I],valueSpec:a.transition,style:y,styleSpec:a}):f[I]?ae({key:I,value:e[I],valueSpec:f[I],style:y,styleSpec:a}):[new i.V(I,e[I],`unknown property "${I}"`)])}return w}function St(p){const e=p.value;if(!e)return[];const a=p.key;if(!i.H(e))return[new i.V(a,e,`object expected, ${i.K(e)} found`)];let f=[];const y=p.styleSpec,w=y["light-3d"],I=p.style,M=p.style.lights;for(const V of["type","id"])if(!(V in e))return f=f.concat([new i.V(a,e,`missing property "${V}"`)]),f;if(!i.a0(e.type))return f=f.concat([new i.V(`${a}.type`,e.type,"string expected")]),f;if(M)for(let V=0;V<p.arrayIndex;V++){const Z=i.J(e.type),U=M[V];i.J(U.type)===Z&&f.push(new i.V(a,e.id,`duplicate light type "${e.type}", previously defined at line ${U.id.__line__}`))}const L=`properties_light_${e.type}`;if(!(L in y))return f=f.concat([new i.V(`${a}.type`,e,`Invalid light type ${e.type}`)]),f;const N=y[L];for(const V in e)if(V==="properties"){const Z=e[V];if(!i.H(Z))return f=f.concat([new i.V("properties",Z,`object expected, ${i.K(Z)} found`)]),f;for(const U in Z){const X=U.match(/^(.*)-transition$/),K=U.match(/^(.*)-use-theme$/);f=f.concat(K&&N[K[1]]?ae({key:V,value:Z[U],valueSpec:{type:"string"},style:I,styleSpec:y}):X&&N[X[1]]&&N[X[1]].transition?ae({key:V,value:e[V],valueSpec:y.transition,style:I,styleSpec:y}):N[U]?ae({key:U,value:Z[U],valueSpec:N[U],style:I,styleSpec:y}):[new i.a3(p.key,Z[U],`unknown property "${U}"`)])}}else f=f.concat(w[V]?ae({key:V,value:e[V],valueSpec:w[V],style:I,styleSpec:y}):[new i.a3(V,e[V],`unknown property "${V}"`)]);return f}function Pt(p){const e=p.value,a=p.key,f=p.style,y=p.styleSpec,w=y.terrain;if(e==null)return[];if(!i.H(e))return[new i.V("terrain",e,`object expected, ${i.K(e)} found`)];let I=[];for(const M in e){const L=M.match(/^(.*)-transition$/),N=M.match(/^(.*)-use-theme$/);I=I.concat(N&&w[N[1]]?ae({key:M,value:e[M],valueSpec:{type:"string"},style:f,styleSpec:y}):L&&w[L[1]]&&w[L[1]].transition?ae({key:M,value:e[M],valueSpec:y.transition,style:f,styleSpec:y}):w[M]?ae({key:M,value:e[M],valueSpec:w[M],style:f,styleSpec:y}):[new i.a3(M,e[M],`unknown property "${M}"`)])}if(e.source)if(i.a0(e.source)){const M=f.sources&&f.sources[e.source],L=M&&i.J(M.type);M?L!=="raster-dem"&&I.push(new i.V(`${a}.source`,e.source,`terrain cannot be used with a source of type ${L}, it only be used with a "raster-dem" source type`)):I.push(new i.V(`${a}.source`,e.source,`source "${e.source}" not found`))}else I.push(new i.V(`${a}.source`,e.source,"source must be a string"));else I.push(new i.V(a,e,'terrain is missing required property "source"'));return I}function Nt(p){const e=p.value,a=p.style,f=p.styleSpec,y=f.fog;if(e===void 0)return[];if(!i.H(e))return[new i.V("fog",e,`object expected, ${i.K(e)} found`)];let w=[];for(const I in e){const M=I.match(/^(.*)-transition$/),L=I.match(/^(.*)-use-theme$/);w=w.concat(L&&y[L[1]]?ae({key:I,value:e[I],valueSpec:{type:"string"},style:a,styleSpec:f}):M&&y[M[1]]&&y[M[1]].transition?ae({key:I,value:e[I],valueSpec:f.transition,style:a,styleSpec:f}):y[I]?ae({key:I,value:e[I],valueSpec:y[I],style:a,styleSpec:f}):[new i.a3(I,e[I],`unknown property "${I}"`)])}return w}const ce={"*":()=>[],array:oo,boolean:function(p){const e=p.value,a=p.key;return i.$(e)?[]:[new i.V(a,e,`boolean expected, ${i.K(e)} found`)]},number:ll,color:function({key:p,value:e}){return i.a0(e)?i.a1.parseCSSColor(e)===null?[new i.V(p,e,`color expected, "${e}" found`)]:[]:[new i.V(p,e,`color expected, ${i.K(e)} found`)]},enum:bs,filter:Cs,function:$l,layer:hl,object:Fe,source:Da,model:i.a7,light:we,"light-3d":St,terrain:Pt,fog:Nt,string:Ka,formatted:function(p){return Ka(p).length===0?[]:Ms(p)},resolvedImage:function(p){return Ka(p).length===0?[]:Ms(p)},projection:function(p){const e=p.value,a=p.styleSpec,f=a.projection,y=p.style;if(i.H(e)){let w=[];for(const I in e)w=w.concat(ae({key:I,value:e[I],valueSpec:f[I],style:y,styleSpec:a}));return w}return i.a0(e)?[]:[new i.V("projection",e,`object or string expected, ${i.K(e)} found`)]},import:function(p){const e=p.key,{value:a,styleSpec:f}=p;if(!i.H(a))return[new i.V(e,a,"import must be an object")];const{data:y,...w}=a;Object.defineProperty(w,"__line__",{value:a.__line__,enumerable:!1});let I=Fe(Object.assign({},p,{value:w,valueSpec:f.import}));return i.J(w.id)===""&&I.push(new i.V(`${p.key}.id`,w,"import id can't be an empty string")),y&&(I=I.concat(De(y,f,{key:`${p.key}.data`}))),I},iconset:function(p){const e=p.value,a=p.key,f=p.styleSpec,y=p.style;if(!i.H(e))return[new i.V(a,e,"object expected")];if(!e.type)return[new i.V(a,e,'"type" is required')];const w=i.J(e.type);let I=[];if(I=I.concat(Fe({key:a,value:e,valueSpec:f[`iconset_${w}`],style:y,styleSpec:f})),function(M,L){return!(M!=="source"||!L.source)}(w,e)){const M=y.sources&&y.sources[e.source],L=M&&i.J(M.type);M?L!=="raster-array"&&I.push(new i.V(a,e.source,`iconset cannot be used with a source of type ${String(L)}, it only be used with a "raster-array" source type`)):I.push(new i.V(a,e.source,`source "${e.source}" not found`))}return I}};function ae(p,e=!1){const a=p.value,f=p.valueSpec,y=p.styleSpec;if(f.expression){if(i.a4(i.J(a)))return $l(p);if(i.Q(i.S(a)))return Ms(p)}if(f.type&&ce[f.type]){const w=ce[f.type](p);return e===!0&&w.length>0&&Array.isArray(p.value)?Ms(p):w}return Fe(Object.assign({},p,{valueSpec:f.type?y[f.type]:f}))}function Fe(p){const e=p.key,a=p.value,f=p.valueSpec||{},y=p.objectElementValidators||{},w=p.style,I=p.styleSpec;if(!i.H(a))return[new i.V(e,a,`object expected, ${i.K(a)} found`)];let M=[];for(const L in a){const N=L.split(".")[0];let V;y[N]?V=y[N]:f[N]?V=ae:y["*"]?V=y["*"]:f["*"]&&(V=ae),V?M=M.concat(V({key:(e&&`${e}.`)+L,value:a[L],valueSpec:f[N]||f["*"],style:w,styleSpec:I,object:a,objectKey:L},a)):M.push(new i.a3(e,a[L],`unknown property "${L}"`))}for(const L in f){if(y[L])continue;const N=f[L];N.required&&N.default===void 0&&a[L]===void 0&&M.push(new i.V(e,a,`missing required property "${L}"`))}return M}function Jt({key:p,value:e}){const a=Ka({key:p,value:e});if(a.length)return a;const f=e;return f.indexOf("{fontstack}")===-1&&a.push(new i.V(p,e,'"glyphs" url must include a "{fontstack}" token')),f.indexOf("{range}")===-1&&a.push(new i.V(p,e,'"glyphs" url must include a "{range}" token')),a}function De(p,e=i.a6,a={}){return Fe({key:a.key||"",value:p,valueSpec:Object.assign(e.$root,{"*":{type:"*"}}),styleSpec:e,style:p,objectElementValidators:{glyphs:Jt}})}function We(p,e=i.a6){return se(De(p,e))}const ci=p=>se(Da(p)),ui=p=>se(we(p)),cr=p=>se(St(p)),zr=p=>se(Pt(p)),Ae=p=>se(Nt(p)),Do=p=>se(function(e){const a=e.value,f=e.style,y=e.styleSpec,w=y.snow;if(a===void 0)return[];if(!i.H(a))return[new i.V("snow",a,`object expected, ${i.K(a)} found`)];let I=[];for(const M in a){const L=M.match(/^(.*)-transition$/);I=I.concat(L&&w[L[1]]&&w[L[1]].transition?ae({key:M,value:a[M],valueSpec:y.transition,style:f,styleSpec:y}):w[M]?ae({key:M,value:a[M],valueSpec:w[M],style:f,styleSpec:y}):[new i.a3(M,a[M],`unknown property "${M}"`)])}return I}(p)),An=p=>se(function(e){const a=e.value,f=e.style,y=e.styleSpec,w=y.rain;if(a===void 0)return[];if(!i.H(a))return[new i.V("rain",a,`object expected, ${i.K(a)} found`)];let I=[];for(const M in a){const L=M.match(/^(.*)-transition$/);I=I.concat(L&&w[L[1]]&&w[L[1]].transition?ae({key:M,value:a[M],valueSpec:y.transition,style:f,styleSpec:y}):w[M]?ae({key:M,value:a[M],valueSpec:w[M],style:f,styleSpec:y}):[new i.a3(M,a[M],`unknown property "${M}"`)])}return I}(p)),Qn=p=>se(hl(p)),ar=p=>se(Cs(p)),bi=p=>se(Cl(p)),Zo=p=>se(Vs(p)),zo=p=>se(i.a7(p));function se(p){return p.slice().sort((e,a)=>e.line&&a.line?e.line-a.line:0)}function st(p,e){let a=!1;if(e&&e.length)for(const f of e)f instanceof i.a3?i.w(f.message):(p.fire(new i.y(new Error(f.message))),a=!0);return a}const tt=i.a6.light;let wt;class Bt extends i.E{constructor(e,a="flat"){super(),this._transitionable=new i.a8(wt||(wt=new i.a9({anchor:new i.aa(tt.anchor),position:new i.ab(tt.position),color:new i.aa(tt.color),intensity:new i.aa(tt.intensity)}))),this.setLight(e,a),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,a,f={}){this._validate(ui,e,f)||(this._transitionable.setTransitionOrValue(e),this.id=a)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,a,f){return(!f||f.validate!==!1)&&st(this,e.call(We,Object.assign({value:a,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}}const Ht=i.a6.terrain;let oe=class extends i.E{constructor(p,e,a,f,y){super(),this.scope=a,this._transitionable=new i.a8(new i.a9({source:new i.aa(Ht.source),exaggeration:new i.aa(Ht.exaggeration)}),a,f),this._transitionable.setTransitionOrValue(p,f),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=e,this.worldview=y}get(){return this._transitionable.serialize()}set(p,e){this._transitionable.setTransitionOrValue(p,e)}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}getExaggeration(p){return this._transitioning.possiblyEvaluate(new i.ac(p,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const p=this._transitionable._values.exaggeration;if(!p)return null;const e=p.value.expression;if(!e)return null;let a=-1,f=-1,y=1;for(const w of e.zoomStops)y=e.evaluate(new i.ac(w,{worldview:this.worldview})),y>.01?(a=w,f=-1):f=w;return y<.01&&a>0&&f>a?[a,f]:null}isZoomDependent(){const p=this._transitionable._values.exaggeration;return p!=null&&p.value!=null&&p.value.expression!=null&&p.value.expression instanceof i.ad}};const ye=45,Yt=65,xe=.05;function ti(p,e,a,f){const y=i.ah(ye,Yt,a),[w,I]=$e(p,f);let M=1-Math.min(1,Math.exp((e-w)/(I-w)*-6));return M*=M*M,M=Math.min(1,1.00747*M),M*y*p.alpha}function $e(p,e){const a=.5/Math.tan(.5*e);return[p.range[0]+a,p.range[1]+a]}function Di(p,e,a,f,y){const w=i.af([],[e,a,f],y.mercatorFogMatrix);return ti(p,i.ag(w),y.pitch,y._fov)}function er(p,e,a,f,y,w,I){const M=[[a,f,0],[y,f,0],[y,w,0],[a,w,0]];let L=Number.MAX_VALUE,N=-Number.MAX_VALUE;for(const V of M){const Z=i.af([],V,e),U=i.ag(Z);L=Math.min(L,U),N=Math.max(N,U)}return[ti(p,L,I.pitch,I._fov),ti(p,N,I.pitch,I._fov)]}const Ki=i.a6.fog;class Hi extends i.E{constructor(e,a,f,y){super();const w=new i.a9({range:new i.aa(Ki.range),color:new i.aa(Ki.color),"color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new i.aa(Ki["high-color"]),"high-color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new i.aa(Ki["space-color"]),"space-color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new i.aa(Ki["horizon-blend"]),"star-intensity":new i.aa(Ki["star-intensity"]),"vertical-range":new i.aa(Ki["vertical-range"])});this._transitionable=new i.a8(w,f,new Map(y)),this.set(e,y),this._transitioning=this._transitionable.untransitioned(),this._transform=a,this.properties=new i.ai(w),this.scope=f}get state(){const e=this._transform,a=e.projection.name==="globe",f=i.aj(e.zoom),y=this.properties.get("range"),w=[.5,3];return{range:a?[i.ak(w[0],y[0],f),i.ak(w[1],y[1],f)]:y,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(e,a,f={}){if(this._validate(Ae,e,f))return;const y=Object.assign({},e);for(const w of Object.keys(Ki))y[w]===void 0&&(y[w]=Ki[w].default);this._options=y,this._transitionable.setTransitionOrValue(this._options,a)}getOpacity(e){if(!this._transform.projection.supportsFog)return 0;const a=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:i.ah(ye,Yt,e))*a.a}getOpacityAtLatLng(e,a){return this._transform.projection.supportsFog?function(f,y,w){const I=i.ae.fromLngLat(y),M=w.elevation?w.elevation.getAtPointOrZero(I):0;return Di(f,I.x,I.y,M,w)}(this.state,e,a):0}getOpacityForTile(e){if(!this._transform.projection.supportsFog)return[1,1];const a=this._transform.calculateFogTileMatrix(e.toUnwrapped());return er(this.state,a,0,0,i.al,i.al,this._transform)}getOpacityForBounds(e,a,f,y,w){return this._transform.projection.supportsFog?er(this.state,e,a,f,y,w,this._transform):[1,1]}getFovAdjustedRange(e){return this._transform.projection.supportsFog?$e(this.state,e):[0,1]}isVisibleOnFrustum(e){if(!this._transform.projection.supportsFog)return!1;const a=[4,5,6,7];for(const f of a){const y=e.points[f];let w;if(y[2]>=0)w=y;else{const I=e.points[f-4];w=i.am(I,y,I[2]/(I[2]-y[2]))}if(Di(this.state,w[0],w[1],0,this._transform)>=xe)return!0}return!1}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,a,f){return(!f||f.validate!==!1)&&st(this,e.call(We,Object.assign({value:a,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}}let gr,Qi,Cn,Nn,Vo=class extends i.E{constructor(p,e,a,f){super();const y=gr||(gr=new i.a9({density:new i.aa(i.a6.snow.density),intensity:new i.aa(i.a6.snow.intensity),color:new i.aa(i.a6.snow.color),opacity:new i.aa(i.a6.snow.opacity),vignette:new i.aa(i.a6.snow.vignette),"vignette-color":new i.aa(i.a6.snow["vignette-color"]),"center-thinning":new i.aa(i.a6.snow["center-thinning"]),direction:new i.aa(i.a6.snow.direction),"flake-size":new i.aa(i.a6.snow["flake-size"])}));this._transitionable=new i.a8(y,a,new Map(f)),this.set(p,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ai(y),this.scope=a}get state(){const p=this.properties.get("opacity"),e=this.properties.get("color"),a=this.properties.get("direction"),f=i.an(a[0]),y=-Math.max(i.an(a[1]),.01),w=[Math.cos(f)*Math.cos(y),Math.sin(f)*Math.cos(y),Math.sin(y)],I=this.properties.get("vignette"),M=this.properties.get("vignette-color");return M.a=I,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.ao(e.r,e.g,e.b,e.a*p),direction:w,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:M}}get(){return this._transitionable.serialize()}set(p,e,a={}){if(this._validate(Do,p,a))return;const f=Object.assign({},p),y=i.a6.snow;for(const w of Object.keys(y))f[w]===void 0&&(f[w]=y[w].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,e)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,e,a){return(!a||a.validate!==!1)&&st(this,p.call(We,Object.assign({value:e,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}},Qr=class extends i.E{constructor(p,e,a,f){super();const y=Qi||(Qi=new i.a9({density:new i.aa(i.a6.rain.density),intensity:new i.aa(i.a6.rain.intensity),color:new i.aa(i.a6.rain.color),opacity:new i.aa(i.a6.rain.opacity),vignette:new i.aa(i.a6.rain.vignette),"vignette-color":new i.aa(i.a6.rain["vignette-color"]),"center-thinning":new i.aa(i.a6.rain["center-thinning"]),direction:new i.aa(i.a6.rain.direction),"droplet-size":new i.aa(i.a6.rain["droplet-size"]),"distortion-strength":new i.aa(i.a6.rain["distortion-strength"])}));this._transitionable=new i.a8(y,a,new Map(f)),this.set(p,f),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ai(y),this.scope=a}get state(){const p=this.properties.get("opacity"),e=this.properties.get("color"),a=this.properties.get("direction"),f=i.an(a[0]),y=-Math.max(i.an(a[1]),.01),w=[Math.cos(f)*Math.cos(y),Math.sin(f)*Math.cos(y),Math.sin(y)],I=this.properties.get("vignette-color");return I.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.ao(e.r,e.g,e.b,e.a*p),direction:w,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:I}}get(){return this._transitionable.serialize()}set(p,e,a={}){if(this._validate(An,p,a))return;const f=Object.assign({},p),y=i.a6.rain;for(const w of Object.keys(y))f[w]===void 0&&(f[w]=y[w].default);this._options=f,this._transitionable.setTransitionOrValue(this._options,e)}updateConfig(p){this._transitionable.setTransitionOrValue(this._options,new Map(p))}updateTransitions(p){this._transitioning=this._transitionable.transitioned(p,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(p){this.properties=this._transitioning.possiblyEvaluate(p)}_validate(p,e,a){return(!a||a.validate!==!1)&&st(this,p.call(We,Object.assign({value:e,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}};class ao extends i.E{constructor(e,a,f,y){super(),this.scope=f,this._options=e,this.properties=new i.ai(a),this._transitionable=new i.a8(a,f,new Map(y)),this._transitionable.setTransitionOrValue(e.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(e){this._transitionable.setTransitionOrValue(this._options.properties,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(e,a){this._options=e,this._transitionable.setTransitionOrValue(e.properties,a)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class gn{constructor(e,a,f){this.screenBounds=e,this.cameraPoint=f.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=a,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,f)}static createFromScreenPoints(e,a){let f,y;if(e instanceof i.P||typeof e[0]=="number"){const w=i.P.convert(e);f=[w],y=a.isPointAboveHorizon(w)}else{const w=i.P.convert(e[0]),I=i.P.convert(e[1]),M=w.add(I)._div(2);f=[w,I],y=i.aq(w,I).every(L=>a.isPointAboveHorizon(L))&&a.isPointAboveHorizon(M)}return new gn(f,y,a)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(e){return i.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],e)}bufferedCameraGeometry(e){const a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],y=i.aq(a,f,0,!1);return this.cameraPoint.y>f.y&&(this.cameraPoint.x>a.x&&this.cameraPoint.x<f.x?y.splice(3,0,this.cameraPoint):this.cameraPoint.x>=f.x?y[2]=this.cameraPoint:this.cameraPoint.x<=a.x&&(y[3]=this.cameraPoint)),i.ar(y,e)}bufferedCameraGeometryGlobe(e){const a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],y=i.aq(a,f,e),w=this.cameraPoint.clone();switch(3*((w.y>a.y)+(w.y>f.y))+((w.x>a.x)+(w.x>f.x))){case 0:y[0]=w,y[4]=w.clone();break;case 1:y.splice(1,0,w);break;case 2:y[1]=w;break;case 3:y.splice(4,0,w);break;case 5:y.splice(2,0,w);break;case 6:y[3]=w;break;case 7:y.splice(3,0,w);break;case 8:y[2]=w}return y}containsTile(e,a,f,y=0){const w=Math.max(e.queryPadding,e.evaluateQueryRenderedFeaturePadding())/a._pixelsPerMercatorPixel+1,I=f?this._bufferedCameraMercator(w,a):this._bufferedScreenMercator(w,a);let M=e.tileID.wrap+(I.unwrapped?y:0);const L=I.polygon.map(ht=>i.as(e.tileTransform,ht,M));if(!i.at(L,0,0,i.al,i.al))return;M=e.tileID.wrap+(this.screenGeometryMercator.unwrapped?y:0);const N=this.screenGeometryMercator.polygon.map(ht=>i.au(e.tileTransform,ht,M)),V=N.map(ht=>new i.P(ht[0],ht[1])),Z=a.getFreeCameraOptions().position||new i.ae(0,0,0),U=i.au(e.tileTransform,Z,M),X=N.map(ht=>{const lt=i.av(ht,ht,U);return i.aw(lt,lt),new i.ax(U,lt)}),K=i.ay(e,1,a.zoom)*a._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:V,tilespaceRays:X,bufferedTilespaceGeometry:L,bufferedTilespaceBounds:(rt=i.az(L),rt.min.x=i.aA(rt.min.x,0,i.al),rt.min.y=i.aA(rt.min.y,0,i.al),rt.max.x=i.aA(rt.max.x,0,i.al),rt.max.y=i.aA(rt.max.y,0,i.al),rt),tile:e,tileID:e.tileID,pixelToTileUnitsFactor:K};var rt}_bufferedScreenMercator(e,a){const f=to(e);if(this._screenRaycastCache[f])return this._screenRaycastCache[f];{let y;return y=a.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(e),a):{polygon:this.bufferedScreenGeometry(e).map(w=>a.pointCoordinate3D(w)),unwrapped:!0},this._screenRaycastCache[f]=y,y}}_bufferedCameraMercator(e,a){const f=to(e);if(this._cameraRaycastCache[f])return this._cameraRaycastCache[f];{let y;return y=a.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(e),a):{polygon:this.bufferedCameraGeometry(e).map(w=>a.pointCoordinate3D(w)),unwrapped:!0},this._cameraRaycastCache[f]=y,y}}_projectAndResample(e,a){const f=function(w,I){const M=i.aB([],I.pixelMatrix,I.globeMatrix),L=[0,-i.aD,0,1],N=[0,i.aD,0,1],V=[0,0,0,1];i.aC(L,L,M),i.aC(N,N,M),i.aC(V,V,M);const Z=new i.P(L[0]/L[3],L[1]/L[3]),U=new i.P(N[0]/N[3],N[1]/N[3]),X=i.aE(w,Z)&&L[3]<V[3],K=i.aE(w,U)&&N[3]<V[3];if(!X&&!K)return null;const rt=function($t,Ot,Rt){for(let Zt=1;Zt<$t.length;Zt++){const pe=Wn(Ot.pointCoordinate3D($t[Zt-1]).x),le=Wn(Ot.pointCoordinate3D($t[Zt]).x);if(Rt<0){if(pe<le)return{idx:Zt,t:-pe/(le-1-pe)}}else if(le<pe)return{idx:Zt,t:(1-pe)/(le+1-pe)}}return null}(w,I,X?-1:1);if(!rt)return null;const{idx:ht,t:lt}=rt;let _t=ht>1?Ur(w.slice(0,ht),I):[],Mt=ht<w.length?Ur(w.slice(ht),I):[];_t=_t.map($t=>new i.P(Wn($t.x),$t.y)),Mt=Mt.map($t=>new i.P(Wn($t.x),$t.y));const vt=[..._t];vt.length===0&&vt.push(Mt[Mt.length-1]);const Ut=i.ak(vt[vt.length-1].y,(Mt.length===0?_t[0]:Mt[0]).y,lt);let Ct;return Ct=X?[new i.P(0,Ut),new i.P(0,0),new i.P(1,0),new i.P(1,Ut)]:[new i.P(1,Ut),new i.P(1,1),new i.P(0,1),new i.P(0,Ut)],vt.push(...Ct),Mt.length===0?vt.push(_t[0]):vt.push(...Mt),{polygon:vt.map($t=>new i.ae($t.x,$t.y)),unwrapped:!1}}(e,a);if(f)return f;const y=function(w,I){let M=!1,L=-1/0,N=0;for(let Z=0;Z<w.length-1;Z++)w[Z].x>L&&(L=w[Z].x,N=Z);for(let Z=0;Z<w.length-1;Z++){const U=(N+Z)%(w.length-1),X=w[U],K=w[U+1];Math.abs(X.x-K.x)>.5&&(X.x<K.x?(X.x+=1,U===0&&(w[w.length-1].x+=1)):(K.x+=1,U+1===w.length-1&&(w[0].x+=1)),M=!0)}const V=i.aF(I.center.lng);return M&&V<Math.abs(V-1)&&w.forEach(Z=>{Z.x-=1}),{polygon:w,unwrapped:M}}(Ur(e,a).map(w=>new i.P(Wn(w.x),w.y)),a);return{polygon:y.polygon.map(w=>new i.ae(w.x,w.y)),unwrapped:y.unwrapped}}}function Ur(p,e){return i.aG(p,a=>{const f=e.pointCoordinate3D(a);a.x=f.x,a.y=f.y},1/256)}function Wn(p){return p<0?1+p%1:p%1}function to(p){return 100*p|0}function Dn(p,e,a,f,y){const w=function(M,L){if(M)return y(M);if(L){if(p.url&&L.tiles&&p.tiles&&delete p.tiles,L.variants){if(!Array.isArray(L.variants))return y(new Error("variants must be an array"));for(const V of L.variants){if(V==null||typeof V!="object"||V.constructor!==Object)return y(new Error("variant must be an object"));if(!Array.isArray(V.capabilities))return y(new Error("capabilities must be an array"));if(V.capabilities.length===1&&V.capabilities[0]==="meshopt"){L=Object.assign(L,V);break}}}const N=i.aH(Object.assign({},L,p),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);N.tiles=e.canonicalizeTileset(N,p.url),y(null,N)}},I=function(M,L,N){if(!M)return null;if(!L&&!N)return M;N=N||M.worldview_default;const V=Object.values(M.language||{});if(V.length===0)return null;const Z=Object.values(M.worldview||{});if(Z.length===0)return null;const U=V.every(K=>K===L),X=Z.every(K=>K===N);return U&&X?M:L in(M.language_options||{})||N in(M.worldview_options||{})?null:M.language_options&&M.worldview_options?M:null}(p.data,a,f);return I?i.o.frame(()=>w(null,I)):p.url?i.m(e.transformRequest(e.normalizeSourceURL(p.url,null,a,f),i.R.Source),w):i.o.frame(()=>{const{data:M,...L}=p;w(null,L)})}function eo(p,e){const a=Math.pow(2,e.z),f=Math.floor(i.aF(p.getWest())*a),y=Math.floor(i.aJ(p.getNorth())*a),w=Math.ceil(i.aF(p.getEast())*a),I=Math.ceil(i.aJ(p.getSouth())*a);return e.x>=f&&e.x<w&&e.y>=y&&e.y<I}class ps{constructor(e,a,f){this.bounds=e?i.aI.convert(this.validateBounds(e)):null,this.minzoom=a||0,this.maxzoom=f||24}validateBounds(e){return Array.isArray(e)&&e.length===4?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}addExtraBounds(e){if(e){this.extraBounds||(this.extraBounds=[]);for(const a of e)this.extraBounds.push(i.aI.convert(this.validateBounds(a)))}}contains(e){if(e.z>this.maxzoom||e.z<this.minzoom||this.bounds&&!eo(this.bounds,e))return!1;if(!this.extraBounds)return!0;for(const a of this.extraBounds)if(eo(a,e))return!0;return!1}static fromTileJSON(e){if(!e.bounds&&!e.extra_bounds)return null;const a=new ps(e.bounds,e.minzoom,e.maxzoom);return a.addExtraBounds(e.extra_bounds),a}}class na extends i.E{constructor(e,a,f,y){if(super(),this.id=e,this.dispatcher=f,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,i.aH(a,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},a),this._collectResourceTiming=!!a.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(y),this._tileWorkers={},this._deduped=new i.aK}load(e){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));const a=Array.isArray(this.map._language)?this.map._language.join():this.map._language,f=this.map.getWorldview();this._tileJSONRequest=Dn(this._options,this.map._requestManager,a,f,(y,w)=>{if(this._tileJSONRequest=null,this._loaded=!0,y)a&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${a}`),f&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${f}`),this.fire(new i.y(y));else if(w){if(Object.assign(this,w),this.hasWorldviews=!!w.worldview_options,w.worldview_default&&(this.worldviewDefault=w.worldview_default),w.vector_layers){this.vectorLayers=w.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const I of w.vector_layers)this.vectorLayerIds.push(I.id),w.worldview&&w.worldview[I.source]&&this.localizableLayerIds.add(I.id)}this.tileBounds=ps.fromTileJSON(w),Ps(w.tiles,this.map._requestManager._customAccessToken),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}e&&e(y)})}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const e=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(e))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(e,a){const f=e.tileID.canonical.url(this.tiles,this.scheme),y=this.map._requestManager.normalizeTileURL(f),w=this.map._requestManager.transformRequest(y,i.R.Tile),I=this.map.style?this.map.style.getLut(this.scope):null,M=I?{image:I.image.clone()}:null,L={request:w,data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,lut:M,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:i.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:e.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:e.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&i.h(f)&&(L.localizableLayerIds=this.localizableLayerIds),L.request.collectResourceTiming=this._collectResourceTiming,e.actor&&e.state!=="expired")e.state==="loading"?e.reloadCallback=a:e.request=e.actor.send("reloadTile",L,N.bind(this));else if(e.actor=this._tileWorkers[y]=this._tileWorkers[y]||this.dispatcher.getActor(),this.dispatcher.ready)e.request=e.actor.send("loadTile",L,N.bind(this),void 0,!0);else{const V=i.aL.call({deduped:this._deduped},L,(Z,U)=>{if(Z||!U)N.call(this,Z);else{const X=i.aM(U.responseHeaders);L.data={cacheControl:X.cacheControl,expires:X.expires,rawData:U.rawData.slice(0)},e.actor&&e.actor.send("loadTile",L,N.bind(this),void 0,!0)}},!0);e.request={cancel:V}}function N(V,Z){return delete e.request,e.aborted?a(null):V&&V.status!==404?a(V):(Z&&Z.resourceTiming&&(e.resourceTiming=Z.resourceTiming),this.map._refreshExpiredTiles&&Z&&e.setExpiryData(Z),e.loadVectorData(Z,this.map.painter),i.aN(this.dispatcher),a(null,Z),void(e.reloadCallback&&(this.loadTile(e,e.reloadCallback),e.reloadCallback=null)))}}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,a){e.actor&&e.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Dl extends i.E{constructor(e,a,f,y){super(),this.id=e,this.dispatcher=f,this.setEventedParent(y),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},a),Object.assign(this,i.aH(a,["url","scheme","tileSize"]))}load(e){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));const a=this.map.getWorldview();this._tileJSONRequest=Dn(this._options,this.map._requestManager,null,a,(f,y)=>{this._tileJSONRequest=null,this._loaded=!0,f?this.fire(new i.y(f)):y&&(Object.assign(this,y),y.raster_layers&&(this.rasterLayers=y.raster_layers,this.rasterLayerIds=this.rasterLayers.map(w=>w.id)),this.tileBounds=ps.fromTileJSON(y),Ps(y.tiles),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))),e&&e(f)})}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const e=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(e))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,a){const f=i.o.devicePixelRatio>=2,y=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),f,this.tileSize);e.request=i.n(this.map._requestManager.transformRequest(y,i.R.Tile),(w,I,M)=>{if(delete e.request,e.aborted)return e.state="unloaded",a(null);if(w)return e.state="errored",a(w);if(!I)return a(null);const L=i.aM(M);this.map._refreshExpiredTiles&&e.setExpiryData(L),e.setTexture(I,this.map.painter),e.state="loaded",i.aN(this.dispatcher),a(null)})}abortTile(e,a){e.request&&(e.request.cancel(),delete e.request),a&&a()}unloadTile(e,a){e.texture&&e.texture instanceof i.T?(e.destroy(!0),e.texture&&e.texture instanceof i.T&&this.map.painter.saveTileTexture(e.texture)):e.destroy(),a&&a()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Ih([p,e],a,f,{scaled:y=!0}={}){const{tileSize:w,buffer:I}=f,{x:M,y:L,z:N}=a;if(!isFinite(M)||!isFinite(L)||!isFinite(N))throw new Error("Invalid MRT header");const V=2**N,Z=V*i.aF(p),U=V*i.aJ(e);return function([X,K],rt,{scaled:ht=!0}={}){if(!rt)throw new Error("bandView is undefined");const{data:lt,tileSize:_t,buffer:Mt,offset:vt,scale:Ut,dimension:Ct}=rt;if(X<-Mt||X>_t+Mt||K<-Mt||K>_t+Mt)throw new Error(`Point (${X}, ${K}) out of bounds for tileSize=${_t}, buffer=${Mt}`);const $t=(K+Mt)*(_t+2*Mt)+(X+Mt);if(new Uint32Array(lt.buffer)[$t]===4294967295)return null;let Ot=[];Ot=ht?[]:new rt.data.constructor(Ct);for(let Rt=0;Rt<Ct;Rt++)Ot[Rt]=Math.round(1e12*(lt[Ct*$t+Rt]*Ut+vt))/1e12;return Ot}([Math.min(Math.max(-I,Math.floor((Z-M)*w)),w-1+I),Math.min(Math.max(-I,Math.floor((U-L)*w)),w-1+I)],f,{scaled:y})}class hs extends Dl{constructor(e,a,f,y){super(e,a,f,y),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},a)}triggerRepaint(e){const a=this.map.painter._terrain,f=this.map.style.getSourceCache(this.id);a&&a.enabled&&f&&a._clearRenderCacheForTile(f.id,e.tileID),this.map.triggerRepaint()}loadTile(e,a){const f=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),y=this.map._requestManager.transformRequest(f,i.R.Tile),w={request:y,uid:e.uid,tileID:e.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};e.source=this.id,e.scope=this.scope,e.requestParams=y,e.actor||(e.actor=this.dispatcher.getActor());const I=(M,L,N)=>{if(delete e.request,e.aborted)return e.state="unloaded",a(null);if(M)return M.name==="AbortError"?void 0:(e.state="errored",a(M));if(this.map._refreshExpiredTiles&&L){const V=i.aM(N);e.setExpiryData(V)}if(this.partial&&e.state!=="expired")e.state="empty";else if(!this.partial){if(!L)return a(null);e.state="loaded",e._isHeaderLoaded=!0,e._mrt=L}a(null)};e.request=this.partial?e.fetchHeader(void 0,I.bind(this)):e.actor.send("loadTile",w,I.bind(this),void 0,!0)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,a){const f=e.texturePerLayer;if(e.flushAllQueues(),f.size){e.destroy(!0);for(const y of f.values())this.map.painter.saveTileTexture(y)}else e.destroy()}prepareTile(e,a,f,y){e._isHeaderLoaded&&(e.state!=="empty"&&(e.state="reloading"),e.fetchBandForRender(a,f,y,(w,I)=>{if(w)return e.state="errored",this.fire(new i.y(w)),void this.triggerRepaint(e);I&&(e._isHeaderLoaded=!0,e.setTexturePerLayer(f,I,this.map.painter),e.state="loaded",this.triggerRepaint(e))}))}getInitialBand(e){if(!this.rasterLayers)return 0;const a=this.rasterLayers.find(({id:w})=>w===e),f=a&&a.fields,y=f&&f.bands&&f.bands;return y?y[0]:0}getTextureDescriptor(e,a,f){if(!e)return;const y=a.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!y)return;let w=null;a instanceof i.aQ?w=a.paint.get("raster-array-band"):a instanceof i.aR&&(w=a.paint.get("raster-particle-array-band"));const I=w||this.getInitialBand(y);if(I==null)return;if(!e.textureDescriptorPerLayer.get(a.id))return void this.prepareTile(e,y,a.id,I);if(e.updateNeeded(a.id,I)&&!f)return;const M=e.textureDescriptorPerLayer.get(a.id);return Object.assign({},M,{texture:e.texturePerLayer.get(a.id)})}getImages(e,a){const f=new Map;for(const y of e)for(const w of a){const[I,M]=w.split("/"),L=y.getLayer(I);if(!L||!L.hasBand(M)||!L.hasDataForBand(M))continue;const{bytes:N,tileSize:V,buffer:Z}=L.getBandView(M),U=V+2*Z,X={data:new i.q({width:U,height:U},N),pixelRatio:2,sdf:!1,usvg:!1,version:0};f.set(w,X)}return f}queryRasterArrayValueByBandId(e,a,f){const y=a._mrt;return new Promise(w=>{const I={},M=new Set;for(const[L,N]of Object.entries(y.layers)){if(f.layerName&&L!==f.layerName)continue;const V={};I[L]=V;for(const{bands:Z}of N.dataIndex)for(const U of Z)f.bands&&!f.bands.includes(U)||(M.add(i.B(L,U)),a.fetchBand(L,null,U,X=>{i.o.frame(()=>{V[U]=X?null:Ih([e.lng,e.lat],y,N.getBandView(U)),M.delete(i.B(L,U)),M.size===0&&w(I)})},!1))}M.size===0&&w(I)})}_loadTileForQuery(e,a){if(this._loadTileLoaded[e.uid])return void a(null,e._mrt);if(this._loadTilePending[e.uid])return void this._loadTilePending[e.uid].push(a);this._loadTilePending[e.uid]=[a];const f=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),y=this.map._requestManager.transformRequest(f,i.R.Tile);e.actor.send("loadTile",{request:y,uid:e.uid,tileID:e.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},(w,I,M)=>{if(w)return this._loadTilePending[e.uid].forEach(L=>L(w,null)),void delete this._loadTilePending[e.uid];if(!I)return this._loadTilePending[e.uid].forEach(L=>L(null,null)),void delete this._loadTilePending[e.uid];if(this.map._refreshExpiredTiles&&I){const L=i.aM(M);e.setExpiryData(L)}e._mrt=I,e._isHeaderLoaded=!0,e.state="loaded",this._loadTilePending[e.uid].forEach(L=>L(null,I)),this._loadTileLoaded[e.uid]=!0,delete this._loadTilePending[e.uid]},void 0,!0)}queryRasterArrayValueByAllBands(e,a,f){return new Promise((y,w)=>{this._loadTileForQuery(a,(I,M)=>{I?w(I):y(M?this.queryRasterArrayValueByBandId(e,a,f):null)})})}queryRasterArrayValue(e,a){const f=i.aS.convert(e),y=this.findLoadedParent(f);return y&&y._mrt?a.bands||!this.partial?this.queryRasterArrayValueByBandId(f,y,a):this.queryRasterArrayValueByAllBands(f,y,a):Promise.resolve(null)}findLoadedParent(e){const a=i.ae.fromLngLat(e,this.map.transform.tileSize),f=this.maxzoom+1,y=1<<f,w=Math.floor(a.x),I=Math.floor((a.x-w)*y),M=Math.floor(a.y*y),L=this.map.style.getSourceCache(this.id),N=new i.aP(f,w,f,I,M);return L.findLoadedParent(N,this.minzoom)}}const ul={vector:na,raster:Dl,"raster-dem":class extends Dl{constructor(p,e,a,f){super(p,e,a,f),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},e),this.encoding=e.encoding||"mapbox"}loadTile(p,e){const a=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function f(y,w){y&&(p.state="errored",e(y)),w&&(p.dem=w,p.dem.onDeserialize(),p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0,p.state="loaded",e(null))}p.request=i.n(this.map._requestManager.transformRequest(a,i.R.Tile),(function(y,w,I){if(delete p.request,p.aborted)p.state="unloaded",e(null);else if(y)p.state="errored",e(y);else if(w){const M=i.aM(I);this.map._refreshExpiredTiles&&p.setExpiryData(M);const L=ImageBitmap&&w instanceof ImageBitmap&&i.r(),N=1-(w.width-i.aO(w.width))/2;N<1||p.neighboringTiles||(p.neighboringTiles=this._getNeighboringTiles(p.tileID));const V=L?w:i.o.getImageData(w,N),Z={uid:p.uid,tileID:p.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:V,encoding:this.encoding,padding:N};p.actor&&p.state!=="expired"||(p.actor=this.dispatcher.getActor(),p.actor.send("loadTile",Z,f.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(p){const e=p.canonical,a=Math.pow(2,e.z),f=(e.x-1+a)%a,y=e.x===0?p.wrap-1:p.wrap,w=(e.x+1+a)%a,I=e.x+1===a?p.wrap+1:p.wrap,M={};return M[new i.aP(p.overscaledZ,y,e.z,f,e.y).key]={backfilled:!1},M[new i.aP(p.overscaledZ,I,e.z,w,e.y).key]={backfilled:!1},e.y>0&&(M[new i.aP(p.overscaledZ,y,e.z,f,e.y-1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,p.wrap,e.z,e.x,e.y-1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,I,e.z,w,e.y-1).key]={backfilled:!1}),e.y+1<a&&(M[new i.aP(p.overscaledZ,y,e.z,f,e.y+1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,p.wrap,e.z,e.x,e.y+1).key]={backfilled:!1},M[new i.aP(p.overscaledZ,I,e.z,w,e.y+1).key]={backfilled:!1}),M}},"raster-array":hs,geojson:class extends i.E{constructor(p,e,a,f){super(),this.id=p,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=a.getActor(),this.setEventedParent(f),this._data=e.data,this._options=Object.assign({},e),this._collectResourceTiming=e.collectResourceTiming,e.maxzoom!==void 0&&(this.maxzoom=e.maxzoom),e.minzoom!==void 0&&(this.minzoom=e.minzoom),e.type&&(this.type=e.type),e.attribution&&(this.attribution=e.attribution),this.promoteId=e.promoteId;const y=i.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:e.cluster||!1,geojsonVtOptions:{buffer:(e.buffer!==void 0?e.buffer:128)*y,tolerance:(e.tolerance!==void 0?e.tolerance:.375)*y,extent:i.al,maxZoom:this.maxzoom,lineMetrics:e.lineMetrics||!1,generateId:e.generateId||!1},superclusterOptions:{maxZoom:e.clusterMaxZoom!==void 0?e.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,e.clusterMinPoints||2),extent:i.al,radius:(e.clusterRadius!==void 0?e.clusterRadius:50)*y,log:!1,generateId:e.generateId||!1},clusterProperties:e.clusterProperties,filter:e.filter,dynamic:e.dynamic},e.workerOptions)}onAdd(p){this.map=p,this.setData(this._data)}setData(p){return this._data=p,this._updateWorkerData(),this}updateData(p){if(!this._options.dynamic)return this.fire(new i.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof p!="string"&&(p.type==="Feature"&&(p={type:"FeatureCollection",features:[p]}),p.type!=="FeatureCollection"))return this.fire(new i.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof p!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const e=new Map;for(const a of this._data.features)e.set(a.id,a);for(const a of p.features)e.set(a.id,a);this._data.features=[...e.values()]}else this._data=p;return this._updateWorkerData(!0),this}getClusterExpansionZoom(p,e){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:p,source:this.id,scope:this.scope},e),this}getClusterChildren(p,e){return this.actor.send("geojson.getClusterChildren",{clusterId:p,source:this.id,scope:this.scope},e),this}getClusterLeaves(p,e,a,f){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:p,limit:e,offset:a},f),this}_updateWorkerData(p=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new i.z("dataloading",{dataType:"source"})),this._loaded=!1;const e=Object.assign({append:p},this.workerOptions);e.scope=this.scope;const a=this._data;typeof a=="string"?(e.request=this.map._requestManager.transformRequest(i.o.resolveURL(a),i.R.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(a),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,(f,y)=>{if(this._loaded=!0,this._pendingLoad=null,f)this.fire(new i.y(f));else{const w={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&y&&y.resourceTiming&&y.resourceTiming[this.id]&&(w.resourceTiming=y.resourceTiming[this.id]),p&&(this._partialReload=!0),this.fire(new i.z("data",w)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(p),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const p=i.B(this.id,this.scope);this.map.style.clearSource(p),this._updateWorkerData()}loadTile(p,e){const a=p.actor?"reloadTile":"loadTile";p.actor=this.actor;const f=this.map.style?this.map.style.getLut(this.scope):null,y=f?{image:f.image.clone()}:null,w=this._partialReload,I={type:this.type,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:y,scope:this.scope,pixelRatio:i.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:p.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:w,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};p.request=this.actor.send(a,I,(M,L)=>w&&!L?(p.state="loaded",e(null)):(delete p.request,p.destroy(),p.aborted?e(null):M?e(M):(p.loadVectorData(L,this.map.painter,a==="reloadTile"),e(null))),void 0,a==="loadTile")}abortTile(p){p.request&&(p.request.cancel(),delete p.request),p.aborted=!0}unloadTile(p,e){this.actor.send("removeTile",{uid:p.uid,type:this.type,source:this.id,scope:this.scope}),p.destroy()}onRemove(p){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends i.aT{constructor(p,e,a,f){super(p,e,a,f),this.roundZoom=!0,this.type="video",this.options=e}load(){this._loaded=!1;const p=this.options;this.urls=[];for(const e of p.urls)this.urls.push(this.map._requestManager.transformRequest(e,i.R.Source).url);i.aU(this.urls,(e,a)=>{this._loaded=!0,e?this.fire(new i.y(e)):a&&(this.video=a,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(p){if(this.video){const e=this.video.seekable;p<e.start(0)||p>e.end(0)?this.fire(new i.y(new i.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${e.start(0)} and ${e.end(0)}-second mark.`))):this.video.currentTime=p}}getVideo(){return this.video}onAdd(p){this.map||(this.map=p,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const p=this.map.painter.context,e=p.gl;this.texture?this.video.paused||(this.texture.bind(e.LINEAR,e.CLAMP_TO_EDGE),e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,this.video)):(this.texture=new i.T(p,this.video,e.RGBA8),this.texture.bind(e.LINEAR,e.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(p)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:i.aT,model:i.aW,"batched-model":class extends i.E{constructor(p,e,a,f){super(),this.type="batched-model",this.id=p,this.tileSize=512,this._options=e,this.tiles=this._options.tiles,this.maxzoom=e.maxzoom||19,this.minzoom=e.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=a,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(f)}onAdd(p){this.map=p,this.load()}reload(){this.cancelTileJSONRequest();const p=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(p))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(p){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));const e=Array.isArray(this.map._language)?this.map._language.join():this.map._language,a=this.map.getWorldview();this._tileJSONRequest=Dn(this._options,this.map._requestManager,e,a,(f,y)=>{this._tileJSONRequest=null,this._loaded=!0,f?(e&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${e}`),a&&a.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${a}`),this.fire(new i.y(f))):y&&(Object.assign(this,y),y.bounds&&(this.tileBounds=new ps(y.bounds,this.minzoom,this.maxzoom)),Ps(y.tiles,this.map._requestManager._customAccessToken),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))),p&&p(f)})}hasTransition(){return!1}hasTile(p){return!this.tileBounds||this.tileBounds.contains(p.canonical)}loaded(){return this._loaded}loadTile(p,e){const a=this.map._requestManager.normalizeTileURL(p.tileID.canonical.url(this.tiles,this.scheme)),f={request:this.map._requestManager.transformRequest(a,i.R.Tile),data:void 0,uid:p.uid,tileID:p.tileID,tileZoom:p.tileZoom,zoom:p.tileID.overscaledZ,tileSize:this.tileSize*p.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:p.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:i.o.devicePixelRatio,promoteId:this.promoteId};if(p.actor&&p.state!=="expired")if(p.state==="loading")p.reloadCallback=e;else{if(p.buckets){const w=Object.values(p.buckets);for(const I of w)I.dirty=!0;return void(p.state="loaded")}p.request=p.actor.send("reloadTile",f,y.bind(this))}else p.actor=this.dispatcher.getActor(),p.request=p.actor.send("loadTile",f,y.bind(this),void 0,!0);function y(w,I){return p.aborted?e(null):w&&w.status!==404?e(w):(this.map._refreshExpiredTiles&&I&&p.setExpiryData(I),p.loadModelData(I,this.map.painter),p.state="loaded",void e(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends i.aT{constructor(p,e,a,f){super(p,e,a,f),e.coordinates?Array.isArray(e.coordinates)&&e.coordinates.length===4&&!e.coordinates.some(y=>!Array.isArray(y)||y.length!==2||y.some(w=>typeof w!="number"))||this.fire(new i.y(new i.V(`sources.${p}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new i.y(new i.V(`sources.${p}`,null,'missing required property "coordinates"'))),e.animate&&typeof e.animate!="boolean"&&this.fire(new i.y(new i.V(`sources.${p}`,null,'optional "animate" property must be a boolean value'))),e.canvas?typeof e.canvas=="string"||e.canvas instanceof HTMLCanvasElement||this.fire(new i.y(new i.V(`sources.${p}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new i.y(new i.V(`sources.${p}`,null,'missing required property "canvas"'))),this.options=e,this.animate=e.animate===void 0||e.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new i.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(p){this.map=p,this.load(),this.canvas&&this.animate&&this.play()}onRemove(p){this.pause()}prepare(){let p=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,p=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,p=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const e=this.map.painter.context;this.texture?!p&&!this._playing||this.texture instanceof i.aV||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new i.T(e,this.canvas,e.gl.RGBA8,{premultiply:!0}),this._prepareData(e)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const p of[this.canvas.width,this.canvas.height])if(isNaN(p)||p<=0)return!0;return!1}},custom:class extends i.E{constructor(p,e,a,f){super(),this.id=p,this.type="custom",this._dataType="raster",this._dispatcher=a,this._implementation=e,this.setEventedParent(f),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new i.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new i.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new ps(this._implementation.bounds,this.minzoom,this.maxzoom)),e.update=this._update.bind(this),e.clearTiles=this._clearTiles.bind(this),e.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,i.aH(e,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return i.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(p){this.map=p,this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(p),this.load()}onRemove(p){this._implementation.onRemove&&this._implementation.onRemove(p)}hasTile(p){if(this._implementation.hasTile){const{x:e,y:a,z:f}=p.canonical;return this._implementation.hasTile({x:e,y:a,z:f})}return!this.tileBounds||this.tileBounds.contains(p.canonical)}loadTile(p,e){const{x:a,y:f,z:y}=p.tileID.canonical,w=new AbortController;p.request=Promise.resolve(this._implementation.loadTile({x:a,y:f,z:y},{signal:w.signal})).then((function(I){return delete p.request,p.aborted?(p.state="unloaded",e(null)):I===void 0?(p.state="errored",e(null)):I===null?(this.loadTileData(p,{width:this.tileSize,height:this.tileSize,data:null}),p.state="loaded",e(null)):function(M){return M instanceof ImageData||M instanceof HTMLCanvasElement||M instanceof ImageBitmap||M instanceof HTMLImageElement}(I)?(this.loadTileData(p,I),p.state="loaded",void e(null)):(p.state="errored",e(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(I=>{I.name!=="AbortError"&&(p.state="errored",e(I))}),p.request.cancel=()=>w.abort()}loadTileData(p,e){p.setTexture(e,this.map.painter)}unloadTile(p,e){if(p.texture&&p.texture instanceof i.T?(p.destroy(!0),p.texture&&p.texture instanceof i.T&&this.map.painter.saveTileTexture(p.texture)):p.destroy(),this._implementation.unloadTile){const{x:a,y:f,z:y}=p.tileID.canonical;this._implementation.unloadTile({x:a,y:f,z:y})}e&&e()}abortTile(p,e){p.request&&p.request.cancel&&(p.request.cancel(),delete p.request),e&&e()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(p=>({x:p.canonical.x,y:p.canonical.y,z:p.canonical.z}))}_clearTiles(){const p=i.B(this.id,this.scope);this.map.style.clearSource(p)}_update(){this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}}},Ta=function(p,e,a,f){const y=new ul[e.type](p,e,a,f);if(y.id!==p)throw new Error(`Expected Source id to be ${p} instead of ${y.id}`);return i.aX(["load","abort","unload","serialize","prepare"],y),y};function zl(p,e,a=""){return`${a}:${e.id||""}:${e.layer.id}:${function(f){if("layerId"in f)return`layer:${f.layerId}`;{const{featuresetId:y,importId:w}=f;return`featureset:${y}${w?`:import:${w}`:""}`}}(p.target)}`}function za(p,e,a,f=""){if(p.uniqueFeatureID){const y=zl(p,e,f);if(a.has(y))return!0;a.add(y)}return!1}function Qa(p,e,a,f,y=!1){const w=e.sourceCache.transform,I=e.sourceCache.tilesIn(p,e.has3DLayers,y);I.sort(Nu);const M=[];for(const L of I){const N=L.tile.queryRenderedFeatures(e,L,a,f,w,y);Object.keys(N).length&&M.push({wrappedTileID:L.tile.tileID.wrapped().key,queryResults:N})}for(const L in e.layers){const N=e.layers[L];if(N.styleLayer){const V=N.styleLayer.queryRenderedFeatures(p,e.sourceCache,f);Object.keys(V).length&&M.push({wrappedTileID:0,queryResults:V})}}return M.length===0?{}:function(L){const N={},V={};for(const Z of L){const U=Z.queryResults,X=Z.wrappedTileID,K=V[X]=V[X]||{};for(const rt in U){const ht=U[rt],lt=K[rt]=K[rt]||{},_t=N[rt]=N[rt]||[];for(const Mt of ht)lt[Mt.featureIndex]||(lt[Mt.featureIndex]=!0,_t.push(Mt))}}return N}(M)}function Hl(p,e,a,f,y,w){const I={},M=f.queryRenderedSymbols(p),L=[];for(const N of Object.keys(M).map(Number))L.push(y[N]);L.sort(Nu);for(const N of L){const V=N.featureIndex.lookupSymbolFeatures(M[N.bucketInstanceId],N.bucketIndex,N.sourceLayerIndex,e,a,w);for(const Z in V){const U=I[Z]=I[Z]||[],X=V[Z];X.sort((K,rt)=>{const ht=N.featureSortOrder;if(ht){const lt=ht.indexOf(K.featureIndex);return ht.indexOf(rt.featureIndex)-lt}return rt.featureIndex-K.featureIndex});for(const K of X)U.push(K)}}return I}function Eh(p,e){const a=p.getRenderableIds().map(w=>p.getTileByID(w)),f=[],y={};for(let w=0;w<a.length;w++){const I=a[w],M=I.tileID.canonical.key;y[M]||(y[M]=!0,I.querySourceFeatures(f,e))}return f}function Nu(p,e){const a=p.tileID,f=e.tileID;return a.overscaledZ-f.overscaledZ||a.canonical.y-f.canonical.y||a.wrap-f.wrap||a.canonical.x-f.canonical.x}function dl(p,e){const a={};if(!e)return a;for(const f of p){const y=f.layerIds.map(w=>e.getLayer(w)).filter(Boolean);if(y.length!==0){f.layers=y,f.stateDependentLayerIds&&(f.stateDependentLayers=f.stateDependentLayerIds.map(w=>y.filter(I=>I.id===w)[0]));for(const w of y)a[w.fqid]=f}}return a}const La=32,ac=33,fs=new Uint16Array(8184);for(let p=0;p<2046;p++){let e=p+2,a=0,f=0,y=0,w=0,I=0,M=0;for(1&e?y=w=I=La:a=f=M=La;(e>>=1)>1;){const N=a+y>>1,V=f+w>>1;1&e?(y=a,w=f,a=I,f=M):(a=y,f=w,y=I,w=M),I=N,M=V}const L=4*p;fs[L+0]=a,fs[L+1]=f,fs[L+2]=y,fs[L+3]=w}const Js=new Uint16Array(2178),un=new Uint8Array(1089),oa=new Uint16Array(1089);function Vn(p){return p===0?-.03125:p===32?.03125:0}const lc={type:2,extent:i.al,loadGeometry:()=>[[new i.P(0,0),new i.P(i.al+1,0),new i.P(i.al+1,i.al+1),new i.P(0,i.al+1),new i.P(0,0)]]};class Uo{constructor(e,a,f,y,w,I){this.tileID=e,this.uid=i.b1(),this.uses=0,this.tileSize=a,this.tileZoom=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=w,y&&y.style&&(this._lastUpdatedBrightness=y.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",y&&y.transform&&(this.projection=y.transform.projection),this.worldview=I,this._hasAppearances=null}registerFadeDuration(e){const a=e+this.timeAdded;a<i.o.now()||this.fadeEndTime&&a<this.fadeEndTime||(this.fadeEndTime=a)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=i.aY(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(e,a,f){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=dl(e.buckets,a.style),this.hasSymbolBuckets=!1;for(const y in this.buckets){const w=this.buckets[y];if(w instanceof i.b3){if(this.hasSymbolBuckets=!0,!f)break;w.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const y in this.buckets){const w=this.buckets[y];if(w instanceof i.b3&&w.hasRTLText){this.hasRTLText=!0,i.b4();break}}this.queryPadding=0;for(const y in this.buckets){const w=this.buckets[y],I=a.style.getOwnLayer(y);if(!I)continue;const M=I.queryRadius(w);this.queryPadding=Math.max(this.queryPadding,M)}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas),this._lastUpdatedBrightness=e.brightness}else this.collisionBoxArray=new i.b2}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(e,a,f){e&&(e.resourceTiming&&(this.resourceTiming=e.resourceTiming),this.buckets=Object.assign({},this.buckets,dl(e.buckets,a.style)),e.featureIndex&&(this.latestFeatureIndex=e.featureIndex))}getBucket(e){return this.buckets[e.fqid]}upload(e,a){for(const w in this.buckets){const I=this.buckets[w];if(I.uploadPending()){let M={},L=[],N={zoom:0,pitch:0,brightness:0,worldview:""};if(a){if(a.style){L=a.style.listImages();const V=I.layers[0],Z=V.sourceLayer||"_geojsonTileLayer",U=a.style.getLayerSourceCache(V);U&&(M=U._state.getState(Z,void 0))}N={zoom:a.transform.zoom||0,pitch:a.transform.pitch||0,brightness:a.style.getBrightness()||0,worldview:a.worldview||""}}I.upload(e,this.tileID.canonical,M,L,N)}}const f=e.gl,y=this.imageAtlas;y&&!y.uploaded&&(this.imageAtlasTexture=new i.T(e,y.image,f.RGBA8,{useMipmap:!!y.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new i.T(e,this.glyphAtlasImage,f.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new i.T(e,this.lineAtlas.image,f.R8),this.lineAtlas.uploaded=!0)}prepare(e,a,f){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture,f),!a||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const y=a.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(a)),(this._lastUpdatedBrightness||y||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&y&&Math.abs(this._lastUpdatedBrightness-y)<.001||(this.updateBuckets(a,this._lastUpdatedBrightness!==y),this._lastUpdatedBrightness=y))}evaluateQueryRenderedFeaturePadding(){let e=0;for(const a in this.buckets){const f=this.buckets[a];f.evaluateQueryRenderedFeaturePadding&&(e=Math.max(e,f.evaluateQueryRenderedFeaturePadding()))}return e}queryRenderedFeatures(e,a,f,y,w,I){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const M=this.evaluateQueryRenderedFeaturePadding(),L=function(N,V){const Z=i.bp([],[.5*N.width,.5*-N.height,1]);return i.bq(Z,Z,[1,-1,0]),i.aB(Z,Z,N.calculateProjMatrix(V.toUnwrapped())),Float32Array.from(Z)}(w,this.tileID);return this.latestFeatureIndex.query(e,{tilespaceGeometry:a,pixelPosMatrix:L,transform:y,availableImages:f,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:M})}querySourceFeatures(e,a){const f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;const y=f.loadVTLayers(),w=a?a.sourceLayer:"",I=y._geojsonTileLayer||y[w];if(!I)return;const M=i.b5(a&&a.filter),{z:L,x:N,y:V}=this.tileID.canonical,Z={z:L,x:N,y:V};for(let U=0;U<I.length;U++){const X=I.feature(U);if(M.needGeometry){const ht=i.b6(X,!0);if(!M.filter(new i.ac(this.tileID.overscaledZ,{worldview:this.worldview}),ht,this.tileID.canonical))continue}else if(!M.filter(new i.ac(this.tileID.overscaledZ,{worldview:this.worldview}),X))continue;const K=f.getId(X,w),rt=new i.b7(X,L,N,V,K);rt.tile=Z,e.push(rt)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(e){const a=this.expirationTime;if(e.cacheControl){const f=i.b8(e.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const f=Date.now();let y=!1;if(this.expirationTime>f)y=!1;else if(a)if(this.expirationTime<a)y=!0;else{const w=this.expirationTime-a;w?this.expirationTime=f+Math.max(w,3e4):y=!0}else y=!0;y?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(e){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&e&&this.updateBuckets(e)}hasAppearances(e){for(const a in this.buckets)if(e.style.hasLayer(a)&&this.buckets[a].layers.some(f=>f.appearances&&f.appearances.length>0))return!0;return!1}updateBuckets(e,a){if(!this.latestFeatureIndex||!e.style)return;const f=this.latestFeatureIndex.loadVTLayers(),y=e.style.listImages(),w=e.style.getBrightness();for(const I in this.buckets){if(!e.style.hasLayer(I))continue;const M=this.buckets[I],L=M.layers[0],N=L.sourceLayer||"_geojsonTileLayer",V=f[N],Z=e.style.getLayerSourceCache(L);let U={};Z&&(U=Z._state.getState(N,void 0));const X=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},K=Object.keys(U).length>0&&!a;if(M.hasAppearances=M.layers.some(ht=>ht.appearances&&ht.appearances.length>0),(K&&M.stateDependentLayers.length!==0||a)&&M.update(U,V,y,X,K?M.stateDependentLayers:M.layers,a,w),K&&M.stateDependentLayers.length!==0||a||M.hasAppearances){const ht={zoom:e.transform.zoom,pitch:e.transform.pitch,brightness:e.style.getBrightness()||0,worldview:e.worldview};M.updateAppearances(this.tileID.canonical,U,y,ht)}(M instanceof i.b9||M instanceof i.ba)&&e._terrain&&e._terrain.enabled&&Z&&M.uploadPending()&&e._terrain._clearRenderCacheForTile(Z.id,this.tileID);const rt=e&&e.style&&e.style.getOwnLayer(I);rt&&(this.queryPadding=Math.max(this.queryPadding,rt.queryRadius(M)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<i.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=i.o.now()+e}setTexture(e,a){const f=a.context,y=f.gl;this.texture=this.texture||a.getTileTexture(e.width),this.texture&&this.texture instanceof i.T?this.texture.update(e):(this.texture=new i.T(f,e,y.RGBA8,{useMipmap:!0}),this.texture.bind(y.LINEAR,y.CLAMP_TO_EDGE))}setDependencies(e,a){const f={};for(const y of a)f[y]=!0;this.dependencies[e]=f}hasDependency(e,a){for(const f of e){const y=this.dependencies[f];if(y){for(const w of a)if(y[w])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,a){if(!a||a.name==="mercator"||this._tileDebugBuffer)return;const f=i.bb(lc,this.tileID.canonical,this.tileTransform)[0],y=new i.bc,w=new i.bd;for(let I=0;I<f.length;I++){const{x:M,y:L}=f[I];y.emplaceBack(M,L),w.emplaceBack(I)}w.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(w),this._tileDebugBuffer=e.createVertexBuffer(y,i.be.members),this._tileDebugSegments=i.bf.simpleSegment(0,0,y.length,w.length)}_makeTileBoundsBuffers(e,a){if(this._tileBoundsBuffer||!a||a.name==="mercator")return;const f=i.bb(lc,this.tileID.canonical,this.tileTransform)[0];let y,w;if(this.isRaster){const I=function(M,L){const N=i.aY(M,L),V=Math.pow(2,M.z);for(let ht=0;ht<ac;ht++)for(let lt=0;lt<ac;lt++){const _t=i.aZ((M.x+(lt+Vn(lt))/La)/V),Mt=i.a_((M.y+(ht+Vn(ht))/La)/V),vt=L.project(_t,Mt),Ut=ht*ac+lt;Js[2*Ut+0]=Math.round((vt.x*N.scale-N.x)*i.al),Js[2*Ut+1]=Math.round((vt.y*N.scale-N.y)*i.al)}un.fill(0),oa.fill(0);for(let ht=2045;ht>=0;ht--){const lt=4*ht,_t=fs[lt+0],Mt=fs[lt+1],vt=fs[lt+2],Ut=fs[lt+3],Ct=_t+vt>>1,$t=Mt+Ut>>1,Ot=Ct+$t-Mt,Rt=$t+_t-Ct,Zt=Mt*ac+_t,pe=Ut*ac+vt,le=$t*ac+Ct,Me=Math.hypot((Js[2*Zt+0]+Js[2*pe+0])/2-Js[2*le+0],(Js[2*Zt+1]+Js[2*pe+1])/2-Js[2*le+1])>=16;un[le]=un[le]||(Me?1:0),ht<1022&&(un[le]=un[le]||un[(Mt+Rt>>1)*ac+(_t+Ot>>1)]||un[(Ut+Rt>>1)*ac+(vt+Ot>>1)])}const Z=new i.a$,U=new i.b0;let X=0;function K(ht,lt){const _t=lt*ac+ht;return oa[_t]===0&&(Z.emplaceBack(Js[2*_t+0],Js[2*_t+1],ht*i.al/La,lt*i.al/La),oa[_t]=++X),oa[_t]-1}function rt(ht,lt,_t,Mt,vt,Ut){const Ct=ht+_t>>1,$t=lt+Mt>>1;if(Math.abs(ht-vt)+Math.abs(lt-Ut)>1&&un[$t*ac+Ct])rt(vt,Ut,ht,lt,Ct,$t),rt(_t,Mt,vt,Ut,Ct,$t);else{const Ot=K(ht,lt),Rt=K(_t,Mt),Zt=K(vt,Ut);U.emplaceBack(Ot,Rt,Zt)}}return rt(0,0,La,La,La,0),rt(La,La,0,0,0,La),{vertices:Z,indices:U}}(this.tileID.canonical,a);y=I.vertices,w=I.indices}else{y=new i.a$,w=new i.b0;for(const{x:M,y:L}of f)y.emplaceBack(M,L,0,0);const I=i.bg(y.int16.subarray(0,4*y.length),void 0,4);for(let M=0;M<I.length;M+=3)w.emplaceBack(I[M],I[M+1],I[M+2])}this._tileBoundsBuffer=e.createVertexBuffer(y,i.bh.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(w),this._tileBoundsSegments=i.bf.simpleSegment(0,0,y.length,w.length)}_makeGlobeTileDebugBuffers(e,a){const f=a.projection;if(!f||f.name!=="globe"||a.freezeTileCoverage)return;const y=this.tileID.canonical,w=i.bi(y,a),I=i.bj(w),M=i.aj(a.zoom);let L;M>0&&(L=i.bk(new Float64Array(16),a.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(e,y,a,I,L,M),this._makeGlobeTileDebugTextBuffer(e,y,a,I,L,M)}_globePoint(e,a,f,y,w,I,M){let L=i.bl(e,a,f);if(I){const N=1<<f.z,V=i.aF(y.center.lng),Z=i.aJ(y.center.lat),U=(f.x+.5)/N-V;let X=0;U>.5?X=-1:U<-.5&&(X=1);let K=(e/i.al+f.x)/N+X,rt=(a/i.al+f.y)/N;K=(K-V)*y._pixelsPerMercatorPixel+V,rt=(rt-Z)*y._pixelsPerMercatorPixel+Z;const ht=[K*y.worldSize,rt*y.worldSize,0];i.af(ht,ht,I),L=i.bm(L,ht,M)}return i.af(L,L,w)}_makeGlobeTileDebugBorderBuffer(e,a,f,y,w,I){const M=new i.bc,L=new i.bd,N=new i.bn,V=(U,X,K,rt,ht)=>{const lt=(K-U)/(ht-1),_t=(rt-X)/(ht-1),Mt=M.length;for(let vt=0;vt<ht;vt++){const Ut=U+vt*lt,Ct=X+vt*_t;M.emplaceBack(Ut,Ct);const $t=this._globePoint(Ut,Ct,a,f,y,w,I);N.emplaceBack($t[0],$t[1],$t[2]),L.emplaceBack(Mt+vt)}},Z=i.al;V(0,0,Z,0,16),V(Z,0,Z,Z,16),V(Z,Z,0,Z,16),V(0,Z,0,0,16),this._tileDebugIndexBuffer=e.createIndexBuffer(L),this._tileDebugBuffer=e.createVertexBuffer(M,i.be.members),this._globeTileDebugBorderBuffer=e.createVertexBuffer(N,i.bo.members),this._tileDebugSegments=i.bf.simpleSegment(0,0,M.length,L.length)}_makeGlobeTileDebugTextBuffer(e,a,f,y,w,I){const M=i.al/4,L=new i.bc,N=new i.b0,V=new i.bn,Z=25;N.reserve(32),L.reserve(Z),V.reserve(Z);const U=(X,K)=>Z*X+K;for(let X=0;X<Z;X++){const K=X*M;for(let rt=0;rt<Z;rt++){const ht=rt*M;L.emplaceBack(ht,K);const lt=this._globePoint(ht,K,a,f,y,w,I);V.emplaceBack(lt[0],lt[1],lt[2])}}for(let X=0;X<4;X++)for(let K=0;K<4;K++){const rt=U(X,K),ht=U(X,K+1),lt=U(X+1,K),_t=U(X+1,K+1);N.emplaceBack(rt,ht,lt),N.emplaceBack(lt,ht,_t)}this._tileDebugTextIndexBuffer=e.createIndexBuffer(N),this._tileDebugTextBuffer=e.createVertexBuffer(L,i.be.members),this._globeTileDebugTextBuffer=e.createVertexBuffer(V,i.bo.members),this._tileDebugTextSegments=i.bf.simpleSegment(0,0,Z,32)}destroy(e=!1){for(const a in this.buckets)this.buckets[a].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!e&&this.texture&&this.texture instanceof i.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}i.br.setPbf(i.bs);class ms extends Uo{constructor(e,a,f,y,w){super(e,a,f,y,w),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(e){return this._mrt&&this._mrt.getLayer(e)}setTexturePerLayer(e,a,f){const y=f.context,w=y.gl;let I=this.texturePerLayer.get(e)||f.getTileTexture(a.width);I&&I instanceof i.T?I.update(a,{premultiply:!1}):I=new i.T(y,a,w.RGBA8,{premultiply:!1}),this.texturePerLayer.has(e)||this.texturePerLayer.set(e,I)}flushQueues(e){const a=this._workQueuePerLayer.get(e)||[],f=this._fetchQueuePerLayer.get(e)||[];for(;a.length;)a.pop()();for(;f.length;)f.pop()()}flushAllQueues(){for(const e of this._workQueuePerLayer.keys()){const a=this._workQueuePerLayer.get(e)||[];for(;a.length;)a.pop()()}for(const e of this._fetchQueuePerLayer.keys()){const a=this._fetchQueuePerLayer.get(e)||[];for(;a.length;)a.pop()()}}fetchHeader(e=16384,a){const f=this._mrt=new i.br(30),y=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(e-1)}});return this.entireBuffer=null,this.request=i.bt(y,(w,I,M)=>{if(w)a(w);else try{const L=f.getHeaderLength(I);if(L>e)return void(this.request=this.fetchHeader(L,a));f.parseHeader(I),this._isHeaderLoaded=!0;let N=0;for(const V of Object.values(f.layers))N=Math.max(N,V.dataIndex[V.dataIndex.length-1].lastByte);I.byteLength>=N&&(this.entireBuffer=I),a(null,this.entireBuffer||I,M)}catch(L){a(L)}}),this.request}fetchBandForRender(e,a,f,y){this.fetchBand(e,a,f,w=>{if(w)return void y(w);this.updateTextureDescriptor(e,a,f);const I=this.textureDescriptorPerLayer.get(a);y(null,I?I.img:null)})}fetchBand(e,a,f,y,w=!0){const I=this._mrt;if(!this._isHeaderLoaded||!I)return void y(new Error("Tile header is not ready"));const M=this.actor;if(!M)return void y(new Error("Can't fetch tile band without an actor"));let L;const N=i.B(String(f),i.B(this.tileID.key,e));let V=this._taskQueue.get(N);V?V.add(y):(V=new Set,V.add(y),this._taskQueue.set(N,V));const Z=(rt,ht)=>{L.complete(rt,ht),rt?y(rt):(V.values().forEach(lt=>lt(null,ht)),this._taskQueue.delete(N))},U=(rt,ht)=>{if(rt)return y(rt);const lt=M.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:ht,task:L},Z,void 0,!0);if(a!==null){const _t=this._workQueuePerLayer.get(a)||[];_t.push(()=>{lt&&lt.cancel(),L.cancel()}),this._workQueuePerLayer.has(a)||this._workQueuePerLayer.set(a,_t)}};let X;try{X=I.getLayer(e)}catch(rt){if(this.state==="reloading")return;throw rt}if(!X)return void y(new Error(`Unknown sourceLayer "${e}"`));if(X.hasDataForBand(f))return V.values().forEach(rt=>rt(null,null)),void this._taskQueue.delete(N);const K=X.getDataRange([f]);if(L=I.createDecodingTask(K),!L||L.tasks.length)if(a!==null&&this.flushQueues(a),this.entireBuffer)U(null,this.entireBuffer.slice(K.firstByte,K.lastByte+1));else{const rt=Object.assign({},this.requestParams,{headers:{Range:`bytes=${K.firstByte}-${K.lastByte}`}}),ht=i.bt(rt,U);if(a!==null){const lt=this._fetchQueuePerLayer.get(a)||[];lt.push(()=>{ht.cancel(),L.cancel()}),this._fetchQueuePerLayer.has(a)||this._fetchQueuePerLayer.set(a,lt)}}}updateNeeded(e,a){return(!this.textureDescriptorPerLayer.get(e)||this.textureDescriptorPerLayer.get(e).band!==a||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(e,a,f){if(!this._mrt)return;const y=this._mrt.getLayer(e);if(!y||!y.hasBand(f)||!y.hasDataForBand(f))return;const{bytes:w,tileSize:I,buffer:M,offset:L,scale:N}=y.getBandView(f),V=I+2*M,Z=new i.q({width:V,height:V},w),U=this.texturePerLayer.get(a);U&&U instanceof i.T&&U.update(Z,{premultiply:!1}),this.textureDescriptorPerLayer.set(a,{layer:e,band:f,img:Z,buffer:M,offset:L,tileSize:I,format:y.pixelFormat,mix:[N,256*N,65536*N,16777216*N]})}destroy(e=!1){if(super.destroy(e),delete this._mrt,!e)for(const a of this.texturePerLayer.values())a&&a instanceof i.T&&a.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class sa{constructor(e,a){this.max=e,this.onRemove=a,this.reset()}reset(){for(const e in this.data)for(const a of this.data[e])a.timeout&&clearTimeout(a.timeout),this.onRemove(a.value);return this.data={},this.order=[],this}add(e,a,f){const y=e.wrapped().key;this.data[y]===void 0&&(this.data[y]=[]);const w={value:a,timeout:void 0};if(f!==void 0&&(w.timeout=setTimeout(()=>{this.remove(e,w)},f)),this.data[y].push(w),this.order.push(y),this.order.length>this.max){const I=this._getAndRemoveByKey(this.order[0]);I&&this.onRemove(I)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const a=this.data[e].shift();return a.timeout&&clearTimeout(a.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),a.value}getByKey(e){const a=this.data[e];return a?a[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,a){if(!this.has(e))return this;const f=e.wrapped().key,y=a===void 0?0:this.data[f].indexOf(a),w=this.data[f][y];return this.data[f].splice(y,1),w.timeout&&clearTimeout(w.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(w.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}filter(e){const a=[];for(const f in this.data)for(const y of this.data[f])e(y.value)||a.push(y);for(const f of a)this.remove(f.value.tileID,f)}}class Us{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,a,f){const y=String(a);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][y]=this.stateChanges[e][y]||{},Object.assign(this.stateChanges[e][y],f),this.deletedStates[e]===null){this.deletedStates[e]={};for(const w in this.state[e])w!==y&&(this.deletedStates[e][w]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][y]===null){this.deletedStates[e][y]={};for(const w in this.state[e][y])f[w]||(this.deletedStates[e][y][w]=null)}else for(const w in f)this.deletedStates[e]&&this.deletedStates[e][y]&&this.deletedStates[e][y][w]===null&&delete this.deletedStates[e][y][w]}removeFeatureState(e,a,f){if(this.deletedStates[e]===null)return;const y=String(a);if(this.deletedStates[e]=this.deletedStates[e]||{},f&&a!==void 0)this.deletedStates[e][y]!==null&&(this.deletedStates[e][y]=this.deletedStates[e][y]||{},this.deletedStates[e][y][f]=null);else if(a!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][y])for(f in this.deletedStates[e][y]={},this.stateChanges[e][y])this.deletedStates[e][y][f]=null;else this.deletedStates[e][y]=null;else this.deletedStates[e]=null}getState(e,a){const f=this.state[e]||{},y=this.stateChanges[e]||{},w=this.deletedStates[e];if(w===null)return{};if(a!==void 0){const M=String(a),L=Object.assign({},f[M],y[M]);if(w){const N=w[a];if(N===null)return{};for(const V in N)delete L[V]}return L}const I=Object.assign({},f,y);if(w)for(const M in w)delete I[M];return I}initializeTileState(e,a){e.refreshFeatureState(a)}coalesceChanges(e,a){const f={};for(const y in this.stateChanges){this.state[y]=this.state[y]||{};const w={};for(const I in this.stateChanges[y])this.state[y][I]||(this.state[y][I]={}),Object.assign(this.state[y][I],this.stateChanges[y][I]),w[I]=this.state[y][I];f[y]=w}for(const y in this.deletedStates){this.state[y]=this.state[y]||{};const w={};if(this.deletedStates[y]===null)for(const I in this.state[y])w[I]={},this.state[y][I]={};else for(const I in this.deletedStates[y]){if(this.deletedStates[y][I]===null)this.state[y][I]={};else if(this.state[y][I])for(const M of Object.keys(this.deletedStates[y][I]))delete this.state[y][I][M];w[I]=this.state[y][I]}f[y]=f[y]||{},Object.assign(f[y],w)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(const y in e)e[y].refreshFeatureState(a)}}class Xn extends i.E{constructor(e,a,f){super(),this.id=e,this._onlySymbols=f,a.on("data",y=>{y.dataType==="source"&&y.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&y.dataType==="source"&&y.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),a.on("error",()=>{this._sourceErrored=!0}),this._source=a,this._tiles={},this._cache=new sa(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=a.minTileCacheSize,this._maxTileCacheSize=a.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Us,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(e){this.map=e,this._minTileCacheSize=this._minTileCacheSize===void 0&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const e in this._tiles)if(!this._tiles[e].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,a){return e.isSymbolTile=this._onlySymbols,e.isExtraShadowCaster=this._shadowCasterTiles[e.tileID.key],this._source.loadTile(e,a)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e)}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e)}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const a in this._tiles){const f=this._tiles[a];f.upload(e,this.map?this.map.painter:void 0),f.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(e=>e.tileID).sort(Vu).map(e=>e.key)}getRenderableIds(e,a){const f=[];for(const y in this._tiles)this._isIdRenderable(+y,e,a)&&f.push(this._tiles[y]);return e?f.sort((y,w)=>{const I=y.tileID,M=w.tileID,L=new i.P(I.canonical.x,I.canonical.y)._rotate(this.transform.angle),N=new i.P(M.canonical.x,M.canonical.y)._rotate(this.transform.angle);return I.overscaledZ-M.overscaledZ||N.y-L.y||N.x-L.x}).map(y=>y.tileID.key):f.map(y=>y.tileID).sort(Vu).map(y=>y.key)}hasRenderableParent(e){const a=this.findLoadedParent(e,0);return!!a&&this._isIdRenderable(a.tileID.key)}_isIdRenderable(e,a,f){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(a||!this._tiles[e].holdingForFade())&&(f||!this._shadowCasterTiles[e])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(+e,"reloading")}}_reloadTile(e,a){const f=this._tiles[e];f&&(f.state!=="loading"&&(f.state=a),this._loadTile(f,this._tileLoaded.bind(this,f,e,a)))}_tileLoaded(e,a,f,y,w){if(y){if(e.state="errored",y.status!==404)this._source.fire(new i.y(y,{tile:e}));else{if(this._source.fire(new i.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:e})),!(e.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const M=this.map.painter.terrain;this.update(this.transform,M.getScaledDemTileSize(),!0),M.resetTileLookupCache(this.id)}else this.update(this.transform)}return}e.timeAdded=i.o.now(),f==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(a,e),this._source.type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null);let I=new Map;w&&w.responseHeaders&&(I=w.responseHeaders),this._source.fire(new i.z("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id,responseHeaders:I}))}_backfillDEM(e){const a=this.getRenderableIds();for(let y=0;y<a.length;y++){const w=a[y];if(e.neighboringTiles&&e.neighboringTiles[w]){const I=this.getTileByID(w);f(e,I),f(I,e)}}function f(y,w){if(!y.dem||y.dem.borderReady)return;y.needsHillshadePrepare=!0,y.needsDEMTextureUpload=!0;let I=w.tileID.canonical.x-y.tileID.canonical.x;const M=w.tileID.canonical.y-y.tileID.canonical.y,L=Math.pow(2,y.tileID.canonical.z),N=w.tileID.key;I===0&&M===0||Math.abs(M)>1||(Math.abs(I)>1&&(Math.abs(I+L)===1?I+=L:Math.abs(I-L)===1&&(I-=L)),w.dem&&y.dem&&(y.dem.backfillBorder(w.dem,I,M),y.neighboringTiles&&y.neighboringTiles[N]&&(y.neighboringTiles[N].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,a,f,y){for(const w in this._tiles){let I=this._tiles[w];if(y[w]||!I.hasData()||I.tileID.overscaledZ<=a||I.tileID.overscaledZ>f)continue;let M=I.tileID;for(;I&&I.tileID.overscaledZ>a+1;){const N=I.tileID.scaledTo(I.tileID.overscaledZ-1);I=this._tiles[N.key],I&&I.hasData()&&(M=N)}let L=M;for(;L.overscaledZ>a;)if(L=L.scaledTo(L.overscaledZ-1),e[L.key]){y[M.key]=M;break}}}findLoadedParent(e,a){if(e.key in this._loadedParentTiles){const f=this._loadedParentTiles[e.key];return f&&f.tileID.overscaledZ>=a?f:null}for(let f=e.overscaledZ-1;f>=a;f--){const y=e.scaledTo(f),w=this._getLoadedTile(y);if(w)return w}}_getLoadedTile(e){const a=this._tiles[e.key];return a&&a.hasData()?a:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,a){a=a||this._source.tileSize;const f=Math.ceil(e.width/a)+1,y=Math.ceil(e.height/a)+1,w=Math.floor(f*y*5),I=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,w):w,M=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,I):I;this._cache.setMaxSize(M)}handleWrapJump(e){const a=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,a){const f={};for(const y in this._tiles){const w=this._tiles[y];w.tileID=w.tileID.unwrapTo(w.tileID.wrap+a),f[w.tileID.key]=w}this._tiles=f;for(const y in this._timers)clearTimeout(this._timers[y]),delete this._timers[y];for(const y in this._tiles)this._setTileReloadTimer(+y,this._tiles[y])}}update(e,a,f,y,w){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!f)return;this.updateCacheSize(e,a),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const I=this._source.type==="batched-model";let M,L=this._source.maxzoom;const N=this.map&&this.map.painter?this.map.painter._terrain:null;if(N&&N.sourceCache===this&&N.attenuationRange()){const U=N.attenuationRange()[0],X=Math.floor(U)-Math.log2(N.getDemUpscale());L>X&&(L=X)}if(this.used||this.usedForTerrain){if(this._source.tileID)M=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(U=>new i.aP(U.canonical.z,U.wrap,U.canonical.z,U.canonical.x,U.canonical.y));else if(this.tileCoverLift!==0){const U=e.clone();U.tileCoverLift=this.tileCoverLift,M=U.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:L,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:I}),this._source.minzoom<=1&&e.projection.name==="globe"&&(M.push(new i.aP(1,0,1,0,0)),M.push(new i.aP(1,0,1,1,0)),M.push(new i.aP(1,0,1,0,1)),M.push(new i.aP(1,0,1,1,1)))}else if(M=e.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:L,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:I}),this._source.hasTile){const U=this._source.hasTile.bind(this._source);M=M.filter(X=>U(X))}}else M=[];if(M.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Ds(this._source.type)){const U=e.coveringZoomLevel({tileSize:a||this._source.tileSize,roundZoom:this._source.roundZoom&&!f}),X=Math.min(U,this._source.maxzoom);if(I){const K=e.extendTileCover(M,X);for(const rt of K)M.push(rt)}else if(w){const K=e.extendTileCoverToNearPlane(M,this.transform.getFrustum(X),X);for(const rt of K)M.push(rt)}else if(this.castsShadows&&y){const K=e.extendTileCover(M,X,y);for(const rt of K)this._shadowCasterTiles[rt.key]=!0,M.push(rt)}}const V=this._updateRetainedTiles(M);if(Ds(this._source.type)&&M.length!==0){const U={},X={},K=Object.keys(V);for(const ht of K){const lt=V[ht],_t=this._tiles[ht];if(!_t||_t.fadeEndTime&&_t.fadeEndTime<=i.o.now())continue;const Mt=this.findLoadedParent(lt,Math.max(lt.overscaledZ-Xn.maxOverzooming,this._source.minzoom));Mt&&(this._addTile(Mt.tileID),U[Mt.tileID.key]=Mt.tileID),X[ht]=lt}const rt=M[M.length-1].overscaledZ;for(const ht in this._tiles){const lt=this._tiles[ht];if(V[ht]||!lt.hasData())continue;let _t=lt.tileID;for(;_t.overscaledZ>rt;){_t=_t.scaledTo(_t.overscaledZ-1);const Mt=this._tiles[_t.key];if(Mt&&Mt.hasData()&&X[_t.key]){V[ht]=lt.tileID;break}}}for(const ht in U)V[ht]||(this._coveredTiles[ht]=!0,V[ht]=U[ht])}for(const U in V)this._tiles[U].clearFadeHold();const Z=i.bu(this._tiles,V);for(const U of Z){const X=this._tiles[U];X.hasSymbolBuckets&&!X.holdingForFade()?X.setHoldDuration(this.map._fadeDuration):X.hasSymbolBuckets&&!X.symbolFadeFinished()||this._removeTile(+U)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const a={};if(e.length===0)return a;const f={},y=e.reduce((N,V)=>Math.min(N,V.overscaledZ),1/0),w=e[0].overscaledZ,I=Math.max(w-Xn.maxOverzooming,this._source.minzoom),M=Math.max(w+Xn.maxUnderzooming,this._source.minzoom),L={};for(const N of e){const V=this._addTile(N);a[N.key]=N,V.hasData()||y<this._source.maxzoom&&(L[N.key]=N)}this._retainLoadedChildren(L,y,M,a);for(const N of e){let V=this._tiles[N.key];if(V.hasData())continue;if(N.canonical.z>=this._source.maxzoom){const U=N.children(this._source.maxzoom)[0],X=this.getTile(U);if(X&&X.hasData()){a[U.key]=U;continue}}else{const U=N.children(this._source.maxzoom);if(a[U[0].key]&&a[U[1].key]&&a[U[2].key]&&a[U[3].key])continue}let Z=V.wasRequested();for(let U=N.overscaledZ-1;U>=I;--U){const X=N.scaledTo(U);if(f[X.key]||(f[X.key]=!0,V=this.getTile(X),!V&&Z&&(V=this._addTile(X)),V&&(a[X.key]=X,Z=V.wasRequested(),V.hasData())))break}}return a}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const a=[];let f,y=this._tiles[e].tileID;for(;y.overscaledZ>0;){if(y.key in this._loadedParentTiles){f=this._loadedParentTiles[y.key];break}a.push(y.key);const w=y.scaledTo(y.overscaledZ-1);if(f=this._getLoadedTile(w),f)break;y=w}for(const w of a)this._loadedParentTiles[w]=f}}_addTile(e){let a=this._tiles[e.key];if(a)return a.isExtraShadowCaster!==!0||this._shadowCasterTiles[e.key]||this._reloadTile(e.key,"reloading"),a;a=this._cache.getAndRemove(e),a&&(this._setTileReloadTimer(e.key,a),a.tileID=e,this._state.initializeTileState(a,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,a)));const f=!!a;if(!f){const y=this.map?this.map.painter:null,w=this._source.tileSize*e.overscaleFactor();a=this._source.type==="raster-array"?new ms(e,w,this.transform.tileZoom,y,this._isRaster):new Uo(e,w,this.transform.tileZoom,y,this._isRaster,this._source.worldview),this._loadTile(a,this._tileLoaded.bind(this,a,e.key,a.state))}return a.uses++,this._tiles[e.key]=a,f||this._source.fire(new i.z("dataloading",{tile:a,coord:a.tileID,dataType:"source"})),a}_setTileReloadTimer(e,a){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const f=a.getExpiryTimeout();f&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},f))}_removeTile(e){const a=this._tiles[e];a&&(a.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),a.uses>0||(a.hasData()&&a.state!=="reloading"||a.state==="empty"?this._cache.add(a.tileID,a,a.getExpiryTimeout()):(a.aborted=!0,this._abortTile(a),this._unloadTile(a))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(e,a,f){const y=[],w=this.transform;if(!w)return y;const I=w.projection.name==="globe",M=i.aF(w.center.lng);for(const L in this._tiles){const N=this._tiles[L];if(f&&N.clearQueryDebugViz(),N.holdingForFade())continue;let V;if(I){const Z=N.tileID.canonical;if(Z.z===0){const U=[Math.abs(i.aA(M,...js(Z,-1))-M),Math.abs(i.aA(M,...js(Z,1))-M)];V=[0,2*U.indexOf(Math.min(...U))-1]}else{const U=[Math.abs(i.aA(M,...js(Z,-1))-M),Math.abs(i.aA(M,...js(Z,0))-M),Math.abs(i.aA(M,...js(Z,1))-M)];V=[U.indexOf(Math.min(...U))-1]}}else V=[0];for(const Z of V){const U=e.containsTile(N,w,a,Z);U&&y.push(U)}}return y}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(e){return this._getRenderableCoordinates(e)}_getRenderableCoordinates(e,a){const f=this.getRenderableIds(e,a).map(w=>this._tiles[w].tileID),y=this.transform.projection.name==="globe";for(const w of f)w.projMatrix=this.transform.calculateProjMatrix(w.toUnwrapped()),w.expandedProjMatrix=y?this.transform.calculateProjMatrix(w.toUnwrapped(),!1,!0):w.projMatrix;return f}sortCoordinatesByDistance(e){const a=e.slice(),f=this.transform._camera.position,y=this.transform._camera.forward(),w={};for(const I of a){const M=1/(1<<I.canonical.z);w[I.key]=((I.canonical.x+.5)*M+I.wrap-f[0])*y[0]+((I.canonical.y+.5)*M-f[1])*y[1]-f[2]*y[2]}return a.sort((I,M)=>w[I.key]-w[M.key]),a}hasTransition(){if(this._source.hasTransition())return!0;if(Ds(this._source.type))for(const e in this._tiles){const a=this._tiles[e];if(a.fadeEndTime!==void 0&&a.fadeEndTime>=i.o.now())return!0}return!1}setFeatureState(e,a,f){this._state.updateState(e=e||"_geojsonTileLayer",a,f)}removeFeatureState(e,a,f){this._state.removeFeatureState(e=e||"_geojsonTileLayer",a,f)}getFeatureState(e,a){return this._state.getState(e=e||"_geojsonTileLayer",a)}setDependencies(e,a,f){const y=this._tiles[e];y&&y.setDependencies(a,f)}reloadTilesForDependencies(e,a){for(const f in this._tiles)this._tiles[f].hasDependency(e,a)&&this._reloadTile(+f,"reloading");this._cache.filter(f=>!f.hasDependency(e,a))}_preloadTiles(e,a){if(!this._sourceLoaded){const L=()=>{this._sourceLoaded&&(this._source.off("data",L),this._preloadTiles(e,a))};return void this._source.on("data",L)}const f=new Map,y=Array.isArray(e)?e:[e],w=this.map.painter.terrain,I=this.usedForTerrain&&w?w.getScaledDemTileSize():this._source.tileSize;for(const L of y){const N=L.coveringTiles({tileSize:I,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const V of N)f.set(V.key,V);this.usedForTerrain&&L.updateElevation(!1)}const M=Array.from(f.values());i.bv(M,(L,N)=>{const V=new Uo(L,this._source.tileSize*L.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(V,Z=>{this._source.type==="raster-dem"&&V.dem&&this._backfillDEM(V),N(Z,V)})},a)}}function Vu(p,e){const a=Math.abs(2*p.wrap)-+(p.wrap<0),f=Math.abs(2*e.wrap)-+(e.wrap<0);return p.overscaledZ-e.overscaledZ||f-a||e.canonical.y-p.canonical.y||e.canonical.x-p.canonical.x}function Ds(p){return p==="raster"||p==="image"||p==="video"||p==="custom"}function js(p,e){const a=1<<p.z;return[p.x/a+e,(p.x+1)/a+e]}Xn.maxOverzooming=10,Xn.maxUnderzooming=3;class aa{constructor(e){this.style=e,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const e=!1,a=!1;for(const f in this.style._mergedLayers){const y=this.style._mergedLayers[f];if(y.type==="fill-extrusion"||y.type==="building")this.layers.push({layer:y,visible:e,visibilityChanged:a});else if(y.type==="model"){const w=this.style.getLayerSource(y);w&&w.type==="batched-model"&&this.layers.push({layer:y,visible:e,visibilityChanged:a})}}}onNewFrame(e){this.layersGotHidden=!1;for(const a of this.layers){const f=a.layer;let y=!1;f.type==="fill-extrusion"?y=!f.isHidden(e)&&f.paint.get("fill-extrusion-opacity")>0:f.type==="building"?y=!f.isHidden(e)&&f.paint.get("building-opacity")>0:f.type==="model"&&(y=!f.isHidden(e)&&f.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!y&&a.visible,a.visible=y}}updateZOffset(e,a){this.currentBuildingBuckets=[];for(const y of this.layers){const w=y.layer,I=this.style.getLayerSourceCache(w);let M=1;w.type==="fill-extrusion"?M=y.visible?w.paint.get("fill-extrusion-vertical-scale"):0:w.type==="building"&&(M=y.visible?w.paint.get("building-vertical-scale"):0);let L=I?I.getTile(a):null;if(!L&&I)for(const N in I._tiles){const V=I._tiles[N];if(a.canonical.isChildOf(V.tileID.canonical)){L=V;break}}this.currentBuildingBuckets.push({bucket:L?L.getBucket(w):null,tileID:L?L.tileID:a,verticalScale:M})}e.hasAnyZOffset=!1;let f=!1;for(let y=0;y<e.symbolInstances.length;y++){const w=e.symbolInstances.get(y),I=w.zOffset,M=this._getHeightAtTileOffset(a,w.tileAnchorX,w.tileAnchorY);w.zOffset=M!==Number.NEGATIVE_INFINITY?M:I,f||I===w.zOffset||(f=!0),e.hasAnyZOffset||w.zOffset===0||(e.hasAnyZOffset=!0)}f&&(e.zOffsetBuffersNeedUpload=!0,e.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(e,a,f,y){let w=a,I=f;if(e.canonical.z!==y.canonical.z){const M=y.canonical,L=1/(1<<e.canonical.z-M.z);w=(a+e.canonical.x*i.al)*L-M.x*i.al|0,I=(f+e.canonical.y*i.al)*L-M.y*i.al|0}return{tileX:w,tileY:I}}_getHeightAtTileOffset(e,a,f){let y,w;for(let I=0;I<this.layers.length;++I){const M=this.layers[I].layer;if(M.type!=="fill-extrusion"&&M.type!=="building")continue;const{bucket:L,tileID:N,verticalScale:V}=this.currentBuildingBuckets[I];if(!L)continue;const{tileX:Z,tileY:U}=this._mapCoordToOverlappingTile(e,a,f,N),X=L.getHeightAtTileCoord(Z,U);X&&X.height!==void 0&&(X.hidden?y=X.height:w=Math.max(X.height*V,w||0))}if(w!==void 0)return w;for(let I=0;I<this.layers.length;++I){const M=this.layers[I];if(M.layer.type!=="model"||!M.visible)continue;const{bucket:L,tileID:N}=this.currentBuildingBuckets[I];if(!L)continue;const{tileX:V,tileY:Z}=this._mapCoordToOverlappingTile(e,a,f,N),U=L.getHeightAtTileCoord(V,Z);if(U&&!U.hidden)return U.height===void 0&&y!==void 0?Math.min(U.maxHeight,y)*U.verticalScale:U.height?U.height*U.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Uu(p,e){const a={};for(const f in p)f!=="ref"&&(a[f]=p[f]);return i.bw.forEach(f=>{f in e&&(a[f]=e[f])}),a}function Ll(p){p=p.slice();const e=Object.create(null);for(let a=0;a<p.length;a++)e[p[a].id]=p[a];for(let a=0;a<p.length;a++)"ref"in p[a]&&(p[a]=Uu(p[a],e[p[a].ref]));return p}const vr={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Ah(p,e,a){a.push({command:vr.addSource,args:[p,e[p]]})}function Wl(p,e,a){e.push({command:vr.removeSource,args:[p]}),a[p]=!0}function Yc(p,e,a,f){Wl(p,a,f),Ah(p,e,a)}function Ra(p,e,a){let f;for(f in p[a])if(p[a].hasOwnProperty(f)&&f!=="data"&&!i.bx(p[a][f],e[a][f]))return!1;for(f in e[a])if(e[a].hasOwnProperty(f)&&f!=="data"&&!i.bx(p[a][f],e[a][f]))return!1;return!0}function ko(p,e,a,f,y,w){let I;for(I in e=e||{},p=p||{})p.hasOwnProperty(I)&&(i.bx(p[I],e[I])||a.push({command:w,args:[f,I,e[I],y]}));for(I in e)e.hasOwnProperty(I)&&!p.hasOwnProperty(I)&&(i.bx(p[I],e[I])||a.push({command:w,args:[f,I,e[I],y]}))}function pl(p){return p.id}function qn(p,e){return p[e.id]=e,p}function rn(p,e,a){const f=e.createTileMatrix(p,p.worldSize,a.toUnwrapped());return i.aB(new Float32Array(16),p.projMatrix,f)}function lu(p,e,a){if(e.projection.name===a.projection.name)return p.projMatrix;const f=a.clone();return f.setProjection(e.projection),rn(f,e.getProjection(),p)}function Un(p,e,a){return e.name===a.projection.name?p.projMatrix:rn(a,e,p)}class ju{constructor(e,a){this.reset(e,a)}reset(e,a){this.points=e||[],this._distances=[0];for(let f=1;f<this.points.length;f++)this._distances[f]=this._distances[f-1]+this.points[f].dist(this.points[f-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(a||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(this.points.length===1)return this.points[0];e=i.aA(e,0,1);let a=1,f=this._distances[a];const y=e*this.paddedLength+this.padding;for(;f<y&&a<this._distances.length;)f=this._distances[++a];const w=a-1,I=this._distances[w],M=f-I,L=M>0?(y-I)/M:0;return this.points[w].mult(1-L).add(this.points[a].mult(L))}}class tl{constructor(e,a,f){const y=this.boxCells=[],w=this.circleCells=[];this.xCellCount=Math.ceil(e/f),this.yCellCount=Math.ceil(a/f);for(let I=0;I<this.xCellCount*this.yCellCount;I++)y.push([]),w.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=a,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/a,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,a,f,y,w){this._forEachCell(a,f,y,w,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(a),this.bboxes.push(f),this.bboxes.push(y),this.bboxes.push(w)}insertCircle(e,a,f,y){this._forEachCell(a-y,f-y,a+y,f+y,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(a),this.circles.push(f),this.circles.push(y)}_insertBoxCell(e,a,f,y,w,I){this.boxCells[w].push(I)}_insertCircleCell(e,a,f,y,w,I){this.circleCells[w].push(I)}_query(e,a,f,y,w,I){if(f<0||e>this.width||y<0||a>this.height)return!w&&[];const M=[];if(e<=0&&a<=0&&this.width<=f&&this.height<=y){if(w)return!0;for(let L=0;L<this.boxKeys.length;L++)M.push({key:this.boxKeys[L],x1:this.bboxes[4*L],y1:this.bboxes[4*L+1],x2:this.bboxes[4*L+2],y2:this.bboxes[4*L+3]});for(let L=0;L<this.circleKeys.length;L++){const N=this.circles[3*L],V=this.circles[3*L+1],Z=this.circles[3*L+2];M.push({key:this.circleKeys[L],x1:N-Z,y1:V-Z,x2:N+Z,y2:V+Z})}return I?M.filter(I):M}return this._forEachCell(e,a,f,y,this._queryCell,M,{hitTest:w,seenUids:{box:{},circle:{}}},I),w?M.length>0:M}_queryCircle(e,a,f,y,w){const I=e-f,M=e+f,L=a-f,N=a+f;if(M<0||I>this.width||N<0||L>this.height)return!y&&[];const V=[];return this._forEachCell(I,L,M,N,this._queryCellCircle,V,{hitTest:y,circle:{x:e,y:a,radius:f},seenUids:{box:{},circle:{}}},w),y?V.length>0:V}query(e,a,f,y,w){return this._query(e,a,f,y,!1,w)}hitTest(e,a,f,y,w){return this._query(e,a,f,y,!0,w)}hitTestCircle(e,a,f,y){return this._queryCircle(e,a,f,!0,y)}_queryCell(e,a,f,y,w,I,M,L){const N=M.seenUids,V=this.boxCells[w];if(V!==null){const U=this.bboxes;for(const X of V)if(!N.box[X]){N.box[X]=!0;const K=4*X;if(e<=U[K+2]&&a<=U[K+3]&&f>=U[K+0]&&y>=U[K+1]&&(!L||L(this.boxKeys[X]))){if(M.hitTest)return I.push(!0),!0;I.push({key:this.boxKeys[X],x1:U[K],y1:U[K+1],x2:U[K+2],y2:U[K+3]})}}}const Z=this.circleCells[w];if(Z!==null){const U=this.circles;for(const X of Z)if(!N.circle[X]){N.circle[X]=!0;const K=3*X;if(this._circleAndRectCollide(U[K],U[K+1],U[K+2],e,a,f,y)&&(!L||L(this.circleKeys[X]))){if(M.hitTest)return I.push(!0),!0;{const rt=U[K],ht=U[K+1],lt=U[K+2];I.push({key:this.circleKeys[X],x1:rt-lt,y1:ht-lt,x2:rt+lt,y2:ht+lt})}}}}}_queryCellCircle(e,a,f,y,w,I,M,L){const N=M.circle,V=M.seenUids,Z=this.boxCells[w];if(Z!==null){const X=this.bboxes;for(const K of Z)if(!V.box[K]){V.box[K]=!0;const rt=4*K;if(this._circleAndRectCollide(N.x,N.y,N.radius,X[rt+0],X[rt+1],X[rt+2],X[rt+3])&&(!L||L(this.boxKeys[K])))return I.push(!0),!0}}const U=this.circleCells[w];if(U!==null){const X=this.circles;for(const K of U)if(!V.circle[K]){V.circle[K]=!0;const rt=3*K;if(this._circlesCollide(X[rt],X[rt+1],X[rt+2],N.x,N.y,N.radius)&&(!L||L(this.circleKeys[K])))return I.push(!0),!0}}}_forEachCell(e,a,f,y,w,I,M,L){const N=this._convertToXCellCoord(e),V=this._convertToYCellCoord(a),Z=this._convertToXCellCoord(f),U=this._convertToYCellCoord(y);for(let X=N;X<=Z;X++)for(let K=V;K<=U;K++)if(w.call(this,e,a,f,y,this.xCellCount*K+X,I,M,L))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,a,f,y,w,I){const M=y-e,L=w-a,N=f+I;return N*N>M*M+L*L}_circleAndRectCollide(e,a,f,y,w,I,M){const L=(I-y)/2,N=Math.abs(e-(y+L));if(N>L+f)return!1;const V=(M-w)/2,Z=Math.abs(a-(w+V));if(Z>V+f)return!1;if(N<=L||Z<=V)return!0;const U=N-L,X=Z-V;return U*U+X*X<=f*f}}const Sa={unknown:0,flipRequired:1,flipNotRequired:2},cc=Math.tan(85*Math.PI/180);function Jc(p,e,a,f,y,w,I){const M=i.bB();if(a)if(w.name==="globe"){const L=i.bC(y,e);i.aB(M,M,L)}else{const L=i.bD([],I);M[0]=L[0],M[1]=L[1],M[4]=L[2],M[5]=L[3],f||i.bA(M,M,y.angle)}else i.aB(M,y.labelPlaneMatrix,p);return M}function Kc(p,e,a,f,y,w,I){const M=Jc(p,e,a,f,y,w,I);return w.name==="globe"&&a||(M[2]=M[6]=M[10]=M[14]=0),M}function Rl(p,e,a,f,y,w,I){if(a){if(w.name==="globe"){const M=Jc(p,e,a,f,y,w,I);return i.bk(M,M),i.aB(M,p,M),M}{const M=i.by(p),L=i.bz([]);return L[0]=I[0],L[1]=I[1],L[4]=I[2],L[5]=I[3],i.aB(M,M,L),f||i.bA(M,M,-y.angle),M}}return y.glCoordMatrix}function es(p,e,a,f){const y=[p,e,a,1];a?i.aC(y,y,f):ml(y,y,f);const w=y[3];return y[0]/=w,y[1]/=w,y[2]/=w,y}function Ph(p,e){return Math.min(.5+p/e*.5,1.5)}function pp(p,e){const a=p[0]/p[3],f=p[1]/p[3];return a>=-e[0]&&a<=e[0]&&f>=-e[1]&&f<=e[1]}function Xl(p,e,a,f,y,w,I,M,L,N,V=1){const Z=a.transform,U=f?p.textSizeData:p.iconSizeData,X=i.bJ(U,a.transform.zoom,V),K=Z.projection.name==="globe",rt=[256/a.width*2+1,256/a.height*2+1],ht=f?p.text.dynamicLayoutVertexArray:p.icon.dynamicLayoutVertexArray;ht.clear();let lt=null;K&&(lt=f?p.text.globeExtVertexArray:p.icon.globeExtVertexArray);const _t=p.lineVertexArray,Mt=f?p.text.placedSymbolArray:p.icon.placedSymbolArray,vt=a.transform.width/a.transform.height;let Ut,Ct=!1;for(let $t=0;$t<Mt.length;$t++){const Ot=Mt.get($t),{numGlyphs:Rt,writingMode:Zt}=Ot;if(Zt!==i.bK.vertical||Ct||Ut===i.bK.horizontal||(Ct=!0),Ut=Zt,(Ot.hidden||Zt===i.bK.vertical)&&!Ct){fl(Rt,ht);continue}Ct=!1;const pe=new i.P(Ot.tileAnchorX,Ot.tileAnchorY),le=p.elevationType==="road",Me=!!Z.elevation||le;let{x:ve,y:Be,z:oi}=Z.projection.projectTilePoint(pe.x,pe.y,N.canonical),ge=null;if(Me){const Ai=le?p.getElevationFeatureForText($t):null;ge={getElevation:L,elevation:Z.elevation,elevationFeature:Ai};const[Wi,Gr,en]=L(pe,Z.elevation,Ai);ve+=Wi,Be+=Gr,oi+=en}const ie=[ve,Be,oi,1];if(i.aC(ie,ie,e),!pp(ie,rt)){fl(Rt,ht);continue}const Oe=ie[3],Te=Ph(a.transform.getCameraToCenterDistance(Z.projection),Oe),qe=i.bL(U,X,Ot),si=I?qe/Te:qe*Te,Li=es(ve,Be,oi,y);if(Li[3]<=0){fl(Rt,ht);continue}let ni={};const li=i.an(p.layers[0].layout.get("text-max-angle")),Fi=Math.cos(li),Si=I?null:ge,xi=cf(Ot,si,!1,M,e,y,w,p.glyphOffsetArray,_t,ht,lt,Li,pe,ni,vt,Si,Z.projection,N,I,Fi);Ct=xi.useVertical,Si&&xi.needsFlipping&&(ni={}),(xi.notEnoughRoom||Ct||xi.needsFlipping&&cf(Ot,si,!0,M,e,y,w,p.glyphOffsetArray,_t,ht,lt,Li,pe,ni,vt,Si,Z.projection,N,I,Fi).notEnoughRoom)&&fl(Rt,ht)}f?(p.text.dynamicLayoutVertexBuffer.updateData(ht),lt&&p.text.globeExtVertexBuffer&&p.text.globeExtVertexBuffer.updateData(lt)):(p.icon.dynamicLayoutVertexBuffer.updateData(ht),lt&&p.icon.globeExtVertexBuffer&&p.icon.globeExtVertexBuffer.updateData(lt))}function Br(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht){const{lineStartIndex:lt,glyphStartIndex:_t,segment:Mt}=M,vt=_t+M.numGlyphs,Ut=lt+M.lineLength,Ct=e.getoffsetX(_t),$t=e.getoffsetX(vt-1),Ot=el(p*Ct,a,f,y,w,I,Mt,lt,Ut,L,N,V,Z,U,!0,X,K,rt,ht);if(!Ot)return null;const Rt=el(p*$t,a,f,y,w,I,Mt,lt,Ut,L,N,V,Z,U,!0,X,K,rt,ht);return Rt?{first:Ot,last:Rt}:null}function Gu(p,e,a,f){return p===i.bK.horizontal&&Math.abs(f)>Math.abs(a)?{useVertical:!0}:p===i.bK.vertical?f>0?{needsFlipping:!0}:null:e!==Sa.unknown&&function(y,w){return y===0||Math.abs(w/y)>cc}(a,f)?e===Sa.flipRequired?{needsFlipping:!0}:null:a<0?{needsFlipping:!0}:null}function cf(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt,_t,Mt){const vt=e/24,Ut=p.lineOffsetX*vt,Ct=p.lineOffsetY*vt,{lineStartIndex:$t,glyphStartIndex:Ot,numGlyphs:Rt,segment:Zt,writingMode:pe,flipState:le}=p,Me=$t+p.lineLength,ve=Be=>{if(V){const[Oe,Te,qe]=Be.up,si=N.length;i.bM(V,si+0,Oe,Te,qe),i.bM(V,si+1,Oe,Te,qe),i.bM(V,si+2,Oe,Te,qe),i.bM(V,si+3,Oe,Te,qe)}const[oi,ge,ie]=Be.point;i.bN(N,oi,ge,ie,Be.angle)};if(Rt>1){const Be=Br(vt,M,Ut,Ct,a,Z,U,p,L,w,X,rt,!1,ht,lt,_t,Mt);if(!Be)return{notEnoughRoom:!0};if(f&&!a){let[oi,ge,ie]=Be.first.point,[Oe,Te,qe]=Be.last.point;[oi,ge]=es(oi,ge,ie,I),[Oe,Te]=es(Oe,Te,qe,I);const si=Gu(pe,le,(Oe-oi)*K,Te-ge);if(p.flipState=si&&si.needsFlipping?Sa.flipRequired:Sa.flipNotRequired,si)return si}ve(Be.first);for(let oi=Ot+1;oi<Ot+Rt-1;oi++){const ge=el(vt*M.getoffsetX(oi),Ut,Ct,a,Z,U,Zt,$t,Me,L,w,X,rt,!1,!1,ht,lt,_t,Mt);if(!ge)return N.length-=4*(oi-Ot),{notEnoughRoom:!0};ve(ge)}ve(Be.last)}else{if(f&&!a){const oi=es(U.x,U.y,0,y),ge=$t+Zt+1,ie=new i.P(L.getx(ge),L.gety(ge)),Oe=es(ie.x,ie.y,0,y),Te=Oe[3]>0?Oe:Gi(U,ie,oi,1,y,void 0,ht,lt.canonical),qe=Gu(pe,le,(Te[0]-oi[0])*K,Te[1]-oi[1]);if(p.flipState=qe&&qe.needsFlipping?Sa.flipRequired:Sa.flipNotRequired,qe)return qe}const Be=el(vt*M.getoffsetX(Ot),Ut,Ct,a,Z,U,Zt,$t,Me,L,w,X,rt,!1,!1,ht,lt,_t,Mt);if(!Be)return{notEnoughRoom:!0};ve(Be)}return{}}function la(p,e,a,f,y){const{x:w,y:I,z:M}=f.projectTilePoint(p.x,p.y,e);if(!y)return es(w,I,M,a);const[L,N,V]=y.getElevation(p,y.elevation,y.elevationFeature);return es(w+L,I+N,M+V,a)}function Gi(p,e,a,f,y,w,I,M){const L=la(p.sub(e)._unit()._add(p),M,y,I,w);return i.av(L,a,L),i.aw(L,L),i.bG(L,a,L,f)}function el(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt,_t){const Mt=f?p-e:p+e;let vt=Mt>0?1:-1,Ut=0;f&&(vt*=-1,Ut=Math.PI),vt<0&&(Ut+=Math.PI);let Ct=M+I+(vt>0?0:1)|0,$t=y,Ot=y,Rt=0,Zt=0;const pe=Math.abs(Mt),le=[],Me=[];let ve=w,Be=ve,oi=i.bE([]);const ge=()=>Gi(Be,ve,Ot,pe-Rt+1,V,U,rt,ht.canonical);for(;Rt+Zt<=pe;){if(Ct+=vt,Ct<M||Ct>=L)return null;if(Ot=$t,Be=ve,le.push(Ot),X&&Me.push(Be),ve=new i.P(N.getx(Ct),N.gety(Ct)),$t=Z[Ct],!$t){const Si=la(ve,ht.canonical,V,rt,U);$t=Si[3]>0?Z[Ct]=Si:ge()}Rt+=Zt;const li=i.av([],$t,Ot),Fi=i.bF(Ot,$t);if(a&&Fi>0&&Zt>0&&i.bI(oi,li)/(Zt*Fi)<_t)return null;Zt=Fi,oi=li}K&&U&&(Z[Ct]&&($t=ge(),Zt=i.bF(Ot,$t),oi=i.av([],$t,Ot)),Z[Ct]=$t);const ie=(pe-Rt)/Zt,Oe=ve.sub(Be)._mult(ie)._add(Be),Te=i.bG([],Ot,oi,ie);let qe=[0,0,1],si=oi[0],Li=oi[1];if(lt&&(qe=rt.upVector(ht.canonical,Oe.x,Oe.y),qe[0]!==0||qe[1]!==0||qe[2]!==1)){const li=[qe[2],0,-qe[0]],Fi=i.bH([],qe,li);i.aw(li,li),i.aw(Fi,Fi),si=i.bI(oi,li),Li=i.bI(oi,Fi)}if(a){const li=i.bH([],qe,oi);i.aw(li,li),i.bG(Te,Te,li,a*vt)}const ni=Ut+Math.atan2(Li,si);return le.push(Te),X&&Me.push(Oe),{point:Te,angle:ni,path:le,tilePath:Me,up:qe}}function fl(p,e){const a=e.length,f=a+4*p;e.resize(f),e.float32.fill(-1/0,4*a,4*f)}function ml(p,e,a){const f=e[0],y=e[1];return p[0]=a[0]*f+a[4]*y+a[12],p[1]=a[1]*f+a[5]*y+a[13],p[3]=a[3]*f+a[7]*y+a[15],p}const kl=100;class ka{constructor(e,a,f=new tl(e.width+200,e.height+200,25),y=new tl(e.width+200,e.height+200,25)){this.transform=e,this.grid=f,this.ignoredGrid=y,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+kl,this.screenBottomBoundary=e.height+kl,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.fogState=a}placeCollisionBox(e,a,f,y,w,I,M,L,N,V,Z){let U=f.projectedAnchorX,X=f.projectedAnchorY,K=f.projectedAnchorZ;const rt=f.tileAnchorX,ht=f.tileAnchorY,lt=f.elevation,_t=f.tileID,Mt=e.getProjection();if(lt&&_t){const[Me,ve,Be]=Mt.upVector(_t.canonical,f.tileAnchorX,f.tileAnchorY),oi=Mt.upVectorScale(_t.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;U+=Me*lt*oi,X+=ve*lt*oi,K+=Be*lt*oi}const vt=e.projection.name==="globe",Ut=e.projection.name==="globe"?i.aj(this.transform.zoom):0;if(_t&&vt&&Ut<1&&!I){const Me=1<<_t.canonical.z,ve=i.bO(rt,ht);i.bP(ve,ve,1/i.al),i.bQ(ve,ve,i.bO(_t.canonical.x,_t.canonical.y)),i.bP(ve,ve,1/Me),i.bR(ve,ve,i.bO(y[0],y[1])),ve[0]=i.bS(ve[0],-.5,.5),i.bP(ve,ve,i.al);const Be=i.bT(ve[0],ve[1],i.al/(2*Math.PI),1);i.aC(Be,Be,w),U=i.ak(U,Be[0],Ut),X=i.ak(X,Be[1],Ut),K=i.ak(K,Be[2],Ut)}const Ct=this.projectAndGetPerspectiveRatio(V,U,X,K,f.tileID,Mt.name==="globe"||!!lt||this.transform.pitch>0,Mt),$t=N*Ct.perspectiveRatio,Ot=(f.x1*a+M.x-f.padding)*$t+Ct.point.x,Rt=(f.y1*a+M.y-f.padding)*$t+Ct.point.y,Zt=(f.x2*a+M.x+f.padding)*$t+Ct.point.x,pe=(f.y2*a+M.y+f.padding)*$t+Ct.point.y,le=Ct.perspectiveRatio<=.55||Ct.occluded;return!this.isInsideGrid(Ot,Rt,Zt,pe)||!L&&this.grid.hitTest(Ot,Rt,Zt,pe,Z)||le?{box:[],offscreen:!1,occluded:Ct.occluded}:{box:[Ot,Rt,Zt,pe],offscreen:this.isOffscreen(Ot,Rt,Zt,pe),occluded:!1}}placeCollisionCircles(e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht){const lt=[],_t=this.transform.elevation,Mt=e.getProjection(),vt=e.elevationType==="road",Ut=!!_t||vt,Ct=i.bU.getAtTileOffsetFunc(ht,this.transform.center.lat,this.transform.worldSize,Mt),$t=new i.P(f.tileAnchorX,f.tileAnchorY),Ot=new i.P(f.tileAnchorX,f.tileAnchorY);let{x:Rt,y:Zt,z:pe}=Mt.projectTilePoint(Ot.x,Ot.y,ht.canonical),le=null;if(Ut){const Fi=vt?e.getElevationFeatureForText(y):null;le={getElevation:Ct,elevation:_t,elevationFeature:Fi};const[Si,xi,Ai]=Ct($t,_t,Fi);Rt+=Si,Zt+=xi,pe+=Ai}const Me=Mt.name==="globe",ve=this.projectAndGetPerspectiveRatio(L,Rt,Zt,pe,ht,Me||!!_t||this.transform.pitch>0,Mt),{perspectiveRatio:Be}=ve,oi=(U?M/Be:M*Be)/i.bX,ge=es(Rt,Zt,pe,N),ie=f.lineOffsetX*oi,Oe=f.lineOffsetY*oi,Te=i.an(e.layers[0].layout.get("text-max-angle")),qe=Math.cos(Te),si=ve.signedDistanceFromCamera>0?Br(oi,I,ie,Oe,vt&&f.flipState===1,ge,Ot,f,w,N,{},Ut&&!U?le:null,U&&Ut,Mt,ht,U,qe):null;let Li=!1,ni=!1,li=!0;if(si&&!ve.occluded){const Fi=.5*K*Be+rt,Si=new i.P(-100,-100),xi=new i.P(this.screenRightBoundary,this.screenBottomBoundary),Ai=new ju,{first:Wi,last:Gr}=si,en=Wi.path.length;let kn=[];for(let Pr=en-1;Pr>=1;Pr--)kn.push(Wi.path[Pr]);for(let Pr=1;Pr<Gr.path.length;Pr++)kn.push(Gr.path[Pr]);const ur=2.5*Fi;V&&(kn=kn.map(([Pr,Mn,Yr],Zn)=>(Ut&&!Me&&(Yr=Ct(Zn<en-1?Wi.tilePath[en-1-Zn]:Gr.tilePath[Zn-en+2],_t,le.elevationFeature)[2]),es(Pr,Mn,Yr,V))),kn.some(Pr=>Pr[3]<=0)&&(kn=[]));let Kr=[];if(kn.length>0){let Pr=1/0,Mn=-1/0,Yr=1/0,Zn=-1/0;for(const an of kn)Pr=Math.min(Pr,an[0]),Yr=Math.min(Yr,an[1]),Mn=Math.max(Mn,an[0]),Zn=Math.max(Zn,an[1]);Mn>=Si.x&&Pr<=xi.x&&Zn>=Si.y&&Yr<=xi.y&&(Kr=[kn.map(an=>new i.P(an[0],an[1]))],(Pr<Si.x||Mn>xi.x||Yr<Si.y||Zn>xi.y)&&(Kr=i.bV(Kr,Si.x,Si.y,xi.x,xi.y)))}for(const Pr of Kr){Ai.reset(Pr,.25*Fi);let Mn=0;Mn=Ai.length<=.5*Fi?1:Math.ceil(Ai.paddedLength/ur)+1;for(let Yr=0;Yr<Mn;Yr++){const Zn=Yr/Math.max(Mn-1,1),an=Ai.lerp(Zn),Mr=an.x+kl,_n=an.y+kl;lt.push(Mr,_n,Fi,0);const Lr=Mr-Fi,fo=_n-Fi,yn=Mr+Fi,mr=_n+Fi;if(li=li&&this.isOffscreen(Lr,fo,yn,mr),ni=ni||this.isInsideGrid(Lr,fo,yn,mr),!a&&this.grid.hitTestCircle(Mr,_n,Fi,X)&&(Li=!0,!Z))return{circles:[],offscreen:!1,collisionDetected:Li,occluded:!1}}}}return{circles:!Z&&Li||!ni?[]:lt,offscreen:li,collisionDetected:Li,occluded:ve.occluded}}queryRenderedSymbols(e){if(e.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const a=[];let f=1/0,y=1/0,w=-1/0,I=-1/0;for(const V of e){const Z=new i.P(V.x+kl,V.y+kl);f=Math.min(f,Z.x),y=Math.min(y,Z.y),w=Math.max(w,Z.x),I=Math.max(I,Z.y),a.push(Z)}const M=this.grid.query(f,y,w,I).concat(this.ignoredGrid.query(f,y,w,I)),L={},N={};for(const V of M){const Z=V.key;if(L[Z.bucketInstanceId]===void 0&&(L[Z.bucketInstanceId]={}),L[Z.bucketInstanceId][Z.featureIndex])continue;const U=[new i.P(V.x1,V.y1),new i.P(V.x2,V.y1),new i.P(V.x2,V.y2),new i.P(V.x1,V.y2)];i.bW(a,U)&&(L[Z.bucketInstanceId][Z.featureIndex]=!0,N[Z.bucketInstanceId]===void 0&&(N[Z.bucketInstanceId]=[]),N[Z.bucketInstanceId].push(Z.featureIndex))}return N}insertCollisionBox(e,a,f,y,w){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:f,featureIndex:y,collisionGroupID:w},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,a,f,y,w){const I=a?this.ignoredGrid:this.grid,M={bucketInstanceId:f,featureIndex:y,collisionGroupID:w};for(let L=0;L<e.length;L+=4)I.insertCircle(M,e[L],e[L+1],e[L+2])}projectAndGetPerspectiveRatio(e,a,f,y,w,I,M){const L=[a,f,y,1];let N=!1;y||this.transform.pitch>0?(i.aC(L,L,e),this.fogState&&w&&M.name!=="globe"&&(N=function(U,X,K,rt,ht,lt){const _t=lt.calculateFogTileMatrix(ht),Mt=[X,K,rt];return i.af(Mt,Mt,_t),ti(U,i.ag(Mt),lt.pitch,lt._fov)}(this.fogState,a,f,y,w.toUnwrapped(),this.transform)>.9)):ml(L,L,e);const V=L[3];return{point:new i.P((L[0]/V+1)/2*this.transform.width+kl,(-L[1]/V+1)/2*this.transform.height+kl),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(M)/V*.5,1.5),signedDistanceFromCamera:V,occluded:I&&L[2]>V||N}}isOffscreen(e,a,f,y){return f<kl||e>=this.screenRightBoundary||y<kl||a>this.screenBottomBoundary}isInsideGrid(e,a,f,y){return f>=0&&e<this.gridRightBoundary&&y>=0&&a<this.gridBottomBoundary}getViewportMatrix(){const e=i.bz([]);return i.bq(e,e,[-100,-100,0]),e}}class Vi{constructor(e,a,f,y){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?a:-a))):y&&f?1:0,this.placed=f}isHidden(){return this.opacity===0&&!this.placed}}class Jr{constructor(e,a,f,y,w,I=!1){this.text=new Vi(e?e.text:null,a,f,w),this.icon=new Vi(e?e.icon:null,a,y,w),this.clipped=I}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class mn{constructor(e,a,f,y=!1){this.text=e,this.icon=a,this.skipFade=f,this.clipped=y}}class il{constructor(){this.invProjMatrix=i.bB(),this.viewportMatrix=i.bB(),this.circles=[]}}class Qc{constructor(e,a,f,y,w){this.bucketInstanceId=e,this.featureIndex=a,this.sourceLayerIndex=f,this.bucketIndex=y,this.tileID=w}}class dn{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const a=++this.maxGroupID;this.collisionGroups[e]={ID:a,predicate:f=>f.collisionGroupID===a}}return this.collisionGroups[e]}}function ca(p,e,a,f,y){const{horizontalAlign:w,verticalAlign:I}=i.c0(p),M=-(w-.5)*e,L=-(I-.5)*a,N=i.c1(p,f);return new i.P(M+N[0]*y,L+N[1]*y)}function Dc(p,e,a,f,y){const w=new i.P(p,e);return a&&w._rotate(f?y:-y),w}class hc{constructor(e,a,f,y,w,I){this.transform=e.clone(),this.projection=e.projection.name,this.collisionIndex=new ka(this.transform,w),this.buildingIndex=I,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=a,this.retainedQueryData={},this.collisionGroups=new dn(f),this.collisionCircleArrays={},this.prevPlacement=y,y&&(y.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(e,a,f,y,w=1){const I=f.getBucket(a),M=f.latestFeatureIndex;if(!I||!M||a.fqid!==I.layerIds[0])return;const L=I.layers[0].layout,N=I.layers[0].paint,V=f.collisionBoxArray,Z=Math.pow(2,this.transform.zoom-f.tileID.overscaledZ),U=f.tileSize/i.al,X=f.tileID.toUnwrapped();this.transform.setProjection(I.projection);const K=(rt=f.tileID,ht=I.getProjection(),lt=this.transform,ht.name===this.projection?lt.calculateProjMatrix(rt.toUnwrapped()):rn(lt,ht,rt));var rt,ht,lt;const _t=L.get("text-pitch-alignment")==="map",Mt=L.get("text-rotation-alignment")==="map";a.compileFilter(a.options);const vt=a.dynamicFilter(),Ut=a.dynamicFilterNeedsFeature(),Ct=this.transform.calculatePixelsToTileUnitsMatrix(f),$t=Kc(K,f.tileID.canonical,_t,Mt,this.transform,I.getProjection(),Ct);let Ot=null;const Rt=I.getProjection().createInversionMatrix(this.transform,f.tileID.canonical);if(_t){const ie=Rl(K,f.tileID.canonical,_t,Mt,this.transform,I.getProjection(),Ct);Ot=i.aB([],this.transform.labelPlaneMatrix,ie)}let Zt=null;vt&&f.latestFeatureIndex&&(Zt={unwrappedTileID:X,dynamicFilter:vt,dynamicFilterNeedsFeature:Ut}),this.retainedQueryData[I.bucketInstanceId]=new Qc(I.bucketInstanceId,M,I.sourceLayerIndex,I.index,f.tileID);const[pe,le]=I.layers[0].layout.get("text-size-scale-range"),Me=i.aA(w,pe,le),[ve,Be]=L.get("icon-size-scale-range"),oi=i.aA(w,ve,Be),ge={bucket:I,layout:L,paint:N,posMatrix:K,invMatrix:Rt,mercatorCenter:[i.aF(this.transform.center.lng),i.aJ(this.transform.center.lat)],textLabelPlaneMatrix:$t,labelToScreenMatrix:Ot,clippingData:Zt,scale:Z,textPixelRatio:U,holdingForFade:f.holdingForFade(),collisionBoxArray:V,partiallyEvaluatedTextSize:i.bJ(I.textSizeData,this.transform.zoom,Me),partiallyEvaluatedIconSize:i.bJ(I.iconSizeData,this.transform.zoom,oi),collisionGroup:this.collisionGroups.get(I.sourceID),latestFeatureIndex:f.latestFeatureIndex};if(y)for(const ie of I.sortKeyRanges){const{sortKey:Oe,symbolInstanceStart:Te,symbolInstanceEnd:qe}=ie;e.push({sortKey:Oe,symbolInstanceStart:Te,symbolInstanceEnd:qe,parameters:ge})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:I.symbolInstances.length,parameters:ge})}attemptAnchorPlacement(e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt,_t,Mt,vt,Ut){const{textOffset0:Ct,textOffset1:$t,crossTileID:Ot}=rt,Rt=[Ct,$t],Zt=ca(e,I,M,Rt,L),pe=this.collisionIndex.placeCollisionBox(lt,L,a,f,y,w,Dc(Zt.x,Zt.y,N,V,this.transform.angle),K,Z,U,X.predicate);if(Mt){const le=lt.getSymbolInstanceIconSize(Ut,this.transform.zoom,rt.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(lt,le,Mt,f,y,w,Dc(Zt.x,Zt.y,N,V,this.transform.angle),K,Z,U,X.predicate).box.length===0)return}if(pe.box.length>0){let le;return this.prevPlacement&&this.prevPlacement.variableOffsets[Ot]&&this.prevPlacement.placements[Ot]&&this.prevPlacement.placements[Ot].text&&(le=this.prevPlacement.variableOffsets[Ot].anchor),this.variableOffsets[Ot]={textOffset:Rt,width:I,height:M,anchor:e,textScale:L,prevAnchor:le},this.markUsedJustification(lt,e,rt,_t),lt.allowVerticalPlacement&&(this.markUsedOrientation(lt,_t,rt),this.placedOrientations[Ot]=_t),{shift:Zt,placedGlyphBoxes:pe}}}placeLayerBucketPart(e,a,f,y,w=1){const{bucket:I,layout:M,paint:L,posMatrix:N,textLabelPlaneMatrix:V,labelToScreenMatrix:Z,clippingData:U,textPixelRatio:X,mercatorCenter:K,invMatrix:rt,holdingForFade:ht,collisionBoxArray:lt,partiallyEvaluatedTextSize:_t,partiallyEvaluatedIconSize:Mt,collisionGroup:vt,latestFeatureIndex:Ut}=e.parameters,Ct=M.get("text-optional"),$t=M.get("icon-optional"),Ot=M.get("text-allow-overlap"),Rt=M.get("icon-allow-overlap"),Zt=M.get("text-rotation-alignment")==="map",pe=M.get("icon-rotation-alignment")==="map",le=M.get("text-pitch-alignment")==="map",Me=L.get("symbol-z-offset"),ve=M.get("symbol-elevation-reference")==="sea",Be=M.get("symbol-placement"),[oi,ge]=M.get("text-size-scale-range"),[ie,Oe]=M.get("icon-size-scale-range"),Te=i.aA(w,oi,ge),qe=i.aA(w,ie,Oe),si=M.get("text-variable-anchor"),Li=Zt&&Be!=="point",ni=pe&&Be!=="point",li=si&&I.hasTextData(),Fi=I.hasIconTextFit()&&li&&I.hasIconData();this.transform.setProjection(I.projection);const Si=li||Li,xi=ni||Fi;let Ai=Ot&&(Rt||!I.hasIconData()||$t),Wi=Rt&&(Ot||!I.hasTextData()||Ct);const Gr=!Me.isConstant();!I.collisionArrays&&lt&&I.deserializeCollisionBoxes(lt),f&&y&&I.updateCollisionDebugBuffers(this.transform.zoom,lt,Te,qe);const en=(ur,Kr,Pr)=>{const{crossTileID:Mn,numVerticalGlyphVertices:Yr}=ur;let Zn=null;if(U&&U.dynamicFilterNeedsFeature||Gr){const mo=this.retainedQueryData[I.bucketInstanceId];Zn=Ut.loadFeature({featureIndex:ur.featureIndex,bucketIndex:mo.bucketIndex,sourceLayerIndex:mo.sourceLayerIndex,layoutVertexArrayOffset:0})}if(U&&!(0,U.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:I.worldview},Zn,this.retainedQueryData[I.bucketInstanceId].tileID.canonical,new i.P(ur.tileAnchorX,ur.tileAnchorY),this.transform.calculateDistanceTileData(U.unwrappedTileID)))return this.placements[Mn]=new mn(!1,!1,!1,!0),void a.add(Mn);const an=Me.evaluate(Zn,{});if(a.has(Mn))return;if(ht)return void(this.placements[Mn]=new mn(!1,!1,!1));let Mr=!1,_n=!1,Lr=!0,fo=!1,yn=!1,mr=null,nn={box:null,offscreen:null,occluded:null},So={box:null},Yo=null,Ro=null,jo=null,Io=0,fa=0,Pa=0;Pr.textFeatureIndex?Io=Pr.textFeatureIndex:ur.useRuntimeCollisionCircles&&(Io=ur.featureIndex),Pr.verticalTextFeatureIndex&&(fa=Pr.verticalTextFeatureIndex);const Va=I.elevationFeatures?I.elevationFeatures[ur.elevationFeatureIndex]:void 0,ic=mo=>{mo.tileID=this.retainedQueryData[I.bucketInstanceId].tileID;const Go=this.transform.elevation;mo.elevation=ve?an:an+i.bU.getAtTileOffset(mo.tileID,new i.P(mo.tileAnchorX,mo.tileAnchorY),Go,Va),mo.elevation+=ur.zOffset},ma=Pr.textBox;if(ma){ic(ma);const mo=jn=>{let Qo=i.bK.horizontal;if(I.allowVerticalPlacement&&!jn&&this.prevPlacement){const Ls=this.prevPlacement.placedOrientations[Mn];Ls&&(this.placedOrientations[Mn]=Ls,Qo=Ls,this.markUsedOrientation(I,Qo,ur))}return Qo},Go=(jn,Qo)=>{if(I.allowVerticalPlacement&&Yr>0&&Pr.verticalTextBox){for(const Ls of I.writingModes)if(Ls===i.bK.vertical?(nn=Qo(),So=nn):nn=jn(),nn&&nn.box&&nn.box.length)break}else nn=jn()};if(si){let jn=si;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Mn]){const go=this.prevPlacement.variableOffsets[Mn];jn.indexOf(go.anchor)>0&&(jn=jn.filter(rc=>rc!==go.anchor),jn.unshift(go.anchor))}const Qo=(go,rc,Up)=>{const Du=I.getSymbolInstanceTextSize(_t,ur,this.transform.zoom,Kr),jp=(go.x2-go.x1)*Du+2*go.padding,Gp=(go.y2-go.y1)*Du+2*go.padding,wc=ur.hasIconTextFit&&!Rt?rc:null;wc&&ic(wc);let eu={box:[],offscreen:!1,occluded:!1};const Zs=Ot?2*jn.length:jn.length;for(let Tc=0;Tc<Zs;++Tc){const Xd=this.attemptAnchorPlacement(jn[Tc%jn.length],go,K,rt,Si,jp,Gp,Du,Zt,le,X,N,vt,Tc>=jn.length,ur,Kr,I,Up,wc,_t,Mt);if(Xd&&(eu=Xd.placedGlyphBoxes,eu&&eu.box&&eu.box.length)){Mr=!0,mr=Xd.shift;break}}return eu};Go(()=>Qo(ma,Pr.iconBox,i.bK.horizontal),()=>{const go=Pr.verticalTextBox;return go&&ic(go),I.allowVerticalPlacement&&!(nn&&nn.box&&nn.box.length)&&Yr>0&&go?Qo(go,Pr.verticalIconBox,i.bK.vertical):{box:null,offscreen:null,occluded:null}}),nn&&(Mr=nn.box,Lr=nn.offscreen,fo=nn.occluded);const Ls=mo(!(!nn||!nn.box));if(!Mr&&this.prevPlacement){const go=this.prevPlacement.variableOffsets[Mn];go&&(this.variableOffsets[Mn]=go,this.markUsedJustification(I,go.anchor,ur,Ls))}}else{const jn=(Qo,Ls)=>{const go=I.getSymbolInstanceTextSize(_t,ur,this.transform.zoom,Kr),rc=this.collisionIndex.placeCollisionBox(I,go,Qo,K,rt,Si,new i.P(0,0),Ot,X,N,vt.predicate);return rc&&rc.box&&rc.box.length&&(this.markUsedOrientation(I,Ls,ur),this.placedOrientations[Mn]=Ls),rc};Go(()=>jn(ma,i.bK.horizontal),()=>{const Qo=Pr.verticalTextBox;return I.allowVerticalPlacement&&Yr>0&&Qo?(ic(Qo),jn(Qo,i.bK.vertical)):{box:null,offscreen:null,occluded:null}}),mo(!!(nn&&nn.box&&nn.box.length))}}if(Yo=nn,Mr=Yo&&Yo.box&&Yo.box.length>0,Lr=Yo&&Yo.offscreen,fo=Yo&&Yo.occluded,ur.useRuntimeCollisionCircles){const mo=ur.centerJustifiedTextSymbolIndex>=0?ur.centerJustifiedTextSymbolIndex:ur.verticalPlacedTextSymbolIndex,Go=I.text.placedSymbolArray.get(mo),jn=i.bL(I.textSizeData,_t,Go),Qo=M.get("text-padding");Ro=this.collisionIndex.placeCollisionCircles(I,Ot,Go,mo,I.lineVertexArray,I.glyphOffsetArray,jn,N,V,Z,f,le,vt.predicate,ur.collisionCircleDiameter*jn/i.bX,Qo,this.retainedQueryData[I.bucketInstanceId].tileID),Mr=Ot||Ro.circles.length>0&&!Ro.collisionDetected,Lr=Lr&&Ro.offscreen,fo=Ro.occluded}if(Pr.iconFeatureIndex&&(Pa=Pr.iconFeatureIndex),Pr.iconBox){const mo=Go=>{ic(Go);const jn=ur.hasIconTextFit&&mr?Dc(mr.x,mr.y,Zt,le,this.transform.angle):new i.P(0,0),Qo=I.getSymbolInstanceIconSize(Mt,this.transform.zoom,ur.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(I,Qo,Go,K,rt,xi,jn,Rt,X,N,vt.predicate)};So&&So.box&&So.box.length&&Pr.verticalIconBox?(jo=mo(Pr.verticalIconBox),_n=jo.box.length>0):(jo=mo(Pr.iconBox),_n=jo.box.length>0),Lr=Lr&&jo.offscreen,yn=jo.occluded}const vc=Ct||ur.numHorizontalGlyphVertices===0&&Yr===0,bc=$t||ur.numIconVertices===0;if(vc||bc?bc?vc||(_n=_n&&Mr):Mr=_n&&Mr:_n=Mr=_n&&Mr,Mr&&Yo&&Yo.box&&this.collisionIndex.insertCollisionBox(Yo.box,M.get("text-ignore-placement"),I.bucketInstanceId,So&&So.box&&fa?fa:Io,vt.ID),_n&&jo&&this.collisionIndex.insertCollisionBox(jo.box,M.get("icon-ignore-placement"),I.bucketInstanceId,Pa,vt.ID),Ro&&(Mr&&this.collisionIndex.insertCollisionCircles(Ro.circles,M.get("text-ignore-placement"),I.bucketInstanceId,Io,vt.ID),f)){const mo=I.bucketInstanceId;let Go=this.collisionCircleArrays[mo];Go===void 0&&(Go=this.collisionCircleArrays[mo]=new il);for(let jn=0;jn<Ro.circles.length;jn+=4)Go.circles.push(Ro.circles[jn+0]),Go.circles.push(Ro.circles[jn+1]),Go.circles.push(Ro.circles[jn+2]),Go.circles.push(Ro.collisionDetected?1:0)}const qs=I.projection.name!=="globe";Ai=Ai&&(qs||!fo),Wi=Wi&&(qs||!yn),this.placements[Mn]=new mn(Mr||Ai,_n||Wi,Lr||I.justReloaded),a.add(Mn)},kn=this.retainedQueryData[I.bucketInstanceId].tileID;if(I.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(I,kn),I.elevationType==="road"&&I.updateRoadElevation(kn.canonical),I.updateZOffset(),I.sortFeaturesByY){const ur=I.getSortedSymbolIndexes(this.transform.angle);for(let Kr=ur.length-1;Kr>=0;--Kr){const Pr=ur[Kr];en(I.symbolInstances.get(Pr),Pr,I.collisionArrays[Pr])}I.hasAnyZOffset&&i.w(`${I.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(I.hasAnyZOffset){const ur=I.getSortedIndexesByZOffset();for(let Kr=0;Kr<ur.length;++Kr){const Pr=ur[Kr];en(I.symbolInstances.get(Pr),Pr,I.collisionArrays[Pr])}}else for(let ur=e.symbolInstanceStart;ur<e.symbolInstanceEnd;ur++)en(I.symbolInstances.get(ur),ur,I.collisionArrays[ur]);if(f&&I.bucketInstanceId in this.collisionCircleArrays){const ur=this.collisionCircleArrays[I.bucketInstanceId];i.bk(ur.invProjMatrix,N),ur.viewportMatrix=this.collisionIndex.getViewportMatrix()}I.justReloaded=!1}markUsedJustification(e,a,f,y){const{leftJustifiedTextSymbolIndex:w,centerJustifiedTextSymbolIndex:I,rightJustifiedTextSymbolIndex:M,verticalPlacedTextSymbolIndex:L,crossTileID:N}=f,V=i.c2(a),Z=y===i.bK.vertical?L:V==="left"?w:V==="center"?I:V==="right"?M:-1;w>=0&&(e.text.placedSymbolArray.get(w).crossTileID=Z>=0&&w!==Z?0:N),I>=0&&(e.text.placedSymbolArray.get(I).crossTileID=Z>=0&&I!==Z?0:N),M>=0&&(e.text.placedSymbolArray.get(M).crossTileID=Z>=0&&M!==Z?0:N),L>=0&&(e.text.placedSymbolArray.get(L).crossTileID=Z>=0&&L!==Z?0:N)}markUsedOrientation(e,a,f){const y=a===i.bK.horizontal||a===i.bK.horizontalOnly?a:0,w=a===i.bK.vertical?a:0,{leftJustifiedTextSymbolIndex:I,centerJustifiedTextSymbolIndex:M,rightJustifiedTextSymbolIndex:L,verticalPlacedTextSymbolIndex:N}=f,V=e.text.placedSymbolArray;I>=0&&(V.get(I).placedOrientation=y),M>=0&&(V.get(M).placedOrientation=y),L>=0&&(V.get(L).placedOrientation=y),N>=0&&(V.get(N).placedOrientation=w)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const a=this.prevPlacement;let f=!1;this.prevZoomAdjustment=a?a.zoomAdjustment(this.transform.zoom):0;const y=a?a.symbolFadeChange(e):1,w=a?a.opacities:{},I=a?a.variableOffsets:{},M=a?a.placedOrientations:{};for(const L in this.placements){const N=this.placements[L],V=w[L];V?(this.opacities[L]=new Jr(V,y,N.text,N.icon,null,N.clipped),f=f||N.text!==V.text.placed||N.icon!==V.icon.placed):(this.opacities[L]=new Jr(null,y,N.text,N.icon,N.skipFade,N.clipped),f=f||N.text||N.icon)}for(const L in w){const N=w[L];if(!this.opacities[L]){const V=new Jr(N,y,!1,!1);V.isHidden()||(this.opacities[L]=V,f=f||N.text.placed||N.icon.placed)}}for(const L in I)this.variableOffsets[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.variableOffsets[L]=I[L]);for(const L in M)this.placedOrientations[L]||!this.opacities[L]||this.opacities[L].isHidden()||(this.placedOrientations[L]=M[L]);f?this.lastPlacementChangeTime=e:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=a?a.lastPlacementChangeTime:e)}updateLayerOpacities(e,a,f,y){const w=new Set;for(const I of a){const M=I.getBucket(e);M&&I.latestFeatureIndex&&e.fqid===M.layerIds[0]&&(this.updateBucketOpacities(M,w,I,I.collisionBoxArray,f,y,I.tileID,e.scope),M.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(M,I.tileID),M.elevationType==="road"&&M.updateRoadElevation(I.tileID.canonical),M.updateZOffset())}}updateBucketOpacities(e,a,f,y,w,I,M,L){e.hasTextData()&&e.text.opacityVertexArray.clear(),e.hasIconData()&&e.icon.opacityVertexArray.clear(),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();const N=e.layers[0].layout,V=e.layers[0].paint,Z=!!e.layers[0].dynamicFilter(),U=new Jr(null,0,!1,!1,!0),X=N.get("text-allow-overlap"),K=N.get("icon-allow-overlap"),rt=N.get("text-variable-anchor"),ht=N.get("text-rotation-alignment")==="map",lt=N.get("text-pitch-alignment")==="map",_t=V.get("symbol-z-offset"),Mt=N.get("symbol-elevation-reference")==="sea",vt=!_t.isConstant(),Ut=new Jr(null,0,X&&(K||!e.hasIconData()||N.get("icon-optional")),K&&(X||!e.hasTextData()||N.get("text-optional")),!0);!e.collisionArrays&&y&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(y);const Ct=(Ot,Rt,Zt)=>{for(let pe=0;pe<Rt/4;pe++)Ot.opacityVertexArray.emplaceBack(Zt)};let $t=0;I&&e.updateReplacement(M,I);for(let Ot=0;Ot<e.symbolInstances.length;Ot++){const Rt=e.symbolInstances.get(Ot),{numHorizontalGlyphVertices:Zt,numVerticalGlyphVertices:pe,crossTileID:le,numIconVertices:Me,tileAnchorX:ve,tileAnchorY:Be}=Rt;let oi=null;const ge=this.retainedQueryData[e.bucketInstanceId];vt&&Rt&&ge&&(oi=f.latestFeatureIndex.loadFeature({featureIndex:Rt.featureIndex,bucketIndex:ge.bucketIndex,sourceLayerIndex:ge.sourceLayerIndex,layoutVertexArrayOffset:0}));const ie=_t.evaluate(oi,{}),Oe=a.has(le);let Te=this.opacities[le];Oe?Te=U:Te||(Te=Ut,this.opacities[le]=Te),a.add(le);const qe=Zt>0||pe>0,si=Me>0,Li=this.placedOrientations[le],ni=Li===i.bK.vertical,li=Li===i.bK.horizontal||Li===i.bK.horizontalOnly;!qe&&!si||Te.isHidden()||$t++;let Fi=!1;if((qe||si)&&I)for(const Si of e.activeReplacements){if(i.bY(Si,w,i.bZ.Symbol,L)||Si.min.x>ve||ve>Si.max.x||Si.min.y>Be||Be>Si.max.y)continue;const xi=i.b_(ve,Be,M.canonical,Si.footprintTileId.canonical);if(Fi=i.b$(xi,Si.footprint),Fi)break}if(qe){const Si=Fi?Ts:eh(Te.text);Ct(e.text,Zt,ni?Ts:Si),Ct(e.text,pe,li?Ts:Si);const xi=Te.text.isHidden(),{leftJustifiedTextSymbolIndex:Ai,centerJustifiedTextSymbolIndex:Wi,rightJustifiedTextSymbolIndex:Gr,verticalPlacedTextSymbolIndex:en}=Rt,kn=e.text.placedSymbolArray,ur=xi||ni?1:0;Ai>=0&&(kn.get(Ai).hidden=ur),Wi>=0&&(kn.get(Wi).hidden=ur),Gr>=0&&(kn.get(Gr).hidden=ur),en>=0&&(kn.get(en).hidden=xi||li?1:0);const Kr=this.variableOffsets[le];Kr&&this.markUsedJustification(e,Kr.anchor,Rt,Li);const Pr=this.placedOrientations[le];Pr&&(this.markUsedJustification(e,"left",Rt,Pr),this.markUsedOrientation(e,Pr,Rt))}if(si){const Si=Fi?Ts:eh(Te.icon),{placedIconSymbolIndex:xi,verticalPlacedIconSymbolIndex:Ai}=Rt,Wi=e.icon.placedSymbolArray,Gr=Te.icon.isHidden()?1:0;xi>=0&&(Ct(e.icon,Me,ni?Ts:Si),Wi.get(xi).hidden=Gr),Ai>=0&&(Ct(e.icon,Rt.numVerticalIconVertices,li?Ts:Si),Wi.get(Ai).hidden=Gr)}if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){const Si=e.collisionArrays[Ot];if(Si){let xi=new i.P(0,0),Ai=!0;if(Si.textBox||Si.verticalTextBox){if(rt){const Gr=this.variableOffsets[le];Gr?(xi=ca(Gr.anchor,Gr.width,Gr.height,Gr.textOffset,Gr.textScale),ht&&xi._rotate(lt?this.transform.angle:-this.transform.angle)):Ai=!1}Z&&(Ai=!Te.clipped),Si.textBox&&ws(e.textCollisionBox.collisionVertexArray,Te.text.placed,!Ai||ni,ie,Mt,xi.x,xi.y),Si.verticalTextBox&&ws(e.textCollisionBox.collisionVertexArray,Te.text.placed,!Ai||li,ie,Mt,xi.x,xi.y)}const Wi=Ai&&!!(!li&&Si.verticalIconBox);Si.iconBox&&ws(e.iconCollisionBox.collisionVertexArray,Te.icon.placed,Wi,ie,Mt,Rt.hasIconTextFit?xi.x:0,Rt.hasIconTextFit?xi.y:0),Si.verticalIconBox&&ws(e.iconCollisionBox.collisionVertexArray,Te.icon.placed,!Wi,ie,Mt,Rt.hasIconTextFit?xi.x:0,Rt.hasIconTextFit?xi.y:0)}}}if(e.fullyClipped=$t===0,e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.bucketInstanceId in this.collisionCircleArrays){const Ot=this.collisionCircleArrays[e.bucketInstanceId];e.placementInvProjMatrix=Ot.invProjMatrix,e.placementViewportMatrix=Ot.viewportMatrix,e.collisionCircleArray=Ot.circles,delete this.collisionCircleArrays[e.bucketInstanceId]}}symbolFadeChange(e){return this.fadeDuration===0?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,a){const f=this.zoomAtLastRecencyCheck===a?1-this.zoomAdjustment(a):1;return this.zoomAtLastRecencyCheck=a,this.commitTime+this.fadeDuration*f>e}setStale(){this.stale=!0}}function ws(p,e,a,f,y,w,I){p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0),p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0),p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0),p.emplaceBack(e?1:0,a?1:0,w||0,I||0,f,y?1:0)}const Ho=Math.pow(2,25),zc=Math.pow(2,24),Id=Math.pow(2,17),Ed=Math.pow(2,16),th=Math.pow(2,9),uc=Math.pow(2,8),hf=Math.pow(2,1);function eh(p){if(p.opacity===0&&!p.placed)return 0;if(p.opacity===1&&p.placed)return 4294967295;const e=p.placed?1:0,a=Math.floor(127*p.opacity);return a*Ho+e*zc+a*Id+e*Ed+a*th+e*uc+a*hf+e}const Ts=0;class gl{constructor(e){this._sortAcrossTiles=e.layout.get("symbol-z-order")!=="viewport-y"&&e.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(e,a,f,y,w,I){const M=this._bucketParts;for(;this._currentTileIndex<e.length;)if(a.getBucketParts(M,y,e[this._currentTileIndex],this._sortAcrossTiles,I),this._currentTileIndex++,w())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,M.sort((L,N)=>L.sortKey-N.sortKey));this._currentPartIndex<M.length;){const L=M[this._currentPartIndex];if(a.placeLayerBucketPart(L,this._seenCrossTileIDs,f,L.symbolInstanceStart===0,I),this._currentPartIndex++,w())return!0}return!1}}class Fa{constructor(e,a,f,y,w,I,M,L,N){this.placement=new hc(e,w,I,M,L,N),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=f,this._showCollisionBoxes=y,this._done=!1}isDone(){return this._done}continuePlacement(e,a,f,y,w){const I=i.o.now(),M=()=>{const L=i.o.now()-I;return!this._forceFullPlacement&&L>2};for(;this._currentPlacementIndex>=0;){const L=a[e[this._currentPlacementIndex]],N=this.placement.collisionIndex.transform.zoom;if(L.type==="symbol"&&(!L.minzoom||L.minzoom<=N)&&(!L.maxzoom||L.maxzoom>N)){const V=L,Z=V.layout.get("symbol-z-elevate"),U=V.layout.get("symbol-sort-key").constantOr(1)!==void 0,X=V.layout.get("symbol-z-order"),K=X==="viewport-y"||X==="auto"&&!(X!=="viewport-y"&&U),rt=V.layout.get("text-allow-overlap")||V.layout.get("icon-allow-overlap")||V.layout.get("text-ignore-placement")||V.layout.get("icon-ignore-placement"),ht=K&&rt,lt=this._inProgressLayer=this._inProgressLayer||new gl(V),_t=i.B(L.source,L.scope);if(lt.continuePlacement(Z||ht?y[_t]:f[_t],this.placement,this._showCollisionBoxes,L,M,w))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const Ad=512/i.al/2;class $u{constructor(e,a,f){this.tileID=e,this.bucketInstanceId=f,this.index=new i.c3(a.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const y=e.canonical.x*i.al,w=e.canonical.y*i.al;for(let I=0;I<a.length;I++){const{key:M,crossTileID:L,tileAnchorX:N,tileAnchorY:V}=a.get(I),Z=Math.floor((y+N)*Ad),U=Math.floor((w+V)*Ad);this.index.add(Z,U),this.keys.push(M),this.crossTileIDs.push(L)}this.index.finish()}findMatches(e,a,f){const y=this.tileID.canonical.z<a.canonical.z?1:Math.pow(2,this.tileID.canonical.z-a.canonical.z),w=Ad/Math.pow(2,a.canonical.z-this.tileID.canonical.z),I=a.canonical.x*i.al,M=a.canonical.y*i.al;for(let L=0;L<e.length;L++){const N=e.get(L);if(N.crossTileID)continue;const{key:V,tileAnchorX:Z,tileAnchorY:U}=N,X=Math.floor((I+Z)*w),K=Math.floor((M+U)*w),rt=this.index.range(X-y,K-y,X+y,K+y).sort((ht,lt)=>ht-lt);for(const ht of rt){const lt=this.crossTileIDs[ht];if(this.keys[ht]===V&&!f.has(lt)){f.add(lt),N.crossTileID=lt;break}}}}}class gs{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Yl{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const a=Math.round((e-this.lng)/360);if(a!==0)for(const f in this.indexes){const y=this.indexes[f],w={};for(const I in y){const M=y[I];M.tileID=M.tileID.unwrapTo(M.tileID.wrap+a),w[M.tileID.key]=M}this.indexes[f]=w}this.lng=e}addBucket(e,a,f){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===a.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let w=0;w<a.symbolInstances.length;w++)a.symbolInstances.get(w).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]=new Set);const y=this.usedCrossTileIDs[e.overscaledZ];for(const w in this.indexes){const I=this.indexes[w];if(Number(w)>e.overscaledZ)for(const M in I){const L=I[M];L.tileID.isChildOf(e)&&L.findMatches(a.symbolInstances,e,y)}else{const M=I[e.scaledTo(Number(w)).key];M&&M.findMatches(a.symbolInstances,e,y)}}for(let w=0;w<a.symbolInstances.length;w++){const I=a.symbolInstances.get(w);I.crossTileID||(I.crossTileID=f.generate(),y.add(I.crossTileID))}return this.indexes[e.overscaledZ]===void 0&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new $u(e,a.symbolInstances,a.bucketInstanceId),!0}removeBucketCrossTileIDs(e,a){for(const f of a.crossTileIDs)this.usedCrossTileIDs[e].delete(f)}removeStaleBuckets(e){let a=!1;for(const f in this.indexes){const y=this.indexes[f];for(const w in y)e[y[w].bucketInstanceId]||(this.removeBucketCrossTileIDs(f,y[w]),delete y[w],a=!0)}return a}}class Lc{constructor(){this.layerIndexes={},this.crossTileIDs=new gs,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,a,f,y){let w=this.layerIndexes[e.fqid];w===void 0&&(w=this.layerIndexes[e.fqid]=new Yl);let I=!1;const M={};y.name!=="globe"&&w.handleWrapJump(f);for(const L of a){const N=L.getBucket(e);N&&e.fqid===N.layerIds[0]&&(N.bucketInstanceId||(N.bucketInstanceId=++this.maxBucketInstanceId),w.addBucket(L.tileID,N,this.crossTileIDs)&&(I=!0),M[N.bucketInstanceId]=!0)}return w.removeStaleBuckets(M)&&(I=!0),I}pruneUnusedLayers(e){const a={};e.forEach(f=>{a[f]=!0});for(const f in this.layerIndexes)a[f]||delete this.layerIndexes[f]}}const Fo=771;class Sr{constructor(e,a,f,y){this.blendFunction=e,this.blendColor=a.toNonPremultipliedRenderColor(null),this.mask=f,this.blendEquation=y}}Sr.Replace=[1,0,1,0],Sr.disabled=new Sr(Sr.Replace,i.ao.transparent,[!1,!1,!1,!1]),Sr.unblended=new Sr(Sr.Replace,i.ao.transparent,[!0,!0,!0,!0]),Sr.alphaBlended=new Sr([1,Fo,1,Fo],i.ao.transparent,[!0,!0,!0,!0]),Sr.alphaBlendedNonPremultiplied=new Sr([770,Fo,770,Fo],i.ao.transparent,[!0,!0,!0,!0]),Sr.multiply=new Sr([774,0,774,0],i.ao.transparent,[!0,!0,!0,!0]),Sr.additive=new Sr([1,1,1,1],i.ao.transparent,[!0,!0,!0,!0]);class ki{constructor(e,a,f){this.func=e,this.mask=a,this.range=f}}ki.ReadOnly=!1,ki.ReadWrite=!0,ki.disabled=new ki(519,ki.ReadOnly,[0,1]);const Fl=7680;class hr{constructor(e,a,f,y,w,I){this.test=e,this.ref=a,this.mask=f,this.fail=y,this.depthFail=w,this.pass=I}}hr.disabled=new hr({func:519,mask:0},0,0,Fl,Fl,Fl);const cu=1029,Mh=2305;class rr{constructor(e,a,f){this.enable=e,this.mode=a,this.frontFace=f}}function ih(p,e){const a=i.c9(p,3);i.cb(p,e),i.cf(p,3,a)}function fp(p,e){const a=i.c6([]);return i.c7(a,a,-e),i.c8(a,a,-p),a}function Uf(p,e){const a=[p[0],p[1],0],f=[e[0],e[1],0];if(i.ag(a)>=1e-15){const I=i.aw([],a);i.c4(f,I,i.bI(f,I)),e[0]=f[0],e[1]=f[1]}const y=i.bH([],e,p);if(i.c5(y)<1e-15)return null;const w=Math.atan2(-y[1],y[0]);return fp(Math.atan2(Math.sqrt(p[0]*p[0]+p[1]*p[1]),-p[2]),w)}rr.disabled=new rr(!1,cu,Mh),rr.backCCW=new rr(!0,cu,Mh),rr.backCW=new rr(!0,cu,2304),rr.frontCW=new rr(!0,1028,2304),rr.frontCCW=new rr(!0,1028,Mh);class dc{constructor(e,a){this.position=e,this.orientation=a}get position(){return this._position}set position(e){if(e){const a=e instanceof i.ae?e:new i.ae(e[0],e[1],e[2]);this._renderWorldCopies&&(a.x=i.bS(a.x,0,1)),this._position=a}else this._position=null}lookAtPoint(e,a,f){if(this.orientation=null,!this.position)return;const y=this.position,w=f||(this._elevation?this._elevation.getAtPointOrZero(i.ae.fromLngLat(e)):0),I=i.ae.fromLngLat(e,w),M=[I.x-y.x,I.y-y.y,I.z-y.z];a||(a=[0,0,1]),a[2]=Math.abs(a[2]),this.orientation=Uf(M,a)}setPitchBearing(e,a){this.orientation=fp(i.an(e),i.an(-a))}}class hu{constructor(e,a){this._transform=i.bz([]),this.orientation=a,this.position=e}get mercatorPosition(){const e=this.position;return new i.ae(e[0],e[1],e[2])}get position(){const e=i.c9(this._transform,3);return[e[0],e[1],e[2]]}set position(e){var a;e&&i.cf(this._transform,3,[(a=e)[0],a[1],a[2],1])}get orientation(){return this._orientation}set orientation(e){this._orientation=e||i.c6([]),e&&ih(this._transform,this._orientation)}getPitchBearing(){const e=this.forward(),a=this.right();return{bearing:Math.atan2(-a[1],a[0]),pitch:Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2])}}setPitchBearing(e,a){this._orientation=fp(e,a),ih(this._transform,this._orientation)}forward(){const e=i.c9(this._transform,2);return[-e[0],-e[1],-e[2]]}up(){const e=i.c9(this._transform,1);return[-e[0],-e[1],-e[2]]}right(){const e=i.c9(this._transform,0);return[e[0],e[1],e[2]]}getCameraToWorld(e,a){const f=new Float64Array(16);return i.bk(f,this.getWorldToCamera(e,a)),f}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(e,a,f){const y=this.position;i.c4(y,y,-e);const w=new Float64Array(16);return i.bp(w,[f,f,f]),i.bq(w,w,y),w[10]*=a,w}getWorldToCamera(e,a){const f=new Float64Array(16),y=new Float64Array(4),w=this.position;return i.ca(y,this._orientation),i.c4(w,w,-e),i.cb(f,y),i.bq(f,f,w),f[1]*=-1,f[5]*=-1,f[9]*=-1,f[13]*=-1,f[8]*=a,f[9]*=a,f[10]*=a,f[11]*=a,f}getCameraToClipPerspective(e,a,f,y){const w=new Float64Array(16);return i.cc(w,e,a,f,y),w}getCameraToClipOrthographic(e,a,f,y,w,I){const M=new Float64Array(16);return i.cd(M,e,a,f,y,w,I),M}getDistanceToElevation(e,a=!1){const f=e===0?0:i.ce(e,a?i.a_(this.position[1]):this.position[1]),y=this.forward();return(f-this.position[2])/y[2]}clone(){return new hu([...this.position],[...this.orientation])}}const Ss={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Ks{constructor(e=0,a=0,f=0,y=0){if(isNaN(e)||e<0||isNaN(a)||a<0||isNaN(f)||f<0||isNaN(y)||y<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=a,this.left=f,this.right=y}interpolate(e,a,f){return a.top!=null&&e.top!=null&&(this.top=i.ak(e.top,a.top,f)),a.bottom!=null&&e.bottom!=null&&(this.bottom=i.ak(e.bottom,a.bottom,f)),a.left!=null&&e.left!=null&&(this.left=i.ak(e.left,a.left,f)),a.right!=null&&e.right!=null&&(this.right=i.ak(e.right,a.right,f)),this}getCenter(e,a){const f=i.aA((this.left+e-this.right)/2,0,e),y=i.aA((this.top+a-this.bottom)/2,0,a);return new i.P(f,y)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new Ks(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Ch=15;class Rc{constructor(e,a,f,y,w,I,M){this.tileSize=512,this._renderWorldCopies=w===void 0||w,this._minZoom=e||0,this._maxZoom=a||22,this._minPitch=f??0,this._maxPitch=y??60,this.setProjection(I),this.setMaxBounds(M),this.width=0,this.height=0,this._center=new i.aS(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ks,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new hu,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const e=new Rc(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return e._elevation=this._elevation,e._centerAltitude=this._centerAltitude,e._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,e.tileSize=this.tileSize,e.mercatorFromTransition=this.mercatorFromTransition,e.width=this.width,e.height=this.height,e.cameraElevationReference=this.cameraElevationReference,e._center=this._center,e._setZoom(this.zoom),e._seaLevelZoom=this._seaLevelZoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._nearZ=this._nearZ,e._farZ=this._farZ,e._averageElevation=this._averageElevation,e._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,e._unmodified=this._unmodified,e._edgeInsets=this._edgeInsets.clone(),e._camera=this._camera.clone(),e._calcMatrices(),e.freezeTileCoverage=this.freezeTileCoverage,e.frustumCorners=this.frustumCorners,e._allowWorldUnderZoom=this._allowWorldUnderZoom,e}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Ch}get elevation(){return this._elevation}set elevation(e){this._elevation!==e&&(this._elevation=e,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(e,a=!1){const f=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||f)&&this._updateCameraOnTerrain(),(e||f)&&this._constrainCamera(a),this._calcMatrices()}getProjection(){return i.aH(this.projection,["name","center","parallels"])}setProjection(e){this.projectionOptions=e||{name:"mercator"};const a=this.projection?this.getProjection():void 0;this.projection=i.cl(this.projectionOptions);const f=this.getProjection(),y=!i.bx(a,f);return y&&this._calcMatrices(),this.mercatorFromTransition=!1,y}setOrthographicProjectionAtLowPitch(e){return this._orthographicProjectionAtLowPitch!==e&&(this._orthographicProjectionAtLowPitch=e,this._calcMatrices(),!0)}setMercatorFromTransition(){const e=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=i.cl({name:"mercator"});const a=e!==this.projection.name;return a&&this._calcMatrices(),a}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(e){e===void 0?e=!0:e===null&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get cameraWorldSize(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return i.ce(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new i.P(this.width,this.height)}get bearing(){return i.bS(this.rotation,-180,180)}set bearing(e){this.rotation=e}get rotation(){return-this.angle/Math.PI*180}set rotation(e){const a=-e*Math.PI/180;this.angle!==a&&(this._unmodified=!1,this.angle=a,this._calcMatrices(),this.rotationMatrix=i.cm(),i.cn(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(e){const a=i.aA(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==a&&(this._unmodified=!1,this._pitch=a,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=i.an(e),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const e=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/e)}get averageElevation(){return this._averageElevation}set averageElevation(e){this._averageElevation=e,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(e){const a=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==a&&(this._unmodified=!1,this._setZoom(a),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(e){this._zoom=e,this.scale=this.zoomScale(e),this.tileZoom=Math.floor(e),this.zoomFraction=e-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(e){this._tileCoverLift!==e&&(this._tileCoverLift=e)}_updateCameraOnTerrain(){const e=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,a=this.elevation&&e===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||e===Number.NEGATIVE_INFINITY&&(!a||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const f=this._elevation;a||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&f.exaggeration()&&this._centerAltitudeValidForExaggeration!==f.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*f.exaggeration(),this._centerAltitudeValidForExaggeration=f.exaggeration()):(this._centerAltitude=e||0,this._centerAltitudeValidForExaggeration=f.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const e=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(e)}sampleAverageElevation(){if(!this._elevation)return 0;const e=this._elevation,a=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],f=this.horizonLineFromTop();let y=0,w=0;for(let I=0;I<a.length;I++){const M=new i.P(a[I][0]*this.width,f+a[I][1]*(this.height-f)),L=e.pointCoordinate(M);if(!L)continue;const N=1/Math.hypot(L[0]-this._camera.position[0],L[1]-this._camera.position[1]);y+=L[3]*N,w+=N}return w===0?NaN:y/w}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const e=this._seaLevelZoom,a=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),f=this.pixelsPerMeter/this.worldSize*a,y=this._mercatorZfromZoom(e),w=this._mercatorZfromZoom(this._maxZoom),I=Math.max(y-f,w);this._setZoom(this._zoomFromMercatorZ(I))}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}computeZoomRelativeTo(e){const a=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,e.toAltitude()));let f;f=e.z<this._camera.position[2]?[a.x,a.y,a.z]:[e.x,e.y,e.z];const y=i.ag(i.av([],this._camera.position,f));return i.aA(this._zoomFromMercatorZ(y),this._minZoom,this._maxZoom)}setFreeCameraOptions(e){if(!this.height||!e.position&&!e.orientation)return;this._updateCameraState();let a=!1;if(e.orientation&&!i.co(e.orientation,this._camera.orientation)&&(a=this._setCameraOrientation(e.orientation)),e.position){const f=[e.position.x,e.position.y,e.position.z];i.cp(f,this._camera.position)||(this._setCameraPosition(f),a=!0)}a&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const e=this._camera.position,a=new dc;return a.position=new i.ae(e[0],e[1],e[2]),a.orientation=this._camera.orientation,a._elevation=this.elevation,a._renderWorldCopies=this.renderWorldCopies,a}_setCameraOrientation(e){if(!i.cq(e))return!1;i.cr(e,e);const a=i.cs([],[0,0,-1],e),f=i.cs([],[0,-1,0],e);if(f[2]<0)return!1;const y=Uf(a,f);return!!y&&(this._camera.orientation=y,!0)}_setCameraPosition(e){const a=this.zoomScale(this.minZoom)*this.tileSize,f=this.zoomScale(this.maxZoom)*this.tileSize,y=this.cameraToCenterDistance;e[2]=i.aA(e[2],y/f,y/a),this._camera.position=e}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,a,f){this._unmodified=!1,this._edgeInsets.interpolate(e,a,f),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){const a=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,a)}getVisibleUnwrappedCoordinates(e){const a=[new i.ct(0,e)];if(this.renderWorldCopies){const f=this.pointCoordinate(new i.P(0,0)),y=this.pointCoordinate(new i.P(this.width,0)),w=this.pointCoordinate(new i.P(this.width,this.height)),I=this.pointCoordinate(new i.P(0,this.height)),M=Math.floor(Math.min(f.x,y.x,w.x,I.x)),L=Math.floor(Math.max(f.x,y.x,w.x,I.x)),N=1;for(let V=M-N;V<=L+N;V++)V!==0&&a.push(new i.ct(V,e))}return a}isLODDisabled(e){return(!e||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(e,a,f){let y=[];const w=f!=null,I=!w;if(I&&this.zoom<a||w&&f[0]===0&&f[1]===0)return y;const M=new Set,L=(V,Z,U,X,K)=>{const rt=i.cX(Z,V,U,X,K);M.has(rt)||(y.push(new i.aP(V,Z,U,X,K)),M.add(rt))};for(let V=0;V<e.length;V++){const Z=e[V];if(I&&Z.canonical.z!==a)continue;const U=Z.canonical,X=Z.overscaledZ,K=Z.wrap,rt=1<<U.z,ht=U.x+1<rt,lt=U.x>0,_t=U.y+1<rt,Mt=U.y>0,vt=Z.wrap-(lt?0:1),Ut=Z.wrap+(ht?0:1),Ct=lt?U.x-1:rt-1,$t=ht?U.x+1:0;if(w)f[0]<0?(L(X,Ut,U.z,$t,U.y),f[1]<0&&_t&&(L(X,K,U.z,U.x,U.y+1),L(X,Ut,U.z,$t,U.y+1)),f[1]>0&&Mt&&(L(X,K,U.z,U.x,U.y-1),L(X,Ut,U.z,$t,U.y-1))):f[0]>0?(L(X,vt,U.z,Ct,U.y),f[1]<0&&_t&&(L(X,K,U.z,U.x,U.y+1),L(X,vt,U.z,Ct,U.y+1)),f[1]>0&&Mt&&(L(X,K,U.z,U.x,U.y-1),L(X,vt,U.z,Ct,U.y-1))):f[1]<0&&_t?L(X,K,U.z,U.x,U.y+1):Mt&&L(X,K,U.z,U.x,U.y-1);else{const Ot=Z.visibleQuadrants;1&Ot&&(L(X,vt,U.z,Ct,U.y),Mt&&(L(X,K,U.z,U.x,U.y-1),L(X,vt,U.z,Ct,U.y-1))),2&Ot&&(L(X,Ut,U.z,$t,U.y),Mt&&(L(X,K,U.z,U.x,U.y-1),L(X,Ut,U.z,$t,U.y-1))),4&Ot&&(L(X,vt,U.z,Ct,U.y),_t&&(L(X,K,U.z,U.x,U.y+1),L(X,vt,U.z,Ct,U.y+1))),8&Ot&&(L(X,Ut,U.z,$t,U.y),_t&&(L(X,K,U.z,U.x,U.y+1),L(X,Ut,U.z,$t,U.y+1)))}}const N=[];for(const V of y)y.some(Z=>V.isChildOf(Z))||N.push(V);if(y=N.filter(V=>!e.some(Z=>!!(V.overscaledZ<a&&Z.isChildOf(V))||V.equals(Z)||V.isChildOf(Z))),I){const V=1<<a,Z=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),U=[V*Z.x,V*Z.y],X=4,K=X*X;y=y.filter(rt=>{const ht=rt.canonical.x+.5-U[0],lt=rt.canonical.y+.5-U[1];return ht*ht+lt*lt<K})}return y}extendTileCoverToNearPlane(e,a,f){const y=[],w=new Set;for(const _t of e)w.add(_t.key);const I=(_t,Mt,vt,Ut,Ct)=>{const $t=i.cX(Mt,_t,vt,Ut,Ct);w.has($t)||(y.push(new i.aP(_t,Mt,vt,Ut,Ct)),w.add($t))},M=e.reduce((_t,Mt)=>Math.max(_t,Mt.overscaledZ),f),L=1<<f,N=[new i.P(0,0),new i.P(i.al,0),new i.P(i.al,i.al),new i.P(0,i.al)],V=new i.P(0,0),Z=new i.P(0,0),U=(_t,Mt)=>{const vt=Math.floor(_t[0]),Ut=Math.floor(_t[1]),Ct=(_t[0]-vt)*i.al,$t=(_t[1]-Ut)*i.al,Ot=Math.floor(Mt[0]),Rt=Math.floor(Mt[1]),Zt=(Mt[0]-Ot)*i.al,pe=(Mt[1]-Rt)*i.al;for(let le=-1;le<=1;le++){const Me=vt+le;if(!(Me<0||Me>=L)){V.x=Ct-le*i.al,Z.x=Zt-(Me-Ot)*i.al;for(let ve=-1;ve<=1;ve++){const Be=Ut+ve;V.y=$t-ve*i.al,Z.y=pe-(Be-Rt)*i.al,i.cY(V,Z,N)&&I(M,0,f,Me,Be)}}}},X=a.points,K=X[i.cu],rt=X[i.cv],ht=this._projectToGround(K,X[i.cw]),lt=this._projectToGround(rt,X[i.cx]);return U(K,ht),U(rt,lt),y}_projectToGround(e,a){return i.cy(i.cz(),e,a,e[2]/(e[2]-a[2]))}coveringTiles(e){let a=this.coveringZoomLevel(e);const f=a,y=this.elevation&&this.elevation.exaggeration(),w=y&&!e.isTerrainDEM,I=this.projection.name==="mercator";if(e.minzoom!==void 0&&a<e.minzoom)return[];e.maxzoom!==void 0&&a>e.maxzoom&&(a=e.maxzoom);const M=this.locationCoordinate(this.center),L=this.center.lat,N=1<<a,V=[N*M.x,N*M.y,0],Z=this.projection.name==="globe",U=!Z,X=i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,a,U),K=Z?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),rt=N*i.ce(1,this.center.lat),ht=this._camera.position[2]/i.ce(1,this.center.lat),lt=[N*K.x,N*K.y,ht*(U?1:rt)],_t=Z||y,Mt=this.cameraToCenterDistance/e.tileSize*(e.roundZoom?1:.502),vt=this.isLODDisabled(!0)?a:0;let Ut;if(this._elevation&&e.isTerrainDEM)Ut=1e4*this._elevation.exaggeration();else if(this._elevation){const ie=this._elevation.getMinMaxForVisibleTiles();Ut=ie?ie.max:this._centerAltitude}else Ut=this._centerAltitude;const Ct=e.isTerrainDEM?-Ut:this._elevation?this._elevation.getMinElevationBelowMSL():0,$t=this.projection.isReprojectedInTileSpace?i.cB(this):1,Ot=ie=>{const Te=new i.ae(ie.x+25e-6,ie.y,ie.z),qe=new i.ae(ie.x,ie.y+25e-6,ie.z),si=ie.toLngLat(),Li=Te.toLngLat(),ni=qe.toLngLat(),li=this.locationCoordinate(si),Fi=this.locationCoordinate(Li),Si=this.locationCoordinate(ni),xi=Math.hypot(Fi.x-li.x,Fi.y-li.y),Ai=Math.hypot(Si.x-li.x,Si.y-li.y);return Math.sqrt(xi*Ai)*$t/25e-6},Rt=ie=>{const Oe=Ut,Te=Ct;return{aabb:i.cE(this,N,0,0,0,ie,Te,Oe,this.projection),zoom:0,x:0,y:0,minZ:Te,maxZ:Oe,wrap:ie,fullyVisible:!1}},Zt=[];let pe=[];const le=a,Me=e.reparseOverscaled?f:a,ve=(ht-this._centerAltitude)*rt,Be=ie=>{if(!this._elevation||!ie.tileID||!I)return;const Oe=this._elevation.getMinMaxForTile(ie.tileID),Te=ie.aabb;Oe?(Te.min[2]=Oe.min,Te.max[2]=Oe.max,Te.center[2]=(Te.min[2]+Te.max[2])/2):(ie.shouldSplit=ge(ie),ie.shouldSplit||(Te.min[2]=Te.max[2]=Te.center[2]=this._centerAltitude))},oi=(ie,Oe)=>{if(.707*Oe<ie)return 1;const Te=Oe/ie;return Te/(1.4144271570014144+(Math.pow(1.1,Te-1.4144271570014144+1)-1)/(1.1-1)-1)},ge=ie=>{if(ie.zoom<vt)return!0;if(ie.zoom===le)return!1;if(ie.shouldSplit!=null)return ie.shouldSplit;const Oe=ie.aabb.distanceX(lt),Te=ie.aabb.distanceY(lt);let qe=ve,si=1;if(Z){qe=ie.aabb.distanceZ(lt);const Ai=Math.pow(2,ie.zoom),Wi=i.a_((ie.y+1)/Ai),Gr=i.a_(ie.y/Ai),en=Math.min(Math.max(L,Wi),Gr),kn=i.d0(en)/i.d0(L);if(si=en===L?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,kn/this._mercatorScaleRatio),this.zoom<=i.cZ&&ie.zoom===le-1&&kn>=.9)return!0}else if(w&&(qe=ie.aabb.distanceZ(lt)*rt),this.projection.isReprojectedInTileSpace&&f<=5){const Ai=Math.pow(2,ie.zoom),Wi=Ot(new i.ae((ie.x+.5)/Ai,(ie.y+.5)/Ai));si=Wi>.85?1:Wi}if(!I&&!Z){const Ai=Math.sqrt(Oe*Oe+Te*Te+qe*qe);let Wi=(1<<le-ie.zoom)*Mt*si;return Wi*=oi(Math.max(qe,ve),Ai),Ai<Wi}let Li=Number.MAX_VALUE,ni=0;const li=ie.aabb.getCorners(),Fi=[];for(const Ai of li){i.av(Fi,Ai,lt),Z||(w?Fi[2]*=rt:Fi[2]=ve);const Wi=i.bI(Fi,this._camera.forward());Wi<Li&&(Li=Wi,ni=Math.abs(Fi[2]))}let Si=(1<<le-ie.zoom)*Mt*si;if(Si*=oi(Math.max(ni,ve),Li),Li<Si)return!0;const xi=ie.aabb.closestPoint(V);return xi[0]===V[0]&&xi[1]===V[1]};if(this.renderWorldCopies)for(let ie=1;ie<=3;ie++)Zt.push(Rt(-ie)),Zt.push(Rt(ie));for(Zt.push(Rt(0));Zt.length>0;){const ie=Zt.pop(),Oe=ie.x,Te=ie.y;let qe=ie.fullyVisible;const si=()=>this.projection.name==="globe"&&(ie.y===0||ie.y===(1<<ie.zoom)-1);if(!qe){let Li=_t?ie.aabb.intersects(X):ie.aabb.intersectsFlat(X);if(Li===0&&si()){const ni=new i.cC(ie.zoom,Oe,Te);Li=i.cD(this,N,ni,!0).intersects(X)}if(Li===0)continue;qe=Li===2}if(ie.zoom!==le&&ge(ie))for(let Li=0;Li<4;Li++){const ni=(Oe<<1)+Li%2,li=(Te<<1)+(Li>>1),Fi={aabb:I?ie.aabb.quadrant(Li):i.cE(this,N,ie.zoom+1,ni,li,ie.wrap,ie.minZ,ie.maxZ,this.projection),zoom:ie.zoom+1,x:ni,y:li,wrap:ie.wrap,fullyVisible:qe,tileID:void 0,shouldSplit:void 0,minZ:ie.minZ,maxZ:ie.maxZ};w&&!Z&&(Fi.tileID=new i.aP(ie.zoom+1===le?Me:ie.zoom+1,ie.wrap,ie.zoom+1,ni,li),Be(Fi)),Zt.push(Fi)}else{const Li=ie.zoom===le?Me:ie.zoom;if(e.minzoom&&e.minzoom>Li)continue;let ni=0;if(!qe){let xi=_t?ie.aabb.intersectsPrecise(X):ie.aabb.intersectsPreciseFlat(X);if(xi===0&&si()){const Ai=new i.cC(ie.zoom,Oe,Te);xi=i.cD(this,N,Ai,!0).intersectsPrecise(X)}if(xi===0)continue;if(e.calculateQuadrantVisibility)if(X.containsPoint(ie.aabb.center))ni=15;else for(let Ai=0;Ai<4;Ai++)ie.aabb.quadrant(Ai).intersects(X)!==0&&(ni|=1<<Ai)}const li=V[0]-(.5+Oe+(ie.wrap<<ie.zoom))*(1<<a-ie.zoom),Fi=V[1]-.5-Te,Si=ie.tileID?ie.tileID:new i.aP(Li,ie.wrap,ie.zoom,Oe,Te);e.calculateQuadrantVisibility&&(Si.visibleQuadrants=ni),pe.push({tileID:Si,distanceSq:li*li+Fi*Fi})}}if(this.fogCullDistSq){const ie=this.fogCullDistSq,Oe=this.horizonLineFromTop();pe=pe.filter(Te=>{const qe=[0,0,0,1],si=[i.al,i.al,0,1],Li=this.calculateFogTileMatrix(Te.tileID.toUnwrapped());i.aC(qe,qe,Li),i.aC(si,si,Li);const ni=i.cF([],qe,si),li=i.cG([],qe,si),Fi=i.c_(ni,li);if(Fi===0)return!0;let Si=!1;const xi=this._elevation;if(xi&&Fi>ie&&Oe!==0){const Ai=this.calculateProjMatrix(Te.tileID.toUnwrapped());let Wi;e.isTerrainDEM||(Wi=xi.getMinMaxForTile(Te.tileID)),Wi||(Wi={min:Ct,max:Ut});const Gr=i.cH(this.rotation),en=[Gr[0]*i.al,Gr[1]*i.al,Wi.max];i.af(en,en,Ai),Si=(1-en[1])*this.height*.5<Oe}return Fi<ie||Si})}return pe.sort((ie,Oe)=>ie.distanceSq-Oe.distanceSq).map(ie=>ie.tileID)}resize(e,a){this.width=e,this.height=a,this.pixelsToGLUnits=[2/e,-2/a],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log2(e)}project(e){const a=i.aA(e.lat,-i.cI,i.cI),f=this.projection.project(e.lng,a);return new i.P(f.x*this.worldSize,f.y*this.worldSize)}unproject(e){return this.projection.unproject(e.x/this.worldSize,e.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/i.ce(1,this.center.lat)/this.worldSize}setLocationAtPoint(e,a){let f,y;const w=this.centerPoint;if(this.projection.name==="globe"){const M=this.worldSize;f=(a.x-w.x)/M,y=(a.y-w.y)/M}else{const M=this.pointCoordinate(a),L=this.pointCoordinate(w);f=M.x-L.x,y=M.y-L.y}const I=this.locationCoordinate(e);this.setLocation(new i.ae(I.x-f,I.y-y))}setLocation(e){this.center=this.coordinateLocation(e),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(e,a){return this.projection.locationPoint(this,e,a)}locationPoint3D(e,a){return this.projection.locationPoint(this,e,a,!0)}pointLocation(e){return this.coordinateLocation(this.pointCoordinate(e))}pointLocation3D(e,a){return this.coordinateLocation(this.pointCoordinate3D(e,a))}locationCoordinate(e,a){const f=a?i.ce(a,e.lat):void 0,y=this.projection.project(e.lng,e.lat);return new i.ae(y.x,y.y,f)}coordinateLocation(e){return this.projection.unproject(e.x,e.y)}pointRayIntersection(e,a){const f=a??this._centerAltitude,y=[e.x,e.y,0,1],w=[e.x,e.y,1,1];i.aC(y,y,this.pixelMatrixInverse),i.aC(w,w,this.pixelMatrixInverse);const I=w[3];i.cJ(y,y,1/y[3]),i.cJ(w,w,1/I);const M=y[2],L=w[2];return{p0:y,p1:w,t:M===L?0:(f-M)/(L-M)}}screenPointToMercatorRay(e){const a=[e.x,e.y,0,1],f=[e.x,e.y,1,1];return i.aC(a,a,this.pixelMatrixInverse),i.aC(f,f,this.pixelMatrixInverse),i.cJ(a,a,1/a[3]),i.cJ(f,f,1/f[3]),a[2]=i.ce(a[2],this._center.lat)*this.worldSize,f[2]=i.ce(f[2],this._center.lat)*this.worldSize,i.cJ(a,a,1/this.worldSize),i.cJ(f,f,1/this.worldSize),new i.ax([a[0],a[1],a[2]],i.aw([],i.av([],f,a)))}rayIntersectionCoordinate(e){const{p0:a,p1:f,t:y}=e,w=i.ce(a[2],this._center.lat),I=i.ce(f[2],this._center.lat);return new i.ae(i.ak(a[0],f[0],y)/this.worldSize,i.ak(a[1],f[1],y)/this.worldSize,i.ak(w,I,y))}pointCoordinate(e,a=this._centerAltitude){return this.projection.pointCoordinate(this,e.x,e.y,a)}pointCoordinate3D(e,a){if(!this.elevation)return this.pointCoordinate(e,a);let f=this.projection.pointCoordinate3D(this,e.x,e.y);if(f)return new i.ae(f[0],f[1],f[2]);let y=0,w=this.horizonLineFromTop();if(e.y>w)return this.pointCoordinate(e,a);const I=.02*w,M=e.clone();for(let L=0;L<10&&w-y>I;L++){M.y=i.ak(y,w,.66);const N=this.projection.pointCoordinate3D(this,M.x,M.y);N?(w=M.y,f=N):y=M.y}return f?new i.ae(f[0],f[1],f[2]):this.pointCoordinate(e)}isPointAboveHorizon(e){return this.projection.isPointAboveHorizon(this,e)}isPointOnSurface(e){if(e.y<0||e.y>this.height||e.x<0||e.x>this.width)return!1;if(this.elevation||this.zoom>=i.cK)return!this.isPointAboveHorizon(e);const a=this.pointCoordinate(e);return a.y>=0&&a.y<=1}_coordinatePoint(e,a){const f=a&&this.elevation?this.elevation.getAtPointOrZero(e,this._centerAltitude):this._centerAltitude,y=[e.x*this.worldSize,e.y*this.worldSize,f+e.toAltitude(),1];return i.aC(y,y,this.pixelMatrix),y[3]>0?new i.P(y[0]/y[3],y[1]/y[3]):new i.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:e,left:a}=this._edgeInsets,f=this.height-this._edgeInsets.bottom,y=this.width-this._edgeInsets.right,w=this.pointLocation3D(new i.P(a,e)),I=this.pointLocation3D(new i.P(y,e)),M=this.pointLocation3D(new i.P(y,f)),L=this.pointLocation3D(new i.P(a,f));let N=Math.min(w.lng,I.lng,M.lng,L.lng),V=Math.max(w.lng,I.lng,M.lng,L.lng),Z=Math.min(w.lat,I.lat,M.lat,L.lat),U=Math.max(w.lat,I.lat,M.lat,L.lat);const X=Math.pow(2,-this.zoom)/16*270,K=this.projection.name==="globe"?1:4,rt=(ht,lt,_t,Mt,vt)=>{const Ut=(ht+_t)/2,Ct=(lt+Mt)/2,$t=new i.P(Ut,Ct),{lng:Ot,lat:Rt}=this.pointLocation3D($t),Zt=Math.max(0,N-Ot,Z-Rt,Ot-V,Rt-U);N=Math.min(N,Ot),V=Math.max(V,Ot),Z=Math.min(Z,Rt),U=Math.max(U,Rt),(vt<K||Zt>X)&&(rt(ht,lt,Ut,Ct,vt+1),rt(Ut,Ct,_t,Mt,vt+1))};if(rt(a,e,y,e,1),rt(y,e,y,f,1),rt(y,f,a,f,1),rt(a,f,a,e,1),this.projection.name==="globe"){const[ht,lt]=i.cL(this);ht?(U=90,V=180,N=-180):lt&&(Z=-90,V=180,N=-180)}return new i.aI(new i.aS(N,Z),new i.aS(V,U))}_getBoundsRectangular(e,a){const{top:f,left:y}=this._edgeInsets,w=this.height-this._edgeInsets.bottom,I=this.width-this._edgeInsets.right,M=new i.P(y,f),L=new i.P(I,f),N=new i.P(I,w),V=new i.P(y,w);let Z=this.pointCoordinate(M,e),U=this.pointCoordinate(L,e);const X=this.pointCoordinate(N,a),K=this.pointCoordinate(V,a),rt=(ht,lt)=>(lt.y-ht.y)/(lt.x-ht.x);return Z.y>1&&U.y>=0?Z=new i.ae((1-K.y)/rt(K,Z)+K.x,1):Z.y<0&&U.y<=1&&(Z=new i.ae(-K.y/rt(K,Z)+K.x,0)),U.y>1&&Z.y>=0?U=new i.ae((1-X.y)/rt(X,U)+X.x,1):U.y<0&&Z.y<=1&&(U=new i.ae(-X.y/rt(X,U)+X.x,0)),new i.aI().extend(this.coordinateLocation(Z)).extend(this.coordinateLocation(U)).extend(this.coordinateLocation(K)).extend(this.coordinateLocation(X))}_getBoundsRectangularTerrain(){const e=this.elevation;if(!e.visibleDemTiles.length||e.isUsingMockSource())return this._getBoundsRectangular(0,0);const a=e.visibleDemTiles.reduce((f,y)=>{if(y.dem){const w=y.dem.tree;f.min=Math.min(f.min,w.minimums[0]),f.max=Math.max(f.max,w.maximums[0])}return f},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(a.min*e.exaggeration(),a.max*e.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(e=!0){const a=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,f=this.height/2-a*(1-this._horizonShift);return e?Math.max(0,f):f}getMaxBounds(){return this.maxBounds}setMaxBounds(e){this.maxBounds=e,this.minLat=-i.cI,this.maxLat=i.cI,this.minLng=-180,this.maxLng=180,e&&(this.minLat=e.getSouth(),this.maxLat=e.getNorth(),this.minLng=e.getWest(),this.maxLng=e.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=i.aF(this.minLng)*this.tileSize,this.worldMaxX=i.aF(this.maxLng)*this.tileSize,this.worldMinY=i.aJ(this.maxLat)*this.tileSize,this.worldMaxY=i.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(e,a){return this.projection.createTileMatrix(this,a,e)}calculateDistanceTileData(e){const a=e.key,f=this._distanceTileDataCache;if(f[a])return f[a];const y=e.canonical,w=1/this.height,I=this.cameraWorldSize,M=I/this.zoomScale(y.z),L=(y.x+Math.pow(2,y.z)*e.wrap)*M,N=y.y*M,V=this.point;V.x*=I/this.worldSize,V.y*=I/this.worldSize;const Z=this.angle,U=Math.sin(-Z),X=-Math.cos(-Z);return f[a]={bearing:[U,X],center:[(V.x-L)*w,(V.y-N)*w],scale:M/i.al*w},f[a]}calculateFogTileMatrix(e){const a=e.key,f=this._fogTileMatrixCache;if(f[a])return f[a];const y=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,e);return i.aB(y,this.worldToFogMatrix,y),f[a]=new Float32Array(y),f[a]}calculateProjMatrix(e,a=!1,f=!1){const y=e.key;let w;if(w=f?this._expandedProjMatrixCache:a?this._alignedProjMatrixCache:this._projMatrixCache,w[y])return w[y];const I=this.calculatePosMatrix(e,this.worldSize);let M;return M=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:f?this.expandedFarZProjMatrix:a?this.alignedProjMatrix:this.projMatrix,i.aB(I,M,I),w[y]=new Float32Array(I),w[y]}calculatePixelsToTileUnitsMatrix(e){const a=e.tileID.key,f=this._pixelsToTileUnitsCache;if(f[a])return f[a];const y=i.cM(e,this);return f[a]=y,f[a]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const e=1/this.worldSize,a=i.bp([],[e,e,e]);return i.aB(a,a,this.globeMatrix),a}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const e=this._elevation;this._updateCameraState();const a=i.ce(1,this._center.lat)*this.worldSize,f=this._computeCameraPosition(a),y=this._camera.forward(),w=i.ce(1,this._center.lat);f[2]/=w,y[2]/=w,i.aw(y,y);const I=e.raycast(f,y,e.exaggeration());if(I){const M=i.bG([],f,y,I),L=new i.ae(M[0],M[1],i.ce(M[2],i.a_(M[1]))),N=(L.z+i.ag([L.x-f[0],L.y-f[1],L.z-f[2]*w]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(N),this._centerAltitude=L.toAltitude(),this._center=this.coordinateLocation(L),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(e=!1){if(!this._elevation)return;const a=this._elevation,f=i.ce(1,this._center.lat)*this.worldSize,y=this._computeCameraPosition(f),w=a.getAtPointOrZero(new i.ae(...y)),I=this.pixelsPerMeter/this.worldSize*w,M=this._minimumHeightOverTerrain(),L=y[2]-I;if(L<=M)if(L<0||e){const N=this.locationCoordinate(this._center,this._centerAltitude),V=[y[0],y[1],N.z-y[2]],Z=i.ag(V);V[2]-=(M-L)/this._pixelsPerMercatorPixel;const U=i.ag(V);if(U===0)return;i.c4(V,V,Z/U*this._pixelsPerMercatorPixel),this._camera.position=[y[0],y[1],N.z*this._pixelsPerMercatorPixel-V[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const e=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||e){const U=this.center;return U.lat=i.aA(U.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!e)&&(U.lng=i.aA(U.lng,this.minLng,this.maxLng)),this.center=U,void(this._constraining=!1)}const a=this._unmodified,{x:f,y}=this.point;let w=0,I=f,M=y;const L=this.width/2,N=this.height/2,V=this.worldMinY*this.scale,Z=this.worldMaxY*this.scale;if(y-N<V&&(M=V+N),y+N>Z&&(M=Z-N),Z-V<this.height&&(w=Math.max(w,this.height/(Z-V)),M=(Z+V)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const U=this.worldMinX*this.scale,X=this.worldMaxX*this.scale,K=this.worldSize/2-(U+X)/2;I=(f+K+this.worldSize)%this.worldSize-K,I-L<U&&(I=U+L),I+L>X&&(I=X-L),X-U<this.width&&(w=Math.max(w,this.width/(X-U)),I=(X+U)/2)}I===f&&M===y||this._allowWorldUnderZoom||(this.center=this.unproject(new i.P(I,M))),w&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(w)),this._constrainCamera(),this._unmodified=a,this._constraining=!1}_minZoomForBounds(){let e=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(e=Math.max(e,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),e}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const e=this.centerOffset,a=this.projection.name==="globe",f=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=i.ce(1,this.center.lat)/i.ce(1,i.d1));const y=i.cN(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,y),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const w=this.projection.zAxisUnit==="meters"?f:1,I=this._camera.getWorldToCamera(this.worldSize,w);let M;const L=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(L[8]=2*-e.x/this.width,L[9]=2*e.y/this.height,this.isOrthographic){let Rt=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Zt=Rt*this.aspect,pe=-Zt,le=-Rt;Zt-=e.x,pe-=e.x,Rt+=e.y,le+=e.y,M=this._camera.getCameraToClipOrthographic(pe,Zt,le,Rt,this._nearZ,this._farZ),((Me,ve,Be,oi)=>{for(let ge=0;ge<16;ge++)Me[ge]=i.ak(ve[ge],Be[ge],oi)})(M,M,L,i.c$(this.pitch>=Ch?1:this.pitch/Ch))}else M=L;const N=i.cO([],L,I);let V=i.cO([],M,I);if(this.projection.isReprojectedInTileSpace){const Rt=this.locationCoordinate(this.center),Zt=i.bz([]);i.bq(Zt,Zt,[Rt.x*this.worldSize,Rt.y*this.worldSize,0]),i.aB(Zt,Zt,i.cP(this)),i.bq(Zt,Zt,[-Rt.x*this.worldSize,-Rt.y*this.worldSize,0]),i.aB(V,V,Zt),i.aB(N,N,Zt),this.inverseAdjustmentMatrix=i.cQ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=i.cR([],V,[this.worldSize,this.worldSize,this.worldSize/w,1]),this.projMatrix=V,this.invProjMatrix=i.bk(new Float64Array(16),this.projMatrix),a){const Rt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Rt[8]=2*-e.x/this.width,Rt[9]=2*e.y/this.height,this.expandedFarZProjMatrix=i.cO([],Rt,I)}else this.expandedFarZProjMatrix=this.projMatrix;const Z=i.bk([],M);this.frustumCorners=i.cS.fromInvProjectionMatrix(Z,this.horizonLineFromTop(),this.height),this.cameraFrustum=i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!a);const U=new Float32Array(16);i.bz(U),i.cR(U,U,[1,-1,1]),i.cT(U,U,this._pitch),i.bA(U,U,this.angle);const X=i.cc(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=i.by(X);const K=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;X[8]=2*-e.x/this.width,X[9]=2*(e.y+K)/this.height,this.skyboxMatrix=i.aB(U,X,U);const rt=this.point,ht=rt.x,lt=rt.y,_t=this.width%2/2,Mt=this.height%2/2,vt=Math.cos(this.angle),Ut=Math.sin(this.angle),Ct=ht-Math.round(ht)+vt*_t+Ut*Mt,$t=lt-Math.round(lt)+vt*Mt+Ut*_t,Ot=new Float64Array(V);if(i.bq(Ot,Ot,[Ct>.5?Ct-1:Ct,$t>.5?$t-1:$t,0]),this.alignedProjMatrix=Ot,V=i.bB(),i.cR(V,V,[this.width/2,-this.height/2,1]),i.bq(V,V,[1,-1,0]),this.labelPlaneMatrix=V,V=i.bB(),i.cR(V,V,[1,-1,1]),i.bq(V,V,[-1,-1,0]),i.cR(V,V,[2/this.width,2/this.height,1]),this.glCoordMatrix=V,this.pixelMatrix=i.aB(new Float64Array(16),this.labelPlaneMatrix,N),this._calcFogMatrices(),this._distanceTileDataCache={},V=i.bk(new Float64Array(16),this.pixelMatrix),!V)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=V,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=i.cU(this);const Rt=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=i.af(Rt,Rt,I),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=V;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const e=this.cameraWorldSizeForFog,a=this.cameraPixelsPerMeter,f=this._camera.position,y=1/this.height/this._pixelsPerMercatorPixel,w=[e,e,a];i.c4(w,w,y),i.c4(f,f,-1),i.cV(f,f,w);const I=i.bB();i.bq(I,I,f),i.cR(I,I,w),this.mercatorFogMatrix=I,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(e,a,y)}_computeCameraPosition(e){const a=(e=e||this.pixelsPerMeter)/this.pixelsPerMeter,f=this._camera.forward(),y=this.point,w=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*a-e/this.worldSize*this._centerAltitude;return[y.x/this.worldSize-f[0]*w,y.y/this.worldSize-f[1]*w,e/this.worldSize*this._centerAltitude-f[2]*w]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(e){const a=this._maxCameraBoundsDistance()*Math.cos(this._pitch),f=this._camera.position[2],y=e[2];let w=1;this.projection.wrap&&(this.center=this.center.wrap()),y>0&&(w=Math.min((a-f)/y,1)),this._camera.position=i.bG([],this._camera.position,e,w),this._updateStateFromCamera()}_updateStateFromCamera(){const e=this._camera.position,a=this._camera.forward(),{pitch:f,bearing:y}=this._camera.getPitchBearing(),w=i.ce(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,I=this._mercatorZfromZoom(this._maxZoom)*Math.cos(i.an(this._maxPitch)),M=Math.max((e[2]-w)/Math.cos(f),I),L=this._zoomFromMercatorZ(M);i.bG(e,e,a,M),this._pitch=i.aA(f,i.an(this.minPitch),i.an(this.maxPitch)),this.angle=i.bS(y,-Math.PI,Math.PI),this._setZoom(i.aA(L,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new i.ae(e[0],e[1],e[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(e){return Math.pow(2,e)*this.tileSize}_mercatorZfromZoom(e){return this.cameraToCenterDistance/this._worldSizeFromZoom(e)}_minimumHeightOverTerrain(){const e=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(e)}_zoomFromMercatorZ(e){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,e)*this.tileSize))}zoomFromMercatorZAdjusted(e){let a=0,f=i.cK,y=0,w=1/0;for(;f-a>1e-6&&f>a;){const I=a+.5*(f-a),M=this.tileSize*Math.pow(2,I),L=this.getCameraToCenterDistance(this.projection,I,M),N=this.scaleZoom(L/(Math.max(0,e)*this.tileSize)),V=Math.abs(I-N);V<w&&(w=V,y=I),I<N?a=I:f=I}return y}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(i.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(e,a){const f=Math.min(e.x,a.x),y=Math.max(e.x,a.x),w=Math.min(e.y,a.y),I=Math.max(e.y,a.y);if(w<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const M=[new i.P(f,w),new i.P(y,I),new i.P(f,I),new i.P(y,w)],L=this.renderWorldCopies?-3:0,N=this.renderWorldCopies?4:1;for(const V of M){const Z=this.pointRayIntersection(V);if(Z.t<0)return!0;const U=this.rayIntersectionCoordinate(Z);if(U.x<L||U.y<0||U.x>N||U.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+i.cW(this.fovAboveCenter)>88||this.anyCornerOffEdge(new i.P(0,0),new i.P(this.width,this.height))}zoomDeltaToMovement(e,a){const f=i.ag(i.av([],this._camera.position,e)),y=this._zoomFromMercatorZ(f)+a;return f-this._mercatorZfromZoom(y)}getCameraPoint(){if(this.projection.name==="globe"){const e=function([a,f,y],w){const I=[a,f,y,1];i.aC(I,I,w);const M=I[3]=Math.max(I[3],1e-6);return I[0]/=M,I[1]/=M,I[2]/=M,I}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new i.P(e[0],e[1])}{const e=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new i.P(0,e))}}getCameraToCenterDistance(e,a=this.zoom,f=this.worldSize){const y=i.cN(e,a,this.width,this.height,1024),w=e.pixelSpaceConversion(this.center.lat,f,y);let I=.5/Math.tan(.5*this._fov)*this.height*w;return this.isOrthographic&&(I=i.ak(1,I,i.c$(this.pitch>=Ch?1:this.pitch/Ch))),I}getWorldToCameraMatrix(){const e=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&i.aB(e,e,this.globeMatrix),e}getFrustum(e){return i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,e,this.projection.zAxisUnit==="meters")}}const ha=(p,e)=>{if(e>0&&p.terrain&&i.w("Cutoff is currently disabled on terrain"),e<=0||p.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const a=p.transform,f=Math.max(Math.abs(a._zoom-(p.minCutoffZoom-1)),1),y=a.isLODDisabled(!1)?i.ah(60,45,a.pitch):i.ah(30,15,a.pitch),w=a._farZ-a._nearZ,I=e*a.height,M=((1-(L=y))*a.cameraToCenterDistance+L*(a._farZ+I))*f;var L;return{shouldRenderCutoff:y<1,uniformValues:{u_cutoff_params:[a._nearZ,a._farZ,(M-a._nearZ)/w,(M-I-a._nearZ)/w]}}},Is={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class uf{constructor(e,a){this.aabb=e,this.lastCascade=a}}class df{add(e,a){const f=this.receivers[e.key];f!==void 0?(f.aabb.min[0]=Math.min(f.aabb.min[0],a.min[0]),f.aabb.min[1]=Math.min(f.aabb.min[1],a.min[1]),f.aabb.min[2]=Math.min(f.aabb.min[2],a.min[2]),f.aabb.max[0]=Math.max(f.aabb.max[0],a.max[0]),f.aabb.max[1]=Math.max(f.aabb.max[1],a.max[1]),f.aabb.max[2]=Math.max(f.aabb.max[2],a.max[2])):this.receivers[e.key]=new uf(a,null)}clear(){this.receivers={}}get(e){return this.receivers[e.key]}computeRequiredCascades(e,a,f){const y=i.d8.fromPoints(e.points);let w=0;for(const I in this.receivers){const M=this.receivers[I];if(!M||!y.intersectsAabb(M.aabb))continue;M.aabb.min=y.closestPoint(M.aabb.min),M.aabb.max=y.closestPoint(M.aabb.max);const L=M.aabb.getCorners();for(let N=0;N<f.length;N++){let V=!0;for(const Z of L){const U=[Z[0]*a,Z[1]*a,Z[2]];if(i.af(U,U,f[N].matrix),U[0]<-1||U[0]>1||U[1]<-1||U[1]>1){V=!1;break}}if(M.lastCascade=N,w=Math.max(w,N),V)break}}return w+1}}class uu{constructor(e){this.painter=e,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new df,this._depthMode=new ki(e.context.gl.LEQUAL,ki.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,e.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),e.tp.registerParameter(Is,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),e.tp.registerParameter(Is,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),e.tp.registerParameter(Is,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),e.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const e of this._cascades)e.texture.destroy(),e.framebuffer.destroy();this._cascades=[]}updateShadowParameters(e,a){const f=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!a||!a.properties)return;const y=a.properties.get("shadow-intensity");if(!a.shadowsEnabled()||y<=0||(this._shadowLayerCount=f.style.order.reduce((K,rt)=>{const ht=f.style._mergedLayers[rt];return K+(ht.hasShadowPass()&&!ht.isHidden(e.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const w=f.context,I=Is.shadowMapResolution,M=Is.shadowMapResolution;if(this._cascades.length===0||Is.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let K=0;K<Is.cascadeCount;++K){const rt=f._shadowMapDebug,ht=w.gl,lt=w.createFramebuffer(I,M,rt,"texture"),_t=new i.T(w,{width:I,height:M,data:null},ht.DEPTH_COMPONENT16);if(lt.depthAttachment.set(_t.texture),rt){const Mt=new i.T(w,{width:I,height:M,data:null},ht.RGBA8);lt.colorAttachment.set(Mt.texture)}this._cascades.push({framebuffer:lt,texture:_t,matrix:[],far:0,boundingSphereRadius:0,frustum:new i.cA,scale:0})}}this.shadowDirection=Dh(a);let L=0;if(e.elevation){const K=e.elevation,rt=[1e4,-1e4];K.visibleDemTiles.filter(ht=>ht.dem).forEach(ht=>{const lt=ht.dem.tree;rt[0]=Math.min(rt[0],lt.minimums[0]),rt[1]=Math.max(rt[1],lt.maximums[0])}),rt[0]!==1e4&&(L=(rt[1]-rt[0])*K.exaggeration())}const N=1.5*e.cameraToCenterDistance,V=3*N,Z=new Float64Array(16);for(let K=0;K<this._cascades.length;++K){const rt=this._cascades[K];let ht=e.height/50,lt=1;Is.cascadeCount===1?lt=V:K===0?lt=N:(ht=N,lt=V);const[_t,Mt]=jf(e,this.shadowDirection,ht,lt,Is.shadowMapResolution,L);rt.scale=e.scale,rt.matrix=_t,rt.boundingSphereRadius=Mt,i.bk(Z,rt.matrix),rt.frustum=i.cA.fromInvProjectionMatrix(Z,1,0,!0),rt.far=lt}const U=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[U].far,this._cascades[U].far],this._uniformValues.u_shadow_intensity=y,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Is.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Is.shadowMapResolution,this._uniformValues.u_shadowmap_0=Ss.ShadowMap0,this._uniformValues.u_shadowmap_1=Ss.ShadowMap0+1,this._groundShadowTiles=f.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const X=f.transform.elevation;for(const K of this._groundShadowTiles){let rt={min:0,max:0};if(X){const ht=X.getMinMaxForTile(K);ht&&(rt=ht)}this.addShadowReceiver(K.toUnwrapped(),rt.min,rt.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(e){this._enabled=e}drawShadowPass(e,a){if(!this.enabled)return;const f=this.painter,y=f.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(f.transform.getFrustum(0),f.transform.worldSize,this._cascades),y.viewport.set([0,0,Is.shadowMapResolution,Is.shadowMapResolution]);for(let w=0;w<this._numCascadesToRender;++w){f.currentShadowCascade=w,y.bindFramebuffer.set(this._cascades[w].framebuffer.framebuffer),y.clear({color:i.ao.white,depth:1});for(const I of e.order){const M=e._mergedLayers[I];if(!M.hasShadowPass()||M.isHidden(f.transform.zoom))continue;const L=e.getLayerSourceCache(M),N=L?a[L.id]:void 0;(M.type==="model"||N&&N.length)&&f.renderLayer(f,L,M,N)}}f.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const e=this.painter,a=e.style,f=e.context,y=f.gl,w=a.directionalLight,I=a.ambientLight;if(!w||!I)return;const M=[],L=ha(e,e.longestCutoffRange);L.shouldRenderCutoff&&M.push("RENDER_CUTOFF"),M.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&M.push("NORMAL_OFFSET");const N=_l(a,w,I),V=new ki(y.LEQUAL,ki.ReadOnly,e.depthRangeFor3D),Z=new hr({func:y.EQUAL,mask:255},0,255,y.KEEP,y.KEEP,y.KEEP);for(const U of this._groundShadowTiles){const X=U.toUnwrapped(),K=e.isTileAffectedByFog(U),rt=e.getOrCreateProgram("groundShadow",{defines:M,overrideFog:K});this.setupShadows(X,rt),e.uploadCommonUniforms(f,rt,X,null,L);const ht={u_matrix:e.transform.calculateProjMatrix(X),u_ground_shadow_factor:N};rt.draw(e,y.TRIANGLES,V,Z,Sr.multiply,rr.disabled,ht,"ground_shadow",e.tileExtentBuffer,e.quadTriangleIndexBuffer,e.tileExtentSegments,null,e.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Sr.unblended:Sr.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(e){const a=this.painter.transform,f=a.calculatePosMatrix(e,a.worldSize);return i.aB(f,this._cascades[this.painter.currentShadowCascade].matrix,f),Float32Array.from(f)}calculateShadowPassMatrixFromMatrix(e){const a=i.by(e);return i.aB(a,this._cascades[this.painter.currentShadowCascade].matrix,e),a}setupShadows(e,a,f){if(!this.enabled)return;const y=this.painter.transform,w=this.painter.context,I=w.gl,M=this._uniformValues,L=new Float64Array(16),N=y.calculatePosMatrix(e,y.worldSize);for(let V=0;V<this._cascades.length;V++)i.aB(L,this._cascades[V].matrix,N),M[V===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(L),w.activeTexture.set(I.TEXTURE0+Ss.ShadowMap0+V),this._cascades[V].texture.bindExtraParam(I.LINEAR,I.LINEAR,I.CLAMP_TO_EDGE,I.CLAMP_TO_EDGE,I.GREATER);if(this.useNormalOffset=!!f,this.useNormalOffset){const V=i.d6(e.canonical),Z=2/y.tileSize*i.al/Is.shadowMapResolution,U=Z*this._cascades[0].boundingSphereRadius,X=Z*this._cascades[this._cascades.length-1].boundingSphereRadius,K=(f==="vector-tile"?1:3)*function(rt,ht,lt,_t,Mt){const vt=i.aA((rt-22)/-22,0,1);return .125*(1-vt)+4*vt}(y.zoom);M.u_shadow_normal_offset=[V,U*K,X*K],M.u_shadow_bias=[1e-4,.0012,.012]}else M.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(w,M)}setupShadowsFromMatrix(e,a,f=!1){if(!this.enabled)return;const y=this.painter.context,w=y.gl,I=this._uniformValues,M=new Float64Array(16);for(let L=0;L<Is.cascadeCount;L++)i.aB(M,this._cascades[L].matrix,e),I[L===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(M),y.activeTexture.set(w.TEXTURE0+Ss.ShadowMap0+L),this._cascades[L].texture.bindExtraParam(w.LINEAR,w.LINEAR,w.CLAMP_TO_EDGE,w.CLAMP_TO_EDGE,w.GREATER);if(this.useNormalOffset=f,f){const L=Is.normalOffset;I.u_shadow_normal_offset=[1,L,L],I.u_shadow_bias=[6e-5,.0012,.012]}else I.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(y,I)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(e,a,f,y){if(y[2]>=0)return{};const w=function(L,N,V){const Z=V/(1<<L.canonical.z);return new i.d8([L.canonical.x*Z+L.wrap*V,L.canonical.y*Z+L.wrap*V,0],[(L.canonical.x+1)*Z+L.wrap*V,(L.canonical.y+1)*Z+L.wrap*V,N])}(e,a,f).getCorners(),I=a/-y[2];y[0]<0?(i.d7(w[0],w[0],[y[0]*I,0,0]),i.d7(w[3],w[3],[y[0]*I,0,0])):y[0]>0&&(i.d7(w[1],w[1],[y[0]*I,0,0]),i.d7(w[2],w[2],[y[0]*I,0,0])),y[1]<0?(i.d7(w[0],w[0],[0,y[1]*I,0]),i.d7(w[1],w[1],[0,y[1]*I,0])):y[1]>0&&(i.d7(w[2],w[2],[0,y[1]*I,0]),i.d7(w[3],w[3],[0,y[1]*I,0]));const M={};return M.vertices=w,M.planes=[kc(w[1],w[0],w[4]),kc(w[2],w[1],w[5]),kc(w[3],w[2],w[6]),kc(w[0],w[3],w[7])],M}addShadowReceiver(e,a,f){this._receivers.add(e,i.d8.fromTileIdAndHeight(e,a,f))}getMaxCascadeForTile(e){const a=this._receivers.get(e);return a&&a.lastCascade?a.lastCascade:0}}function kc(p,e,a){const f=i.av([],a,e),y=i.av([],p,e),w=i.bH([],f,y),I=i.ag(w);return I===0?[0,0,1,0]:(i.c4(w,w,1/I),[w[0],w[1],w[2],-i.bI(w,e)])}function Dh(p){const e=p.properties.get("direction"),a=i.d3(e.x,e.y,e.z);a[2]=i.aA(a[2],0,75);const f=i.d5([a[0],a[1],a[2]]);return i.d4(f.x,f.y,f.z)}function _l(p,e,a){const f=e.properties.get("color-use-theme")==="none",y=e.properties.get("color"),w=e.properties.get("intensity"),I=e.properties.get("direction"),M=[I.x,I.y,I.z],L=a.properties.get("color-use-theme")==="none",N=a.properties.get("color"),V=a.properties.get("intensity"),Z=Math.max(i.bI([0,0,1],M),0),U=[0,0,0];i.c4(U,N.toPremultipliedRenderColor(L?null:p.getLut(e.scope)).toArray01Linear().slice(0,3),V);const X=[0,0,0];return i.c4(X,y.toPremultipliedRenderColor(f?null:p.getLut(a.scope)).toArray01Linear().slice(0,3),Z*w),i.da([U[0]>0?U[0]/(U[0]+X[0]):0,U[1]>0?U[1]/(U[1]+X[1]):0,U[2]>0?U[2]/(U[2]+X[2]):0])}function jf(p,e,a,f,y,w){const I=p.zoom,M=p.scale,L=p.worldSize,N=1/L,V=p.aspect,Z=Math.sqrt(1+V*V)*Math.tan(.5*p.fovX),U=Z*Z,X=f-a,K=f+a;let rt,ht;U>X/K?(rt=f,ht=f*Z):(rt=.5*K*(1+U),ht=.5*Math.sqrt(X*X+2*(f*f+a*a)*U+K*K*U*U));const lt=p.projection.pixelsPerMeter(p.center.lat,L),_t=p._camera.getCameraToWorldMercator(),Mt=[0,0,-rt*N];i.af(Mt,Mt,_t);let vt=ht*N;const Ut=p._edgeInsets;if(!(Ut.left===0&&Ut.top===0&&Ut.right===0&&Ut.bottom===0||Ut.left===Ut.right&&Ut.top===Ut.bottom)){const qe=p._camera.getWorldToCamera(p.worldSize,p.projection.zAxisUnit==="meters"?lt:1),si=p._camera.getCameraToClipPerspective(p._fov,p.width/p.height,a,f);si[8]=2*-p.centerOffset.x/p.width,si[9]=2*p.centerOffset.y/p.height;const Li=new Float64Array(16);i.cO(Li,si,qe);const ni=new Float64Array(16);i.bk(ni,Li);const li=i.cA.fromInvProjectionMatrix(ni,L,I,!0);for(const Fi of li.points){const Si=((Ct=Fi)[0]/=M,Ct[1]/=M,Ct[2]=i.ce(Ct[2],p._center.lat),Ct);vt=Math.max(vt,i.c5(i.d9([],Mt,Si)))}}var Ct;vt*=y/(y-1);const $t=Math.acos(e[2]),Ot=Math.atan2(-e[0],-e[1]),Rt=new hu;Rt.position=Mt,Rt.setPitchBearing($t,Ot);const Zt=Rt.getWorldToCamera(L,lt),pe=vt*L,le=Math.min(p._mercatorZfromZoom(17)*L*-2,-2*pe),Me=Rt.getCameraToClipOrthographic(-pe,pe,-pe,pe,le,(pe+w*lt)/e[2]),ve=new Float64Array(16);i.aB(ve,Me,Zt);const Be=i.d4(Math.floor(1e6*Mt[0])/1e6*L,Math.floor(1e6*Mt[1])/1e6*L,0),oi=.5*y,ge=[0,0,0];i.af(ge,Be,ve),i.c4(ge,ge,oi);const ie=[Math.floor(ge[0]),Math.floor(ge[1]),Math.floor(ge[2])],Oe=[0,0,0];i.av(Oe,ge,ie),i.c4(Oe,Oe,-1/oi);const Te=new Float64Array(16);return i.bz(Te),i.bq(Te,Te,Oe),i.aB(ve,Te,ve),[ve,pe]}class uo extends i.E{constructor(e){super(),this.requestManager=e,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(e,a){return i.db(this.requestManager.transformRequest(a,i.R.Model).url).then(f=>{if(!f)return;const y=i.dc(f),w=new i.dd(e,a,void 0,void 0,y);return w.computeBoundsAndApplyParent(),w}).catch(f=>{if(f&&f.status===404)return null;this.fire(new i.y(new Error(`Could not load model ${e} from ${a}: ${f.message}`)))})}load(e,a,f={forceReload:!1}){this.models[a]||(this.models[a]={});const y=Object.keys(e),w=[],I=[];for(const M of y){const L=e[M];this.hasURLBeenRequested(L)&&!f.forceReload||(this.modelByURL[L]={modelId:M,scope:a},w.push(this.loadModel(M,L)),I.push(M)),this.models[a][M]||(this.models[a][M]={model:null,numReferences:1})}this.numModelsLoading[a]=(this.numModelsLoading[a]||0)+I.length,Promise.allSettled(w).then(M=>{for(let L=0;L<M.length;L++){const{status:N}=M[L];if(N==="rejected")continue;const{value:V}=M[L];this.models[a][I[L]]||(this.models[a][I[L]]={model:null,numReferences:1}),this.models[a][I[L]].model=V}this.numModelsLoading[a]-=I.length,this.fire(new i.z("data",{dataType:"style"}))}).catch(M=>{this.fire(new i.y(new Error(`Could not load models: ${M.message}`)))})}isLoaded(){for(const e in this.numModelsLoading)if(this.numModelsLoading[e]>0)return!1;return!0}hasModel(e,a,f={exactIdMatch:!1}){return!!(f.exactIdMatch?this.getModel(e,a):this.getModelByURL(this.modelUris[a][e]))}getModel(e,a){return this.models[a]||(this.models[a]={}),this.models[a][e]?this.models[a][e].model:void 0}getModelByURL(e){if(!e)return null;const a=this.modelByURL[e];return a?this.models[a.scope][a.modelId].model:null}hasModelBeenAdded(e,a){return this.models[a]&&this.models[a][e]!==void 0}getModelURIs(e){return this.modelUris[e]||{}}addModel(e,a,f){this.models[f]||(this.models[f]={}),this.modelUris[f]||(this.modelUris[f]={});const y=this.requestManager.normalizeModelURL(a);if((this.hasModel(e,f,{exactIdMatch:!0})||this.hasModelBeenAdded(e,f))&&this.modelUris[f][e]===y)this.models[f][e].numReferences++;else if(this.hasURLBeenRequested(y)){const{scope:w,modelId:I}=this.modelByURL[y];this.models[w][I].numReferences++}else this.modelUris[f][e]=y,this.load({[e]:this.modelUris[f][e]},f)}addModelURLs(e,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});const f=this.modelUris[a];for(const y in e)f[y]=this.requestManager.normalizeModelURL(e[y])}reloadModels(e){this.load(this.modelUris[e],e,{forceReload:!0})}addModelsFromBucket(e,a){this.models[a]||(this.models[a]={}),this.modelUris[a]||(this.modelUris[a]={});const f={};for(const y of e)this.hasModel(y,a,{exactIdMatch:!0})||this.hasURLBeenRequested(y)?this.models[a][y].numReferences++:this.modelUris[a][y]&&!this.hasURLBeenRequested(y)?f[y]=this.modelUris[a][y]:!this.hasURLBeenRequested(y)&&i.de(y,!1)&&(this.modelUris[a][y]=this.requestManager.normalizeModelURL(y),f[y]=this.modelUris[a][y]);this.load(f,a)}hasURLBeenRequested(e){return this.modelByURL[e]!==void 0}removeModel(e,a,f=!1,y=!1){if(this.models[a]&&this.models[a][e]&&(this.models[a][e].numReferences--,this.models[a][e].numReferences===0||y)){const w=this.modelUris[a][e];f||delete this.modelUris[a][e],delete this.modelByURL[w];const I=this.models[a][e].model;if(!I)return;delete this.models[a][e],I.destroy()}}destroy(){for(const e of Object.keys(this.models))for(const a of Object.keys(this.models[e])){const f=this.models[e][a].model;delete this.models[e][a],f&&f.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(e){return this.models[e]||(this.models[e]={}),Object.keys(this.models[e])}upload(e,a){this.models[a]||(this.models[a]={});for(const f in this.models[a])this.models[a][f].model&&this.models[a][f].model.upload(e.context)}}const Pd=i.a6.colorTheme,zh=new i.a9({data:new i.aa(Pd.data)});function Gf(p){if(!p.metadata||!p.metadata.content_area)return;const e=i.o.devicePixelRatio,{left:a,top:f,width:y,height:w}=p.metadata.content_area,I=a*e,M=f*e;return[I,M,I+y*e,M+w*e]}function $f(p){if(p)return p.map(([e,a])=>[e*i.o.devicePixelRatio,a*i.o.devicePixelRatio])}class qf{constructor(e,a,f){this.id=e,this.scope=a,this.sourceCache=f,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(e){this.missingRequests.has(e.name)||this.pendingRequests.has(e.name)||this.pendingRequests.add(e.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const e=new Map;if(!this.sourceCache.loaded())return e;const a=this.sourceCache.getVisibleCoordinates();if(a.length===0)return e;const f=this.sourceCache.getSource();if(!(f instanceof hs))return e;const y=a.map(I=>this.sourceCache.getTile(I)),w=f.getImages(y,Array.from(this.pendingRequests));for(const[I,M]of w)e.set(i.I.from({name:I,iconsetId:this.id}),M),this.pendingRequests.delete(I);for(const I of this.pendingRequests)this.missingRequests.add(I);return this.pendingRequests.clear(),e}}const pc=(p,e)=>st(p,e&&e.filter(a=>a.identifier!=="source.canvas")),mp=i.aH(vr,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),qu=i.aH(vr,["setCenter","setZoom","setBearing","setPitch"]),Zu=new Set(["background","sky","slot","custom"]),rh={version:8,layers:[],sources:{}},du={duration:300,delay:0};class Ia extends i.E{constructor(e,a={}){super(),this.map=e,this.scope=a.scope||"",this.globalId=null,this.fragments=[],this.importDepth=a.importDepth||0,this.importsCache=a.importsCache||new Map,this.resolvedImports=a.resolvedImports||new Set,this.transition=Object.assign({},du),this._buildingIndex=new aa(this),this.crossTileSymbolIndex=new Lc,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=a.styleChanges||new ds,this.dispatcher=a.dispatcher?a.dispatcher:new i.D(i.dg(),this),a.imageManager?this.imageManager=a.imageManager:(this.imageManager=new xo(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=a.glyphManager?a.glyphManager:new i.dh(e._requestManager,a.localFontFamily?i.di.all:a.localIdeographFontFamily?i.di.ideographs:i.di.none,a.localFontFamily||a.localIdeographFontFamily),a.modelManager?this.modelManager=a.modelManager:(this.modelManager=new uo(e._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=a.configOptions?a.configOptions:new Map,this._configDependentLayers=a.configDependentLayers?a.configDependentLayers:new Set,this._indoorDependentLayers=a.indoorDependentLayers?a.indoorDependentLayers:new Set,this._config=a.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:a.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=a.initialConfig,this.dispatcher.broadcast("setReferrer",i.dj());const f=this;this._rtlTextPluginCallback=Ia.registerForPluginStateChange(y=>{f.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:y.pluginStatus,pluginURL:y.pluginURL},(w,I)=>{if(i.dk(w),I&&I.every(M=>M))for(const M in f._sourceCaches){const L=f._sourceCaches[M],N=L.getSource().type;N!=="vector"&&N!=="geojson"||L.reload()}})}),this.on("data",y=>{if(y.dataType!=="source"||y.sourceDataType!=="metadata")return;const w=this.getOwnSource(y.sourceId);if(w&&w.vectorLayerIds)for(const I in this._layers){const M=this._layers[I];M.source===w.id&&this._validateLayer(M)}})}load(e){return e?(typeof e=="string"?this.loadURL(e):this.loadJSON(e),this):this}_getGlobalId(e){if(!e)return null;if(typeof e=="string"){if(i.h(e))return e;const a=i.dl(e);if(!a.startsWith("http"))try{return new URL(a,location.href).toString()}catch{return a}return a}return`json://${i.dm(JSON.stringify(e))}`}_diffStyle(e,a,f){this.globalId=this._getGlobalId(e);const y=(w,I)=>{try{I(null,this.setState(w,f))}catch(M){I(M,!1)}};if(typeof e=="string"){const w=this.map._requestManager.normalizeStyleURL(e),I=this.map._requestManager.transformRequest(w,i.R.Style);i.m(I,(M,L)=>{M?this.fire(new i.y(M)):L&&y(L,a)})}else typeof e=="object"&&y(e,a)}loadURL(e,a={}){this.fire(new i.z("dataloading",{dataType:"style"}));const f=typeof a.validate=="boolean"?a.validate:!i.h(e);this.globalId=this._getGlobalId(e),e=this.map._requestManager.normalizeStyleURL(e,a.accessToken),this.resolvedImports.add(e);const y=this.importsCache.get(e);if(y)return this._load(y,f);const w=this.map._requestManager.transformRequest(e,i.R.Style);this._request=i.m(w,(I,M)=>{if(this._request=null,I)this.fire(new i.y(I));else if(M)return this.importsCache.set(e,M),this._load(M,f)})}loadJSON(e,a={}){this.fire(new i.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(e),this._request=i.o.frame(()=>{this._request=null,this._load(e,a.validate!==!1)})}loadEmpty(){this.fire(new i.z("dataloading",{dataType:"style"})),this._load(rh,!1)}_loadImports(e,a,f){if(this.importDepth>=4)return i.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const y=[];for(const w of e){const I=this._createFragmentStyle(w),M=new Promise(V=>{I.once("style.import.load",V),I.once("error",V)}).then(()=>this.mergeAll());if(y.push(M),this.resolvedImports.has(w.url)){I.loadEmpty();continue}const L=w.data||this.importsCache.get(w.url);L?(I.loadJSON(L,{validate:a}),this._isInternalStyle(L)&&(I.globalId=null)):w.url?I.loadURL(w.url,{validate:a}):I.loadEmpty();const N={style:I,id:w.id,config:w.config};if(f){const V=this.fragments.findIndex(({id:Z})=>Z===f);this.fragments=this.fragments.slice(0,V).concat(N).concat(this.fragments.slice(V))}else this.fragments.push(N)}return Promise.allSettled(y)}getImportGlobalIds(e=this,a=new Set){for(const f of e.fragments)f.style.globalId&&a.add(f.style.globalId),this.getImportGlobalIds(f.style,a);return[...a.values()]}_createFragmentStyle(e){const a=this.scope?i.B(e.id,this.scope):e.id;let f;const y=this._initialConfig&&this._initialConfig[a];(e.config||y)&&(f=Object.assign({},e.config,y));const w=new Ia(this.map,{scope:a,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:f,configOptions:this.options,colorThemeOverride:e["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return w.setEventedParent(this.map,{style:w}),w}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(e){return this.isRootStyle()&&(e.fragment||!!e.schema&&e.fragment!==!1)}_load(e,a){if(this._isInternalStyle(e)){const w=Object.assign({},rh,{imports:[{id:"basemap",data:e,url:""}]},e.center?{center:e.center}:{},e.bearing?{bearing:e.bearing}:{},e.pitch?{pitch:e.pitch}:{},e.zoom?{zoom:e.zoom}:{},e.light?{light:e.light}:{});return this._importedAsBasemap=!0,void this._load(w,a)}if(this.updateConfig(this._config,e.schema),a&&pc(this,We(e)))return;this._loaded=!0,this.stylesheet=i.dn(e);const f=()=>{for(const L in e.sources)this.addSource(L,e.sources[L],{validate:!1,isInitialLoad:!0});if(e.iconsets)for(const L in e.iconsets)this.addIconset(L,e.iconsets[L]);e.sprite?this._loadIconset(e.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&e.glyphs&&this.glyphManager.setURL(e.glyphs);const w=Ll(this.stylesheet.layers);if(this._order=w.map(L=>L.id),this.stylesheet.light&&i.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const L=this.stylesheet.lights[0];this.light=new Bt(L.properties,L.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Bt(this.stylesheet.light)),this._layers={};for(const L of w){const N=i.dt(L,this.scope,this._styleColorTheme.lut,this.options);N.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(N.fqid),N.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(N.fqid),this._hasAppearances=this._hasAppearances||N.getAppearances().length!==0,N.setEventedParent(this,{layer:{id:N.id}}),this._layers[N.id]=N;const V=this.getOwnLayerSourceCache(N),Z=!!this.directionalLight&&this.directionalLight.shadowsEnabled();V&&N.canCastShadows()&&Z&&(V.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const I=this.stylesheet.terrain;I&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(I,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new i.z("data",{dataType:"style"}));const M=this.isRootStyle();e.imports?this._loadImports(e.imports,a).then(()=>{this._reloadImports(),this.fire(new i.z(M?"style.load":"style.import.load"))}).catch(L=>{this.fire(new i.y(new Error("Failed to load imports",L))),this.fire(new i.z(M?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new i.z(M?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const y=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(y){const w=this._evaluateColorThemeData(y);this._loadColorTheme(w).then(()=>{f()}).catch(I=>{i.w(`Couldn't load color theme from the stylesheet: ${I}`),f()})}else this._styleColorTheme.lut=null,f()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances}mergeAll(){let e,a,f,y,w,I,M,L,N,V;const Z={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(U=>{if(U.stylesheet){if(U.light!=null&&(e=U.light),U.stylesheet.lights)for(const X of U.stylesheet.lights)X.type==="ambient"&&U.ambientLight!=null&&(a=U.ambientLight),X.type==="directional"&&U.directionalLight!=null&&(f=U.directionalLight);y=this._prioritizeTerrain(y,U.terrain,U.stylesheet.terrain),U.stylesheet.fog&&U.fog!=null&&(w=U.fog),U.stylesheet.snow&&U.snow!=null&&(I=U.snow),U.stylesheet.rain&&U.rain!=null&&(M=U.rain),U.stylesheet.camera!=null&&(V=U.stylesheet.camera),U.stylesheet.projection!=null&&(L=U.stylesheet.projection),U.stylesheet.transition!=null&&(N=U.stylesheet.transition),Z[U.scope]=U._styleColorTheme}}),this.light=e,this.ambientLight=a,this.directionalLight=f,this.fog=w,this.snow=I,this.rain=M,this._styleColorThemeForScope=Z,y===null?delete this.terrain:this.terrain=y,this.camera=V||{"camera-projection":"perspective"},this.projection=L||{name:"mercator"},this.transition=Object.assign({},du,N),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(e){const a=f=>{for(const y of f.fragments)a(y.style);e(f)};a(this)}_prioritizeTerrain(e,a,f){const y=e&&e.drapeRenderMode===0;return f===null?a&&a.drapeRenderMode===0?a:y?e:null:a!=null&&(!e||y||a&&a.drapeRenderMode===1)?a:e}mergeTerrain(){let e;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(a=>{e=this._prioritizeTerrain(e,a.terrain,a.stylesheet.terrain)}),e===null?delete this.terrain:this.terrain=e}mergeProjection(){let e;this.forEachFragmentStyle(a=>{a.stylesheet.projection!=null&&(e=a.stylesheet.projection)}),this.projection=e||{name:"mercator"}}mergeSources(){const e={},a={},f={};this.forEachFragmentStyle(y=>{for(const w in y._sourceCaches){const I=i.B(w,y.scope);e[I]=y._sourceCaches[w]}for(const w in y._otherSourceCaches){const I=i.B(w,y.scope);a[I]=y._otherSourceCaches[w]}for(const w in y._symbolSourceCaches){const I=i.B(w,y.scope);f[I]=y._symbolSourceCaches[w]}}),this._mergedSourceCaches=e,this._mergedOtherSourceCaches=a,this._mergedSymbolSourceCaches=f}mergeIndoor(){this.forEachFragmentStyle(e=>{if(e.stylesheet&&e.stylesheet.indoor)for(const a of Object.values(e.stylesheet.indoor)){const f=a,y=i.B(f.sourceId,e.scope);this._mergedIndoor[y]=new Set(f.sourceLayers||[])}})}mergeLayers(){const e={},a=[],f={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(I=>{for(const M of I._order){const L=I._layers[M];if(L.type==="slot"){const N=i.dp(M);if(e[N])continue;e[N]=[]}L.slot&&e[L.slot]?e[L.slot].push(L):a.push(L)}}),this._mergedOrder=[];let y=-1;const w=(I=[])=>{for(const M of I)if(M.type==="slot"){const L=i.dp(M.id);e[L]&&w(e[L]),this._mergedSlots.push(L)}else{const L=i.B(M.id,M.scope);this._mergedOrder.push(L),f[L]=M,M.is3D(!!this.terrain)&&(this._has3DLayers=!0,y=this._mergedOrder.length-1),M.type==="circle"&&(this._hasCircleLayers=!0),M.type==="symbol"&&(this._hasSymbolLayers=!0),M.type==="clip"&&(this._clipLayerPresent=!0)}};if(w(a),this._has3DLayers){const I={};for(let M=0;M<this._mergedOrder.length;++M){const L=this._mergedOrder[M];I[L]=M===y?1:M<y?f[L].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort((M,L)=>I[M]-I[L])}this._mergedLayers=f,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(e){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,e),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(e){return e.data?function(a,f,y,w){const I=Object.assign({},f);for(const L of Object.keys(Pd))I[L]===void 0&&(I[L]=Pd[L].default);const M=new i.a8(zh,a,new Map(y));return M.setTransitionOrValue(I,y),M.untransitioned().possiblyEvaluate(new i.ac(0,{worldview:void 0}))}(this.scope,e,this.options).get("data"):null}_loadColorTheme(e){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const a=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((f,y)=>{const w="data:image/png;base64,";if(!e||e.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void f();let I=e;I.startsWith(w)||(I=w+I);const M=i.I.from("mapbox-reserved-lut"),L=new Image;L.src=I,L.onerror=()=>{this._styleColorTheme.lutLoading=!1,y(new Error("Failed to load image data"))},L.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==a)return void f();this._styleColorTheme.lutLoading=!1;const{width:N,height:V,data:Z}=i.o.getImageData(L);if(V>32)return void y(new Error("The height of the image must be less than or equal to 32 pixels."));if(N!==V*V)return void y(new Error("The width of the image must be equal to the height squared."));this.getImage(M)&&this.removeImage(M),this.addImage(M,{data:new i.q({width:N,height:V},Z),pixelRatio:1,sdf:!1,usvg:!1,version:0});const U=this.imageManager.getImage(M,this.scope);U?(this._styleColorTheme.lut={image:U.data,data:e},f()):y(new Error("Missing LUT image."))}})}getLut(e){const a=this._styleColorThemeForScope[e];return a?a.lut:null}setProjection(e){e?this.stylesheet.projection=e:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(e){this._spriteRequest=function(a,f,y){let w,I,M;const L=i.o.devicePixelRatio>1?"@2x":"";let N=i.m(f.transformRequest(f.normalizeSpriteURL(a,L,".json"),i.R.SpriteJSON),(U,X)=>{N=null,M||(M=U,w=X,Z())}),V=i.n(f.transformRequest(f.normalizeSpriteURL(a,L,".png"),i.R.SpriteImage),(U,X)=>{V=null,M||(M=U,I=X,Z())});function Z(){if(M)y(M);else if(w&&I){const U=i.o.getImageData(I),X={};for(const K in w){const{width:rt,height:ht,x:lt,y:_t,sdf:Mt,pixelRatio:vt,stretchX:Ut,stretchY:Ct,content:$t}=w[K],Ot=new i.q({width:rt,height:ht});i.q.copy(U,Ot,{x:lt,y:_t},{x:0,y:0},{width:rt,height:ht},null),X[K]={data:Ot,pixelRatio:vt!==void 0?vt:1,sdf:Mt!==void 0&&Mt,stretchX:Ut,stretchY:Ct,content:$t,usvg:!1,version:0}}y(null,X)}}return{cancel(){N&&(N.cancel(),N=null),V&&(V.cancel(),V=null)}}}(e,this.map._requestManager,(a,f)=>{if(this._spriteRequest=null,a)this.fire(new i.y(a));else if(f){const y=new Map;for(const w in f)y.set(i.I.from(w),f[w]);this.addImages(y)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.z("data",{dataType:"style"}))})}addIconset(e,a){if(a.type==="sprite")return void this._loadSprite(a.url);const f=this.getOwnSourceCache(a.source);if(!f)return void this.fire(new i.y(new Error(`Source "${a.source}" as specified by iconset "${e}" does not exist and cannot be used as an iconset source`)));const y=f.getSource();if(y.type!=="raster-array")return void this.fire(new i.y(new Error(`Source "${a.source}" as specified by iconset "${e}" is not a "raster-array" source and cannot be used as an iconset source`)));y.partial=!1;const w=new qf(e,this.scope,f);this.imageManager.addImageProvider(w,this.scope)}removeIconset(e){this.imageManager.removeImageProvider(e,this.scope)}_loadIconset(e){if(!i.h(e)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(e);const a=this.map._spriteFormat==="auto";var f,y;this._spriteRequest=(y=(w,I)=>{if(this._spriteRequest=null,w)a?this._loadSprite(e):this.fire(new i.y(w));else if(I){const M=new Map;for(const L in I)M.set(i.I.from(L),I[L]);this.addImages(M)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.z("data",{dataType:"style"}))},i.bt((f=this.map._requestManager).transformRequest(f.normalizeIconsetURL(e),i.R.Iconset),(w,I)=>{if(w)return void y(w);const M={},L=i.df(new i.bs(I));for(const N of L.icons){const V={version:1,pixelRatio:i.o.devicePixelRatio,content:Gf(N),stretchX:N.metadata?$f(N.metadata.stretch_x_areas):void 0,stretchY:N.metadata?$f(N.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:N};M[N.name]=V}y(null,M)}))}_validateLayer(e){const a=this.getOwnSource(e.source);if(!a)return;const f=e.sourceLayer;f&&(a.type==="geojson"||a.vectorLayerIds&&a.vectorLayerIds.indexOf(f)===-1)&&this.fire(new i.y(new Error(`Source layer "${f}" does not exist on source "${a.id}" as specified by style layer "${e.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const e in this._sourceCaches)if(!this._sourceCaches[e].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:e}of this.fragments)if(!e.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((e,a)=>{const f=this.fragments[a];return f&&f.style&&(e.data=f.style.serialize()),e})}_serializeSources(){const e={};for(const a in this._sourceCaches){const f=this._sourceCaches[a].getSource();e[f.id]||(e[f.id]=f.serialize())}return e}_serializeLayers(e){const a=[];for(const f of e){const y=this._layers[f];y&&y.type!=="custom"&&a.push(y.serialize())}return a}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const e in this._sourceCaches)if(this._sourceCaches[e].hasTransition())return!0;for(const e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(e){return e?this.order:this._mergedOrder}isLayerDraped(e){return!!this.terrain&&e.isDraped(this.getLayerSourceCache(e))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(e){const a=this.getOwnLayer(e);if(a)return a;this.fire(new i.y(new Error(`The layer '${e}' does not exist in the map's style.`)))}_checkSource(e){const a=this.getOwnSource(e);if(a)return a;this.fire(new i.y(new Error(`The source '${e}' does not exist in the map's style.`)))}precompilePrograms(e,a){const f=this.map.painter;if(f)for(let y=e.minzoom||0;y<(e.maxzoom||25.5);y++){const w=e.getProgramIds();if(w)for(const I of w){const M=e.getDefaultProgramParams(I,a.zoom,this._styleColorTheme.lut);M&&(f.style=this,this.fog&&(f._fogVisible=!0,M.overrideFog=!0,f.getOrCreateProgram(I,M)),f._fogVisible=!1,M.overrideFog=!1,f.getOrCreateProgram(I,M),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(M.overrideRtt=!0,f.getOrCreateProgram(I,M)))}}}update(e){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(e),this.directionalLight&&this.directionalLight.recalculate(e);const a=this.calculateLightsBrightness();e.brightness=a||0,a!==this._brightness&&(this._brightness=a,this.dispatcher.broadcast("setBrightness",a)),e.worldview!==this._worldview&&(this._worldview=e.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const f=this._changes.isDirty();let y=!1;if(this._changes.isDirty()){const M=this._changes.getLayerUpdatesByScope();for(const L in M){const{updatedIds:N,removedIds:V}=M[L];(N||V)&&(this._updateWorkerLayers(L,N,V),y=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(e),this.light&&this.light.updateTransitions(e),this.ambientLight&&this.ambientLight.updateTransitions(e),this.directionalLight&&this.directionalLight.updateTransitions(e),this.fog&&this.fog.updateTransitions(e),this.snow&&this.snow.updateTransitions(e),this.rain&&this.rain.updateTransitions(e),this._changes.reset()}const w={};for(const M in this._mergedSourceCaches){const L=this._mergedSourceCaches[M];w[M]=L.used,L.used=!1,L.tileCoverLift=0}for(const M of this._mergedOrder){const L=this._mergedLayers[M];if(L.recalculate(e,this._availableImages),!L.isHidden(e.zoom)){const N=this.getLayerSourceCache(L);N&&(N.used=!0,N.tileCoverLift=Math.max(N.tileCoverLift,L.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(L,e)}):this.precompilePrograms(L,e))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&y&&this.mergeLayers();const I=this.imageManager.getPendingImageProviders();for(const M of I)M.sourceCache.used=!0;for(const M in w){const L=this._mergedSourceCaches[M];w[M]!==L.used&&L.getSource().fire(new i.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:L.getSource().id}))}this.light&&this.light.recalculate(e),this.terrain&&this.terrain.recalculate(e),this.fog&&this.fog.recalculate(e),this.snow&&this.snow.recalculate(e),this.rain&&this.rain.recalculate(e),this.z=e.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),f&&this.fire(new i.z("data",{dataType:"style"}))}updateImageProviders(){const e=this.imageManager.getPendingImageProviders();for(const a of e){const f=a.resolvePendingRequests(),y=this.getFragmentStyle(a.scope);y&&y.addImages(f)}}_updateTilesForChangedImages(){const e={};for(const a in this._mergedSourceCaches){const f=this._mergedSourceCaches[a].getSource().scope;e[f]=e[f]||this._changes.getUpdatedImages(f),e[f].length!==0&&this._mergedSourceCaches[a].reloadTilesForDependencies(["icons","patterns"],e[f])}for(const a in e)this._changes.resetUpdatedImages(a)}_updateWorkerLayers(e,a,f){const y=this.getFragmentStyle(e);y&&this.dispatcher.broadcast("updateLayers",{layers:a?y._serializeLayers(a):[],scope:e,removedIds:f||[],options:y.options})}setState(e,a){if(this._checkLoaded(),pc(this,We(e)))return!1;(e=i.dn(e)).layers=Ll(e.layers);const f=function(I,M){if(!I)return[{command:vr.setStyle,args:[M]}];let L=[];try{if(!i.bx(I.version,M.version))return[{command:vr.setStyle,args:[M]}];if(i.bx(I.center,M.center)||L.push({command:vr.setCenter,args:[M.center]}),i.bx(I.zoom,M.zoom)||L.push({command:vr.setZoom,args:[M.zoom]}),i.bx(I.bearing,M.bearing)||L.push({command:vr.setBearing,args:[M.bearing]}),i.bx(I.pitch,M.pitch)||L.push({command:vr.setPitch,args:[M.pitch]}),i.bx(I.sprite,M.sprite)||L.push({command:vr.setSprite,args:[M.sprite]}),i.bx(I.glyphs,M.glyphs)||L.push({command:vr.setGlyphs,args:[M.glyphs]}),i.bx(I.imports,M.imports)||function(X=[],K=[],rt){K=K||[];const ht=(X=X||[]).map(pl),lt=K.map(pl),_t=X.reduce(qn,{}),Mt=K.reduce(qn,{}),vt=ht.slice();let Ut,Ct,$t,Ot;for(Ut=0,Ct=0;Ut<ht.length;Ut++)$t=ht[Ut],Mt.hasOwnProperty($t)?Ct++:(rt.push({command:vr.removeImport,args:[$t]}),vt.splice(vt.indexOf($t,Ct),1));for(Ut=0,Ct=0;Ut<lt.length;Ut++)$t=lt[lt.length-1-Ut],vt[vt.length-1-Ut]!==$t&&(_t.hasOwnProperty($t)?(rt.push({command:vr.removeImport,args:[$t]}),vt.splice(vt.lastIndexOf($t,vt.length-Ct),1)):Ct++,Ot=vt[vt.length-Ut],rt.push({command:vr.addImport,args:[Mt[$t],Ot]}),vt.splice(vt.length-Ut,0,$t));for(const Rt of K){const Zt=_t[Rt.id];Zt&&(delete Zt.data,i.bx(Zt,Rt)||rt.push({command:vr.updateImport,args:[Rt.id,Rt]}))}}(I.imports,M.imports,L),i.bx(I.transition,M.transition)||L.push({command:vr.setTransition,args:[M.transition]}),i.bx(I.light,M.light)||L.push({command:vr.setLight,args:[M.light]}),i.bx(I.fog,M.fog)||L.push({command:vr.setFog,args:[M.fog]}),i.bx(I.snow,M.snow)||L.push({command:vr.setSnow,args:[M.snow]}),i.bx(I.rain,M.rain)||L.push({command:vr.setRain,args:[M.rain]}),i.bx(I.projection,M.projection)||L.push({command:vr.setProjection,args:[M.projection]}),i.bx(I.lights,M.lights)||L.push({command:vr.setLights,args:[M.lights]}),i.bx(I.camera,M.camera)||L.push({command:vr.setCamera,args:[M.camera]}),i.bx(I.iconsets,M.iconsets)||function(X,K,rt){let ht;for(ht in K=K||{},X=X||{})X.hasOwnProperty(ht)&&(K.hasOwnProperty(ht)||rt.push({command:vr.removeIconset,args:[ht]}));for(ht in K){if(!K.hasOwnProperty(ht))continue;const lt=K[ht];X.hasOwnProperty(ht)?i.bx(X[ht],lt)||(rt.push({command:vr.removeIconset,args:[ht]}),rt.push({command:vr.addIconset,args:[ht,lt]})):rt.push({command:vr.addIconset,args:[ht,lt]})}}(I.iconsets,M.iconsets,L),!i.bx(I["color-theme"],M["color-theme"]))return[{command:vr.setStyle,args:[M]}];const N={},V=[];(function(X,K,rt,ht){let lt;for(lt in K=K||{},X=X||{})X.hasOwnProperty(lt)&&(K.hasOwnProperty(lt)||Wl(lt,rt,ht));for(lt in K){if(!K.hasOwnProperty(lt))continue;const _t=K[lt];X.hasOwnProperty(lt)?i.bx(X[lt],_t)||(X[lt].type==="geojson"&&_t.type==="geojson"&&Ra(X,K,lt)?rt.push({command:vr.setGeoJSONSourceData,args:[lt,_t.data]}):Yc(lt,K,rt,ht)):Ah(lt,K,rt)}})(I.sources,M.sources,V,N);const Z=[];I.layers&&I.layers.forEach(X=>{X.source&&N[X.source]?L.push({command:vr.removeLayer,args:[X.id]}):Z.push(X)});let U=I.terrain;U&&N[U.source]&&(L.push({command:vr.setTerrain,args:[void 0]}),U=void 0),L=L.concat(V),i.bx(U,M.terrain)||L.push({command:vr.setTerrain,args:[M.terrain]}),function(X,K,rt){K=K||[];const ht=(X=X||[]).map(pl),lt=K.map(pl),_t=X.reduce(qn,{}),Mt=K.reduce(qn,{}),vt=ht.slice(),Ut=Object.create(null);let Ct,$t,Ot,Rt,Zt,pe,le;for(Ct=0,$t=0;Ct<ht.length;Ct++)Ot=ht[Ct],Mt.hasOwnProperty(Ot)?$t++:(rt.push({command:vr.removeLayer,args:[Ot]}),vt.splice(vt.indexOf(Ot,$t),1));for(Ct=0,$t=0;Ct<lt.length;Ct++)Ot=lt[lt.length-1-Ct],vt[vt.length-1-Ct]!==Ot&&(_t.hasOwnProperty(Ot)?(rt.push({command:vr.removeLayer,args:[Ot]}),vt.splice(vt.lastIndexOf(Ot,vt.length-$t),1)):$t++,pe=vt[vt.length-Ct],rt.push({command:vr.addLayer,args:[Mt[Ot],pe]}),vt.splice(vt.length-Ct,0,Ot),Ut[Ot]=!0);for(Ct=0;Ct<lt.length;Ct++)if(Ot=lt[Ct],Rt=_t[Ot],Zt=Mt[Ot],!Ut[Ot]&&!i.bx(Rt,Zt))if(i.bx(Rt.source,Zt.source)&&i.bx(Rt["source-layer"],Zt["source-layer"])&&i.bx(Rt.type,Zt.type)){for(le in ko(Rt.layout,Zt.layout,rt,Ot,null,vr.setLayoutProperty),ko(Rt.paint,Zt.paint,rt,Ot,null,vr.setPaintProperty),i.bx(Rt.slot,Zt.slot)||rt.push({command:vr.setSlot,args:[Ot,Zt.slot]}),i.bx(Rt.filter,Zt.filter)||rt.push({command:vr.setFilter,args:[Ot,Zt.filter]}),i.bx(Rt.minzoom,Zt.minzoom)&&i.bx(Rt.maxzoom,Zt.maxzoom)||rt.push({command:vr.setLayerZoomRange,args:[Ot,Zt.minzoom,Zt.maxzoom]}),Rt)Rt.hasOwnProperty(le)&&le!=="layout"&&le!=="paint"&&le!=="filter"&&le!=="metadata"&&le!=="minzoom"&&le!=="maxzoom"&&le!=="slot"&&(le.indexOf("paint.")===0?ko(Rt[le],Zt[le],rt,Ot,le.slice(6),vr.setPaintProperty):i.bx(Rt[le],Zt[le])||rt.push({command:vr.setLayerProperty,args:[Ot,le,Zt[le]]}));for(le in Zt)Zt.hasOwnProperty(le)&&!Rt.hasOwnProperty(le)&&le!=="layout"&&le!=="paint"&&le!=="filter"&&le!=="metadata"&&le!=="minzoom"&&le!=="maxzoom"&&le!=="slot"&&(le.indexOf("paint.")===0?ko(Rt[le],Zt[le],rt,Ot,le.slice(6),vr.setPaintProperty):i.bx(Rt[le],Zt[le])||rt.push({command:vr.setLayerProperty,args:[Ot,le,Zt[le]]}))}else rt.push({command:vr.removeLayer,args:[Ot]}),pe=vt[vt.lastIndexOf(Ot)+1],rt.push({command:vr.addLayer,args:[Zt,pe]})}(Z,M.layers,L)}catch(N){console.warn("Unable to compute style diff:",N),L=[{command:vr.setStyle,args:[M]}]}return L}(this.serialize(),e).filter(I=>!(I.command in qu));if(f.length===0)return!1;const y=f.filter(I=>!(I.command in mp));if(y.length>0)throw new Error(`Unimplemented: ${y.map(I=>I.command).join(", ")}.`);const w=[];return f.forEach(I=>{w.push(this[I.command](...I.args))}),a&&Promise.all(w).then(a).catch(a),this.stylesheet=e,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(e){if(e.size===0)return this;for(const[a,f]of e.entries()){if(this.getImage(a))return this.fire(new i.y(new Error(`An image with the name "${a.name}" already exists.`)));this.imageManager.addImage(a,this.scope,f),this._changes.updateImage(a,this.scope)}return this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this}addImage(e,a){return this.getImage(e)?this.fire(new i.y(new Error(`An image with the name "${e.name}" already exists.`))):(this.imageManager.addImage(e,this.scope,a),this._changes.updateImage(e,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this)}updateImage(e,a,f=!1){this.imageManager.updateImage(e,this.scope,a),f&&(this._changes.updateImage(e,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})))}getImage(e){return this.imageManager.getImage(e,this.scope)}removeImage(e){return this.getImage(e)?(this.imageManager.removeImage(e,this.scope),this._changes.updateImage(e,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this):this.fire(new i.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(e){return this.modelManager.addModelURLs(e,this.scope),this._updateWorkerModels(),this.fire(new i.z("data",{dataType:"style"})),this}addModel(e,a,f={}){return this._checkLoaded(),this._validate(zo,`models.${e}`,a,null,f)||(this.modelManager.addModel(e,a,this.scope),this.fire(new i.z("data",{dataType:"style"}))),this}hasModel(e){return this.modelManager.hasModel(e,this.scope)}removeModel(e){return this.hasModel(e)?(this.modelManager.removeModel(e,this.scope,!1,!0),this.fire(new i.z("data",{dataType:"style"})),this):this.fire(new i.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(e,a,f={}){if(this._checkLoaded(),this.getOwnSource(e)!==void 0)throw new Error(`There is already a source with ID "${e}".`);if(!a.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(a).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(a.type)>=0&&this._validate(ci,`sources.${e}`,a,null,f))return;this.map&&this.map._collectResourceTiming&&(a.collectResourceTiming=!0);const y=Ta(e,a,this.dispatcher,this);y.scope=this.scope,y.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(y.id),source:y.serialize(),sourceId:y.id}));const w=I=>{const M=(I?"symbol:":"other:")+y.id,L=i.B(M,this.scope),N=this._sourceCaches[M]=new Xn(L,y,I);(I?this._symbolSourceCaches:this._otherSourceCaches)[y.id]=N,N.onAdd(this.map)};w(!1),a.type!=="vector"&&a.type!=="geojson"||w(!0),y.onAdd&&y.onAdd(this.map),f.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(e){this._checkLoaded();const a=this.getOwnSource(e);if(!a)throw new Error("There is no source with this ID");for(const y in this._layers)if(this._layers[y].source===e)return this.fire(new i.y(new Error(`Source "${e}" cannot be removed while layer "${y}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===e)return this.fire(new i.y(new Error(`Source "${e}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const y=Object.entries(this.stylesheet.iconsets).find(([w,I])=>I.type==="source"&&I.source===e);if(y)return this.fire(new i.y(new Error(`Source "${e}" cannot be removed while iconset "${y[0]}" is using it.`)))}const f=this.getOwnSourceCaches(e);for(const y of f){const w=i.dp(y.id);delete this._sourceCaches[w],this._changes.discardSourceCacheUpdate(y.id),y.fire(new i.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:y.getSource().id})),y.setEventedParent(null),y.clearTiles()}return delete this._otherSourceCaches[e],delete this._symbolSourceCaches[e],this.mergeSources(),a.setEventedParent(null),a.onRemove&&a.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(e,a){this._checkLoaded(),this.getOwnSource(e).setData(a),this._changes.setDirty()}getOwnSource(e){const a=this.getOwnSourceCache(e);return a&&a.getSource()}getOwnSources(){const e=[];for(const a in this._otherSourceCaches){const f=this.getOwnSourceCache(a);f&&e.push(f.getSource())}return e}areTilesLoaded(){const e=this._mergedSourceCaches;for(const a in e){const f=e[a]._tiles;for(const y in f){const w=f[y];if(w.state!=="loaded"&&w.state!=="errored")return!1}}return!0}setLights(e){if(this._checkLoaded(),!e)return delete this.ambientLight,void delete this.directionalLight;const a=this._getTransitionParameters();for(const w of e){if(this._validate(cr,"lights",w))return;switch(w.type){case"ambient":if(this.ambientLight){const I=this.ambientLight;I.set(w),I.updateTransitions(a)}else this.ambientLight=new ao(w,Cn||(Cn=new i.a9({color:new i.aa(i.a6.properties_light_ambient.color),"color-use-theme":new i.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.aa(i.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const I=this.directionalLight;I.set(w),I.updateTransitions(a)}else this.directionalLight=new ao(w,Nn||(Nn=new i.a9({direction:new i.ap(i.a6.properties_light_directional.direction),color:new i.aa(i.a6.properties_light_directional.color),"color-use-theme":new i.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.aa(i.a6.properties_light_directional.intensity),"cast-shadows":new i.aa(i.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new i.aa(i.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new i.aa(i.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const f=Object.assign(a,{worldview:this.map.getWorldview()}),y=new i.ac(this.z||0,f);this.ambientLight&&this.ambientLight.recalculate(y),this.directionalLight&&this.directionalLight.recalculate(y),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const e=this.directionalLight,a=this.ambientLight;if(!e||!a)return;const f=U=>.2126*(U[0]<=.03928?U[0]/12.92:Math.pow((U[0]+.055)/1.055,2.4))+.7152*(U[1]<=.03928?U[1]/12.92:Math.pow((U[1]+.055)/1.055,2.4))+.0722*(U[2]<=.03928?U[2]/12.92:Math.pow((U[2]+.055)/1.055,2.4)),y=e.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),w=e.properties.get("intensity"),I=e.properties.get("direction"),M=1-i.d3(I.x,I.y,I.z)[2]/90,L=f(y)*w*M,N=a.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),V=a.properties.get("intensity"),Z=f(N)*V;return Number(((L+Z)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const e=[];return this.directionalLight&&e.push(this.directionalLight.get()),this.ambientLight&&e.push(this.ambientLight.get()),e}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(e){if(e==null||e===""&&this.isRootStyle())return this;if(i.dq(e)){const a=i.dr(e),f=this.fragments.find(({id:w})=>w===a);if(!f)return;const y=i.dp(e);return f.style.getFragmentStyle(y)}{const a=this.fragments.find(({id:f})=>f===e);return a?a.style:void 0}}setFeaturesetSelectors(e){if(!e)return;const a={},f=(y,w="")=>`${y}::${w}`;this._featuresetSelectors={};for(const y in e){const w=this._featuresetSelectors[y]=[];for(const I of e[y].selectors){if(I.featureNamespace){const L=this.getOwnLayer(I.layer);if(!L){i.w(`Layer is undefined for selector: ${I.layer}`);continue}const N=f(L.source,L.sourceLayer);if(N in a&&a[N]!==I.featureNamespace){i.w(`"featureNamespace ${I.featureNamespace} of featureset ${y}'s selector is not associated to the same source, skip this selector`);continue}a[N]=I.featureNamespace}let M;if(I.properties)for(const L in I.properties){const N=i.U(I.properties[L]);N.result==="success"&&(M=M||{},M[L]=N.value)}w.push({layerId:I.layer,namespace:I.featureNamespace,properties:M,uniqueFeatureID:I._uniqueFeatureID})}}}getFeaturesetDescriptors(e){const a=this.getFragmentStyle(e);if(!a||!a.stylesheet.featuresets)return[];const f=[];for(const y in a.stylesheet.featuresets)f.push({featuresetId:y,importId:a.scope?a.scope:void 0});return f}getFeaturesetLayers(e,a){const f=this.getFragmentStyle(a),y=f.stylesheet.featuresets;if(!y||!y[e])return this.fire(new i.y(new Error(`The featureset '${e}' does not exist in the map's style and cannot be queried.`))),[];const w=[];for(const I of y[e].selectors){const M=f.getOwnLayer(I.layer);M&&w.push(M)}return w}getConfigProperty(e,a){const f=this.getFragmentStyle(e);if(!f)return null;const y=i.B(a,f.scope),w=f.options.get(y),I=w?w.value||w.default:null;return I?I.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(e,a){const f=i.B(e,a);return this._mergedIndoor[f]}setIndoorData(e,a){this.map.indoor.setIndoorData(a)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(e,a,f){const y=this.getFragmentStyle(e);if(!y)return;const w=y.stylesheet.schema;if(!w||!w[a])return;const I=i.U(f);if(I.result!=="success")return void pc(this,I.value);const M=I.value.expression,L=i.B(a,y.scope),N=y.options.get(L);if(!N)return;let V;const{minValue:Z,maxValue:U,stepValue:X,type:K,values:rt}=w[a],ht=i.U(w[a].default);ht.result==="success"&&(V=ht.value.expression),V?(this.options.set(L,Object.assign({},N,{value:M,default:V,minValue:Z,maxValue:U,stepValue:X,type:K,values:rt})),this.updateConfigDependencies(a)):this.fire(new i.y(new Error(`No schema defined for the config option "${a}" in the "${e}" fragment.`)))}getConfig(e){const a=this.getFragmentStyle(e);if(!a)return null;const f=a.stylesheet.schema;if(!f)return null;const y={};for(const w in f){const I=i.B(w,a.scope),M=a.options.get(I),L=M?M.value||M.default:null;y[w]=L?L.serialize():null}return y}setConfig(e,a){const f=this.getFragmentStyle(e);f&&(f.updateConfig(a,f.stylesheet.schema),this.updateConfigDependencies())}getSchema(e){const a=this.getFragmentStyle(e);return a?a.stylesheet.schema:null}setSchema(e,a){const f=this.getFragmentStyle(e);f&&(f.stylesheet.schema=a,f.updateConfig(f._config,a),this.updateConfigDependencies())}updateConfig(e,a){if(this._config=e,e||a)if(a)for(const f in a){let y,w;const I=i.U(a[f].default);if(I.result==="success"&&(y=I.value.expression),e&&e[f]!==void 0){const U=i.U(e[f]);U.result==="success"&&(w=U.value.expression)}const{minValue:M,maxValue:L,stepValue:N,type:V,values:Z}=a[f];if(y){const U=i.B(f,this.scope);this.options.set(U,{default:y,value:w,minValue:M,maxValue:L,stepValue:N,type:V,values:Z})}else this.fire(new i.y(new Error(`No schema defined for config option "${f}".`)))}else this.fire(new i.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(e,a=()=>!0){for(const f of e){const y=this.getLayer(f);y&&a(y)&&(y.possiblyEvaluateVisibility(),this._updateLayer(y),this._changes.setDirty())}}updateConfigDependencies(e){this._updateLayers(this._configDependentLayers,a=>!e||a.expressionDependencies.configDependencies.has(e)),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(a=>{const f=a._styleColorTheme.colorThemeOverride?a._styleColorTheme.colorThemeOverride:a._styleColorTheme.colorTheme;if(f){const y=a._evaluateColorThemeData(f);(!a._styleColorTheme.lut&&y!==""||a._styleColorTheme.lut&&y!==a._styleColorTheme.lut.data)&&a.setColorTheme(f)}}),this._changes.setDirty()}addLayer(e,a,f={}){this._checkLoaded();const y=e.id;if(this._layers[y])return void this.fire(new i.y(new Error(`Layer with id "${y}" already exists on this map`)));let w;if(e.type==="custom"){if(pc(this,i.ds(e)))return;w=i.dt(e,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof e.source=="object"&&(this.addSource(y,e.source),e=i.dn(e),e=Object.assign(e,{source:y})),this._validate(Qn,`layers.${y}`,e,{arrayIndex:-1},f))return;w=i.dt(e,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(w),w.setEventedParent(this,{layer:{id:y}})}const I=i.B(w.source,w.scope);w.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(I),w.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(I);let M=this._order.length;if(a){const Z=this._order.indexOf(a);if(Z===-1)return void this.fire(new i.y(new Error(`Layer with id "${a}" does not exist on this map.`)));w.slot===this._layers[a].slot?M=Z:i.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(M,0,y),this._layerOrderChanged=!0,this._layers[y]=w;const L=this.getOwnLayerSourceCache(w),N=!!this.directionalLight&&this.directionalLight.shadowsEnabled();L&&w.canCastShadows()&&N&&(L.castsShadows=!0);const V=this._changes.getRemovedLayer(w);if(V&&w.source&&L&&w.type!=="custom"){this._changes.discardLayerRemoval(w);const Z=i.B(w.source,w.scope);V.type!==w.type?this._changes.updateSourceCache(Z,"clear"):(this._changes.updateSourceCache(Z,"reload"),L.pause())}this._updateLayer(w),w.onAdd&&w.onAdd(this.map),w.scope=this.scope,this.mergeLayers()}moveLayer(e,a){this._checkLoaded();const f=this._checkLayer(e);if(!f||e===a)return;const y=this._order.indexOf(e);this._order.splice(y,1);let w=this._order.length;if(a){const I=this._order.indexOf(a);if(I===-1)return void this.fire(new i.y(new Error(`Layer with id "${a}" does not exist on this map.`)));f.slot===this._layers[a].slot?w=I:i.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(w,0,e),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(e){this._checkLoaded();const a=this._checkLayer(e);if(!a)return;a.setEventedParent(null);const f=this._order.indexOf(e);this._order.splice(f,1),delete this._layers[e],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(a.fqid),this._indoorDependentLayers.delete(a.fqid),this._changes.removeLayer(a);const y=this.getOwnLayerSourceCache(a);if(y&&y.castsShadows){let w=!1;for(const I in this._layers)if(this._layers[I].source===a.source&&this._layers[I].canCastShadows()){w=!0;break}y.castsShadows=w}a.onRemove&&a.onRemove(this.map),this.mergeLayers()}getOwnLayer(e){return this._layers[e]}hasLayer(e){return e in this._mergedLayers}hasLayerType(e){for(const a in this._layers)if(this._layers[a].type===e)return!0;return!1}setLayerZoomRange(e,a,f){this._checkLoaded();const y=this._checkLayer(e);y&&(y.minzoom===a&&y.maxzoom===f||(a!=null&&(y.minzoom=a),f!=null&&(y.maxzoom=f),this._updateLayer(y)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(e,a){this._checkLoaded();const f=this._checkLayer(e);f&&f.slot!==a&&(f.slot=a,this._updateLayer(f))}setFilter(e,a,f={}){this._checkLoaded();const y=this._checkLayer(e);if(y&&!i.bx(y.filter,a))return a==null?(y.filter=void 0,void this._updateLayer(y)):void(this._validate(ar,`layers.${y.id}.filter`,a,{layerType:y.type},f)||(y.filter=i.dn(a),this._updateLayer(y)))}getFilter(e){const a=this._checkLayer(e);if(a)return i.dn(a.filter)}setLayoutProperty(e,a,f,y={}){this._checkLoaded();const w=this._checkLayer(e);if(w&&!i.bx(w.getLayoutProperty(a),f)){if(f!=null&&(!y||y.validate!==!1)&&pc(w,Zo.call(We,{key:`layers.${e}.layout.${a}`,layerType:w.type,objectKey:a,value:f,styleSpec:i.a6,style:{glyphs:!0,sprite:!0}})))return;w.setLayoutProperty(a,f),w.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(w.fqid),w.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(w.fqid),this._updateLayer(w)}}setLayerProperty(e,a,f,y={}){this._checkLoaded();const w=this._checkLayer(e);w&&(a==="appearances"?(w.setAppearances(f),this._changes.setDirty()):w.isPaintProperty(a)?this.setPaintProperty(e,a,f,y):this.setLayoutProperty(e,a,f,y))}getLayoutProperty(e,a){const f=this._checkLayer(e);if(f)return f.getLayoutProperty(a)}setPaintProperty(e,a,f,y={}){this._checkLoaded();const w=this._checkLayer(e);if(!w||i.bx(w.getPaintProperty(a),f)||f!=null&&(!y||y.validate!==!1)&&pc(w,bi.call(We,{key:`layers.${e}.paint.${a}`,layerType:w.type,objectKey:a,value:f,styleSpec:i.a6})))return;const I=w.setPaintProperty(a,f);w.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(w.fqid),w.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(w.fqid),I&&this._updateLayer(w),this._changes.updatePaintProperties(w)}getPaintProperty(e,a){const f=this._checkLayer(e);if(f)return f.getPaintProperty(a)}setFeatureState(e,a){if(this._checkLoaded(),"target"in e){if("featuresetId"in e.target){const{featuresetId:L,importId:N}=e.target,V=this.getFragmentStyle(N),Z=V.getFeaturesetLayers(L);for(const{source:U,sourceLayer:X}of Z)V.setFeatureState({id:e.id,source:U,sourceLayer:X},a)}else if("layerId"in e.target){const{layerId:L}=e.target,N=this.getLayer(L);this.setFeatureState({id:e.id,source:N.source,sourceLayer:N.sourceLayer},a)}return}const f=e.source,y=e.sourceLayer,w=this._checkSource(f);if(!w)return;const I=w.type;if(I==="geojson"&&y)return void this.fire(new i.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(I==="vector"&&!y)return void this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")));e.id===void 0&&this.fire(new i.y(new Error("The feature id parameter must be provided.")));const M=this.getOwnSourceCaches(f);for(const L of M)L.setFeatureState(y,e.id,a)}removeFeatureState(e,a){if(this._checkLoaded(),"target"in e){if("featuresetId"in e.target){const{featuresetId:L,importId:N}=e.target,V=this.getFragmentStyle(N),Z=V.getFeaturesetLayers(L);for(const{source:U,sourceLayer:X}of Z)V.removeFeatureState({id:e.id,source:U,sourceLayer:X},a)}else if("layerId"in e.target){const{layerId:L}=e.target,N=this.getLayer(L);this.removeFeatureState({id:e.id,source:N.source,sourceLayer:N.sourceLayer},a)}return}const f=e.source,y=this._checkSource(f);if(!y)return;const w=y.type,I=w==="vector"?e.sourceLayer:void 0;if(w==="vector"&&!I)return void this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(a&&typeof e.id!="string"&&typeof e.id!="number")return void this.fire(new i.y(new Error("A feature id is required to remove its specific state property.")));const M=this.getOwnSourceCaches(f);for(const L of M)L.removeFeatureState(I,e.id,a)}getFeatureState(e){if(this._checkLoaded(),"target"in e){let w;if("featuresetId"in e.target){const{featuresetId:I,importId:M}=e.target,L=this.getFragmentStyle(M),N=L.getFeaturesetLayers(I);for(const{source:V,sourceLayer:Z}of N){const U=L.getFeatureState({id:e.id,source:V,sourceLayer:Z});if(U&&!w)w=U;else if(!i.bx(w,U))return void this.fire(new i.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in e.target){const{layerId:I}=e.target,M=this.getLayer(I);w=this.getFeatureState({id:e.id,source:M.source,sourceLayer:M.sourceLayer})}return w}const a=e.source,f=e.sourceLayer,y=this._checkSource(a);if(y){if(y.type!=="vector"||f)return e.id===void 0&&this.fire(new i.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(a)[0].getFeatureState(f,e.id);this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(e){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,e),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const e=this.getTerrain(),a=e&&this.terrain&&this.terrain.scope===this.scope?e:this.stylesheet.terrain;return i.du({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:a,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},f=>f!==void 0)}_updateFilteredLayers(e){for(const a of Object.values(this._mergedLayers))e(a)&&this._updateLayer(a)}_updateLayer(e){this._changes.updateLayer(e);const a=this.getLayerSourceCache(e),f=i.B(e.source,e.scope),y=this._changes.getUpdatedSourceCaches();e.source&&!y[f]&&a&&a.getSource().type!=="raster"&&(this._changes.updateSourceCache(f,"reload"),a.pause()),e.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(e){const a=M=>this._mergedLayers[M].is3D(!!this.terrain),f=this.order,y={},w=[];for(let M=f.length-1;M>=0;M--){const L=f[M];if(a(L)){y[L]=M;for(const N of e){const V=N[L];if(V)for(const Z of V)w.push(Z)}}}w.sort((M,L)=>L.intersectionZ-M.intersectionZ);const I=[];for(let M=f.length-1;M>=0;M--){const L=f[M];if(a(L))for(let N=w.length-1;N>=0;N--){const V=w[N].feature;if(V.layer&&y[V.layer.id]<M)break;I.push(V),w.pop()}else for(const N of e){const V=N[L];if(V)for(const Z of V)I.push(Z.feature)}}return I}queryRasterValue(e,a,f){const y=this.getOwnSource(e);return y?y.type!=="raster-array"?(this.fire(new i.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):y.queryRasterArrayValue(a,f):(this.fire(new i.y(new Error(`Source with id "${e}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(e,a,f){let y;a&&!Array.isArray(a)&&a.filter&&(this._validate(ar,"queryRenderedFeatures.filter",a.filter,null,a),y=i.b5(a.filter));const w={},I=V=>{if(Zu.has(V.type))return;const Z=this.getOwnLayerSourceCache(V),U=w[Z.id]=w[Z.id]||{sourceCache:Z,layers:{},has3DLayers:!1};V.is3D(!!this.terrain)&&(U.has3DLayers=!0),U.layers[V.fqid]=U.layers[V.fqid]||{styleLayer:V,targets:[]},U.layers[V.fqid].targets.push({filter:y})};if(a&&a.layers){if(!Array.isArray(a.layers))return this.fire(new i.y(new Error("parameters.layers must be an Array."))),[];for(const V of a.layers){const Z=this._layers[V];if(!Z)return this.fire(new i.y(new Error(`The layer '${V}' does not exist in the map's style and cannot be queried for features.`))),[];I(Z)}}else for(const V in this._layers)I(this._layers[V]);const M=this._queryRenderedFeatures(e,w,f),L=this._flattenAndSortRenderedFeatures(M),N=[];for(const V of L)i.dv(V.layer.id)===this.scope&&N.push(V);return N}queryRenderedFeatureset(e,a,f){let y;a&&!Array.isArray(a)&&a.filter&&(this._validate(ar,"queryRenderedFeatures.filter",a.filter,null,a),y=i.b5(a.filter));const w="mock",I=[];if(a&&a.target)I.push(Object.assign({},a,{targetId:w,filter:y}));else{const V=this.getFeaturesetDescriptors();for(const Z of V)I.push({targetId:w,filter:y,target:Z});for(const{style:Z}of this.fragments){const U=Z.getFeaturesetDescriptors();for(const X of U)I.push({targetId:w,filter:y,target:X})}}const M=this.queryRenderedTargets(e,I,f),L=[],N=new Set;for(const V of M)for(const Z of V.variants[w])za(Z,V,N)||L.push(new i.dw(V,Z));return L}queryRenderedTargets(e,a,f){const y={},w=(M,L,N,V)=>{const Z=y[L.id]=y[L.id]||{sourceCache:L,layers:{},has3DLayers:!1};if(Z.layers[M.fqid]=Z.layers[M.fqid]||{styleLayer:M,targets:[]},M.is3D(!!this.terrain)&&(Z.has3DLayers=!0),!V)return N.uniqueFeatureID=!1,void Z.layers[M.fqid].targets.push(N);Z.layers[M.fqid].targets.push(Object.assign({},N,{namespace:V.namespace,properties:V.properties,uniqueFeatureID:V.uniqueFeatureID}))};for(const M of a)if("featuresetId"in M.target){const{featuresetId:L,importId:N}=M.target,V=this.getFragmentStyle(N);if(!V||!V._featuresetSelectors)continue;const Z=V._featuresetSelectors[L];if(!Z){this.fire(new i.y(new Error(`The featureset '${L}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const U of Z){const X=V.getOwnLayer(U.layerId);X&&!Zu.has(X.type)&&w(X,V.getOwnLayerSourceCache(X),M,U)}}else if("layerId"in M.target){const{layerId:L}=M.target,N=this.getLayer(L);if(!N||Zu.has(N.type))continue;w(N,this.getLayerSourceCache(N),M)}const I=this._queryRenderedFeatures(e,y,f);return this._flattenAndSortRenderedFeatures(I)}_queryRenderedFeatures(e,a,f){const y=[],w=!!this.map._showQueryGeometry,I=gn.createFromScreenPoints(e,f);for(const M in a){const L=Qa(I,a[M],this._availableImages,f,w);Object.keys(L).length&&y.push(L)}if(this.placement)for(const M in a){if(!a[M].sourceCache._onlySymbols)continue;const L=Hl(I.screenGeometry,a[M],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(L).length&&y.push(L)}return y}querySourceFeatures(e,a){const f=a&&a.filter;f&&this._validate(ar,"querySourceFeatures.filter",f,null,a);let y=[];const w=this.getOwnSourceCaches(e);for(const I of w)y=y.concat(Eh(I,a));return y}addSourceType(e,a,f){return Ia.getSourceType(e)?f(new Error(`A source type called "${e}" already exists.`)):(Ia.setSourceType(e,a),a.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:a.workerSourceURL},f):f(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(e,a,f={}){this._checkLoaded();const y=this.light.getLight();let w=!1;for(const M in e)if(!i.bx(e[M],y[M])){w=!0;break}if(!w)return;const I=this._getTransitionParameters();this.light.setLight(e,a,f),this.light.updateTransitions(I)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=i.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&i.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(e,a=1){if(this._checkLoaded(),!e)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),a===0&&delete this.terrain,e===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let f=e;const y=e.source==null;if(a===1){if(this.disableElevatedTerrain)return;if(typeof f.source=="object"){const M="terrain-dem-src";this.addSource(M,f.source),f=i.dn(f),f=Object.assign(f,{source:M})}const w=Object.assign({},f),I={};if(this.terrain&&y){w.source=this.terrain.get().source;const M=this.terrain?this.getFragmentStyle(this.terrain.scope):null;M&&(I.style=M.serialize())}if(this._validate(zr,"terrain",w,I))return}if(!this.terrain||this.terrain.scope!==this.scope&&!y||this.terrain&&a!==this.terrain.drapeRenderMode){if(!f)return;this._createTerrain(f,a),this.fire(new i.z("data",{dataType:"style"}))}else{const w=this.terrain,I=w.get();for(const M of Object.keys(i.a6.terrain))!f.hasOwnProperty(M)&&i.a6.terrain[M].default&&(f[M]=i.a6.terrain[M].default);for(const M in e)if(!i.bx(e[M],I[M])){w.set(e,this.options),this.stylesheet.terrain=e;const L=this._getTransitionParameters({duration:0});w.updateTransitions(L),this.fire(new i.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(e){const a=this.fog=new Hi(e,this.map.transform,this.scope,this.options);this.stylesheet.fog=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_createSnow(e){const a=this.snow=new Vo(e,this.map.transform,this.scope,this.options);this.stylesheet.snow=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_createRain(e){const a=this.rain=new Qr(e,this.map.transform,this.scope,this.options);this.stylesheet.rain=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const e of this.map._markers)e._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(e){if(this._checkLoaded(),!e)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const a=this.fog;if(!i.bx(a.get(),e)){a.set(e,this.options),this.stylesheet.fog=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createFog(e);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(e){if(this._checkLoaded(),!e)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const a=this.snow;if(!i.bx(a.get(),e)){a.set(e,this.options),this.stylesheet.snow=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createSnow(e);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(e){if(this._checkLoaded(),!e)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const a=this.rain;if(!i.bx(a.get(),e)){a.set(e,this.options),this.stylesheet.rain=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createRain(e);this._markersNeedUpdate=!0}_reloadColorTheme(){const e=()=>{for(const y in this._layers)this._layers[y].lut=this._styleColorTheme.lut;for(const y in this._sourceCaches)this._sourceCaches[y].clearTiles()},a=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!a)return this._styleColorTheme.lut=null,void e();const f=this._evaluateColorThemeData(a);this._loadColorTheme(f).then(()=>{this.fire(new i.z("colorthemeset")),e()}).catch(y=>{i.w(`Couldn't set color theme: ${y}`)})}setColorTheme(e){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&i.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=e,this._reloadColorTheme()}setImportColorTheme(e,a){const f=this.getFragmentStyle(e);f&&(f._styleColorTheme.colorThemeOverride=a,f._reloadColorTheme())}_getTransitionParameters(e){return{now:i.o.now(),transition:Object.assign(this.transition,e)}}updateDrapeFirstLayers(){if(!this.terrain)return;const e=[],a=[];for(const f of this._mergedOrder)this.isLayerDraped(this._mergedLayers[f])?e.push(f):a.push(f);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...e),this._drapedFirstOrder.push(...a)}_createTerrain(e,a){const f=this.terrain=new oe(e,a,this.scope,this.options,this.map.getWorldview());a===1&&(this.stylesheet.terrain=e),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const y=this._getTransitionParameters({duration:0});f.updateTransitions(y)}_force3DLayerUpdate(){for(const e in this._layers){const a=this._layers[e];a.type==="fill-extrusion"&&this._updateLayer(a)}}_forceSymbolLayerUpdate(){for(const e in this._layers){const a=this._layers[e];a.type==="symbol"&&this._updateLayer(a)}}_validate(e,a,f,y,w={}){if(w&&w.validate===!1)return!1;const I=Object.assign({},this.serialize());return pc(this,e.call(We,Object.assign({key:a,style:I,value:f,styleSpec:i.a6},y)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),i.dx.off("pluginStateChange",this._rtlTextPluginCallback);for(const e in this._mergedLayers)this._mergedLayers[e].setEventedParent(null);for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles(),this._mergedSourceCaches[e].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(e){const a=this.getSourceCaches(e);for(const f of a)f.clearTiles()}clearSources(){for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles()}clearLayers(){for(const e in this._mergedLayers){const a=this._mergedLayers[e];a._clear&&a._clear()}}reloadSource(e){const a=this.getSourceCaches(e);for(const f of a)f.resume(),f.reload()}reloadSources(){for(const e of this.getSources())e.reload&&e.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(e=>{e.modelManager.reloadModels(e.scope)})}updateSources(e){let a;this.directionalLight&&(a=Dh(this.directionalLight));const f=new Set;for(const y in this._mergedLayers){const w=this._mergedLayers[y];w.hasElevation()&&!f.has(w.source)&&f.add(w.source)}for(const y in this._mergedSourceCaches){const w=this._mergedSourceCaches[y],I=f.has(w._source.id);w.update(e,void 0,void 0,a,I)}}_generateCollisionBoxes(){for(const e in this._sourceCaches){const a=this._sourceCaches[e];a.resume(),a.reload()}}_updatePlacement(e,a,f,y,w,I,M=!1){let L=!1,N=!1;const V={},Z={};for(const U of this._mergedOrder){const X=this._mergedLayers[U];if(X.type!=="symbol")continue;const K=i.B(X.source,X.scope);let rt=V[K];if(!rt){const lt=this.getLayerSourceCache(X);if(!lt)continue;const _t=lt.getRenderableIds(!0).map(Mt=>lt.getTileByID(Mt));Z[K]=_t.slice(),rt=V[K]=_t.sort((Mt,vt)=>vt.tileID.overscaledZ-Mt.tileID.overscaledZ||(Mt.tileID.isLessThan(vt.tileID)?-1:1))}const ht=this.crossTileSymbolIndex.addLayer(X,rt,a.center.lng,a.projection);L=L||ht}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),M=M||this._layerOrderChanged||y===0,this._layerOrderChanged&&this.fire(new i.z("neworder")),(M||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(i.o.now(),a.zoom))&&(this.pauseablePlacement=new Fa(a,this._mergedOrder,M,f,y,w,this.placement,this.fog&&a.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,V,Z,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(i.o.now()),N=!0),L&&this.pauseablePlacement.placement.setStale()),N||L){this._buildingIndex.onNewFrame(a.zoom);for(let U=0;U<this._mergedOrder.length;U++){const X=this._mergedLayers[this._mergedOrder[U]];if(X.type!=="symbol")continue;const K=this.isLayerClipped(X);this.placement.updateLayerOpacities(X,V[i.B(X.source,X.scope)],U,K?I:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(i.o.now())}}_releaseSymbolFadeTiles(){for(const e in this._sourceCaches)this._sourceCaches[e].releaseSymbolFadeTiles()}addImport(e,a){this._checkLoaded();const f=this.stylesheet.imports=this.stylesheet.imports||[];if(f.findIndex(({id:w})=>w===e.id)!==-1)return void this.fire(new i.y(new Error(`Import with id '${e.id}' already exists in the map's style.`)));if(!a)return f.push(e),this._loadImports([e],!0);const y=f.findIndex(({id:w})=>w===a);return y===-1&&this.fire(new i.y(new Error(`Import with id "${a}" does not exist on this map.`))),this.stylesheet.imports=f.slice(0,y).concat(e).concat(f.slice(y)),this._loadImports([e],!0,a)}updateImport(e,a){this._checkLoaded();const f=this.stylesheet.imports||[],y=this.getImportIndex(e);return y===-1?this:typeof a=="string"?(this.setImportUrl(e,a),this):(a.url&&a.url!==f[y].url&&this.setImportUrl(e,a.url),i.bx(a.config,f[y].config)||this.setImportConfig(e,a.config,a.data.schema),i.bx(a.data,f[y].data)||this.setImportData(e,a.data),this)}moveImport(e,a){this._checkLoaded();let f=this.stylesheet.imports||[];const y=this.getImportIndex(e);if(y===-1)return this;const w=this.getImportIndex(a);if(w===-1)return this;const I=f[y],M=this.fragments[y];return f=f.filter(({id:L})=>L!==e),this.fragments=this.fragments.filter(({id:L})=>L!==e),this.stylesheet.imports=f.slice(0,w).concat(I).concat(f.slice(w)),this.fragments=this.fragments.slice(0,w).concat(M).concat(this.fragments.slice(w)),this.mergeLayers(),this}setImportUrl(e,a){this._checkLoaded();const f=this.stylesheet.imports||[],y=this.getImportIndex(e);if(y===-1)return this;f[y].url=a;const w=this.fragments[y];return w.style=this._createFragmentStyle(f[y]),w.style.on("style.import.load",()=>this.mergeAll()),w.style.loadURL(a),this}setImportData(e,a){this._checkLoaded();const f=this.getImportIndex(e),y=this.stylesheet.imports||[];return f===-1?this:a?(this.fragments[f].style.setState(a),this._reloadImports(),this):(delete y[f].data,this.setImportUrl(e,y[f].url))}setImportConfig(e,a,f){this._checkLoaded();const y=this.getImportIndex(e),w=this.stylesheet.imports||[];if(y===-1)return this;a?w[y].config=a:delete w[y].config;const I=this.fragments[y];f&&I.style.stylesheet&&(I.style.stylesheet.schema=f);const M=I.style.stylesheet&&I.style.stylesheet.schema;return I.config=a,I.style.updateConfig(a,M),this.updateConfigDependencies(),this}removeImport(e){this._checkLoaded();const a=this.stylesheet.imports||[],f=this.getImportIndex(e);f!==-1&&(a.splice(f,1),this.fragments[f].style._remove(),this.fragments.splice(f,1),this._reloadImports())}getImportIndex(e){const a=(this.stylesheet.imports||[]).findIndex(f=>f.id===e);return a===-1&&this.fire(new i.y(new Error(`Import '${e}' does not exist in the map's style and cannot be updated.`))),a}getLayer(e){return this._mergedLayers[e]}getSources(){const e=[];for(const a in this._mergedOtherSourceCaches){const f=this._mergedOtherSourceCaches[a];f&&e.push(f.getSource())}return e}getSource(e,a){const f=this.getSourceCache(e,a);return f&&f.getSource()}getLayerSource(e){const a=this.getLayerSourceCache(e);return a&&a.getSource()}getSourceCache(e,a){const f=i.B(e,a);return this._mergedOtherSourceCaches[f]}getLayerSourceCache(e){const a=i.B(e.source,e.scope);return e.type==="symbol"?this._mergedSymbolSourceCaches[a]:this._mergedOtherSourceCaches[a]}getSourceCaches(e){if(e==null)return Object.values(this._mergedSourceCaches);const a=[];return this._mergedOtherSourceCaches[e]&&a.push(this._mergedOtherSourceCaches[e]),this._mergedSymbolSourceCaches[e]&&a.push(this._mergedSymbolSourceCaches[e]),a}updateSourceCaches(){const e=this._changes.getUpdatedSourceCaches();for(const a in e){const f=e[a];f==="reload"?this.reloadSource(a):f==="clear"&&this.clearSource(a)}}updateLayers(e){const a=this._changes.getUpdatedPaintProperties();for(const f of a){const y=this.getLayer(f);y&&y.updateTransitions(e)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(e){this.stylesheet.glyphs=e,this.glyphManager.setURL(e)}getImages(e,a,f){this.imageManager.getImages(a.images,a.scope,f),this._updateTilesForChangedImages();const y=I=>{if(I){const M=a.images.map(L=>i.I.toString(L));I.setDependencies(a.tileID.key,a.type,M)}},w=i.B(a.source,a.scope);y(this._mergedOtherSourceCaches[w]),y(this._mergedSymbolSourceCaches[w]),a.images.some(I=>I.iconsetId)&&this.fire(new i.z("data",{dataType:"style"}))}rasterizeImages(e,a,f){this.imageManager.rasterizeImages(a,f)}getGlyphs(e,a,f){this.glyphManager.getGlyphs(a.stacks,f)}getResource(e,a,f){return i.dy(a,f)}getOwnSourceCache(e){return this._otherSourceCaches[e]}getOwnLayerSourceCache(e){return e.type==="symbol"?this._symbolSourceCaches[e.source]:this._otherSourceCaches[e.source]}getOwnSourceCaches(e){const a=[];return this._otherSourceCaches[e]&&a.push(this._otherSourceCaches[e]),this._symbolSourceCaches[e]&&a.push(this._symbolSourceCaches[e]),a}_isSourceCacheLoaded(e){const a=this.getOwnSourceCaches(e);return a.length===0?(this.fire(new i.y(new Error(`There is no source with ID '${e}'`))),!1):a.every(f=>f.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(e,a){if(!this._clipLayerPresent&&e.type!=="fill-extrusion"&&e.type!=="building")return!1;const f=e.type==="fill-extrusion"&&(e.sourceLayer==="building"||e.sourceLayer==="procedural_buildings"),y=e.type==="building";if(e.is3D(!!this.terrain)){if(f||y||a&&a.type==="batched-model"||e.type==="model")return!0}else if(e.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(e=>{e.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Ia.getSourceType=function(p){return ul[p]},Ia.setSourceType=function(p,e){ul[p]=e},Ia.registerForPluginStateChange=i.dz;class ua extends i.E{constructor(e){super(),this._style=e,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},i.aX(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(e){e===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=e,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(e){this._activeFloorsVisible=e,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(e){for(const[a,f]of Object.entries(e.buildings))if(this._buildings[a])for(const y of f.floorIds)this._buildings[a].floors[y]||(this._buildings[a].floors[y]=f.floors[y]);else this._buildings[a]=f;for(const a of e.activeFloors)this._activeFloors.add(a);this._updateIndoorSelector()}getIndoorTileOptions(e,a){const f=this._style.getIndoorSourceLayers(e,a);return f&&this._indoorState?{sourceLayers:f,indoorState:this._indoorState}:null}_updateUI(e,a,f){const y=function(w,I,M,L){let N=null,V=Number.MAX_SAFE_INTEGER;if(L<16)return null;for(const[Z,U]of Object.entries(w)){const X=U.center;if(X){const K=I.distanceTo(i.aS.convert(X));K<V&&M.contains(X)&&(V=K,N=Z)}}return N}(this._buildings,a,f,e);y!==this._closestBuildingId&&(this._closestBuildingId=y,this._updateIndoorSelector())}_updateIndoorSelector(){const e=this._buildings,a=this._closestBuildingId,f=a&&e?e[a]:void 0;if(!f)return void this.fire(new i.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let y=null;for(const I of f.floorIds)if(this._activeFloors&&this._activeFloors.has(I)){y=I;break}const w=Array.from(f.floorIds).map(I=>({id:I,name:f.floors[I].name,zIndex:f.floors[I].zIndex})).sort((I,M)=>M.zIndex-I.zIndex);this.fire(new i.z("selector-update",{selectedFloorId:y,activeFloorsVisible:this._activeFloorsVisible,floors:w}))}_updateActiveFloors(){const e=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:e,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var Hu=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,gp=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Md=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib
#define DECLARE_MATERIAL_TABLE_INFO
#endif`,Jl="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",nh=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,Wu=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Lh=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Ba=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Cd=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,ri=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Rh=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const pu=[];Oa(Hu,pu),Oa(Md,pu),Oa(gp,pu);const kh={"_prelude_fog.vertex.glsl":Wu,"_prelude_terrain.vertex.glsl":nh,"_prelude_shadow.vertex.glsl":ri,"_prelude_material_table.vertex.glsl":`#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define MATERIAL_TABLE_DEBUG 0
uniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;
#if MATERIAL_TABLE_DEBUG
vec4 colorDebug;
#endif
};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { 
if (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; 
}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { 
iRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;
#if MATERIAL_TABLE_DEBUG
const vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;
#endif
uint offset=0u;
#if MATERIAL_TABLE_DEBUG
bool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}
#endif
offset++;
#if MATERIAL_TABLE_DEBUG
uint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}
#endif
offset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);
#if MATERIAL_TABLE_DEBUG
if(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}
#endif
uint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);
#if MATERIAL_TABLE_DEBUG
if(keepFinding)
{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}
#endif
offset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;
#if MATERIAL_TABLE_DEBUG
if(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}
#endif
info.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)
{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)
#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));
#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;
#endif`,"_prelude_fog.fragment.glsl":Lh,"_prelude_shadow.fragment.glsl":Rh,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":Ba,"_prelude_raster_particle.glsl":Cd},Pn={};jr("",nh),jr(Lh,Wu),jr(Rh,ri),jr(Ba,""),jr(Cd,"");const Fh=jr(gp,Md),Fc=Hu;var Dd={background:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef FLOOD_LIGHT
in highp float v_flood_radius;in float v_has_flood_light;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);
#ifdef FLOOD_LIGHT
float flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);
#endif
color.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
#ifdef FLOOD_LIGHT
out highp float v_flood_radius;out float v_has_flood_light;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
#ifdef FLOOD_LIGHT
v_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);
#endif
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:jr(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:jr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:jr("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:jr(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:jr(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:jr("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:jr("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:jr("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:jr(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:jr(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#else
#ifdef FEATURE_CUTOUT
apply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);
#endif
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:jr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:jr(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:jr(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:jr(`precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:jr("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:jr("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:jr(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:jr(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#define APPEARANCE_ICON 1.0
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
#ifdef Z_TEST_OCCLUSION
out_fade_opacity*=occlusion_opacity;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:jr("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:jr(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Jl),skyboxGradient:jr(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Jl),skyboxCapture:jr(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:jr(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:jr(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef FLIP_Y
coord.y=1.0-coord.y;
#endif
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#ifdef CLIP_ZERO_TO_ONE
v_depth=-1.0+2.0*v_depth; 
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:jr(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:jr(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:jr("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:jr("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:jr("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:jr("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Oa(p,e){const a=p.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let f of a)if(f=f.trim(),f[0]==="#"&&f.includes("if")&&!f.includes("endif")){f=f.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const y=f.split(" ");for(const w of y)e.includes(w)||e.push(w)}}function jr(p,e){const a=/#include\s+"([^"]+)"/g,f=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,y={},w=[],I=[];if(p=p.replace(a,(L,N)=>(I.push(N),"")),(e=e.replace(a,(L,N)=>(w.push(N),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let M=[...pu];Oa(p,M),Oa(e,M);for(const L of[...w,...I])kh[L]||console.error(`Undefined include: ${L}`),Pn[L]||(Pn[L]=[],Oa(kh[L],Pn[L])),M=[...M,...Pn[L]];return{fragmentSource:p=p.replace(f,(L,N,V,Z,U)=>(y[U]=!0,N==="define"?`
#ifndef HAS_UNIFORM_u_${U}
in ${V} ${Z} ${U};
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="initialize"?`
#ifdef HAS_UNIFORM_u_${U}
    ${V} ${Z} ${U} = u_${U};
#endif
`:N==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${V} ${Z} ${U};
#endif
`:N==="initialize-attribute"?"":void 0)),vertexSource:e=e.replace(f,(L,N,V,Z,U)=>{const X=`MATERIAL_ATTRIBUTE_OFFSET_${U}`,K=Z==="float"?"vec2":Z,rt=`GET_ATTRIBUTE_${K}(a_${U}, materialInfo, ${X})`,ht=U.match(/color/)?"color":K;return N==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${U}
in ${V} ${Z} a_${U};
#endif
`:y[U]?N==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
    #if !defined(${X})
        in ${V} ${K} a_${U};
    #endif
out ${V} ${Z} ${U};
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="initialize"?ht==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    ${U} = a_${U};
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`:`
#if !defined(HAS_UNIFORM_u_${U}) 
    #ifdef ${X}
        ${U} = unpack_mix_${ht}(${rt}, u_${U}_t);
    #else
        ${U} = unpack_mix_${ht}(a_${U}, u_${U}_t);
    #endif
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`:N==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${V} ${Z} a_${U};
    out ${V} ${Z} ${U};
#endif
`:N==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${U} = a_${U};
#endif
`:void 0:N==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
    #if !defined(${X})
        in ${V} ${K} a_${U};
    #endif  
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="define-instanced"?ht==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${U}0;
in vec4 a_${U}1;
in vec4 a_${U}2;
in vec4 a_${U}3;
#else
uniform ${V} ${Z} u_${U};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${V} ${K} a_${U};
#else
uniform ${V} ${Z} u_${U};
#endif
`:N==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${V} ${Z} ${U} = a_${U};
#endif
`:ht==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    #ifdef ${X}
        ${V} ${Z} ${U} = ${rt};
    #else
        ${V} ${Z} ${U} = a_${U};
    #endif
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`:`
#ifndef HAS_UNIFORM_u_${U}
    #ifdef ${X}
        ${V} ${Z} ${U} = unpack_mix_${ht}(${rt}, u_${U}_t);
    #else
        ${V} ${Z} ${U} = unpack_mix_${ht}(a_${U}, u_${U}_t);
    #endif
#else
    ${V} ${Z} ${U} = u_${U};
#endif
`}),usedDefines:M,vertexIncludes:w,fragmentIncludes:I}}class Xu{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(e,a,f,y,w,I,M,L){this.context=e;let N=this.boundPaintVertexBuffers.length!==y.length;for(let Z=0;!N&&Z<y.length;Z++)this.boundPaintVertexBuffers[Z]!==y[Z]&&(N=!0);let V=this.boundDynamicVertexBuffers.length!==M.length;for(let Z=0;!V&&Z<M.length;Z++)this.boundDynamicVertexBuffers[Z]!==M[Z]&&(V=!0);if(!this.vao||this.boundProgram!==a||this.boundLayoutVertexBuffer!==f||N||V||this.boundIndexBuffer!==w||this.boundVertexOffset!==I)this.freshBind(a,f,y,w,I,M,L);else{e.bindVertexArrayOES.set(this.vao);for(const Z of M)Z&&(Z.bind(),L&&Z.instanceCount&&Z.setVertexAttribDivisor(e.gl,a,L));w&&w.dynamicDraw&&w.bind()}}freshBind(e,a,f,y,w,I,M){const L=this.context,N=L.gl;this.vao&&this.destroy(),this.vao=L.gl.createVertexArray(),L.bindVertexArrayOES.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=a,this.boundPaintVertexBuffers=f,this.boundIndexBuffer=y,this.boundVertexOffset=w,this.boundDynamicVertexBuffers=I,a.enableAttributes(N,e),a.bind(),a.setVertexAttribPointers(N,e,w);for(const V of f)V.enableAttributes(N,e),V.bind(),V.setVertexAttribPointers(N,e,w);for(const V of I)V&&(V.enableAttributes(N,e),V.bind(),V.setVertexAttribPointers(N,e,w),M&&V.instanceCount&&V.setVertexAttribDivisor(N,e,M));y&&y.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Zf(p,e){const a=Math.pow(2,e.canonical.z),f=e.canonical.y;return[new i.ae(0,f/a).toLngLat().lat,new i.ae(0,(f+1)/a).toLngLat().lat]}function Cm(p,e,a,f,y,w,I){const M=p.context,L=M.gl,N=a.hillshadeFBO;if(!N)return;p.prepareDrawTile();const V=p.isTileAffectedByFog(e),Z=p.getOrCreateProgram("hillshade",{overrideFog:V});M.activeTexture.set(L.TEXTURE0),L.bindTexture(L.TEXTURE_2D,N.colorAttachment.get());const U=((ht,lt,_t,Mt)=>{const vt=_t.paint.get("hillshade-shadow-color"),Ut=_t.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",Ct=_t.paint.get("hillshade-highlight-color"),$t=_t.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",Ot=_t.paint.get("hillshade-accent-color"),Rt=_t.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",Zt=_t.paint.get("hillshade-emissive-strength");let pe=i.an(_t.paint.get("hillshade-illumination-direction"));if(_t.paint.get("hillshade-illumination-anchor")==="viewport")pe-=ht.transform.angle;else if(ht.style&&ht.style.enable3dLights()&&ht.style.directionalLight){const Me=ht.style.directionalLight.properties.get("direction"),ve=i.d3(Me.x,Me.y,Me.z);pe=i.an(ve[1])}const le=!ht.options.moving;return{u_matrix:Mt||ht.transform.calculateProjMatrix(lt.tileID.toUnwrapped(),le),u_image:0,u_latrange:Zf(0,lt.tileID),u_light:[_t.paint.get("hillshade-exaggeration"),pe],u_shadow:vt.toPremultipliedRenderColor(Ut?null:_t.lut),u_highlight:Ct.toPremultipliedRenderColor($t?null:_t.lut),u_emissive_strength:Zt,u_accent:Ot.toPremultipliedRenderColor(Rt?null:_t.lut)}})(p,a,f,p.terrain?e.projMatrix:null);p.uploadCommonUniforms(M,Z,e.toUnwrapped());const{tileBoundsBuffer:X,tileBoundsIndexBuffer:K,tileBoundsSegments:rt}=p.getTileBoundsBuffers(a);Z.draw(p,L.TRIANGLES,y,w,I,rr.disabled,U,f.id,X,K,rt)}function fu(p,e,a){if(!e.needsDEMTextureUpload)return;const f=p.context,y=f.gl;f.pixelStoreUnpackPremultiplyAlpha.set(!1),e.demTexture=e.demTexture||p.getTileTexture(a.stride);const w=a.getPixels();e.demTexture?e.demTexture.update(w,{premultiply:!1}):e.demTexture=new i.T(f,w,y.R32F,{premultiply:!1}),e.needsDEMTextureUpload=!1}function _p(p,e,a){const f=p.context,y=f.gl;if(!e.dem)return;const w=e.dem;if(f.activeTexture.set(y.TEXTURE1),fu(p,e,w),!e.demTexture)return;e.demTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE);const I=w.dim;f.activeTexture.set(y.TEXTURE0);let M=e.hillshadeFBO;if(!M){const U=new i.T(f,{width:I,height:I,data:null},y.RGBA8);U.bind(y.LINEAR,y.CLAMP_TO_EDGE),M=e.hillshadeFBO=f.createFramebuffer(I,I,!0,"renderbuffer"),M.colorAttachment.set(U.texture)}f.bindFramebuffer.set(M.framebuffer),f.viewport.set([0,0,I,I]);const{tileBoundsBuffer:L,tileBoundsIndexBuffer:N,tileBoundsSegments:V}=p.getMercatorTileBoundsBuffers(),Z=[];p.linearFloatFilteringSupported()&&Z.push("TERRAIN_DEM_FLOAT_FORMAT"),p.getOrCreateProgram("hillshadePrepare",{defines:Z}).draw(p,y.TRIANGLES,ki.disabled,hr.disabled,Sr.unblended,rr.disabled,((U,X)=>{const K=X.stride,rt=i.bB();return i.cd(rt,0,i.al,-i.al,0,0,1),i.bq(rt,rt,[0,-i.al,0]),{u_matrix:rt,u_image:1,u_dimension:[K,K],u_zoom:U.overscaledZ}})(e.tileID,w),a.id,L,N,V),e.needsHillshadePrepare=!1}class lo{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Bh extends lo{getDefault(){return i.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const a=this.current;(e.r!==a.r||e.g!==a.g||e.b!==a.b||e.a!==a.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class Yu extends lo{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class Hf extends lo{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class yp extends lo{getDefault(){return[!0,!0,!0,!0]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class xp extends lo{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class vp extends lo{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class mu extends lo{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const a=this.current;(e.func!==a.func||e.ref!==a.ref||e.mask!==a.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class bp extends lo{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class zd extends lo{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),this.current=e,this.dirty=!1}}class Ld extends lo{getDefault(){return[0,1]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class Wf extends lo{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.current=e,this.dirty=!1}}class Rd extends lo{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class Oh extends lo{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.BLEND):a.disable(a.BLEND),this.current=e,this.dirty=!1}}class Ju extends lo{getDefault(){const e=this.gl;return[e.ONE,e.ZERO,e.ONE,e.ZERO]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.blendFuncSeparate(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Nh extends lo{getDefault(){return i.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const a=this.current;(e.r!==a.r||e.g!==a.g||e.b!==a.b||e.a!==a.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class gu extends lo{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(e,e),this.current=e,this.dirty=!1)}}class Vh extends lo{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;e?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),this.current=e,this.dirty=!1}}class Uh extends lo{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class pf extends lo{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}let kd=class extends lo{getDefault(){return null}set(p){(p!==this.current||this.dirty)&&(this.gl.useProgram(p),this.current=p,this.dirty=!1)}};class rs extends lo{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class yl extends lo{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const a=this.current;(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Ea extends lo{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class jh extends lo{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindRenderbuffer(a.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class oh extends lo{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindTexture(a.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class Fd extends lo{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.bindBuffer(a.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Bc extends lo{getDefault(){return null}set(e){const a=this.gl;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class wp extends lo{getDefault(){return null}set(e){this.gl&&(e!==this.current||this.dirty)&&(this.gl.bindVertexArray(e),this.current=e,this.dirty=!1)}}class Ku extends lo{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class Tp extends lo{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class _u extends lo{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class Qu extends lo{constructor(e,a){super(e),this.context=e,this.parent=a}getDefault(){return null}}class ff extends Qu{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class td extends Qu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferRenderbuffer(a.FRAMEBUFFER,this.attachment(),a.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class Xf extends Qu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment(),a.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Oc extends td{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Bd=(p,e,a)=>({u_matrix:p,u_image0:0,u_skirt_height:e,u_ground_shadow_factor:a}),Od=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt)=>({u_proj_matrix:Float32Array.from(p),u_globe_matrix:e,u_normalize_matrix:Float32Array.from(f),u_merc_matrix:a,u_zoom_transition:y,u_merc_center:w,u_image0:0,u_frustum_tl:I,u_frustum_tr:M,u_frustum_br:L,u_frustum_bl:N,u_globe_pos:V,u_globe_radius:Z,u_viewport:U,u_grid_matrix:rt?Float32Array.from(rt):new Float32Array(9),u_skirt_height:X,u_far_z_cutoff:K});function ed(p,e){return p!=null&&e!=null&&!(!p.hasData()||!e.hasData())&&p.demTexture!=null&&e.demTexture!=null&&p.tileID.key!==e.tileID.key}const sh=new class{constructor(){this.operations={}}newMorphing(p,e,a,f,y){if(p in this.operations){const w=this.operations[p];w.to.tileID.key!==a.tileID.key&&(w.queued=a)}else this.operations[p]={startTime:f,phase:0,duration:y,from:e,to:a,queued:null}}getMorphValuesForProxy(p){if(!(p in this.operations))return null;const e=this.operations[p];return{from:e.from,to:e.to,phase:e.phase}}update(p){for(const e in this.operations){const a=this.operations[e];for(a.phase=(p-a.startTime)/a.duration;a.phase>=1||!this._validOp(a);)if(!this._nextOp(a,p)){delete this.operations[e];break}}}_nextOp(p,e){return!!p.queued&&(p.from=p.to,p.to=p.queued,p.queued=null,p.phase=0,p.startTime=e,!0)}_validOp(p){return p.from.hasData()&&p.to.hasData()}},Gh={0:null,1:"TERRAIN_VERTEX_MORPHING"};function mf(p,e,a){if(e===0)return 0;const f=e<1&&a===514?.25/e:1;return 6*Math.pow(1.5,22-p)*Math.max(e,1)*f}function id(p,e){const a=1<<p.z;return!e&&(p.x===0||p.x===a-1)||p.y===0||p.y===a-1}const $h=p=>({u_matrix:p});function yu(p,e,a,f,y){if(y>0){const w=i.o.now(),I=(w-p.timeAdded)/y,M=e?(w-e.timeAdded)/y:-1,L=a.getSource(),N=f.coveringZoomLevel({tileSize:L.tileSize,roundZoom:L.roundZoom}),V=!e||Math.abs(e.tileID.overscaledZ-N)>Math.abs(p.tileID.overscaledZ-N),Z=V&&p.refreshedUponExpiration?1:i.aA(V?I:1-M,0,1);return e?{opacity:1,mix:1-Z,isFading:I<1}:{opacity:Z,mix:0,isFading:I<1}}return{opacity:1,mix:0,isFading:!1}}class xl extends Xn{constructor(e){const a=Ta("mock-dem",{type:"raster-dem",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("mock-dem",a,!1),a.setEventedParent(this),this._sourceLoaded=!0}_loadTile(e,a){e.state="loaded",a(null)}}class vl extends Xn{constructor(e){const a=Ta("proxy",{type:"geojson",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("proxy",a,!1),a.setEventedParent(this),this.map=this.getSource().map=e,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(e,a,f){if(e.freezeTileCoverage)return;this.transform=e;const y=e.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((w,I)=>{if(w[I.key]="",!this._tiles[I.key]){const M=new Uo(I,this._source.tileSize*I.overscaleFactor(),e.tileZoom,void 0,void 0,this._source.worldview);M.state="loaded",this._tiles[I.key]=M}return w},{});for(const w in this._tiles)w in y||(this.freeFBO(w),this._tiles[w].unloadVectorData(),delete this._tiles[w])}freeFBO(e){const a=this.proxyCachedFBO[e];if(a!==void 0){const f=Object.values(a);this.renderCachePool.push(...f),delete this.proxyCachedFBO[e]}}deallocRenderCache(){this.renderCache.forEach(e=>e.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Qs extends i.aP{constructor(e,a,f){super(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y),this.proxyTileKey=a,this.projMatrix=f}}class Nc extends i.bU{constructor(e,a){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},e.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),e.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),e.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=e,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[f,y,w]=function(L){const N=new i.bc,V=new i.b0,Z=131;N.reserve(17161),V.reserve(33800);const U=i.al/128,X=i.al+U/2,K=X+U;for(let ht=-U;ht<K;ht+=U)for(let lt=-U;lt<K;lt+=U){const _t=lt<0||lt>X||ht<0||ht>X?24575:0,Mt=i.aA(Math.round(lt),0,i.al),vt=i.aA(Math.round(ht),0,i.al);N.emplaceBack(Mt+_t,vt)}const rt=(ht,lt)=>{const _t=lt*Z+ht;V.emplaceBack(_t+1,_t,_t+Z),V.emplaceBack(_t+Z,_t+Z+1,_t+1)};for(let ht=1;ht<129;ht++)for(let lt=1;lt<129;lt++)rt(lt,ht);return[0,129].forEach(ht=>{for(let lt=0;lt<130;lt++)rt(lt,ht),rt(ht,lt)}),[N,V,32768]}(),I=e.context;this.gridBuffer=I.createVertexBuffer(f,i.be.members),this.gridIndexBuffer=I.createIndexBuffer(y),this.gridSegments=i.bf.simpleSegment(0,0,f.length,y.length),this.gridNoSkirtSegments=i.bf.simpleSegment(0,0,f.length,w),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new vl(a.map),this.orthoMatrix=i.bB(),i.cd(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,i.al,0,i.al,0,1);const M=I.gl;this._overlapStencilMode=new hr({func:M.GEQUAL,mask:255},0,255,M.KEEP,M.KEEP,M.REPLACE),this._previousZoom=e.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=a,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new xl(a.map),this._pendingGroundEffectLayers=[]}set style(e){e.on("data",this._onStyleDataEvent.bind(this)),this._style=e,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(e,a,f){if(e&&e.terrain){this._style!==e&&(this.style=e,this._evaluationZoom=void 0);const y=e.terrain.properties,w=e.terrain.drapeRenderMode===0,I=e.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=i.o.now();const M=e.terrain&&e.terrain.scope,L=y.get("source"),N=w?this._mockSourceCache:e.getSourceCache(L,M);if(!N)return void i.w(`Couldn't find terrain source "${L}".`);if(this.sourceCache=N,this._attenuationRange=e.terrain.getAttenuationRange(),this._exaggeration=I?this.calculateExaggeration(a):y.get("exaggeration"),!a.projection.requiresDraping&&I&&this._exaggeration===0)return void this._disable();this.enabled=!0;const V=()=>{this.sourceCache.used&&i.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const Z=this.getScaledDemTileSize();this.sourceCache.update(a,Z,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,V(),this._initializing=!0),V(),a.updateElevation(!0,f),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(a),this._emptyDEMTextureDirty=!0,this._previousZoom=a.zoom}else this._disable()}calculateExaggeration(e){if(this._attenuationRange&&e.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(e.zoom);const a=this._previousCameraAltitude,f=e.getFreeCameraOptions().position.z/e.pixelsPerMeter*e.worldSize;this._previousCameraAltitude=f;const y=a!=null?f-a:Number.MAX_VALUE;if(Math.abs(y)<2)return this._exaggeration;const w=e.zoom,I=this._style.terrain;if(!this._previousUpdateTimestamp)return I.getExaggeration(w);let M=w-this._previousZoom;const L=this._previousUpdateTimestamp;let N=w;this._evaluationZoom!=null&&(N=this._evaluationZoom,Math.abs(w-N)>.5&&(M=.5*(w-N+M)),M*y<0&&(N+=M)),this._evaluationZoom=N;const V=I.getExaggeration(N),Z=V===I.getExaggeration(Math.max(0,N-.1));if(Z&&Math.abs(V-this._exaggeration)<.01)return V;let U=Math.min(.1,.00375*(this._updateTimestamp-L));return(Z||V<.1||Math.abs(M)<1e-4)&&(U=Math.min(.2,4*U)),i.ak(this._exaggeration,V,U)}resetTileLookupCache(e){this._findCoveringTileCache[e]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(e){e.dataType==="source"&&e.coord?this._clearRenderCacheForTile(e.sourceCacheId,e.coord):e.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const e in this._style._mergedSourceCaches)this._style._mergedSourceCaches[e].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(e=>e.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const e=2*this.proxySourceCache.getSource().tileSize;return[e,e]}set useVertexMorphing(e){this._useVertexMorphing=e}updateTileBinding(e){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const a=this.proxySourceCache,f=this.painter.transform;this._initializing&&(this._initializing=f._centerAltitude===0&&this.getAtPointOrZero(i.ae.fromLngLat(f.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const y=this.proxyCoords=a.getIds().map(L=>{const N=a.getTileByID(L).tileID;return N.projMatrix=f.calculateProjMatrix(N.toUnwrapped()),N});(function(L,N){const V=N.transform.pointCoordinate(N.transform.getCameraPoint()),Z=new i.P(V.x,V.y);L.sort((U,X)=>{if(X.overscaledZ-U.overscaledZ)return X.overscaledZ-U.overscaledZ;const K=new i.P(U.canonical.x+(1<<U.canonical.z)*U.wrap,U.canonical.y),rt=new i.P(X.canonical.x+(1<<X.canonical.z)*X.wrap,X.canonical.y),ht=Z.mult(1<<U.canonical.z);return ht.x-=.5,ht.y-=.5,ht.distSqr(K)-ht.distSqr(rt)})})(y,this.painter);const w=this.proxyToSource||{};this.proxyToSource={},y.forEach(L=>{this.proxyToSource[L.key]={}}),this.terrainTileForTile={};const I=this._style._mergedSourceCaches;for(const L in I){const N=I[L];if(!N.used||(N!==this.sourceCache&&this.resetTileLookupCache(N.id),this._setupProxiedCoordsForOrtho(N,e[L],w),N.usedForTerrain))continue;const V=e[L];N.getSource().reparseOverscaled&&this._assignTerrainTiles(V)}this.proxiedCoords[a.id]=y.map(L=>new Qs(L,L.key,this.orthoMatrix)),this._assignTerrainTiles(y),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(w),this.renderingToTexture=!1;const M={};this._visibleDemTiles=[];for(const L of this.proxyCoords){const N=this.terrainTileForTile[L.key];if(!N)continue;const V=N.tileID.key;V in M||(this._visibleDemTiles.push(N),M[V]=V)}}_assignTerrainTiles(e){this._initializing||e.forEach(a=>{if(this.terrainTileForTile[a.key])return;const f=this._findTileCoveringTileID(a,this.sourceCache);f&&(this.terrainTileForTile[a.key]=f)})}_prepareDEMTextures(){const e=this.painter.context,a=e.gl;for(const f in this.terrainTileForTile){const y=this.terrainTileForTile[f],w=y.dem;!w||y.demTexture&&!y.needsDEMTextureUpload||(e.activeTexture.set(a.TEXTURE1),fu(this.painter,y,w))}}_prepareDemTileUniforms(e,a,f,y){if(!a||a.demTexture==null)return!1;const w=e.tileID.canonical,I=Math.pow(2,a.tileID.canonical.z-w.z),M=y||"";return f[`u_dem_tl${M}`]=[w.x*I%1,w.y*I%1],f[`u_dem_scale${M}`]=I,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let e=0;const a=this._visibleDemTiles.reduce((f,y)=>{if(!y.dem)return f;const w=y.dem.tree.minimums[0];return w>0&&e++,f+w},0);return e?a/e:0}_updateEmptyDEMTexture(){const e=this.painter.context,a=e.gl;e.activeTexture.set(a.TEXTURE2);const f=this._getLoadedAreaMinimum(),y=new i.dK({width:1,height:1},new Float32Array([f]));this._emptyDEMTextureDirty=!1;let w=this._emptyDEMTexture;return w?w.update(y,{premultiply:!1}):w=this._emptyDEMTexture=new i.T(e,y,a.R32F,{premultiply:!1}),w}setupElevationDraw(e,a,f){const y=this.painter.context,w=y.gl,I={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};I.u_exaggeration=this.exaggeration();let M=null,L=null,N=1;if(f&&f.morphing&&this._useVertexMorphing){const X=f.morphing.srcDemTile,K=f.morphing.dstDemTile;N=f.morphing.phase,X&&K&&(this._prepareDemTileUniforms(e,X,I,"_prev")&&(L=X),this._prepareDemTileUniforms(e,K,I)&&(M=K))}const V=X=>X&&X.demTexture&&this.painter.linearFloatFilteringSupported()?w.LINEAR:w.NEAREST;let Z=null;var U;if(this.enabled?L&&M?(Z=M.demTexture,y.activeTexture.set(w.TEXTURE4),L.demTexture.bind(V(L),w.CLAMP_TO_EDGE),I.u_dem_lerp=N):(M=this.terrainTileForTile[e.tileID.key],Z=this._prepareDemTileUniforms(e,M,I)?M.demTexture:this.emptyDEMTexture):Z=this.emptyDEMTexture,y.activeTexture.set(w.TEXTURE2),Z&&(I.u_dem_size=(U=Z).size[0]===1?1:U.size[0]-2,Z.bind(V(M),w.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(f&&f.useDepthForOcclusion,a,I),f&&f.useMeterToDem&&M){const X=(1<<M.tileID.canonical.z)*i.ce(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;I.u_meter_to_dem=X}if(f&&f.labelPlaneMatrixInv&&(I.u_label_plane_matrix_inv=f.labelPlaneMatrixInv),a.setTerrainUniformValues(y,I),this.painter.transform.projection.name==="globe"){const X=this.globeUniformValues(this.painter.transform,e.tileID.canonical,f&&f.useDenormalizedUpVectorScale);a.setGlobeUniformValues(y,X)}}globeUniformValues(e,a,f){const y=e.projection;return{u_tile_tl_up:y.upVector(a,0,0),u_tile_tr_up:y.upVector(a,i.al,0),u_tile_br_up:y.upVector(a,i.al,i.al),u_tile_bl_up:y.upVector(a,0,i.al),u_tile_up_scale:f?i.dL(1):y.upVectorScale(a,e.center.lat,e.worldSize).metersToTile}}renderToBackBuffer(e){const a=this.painter,f=this.painter.context;e.length!==0&&(f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),a.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(y,w,I,M,L){if(y.transform.projection.name==="globe")(function(N,V,Z,U,X){const K=N.context,rt=K.gl;let ht,lt;const _t=N.transform,Mt=i.dD(N,K,_t),vt=(Me,ve)=>{if(lt===ve)return;const Be=[Gh[ve],"PROJECTION_GLOBE_VIEW"];Mt&&Be.push("CUSTOM_ANTIALIASING");const oi=N.isTileAffectedByFog(Me);ht=N.getOrCreateProgram("globeRaster",{defines:Be,overrideFog:oi}),lt=ve},Ut=N.colorModeForRenderPass(),Ct=new ki(rt.LEQUAL,ki.ReadWrite,N.depthRangeFor3D);sh.update(X);const $t=i.dE(_t),Ot=[i.aF(_t.center.lng),i.aJ(_t.center.lat)],Rt=N.globeSharedBuffers,Zt=[_t.width*i.o.devicePixelRatio,_t.height*i.o.devicePixelRatio],pe=Float32Array.from(_t.globeMatrix),le={useDenormalizedUpVectorScale:!0};{const Me=N.transform,ve=mf(Me.zoom,V.exaggeration(),V.sourceCache._source.tileSize);lt=-1;const Be=rt.TRIANGLES;for(const oi of U){const ge=Z.getTile(oi),ie=hr.disabled,Oe=V.prevTerrainTileForTile[oi.key],Te=V.terrainTileForTile[oi.key];ed(Oe,Te)&&sh.newMorphing(oi.key,Oe,Te,X,250),K.activeTexture.set(rt.TEXTURE0),ge.texture&&ge.texture.bind(rt.LINEAR,rt.CLAMP_TO_EDGE);const qe=sh.getMorphValuesForProxy(oi.key),si=qe?1:0;qe&&Object.assign(le,{morphing:{srcDemTile:qe.from,dstDemTile:qe.to,phase:i.dC(qe.phase)}});const Li=i.dF(oi.canonical),ni=i.dG(Li.getCenter().lat),li=i.dH(oi.canonical,Li,ni,Me.worldSize/Me._pixelsPerMercatorPixel),Fi=i.bj(i.dI(oi.canonical)),Si=Od(Me.expandedFarZProjMatrix,pe,$t,Fi,i.aj(Me.zoom),Ot,Me.frustumCorners.TL,Me.frustumCorners.TR,Me.frustumCorners.BR,Me.frustumCorners.BL,Me.globeCenterInViewSpace,Me.globeRadius,Zt,ve,Me._farZ,li);if(vt(oi,si),ht&&(V.setupElevationDraw(ge,ht,le),N.uploadCommonUniforms(K,ht,oi.toUnwrapped()),Rt)){const[xi,Ai,Wi]=Rt.getGridBuffers(ni,ve!==0);ht.draw(N,Be,Ct,ie,Ut,rr.backCCW,Si,"globe_raster",xi,Ai,Wi)}}}if(Rt&&(N.renderDefaultNorthPole||N.renderDefaultSouthPole)){const Me=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Mt&&Me.push("CUSTOM_ANTIALIASING"),ht=N.getOrCreateProgram("globeRaster",{defines:Me});for(const ve of U){const{x:Be,y:oi,z:ge}=ve.canonical,ie=oi===0,Oe=oi===(1<<ge)-1,[Te,qe,si,Li]=Rt.getPoleBuffers(ge,!1);if(Li&&(ie||Oe)){const ni=Z.getTile(ve);K.activeTexture.set(rt.TEXTURE0),ni.texture&&ni.texture.bind(rt.LINEAR,rt.CLAMP_TO_EDGE);let li=i.dJ(ge,Be,_t);const Fi=i.bj(i.dI(ve.canonical)),Si=(xi,Ai)=>xi.draw(N,rt.TRIANGLES,Ct,hr.disabled,Ut,rr.disabled,Od(_t.expandedFarZProjMatrix,li,li,Fi,0,Ot,_t.frustumCorners.TL,_t.frustumCorners.TR,_t.frustumCorners.BR,_t.frustumCorners.BL,_t.globeCenterInViewSpace,_t.globeRadius,Zt,0,_t._farZ),"globe_pole_raster",Ai,si,Li);V.setupElevationDraw(ni,ht,le),N.uploadCommonUniforms(K,ht,ve.toUnwrapped()),ie&&N.renderDefaultNorthPole&&Si(ht,Te),Oe&&N.renderDefaultSouthPole&&(li=i.cR(i.bB(),li,[1,-1,1]),Si(ht,qe))}}}})(y,w,I,M,L);else{const N=y.context,V=N.gl;let Z,U;const X=y.shadowRenderer,K=ha(y,y.longestCutoffRange),rt=Ut=>{if(U===Ut)return;const Ct=[];Ct.push(Gh[Ut]),K.shouldRenderCutoff&&Ct.push("RENDER_CUTOFF"),X&&(Ct.push("RENDER_SHADOWS","DEPTH_TEXTURE"),X.useNormalOffset&&Ct.push("NORMAL_OFFSET")),Z=y.getOrCreateProgram("terrainRaster",{defines:Ct}),U=Ut},ht=y.colorModeForRenderPass(),lt=new ki(V.LEQUAL,ki.ReadWrite,y.depthRangeFor3D);sh.update(L);const _t=y.transform,Mt=mf(_t.zoom,w.exaggeration(),w.sourceCache._source.tileSize);let vt=[0,0,0];if(X){const Ut=y.style.directionalLight,Ct=y.style.ambientLight;Ut&&Ct&&(vt=_l(y.style,Ut,Ct))}{U=-1;const Ut=V.TRIANGLES,[Ct,$t]=[w.gridIndexBuffer,w.gridSegments];for(const Ot of M){const Rt=I.getTile(Ot),Zt=hr.disabled,pe=w.prevTerrainTileForTile[Ot.key],le=w.terrainTileForTile[Ot.key];ed(pe,le)&&sh.newMorphing(Ot.key,pe,le,L,250),N.activeTexture.set(V.TEXTURE0),Rt.texture&&Rt.texture.bind(V.LINEAR,V.CLAMP_TO_EDGE);const Me=sh.getMorphValuesForProxy(Ot.key),ve=Me?1:0;let Be;Me&&(Be={morphing:{srcDemTile:Me.from,dstDemTile:Me.to,phase:i.dC(Me.phase)}});const oi=Bd(Ot.projMatrix,id(Ot.canonical,_t.renderWorldCopies)?Mt/10:Mt,vt);if(rt(ve),!Z)continue;w.setupElevationDraw(Rt,Z,Be);const ge=Ot.toUnwrapped();X&&X.setupShadows(ge,Z),y.uploadCommonUniforms(N,Z,ge,null,K),Z.draw(y,Ut,lt,Zt,ht,rr.backCCW,oi,"terrain_raster",w.gridBuffer,Ct,$t)}}}}(a,this,this.proxySourceCache,e,this._updateTimestamp),this.renderingToTexture=!0,a.gpuTimingDeferredRenderEnd(),e.splice(0,e.length))}renderBatch(e){if(this._drapedRenderBatches.length===0)return e+1;this.renderingToTexture=!0;const a=this.painter,f=this.painter.context,y=this.proxySourceCache,w=this.proxiedCoords[y.id],I=this._drapedRenderBatches.shift(),M=a.style.order,L=[];let N=0;for(const V of w){const Z=y.getTileByID(V.proxyTileKey),U=y.proxyCachedFBO[V.key]?y.proxyCachedFBO[V.key][e]:void 0,X=U!==void 0?y.renderCache[U]:this.pool[N++],K=U!==void 0;if(Z.texture=X.tex,K&&!X.dirty){L.push(Z.tileID);continue}let rt;f.bindFramebuffer.set(X.fb.framebuffer),this.renderedToTile=!1,X.dirty&&(f.clear({color:i.ao.transparent,stencil:0}),X.dirty=!1);for(let ht=I.start;ht<=I.end;++ht){const lt=a.style._mergedLayers[M[ht]];if(lt.isHidden(a.transform.zoom))continue;const _t=a.style.getLayerSourceCache(lt),Mt=_t?this.proxyToSource[V.key][_t.id]:[V];if(!Mt)continue;const vt=Mt;f.viewport.set([0,0,X.fb.width,X.fb.height]),rt!==(_t?_t.id:null)&&(this._setupStencil(X,Mt,lt,_t),rt=_t?_t.id:null),a.renderLayer(a,_t,lt,vt)}if(this._drapedRenderBatches.length===0)for(const ht of this._pendingGroundEffectLayers){const lt=a.style._mergedLayers[M[ht]];if(lt.isHidden(a.transform.zoom))continue;const _t=a.style.getLayerSourceCache(lt),Mt=_t?this.proxyToSource[V.key][_t.id]:[V];if(!Mt)continue;const vt=Mt;f.viewport.set([0,0,X.fb.width,X.fb.height]),rt!==(_t?_t.id:null)&&(this._setupStencil(X,Mt,lt,_t),rt=_t?_t.id:null),a.renderLayer(a,_t,lt,vt)}this.renderedToTile?(X.dirty=!0,L.push(Z.tileID)):K||--N,N===5&&(N=0,this.renderToBackBuffer(L))}return this.renderToBackBuffer(L),this.renderingToTexture=!1,f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),I.end+1}postRender(){}isLayerOrderingCorrect(e){const a=e.order.length;let f=-1,y=a;for(let w=0;w<a;++w)this._style.isLayerDraped(e._mergedLayers[e.order[w]])?f=Math.max(f,w):y=Math.min(y,w);return y>f}getMinElevationBelowMSL(){let e=0;return this._visibleDemTiles.filter(a=>a.dem).forEach(a=>{e=Math.min(e,a.dem.tree.minimums[0])}),e===0?e:(e-30)*this._exaggeration}raycast(e,a,f){if(!this._visibleDemTiles)return null;const y=this._visibleDemTiles.filter(w=>w.dem).map(w=>{const I=w.tileID,M=1<<I.overscaledZ,{x:L,y:N}=I.canonical,V=L/M,Z=(L+1)/M,U=N/M,X=(N+1)/M;return{minx:V,miny:U,maxx:Z,maxy:X,t:w.dem.tree.raycastRoot(V,U,Z,X,e,a,f),tile:w}});y.sort((w,I)=>(w.t!==null?w.t:Number.MAX_VALUE)-(I.t!==null?I.t:Number.MAX_VALUE));for(const w of y){if(w.t==null)return null;const I=w.tile.dem.tree.raycast(w.minx,w.miny,w.maxx,w.maxy,e,a,f);if(I!=null)return I}return null}_createFBO(){const e=this.painter.context,a=e.gl,f=this.drapeBufferSize;e.activeTexture.set(a.TEXTURE0);const y=new i.T(e,{width:f[0],height:f[1],data:null},a.RGBA8);y.bind(a.LINEAR,a.CLAMP_TO_EDGE);const w=e.createFramebuffer(f[0],f[1],!0,null);return w.colorAttachment.set(y.texture),w.depthAttachment=new Oc(e,w.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=e.createRenderbuffer(e.gl.DEPTH_STENCIL,f[0],f[1]),this._stencilRef=0,w.depthAttachment.set(this._sharedDepthStencil),e.clear({stencil:0})):w.depthAttachment.set(this._sharedDepthStencil),e.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,e.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.extTextureFilterAnisotropicMax),{fb:w,tex:y,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const e in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[e].hasTransition())return!0;return this._style.order.some(e=>{const a=this._style._mergedLayers[e],f=a.isHidden(this.painter.transform.zoom);return a.type==="hillshade"||a.type==="custom"?!f&&a.shouldRedrape():!f&&a.hasTransition()})}_clearLineLayersFromRenderCache(){let e=!1;for(const f of this._style.getSources())if(f instanceof na){e=!0;break}if(!e)return;const a={};for(let f=0;f<this._style.order.length;++f){const y=this._style._mergedLayers[this._style.order[f]],w=this._style.getLayerSourceCache(y);if(w&&!a[w.id]&&!y.isHidden(this.painter.transform.zoom)&&y.type==="line"&&y.widthExpression()instanceof i.ad){a[w.id]=!0;for(const I of this.proxyCoords){const M=this.proxyToSource[I.key][w.id];if(M)for(const L of M)this._clearRenderCacheForTile(w.id,L)}}}}_clearRasterLayersFromRenderCache(){let e=!1;for(const f in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[f]._source instanceof Dl){e=!0;break}if(!e)return;const a={};for(let f=0;f<this._style.order.length;++f){const y=this._style._mergedLayers[this._style.order[f]],w=this._style.getLayerSourceCache(y);if(!w||a[w.id]||y.isHidden(this.painter.transform.zoom)||y.type!=="raster")continue;const I=y.paint.get("raster-fade-duration");for(const M of this.proxyCoords){const L=this.proxyToSource[M.key][w.id];if(L)for(const N of L){const V=yu(w.getTile(N),w.findLoadedParent(N,0),w,this.painter.transform,I);(V.opacity!==1||V.mix!==0)&&this._clearRenderCacheForTile(w.id,N)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const e=this._style.order,a=e.length;if(a===0)return;const f=[];this._pendingGroundEffectLayers=[];let y,w=0,I=this._style._mergedLayers[e[w]];for(;!this._style.isLayerDraped(I)&&I.isHidden(this.painter.transform.zoom)&&++w<a;)I=this._style._mergedLayers[e[w]];for(;w<a;++w){const M=this._style._mergedLayers[e[w]];M.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(M)?y===void 0&&(y=w):(M.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(w),y!==void 0&&(f.push({start:y,end:w-1}),y=void 0)))}if(y!==void 0&&f.push({start:y,end:w-1}),f.length!==0){const M=f[f.length-1];this._pendingGroundEffectLayers.every(L=>L>M.end)||i.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=f}_setupRenderCache(e){const a=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,a.renderCache.length>a.renderCachePool.length){const I=Object.values(a.proxyCachedFBO);a.proxyCachedFBO={};for(let M=0;M<I.length;++M){const L=Object.values(I[M]);a.renderCachePool.push(...L)}}return}this._clearRasterLayersFromRenderCache();const f=this.proxyCoords,y=this._tilesDirty;for(let I=f.length-1;I>=0;I--){const M=f[I];if(a.getTileByID(M.key),a.proxyCachedFBO[M.key]!==void 0){const L=e[M.key],N=this.proxyToSource[M.key];let V=0;for(const Z in N){const U=N[Z],X=L[Z];if(!X||X.length!==U.length||U.some((K,rt)=>K!==X[rt]||y[Z]&&y[Z].hasOwnProperty(K.key))){V=-1;break}++V}for(const Z in a.proxyCachedFBO[M.key])a.renderCache[a.proxyCachedFBO[M.key][Z]].dirty=V<0||V!==Object.values(L).length}}const w=[...this._drapedRenderBatches];w.sort((I,M)=>M.end-M.start-(I.end-I.start));for(const I of w)for(const M of f){if(a.proxyCachedFBO[M.key])continue;let L=a.renderCachePool.pop();L===void 0&&a.renderCache.length<50&&(L=a.renderCache.length,a.renderCache.push(this._createFBO())),L!==void 0&&(a.proxyCachedFBO[M.key]={},a.proxyCachedFBO[M.key][I.start]=L,a.renderCache[L].dirty=!0)}this._tilesDirty={}}_setupStencil(e,a,f,y){if(!y||!this._sourceTilesOverlap[y.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const w=this.painter.context,I=w.gl;if(a.length<=1)return void(this._overlapStencilType=!1);let M;if(f.isTileClipped())M=a.length,this._overlapStencilMode.test={func:I.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(a[0].overscaledZ>a[a.length-1].overscaledZ))return void(this._overlapStencilType=!1);M=1,this._overlapStencilMode.test={func:I.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+M>255&&(w.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=M,this._overlapStencilMode.ref=this._stencilRef,f.isTileClipped()&&this._renderTileClippingMasks(a,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(e){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[e.key]),this._overlapStencilMode):hr.disabled}_renderTileClippingMasks(e,a){const f=this.painter,y=this.painter.context,w=y.gl;f._tileClippingMaskIDs={},y.setColorMode(Sr.disabled),y.setDepthMode(ki.disabled);const I=f.getOrCreateProgram("clippingMask");for(const M of e){const L=f._tileClippingMaskIDs[M.key]=--a;I.draw(f,w.TRIANGLES,ki.disabled,new hr({func:w.ALWAYS,mask:0},L,255,w.KEEP,w.KEEP,w.REPLACE),Sr.disabled,rr.disabled,$h(M.projMatrix),"$clipping",f.tileExtentBuffer,f.quadTriangleIndexBuffer,f.tileExtentSegments)}}pointCoordinate(e){const a=this.painter.transform;if(e.x<0||e.x>a.width||e.y<0||e.y>a.height)return null;const f=[e.x,e.y,1,1];i.aC(f,f,a.pixelMatrixInverse),i.cJ(f,f,1/f[3]),f[0]/=a.worldSize,f[1]/=a.worldSize;const y=a._camera.position,w=i.ce(1,a.center.lat),I=[y[0],y[1],y[2]/w,0],M=i.d9([],f.slice(0,3),I);i.aw(M,M);const L=this.raycast(I,M,this._exaggeration);return L!==null&&L?(i.bG(I,I,M,L),I[3]=I[2],I[2]*=w,I):null}_setupProxiedCoordsForOrtho(e,a,f){if(e.getSource()instanceof i.aT)return this._setupProxiedCoordsForImageSource(e,a,f);this._findCoveringTileCache[e.id]=this._findCoveringTileCache[e.id]||{};const y=this.proxiedCoords[e.id]=[],w=this.proxyCoords;for(let L=0;L<w.length;L++){const N=w[L],V=this._findTileCoveringTileID(N,e);if(V){const Z=this._createProxiedId(N,V,f[N.key]&&f[N.key][e.id]);y.push(Z),this.proxyToSource[N.key][e.id]=[Z]}}let I=!1;const M=new Set;for(let L=0;L<a.length;L++){const N=e.getTile(a[L]);if(!N||!N.hasData())continue;const V=this._findTileCoveringTileID(N.tileID,this.proxySourceCache);if(V&&V.tileID.canonical.z!==N.tileID.canonical.z){const Z=this.proxyToSource[V.tileID.key][e.id],U=this._createProxiedId(V.tileID,N,f[V.tileID.key]&&f[V.tileID.key][e.id]);Z?Z.splice(Z.length-1,0,U):this.proxyToSource[V.tileID.key][e.id]=[U];const X=this.proxyToSource[V.tileID.key][e.id];M.has(X)||M.add(X),y.push(U),I=!0}}if(this._sourceTilesOverlap[e.id]=I,I&&this._debugParams.sortTilesHiZFirst)for(const L of M)L.sort((N,V)=>V.overscaledZ-N.overscaledZ)}_setupProxiedCoordsForImageSource(e,a,f){if(!e.getSource().loaded())return;const y=this.proxiedCoords[e.id]=[],w=this.proxyCoords,I=e.getSource(),M=I.tileID;if(!M)return;const L=new i.P(M.x,M.y)._div(1<<M.z),N=I.coordinates.map(i.ae.fromLngLat).reduce((Z,U)=>(Z.min.x=Math.min(Z.min.x,U.x-L.x),Z.min.y=Math.min(Z.min.y,U.y-L.y),Z.max.x=Math.max(Z.max.x,U.x-L.x),Z.max.y=Math.max(Z.max.y,U.y-L.y),Z),{min:new i.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new i.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),V=(Z,U)=>{const X=Z.wrap+Z.canonical.x/(1<<Z.canonical.z),K=Z.canonical.y/(1<<Z.canonical.z),rt=i.al/(1<<Z.canonical.z),ht=U.wrap+U.canonical.x/(1<<U.canonical.z),lt=U.canonical.y/(1<<U.canonical.z);return X+rt<ht+N.min.x||X>ht+N.max.x||K+rt<lt+N.min.y||K>lt+N.max.y};for(let Z=0;Z<w.length;Z++){const U=w[Z];for(let X=0;X<a.length;X++){const K=e.getTile(a[X]);if(!K||!K.hasData()||V(U,K.tileID))continue;const rt=this._createProxiedId(U,K,f[U.key]&&f[U.key][e.id]),ht=this.proxyToSource[U.key][e.id];ht?ht.push(rt):this.proxyToSource[U.key][e.id]=[rt],y.push(rt)}}}_createProxiedId(e,a,f){let y=this.orthoMatrix;if(f){const w=f.find(I=>I.key===a.tileID.key);if(w)return w}if(a.tileID.key!==e.key){const w=e.canonical.z-a.tileID.canonical.z;let I,M,L;y=i.bB();const N=a.tileID.wrap-e.wrap<<e.overscaledZ;w>0?(I=i.al>>w,M=I*((a.tileID.canonical.x<<w)-e.canonical.x+N),L=I*((a.tileID.canonical.y<<w)-e.canonical.y)):(I=i.al<<-w,M=i.al*(a.tileID.canonical.x-(e.canonical.x+N<<-w)),L=i.al*(a.tileID.canonical.y-(e.canonical.y<<-w))),i.cd(y,0,I,0,I,0,1),i.bq(y,y,[M,L,0])}return new Qs(a.tileID,e.key,y)}_findTileCoveringTileID(e,a){let f=a.getTile(e);if(f&&f.hasData())return f;const y=this._findCoveringTileCache[a.id],w=y[e.key];if(f=w?a.getTileByID(w):null,f&&f.hasData()||w===null)return f;let I=f?f.tileID:e,M=I.overscaledZ;const L=a.getSource().minzoom,N=[];if(!w){const Z=a.getSource().maxzoom;if(e.canonical.z>=Z){const U=e.canonical.z-Z;a.getSource().reparseOverscaled?(M=Math.max(e.canonical.z+2,a.transform.tileZoom),I=new i.aP(M,e.wrap,Z,e.canonical.x>>U,e.canonical.y>>U)):U!==0&&(M=Z,I=new i.aP(M,e.wrap,Z,e.canonical.x>>U,e.canonical.y>>U))}I.key!==e.key&&(N.push(I.key),f=a.getTile(I))}const V=Z=>{N.forEach(U=>{y[U]=Z}),N.length=0};for(M-=1;M>=L&&(!f||!f.hasData());M--){f&&V(f.tileID.key);const Z=I.calculateScaledKey(M);if(f=a.getTileByID(Z),f&&f.hasData())break;const U=y[Z];if(U===null)break;U===void 0?N.push(Z):f=a.getTileByID(U)}return V(f?f.tileID.key:null),f&&f.hasData()?f:null}findDEMTileFor(e){return this.enabled?this._findTileCoveringTileID(e,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(e,a){let f=this._tilesDirty[e];f||(f=this._tilesDirty[e]={}),f[a.key]=!0}}function ns(p,e,a){const f=function(M,L,N){const V=i.bI(L,M),Z=i.bI(N,[.2126,.7152,.0722]),U=(K,rt,ht)=>(1-ht)*K+ht*rt,X=U(1-.3*Math.min(Z,1),1,Math.min(V+1,1));return U(.92,1,Math.asin(i.aA(L[2],-1,1))/Math.PI+.5)*X}(p,[0,0,1],e),y=[0,0,0];i.c4(y,a.slice(0,3),f);const w=[0,0,0];i.c4(w,e.slice(0,3),p[2]);const I=[0,0,0];return i.d7(I,y,w),i.da(I)}const xu=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],ah=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Nd{static cacheKey(e,a,f,y){let w=`${a}${y?y.cacheKey:""}`;for(const I of f)e.usedDefines.includes(I)&&(w+=`/${I}`);return w}constructor(e,a,f,y,w,I){const M=e.gl;this.program=M.createProgram(),this.configuration=y,this.name=a,this.fixedDefines=[...I];let L=y?y.defines():[];L=L.concat(I.map(K=>`#define ${K}`));const N=`#version 300 es
`;let V=N+L.concat("precision mediump float;",Fc,Fh.fragmentSource).join(`
`);for(const K of f.fragmentIncludes)V+=`
${kh[K]}`;V+=`
${f.fragmentSource}`;let Z=N+L.concat("precision highp float;",Fc,Fh.vertexSource).join(`
`);for(const K of f.vertexIncludes)Z+=`
${kh[K]}`;this.forceManualRenderingForInstanceIDShaders=e.forceManualRenderingForInstanceIDShaders&&f.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(Z+=`
uniform int u_instanceID;
`),Z+=`
${f.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(Z=Z.replaceAll("gl_InstanceID","u_instanceID"));const U=M.createShader(M.FRAGMENT_SHADER);if(M.isContextLost())return void(this.failedToCreate=!0);M.shaderSource(U,V),M.compileShader(U),M.attachShader(this.program,U);const X=M.createShader(M.VERTEX_SHADER);M.isContextLost()?this.failedToCreate=!0:(M.shaderSource(X,Z),M.compileShader(X),M.attachShader(this.program,X),this.attributes={},M.linkProgram(this.program),M.deleteShader(X),M.deleteShader(U),this.fixedUniforms=w(e),this.binderUniforms=y?y.getUniforms(e):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(K=>({u_instanceID:new i.cg(K)}))(e)),(I.includes("TERRAIN")||a.indexOf("symbol")!==-1||a.indexOf("circle")!==-1)&&(this.terrainUniforms=(K=>({u_dem:new i.cg(K),u_dem_prev:new i.cg(K),u_dem_tl:new i.cj(K),u_dem_scale:new i.ci(K),u_dem_tl_prev:new i.cj(K),u_dem_scale_prev:new i.ci(K),u_dem_size:new i.ci(K),u_dem_lerp:new i.ci(K),u_exaggeration:new i.ci(K),u_depth:new i.cg(K),u_depth_size_inv:new i.cj(K),u_depth_range_unpack:new i.cj(K),u_occluder_half_size:new i.ci(K),u_occlusion_depth_offset:new i.ci(K),u_meter_to_dem:new i.ci(K),u_label_plane_matrix_inv:new i.ck(K)}))(e)),I.includes("GLOBE")&&(this.globeUniforms=(K=>({u_tile_tl_up:new i.ch(K),u_tile_tr_up:new i.ch(K),u_tile_br_up:new i.ch(K),u_tile_bl_up:new i.ch(K),u_tile_up_scale:new i.ci(K)}))(e)),I.includes("FOG")&&(this.fogUniforms=(K=>({u_fog_matrix:new i.ck(K),u_fog_range:new i.cj(K),u_fog_color:new i.d2(K),u_fog_horizon_blend:new i.ci(K),u_fog_vertical_limit:new i.cj(K),u_fog_temporal_offset:new i.ci(K),u_frustum_tl:new i.ch(K),u_frustum_tr:new i.ch(K),u_frustum_br:new i.ch(K),u_frustum_bl:new i.ch(K),u_globe_pos:new i.ch(K),u_globe_radius:new i.ci(K),u_globe_transition:new i.ci(K),u_is_globe:new i.cg(K),u_viewport:new i.cj(K)}))(e)),I.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(K=>({u_cutoff_params:new i.d2(K)}))(e)),I.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(K=>({u_lighting_ambient_color:new i.ch(K),u_lighting_directional_dir:new i.ch(K),u_lighting_directional_color:new i.ch(K),u_ground_radiance:new i.ch(K)}))(e)),I.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(K=>({u_light_matrix_0:new i.ck(K),u_light_matrix_1:new i.ck(K),u_fade_range:new i.cj(K),u_shadow_normal_offset:new i.ch(K),u_shadow_intensity:new i.ci(K),u_shadow_texel_size:new i.ci(K),u_shadow_map_resolution:new i.ci(K),u_shadow_direction:new i.ch(K),u_shadow_bias:new i.ch(K),u_shadowmap_0:new i.cg(K),u_shadowmap_1:new i.cg(K)}))(e)))}getAttributeLocation(e,a){let f=this.attributes[a];return f===void 0&&(f=this.attributes[a]=e.getAttribLocation(this.program,a)),f}setTerrainUniformValues(e,a){if(!this.terrainUniforms)return;const f=this.terrainUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y]&&f[y].set(this.program,y,a[y])}}setGlobeUniformValues(e,a){if(!this.globeUniforms)return;const f=this.globeUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y]&&f[y].set(this.program,y,a[y])}}setFogUniformValues(e,a){if(!this.fogUniforms)return;const f=this.fogUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}}setCutoffUniformValues(e,a){if(!this.cutoffUniforms)return;const f=this.cutoffUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}}setLightsUniformValues(e,a){if(!this.lightsUniforms)return;const f=this.lightsUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}}setShadowUniformValues(e,a){if(this.failedToCreate||!this.shadowUniforms)return;const f=this.shadowUniforms;e.program.set(this.program);for(const y in a)f[y].set(this.program,y,a[y])}_drawDebugWireframe(e,a,f,y,w,I,M,L,N,V){const Z=e.options.wireframe;if(Z.terrain===!1&&Z.layers2D===!1&&Z.layers3D===!1)return;const U=e.context;if(!(!(!Z.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!Z.layers2D||e._terrain&&e._terrain.renderingToTexture||!xu.includes(this.name))||!(!Z.layers3D||!ah.includes(this.name))))return;const X=U.gl,K=e.wireframeDebugCache.getLinesFromTrianglesBuffer(e.frameCounter,w,U);if(!K)return;const rt=[...this.fixedDefines];rt.push("DEBUG_WIREFRAME");const ht=e.getOrCreateProgram(this.name,{config:this.configuration,defines:rt});U.program.set(ht.program);const lt=(vt,Ut,Ct)=>{if(Ut[vt]&&Ct[vt])for(const $t in Ut[vt])Ct[vt][$t]&&Ct[vt][$t].set(Ct.program,$t,Ut[vt][$t].current)};N&&N.setUniforms(ht.program,U,ht.binderUniforms,M,{zoom:L}),lt("fixedUniforms",this,ht),lt("terrainUniforms",this,ht),lt("globeUniforms",this,ht),lt("fogUniforms",this,ht),lt("lightsUniforms",this,ht),lt("shadowUniforms",this,ht),K.bind(),U.setColorMode(new Sr([X.ONE,X.ONE_MINUS_SRC_ALPHA,X.ZERO,X.ONE],i.ao.transparent,[!0,!0,!0,!1])),U.setDepthMode(new ki(a.func===X.LESS?X.LEQUAL:a.func,ki.ReadOnly,a.range)),U.setStencilMode(hr.disabled);const _t=3*I.primitiveLength*2,Mt=3*I.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const vt=V||1;for(let Ut=0;Ut<vt;++Ut)ht.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Ut),X.drawElements(X.LINES,_t,X.UNSIGNED_SHORT,Mt)}else V&&V>1?X.drawElementsInstanced(X.LINES,_t,X.UNSIGNED_SHORT,Mt,V):X.drawElements(X.LINES,_t,X.UNSIGNED_SHORT,Mt);w.bind(),U.program.set(this.program),U.setDepthMode(a),U.setStencilMode(f),U.setColorMode(y)}checkUniforms(e,a,f){if(this.fixedDefines.includes(a)){for(const y of Object.keys(f))if(!f[y].initialized)throw new Error(`Program '${this.name}', from draw '${e}': uniform ${y} not set but required by ${a} being defined`)}}draw(e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht){const lt=e.context,_t=lt.gl;if(this.failedToCreate)return;lt.program.set(this.program),lt.setDepthMode(f),lt.setStencilMode(y),lt.setColorMode(w),lt.setCullFace(I);for(const Ut of Object.keys(this.fixedUniforms))this.fixedUniforms[Ut].set(this.program,Ut,M[Ut]);K&&K.setUniforms(this.program,lt,this.binderUniforms,U,{zoom:X});const Mt={[_t.POINTS]:1,[_t.LINES]:2,[_t.TRIANGLES]:3,[_t.LINE_STRIP]:1}[a];this.checkUniforms(L,"RENDER_SHADOWS",this.shadowUniforms);const vt=ht&&ht>0?1:void 0;for(const Ut of Z.get()){const Ct=Ut.vaos||(Ut.vaos={});if((Ct[L]||(Ct[L]=new Xu)).bind(lt,this,N,K?K.getPaintVertexBuffers():[],V,Ut.vertexOffset,rt||[],vt),this.forceManualRenderingForInstanceIDShaders){const $t=ht||1;for(let Ot=0;Ot<$t;++Ot)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Ot),V?_t.drawElements(a,Ut.primitiveLength*Mt,_t.UNSIGNED_SHORT,Ut.primitiveOffset*Mt*2):_t.drawArrays(a,Ut.vertexOffset,Ut.vertexLength)}else ht&&ht>1?_t.drawElementsInstanced(a,Ut.primitiveLength*Mt,_t.UNSIGNED_SHORT,Ut.primitiveOffset*Mt*2,ht):V?_t.drawElements(a,Ut.primitiveLength*Mt,_t.UNSIGNED_SHORT,Ut.primitiveOffset*Mt*2):_t.drawArrays(a,Ut.vertexOffset,Ut.vertexLength);a===_t.TRIANGLES&&V&&this._drawDebugWireframe(e,f,y,w,V,Ut,U,X,K,ht)}}}function Sp(p,e,a=0){const f=Math.pow(2,e.tileID.overscaledZ),y=e.tileSize*Math.pow(2,p.transform.tileZoom)/f,w=y*(e.tileID.canonical.x+e.tileID.wrap*f),I=y*e.tileID.canonical.y;return{u_image:0,u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/i.ay(e,1,p.transform.tileZoom),u_pixel_coord_upper:[w>>16,I>>16],u_pixel_coord_lower:[65535&w,65535&I],u_pattern_transition:a}}const Vc={terrain:0,flat:1},Vd=i.bB(),vu=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt)=>{const _t=e.style.light,Mt=_t.properties.get("position"),vt=[Mt.x,Mt.y,Mt.z],Ut=i.dN();_t.properties.get("anchor")==="viewport"&&(i.dO(Ut,-e.transform.angle),i.dP(vt,vt,Ut));const Ct=_t.properties.get("color").toPremultipliedRenderColor(null),$t=e.transform,Ot={u_matrix:p,u_lightpos:vt,u_lightintensity:_t.properties.get("intensity"),u_lightcolor:[Ct.r,Ct.g,Ct.b],u_vertical_gradient:+a,u_opacity:f,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Vd,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Vc[N],u_base_type:Vc[V],u_ao:y,u_edge_radius:w,u_width_scale:I,u_flood_light_color:K,u_vertical_scale:rt,u_flood_light_intensity:ht,u_ground_shadow_factor:lt};return $t.projection.name==="globe"&&(Ot.u_tile_id=[M.canonical.x,M.canonical.y,1<<M.canonical.z],Ot.u_zoom_transition=Z,Ot.u_inv_rot_matrix=X,Ot.u_merc_center=U,Ot.u_up_dir=$t.projection.upVector(new i.cC(0,0,0),U[0]*i.al,U[1]*i.al),Ot.u_height_lift=L),Ot},rd=(p,e,a,f,y,w)=>({u_matrix:p,u_edge_radius:e,u_width_scale:a,u_vertical_scale:f,u_height_type:Vc[y],u_base_type:Vc[w]}),Kl=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt)=>{const _t=vu(p,e,a,f,y,w,I,M,N,V,Z,U,X,K,rt,ht,1,[0,0,0]),Mt={u_height_factor:-Math.pow(2,M.overscaledZ)/L.tileSize/8};return Object.assign(_t,Sp(e,L,lt),Mt)},ir=(p,e,a,f,y,w,I,M,L,N,V)=>({u_matrix:e,u_opacity:a,u_ao_pass:f?1:0,u_meter_to_tile:y,u_ao:w,u_flood_light_intensity:I,u_flood_light_color:M,u_attenuation:L,u_edge_radius:N,u_fb:0,u_fb_size:V,u_dynamic_offset:1}),bu=(p,e,a)=>({u_matrix:p,u_emissive_strength:e,u_ground_shadow_factor:a}),Ip=(p,e,a,f,y,w=0)=>Object.assign(bu(p,e,y),Sp(a,f,w)),Yf=(p,e,a,f)=>({u_matrix:p,u_world:a,u_emissive_strength:e,u_ground_shadow_factor:f}),Ud=(p,e,a,f,y,w,I=0)=>Object.assign(Ip(p,e,a,f,w,I),{u_world:y}),lh=(p,e)=>({u_matrix:p,u_ground_shadow_factor:e}),nd=(p,e,a,f,y)=>({u_matrix:p,u_camera_pos:[e[0],e[1],e[2]],u_depth_bias:a,u_height_scale:f,u_reset_depth:y}),gf=(p,e,a,f,y,w,I,M,L)=>({u_matrix:p,u_normal_matrix:e,u_opacity:a,u_faux_facade_ao_intensity:f,u_camera_pos:y,u_tile_to_meter:w,u_facade_emissive_chance:I,u_flood_light_color:M,u_flood_light_intensity:L}),qh=p=>({u_matrix:p}),_f=p=>({u_matrix:p}),Uc=(p,e,a,f,y,w,I,M)=>{const L=i.al/w.tileSize;return{u_matrix:p,u_inv_rot_matrix:e,u_camera_to_center_distance:a.getCameraToCenterDistance(M),u_extrude_scale:[a.pixelsToGLUnits[0]/L,a.pixelsToGLUnits[1]/L],u_zoom_transition:f,u_tile_id:I,u_merc_center:y}},od=(p,e,a=1)=>({u_matrix:p,u_color:e,u_overlay:0,u_overlay_scale:a}),Ep=i.bB(),yf=(p,e,a,f,y,w,I)=>{const M=p.transform,L=M.projection.name==="globe",N=L?i.dQ(M.zoom,e.canonical)*M._pixelsPerMercatorPixel:i.ay(a,1,w),V={u_matrix:e.projMatrix,u_extrude_scale:N,u_intensity:I,u_inv_rot_matrix:Ep,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(L){V.u_inv_rot_matrix=f,V.u_merc_center=y,V.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],V.u_zoom_transition=i.aj(M.zoom);const Z=y[0]*i.al,U=y[1]*i.al;V.u_up_dir=M.projection.upVector(new i.cC(0,0,0),Z,U)}return V};function jd(p,[e,a,f,y],[w,I]){if(w===I)return[0,0,0,0];const M=255*(p-1)/(p*(I-w));return[e*M,a*M,f*M,y*M]}function fc(p,e,[a,f]){return a===f?0:.5/p+(e-a)*(p-1)/(p*(f-a))}const wu=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt,_t,Mt,vt)=>({u_matrix:p,u_normalize_matrix:e,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:y,u_tl_parent:w,u_scale_parent:N,u_fade_t:V.mix,u_opacity:V.opacity*Z.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:Z.paint.get("raster-brightness-min"),u_brightness_high:Z.paint.get("raster-brightness-max"),u_saturation_factor:i.dS(Z.paint.get("raster-saturation")),u_contrast_factor:i.dR(Z.paint.get("raster-contrast")),u_spin_weights:sd(Z.paint.get("raster-hue-rotate")),u_perspective_transform:U,u_raster_elevation:X,u_zoom_transition:I,u_merc_center:M,u_cutoff_params:L,u_colorization_mix:jd(i.dT,rt,lt),u_colorization_offset:fc(i.dT,ht,lt),u_color_ramp:K,u_texture_offset:[Mt/(_t+2*Mt),_t/(_t+2*Mt)],u_texture_res:[_t+2*Mt,_t+2*Mt],u_emissive_strength:vt});function sd(p){p*=Math.PI/180;const e=Math.sin(p),a=Math.cos(p);return[(2*a+1)/3,(-Math.sqrt(3)*e-a+1)/3,(Math.sqrt(3)*e-a+1)/3]}const Tu=.05,ch=(p,e,a,f,y,w,I,M,L,N,V,Z)=>({u_matrix:p,u_normalize_matrix:e,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:y,u_tl_parent:w,u_scale_parent:N,u_fade_t:V.mix,u_opacity:V.opacity,u_image0:0,u_image1:1,u_raster_elevation:Z,u_zoom_transition:I,u_merc_center:M,u_cutoff_params:L}),jc=(p,e,a,f,y,w,I,M,L,N)=>({u_particle_texture:p,u_particle_texture_side_len:e,u_tile_offset:a,u_velocity:f,u_color_ramp:w,u_velocity_res:y,u_max_speed:I,u_uv_offset:M,u_data_scale:[255*L[0],255*L[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[Tu,Tu]}),wo=(p,e,a,f,y,w,I,M,L,N)=>({u_particle_texture:p,u_particle_texture_side_len:e,u_velocity:a,u_velocity_res:f,u_max_speed:y,u_speed_factor:w,u_reset_rate:I,u_rand_seed:Math.random(),u_uv_offset:M,u_data_scale:[255*L[0],255*L[1]],u_data_offset:N,u_particle_pos_scale:1.1,u_particle_pos_offset:[Tu,Tu]}),xf=i.bB(),Su=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt,_t,Mt,vt,Ut,Ct,$t)=>{const Ot=y.transform,Rt={u_is_size_zoom_constant:+(p==="constant"||p==="source"),u_is_size_feature_constant:+(p==="constant"||p==="camera"),u_size_t:e?e.uSizeT:0,u_size:e?e.uSize:0,u_camera_to_center_distance:Ot.getCameraToCenterDistance(_t),u_rotate_symbol:+a,u_aspect_ratio:Ot.width/Ot.height,u_fade_change:y.options.fadeDuration?y.symbolFadeChange:1,u_matrix:w,u_label_plane_matrix:I,u_coord_matrix:M,u_is_text:+N,u_elevation_from_sea:L?1:0,u_pitch_with_map:+f,u_texsize:V,u_texsize_icon:Z,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:xf,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:xf,u_up_vector:[0,-1,0],u_color_adj_mat:Ut,u_icon_transition:Ct||0,u_gamma_scale:f?y.transform.getCameraToCenterDistance(_t)*Math.cos(y.terrain?0:y.transform._pitch):1,u_device_pixel_ratio:i.o.devicePixelRatio,u_is_halo:1,u_scale_factor:$t||1,u_ground_shadow_factor:Mt,u_inv_matrix:i.bk(i.bB(),I),u_normal_scale:vt,u_lutTexture:Ss.LUT};return _t.name==="globe"&&(Rt.u_tile_id=[X.canonical.x,X.canonical.y,1<<X.canonical.z],Rt.u_zoom_transition=K,Rt.u_inv_rot_matrix=ht,Rt.u_merc_center=rt,Rt.u_camera_forward=Ot._camera.forward(),Rt.u_ecef_origin=i.dU(Ot.globeMatrix,X.toUnwrapped()),Rt.u_tile_matrix=Float32Array.from(Ot.globeMatrix),Rt.u_up_vector=lt),Rt},Zh=(p,e,a,f)=>({u_matrix:p,u_emissive_strength:e,u_opacity:a,u_color:f}),ad=(p,e,a,f,y,w,I,M,L)=>Object.assign(function(N,V,Z,U,X,K){const{width:rt,height:ht}=U.imageManager.getPixelSize(V),lt=Math.pow(2,K.tileID.overscaledZ),_t=K.tileSize*Math.pow(2,U.transform.tileZoom)/lt,Mt=_t*(K.tileID.canonical.x+K.tileID.wrap*lt),vt=_t*K.tileID.canonical.y;return{u_image:0,u_pattern_tl:Z.tl,u_pattern_br:Z.br,u_texsize:[rt,ht],u_pattern_size:Z.displaySize,u_pattern_units_to_pixels:X?[U.transform.width,-1*U.transform.height]:[1/i.ay(K,1,U.transform.tileZoom),1/i.ay(K,1,U.transform.tileZoom)],u_pixel_coord_upper:[Mt>>16,vt>>16],u_pixel_coord_lower:[65535&Mt,65535&vt]}}(0,w,I,f,M,L),{u_matrix:p,u_emissive_strength:e,u_opacity:a}),Ap=new Float32Array(i.bz([])),ld=(p,e,a,f,y,w,I,M,L,N,V,Z,U,X=[0,0,0],K,rt,ht)=>{const lt=y.style.light,_t=lt.properties.get("position"),Mt=[-_t.x,-_t.y,_t.z],vt=i.dN();lt.properties.get("anchor")==="viewport"&&(i.dO(vt,-y.transform.angle),i.dP(Mt,Mt,vt));const Ut=V.alphaMode==="MASK",Ct=lt.properties.get("color").toNonPremultipliedRenderColor(null),$t=U.paint.get("model-ambient-occlusion-intensity"),Ot=U.paint.get("model-color").constantOr(i.ao.white).toNonPremultipliedRenderColor(null);return Ot.a=U.paint.get("model-color-mix-intensity").constantOr(0),ht&&(Ot.r=ht[0],Ot.g=ht[1],Ot.b=ht[2],Ot.a=ht[3]),rt&&(Ot.r=rt.color.r,Ot.g=rt.color.g,Ot.b=rt.color.b,Ot.a=rt.colorMix,Z=rt.emissionStrength,w=rt.opacity),{u_matrix:p,u_lighting_matrix:e,u_normal_matrix:a,u_node_matrix:f||Ap,u_lightpos:Mt,u_lightintensity:lt.properties.get("intensity"),u_lightcolor:[Ct.r,Ct.g,Ct.b],u_camera_pos:X,u_opacity:w,u_baseTextureIsAlpha:0,u_alphaMask:+Ut,u_alphaCutoff:V.alphaCutoff,u_baseColorFactor:I.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:M.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:L,u_roughnessFactor:N,u_baseColorTexture:Ss.BaseColor,u_metallicRoughnessTexture:Ss.MetallicRoughness,u_normalTexture:Ss.Normal,u_occlusionTexture:Ss.Occlusion,u_emissionTexture:Ss.Emission,u_lutTexture:Ss.LUT,u_color_mix:Ot.toArray01(),u_aoIntensity:$t,u_emissive_strength:Z,u_occlusionTextureTransform:K||[0,0,0,0]}},Hh=(p,e=Ap,a=Ap)=>({u_matrix:p,u_instance:e,u_node_matrix:a}),Jf={fillExtrusion:p=>({u_matrix:new i.ck(p),u_lightpos:new i.ch(p),u_lightintensity:new i.ci(p),u_lightcolor:new i.ch(p),u_vertical_gradient:new i.ci(p),u_opacity:new i.ci(p),u_edge_radius:new i.ci(p),u_width_scale:new i.ci(p),u_ao:new i.cj(p),u_height_type:new i.cg(p),u_base_type:new i.cg(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_up_dir:new i.ch(p),u_height_lift:new i.ci(p),u_flood_light_color:new i.ch(p),u_vertical_scale:new i.ci(p),u_flood_light_intensity:new i.ci(p),u_ground_shadow_factor:new i.ch(p)}),fillExtrusionDepth:p=>({u_matrix:new i.ck(p),u_edge_radius:new i.ci(p),u_width_scale:new i.ci(p),u_vertical_scale:new i.ci(p),u_height_type:new i.cg(p),u_base_type:new i.cg(p)}),fillExtrusionPattern:p=>({u_matrix:new i.ck(p),u_lightpos:new i.ch(p),u_lightintensity:new i.ci(p),u_lightcolor:new i.ch(p),u_vertical_gradient:new i.ci(p),u_height_factor:new i.ci(p),u_edge_radius:new i.ci(p),u_width_scale:new i.ci(p),u_ao:new i.cj(p),u_height_type:new i.cg(p),u_base_type:new i.cg(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_up_dir:new i.ch(p),u_height_lift:new i.ci(p),u_image:new i.cg(p),u_texsize:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_tile_units_to_pixels:new i.ci(p),u_opacity:new i.ci(p),u_pattern_transition:new i.ci(p)}),fillExtrusionGroundEffect:p=>({u_matrix:new i.ck(p),u_opacity:new i.ci(p),u_ao_pass:new i.ci(p),u_meter_to_tile:new i.ci(p),u_ao:new i.cj(p),u_flood_light_intensity:new i.ci(p),u_flood_light_color:new i.ch(p),u_attenuation:new i.ci(p),u_edge_radius:new i.ci(p),u_fb:new i.cg(p),u_fb_size:new i.ci(p),u_dynamic_offset:new i.ci(p)}),fill:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_ground_shadow_factor:new i.ch(p)}),fillPattern:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_image:new i.cg(p),u_texsize:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_tile_units_to_pixels:new i.ci(p),u_ground_shadow_factor:new i.ch(p),u_pattern_transition:new i.ci(p)}),fillOutline:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_world:new i.cj(p),u_ground_shadow_factor:new i.ch(p)}),fillOutlinePattern:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_world:new i.cj(p),u_image:new i.cg(p),u_texsize:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_tile_units_to_pixels:new i.ci(p),u_ground_shadow_factor:new i.ch(p),u_pattern_transition:new i.ci(p)}),building:p=>({u_matrix:new i.ck(p),u_normal_matrix:new i.ck(p),u_opacity:new i.ci(p),u_faux_facade_ao_intensity:new i.ci(p),u_camera_pos:new i.ch(p),u_tile_to_meter:new i.ci(p),u_facade_emissive_chance:new i.ci(p),u_flood_light_color:new i.ch(p),u_flood_light_intensity:new i.ci(p)}),buildingBloom:p=>({u_matrix:new i.ck(p)}),buildingDepth:p=>({u_matrix:new i.ck(p)}),elevatedStructuresDepth:p=>({u_matrix:new i.ck(p),u_depth_bias:new i.ci(p)}),elevatedStructures:p=>({u_matrix:new i.ck(p),u_ground_shadow_factor:new i.ch(p)}),elevatedStructuresDepthReconstruct:p=>({u_matrix:new i.ck(p),u_camera_pos:new i.ch(p),u_depth_bias:new i.ci(p),u_height_scale:new i.ci(p),u_reset_depth:new i.ci(p)}),circle:i.dX,collisionBox:p=>({u_matrix:new i.ck(p),u_inv_rot_matrix:new i.ck(p),u_camera_to_center_distance:new i.ci(p),u_extrude_scale:new i.cj(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_tile_id:new i.ch(p)}),collisionCircle:p=>({u_matrix:new i.ck(p),u_inv_matrix:new i.ck(p),u_camera_to_center_distance:new i.ci(p),u_viewport_size:new i.cj(p)}),debug:p=>({u_color:new i.dA(p),u_matrix:new i.ck(p),u_overlay:new i.cg(p),u_overlay_scale:new i.ci(p)}),clippingMask:p=>({u_matrix:new i.ck(p)}),heatmap:p=>({u_extrude_scale:new i.ci(p),u_intensity:new i.ci(p),u_matrix:new i.ck(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_up_dir:new i.ch(p)}),heatmapTexture:p=>({u_image:new i.cg(p),u_color_ramp:new i.cg(p),u_opacity:new i.ci(p)}),hillshade:p=>({u_matrix:new i.ck(p),u_image:new i.cg(p),u_latrange:new i.cj(p),u_light:new i.cj(p),u_shadow:new i.dA(p),u_highlight:new i.dA(p),u_emissive_strength:new i.ci(p),u_accent:new i.dA(p)}),hillshadePrepare:p=>({u_matrix:new i.ck(p),u_image:new i.cg(p),u_dimension:new i.cj(p),u_zoom:new i.ci(p)}),line:i.dW,linePattern:i.dV,raster:p=>({u_matrix:new i.ck(p),u_normalize_matrix:new i.ck(p),u_globe_matrix:new i.ck(p),u_merc_matrix:new i.ck(p),u_grid_matrix:new i.dB(p),u_tl_parent:new i.cj(p),u_scale_parent:new i.ci(p),u_fade_t:new i.ci(p),u_opacity:new i.ci(p),u_image0:new i.cg(p),u_image1:new i.cg(p),u_brightness_low:new i.ci(p),u_brightness_high:new i.ci(p),u_saturation_factor:new i.ci(p),u_contrast_factor:new i.ci(p),u_spin_weights:new i.ch(p),u_perspective_transform:new i.cj(p),u_raster_elevation:new i.ci(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_cutoff_params:new i.d2(p),u_colorization_mix:new i.d2(p),u_colorization_offset:new i.ci(p),u_color_ramp:new i.cg(p),u_texture_offset:new i.cj(p),u_texture_res:new i.cj(p),u_emissive_strength:new i.ci(p)}),rasterParticle:p=>({u_matrix:new i.ck(p),u_normalize_matrix:new i.ck(p),u_globe_matrix:new i.ck(p),u_merc_matrix:new i.ck(p),u_grid_matrix:new i.dB(p),u_tl_parent:new i.cj(p),u_scale_parent:new i.ci(p),u_fade_t:new i.ci(p),u_opacity:new i.ci(p),u_image0:new i.cg(p),u_image1:new i.cg(p),u_raster_elevation:new i.ci(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_cutoff_params:new i.d2(p)}),rasterParticleTexture:p=>({u_texture:new i.cg(p),u_opacity:new i.ci(p)}),rasterParticleDraw:p=>({u_particle_texture:new i.cg(p),u_particle_texture_side_len:new i.ci(p),u_tile_offset:new i.cj(p),u_velocity:new i.cg(p),u_color_ramp:new i.cg(p),u_velocity_res:new i.cj(p),u_max_speed:new i.ci(p),u_uv_offset:new i.cj(p),u_data_scale:new i.cj(p),u_data_offset:new i.ci(p),u_particle_pos_scale:new i.ci(p),u_particle_pos_offset:new i.cj(p)}),rasterParticleUpdate:p=>({u_particle_texture:new i.cg(p),u_particle_texture_side_len:new i.ci(p),u_velocity:new i.cg(p),u_velocity_res:new i.cj(p),u_max_speed:new i.ci(p),u_speed_factor:new i.ci(p),u_reset_rate:new i.ci(p),u_rand_seed:new i.ci(p),u_uv_offset:new i.cj(p),u_data_scale:new i.cj(p),u_data_offset:new i.ci(p),u_particle_pos_scale:new i.ci(p),u_particle_pos_offset:new i.cj(p)}),symbol:p=>({u_is_size_zoom_constant:new i.cg(p),u_is_size_feature_constant:new i.cg(p),u_size_t:new i.ci(p),u_size:new i.ci(p),u_camera_to_center_distance:new i.ci(p),u_rotate_symbol:new i.cg(p),u_aspect_ratio:new i.ci(p),u_fade_change:new i.ci(p),u_matrix:new i.ck(p),u_label_plane_matrix:new i.ck(p),u_coord_matrix:new i.ck(p),u_is_text:new i.cg(p),u_elevation_from_sea:new i.cg(p),u_pitch_with_map:new i.cg(p),u_texsize:new i.cj(p),u_texsize_icon:new i.cj(p),u_texture:new i.cg(p),u_texture_icon:new i.cg(p),u_gamma_scale:new i.ci(p),u_device_pixel_ratio:new i.ci(p),u_tile_id:new i.ch(p),u_zoom_transition:new i.ci(p),u_inv_rot_matrix:new i.ck(p),u_merc_center:new i.cj(p),u_camera_forward:new i.ch(p),u_tile_matrix:new i.ck(p),u_up_vector:new i.ch(p),u_ecef_origin:new i.ch(p),u_is_halo:new i.cg(p),u_icon_transition:new i.ci(p),u_color_adj_mat:new i.ck(p),u_scale_factor:new i.ci(p),u_ground_shadow_factor:new i.ch(p),u_inv_matrix:new i.ck(p),u_normal_scale:new i.ci(p),u_lutTexture:new i.cg(p)}),background:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_opacity:new i.ci(p),u_color:new i.dA(p)}),backgroundPattern:p=>({u_matrix:new i.ck(p),u_emissive_strength:new i.ci(p),u_opacity:new i.ci(p),u_image:new i.cg(p),u_pattern_tl:new i.cj(p),u_pattern_br:new i.cj(p),u_texsize:new i.cj(p),u_pattern_size:new i.cj(p),u_pixel_coord_upper:new i.cj(p),u_pixel_coord_lower:new i.cj(p),u_pattern_units_to_pixels:new i.cj(p)}),terrainRaster:p=>({u_matrix:new i.ck(p),u_image0:new i.cg(p),u_skirt_height:new i.ci(p),u_ground_shadow_factor:new i.ch(p)}),skybox:p=>({u_matrix:new i.ck(p),u_sun_direction:new i.ch(p),u_cubemap:new i.cg(p),u_opacity:new i.ci(p),u_temporal_offset:new i.ci(p)}),skyboxGradient:p=>({u_matrix:new i.ck(p),u_color_ramp:new i.cg(p),u_center_direction:new i.ch(p),u_radius:new i.ci(p),u_opacity:new i.ci(p),u_temporal_offset:new i.ci(p)}),skyboxCapture:p=>({u_matrix_3f:new i.dB(p),u_sun_direction:new i.ch(p),u_sun_intensity:new i.ci(p),u_color_tint_r:new i.d2(p),u_color_tint_m:new i.d2(p),u_luminance:new i.ci(p)}),globeRaster:p=>({u_proj_matrix:new i.ck(p),u_globe_matrix:new i.ck(p),u_normalize_matrix:new i.ck(p),u_merc_matrix:new i.ck(p),u_zoom_transition:new i.ci(p),u_merc_center:new i.cj(p),u_image0:new i.cg(p),u_grid_matrix:new i.dB(p),u_skirt_height:new i.ci(p),u_far_z_cutoff:new i.ci(p),u_frustum_tl:new i.ch(p),u_frustum_tr:new i.ch(p),u_frustum_br:new i.ch(p),u_frustum_bl:new i.ch(p),u_globe_pos:new i.ch(p),u_globe_radius:new i.ci(p),u_viewport:new i.cj(p)}),globeAtmosphere:p=>({u_frustum_tl:new i.ch(p),u_frustum_tr:new i.ch(p),u_frustum_br:new i.ch(p),u_frustum_bl:new i.ch(p),u_horizon:new i.ci(p),u_transition:new i.ci(p),u_fadeout_range:new i.ci(p),u_atmosphere_fog_color:new i.d2(p),u_high_color:new i.d2(p),u_space_color:new i.d2(p),u_temporal_offset:new i.ci(p),u_horizon_angle:new i.ci(p)}),model:p=>({u_matrix:new i.ck(p),u_lighting_matrix:new i.ck(p),u_normal_matrix:new i.ck(p),u_node_matrix:new i.ck(p),u_lightpos:new i.ch(p),u_lightintensity:new i.ci(p),u_lightcolor:new i.ch(p),u_camera_pos:new i.ch(p),u_opacity:new i.ci(p),u_baseColorFactor:new i.d2(p),u_emissiveFactor:new i.d2(p),u_metallicFactor:new i.ci(p),u_roughnessFactor:new i.ci(p),u_baseTextureIsAlpha:new i.cg(p),u_alphaMask:new i.cg(p),u_alphaCutoff:new i.ci(p),u_baseColorTexture:new i.cg(p),u_metallicRoughnessTexture:new i.cg(p),u_normalTexture:new i.cg(p),u_occlusionTexture:new i.cg(p),u_emissionTexture:new i.cg(p),u_lutTexture:new i.cg(p),u_color_mix:new i.d2(p),u_aoIntensity:new i.ci(p),u_emissive_strength:new i.ci(p),u_occlusionTextureTransform:new i.d2(p)}),modelDepth:p=>({u_matrix:new i.ck(p),u_instance:new i.ck(p),u_node_matrix:new i.ck(p)}),groundShadow:p=>({u_matrix:new i.ck(p),u_ground_shadow_factor:new i.ch(p)}),stars:p=>({u_matrix:new i.ck(p),u_up:new i.ch(p),u_right:new i.ch(p),u_intensity_multiplier:new i.ci(p)}),snowParticle:p=>({u_modelview:new i.ck(p),u_projection:new i.ck(p),u_time:new i.ci(p),u_cam_pos:new i.ch(p),u_velocityConeAperture:new i.ci(p),u_velocity:new i.ci(p),u_horizontalOscillationRadius:new i.ci(p),u_horizontalOscillationRate:new i.ci(p),u_boxSize:new i.ci(p),u_billboardSize:new i.ci(p),u_simpleShapeParameters:new i.cj(p),u_screenSize:new i.cj(p),u_thinningCenterPos:new i.cj(p),u_thinningShape:new i.ch(p),u_thinningAffectedRatio:new i.ci(p),u_thinningParticleOffset:new i.ci(p),u_particleColor:new i.d2(p),u_direction:new i.ch(p)}),rainParticle:p=>({u_modelview:new i.ck(p),u_projection:new i.ck(p),u_time:new i.ci(p),u_cam_pos:new i.ch(p),u_texScreen:new i.cg(p),u_velocityConeAperture:new i.ci(p),u_velocity:new i.ci(p),u_boxSize:new i.ci(p),u_rainDropletSize:new i.cj(p),u_distortionStrength:new i.ci(p),u_rainDirection:new i.ch(p),u_color:new i.d2(p),u_screenSize:new i.cj(p),u_thinningCenterPos:new i.cj(p),u_thinningShape:new i.ch(p),u_thinningAffectedRatio:new i.ci(p),u_thinningParticleOffset:new i.ci(p),u_shapeDirectionalPower:new i.ci(p),u_shapeNormalPower:new i.ci(p),u_mode:new i.ci(p)}),vignette:p=>({u_vignetteShape:new i.ch(p),u_vignetteColor:new i.d2(p)}),occlusion:p=>({u_matrix:new i.ck(p),u_anchorPos:new i.ch(p),u_screenSizePx:new i.cj(p),u_occluderSizePx:new i.cj(p),u_color:new i.d2(p)})};class da{constructor(e,a,f,y){this.id=da.uniqueIdxCounter,da.uniqueIdxCounter++,this.context=e;const w=e.gl;this.buffer=w.createBuffer(),this.dynamicDraw=!!f,this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),w.bufferData(w.ELEMENT_ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?w.DYNAMIC_DRAW:w.STATIC_DRAW),this.dynamicDraw||y||a.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){this.id=da.uniqueIdxCounter,da.uniqueIdxCounter++;const a=this.context.gl;this.context.unbindVAO(),this.bind(),a.bufferSubData(a.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}da.uniqueIdxCounter=0;const Wh={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ir{constructor(e,a,f,y,w,I){this.length=a.length,this.attributes=f,this.itemSize=a.bytesPerElement,this.dynamicDraw=y,this.instanceCount=I,this.context=e;const M=e.gl;this.buffer=M.createBuffer(),e.bindVertexBuffer.set(this.buffer),M.bufferData(M.ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?M.DYNAMIC_DRAW:M.STATIC_DRAW),this.dynamicDraw||w||a.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){const a=this.context.gl;this.bind(),a.bufferSubData(a.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,a){for(let f=0;f<this.attributes.length;f++){const y=a.getAttributeLocation(e,this.attributes[f].name);y!==-1&&e.enableVertexAttribArray(y)}}setVertexAttribPointers(e,a,f){for(let y=0;y<this.attributes.length;y++){const w=this.attributes[y],I=a.getAttributeLocation(e,w.name);I!==-1&&e.vertexAttribPointer(I,w.components,e[Wh[w.type]],!1,this.itemSize,w.offset+this.itemSize*(f||0))}}setVertexAttribDivisor(e,a,f){for(let y=0;y<this.attributes.length;y++){const w=a.getAttributeLocation(e,this.attributes[y].name);w!==-1&&this.instanceCount&&this.instanceCount>0&&e.vertexAttribDivisor(w,f)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Or{constructor(e,a,f,y,w){this.context=e,this.width=a,this.height=f;const I=this.framebuffer=e.gl.createFramebuffer();y&&(this.colorAttachment=new ff(e,I)),w&&(this.depthAttachmentType=w,this.depthAttachment=w==="renderbuffer"?new td(e,I):new Xf(e,I))}destroy(){const e=this.context.gl;if(this.colorAttachment){const a=this.colorAttachment.get();a&&e.deleteTexture(a)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const a=this.depthAttachment.get();a&&e.deleteRenderbuffer(a)}else{const a=this.depthAttachment.get();a&&e.deleteTexture(a)}e.deleteFramebuffer(this.framebuffer)}}class Xh{constructor(e,a){this.gl=e,this.clearColor=new Bh(this),this.clearDepth=new Yu(this),this.clearStencil=new Hf(this),this.colorMask=new yp(this),this.depthMask=new xp(this),this.stencilMask=new vp(this),this.stencilFunc=new mu(this),this.stencilOp=new bp(this),this.stencilTest=new zd(this),this.depthRange=new Ld(this),this.depthTest=new Wf(this),this.depthFunc=new Rd(this),this.blend=new Oh(this),this.blendFunc=new Ju(this),this.blendColor=new Nh(this),this.blendEquation=new gu(this),this.cullFace=new Vh(this),this.cullFaceSide=new Uh(this),this.frontFace=new pf(this),this.program=new kd(this),this.activeTexture=new rs(this),this.viewport=new yl(this),this.bindFramebuffer=new Ea(this),this.bindRenderbuffer=new jh(this),this.bindTexture=new oh(this),this.bindVertexBuffer=new Fd(this),this.bindElementBuffer=new Bc(this),this.bindVertexArrayOES=new wp(this),this.pixelStoreUnpack=new Ku(this),this.pixelStoreUnpackPremultiplyAlpha=new Tp(this),this.pixelStoreUnpackFlipY=new _u(this),this.options=a?Object.assign({},a):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=e.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=e.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=e.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=a&&!!a.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=e.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=e.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=e.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPointSize=e.getParameter(e.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,a,f){return new da(this,e,a,f)}createVertexBuffer(e,a,f,y,w){return new Ir(this,e,a,f,y,w)}createRenderbuffer(e,a,f){const y=this.gl,w=y.createRenderbuffer();return this.bindRenderbuffer.set(w),y.renderbufferStorage(y.RENDERBUFFER,e,a,f),this.bindRenderbuffer.set(null),w}createFramebuffer(e,a,f,y){return new Or(this,e,a,f,y)}clear({color:e,depth:a,stencil:f,colorMask:y}){const w=this.gl;let I=0;e&&(I|=w.COLOR_BUFFER_BIT,this.clearColor.set(e.toNonPremultipliedRenderColor(null)),this.colorMask.set(y||[!0,!0,!0,!0])),a!==void 0&&(I|=w.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(a),this.depthMask.set(!0)),f!==void 0&&(I|=w.STENCIL_BUFFER_BIT,this.clearStencil.set(f),this.stencilMask.set(255)),w.clear(I)}setCullFace(e){e.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(e){i.bx(e.blendFunction,Sr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor),e.blendEquation?this.blendEquation.set(e.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(e.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let mc;function hh(p,e,a,f,y,w,I){const M=p.context,L=M.gl,N=p.transform,V=[i.aF(N.center.lng),i.aJ(N.center.lat)],Z=a.layout.get("symbol-placement"),U=a.layout.get("text-variable-anchor"),X=a.layout.get("icon-rotation-alignment")==="map",K=a.layout.get("text-rotation-alignment")==="map",rt=Z!=="point",ht=[];let lt=0,_t=0;for(let Rt=0;Rt<f.length;Rt++){const Zt=f[Rt],pe=e.getTile(Zt),le=pe.getBucket(a);if(!le)continue;const Me=le.getProjection().createInversionMatrix(N,Zt.canonical),ve=[],Be=lu(Zt,le,N),oi=!I&&X&&rt,ge=I&&K&&rt,ie=U&&le.hasTextData(),Oe=le.hasIconTextFit()&&ie&&le.hasIconData(),Te=oi||ge||I&&ie||Oe,qe=le.projection.name==="globe",si=qe?i.aj(N.zoom):0;qe&&(ve.push("PROJECTION_GLOBE_VIEW"),Te&&ve.push("PROJECTED_POS_ON_VIEWPORT"));const Li=p.getOrCreateProgram("collisionBox",{defines:ve});let ni=Be;y[0]===0&&y[1]===0||(ni=p.translatePosMatrix(Be,pe,y,w));const li=I?le.textCollisionBox:le.iconCollisionBox,Fi=le.collisionCircleArray;if(Fi.length>0){const xi=i.bB(),Ai=ni;i.cO(xi,le.placementInvProjMatrix,N.glCoordMatrix),i.cO(xi,xi,le.placementViewportMatrix),ht.push({circleArray:Fi,circleOffset:_t,transform:Ai,invTransform:xi,projection:le.getProjection()}),lt+=Fi.length/4,_t=lt}if(!li)continue;p.terrain&&p.terrain.setupElevationDraw(pe,Li);const Si=qe?[Zt.canonical.x,Zt.canonical.y,1<<Zt.canonical.z]:[0,0,0];Li.draw(p,L.LINES,ki.disabled,hr.disabled,p.colorModeForRenderPass(),rr.disabled,Uc(ni,Me,N,si,V,pe,Si,le.getProjection()),a.id,li.layoutVertexBuffer,li.indexBuffer,li.segments,null,N.zoom,null,[li.collisionVertexBuffer,li.collisionVertexBufferExt])}if(!I||!ht.length)return;const Mt=p.getOrCreateProgram("collisionCircle"),vt=new i.dY;vt.resize(4*lt),vt._trim();let Ut=0;for(const Rt of ht)for(let Zt=0;Zt<Rt.circleArray.length/4;Zt++){const pe=4*Zt,le=Rt.circleArray[pe+0],Me=Rt.circleArray[pe+1],ve=Rt.circleArray[pe+2],Be=Rt.circleArray[pe+3];vt.emplace(Ut++,le,Me,ve,Be,0),vt.emplace(Ut++,le,Me,ve,Be,1),vt.emplace(Ut++,le,Me,ve,Be,2),vt.emplace(Ut++,le,Me,ve,Be,3)}(!mc||mc.length<2*lt)&&(mc=function(Rt){const Zt=2*Rt,pe=new i.b0;pe.resize(Zt),pe._trim();for(let le=0;le<Zt;le++){const Me=6*le;pe.uint16[Me+0]=4*le+0,pe.uint16[Me+1]=4*le+1,pe.uint16[Me+2]=4*le+2,pe.uint16[Me+3]=4*le+2,pe.uint16[Me+4]=4*le+3,pe.uint16[Me+5]=4*le+0}return pe}(lt));const Ct=M.createIndexBuffer(mc,!0),$t=M.createVertexBuffer(vt,i.dZ.members,!0);for(const Rt of ht){const Zt={u_matrix:Rt.transform,u_inv_matrix:Rt.invTransform,u_camera_to_center_distance:(Ot=N).getCameraToCenterDistance(Rt.projection),u_viewport_size:[Ot.width,Ot.height]};Mt.draw(p,L.TRIANGLES,ki.disabled,hr.disabled,p.colorModeForRenderPass(),rr.disabled,Zt,a.id,$t,Ct,i.bf.simpleSegment(0,2*Rt.circleOffset,Rt.circleArray.length,Rt.circleArray.length/2),null,N.zoom)}var Ot;$t.destroy(),Ct.destroy()}const _s=i.bB();function bl(p){const e=p._camera.getWorldToCamera(p.worldSize,1),a=i.aB([],e,p.globeMatrix);i.bk(a,a);const f=[0,0,0],y=[0,1,0,0];return i.aC(y,y,a),f[0]=y[0],f[1]=y[1],f[2]=y[2],i.aw(f,f),f}function Gd({width:p,height:e,anchor:a,textOffset:f,textScale:y},w){const{horizontalAlign:I,verticalAlign:M}=i.c0(a),L=-(I-.5)*p,N=-(M-.5)*e,V=i.c1(a,f);return new i.P((L/y+V[0])*w,(N/y+V[1])*w)}function Pp(p,e,a,f,y,w,I,M,L,N){const V=p.text.placedSymbolArray,Z=p.text.dynamicLayoutVertexArray,U=p.icon.dynamicLayoutVertexArray,X={},K=p.getProjection(),rt=Un(I,K,y),ht=y.elevation,lt=K.upVectorScale(I.canonical,y.center.lat,y.worldSize).metersToTile;Z.clear();for(let _t=0;_t<V.length;_t++){const Mt=V.get(_t),{tileAnchorX:vt,tileAnchorY:Ut,numGlyphs:Ct}=Mt,$t=Mt.hidden||!Mt.crossTileID||p.allowVerticalPlacement&&!Mt.placedOrientation?null:f[Mt.crossTileID];if($t){let Ot=0,Rt=0,Zt=0;const pe=p.elevationType==="road";if(ht||pe){const Te=pe?p.getElevationFeatureForText(_t):null,qe=i.bU.getAtTileOffset(I,new i.P(vt,Ut),ht,Te),[si,Li,ni]=K.upVector(I.canonical,vt,Ut);Ot=qe*si*lt,Rt=qe*Li*lt,Zt=qe*ni*lt}let[le,Me,ve,Be]=es(Mt.projectedAnchorX+Ot,Mt.projectedAnchorY+Rt,Mt.projectedAnchorZ+Zt,a?rt:w);const oi=Ph(y.getCameraToCenterDistance(K),Be);let ge=i.bL(p.textSizeData,L,Mt)*oi/i.bX;a&&(ge*=p.tilePixelRatio/M);const ie=Gd($t,ge);a?({x:le,y:Me,z:ve}=K.projectTilePoint(vt+ie.x,Ut+ie.y,I.canonical),[le,Me,ve]=es(le+Ot,Me+Rt,ve+Zt,w)):(e&&ie._rotate(-y.angle),le+=ie.x,Me+=ie.y,ve=0);const Oe=p.allowVerticalPlacement&&Mt.placedOrientation===i.bK.vertical?Math.PI/2:0;for(let Te=0;Te<Ct;Te++)i.bN(Z,le,Me,ve,Oe);N&&Mt.associatedIconIndex>=0&&(X[Mt.associatedIconIndex]={x:le,y:Me,z:ve,angle:Oe})}else fl(Ct,Z)}if(N){U.clear();const _t=p.icon.placedSymbolArray;for(let Mt=0;Mt<_t.length;Mt++){const vt=_t.get(Mt),{numGlyphs:Ut}=vt,Ct=X[Mt];if(vt.hidden||!Ct)fl(Ut,U);else{const{x:$t,y:Ot,z:Rt,angle:Zt}=Ct;for(let pe=0;pe<Ut;pe++)i.bN(U,$t,Ot,Rt,Zt)}}p.icon.dynamicLayoutVertexBuffer.updateData(U)}p.text.dynamicLayoutVertexBuffer.updateData(Z)}function $d(p,e,a,f,y,w,I={}){const M=a.paint.get("icon-translate"),L=a.paint.get("text-translate"),N=a.paint.get("icon-translate-anchor"),V=a.paint.get("text-translate-anchor"),Z=a.layout.get("icon-rotation-alignment"),U=a.layout.get("text-rotation-alignment"),X=a.layout.get("icon-pitch-alignment"),K=a.layout.get("text-pitch-alignment"),rt=a.layout.get("icon-keep-upright"),ht=a.layout.get("text-keep-upright"),lt=a.paint.get("icon-color-saturation"),_t=a.paint.get("icon-color-contrast"),Mt=a.paint.get("icon-color-brightness-min"),vt=a.paint.get("icon-color-brightness-max"),Ut=a.layout.get("symbol-elevation-reference")==="sea",Ct=a.layout.get("icon-image-use-theme")==="none",$t=p.context,Ot=$t.gl,Rt=p.transform,Zt=Z==="map",pe=U==="map",le=X==="map",Me=K==="map",ve=a.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Be=!1;const oi=p.depthModeForSublayer(0,ki.ReadOnly),ge=new ki(p.context.gl.LEQUAL,ki.ReadOnly,p.depthRangeFor3D),ie=[i.aF(Rt.center.lng),i.aJ(Rt.center.lat)],Oe=a.layout.get("text-variable-anchor"),Te=Rt.projection.name==="globe",qe=[],si=[0,-1,0];for(const Li of f){const ni=e.getTile(Li),li=ni.getBucket(a);if(!li||li.projection.name==="mercator"&&Te||li.fullyClipped)continue;const Fi=li.projection.name==="globe",Si=Fi?i.aj(Rt.zoom):0,xi=Un(Li,li.getProjection(),Rt),Ai=Rt.calculatePixelsToTileUnitsMatrix(ni),Wi=Oe&&li.hasTextData(),Gr=li.hasIconTextFit()&&Wi&&li.hasIconData(),en=li.getProjection().createInversionMatrix(Rt,Li.canonical),kn=(1<<ni.tileID.canonical.z)*i.al/p.transform.worldSize,ur=yn=>{let mr=[0,0,0];if(yn){const nn=p.style.directionalLight,So=p.style.ambientLight;nn&&So&&(mr=_l(p.style,nn,So))}return mr},Kr=yn=>{Rt.depthOcclusionForSymbolsAndCircles&&(a.hasOcclusionOpacityProperties||p.terrain)&&(yn.push("DEPTH_D24"),yn.push("DEPTH_OCCLUSION"))},Pr=yn=>{a.lut&&!Ct&&(a.lut.texture||(a.lut.texture=new i.d_(p.context,a.lut.image,[a.lut.image.height,a.lut.image.height,a.lut.image.height],$t.gl.RGBA8)),$t.activeTexture.set($t.gl.TEXTURE0+Ss.LUT),a.lut.texture&&a.lut.texture.bind($t.gl.LINEAR,$t.gl.CLAMP_TO_EDGE),yn.push("APPLY_LUT_ON_GPU"))},Mn=()=>{const yn=Zt&&a.layout.get("symbol-placement")!=="point",mr=[];Kr(mr),Pr(mr);const nn=yn||Gr,So=li.elevationType==="road",Yo=p.shadowRenderer,Ro=So&&le&&!!Yo&&Yo.enabled,jo=ur(Ro),Io=So&&le&&!p.terrain?ge:oi,fa=a.paint.get("icon-image-cross-fade");p.terrainRenderModeElevated()&&le&&mr.push("PITCH_WITH_MAP_TERRAIN"),Fi&&(mr.push("PROJECTION_GLOBE_VIEW"),nn&&mr.push("PROJECTED_POS_ON_VIEWPORT")),fa>0&&li.hasAnySecondaryIcon&&mr.push("ICON_TRANSITION"),!li.icon.zOffsetVertexBuffer||So&&p.terrain||mr.push("Z_OFFSET"),lt===0&&_t===0&&Mt===0&&vt===1||mr.push("COLOR_ADJUSTMENT"),li.sdfIcons&&mr.push("RENDER_SDF"),Ro&&mr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),So&&le&&!p.terrain&&li.icon.orientationVertexBuffer&&mr.push("ELEVATED_ROADS");const Pa=li.icon.programConfigurations.get(a.id),Va=p.getOrCreateProgram("symbol",{config:Pa,defines:mr}),ic=ni.imageAtlasTexture?ni.imageAtlasTexture.size:[0,0],ma=li.iconSizeData,vc=i.bJ(ma,Rt.zoom),bc=le||!Rt.isOrthographic,qs=Jc(xi,ni.tileID.canonical,le,Zt,Rt,li.getProjection(),Ai),mo=Rl(xi,ni.tileID.canonical,le,Zt,Rt,li.getProjection(),Ai),Go=p.translatePosMatrix(mo,ni,M,N,!0),jn=p.translatePosMatrix(xi,ni,M,N),Qo=nn?_s:qs,Ls=Zt&&!le&&!yn;let go=si;!Te&&!Rt.mercatorFromTransition||Zt||(go=bl(Rt));const rc=Fi?go:si,Up=a.getColorAdjustmentMatrix(lt,_t,Mt,vt),Du=Su(ma.kind,vc,Ls,le,p,jn,Qo,Go,Ut,!1,ic,[0,0],0,Li,Si,ie,en,rc,li.getProjection(),jo,kn,Up,fa,null),jp=ni.imageAtlasTexture?ni.imageAtlasTexture:null,Gp=a.layout.get("icon-size").constantOr(0)!==1||li.iconsNeedLinear,wc=li.sdfIcons||p.options.rotating||p.options.zooming||Gp||bc?Ot.LINEAR:Ot.NEAREST,eu=li.sdfIcons&&a.paint.get("icon-halo-width").constantOr(1)!==0,Zs=p.terrain&&le&&yn?i.bk(i.bB(),qs):_s;if(yn&&li.icon){const Tc=i.bU.getAtTileOffsetFunc(Li,Rt.center.lat,Rt.worldSize,li.getProjection()),Xd=Kc(xi,ni.tileID.canonical,le,Zt,Rt,li.getProjection(),Ai),Sg=a.layout.get("icon-size-scale-range"),rm=i.aA(p.scaleFactor,Sg[0],Sg[1]);Xl(li,xi,p,!1,Xd,mo,le,rt,Tc,Li,rm)}return{program:Va,buffers:li.icon,uniformValues:Du,atlasTexture:jp,atlasTextureIcon:null,atlasInterpolation:wc,atlasInterpolationIcon:null,isSDF:li.sdfIcons,hasHalo:eu,depthMode:Io,tile:ni,renderWithShadows:Ro,labelPlaneMatrixInv:Zs}},Yr=()=>{const yn=pe&&a.layout.get("symbol-placement")!=="point",mr=[],nn=yn||Oe||Gr,So=li.elevationType==="road",Yo=p.shadowRenderer,Ro=So&&Me&&!!Yo&&Yo.enabled,jo=ur(Ro),Io=So&&Me&&!p.terrain?ge:oi;p.terrainRenderModeElevated()&&Me&&mr.push("PITCH_WITH_MAP_TERRAIN"),Fi&&(mr.push("PROJECTION_GLOBE_VIEW"),nn&&mr.push("PROJECTED_POS_ON_VIEWPORT")),!li.text.zOffsetVertexBuffer||So&&p.terrain||mr.push("Z_OFFSET"),li.iconsInText&&mr.push("RENDER_TEXT_AND_SYMBOL"),mr.push("RENDER_SDF"),Ro&&mr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),So&&Me&&!p.terrain&&li.text.orientationVertexBuffer&&mr.push("ELEVATED_ROADS"),Kr(mr);const fa=li.text.programConfigurations.get(a.id),Pa=p.getOrCreateProgram("symbol",{config:fa,defines:mr});let Va,ic=[0,0],ma=null;const vc=li.textSizeData;li.iconsInText&&(ic=ni.imageAtlasTexture?ni.imageAtlasTexture.size:[0,0],ma=ni.imageAtlasTexture?ni.imageAtlasTexture:null,Va=Me||!Rt.isOrthographic||p.options.rotating||p.options.zooming||vc.kind==="composite"||vc.kind==="camera"?Ot.LINEAR:Ot.NEAREST);const bc=ni.glyphAtlasTexture?ni.glyphAtlasTexture.size:[0,0],qs=a.layout.get("text-size-scale-range"),mo=i.aA(p.scaleFactor,qs[0],qs[1]),Go=i.bJ(vc,Rt.zoom,mo),jn=Jc(xi,ni.tileID.canonical,Me,pe,Rt,li.getProjection(),Ai),Qo=Rl(xi,ni.tileID.canonical,Me,pe,Rt,li.getProjection(),Ai),Ls=p.translatePosMatrix(Qo,ni,L,V,!0),go=p.translatePosMatrix(xi,ni,L,V),rc=nn?_s:jn,Up=pe&&!Me&&!yn;let Du=si;!Te&&!Rt.mercatorFromTransition||pe||(Du=bl(Rt));const jp=Su(vc.kind,Go,Up,Me,p,go,rc,Ls,Ut,!0,bc,ic,0,Li,Si,ie,en,Fi?Du:si,li.getProjection(),jo,kn,null,null,mo),Gp=ni.glyphAtlasTexture?ni.glyphAtlasTexture:null,wc=Ot.LINEAR,eu=a.paint.get("text-halo-width").constantOr(1)!==0,Zs=p.terrain&&Me&&yn?i.bk(i.bB(),jn):_s;if(yn&&li.text){const Tc=i.bU.getAtTileOffsetFunc(Li,Rt.center.lat,Rt.worldSize,li.getProjection()),Xd=Kc(xi,ni.tileID.canonical,Me,pe,Rt,li.getProjection(),Ai);Xl(li,xi,p,!0,Xd,Qo,Me,ht,Tc,Li,mo)}return{program:Pa,buffers:li.text,uniformValues:jp,atlasTexture:Gp,atlasTextureIcon:ma,atlasInterpolation:wc,atlasInterpolationIcon:Va,isSDF:!0,hasHalo:eu,depthMode:Io,tile:ni,renderWithShadows:Ro,labelPlaneMatrixInv:Zs}},Zn=li.icon.segments.get().length,an=li.text.segments.get().length,Mr=Zn&&!I.onlyText?Mn():null,_n=an&&!I.onlyIcons?Yr():null,Lr=a.paint.get("icon-opacity").constantOr(1),fo=a.paint.get("text-opacity").constantOr(1);if(ve&&li.canOverlap){Be=!0;const yn=Lr&&!I.onlyText?li.icon.segments.get():[],mr=fo&&!I.onlyIcons?li.text.segments.get():[];for(const nn of yn)qe.push({segments:new i.bf([nn]),sortKey:nn.sortKey,state:Mr});for(const nn of mr)qe.push({segments:new i.bf([nn]),sortKey:nn.sortKey,state:_n})}else I.onlyText||qe.push({segments:Lr?li.icon.segments:new i.bf([]),sortKey:0,state:Mr}),I.onlyIcons||qe.push({segments:fo?li.text.segments:new i.bf([]),sortKey:0,state:_n})}Be&&qe.sort((Li,ni)=>Li.sortKey-ni.sortKey);for(const Li of qe){const ni=Li.state;if(ni)if(p.terrain?p.terrain.setupElevationDraw(ni.tile,ni.program,{useDepthForOcclusion:Rt.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ni.labelPlaneMatrixInv}):p.setupDepthForOcclusion(Rt.depthOcclusionForSymbolsAndCircles,ni.program),$t.activeTexture.set(Ot.TEXTURE0),ni.atlasTexture&&ni.atlasTexture.bind(ni.atlasInterpolation,Ot.CLAMP_TO_EDGE,!0),ni.atlasTextureIcon&&($t.activeTexture.set(Ot.TEXTURE1),ni.atlasTextureIcon&&ni.atlasTextureIcon.bind(ni.atlasInterpolationIcon,Ot.CLAMP_TO_EDGE,!0)),ni.renderWithShadows&&p.shadowRenderer.setupShadows(ni.tile.tileID.toUnwrapped(),ni.program,"vector-tile"),p.uploadCommonLightUniforms(p.context,ni.program),ni.hasHalo){const li=ni.uniformValues;li.u_is_halo=1,Mp(ni.buffers,Li.segments,a,p,ni.program,ni.depthMode,y,w,li,2),li.u_is_halo=0}else{if(ni.isSDF){const li=ni.uniformValues;ni.hasHalo&&(li.u_is_halo=1,Mp(ni.buffers,Li.segments,a,p,ni.program,ni.depthMode,y,w,li,1)),li.u_is_halo=0}Mp(ni.buffers,Li.segments,a,p,ni.program,ni.depthMode,y,w,ni.uniformValues,1)}}}function Mp(p,e,a,f,y,w,I,M,L,N){const V=[p.dynamicLayoutVertexBuffer,p.opacityVertexBuffer,p.iconTransitioningVertexBuffer,p.globeExtVertexBuffer,p.zOffsetVertexBuffer,p.orientationVertexBuffer];y.draw(f,f.context.gl.TRIANGLES,w,I,M,rr.disabled,L,a.id,p.layoutVertexBuffer,p.indexBuffer,e,a.paint,f.transform.zoom,p.programConfigurations.get(a.id),V,N)}function cd(p,e){const a=1<<p.canonical.z,f=(e.x*a-p.canonical.x-p.wrap*a)*i.al,y=(e.y*a-p.canonical.y)*i.al,w=i.e7(e.z,e.y);return i.d4(f,y,w)}function po(p,e,a,f,y){if(!a.layout||a.layout.get("fill-elevation-reference")==="none"||a.paint.get("fill-opacity").constantOr(1)===0)return;const w=p.context.gl,I=new ki(p.context.gl.LEQUAL,ki.ReadWrite,p.depthRangeFor3D),M=new ki(p.context.gl.GREATER,ki.ReadWrite,p.depthRangeFor3D),L=function(X){let K=.01;return X.isOrthographic&&(K=i.ak(1e-4,K,i.c$(X.pitch>=Ch?1:X.pitch/Ch))),2*K}(p.transform),N=p.transform.getFreeCameraOptions().position,V="elevatedStructuresDepthReconstruct",Z=p.getOrCreateProgram(V,{defines:["DEPTH_RECONSTRUCTION"]}),U=p.getOrCreateProgram(V);for(const X of f){const K=e.getTile(X),rt=K.getBucket(a);if(!rt)continue;const ht=rt.elevatedStructures;if(!ht)continue;const lt=rt.elevationBufferData.heightRange,_t=cd(X.toUnwrapped(),N),Mt=p.translatePosMatrix(X.projMatrix,K,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor"));let vt,Ut,Ct,$t;if(y==="initialize"){if(!lt||lt.min>=1||ht.depthSegments.segments[0].primitiveLength===0)continue;vt=nd(Mt,_t,L,1,0),Ut=I,Ct=ht.depthSegments,$t=Z}else if(y==="reset"){if(!lt||lt.min>=0||ht.maskSegments.segments[0].primitiveLength===0)continue;vt=nd(Mt,_t,0,0,1),Ut=M,Ct=ht.maskSegments,$t=Z}else if(y==="geometry"){if(ht.depthSegments.segments[0].primitiveLength===0)continue;vt=nd(Mt,_t,L,1,0),Ut=I,Ct=ht.depthSegments,$t=U}$t.draw(p,w.TRIANGLES,Ut,hr.disabled,Sr.disabled,rr.disabled,vt,a.id,ht.vertexBuffer,ht.indexBuffer,Ct,a.paint,p.transform.zoom)}}function Ko(p,e,a){const{painter:f,sourceCache:y,layer:w,coords:I,colorMode:M,elevationType:L,terrainEnabled:N,pass:V}=p,Z=f.context.gl,U=w.paint.get("fill-pattern"),X=w.paint.get("fill-pattern-cross-fade"),K=U.constantOr(null);let rt=L;L!=="road"||e&&!N||(rt="none");const ht=rt==="road",lt=p.painter.shadowRenderer,_t=ht&&!!lt&&lt.enabled,Mt=new ki(f.context.gl.LEQUAL,ki.ReadOnly,f.depthRangeFor3D);let vt=[0,0,0];if(_t){const $t=f.style.directionalLight,Ot=f.style.ambientLight;$t&&Ot&&(vt=_l(f.style,$t,Ot))}const Ut=U&&U.constantOr(1),Ct=($t,Ot)=>{let Rt,Zt,pe,le,Me;Ot?(Rt=Ut&&!w.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",pe=Z.LINES):(Rt=Ut?"fillPattern":"fill",pe=Z.TRIANGLES);for(const ve of I){const Be=y.getTile(ve);if(Ut&&!Be.patternsLoaded())continue;const oi=Be.getBucket(w);if(!oi)continue;const ge=e?oi.elevationBufferData:oi.bufferData;if(ge.isEmpty())continue;f.prepareDrawTile();const ie=ge.programConfigurations.get(w.id),Oe=f.isTileAffectedByFog(ve),Te=[],qe=[];ht&&(Te.push("ELEVATED_ROADS"),qe.push(ge.elevatedLayoutVertexBuffer)),_t&&Te.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Ut&&(f.context.activeTexture.set(Z.TEXTURE0),Be.imageAtlasTexture&&Be.imageAtlasTexture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE),ie.updatePaintBuffers());let si=!1;if(K&&Be.imageAtlas){const Si=Be.imageAtlas,xi=i.e2.from(K),Ai=xi.getPrimary().scaleSelf(i.o.devicePixelRatio).toString(),Wi=xi.getSecondary(),Gr=Si.patternPositions.get(Ai),en=Wi?Si.patternPositions.get(Wi.scaleSelf(i.o.devicePixelRatio).toString()):null;si=!!Gr&&!!en,Gr&&ie.setConstantPatternPositions(Gr,en)}X>0&&(si||ie.getPatternTransitionVertexBuffer("fill-pattern"))&&Te.push("FILL_PATTERN_TRANSITION");const Li=f.getOrCreateProgram(Rt,{config:ie,overrideFog:Oe,defines:Te}),ni=f.translatePosMatrix(ve.projMatrix,Be,w.paint.get("fill-translate"),w.paint.get("fill-translate-anchor"));_t&&lt.setupShadows(Be.tileID.toUnwrapped(),Li,"vector-tile");const li=w.paint.get("fill-emissive-strength");if(Ot){le=ge.lineIndexBuffer,Me=ge.lineSegments;const Si=f.terrain&&f.terrain.renderingToTexture?f.terrain.drapeBufferSize:[Z.drawingBufferWidth,Z.drawingBufferHeight];Zt=Rt==="fillOutlinePattern"&&Ut?Ud(ni,li,f,Be,Si,vt,X):Yf(ni,li,Si,vt)}else le=ge.indexBuffer,Me=ge.triangleSegments,Zt=Ut?Ip(ni,li,f,Be,vt,X):bu(ni,li,vt);f.uploadCommonUniforms(f.context,Li,ve.toUnwrapped());let Fi=$t;(L==="road"&&!N||L==="offset")&&(Fi=Mt),Li.draw(f,pe,Fi,a||f.stencilModeForClipping(ve),M,rr.disabled,Zt,w.id,ge.layoutVertexBuffer,le,Me,w.paint,f.transform.zoom,ie,qe)}};f.renderPass===V&&Ct(f.depthModeForSublayer(1,f.renderPass==="opaque"?ki.ReadWrite:ki.ReadOnly),!1),rt==="none"&&f.renderPass==="translucent"&&w.paint.get("fill-antialias")&&Ct(f.depthModeForSublayer(w.getPaintProperty("fill-outline-color")?2:0,ki.ReadOnly),!0)}function Ei(p,e,a,f,y,w,I,M){a.resetLayerRenderingStats(p);const L=p.context,N=L.gl,V=p.transform,Z=a.paint.get("fill-extrusion-pattern"),U=a.paint.get("fill-extrusion-pattern-cross-fade"),X=Z.constantOr(null),K=Z.constantOr(1),rt=a.paint.get("fill-extrusion-opacity"),ht=p.style.enable3dLights(),lt=a.paint.get(ht&&!K?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),_t=[a.paint.get("fill-extrusion-ambient-occlusion-intensity"),lt],Mt=a.layout.get("fill-extrusion-edge-radius"),vt=Mt>0&&!a.paint.get("fill-extrusion-rounded-roof"),Ut=vt?0:Mt,Ct=V.projection.name==="globe"?i.ea():0,$t=V.projection.name==="globe",Ot=$t?i.aj(V.zoom):0,Rt=[i.aF(V.center.lng),i.aJ(V.center.lat)],Zt=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",pe=a.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(Zt?null:a.lut).toArray01().slice(0,3),le=a.paint.get("fill-extrusion-flood-light-intensity"),Me=a.paint.get("fill-extrusion-vertical-scale"),ve=a.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Be=a.paint.get("fill-extrusion-height-alignment"),oi=a.paint.get("fill-extrusion-base-alignment"),ge=ha(p,a.paint.get("fill-extrusion-cutoff-fade-range")),ie=[];let Oe;$t&&ie.push("PROJECTION_GLOBE_VIEW"),_t[0]>0&&ie.push("FAUX_AO"),vt&&ie.push("ZERO_ROOF_RADIUS"),M&&ie.push("HAS_CENTROID"),le>0&&ie.push("FLOOD_LIGHT"),ge.shouldRenderCutoff&&ie.push("RENDER_CUTOFF"),ve&&ie.push("RENDER_WALL_MODE");const Te=p.renderPass==="shadow",qe=p.shadowRenderer,si=Te&&!!qe,Li=Te?rr.disabled:rr.backCCW;p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!0);let ni=[0,0,0];if(qe){const Si=p.style.directionalLight,xi=p.style.ambientLight;Si&&xi&&(ni=_l(p.style,Si,xi)),Te||(ie.push("RENDER_SHADOWS","DEPTH_TEXTURE"),qe.useNormalOffset&&ie.push("NORMAL_OFFSET")),Oe=ie.concat(["SHADOWS_SINGLE_CASCADE"])}const li=si?"fillExtrusionDepth":K?"fillExtrusionPattern":"fillExtrusion",Fi=a.getLayerRenderingStats();for(const Si of f){const xi=e.getTile(Si),Ai=xi.getBucket(a);if(!Ai||Ai.projection.name!==V.projection.name)continue;let Wi=!1;qe&&(Wi=qe.getMaxCascadeForTile(Si.toUnwrapped())===0);const Gr=p.isTileAffectedByFog(Si),en=Ai.programConfigurations.get(a.id);let kn=!1;if(X&&xi.imageAtlas){const an=xi.imageAtlas,Mr=i.e2.from(X),_n=Mr.getPrimary().scaleSelf(i.o.devicePixelRatio).toString(),Lr=Mr.getSecondary(),fo=an.patternPositions.get(_n),yn=Lr?an.patternPositions.get(Lr.scaleSelf(i.o.devicePixelRatio).toString()):null;kn=!!fo&&!!yn,fo&&en.setConstantPatternPositions(fo,yn)}U>0&&(kn||en.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&ie.push("FILL_EXTRUSION_PATTERN_TRANSITION");const ur=p.getOrCreateProgram(li,{config:en,defines:Wi?Oe:ie,overrideFog:Gr});if(p.terrain&&p.terrain.setupElevationDraw(xi,ur,{useMeterToDem:!0}),!Ai.centroidVertexBuffer){const an=ur.getAttributeLocation(N,"a_centroid_pos");an!==-1&&N.vertexAttrib2f(an,0,0)}!Te&&qe&&qe.setupShadows(xi.tileID.toUnwrapped(),ur,"vector-tile"),K&&(p.context.activeTexture.set(N.TEXTURE0),xi.imageAtlasTexture&&xi.imageAtlasTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),en.updatePaintBuffers());const Kr=a.paint.get("fill-extrusion-vertical-gradient"),Pr=1/Ai.tileToMeter;let Mn;if(Te&&qe){if(hd(xi.tileID,Ai.maxHeight,p))continue;const an=qe.calculateShadowPassMatrixFromTile(xi.tileID.toUnwrapped());Mn=rd(an,Ut,Pr,Me,Be,oi)}else{const an=p.translatePosMatrix(Si.expandedProjMatrix,xi,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Mr=V.projection.createInversionMatrix(V,Si.canonical);Mn=K?Kl(an,p,Kr,rt,_t,Ut,Pr,Si,xi,Ct,Be,oi,Ot,Rt,Mr,pe,Me,U):vu(an,p,Kr,rt,_t,Ut,Pr,Si,Ct,Be,oi,Ot,Rt,Mr,pe,Me,le,ni)}p.uploadCommonUniforms(L,ur,Si.toUnwrapped(),null,ge);let Yr=Ai.segments;if(V.projection.name==="mercator"&&!Te&&(Yr=Ai.getVisibleSegments(xi.tileID,p.terrain,p.transform.getFrustum(0)),!Yr.get().length))continue;if(Fi)if(Te)for(const an of Yr.get())Fi.numRenderedVerticesInShadowPass+=an.primitiveLength;else for(const an of Yr.get())Fi.numRenderedVerticesInTransparentPass+=an.primitiveLength;const Zn=[];(p.terrain||M)&&Zn.push(Ai.centroidVertexBuffer),$t&&Zn.push(Ai.layoutVertexExtBuffer),ve&&Zn.push(Ai.wallVertexBuffer),ur.draw(p,L.gl.TRIANGLES,y,w,I,Li,Mn,a.id,Ai.layoutVertexBuffer,Ai.indexBuffer,Yr,a.paint,p.transform.zoom,en,Zn)}p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!1)}class Iu{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function Bl(p,e,a,f,y,w,I,M,L,N,V,Z,U,X,K,rt,ht,lt,_t,Mt){const vt=e.context,Ut=vt.gl,Ct=e.transform,$t=e.transform.zoom,Ot=[],Rt=p.translate,Zt=p.translateAnchor,pe=p.edgeRadius,le=ha(e,p.cutoffFadeRange);V==="clear"?(Ot.push("CLEAR_SUBPASS"),Mt&&(Ot.push("CLEAR_FROM_TEXTURE"),vt.activeTexture.set(Ut.TEXTURE0),Mt.bind(Ut.LINEAR,Ut.CLAMP_TO_EDGE))):V==="sdf"&&Ot.push("SDF_SUBPASS"),lt&&Ot.push("HAS_CENTROID"),le.shouldRenderCutoff&&Ot.push("RENDER_CUTOFF");const Me=(ve,Be,oi,ge,ie)=>{let Oe=Ot;Be.groundRadiusBuffer!=null&&(Oe=Ot.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const Te=Be.programConfigurations.get(f.id),qe=e.isTileAffectedByFog(ve),si=e.getOrCreateProgram("fillExtrusionGroundEffect",{config:Te,defines:Oe,overrideFog:qe}),Li=ir(e,ge,Z,N,ie,[U,X*ie],K,rt,ht,$t>=17?0:pe*ie,Mt?Mt.size[0]:0),ni=[];lt&&ni.push(Be.hiddenByLandmarkVertexBuffer),Be.groundRadiusBuffer!=null&&ni.push(Be.groundRadiusBuffer),e.uploadCommonUniforms(vt,si,ve.toUnwrapped(),null,le),si.draw(e,vt.gl.TRIANGLES,w,I,M,L,Li,f.id,Be.vertexBuffer,Be.indexBuffer,oi,f.paint,$t,Te,ni)};for(const ve of y){const Be=a.getTile(ve),oi=Be.getBucket(f);if(!oi||oi.projection.name!==Ct.projection.name||!oi.groundEffect||oi.groundEffect&&!oi.groundEffect.hasData())continue;const ge=oi.groundEffect,ie=1/oi.tileToMeter;{const Oe=e.translatePosMatrix(ve.projMatrix,Be,Rt,Zt),Te=ge.getDefaultSegment();Me(ve,ge,Te,Oe,ie)}if(_t)for(let Oe=0;Oe<4;Oe++){const Te=i.e8[Oe](ve),qe=a.getTile(Te);if(!qe)continue;const si=qe.getBucket(f);if(!si||si.projection.name!==Ct.projection.name||!si.groundEffect||si.groundEffect&&!si.groundEffect.hasData())continue;const Li=si.groundEffect;let ni,li;Oe===0?(ni=[-i.al,0,0],li=1):Oe===1?(ni=[i.al,0,0],li=0):Oe===2?(ni=[0,-i.al,0],li=3):(ni=[0,i.al,0],li=2);const Fi=Li.regionSegments[li];if(!Fi)continue;const Si=new Float32Array(16);i.bq(Si,ve.projMatrix,ni),Me(ve,Li,Fi,e.translatePosMatrix(Si,Be,Rt,Zt),ie)}}}function Gc(p,e,a,f,y,w,I){f.centroidVertexArray.length===0&&f.createCentroidsBuffer();const M=w?w.findDEMTileFor(a):null;if(!(M&&M.dem||I))return;w&&M&&M.dem&&f.selfDEMTileTimestamp!==M.dem._timestamp&&(f.borderDoneWithNeighborZ=[-1,-1,-1,-1],f.selfDEMTileTimestamp=M.dem._timestamp);const L=lt=>new i.P(Math.ceil((lt+i.ec)*i.ed),0),N=lt=>{const _t=e.getSource().minzoom,Mt=Ut=>{const Ct=e.getTileByID(Ut);if(Ct&&Ct.hasData())return Ct.getBucket(y)},vt=[0,-1,1];for(const Ut of vt){if(lt.overscaledZ+Ut<_t)continue;const Ct=Mt(lt.calculateScaledKey(lt.overscaledZ+Ut));if(Ct)return Ct}},V=[0,0,0],Z=(lt,_t)=>(V[0]=Math.min(lt.min.y,_t.min.y),V[1]=Math.max(lt.max.y,_t.max.y),V[2]=i.al-_t.min.x>lt.max.x?_t.min.x-i.al:lt.max.x,V),U=(lt,_t)=>(V[0]=Math.min(lt.min.x,_t.min.x),V[1]=Math.max(lt.max.x,_t.max.x),V[2]=i.al-_t.min.y>lt.max.y?_t.min.y-i.al:lt.max.y,V),X=[(lt,_t)=>Z(lt,_t),(lt,_t)=>Z(_t,lt),(lt,_t)=>U(lt,_t),(lt,_t)=>U(_t,lt)],K=(lt,_t,Mt,vt,Ut,Ct,$t)=>{if(!w)return 0;const Ot=[[Ct?Mt:lt,Ct?lt:Mt,0],[Ct?Mt:_t,Ct?_t:Mt,0]],Rt=$t<0?i.al+$t:$t,Zt=[Ct?Rt:(lt+_t)/2,Ct?(lt+_t)/2:Rt,0];return Mt===0&&$t<0||Mt!==0&&$t>0?w.getForTilePoints(Ut,[Zt],!0,vt):Ot.push(Zt),w.getForTilePoints(a,Ot,!0,M),Math.max(Ot[0][2],Ot[1][2],Zt[2])/w.exaggeration()};for(let lt=0;lt<4;lt++){const _t=f.borderFeatureIndices[lt];if(_t.length===0)continue;const Mt=i.e8[lt](a),vt=N(Mt);if(!(vt&&vt instanceof i.e9))continue;const Ut=w?w.findDEMTileFor(Mt):null;if(!(Ut&&Ut.dem||I)||(w&&Ut&&Ut.dem&&f.borderDEMTileTimestamp[lt]!==Ut.dem._timestamp&&(f.borderDoneWithNeighborZ[lt]=-1,f.borderDEMTileTimestamp[lt]=Ut.dem._timestamp),f.borderDoneWithNeighborZ[lt]===vt.canonical.z))continue;vt.centroidVertexArray.length===0&&vt.createCentroidsBuffer();const Ct=(lt<2?1:5)-lt,$t=vt.borderDoneWithNeighborZ[Ct]!==f.canonical.z,Ot=vt.borderFeatureIndices[Ct];let Rt=0;if(f.canonical.z!==vt.canonical.z){for(const Zt of _t)f.showCentroid(f.featuresOnBorder[Zt]);if($t)for(const Zt of Ot)vt.showCentroid(vt.featuresOnBorder[Zt]);f.borderDoneWithNeighborZ[lt]=vt.canonical.z,vt.borderDoneWithNeighborZ[Ct]=f.canonical.z}for(const Zt of _t){const pe=f.featuresOnBorder[Zt],le=f.centroidData[pe.centroidDataIndex],Me=pe.borders[lt];let ve;for(;Rt<Ot.length;){ve=vt.featuresOnBorder[Ot[Rt]];const Be=ve.borders[Ct];if(Be[1]>Me[0]+3||Be[0]>Me[0]-3)break;vt.showCentroid(ve),Rt++}if(ve&&Rt<Ot.length){const Be=Rt;let oi=0;for(;!(ve.borders[Ct][0]>Me[1]-3)&&(oi++,++Rt!==Ot.length);)ve=vt.featuresOnBorder[Ot[Rt]];ve=vt.featuresOnBorder[Ot[Be]];let ge=!1;if(oi>=1){const Te=ve.borders[Ct];Math.abs(Me[0]-Te[0])<3&&Math.abs(Me[1]-Te[1])<3&&(oi=1,ge=!0,Rt=Be+1)}else if(oi===0){f.showCentroid(pe);continue}const ie=vt.centroidData[ve.centroidDataIndex];I&&ge&&(((rt=le).flags|(ht=ie).flags)&i.eb?(rt.flags|=i.eb,ht.flags|=i.eb):(rt.flags&=~i.eb,ht.flags&=~i.eb));const Oe=pe.intersectsCount()>1||ve.intersectsCount()>1;if(oi>1)Rt=Be,le.centroidXY=ie.centroidXY=new i.P(0,0);else if(Ut&&Ut.dem&&!Oe){const Te=X[lt](le,ie),qe=lt%2?i.al-1:0,si=K(Te[0],Math.min(i.al-1,Te[1]),qe,Ut,Mt,lt<2,Te[2]);le.centroidXY=ie.centroidXY=L(si)}else Oe?le.centroidXY=ie.centroidXY=new i.P(0,0):(le.centroidXY=f.encodeBorderCentroid(pe),ie.centroidXY=vt.encodeBorderCentroid(ve));f.writeCentroidToBuffer(le),vt.writeCentroidToBuffer(ie)}else f.showCentroid(pe)}f.borderDoneWithNeighborZ[lt]=vt.canonical.z,vt.borderDoneWithNeighborZ[Ct]=f.canonical.z}var rt,ht;(f.needsCentroidUpdate||!f.centroidVertexBuffer&&f.centroidVertexArray.length!==0)&&f.uploadCentroid(p)}const $c=[1,0,0],Zi=[0,1,0],Yh=[0,0,1];function hd(p,e,a){const f=a.transform,y=a.shadowRenderer;if(!y)return!0;const w=p.toUnwrapped(),I=f.tileSize*y._cascades[a.currentShadowCascade].scale;let M=e;if(f.elevation){const rt=f.elevation.getMinMaxForTile(p);rt&&(M+=rt.max)}const L=[...y.shadowDirection];L[2]=-L[2];const N=y.computeSimplifiedTileShadowVolume(w,M,I,L);if(!N)return!1;const V=[$c,Zi,Yh,L,[L[0],0,L[2]],[0,L[1],L[2]]],Z=f.projection.name==="globe",U=f.scaleZoom(I),X=i.cA.fromInvProjectionMatrix(f.invProjMatrix,f.worldSize,U,!Z),K=y.getCurrentCascadeFrustum();return X.intersectsPrecise(N.vertices,N.planes,V)===0||K.intersectsPrecise(N.vertices,N.planes,V)===0}function Eu(p){const{painter:e,source:a,layer:f,coords:y}=p;let w=p.defines;const I=e.context,M=e.renderPass==="shadow",L=e.renderPass==="light-beam",N=e.shadowRenderer,V=i.ee(e.transform.center.lat,e.transform.zoom),Z=ha(e,f.paint.get("building-cutoff-fade-range"));Z.shouldRenderCutoff&&(w=w.concat("RENDER_CUTOFF")),p.floodLightIntensity>0&&(w=w.concat("FLOOD_LIGHT"));for(const U of y){const X=a.getTile(U),K=X.getBucket(f);if(!K)continue;N&&N.getMaxCascadeForTile(U.toUnwrapped())===0&&(w=w.concat("SHADOWS_SINGLE_CASCADE"));const rt=K.programConfigurations.get(f.id);let ht,lt,_t,Mt=e.translatePosMatrix(U.expandedProjMatrix,X,[0,0],"map");if(Mt=i.cR(i.bB(),Mt,[1,1,p.verticalScale]),M&&N){if(hd(X.tileID,K.maxHeight*V,e))continue;let Ut=N.calculateShadowPassMatrixFromTile(X.tileID.toUnwrapped());Ut=i.cR(i.bB(),Ut,[1,1,p.verticalScale]),_t=_f(Ut),ht=lt=e.getOrCreateProgram("buildingDepth",{config:rt,defines:w,overrideFog:!1})}else if(L)ht=lt=e.getOrCreateProgram("buildingBloom",{config:rt,defines:w,overrideFog:!1}),_t=qh(Mt);else{const Ut=e.transform.calculatePosMatrix(U.toUnwrapped(),e.transform.worldSize);i.cR(Ut,Ut,[1,1,p.verticalScale]);const Ct=i.bB();i.cR(Ct,Ut,[1,-1,1/V]),i.bk(Ct,Ct),i.ef(Ct,Ct);const $t=e.transform.getFreeCameraOptions().position,Ot=1<<U.canonical.z;if(_t=gf(Mt,Ct,p.opacity,p.facadeAOIntensity,[(($t.x-U.wrap)*Ot-U.canonical.x)*i.al,($t.y*Ot-U.canonical.y)*i.al,$t.z*Ot*i.al],K.tileToMeter,p.facadeEmissiveChance,p.floodLightColor,p.floodLightIntensity),lt=e.getOrCreateProgram("building",{config:rt,defines:w,overrideFog:!1}),p.depthOnly===!0)ht=lt;else{const Rt=w.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);ht=e.getOrCreateProgram("building",{config:rt,defines:Rt,overrideFog:!1})}N&&(N.setupShadowsFromMatrix(Ut,lt,!0),ht!==lt&&N.setupShadowsFromMatrix(Ut,ht,!0))}const vt=(Ut,Ct)=>{if(L){const $t=Ut.entranceBloom;Ct.draw(e,I.gl.TRIANGLES,p.depthMode,hr.disabled,p.blendMode,rr.disabled,_t,f.id,$t.layoutVertexBuffer,$t.indexBuffer,$t.segmentsBucket,f.paint,e.transform.zoom,rt,[$t.layoutAttenuationBuffer,$t.layoutColorBuffer])}else{const $t=Ut.segmentsBucket;let Ot=[Ut.layoutNormalBuffer,Ut.layoutCentroidBuffer,Ut.layoutColorBuffer,Ut.layoutFloodLightDataBuffer];Ut.layoutFacadePaintBuffer&&(Ot=Ot.concat([Ut.layoutFacadeDataBuffer,Ut.layoutFacadeVerticalRangeBuffer,Ut.layoutFacadePaintBuffer])),Ct.draw(e,I.gl.TRIANGLES,p.depthMode,hr.disabled,p.blendMode,M?rr.disabled:rr.backCW,_t,f.id,Ut.layoutVertexBuffer,Ut.indexBuffer,$t,f.paint,e.transform.zoom,rt,Ot)}};e.uploadCommonUniforms(I,lt,U.toUnwrapped(),null,Z),K.buildingWithoutFacade&&vt(K.buildingWithoutFacade,lt),K.buildingWithFacade&&(ht!==lt&&e.uploadCommonUniforms(I,ht,U.toUnwrapped(),null,Z),vt(K.buildingWithFacade,ht))}}function Jh(p,e,a,f,y,w,I,M,L,N,V,Z,U){const X=p.context.gl,K=p.depthModeForSublayer(1,ki.ReadOnly,X.LEQUAL,!0),rt=.1*(1-(ht=V))+3*ht;var ht;const lt=p._showOverdrawInspector,_t=Z,Mt=new Iu;lt||Bl(Mt,p,e,a,f,K,new hr({func:X.ALWAYS,mask:255},255,255,X.KEEP,X.KEEP,X.REPLACE),new Sr([X.ONE,X.ONE,X.ONE,X.ONE],i.ao.transparent,[!1,!1,!1,!0],X.MIN),rr.disabled,y,"sdf",w,I,M,L,N,rt,_t,!1);{const vt=lt?hr.disabled:new hr({func:X.EQUAL,mask:255},255,255,X.KEEP,X.DECR,X.DECR),Ut=lt?p.colorModeForRenderPass():new Sr([X.ONE_MINUS_DST_ALPHA,X.DST_ALPHA,X.ONE,X.ONE],i.ao.transparent,[!0,!0,!0,!0]);Bl(Mt,p,e,a,f,K,vt,Ut,rr.disabled,y,"color",w,I,M,L,N,rt,_t,!1)}}function qd(p){return[p[0]*i.eg,p[1]*i.eg,p[2]*i.eg,0]}function Kh(p,e,a,f,y,w,I,M,L){const N=f.getSource(),V=a.globeSharedBuffers;if(!V)return;let Z,U,X;if(e&&(Z=f.getTile(e)),N instanceof i.aT?(U=N.texture,X=i.dJ(0,0,a.transform)):Z&&e&&(U=Z.texture,X=i.dJ(e.canonical.z,e.canonical.x,a.transform)),!U||!X)return;p||(X=i.cR(i.bB(),X,[1,-1,1]));const K=a.context,rt=K.gl,ht=y.paint.get("raster-resampling")==="nearest"?rt.NEAREST:rt.LINEAR,lt=a.colorModeForDrapableLayerRenderPass(w),_t=I.defines;_t.push("GLOBE_POLES");const Mt=new ki(rt.LEQUAL,ki.ReadWrite,a.depthRangeFor3D),vt=Float32Array.from(a.transform.expandedFarZProjMatrix),Ut=Float32Array.from(i.bj(i.dI(new i.cC(0,0,0))));a.terrain&&a.terrain.prepareDrawTile(),K.activeTexture.set(rt.TEXTURE0),U.bind(ht,rt.CLAMP_TO_EDGE),K.activeTexture.set(rt.TEXTURE1),U.bind(ht,rt.CLAMP_TO_EDGE),"useMipmap"in U&&K.extTextureFilterAnisotropic&&a.transform.pitch>20&&rt.texParameterf(rt.TEXTURE_2D,K.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,K.extTextureFilterAnisotropicMax);const[Ct,$t,Ot,Rt]=e?V.getPoleBuffers(e.canonical.z,!1):V.getPoleBuffers(0,!0),Zt=y.paint.get("raster-elevation");let pe;p?(pe=Ct,a.renderDefaultNorthPole=Zt!==0):(pe=$t,a.renderDefaultSouthPole=Zt!==0);const le=qd(I.mix),Me=((Be,oi,ge,ie,Oe,Te,qe,si,Li,ni,li,Fi,Si)=>wu(Be,oi,ge,new Float32Array(16),new Float32Array(9),[0,0],ie,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Te,[0,0],si,2,ni,li,Fi,1,0,Si))(vt,Ut,X,i.aj(a.transform.zoom),0,y,0,Zt,0,le,I.offset,I.range,w),ve=a.getOrCreateProgram("raster",{defines:_t});a.uploadCommonUniforms(K,ve,null),ve.draw(a,rt.TRIANGLES,Mt,L,lt,M,Me,y.id,pe,Ot,Rt)}function Qh(p){const e=p._nearZ,a=p.projection.farthestPixelDistance(p),f=a-e,y=.2*p.height,w=e+y;return[e,a,(w-y-e)/f,(w-e)/f]}function vf(p,e,a,f){if(p)return e instanceof hs&&p instanceof ms?e.getTextureDescriptor(p,a,!0):{texture:p.texture,mix:qd(f.mix),offset:f.offset,buffer:0,tileSize:1}}var Cp=i.eh([{name:"a_index",type:"Int16",components:1}]);class Gs{constructor(e,a,f,y){const w={width:f[0],height:f[1],data:null},I=e.gl;this.targetColorTexture=new i.T(e,w,I.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new i.T(e,w,I.RGBA8,{useMipmap:!1}),this.context=e,this.updateParticleTexture(a,y),this.lastInvalidatedAt=0}updateParticleTexture(e,a){if(this.particleTextureDimension===a.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const f=this.context.gl,y=a.width*a.height;this.particleTexture0=new i.T(this.context,a,f.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new i.T(this.context,a,f.RGBA8,{premultiply:!1,useMipmap:!1});const w=new i.ei;w.reserve(y);for(let I=0;I<y;I++)w.emplaceBack(I);this.particleIndexBuffer=this.context.createVertexBuffer(w,Cp.members,!0),this.particleSegment=i.bf.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=a.width}update(e){return!(this.lastInvalidatedAt<e&&(this.lastInvalidatedAt=i.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function ud(p,e,a){if(!p)return null;const f=e.getTextureDescriptor(p,a,!0);if(!f)return null;let{texture:y,mix:w,offset:I,tileSize:M,buffer:L,format:N}=f;if(!y||!N)return null;let V=!1;return N==="uint32"&&(V=!0,w[3]=0,w=jd(i.ej,w,[0,a.paint.get("raster-particle-max-speed")]),I=fc(i.ej,I,[0,a.paint.get("raster-particle-max-speed")])),{texture:y,textureOffset:[L/(M+2*L),M/(M+2*L)],tileSize:M,scalarData:V,scale:w,offset:I,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[N]]}}function pa(p){const e=p._nearZ,a=p.projection.farthestPixelDistance(p),f=a-e,y=.2*p.height,w=e+y;return[e,a,(w-y-e)/f,(w-e)/f]}const gc=new i.ao(1,0,0,1),Zd=new i.ao(0,1,0,1),C=new i.ao(0,0,1,1),s=new i.ao(1,0,1,1),d=new i.ao(0,1,1,1);function v(p,e,a,f,y,w){for(let I=0;I<a.length;I++)if(y){const N=new i.ao(f.r*.8,f.g*.8,f.b*.8,1);S(p,e,a[I],f,-1,-1,w),S(p,e,a[I],f,-1,1,w),S(p,e,a[I],f,1,1,w),S(p,e,a[I],f,1,-1,w),S(p,e,a[I],N,0,0,w)}else S(p,e,a[I],f,0,0,w)}function S(p,e,a,f,y,w,I){const M=p.context,L=p.transform,N=M.gl,V=L.projection.name==="globe",Z=V?["PROJECTION_GLOBE_VIEW"]:[];let U=i.by(a.projMatrix);if(V&&i.aj(L.zoom)>0){const le=i.bi(a.canonical,L),Me=i.ek(le);U=i.aB(new Float32Array(16),L.globeMatrix,Me),i.aB(U,L.projMatrix,U)}const X=i.bB();X[12]+=2*y/(i.o.devicePixelRatio*L.width),X[13]+=2*w/(i.o.devicePixelRatio*L.height),i.aB(U,X,U);const K=p.getOrCreateProgram("debug",{defines:Z}),rt=e.getTileByID(a.key);p.terrain&&p.terrain.setupElevationDraw(rt,K);const ht=ki.disabled,lt=hr.disabled,_t=p.colorModeForRenderPass(),Mt="$debug";M.activeTexture.set(N.TEXTURE0),p.emptyTexture.bind(N.LINEAR,N.CLAMP_TO_EDGE),V?rt._makeGlobeTileDebugBuffers(p.context,L):rt._makeDebugTileBoundsBuffers(p.context,L.projection);const vt=rt._tileDebugBuffer||p.debugBuffer,Ut=rt._tileDebugIndexBuffer||p.debugIndexBuffer,Ct=rt._tileDebugSegments||p.debugSegments;if(K.draw(p,N.LINE_STRIP,ht,lt,_t,rr.disabled,od(U,f.toPremultipliedRenderColor(null)),Mt,vt,Ut,Ct,null,null,null,[rt._globeTileDebugBorderBuffer]),I){const le=rt.latestRawTileData,Me=Math.floor((le&&le.byteLength||0)/1024);let ve=a.canonical.toString();a.overscaledZ!==a.canonical.z&&(ve+=` => ${a.overscaledZ}`),ve+=` ${rt.state}`,ve+=` ${Me}kb`,function(Be,oi){Be.initDebugOverlayCanvas();const ge=Be.debugOverlayCanvas,ie=Be.context.gl,Oe=Be.debugOverlayCanvas.getContext("2d");Oe.clearRect(0,0,ge.width,ge.height),Oe.shadowColor="white",Oe.shadowBlur=2,Oe.lineWidth=1.5,Oe.strokeStyle="white",Oe.textBaseline="top",Oe.font="bold 36px Open Sans, sans-serif",Oe.fillText(oi,5,5),Oe.strokeText(oi,5,5),Be.debugOverlayTexture.update(ge),Be.debugOverlayTexture.bind(ie.LINEAR,ie.CLAMP_TO_EDGE)}(p,ve)}const $t=e.getTile(a).tileSize,Ot=512/Math.min($t,512)*(a.overscaledZ/L.zoom)*.5,Rt=rt._tileDebugTextBuffer||p.debugBuffer,Zt=rt._tileDebugTextIndexBuffer||p.quadTriangleIndexBuffer,pe=rt._tileDebugTextSegments||p.debugSegments;K.draw(p,N.TRIANGLES,ht,lt,Sr.alphaBlended,rr.disabled,od(U,i.ao.transparent.toPremultipliedRenderColor(null),Ot),Mt,Rt,Zt,pe,null,null,null,[rt._globeTileDebugTextBuffer])}function D(p,e,a,f){j(p,0,e+a/2,p.transform.width,a,f)}function k(p,e,a,f){j(p,e-a/2,0,a,p.transform.height,f)}function j(p,e,a,f,y,w){const I=p.context,M=I.gl;M.enable(M.SCISSOR_TEST),M.scissor(e*i.o.devicePixelRatio,a*i.o.devicePixelRatio,f*i.o.devicePixelRatio,y*i.o.devicePixelRatio),I.clear({color:w}),M.disable(M.SCISSOR_TEST)}const H=i.eh([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:J}=H;function et(p,e,a,f){p.emplaceBack(e,a,f)}class mt{constructor(e){this.vertexArray=new i.el,this.indices=new i.b0,et(this.vertexArray,-1,-1,1),et(this.vertexArray,1,-1,1),et(this.vertexArray,-1,1,1),et(this.vertexArray,1,1,1),et(this.vertexArray,-1,-1,-1),et(this.vertexArray,1,-1,-1),et(this.vertexArray,-1,1,-1),et(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=e.createVertexBuffer(this.vertexArray,J),this.indexBuffer=e.createIndexBuffer(this.indices),this.segment=i.bf.simpleSegment(0,0,36,12)}}function dt(p,e,a,f,y,w){const I=p.context.gl,M=e.paint.get("sky-atmosphere-color"),L=e.paint.get("sky-atmosphere-halo-color"),N=e.paint.get("sky-atmosphere-sun-intensity"),V=((Z,U,X,K,rt)=>({u_matrix_3f:Z,u_sun_direction:U,u_sun_intensity:X,u_color_tint_r:[K.r,K.g,K.b,K.a],u_color_tint_m:[rt.r,rt.g,rt.b,rt.a],u_luminance:5e-5}))(i.en(i.dN(),f),y,N,M.toPremultipliedRenderColor(null),L.toPremultipliedRenderColor(null));I.framebufferTexture2D(I.FRAMEBUFFER,I.COLOR_ATTACHMENT0,I.TEXTURE_CUBE_MAP_POSITIVE_X+w,e.skyboxTexture,0),a.draw(p,I.TRIANGLES,ki.disabled,hr.disabled,Sr.unblended,rr.frontCW,V,"skyboxCapture",e.skyboxGeometry.vertexBuffer,e.skyboxGeometry.indexBuffer,e.skyboxGeometry.segment)}const Tt=i.eh([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class pt{constructor(e){const a=new i.eo;a.emplaceBack(-1,1,1,0,0),a.emplaceBack(1,1,1,1,0),a.emplaceBack(1,-1,1,1,1),a.emplaceBack(-1,-1,1,0,1);const f=new i.b0;f.emplaceBack(0,1,2),f.emplaceBack(2,3,0),this.vertexBuffer=e.createVertexBuffer(a,Tt.members),this.indexBuffer=e.createIndexBuffer(f),this.segments=i.bf.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const It=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Kt{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Wt{constructor(e){this.colorModeAlphaBlendedWriteRGB=new Sr([1,Fo,1,Fo],i.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Sr([1,0,1,0],i.ao.transparent,[!1,!1,!1,!0]),this.params=new Kt,this.updateNeeded=!0,e.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),e.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),e.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),e.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(e){const a=e.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new pt(a);const f=this.params.sizeRange,y=this.params.intensityRange,w=function(V){const Z=i.eq(30),U=[];for(let X=0;X<V;++X){const K=2*Math.PI*Z(),rt=Math.acos(1-2*Z())-.5*Math.PI;U.push(i.d4(Math.cos(rt)*Math.cos(K),Math.cos(rt)*Math.sin(K),Math.sin(rt)))}return U}(this.params.starsCount),I=i.eq(300),M=new i.ep,L=new i.b0;let N=0;for(let V=0;V<w.length;++V){const Z=i.c4([],w[V],200),U=Math.max(0,1+.01*f*(1*I()-.5)),X=Math.max(0,1+.01*y*(1*I()-.5));M.emplaceBack(Z[0],Z[1],Z[2],-1,-1,U,X),M.emplaceBack(Z[0],Z[1],Z[2],1,-1,U,X),M.emplaceBack(Z[0],Z[1],Z[2],1,1,U,X),M.emplaceBack(Z[0],Z[1],Z[2],-1,1,U,X),L.emplaceBack(N+0,N+1,N+2),L.emplaceBack(N+0,N+2,N+3),N+=4}this.starsVx=a.createVertexBuffer(M,It.members),this.starsIdx=a.createIndexBuffer(L),this.starsSegments=i.bf.simpleSegment(0,0,M.length,L.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(e,a){const f=e.context,y=f.gl,w=e.transform,I=new ki(y.LEQUAL,ki.ReadOnly,[0,1]),M=i.aj(w.zoom),L=e.style.getLut(a.scope),N=a.properties.get("color-use-theme")==="none",V=a.properties.get("color").toNonPremultipliedRenderColor(N?null:L),Z=a.properties.get("high-color-use-theme")==="none",U=a.properties.get("high-color").toNonPremultipliedRenderColor(Z?null:L),X=a.properties.get("space-color-use-theme")==="none",K=a.properties.get("space-color").toNonPremultipliedRenderColor(X?null:L),rt=5e-4,ht=i.er(a.properties.get("horizon-blend"),0,1,rt,.25),lt=i.dD(e,f,w)&&ht===rt?w.worldSize/(2*Math.PI*1.025)-1:w.globeRadius,_t=e.frameCounter/1e3%1,Mt=i.ag(w.globeCenterInViewSpace),vt=Math.sqrt(Math.pow(Mt,2)-Math.pow(lt,2)),Ut=Math.acos(vt/Mt),Ct=$t=>{const Ot=w.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];$t&&Ot.push("ALPHA_PASS");const Rt=e.getOrCreateProgram("globeAtmosphere",{defines:Ot}),Zt=((le,Me,ve,Be,oi,ge,ie,Oe,Te,qe,si,Li)=>({u_frustum_tl:le,u_frustum_tr:Me,u_frustum_br:ve,u_frustum_bl:Be,u_horizon:oi,u_transition:ge,u_fadeout_range:ie,u_atmosphere_fog_color:Oe.toArray01(),u_high_color:Te.toArray01(),u_space_color:qe.toArray01(),u_temporal_offset:si,u_horizon_angle:Li}))(w.frustumCorners.TL,w.frustumCorners.TR,w.frustumCorners.BR,w.frustumCorners.BL,w.frustumCorners.horizon,M,ht,V,U,K,_t,Ut);e.uploadCommonUniforms(f,Rt);const pe=this.atmosphereBuffer;pe&&Rt.draw(e,y.TRIANGLES,I,hr.disabled,$t?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,rr.backCW,Zt,$t?"atmosphere_glow_alpha":"atmosphere_glow",pe.vertexBuffer,pe.indexBuffer,pe.segments)};Ct(!1),Ct(!0)}drawStars(e,a){const f=i.aA(a.properties.get("star-intensity"),0,1);if(f===0)return;const y=e.context,w=y.gl,I=e.transform,M=e.getOrCreateProgram("stars"),L=i.c6([]);i.c8(L,L,-I._pitch),i.c7(L,L,-I.angle),i.c8(L,L,i.an(I._center.lat)),i.es(L,L,-i.an(I._center.lng));const N=i.cb(new Float32Array(16),L),V=i.aB([],I.starsProjMatrix,N),Z=i.en([],N),U=i.et([],Z),X=[0,1,0];i.dP(X,X,U),i.c4(X,X,this.params.sizeMultiplier);const K=[1,0,0];i.dP(K,K,U),i.c4(K,K,this.params.sizeMultiplier);const rt=(ht=X,lt=K,_t=f,{u_matrix:Float32Array.from(V),u_up:ht,u_right:lt,u_intensity_multiplier:_t});var ht,lt,_t;e.uploadCommonUniforms(y,M),this.starsVx&&this.starsIdx&&M.draw(e,w.TRIANGLES,ki.disabled,hr.disabled,this.colorModeAlphaBlendedWriteRGB,rr.disabled,rt,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class ft{constructor(){this.visibleTiles=[]}updateBorders(e,a){const f=[],y=[],w=e._getRenderableCoordinates(!1,!0);for(const L of w){const N=e.getTile(L);if(!N.hasData())continue;const V=N.getBucket(a);V&&(V.isEmpty()||(f.push(L.key),y.push({bucket:V,tileID:L.canonical})))}let I=f.length!==this.visibleTiles.length;if(!I){f.sort();for(let L=0;L<f.length;L++)if(f[L]!==this.visibleTiles[L]){I=!0;break}}if(!I)return;const M=new Set;this.visibleTiles=f,y.sort((L,N)=>L.tileID.z-N.tileID.z||L.tileID.x-N.tileID.x||L.tileID.y-N.tileID.y);for(const L of y){const N=new Array,V=new Array,Z=L.bucket;for(const U of Z.featuresOnBorder)M.has(U.featureId)?V.push(U.footprintIndex):(M.add(U.featureId),N.push(U.footprintIndex));Z.updateFootprintHiddenFlags(N,i.eu,!1),Z.updateFootprintHiddenFlags(V,i.eu,!0)}}}function _e(p,e){const a=[...p],f=e.cameraWorldSizeForFog/e.worldSize,y=i.bz([]);return i.cR(y,y,[f,f,1]),i.aB(a,y,a),i.aB(a,e.worldToFogMatrix,a),a}function he(p,e,a,f,y){const w=a.material,I=f.context,{baseColorTexture:M,metallicRoughnessTexture:L}=w.pbrMetallicRoughness,{normalTexture:N,occlusionTexture:V,emissionTexture:Z}=w;function U(K,rt,ht){if(K&&(p.push(rt),I.activeTexture.set(I.gl.TEXTURE0+ht),K.gfxTexture)){const{minFilter:lt,magFilter:_t,wrapS:Mt,wrapT:vt}=K.sampler;K.gfxTexture.bindExtraParam(lt,_t,Mt,vt)}}U(M,"HAS_TEXTURE_u_baseColorTexture",Ss.BaseColor),U(L,"HAS_TEXTURE_u_metallicRoughnessTexture",Ss.MetallicRoughness),U(N,"HAS_TEXTURE_u_normalTexture",Ss.Normal),U(V,"HAS_TEXTURE_u_occlusionTexture",Ss.Occlusion),U(Z,"HAS_TEXTURE_u_emissionTexture",Ss.Emission),y&&(y.texture||(y.texture=new i.d_(f.context,y.image,[y.image.height,y.image.height,y.image.height],I.gl.RGBA8)),I.activeTexture.set(I.gl.TEXTURE0+Ss.LUT),y.texture&&y.texture.bind(I.gl.LINEAR,I.gl.CLAMP_TO_EDGE),p.push("APPLY_LUT_ON_GPU")),a.texcoordBuffer&&(p.push("HAS_ATTRIBUTE_a_uv_2f"),e.push(a.texcoordBuffer)),a.colorBuffer&&(p.push(a.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),e.push(a.colorBuffer)),a.normalBuffer&&(p.push("HAS_ATTRIBUTE_a_normal_3f"),e.push(a.normalBuffer)),a.pbrBuffer&&(p.push("HAS_ATTRIBUTE_a_pbr"),p.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),e.push(a.pbrBuffer)),w.alphaMode!=="OPAQUE"&&w.alphaMode!=="MASK"||p.push("UNPREMULT_TEXTURE_IN_SHADER"),w.defined||p.push("DIFFUSE_SHADED");const X=f.shadowRenderer;X&&(p.push("RENDER_SHADOWS","DEPTH_TEXTURE"),X.useNormalOffset&&p.push("NORMAL_OFFSET"))}function me(p,e,a,f,y,w){const I=a.paint.get("model-opacity").constantOr(1),M=e.context,L=new ki(e.context.gl.LEQUAL,p.isLightMesh?ki.ReadOnly:ki.ReadWrite,e.depthRangeFor3D),N=e.transform,V=p.mesh,Z=V.material,U=Z.pbrMetallicRoughness,X=e.style.fog;let K;K=e.transform.projection.zAxisUnit==="pixels"?[...p.nodeModelMatrix]:i.aB([],f.zScaleMatrix,p.nodeModelMatrix),i.aB(K,f.negCameraPosMatrix,K);const rt=i.bk([],K);i.ef(rt,rt);const ht=a.paint.get("model-color-use-theme").constantOr("default")==="none",lt=a.paint.get("model-emissive-strength").constantOr(0),_t=ld(new Float32Array(p.worldViewProjection),new Float32Array(K),new Float32Array(rt),null,e,I,U.baseColorFactor,Z.emissiveFactor,U.metallicFactor,U.roughnessFactor,Z,lt,a,void 0,void 0,p.materialOverride,p.modelColor),Mt={defines:[]},vt=[],Ut=e.shadowRenderer;Ut&&(Ut.useNormalOffset=!1),he(Mt.defines,vt,V,e,ht?null:a.lut);let Ct=null;if(X){const Rt=_e(p.nodeModelMatrix,e.transform);if(Ct=new Float32Array(Rt),N.projection.name!=="globe"){const Zt=V.aabb.min,pe=V.aabb.max,[le,Me]=X.getOpacityForBounds(Rt,Zt[0],Zt[1],pe[0],pe[1]);Mt.overrideFog=le>=xe||Me>=xe}}const $t=ha(e,a.paint.get("model-cutoff-fade-range"));$t.shouldRenderCutoff&&Mt.defines.push("RENDER_CUTOFF");const Ot=e.getOrCreateProgram("model",Mt);e.uploadCommonUniforms(M,Ot,null,Ct,$t),e.renderPass!=="shadow"&&Ut&&Ut.setupShadowsFromMatrix(p.nodeModelMatrix,Ot),Ot.draw(e,M.gl.TRIANGLES,L,y,w,V.material.doubleSided?rr.disabled:rr.backCCW,_t,a.id,V.vertexBuffer,V.indexBuffer,V.segments,a.paint,e.transform.zoom,void 0,vt)}function be(p,e,a){return p.type==="vector"?e.scope:a?"basemap":""}function de(p,e,a,f,y,w,I,M,L){const N=p.transform,V=!!e.isGeometryBloom&&e.isGeometryBloom;if(V&&p.renderPass==="shadow")return;const Z=N.projection.name==="globe"?i.eC(a,N):[...a];i.aB(Z,Z,e.globalMatrix);const U=i.aB([],f,Z);if(e.meshes)for(const X of e.meshes){const K=M.get(X.material.name);if(K&&K.opacity<=0)continue;if(X.material.alphaMode!=="BLEND"){I.push({mesh:X,depth:0,modelIndex:y,worldViewProjection:U,nodeModelMatrix:Z,isLightMesh:V,materialOverride:K,modelColor:L});continue}const rt=i.af([],X.centroid,U);!N.isOrthographic&&rt[2]<=0||w.push({mesh:X,depth:rt[2],modelIndex:y,worldViewProjection:U,nodeModelMatrix:Z,isLightMesh:V,materialOverride:K,modelColor:L})}if(e.children)for(const X of e.children)de(p,X,a,f,y,w,I,M,L)}function Ce(p,e,a,f){const y=a.shadowRenderer;if(!y)return;const w=y.getShadowPassDepthMode(),I=y.getShadowPassColorMode(),M=y.calculateShadowPassMatrixFromMatrix(e),L=Hh(M);a.getOrCreateProgram("modelDepth",{defines:a._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(a,a.context.gl.TRIANGLES,w,hr.disabled,I,rr.disabled,L,f.id,p.vertexBuffer,p.indexBuffer,p.segments,f.paint,a.transform.zoom,void 0,void 0)}function Qe(p,e,a,f,y,w){for(const I of y){const M=Object.assign({},f);M.part=I;const L={type:"Unknown",id:e,properties:M},N={orientation:p.paint.get("model-rotation").evaluate(L,a)};w.set(I,N)}}function Xe(p,e,a,f,y,w){for(const I of y){const M=Object.assign({},f);M.part=I;const L={type:"Unknown",id:e,properties:M},N={color:p.paint.get("model-color").evaluate(L,a),colorMix:p.paint.get("model-color-mix-intensity").evaluate(L,a),opacity:p.paint.get("model-opacity").evaluate(L,a),emissionStrength:p.paint.get("model-emissive-strength").evaluate(L,a)};w.set(I,N)}}function Je(p,e,a,f,y,w){if(a===1)for(const M of y)me(M,p,e,w[M.modelIndex],hr.disabled,p.colorModeForRenderPass());else{for(const M of y)me(M,p,e,w[M.modelIndex],hr.disabled,Sr.disabled);for(const M of y)me(M,p,e,w[M.modelIndex],p.stencilModeFor3D(),p.colorModeForRenderPass());p.resetStencilClippingMasks()}const I=Sr.additive;for(const M of f)me(M,p,e,w[M.modelIndex],hr.disabled,M.isLightMesh?I:p.colorModeForRenderPass())}function ii(p,e,a){const f=e.updateZoomBasedPaintProperties(),y=function(w,I,M){let L,N,V,Z=w.terrain?w.terrain.exaggeration():0;if(w.terrain&&Z>0){const U=w.terrain,X=U.findDEMTileFor(M);X&&X.dem?L=i.eE.create(U,M,X):Z=0}if(Z===0&&(I.terrainElevationMin=0,I.terrainElevationMax=0),Z===I.validForExaggeration&&(Z===0||L&&L._demTile&&L._demTile.tileID===I.validForDEMTile.id&&L._dem._timestamp===I.validForDEMTile.timestamp))return!1;for(const U in I.instancesPerModel){const X=I.instancesPerModel[U];for(let K=0;K<X.instancedDataArray.length;++K){const rt=(L?Z*L.getElevationAt(0|X.instancedDataArray.float32[16*K],0|X.instancedDataArray.float32[16*K+1],!0,!0):0)+X.instancesEvaluatedElevation[K];X.instancedDataArray.float32[16*K+6]=rt,N=N?Math.min(I.terrainElevationMin,rt):rt,V=V?Math.max(I.terrainElevationMax,rt):rt}}return I.terrainElevationMin=N||0,I.terrainElevationMax=V||0,I.validForExaggeration=Z,I.validForDEMTile=L&&L._demTile?{id:L._demTile.tileID,timestamp:L._dem._timestamp}:{id:void 0,timestamp:0},!0}(p,e,a);(f||y)&&(e.uploaded=!1,e.upload(p.context))}const Ri={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new i.d8([0,0,0],[i.al,i.al,0])};function Oi(p,e){const a=1<<p.canonical.z,f=e.getFreeCameraOptions().position,y=e.elevation,w=p.canonical.x/a,I=(p.canonical.x+1)/a,M=p.canonical.y/a,L=(p.canonical.y+1)/a;let N=e._centerAltitude;if(y){const X=y.getMinMaxForTile(p);X&&X.max>N&&(N=X.max)}const V=i.aA(f.x,w,I)-f.x,Z=i.aA(f.y,M,L)-f.y,U=i.ce(N,e.center.lat)-f.z;return e._zoomFromMercatorZ(Math.sqrt(V*V+Z*Z+U*U))}function Ti(p,e,a,f,y,w,I){const M=p.context,L=p.renderPass==="shadow",N=p.shadowRenderer,V=L&&N?N.getShadowPassDepthMode():new ki(M.gl.LEQUAL,ki.ReadWrite,p.depthRangeFor3D),Z=p.isTileAffectedByFog(w),U=p.transform.projection.name==="globe";if(a.meshes)for(const X of a.meshes){const K=U?[]:["MODEL_POSITION_ON_GPU"],rt=[];let ht,lt,_t;const Mt=!U&&f.instancedDataArray.length>20;Mt&&K.push("INSTANCED_ARRAYS");const vt=ha(p,e.paint.get("model-cutoff-fade-range"));if(vt.shouldRenderCutoff&&K.push("RENDER_CUTOFF"),L&&N)ht=p.getOrCreateProgram("modelDepth",{defines:K}),lt=Hh(I.shadowTileMatrix,I.shadowTileMatrix,Float32Array.from(a.globalMatrix)),_t=N.getShadowPassColorMode();else{he(K,rt,X,p,e.paint.get("model-color-use-theme").constantOr("default")==="none"?null:e.lut),ht=p.getOrCreateProgram("model",{defines:K,overrideFog:Z});const Ct=X.material,$t=Ct.pbrMetallicRoughness,Ot=e.paint.get("model-opacity").constantOr(1),Rt=e.paint.get("model-emissive-strength").constantOr(0);lt=ld(w.expandedProjMatrix,Float32Array.from(a.globalMatrix),new Float32Array(16),null,p,Ot,$t.baseColorFactor,Ct.emissiveFactor,$t.metallicFactor,$t.roughnessFactor,Ct,Rt,e,y),N&&(I.shadowUniformsInitialized?ht.setShadowUniformValues(M,N.getShadowUniformValues()):(N.setupShadows(w.toUnwrapped(),ht,"model-tile"),I.shadowUniformsInitialized=!0)),_t=vt.shouldRenderCutoff||Ot<1||Ct.alphaMode!=="OPAQUE"?Sr.alphaBlended:Sr.unblended}p.uploadCommonUniforms(M,ht,w.toUnwrapped(),null,vt);const Ut=X.material.doubleSided?rr.disabled:rr.backCCW;if(Mt)rt.push(f.instancedDataBuffer),ht.draw(p,M.gl.TRIANGLES,V,hr.disabled,_t,Ut,lt,e.id,X.vertexBuffer,X.indexBuffer,X.segments,e.paint,p.transform.zoom,void 0,rt,f.instancedDataArray.length);else{const Ct=L?"u_instance":"u_normal_matrix";for(let $t=0;$t<f.instancedDataArray.length;++$t)lt[Ct]=new Float32Array(f.instancedDataArray.arrayBuffer,64*$t,16),ht.draw(p,M.gl.TRIANGLES,V,hr.disabled,_t,Ut,lt,e.id,X.vertexBuffer,X.indexBuffer,X.segments,e.paint,p.transform.zoom,void 0,rt)}}if(a.children)for(const X of a.children)Ti(p,e,X,f,y,w,I)}const br=[1,-1,1];function tn(p,e,a,f){if(!a.modelManager)return!0;const y=a.modelManager;if(!a.shadowRenderer)return!0;const w=a.shadowRenderer,I=e.aabb;let M=!0,L=p.maxHeight;if(L===0){let V=0;for(const Z in p.instancesPerModel){const U=y.getModel(Z,f);U?V=Math.max(V,Math.max(Math.max(U.aabb.max[0],U.aabb.max[1]),U.aabb.max[2])):M=!1}L=p.maxScale*V*1.41+p.maxVerticalOffset,M&&(p.maxHeight=L)}I.max[2]=L,I.min[2]+=p.terrainElevationMin,I.max[2]+=p.terrainElevationMax,i.af(I.min,I.min,e.tileMatrix),i.af(I.max,I.max,e.tileMatrix);const N=I.intersects(w.getCurrentCascadeFrustum());return a.currentShadowCascade===0&&(p.isInsideFirstShadowMapFrustum=N===2),N===0}function Zr(p,e){const a=p.uniformValues.u_cutoff_params[0],f=p.uniformValues.u_cutoff_params[1],y=p.uniformValues.u_cutoff_params[2],w=p.uniformValues.u_cutoff_params[3];return f===a||w===y?1:i.aA(((e-a)/(f-a)-y)/(w-y),0,1)}function vo(p,e,a,f){if(e.pitch<20)return 1;const y=e.getWorldToCameraMatrix();i.aB(y,y,p);const w=i.bT(a.min[0],a.min[1],a.min[2],1);let I=i.aC(i.eF(),w,y),M=I,L=I;w[1]=a.max[1],I=i.aC(i.eF(),w,y),M=I[1]<M[1]?I:M,L=I[1]>L[1]?I:L,w[0]=a.max[0],I=i.aC(i.eF(),w,y),M=I[1]<M[1]?I:M,L=I[1]>L[1]?I:L,w[1]=a.min[1],I=i.aC(i.eF(),w,y),M=I[1]<M[1]?I:M,L=I[1]>L[1]?I:L;const N=i.aA(f[0],0,1),V=100*e.pixelsPerMeter*i.aA(f[1],0,1),Z=i.aA(f[2],0,1),U=i.eG(i.eF(),M,L,N),X=Math.tan(.5*e.fovX),K=-U[2]*X;if(V===0)return U[1]<-Math.abs(K)?Z:1;const rt=(-Math.abs(K)-U[1])/V,ht=(_t,Mt,vt)=>(1-vt)*_t+vt*Mt,lt=i.aA(ht(1,Z,rt),Z,1);return ht(1,lt,i.aA((e.pitch-20)/20,0,1))}class Wo{}class os{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(e,a,f){{const Z=this._storage.get(a.id);if(Z)return Z.lastUsedFrameIdx=e,Z.buf}const y=f.gl,w=y.getBufferParameter(y.ELEMENT_ARRAY_BUFFER,y.BUFFER_SIZE),I=new ArrayBuffer(w),M=new Int16Array(I);y.getBufferSubData(y.ELEMENT_ARRAY_BUFFER,0,new Int16Array(I));const L=new i.eI;for(let Z=0;Z<w/2;Z+=3){const U=M[Z],X=M[Z+1],K=M[Z+2];L.emplaceBack(U,X),L.emplaceBack(X,K),L.emplaceBack(K,U)}const N=f.bindVertexArrayOES.current,V=new Wo;return V.buf=new da(f,L),V.lastUsedFrameIdx=e,this._storage.set(a.id,V),f.bindVertexArrayOES.set(N),V.buf}update(e){for(const[a,f]of this._storage)e-f.lastUsedFrameIdx>30&&(f.buf.destroy(),this._storage.delete(a))}destroy(){for(const[e,a]of this._storage)a.buf.destroy(),this._storage.delete(e)}}class Xo{constructor(e){this.occluderSize=30,this.depthOffset=-1e-4,e.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),e.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const zs=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class ss{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class io{constructor(e,a){this.revealStart=11,this.revealRange=2,e.registerParameter(this,[...a,"Reveal"],"revealStart",{min:0,max:17,step:.05}),e.registerParameter(this,[...a,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const Es=i.eh([{type:"Float32",name:"a_pos_2f",components:2}]);class as{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(e,a){const f=e.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const I=new i.eJ,M=new i.b0;I.emplaceBack(-1,-1),I.emplaceBack(1,-1),I.emplaceBack(1,1),I.emplaceBack(-1,1),M.emplaceBack(0,1,2),M.emplaceBack(0,2,3),this.vignetteVx=e.context.createVertexBuffer(I,Es.members),this.vignetteIdx=e.context.createIndexBuffer(M)}const y=i.bf.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){e.uploadCommonUniforms(e.context,f);const I={u_vignetteShape:(w={vignetteShape:[a.start,a.range,Math.pow(10,a.fadePower)],vignetteColor:[a.color.r,a.color.g,a.color.b,a.color.a*a.strength]}).vignetteShape,u_vignetteColor:w.vignetteColor};f.draw(e,e.context.gl.TRIANGLES,ki.disabled,hr.disabled,Sr.alphaBlended,rr.disabled,I,"vignette",this.vignetteVx,this.vignetteIdx,y)}var w}}class sn{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(e,a){const f=e.getFreeCameraOptions().position,y=f.toAltitude(),w=f.toLngLat(),I=i.an(w.lng),M=i.an(w.lat),L=e.pixelsPerMeter/a,N=I*i.eL,V=i.eL*Math.log(Math.tan(Math.PI/4+M/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const Z=-this._offsetYPrev+V,U=-this._elevationPrev+y;this._accumulatedOffsetX+=(-this._offsetXPrev+N)*L,this._accumulatedOffsetY+=Z*L,this._accumulatedElevation+=U*L,this._offsetXPrev=N,this._offsetYPrev=V,this._elevationPrev=y}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Er(p,e){return[-(p[0]-Math.floor(p[0]/e)*e),-(p[1]-Math.floor(p[1]/e)*e),-(p[2]-Math.floor(p[2]/e)*e)]}function Ql(p){const e=i.eq(1323123451230),a=[];for(let f=0;f<p;++f){const y=2*e()-1,w=2*e()-1,I=2*e()-1;a.push(i.d4(y,w,I))}return a}function As(p,e,a,f,y){const w=i.aA((y-a)/(f-a),0,1);return(1-w)*p+w*e}class wl{constructor(e){this._movement=new sn,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new as,this._ppmScaleFactor=e}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(e,a){const f=e.transform;this._movement.update(f,this._ppmScaleFactor);const y=f.starsProjMatrix,w=i.c6([]);i.c8(w,w,i.an(90)-f._pitch),i.c7(w,w,-f.angle);const I=i.cb(new Float32Array(16),w),M=i.eK(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),L=i.ef([],M),N=i.aB([],L,I),V=Date.now()/1e3;return this._accumulatedTimeFromStart+=(V-this._prevTime)*a,this._prevTime=V,{projectionMatrix:y,modelviewMatrix:N}}}class tc extends wl{constructor(e){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new io(e.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(e){const a=e.context;if(!this.particlesVx){const f=Ql(this.particlesCount),y=new i.eM,w=new i.b0;let I=0;const M=i.eq(1323123451230);for(let L=0;L<f.length;++L){const N=f[L],V=[2*M()-1,M(),M(),M()];y.emplaceBack(N[0],N[1],N[2],-1,-1,...V),y.emplaceBack(N[0],N[1],N[2],1,-1,...V),y.emplaceBack(N[0],N[1],N[2],1,1,...V),y.emplaceBack(N[0],N[1],N[2],-1,1,...V),w.emplaceBack(I+0,I+1,I+2),w.emplaceBack(I+0,I+2,I+3),I+=4}this.particlesVx=a.createVertexBuffer(y,zs.members),this.particlesIdx=a.createIndexBuffer(w)}}draw(e){if(!this._params.overrideStyleParameters&&!e.style.rain)return;const a=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},f=e.transform.zoom;if(a.revealStart>f)return;const y=As(0,1,a.revealStart,a.revealStart+a.revealRange,f);if(!this.particlesVx||!this.particlesIdx)return;const w=structuredClone(this._params);let I=[-w.direction.x,w.direction.y,-100];i.aw(I,I);const M=structuredClone(this._vignetteParams);M.strength*=y,w.overrideStyleParameters||(w.intensity=e.style.rain.state.density,w.timeFactor=e.style.rain.state.intensity,w.color=structuredClone(e.style.rain.state.color),I=structuredClone(e.style.rain.state.direction),w.screenThinning.intensity=e.style.rain.state.centerThinning,w.dropletSizeX=e.style.rain.state.dropletSize[0],w.dropletSizeYScale=e.style.rain.state.dropletSize[1]/e.style.rain.state.dropletSize[0],w.distortionStrength=100*e.style.rain.state.distortionStrength,M.strength=1,M.color=structuredClone(e.style.rain.state.vignetteColor));const L=this.updateOnRender(e,w.timeFactor),N=e.context,V=N.gl,Z=e.transform;this.screenTexture&&this.screenTexture.size[0]===e.width&&this.screenTexture.size[1]===e.height||(this.screenTexture=new i.T(N,{width:e.width,height:e.height,data:null},V.RGBA8)),w.distortionStrength>0&&(N.activeTexture.set(V.TEXTURE0),this.screenTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),V.copyTexSubImage2D(V.TEXTURE_2D,0,0,0,0,0,e.width,e.height));const U=e.getOrCreateProgram("rainParticle");e.uploadCommonUniforms(N,U),N.activeTexture.set(V.TEXTURE0),this.screenTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE);const X=[w.color.r,w.color.g,w.color.b,w.color.a],K=(rt,ht)=>{const lt=Er(this._movement.getPosition(),rt),_t=w.dropletSizeX,Mt=w.dropletSizeX*w.dropletSizeYScale,vt=e.width/2,Ut=e.height/2,Ct=As(0,w.screenThinning.start,0,1,w.screenThinning.intensity),$t=As(.001,w.screenThinning.range,0,1,w.screenThinning.intensity),Ot=As(0,w.screenThinning.particleOffset,0,1,w.screenThinning.intensity),Rt=(Zt={modelview:L.modelviewMatrix,projection:L.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:lt,velocityConeAperture:w.velocityConeAperture,velocity:w.velocity,boxSize:rt,rainDropletSize:[_t,Mt],distortionStrength:w.distortionStrength,rainDirection:I,color:X,screenSize:[Z.width,Z.height],thinningCenterPos:[vt,Ut],thinningShape:[Ct,$t,Math.pow(10,w.screenThinning.fadePower)],thinningAffectedRatio:w.screenThinning.affectedRatio,thinningParticleOffset:Ot,shapeDirectionalPower:w.shapeDirPower,shapeNormalPower:w.shapeNormalPower,mode:ht?0:1},{u_modelview:Float32Array.from(Zt.modelview),u_projection:Float32Array.from(Zt.projection),u_time:Zt.time,u_cam_pos:Zt.camPos,u_texScreen:0,u_velocityConeAperture:Zt.velocityConeAperture,u_velocity:Zt.velocity,u_boxSize:Zt.boxSize,u_rainDropletSize:Zt.rainDropletSize,u_distortionStrength:Zt.distortionStrength,u_rainDirection:Zt.rainDirection,u_color:Zt.color,u_screenSize:Zt.screenSize,u_thinningCenterPos:Zt.thinningCenterPos,u_thinningShape:Zt.thinningShape,u_thinningAffectedRatio:Zt.thinningAffectedRatio,u_thinningParticleOffset:Zt.thinningParticleOffset,u_shapeDirectionalPower:Zt.shapeDirectionalPower,u_shapeNormalPower:Zt.shapeNormalPower,u_mode:Zt.mode});var Zt;const pe=Math.round(w.intensity*this.particlesCount),le=i.bf.simpleSegment(0,0,4*pe,2*pe);U.draw(e,V.TRIANGLES,ki.disabled,hr.disabled,Sr.alphaBlended,rr.disabled,Rt,"rain_particles",this.particlesVx,this.particlesIdx,le)};w.distortionStrength>0&&K(w.boxSize,!0),K(w.boxSize,!1),this._vignette.draw(e,M)}}const $s=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class _c extends wl{constructor(e){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new io(e.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(e){const a=e.context;if(!this.particlesVx){const f=Ql(this.particlesCount),y=new i.eN,w=new i.b0;let I=0;const M=i.eq(1323123451230);for(let L=0;L<f.length;++L){const N=f[L],V=M(),Z=M(),U=M(),X=[L/f.length,V,Z,U],K=[M(),M()];y.emplaceBack(N[0],N[1],N[2],-1,-1,...X,...K),y.emplaceBack(N[0],N[1],N[2],1,-1,...X,...K),y.emplaceBack(N[0],N[1],N[2],1,1,...X,...K),y.emplaceBack(N[0],N[1],N[2],-1,1,...X,...K),w.emplaceBack(I+0,I+1,I+2),w.emplaceBack(I+0,I+2,I+3),I+=4}this.particlesVx=a.createVertexBuffer(y,$s.members),this.particlesIdx=a.createIndexBuffer(w)}}draw(e){if(!this._params.overrideStyleParameters&&!e.style.snow)return;const a=structuredClone(this._params);let f=[-a.direction.x,a.direction.y,-100];i.aw(f,f);const y=structuredClone(this._vignetteParams),w=a.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},I=e.transform.zoom;if(w.revealStart>I)return;const M=As(0,1,w.revealStart,w.revealStart+w.revealRange,I);y.strength*=M,a.overrideStyleParameters||(a.intensity=e.style.snow.state.density,a.timeFactor=e.style.snow.state.intensity,a.color=structuredClone(e.style.snow.state.color),f=structuredClone(e.style.snow.state.direction),a.screenThinning.intensity=e.style.snow.state.centerThinning,a.billboardSize=2.79*e.style.snow.state.flakeSize,y.strength=1,y.color=structuredClone(e.style.snow.state.vignetteColor));const L=this.updateOnRender(e,a.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const N=e.context,V=N.gl,Z=e.transform,U=e.getOrCreateProgram("snowParticle");e.uploadCommonUniforms(N,U),((X,K,rt)=>{const ht=Er(this._movement.getPosition(),X),lt=Z.width/2,_t=Z.height/2,Mt=As(0,rt.screenThinning.start,0,1,rt.screenThinning.intensity),vt=As(.001,rt.screenThinning.range,0,1,rt.screenThinning.intensity),Ut=As(0,rt.screenThinning.particleOffset,0,1,rt.screenThinning.intensity),Ct=($t={modelview:L.modelviewMatrix,projection:L.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:ht,velocityConeAperture:rt.velocityConeAperture,velocity:rt.velocity,horizontalOscillationRadius:rt.horizontalOscillationRadius,horizontalOscillationRate:rt.horizontalOscillationRate,boxSize:X,billboardSize:1*rt.billboardSize,simpleShapeParameters:[rt.shapeFadeStart,rt.shapeFadePower],screenSize:[Z.width,Z.height],thinningCenterPos:[lt,_t],thinningShape:[Mt,vt,Math.pow(10,rt.screenThinning.fadePower)],thinningAffectedRatio:rt.screenThinning.affectedRatio,thinningParticleOffset:Ut,color:[rt.color.r,rt.color.g,rt.color.b,rt.color.a],direction:f},{u_modelview:Float32Array.from($t.modelview),u_projection:Float32Array.from($t.projection),u_time:$t.time,u_cam_pos:$t.camPos,u_velocityConeAperture:$t.velocityConeAperture,u_velocity:$t.velocity,u_horizontalOscillationRadius:$t.horizontalOscillationRadius,u_horizontalOscillationRate:$t.horizontalOscillationRate,u_boxSize:$t.boxSize,u_billboardSize:$t.billboardSize,u_simpleShapeParameters:$t.simpleShapeParameters,u_screenSize:$t.screenSize,u_thinningCenterPos:$t.thinningCenterPos,u_thinningShape:$t.thinningShape,u_thinningAffectedRatio:$t.thinningAffectedRatio,u_thinningParticleOffset:$t.thinningParticleOffset,u_particleColor:$t.color,u_direction:$t.direction});var $t;const Ot=Math.round(rt.intensity*this.particlesCount),Rt=i.bf.simpleSegment(0,0,4*Ot,2*Ot);this.particlesVx&&this.particlesIdx&&U.draw(e,V.TRIANGLES,ki.disabled,hr.disabled,Sr.alphaBlended,rr.disabled,Ct,"snow_particles",this.particlesVx,this.particlesIdx,Rt)})(a.boxSize,0,a),this._vignette.draw(e,y)}}const rl={symbol:function(p,e,a,f,y){if(p.renderPass!=="translucent")return;const w=hr.disabled,I=p.colorModeForRenderPass(),M=a.layout.get("text-variable-anchor"),L=a.layout.get("text-size-scale-range"),N=i.aA(p.scaleFactor,L[0],L[1]);M&&function(U,X,K,rt,ht,lt,_t,Mt){const vt=X.transform,Ut=ht==="map",Ct=lt==="map";for(const $t of U){const Ot=rt.getTile($t),Rt=Ot.getBucket(K);if(!Rt||!Rt.text||!Rt.text.segments.get().length)continue;const Zt=i.bJ(Rt.textSizeData,vt.zoom,Mt),pe=Un($t,Rt.getProjection(),vt),le=vt.calculatePixelsToTileUnitsMatrix(Ot),Me=Jc(pe,Ot.tileID.canonical,Ct,Ut,vt,Rt.getProjection(),le),ve=Rt.hasIconTextFit()&&Rt.hasIconData();Zt&&Pp(Rt,Ut,Ct,_t,vt,Me,$t,Math.pow(2,vt.zoom-Ot.tileID.overscaledZ),Zt,ve)}}(f,p,a,e,a.layout.get("text-rotation-alignment"),a.layout.get("text-pitch-alignment"),y,N);const V=a.paint.get("icon-opacity").constantOr(1)!==0,Z=a.paint.get("text-opacity").constantOr(1)!==0;a.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(V||Z)?$d(p,e,a,f,w,I):(V&&$d(p,e,a,f,w,I,{onlyIcons:!0}),Z&&$d(p,e,a,f,w,I,{onlyText:!0})),e.map.showCollisionBoxes&&(hh(p,e,a,f,a.paint.get("text-translate"),a.paint.get("text-translate-anchor"),!0),hh(p,e,a,f,a.paint.get("icon-translate"),a.paint.get("icon-translate-anchor"),!1))},circle:function(p,e,a,f){if(p.renderPass!=="translucent")return;const y=a.paint.get("circle-opacity"),w=a.paint.get("circle-stroke-width"),I=a.paint.get("circle-stroke-opacity"),M=a.layout.get("circle-sort-key").constantOr(1)!==void 0,L=a.paint.get("circle-emissive-strength");if(y.constantOr(1)===0&&(w.constantOr(1)===0||I.constantOr(1)===0))return;const N=p.context,V=N.gl,Z=p.transform,U=!(!p.terrain||!p.terrain.enabled),X=a.layout.get("circle-elevation-reference"),K=p.depthModeForSublayer(0,ki.ReadOnly),rt=new ki(p.context.gl.LEQUAL,ki.ReadOnly,p.depthRangeFor3D),ht=X==="none"||U?K:rt,lt=hr.disabled,_t=p.colorModeForDrapableLayerRenderPass(L),Mt=Z.projection.name==="globe",vt=[i.aF(Z.center.lng),i.aJ(Z.center.lat)],Ut=[];for(let $t=0;$t<f.length;$t++){const Ot=f[$t],Rt=e.getTile(Ot),Zt=Rt.getBucket(a);if(!Zt||Zt.projection.name!==Z.projection.name)continue;const pe=Zt.programConfigurations.get(a.id),le=Zt.layoutVertexBuffer,Me=Zt.globeExtVertexBuffer,ve=Zt.indexBuffer,Be=i.d$(a),oi=[Me],ge=p.isTileAffectedByFog(Ot);Mt&&Be.push("PROJECTION_GLOBE_VIEW"),Be.push("DEPTH_D24"),p.terrain&&Z.depthOcclusionForSymbolsAndCircles&&Be.push("DEPTH_OCCLUSION"),Zt.hasElevation&&!p.terrain&&(Be.push("ELEVATED_ROADS"),oi.push(Zt.elevatedLayoutVertexBuffer));const ie=p.getOrCreateProgram("circle",{config:pe,defines:Be,overrideFog:ge}),Oe=Z.projection.createInversionMatrix(Z,Ot.canonical),Te={programConfiguration:pe,program:ie,layoutVertexBuffer:le,dynamicBuffers:oi,indexBuffer:ve,uniformValues:i.e0(p,Ot,Rt,Oe,vt,a),tile:Rt};if(M){const qe=Zt.segments.get();for(const si of qe)Ut.push({segments:new i.bf([si]),sortKey:si.sortKey,state:Te})}else Ut.push({segments:Zt.segments,sortKey:0,state:Te})}M&&Ut.sort(($t,Ot)=>$t.sortKey-Ot.sortKey);const Ct={useDepthForOcclusion:Z.depthOcclusionForSymbolsAndCircles};for(const $t of Ut){const{programConfiguration:Ot,program:Rt,layoutVertexBuffer:Zt,dynamicBuffers:pe,indexBuffer:le,uniformValues:Me,tile:ve}=$t.state,Be=$t.segments;p.terrain&&p.terrain.setupElevationDraw(ve,Rt,Ct),p.uploadCommonUniforms(N,Rt,ve.tileID.toUnwrapped()),Rt.draw(p,V.TRIANGLES,ht,lt,_t,rr.disabled,Me,a.id,Zt,le,Be,a.paint,Z.zoom,Ot,pe)}},heatmap:function(p,e,a,f){if(a.paint.get("heatmap-opacity")!==0)if(p.renderPass==="offscreen"){const y=p.context,w=y.gl,I=hr.disabled,M=new Sr([w.ONE,w.ONE,w.ONE,w.ONE],i.ao.transparent,[!0,!0,!0,!0]);(function(X,K,rt,ht){const lt=X.gl,_t=K.width*ht,Mt=K.height*ht;X.activeTexture.set(lt.TEXTURE1),X.viewport.set([0,0,_t,Mt]);let vt=rt.heatmapFbo;if(!vt||vt&&(vt.width!==_t||vt.height!==Mt)){vt&&vt.destroy();const Ut=lt.createTexture();lt.bindTexture(lt.TEXTURE_2D,Ut),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_WRAP_S,lt.CLAMP_TO_EDGE),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_WRAP_T,lt.CLAMP_TO_EDGE),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_MIN_FILTER,lt.LINEAR),lt.texParameteri(lt.TEXTURE_2D,lt.TEXTURE_MAG_FILTER,lt.LINEAR),vt=rt.heatmapFbo=X.createFramebuffer(_t,Mt,!0,null),function(Ct,$t,Ot,Rt,Zt,pe){const le=Ct.gl;le.texImage2D(le.TEXTURE_2D,0,Ct.extRenderToTextureHalfFloat?le.RGBA16F:le.RGBA,Zt,pe,0,le.RGBA,Ct.extRenderToTextureHalfFloat?le.HALF_FLOAT:le.UNSIGNED_BYTE,null),Rt.colorAttachment.set(Ot)}(X,0,Ut,vt,_t,Mt)}else lt.bindTexture(lt.TEXTURE_2D,vt.colorAttachment.get()),X.bindFramebuffer.set(vt.framebuffer)})(y,p,a,p.transform.projection.name==="globe"?.5:.25),y.clear({color:i.ao.transparent});const L=p.transform,N=L.projection.name==="globe",V=N?["PROJECTION_GLOBE_VIEW"]:[],Z=N?rr.frontCCW:rr.disabled,U=[i.aF(L.center.lng),i.aJ(L.center.lat)];for(let X=0;X<f.length;X++){const K=f[X];if(e.hasRenderableParent(K))continue;const rt=e.getTile(K),ht=rt.getBucket(a);if(!ht||ht.projection.name!==L.projection.name)continue;const lt=p.isTileAffectedByFog(K),_t=ht.programConfigurations.get(a.id),Mt=p.getOrCreateProgram("heatmap",{config:_t,defines:V,overrideFog:lt}),{zoom:vt}=p.transform;p.terrain&&p.terrain.setupElevationDraw(rt,Mt),p.uploadCommonUniforms(y,Mt,K.toUnwrapped());const Ut=L.projection.createInversionMatrix(L,K.canonical);Mt.draw(p,w.TRIANGLES,ki.disabled,I,M,Z,yf(p,K,rt,Ut,U,vt,a.paint.get("heatmap-intensity")),a.id,ht.layoutVertexBuffer,ht.indexBuffer,ht.segments,a.paint,p.transform.zoom,_t,N?[ht.globeExtVertexBuffer]:null)}y.viewport.set([0,0,p.width,p.height])}else p.renderPass==="translucent"&&(p.context.setColorMode(p.colorModeForRenderPass()),function(y,w){const I=y.context,M=I.gl,L=w.heatmapFbo;if(!L)return;I.activeTexture.set(M.TEXTURE0),M.bindTexture(M.TEXTURE_2D,L.colorAttachment.get()),I.activeTexture.set(M.TEXTURE1);let N=w.colorRampTexture;N||(N=w.colorRampTexture=new i.T(I,w.colorRamp,M.RGBA8)),N.bind(M.LINEAR,M.CLAMP_TO_EDGE),y.getOrCreateProgram("heatmapTexture").draw(y,M.TRIANGLES,ki.disabled,hr.disabled,y.colorModeForRenderPass(),rr.disabled,((V,Z,U,X)=>({u_image:0,u_color_ramp:1,u_opacity:Z.paint.get("heatmap-opacity")}))(0,w),w.id,y.viewportBuffer,y.quadTriangleIndexBuffer,y.viewportSegments,w.paint,y.transform.zoom)}(p,a))},line:function(p,e,a,f){if(p.renderPass!=="translucent")return;const y=a.paint.get("line-opacity"),w=a.paint.get("line-width");if(y.constantOr(1)===0||w.constantOr(1)===0)return;const I=a.paint.get("line-emissive-strength"),M=a.paint.get("line-occlusion-opacity"),L=a.layout.get("line-elevation-reference"),N=a.layout.get("line-width-unit")==="meters",V=L==="sea",Z=!(!p.terrain||!p.terrain.enabled),U=p.context,X=U.gl;if(a.hasElevatedBuckets&&p.transform.projection.name==="globe")return;const K=a.layout.get("line-cross-slope"),rt=K!==void 0,ht=K<1,lt=p.colorModeForDrapableLayerRenderPass(I),_t=p.terrain&&p.terrain.renderingToTexture,Mt=_t?1:i.o.devicePixelRatio,vt=a.paint.get("line-dasharray"),Ut=vt.constantOr(1),Ct=a.layout.get("line-cap"),$t=vt.constantOr(null),Ot=Ct.constantOr(null),Rt=a.paint.get("line-pattern"),Zt=Rt.constantOr(1),pe=a.paint.get("line-pattern-cross-fade"),le=Rt.constantOr(null),Me=a.paint.get("line-opacity").constantOr(1);let ve=!Zt&&Me!==1||p.depthOcclusion&&M>0&&M<1;const Be=a.paint.get("line-gradient"),oi=Zt?"linePattern":"line",ge=i.e1(a);let ie;if(_t&&p.terrain&&p.terrain.clipOrMaskOverlapStencilType()&&(ve=!1),M!==0&&p.depthOcclusion){const si=a.paint._values["line-opacity"];si&&si.value&&si.value.kind==="constant"?ie=si.value:i.w(`Occlusion opacity for layer ${a.id} is supported only when line-opacity isn't data-driven.`)}w.value.kind!=="constant"&&w.value.isLineProgressConstant===!1&&ge.push("VARIABLE_LINE_WIDTH");const Oe=(si,Li,ni,li,Fi,Si)=>{for(const xi of si){const Ai=e.getTile(xi);if(Zt&&!Ai.patternsLoaded())continue;const Wi=Ai.getBucket(a);if(!Wi||Wi.elevationType!=="none"&&!Fi||Wi.elevationType==="none"&&Fi)continue;p.prepareDrawTile();const Gr=[...Li],en=p.shadowRenderer,kn=Wi.elevationType==="road"&&!!en&&en.enabled;let ur=[0,0,0];if(kn){const mr=p.style.directionalLight,nn=p.style.ambientLight;mr&&nn&&(ur=_l(p.style,mr,nn)),Gr.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const Kr=Wi.programConfigurations.get(a.id);let Pr=!1;if(le&&Ai.imageAtlas){const mr=i.e2.from(le),nn=mr.getPrimary().scaleSelf(Mt).toString(),So=Ai.imageAtlas.patternPositions.get(nn),Yo=mr.getSecondary(),Ro=Yo?Ai.imageAtlas.patternPositions.get(Yo.scaleSelf(Mt).toString()):null;Pr=!!So&&!!Ro,So&&Kr.setConstantPatternPositions(So,Ro)}pe>0&&(Pr||Kr.getPatternTransitionVertexBuffer("line-pattern"))&&Gr.push("LINE_PATTERN_TRANSITION");const Mn=p.isTileAffectedByFog(xi),Yr=p.getOrCreateProgram(oi,{config:Kr,defines:Gr,overrideFog:Mn});if(!Zt&&$t&&Ot&&Ai.lineAtlas){const mr=Ai.lineAtlas.getDash($t,Ot);mr&&Kr.setConstantPatternPositions(mr)}kn&&en.setupShadows(Ai.tileID.toUnwrapped(),Yr,"vector-tile");let[Zn,an]=a.paint.get("line-trim-offset");(Ot==="round"||Ot==="square")&&Zn!==an&&(Zn===0&&(Zn-=1),an===1&&(an+=1));const Mr=_t?xi.projMatrix:null,_n=N?1/Wi.tileToMeter/i.ay(Ai,1,p.transform.zoom):1,Lr=N?1/Wi.tileToMeter/i.ay(Ai,1,Math.floor(p.transform.zoom)):1,fo=Zt?i.e3(p,Ai,a,Mr,Mt,_n,Lr,[Zn,an],ur,pe):i.e4(p,Ai,a,Mr,Wi.lineClipsArray.length,Mt,_n,Lr,[Zn,an],ur);if(Be){const mr=Wi.gradients[a.id];let nn=mr.texture;if(a.gradientVersion!==mr.version){let So=256;if(a.stepInterpolant){const Yo=e.getSource().maxzoom,Ro=xi.canonical.z===Yo?Math.ceil(1<<p.transform.maxZoom-xi.canonical.z):1;So=i.aA(i.e5(Wi.maxLineLength/i.al*1024*Ro),256,U.maxTextureSize)}mr.gradient=i.e6({expression:a.gradientExpression(),evaluationKey:"lineProgress",resolution:So,image:mr.gradient||void 0,clips:Wi.lineClipsArray}),mr.texture?mr.texture.update(mr.gradient):mr.texture=new i.T(U,mr.gradient,X.RGBA8),mr.version=a.gradientVersion,nn=mr.texture}U.activeTexture.set(X.TEXTURE1),nn.bind(a.stepInterpolant?X.NEAREST:X.LINEAR,X.CLAMP_TO_EDGE)}Ut&&(U.activeTexture.set(X.TEXTURE0),Ai.lineAtlasTexture&&Ai.lineAtlasTexture.bind(X.LINEAR,X.REPEAT),Kr.updatePaintBuffers()),Zt&&(U.activeTexture.set(X.TEXTURE0),Ai.imageAtlasTexture&&Ai.imageAtlasTexture.bind(X.LINEAR,X.CLAMP_TO_EDGE),Kr.updatePaintBuffers()),Fi&&!V&&p.terrain.setupElevationDraw(Ai,Yr),p.uploadCommonUniforms(U,Yr,xi.toUnwrapped());const yn=mr=>{ie!=null&&(ie.value=Me*M),Yr.draw(p,X.TRIANGLES,ni,mr,lt,rr.disabled,fo,a.id,Wi.layoutVertexBuffer,Wi.indexBuffer,Wi.segments,a.paint,p.transform.zoom,Kr,[Wi.layoutVertexBuffer2,Wi.patternVertexBuffer,Wi.zOffsetVertexBuffer]),ie!=null&&(ie.value=Me)};if(ve&&!Fi){const mr=p.stencilModeForClipping(xi).ref;mr===0&&_t&&U.clear({stencil:0});const nn={func:X.EQUAL,mask:255};fo.u_alpha_discard_threshold=.8,yn(new hr(nn,mr,255,X.KEEP,X.KEEP,X.INVERT)),fo.u_alpha_discard_threshold=0,yn(new hr(nn,mr,255,X.KEEP,X.KEEP,X.KEEP))}else fo.u_alpha_discard_threshold=ve&&Fi&&Si?.8:0,yn(Fi?li:p.stencilModeForClipping(xi))}};let Te=p.depthModeForSublayer(0,ki.ReadOnly);const qe=new ki(p.depthOcclusion?X.GREATER:X.LEQUAL,ki.ReadOnly,p.depthRangeFor3D);if(a.hasNonElevatedBuckets){const si=!_t&&p.terrain;M!==0&&si?i.w(`Occlusion opacity for layer ${a.id} is supported on terrain only if the layer has line-z-offset enabled.`):si?i.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${a.id}.`):Oe(f,ge,Te,hr.disabled,!1,!0)}if(a.hasElevatedBuckets){L==="hd-road-markup"?Z||(Te=qe,ge.push("ELEVATED_ROADS")):(ge.push("ELEVATED"),Te=qe,rt&&ge.push(ht?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),V&&ge.push("ELEVATION_REFERENCE_SEA"));const si=ve?p.stencilModeFor3D():hr.disabled;p.forceTerrainMode=!0,Oe(f,ge,Te,si,!0,!0),ve&&Oe(f,ge,Te,si,!0,!1),p.forceTerrainMode=!1}ve&&(p.resetStencilClippingMasks(),_t&&U.clear({stencil:0})),M===0||p.depthOcclusion||_t||p.layersWithOcclusionOpacity.push(p.currentLayer)},fill:function(p,e,a,f){const y=a.paint.get("fill-color"),w=a.paint.get("fill-opacity");if(w.constantOr(1)===0)return;const I=a.paint.get("fill-emissive-strength"),M=p.colorModeForDrapableLayerRenderPass(I),L=a.paint.get("fill-pattern"),N=p.opaquePassEnabledForLayer()&&!L.constantOr(1)&&y.constantOr(i.ao.transparent).a===1&&w.constantOr(0)===1?"opaque":"translucent";let V="none";a.layout.get("fill-elevation-reference")!=="none"?V="road":a.paint.get("fill-z-offset").constantOr(1)!==0&&(V="offset");const Z=!(!p.terrain||!p.terrain.enabled),U={painter:p,sourceCache:e,layer:a,coords:f,colorMode:M,elevationType:V,terrainEnabled:Z,pass:N};if(p.renderPass!=="shadow")if(V!=="offset"){if(Ko(U,!1),V==="road"){const X=!Z&&p.renderPass==="translucent";X&&po(p,e,a,f,"geometry"),Ko(U,!0,hr.disabled),X&&function(K){const{painter:rt,sourceCache:ht,layer:lt,coords:_t,colorMode:Mt}=K,vt=rt.context.gl,Ut=K.painter.shadowRenderer,Ct=!!Ut&&Ut.enabled,$t=new ki(rt.context.gl.LEQUAL,ki.ReadOnly,rt.depthRangeFor3D);let Ot=[0,0,0];if(Ct){const Zt=rt.style.directionalLight,pe=rt.style.ambientLight;Zt&&pe&&(Ot=_l(rt.style,Zt,pe))}const Rt=Zt=>{for(const pe of _t){const le=ht.getTile(pe),Me=le.getBucket(lt);if(!Me)continue;const ve=Me.elevatedStructures;if(!ve)continue;let Be,oi;if(Zt?(Be=ve.renderableBridgeSegments,oi=ve.bridgeProgramConfigurations.get(lt.id)):(Be=ve.renderableTunnelSegments,oi=ve.tunnelProgramConfigurations.get(lt.id)),!Be||Be.segments[0].primitiveLength===0)continue;oi.updatePaintBuffers(),rt.prepareDrawTile();const ge=rt.isTileAffectedByFog(pe),ie=[];Ct&&ie.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Oe=rt.getOrCreateProgram("elevatedStructures",{config:oi,overrideFog:ge,defines:ie}),Te=rt.translatePosMatrix(pe.projMatrix,le,lt.paint.get("fill-translate"),lt.paint.get("fill-translate-anchor"));Ct&&Ut.setupShadows(le.tileID.toUnwrapped(),Oe,"vector-tile");const qe=lh(Te,Ot);rt.uploadCommonUniforms(rt.context,Oe,pe.toUnwrapped()),Oe.draw(rt,vt.TRIANGLES,$t,hr.disabled,Mt,rr.backCCW,qe,lt.id,ve.vertexBuffer,ve.indexBuffer,Be,lt.paint,rt.transform.zoom,oi,[ve.vertexBufferNormal])}};Rt(!0),Rt(!1)}(U)}}else Ko(U,!1,p.stencilModeFor3D());else p.shadowRenderer&&V==="road"&&!Z&&function(X){const{painter:K,sourceCache:rt,layer:ht,coords:lt}=X,_t=K.context.gl,Mt=X.painter.shadowRenderer;for(const vt of lt){const Ut=rt.getTile(vt),Ct=Ut.getBucket(ht);if(!Ct)continue;const $t=Ct.elevatedStructures;if(!$t||!$t.shadowCasterSegments||$t.shadowCasterSegments.segments[0].primitiveLength===0)continue;K.prepareDrawTile();const Ot=Ct.bufferData.programConfigurations.get(ht.id),Rt=K.isTileAffectedByFog(vt),Zt=K.getOrCreateProgram("elevatedStructuresDepth",{config:Ot,overrideFog:Rt}),pe=Mt.calculateShadowPassMatrixFromTile(Ut.tileID.toUnwrapped());K.uploadCommonUniforms(K.context,Zt,vt.toUnwrapped());const le={u_matrix:pe,u_depth_bias:0};Zt.draw(K,_t.TRIANGLES,Mt.getShadowPassDepthMode(),hr.disabled,Mt.getShadowPassColorMode(),rr.disabled,le,ht.id,$t.vertexBuffer,$t.indexBuffer,$t.shadowCasterSegments,ht.paint,K.transform.zoom,Ot)}}(U)},"fill-extrusion":function(p,e,a,f){const y=a.paint.get("fill-extrusion-opacity"),w=p.context,I=w.gl,M=p.terrain,L=M&&M.renderingToTexture;if(y===0)return;const N=p.conflationActive&&p.style.isLayerClipped(a,e.getSource()),V=p.style.order.indexOf(a.fqid);if(N&&function(Z,U,X,K,rt){for(const ht of K){const lt=U.getTile(ht).getBucket(X);lt&&(lt.updateReplacement(ht,Z.replacementSource,rt),lt.uploadCentroid(Z.context))}}(p,e,a,f,V),M||N)for(const Z of f){const U=e.getTile(Z).getBucket(a);U&&Gc(p.context,e,Z,U,a,M,N)}if(p.renderPass==="shadow"&&p.shadowRenderer){const Z=p.shadowRenderer;if(M&&y<.65&&a._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof i.ad)return;const U=Z.getShadowPassDepthMode(),X=Z.getShadowPassColorMode();Ei(p,e,a,f,U,hr.disabled,X,N)}else if(p.renderPass==="translucent"){const Z=!a.paint.get("fill-extrusion-pattern").constantOr(1),U=a.paint.get("fill-extrusion-color").constantOr(i.ao.white);if(!L&&U.a!==0){const X=new ki(p.context.gl.LEQUAL,ki.ReadWrite,p.depthRangeFor3D);y===1&&Z?Ei(p,e,a,f,X,hr.disabled,Sr.unblended,N):(Ei(p,e,a,f,X,hr.disabled,Sr.disabled,N),Ei(p,e,a,f,X,p.stencilModeFor3D(),p.colorModeForRenderPass(),N),p.resetStencilClippingMasks())}if(p.style.enable3dLights()&&Z&&(!M&&p.transform.projection.name!=="globe"||L)){const X=a.paint.get("fill-extrusion-opacity"),K=a.paint.get("fill-extrusion-ambient-occlusion-intensity"),rt=a.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),ht=a.paint.get("fill-extrusion-flood-light-intensity"),lt=a.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",_t=a.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(lt?null:a.lut).toArray01().slice(0,3),Mt=K>0&&rt>0,vt=ht>0,Ut=(Ot,Rt,Zt)=>(1-Zt)*Ot+Zt*Rt,Ct=new Iu;Ct.translate=a.paint.get("fill-extrusion-translate"),Ct.translateAnchor=a.paint.get("fill-extrusion-translate-anchor"),Ct.edgeRadius=a.layout.get("fill-extrusion-edge-radius"),Ct.cutoffFadeRange=a.paint.get("fill-extrusion-cutoff-fade-range");const $t=Ot=>{const Rt=p.depthModeForSublayer(1,ki.ReadOnly,I.LEQUAL,!0),Zt=a.paint.get(Ot?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),pe=Ut(.1,3,Zt),le=p._showOverdrawInspector;if(!le){const Me=new hr({func:I.ALWAYS,mask:255},255,255,I.KEEP,I.KEEP,I.REPLACE),ve=new Sr([I.ONE,I.ONE,I.ONE,I.ONE],i.ao.transparent,[!1,!1,!1,!0],I.MIN);Bl(Ct,p,e,a,f,Rt,Me,ve,rr.disabled,Ot,"sdf",X,K,rt,ht,_t,pe,N,!1)}{const Me=le?hr.disabled:new hr({func:I.EQUAL,mask:255},255,255,I.KEEP,I.DECR,I.DECR),ve=le?p.colorModeForRenderPass():new Sr([I.ONE_MINUS_DST_ALPHA,I.DST_ALPHA,I.ONE,I.ONE],i.ao.transparent,[!0,!0,!0,!0]);Bl(Ct,p,e,a,f,Rt,Me,ve,rr.disabled,Ot,"color",X,K,rt,ht,_t,pe,N,!1)}};if(L){const Ot=(Rt,Zt,pe)=>{const le=p.depthModeForSublayer(1,ki.ReadOnly,I.LEQUAL,!1),Me=a.paint.get(Rt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ve=Ut(.1,3,Me);{const Be=new Sr([I.ONE,I.ONE,I.ONE,I.ONE],i.ao.transparent,[!1,!1,!1,!0]);Bl(Ct,p,e,a,f,le,hr.disabled,Be,rr.disabled,Rt,"clear",X,K,rt,ht,_t,ve,N,Zt)}{const Be=new hr({func:I.ALWAYS,mask:255},255,255,I.KEEP,I.KEEP,I.REPLACE),oi=new Sr([I.ONE,I.ONE,I.ONE,I.ONE],i.ao.transparent,[!1,!1,!1,!0],I.MIN);Bl(Ct,p,e,a,f,le,Be,oi,rr.disabled,Rt,"sdf",X,K,rt,ht,_t,ve,N,Zt)}{const Be=Rt?I.ZERO:I.ONE_MINUS_DST_ALPHA,oi=new hr({func:I.EQUAL,mask:255},255,255,I.KEEP,I.DECR,I.DECR),ge=new Sr([Be,I.DST_ALPHA,I.ONE_MINUS_DST_ALPHA,I.ZERO],i.ao.transparent,[!0,!0,!0,!0]);Bl(Ct,p,e,a,f,le,oi,ge,rr.disabled,Rt,"color",X,K,rt,ht,_t,ve,N,Zt)}{const Be=new Sr([I.ONE,I.ONE,I.ONE,Rt?I.ZERO:I.ONE],i.ao.transparent,[!1,!1,!1,!0],Rt?I.FUNC_ADD:I.MAX);Bl(Ct,p,e,a,f,le,hr.disabled,Be,rr.disabled,Rt,"clear",X,K,rt,ht,_t,ve,N,Zt,pe)}};if(Mt||vt){let Rt;if(p.prepareDrawTile(),M){const Zt=M.drapeBufferSize[0],pe=M.drapeBufferSize[1];Rt=M.framebufferCopyTexture,Rt&&(!Rt||Rt.size[0]===Zt&&Rt.size[1]===pe)||(Rt&&Rt.destroy(),Rt=M.framebufferCopyTexture=new i.T(w,new i.q({width:Zt,height:pe}),I.RGBA8)),Rt.bind(I.LINEAR,I.CLAMP_TO_EDGE),I.copyTexSubImage2D(I.TEXTURE_2D,0,0,0,0,0,Zt,pe)}Mt&&Ot(!0,!1,Rt),vt&&Ot(!1,!0,Rt)}}else Mt&&$t(!0),vt&&$t(!1),(Mt||vt)&&p.resetStencilClippingMasks()}}},building:function(p,e,a,f){p.currentLayer<p.firstLightBeamLayer&&(p.firstLightBeamLayer=p.currentLayer);const y=a.paint.get("building-ambient-occlusion-ground-intensity"),w=a.paint.get("building-ambient-occlusion-ground-radius"),I=a.paint.get("building-ambient-occlusion-ground-attenuation"),M=a.paint.get("building-opacity");if(M<=0)return;let L=y>0&&w>0,N=!0;const V=a.paint.get("building-vertical-scale");if(V<=0)return;(!p.shadowRenderer||V<1)&&(N=!1);const Z=p.conflationActive&&p.style.isLayerClipped(a,e.getSource()),U=p.style.order.indexOf(a.fqid);if(function(X,K,rt,ht,lt,_t){for(const Mt of _t){const vt=K.getTile(Mt).getBucket(rt);vt&&(lt&&vt.updateReplacement(Mt,X.replacementSource,ht),vt.uploadUpdatedIndexBuffer(X.context))}}(p,e,a,U,Z,f),function(X,K,rt,ht){for(const lt of ht){const _t=K.getTile(lt).getBucket(rt);_t&&_t.needsEvaluation()&&_t.uploadUpdatedColorBuffer(X.context)}}(p,e,a,f),a.resetLayerRenderingStats(p),p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!0),p.renderPass==="shadow"&&p.shadowRenderer){const X=p.shadowRenderer,K=[],rt=X.getShadowPassDepthMode();Eu({painter:p,source:e,layer:a,coords:f,defines:K,blendMode:X.getShadowPassColorMode(),depthMode:rt,opacity:M,verticalScale:V,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(p.renderPass==="translucent"){let X=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];N&&(X=X.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),p.shadowRenderer&&p.shadowRenderer.useNormalOffset&&(X=X.concat("NORMAL_OFFSET"));const K=a.paint.get("building-facade-emissive-chance"),rt=a.paint.get("building-ambient-occlusion-intensity"),ht=a.paint.get("building-flood-light-intensity"),lt=a.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",_t=a.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(lt?null:a.lut).toArray01().slice(0,3),Mt=a.paint.get("building-flood-light-ground-attenuation"),vt=ht>0,Ut=new ki(p.context.gl.LEQUAL,ki.ReadWrite,p.depthRangeFor3D);M<1&&Eu({painter:p,source:e,layer:a,coords:f,defines:X,blendMode:Sr.disabled,depthMode:Ut,opacity:M,verticalScale:V,facadeEmissiveChance:K,facadeAOIntensity:rt,floodLightIntensity:ht,floodLightColor:_t,depthOnly:!0});const Ct=p.colorModeForRenderPass();Eu({painter:p,source:e,layer:a,coords:f,defines:X,blendMode:Ct,depthMode:Ut,opacity:M,verticalScale:V,facadeEmissiveChance:K,facadeAOIntensity:rt,floodLightIntensity:ht,floodLightColor:_t}),L&&Jh(p,e,a,f,!0,M,y,w,ht,_t,I,Z),vt&&Jh(p,e,a,f,!1,M,y,w,ht,_t,Mt,Z)}else if(p.renderPass==="light-beam"){const X=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],K=new ki(p.context.gl.LEQUAL,ki.ReadOnly,p.depthRangeFor3D);Eu({painter:p,source:e,layer:a,coords:f,defines:X,blendMode:Sr.alphaBlended,depthMode:K,opacity:M,verticalScale:V,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}p.shadowRenderer&&(p.shadowRenderer.useNormalOffset=!1),p.resetStencilClippingMasks()},hillshade:function(p,e,a,f){if(p.renderPass!=="offscreen"&&p.renderPass!=="translucent"||p.style.disableElevatedTerrain)return;const y=p.context,w=p.terrain&&p.terrain.renderingToTexture,[I,M]=p.renderPass!=="translucent"||w?[{},f]:p.stencilConfigForOverlap(f);for(const L of M){const N=e.getTile(L);if(N.needsHillshadePrepare&&p.renderPass==="offscreen")_p(p,N,a);else if(p.renderPass==="translucent"){const V=p.depthModeForSublayer(0,ki.ReadOnly),Z=a.paint.get("hillshade-emissive-strength"),U=p.colorModeForDrapableLayerRenderPass(Z),X=w&&p.terrain?p.terrain.stencilModeForRTTOverlap(L):I[L.overscaledZ];Cm(p,L,N,a,V,X,U)}}y.viewport.set([0,0,p.width,p.height]),p.resetStencilClippingMasks()},raster:function(p,e,a,f,y,w){if(p.renderPass!=="translucent"||a.paint.get("raster-opacity")===0)return;const I=p.transform.projection.name==="globe",M=a.paint.get("raster-elevation")!==0,L=M&&I;if(p.renderElevatedRasterBackface&&!L)return;const N=p.context,V=N.gl,Z=e.getSource(),U=function(Ct,$t,Ot,Rt){const Zt=$t.paint.get("raster-color"),pe=Ct.type==="raster-array",le=[],Me=$t.paint.get("raster-resampling"),ve=$t.paint.get("raster-color-mix");let Be=$t.paint.get("raster-color-range");const oi=[ve[0],ve[1],ve[2],0],ge=ve[3];let ie=Me==="nearest"?Rt.NEAREST:Rt.LINEAR;if(pe&&(le.push("RASTER_ARRAY"),Zt||le.push("RASTER_COLOR"),Me==="linear"&&le.push("RASTER_ARRAY_LINEAR"),ie=Rt.NEAREST,!Be&&Ct.rasterLayers)){const Oe=Ct.rasterLayers.find(({id:Te})=>Te===$t.sourceLayer);Oe&&Oe.fields&&Oe.fields.range&&(Be=Oe.fields.range)}if(Be=Be||[0,1],Zt){le.push("RASTER_COLOR"),Ot.activeTexture.set(Rt.TEXTURE2),$t.updateColorRamp(Be);let Oe=$t.colorRampTexture;Oe||(Oe=$t.colorRampTexture=new i.T(Ot,$t.colorRamp,Rt.RGBA8)),Oe.bind(Rt.LINEAR,Rt.CLAMP_TO_EDGE)}return{mix:oi,range:Be,offset:ge,defines:le,resampling:ie}}(Z,a,N,V);if(Z instanceof i.aT&&!f.length&&!I)return;const X=a.paint.get("raster-emissive-strength"),K=p.colorModeForDrapableLayerRenderPass(X),rt=p.terrain&&p.terrain.renderingToTexture,ht=!p.options.moving,lt=a.paint.get("raster-resampling")==="nearest"?V.NEAREST:V.LINEAR;if(Z instanceof i.aT&&!f.length&&(Z.onNorthPole||Z.onSouthPole)){const Ct=M?p.stencilModeFor3D():hr.disabled;return void Kh(!!Z.onNorthPole,null,p,e,a,X,U,rr.disabled,Ct)}if(!f.length)return;const[_t,Mt]=Z instanceof i.aT||rt?[{},f]:p.stencilConfigForOverlap(f),vt=Mt[Mt.length-1].overscaledZ;L&&U.defines.push("PROJECTION_GLOBE_VIEW"),M&&U.defines.push("RENDER_CUTOFF");const Ut=(Ct,$t,Ot)=>{for(const Rt of Ct){const Zt=Rt.toUnwrapped(),pe=e.getTile(Rt);if(rt&&(!pe||!pe.hasData()))continue;N.activeTexture.set(V.TEXTURE0);const le=vf(pe,Z,a,U);if(!le||!le.texture)continue;const{texture:Me,mix:ve,offset:Be,tileSize:oi,buffer:ge}=le;let ie,Oe;rt?(ie=ki.disabled,Oe=Rt.projMatrix):M?(ie=new ki(V.LEQUAL,ki.ReadWrite,p.depthRangeFor3D),Oe=I?Float32Array.from(p.transform.expandedFarZProjMatrix):p.transform.calculateProjMatrix(Zt,ht)):(ie=p.depthModeForSublayer(Rt.overscaledZ-vt,a.paint.get("raster-opacity")===1?ki.ReadWrite:ki.ReadOnly,V.LESS),Oe=p.transform.calculateProjMatrix(Zt,ht));const Te=p.terrain&&rt?p.terrain.stencilModeForRTTOverlap(Rt):_t[Rt.overscaledZ],qe=w?0:a.paint.get("raster-fade-duration");pe.registerFadeDuration(qe);const si=e.findLoadedParent(Rt,0),Li=yu(pe,si,e,p.transform,qe);let ni,li;!Li.isFading&&pe.refreshedUponExpiration&&(pe.refreshedUponExpiration=!1),p.terrain&&p.terrain.prepareDrawTile(),N.activeTexture.set(V.TEXTURE0),Me.bind(lt,V.CLAMP_TO_EDGE),N.activeTexture.set(V.TEXTURE1),si?(si.texture&&si.texture.bind(lt,V.CLAMP_TO_EDGE),ni=Math.pow(2,si.tileID.overscaledZ-pe.tileID.overscaledZ),li=[pe.tileID.canonical.x*ni%1,pe.tileID.canonical.y*ni%1]):Me.bind(lt,V.CLAMP_TO_EDGE),"useMipmap"in Me&&N.extTextureFilterAnisotropic&&p.transform.pitch>20&&V.texParameterf(V.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);const Fi=p.transform;let Si;const xi=M?Qh(Fi):[0,0,0,0];let Ai,Wi,Gr,en,kn,ur=0;if(L&&Z instanceof i.aT&&Z.coordinates.length>3)Ai=Float32Array.from(i.bj(i.dI(new i.cC(0,0,0)))),Wi=Float32Array.from(Fi.globeMatrix),Gr=Float32Array.from(i.dE(Fi)),en=[i.aF(Fi.center.lng),i.aJ(Fi.center.lat)],Si=Z.elevatedGlobePerspectiveTransform,kn=Z.elevatedGlobeGridMatrix||new Float32Array(9);else if(L){const Yr=i.dF(Rt.canonical);ur=i.dG(Yr.getCenter().lat),Ai=Float32Array.from(i.bj(i.dI(Rt.canonical))),Wi=Float32Array.from(Fi.globeMatrix),Gr=Float32Array.from(i.dE(Fi)),en=[i.aF(Fi.center.lng),i.aJ(Fi.center.lat)],Si=[0,0],kn=Float32Array.from(i.dH(Rt.canonical,Yr,ur,Fi.worldSize/Fi._pixelsPerMercatorPixel))}else Si=Z instanceof i.aT?Z.perspectiveTransform:[0,0],Ai=new Float32Array(16),Wi=new Float32Array(9),Gr=new Float32Array(16),en=[0,0],kn=new Float32Array(9);const Kr=wu(Oe,Ai,Wi,Gr,kn,li||[0,0],i.aj(p.transform.zoom),en,xi,ni||1,Li,a,Si,M?a.paint.get("raster-elevation"):0,2,ve,Be,U.range,oi,ge,X),Pr=p.isTileAffectedByFog(Rt),Mn=p.getOrCreateProgram("raster",{defines:U.defines,overrideFog:Pr});if(p.uploadCommonUniforms(N,Mn,Zt),Z instanceof i.aT){const Yr=Z.elevatedGlobeVertexBuffer,Zn=Z.elevatedGlobeIndexBuffer;if(rt||!I)Z.boundsBuffer&&Z.boundsSegments&&Mn.draw(p,V.TRIANGLES,ie,hr.disabled,K,rr.disabled,Kr,a.id,Z.boundsBuffer,p.quadTriangleIndexBuffer,Z.boundsSegments);else if(Yr&&Zn){const an=Fi.zoom<=i.cZ?Z.elevatedGlobeSegments:Z.getSegmentsForLongitude(Fi.center.lng);an&&Mn.draw(p,V.TRIANGLES,ie,hr.disabled,K,$t,Kr,a.id,Yr,Zn,an)}}else if(L){ie=new ki(V.LEQUAL,ki.ReadOnly,p.depthRangeFor3D);const Yr=p.globeSharedBuffers;if(Yr){const[Zn,an,Mr]=Yr.getGridBuffers(ur,!1);Mn.draw(p,V.TRIANGLES,ie,Ot||Te,p.colorModeForRenderPass(),$t,Kr,a.id,Zn,an,Mr)}}else{const{tileBoundsBuffer:Yr,tileBoundsIndexBuffer:Zn,tileBoundsSegments:an}=p.getTileBoundsBuffers(pe);Mn.draw(p,V.TRIANGLES,ie,Te,K,rr.disabled,Kr,a.id,Yr,Zn,an)}}if(!(Z instanceof i.aT)&&L)for(const Rt of Ct){const Zt=Rt.canonical.y===(1<<Rt.canonical.z)-1;Rt.canonical.y===0&&Kh(!0,Rt,p,e,a,X,U,$t,Ot||hr.disabled),Zt&&Kh(!1,Rt,p,e,a,X,U,$t===rr.frontCW?rr.backCW:rr.frontCW,Ot||hr.disabled)}};L?Ut(Mt,p.renderElevatedRasterBackface?rr.backCW:rr.frontCW,p.stencilModeFor3D()):Ut(Mt,rr.disabled,void 0),p.resetStencilClippingMasks()},"raster-particle":function(p,e,a,f,y,w){p.renderPass==="offscreen"&&function(I,M,L,N){if(!N.length)return;const V=I.context,Z=V.gl,U=M.getSource();if(!(U instanceof hs))return;const X=Math.ceil(Math.sqrt(L.paint.get("raster-particle-count")));let K=L.particlePositionRGBAImage;if(!K||K.width!==X){const Mt=function(vt){const Ut=vt*vt,Ct=new Uint8Array(4*Ut),$t=function(Rt){return Rt|=0,Rt=Math.imul(2747636419^Rt,2654435769),Rt=Math.imul(Rt^Rt>>>16,2654435769),((Rt=Math.imul(Rt^Rt>>>16,2654435769))>>>0)/4294967296},Ot=1/1.1;for(let Rt=0;Rt<Ut;Rt++){const Zt=Ot*($t(2*Rt+0)+Tu),pe=Ot*($t(2*Rt+1)+Tu),le=255*Zt%1,Me=255*pe%1,ve=le,Be=pe-Me/255,oi=Me;Ct[4*Rt+0]=255*(Zt-le/255),Ct[4*Rt+1]=255*ve,Ct[4*Rt+2]=255*Be,Ct[4*Rt+3]=255*oi}return Ct}(X);K=L.particlePositionRGBAImage=new i.q({width:X,height:X},Mt)}let rt=L.particleFramebuffer;rt?rt.width!==X&&(rt.destroy(),rt=L.particleFramebuffer=V.createFramebuffer(X,X,!0,null)):rt=L.particleFramebuffer=V.createFramebuffer(X,X,!0,null);const ht=[];for(const Mt of N){const vt=M.getTile(Mt);if(!(vt instanceof ms))continue;const Ut=ud(vt,U,L);if(!Ut)continue;const Ct=[vt.tileSize,vt.tileSize];let $t=L.tileFramebuffer;$t||($t=L.tileFramebuffer=V.createFramebuffer(Ct[0],Ct[1],!0,null));let Ot=vt.rasterParticleState;Ot||(Ot=vt.rasterParticleState=new Gs(V,Mt,Ct,K));const Rt=Ot.update(L.lastInvalidatedAt);Ot.particleTextureDimension!==X&&Ot.updateParticleTexture(Mt,K);const Zt=Ot.targetColorTexture;Ot.targetColorTexture=Ot.backgroundColorTexture,Ot.backgroundColorTexture=Zt;const pe=Ot.particleTexture0;Ot.particleTexture0=Ot.particleTexture1,Ot.particleTexture1=pe,ht.push([Mt,Ut,Ot,Rt])}if(ht.length===0)return;const lt=i.o.now(),_t=L.previousDrawTimestamp?.001*(lt-L.previousDrawTimestamp):.0167;if(L.previousDrawTimestamp=lt,L.hasColorMap()){V.activeTexture.set(Z.TEXTURE0+2);let Mt=L.colorRampTexture;Mt||(Mt=L.colorRampTexture=new i.T(V,L.colorRamp,Z.RGBA8)),Mt.bind(Z.LINEAR,Z.CLAMP_TO_EDGE)}V.bindFramebuffer.set(L.tileFramebuffer.framebuffer),function(Mt,vt,Ut){const Ct=Mt.context,$t=Ct.gl,Ot=vt.tileFramebuffer;Ct.activeTexture.set($t.TEXTURE0);const Rt={u_texture:0,u_opacity:1.05*(pe=vt.paint.get("raster-particle-fade-opacity-factor"))/(pe+.05)},Zt=Mt.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var pe;for(const le of Ut){const[,,Me,ve]=le;Ot.colorAttachment.set(Me.targetColorTexture.texture),Ct.viewport.set([0,0,Ot.width,Ot.height]),Ct.clear({color:i.ao.transparent}),ve&&(Me.backgroundColorTexture.bind($t.NEAREST,$t.CLAMP_TO_EDGE),Zt.draw(Mt,$t.TRIANGLES,ki.disabled,hr.disabled,Sr.alphaBlended,rr.disabled,Rt,vt.id,Mt.viewportBuffer,Mt.quadTriangleIndexBuffer,Mt.viewportSegments))}}(I,L,ht),function(Mt,vt,Ut,Ct){const $t=Mt.context,Ot=$t.gl,Rt=Ut.tileFramebuffer,Zt=Mt.transform.projection.name==="globe",pe=Ut.paint.get("raster-particle-max-speed");for(const le of Ct){const[Me,ve,Be]=le;$t.activeTexture.set(Ot.TEXTURE0+0),ve.texture.bind(Ot.LINEAR,Ot.CLAMP_TO_EDGE),Rt.colorAttachment.set(Be.targetColorTexture.texture);const oi=Mt.getOrCreateProgram("rasterParticleDraw",{defines:ve.defines,overrideFog:!1});$t.activeTexture.set(Ot.TEXTURE0+1);const ge=ve.scalarData?[]:[0,1,2,3].map(Te=>i.e8[Te](Me));ge.push(Me);const ie=Me.canonical.x,Oe=Me.canonical.y;for(const Te of ge){const qe=vt.getTile(Zt?Te.wrapped():Te);if(!qe)continue;const si=qe.rasterParticleState;if(!si)continue;const Li=Te.canonical.x+(1<<Te.canonical.z)*(Te.wrap-Me.wrap),ni=Te.canonical.y;si.particleTexture0.bind(Ot.NEAREST,Ot.CLAMP_TO_EDGE);const li=jc(1,si.particleTexture0.size[0],[Li-ie,ni-Oe],0,ve.texture.size,2,pe,ve.textureOffset,ve.scale,ve.offset);oi.draw(Mt,Ot.POINTS,ki.disabled,hr.disabled,Sr.alphaBlended,rr.disabled,li,Ut.id,si.particleIndexBuffer,void 0,si.particleSegment)}}}(I,M,L,ht),V.bindFramebuffer.set(L.particleFramebuffer.framebuffer),function(Mt,vt,Ut,Ct){const $t=Mt.context,Ot=$t.gl,Rt=vt.paint.get("raster-particle-max-speed"),Zt=Ct*vt.paint.get("raster-particle-speed-factor")*.15,pe=function(Me){return Math.pow(Me,6)}(.01+1*vt.paint.get("raster-particle-reset-rate-factor")),le=vt.particleFramebuffer;$t.viewport.set([0,0,le.width,le.height]);for(const Me of Ut){const[,ve,Be]=Me;$t.activeTexture.set(Ot.TEXTURE0+0),ve.texture.bind(Ot.LINEAR,Ot.CLAMP_TO_EDGE),$t.activeTexture.set(Ot.TEXTURE0+1);const oi=Be.particleTexture0;oi.bind(Ot.NEAREST,Ot.CLAMP_TO_EDGE);const ge=wo(1,oi.size[0],0,ve.texture.size,Rt,Zt,pe,ve.textureOffset,ve.scale,ve.offset);le.colorAttachment.set(Be.particleTexture1.texture),$t.clear({color:i.ao.transparent}),Mt.getOrCreateProgram("rasterParticleUpdate",{defines:ve.defines}).draw(Mt,Ot.TRIANGLES,ki.disabled,hr.disabled,Sr.unblended,rr.disabled,ge,vt.id,Mt.viewportBuffer,Mt.quadTriangleIndexBuffer,Mt.viewportSegments)}}(I,L,ht,_t)}(p,e,a,f),p.renderPass==="translucent"&&(function(I,M,L,N,V){const Z=I.context,U=Z.gl,X=M.getSource().tileSize,K=5*(1-i.ah(i.cK,i.cK+1,I.transform.zoom))*X+L.paint.get("raster-particle-elevation"),rt=!I.options.moving,ht=I.transform.projection.name==="globe";if(!N.length)return;const[lt,_t]=I.stencilConfigForOverlap(N),Mt=[];ht&&Mt.push("PROJECTION_GLOBE_VIEW");const vt=I.stencilModeFor3D();for(const Ut of _t){const Ct=Ut.toUnwrapped(),$t=M.getTile(Ut);if(!$t.rasterParticleState)continue;const Ot=$t.rasterParticleState,Rt=100;$t.registerFadeDuration(Rt);const Zt=M.findLoadedParent(Ut,0),pe=yu($t,Zt,M,I.transform,Rt);let le,Me;I.terrain&&I.terrain.prepareDrawTile(),Z.activeTexture.set(U.TEXTURE0),Ot.targetColorTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),Z.activeTexture.set(U.TEXTURE1),Zt&&Zt.rasterParticleState?(Zt.rasterParticleState.targetColorTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE),le=Math.pow(2,Zt.tileID.overscaledZ-$t.tileID.overscaledZ),Me=[$t.tileID.canonical.x*le%1,$t.tileID.canonical.y*le%1]):Ot.targetColorTexture.bind(U.LINEAR,U.CLAMP_TO_EDGE);const ve=ht?Float32Array.from(I.transform.expandedFarZProjMatrix):I.transform.calculateProjMatrix(Ct,rt),Be=I.transform,oi=pa(Be),ge=i.dF(Ut.canonical),ie=i.dG(ge.getCenter().lat);let Oe,Te,qe,si,Li;ht?(Oe=Float32Array.from(i.bj(i.dI(Ut.canonical))),Te=Float32Array.from(Be.globeMatrix),qe=Float32Array.from(i.dE(Be)),si=[i.aF(Be.center.lng),i.aJ(Be.center.lat)],Li=Float32Array.from(i.dH(Ut.canonical,ge,ie,Be.worldSize/Be._pixelsPerMercatorPixel))):(Oe=new Float32Array(16),Te=new Float32Array(9),qe=new Float32Array(16),si=[0,0],Li=new Float32Array(9));const ni=ch(ve,Oe,Te,qe,Li,Me||[0,0],i.aj(I.transform.zoom),si,oi,le||1,pe,K),li=I.isTileAffectedByFog(Ut),Fi=I.getOrCreateProgram("rasterParticle",{defines:Mt,overrideFog:li});if(I.uploadCommonUniforms(Z,Fi,Ct),ht){const Si=new ki(U.LEQUAL,ki.ReadOnly,I.depthRangeFor3D),xi=0,Ai=I.globeSharedBuffers;if(Ai){const[Wi,Gr,en]=Ai.getGridBuffers(ie,xi!==0);Fi.draw(I,U.TRIANGLES,Si,vt,Sr.alphaBlended,I.renderElevatedRasterBackface?rr.frontCCW:rr.backCCW,ni,L.id,Wi,Gr,en)}}else{const Si=I.depthModeForSublayer(0,ki.ReadOnly),xi=lt[Ut.overscaledZ],{tileBoundsBuffer:Ai,tileBoundsIndexBuffer:Wi,tileBoundsSegments:Gr}=I.getTileBoundsBuffers($t);Fi.draw(I,U.TRIANGLES,Si,xi,Sr.alphaBlended,rr.disabled,ni,L.id,Ai,Wi,Gr)}}I.resetStencilClippingMasks()}(p,e,a,f),p.style.map.triggerRepaint())},background:function(p,e,a,f){const y=a.paint.get("background-color"),w=a.paint.get("background-color-use-theme").constantOr("default")==="none",I=a.paint.get("background-opacity"),M=a.paint.get("background-emissive-strength"),L=a.paint.get("background-pitch-alignment")==="viewport";if(I===0)return;const N=p.context,V=N.gl,Z=p.transform,U=Z.tileSize,X=a.paint.get("background-pattern");let K;if(X!==void 0&&(X===null||(K=p.imageManager.getPattern(i.I.from(X.toString()),a.scope,p.style.getLut(a.scope)),!K)))return;const rt=!X&&y.a===1&&I===1&&p.opaquePassEnabledForLayer()?"opaque":"translucent";if(p.renderPass!==rt)return;const ht=hr.disabled,lt=p.depthModeForSublayer(0,rt==="opaque"?ki.ReadWrite:ki.ReadOnly),_t=p.colorModeForDrapableLayerRenderPass(M),Mt=X?"backgroundPattern":"background";let vt,Ut=f;if(Ut||(vt=p.getBackgroundTiles(),Ut=Object.values(vt).map(Ct=>Ct.tileID)),X&&(N.activeTexture.set(V.TEXTURE0),p.imageManager.bind(p.context,a.scope)),L){const Ct=p.getOrCreateProgram(Mt,{overrideFog:!1,overrideRtt:!0}),$t=new Float32Array(i.bz([])),Ot=new i.aP(0,0,0,0,0),Rt=X?ad($t,M,I,p,0,a.scope,K,L,{tileID:Ot,tileSize:U}):Zh($t,M,I,y.toPremultipliedRenderColor(w?null:a.lut));Ct.draw(p,V.TRIANGLES,lt,ht,_t,rr.disabled,Rt,a.id,p.viewportBuffer,p.quadTriangleIndexBuffer,p.viewportSegments)}else for(const Ct of Ut){const $t=p.isTileAffectedByFog(Ct),Ot=p.getOrCreateProgram(Mt,{overrideFog:$t}),Rt=Ct.toUnwrapped(),Zt=f?Ct.projMatrix:p.transform.calculateProjMatrix(Rt);p.prepareDrawTile();const pe=e?e.getTile(Ct):vt?vt[Ct.key]:new Uo(Ct,U,Z.zoom,p),le=X?ad(Zt,M,I,p,0,a.scope,K,L,{tileID:Ct,tileSize:U}):Zh(Zt,M,I,y.toPremultipliedRenderColor(w?null:a.lut));p.uploadCommonUniforms(N,Ot,Rt);const{tileBoundsBuffer:Me,tileBoundsIndexBuffer:ve,tileBoundsSegments:Be}=p.getTileBoundsBuffers(pe);Ot.draw(p,V.TRIANGLES,lt,ht,_t,rr.disabled,le,a.id,Me,ve,Be)}},sky:function(p,e,a){const f=p._atmosphere?i.aj(p.transform.zoom):1,y=a.paint.get("sky-opacity")*f;if(y===0)return;const w=p.context,I=a.paint.get("sky-type"),M=new ki(w.gl.LEQUAL,ki.ReadOnly,[0,1]),L=p.frameCounter/1e3%1;I==="atmosphere"?p.renderPass==="offscreen"?a.needsSkyboxCapture(p)&&(function(N,V,Z,U){const X=N.context,K=X.gl;let rt=V.skyboxFbo;if(!rt){rt=V.skyboxFbo=X.createFramebuffer(32,32,!0,null),V.skyboxGeometry=new mt(X),V.skyboxTexture=X.gl.createTexture(),K.bindTexture(K.TEXTURE_CUBE_MAP,V.skyboxTexture),K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_WRAP_S,K.CLAMP_TO_EDGE),K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_WRAP_T,K.CLAMP_TO_EDGE),K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_MIN_FILTER,K.LINEAR),K.texParameteri(K.TEXTURE_CUBE_MAP,K.TEXTURE_MAG_FILTER,K.LINEAR);for(let Mt=0;Mt<6;++Mt)K.texImage2D(K.TEXTURE_CUBE_MAP_POSITIVE_X+Mt,0,K.RGBA,32,32,0,K.RGBA,K.UNSIGNED_BYTE,null)}X.bindFramebuffer.set(rt.framebuffer),X.viewport.set([0,0,32,32]);const ht=V.getCenter(N,!0),lt=N.getOrCreateProgram("skyboxCapture"),_t=new Float64Array(16);i.bz(_t),i.em(_t,_t,.5*-Math.PI),dt(N,V,lt,_t,ht,0),i.bz(_t),i.em(_t,_t,.5*Math.PI),dt(N,V,lt,_t,ht,1),i.bz(_t),i.cT(_t,_t,.5*-Math.PI),dt(N,V,lt,_t,ht,2),i.bz(_t),i.cT(_t,_t,.5*Math.PI),dt(N,V,lt,_t,ht,3),i.bz(_t),dt(N,V,lt,_t,ht,4),i.bz(_t),i.em(_t,_t,Math.PI),dt(N,V,lt,_t,ht,5),X.viewport.set([0,0,N.width,N.height])}(p,a),a.markSkyboxValid(p)):p.renderPass==="sky"&&function(N,V,Z,U,X){const K=N.context,rt=K.gl,ht=N.transform,lt=N.getOrCreateProgram("skybox");K.activeTexture.set(rt.TEXTURE0),rt.bindTexture(rt.TEXTURE_CUBE_MAP,V.skyboxTexture);const _t=((Mt,vt,Ut,Ct,$t)=>({u_matrix:Mt,u_sun_direction:vt,u_cubemap:0,u_opacity:Ct,u_temporal_offset:$t}))(ht.skyboxMatrix,V.getCenter(N,!1),0,U,X);N.uploadCommonUniforms(K,lt),lt.draw(N,rt.TRIANGLES,Z,hr.disabled,N.colorModeForRenderPass(),rr.backCW,_t,"skybox",V.skyboxGeometry.vertexBuffer,V.skyboxGeometry.indexBuffer,V.skyboxGeometry.segment)}(p,a,M,y,L):I==="gradient"&&p.renderPass==="sky"&&function(N,V,Z,U,X){const K=N.context,rt=K.gl,ht=N.transform,lt=N.getOrCreateProgram("skyboxGradient");V.skyboxGeometry||(V.skyboxGeometry=new mt(K)),K.activeTexture.set(rt.TEXTURE0);let _t=V.colorRampTexture;_t||(_t=V.colorRampTexture=new i.T(K,V.colorRamp,rt.RGBA8)),_t.bind(rt.LINEAR,rt.CLAMP_TO_EDGE);const Mt=((vt,Ut,Ct,$t,Ot)=>({u_matrix:vt,u_color_ramp:0,u_center_direction:Ut,u_radius:i.an(Ct),u_opacity:$t,u_temporal_offset:Ot}))(ht.skyboxMatrix,V.getCenter(N,!1),V.paint.get("sky-gradient-radius"),U,X);N.uploadCommonUniforms(K,lt),lt.draw(N,rt.TRIANGLES,Z,hr.disabled,N.colorModeForRenderPass(),rr.backCW,Mt,"skyboxGradient",V.skyboxGeometry.vertexBuffer,V.skyboxGeometry.indexBuffer,V.skyboxGeometry.segment)}(p,a,M,y,L)},custom:function(p,e,a,f){const y=p.context,w=a.implementation;if(!p.transform.projection.unsupportedLayers||!p.transform.projection.unsupportedLayers.includes("custom")||p.terrain&&(p.terrain.renderingToTexture||p.renderPass==="offscreen")&&a.isDraped(e)){if(p.renderPass==="offscreen"){const I=w.prerender;if(I){if(p.setCustomLayerDefaults(),y.setColorMode(p.colorModeForRenderPass()),p.transform.projection.name==="globe"){const M=p.transform.pointMerc;I.call(w,y.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),i.aj(p.transform.zoom),[M.x,M.y],p.transform.pixelsPerMeterRatio)}else I.call(w,y.gl,p.transform.customLayerMatrix());y.setDirty(),p.setBaseState()}}else if(p.renderPass==="translucent"){if(p.terrain&&p.terrain.renderingToTexture){const M=w.renderToTile;if(M){const L=f[0].canonical,N={x:L.x+f[0].wrap*(w.wrapTileId?0:1<<L.z),y:L.y,z:L.z};y.setDepthMode(ki.disabled),y.setStencilMode(hr.disabled),y.setColorMode(p.colorModeForRenderPass()),p.setCustomLayerDefaults(),M.call(w,y.gl,N),y.setDirty(),p.setBaseState()}return}p.setCustomLayerDefaults(),y.setColorMode(p.colorModeForRenderPass()),y.setStencilMode(hr.disabled);const I=w.renderingMode==="3d"?new ki(p.context.gl.LEQUAL,ki.ReadWrite,p.depthRangeFor3D):p.depthModeForSublayer(0,ki.ReadOnly);if(y.setDepthMode(I),p.transform.projection.name==="globe"){const M=p.transform.pointMerc;w.render(y.gl,p.transform.customLayerMatrix(),p.transform.getProjection(),p.transform.globeToMercatorMatrix(),i.aj(p.transform.zoom),[M.x,M.y],p.transform.pixelsPerMeterRatio)}else w.render(y.gl,p.transform.customLayerMatrix());y.setDirty(),p.setBaseState(),y.bindFramebuffer.set(null)}}else i.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(p,e,a,f){if(p.renderPass==="opaque")return;const y=a.paint.get("model-opacity").constantOr(1),w=a.paint.get("model-elevation-reference"),I=w==="ground",M=w==="ground";if(y===0)return;const L=a.paint.get("model-cast-shadows");if(p.renderPass==="shadow"&&(!L||p.terrain&&y<.65&&a._transitionablePaint._values["model-opacity"].value.expression instanceof i.ad))return;const N=p.shadowRenderer,V=a.paint.get("model-receive-shadows");N&&(N.useNormalOffset=!0,V||(N.enabled=!1));const Z=()=>{N&&(N.useNormalOffset=!0,V||(N.enabled=!0))},U=e.getSource();if(p.renderPass==="light-beam"&&U.type!=="batched-model")return;if(U.type==="vector"||U.type==="geojson")return function(vt,Ut,Ct,$t,Ot){const Rt=vt.transform,Zt=Rt.projection.name==="globe",pe=Rt.getFreeCameraOptions().position;if(!vt.modelManager)return;const le=vt.modelManager;Ct.modelManager=le;const Me=vt.shadowRenderer;if(!Ct._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ve=Ct._unevaluatedLayout._values["model-id"],Be=Object.assign({},Ct.layout.get("model-id").parameters),oi=vt.style.order.indexOf(Ct.fqid);for(const ge of $t){const ie=Ut.getTile(ge).getBucket(Ct);if(!ie||ie.projection.name!==Rt.projection.name)continue;const Oe=ie.getModelUris();if(Oe&&!ie.modelsRequested&&(le.addModelsFromBucket(Oe,Ot),ie.modelsRequested=!0),Zt)Be.zoom=ge.overscaledZ;else{const Si=Oi(ge,Rt);Be.zoom=Si}const Te=ve.possiblyEvaluate(Be);if(ii(vt,ie,ge),Ri.shadowUniformsInitialized=!1,Ri.useSingleShadowCascade=!!Me&&Me.getMaxCascadeForTile(ge.toUnwrapped())===0,vt.renderPass==="shadow"&&Me){if(vt.currentShadowCascade===1&&ie.isInsideFirstShadowMapFrustum)continue;const Si=Rt.calculatePosMatrix(ge.toUnwrapped(),Rt.worldSize);if(Ri.tileMatrix.set(Si),Ri.shadowTileMatrix=Float32Array.from(Me.calculateShadowPassMatrixFromMatrix(Si)),Ri.aabb.min=[0,0,0],Ri.aabb.max[0]=Ri.aabb.max[1]=i.al,Ri.aabb.max[2]=0,tn(ie,Ri,vt,Ct.scope))continue}const qe=1<<ge.canonical.z,si=[((pe.x-ge.wrap)*qe-ge.canonical.x)*i.al,(pe.y*qe-ge.canonical.y)*i.al,pe.z*qe*i.al];vt.conflationActive&&Object.keys(ie.instancesPerModel).length>0&&vt.style.isLayerClipped(Ct,Ut.getSource())&&ie.updateReplacement(ge,vt.replacementSource,oi,Ot)&&(ie.uploaded=!1,ie.upload(vt.context));let Li=0;const ni=new Array,li=new Array,Fi=new Array;for(let Si in ie.instancesPerModel){const xi=ie.instancesPerModel[Si];xi.features.length>0&&!Zt&&(Si=Te.evaluate(xi.features[0].feature,{}));const Ai=le.getModel(Si,Ot);if(Ai||le.hasURLBeenRequested(Si)||ie.modelUris.includes(Si)||(ie.modelUris.push(Si),ie.modelsRequested=!1),Ai&&Ai.uploaded)if(Zt){const Wi=i.c4([],[pe.x,pe.y,pe.z],vt.transform.worldSize);i.ev(Wi,Wi);for(let Gr=0;Gr<xi.instancedDataArray.length;++Gr){const en=[0,0,0],kn=[1,1,1],ur=i.ew(),Kr=xi.tileCoordinatesForInstance(Gr),Pr=xi.transformForInstance(Gr);i.ex(kn,Pr),i.ey(ur,Pr),i.ez(en,ur);const Mn=xi.translationForInstance(Gr),Yr=new i.aS(0,0);i.eA(ie.canonical,Yr,Kr.x,Kr.y);const Zn=i.bB();i.eB(Zn,Ai,vt.transform,Yr,en,kn,Mn,!0,!1,!1);const an=xi.colorForInstance(Gr),Mr=i.bz([]),_n=i.ee(Yr.lat,vt.transform.zoom),Lr=i.bp([],[1,1,1/_n]);i.bq(Mr,Mr,Wi),Fi.push({zScaleMatrix:Lr,negCameraPosMatrix:Mr});for(const fo of Ai.nodes)de(vt,fo,Zn,vt.transform.expandedFarZProjMatrix,Li,ni,li,Ai.materialOverrides,an);++Li}}else for(const Wi of Ai.nodes)Ti(vt,Ct,Wi,xi,si,ge,Ri)}if(Zt)if(vt.renderPass==="shadow"){for(const Si of li)Ce(Si.mesh,Si.nodeModelMatrix,vt,Ct);for(const Si of ni)Ce(Si.mesh,Si.nodeModelMatrix,vt,Ct)}else Je(vt,Ct,1,ni,li,Fi)}}(p,e,a,f,be(U,a,p.style._importedAsBasemap)),void Z();if(!U.loaded())return;if(U.type==="batched-model")return function(vt,Ut,Ct,$t){Ct.resetLayerRenderingStats(vt);const Ot=vt.context,Rt=vt.transform,Zt=vt.style.fog,pe=vt.shadowRenderer;if(Rt.projection.name!=="mercator")return void i.w(`Drawing 3D landmark models for ${Rt.projection.name} projection is not yet implemented`);const le=vt.transform.getFreeCameraOptions().position,Me=i.c4([],[le.x,le.y,le.z],vt.transform.worldSize),ve=i.ev([],Me),Be=i.bz([]),oi=i.ee(Rt.center.lat,Rt.zoom),ge=i.bp([],[1,1,1/oi]);i.bq(Be,Be,ve);const ie=Ct.paint.get("model-opacity").constantOr(1),Oe=new ki(Ot.gl.LEQUAL,ki.ReadWrite,vt.depthRangeFor3D),Te=new ki(Ot.gl.LEQUAL,ki.ReadOnly,vt.depthRangeFor3D),qe=new i.d8([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),si=vt.renderPass==="shadow",Li=si&&pe?pe.getCurrentCascadeFrustum():Rt.getFrustum(Rt.scaleZoom(Rt.worldSize)),ni=Ct.paint.get("model-front-cutoff"),li=ni[2]<1,Fi=ha(vt,Ct.paint.get("model-cutoff-fade-range")),Si=Ct.getLayerRenderingStats();(function(xi,Ai,Wi,Gr){const en=xi.terrain?xi.terrain.exaggeration():0,kn=xi.transform.zoom;for(const ur of Gr){const Kr=Ai.getTile(ur).getBucket(Wi);Kr&&(Kr.setFilter(Wi.filter),xi.conflationActive&&Kr.updateReplacement(ur,xi.replacementSource),Kr.evaluateTransform(xi,Wi),xi.terrain&&en>0&&Kr.elevationUpdate(xi.terrain,en,ur,Wi.source),Kr.needsReEvaluation(xi,kn,Wi)&&Kr.evaluate(Wi))}})(vt,Ut,Ct,$t),function(){let xi,Ai,Wi;li?(xi=$t.length-1,Ai=-1,Wi=-1):(xi=0,Ai=$t.length,Wi=1);const Gr=new Float64Array(16),en=i.cz(),kn=new i.P(0,0);for(let ur=xi;ur!==Ai;ur+=Wi){const Kr=$t[ur],Pr=Ut.getTile(Kr).getBucket(Ct);if(!Pr||!Pr.uploaded)continue;let Mn=!1;pe&&(Mn=pe.getMaxCascadeForTile(Kr.toUnwrapped())===0);const Yr=Rt.calculatePosMatrix(Kr.toUnwrapped(),Rt.worldSize),Zn=Pr.modelTraits;!si&&li&&(i.bk(Gr,Yr),i.af(en,Me,Gr),kn.x=en[0],kn.y=en[1]);const an=[];Pr.setFilter(Ct.filter);for(const Mr of Pr.getNodesInfo()){if(Mr.hiddenByReplacement||!Mr.node.meshes)continue;const _n=Mr.node;let Lr=0;vt.terrain&&_n.elevation&&(Lr=_n.elevation*vt.terrain.exaggeration());const fo=(()=>{const Va=Mr.aabb;return qe.min=[...Va.min],qe.max=[...Va.max],qe.min[2]+=Lr,qe.max[2]+=Lr,i.af(qe.min,qe.min,Yr),i.af(qe.max,qe.max,Yr),qe})(),yn=Mr.evaluatedScale;if(yn[0]<=1&&yn[1]<=1&&yn[2]<=1&&fo.intersects(Li)===0)continue;if(!si&&li){const Va=.16666666666666666;Mr.cameraCollisionOpacity=Me[0]>fo.min[0]&&Me[0]<fo.max[0]&&Me[1]>fo.min[1]&&Me[1]<fo.max[1]&&Me[2]*oi<fo.max[2]&&_n.footprint&&i.b$(kn,_n.footprint)?Math.max(Mr.cameraCollisionOpacity-Va,0):Math.min(1,Mr.cameraCollisionOpacity+Va)}const mr=[...Yr],nn=1/i.d6(Kr.canonical),So=_n.anchor?_n.anchor[0]:0,Yo=_n.anchor?_n.anchor[1]:0;i.bq(mr,mr,[So*(yn[0]-1)+Mr.evaluatedTranslation[0]*nn,Yo*(yn[1]-1)+Mr.evaluatedTranslation[1]*nn,Lr+Mr.evaluatedTranslation[2]]),i.cp(yn,i.eD)||i.cR(mr,mr,yn);const Ro=i.aB([],mr,_n.globalMatrix),jo=i.aB([],Rt.expandedFarZProjMatrix,Ro),Io=i.aB([],Rt.expandedFarZProjMatrix,mr),fa=i.aC([],[So,Yo,Lr,1],jo)[2];_n.hidden=!1;let Pa=ie;si||(li&&(Pa*=Mr.cameraCollisionOpacity,Pa*=vo(mr,Rt,Mr.aabb,ni)),Pa*=Zr(Fi,fa)),Pa!==0?an.push({nodeInfo:Mr,depth:fa,opacity:Pa,wvpForNode:jo,wvpForTile:Io,nodeModelMatrix:Ro,tileModelMatrix:mr}):_n.hidden=!0}si||an.sort((Mr,_n)=>!li||Mr.opacity===1&&_n.opacity===1?Mr.depth<_n.depth?-1:1:Mr.opacity===1?-1:_n.opacity===1?1:Mr.depth>_n.depth?-1:1);for(const Mr of an){const _n=Mr.nodeInfo,Lr=_n.node;let fo=i.aB([],ge,Mr.tileModelMatrix);i.aB(fo,Be,fo);const yn=i.bk([],fo);i.ef(yn,yn),i.cR(yn,yn,br),fo=i.aB(fo,fo,Lr.globalMatrix);const mr=vt.renderPass==="light-beam",nn=Ct.paint.get("model-color-use-theme").constantOr("default")==="none",So=Zn&i.eH.HasMapboxMeshFeatures,Yo=So?0:_n.evaluatedRMEA[0][2];for(let Ro=0;Ro<Lr.meshes.length;++Ro){const jo=Lr.meshes[Ro],Io=Ro===Lr.lightMeshIndex;let fa=Mr.wvpForNode;if(Io){if(!mr&&!vt.terrain&&vt.shadowRenderer){vt.currentLayer<vt.firstLightBeamLayer&&(vt.firstLightBeamLayer=vt.currentLayer);continue}fa=Mr.wvpForTile}else if(mr)continue;const Pa={defines:[]},Va=[];if(!si&&pe&&(pe.useNormalOffset=!!jo.normalBuffer),he(Pa.defines,Va,jo,vt,nn?null:Ct.lut),So||Pa.defines.push("DIFFUSE_SHADED"),Mn&&Pa.defines.push("SHADOWS_SINGLE_CASCADE"),Si&&(si?Si.numRenderedVerticesInShadowPass+=jo.vertexArray.length:Si.numRenderedVerticesInTransparentPass+=jo.vertexArray.length),si){Ce(jo,Mr.nodeModelMatrix,vt,Ct);continue}let ic=null;if(Zt){const Go=_e(Mr.nodeModelMatrix,vt.transform);if(ic=new Float32Array(Go),Rt.projection.name!=="globe"){const jn=jo.aabb.min,Qo=jo.aabb.max,[Ls,go]=Zt.getOpacityForBounds(Go,jn[0],jn[1],Qo[0],Qo[1]);Pa.overrideFog=Ls>=xe||go>=xe}}const ma=jo.material;let vc;ma.occlusionTexture&&ma.occlusionTexture.offsetScale&&(vc=ma.occlusionTexture.offsetScale,Pa.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const bc=vt.getOrCreateProgram("model",Pa);!si&&pe&&pe.setupShadowsFromMatrix(Mr.tileModelMatrix,bc,pe.useNormalOffset),vt.uploadCommonUniforms(Ot,bc,null,ic);const qs=ma.pbrMetallicRoughness;qs.metallicFactor=.9,qs.roughnessFactor=.5;const mo=ld(new Float32Array(fa),new Float32Array(fo),new Float32Array(yn),new Float32Array(Lr.globalMatrix),vt,Mr.opacity,qs.baseColorFactor,ma.emissiveFactor,qs.metallicFactor,qs.roughnessFactor,ma,Yo,Ct,[0,0,0],vc);!Io&&(_n.hasTranslucentParts||Mr.opacity<1)&&bc.draw(vt,Ot.gl.TRIANGLES,Oe,hr.disabled,Sr.disabled,rr.backCCW,mo,Ct.id,jo.vertexBuffer,jo.indexBuffer,jo.segments,Ct.paint,vt.transform.zoom,void 0,Va),bc.draw(vt,Ot.gl.TRIANGLES,Io?Te:Oe,hr.disabled,Io||Mr.opacity<1||_n.hasTranslucentParts?Sr.alphaBlended:Sr.unblended,rr.backCCW,mo,Ct.id,jo.vertexBuffer,jo.indexBuffer,jo.segments,Ct.paint,vt.transform.zoom,void 0,Va)}}}}()}(p,e,a,f),void Z();if(U.type!=="model")return;const X=U.getModels(),K=[],rt=p.transform.getFreeCameraOptions().position,ht=i.c4([],[rt.x,rt.y,rt.z],p.transform.worldSize);i.ev(ht,ht);const lt=[],_t=[];let Mt=0;for(const vt of X){const Ut=e.getFeatureState("",vt.id),Ct={type:"Unknown",id:vt.id,properties:vt.featureProperties},$t=a.paint.get("model-rotation").evaluate(Ct,Ut),Ot=a.paint.get("model-scale").evaluate(Ct,Ut),Rt=a.paint.get("model-translation").evaluate(Ct,Ut);Qe(a,vt.id,Ut,vt.featureProperties,vt.nodeOverrideNames,vt.nodeOverrides),Xe(a,vt.id,Ut,vt.featureProperties,vt.materialOverrideNames,vt.materialOverrides),vt.nodeOverrides.size>0&&vt.computeBoundsAndApplyParent(),vt.computeModelMatrix(p,$t,Ot,Rt,M,I,!1);const Zt=i.bz([]),pe=i.ee(vt.position.lat,p.transform.zoom),le=i.bp([],[1,1,1/pe]);i.bq(Zt,Zt,ht),K.push({zScaleMatrix:le,negCameraPosMatrix:Zt});for(const Me of vt.nodes)de(p,Me,vt.matrix,p.transform.expandedFarZProjMatrix,Mt,lt,_t,vt.materialOverrides);Mt++}if(lt.sort((vt,Ut)=>Ut.depth-vt.depth),p.renderPass!=="shadow")Je(p,a,y,lt,_t,K),Z();else{for(const vt of _t)Ce(vt.mesh,vt.nodeModelMatrix,p,a);for(const vt of lt)Ce(vt.mesh,vt.nodeModelMatrix,p,a);Z()}}},ec={line:function(p,e,a){if(p.hasElevatedBuckets=!1,p.hasNonElevatedBuckets=!1,p._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||p._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(e){const f=e.getVisibleCoordinates();for(const y of f){const w=e.getTile(y).getBucket(p);if(w&&(w.elevationType!=="none"?p.hasElevatedBuckets=!0:p.hasNonElevatedBuckets=!0,p.hasElevatedBuckets&&p.hasNonElevatedBuckets))break}}}else p.hasNonElevatedBuckets=!0},model:function(p,e,a){const f=e.getSource();if(!f.loaded())return;if(f.type==="vector"||f.type==="geojson"){const w=be(f,p,a.style._importedAsBasemap);return void(a.modelManager&&a.modelManager.upload(a,w))}if(f.type==="batched-model"||f.type!=="model")return;const y=f.getModels();for(const w of y)w.upload(a.context)},raster:function(p,e,a){const f=e.getSource();if(!(f instanceof hs&&f.loaded()))return;const y=p.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!y)return;const w=p.paint.get("raster-array-band")||f.getInitialBand(y);if(w==null)return;const I=e.getIds().map(M=>e.getTileByID(M));for(const M of I)M.updateNeeded(p.id,w)&&f.prepareTile(M,y,p.id,w)},"raster-particle":function(p,e,a){const f=e.getSource();if(!(f instanceof hs&&f.loaded()))return;const y=p.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!y)return;const w=p.paint.get("raster-particle-array-band")||f.getInitialBand(y);if(w==null)return;const I=e.getIds().map(M=>e.getTileByID(M));for(const M of I)M.updateNeeded(p.id,w)&&f.prepareTile(M,y,p.id,w)}},qc={fill:po},ta={fill:function(p,e,a,f){if(!a.layout||a.layout.get("fill-elevation-reference")==="none"||a.paint.get("fill-opacity").constantOr(1)===0)return;const y=p.context.gl,w=new ki(y.LEQUAL,ki.ReadOnly,p.depthRangeFor3D),I=new hr({func:y.ALWAYS,mask:255},255,255,y.KEEP,y.KEEP,y.REPLACE),M=p.transform.getFreeCameraOptions().position,L=p.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const N of f){const V=e.getTile(N),Z=V.getBucket(a);if(!Z)continue;const U=Z.elevatedStructures;if(!U||U.depthSegments.segments[0].primitiveLength===0)continue;const X=cd(N.toUnwrapped(),M),K=p.translatePosMatrix(N.projMatrix,V,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor")),rt=nd(K,X,0,1,0);L.draw(p,y.TRIANGLES,w,I,Sr.disabled,rr.disabled,rt,a.id,U.vertexBuffer,U.indexBuffer,U.depthSegments,a.paint,p.transform.zoom)}}};class Bo{constructor(e,a,f,y,w,I){this.context=new Xh(e,a),this.transform=f,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=w,this._timeStamp=i.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const M=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const N of M)this._debugParams.enabledLayers[N]=!0;w.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),w.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),w.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),w.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),w.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),w.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const N of M)w.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],N);this.occlusionParams=new Xo(w),this.setup(),this.numSublayers=Xn.maxUnderzooming+Xn.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new i.eO,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new uu(this),this._wireframeDebugCache=new os,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const L=new i.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new i.T(this.context,L,e.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=y,this.worldview=I}updateTerrain(e,a){const f=!!e&&!!e.terrain&&this.transform.projection.supportsTerrain;if(!(f||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Nc(this,e));const y=this._terrain;this.transform.elevation=f?y:null,y.update(e,this.transform,a),this.transform.elevation&&!y.enabled&&(this.transform.elevation=null)}_updateFog(e){const a=e.fog;if(!a||this.transform.projection.name==="globe"||a.getOpacity(this.transform.pitch)<1||a.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[f,y]=a.getFovAdjustedRange(this.transform._fov);if(f>y)return void(this.transform.fogCullDistSq=null);const w=f+.78*(y-f);this.transform.fogCullDistSq=w*w}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(e){e&&!this._terrain&&(this._terrain=new Nc(this,this.style)),this._forceTerrainMode=e}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(e,a){if(this.width=e*i.o.devicePixelRatio,this.height=a*i.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const f of this.style.order)this.style._mergedLayers[f].resize()}setup(){const e=this.context,a=new i.bc;a.emplaceBack(0,0),a.emplaceBack(i.al,0),a.emplaceBack(0,i.al),a.emplaceBack(i.al,i.al),this.tileExtentBuffer=e.createVertexBuffer(a,i.be.members),this.tileExtentSegments=i.bf.simpleSegment(0,0,4,2);const f=new i.bc;f.emplaceBack(0,0),f.emplaceBack(i.al,0),f.emplaceBack(0,i.al),f.emplaceBack(i.al,i.al),this.debugBuffer=e.createVertexBuffer(f,i.be.members),this.debugSegments=i.bf.simpleSegment(0,0,4,5);const y=new i.bc;y.emplaceBack(-1,-1),y.emplaceBack(1,-1),y.emplaceBack(-1,1),y.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(y,i.be.members),this.viewportSegments=i.bf.simpleSegment(0,0,4,2);const w=new i.a$;w.emplaceBack(0,0,0,0),w.emplaceBack(i.al,0,i.al,0),w.emplaceBack(0,i.al,0,i.al),w.emplaceBack(i.al,i.al,i.al,i.al),this.mercatorBoundsBuffer=e.createVertexBuffer(w,i.bh.members),this.mercatorBoundsSegments=i.bf.simpleSegment(0,0,4,2);const I=new i.b0;I.emplaceBack(0,1,2),I.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(I);const M=new i.bd;for(const N of[0,1,3,2,0])M.emplaceBack(N);this.debugIndexBuffer=e.createIndexBuffer(M),this.emptyTexture=new i.T(e,new i.q({width:1,height:1},Uint8Array.of(0,0,0,0)),e.gl.RGBA8),this.identityMat=i.bB();const L=this.context.gl;this.stencilClearMode=new hr({func:L.ALWAYS,mask:0},0,255,L.ZERO,L.ZERO,L.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(e){return e._makeTileBoundsBuffers(this.context,this.transform.projection),e._tileBoundsBuffer?{tileBoundsBuffer:e._tileBoundsBuffer,tileBoundsIndexBuffer:e._tileBoundsIndexBuffer,tileBoundsSegments:e._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const e=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,e.TRIANGLES,ki.disabled,this.stencilClearMode,Sr.disabled,rr.disabled,$h(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(e,a,f){if(!a||this.currentStencilSource===a.id||!e.isTileClipped()||!f||f.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let M=!1;for(const L of f)if(this._tileClippingMaskIDs[L.key]===void 0){M=!0;break}if(!M)return}this.currentStencilSource=a.id;const y=this.context,w=y.gl;this.nextStencilID+f.length>256&&this.clearStencil(),y.setColorMode(Sr.disabled),y.setDepthMode(ki.disabled);const I=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const M of f){const L=a.getTile(M),N=this._tileClippingMaskIDs[M.key]=this.nextStencilID++,{tileBoundsBuffer:V,tileBoundsIndexBuffer:Z,tileBoundsSegments:U}=this.getTileBoundsBuffers(L);I.draw(this,w.TRIANGLES,ki.disabled,new hr({func:w.ALWAYS,mask:0},N,255,w.KEEP,w.KEEP,w.REPLACE),Sr.disabled,rr.disabled,$h(M.projMatrix),"$clipping",V,Z,U)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,a=this.context.gl;return new hr({func:a.NOTEQUAL,mask:255},e,255,a.KEEP,a.KEEP,a.REPLACE)}stencilModeForClipping(e){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(e);const a=this.context.gl;return new hr({func:a.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,a.KEEP,a.KEEP,a.REPLACE)}stencilConfigForOverlap(e){const a=this.context.gl,f=e.sort((I,M)=>M.overscaledZ-I.overscaledZ),y=f[f.length-1].overscaledZ,w=f[0].overscaledZ-y+1;if(w>1){this.currentStencilSource=void 0,this.nextStencilID+w>256&&this.clearStencil();const I={};for(let M=0;M<w;M++)I[M+y]=new hr({func:a.GEQUAL,mask:255},M+this.nextStencilID,255,a.KEEP,a.KEEP,a.REPLACE);return this.nextStencilID+=w,[I,f]}return[{[y]:hr.disabled},f]}colorModeForRenderPass(){const e=this.context.gl;return this._showOverdrawInspector?new Sr([e.CONSTANT_COLOR,e.ONE,e.CONSTANT_COLOR,e.ONE],new i.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Sr.unblended:Sr.alphaBlended}colorModeForDrapableLayerRenderPass(e){const a=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new Sr([a.ONE,a.ONE_MINUS_SRC_ALPHA,a.CONSTANT_ALPHA,a.ONE_MINUS_SRC_ALPHA],new i.ao(0,0,0,e===void 0?0:e),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(e,a,f,y=!1){if(this.depthOcclusion)return new ki(this.context.gl.GREATER,ki.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!y)return ki.disabled;const w=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new ki(f||this.context.gl.LEQUAL,a,[w,w])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const e=this.context.gl,a=Math.ceil(this.width),f=Math.ceil(this.height),y=this.context.bindFramebuffer.get(),w=e.getParameter(e.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===a&&this.depthFBO.height===f||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),a!==0&&f!==0&&(this.depthFBO=new Or(this.context,a,f,!1,"texture"),this.depthTexture=new i.T(this.context,{width:a,height:f,data:null},e.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(y),e.bindTexture(e.TEXTURE_2D,w),this.depthFBO&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),e.blitFramebuffer(0,0,a,f,0,0,a,f,e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((e,a)=>e+a/this._fpsHistory.length,0))}render(e,a){const f=i.o.now();this._dt=f-this._timeStamp,this._timeStamp=f,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=e.map.repaint,this.style=e,this.options=a;const y=this.style._mergedLayers,w=!(!this.terrain||!this.terrain.enabled),I=()=>this.style._getOrder(w).filter(ge=>{const ie=y[ge];return!(ie.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[ie.type]});let M=I(),L=!1,N=!1,V=null;for(const ge of M){const ie=y[ge];ie.type==="circle"?L=!0:ie.type==="building"?V=ie:ie.type==="symbol"&&(ie.hasOcclusionOpacityProperties?N=!0:L=!0)}let Z=M.map(ge=>y[ge]);const U=this.style._mergedSourceCaches;this.imageManager=e.imageManager,this.modelManager=e.modelManager,this.symbolFadeChange=e.placement.symbolFadeChange(i.o.now()),this.imageManager.beginFrame();let X=0,K=!1;for(const ge in U){const ie=U[ge];ie.used&&(ie.prepare(this.context),ie.getSource().usedInConflation&&++X)}let rt=!1;for(const ge of Z)ge.isHidden(this.transform.zoom)||(ge.type==="clip"&&(rt=!0),this.prepareLayer(ge));const ht={},lt={},_t={},Mt={},vt={};for(const ge in U){const ie=U[ge];ht[ge]=ie.getVisibleCoordinates(),lt[ge]=ht[ge].slice().reverse(),_t[ge]=ie.getVisibleCoordinates(!0).reverse(),Mt[ge]=ie.getShadowCasterCoordinates(),vt[ge]=ie.sortCoordinatesByDistance(ht[ge])}const Ut=ge=>{const ie=this.style.getLayerSourceCache(ge);return ie&&ie.used?ie.getSource():null};if(X||rt||this._clippingActiveLastFrame){const ge=[],ie=[];let Oe=0;for(const Te of Z)this.isSourceForClippingOrConflation(Te,Ut(Te))&&(ge.push(Te),ie.push(Oe)),Oe++;if(rt||ge.length>1||this._clippingActiveLastFrame){rt=!1;const Te=[];for(let qe=0;qe<ge.length;qe++){const si=ge[qe],Li=ie[qe],ni=this.style.getLayerSourceCache(si);if(!ni||!ni.used||!ni.getSource().usedInConflation&&si.type!=="clip"&&si.type!=="building")continue;let li=i.eP,Fi=i.bZ.None;const Si=[];let xi=!0;if(si.type==="building")li=i.eR;else if(si.type==="clip"){li=Li;for(const Ai of si.layout.get("clip-layer-types"))Fi|=Ai==="model"?i.bZ.Model:Ai==="symbol"?i.bZ.Symbol:i.bZ.FillExtrusion;for(const Ai of si.layout.get("clip-layer-scope"))Si.push(Ai);si.isHidden(this.transform.zoom)?xi=!1:rt=!0}xi&&Te.push({layer:si.fqid,cache:ni,order:li,clipMask:Fi,clipScope:Si})}this.replacementSource.setSources(Te),K=!0}}this._clippingActiveLastFrame=rt,K||this.replacementSource.clear(),this.conflationActive=K,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let ge=0;ge<Z.length;ge++){const ie=Z[ge],Oe=ie.cutoffRange();if(this.longestCutoffRange=Math.max(Oe,this.longestCutoffRange),Oe>0){const Te=Ut(ie);Te&&(this.minCutoffZoom=Math.max(Te.minzoom,this.minCutoffZoom)),ie.minzoom&&(this.minCutoffZoom=Math.max(ie.minzoom,this.minCutoffZoom))}ie.is3D(w)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=ge),this._lastOcclusionLayer=ge)}const Ct=this.style&&this.style.fog;Ct?(this._fogVisible=Ct.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=Ct.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(_t),this.opaquePassCutoff=0,M=I(),Z=M.map(ge=>y[ge]));const $t=this._shadowRenderer;if($t){$t.updateShadowParameters(this.transform,this.style.directionalLight);for(const ge in U)for(const ie of ht[ge]){let Oe={min:0,max:0};this.terrain&&(Oe=this.terrain.getMinMaxForTile(ie)||Oe),$t.addShadowReceiver(ie.toUnwrapped(),Oe.min,Oe.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new i.eQ(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Wt(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const Ot=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),Rt=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(Ot&&!this._snow&&(this._snow=new _c(this)),!Ot&&this._snow&&(this._snow.destroy(),delete this._snow),Rt&&!this._rain&&(this._rain=new tc(this)),!Rt&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),V){this.buildingTileBorderManager||(this.buildingTileBorderManager=new ft);const ge=this.style.getLayerSourceCache(V);this.buildingTileBorderManager.updateBorders(ge,V)}if(!On.has(this.context.gl))return;this.renderPass="offscreen";for(const ge of Z){const ie=e.getLayerSourceCache(ge);if(!ge.hasOffscreenPass()||ge.isHidden(this.transform.zoom))continue;const Oe=ie?lt[ie.id]:void 0;(ge.type==="custom"||ge.type==="raster"||ge.type==="raster-particle"||ge.isSky()||Oe&&Oe.length)&&this.renderLayer(this,ie,ge,Oe)}this.depthRangeFor3D=[0,1-(Z.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Mt)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const Zt=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),pe=(()=>{if(a.showOverdrawInspector)return i.ao.black;const ge=this.style.fog;if(ge&&this.transform.projection.supportsFog){const ie=this.style.getLut(ge.scope);if(!Zt){const Oe=ge.properties.get("color-use-theme")==="none",Te=ge.properties.get("color").toNonPremultipliedRenderColor(Oe?null:ie).toArray01();return new i.ao(...Te)}if(Zt){const Oe=ge.properties.get("space-color-use-theme")==="none",Te=ge.properties.get("space-color").toNonPremultipliedRenderColor(Oe?null:ie).toArray01();return new i.ao(...Te)}}return i.ao.transparent})();if(this.context.clear({color:pe,depth:1}),this.clearStencil(),this._showOverdrawInspector=a.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Zt&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=M.length-1;this.currentLayer>=0;this.currentLayer--){const ge=Z[this.currentLayer],ie=e.getLayerSourceCache(ge);if(ge.isSky())continue;const Oe=ie?(ge.is3D(w)?vt:lt)[ie.id]:void 0;this._renderTileClippingMasks(ge,ie,Oe),this.renderLayer(this,ie,ge,Oe)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&Zt&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||i.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<M.length;this.currentLayer++){const ge=Z[this.currentLayer],ie=e.getLayerSourceCache(ge);ge.isSky()&&this.renderLayer(this,ie,ge,ie?lt[ie.id]:void 0)}function le(ge,ie){let Oe;return ie&&(Oe=(ge.type==="symbol"?_t:ge.is3D(w)?vt:lt)[ie.id]),Oe}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<M.length;){const ge=Z[this.currentLayer];if(ge.type==="raster"||ge.type==="raster-particle"){const ie=e.getLayerSourceCache(ge);this.renderLayer(this,ie,ge,le(ge,ie))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Me=0;$t&&(Me=$t.getShadowCastingLayerCount());let ve=!1,Be=-1;for(let ge=0;ge<M.length;++ge){const ie=Z[ge];ie.isHidden(this.transform.zoom)||ie.is3D(w)&&(Be=ge)}N&&Be===-1&&(L=!0);let oi=!1;for(;this.currentLayer<M.length;){const ge=Z[this.currentLayer],ie=e.getLayerSourceCache(ge);if(ge.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(ge)){if(ge.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!oi&&ge.is3D(w)&&!w){const Oe=this.currentLayer,Te=qe=>{for(this.currentLayer=0;this.currentLayer<Z.length;this.currentLayer++){const si=Z[this.currentLayer];if(qc[si.type]){const Li=this.style.getLayerSourceCache(si);qc[si.type](this,Li,si,le(si,Li),qe)}}};Te("initialize"),Te("reset"),this.currentLayer=Oe,oi=!0}if(L&&!ve&&this.terrain&&!this.transform.isOrthographic&&(ve=!0,this.blitDepth()),N&&Be!==-1&&this.currentLayer===Be+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(ge,ie,ie?ht[ie.id]:void 0),this.renderLayer(this,ie,ge,le(ge,ie)),!this.terrain&&$t&&Me>0&&ge.hasShadowPass()&&--Me==0){{this.clearStencil(),this.resetStencilClippingMasks();const Oe=this.currentLayer;for(this.currentLayer=0;this.currentLayer<Z.length;this.currentLayer++){const Te=Z[this.currentLayer];if(ta[Te.type]){const qe=this.style.getLayerSourceCache(Te);ta[Te.type](this,qe,Te,le(Te,qe))}}this.currentLayer=Oe}if($t.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Oe=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Oe;this.currentLayer++){const Te=Z[this.currentLayer];if(!Te.hasLightBeamPass())continue;const qe=e.getLayerSourceCache(Te);this.renderLayer(this,qe,Te,qe?lt[qe.id]:void 0)}this.currentLayer=Oe,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Oe=this.currentLayer;this.depthOcclusion=!0;for(const Te of this.layersWithOcclusionOpacity){this.currentLayer=Te;const qe=Z[this.currentLayer],si=e.getLayerSourceCache(qe),Li=si?lt[si.id]:void 0;this.terrain||this._renderTileClippingMasks(qe,si,si?ht[si.id]:void 0),this.renderLayer(this,si,qe,Li)}this.depthOcclusion=!1,this.currentLayer=Oe,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let ge=null;Z.forEach(ie=>{const Oe=e.getLayerSourceCache(ie);Oe&&!ie.isHidden(this.transform.zoom)&&Oe.getVisibleCoordinates().length&&(!ge||ge.getSource().maxzoom<Oe.getSource().maxzoom)&&(ge=Oe)}),ge&&this.options.showTileBoundaries&&v(this,ge,ge.getVisibleCoordinates(),i.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&v(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new i.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(ge){const ie=ge.transform.padding;D(ge,ge.transform.height-(ie.top||0),3,gc),D(ge,ie.bottom||0,3,Zd),k(ge,ie.left||0,3,C),k(ge,ge.transform.width-(ie.right||0),3,s);const Oe=ge.transform.centerPoint;(function(Te,qe,si,Li){j(Te,qe-1,si-10,2,20,Li),j(Te,qe-10,si-1,20,2,Li)})(ge,Oe.x,ge.transform.height-Oe.y,d)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),K||(this.conflationActive=!1)}prepareLayer(e){this.gpuTimingStart(e);const{unsupportedLayers:a}=this.transform.projection,f=!a||!a.includes(e.type);if(ec[e.type]&&(f||this.terrain&&e.type==="custom")){const y=this.style.getLayerSourceCache(e);ec[e.type](e,y,this)}this.gpuTimingEnd()}renderLayer(e,a,f,y){f.isHidden(this.transform.zoom)||(f.type==="background"||f.type==="sky"||f.type==="custom"||f.type==="model"||f.type==="raster"||f.type==="raster-particle"||y&&y.length)&&(this.id=f.id,this.gpuTimingStart(f),e.transform.projection.unsupportedLayers&&e.transform.projection.unsupportedLayers.includes(f.type)&&(!e.terrain||f.type!=="custom")||f.type==="clip"||rl[f.type](e,a,f,y,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(e){if(!this.options.gpuTiming)return;const a=this.context.extTimerQuery,f=this.context.gl;let y=this.gpuTimers[e.id];y||(y=this.gpuTimers[e.id]={calls:0,cpuTime:0,query:f.createQuery()}),y.calls++,f.beginQuery(a.TIME_ELAPSED_EXT,y.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const e=this.context.extTimerQuery,a=this.context.gl,f=a.createQuery();this.deferredRenderGpuTimeQueries.push(f),a.beginQuery(e.TIME_ELAPSED_EXT,f)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const e=this.gpuTimers;return this.gpuTimers={},e}collectDeferredRenderGpuQueries(){const e=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],e}queryGpuTimers(e){const a={};for(const f in e){const y=e[f],w=this.context.extTimerQuery,I=w.getQueryParameter(y.query,this.context.gl.QUERY_RESULT)/1e6;w.deleteQueryEXT(y.query),a[f]=I}return a}queryGpuTimeDeferredRender(e){if(!this.options.gpuTimingDeferredRender)return 0;const a=this.context.gl;let f=0;for(const y of e)f+=a.getQueryParameter(y,a.QUERY_RESULT)/1e6,a.deleteQuery(y);return f}translatePosMatrix(e,a,f,y,w){if(!f[0]&&!f[1])return e;const I=w?y==="map"?this.transform.angle:0:y==="viewport"?-this.transform.angle:0;if(I){const N=Math.sin(I),V=Math.cos(I);f=[f[0]*V-f[1]*N,f[0]*N+f[1]*V]}const M=[w?f[0]:i.ay(a,f[0],this.transform.zoom),w?f[1]:i.ay(a,f[1],this.transform.zoom),0],L=new Float32Array(16);return i.bq(L,e,M),L}saveTileTexture(e){if(e.context!==this.context)return;const a=e.size[0],f=this._tileTextures[a];f?f.push(e):this._tileTextures[a]=[e]}getTileTexture(e){const a=this._tileTextures[e];return a&&a.length>0?a.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(e,a,f){const y=f===void 0?this.terrain&&this.terrain.renderingToTexture:f,w=[];return this.style&&this.style.enable3dLights()&&(e==="globeRaster"||e==="terrainRaster"?(w.push("LIGHTING_3D_MODE"),w.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):y||w.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||w.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(w.push("TERRAIN"),this.linearFloatFilteringSupported()&&w.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&w.push("GLOBE"),!this._fogVisible||y||a!==void 0&&!a||w.push("FOG","FOG_DITHERING"),y&&w.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&w.push("OVERDRAW_INSPECTOR"),w}getOrCreateProgram(e,a){this.cache=this.cache||{};const f=a&&a.defines||[],y=a&&a.config,w=this.currentGlobalDefines(e,a&&a.overrideFog,a&&a.overrideRtt).concat(f),I=Nd.cacheKey(Dd[e],e,w,y);return this.cache[I]||(this.cache[I]=new Nd(this.context,e,Dd[e],y,Jf[e],w)),this.cache[I]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new i.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(e,a){if(this.style.enable3dLights()){const f=this.style.directionalLight,y=this.style.ambientLight;if(f&&y){const w=((I,M,L)=>{const N=I.properties.get("direction"),V=I.properties.get("color-use-theme")==="none",Z=I.properties.get("color").toNonPremultipliedRenderColor(V?null:L.getLut(I.scope)).toArray01(),U=I.properties.get("intensity"),X=M.properties.get("color-use-theme")==="none",K=M.properties.get("color").toNonPremultipliedRenderColor(X?null:L.getLut(M.scope)).toArray01(),rt=M.properties.get("intensity"),ht=[N.x,N.y,N.z],lt=i.dM(K,rt),_t=i.dM(Z,U);return{u_lighting_ambient_color:lt,u_lighting_directional_dir:ht,u_lighting_directional_color:_t,u_ground_radiance:ns(ht,_t,lt)}})(f,y,this.style);a.setLightsUniformValues(e,w)}}}uploadCommonUniforms(e,a,f,y,w){if(this.uploadCommonLightUniforms(e,a),this.terrain&&this.terrain.renderingToTexture)return;const I=this.style.fog;if(I){const M=I.getOpacity(this.transform.pitch),L=((N,V,Z,U,X,K,rt,ht,lt,_t,Mt,vt)=>{const Ut=N.transform,Ct=V.properties.get("color-use-theme")==="none",$t=V.properties.get("color").toNonPremultipliedRenderColor(Ct?null:N.style.getLut(V.scope)).toArray01();$t[3]=U;const Ot=N.frameCounter/1e3%1,[Rt,Zt]=V.properties.get("vertical-range");return{u_fog_matrix:Z?Ut.calculateFogTileMatrix(Z):vt||N.identityMat,u_fog_range:V.getFovAdjustedRange(Ut._fov),u_fog_color:$t,u_fog_horizon_blend:V.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Rt,Zt),Zt],u_fog_temporal_offset:Ot,u_frustum_tl:X,u_frustum_tr:K,u_frustum_br:rt,u_frustum_bl:ht,u_globe_pos:lt,u_globe_radius:_t,u_viewport:Mt,u_globe_transition:i.aj(Ut.zoom),u_is_globe:+(Ut.projection.name==="globe")}})(this,I,f,M,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*i.o.devicePixelRatio,this.transform.height*i.o.devicePixelRatio],y);a.setFogUniformValues(e,L)}w&&a.setCutoffUniformValues(e,w.uniformValues)}setTileLoadedFlag(e){this.tileLoaded=e}saveCanvasCopy(){const e=this.canvasCopy();e&&(this.frameCopies.push(e),this.tileLoaded=!1)}canvasCopy(){const e=this.context.gl,a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,e.drawingBufferWidth,e.drawingBufferHeight,0),a}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const e=this.style&&this.style.fog;return!!e&&e.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const e=this._backgroundTiles,a=this._backgroundTiles={},f=this.transform.coveringTiles({tileSize:512});for(const y of f)a[y.key]=e[y.key]||new Uo(y,512,this.transform.tileZoom,this,void 0,this.worldview);return a}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(e,a){return!(!e.is3D(!(!this.terrain||!this.terrain.enabled))||e.type!=="clip"&&e.type!=="building"&&(e.minzoom&&e.minzoom>this.transform.zoom||(this.style._clipLayerPresent||e.sourceLayer!=="building"&&e.sourceLayer!=="procedural_buildings")&&(!a||a.type!=="batched-model")))}isTileAffectedByFog(e){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let a=this._cachedTileFogOpacities[e.key];return a||(this._cachedTileFogOpacities[e.key]=a=this.style.fog.getOpacityForTile(e)),a[0]>=xe||a[1]>=xe}setupDepthForOcclusion(e,a,f){const y=this.context,w=y.gl,I=!!f;var M;f||(f={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),y.activeTexture.set(w.TEXTURE3),e&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(w.NEAREST,w.CLAMP_TO_EDGE),f.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],f.u_depth_range_unpack=[2/((M=this.depthRangeFor3D)[1]-M[0]),-1-2*M[0]/(M[1]-M[0])],f.u_occluder_half_size=.5*this.occlusionParams.occluderSize,f.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(w.NEAREST,w.CLAMP_TO_EDGE),y.activeTexture.set(w.TEXTURE0),I||a.setTerrainUniformValues(y,f)}}function Oo(p,e){let a=!1,f=null;const y=()=>{f=null,a&&(p(),f=setTimeout(y,e),a=!1)};return()=>(a=!0,f||y(),f)}class ys{constructor(e){this._hashName=e&&encodeURIComponent(e),i.aX(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Oo(this._updateHashUnthrottled.bind(this),300)}addTo(e){return this._map=e,window.addEventListener("hashchange",this._onHashChange,!1),e.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const e=this._map;if(!e)return"";const a=Lo(e);if(this._hashName){const f=this._hashName;let y=!1;const w=location.hash.slice(1).split("&").map(I=>{const M=I.split("=")[0];return M===f?(y=!0,`${M}=${a}`):I}).filter(I=>I);return y||w.push(`${f}=${a}`),`#${w.join("&")}`}return`#${a}`}_getCurrentHash(){const e=location.hash.replace("#","");if(this._hashName){let a;return e.split("&").map(f=>f.split("=")).forEach(f=>{f[0]===this._hashName&&(a=f)}),(a&&a[1]||"").split("/")}return e.split("/")}_onHashChange(){const e=this._map;if(!e)return!1;const a=this._getCurrentHash();if(a.length>=3&&!a.some(f=>isNaN(Number(f)))){const f=e.dragRotate.isEnabled()&&e.touchZoomRotate.isEnabled()?+(a[3]||0):e.getBearing();return e.jumpTo({center:[+a[2],+a[1]],zoom:+a[0],bearing:f,pitch:+(a[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Lo(p,e){const a=p.getCenter(),f=Math.round(100*p.getZoom())/100,y=Math.ceil((f*Math.LN2+Math.log(512/360/.5))/Math.LN10),w=Math.pow(10,y),I=Math.round(a.lng*w)/w,M=Math.round(a.lat*w)/w,L=p.getBearing(),N=p.getPitch();let V=e?`/${I}/${M}/${f}`:`${f}/${M}/${I}`;return(L||N)&&(V+="/"+Math.round(10*L)/10),N&&(V+=`/${Math.round(N)}`),V}const Ol={linearity:.3,easing:i.eS(0,0,.3,1)},uh=Object.assign({deceleration:2500,maxSpeed:1400},Ol),Dp=Object.assign({deceleration:20,maxSpeed:1400},Ol),Nl=Object.assign({deceleration:1e3,maxSpeed:360},Ol),dh=Object.assign({deceleration:1e3,maxSpeed:90},Ol);class zp{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:i.o.now(),settings:e})}_drainInertiaBuffer(){const e=this._inertiaBuffer,a=i.o.now();for(;e.length>0&&a-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const a={zoom:0,bearing:0,pitch:0,pan:new i.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:w}of this._inertiaBuffer)a.zoom+=w.zoomDelta||0,a.bearing+=w.bearingDelta||0,a.pitch+=w.pitchDelta||0,w.panDelta&&a.pan._add(w.panDelta),w.around&&(a.around=w.around),w.pinchAround&&(a.pinchAround=w.pinchAround);const f=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,y={};if(a.pan.mag()){const w=ph(a.pan.mag(),f,Object.assign({},uh,e||{}));y.offset=a.pan.mult(w.amount/a.pan.mag()),y.center=this._map.transform.center,Vl(y,w)}if(a.zoom){const w=ph(a.zoom,f,Dp);y.zoom=this._map.transform.zoom+w.amount,Vl(y,w)}if(a.bearing){const w=ph(a.bearing,f,Nl);y.bearing=this._map.transform.bearing+i.aA(w.amount,-179,179),Vl(y,w)}if(a.pitch){const w=ph(a.pitch,f,dh);y.pitch=this._map.transform.pitch+w.amount,Vl(y,w)}if(y.zoom||y.bearing){const w=a.pinchAround===void 0?a.around:a.pinchAround;y.around=w?this._map.unproject(w):this._map.getCenter()}return this.clear(),y.noMoveStart=!0,y}}function Vl(p,e){(!p.duration||p.duration<e.duration)&&(p.duration=e.duration,p.easing=e.easing)}function ph(p,e,a){const{maxSpeed:f,linearity:y,deceleration:w}=a,I=i.aA(p*y/(e/1e3),-f,f),M=Math.abs(I)/(w*y);return{easing:a.easing,duration:1e3*M,amount:I*(M/2)}}class ro extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a,f,y={}){const w=ba(a.getCanvasContainer(),f),I=a.unproject(w);super(e,Object.assign({point:w,lngLat:I,originalEvent:f},y)),this._defaultPrevented=!1,this.target=a}}class Ul extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a,f){const y=e==="touchend"?f.changedTouches:f.touches,w=Os(a.getCanvasContainer(),y),I=w.map(L=>a.unproject(L)),M=w.reduce((L,N,V,Z)=>L.add(N.div(Z.length)),new i.P(0,0));super(e,{points:w,point:M,lngLats:I,lngLat:a.unproject(M),originalEvent:f}),this._defaultPrevented=!1}}class yc extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,a){super("wheel",{originalEvent:a}),this._defaultPrevented=!1}}class Hd{constructor(e,a){this._map=e,this._clickTolerance=a.clickTolerance}reset(){this._mousedownPos=void 0}wheel(e){return this._firePreventable(new yc(this._map,e))}mousedown(e,a){return this._mousedownPos=a,this._firePreventable(new ro(e.type,this._map,e))}mouseup(e){this._map.fire(new ro(e.type,this._map,e))}preclick(e){const a=new MouseEvent("preclick",e);this._map.fire(new ro(a.type,this._map,a))}click(e,a){this._mousedownPos&&this._mousedownPos.dist(a)>=this._clickTolerance||(this.preclick(e),this._map.fire(new ro(e.type,this._map,e)))}dblclick(e){return this._firePreventable(new ro(e.type,this._map,e))}mouseover(e){this._map.fire(new ro(e.type,this._map,e))}mouseout(e){this._map.fire(new ro(e.type,this._map,e))}touchstart(e){return this._firePreventable(new Ul(e.type,this._map,e))}touchmove(e){this._map.fire(new Ul(e.type,this._map,e))}touchend(e){this._map.fire(new Ul(e.type,this._map,e))}touchcancel(e){this._map.fire(new Ul(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class fh{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(e){this._map.fire(new ro(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ro("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._map.fire(new ro(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class bf{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=a.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,a){this.isEnabled()&&e.shiftKey&&e.button===0&&(En(),this._startPos=this._lastPos=a,this._active=!0)}mousemoveWindow(e,a){if(!this._active)return;const f=a,y=this._startPos,w=this._lastPos;if(!y||!w||w.equals(f)||!this._box&&f.dist(y)<this._clickTolerance)return;this._lastPos=f,this._box||(this._box=Ci("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",e));const I=Math.min(y.x,f.x),M=Math.max(y.x,f.x),L=Math.min(y.y,f.y),N=Math.max(y.y,f.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${I}px,${L}px)`,this._box.style.width=M-I+"px",this._box.style.height=N-L+"px")})}mouseupWindow(e,a){if(!this._active)return;const f=this._startPos,y=a;if(f&&e.button===0){if(this.reset(),bo(),f.x!==y.x||f.y!==y.y)return this._map.fire(new i.z("boxzoomend",{originalEvent:e})),{cameraAnimation:w=>w.fitScreenCoordinates(f,y,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",e)}}keydown(e){this._active&&e.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",e))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),$o(),delete this._startPos,delete this._lastPos}_fireEvent(e,a){return this._map.fire(new i.z(e,{originalEvent:a}))}}function Lp(p,e){const a={};for(let f=0;f<p.length;f++)a[p[f].identifier]=e[f];return a}class Rp{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(e,a,f){(this.centroid||f.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=e.timeStamp),f.length===this.numTouches&&(this.centroid=function(y){const w=new i.P(0,0);for(const I of y)w._add(I);return w.div(y.length)}(a),this.touches=Lp(f,a)))}touchmove(e,a,f){if(this.aborted||!this.centroid)return;const y=Lp(f,a);for(const w in this.touches){const I=y[w];(!I||I.dist(this.touches[w])>30)&&(this.aborted=!0)}}touchend(e,a,f){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),f.length===0){const y=!this.aborted&&this.centroid;if(this.reset(),y)return y}}}class Au{constructor(e){this.singleTap=new Rp(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(e,a,f){this.singleTap.touchstart(e,a,f)}touchmove(e,a,f){this.singleTap.touchmove(e,a,f)}touchend(e,a,f){const y=this.singleTap.touchend(e,a,f);if(y){const w=e.timeStamp-this.lastTime<500,I=!this.lastTap||this.lastTap.dist(y)<30;if(w&&I||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=y,this.count===this.numTaps)return this.reset(),y}}}class Dm{constructor(){this._zoomIn=new Au({numTouches:1,numTaps:2}),this._zoomOut=new Au({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,a,f){this._zoomIn.touchstart(e,a,f),this._zoomOut.touchstart(e,a,f)}touchmove(e,a,f){this._zoomIn.touchmove(e,a,f),this._zoomOut.touchmove(e,a,f)}touchend(e,a,f){const y=this._zoomIn.touchend(e,a,f),w=this._zoomOut.touchend(e,a,f);return y?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:I=>I.easeTo({duration:300,zoom:I.getZoom()+1,around:I.unproject(y)},{originalEvent:e})}):w?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:I=>I.easeTo({duration:300,zoom:I.getZoom()-1,around:I.unproject(w)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const kp={0:1,2:2},Kf={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class dd{constructor(e){this.reset(),this._clickTolerance=e.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(e,a){return!1}_move(e,a){return{}}mousedown(e,a){if(this._lastPoint)return;const f=Ya(e);this._correctButton(e,f)&&(this._lastPoint=a,this._eventButton=f)}mousemoveWindow(e,a){const f=this._lastPoint;if(f){if(e.preventDefault(),this._eventButton!=null&&function(y,w){const I=kp[w];return y.buttons===void 0||(y.buttons&I)!==I}(e,this._eventButton))this.reset();else if(this._moved||!(a.dist(f)<this._clickTolerance))return this._moved=!0,this._lastPoint=a,this._move(f,a)}}mouseupWindow(e){this._lastPoint&&Ya(e)===this._eventButton&&(this._moved&&bo(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Qf extends dd{mousedown(e,a){super.mousedown(e,a),this._lastPoint&&(this._active=!0)}_correctButton(e,a){return a===0&&!e.ctrlKey}_move(e,a){return{around:a,panDelta:a.sub(e)}}}class wf extends dd{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?Kf[e.pitchRotateKey]:void 0}_correctButton(e,a){return this._pitchRotateKey?a===0&&e[this._pitchRotateKey]:a===0&&e.ctrlKey||a===2}_move(e,a){const f=.8*(a.x-e.x);if(f)return this._active=!0,{bearingDelta:f}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class pd extends dd{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?Kf[e.pitchRotateKey]:void 0}_correctButton(e,a){return this._pitchRotateKey?a===0&&e[this._pitchRotateKey]:a===0&&e.ctrlKey||a===2}_move(e,a){const f=-.5*(a.y-e.y);if(f)return this._active=!0,{pitchDelta:f}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class gg{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._minTouches=1,this._clickTolerance=a.clickTolerance||1,this.reset(),i.aX(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new i.P(0,0)}touchstart(e,a,f){return this._calculateTransform(e,a,f)}touchmove(e,a,f){if(this._active&&!(f.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(f.length===1&&!i.eT())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return e.cancelable&&e.preventDefault(),this._calculateTransform(e,a,f)}}touchend(e,a,f){this._calculateTransform(e,a,f),this._active&&f.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,a,f){f.length>0&&(this._active=!0);const y=Lp(f,a),w=new i.P(0,0),I=new i.P(0,0);let M=0;for(const N in y){const V=y[N],Z=this._touches[N];Z&&(w._add(V),I._add(V.sub(Z)),M++,y[N]=V)}if(this._touches=y,M<this._minTouches||!I.mag())return;const L=I.div(M);return this._sum._add(L),this._sum.mag()<this._clickTolerance?void 0:{around:w.div(M),panDelta:L}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Ci("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Pu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(e){}_move(e,a,f){return{}}touchstart(e,a,f){this._firstTwoTouches||f.length<2||(this._firstTwoTouches=[f[0].identifier,f[1].identifier],this._start([a[0],a[1]]))}touchmove(e,a,f){const y=this._firstTwoTouches;if(!y)return;e.preventDefault();const[w,I]=y,M=fd(f,a,w),L=fd(f,a,I);if(!M||!L)return;const N=this._aroundCenter?null:M.add(L).div(2);return this._move([M,L],N,e)}touchend(e,a,f){if(!this._firstTwoTouches)return;const[y,w]=this._firstTwoTouches,I=fd(f,a,y),M=fd(f,a,w);I&&M||(this._active&&bo(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&e.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function fd(p,e,a){for(let f=0;f<p.length;f++)if(p[f].identifier===a)return e[f]}function Fp(p,e){return Math.log2(p/e)}class _g extends Pu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,a){const f=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(Fp(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Fp(this._distance,f),pinchAround:a}}}function zm(p,e){return 180*p.angleWith(e)/Math.PI}class yg extends Pu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,a){const f=this._vector;if(this._vector=e[0].sub(e[1]),f&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:zm(this._vector,f),pinchAround:a}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const a=25/(Math.PI*this._minDiameter)*360,f=this._startVector;if(!f)return!1;const y=zm(e,f);return Math.abs(y)<a}}function tm(p){return Math.abs(p.y)>Math.abs(p.x)}class Lm extends Pu{constructor(e){super(),this._map=e}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(e){this._lastPoints=e,tm(e[0].sub(e[1]))&&(this._valid=!1)}_move(e,a,f){const y=this._lastPoints;if(!y)return;const w=e[0].sub(y[0]),I=e[1].sub(y[1]);return this._map._cooperativeGestures&&!i.eT()&&f.touches.length<3||(this._valid=this.gestureBeginsVertically(w,I,f.timeStamp),!this._valid)?void 0:(this._lastPoints=e,this._active=!0,{pitchDelta:(w.y+I.y)/2*-.5})}gestureBeginsVertically(e,a,f){if(this._valid!==void 0)return this._valid;const y=e.mag()>=2,w=a.mag()>=2;if(!y&&!w)return;if(!y||!w)return this._firstMove==null&&(this._firstMove=f),f-this._firstMove<100&&void 0;const I=e.y>0==a.y>0;return tm(e)&&tm(a)&&I}}const em={panStep:100,bearingStep:15,pitchStep:10};class Rm{constructor(){const e=em;this._panStep=e.panStep,this._bearingStep=e.bearingStep,this._pitchStep=e.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let a=0,f=0,y=0,w=0,I=0;switch(e.keyCode){case 61:case 107:case 171:case 187:a=1;break;case 189:case 109:case 173:a=-1;break;case 37:e.shiftKey?f=-1:(e.preventDefault(),w=-1);break;case 39:e.shiftKey?f=1:(e.preventDefault(),w=1);break;case 38:e.shiftKey?y=1:(e.preventDefault(),I=-1);break;case 40:e.shiftKey?y=-1:(e.preventDefault(),I=1);break;default:return}return this._rotationDisabled&&(f=0,y=0),{cameraAnimation:M=>{const L=M.getZoom();M.easeTo({duration:300,easeId:"keyboardHandler",easing:km,zoom:a?Math.round(L)+a*(e.shiftKey?2:1):L,bearing:M.getBearing()+f*this._bearingStep,pitch:M.getPitch()+y*this._pitchStep,offset:[-w*this._panStep,-I*this._panStep],center:M.getCenter()},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function km(p){return p*(2-p)}const xg=4.000244140625,g_=1/450;class vg{constructor(e,a){this._map=e,this._el=e.getCanvasContainer(),this._handler=a,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=g_,i.aX(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&e.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(e){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(e.ctrlKey||e.metaKey||this.isZooming()||i.eT()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let a=e.deltaMode===WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const f=i.o.now(),y=f-(this._lastWheelEventTime||0);this._lastWheelEventTime=f,a!==0&&a%xg==0?this._type="wheel":a!==0&&Math.abs(a)<4?this._type="trackpad":y>400?(this._type=null,this._lastValue=a,this._timeout=window.setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(y*a)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,a+=this._lastValue)),e.shiftKey&&a&&(a/=4),this._type&&(this._lastWheelEvent=e,this._delta-=a,this._active||this._start(e)),e.preventDefault()}_onTimeout(e){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(e)}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const a=ba(this._el,e);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:a,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const e=this._map.transform;this._type==="wheel"&&e.projection.wrap&&(e._center.lng>=180||e._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const a=()=>e._terrainEnabled()&&this._aroundCoord?e.computeZoomRelativeTo(this._aroundCoord):e.zoom;if(this._delta!==0){const N=this._type==="wheel"&&Math.abs(this._delta)>xg?this._wheelZoomRate:this._defaultZoomRate;let V=2/(1+Math.exp(-Math.abs(this._delta*N)));this._delta<0&&V!==0&&(V=1/V);const Z=a(),U=Math.pow(2,Z),X=typeof this._targetZoom=="number"?e.zoomScale(this._targetZoom):U;this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,e.scaleZoom(X*V))),this._type==="wheel"&&(this._startZoom=Z,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const f=typeof this._targetZoom=="number"?this._targetZoom:a(),y=this._startZoom,w=this._easing;let I,M=!1;if(this._type==="wheel"&&y&&w){const N=Math.min((i.o.now()-this._lastWheelEventTime)/200,1),V=w(N);I=i.ak(y,f,V),N<1?this._frameId||(this._frameId=!0):M=!0}else I=f,M=!0;this._active=!0,M&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let L=I-a();return L*this._lastDelta<0&&(L=0),{noInertia:!0,needsRenderFrame:!M,zoomDelta:L,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let a=i.eU;if(this._prevEase){const f=this._prevEase,y=(i.o.now()-f.start)/f.duration,w=f.easing(y+.01)-f.easing(y),I=.27/Math.sqrt(w*w+1e-4)*.01,M=Math.sqrt(.0729-I*I);a=i.eS(I,M,.25,1)}return this._prevEase={start:i.o.now(),duration:e,easing:a},a}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Ci("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class To{constructor(e,a){this._clickZoom=e,this._tapZoom=a}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class bg{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(e,a){return e.preventDefault(),{cameraAnimation:f=>{f.easeTo({duration:300,zoom:f.getZoom()+(e.shiftKey?-1:1),around:f.unproject(a)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Fm{constructor(){this._tap=new Au({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(e,a,f){this._swipePoint||(this._tapTime&&e.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?f.length>0&&(this._swipePoint=a[0],this._swipeTouch=f[0].identifier):this._tap.touchstart(e,a,f))}touchmove(e,a,f){if(this._tapTime){if(this._swipePoint){if(f[0].identifier!==this._swipeTouch)return;const y=a[0],w=y.y-this._swipePoint.y;return this._swipePoint=y,e.preventDefault(),this._active=!0,{zoomDelta:w/128}}}else this._tap.touchmove(e,a,f)}touchend(e,a,f){this._tapTime?this._swipePoint&&f.length===0&&this.reset():this._tap.touchend(e,a,f)&&(this._tapTime=e.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class wg{constructor(e,a,f){this._el=e,this._mousePan=a,this._touchPan=f}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Bm{constructor(e,a,f){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=a,this._mousePitch=f}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Mu{constructor(e,a,f,y){this._el=e,this._touchZoom=a,this._touchRotate=f,this._tapDragZoom=y,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Aa=p=>p.zoom||p.drag||p.pitch||p.rotate;class im extends i.z{}class Bp{constructor(){this.constants=[1,1,.01],this.radius=0}setup(e,a){const f=i.av([],a,e);this.radius=i.ag(f[2]<0?i.eW([],f,this.constants):[f[0],f[1],0])}projectRay(e){i.eW(e,e,this.constants),i.aw(e,e),i.eX(e,e,this.constants);const a=i.c4([],e,this.radius);if(a[2]>0){const f=i.c4([],[0,0,1],i.bI(a,[0,0,1])),y=i.c4([],i.aw([],[a[0],a[1],0]),this.radius),w=i.d7([],a,i.c4([],i.av([],i.d7([],y,f),a),2));a[0]=w[0],a[1]=w[1]}return a}}function Zc(p){return p.panDelta&&p.panDelta.mag()||p.zoomDelta||p.bearingDelta||p.pitchDelta}class Tf{constructor(e,a){this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new zp(e),this._bearingSnap=a.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Bp,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(a),i.aX(["handleEvent","handleWindowEvent"],this);const f=this._el;this._listeners=[[f,"touchstart",{passive:!0}],[f,"touchmove",{passive:!1}],[f,"touchend",void 0],[f,"touchcancel",void 0],[f,"mousedown",void 0],[f,"mousemove",void 0],[f,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[f,"mouseover",void 0],[f,"mouseout",void 0],[f,"dblclick",void 0],[f,"click",void 0],[f,"keydown",{capture:!1}],[f,"keyup",void 0],[f,"wheel",{passive:!1}],[f,"contextmenu",void 0],[window,"blur",void 0]];for(const[y,w,I]of this._listeners){const M=y===document?this.handleWindowEvent:this.handleEvent;y.addEventListener(w,M,I)}}destroy(){for(const[e,a,f]of this._listeners){const y=e===document?this.handleWindowEvent:this.handleEvent;e.removeEventListener(a,y,f)}}_addDefaultHandlers(e){const a=this._map,f=a.getCanvasContainer();this._add("mapEvent",new Hd(a,e));const y=a.boxZoom=new bf(a,e);this._add("boxZoom",y);const w=new Dm,I=new bg;a.doubleClickZoom=new To(I,w),this._add("tapZoom",w),this._add("clickZoom",I);const M=new Fm;this._add("tapDragZoom",M);const L=a.touchPitch=new Lm(a);this._add("touchPitch",L);const N=new wf(e),V=new pd(e);a.dragRotate=new Bm(e,N,V),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",V,["mouseRotate"]);const Z=new Qf(e),U=new gg(a,e);a.dragPan=new wg(f,Z,U),this._add("mousePan",Z),this._add("touchPan",U,["touchZoom","touchRotate"]);const X=new yg,K=new _g;a.touchZoomRotate=new Mu(f,K,X,M),this._add("touchRotate",X,["touchPan","touchZoom"]),this._add("touchZoom",K,["touchPan","touchRotate"]),this._add("blockableMapEvent",new fh(a));const rt=a.scrollZoom=new vg(a,this);this._add("scrollZoom",rt,["mousePan"]);const ht=a.keyboard=new Rm;this._add("keyboard",ht);for(const lt of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])e.interactive&&e[lt]&&a[lt].enable(e[lt])}_add(e,a,f){this._handlers.push({handlerName:e,handler:a,allowed:f}),this._handlersById[e]=a}stop(e){if(!this._updatingCamera){for(const{handler:a}of this._handlers)a.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Aa(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(e,a,f){for(const y in e)if(y!==f&&(!a||a.indexOf(y)<0))return!0;return!1}handleWindowEvent(e){this.handleEvent(e,`${e.type}Window`)}_getMapTouches(e){const a=[];for(const f of e)this._el.contains(f.target)&&a.push(f);return a}handleEvent(e,a){this._updatingCamera=!0;const f=e.type==="renderFrame",y=f?void 0:e,w={needsRenderFrame:!1},I={},M={},L=e.touches?this._getMapTouches(e.touches):void 0,N=L?Os(this._el,L):f?void 0:ba(this._el,e);for(const{handlerName:U,handler:X,allowed:K}of this._handlers){if(!X.isEnabled())continue;let rt;this._blockedByActive(M,K,U)?X.reset():X[a||e.type]&&(rt=X[a||e.type](e,N,L),this.mergeHandlerResult(w,I,rt,U,y),rt&&rt.needsRenderFrame&&this._triggerRenderFrame()),(rt||X.isActive())&&(M[U]=X)}const V={};for(const U in this._previousActiveHandlers)M[U]||(V[U]=y);this._previousActiveHandlers=M,(Object.keys(V).length||Zc(w))&&(this._changes.push([w,I,V]),this._triggerRenderFrame()),(Object.keys(M).length||Zc(w))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:Z}=w;Z&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],Z(this._map))}mergeHandlerResult(e,a,f,y,w){if(!f)return;Object.assign(e,f);const I={handlerName:y,originalEvent:f.originalEvent||w};f.zoomDelta!==void 0&&(a.zoom=I),f.panDelta!==void 0&&(a.drag=I),f.pitchDelta!==void 0&&(a.pitch=I),f.bearingDelta!==void 0&&(a.rotate=I)}_applyChanges(){const e={},a={},f={};for(const[y,w,I]of this._changes)y.panDelta&&(e.panDelta=(e.panDelta||new i.P(0,0))._add(y.panDelta)),y.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+y.zoomDelta),y.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+y.bearingDelta),y.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+y.pitchDelta),y.around!==void 0&&(e.around=y.around),y.aroundCoord!==void 0&&(e.aroundCoord=y.aroundCoord),y.pinchAround!==void 0&&(e.pinchAround=y.pinchAround),y.noInertia&&(e.noInertia=y.noInertia),Object.assign(a,w),Object.assign(f,I);this._updateMapTransform(e,a,f),this._changes=[]}_updateMapTransform(e,a,f){const y=this._map,w=y.transform,I=_t=>[_t.x,_t.y,_t.z];if((_t=>{const Mt=this._eventsInProgress.drag;return Mt&&!this._handlersById[Mt.handlerName].isActive()})()&&!Zc(e)){const _t=w.zoom;w.cameraElevationReference="sea",this._originalZoom!=null&&w._orthographicProjectionAtLowPitch&&w.projection.name!=="globe"&&w.pitch===0?(w.cameraElevationReference="ground",w.zoom=this._originalZoom):(w.recenterOnTerrain(),w.cameraElevationReference="ground"),_t!==w.zoom&&this._map._update(!0)}if(w._isCameraConstrained&&y._stop(!0),!Zc(e))return void this._fireEvents(a,f,!0);let{panDelta:M,zoomDelta:L,bearingDelta:N,pitchDelta:V,around:Z,aroundCoord:U,pinchAround:X}=e;w._isCameraConstrained&&(L>0&&(L=0),w._isCameraConstrained=!1),X!==void 0&&(Z=X),(L||(_t=>a[_t]&&!this._eventsInProgress[_t])("drag"))&&Z&&(this._dragOrigin=I(w.pointCoordinate3D(Z)),this._originalZoom=w.zoom,this._trackingEllipsoid.setup(w._camera.position,this._dragOrigin)),w.cameraElevationReference="sea",y._stop(!0),Z=Z||y.transform.centerPoint,N&&(w.bearing+=N),V&&(w.pitch+=V),w._updateCameraState();const K=[0,0,0];if(M)if(w.projection.name==="mercator"){const _t=this._trackingEllipsoid.projectRay(w.screenPointToMercatorRay(Z).dir),Mt=this._trackingEllipsoid.projectRay(w.screenPointToMercatorRay(Z.sub(M)).dir);K[0]=Mt[0]-_t[0],K[1]=Mt[1]-_t[1]}else{const _t=w.pointCoordinate(Z);if(w.projection.name==="globe"){M=M.rotate(-w.angle);const Mt=w._pixelsPerMercatorPixel/w.worldSize;K[0]=-M.x*i.eV(i.a_(_t.y))*Mt,K[1]=-M.y*i.eV(w.center.lat)*Mt}else{const Mt=w.pointCoordinate(Z.sub(M));_t&&Mt&&(K[0]=Mt.x-_t.x,K[1]=Mt.y-_t.y)}}const rt=w.zoom,ht=[0,0,0];if(L){const _t=I(U||w.pointCoordinate3D(Z)),Mt={dir:i.aw([],i.av([],_t,w._camera.position))};if(Mt.dir[2]<0){const vt=w.zoomDeltaToMovement(_t,L);i.c4(ht,Mt.dir,vt)}}const lt=i.d7(K,K,ht);w._translateCameraConstrained(lt),L&&Math.abs(w.zoom-rt)>1e-4&&w.recenterOnTerrain(),w.cameraElevationReference="ground",this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(a,f,!0)}_fireEvents(e,a,f){const y=Aa(this._eventsInProgress),w=Aa(e),I={};for(const V in e){const{originalEvent:Z}=e[V];this._eventsInProgress[V]||(I[`${V}start`]=Z),this._eventsInProgress[V]=e[V]}!y&&w&&this._fireEvent("movestart",w.originalEvent);for(const V in I)this._fireEvent(V,I[V]);w&&this._fireEvent("move",w.originalEvent);for(const V in e){const{originalEvent:Z}=e[V];this._fireEvent(V,Z)}const M={};let L;for(const V in this._eventsInProgress){const{handlerName:Z,originalEvent:U}=this._eventsInProgress[V];this._handlersById[Z].isActive()||(delete this._eventsInProgress[V],L=a[Z]||U,M[`${V}end`]=L)}for(const V in M)this._fireEvent(V,M[V]);const N=Aa(this._eventsInProgress);if(f&&(y||w)&&!N){this._updatingCamera=!0;const V=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),Z=U=>U!==0&&-this._bearingSnap<U&&U<this._bearingSnap;V?(Z(V.bearing||this._map.getBearing())&&(V.bearing=0),this._map.easeTo(V,{originalEvent:L})):(this._map.fire(new i.z("moveend",{originalEvent:L})),Z(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(e,a){this._map.fire(new i.z(e,a?{originalEvent:a}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(e=>{this._frameId=void 0,this.handleEvent(new im("renderFrame",{timeStamp:e})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const ls="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class tu extends i.E{constructor(e,a){super(),this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=a.bearingSnap,this._respectPrefersReducedMotion=a.respectPrefersReducedMotion!==!1,i.aX(["_renderFrameCallback"],this)}getCenter(){return new i.aS(this.transform.center.lng,this.transform.center.lat)}setCenter(e,a){return this.jumpTo({center:e},a)}panBy(e,a,f){return e=i.P.convert(e).mult(-1),this.panTo(this.transform.center,Object.assign({offset:e},a),f)}panTo(e,a,f){return this.easeTo(Object.assign({center:e},a),f)}getZoom(){return this.transform.zoom}setZoom(e,a){return this.jumpTo({zoom:e},a),this}zoomTo(e,a,f){return this.easeTo(Object.assign({zoom:e},a),f)}zoomIn(e,a){return this.zoomTo(this.getZoom()+1,e,a),this}zoomOut(e,a){return this.zoomTo(this.getZoom()-1,e,a),this}getBearing(){return this.transform.bearing}setBearing(e,a){return this.jumpTo({bearing:e},a),this}getPadding(){return this.transform.padding}setPadding(e,a){return this.jumpTo({padding:e},a),this}rotateTo(e,a,f){return this.easeTo(Object.assign({bearing:e},a),f)}resetNorth(e,a){return this.rotateTo(0,Object.assign({duration:1e3},e),a),this}resetNorthPitch(e,a){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},e),a),this}snapToNorth(e,a){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,a):this}getPitch(){return this.transform.pitch}setPitch(e,a){return this.jumpTo({pitch:e},a),this}cameraForBounds(e,a){e=i.aI.convert(e);const f=a&&a.bearing||0,y=a&&a.pitch||0,w=e.getNorthWest(),I=e.getSouthEast();return this._cameraForBounds(this.transform,w,I,f,y,a)}_extendPadding(e){const a={top:0,right:0,bottom:0,left:0};return e==null?Object.assign({},a,this.transform.padding):typeof e=="number"?{top:e,bottom:e,right:e,left:e}:Object.assign({},a,e)}_extendCameraOptions(e){return(e=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},e)).padding=this._extendPadding(e.padding),e}_minimumAABBFrustumDistance(e,a){const f=a.max[0]-a.min[0],y=a.max[1]-a.min[1];return f/y>e.aspect?f/(2*Math.tan(.5*e.fovX)*e.aspect):y/(2*Math.tan(.5*e.fovY)*e.aspect)}_cameraForBoundsOnGlobe(e,a,f,y,w,I){const M=e.clone(),L=this._extendCameraOptions(I);M.bearing=y,M.pitch=w;const N=i.aS.convert(a),V=i.aS.convert(f),Z=.5*(N.lat+V.lat),U=.5*(N.lng+V.lng),X=i.eY(Z,U),K=i.aw([],X),rt=i.aw([],i.bH([],K,[0,1,0])),ht=i.bH([],rt,K),lt=[rt[0],rt[1],rt[2],0,ht[0],ht[1],ht[2],0,K[0],K[1],K[2],0,0,0,0,1],_t=[X,i.eY(N.lat,N.lng),i.eY(V.lat,N.lng),i.eY(V.lat,V.lng),i.eY(N.lat,V.lng),i.eY(Z,N.lng),i.eY(Z,V.lng),i.eY(N.lat,U),i.eY(V.lat,U)];let Mt=i.d8.fromPoints(_t.map(Te=>[i.bI(rt,Te),i.bI(ht,Te),i.bI(K,Te)]));const vt=i.af([],Mt.center,lt);i.eZ(vt)===0&&i.e_(vt,0,0,1),i.aw(vt,vt),i.c4(vt,vt,i.aD),M.center=i.e$(vt);const Ut=M.getWorldToCameraMatrix(),Ct=i.bk(new Float64Array(16),Ut);Mt=i.d8.applyTransform(Mt,i.aB([],Ut,lt));const $t=this._extendAABB(Mt,M,L,y);if(!$t)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Mt=$t,i.af(vt,vt,Ut);const Ot=.5*(Mt.max[2]-Mt.min[2]),Rt=this._minimumAABBFrustumDistance(M,Mt),Zt=i.c4([],[0,0,1],Ot),pe=i.d7(Zt,vt,Zt),le=Rt+(M.pitch===0?0:i.bF(vt,pe)),Me=M.globeCenterInViewSpace,ve=i.av([],vt,[Me[0],Me[1],Me[2]]);i.aw(ve,ve),i.c4(ve,ve,le);const Be=i.d7([],vt,ve);i.af(Be,Be,Ct);const oi=i.eL/i.aD,ge=i.ag(Be),ie=i.ce(Math.max(ge*oi-i.eL,Number.EPSILON),0),Oe=Math.min(M.zoomFromMercatorZAdjusted(ie),L.maxZoom);return Oe>.5*(i.cZ+i.cK)?(M.setProjection({name:"mercator"}),M.zoom=Oe,this._cameraForBounds(M,a,f,y,w,I)):{center:M.center,zoom:Oe,bearing:y,pitch:w}}_extendAABB(e,a,f,y){const w=.5*((f.padding.left||0)+(f.padding.right||0)),I=.5*((f.padding.top||0)+(f.padding.bottom||0)),M=I,L=w,N=w,V=I,Z=a.width-(L+N),U=a.height-(M+V),X=i.av([],e.max,e.min),K=Math.min(Z/X[0],U/X[1]),rt=Math.min(a.scaleZoom(a.scale*K),f.maxZoom);if(isNaN(rt))return null;const ht=a.scale/a.zoomScale(rt),lt=new i.d8([e.min[0]-L*ht,e.min[1]-V*ht,e.min[2]],[e.max[0]+N*ht,e.max[1]+M*ht,e.max[2]]),_t=(typeof f.offset.x=="number"&&typeof f.offset.y=="number"?new i.P(f.offset.x,f.offset.y):i.P.convert(f.offset)).rotate(-i.an(y));return lt.center[0]-=_t.x*ht,lt.center[1]+=_t.y*ht,lt}queryTerrainElevation(e,a){const f=this.transform.elevation;return f?(a=Object.assign({},{exaggerated:!0},a),f.getAtPoint(i.ae.fromLngLat(e),null,a.exaggerated)):null}_cameraForBounds(e,a,f,y,w,I){if(e.projection.name==="globe")return this._cameraForBoundsOnGlobe(e,a,f,y,w,I);const M=e.clone(),L=this._extendCameraOptions(I);M.bearing=y,M.pitch=w;const N=i.aS.convert(a),V=i.aS.convert(f),Z=new i.aS(N.lng,V.lat),U=new i.aS(V.lng,N.lat),X=M.project(N),K=M.project(V),rt=this.queryTerrainElevation(N),ht=this.queryTerrainElevation(V),lt=this.queryTerrainElevation(Z),_t=this.queryTerrainElevation(U),Mt=[[X.x,X.y,Math.min(rt||0,ht||0,lt||0,_t||0)],[K.x,K.y,Math.max(rt||0,ht||0,lt||0,_t||0)]];let vt=i.d8.fromPoints(Mt);const Ut=M.getWorldToCameraMatrix(),Ct=i.bk(new Float64Array(16),Ut);vt=i.d8.applyTransform(vt,Ut);const $t=this._extendAABB(vt,M,L,y);if(!$t)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");vt=$t;const Ot=.5*i.av([],vt.max,vt.min)[2],Rt=this._minimumAABBFrustumDistance(M,vt),Zt=[0,0,1,0];i.aC(Zt,Zt,Ut),i.f0(Zt,Zt);const pe=i.c4([],Zt,Rt+Ot),le=i.d7([],vt.center,pe);i.af(vt.center,vt.center,Ct),i.af(le,le,Ct);const Me=M.unproject(new i.P(vt.center[0],vt.center[1])),ve=i.f1(M.projection,Me),Be=Math.pow(2,ve),oi=Math.min(M._zoomFromMercatorZ(le[2]*M.pixelsPerMeter*Be/M.worldSize),L.maxZoom);return M.mercatorFromTransition&&oi<.5*(i.cZ+i.cK)?(M.setProjection({name:"globe"}),M.zoom=oi,this._cameraForBounds(M,a,f,y,w,I)):{center:Me,zoom:oi,bearing:y,pitch:w}}fitBounds(e,a,f){const y=this.cameraForBounds(e,a);return this._fitInternal(y,a,f)}fitScreenCoordinates(e,a,f,y,w){const I=i.P.convert(e),M=i.P.convert(a),L=new i.P(Math.min(I.x,M.x),Math.min(I.y,M.y)),N=new i.P(Math.max(I.x,M.x),Math.max(I.y,M.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(I,M))return this;const V=this.transform.pointLocation3D(L),Z=this.transform.pointLocation3D(N),U=this.transform.pointLocation3D(new i.P(L.x,N.y)),X=this.transform.pointLocation3D(new i.P(N.x,L.y)),K=[Math.min(V.lng,Z.lng,U.lng,X.lng),Math.min(V.lat,Z.lat,U.lat,X.lat)],rt=[Math.max(V.lng,Z.lng,U.lng,X.lng),Math.max(V.lat,Z.lat,U.lat,X.lat)],ht=y&&y.pitch?y.pitch:this.getPitch(),lt=this._cameraForBounds(this.transform,K,rt,f,ht,y);return this._fitInternal(lt,y,w)}_fitInternal(e,a,f){return e?(a=Object.assign(e,a)).linear?this.easeTo(a,f):this.flyTo(a,f):this}jumpTo(e,a){this.stop();const f=e.preloadOnly?this.transform.clone():this.transform;let y=!1,w=!1,I=!1;"zoom"in e&&f.zoom!==+e.zoom&&(y=!0,f.zoom=+e.zoom),e.center!==void 0&&(f.center=i.aS.convert(e.center)),"bearing"in e&&f.bearing!==+e.bearing&&(w=!0,f.bearing=+e.bearing),"pitch"in e&&f.pitch!==+e.pitch&&(I=!0,f.pitch=+e.pitch);const M=typeof e.padding=="number"?this._extendPadding(e.padding):e.padding;if(e.padding!=null&&!f.isPaddingEqual(M))if(e.retainPadding===!1){const L=f.clone();L.padding=M,f.setLocationAtPoint(f.center,L.centerPoint)}else f.padding=M;return e.preloadOnly?(this._preloadTiles(f),this):(this.fire(new i.z("movestart",a)).fire(new i.z("move",a)),y&&this.fire(new i.z("zoomstart",a)).fire(new i.z("zoom",a)).fire(new i.z("zoomend",a)),w&&this.fire(new i.z("rotatestart",a)).fire(new i.z("rotate",a)).fire(new i.z("rotateend",a)),I&&this.fire(new i.z("pitchstart",a)).fire(new i.z("pitch",a)).fire(new i.z("pitchend",a)),this.fire(new i.z("moveend",a)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||i.w(ls),this.transform.getFreeCameraOptions()}setFreeCameraOptions(e,a){const f=this.transform;if(!f.projection.supportsFreeCamera)return i.w(ls),this;this.stop();const y=f.zoom,w=f.pitch,I=f.bearing;f.setFreeCameraOptions(e);const M=y!==f.zoom,L=w!==f.pitch,N=I!==f.bearing;return this.fire(new i.z("movestart",a)).fire(new i.z("move",a)),M&&this.fire(new i.z("zoomstart",a)).fire(new i.z("zoom",a)).fire(new i.z("zoomend",a)),N&&this.fire(new i.z("rotatestart",a)).fire(new i.z("rotate",a)).fire(new i.z("rotateend",a)),L&&this.fire(new i.z("pitchstart",a)).fire(new i.z("pitch",a)).fire(new i.z("pitchend",a)),this.fire(new i.z("moveend",a)),this}easeTo(e,a){this._stop(!1,e.easeId),((e=Object.assign({offset:[0,0],duration:500,easing:i.eU},e)).animate===!1||this._prefersReducedMotion(e))&&(e.duration=0);const f=this.transform,y=this.getZoom(),w=this.getBearing(),I=this.getPitch(),M=this.getPadding(),L="zoom"in e?+e.zoom:y,N="bearing"in e?this._normalizeBearing(e.bearing,w):w,V="pitch"in e?+e.pitch:I,Z=this._extendPadding(e.padding),U=i.P.convert(e.offset);let X,K,rt;if(f.projection.name==="globe"){const Zt=i.ae.fromLngLat(f.center),pe=U.rotate(-f.angle);Zt.x+=pe.x/f.worldSize,Zt.y+=pe.y/f.worldSize;const le=Zt.toLngLat(),Me=i.aS.convert(e.center||le);this._normalizeCenter(Me),X=f.centerPoint.add(pe),K=new i.P(Zt.x,Zt.y).mult(f.worldSize),rt=new i.P(i.aF(Me.lng),i.aJ(Me.lat)).mult(f.worldSize).sub(K)}else{X=f.centerPoint.add(U);const Zt=f.pointLocation(X),pe=i.aS.convert(e.center||Zt);this._normalizeCenter(pe),K=f.project(Zt),rt=f.project(pe).sub(K)}const ht=f.zoomScale(L-y);let lt,_t;e.around&&(lt=i.aS.convert(e.around),_t=f.locationPoint(lt));const Mt=this._zooming||L!==y,vt=this._rotating||w!==N,Ut=this._pitching||V!==I,Ct=!f.isPaddingEqual(Z),$t=e.retainPadding===!1?f.clone():f,Ot=Zt=>pe=>{if(Mt&&(Zt.zoom=i.ak(y,L,pe)),vt&&(Zt.bearing=i.ak(w,N,pe)),Ut&&(Zt.pitch=i.ak(I,V,pe)),Ct&&($t.interpolatePadding(M,Z,pe),X=$t.centerPoint.add(U)),lt)Zt.setLocationAtPoint(lt,_t);else{const le=Zt.zoomScale(Zt.zoom-y),Me=L>y?Math.min(2,ht):Math.max(.5,ht),ve=Math.pow(Me,1-pe),Be=Zt.unproject(K.add(rt.mult(pe*ve)).mult(le));Zt.setLocationAtPoint(Zt.renderWorldCopies?Be.wrap():Be,X)}return e.preloadOnly||this._fireMoveEvents(a),Zt};if(e.preloadOnly){const Zt=this._emulate(Ot,e.duration,f);return this._preloadTiles(Zt),this}const Rt={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Mt,this._rotating=vt,this._pitching=Ut,this._padding=Ct,this._easeId=e.easeId,this._prepareEase(a,e.noMoveStart,Rt),this._ease(Ot(f),Zt=>{f.cameraElevationReference==="sea"&&f.recenterOnTerrain(),this._afterEase(a,Zt)},e),this}_prepareEase(e,a,f={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),a||f.moving||this.fire(new i.z("movestart",e)),this._zooming&&!f.zooming&&this.fire(new i.z("zoomstart",e)),this._rotating&&!f.rotating&&this.fire(new i.z("rotatestart",e)),this._pitching&&!f.pitching&&this.fire(new i.z("pitchstart",e))}_fireMoveEvents(e){this.fire(new i.z("move",e)),this._zooming&&this.fire(new i.z("zoom",e)),this._rotating&&this.fire(new i.z("rotate",e)),this._pitching&&this.fire(new i.z("pitch",e))}_afterEase(e,a){if(this._easeId&&a&&this._easeId===a)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const f=this._zooming,y=this._rotating,w=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,f&&this.fire(new i.z("zoomend",e)),y&&this.fire(new i.z("rotateend",e)),w&&this.fire(new i.z("pitchend",e)),this.fire(new i.z("moveend",e))}flyTo(e,a){if(this._prefersReducedMotion(e)){const Te=i.aH(e,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Te,a)}this.stop(),e=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:i.eU},e);const f=this.transform,y=this.getZoom(),w=this.getBearing(),I=this.getPitch(),M=this.getPadding(),L="zoom"in e?i.aA(+e.zoom,f.minZoom,f.maxZoom):y,N="bearing"in e?this._normalizeBearing(e.bearing,w):w,V="pitch"in e?+e.pitch:I,Z=this._extendPadding(e.padding),U=f.zoomScale(L-y),X=i.P.convert(e.offset);let K=f.centerPoint.add(X);const rt=f.pointLocation(K),ht=i.aS.convert(e.center||rt);this._normalizeCenter(ht);const lt=f.project(rt),_t=f.project(ht).sub(lt);let Mt=e.curve;const vt=Math.max(f.width,f.height),Ut=vt/U,Ct=_t.mag();if("minZoom"in e){const Te=i.aA(Math.min(e.minZoom,y,L),f.minZoom,f.maxZoom),qe=vt/f.zoomScale(Te-y);Mt=Math.sqrt(qe/Ct*2)}const $t=Mt*Mt;function Ot(Te){const qe=(Ut*Ut-vt*vt+(Te?-1:1)*$t*$t*Ct*Ct)/(2*(Te?Ut:vt)*$t*Ct);return Math.log(Math.sqrt(qe*qe+1)-qe)}function Rt(Te){return(Math.exp(Te)-Math.exp(-Te))/2}function Zt(Te){return(Math.exp(Te)+Math.exp(-Te))/2}const pe=Ot(0);let le=function(Te){return Zt(pe)/Zt(pe+Mt*Te)},Me=function(Te){return vt*((Zt(pe)*(Rt(qe=pe+Mt*Te)/Zt(qe))-Rt(pe))/$t)/Ct;var qe},ve=(Ot(1)-pe)/Mt;if(Math.abs(Ct)<1e-6||!isFinite(ve)){if(Math.abs(vt-Ut)<1e-6)return this.easeTo(e,a);const Te=Ut<vt?-1:1;ve=Math.abs(Math.log(Ut/vt))/Mt,Me=function(){return 0},le=function(qe){return Math.exp(Te*Mt*qe)}}e.duration="duration"in e?+e.duration:1e3*ve/("screenSpeed"in e?+e.screenSpeed/Mt:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0);const Be=w!==N,oi=V!==I,ge=!f.isPaddingEqual(Z),ie=e.retainPadding===!1?f.clone():f,Oe=Te=>qe=>{const si=qe*ve,Li=1/le(si);Te.zoom=qe===1?L:y+Te.scaleZoom(Li),Be&&(Te.bearing=i.ak(w,N,qe)),oi&&(Te.pitch=i.ak(I,V,qe)),ge&&(ie.interpolatePadding(M,Z,qe),K=ie.centerPoint.add(X));const ni=qe===1?ht:Te.unproject(lt.add(_t.mult(Me(si))).mult(Li));return Te.setLocationAtPoint(Te.renderWorldCopies?ni.wrap():ni,K),Te._updateCameraOnTerrain(),e.preloadOnly||this._fireMoveEvents(a),Te};if(e.preloadOnly){const Te=this._emulate(Oe,e.duration,f);return this._preloadTiles(Te),this}return this._zooming=!0,this._rotating=Be,this._pitching=oi,this._padding=ge,this._prepareEase(a,!1),this._ease(Oe(f),()=>this._afterEase(a),e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(e){}_cancelRenderFrame(e){}_stop(e,a){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const f=this._onEaseEnd;this._onEaseEnd=void 0,f.call(this,a)}if(!e){const f=this.handlers;f&&f.stop(!1)}return this}_ease(e,a,f){f.animate===!1||f.duration===0?(e(1),a()):(this._easeStart=i.o.now(),this._easeOptions=f,this._onEaseFrame=e,this._onEaseEnd=a,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const e=Math.min((i.o.now()-this._easeStart)/this._easeOptions.duration,1),a=this._onEaseFrame;a&&a(this._easeOptions.easing(e)),e<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(e,a){e=i.bS(e,-180,180);const f=Math.abs(e-a);return Math.abs(e-360-a)<f&&(e-=360),Math.abs(e+360-a)<f&&(e+=360),e}_normalizeCenter(e){const a=this.transform;if(a.maxBounds||a.projection.name!=="globe"&&!a.renderWorldCopies)return;const f=e.lng-a.center.lng;e.lng+=f>180?-360:f<-180?360:0}_prefersReducedMotion(e){return this._respectPrefersReducedMotion&&i.o.prefersReducedMotion&&!(e&&e.essential)}_emulate(e,a,f){const y=Math.ceil(15*a/1e3),w=[],I=e(f.clone());for(let M=0;M<=y;M++){const L=I(M/y);w.push(L.clone())}return w}_preloadTiles(e,a){}}class Wd{constructor(e={}){this.options=e,i.aX(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(e){const a=this.options&&this.options.compact,f=e._getUIString("AttributionControl.ToggleAttribution");this._map=e,this._container=Ci("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Ci("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",f);const y=Ci("span","mapboxgl-ctrl-icon",this._compactButton);return y.setAttribute("aria-hidden","true"),y.setAttribute("title",f),this._innerContainer=Ci("div","mapboxgl-ctrl-attrib-inner",this._container),a&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),a===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let e=this._editLink;e||(e=this._editLink=this._container.querySelector(".mapbox-improve-map"));const a=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||i.e.ACCESS_TOKEN}];if(e){const f=a.reduce((y,w,I)=>(w.value&&(y+=`${w.key}=${w.value}${I<a.length-1?"&":""}`),y),"?");e.href=`${i.e.FEEDBACK_URL}/${f}#${Lo(this._map,!0)}`,e.rel="noopener nofollow"}}_updateData(e){!e||(e.dataType!=="source"||e.sourceDataType!=="metadata"&&e.sourceDataType!=="visibility")&&e.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let e=[];if(this._map.style.stylesheet){const y=this._map.style.stylesheet;this.styleOwner=y.owner,this.styleId=y.id}const a=this._map.style._mergedSourceCaches;for(const y in a){const w=a[y];if(w.used){const I=w.getSource();I.attribution&&e.indexOf(I.attribution)<0&&e.push(I.attribution)}}e.sort((y,w)=>y.length-w.length),e=e.filter((y,w)=>{for(let I=w+1;I<e.length;I++)if(e[I].indexOf(y)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=[...this.options.customAttribution,...e]:e.unshift(this.options.customAttribution));const f=e.join(" | ");f!==this._attribHTML&&(this._attribHTML=f,e.length?(this._innerContainer.innerHTML=f,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Sf{constructor(){i.aX(["_updateLogo","_updateCompact"],this)}onAdd(e){this._map=e,this._container=Ci("div","mapboxgl-ctrl");const a=Ci("a","mapboxgl-ctrl-logo");return a.target="_blank",a.rel="noopener nofollow",a.href="https://www.mapbox.com/",a.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),a.setAttribute("rel","noopener nofollow"),this._container.appendChild(a),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(e){e&&e.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const e=this._map.style._sourceCaches;if(Object.entries(e).length===0)return!0;for(const a in e){const f=e[a].getSource();if(f.hasOwnProperty("mapbox_logo")&&!f.mapbox_logo)return!1}return!0}_updateCompact(){const e=this._container.children;if(e.length){const a=e[0];this._map.getCanvasContainer().offsetWidth<250?a.classList.add("mapboxgl-compact"):a.classList.remove("mapboxgl-compact")}}}class If{constructor(){i.aX(["_onIndoorUpdate"],this)}onAdd(e){return this._map=e,this._container=Ci("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",a=>this._onIndoorUpdate(a)),this._container}_createButton(e,a){const f=Ci("button",e,this._container);return f.type="button",f.addEventListener("click",a),f}_createSeparator(){return Ci("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(e,a){this._map&&(e.setAttribute("aria-label",a),e.textContent=a)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(e){if(!e||!e.floors)return this._model=e,void(this._container.style.display="none");const a=this._model;this._model=e,this._container.style.display="inline-block",this._container.style.borderRadius="8px",a&&Array.from(this._container.children).forEach(f=>f.remove()),e.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(e.floors,e.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const e=this._createButton("mapboxgl-ctrl-buildings-toggle",()=>{const a=this._map;this._model&&a&&a._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)});Ci("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&e.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(e),this._createSeparator()}_updateBuildingsButtonState(){const e=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");e&&this._model&&(this._model.activeFloorsVisible?e.classList.remove("mapboxgl-ctrl-level-button-selected"):e.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(e,a){for(let f=0;f<e.length;f++){const y=e[f],w=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(y.id)});this._setButtonTitle(w,y.zIndex.toString()),this._model&&y.id===this._model.selectedFloorId&&a&&w.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(w),f<e.length-1&&this._createSeparator()}}}class Om{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const a=++this._id;return this._queue.push({callback:e,id:a,cancelled:!1}),a}remove(e){const a=this._currentlyRunning,f=a?this._queue.concat(a):this._queue;for(const y of f)if(y.id===e)return void(y.cancelled=!0)}run(e=0){const a=this._currentlyRunning=this._queue;this._queue=[];for(const f of a)if(!f.cancelled&&(f.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Op{constructor(e){this.jumpTo(e)}getValue(e){if(e<=this._startTime)return this._start;if(e>=this._endTime)return this._end;const a=i.dC((e-this._startTime)/(this._endTime-this._startTime));return this._start*(1-a)+this._end*a}isEasing(e){return e>=this._startTime&&e<=this._endTime}jumpTo(e){this._startTime=-1/0,this._endTime=-1/0,this._start=e,this._end=e}easeTo(e,a,f){this._start=this.getValue(a),this._end=e,this._startTime=a,this._endTime=a+f}}const __={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Tg extends i.z{constructor(e,a,f,y){const{point:w,lngLat:I,originalEvent:M,target:L}=e;super(e.type,{point:w,lngLat:I,originalEvent:M,target:L}),this.preventDefault=()=>{e.preventDefault()},this.id=a,this.interaction=f,this.feature=y}}class Nm{constructor(e){this.map=e,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(e,a){if(this.typeById.has(e))throw new Error(`Interaction id "${e}" already exists.`);const f=a.filter;let y=a.type;f&&this.filters.set(e,i.b5(f)),y==="mouseover"&&(y="mouseenter"),y==="mouseout"&&(y="mouseleave");const w=this.interactionsByType.get(y)||new Map;y==="mouseenter"||y==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(e,a)):w.size===0&&this.map.on(y,this.handleType),w.size===0&&this.interactionsByType.set(y,w),w.set(e,a),this.typeById.set(e,y)}get(e){const a=this.typeById.get(e);if(!a)return;const f=this.interactionsByType.get(a);return f?f.get(e):void 0}remove(e){const a=this.typeById.get(e);if(!a)return;this.typeById.delete(e),this.filters.delete(e);const f=this.interactionsByType.get(a);f&&(f.delete(e),a==="mouseenter"||a==="mouseleave"?(this.delegatedInteractions.delete(e),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):f.size===0&&this.map.off(a,this.handleType))}queryTargets(e,a){const f=[];for(const[y,w]of a)w.target&&f.push({targetId:y,target:w.target,filter:this.filters.get(y)});return this.map.style.queryRenderedTargets(e,f,this.map.transform)}handleMove(e){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const a=this.queryTargets(e.point,Array.from(this.delegatedInteractions).reverse());a.length&&(e.type="mouseenter",this.handleType(e,a));const f=new Map;for(const[y,{feature:w}]of this.prevHoveredFeatures)this.hoveredFeatures.has(y)||f.set(w.id,w);f.size&&(e.type="mouseleave",this.handleType(e,Array.from(f.values())))}handleOut(e){const a=Array.from(this.hoveredFeatures.values()).map(({feature:f})=>f);a.length&&(e.type="mouseleave",this.handleType(e,a)),this.hoveredFeatures.clear()}handleType(e,a){const f=e.type==="mouseenter";if(f&&!this.interactionsByType.has(e.type))return void i.w("mouseenter interaction required for mouseleave to work.");const y=Array.from(this.interactionsByType.get(e.type)).reverse(),w=!!a;a=a||this.queryTargets(e.point,y);let I=!1;const M=new Set;for(const L of a){for(const[N,V]of y){if(!V.target)continue;const Z=L.variants?L.variants[N]:null;if(Z){for(const U of Z){if(za(U,L,M,N))continue;const X=new i.dw(L,U),K=zl(U,L,N);w&&X.id!==void 0&&(X.state=this.map.getFeatureState(X));const rt=f?this.prevHoveredFeatures.get(K):null,ht=new Tg(e,N,V,X),lt=rt?rt.stop:V.handler(ht);if(f&&this.hoveredFeatures.set(K,{feature:L,stop:lt}),lt!==!1){I=!0;break}}if(I)break}}if(I)break}if(!I)for(const[L,N]of y){const{handler:V,target:Z}=N;if(!Z&&V(new Tg(e,L,N,null))!==!1)break}}}function Np(p,e){if(Array.isArray(p)&&Array.isArray(e)){const a=new Set(p),f=new Set(e);return a.size===f.size&&p.every(y=>f.has(y))}return i.bx(p,e)}const Vp={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Ef={showCompass:!0,showZoom:!0,visualizePitch:!1};class mh{constructor(e,a,f=!1){this._clickTolerance=10,this.element=a,this.mouseRotate=new wf({clickTolerance:e.dragRotate._mouseRotate._clickTolerance}),this.map=e,f&&(this.mousePitch=new pd({clickTolerance:e.dragRotate._mousePitch._clickTolerance})),i.aX(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener("mousedown",this.mousedown),a.addEventListener("touchstart",this.touchstart,{passive:!1}),a.addEventListener("touchmove",this.touchmove),a.addEventListener("touchend",this.touchend),a.addEventListener("touchcancel",this.reset)}down(e,a){this.mouseRotate.mousedown(e,a),this.mousePitch&&this.mousePitch.mousedown(e,a),En()}move(e,a){const f=this.map,y=this.mouseRotate.mousemoveWindow(e,a),w=y&&y.bearingDelta;if(w&&f.setBearing(f.getBearing()+w),this.mousePitch){const I=this.mousePitch.mousemoveWindow(e,a),M=I&&I.pitchDelta;M&&f.setPitch(f.getPitch()+M)}}off(){const e=this.element;e.removeEventListener("mousedown",this.mousedown),e.removeEventListener("touchstart",this.touchstart),e.removeEventListener("touchmove",this.touchmove),e.removeEventListener("touchend",this.touchend),e.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){$o(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(e){this.down(Object.assign({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),ba(this.element,e)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(e){this.move(e,ba(this.element,e))}mouseup(e){this.mouseRotate.mouseupWindow(e),this.mousePitch&&this.mousePitch.mouseupWindow(e),this.offTemp()}touchstart(e){e.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Os(this.element,e.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>e.preventDefault()},this._startPos))}touchmove(e){e.targetTouches.length!==1?this.reset():(this._lastPos=Os(this.element,e.targetTouches)[0],this.move({preventDefault:()=>e.preventDefault()},this._lastPos))}touchend(e){e.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function xc(p,e,a){if(p=new i.aS(p.lng,p.lat),e){const f=new i.aS(p.lng-360,p.lat),y=new i.aS(p.lng+360,p.lat),w=360*Math.ceil(Math.abs(p.lng-a.center.lng)/360),I=a.locationPoint3D(p).distSqr(e),M=e.x<0||e.y<0||e.x>a.width||e.y>a.height;a.locationPoint3D(f).distSqr(e)<I&&(M||Math.abs(f.lng-a.center.lng)<w)?p=f:a.locationPoint3D(y).distSqr(e)<I&&(M||Math.abs(y.lng-a.center.lng)<w)&&(p=y)}for(;Math.abs(p.lng-a.center.lng)>180;){const f=a.locationPoint3D(p);if(f.x>=0&&f.y>=0&&f.x<=a.width&&f.y<=a.height)break;p.lng>a.center.lng?p.lng-=360:p.lng+=360}return p}const gh={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Na={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Cu extends i.E{constructor(e,a){super(),(e instanceof HTMLElement||a)&&(e=Object.assign({element:e},a)),i.aX(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:f="center",color:y="#3FB1CE",scale:w=1,draggable:I=!1,clickTolerance:M=0,rotation:L=Na.rotation,rotationAlignment:N=Na.rotationAlignment,pitchAlignment:V=Na.pitchAlignment,occludedOpacity:Z=Na.occludedOpacity,altitude:U=Na.altitude}=e||{};this._anchor=f,this._color=y,this._scale=w,this._draggable=I,this._clickTolerance=M,this._rotation=L,this._rotationAlignment=N,this._pitchAlignment=V,this._occludedOpacity=Z,this._altitude=U,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),e&&e.element?(this._element=e.element,this._offset=i.P.convert(e&&e.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=i.P.convert(e&&e.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",rt=>{rt.preventDefault()}),this._element.addEventListener("mousedown",rt=>{rt.preventDefault()});const X=this._element.classList;for(const rt in gh)X.remove(`mapboxgl-marker-anchor-${rt}`);X.add(`mapboxgl-marker-anchor-${this._anchor}`);const K=e&&e.className?e.className.trim().split(/\s+/):[];X.add(...K),this._popup=null}_createDefaultMarker(){const e=Ci("div"),a=Re("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},e);if(this._altitude===0){const f=Re("radialGradient",{id:"shadowGradient"},Re("defs",{},a));Re("stop",{offset:"10%","stop-opacity":.4},f),Re("stop",{offset:"100%","stop-opacity":.05},f),Re("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},a)}return Re("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},a),Re("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},a),Re("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},a),e}addTo(e){return e===this._map||(this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._updateMoving),e.on("moveend",this._update),e.on("remove",this._clearFadeTimer),e._addMarker(this),this.setDraggable(this._draggable),this._update(),e.on("click",this._onMapClick)),this}remove(){const e=this._map;return e&&(e.off("click",this._onMapClick),e.off("move",this._updateMoving),e.off("moveend",this._update),e.off("mousedown",this._addDragHandler),e.off("touchstart",this._addDragHandler),e.off("mouseup",this._onUp),e.off("touchend",this._onUp),e.off("mousemove",this._onMove),e.off("touchmove",this._onMove),e.off("remove",this._clearFadeTimer),e._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=i.aS.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(e){return e===this._altitude||(this._defaultMarker&&(this._altitude===0&&e!==0||this._altitude!==0&&e===0)&&(this._element=this._createDefaultMarker()),this._altitude=e||Na.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const y=Math.sqrt(Math.pow(13.5,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[y,-1*(38.1-13.5+y)],"bottom-right":[-y,-1*(38.1-13.5+y)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=e,e._marker=this,e._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(e){const a=e.code,f=e.charCode||e.keyCode;a!=="Space"&&a!=="Enter"&&f!==32&&f!==13||this.togglePopup()}_onMapClick(e){const a=e.originalEvent.target,f=this._element;this._popup&&(a===f||f.contains(a))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const e=this._popup;return e?(e.isOpen()?(e.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(e.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const e=this._map,a=this._pos;if(!e||!a)return!1;const f=e.unproject(a,this._altitude),y=e.getFreeCameraOptions();if(!y.position)return!1;const w=y.position.toLngLat();return w.distanceTo(f)<.9*w.distanceTo(this._lngLat)}_evaluateOpacity(){const e=this._map;if(!e)return;const a=this._pos;if(!a||a.x<0||a.x>e.transform.width||a.y<0||a.y>e.transform.height)return void this._clearFadeTimer();const f=e.unproject(a,this._altitude);let y;e._showingGlobe()&&i.f4(e.transform,this._lngLat)?y=0:(y=1-e._queryFogOpacity(f),e.transform._terrainEnabled()&&e.getTerrain()&&this._behindTerrain()&&(y*=this._occludedOpacity)),this._element.style.opacity=`${y}`,this._element.style.pointerEvents=y>0?"auto":"none",this._popup&&this._popup._setOpacity(y),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const e=this._pos;if(!e||!this._map)return;const a=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${e.x}px,${e.y}px)
            ${gh[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${a.x}px,${a.y}px)
        `}_calculateXYTransform(){const e=this._pos,a=this._map,f=this.getPitchAlignment();if(!a||!e||f!=="map")return"";if(!a._showingGlobe()){const L=a.getPitch();return L?`rotateX(${L}deg)`:""}const y=i.cW(i.f5(a.transform,this._lngLat)),w=e.sub(i.f6(a.transform)),I=Math.abs(w.x)+Math.abs(w.y);if(I===0)return"";const M=y/I;return`rotateX(${-w.y*M}deg) rotateY(${w.x*M}deg)`}_calculateZTransform(){const e=this._pos,a=this._map;if(!a||!e)return"";let f=0;const y=this.getRotationAlignment();if(y==="map")if(a._showingGlobe()){const w=a.project(new i.aS(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),I=a.project(new i.aS(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(w);f=i.cW(Math.atan2(I.y,I.x))-90}else f=-a.getBearing();else if(y==="horizon"){const w=i.ah(4,6,a.getZoom()),I=i.f6(a.transform);I.y+=w*a.transform.height;const M=e.sub(I),L=i.cW(Math.atan2(M.y,M.x));f=(L>90?L-270:L+90)*(1-w)}return f+=this._rotation,f?`rotateZ(${f}deg)`:""}_update(e){cancelAnimationFrame(this._updateFrameId);const a=this._map;a&&(a.transform.renderWorldCopies&&(this._lngLat=xc(this._lngLat,this._pos,a.transform)),this._pos=a.project(this._lngLat,this._altitude),e===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),a._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(a._showingGlobe()||a.getTerrain()||a.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(e){return this._offset=i.P.convert(e),this._update(),this}addClassName(e){return this._element.classList.add(e),this}removeClassName(e){return this._element.classList.remove(e),this}toggleClassName(e){return this._element.classList.toggle(e)}_onMove(e){const a=this._map;if(!a)return;const f=this._pointerdownPos,y=this._positionDelta;if(f&&y){if(!this._isDragging){const w=this._clickTolerance||a._clickTolerance;if(e.point.dist(f)<w)return;this._isDragging=!0}this._pos=e.point.sub(y),this._lngLat=a.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new i.z("dragstart"))),this.fire(new i.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const e=this._map;e&&(e.off("mousemove",this._onMove),e.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new i.z("dragend")),this._state="inactive"}_addDragHandler(e){const a=this._map,f=this._pos;a&&f&&this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(f),this._pointerdownPos=e.point,this._state="pending",a.on("mousemove",this._onMove),a.on("touchmove",this._onMove),a.once("mouseup",this._onUp),a.once("touchend",this._onUp))}setDraggable(e){this._draggable=!!e;const a=this._map;return a&&(e?(a.on("mousedown",this._addDragHandler),a.on("touchstart",this._addDragHandler)):(a.off("mousedown",this._addDragHandler),a.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||Na.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||Na.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e||Na.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(e){return this._occludedOpacity=e||Na.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const _h={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},y_={maxWidth:100,unit:"metric"},x_={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},v_={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},Vm=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Um(p=new i.P(0,0),e="bottom"){if(typeof p=="number"){const a=Math.round(Math.sqrt(.5*Math.pow(p,2)));switch(e){case"top":return new i.P(0,p);case"top-left":return new i.P(a,a);case"top-right":return new i.P(-a,a);case"bottom":return new i.P(0,-p);case"bottom-left":return new i.P(a,-a);case"bottom-right":return new i.P(-a,-a);case"left":return new i.P(p,0);case"right":return new i.P(-p,0)}return new i.P(0,0)}return p instanceof i.P||Array.isArray(p)?i.P.convert(p):i.P.convert(p[e]||[0,0])}return{version:Le,supported:xr.supported,setRTLTextPlugin:i.fa,getRTLTextPluginStatus:i.f9,Map:class extends tu{constructor(p){nr.mark(wi.create);const e=p;if((p=Object.assign({},Vp,p)).minZoom!=null&&p.maxZoom!=null&&p.minZoom>p.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(p.minPitch!=null&&p.maxPitch!=null&&p.minPitch>p.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(p.minPitch!=null&&p.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(p.maxPitch!=null&&p.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(p.antialias&&i.f2(window)&&(p.antialias=!1,i.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Rc(p.minZoom,p.maxZoom,p.minPitch,p.maxPitch,p.renderWorldCopies,null,null),p),this._repaint=!!p.repaint,this._interactive=p.interactive,this._minTileCacheSize=p.minTileCacheSize,this._maxTileCacheSize=p.maxTileCacheSize,this._failIfMajorPerformanceCaveat=p.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=p.preserveDrawingBuffer,this._antialias=p.antialias,this._trackResize=p.trackResize,this._bearingSnap=p.bearingSnap,this._refreshExpiredTiles=p.refreshExpiredTiles,this._fadeDuration=p.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=p.crossSourceCollisions,this._collectResourceTiming=p.collectResourceTiming,this._language=this._parseLanguage(p.language),this._worldview=p.worldview,this._renderTaskQueue=new Om,this._domRenderTaskQueue=new Om,this._controls=[],this._markers=[],this._popups=[],this._mapId=i.b1(),this._locale=Object.assign({},__,p.locale),this._clickTolerance=p.clickTolerance,this._cooperativeGestures=p.cooperativeGestures,this._performanceMetricsCollection=p.performanceMetricsCollection,this._tessellationStep=p.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=p.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Op(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=p.scaleFactor,this._requestManager=new sc(p.transformRequest,p.accessToken,p.testMode),this._silenceAuthErrors=!!p.testMode,this._contextCreateOptions=p.contextCreateOptions?Object.assign({},p.contextCreateOptions):{},typeof p.container=="string"){const a=document.getElementById(p.container);if(!a)throw new Error(`Container '${p.container.toString()}' not found.`);this._container=a}else{if(!(p.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=p.container}if(this._container.childNodes.length>0&&i.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),p.maxBounds&&this.setMaxBounds(p.maxBounds),this._spriteFormat=p.spriteFormat,i.aX(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new ss),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Tf(this,p),this._localFontFamily=p.localFontFamily,this._localIdeographFontFamily=p.localIdeographFontFamily,(p.style||!p.testMode)&&this.setStyle(p.style||i.e.DEFAULT_STYLE,{config:p.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),p.projection&&this.setProjection(p.projection),p.hash&&(this._hash=new ys(typeof p.hash=="string"&&p.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){e.center==null&&e.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:p.center,zoom:p.zoom,bearing:p.bearing,pitch:p.pitch});const a=p.bounds;a&&(this.resize(),this.fitBounds(a,Object.assign({},p.fitBoundsOptions,{duration:0})))}this.resize(),p.attributionControl&&this.addControl(new Wd({customAttribution:p.customAttribution})),this._logoControl=new Sf,this.addControl(this._logoControl,p.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()}),this.on("data",a=>{this._update(a.dataType==="style"),this.fire(new i.z(`${a.dataType}data`,a))}),this.on("dataloading",a=>{this.fire(new i.z(`${a.dataType}dataloading`,a))}),this._interactions=new Nm(this)}_getMapId(){return this._mapId}addControl(p,e){if(e===void 0&&(e=p.getDefaultPosition?p.getDefaultPosition():"top-right"),!p||!p.onAdd)return this.fire(new i.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const a=p.onAdd(this);this._controls.push(p);const f=this._controlPositions[e];return e.indexOf("bottom")!==-1?f.insertBefore(a,f.firstChild):f.appendChild(a),this}removeControl(p){if(!p||!p.onRemove)return this.fire(new i.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const e=this._controls.indexOf(p);return e>-1&&this._controls.splice(e,1),p.onRemove(this),this}hasControl(p){return this._controls.indexOf(p)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(p){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const e=!this._moving;return e&&this.fire(new i.z("movestart",p)).fire(new i.z("move",p)),this.fire(new i.z("resize",p)),e&&this.fire(new i.z("moveend",p)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(p){return this.transform.setMaxBounds(i.aI.convert(p)),this._update()}setMinZoom(p){if((p=p??-2)>=-2&&p<=this.transform.maxZoom)return this.transform.minZoom=p,this._update(),this.getZoom()<p?this.setZoom(p):this.fire(new i.z("zoomstart")).fire(new i.z("zoom")).fire(new i.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(p){if((p=p??22)>=this.transform.minZoom)return this.transform.maxZoom=p,this._update(),this.getZoom()>p?this.setZoom(p):this.fire(new i.z("zoomstart")).fire(new i.z("zoom")).fire(new i.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(p){if((p=p??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(p>=0&&p<=this.transform.maxPitch)return this.transform.minPitch=p,this._update(),this.getPitch()<p?this.setPitch(p):this.fire(new i.z("pitchstart")).fire(new i.z("pitch")).fire(new i.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(p){if((p=p??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(p>=this.transform.minPitch)return this.transform.maxPitch=p,this._update(),this.getPitch()>p?this.setPitch(p):this.fire(new i.z("pitchstart")).fire(new i.z("pitch")).fire(new i.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(p){return this._scaleFactor=p,this.painter.scaleFactor=p,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(e=>e.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(p){return this.transform.renderWorldCopies=p,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(p){return p==="auto"?navigator.language:Array.isArray(p)?p.length===0?void 0:p.map(e=>e==="auto"?navigator.language:e):p}setLanguage(p){const e=this._parseLanguage(p);if(!this.style||e===this._language)return this;this._language=e,this.style.reloadSources();for(const a of this._controls)a._setLanguage&&a._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(p){return this.style&&p!==this._worldview?(this._worldview=p,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(p){return this._lazyInitEmptyStyle(),p?typeof p=="string"&&(p={name:p}):p=null,this._useExplicitProjection=!!p,this._prioritizeAndUpdateProjection(p,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const p=this.transform,e=p.projection.name;let a;e==="globe"&&p.zoom>=i.cK?(p.setMercatorFromTransition(),a=!0):e==="mercator"&&p.zoom<i.cK&&(p.setProjection({name:"globe"}),a=!0),a&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(p,e){return this._updateProjection(p||e||{name:"mercator"})}_updateProjection(p){let e;const a=this.transform.mercatorFromTransition;e=p.name==="globe"&&this.transform.zoom>=i.cK?this.transform.setMercatorFromTransition():this.transform.setProjection(p),this.style.applyProjectionUpdate();const f=this.transform.getProjection().name==="mercator"&&a!==this.transform.mercatorFromTransition;return(e||f)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(p,e){return this.transform.locationPoint3D(i.aS.convert(p),e)}unproject(p,e){return this.transform.pointLocation3D(i.P.convert(p),e)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(p,e,a){const f=y=>{let w=[];if(Array.isArray(e)){const I=e.filter(M=>this.getLayer(M));w=I.length?this.queryRenderedFeatures(y,{layers:I}):[]}else w=this.queryRenderedFeatures(y,{target:e});return w};if(p==="mouseenter"||p==="mouseover"){let y=!1;return{listener:a,targets:e,delegates:{mousemove:I=>{const M=f(I.point);M.length?y||(y=!0,a.call(this,new ro(p,this,I.originalEvent,{features:M}))):y=!1},mouseout:()=>{y=!1}}}}if(p==="mouseleave"||p==="mouseout"){let y=!1;return{listener:a,targets:e,delegates:{mousemove:M=>{f(M.point).length?y=!0:y&&(y=!1,a.call(this,new ro(p,this,M.originalEvent)))},mouseout:M=>{y&&(y=!1,a.call(this,new ro(p,this,M.originalEvent)))}}}}{const y=w=>{const I=f(w.point);I.length&&(w.features=I,a.call(this,w),delete w.features)};return{listener:a,targets:e,delegates:{[p]:y}}}}on(p,e,a){if(typeof e=="function"||a===void 0)return super.on(p,e);if(typeof e=="string"&&(e=[e]),!this._areTargetsValid(e))return this;const f=this._createDelegatedListener(p,e,a);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[p]=this._delegatedListeners[p]||[],this._delegatedListeners[p].push(f);for(const y in f.delegates)this.on(y,f.delegates[y]);return this}once(p,e,a){if(typeof e=="function"||a===void 0)return super.once(p,e);if(typeof e=="string"&&(e=[e]),!this._areTargetsValid(e))return this;const f=this._createDelegatedListener(p,e,a);for(const y in f.delegates)this.once(y,f.delegates[y]);return this}off(p,e,a){if(typeof e=="function"||a===void 0)return super.off(p,e);if(typeof e=="string"&&(e=[e]),!this._areTargetsValid(e))return this;const f=this._delegatedListeners?this._delegatedListeners[p]:void 0;return f&&(y=>{for(let w=0;w<y.length;w++){const I=y[w];if(I.listener===a&&Np(I.targets,e)){for(const M in I.delegates)this.off(M,I.delegates[M]);return y.splice(w,1),this}}})(f),this}queryRenderedFeatures(p,e){if(!this.style)return[];if(p===void 0||p instanceof i.P||Array.isArray(p)||e!==void 0||(e=p,p=void 0),p=p||[[0,0],[this.transform.width,this.transform.height]],!e){const w=this.style.queryRenderedFeatures(p,void 0,this.transform),I=this.style.queryRenderedFeatureset(p,void 0,this.transform);return w.concat(I)}let a=!0;if(e.target&&(a=this._isTargetValid(e.target),a&&!e.layers))return this.style.queryRenderedFeatureset(p,e,this.transform);let f=!0;if(e.layers&&Array.isArray(e.layers)){for(const w of e.layers)if(!this._isValidId(w)){f=!1;break}if(f&&!e.target)return this.style.queryRenderedFeatures(p,e,this.transform)}let y=[];return f&&(y=y.concat(this.style.queryRenderedFeatures(p,e,this.transform))),a&&(y=y.concat(this.style.queryRenderedFeatureset(p,e,this.transform))),y}querySourceFeatures(p,e){return!p||typeof p=="string"&&!this._isValidId(p)?[]:this.style.querySourceFeatures(p,e)}queryRasterValue(p,e,a){return this._isValidId(p)?this.style.queryRasterValue(p,e,a):Promise.resolve(null)}isPointOnSurface(p){const{name:e}=this.transform.projection;return e!=="globe"&&e!=="mercator"&&i.w(`${e} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(i.P.convert(p))}addInteraction(p,e){return this._interactions.add(p,e),this}removeInteraction(p){return this._interactions.remove(p),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(p){return this._cooperativeGestures=p,this}setStyle(p,e){return e=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},e),this.style&&p&&e.diff!==!1&&e.localFontFamily===this._localFontFamily&&e.localIdeographFontFamily===this._localIdeographFontFamily&&!e.config?(this.style._diffStyle(p,(a,f)=>{if(a){const y=typeof a=="string"?a:a instanceof Error?a.message:a.error;i.w(`Unable to perform style diff: ${y}. Rebuilding the style from scratch.`),this._updateStyle(p,e)}else f&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=e.localIdeographFontFamily,this._localFontFamily=e.localFontFamily,this._updateStyle(p,e))}_getUIString(p){const e=this._locale[p];if(e==null)throw new Error(`Missing UI string '${p}'`);return e}_updateStyle(p,e){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),p){const a=Object.assign({},e);e&&e.config&&(a.initialConfig=e.config,delete a.config),this.style=new Ia(this,a).load(p),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Ia(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(i.w("There is no style added to the map."),!1)}_isValidId(p){return p==null?(this.fire(new i.y(new Error("IDs can't be empty."))),!1):!i.dq(p)||(this.fire(new i.y(new Error(`IDs can't contain special symbols: "${p}".`))),!1)}_isTargetValid(p){return"featuresetId"in p?this._isValidId("importId"in p?p.importId:p.featuresetId):"layerId"in p&&this._isValidId(p.layerId)}_areTargetsValid(p){if(Array.isArray(p)){for(const e of p)if(!this._isValidId(e))return!1;return!0}return this._isTargetValid(p)}addSource(p,e){return this._isValidId(p)?(this._lazyInitEmptyStyle(),this.style.addSource(p,e),this._update(!0)):this}isSourceLoaded(p){return!!this._isValidId(p)&&!!this.style&&this.style._isSourceCacheLoaded(p)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(p,e,a){this._lazyInitEmptyStyle(),this.style.addSourceType(p,e,a)}removeSource(p){return this._isValidId(p)?(this.style.removeSource(p),this._updateTerrain(),this._update(!0)):this}getSource(p){return this._isValidId(p)?this.style.getOwnSource(p):null}addImage(p,e,{pixelRatio:a=1,sdf:f=!1,stretchX:y,stretchY:w,content:I}={}){this._lazyInitEmptyStyle();const M=i.I.from(p);if(e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap){const{width:L,height:N,data:V}=i.o.getImageData(e);this.style.addImage(M,{data:new i.q({width:L,height:N},V),pixelRatio:a,stretchX:y,stretchY:w,content:I,sdf:f,version:0,usvg:!1})}else if(e.width===void 0||e.height===void 0)this.fire(new i.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:L,height:N}=e,V=e;this.style.addImage(M,{data:new i.q({width:L,height:N},new Uint8Array(V.data)),pixelRatio:a,stretchX:y,stretchY:w,content:I,sdf:f,usvg:!1,version:0,userImage:V}),V.onAdd&&V.onAdd(this,p)}}updateImage(p,e){this._lazyInitEmptyStyle();const a=i.I.from(p),f=this.style.getImage(a);if(!f)return void this.fire(new i.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const y=e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap?i.o.getImageData(e):e,{width:w,height:I,data:M}=y;if(w===void 0||I===void 0)return void this.fire(new i.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(w!==(f.usvg?f.icon.usvg_tree.width:f.data.width)||I!==(f.usvg?f.icon.usvg_tree.height:f.data.height))return void this.fire(new i.y(new Error(`The width and height of the updated image (${w}, ${I})
                must be that same as the previous version of the image
                (${f.data.width}, ${f.data.height})`)));const L=!(e instanceof HTMLImageElement||ImageBitmap&&e instanceof ImageBitmap);let N=!1;f.usvg?(f.data=new i.q({width:w,height:I},new Uint8Array(M)),f.usvg=!1,f.icon=void 0,N=!0):f.data.replace(M,L),this.style.updateImage(a,f,N)}hasImage(p){return p?!!this.style&&!!this.style.getImage(i.I.from(p)):(this.fire(new i.y(new Error("Missing required image id"))),!1)}removeImage(p){this.style.removeImage(i.I.from(p))}loadImage(p,e){i.n(this._requestManager.transformRequest(p,i.R.Image),(a,f)=>{e(a,f instanceof HTMLImageElement?i.o.getImageData(f):f)})}listImages(){return this.style.listImages().map(p=>p.name)}addModel(p,e){this._lazyInitEmptyStyle(),this.style.addModel(p,e)}hasModel(p){return p?this.style.hasModel(p):(this.fire(new i.y(new Error("Missing required model id"))),!1)}removeModel(p){this.style.removeModel(p)}listModels(){return this.style.listModels()}addLayer(p,e){return this._isValidId(p.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(p,e),this._update(!0)):this}getSlot(p){const e=this.getLayer(p);return e&&e.slot||null}setSlot(p,e){return this.style.setSlot(p,e),this.style.mergeLayers(),this._update(!0)}addImport(p,e){return this.style.addImport(p,e).catch(a=>this.fire(new i.y(new Error("Failed to add import",a)))),this}updateImport(p,e){return typeof e!="string"&&e.id!==p?(this.removeImport(p),this.addImport(e)):(this.style.updateImport(p,e),this._update(!0))}removeImport(p){return this.style.removeImport(p),this}moveImport(p,e){return this.style.moveImport(p,e),this._update(!0)}moveLayer(p,e){return this._isValidId(p)?(this.style.moveLayer(p,e),this._update(!0)):this}removeLayer(p){return this._isValidId(p)?(this.style.removeLayer(p),this._update(!0)):this}getLayer(p){if(!this._isValidId(p))return null;const e=this.style.getOwnLayer(p);return e?e.type==="custom"?e.implementation:e.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(p,e,a){return this._isValidId(p)?(this.style.setLayerZoomRange(p,e,a),this._update(!0)):this}setFilter(p,e,a={}){return this._isValidId(p)?(this.style.setFilter(p,e,a),this._update(!0)):this}getFilter(p){return this._isValidId(p)?this.style.getFilter(p):null}setPaintProperty(p,e,a,f={}){return this._isValidId(p)?(this.style.setPaintProperty(p,e,a,f),this._update(!0)):this}getPaintProperty(p,e){return this._isValidId(p)?this.style.getPaintProperty(p,e):null}setLayoutProperty(p,e,a,f={}){return this._isValidId(p)?(this.style.setLayoutProperty(p,e,a,f),this._update(!0)):this}getLayoutProperty(p,e){return this._isValidId(p)?this.style.getLayoutProperty(p,e):null}setLayerProperty(p,e,a,f={}){return this._isValidId(p)?(this.style.setLayerProperty(p,e,a,f),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(p){return this.style.setGlyphsUrl(p),this._update(!0)}getSchema(p){return this.style.getSchema(p)}setSchema(p,e){return this.style.setSchema(p,e),this._update(!0)}getConfig(p){return this.style.getConfig(p)}setConfig(p,e){return this.style.setConfig(p,e),this._update(!0)}getConfigProperty(p,e){return this.style.getConfigProperty(p,e)}setConfigProperty(p,e,a){return this.style.setConfigProperty(p,e,a),this._update(!0)}getFeaturesetDescriptors(p){return this.style.getFeaturesetDescriptors(p)}setLights(p){if(this._lazyInitEmptyStyle(),p&&p.length===1&&p[0].type==="flat"){const e=p[0];e.properties?this.style.setFlatLight(e.properties,e.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(p),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const p=this.style.getLights()||[];return p.length===0&&p.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),p}setLight(p,e={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:p}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(p){return this._lazyInitEmptyStyle(),!p&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(p),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(p){return this._lazyInitEmptyStyle(),this.style.setFog(p),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(p){return this._lazyInitEmptyStyle(),this.style.setSnow(p),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(p){return this._lazyInitEmptyStyle(),this.style.setRain(p),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(p){return this._lazyInitEmptyStyle(),this.style.setColorTheme(p),this._update(!0)}setImportColorTheme(p,e){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(p,e),this._update(!0)}setCamera(p){return this.style.setCamera(p),this._triggerCameraUpdate(p)}_triggerCameraUpdate(p){return this._update(this.transform.setOrthographicProjectionAtLowPitch(p["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(p){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(i.aS.convert(p),this.transform):0}setFeatureState(p,e){return p.source&&!this._isValidId(p.source)?this:(this.style.setFeatureState(p,e),this._update())}removeFeatureState(p,e){return p.source&&!this._isValidId(p.source)?this:(this.style.removeFeatureState(p,e),this._update())}getFeatureState(p){return p.source&&!this._isValidId(p.source)?null:this.style.getFeatureState(p)}_selectIndoorFloor(p){this.indoor.selectFloor(p)}_setIndoorActiveFloorsVisibility(p){this.indoor.setActiveFloorsVisibility(p)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new If),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const p=this._container.getBoundingClientRect().width||400,e=this._container.getBoundingClientRect().height||300;let a,f,y,w=this._container;for(;w&&(!f||!y);){const I=window.getComputedStyle(w).transform;I&&I!=="none"&&(a=I.match(/matrix.*\((.+)\)/)[1].split(", "),a[0]&&a[0]!=="0"&&a[0]!=="1"&&(f=a[0]),a[3]&&a[3]!=="0"&&a[3]!=="1"&&(y=a[3])),w=w.parentElement}this._containerWidth=f?Math.abs(p/f):p,this._containerHeight=y?Math.abs(e/y):e}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&i.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new ua(this.style),this.on("load",()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}),this.on("idle",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})}))}_setupContainer(){const p=this._container;p.classList.add("mapboxgl-map"),(this._missingCSSCanary=Ci("div","mapboxgl-canary",p)).style.visibility="hidden",this._detectMissingCSS();const e=this._canvasContainer=Ci("div","mapboxgl-canvas-container",p);this._canvas=Ci("canvas","mapboxgl-canvas",e),this._interactive&&(e.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const a=this._controlContainer=Ci("div","mapboxgl-control-container",p),f=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(y=>{f[y]=Ci("div",`mapboxgl-ctrl-${y}`,a)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(p,e){const a=i.o.devicePixelRatio||1;this._canvas.width=a*Math.ceil(p),this._canvas.height=a*Math.ceil(e),this._canvas.style.width=`${p}px`,this._canvas.style.height=`${e}px`}_addMarker(p){this._markers.push(p)}_removeMarker(p){const e=this._markers.indexOf(p);e!==-1&&this._markers.splice(e,1)}_addPopup(p){this._popups.push(p)}_removePopup(p){const e=this._popups.indexOf(p);e!==-1&&this._popups.splice(e,1)}_setupPainter(){const p=Object.assign({},xr.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),e=this._canvas.getContext("webgl2",p);e?(ho(e,!0),this.painter=new Bo(e,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",a=>{a.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),i.k.testSupport(e)):this.fire(new i.y(new Error("Failed to initialize WebGL")))}_contextLost(p){p.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new i.z("webglcontextlost",{originalEvent:p}))}_contextRestored(p){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new i.z("webglcontextrestored",{originalEvent:p}))}_onMapScroll(p){if(p.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(p){return this.style?(this._styleDirty=this._styleDirty||p,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(p){return this._update(),this._renderTaskQueue.add(p)}_cancelRenderFrame(p){this._renderTaskQueue.remove(p)}_requestDomTask(p){!this.loaded()||this.loaded()&&!this.isMoving()?p():this._domRenderTaskQueue.add(p)}_render(p){let e;this.fire(new i.z("renderstart")),++this._frameId;const a=this.painter.context.extTimerQuery,f=i.o.now(),y=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(e=y.createQuery(),y.beginQuery(a.TIME_ELAPSED_EXT,e)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(p),this._domRenderTaskQueue.run(p),this._removed)return;this._updateProjectionTransition();const w=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const N=this.transform.zoom,V=this.transform.pitch,Z=i.o.now(),U=new i.ac(N,{now:Z,fadeDuration:w,pitch:V,transition:this.style.transition,worldview:this._worldview});this.style.update(U)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let I=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),I=this._updateAverageElevation(f),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):I=this._updateAverageElevation(f);const M=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,w,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),M&&(this._placementDirty=M.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:w,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new i.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,nr.mark(wi.load),this.fire(new i.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),e){const N=i.o.now()-f;y.endQuery(a.TIME_ELAPSED_EXT),setTimeout(()=>{const V=y.getQueryParameter(e,y.QUERY_RESULT)/1e6;y.deleteQuery(e),this.fire(new i.z("gpu-timing-frame",{cpuTime:N,gpuTime:V}))},50)}if(this.listens("gpu-timing-layer")){const N=this.painter.collectGpuTimers();setTimeout(()=>{const V=this.painter.queryGpuTimers(N);this.fire(new i.z("gpu-timing-layer",{layerTimes:V}))},50)}if(this.listens("gpu-timing-deferred-render")){const N=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const V=this.painter.queryGpuTimeDeferredRender(N);this.fire(new i.z("gpu-timing-deferred-render",{gpuTime:V}))},50)}const L=this._sourcesDirty||this._styleDirty||this._placementDirty||I;if(L||this._repaint)this.triggerRepaint();else{const N=this.idle();if(N&&(I=this._updateAverageElevation(f,!0)),I)this.triggerRepaint();else if(this._triggerFrame(!1),N&&(this.fire(new i.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const V=this._calculateSpeedIndex();this.fire(new i.z("speedindexcompleted",{speedIndex:V})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||L||(this._fullyLoaded=!0,nr.mark(wi.fullLoad),this._performanceMetricsCollection&&Xr(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(p){for(const e of this._markers)p&&!this.getRenderWorldCopies()&&(e._lngLat=e._lngLat.wrap()),e._update();for(const e of this._popups)!p||this.getRenderWorldCopies()||e._trackPointer||(e._lngLat=e._lngLat.wrap()),e._update()}_updateAverageElevation(p,e=!1){const a=y=>(this.transform.averageElevation=y,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&a(0);const f=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(f||(e||p-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(p)){const y=this.transform.averageElevation;let w=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(w)?w=0:this._averageElevationLastSampledAt=p;const I=Math.abs(y-w);if(I>1){if(this._isInitialLoad||f)return this._averageElevation.jumpTo(w),a(w);this._averageElevation.easeTo(w,p,300)}else if(I>1e-4)return this._averageElevation.jumpTo(w),a(w)}return!!this._averageElevation.isEasing(p)&&a(this._averageElevation.getValue(p))}_authenticate(){qo(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,p=>{if(p&&(p.message===Hr||p.status===401)){const e=this.painter.context.gl;ho(e,!1),this._logoControl instanceof Sf&&this._logoControl._updateLogo(),e&&e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new i.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),di(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&fr(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&qr(this._requestManager._customAccessToken)}_updateTerrain(){const p=this._isDragging();this.painter.updateTerrain(this.style,p)}_calculateSpeedIndex(){const p=this.painter.canvasCopy(),e=this.painter.getCanvasCopiesAndTimestamps();e.timeStamps.push(performance.now());const a=this.painter.context.gl,f=a.createFramebuffer();function y(w){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,w,0);const I=new Uint8Array(a.drawingBufferWidth*a.drawingBufferHeight*4);return a.readPixels(0,0,a.drawingBufferWidth,a.drawingBufferHeight,a.RGBA,a.UNSIGNED_BYTE,I),I}return a.bindFramebuffer(a.FRAMEBUFFER,f),this._canvasPixelComparison(y(p),e.canvasCopies.map(y),e.timeStamps)}_canvasPixelComparison(p,e,a){let f=a[1]-a[0];const y=p.length/4;for(let w=0;w<e.length;w++){const I=e[w];let M=0;for(let L=0;L<I.length;L+=4)I[L]===p[L]&&I[L+1]===p[L+1]&&I[L+2]===p[L+2]&&I[L+3]===p[L+3]&&(M+=1);f+=(a[w+2]-a[w+1])*(1-M/y)}return f}remove(){this._hash&&this._hash.remove();for(const e of this._controls)e.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const p=this.painter.context.gl.getExtension("WEBGL_lose_context");p&&p.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),On.delete(this.painter.context.gl),$n.remove(),Hn.remove(),this._removed=!0,this.fire(new i.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(p){this._renderNextFrame=this._renderNextFrame||p,this.style&&!this._frame&&(this._frame=i.o.frame(e=>{const a=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,a&&this._render(e)}))}_preloadTiles(p){const e=this.style?this.style.getSourceCaches():[];return i.bv(e,(a,f)=>a._preloadTiles(p,f),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(p){this._trackResize&&this.resize({originalEvent:p})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(p){this._showTileBoundaries!==p&&(this._showTileBoundaries=p,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(p){this._showParseStatus!==p&&(this._showParseStatus=p,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(p){this._showTerrainWireframe!==p&&(this._showTerrainWireframe=p,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(p){this._showLayers2DWireframe!==p&&(this._showLayers2DWireframe=p,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(p){this._showLayers3DWireframe!==p&&(this._showLayers3DWireframe=p,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(p){this._speedIndexTiming!==p&&(this._speedIndexTiming=p,this._update())}get showPadding(){return!!this._showPadding}set showPadding(p){this._showPadding!==p&&(this._showPadding=p,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(p){this._showCollisionBoxes!==p&&(this._showCollisionBoxes=p,this._tp.refreshUI(),p?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(p){this._showOverdrawInspector!==p&&(this._showOverdrawInspector=p,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(p){this._repaint!==p&&(this._repaint=p,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(p){this._vertices=p,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(p){this._showTileAABBs!==p&&(this._showTileAABBs=p,this._tp.refreshUI(),p&&this._update())}_setCacheLimits(p,e){i.f3(p,e)}get version(){return Le}},NavigationControl:class{constructor(p={}){this.options=Object.assign({},Ef,p),this._container=Ci("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",e=>e.preventDefault()),this.options.showZoom&&(i.aX(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",e=>{this._map&&this._map.zoomIn({},{originalEvent:e})}),Ci("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",e=>{this._map&&this._map.zoomOut({},{originalEvent:e})}),Ci("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(i.aX(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",e=>{const a=this._map;a&&(this.options.visualizePitch?a.resetNorthPitch({},{originalEvent:e}):a.resetNorth({},{originalEvent:e}))}),this._compassIcon=Ci("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const p=this._map;if(!p)return;const e=p.getZoom(),a=e===p.getMaxZoom(),f=e===p.getMinZoom();this._zoomInButton.disabled=a,this._zoomOutButton.disabled=f,this._zoomInButton.setAttribute("aria-disabled",a.toString()),this._zoomOutButton.setAttribute("aria-disabled",f.toString())}_rotateCompassArrow(){const p=this._map;if(!p)return;const e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(p.transform.pitch*(Math.PI/180)),.5)}) rotateX(${p.transform.pitch}deg) rotateZ(${p.transform.angle*(180/Math.PI)}deg)`:`rotate(${p.transform.angle*(180/Math.PI)}deg)`;p._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=e)})}onAdd(p){return this._map=p,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),p.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&p.on("pitch",this._rotateCompassArrow),p.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new mh(p,this._compass,this.options.visualizePitch)),this._container}onRemove(){const p=this._map;p&&(this._container.remove(),this.options.showZoom&&p.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&p.off("pitch",this._rotateCompassArrow),p.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(p,e){const a=Ci("button",p,this._container);return a.type="button",a.addEventListener("click",e),a}_setButtonTitle(p,e){if(!this._map)return;const a=this._map._getUIString(`NavigationControl.${e}`);p.setAttribute("aria-label",a),p.firstElementChild&&p.firstElementChild.setAttribute("title",a)}},GeolocateControl:class extends i.E{constructor(p={}){super();const e=navigator.geolocation;this.options=Object.assign({geolocation:e},_h,p),i.aX(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Oo(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(p){return this._map=p,this._container=Ci("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(p){const e=(a=!!this.options.geolocation)=>{this._supportsGeolocation=a,p(a)};this._supportsGeolocation!==void 0?p(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(a=>e(a.state!=="denied")).catch(()=>e()):e()}_isOutOfMapMaxBounds(p){const e=this._map.getMaxBounds(),a=p.coords;return!!e&&(a.longitude<e.getWest()||a.longitude>e.getEast()||a.latitude<e.getSouth()||a.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(p){if(this._map){if(this._isOutOfMapMaxBounds(p))return this._setErrorState(),this.fire(new i.z("outofmaxbounds",p)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=p,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(p),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(p),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.z("geolocate",Object.assign({coords:p.coords,timestamp:p.timestamp},p.toJSON?{toJSON:p.toJSON.bind(p)}:{}))),this._finish()}}_updateCamera(p){const e=new i.aS(p.coords.longitude,p.coords.latitude),a=p.coords.accuracy,f=this._map.getBearing(),y=Object.assign({bearing:f},this.options.fitBoundsOptions);this._map.fitBounds(e.toBounds(a),y,{geolocateSource:!0})}_updateMarker(p){if(p){const e=new i.aS(p.coords.longitude,p.coords.latitude);this._accuracyCircleMarker.setLngLat(e).addTo(this._map),this._userLocationDotMarker.setLngLat(e).addTo(this._map),this._accuracy=p.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const p=this._map.transform,e=i.ce(1,p._center.lat)*p.worldSize,a=Math.ceil(2*this._accuracy*e);this._circleElement.style.width=`${a}px`,this._circleElement.style.height=`${a}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(p){if(this._map){if(this.options.trackUserLocation)if(p.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(p.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.z("error",p)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(p){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",e=>e.preventDefault()),this._geolocateButton=Ci("button","mapboxgl-ctrl-geolocate",this._container),Ci("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",p===!1){i.w("Geolocation support is not available so the GeolocateControl will be disabled.");const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}else{const e=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Ci("div","mapboxgl-user-location"),this._dotElement.appendChild(Ci("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Ci("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Cu({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Ci("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Cu({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",e=>{e.geolocateSource||this._watchState!=="ACTIVE_LOCK"||e.originalEvent&&e.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new i.z("trackuserlocationend")))})}}_onDeviceOrientation(p){this._userLocationDotMarker&&(p.webkitCompassHeading?this._heading=p.webkitCompassHeading:p.absolute===!0&&(this._heading=-1*p.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return i.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new i.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new i.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new i.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let p;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(p={maximumAge:6e5,timeout:0},this._noTimeout=!0):(p=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,p),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const p=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(e=>{e==="granted"&&p()}).catch(console.error):p()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Wd,ScaleControl:class{constructor(p={}){this.options=Object.assign({},y_,p),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),i.aX(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const p=this.options.maxWidth||100,e=this._map,a=e._containerHeight/2,f=e._containerWidth/2-p/2,y=e.unproject([f,a]),w=e.unproject([f+p,a]),I=y.distanceTo(w);if(this.options.unit==="imperial"){const M=3.2808*I;M>5280?this._setScale(p,M/5280,"mile"):this._setScale(p,M,"foot")}else this.options.unit==="nautical"?this._setScale(p,I/1852,"nautical-mile"):I>=1e3?this._setScale(p,I/1e3,"kilometer"):this._setScale(p,I,"meter")}_setScale(p,e,a){this._map._requestDomTask(()=>{const f=function(w){const I=Math.pow(10,`${Math.floor(w)}`.length-1);let M=w/I;return M=M>=10?10:M>=5?5:M>=3?3:M>=2?2:M>=1?1:function(L){const N=Math.pow(10,Math.ceil(-Math.log(L)/Math.LN10));return Math.round(L*N)/N}(M),I*M}(e),y=f/e;this._container.innerHTML=this._isNumberFormatSupported&&a!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:a}).format(f):`${f}&nbsp;${x_[a]}`,this._container.style.width=p*y+"px"})}onAdd(p){return this._map=p,this._language=p.getLanguage(),this._container=Ci("div","mapboxgl-ctrl mapboxgl-ctrl-scale",p.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(p){this._language=p,this._update()}setUnit(p){this.options.unit=p,this._update()}},FullscreenControl:class{constructor(p={}){this._fullscreen=!1,p&&p.container&&(p.container instanceof HTMLElement?this._container=p.container:i.w("Full screen control 'container' must be a DOM element.")),i.aX(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(p){return this._map=p,this._container||(this._container=this._map.getContainer()),this._controlContainer=Ci("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",i.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const p=this._fullscreenButton=Ci("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Ci("span","mapboxgl-ctrl-icon",p).setAttribute("aria-hidden","true"),p.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const p=this._getTitle();this._fullscreenButton.setAttribute("aria-label",p),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",p)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:If,Popup:class extends i.E{constructor(p){super(),this.options=Object.assign(Object.create(v_),p),this._altitude=this.options.altitude,i.aX(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(p&&p.className?p.className.trim().split(/\s+/):[])}addTo(p){return this._map&&this.remove(),this._map=p,this.options.closeOnClick&&p.on("preclick",this._onClose),this.options.closeOnMove&&p.on("move",this._onClose),p.on("remove",this.remove),this._update(),p._addPopup(this),this._focusFirstElement(),this._trackPointer?(p.on("mousemove",this._onMouseEvent),p.on("mouseup",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")):p.on("move",this._update),this.fire(new i.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const p=this._map;return p&&(p.off("move",this._update),p.off("move",this._onClose),p.off("preclick",this._onClose),p.off("click",this._onClose),p.off("remove",this.remove),p.off("mousemove",this._onMouseEvent),p.off("mouseup",this._onMouseEvent),p.off("drag",this._onMouseEvent),p._canvasContainer&&p._canvasContainer.classList.remove("mapboxgl-track-pointer"),p._removePopup(this),this._map=void 0),this.fire(new i.z("close")),this}getLngLat(){return this._lngLat}setLngLat(p){this._lngLat=i.aS.convert(p),this._pos=null,this._trackPointer=!1,this._update();const e=this._map;return e&&(e.on("move",this._update),e.off("mousemove",this._onMouseEvent),e._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(p){return this._altitude=p,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const p=this._map;return p&&(p.off("move",this._update),p.on("mousemove",this._onMouseEvent),p.on("drag",this._onMouseEvent),p._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(p){return this.setDOMContent(document.createTextNode(p))}setHTML(p){const e=document.createDocumentFragment(),a=document.createElement("body");let f;for(a.innerHTML=p;f=a.firstChild,f;)e.appendChild(f);return this.setDOMContent(e)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(p){return this.options.maxWidth=p,this._update(),this}setDOMContent(p){let e=this._content;if(e)for(;e.hasChildNodes();)e.firstChild&&e.removeChild(e.firstChild);else e=this._content=Ci("div","mapboxgl-popup-content",this._container||void 0);if(e.appendChild(p),this.options.closeButton){const a=this._closeButton=Ci("button","mapboxgl-popup-close-button",e);a.type="button",a.setAttribute("aria-label","Close popup"),a.innerHTML='<span aria-hidden="true">&#215;</span>',a.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(p){return this._classList.add(p),this._updateClassList(),this}removeClassName(p){return this._classList.delete(p),this._updateClassList(),this}setOffset(p){return this.options.offset=p,this._update(),this}toggleClassName(p){let e;return this._classList.delete(p)?e=!1:(this._classList.add(p),e=!0),this._updateClassList(),e}_onMouseEvent(p){this._update(p.point)}_getAnchor(p){if(this.options.anchor)return this.options.anchor;const e=this._map,a=this._container,f=this._pos;if(!e||!a||!f)return"bottom";const y=a.offsetWidth,w=a.offsetHeight,I=f.x<y/2,M=f.x>e.transform.width-y/2;if(f.y+p<w)return I?"top-left":M?"top-right":"top";if(f.y>e.transform.height-w){if(I)return"bottom-left";if(M)return"bottom-right"}return I?"left":M?"right":"bottom"}_updateClassList(){const p=this._container;if(!p)return;const e=[...this._classList];e.push("mapboxgl-popup"),this._anchor&&e.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&e.push("mapboxgl-popup-track-pointer"),p.className=e.join(" ")}_update(p){const e=this._map,a=this._content;if(!e||!this._lngLat&&!this._trackPointer||!a)return;let f=this._container;if(f||(f=this._container=Ci("div","mapboxgl-popup",e.getContainer()),this._tip=Ci("div","mapboxgl-popup-tip",f),f.appendChild(a)),this.options.maxWidth&&f.style.maxWidth!==this.options.maxWidth&&(f.style.maxWidth=this.options.maxWidth),e.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=xc(this._lngLat,this._pos,e.transform)),!this._trackPointer||p){const y=this._pos=this._trackPointer&&p instanceof i.P?p:e.project(this._lngLat,this._altitude),w=Um(this.options.offset),I=this._anchor=this._getAnchor(w.y),M=Um(this.options.offset,I),L=y.add(M).round();e._requestDomTask(()=>{this._container&&I&&(this._container.style.transform=`${gh[I]} translate(${L.x}px,${L.y}px)`)})}if(!this._marker&&e._showingGlobe()){const y=i.f4(e.transform,this._lngLat)?0:1;this._setOpacity(y)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const p=this._container.querySelector(Vm);p&&p.focus()}_onClose(){this.remove()}_setOpacity(p){this._container&&(this._container.style.opacity=`${p}`),this._content&&(this._content.style.pointerEvents=p?"auto":"none")}},Marker:Cu,Style:Ia,LngLat:i.aS,LngLatBounds:i.aI,Point:i.P,MercatorCoordinate:i.ae,FreeCameraOptions:dc,Evented:i.E,config:i.e,prewarm:i.f8,clearPrewarmedResources:i.f7,get accessToken(){return i.e.ACCESS_TOKEN},set accessToken(p){i.e.ACCESS_TOKEN=p},get baseApiUrl(){return i.e.API_URL},set baseApiUrl(p){i.e.API_URL=p},get workerCount(){return i.fh.workerCount},set workerCount(p){i.fh.workerCount=p},get maxParallelImageRequests(){return i.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(p){i.e.MAX_PARALLEL_IMAGE_REQUESTS=p},clearStorage(p){i.fg(p)},get workerUrl(){return i.ff.workerUrl},set workerUrl(p){i.ff.workerUrl=p},get workerClass(){return i.ff.workerClass},set workerClass(p){i.ff.workerClass=p},get workerParams(){return i.ff.workerParams},set workerParams(p){i.ff.workerParams=p},get dracoUrl(){return i.fe()},set dracoUrl(p){i.fd(p)},get meshoptUrl(){return i.fc()},set meshoptUrl(p){i.fb(p)},setNow:i.o.setNow,restoreNow:i.o.restoreNow}});var nt=Dt;return nt})})(Eb);var UT=Eb.exports;const Pb=Tb(UT);function jT(){const jt=localStorage.getItem("mapProvider"),bt=localStorage.getItem("mapboxAccessToken");return{provider:jt||"maplibre",mapboxAccessToken:bt||void 0}}function pb(jt){localStorage.setItem("mapProvider",jt.provider),jt.mapboxAccessToken?localStorage.setItem("mapboxAccessToken",jt.mapboxAccessToken):localStorage.removeItem("mapboxAccessToken"),console.log(":",jt.provider)}const GT=jt=>{const bt=jt.split(`
`).filter(Dt=>Dt.trim()),Lt=bt[0].split(",").map(Dt=>Dt.trim()),re=[];for(let Dt=1;Dt<bt.length;Dt++){const qt=bt[Dt].split(",").map(nt=>nt.trim());if(qt.length>=3){const nt={x:parseFloat(qt[0]),y:parseFloat(qt[1]),z:parseFloat(qt[2]),elevation:parseFloat(qt[3]||qt[2]),type:qt[4]||"point",description:qt[5]||"",properties:{}};if(Lt.length>6)for(let i=6;i<Lt.length&&i<qt.length;i++)nt.properties[Lt[i]]=qt[i];re.push(nt)}}return re},tv=jt=>({id:jt.id,name:jt.name,type:jt.type==="flight"?"waypoint":"object",source:jt.source,position:{longitude:jt.longitude,latitude:jt.latitude,altitude:jt.altitude},properties:jt.properties}),X0=jt=>({id:jt.id,name:jt.name,longitude:jt.position.longitude,latitude:jt.position.latitude,altitude:jt.position.altitude,type:jt.type==="waypoint"?"flight":"unknown",source:jt.source,properties:jt.properties}),Mb=jt=>{if(jt.length<2)return 0;let bt=0;for(let Lt=1;Lt<jt.length;Lt++){const re=jt[Lt-1].position,Dt=jt[Lt].position,qt=6371e3,nt=re.latitude*Math.PI/180,i=Dt.latitude*Math.PI/180,Le=(Dt.latitude-re.latitude)*Math.PI/180,wi=(Dt.longitude-re.longitude)*Math.PI/180,nr=Math.sin(Le/2)*Math.sin(Le/2)+Math.cos(nt)*Math.cos(i)*Math.sin(wi/2)*Math.sin(wi/2),bn=2*Math.atan2(Math.sqrt(nr),Math.sqrt(1-nr)),cn=qt*bn,Rr=Dt.altitude-re.altitude,xr=Math.sqrt(cn*cn+Rr*Rr);bt+=xr}return bt},$T=(jt,bt=10)=>{var re;Mb(jt);let Lt=0;for(let Dt=1;Dt<jt.length;Dt++){const qt=((re=jt[Dt].flight)==null?void 0:re.speed)||bt,nt=jt[Dt-1].position,i=jt[Dt].position,Le=6371e3,wi=nt.latitude*Math.PI/180,nr=i.latitude*Math.PI/180,bn=(i.latitude-nt.latitude)*Math.PI/180,cn=(i.longitude-nt.longitude)*Math.PI/180,Rr=Math.sin(bn/2)*Math.sin(bn/2)+Math.cos(wi)*Math.cos(nr)*Math.sin(cn/2)*Math.sin(cn/2),xr=2*Math.atan2(Math.sqrt(Rr),Math.sqrt(1-Rr)),Re=Le*xr/qt,Rn=jt[Dt].duration||0;Lt+=Re+Rn}return Lt},qT=(jt,bt,Lt,re)=>{const Dt=new Date().toISOString();return{id:`mission_${Date.now()}`,name:jt,created:Dt,settings:{homePosition:Lt,maxAltitude:400,maxDistance:1e3,returnToHomeAltitude:50,emergencyAction:"rtl",...re},waypoints:bt,metadata:{totalDistance:Mb(bt),estimatedDuration:$T(bt),maxAltitude:Math.max(...bt.map(qt=>qt.position.altitude))}}},ZT=jt=>{const bt=jt.split(`
`).filter(re=>re.trim());bt[0].split(",").map(re=>re.trim());const Lt=[];for(let re=1;re<bt.length;re++){const Dt=bt[re].split(",").map(qt=>qt.trim());if(Dt.length>=6){const qt={x:parseFloat(Dt[0]),y:parseFloat(Dt[1]),z:parseFloat(Dt[2]),mesh_id:parseInt(Dt[3]),vertex_id:parseInt(Dt[4]),elevation:parseFloat(Dt[5]),slope:Dt[6]?parseFloat(Dt[6]):void 0,aspect:Dt[7]?parseFloat(Dt[7]):void 0};Lt.push(qt)}}return Lt},HT=jt=>{const bt=jt.split(`
`).filter(Dt=>Dt.trim()),Lt=bt[0].split(",").map(Dt=>Dt.trim()),re=[];for(let Dt=1;Dt<bt.length;Dt++){const qt=bt[Dt].split(",").map(nt=>nt.trim());if(qt.length>=6){const nt={x:parseFloat(qt[0]),y:parseFloat(qt[1]),z:parseFloat(qt[2]),elevation:parseFloat(qt[3]),waypoint_id:parseInt(qt[4]),timestamp:qt[5]||void 0,speed:qt[6]?parseFloat(qt[6]):void 0,action:qt[7]||void 0,description:qt[8]||void 0,properties:{}};if(Lt.length>9)for(let i=9;i<Lt.length&&i<qt.length;i++)nt.properties[Lt[i]]=qt[i];re.push(nt)}}return re},WT=jt=>{const bt=jt.split(`
`).filter(Dt=>Dt.trim()),Lt=bt[0].split(",").map(Dt=>Dt.trim()),re=[];for(let Dt=1;Dt<bt.length;Dt++){const qt=bt[Dt].split(",").map(nt=>nt.trim());if(qt.length>=6){const nt={x:parseFloat(qt[0]),y:parseFloat(qt[1]),z:parseFloat(qt[2]),elevation:parseFloat(qt[3]),timestamp:qt[4],speed:parseFloat(qt[5]),battery_level:qt[6]?parseFloat(qt[6]):void 0,signal_strength:qt[7]?parseFloat(qt[7]):void 0,gps_accuracy:qt[8]?parseFloat(qt[8]):void 0,action:qt[9]||void 0,description:qt[10]||void 0,properties:{}};if(Lt.length>11)for(let i=11;i<Lt.length&&i<qt.length;i++)nt.properties[Lt[i]]=qt[i];re.push(nt)}}return re},XT=jt=>{console.log(""),console.log("CSV500:",jt.substring(0,500));const bt=jt.split(`
`).filter(Dt=>Dt.trim());if(console.log("CSV:",bt.length),bt.length<2)throw console.error("CSV"),new Error("");const Lt=bt[0].split(",").map(Dt=>Dt.trim());console.log(":",Lt);const re=[];for(let Dt=1;Dt<bt.length;Dt++)try{const qt=bt[Dt].split(",").map(i=>i.trim());if(qt.length<6){console.warn(` ${Dt} :`,qt);continue}const nt={x:parseFloat(qt[0]),y:parseFloat(qt[1]),z:parseFloat(qt[2]),elevation:parseFloat(qt[3]),type:qt[4],description:qt[5],properties:{damage_level:qt[6]?parseInt(qt[6]):0,component_type:qt[7]||"unknown",inspection_date:qt[8]||void 0}};if(isNaN(nt.x)||isNaN(nt.y)||isNaN(nt.z)){console.warn(` ${Dt} :`,qt);continue}re.push(nt)}catch(qt){console.error(` ${Dt} :`,qt,bt[Dt])}return console.log(":",re.length,""),console.log("3:",re.slice(0,3)),re},YT=jt=>{console.log(""),console.log("CSV500:",jt.substring(0,500));const bt=jt.split(`
`).filter(Dt=>Dt.trim());if(console.log("CSV:",bt.length),bt.length<2)throw console.error("CSV"),new Error("");const Lt=bt[0].split(",").map(Dt=>Dt.trim());console.log(":",Lt);const re=[];for(let Dt=1;Dt<bt.length;Dt++)try{const qt=bt[Dt].split(",").map(i=>i.trim());if(qt.length<6){console.warn(` ${Dt} :`,qt);continue}const nt={x:parseFloat(qt[0]),y:parseFloat(qt[1]),z:parseFloat(qt[2]),mesh_id:parseInt(qt[3]),vertex_id:parseInt(qt[4]),elevation:parseFloat(qt[5]),slope:qt[6]?parseFloat(qt[6]):void 0,aspect:qt[7]?parseFloat(qt[7]):void 0,damage_level:qt[8]?parseInt(qt[8]):0,component_type:qt[9]||"unknown"};if(isNaN(nt.x)||isNaN(nt.y)||isNaN(nt.z)){console.warn(` ${Dt} :`,qt);continue}re.push(nt)}catch(qt){console.error(` ${Dt} :`,qt,bt[Dt])}return console.log(":",re.length,""),console.log("3:",re.slice(0,3)),re},JT=jt=>{const bt=[],Lt=new Map;return jt.forEach(re=>{Lt.has(re.mesh_id)||Lt.set(re.mesh_id,[]),Lt.get(re.mesh_id).push(re)}),Lt.forEach((re,Dt)=>{if(re.length===25)for(let qt=0;qt<4;qt++)for(let nt=0;nt<4;nt++){const i=re[qt*5+nt],Le=re[qt*5+nt+1],wi=re[(qt+1)*5+nt],nr=re[(qt+1)*5+nt+1];bt.push([[i.x,i.y,i.z],[Le.x,Le.y,Le.z],[wi.x,wi.y,wi.z]]),bt.push([[Le.x,Le.y,Le.z],[nr.x,nr.y,nr.z],[wi.x,wi.y,wi.z]])}}),bt},fb=(jt,bt,Lt="3d-points")=>{console.log("3D:",bt.length,""),console.log(":",bt[0]);const re=bt.map(qt=>{var nt;return{type:"Feature",geometry:{type:"Point",coordinates:[qt.x,qt.y]},properties:{elevation:qt.elevation,z:qt.z,type:qt.type,description:qt.description,damage_level:((nt=qt.properties)==null?void 0:nt.damage_level)||0,...qt.properties}}});console.log(":",re.slice(0,3)),jt.getSource(Lt)&&jt.removeSource(Lt);const Dt=`${Lt}-layer`;jt.getLayer(Dt)&&jt.removeLayer(Dt);try{if(console.log(":",Lt),jt.addSource(Lt,{type:"geojson",data:{type:"FeatureCollection",features:re}}),console.log(":",Dt),jt.addLayer({id:Dt,type:"circle",source:Lt,paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,8,15,15,20,25],"circle-color":["match",["get","damage_level"],0,"#00ff00",1,"#ffff00",2,"#ffaa00",3,"#ff6600",4,"#ff0000",5,"#990000","#ff4444"],"circle-opacity":.9,"circle-stroke-width":3,"circle-stroke-color":"#ffffff"}}),console.log("3D"),bt.length>0){const qt=bt.reduce((i,Le)=>i+Le.x,0)/bt.length,nt=bt.reduce((i,Le)=>i+Le.y,0)/bt.length;console.log(":",[qt,nt]),jt.flyTo({center:[qt,nt],zoom:16,duration:2e3})}}catch(qt){throw console.error("3D:",qt),qt}},mb=(jt,bt,Lt="3d-mesh")=>{console.log("3D:",bt.length,"");const re=JT(bt);console.log(":",re.length,"");const Dt=re.map((nt,i)=>({type:"Feature",geometry:{type:"Polygon",coordinates:[nt.map(Le=>[Le[0],Le[1]])]},properties:{id:i,elevation:nt.reduce((Le,wi)=>Le+wi[2],0)/3,z:nt.reduce((Le,wi)=>Le+wi[2],0)/3}}));console.log(":",Dt.slice(0,2)),jt.getSource(Lt)&&jt.removeSource(Lt);const qt=`${Lt}-layer`;jt.getLayer(qt)&&jt.removeLayer(qt);try{if(jt.addSource(Lt,{type:"geojson",data:{type:"FeatureCollection",features:Dt}}),jt.addLayer({id:qt,type:"fill",source:Lt,paint:{"fill-color":["match",["get","damage_level"],0,"#00ff00",1,"#ffff00",2,"#ffaa00",3,"#ff6600",4,"#ff0000",5,"#990000","#ff4444"],"fill-opacity":.7,"fill-outline-color":"#ffffff"}}),console.log("3D"),bt.length>0){const nt=bt.reduce((Le,wi)=>Le+wi.x,0)/bt.length,i=bt.reduce((Le,wi)=>Le+wi.y,0)/bt.length;jt.flyTo({center:[nt,i],zoom:16,duration:2e3})}}catch(nt){throw console.error("3D:",nt),nt}},KT=(jt,bt,Lt="drone-waypoints")=>{console.log(":",bt.length,"");const re=bt.map(i=>({type:"Feature",geometry:{type:"Point",coordinates:[i.x,i.y]},properties:{elevation:i.elevation,z:i.z,waypoint_id:i.waypoint_id,timestamp:i.timestamp,speed:i.speed,action:i.action,description:i.description,...i.properties}})),Dt=bt.length>1?[{type:"Feature",geometry:{type:"LineString",coordinates:bt.map(i=>[i.x,i.y])},properties:{type:"flight-path",waypoint_count:bt.length}}]:[];console.log(":",re.slice(0,3)),jt.getSource(Lt)&&jt.removeSource(Lt);const qt=`${Lt}-waypoints-layer`,nt=`${Lt}-path-layer`;jt.getLayer(qt)&&jt.removeLayer(qt),jt.getLayer(nt)&&jt.removeLayer(nt);try{if(jt.addSource(Lt,{type:"geojson",data:{type:"FeatureCollection",features:re}}),jt.addLayer({id:qt,type:"circle",source:Lt,paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,6,15,12,20,20],"circle-color":["match",["get","action"],"takeoff","#00ff00","land","#ff0000","hover","#ffff00","#007cba"],"circle-opacity":.9,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),Dt.length>0&&(jt.addSource(`${Lt}-path`,{type:"geojson",data:{type:"FeatureCollection",features:Dt}}),jt.addLayer({id:nt,type:"line",source:`${Lt}-path`,paint:{"line-color":"#ff6b35","line-width":3,"line-opacity":.8}})),console.log(""),bt.length>0){const i=bt.reduce((wi,nr)=>wi+nr.x,0)/bt.length,Le=bt.reduce((wi,nr)=>wi+nr.y,0)/bt.length;jt.flyTo({center:[i,Le],zoom:15,duration:2e3})}}catch(i){throw console.error(":",i),i}},QT=(jt,bt,Lt="drone-flight-log")=>{console.log(":",bt.length,"");const re=bt.map(i=>({type:"Feature",geometry:{type:"Point",coordinates:[i.x,i.y]},properties:{elevation:i.elevation,z:i.z,timestamp:i.timestamp,speed:i.speed,battery_level:i.battery_level,signal_strength:i.signal_strength,gps_accuracy:i.gps_accuracy,action:i.action,description:i.description,...i.properties}})),Dt=bt.length>1?[{type:"Feature",geometry:{type:"LineString",coordinates:bt.map(i=>[i.x,i.y])},properties:{type:"flight-trajectory",log_count:bt.length}}]:[];console.log(":",re.slice(0,3)),jt.getSource(Lt)&&jt.removeSource(Lt);const qt=`${Lt}-points-layer`,nt=`${Lt}-trajectory-layer`;jt.getLayer(qt)&&jt.removeLayer(qt),jt.getLayer(nt)&&jt.removeLayer(nt);try{if(jt.addSource(Lt,{type:"geojson",data:{type:"FeatureCollection",features:re}}),jt.addLayer({id:qt,type:"circle",source:Lt,paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,3,15,6,20,10],"circle-color":["interpolate",["linear"],["get","speed"],0,"#00ff00",10,"#ffff00",20,"#ff0000"],"circle-opacity":.7,"circle-stroke-width":1,"circle-stroke-color":"#ffffff"}}),Dt.length>0&&(jt.addSource(`${Lt}-trajectory`,{type:"geojson",data:{type:"FeatureCollection",features:Dt}}),jt.addLayer({id:nt,type:"line",source:`${Lt}-trajectory`,paint:{"line-color":"#00ff00","line-width":2,"line-opacity":.6}})),console.log(""),bt.length>0){const i=bt.reduce((wi,nr)=>wi+nr.x,0)/bt.length,Le=bt.reduce((wi,nr)=>wi+nr.y,0)/bt.length;jt.flyTo({center:[i,Le],zoom:15,duration:2e3})}}catch(i){throw console.error(":",i),i}},Y0=async(jt,bt,Lt="points")=>{console.log(":",jt.name,":",Lt);const re=await jt.text();switch(console.log("100:",re.substring(0,100)),Lt){case"points":const Dt=GT(re);console.log(":",Dt.length,""),console.log("3:",Dt.slice(0,3)),fb(bt,Dt);break;case"mesh":const qt=ZT(re);console.log(":",qt.length,""),console.log("3:",qt.slice(0,3)),mb(bt,qt);break;case"waypoints":const nt=HT(re);console.log(":",nt.length,""),console.log("3:",nt.slice(0,3)),KT(bt,nt);break;case"flight-log":const i=WT(re);console.log(":",i.length,""),console.log("3:",i.slice(0,3)),QT(bt,i);break;case"building-inspection":const Le=XT(re);console.log(":",Le.length,""),console.log("3:",Le.slice(0,3)),fb(bt,Le);break;case"building-inspection-mesh":const wi=YT(re);console.log(":",wi.length,""),console.log("3:",wi.slice(0,3)),mb(bt,wi);break;default:throw new Error(`: ${Lt}`)}},t2=(jt,bt=["3d-points","3d-mesh"])=>{bt.forEach(Lt=>{const re=`${Lt}-layer`;jt.getLayer(re)&&jt.removeLayer(re),jt.getSource(Lt)&&jt.removeSource(Lt)})},e2=(jt,bt)=>{const Lt=jt.trim().split(`
`);if(Lt.length<2)return[];const re=Lt[0].split(",").map(qt=>qt.trim().toLowerCase()),Dt=[];for(let qt=1;qt<Lt.length;qt++){const nt=Lt[qt].split(",").map(Le=>Le.trim().replace(/"/g,"")),i={};if(re.forEach((Le,wi)=>{i[Le]=nt[wi]||""}),i.longitude&&i.latitude){const Le={id:i.id||`${bt}_${qt}_${Date.now()}`,name:i.name||`${qt}`,longitude:parseFloat(i.longitude),latitude:parseFloat(i.latitude),altitude:parseFloat(i.altitude||i.height||i.elevation)||50,type:i.type||"unknown",source:bt,properties:{}};Object.keys(i).forEach(wi=>{["id","name","longitude","latitude","altitude","height","elevation","type"].includes(wi)||(Le.properties[wi]=i[wi])}),Dt.push(Le)}}return Dt},i2=(jt,bt)=>{const Lt=JSON.parse(jt),re=[];return Lt.type==="FeatureCollection"&&Lt.features?Lt.features.forEach((Dt,qt)=>{if(Dt.geometry&&Dt.geometry.type==="Point"){const nt=Dt.geometry.coordinates,i=Dt.properties||{},Le={id:i.id||`${bt}_${qt}_${Date.now()}`,name:i.name||`${qt+1}`,longitude:nt[0],latitude:nt[1],altitude:nt[2]||i.altitude||i.height||i.elevation||50,type:i.type||"unknown",source:bt,properties:{...i}};delete Le.properties.id,delete Le.properties.name,delete Le.properties.altitude,delete Le.properties.height,delete Le.properties.elevation,delete Le.properties.type,re.push(Le)}}):Array.isArray(Lt)&&Lt.forEach((Dt,qt)=>{if(Dt.longitude&&Dt.latitude){const nt={id:Dt.id||`${bt}_${qt}_${Date.now()}`,name:Dt.name||`${qt+1}`,longitude:parseFloat(Dt.longitude||Dt.lng),latitude:parseFloat(Dt.latitude||Dt.lat),altitude:parseFloat(Dt.altitude||Dt.height||Dt.elevation)||50,type:Dt.type||"unknown",source:bt,properties:{}};Object.keys(Dt).forEach(i=>{["id","name","longitude","latitude","lng","lat","altitude","height","elevation","type"].includes(i)||(nt.properties[i]=Dt[i])}),re.push(nt)}}),re},r2=jt=>{if(jt.length===0)return"";const Lt=[["longitude","latitude","altitude","name","type","source"].join(",")];return jt.forEach(re=>{const Dt=[re.longitude,re.latitude,re.altitude,`"${re.name}"`,re.type,`"${re.source}"`];Lt.push(Dt.join(","))}),Lt.join(`
`)},n2=jt=>{const bt={type:"FeatureCollection",metadata:{export_time:new Date().toISOString(),total_objects:jt.length,generator:"MapLibre GSI Terrain System"},features:jt.map(Lt=>({type:"Feature",geometry:{type:"Point",coordinates:[Lt.longitude,Lt.latitude,Lt.altitude]},properties:{name:Lt.name,type:Lt.type,altitude:Lt.altitude,source:Lt.source,id:Lt.id,...Lt.properties}}))};return JSON.stringify(bt,null,2)},gb=jt=>{if(jt.length===0)return"";const bt=["id","name","type","source","longitude","latitude","altitude","relativeAltitude","timestamp","duration","speed","heading","action","waypointId","sequenceNumber","batteryLevel","signalStrength","gpsAccuracy","temperature","humidity","windSpeed","windDirection","missionId","operatorId","aircraftModel","aircraftSerial","description"],Lt=jt.map(Dt=>{var qt,nt,i,Le,wi,nr,bn,cn,Rr,xr,Ci,Re,Rn,pr,$r,En,$o;return[Dt.id,Dt.name,Dt.type,Dt.source,Dt.position.longitude,Dt.position.latitude,Dt.position.altitude,Dt.position.relativeAltitude||"",Dt.timestamp||"",Dt.duration||"",((qt=Dt.flight)==null?void 0:qt.speed)||"",((nt=Dt.flight)==null?void 0:nt.heading)||"",((i=Dt.flight)==null?void 0:i.action)||"",((Le=Dt.flight)==null?void 0:Le.waypointId)||"",((wi=Dt.flight)==null?void 0:wi.sequenceNumber)||"",((nr=Dt.telemetry)==null?void 0:nr.batteryLevel)||"",((bn=Dt.telemetry)==null?void 0:bn.signalStrength)||"",((cn=Dt.telemetry)==null?void 0:cn.gpsAccuracy)||"",((Rr=Dt.telemetry)==null?void 0:Rr.temperature)||"",((xr=Dt.telemetry)==null?void 0:xr.humidity)||"",((Ci=Dt.telemetry)==null?void 0:Ci.windSpeed)||"",((Re=Dt.telemetry)==null?void 0:Re.windDirection)||"",((Rn=Dt.metadata)==null?void 0:Rn.missionId)||"",((pr=Dt.metadata)==null?void 0:pr.operatorId)||"",(($r=Dt.metadata)==null?void 0:$r.aircraftModel)||"",((En=Dt.metadata)==null?void 0:En.aircraftSerial)||"",(($o=Dt.metadata)==null?void 0:$o.description)||""]});return[bt.join(","),...Lt.map(Dt=>Dt.join(","))].join(`
`)},_b=jt=>{const bt=jt.map(re=>({type:"Feature",geometry:re.geometry||{type:"Point",coordinates:[re.position.longitude,re.position.latitude,re.position.altitude]},properties:{id:re.id,name:re.name,type:re.type,source:re.source,altitude:re.position.altitude,relativeAltitude:re.position.relativeAltitude,timestamp:re.timestamp,duration:re.duration,flight:re.flight,telemetry:re.telemetry,metadata:re.metadata,...re.properties}})),Lt={type:"FeatureCollection",metadata:{generator:"MapLibre GSI Terrain - Unified Flight Data",timestamp:new Date().toISOString(),count:jt.length},features:bt};return JSON.stringify(Lt,null,2)},o2=jt=>{const bt=jt.waypoints;if(bt.length===0)return"";const Lt=bt.map(qt=>{var nt,i;return`
        <Placemark>
            <name>${qt.name}</name>
            <description>
                <![CDATA[
                    <b>Action:</b> ${((nt=qt.flight)==null?void 0:nt.action)||"waypoint"}<br/>
                    <b>Altitude:</b> ${qt.position.altitude}m<br/>
                    <b>Speed:</b> ${((i=qt.flight)==null?void 0:i.speed)||"N/A"} m/s<br/>
                    <b>Duration:</b> ${qt.duration||0}s
                ]]>
            </description>
            <Point>
                <coordinates>${qt.position.longitude},${qt.position.latitude},${qt.position.altitude}</coordinates>
            </Point>
        </Placemark>`}).join(""),re=bt.map(qt=>`${qt.position.longitude},${qt.position.latitude},${qt.position.altitude}`).join(" ");return`<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${jt.name}</name>
        <description>${jt.description||""}</description>
        
        <Style id="waypointStyle">
            <IconStyle>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
                </Icon>
            </IconStyle>
        </Style>
        
        <Style id="pathStyle">
            <LineStyle>
                <color>ff0000ff</color>
                <width>3</width>
            </LineStyle>
        </Style>
        
        ${Lt}
        
        <Placemark>
            <name>Flight Path</name>
            <styleUrl>#pathStyle</styleUrl>
            <LineString>
                <altitudeMode>absolute</altitudeMode>
                <coordinates>${re}</coordinates>
            </LineString>
        </Placemark>
        
        <Placemark>
            <name>Home Position</name>
            <Point>
                <coordinates>${jt.settings.homePosition.longitude},${jt.settings.homePosition.latitude},${jt.settings.homePosition.altitude}</coordinates>
            </Point>
        </Placemark>
    </Document>
</kml>`},J0=jt=>{const bt=jt.trim().split(`
`);if(bt.length<2)return[];bt[0].split(",").map(re=>re.trim());const Lt=[];for(let re=1;re<bt.length;re++){const Dt=bt[re].split(",").map(qt=>qt.trim());if(Dt.length>=6){const qt={id:Dt[0]||`unified_${Date.now()}_${re}`,name:Dt[1]||`Flight Data ${re}`,type:Dt[2]||"waypoint",source:Dt[3]||"csv_import",position:{longitude:parseFloat(Dt[4])||0,latitude:parseFloat(Dt[5])||0,altitude:parseFloat(Dt[6])||0,relativeAltitude:Dt[7]?parseFloat(Dt[7]):void 0}};Dt[8]&&(qt.timestamp=Dt[8]),Dt[9]&&(qt.duration=parseFloat(Dt[9])),(Dt[10]||Dt[11]||Dt[12]||Dt[13]||Dt[14])&&(qt.flight={speed:Dt[10]?parseFloat(Dt[10]):void 0,heading:Dt[11]?parseFloat(Dt[11]):void 0,action:Dt[12],waypointId:Dt[13]?parseInt(Dt[13]):void 0,sequenceNumber:Dt[14]?parseInt(Dt[14]):void 0}),(Dt[15]||Dt[16]||Dt[17]||Dt[18]||Dt[19]||Dt[20]||Dt[21])&&(qt.telemetry={batteryLevel:Dt[15]?parseFloat(Dt[15]):void 0,signalStrength:Dt[16]?parseFloat(Dt[16]):void 0,gpsAccuracy:Dt[17]?parseFloat(Dt[17]):void 0,temperature:Dt[18]?parseFloat(Dt[18]):void 0,humidity:Dt[19]?parseFloat(Dt[19]):void 0,windSpeed:Dt[20]?parseFloat(Dt[20]):void 0,windDirection:Dt[21]?parseFloat(Dt[21]):void 0}),(Dt[22]||Dt[23]||Dt[24]||Dt[25]||Dt[26])&&(qt.metadata={missionId:Dt[22]||void 0,operatorId:Dt[23]||void 0,aircraftModel:Dt[24]||void 0,aircraftSerial:Dt[25]||void 0,description:Dt[26]||void 0}),Lt.push(qt)}}return Lt},yb=jt=>{try{const bt=JSON.parse(jt);if(bt.type!=="FeatureCollection"||!bt.features)throw new Error("Invalid GeoJSON format");return bt.features.map((re,Dt)=>{const qt=re.properties||{},nt=re.geometry;let i={longitude:0,latitude:0,altitude:0};return nt&&(nt.type==="Point"?i={longitude:nt.coordinates[0],latitude:nt.coordinates[1],altitude:nt.coordinates[2]||qt.altitude||0}:nt.type==="LineString"&&nt.coordinates.length>0?i={longitude:nt.coordinates[0][0],latitude:nt.coordinates[0][1],altitude:nt.coordinates[0][2]||qt.altitude||0}:nt.type==="Polygon"&&nt.coordinates[0].length>0&&(i={longitude:nt.coordinates[0][0][0],latitude:nt.coordinates[0][0][1],altitude:nt.coordinates[0][0][2]||qt.altitude||0})),{id:qt.id||`geojson_${Date.now()}_${Dt}`,name:qt.name||`Flight Data ${Dt+1}`,type:qt.type||"waypoint",source:qt.source||"geojson_import",position:{...i,relativeAltitude:qt.relativeAltitude},timestamp:qt.timestamp,duration:qt.duration,flight:qt.flight,telemetry:qt.telemetry,metadata:qt.metadata,geometry:nt,properties:qt}})}catch(bt){return console.error("GeoJSON parse error:",bt),[]}},s2=jt=>{try{const bt=JSON.parse(jt);if(!bt.id||!bt.name||!bt.settings||!bt.waypoints)throw new Error("Invalid flight mission format");return bt}catch(bt){return console.error("Flight mission parse error:",bt),null}},Em=(jt,bt,Lt)=>{try{const re=new Blob([jt],{type:Lt}),Dt=URL.createObjectURL(re),qt=document.createElement("a");qt.href=Dt,qt.download=bt,qt.style.display="none",document.body.appendChild(qt),qt.click(),document.body.removeChild(qt),URL.revokeObjectURL(Dt),console.log(`: ${bt}`)}catch(re){throw console.error(":",re),re}},a2=(jt=[139.7454,35.6586])=>{const bt=[];for(let re=1;re<=5;re++){const Dt=(re-1)*(2*Math.PI/5)+Math.random()*.5,qt=200+Math.random()*300,nt=[jt[0]+qt*Math.cos(Dt)/111320,jt[1]+qt*Math.sin(Dt)/110540];bt.push({id:`tokyo_tower_drone_${re}_${Date.now()}`,name:`${String(re).padStart(2,"0")}`,longitude:nt[0],latitude:nt[1],altitude:250+Math.random()*100,type:"drone",source:"tokyo_tower_inspection",properties:{mission:"tower_inspection",status:"active"}})}return[{type:"base",name:"",lat_offset:-.001,lng_offset:.001,altitude:50},{type:"sensor",name:"",lat_offset:5e-4,lng_offset:-8e-4,altitude:100},{type:"weather",name:"",lat_offset:-8e-4,lng_offset:-.001,altitude:80},{type:"manual",name:"A",lat_offset:3e-4,lng_offset:5e-4,altitude:200}].forEach((re,Dt)=>{bt.push({id:`tokyo_tower_${re.type}_${Dt}_${Date.now()}`,name:re.name,longitude:jt[0]+re.lng_offset,latitude:jt[1]+re.lat_offset,altitude:re.altitude+(Math.random()-.5)*20,type:re.type,source:"tokyo_tower_inspection",properties:{facility_type:"inspection_equipment",tower_related:!0}})}),bt},l2=`
const vsSource = \`#version 300 es
    in vec4 a_position;
    out vec2 v_tex_coord;

    void main() {
        gl_Position = a_position;
        v_tex_coord = vec2(a_position.x * 0.5 + 0.5, a_position.y * -0.5 + 0.5);
    }
\`;

const fsSource = \`#version 300 es
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    uniform sampler2D u_height_map;
    in vec2 v_tex_coord;
    out vec4 fragColor;

    void main() {
        vec4 color = texture(u_height_map, v_tex_coord);
        vec3 rgb = color.rgb * 255.0;

        // terrarium0
        vec4 zero_elevation_color = vec4(128.0, 0.0, 0.0, 255.0) / 255.0;

        // 
        bool is_valid = (rgb.r != 128.0 || rgb.g != 0.0 || rgb.b != 0.0) && color.a != 0.0;

        float rgb_value = dot(rgb, vec3(65536.0, 256.0, 1.0));
        float height = mix(rgb_value, rgb_value - 16777216.0, step(8388608.0, rgb_value)) * 0.01;

        // terrarium
        height += 32768.0;
        float r = floor(height / 256.0);
        float g = floor(mod(height, 256.0));
        float b = floor((height - floor(height)) * 256.0);

        // terrarium
        fragColor = mix(
            zero_elevation_color,
            vec4(
                r / 255.0,
                g / 255.0,
                b / 255.0,
                1.0
            ),
            float(is_valid)
        );
    }
\`;

let gl = null;
let program = null;
let positionBuffer = null;
let heightMapLocation = null;

const initWebGL = (canvas) => {
	gl = canvas.getContext('webgl2');
	if (!gl) {
		throw new Error('WebGL not supported');
	}

	const loadShader = (
		gl,
		type,
		source,
	) => {
		const shader = gl.createShader(type);
		if (!shader) {
			console.error('Unable to create shader');
			return null;
		}
		gl.shaderSource(shader, source);
		gl.compileShader(shader);

		if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
			console.error(
				'An error occurred compiling the shaders: ' +
					gl.getShaderInfoLog(shader),
			);
			gl.deleteShader(shader);
			return null;
		}
		return shader;
	};

	const vertexShader = loadShader(gl, gl.VERTEX_SHADER, vsSource);
	const fragmentShader = loadShader(gl, gl.FRAGMENT_SHADER, fsSource);
	if (!vertexShader || !fragmentShader) {
		throw new Error('Failed to load shaders');
	}

	program = gl.createProgram();
	if (!program) {
		throw new Error('Failed to create program');
	}
	gl.attachShader(program, vertexShader);
	gl.attachShader(program, fragmentShader);
	gl.linkProgram(program);

	if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
		console.error(
			'Unable to initialize the shader program: ' +
				gl.getProgramInfoLog(program),
		);
		throw new Error('Failed to link program');
	}

	positionBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
	const positions = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);
	gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
	const positionLocation = gl.getAttribLocation(program, 'a_position');
	gl.enableVertexAttribArray(positionLocation);
	gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

	heightMapLocation = gl.getUniformLocation(program, 'u_height_map');
};

const canvas = new OffscreenCanvas(256, 256);

self.onmessage = async (e) => {
	const { url, image } = e.data;

	try {
		if (!gl) {
			initWebGL(canvas);
		}

		if (!gl || !program || !positionBuffer || !heightMapLocation) {
			throw new Error('WebGL initialization failed');
		}

		const heightMap = gl.createTexture();
		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, heightMap);
		gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
		gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);

		gl.useProgram(program);
		gl.uniform1i(heightMapLocation, 0);

		gl.clear(gl.COLOR_BUFFER_BIT);
		gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

		const blob = await canvas.convertToBlob();
		if (!blob) {
			throw new Error('Failed to convert canvas to blob');
		}
		const buffer = await blob.arrayBuffer();
		self.postMessage({ url, buffer });
	} catch (error) {
		if (error instanceof Error) {
			self.postMessage({ url, error: error.message });
		}
	}
};
`,c2=async(jt,bt)=>{let Lt;try{console.log("[GSI DEM] Fetching:",jt),Lt=await fetch(jt,{signal:bt}),console.log("[GSI DEM] Fetch success:",Lt.status,Lt.statusText)}catch(re){return bt.aborted||console.error(`[GSI DEM] Failed to fetch image from ${jt}:`,re),null}return Lt.ok?await createImageBitmap(await Lt.blob()):(console.error(`[GSI DEM] Response not OK: ${Lt.status} ${Lt.statusText}`),null)};class h2{constructor(bt){Mi(this,"worker");Mi(this,"pendingRequests");Mi(this,"handleMessage",bt=>{const{url:Lt,buffer:re,error:Dt}=bt.data,qt=this.pendingRequests.get(Lt);Dt?(console.error(`Error processing tile ${Lt}:`,Dt),qt&&(qt.reject(new Error(Dt)),this.pendingRequests.delete(Lt))):qt&&(qt.resolve({data:new Uint8Array(re)}),this.pendingRequests.delete(Lt))});Mi(this,"handleError",bt=>{console.error("Worker error:",bt),this.pendingRequests.forEach(Lt=>{Lt.reject(new Error("Worker error occurred"))}),this.pendingRequests.clear()});this.worker=bt,this.pendingRequests=new Map,this.worker.addEventListener("message",this.handleMessage),this.worker.addEventListener("error",this.handleError)}async request(bt,Lt){const re=await c2(bt,Lt.signal);return re?new Promise((Dt,qt)=>{this.pendingRequests.set(bt,{resolve:Dt,reject:qt,controller:Lt}),this.worker.postMessage({image:re,url:bt}),Lt.signal.onabort=()=>{this.pendingRequests.delete(bt),qt(new Error("Request aborted"))}}):Promise.reject(new Error("Failed to load image"))}}const u2=new Blob([l2],{type:"application/javascript"}),d2=new Worker(URL.createObjectURL(u2)),p2=new h2(d2),f2=jt=>{const bt=new RegExp(`^${jt}:(?://)?`);return(Lt,re)=>{let Dt=Lt.url.replace(bt,"");return Dt=Dt.replace(/^(https?)\/{2,}/,"$1://"),console.log("[GSI DEM] Original URL:",Lt.url),console.log("[GSI DEM] Processed URL:",Dt),p2.request(Dt,re)}};class m2{constructor(bt,Lt){Mi(this,"map");Mi(this,"currentStyleId");Mi(this,"styles");Mi(this,"terrainSource");this.map=bt,this.terrainSource=Lt,this.styles=new Map,this.currentStyleId="satellite",this.initializeStyles()}initializeStyles(){this.addStyle({id:"satellite",name:"",description:"",styleObject:{version:8,sources:{seamlessphoto:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg"],maxzoom:18,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"seamlessphoto",source:"seamlessphoto",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"standard",name:"",description:"",styleObject:{version:8,sources:{gsi_std:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png"],maxzoom:18,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"gsi_std",source:"gsi_std",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"pale",name:"",description:"",styleObject:{version:8,sources:{gsi_pale:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png"],maxzoom:18,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"gsi_pale",source:"gsi_pale",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"blank",name:"",description:"",styleObject:{version:8,sources:{gsi_blank:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png"],maxzoom:14,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"gsi_blank",source:"gsi_blank",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"dark",name:"",description:"",styleObject:{version:8,sources:{terrain:this.terrainSource},layers:[{id:"background",type:"background",paint:{"background-color":"#1a1a1a"}}],terrain:{source:"terrain",exaggeration:1.5}}}),this.addStyle({id:"relief",name:"",description:"",styleObject:{version:8,sources:{relief:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png"],maxzoom:15,tileSize:256,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},terrain:this.terrainSource},layers:[{id:"relief",source:"relief",type:"raster"}],terrain:{source:"terrain",exaggeration:1.5}}})}addStyle(bt){this.styles.set(bt.id,bt)}getStyle(bt){return this.styles.get(bt)}getAllStyles(){return Array.from(this.styles.values())}switchStyle(bt){const Lt=this.styles.get(bt);if(!Lt){console.warn(`Style not found: ${bt}`);return}const re=this.map.getStyle(),Dt=re.sources,qt=re.layers,nt={},i=[],Le=["drone-objects","drone-connections","altitude-lines","drawing-polygon","selected-object","drone-trail","flight-plan-waypoints","flight-plan-path"];for(const[wi,nr]of Object.entries(Dt))Le.includes(wi)&&(nt[wi]=nr);for(const wi of qt)Le.some(nr=>wi.id.includes(nr)||wi.source===nr)&&i.push(wi);if(Lt.styleObject){const wi=JSON.parse(JSON.stringify(Lt.styleObject));wi.sources={...wi.sources,...nt},wi.layers||(wi.layers=[]),wi.layers.push(...i),this.map.setStyle(wi),this.currentStyleId=bt}}getCurrentStyleId(){return this.currentStyleId}setTerrainExaggeration(bt){this.map.getTerrain()&&this.map.setTerrain({source:"terrain",exaggeration:bt})}createStyleControl(){const bt=document.createElement("div");bt.className="maplibregl-ctrl maplibregl-ctrl-group map-style-control",bt.style.cssText=`
			position: absolute;
			top: 10px;
			right: 10px;
			background: white;
			border-radius: 4px;
			box-shadow: 0 0 0 2px rgba(0,0,0,.1);
			padding: 10px;
			max-width: 200px;
			z-index: 1;
		`;const Lt=document.createElement("div");Lt.textContent="",Lt.style.cssText=`
			font-weight: bold;
			margin-bottom: 8px;
			font-size: 12px;
			color: #333;
		`,bt.appendChild(Lt);const re=document.createElement("div");re.style.cssText=`
			display: flex;
			flex-direction: column;
			gap: 6px;
		`;for(const i of this.getAllStyles()){const Le=document.createElement("button");Le.textContent=i.name,Le.title=i.description,Le.style.cssText=`
				padding: 8px 12px;
				border: 1px solid #ddd;
				border-radius: 4px;
				background: ${this.currentStyleId===i.id?"#007cbf":"white"};
				color: ${this.currentStyleId===i.id?"white":"#333"};
				cursor: pointer;
				font-size: 11px;
				transition: all 0.2s;
			`,Le.addEventListener("mouseenter",()=>{this.currentStyleId!==i.id&&(Le.style.background="#f0f0f0")}),Le.addEventListener("mouseleave",()=>{this.currentStyleId!==i.id&&(Le.style.background="white")}),Le.addEventListener("click",()=>{this.switchStyle(i.id),re.querySelectorAll("button").forEach(nr=>{const bn=nr.textContent===i.name;nr.style.background=bn?"#007cbf":"white",nr.style.color=bn?"white":"#333"})}),re.appendChild(Le)}bt.appendChild(re);const Dt=document.createElement("div");Dt.style.cssText=`
			margin-top: 12px;
			padding-top: 8px;
			border-top: 1px solid #ddd;
		`;const qt=document.createElement("label");qt.textContent=": 1.5x",qt.style.cssText=`
			display: block;
			font-size: 11px;
			margin-bottom: 4px;
			color: #333;
		`;const nt=document.createElement("input");return nt.type="range",nt.min="1.0",nt.max="3.0",nt.step="0.1",nt.value="1.5",nt.style.cssText=`
			width: 100%;
		`,nt.addEventListener("input",i=>{const Le=parseFloat(i.target.value);this.setTerrainExaggeration(Le),qt.textContent=`: ${Le.toFixed(1)}x`}),Dt.appendChild(qt),Dt.appendChild(nt),bt.appendChild(Dt),bt}}const K0={linear:jt=>jt,easeInQuad:jt=>jt*jt,easeOutQuad:jt=>jt*(2-jt),easeInOutQuad:jt=>jt<.5?2*jt*jt:-1+(4-2*jt)*jt,easeInCubic:jt=>jt*jt*jt,easeOutCubic:jt=>--jt*jt*jt+1,easeInOutCubic:jt=>jt<.5?4*jt*jt*jt:(jt-1)*(2*jt-2)*(2*jt-2)+1,easeInOutSine:jt=>-(Math.cos(Math.PI*jt)-1)/2,easeOutElastic:jt=>{const bt=2*Math.PI/3;return jt===0?0:jt===1?1:Math.pow(2,-10*jt)*Math.sin((jt*10-.75)*bt)+1}};class g2{constructor(bt,Lt){Mi(this,"map");Mi(this,"config");Mi(this,"flightLog",[]);Mi(this,"currentFlightPlan",[]);Mi(this,"currentFlightPlanName","");Mi(this,"currentFlightPlanDescription","");Mi(this,"flightPlanActive",!1);Mi(this,"currentFlightPhase",0);Mi(this,"animationFrameId",null);Mi(this,"onLogUpdate");this.map=bt,this.config={maxSpeed:20,maxAltitude:500,minAltitude:5,acceleration:2,deceleration:3,rotationSpeed:45,physicsEnabled:!0,collisionDetection:!1,...Lt}}setLogUpdateCallback(bt){this.onLogUpdate=bt}addFlightLog(bt,Lt,re,Dt="info"){const qt={timestamp:new Date().toLocaleTimeString("ja-JP"),phase:bt,action:Lt,details:re,type:Dt};this.flightLog.push(qt),this.onLogUpdate&&this.onLogUpdate(this.flightLog)}getFlightLog(){return this.flightLog}clearFlightLog(){this.flightLog=[],this.onLogUpdate&&this.onLogUpdate(this.flightLog)}setFlightPlan(bt){this.currentFlightPlan=bt.phases,this.currentFlightPlanName=bt.name,this.currentFlightPlanDescription=bt.description,this.addFlightLog("","",`${bt.name} `,"success")}startFlightPlan(){if(this.currentFlightPlan.length===0){this.addFlightLog("","","","error");return}if(this.flightPlanActive){this.addFlightLog("","","","warning");return}this.flightPlanActive=!0,this.currentFlightPhase=0,this.addFlightLog("",this.currentFlightPlanName,this.currentFlightPlanDescription,"success"),this.executeFlightPhase()}pauseFlightPlan(){this.flightPlanActive=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.addFlightLog("","","","info")}resumeFlightPlan(){if(this.currentFlightPlan.length===0){this.addFlightLog("","","","error");return}this.flightPlanActive=!0,this.addFlightLog("","","","success"),this.executeFlightPhase()}stopFlightPlan(){this.flightPlanActive=!1,this.currentFlightPhase=0,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.addFlightLog("","","","warning")}executeFlightPhase(){if(!this.flightPlanActive||this.currentFlightPhase>=this.currentFlightPlan.length){this.completeFlightPlan();return}const bt=this.currentFlightPlan[this.currentFlightPhase];this.addFlightLog(bt.phase,bt.action,` ${this.currentFlightPhase+1} `,"info");const Lt={center:[bt.position[0],bt.position[1]],zoom:bt.zoom??17,pitch:bt.pitch??60,bearing:bt.bearing??0,duration:bt.duration,easing:K0.easeInOutCubic};this.map.flyTo(Lt),setTimeout(()=>{this.currentFlightPhase++,this.executeFlightPhase()},bt.duration)}completeFlightPlan(){this.flightPlanActive=!1,this.currentFlightPhase=0,this.addFlightLog("","","","success")}flyToSmooth(bt,Lt){const re={center:[bt[0],bt[1]],zoom:(Lt==null?void 0:Lt.zoom)??this.map.getZoom(),pitch:(Lt==null?void 0:Lt.pitch)??this.map.getPitch(),bearing:(Lt==null?void 0:Lt.bearing)??this.map.getBearing(),duration:(Lt==null?void 0:Lt.duration)??1e3,easing:Lt!=null&&Lt.easing?K0[Lt.easing]:K0.easeInOutCubic};this.map.flyTo(re)}flyAlongPath(bt,Lt){if(bt.length<2){console.warn("At least 2 waypoints are required");return}const Dt=((Lt==null?void 0:Lt.totalDuration)??bt.length*2e3)/(bt.length-1);let qt=0;const nt=()=>{if(qt>=bt.length-1){Lt!=null&&Lt.onComplete&&Lt.onComplete();return}const i=bt[qt],Le=bt[qt+1],wi=this.calculateBearing(i,Le);if(this.map.flyTo({center:[Le[0],Le[1]],zoom:17,pitch:60,bearing:wi,duration:Dt,easing:K0.easeInOutCubic}),Lt!=null&&Lt.onProgress){const nr=(qt+1)/bt.length;Lt.onProgress(nr,qt+1)}qt++,setTimeout(()=>{this.animationFrameId=requestAnimationFrame(nt)},Dt)};nt()}calculateBearing(bt,Lt){const re=bt[1]*Math.PI/180,Dt=bt[0]*Math.PI/180,qt=Lt[1]*Math.PI/180,nt=Lt[0]*Math.PI/180,i=Math.sin(nt-Dt)*Math.cos(qt),Le=Math.cos(re)*Math.sin(qt)-Math.sin(re)*Math.cos(qt)*Math.cos(nt-Dt);return(Math.atan2(i,Le)*180/Math.PI+360)%360}flyOrbit(bt,Lt,re,Dt){const qt=(Dt==null?void 0:Dt.duration)??1e4,nt=(Dt==null?void 0:Dt.clockwise)??!0,i=(Dt==null?void 0:Dt.startAngle)??0,wi=qt/1e3*60;let nr=0;const bn=()=>{if(nr>=wi)return;const cn=nr/wi,Rr=i+(nt?1:-1)*cn*360,xr=Rr*Math.PI/180,Ci=bt[0]+Lt/111320*Math.cos(xr),Re=bt[1]+Lt/110540*Math.sin(xr);this.map.setCenter([Ci,Re]),this.map.setBearing(Rr),Dt!=null&&Dt.onProgress&&Dt.onProgress(Rr),nr++,this.animationFrameId=requestAnimationFrame(bn)};bn()}getFlightPlanStatus(){return{active:this.flightPlanActive,currentPhase:this.currentFlightPhase,totalPhases:this.currentFlightPlan.length,planName:this.currentFlightPlanName}}updateConfig(bt){this.config={...this.config,...bt}}getConfig(){return{...this.config}}}class _2{constructor(bt,Lt){Mi(this,"map");Mi(this,"physicsState");Mi(this,"modelMatrix",[]);Mi(this,"trail",[]);Mi(this,"maxTrailLength",100);this.map=bt,this.physicsState={position:Lt,velocity:[0,0,0],acceleration:[0,0,0],rotation:[0,0,0],angularVelocity:[0,0,0]}}createCustomLayer(){return{id:"drone-3d-model",type:"custom",renderingMode:"3d",onAdd(bt,Lt){},render(bt,Lt){}}}static generateDroneGeometry(){const bt=[],Lt=[],re=[],Dt=[],nt=[[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1],[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1]],i=3,Le=.3,wi=[[i,0,0],[-i,0,0],[0,i,0],[0,-i,0]],nr=1.5,bn=8;for(let cn=0;cn<wi.length;cn++){const[Rr,xr,Ci]=wi[cn];for(let Re=0;Re<bn;Re++){const Rn=Re/bn*Math.PI*2,pr=Rr+Math.cos(Rn)*nr,$r=xr+Math.sin(Rn)*nr,En=Ci+Le;bt.push(pr,$r,En),Lt.push(0,0,1),re.push(.2,.2,.2)}}for(let cn=0;cn<nt.length;cn++){const[Rr,xr,Ci]=nt[cn];bt.push(Rr,xr,Ci),Lt.push(0,0,1),re.push(1,.2,.2)}return{vertices:bt,normals:Lt,colors:re,indices:Dt}}updatePosition(bt){this.physicsState.position=bt,this.trail.push([...bt]),this.trail.length>this.maxTrailLength&&this.trail.shift()}updateRotation(bt){this.physicsState.rotation=bt}updatePhysics(bt){this.physicsState.velocity[0]+=this.physicsState.acceleration[0]*bt,this.physicsState.velocity[1]+=this.physicsState.acceleration[1]*bt,this.physicsState.velocity[2]+=this.physicsState.acceleration[2]*bt,this.physicsState.position[0]+=this.physicsState.velocity[0]*bt,this.physicsState.position[1]+=this.physicsState.velocity[1]*bt,this.physicsState.position[2]+=this.physicsState.velocity[2]*bt;const Lt=.95;this.physicsState.velocity[0]*=Lt,this.physicsState.velocity[1]*=Lt,this.physicsState.velocity[2]*=Lt,this.physicsState.rotation[0]+=this.physicsState.angularVelocity[0]*bt,this.physicsState.rotation[1]+=this.physicsState.angularVelocity[1]*bt,this.physicsState.rotation[2]+=this.physicsState.angularVelocity[2]*bt,this.physicsState.angularVelocity[0]*=Lt,this.physicsState.angularVelocity[1]*=Lt,this.physicsState.angularVelocity[2]*=Lt}applyForce(bt){this.physicsState.acceleration[0]=bt[0],this.physicsState.acceleration[1]=bt[1],this.physicsState.acceleration[2]=bt[2]}applyTorque(bt){this.physicsState.angularVelocity[0]+=bt[0],this.physicsState.angularVelocity[1]+=bt[1],this.physicsState.angularVelocity[2]+=bt[2]}getPosition(){return[...this.physicsState.position]}getPhysicsState(){return{...this.physicsState}}getTrail(){return[...this.trail]}clearTrail(){this.trail=[]}toGeoJSON(){return{type:"Feature",geometry:{type:"Point",coordinates:[this.physicsState.position[0],this.physicsState.position[1],this.physicsState.position[2]]},properties:{type:"drone",rotation:this.physicsState.rotation,velocity:this.physicsState.velocity}}}trailToGeoJSON(){return{type:"Feature",geometry:{type:"LineString",coordinates:this.trail.map(bt=>[bt[0],bt[1],bt[2]])},properties:{type:"drone-trail"}}}}class y2{constructor(bt,Lt){Mi(this,"map");Mi(this,"droneModel");Mi(this,"keyboardState");Mi(this,"gamepadIndex",null);Mi(this,"updateInterval",null);Mi(this,"updateRate",1e3/60);Mi(this,"controls",{forward:["w","ArrowUp"],backward:["s","ArrowDown"],left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["Space"],down:["Shift"],rotateLeft:["q"],rotateRight:["e"],turbo:["Control"]});Mi(this,"params",{moveSpeed:1e-4,altitudeSpeed:2,rotationSpeed:2,turboMultiplier:2});this.map=bt,this.droneModel=Lt,this.keyboardState={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rotateLeft:!1,rotateRight:!1,turbo:!1},this.setupEventListeners(),this.detectGamepad()}setupEventListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this)),window.addEventListener("gamepadconnected",this.handleGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.handleGamepadDisconnected.bind(this))}handleKeyDown(bt){const Lt=bt.key.toLowerCase();(this.controls.forward.includes(Lt)||this.controls.forward.includes(bt.key))&&(this.keyboardState.forward=!0,bt.preventDefault()),(this.controls.backward.includes(Lt)||this.controls.backward.includes(bt.key))&&(this.keyboardState.backward=!0,bt.preventDefault()),(this.controls.left.includes(Lt)||this.controls.left.includes(bt.key))&&(this.keyboardState.left=!0,bt.preventDefault()),(this.controls.right.includes(Lt)||this.controls.right.includes(bt.key))&&(this.keyboardState.right=!0,bt.preventDefault()),this.controls.up.includes(bt.key)&&(this.keyboardState.up=!0,bt.preventDefault()),this.controls.down.includes(bt.key)&&(this.keyboardState.down=!0,bt.preventDefault()),this.controls.rotateLeft.includes(Lt)&&(this.keyboardState.rotateLeft=!0,bt.preventDefault()),this.controls.rotateRight.includes(Lt)&&(this.keyboardState.rotateRight=!0,bt.preventDefault()),this.controls.turbo.includes(bt.key)&&(this.keyboardState.turbo=!0,bt.preventDefault())}handleKeyUp(bt){const Lt=bt.key.toLowerCase();(this.controls.forward.includes(Lt)||this.controls.forward.includes(bt.key))&&(this.keyboardState.forward=!1),(this.controls.backward.includes(Lt)||this.controls.backward.includes(bt.key))&&(this.keyboardState.backward=!1),(this.controls.left.includes(Lt)||this.controls.left.includes(bt.key))&&(this.keyboardState.left=!1),(this.controls.right.includes(Lt)||this.controls.right.includes(bt.key))&&(this.keyboardState.right=!1),this.controls.up.includes(bt.key)&&(this.keyboardState.up=!1),this.controls.down.includes(bt.key)&&(this.keyboardState.down=!1),this.controls.rotateLeft.includes(Lt)&&(this.keyboardState.rotateLeft=!1),this.controls.rotateRight.includes(Lt)&&(this.keyboardState.rotateRight=!1),this.controls.turbo.includes(bt.key)&&(this.keyboardState.turbo=!1)}handleGamepadConnected(bt){console.log(":",bt.gamepad.id),this.gamepadIndex=bt.gamepad.index}handleGamepadDisconnected(bt){console.log(":",bt.gamepad.id),this.gamepadIndex===bt.gamepad.index&&(this.gamepadIndex=null)}detectGamepad(){var Lt;const bt=navigator.getGamepads();for(let re=0;re<bt.length;re++)if(bt[re]){this.gamepadIndex=re,console.log(":",(Lt=bt[re])==null?void 0:Lt.id);break}}getGamepadInput(){var re,Dt,qt,nt,i;if(this.gamepadIndex===null)return null;const Lt=navigator.getGamepads()[this.gamepadIndex];return Lt?{leftStick:{x:Lt.axes[0]||0,y:Lt.axes[1]||0},rightStick:{x:Lt.axes[2]||0,y:Lt.axes[3]||0},throttle:((re=Lt.buttons[7])==null?void 0:re.value)||0,buttons:{takeoff:((Dt=Lt.buttons[0])==null?void 0:Dt.pressed)||!1,land:((qt=Lt.buttons[1])==null?void 0:qt.pressed)||!1,hover:((nt=Lt.buttons[2])==null?void 0:nt.pressed)||!1,turbo:((i=Lt.buttons[6])==null?void 0:i.pressed)||!1}}:null}enable(){this.updateInterval===null&&(this.updateInterval=window.setInterval(()=>{this.update()},this.updateRate),console.log(""))}disable(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null),this.keyboardState={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,rotateLeft:!1,rotateRight:!1,turbo:!1},console.log("")}update(){const bt=this.updateRate/1e3,Lt=this.getGamepadInput();let re=0,Dt=0,qt=0,nt=0;if(this.keyboardState.forward&&(Dt+=1),this.keyboardState.backward&&(Dt-=1),this.keyboardState.left&&(re-=1),this.keyboardState.right&&(re+=1),this.keyboardState.up&&(qt+=1),this.keyboardState.down&&(qt-=1),this.keyboardState.rotateLeft&&(nt-=1),this.keyboardState.rotateRight&&(nt+=1),Lt){const $o=Math.abs(Lt.leftStick.x)>.15?Lt.leftStick.x:0,no=Math.abs(Lt.leftStick.y)>.15?Lt.leftStick.y:0,bo=Math.abs(Lt.rightStick.x)>.15?Lt.rightStick.x:0;re+=$o,Dt-=no,nt+=bo,Lt.throttle>.1&&(qt+=Lt.throttle)}const i=this.keyboardState.turbo||Lt!=null&&Lt.buttons.turbo?this.params.turboMultiplier:1,Le=this.droneModel.getPhysicsState(),wi=Le.position,nr=Le.rotation,bn=this.map.getBearing(),cn=bn*Math.PI/180,Rr=re*Math.cos(cn)-Dt*Math.sin(cn),xr=re*Math.sin(cn)+Dt*Math.cos(cn),Ci=wi[0]+Rr*this.params.moveSpeed*i,Re=wi[1]+xr*this.params.moveSpeed*i,Rn=wi[2]+qt*this.params.altitudeSpeed*bt*i,pr=Math.max(5,Math.min(500,Rn));this.droneModel.updatePosition([Ci,Re,pr]);const $r=nr[2]+nt*this.params.rotationSpeed;this.droneModel.updateRotation([nr[0],nr[1],$r]),this.droneModel.updatePhysics(bt),(re!==0||Dt!==0||qt!==0||nt!==0)&&(this.map.setCenter([Ci,Re]),nt!==0&&this.map.setBearing(bn+nt*this.params.rotationSpeed))}getKeyboardState(){return{...this.keyboardState}}isGamepadConnected(){return this.gamepadIndex!==null}updateParams(bt){Object.assign(this.params,bt)}getControlsHelp(){return`

  W /        : 
  S /        : 
  A /        : 
  D /        : 
  Space       : 
  Shift       : 
  Q           : 
  E           : 
  Ctrl        : 


    : 
    : 
  R2    : 
  L2    : 
  A      : 
  B      : 
		`}}class x2{constructor(bt,Lt){Mi(this,"map");Mi(this,"droneModel");Mi(this,"leftJoystick");Mi(this,"rightJoystick");Mi(this,"updateInterval",null);Mi(this,"updateRate",1e3/60);Mi(this,"leftJoystickContainer",null);Mi(this,"leftJoystickKnob",null);Mi(this,"rightJoystickContainer",null);Mi(this,"rightJoystickKnob",null);Mi(this,"config",{maxDistance:60,deadzone:.15,sensitivity:1.5,returnSpeed:.2});Mi(this,"params",{moveSpeed:1e-4,altitudeSpeed:2,rotationSpeed:2});this.map=bt,this.droneModel=Lt,this.leftJoystick=this.createTouchState(),this.rightJoystick=this.createTouchState(),this.setupJoystickUI(),this.setupEventListeners()}createTouchState(){return{active:!1,startX:0,startY:0,currentX:0,currentY:0,deltaX:0,deltaY:0,touchId:null}}setupJoystickUI(){this.leftJoystickContainer=document.getElementById("leftJoystick"),this.leftJoystickKnob=document.getElementById("leftJoystickKnob"),this.rightJoystickContainer=document.getElementById("rightJoystick"),this.rightJoystickKnob=document.getElementById("rightJoystickKnob"),(!this.leftJoystickContainer||!this.rightJoystickContainer)&&console.warn("UI")}setupEventListeners(){this.leftJoystickContainer&&(this.leftJoystickContainer.addEventListener("touchstart",this.handleTouchStart.bind(this,"left"),{passive:!1}),this.leftJoystickContainer.addEventListener("touchmove",this.handleTouchMove.bind(this,"left"),{passive:!1}),this.leftJoystickContainer.addEventListener("touchend",this.handleTouchEnd.bind(this,"left"),{passive:!1})),this.rightJoystickContainer&&(this.rightJoystickContainer.addEventListener("touchstart",this.handleTouchStart.bind(this,"right"),{passive:!1}),this.rightJoystickContainer.addEventListener("touchmove",this.handleTouchMove.bind(this,"right"),{passive:!1}),this.rightJoystickContainer.addEventListener("touchend",this.handleTouchEnd.bind(this,"right"),{passive:!1}))}handleTouchStart(bt,Lt){Lt.preventDefault();const re=Lt.touches[0];if(!re)return;const Dt=bt==="left"?this.leftJoystick:this.rightJoystick,qt=bt==="left"?this.leftJoystickContainer:this.rightJoystickContainer;if(!qt)return;const nt=qt.getBoundingClientRect(),i=nt.left+nt.width/2,Le=nt.top+nt.height/2;Dt.active=!0,Dt.touchId=re.identifier,Dt.startX=i,Dt.startY=Le,Dt.currentX=re.clientX,Dt.currentY=re.clientY,this.updateJoystickDelta(Dt),this.updateJoystickUI(bt)}handleTouchMove(bt,Lt){Lt.preventDefault();const re=bt==="left"?this.leftJoystick:this.rightJoystick;if(!re.active||re.touchId===null)return;const Dt=Array.from(Lt.touches).find(qt=>qt.identifier===re.touchId);Dt&&(re.currentX=Dt.clientX,re.currentY=Dt.clientY,this.updateJoystickDelta(re),this.updateJoystickUI(bt))}handleTouchEnd(bt,Lt){Lt.preventDefault();const re=bt==="left"?this.leftJoystick:this.rightJoystick;re.active=!1,re.touchId=null,re.deltaX=0,re.deltaY=0,this.updateJoystickUI(bt)}updateJoystickDelta(bt){let Lt=bt.currentX-bt.startX,re=bt.currentY-bt.startY;if(Math.sqrt(Lt*Lt+re*re)>this.config.maxDistance){const qt=Math.atan2(re,Lt);Lt=Math.cos(qt)*this.config.maxDistance,re=Math.sin(qt)*this.config.maxDistance}bt.deltaX=Lt/this.config.maxDistance,bt.deltaY=re/this.config.maxDistance,Math.abs(bt.deltaX)<this.config.deadzone&&(bt.deltaX=0),Math.abs(bt.deltaY)<this.config.deadzone&&(bt.deltaY=0)}updateJoystickUI(bt){const Lt=bt==="left"?this.leftJoystick:this.rightJoystick,re=bt==="left"?this.leftJoystickKnob:this.rightJoystickKnob;if(re)if(Lt.active){const Dt=Lt.deltaX*this.config.maxDistance,qt=Lt.deltaY*this.config.maxDistance;re.style.transform=`translate(${Dt}px, ${qt}px)`,re.style.opacity="1"}else re.style.transform="translate(0, 0)",re.style.opacity="0.5"}enable(){this.updateInterval===null&&(this.leftJoystickContainer&&(this.leftJoystickContainer.style.display="flex",this.leftJoystickContainer.style.pointerEvents="auto"),this.rightJoystickContainer&&(this.rightJoystickContainer.style.display="flex",this.rightJoystickContainer.style.pointerEvents="auto"),this.updateInterval=window.setInterval(()=>{this.processInput()},this.updateRate))}disable(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null),this.leftJoystickContainer&&(this.leftJoystickContainer.style.display="none",this.leftJoystickContainer.style.pointerEvents="none"),this.rightJoystickContainer&&(this.rightJoystickContainer.style.display="none",this.rightJoystickContainer.style.pointerEvents="none"),this.leftJoystick=this.createTouchState(),this.rightJoystick=this.createTouchState()}processInput(){const bt=this.getInput(),Lt=this.droneModel.getPosition();let[re,Dt,qt]=Lt;const nt=this.updateRate/1e3,i=this.config.sensitivity,Le=-bt.leftJoystick.y;Dt+=Le*this.params.moveSpeed*i;const wi=bt.leftJoystick.x;re+=wi*this.params.moveSpeed*i;const nr=-bt.rightJoystick.y;qt+=nr*this.params.altitudeSpeed*nt*i;const bn=bt.rightJoystick.x,Rr=this.map.getBearing()+bn*this.params.rotationSpeed*i;this.droneModel.updatePosition([re,Dt,qt]),this.map.easeTo({center:[re,Dt],bearing:Rr,duration:this.updateRate})}getInput(){return{leftJoystick:{x:this.leftJoystick.deltaX,y:this.leftJoystick.deltaY},rightJoystick:{x:this.rightJoystick.deltaX,y:this.rightJoystick.deltaY},buttons:{turbo:!1,center:!1}}}isEnabled(){return this.updateInterval!==null}updateConfig(bt){this.config={...this.config,...bt}}destroy(){this.disable(),this.leftJoystickContainer&&this.leftJoystickContainer.replaceWith(this.leftJoystickContainer.cloneNode(!0)),this.rightJoystickContainer&&this.rightJoystickContainer.replaceWith(this.rightJoystickContainer.cloneNode(!0))}}class v2{constructor(){Mi(this,"map",null);Mi(this,"droneModel",null);Mi(this,"flightController",null);Mi(this,"state",{isEnabled:!1,flightStatus:"STANDBY",currentPhase:"-",phaseIndex:0,totalPhases:0,elapsedTime:0,dronePosition:null,droneAltitude:0,droneHeading:0,droneSpeed:0,cameraCenter:null,cameraZoom:0,cameraPitch:0,cameraBearing:0,currentPhaseData:null,totalObjects:0,fps:0,memory:0});Mi(this,"events",[]);Mi(this,"maxEvents",10);Mi(this,"updateInterval",null);Mi(this,"startTime",0);Mi(this,"frameCount",0);Mi(this,"lastFpsTime",0);Mi(this,"overlay",null);Mi(this,"toggleBtn",null);Mi(this,"closeBtn",null);Mi(this,"debugModeBtn",null);Mi(this,"handleToggle");Mi(this,"handleClose");Mi(this,"handleToggleBtnClick");this.handleToggle=()=>this.toggle(),this.handleClose=()=>this.hide(),this.handleToggleBtnClick=()=>{var bt;(bt=this.overlay)!=null&&bt.classList.contains("visible")?this.hide():this.show()},this.initializeDOMElements(),this.setupEventListeners()}initializeDOMElements(){this.overlay=document.getElementById("debugOverlay"),this.toggleBtn=document.getElementById("debugToggleBtn"),this.closeBtn=document.getElementById("debugOverlayClose")}setupEventListeners(){this.debugModeBtn=document.getElementById("toggleDebugMode"),this.debugModeBtn&&this.debugModeBtn.addEventListener("click",this.handleToggle),this.closeBtn&&this.closeBtn.addEventListener("click",this.handleClose),this.toggleBtn&&this.toggleBtn.addEventListener("click",this.handleToggleBtnClick)}removeEventListeners(){this.debugModeBtn&&this.debugModeBtn.removeEventListener("click",this.handleToggle),this.closeBtn&&this.closeBtn.removeEventListener("click",this.handleClose),this.toggleBtn&&this.toggleBtn.removeEventListener("click",this.handleToggleBtnClick)}setMap(bt){this.map=bt}setDroneModel(bt){this.droneModel=bt}setFlightController(bt){this.flightController=bt}enable(){this.state.isEnabled=!0,this.startTime=Date.now(),this.lastFpsTime=performance.now(),this.frameCount=0,this.toggleBtn&&this.toggleBtn.classList.add("active"),this.startUpdateLoop(),this.show(),this.addEvent("ENABLE","Debug mode enabled"),console.log("[DEBUG] Debug mode enabled")}disable(){this.state.isEnabled=!1,this.toggleBtn&&this.toggleBtn.classList.remove("active"),this.stopUpdateLoop(),this.hide(),this.addEvent("DISABLE","Debug mode disabled"),console.log("[DEBUG] Debug mode disabled")}toggle(){this.state.isEnabled?this.disable():this.enable()}show(){this.overlay&&this.overlay.classList.add("visible")}hide(){this.overlay&&this.overlay.classList.remove("visible")}startUpdateLoop(){this.updateInterval||(this.updateInterval=window.setInterval(()=>{this.updateState(),this.updateDOM()},100))}stopUpdateLoop(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}updateState(){this.state.elapsedTime=Date.now()-this.startTime,this.frameCount++;const bt=performance.now();if(bt-this.lastFpsTime>=1e3&&(this.state.fps=Math.round(this.frameCount*1e3/(bt-this.lastFpsTime)),this.frameCount=0,this.lastFpsTime=bt),performance.memory&&(this.state.memory=Math.round(performance.memory.usedJSHeapSize/1024/1024)),this.map){const Lt=this.map.getCenter();this.state.cameraCenter={lng:Lt.lng,lat:Lt.lat},this.state.cameraZoom=this.map.getZoom(),this.state.cameraPitch=this.map.getPitch(),this.state.cameraBearing=this.map.getBearing()}if(this.droneModel){if(typeof this.droneModel.getPosition=="function"){const Lt=this.droneModel.getPosition();Lt&&(this.state.dronePosition={lng:Lt[0],lat:Lt[1]},this.state.droneAltitude=Lt[2]||0)}typeof this.droneModel.getHeading=="function"&&(this.state.droneHeading=this.droneModel.getHeading()),typeof this.droneModel.getSpeed=="function"&&(this.state.droneSpeed=this.droneModel.getSpeed())}}updateDOM(){this.updateElement("debugFlightStatus",this.state.flightStatus,this.getStatusClass()),this.updateElement("debugCurrentPhase",this.state.currentPhase),this.updateElement("debugPhaseIndex",`${this.state.phaseIndex} / ${this.state.totalPhases}`),this.updateElement("debugElapsedTime",this.formatTime(this.state.elapsedTime)),this.state.dronePosition&&this.updateElement("debugDronePosition",`${this.state.dronePosition.lng.toFixed(6)}, ${this.state.dronePosition.lat.toFixed(6)}`),this.updateElement("debugDroneAltitude",`${this.state.droneAltitude.toFixed(1)}`),this.updateElement("debugDroneHeading",`${this.state.droneHeading.toFixed(1)}`),this.updateElement("debugDroneSpeed",`${this.state.droneSpeed.toFixed(2)}`),this.state.cameraCenter&&this.updateElement("debugCameraCenter",`${this.state.cameraCenter.lng.toFixed(6)}, ${this.state.cameraCenter.lat.toFixed(6)}`),this.updateElement("debugCameraZoom",`${this.state.cameraZoom.toFixed(2)}`),this.updateElement("debugCameraPitch",`${this.state.cameraPitch.toFixed(1)}`),this.updateElement("debugCameraBearing",`${this.state.cameraBearing.toFixed(1)}`);const bt=document.getElementById("debugPhaseData");bt&&(this.state.currentPhaseData?bt.innerHTML=this.formatJSON(this.state.currentPhaseData):bt.textContent="-"),this.updateElement("debugTotalObjects",`${this.state.totalObjects}`),this.updateElement("debugTotalPhases",`${this.state.totalPhases}`),this.updateElement("debugFPS",`${this.state.fps}`),this.updateElement("debugMemory",`${this.state.memory}`)}updateElement(bt,Lt,re){const Dt=document.getElementById(bt);Dt&&(Dt.textContent=Lt,re&&(Dt.className=`debug-value ${re}`))}getStatusClass(){switch(this.state.flightStatus){case"FLYING":return"success";case"PAUSED":return"warning";case"ERROR":return"error";case"COMPLETED":return"info";default:return""}}formatTime(bt){const Lt=Math.floor(bt/1e3),re=Math.floor(Lt/3600),Dt=Math.floor(Lt%3600/60),qt=Lt%60;return`${re.toString().padStart(2,"0")}:${Dt.toString().padStart(2,"0")}:${qt.toString().padStart(2,"0")}`}escapeHtml(bt){return bt.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}formatJSON(bt){const Lt=JSON.stringify(bt,null,2);return this.escapeHtml(Lt).replace(/&quot;([^&]+)&quot;:/g,'<span class="key">&quot;$1&quot;</span>:').replace(/: &quot;([^&]*)&quot;/g,': <span class="string">&quot;$1&quot;</span>').replace(/([:,\[]\s*)(-?\d+\.?\d*)/g,'$1<span class="number">$2</span>').replace(/: (true|false)/g,': <span class="boolean">$1</span>').replace(/: null/g,': <span class="null">null</span>')}addEvent(bt,Lt){const re=new Date,Dt=`${re.getHours().toString().padStart(2,"0")}:${re.getMinutes().toString().padStart(2,"0")}:${re.getSeconds().toString().padStart(2,"0")}`;this.events.unshift({time:Dt,type:bt,data:Lt}),this.events.length>this.maxEvents&&(this.events=this.events.slice(0,this.maxEvents)),this.updateEventLog()}updateEventLog(){const bt=document.getElementById("debugEventLog");bt&&(bt.innerHTML=this.events.map(Lt=>`
			<div class="debug-event">
				<span class="debug-event-time">${Lt.time}</span>
				<span class="debug-event-type">${Lt.type}</span>
				<span class="debug-event-data">${Lt.data}</span>
			</div>
		`).join(""))}setFlightStatus(bt){this.state.flightStatus=bt,this.addEvent("STATUS",`Flight status changed to ${bt}`)}setCurrentPhase(bt,Lt,re){this.state.currentPhase=bt.phase,this.state.phaseIndex=Lt+1,this.state.totalPhases=re,this.state.currentPhaseData=bt,this.addEvent("PHASE",`${bt.phase}: ${bt.action}`)}setTotalObjects(bt){this.state.totalObjects=bt}setTotalPhases(bt){this.state.totalPhases=bt}logEvent(bt,Lt){this.addEvent(bt,Lt)}isEnabled(){return this.state.isEnabled}destroy(){this.stopUpdateLoop(),this.removeEventListeners(),this.events=[],this.map=null,this.droneModel=null,this.flightController=null,this.overlay=null,this.toggleBtn=null,this.closeBtn=null,this.debugModeBtn=null}}const up=jT(),b2=up.provider==="mapbox"?Pb:nv;up.provider==="mapbox"?up.mapboxAccessToken?(Pb.accessToken=up.mapboxAccessToken,console.log("[OK] Mapbox GL ")):console.warn("[WARNING] Mapbox "):console.log("[OK] MapLibre GL ");const av=window.IS_MOBILE_DEVICE||!1,w2={maxZoom:16,pitch:0,maxPitch:30,zoom:14,tileSize:512,enableTerrain:!1,terrainExaggeration:0,fadeDuration:0,enableDroneTrail:!1,pixelRatio:Math.min(window.devicePixelRatio,2),roundZoomLevel:!0,collectResourceTiming:!1},T2={maxZoom:18,pitch:60,maxPitch:85,zoom:15,tileSize:256,enableTerrain:!0,terrainExaggeration:1.2,fadeDuration:300,enableDroneTrail:!0},af=av?w2:T2;console.log("=".repeat(60));console.log("");console.log(":",av?"":"");console.log(":",af);console.log("=".repeat(60));const S2=`id,name,type,source,longitude,latitude,altitude,relativeAltitude,timestamp,duration,speed,heading,action,waypointId,sequenceNumber,batteryLevel,signalStrength,gpsAccuracy,temperature,humidity,windSpeed,windDirection,missionId,operatorId,aircraftModel,aircraftSerial,description
flight_001,1,waypoint,manual,139.7454,35.6586,100,50,2024-01-15T10:00:00Z,30,5,0,takeoff,1,1,85,-45,2,25,60,3,180,mission_001,operator_001,DJI_Mavic_3,SN001,
flight_002,2,waypoint,manual,139.7456,35.6588,120,70,2024-01-15T10:01:00Z,45,8,90,hover,2,2,82,-48,1.5,24,58,2.5,175,mission_001,operator_001,DJI_Mavic_3,SN001,
flight_003,3,waypoint,manual,139.7458,35.6590,150,100,2024-01-15T10:02:00Z,60,6,180,move,3,3,79,-50,2,23,55,3,170,mission_001,operator_001,DJI_Mavic_3,SN001,`,I2=`id,name,type,source,longitude,latitude,altitude,relativeAltitude,timestamp,duration,speed,heading,action,waypointId,sequenceNumber,batteryLevel,signalStrength,gpsAccuracy,temperature,humidity,windSpeed,windDirection,missionId,operatorId,aircraftModel,aircraftSerial,description
trajectory_001,1,trajectory_point,auto,139.7450,35.6580,50,0,2024-01-15T09:55:00Z,10,3,0,takeoff,1,1,90,-40,1,26,65,1,180,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_002,2,trajectory_point,auto,139.7452,35.6582,75,25,2024-01-15T09:56:00Z,15,5,45,move,2,2,88,-42,1.2,25,63,1.5,175,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_003,3,trajectory_point,auto,139.7454,35.6584,100,50,2024-01-15T09:57:00Z,20,7,90,move,3,3,85,-45,1.5,24,60,2,170,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_004,4,trajectory_point,auto,139.7456,35.6586,125,75,2024-01-15T09:58:00Z,25,6,135,move,4,4,82,-48,1.8,23,57,2.5,165,trajectory_001,operator_001,DJI_Mavic_3,SN001,
trajectory_005,5,trajectory_point,auto,139.7458,35.6588,150,100,2024-01-15T09:59:00Z,30,4,180,land,5,5,79,-50,2,22,55,3,160,trajectory_001,operator_001,DJI_Mavic_3,SN001,`;window.addEventListener("error",jt=>{var bt;console.error(":",jt.error||jt.message),jt.preventDefault(),ix("",((bt=jt.error)==null?void 0:bt.message)||jt.message||"","error")});window.addEventListener("unhandledrejection",jt=>{console.error("Promise:",jt.reason),jt.preventDefault();const bt=jt.reason instanceof Error?jt.reason.message:String(jt.reason||"");ix("",bt,"error")});function ix(jt,bt,Lt="error"){const re=Lt==="error"?"rgba(244, 67, 54, 0.95)":"rgba(255, 193, 7, 0.95)",Dt=Lt==="error"?"#fff":"#000",qt=document.createElement("div");qt.style.cssText=`
		position: fixed;
		top: 20px;
		right: 20px;
		background: ${re};
		color: ${Dt};
		padding: 16px 24px;
		border-radius: 8px;
		z-index: 10000;
		font-size: 14px;
		box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		max-width: 400px;
		cursor: pointer;
		animation: slideIn 0.3s ease-out;
	`,qt.innerHTML=`
		<div style="font-weight: bold; margin-bottom: 4px;">${jt}</div>
		<div style="font-size: 12px; opacity: 0.9;">${bt}</div>
		<div style="font-size: 11px; margin-top: 8px; opacity: 0.7;"></div>
	`,qt.addEventListener("click",()=>{qt.style.transition="opacity 0.3s",qt.style.opacity="0",setTimeout(()=>qt.remove(),300)}),document.body.appendChild(qt),setTimeout(()=>{qt.parentElement&&(qt.style.transition="opacity 0.5s",qt.style.opacity="0",setTimeout(()=>qt.remove(),500))},1e4)}console.log(" ...");let My;try{if(console.log("[START] DEM..."),typeof nv.addProtocol!="function")throw new Error("maplibregl.addProtocol MapLibre GL JS");const jt=f2("gsidem");console.log("[DEBUG] Protocol action created:",typeof jt),nv.addProtocol("gsidem",jt),console.log("[DEBUG] addProtocol called"),My={type:"raster-dem",tiles:["gsidem://https://tiles.gsj.jp/tiles/elev/mixed/{z}/{y}/{x}.png"],tileSize:256,encoding:"terrarium",minzoom:1,maxzoom:14,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},console.log("[SUCCESS] DEM"),console.log("[DEBUG] Terrain source tiles:",My.tiles)}catch(jt){console.error("[ERROR] DEM:",jt),My={type:"raster-dem",tiles:["https://tiles.gsj.jp/tiles/elev/mixed/{z}/{y}/{x}.png"],tileSize:256,encoding:"terrarium",minzoom:1,maxzoom:14,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'};const bt=jt instanceof Error?jt.message:String(jt);console.warn(` 
:`,bt),setTimeout(()=>{const Lt=document.createElement("div");Lt.style.cssText=`
			position: fixed;
			bottom: 80px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(255, 193, 7, 0.95);
			color: #000;
			padding: 12px 24px;
			border-radius: 8px;
			z-index: 10000;
			font-size: 14px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			max-width: 90%;
			text-align: center;
		`,Lt.textContent=" ",document.body.appendChild(Lt),setTimeout(()=>{Lt.style.transition="opacity 0.5s",Lt.style.opacity="0",setTimeout(()=>Lt.remove(),500)},5e3)},1e3)}const pg={center:[139.7454,35.6586],zoom:15,pitch:60,bearing:0},dr=new b2.Map({container:"map",zoom:pg.zoom,center:pg.center,minZoom:5,maxZoom:18,pitch:pg.pitch,maxPitch:85,preserveDrawingBuffer:!0,refreshExpiredTiles:!1,fadeDuration:af.fadeDuration,trackResize:!0,...av&&{maxTileCacheSize:50,renderWorldCopies:!1,crossSourceCollisions:!1,pixelRatio:af.pixelRatio,collectResourceTiming:!1,antialias:!1},style:{version:8,glyphs:"https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",sources:{seamlessphoto:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg"],maxzoom:18,tileSize:af.tileSize,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html"></a>'},...af.enableTerrain?{terrain:My}:{},"drone-objects":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"drone-connections":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"altitude-lines":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"drawing-polygon":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"selected-object":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"flight-plan-waypoints":{type:"geojson",data:{type:"FeatureCollection",features:[]}},"flight-plan-path":{type:"geojson",data:{type:"FeatureCollection",features:[]}}},layers:[{id:"seamlessphoto",source:"seamlessphoto",type:"raster"}],...af.enableTerrain?{terrain:{source:"terrain",exaggeration:af.terrainExaggeration}}:{}}});dr.on("error",jt=>{var Lt;console.error(":",jt);const bt=((Lt=jt.error)==null?void 0:Lt.message)||"";bt.includes("Failed to fetch")?(ix("","","warning"),Mo(": ")):(ix("",bt,"error"),Mo(`: ${bt}`))});console.log(" - load...");let co=[],Cy=!0,of=!1,sf=!1,au=!1,xa=null,Pm=!1,m_=null,Cc=[],ug=null,ev=!1,E2,dg,Q0,f_,Vf,va,ov=!1,Am=!1,lf=[],Mm=!1,dp=0,sl=[],Ou="",Dy="";const sv=[{phase:"",action:"",duration:3e3,position:[139.7454,35.6586,100]},{phase:"1",action:"",duration:4e3,position:[139.7456,35.6588,150]},{phase:"2",action:"",duration:4e3,position:[139.7452,35.6588,150]},{phase:"3",action:"",duration:4e3,position:[139.7452,35.6584,150]},{phase:"4",action:"",duration:4e3,position:[139.7456,35.6584,150]},{phase:"1",action:"",duration:3e3,position:[139.7455,35.6587,120]},{phase:"2",action:"",duration:3e3,position:[139.7453,35.6587,120]},{phase:"3",action:"",duration:3e3,position:[139.7453,35.6585,120]},{phase:"4",action:"",duration:3e3,position:[139.7455,35.6585,120]},{phase:"",action:"",duration:5e3,position:[139.7454,35.6586,200]},{phase:"",action:"",duration:3e3,position:[139.7454,35.6586,0]}];sl=sv;Ou="";Dy="";const Fr=(jt,bt="info")=>{const Lt=document.createElement("div");Lt.style.cssText=`
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bt==="success"?"rgba(34, 197, 94, 0.9)":bt==="error"?"rgba(239, 68, 68, 0.9)":"rgba(59, 130, 246, 0.9)"};
        backdrop-filter: blur(4px);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 13px;
        font-weight: 500;
        max-width: 300px;
        word-wrap: break-word;
        border: 1px solid ${bt==="success"?"rgba(34, 197, 94, 0.3)":bt==="error"?"rgba(239, 68, 68, 0.3)":"rgba(59, 130, 246, 0.3)"};
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
    `,Lt.textContent=jt,document.body.appendChild(Lt),setTimeout(()=>{Lt.style.transform="translateX(0)",Lt.style.opacity="1"},100),setTimeout(()=>{Lt.style.transform="translateX(100%)",Lt.style.opacity="0",setTimeout(()=>{document.body.contains(Lt)&&document.body.removeChild(Lt)},300)},3e3)},on=(jt,bt,Lt,re="info",Dt,qt)=>{const Le={timestamp:new Date().toLocaleTimeString("ja-JP"),phase:jt,action:bt,details:Lt,type:re,...Dt&&{position:Dt},...qt&&{camera:qt}};lf.push(Le),mg(),lf.length>50&&(lf=lf.slice(-30))},mg=()=>{var re;const jt=document.getElementById("flightStatus"),bt=document.getElementById("flightLog"),Lt=document.getElementById("flightLogContainer");if(!(!jt||!bt||!Lt)){if(jt.innerHTML="",Mm&&sl.length>0){const Dt=document.createElement("div");Dt.className="flight-status-bar",Dt.innerHTML=`
			<div class="status-indicator active">
				<span class="status-dot"></span>
				<span class="status-text"></span>
			</div>
			<div class="current-phase">
				<span class="phase-label">:</span>
				<span class="phase-name">${((re=sl[dp])==null?void 0:re.phase)||""}</span>
				<span class="phase-number">(${dp+1}/${sl.length})</span>
			</div>
		`,jt.appendChild(Dt)}else if(sl.length>0){const Dt=document.createElement("div");Dt.className="flight-status-bar",Dt.innerHTML=`
			<div class="status-indicator standby">
				<span class="status-dot"></span>
				<span class="status-text"></span>
			</div>
			<div class="current-phase">
				<span class="phase-label">:</span>
				<span class="phase-name">${Ou}</span>
			</div>
		`,jt.appendChild(Dt)}bt.innerHTML="",lf.forEach((Dt,qt)=>{const nt=document.createElement("div"),i=qt===lf.length-1,Le=qt>=lf.length-3;nt.className=`log-entry ${i?"log-entry-latest":""} ${Le?"log-entry-recent":""}`;const wi=document.createElement("span");wi.className="log-timestamp",wi.textContent=Dt.timestamp;const nr=document.createElement("span");nr.className="log-phase",nr.textContent=Dt.phase;const bn=document.createElement("span");bn.className=`log-action ${Dt.type}`,bn.textContent=Dt.action;const cn=document.createElement("span");if(cn.className="log-details",cn.textContent=Dt.details,i){const Rr=document.createElement("span");Rr.className="latest-indicator",Rr.textContent="",nt.insertBefore(Rr,nt.firstChild)}if(nt.appendChild(wi),nt.appendChild(nr),nt.appendChild(bn),nt.appendChild(cn),Dt.position||Dt.camera){const Rr=document.createElement("div");if(Rr.className="log-extended-info",Dt.position){const xr=document.createElement("div");xr.className="log-position-info",xr.innerHTML=`
					<span class="info-label">:</span>
					<span class="info-value"> ${Dt.position.latitude.toFixed(6)}</span>
					<span class="info-value"> ${Dt.position.longitude.toFixed(6)}</span>
					<span class="info-value"> ${Dt.position.altitude.toFixed(1)}m</span>
				`,Rr.appendChild(xr)}if(Dt.camera){const xr=document.createElement("div");xr.className="log-camera-info",xr.innerHTML=`
					<span class="info-label">:</span>
					<span class="info-value"> ${Dt.camera.bearing.toFixed(1)}</span>
					<span class="info-value"> ${Dt.camera.pitch}</span>
					<span class="info-value"> ${Dt.camera.zoom}</span>
				`,Rr.appendChild(xr)}nt.appendChild(Rr)}bt.appendChild(nt)}),requestAnimationFrame(()=>{Lt.scrollTo({top:Lt.scrollHeight,behavior:"smooth"})})}},A2=()=>{lf=[],mg(),on("","","","info")},P2=()=>{const Lt=`timestamp,phase,action,details,type,latitude,longitude,altitude,bearing,pitch,zoom
`+lf.map(nt=>{var xr,Ci,Re,Rn,pr,$r;const i=`${nt.timestamp},${nt.phase},${nt.action},${nt.details},${nt.type}`,Le=((xr=nt.position)==null?void 0:xr.latitude.toFixed(6))||"",wi=((Ci=nt.position)==null?void 0:Ci.longitude.toFixed(6))||"",nr=((Re=nt.position)==null?void 0:Re.altitude.toFixed(1))||"",bn=((Rn=nt.camera)==null?void 0:Rn.bearing.toFixed(1))||"",cn=((pr=nt.camera)==null?void 0:pr.pitch)||"",Rr=(($r=nt.camera)==null?void 0:$r.zoom)||"";return`${i},${Le},${wi},${nr},${bn},${cn},${Rr}`}).join(`
`),re=new Blob([Lt],{type:"text/csv"}),Dt=URL.createObjectURL(re),qt=document.createElement("a");qt.href=Dt,qt.download=`tokyo_tower_flight_log_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.csv`,document.body.appendChild(qt),qt.click(),document.body.removeChild(qt),URL.revokeObjectURL(Dt),on("","","CSV","success")},Mo=jt=>{const bt=document.getElementById("status");bt&&(bt.textContent=jt),console.log("Status:",jt)},M2=()=>{af.enableDroneTrail&&dr.addLayer({id:"altitude-lines-layer",type:"line",source:"altitude-lines",paint:{"line-color":"#ffaa00","line-width":1,"line-opacity":.4}}),dr.addLayer({id:"polygon-fill-layer",type:"fill",source:"drone-objects",filter:["==",["get","type"],"polygon"],paint:{"fill-color":"#ff6b6b","fill-opacity":.3}}),dr.addLayer({id:"polygon-stroke-layer",type:"line",source:"drone-objects",filter:["==",["get","type"],"polygon"],paint:{"line-color":"#ff6b6b","line-width":2,"line-opacity":.8}}),dr.addLayer({id:"drone-objects-3d",type:"circle",source:"drone-objects",filter:["!=",["get","type"],"polygon"],paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,["interpolate",["linear"],["get","altitude"],50,3,300,8],18,["interpolate",["linear"],["get","altitude"],50,6,300,16]],"circle-color":["match",["get","type"],"drone","#ff4444","building","#44ff44","sensor","#4444ff","base","#ffaa00","weather","#ff44ff","manual","#888888","flight","#ff6b6b","#cccccc"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),dr.addLayer({id:"drone-objects-2d",type:"circle",source:"drone-objects",filter:["!=",["get","type"],"polygon"],layout:{visibility:"none"},paint:{"circle-radius":6,"circle-color":["match",["get","type"],"drone","#ff4444","building","#44ff44","sensor","#4444ff","base","#ffaa00","weather","#ff44ff","manual","#888888","flight","#ff6b6b","#cccccc"],"circle-stroke-width":2,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),af.enableDroneTrail&&dr.addLayer({id:"drone-connections",type:"line",source:"drone-connections",paint:{"line-color":"#00ff00","line-width":2,"line-opacity":.7,"line-dasharray":[2,2]}}),dr.addLayer({id:"drone-labels",type:"symbol",source:"drone-objects",layout:{"text-field":["format",["get","name"],{},`
`,{},["concat",["to-string",["get","altitude"]],"m"],{"font-scale":.8}],"text-font":["Open Sans Regular","Arial Unicode MS Regular"],"text-size":12,"text-offset":[0,-2],"text-anchor":"bottom"},paint:{"text-color":"#ffffff","text-halo-color":"#000000","text-halo-width":1}}),dr.addLayer({id:"polygon-fill",type:"fill",source:"drawing-polygon",paint:{"fill-color":"#ff6b6b","fill-opacity":.3}}),dr.addLayer({id:"polygon-stroke",type:"line",source:"drawing-polygon",paint:{"line-color":"#ff6b6b","line-width":3,"line-opacity":.8}}),dr.addLayer({id:"polygon-points",type:"circle",source:"drawing-polygon",paint:{"circle-radius":6,"circle-color":"#ff6b6b","circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),dr.addLayer({id:"selected-object-highlight",type:"fill",source:"selected-object",paint:{"fill-color":"#00ff00","fill-opacity":.2}}),dr.addLayer({id:"selected-object-stroke",type:"line",source:"selected-object",paint:{"line-color":"#00ff00","line-width":4,"line-opacity":.8}}),dr.addLayer({id:"selected-object-points",type:"circle",source:"selected-object",paint:{"circle-radius":8,"circle-color":"#00ff00","circle-stroke-width":3,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),dr.addLayer({id:"flight-plan-path-layer",type:"line",source:"flight-plan-path",paint:{"line-color":"#00ffff","line-width":3,"line-opacity":.8},layout:{"line-cap":"round","line-join":"round"}}),dr.addLayer({id:"flight-plan-waypoints-layer",type:"circle",source:"flight-plan-waypoints",paint:{"circle-radius":["interpolate",["linear"],["zoom"],10,6,18,12],"circle-color":"#00ffff","circle-stroke-width":3,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),dr.addLayer({id:"flight-plan-waypoint-labels",type:"symbol",source:"flight-plan-waypoints",layout:{"text-field":["get","name"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":12,"text-offset":[0,-2],"text-anchor":"bottom"},paint:{"text-color":"#00ffff","text-halo-color":"#000000","text-halo-width":2}})},tx=jt=>{const bt=(qt,nt)=>{const i=dr.getSource(qt);(i==null?void 0:i.type)==="geojson"&&i.setData({type:"FeatureCollection",features:nt})};if(!jt||jt.length===0){bt("flight-plan-waypoints",[]),bt("flight-plan-path",[]);return}const Lt=jt.map((qt,nt)=>({type:"Feature",geometry:{type:"Point",coordinates:[qt.position[0],qt.position[1],qt.position[2]]},properties:{id:`waypoint-${nt}`,name:`WP${nt+1}: ${qt.phase}`,phase:qt.phase,action:qt.action,altitude:qt.position[2],sequenceNumber:nt+1}})),re=jt.map(qt=>[qt.position[0],qt.position[1],qt.position[2]]),Dt={type:"Feature",geometry:{type:"LineString",coordinates:re},properties:{id:"flight-path",name:"Flight Path"}};bt("flight-plan-waypoints",Lt),bt("flight-plan-path",[Dt]),console.log(`: ${jt.length}: ${re.length}`)},oc=()=>{var re,Dt;const jt=co.map(qt=>{const nt=qt;if(qt.type==="polygon"&&nt.geometry){const i={type:"Feature",geometry:nt.geometry,properties:{id:qt.id,name:qt.name,altitude:qt.altitude,type:qt.type,area:nt.area||0}};return console.log(":",i),i}else return{type:"Feature",geometry:{type:"Point",coordinates:[qt.longitude,qt.latitude]},properties:{id:qt.id,name:qt.name,altitude:qt.altitude,type:qt.type}}});console.log("updateDisplay: :",jt);const bt={type:"FeatureCollection",features:jt};console.log("drone-objects:",bt),(re=dr.getSource("drone-objects"))==null||re.setData(bt);const Lt=co.map(qt=>({type:"Feature",geometry:{type:"LineString",coordinates:[[qt.longitude,qt.latitude],[qt.longitude,qt.latitude]]},properties:{altitude:qt.altitude}}));af.enableDroneTrail&&((Dt=dr.getSource("altitude-lines"))==null||Dt.setData({type:"FeatureCollection",features:Lt}),C2()),console.log(`: ${co.length}`)},C2=()=>{var Lt,re;if(co.length<2){(Lt=dr.getSource("drone-connections"))==null||Lt.setData({type:"FeatureCollection",features:[]});return}const jt={};co.forEach(Dt=>{jt[Dt.type]||(jt[Dt.type]=[]),jt[Dt.type].push(Dt)});const bt=[];Object.values(jt).forEach(Dt=>{if(Dt.length>=2){const qt=Dt.map(nt=>[nt.longitude,nt.latitude]);bt.push({type:"Feature",geometry:{type:"LineString",coordinates:qt},properties:{type:"connection"}})}}),(re=dr.getSource("drone-connections"))==null||re.setData({type:"FeatureCollection",features:bt})},D2=jt=>{const bt=[jt.lng,jt.lat];if(Cc.length>=3){const Lt=Cc[0];if(Math.sqrt(Math.pow((bt[0]-Lt[0])*111e3,2)+Math.pow((bt[1]-Lt[1])*111e3,2))<100){L2();return}}Cc.push(bt),z2(),Fr(`${Cc.length} (${Cc.length>=3?"":""})`,"info")},z2=()=>{const jt=[];if(Cc.forEach((bt,Lt)=>{const re={type:"Feature",geometry:{type:"Point",coordinates:bt},properties:{index:Lt,isFirst:Lt===0}};jt.push(re)}),Cc.length>=2){const bt=[...Cc];Cc.length>=3&&bt.push(Cc[0]),jt.push({type:"Feature",geometry:{type:"LineString",coordinates:bt},properties:{type:"drawing-line"}})}dr.getSource("drawing-polygon").setData({type:"FeatureCollection",features:jt})},L2=()=>{if(Cc.length<3){Fr("3","warning");return}const jt=[...Cc,Cc[0]],bt=R2(Cc),Lt={id:`polygon_${Date.now()}`,name:`_${co.filter(re=>re.type==="polygon").length+1}`,longitude:Cc[0][0],latitude:Cc[0][1],altitude:0,type:"polygon",source:"polygon_draw",geometry:{type:"Polygon",coordinates:[jt]},area:bt};co.push(Lt),console.log(":",Lt),console.log("loadedObjects:",co),ex(),oc(),Fr(`${Lt.name} (: ${bt.toFixed(0)})`,"success")},R2=jt=>{let bt=0;const Lt=jt.length;for(let Dt=0;Dt<Lt;Dt++){const qt=(Dt+1)%Lt;bt+=jt[Dt][0]*jt[qt][1],bt-=jt[qt][0]*jt[Dt][1]}bt=Math.abs(bt)/2;const re=111e3;return bt*re*re},ex=()=>{Cc=[],dr.getSource("drawing-polygon").setData({type:"FeatureCollection",features:[]})},k2=jt=>{const bt=dr.project(jt),Lt=20;let re=null,Dt=1/0;return co.forEach(qt=>{const nt=dr.project([qt.longitude,qt.latitude]),i=Math.sqrt(Math.pow(bt.x-nt.x,2)+Math.pow(bt.y-nt.y,2));i<Lt&&i<Dt&&(Dt=i,re=qt)}),re?(xa=re,lv(),Fr(`${re.name}`,"info"),!0):(zy(),!1)},zy=()=>{xa=null,lv()},lv=()=>{if(!xa){dr.getSource("selected-object").setData({type:"FeatureCollection",features:[]});return}const jt=[];if(xa.type==="polygon"){const bt=xa;bt.geometry&&bt.geometry.coordinates&&(jt.push({type:"Feature",geometry:bt.geometry,properties:{id:xa.id,type:"selected-polygon"}}),bt.geometry.coordinates[0].slice(0,-1).forEach((Lt,re)=>{jt.push({type:"Feature",geometry:{type:"Point",coordinates:Lt},properties:{id:xa.id,type:"selected-vertex",vertexIndex:re}})}))}else jt.push({type:"Feature",geometry:{type:"Point",coordinates:[xa.longitude,xa.latitude]},properties:{id:xa.id,type:"selected-point"}});dr.getSource("selected-object").setData({type:"FeatureCollection",features:jt})},F2=()=>{dr.dragPan.disable(),dr.scrollZoom.disable(),dr.boxZoom.disable(),dr.dragRotate.disable(),dr.keyboard.disable(),dr.doubleClickZoom.disable(),dr.touchZoomRotate.disable()},B2=()=>{dr.dragPan.enable(),dr.scrollZoom.enable(),dr.boxZoom.enable(),dr.dragRotate.enable(),dr.keyboard.enable(),dr.doubleClickZoom.enable(),dr.touchZoomRotate.enable()},O2=jt=>xa?(Pm=!0,m_=[jt.lng,jt.lat],dr.getCanvas().style.cursor="grabbing",F2(),!0):!1,N2=jt=>{if(!Pm||!xa||!m_)return;const bt=jt.lng-m_[0],Lt=jt.lat-m_[1];if(xa.type==="polygon"){const re=xa;re.geometry&&re.geometry.coordinates&&(re.geometry.coordinates[0]=re.geometry.coordinates[0].map(Dt=>[Dt[0]+bt,Dt[1]+Lt]))}xa.longitude+=bt,xa.latitude+=Lt,m_=[jt.lng,jt.lat],oc(),lv()},Cb=()=>{Pm&&xa&&(Pm=!1,m_=null,dr.getCanvas().style.cursor=au?"crosshair":"",B2(),Fr(`${xa.name}`,"success"))},V2=()=>{if(!xa){Fr("","warning");return}const jt=xa.name;confirm(`${jt}`)&&(co=co.filter(Lt=>Lt.id!==xa.id),zy(),oc(),Fr(`${jt}`,"success"))},U2=jt=>{const bt={id:`manual_${Date.now()}`,name:`_${co.filter(Lt=>Lt.type==="manual").length+1}`,longitude:jt.lng,latitude:jt.lat,altitude:150+Math.random()*100,type:"manual",source:"manual_draw"};co.push(bt),oc(),Fr(`: ${bt.name}`,"success")},j2=()=>{Cy=!Cy,Cy?(dr.easeTo({pitch:60,duration:1e3}),dr.setLayoutProperty("drone-objects-3d","visibility","visible"),dr.setLayoutProperty("drone-objects-2d","visibility","none"),Mo("3D")):(dr.easeTo({pitch:0,duration:1e3}),dr.setLayoutProperty("drone-objects-3d","visibility","none"),dr.setLayoutProperty("drone-objects-2d","visibility","visible"),Mo("2D"))},G2=()=>{var Lt,re,Dt,qt,nt,i,Le,wi,nr,bn,cn,Rr,xr,Ci,Re,Rn,pr,$r,En,$o,no,bo,ba,Os,Ya,al,Ja,Hr,sc,cs,Kn,hn,Co,zn,Ys,vs,Ps,Hn;(Lt=document.getElementById("loadPoints"))==null||Lt.addEventListener("click",async()=>{try{const di=await fetch("./data/mock-3d-data.csv");if(!di.ok)throw new Error(`HTTP error! status: ${di.status}`);const tr=await di.text(),fr=new Blob([tr],{type:"text/csv"}),Wr=new File([fr],"sample-points.csv",{type:"text/csv"});await Y0(Wr,dr,"points"),Fr("","success")}catch(di){console.error(":",di),Fr("","error")}}),(re=document.getElementById("loadMesh"))==null||re.addEventListener("click",async()=>{try{const di=await fetch("./data/mock-mesh-data.csv");if(!di.ok)throw new Error(`HTTP error! status: ${di.status}`);const tr=await di.text(),fr=new Blob([tr],{type:"text/csv"}),Wr=new File([fr],"sample-mesh.csv",{type:"text/csv"});await Y0(Wr,dr,"mesh"),Fr("","success")}catch(di){console.error(":",di),Fr("","error")}}),(Dt=document.getElementById("loadBuilding"))==null||Dt.addEventListener("click",async()=>{try{console.log("");const[di,tr]=await Promise.all([fetch("./data/mock-building-inspection-points.csv"),fetch("./data/mock-building-inspection-mesh.csv")]);if(console.log(":",{points:{ok:di.ok,status:di.status},mesh:{ok:tr.ok,status:tr.status}}),!di.ok||!tr.ok)throw new Error(`: HTTP error! status: points=${di.status}, mesh=${tr.status}`);const[fr,Wr]=await Promise.all([di.text(),tr.text()]);console.log("CSV:",{pointsLength:fr.length,meshLength:Wr.length,pointsPreview:fr.substring(0,200),meshPreview:Wr.substring(0,200)});const qr=new Blob([fr],{type:"text/csv"}),Xi=new File([qr],"building-points.csv",{type:"text/csv"});await Y0(Xi,dr,"building-inspection");const Xr=new Blob([Wr],{type:"text/csv"}),$n=new File([Xr],"building-mesh.csv",{type:"text/csv"});await Y0($n,dr,"building-inspection-mesh"),Fr("","success")}catch(di){console.error(":",di),Fr(`: ${di instanceof Error?di.message:""}`,"error")}}),(qt=document.getElementById("loadDroneData"))==null||qt.addEventListener("click",()=>{if(ev)Fr("","info");else{const di=a2([139.7454,35.6586]);co.push(...di),oc(),ev=!0,Mo(`: ${di.length}`),Fr("","success")}}),(nt=document.getElementById("startSimulation"))==null||nt.addEventListener("click",()=>{if(ug){clearInterval(ug),ug=null,Mo("");return}if(co.length===0){Fr("","error");return}Mo(""),ug=setInterval(()=>{co.forEach(di=>{di.type==="drone"&&(di.longitude+=(Math.random()-.5)*2e-4,di.latitude+=(Math.random()-.5)*2e-4,di.altitude+=(Math.random()-.5)*10,di.altitude=Math.max(50,Math.min(400,di.altitude)))}),oc()},1e3)}),(i=document.getElementById("toggleDrawMode"))==null||i.addEventListener("click",()=>{if(of=!of,of){sf=!1;const tr=document.getElementById("togglePolygonMode");tr&&(tr.textContent=""),ex()}const di=document.getElementById("toggleDrawMode");di&&(di.textContent=of?"":""),dr.getCanvas().style.cursor=of?"crosshair":"",Mo(of?" - ":""),Fr(of?"":"","info")}),(Le=document.getElementById("togglePolygonMode"))==null||Le.addEventListener("click",()=>{if(sf=!sf,sf){of=!1;const tr=document.getElementById("toggleDrawMode");tr&&(tr.textContent="")}else ex();const di=document.getElementById("togglePolygonMode");di&&(di.textContent=sf?"":""),dr.getCanvas().style.cursor=sf?"crosshair":"",Mo(sf?" - ":""),Fr(sf?"":"","info")}),(wi=document.getElementById("toggleEditMode"))==null||wi.addEventListener("click",()=>{if(au=!au,au){of=!1,sf=!1;const tr=document.getElementById("toggleDrawMode"),fr=document.getElementById("togglePolygonMode");tr&&(tr.textContent=""),fr&&(fr.textContent=""),ex()}else zy();const di=document.getElementById("toggleEditMode");di&&(di.textContent=au?"":""),dr.getCanvas().style.cursor=au?"crosshair":"",Mo(au?" - Delete":""),Fr(au?"":"","info")}),(nr=document.getElementById("importCSV"))==null||nr.addEventListener("click",()=>{const di=document.createElement("input");di.type="file",di.accept=".csv",di.onchange=async tr=>{var Wr;const fr=(Wr=tr.target.files)==null?void 0:Wr[0];if(fr)try{Mo("CSV...");const qr=await fr.text(),Xi=e2(qr,fr.name);Xi.length>0?(co.push(...Xi),oc(),Mo(`CSV: ${Xi.length}`),Fr(`CSV${Xi.length}`,"success"),on("","CSV",`${fr.name}${Xi.length}`,"success")):(Fr("CSV","warning"),on("","CSV","CSV","warning"))}catch(qr){console.error("CSV:",qr),Fr("CSV","error"),on("","CSV",`${fr.name}`,"error"),Mo("CSV")}},di.click()}),(bn=document.getElementById("importGeoJSON"))==null||bn.addEventListener("click",()=>{const di=document.createElement("input");di.type="file",di.accept=".geojson,.json",di.onchange=async tr=>{var Wr;const fr=(Wr=tr.target.files)==null?void 0:Wr[0];if(fr)try{Mo("GeoJSON...");const qr=await fr.text(),Xi=i2(qr,fr.name);Xi.length>0?(co.push(...Xi),oc(),Mo(`GeoJSON: ${Xi.length}`),Fr(`GeoJSON${Xi.length}`,"success"),on("","GeoJSON",`${fr.name}${Xi.length}`,"success")):(Fr("GeoJSON","warning"),on("","GeoJSON","GeoJSON","warning"))}catch(qr){console.error("GeoJSON:",qr),Fr("GeoJSON","error"),on("","GeoJSON",`${fr.name}`,"error"),Mo("GeoJSON")}},di.click()}),(cn=document.getElementById("exportCSV"))==null||cn.addEventListener("click",()=>{if(co.length>0){const di=r2(co);Em(di,"tokyo_tower_drone_data.csv","text/csv"),Mo("CSV"),Fr("CSV","success")}else Fr("","error")}),(Rr=document.getElementById("exportGeoJSON"))==null||Rr.addEventListener("click",()=>{if(co.length>0){const di=n2(co);Em(di,"tokyo_tower_drone_data.geojson","application/geo+json"),Mo("GeoJSON"),Fr("GeoJSON","success")}else Fr("","error")}),(xr=document.getElementById("clearData"))==null||xr.addEventListener("click",()=>{co.length>0&&confirm(`${co.length}`)&&(co=[],oc(),t2(dr),ev=!1,ug&&(clearInterval(ug),ug=null),Mo(""),Fr("","info"))}),(Ci=document.getElementById("toggle3D"))==null||Ci.addEventListener("click",()=>{j2();const di=document.getElementById("toggle3D");di&&(di.textContent=Cy?"2D":"3D"),Fr(Cy?"3D":"2D","info")}),(Re=document.getElementById("clearLog"))==null||Re.addEventListener("click",()=>{A2()}),(Rn=document.getElementById("exportLog"))==null||Rn.addEventListener("click",()=>{P2()}),(pr=document.getElementById("startFlightPlan"))==null||pr.addEventListener("click",()=>{xb()}),($r=document.getElementById("pauseFlightPlan"))==null||$r.addEventListener("click",()=>{iv()}),(En=document.getElementById("exportFlightPlan"))==null||En.addEventListener("click",()=>{vb()}),($o=document.getElementById("importFlightPlan"))==null||$o.addEventListener("click",()=>{bb()}),(no=document.getElementById("mobileFlightPlanToggle"))==null||no.addEventListener("click",()=>{const di=document.getElementById("mobileFlightPlanModalOverlay");di&&di.classList.add("visible")}),(bo=document.getElementById("mobileFlightPlanModalClose"))==null||bo.addEventListener("click",()=>{const di=document.getElementById("mobileFlightPlanModalOverlay");di&&di.classList.remove("visible")}),(ba=document.getElementById("mobileFlightPlanModalOverlay"))==null||ba.addEventListener("click",di=>{if(di.target===di.currentTarget){const tr=document.getElementById("mobileFlightPlanModalOverlay");tr&&tr.classList.remove("visible")}});const jt=document.getElementById("mobileFlightPlanSelect"),bt=document.getElementById("flightPlanSelect");jt&&bt&&(jt.addEventListener("change",()=>{bt.value=jt.value;const di=new Event("change",{bubbles:!0});bt.dispatchEvent(di)}),bt.addEventListener("change",()=>{jt.value=bt.value})),(Os=document.getElementById("mobileStartFlightPlan"))==null||Os.addEventListener("click",()=>{xb();const di=document.getElementById("mobileFlightPlanModalOverlay");di&&di.classList.remove("visible")}),(Ya=document.getElementById("mobilePauseFlightPlan"))==null||Ya.addEventListener("click",()=>{iv()}),(al=document.getElementById("mobileEnableGameControl"))==null||al.addEventListener("click",()=>{const di=document.getElementById("enableGameControl");di&&di.click();const tr=document.getElementById("mobileFlightPlanModalOverlay");tr&&tr.classList.remove("visible")}),(Ja=document.getElementById("mobileExportFlightPlan"))==null||Ja.addEventListener("click",()=>{vb()}),(Hr=document.getElementById("mobileImportFlightPlan"))==null||Hr.addEventListener("click",()=>{bb()}),(sc=document.getElementById("mobileHomeButton"))==null||sc.addEventListener("click",()=>{Mm&&iv(),dr.flyTo({center:pg.center,zoom:pg.zoom,pitch:pg.pitch,bearing:pg.bearing,duration:1500}),Fr("","success"),console.log(": ")}),(cs=document.getElementById("toggleLog"))==null||cs.addEventListener("click",()=>{const di=document.getElementById("flightLogContainer"),tr=document.getElementById("toggleLog");if(console.log("Toggle"),console.log("FlightLogContainer:",di),console.log("Toggle:",tr),console.log("FlightLogContainer:",di==null?void 0:di.classList.contains("visible")),di&&tr){const fr=di.classList.contains("visible");console.log(":",fr),fr?(di.classList.remove("visible"),di.classList.add("hidden"),tr.textContent="",on("","","","info"),console.log("")):(di.classList.remove("hidden"),di.classList.add("visible"),tr.textContent="",on("","","","info"),console.log(""))}else console.error("FlightLogContainerToggle")}),(Kn=document.getElementById("importFlightData"))==null||Kn.addEventListener("click",()=>{const di=document.createElement("input");di.type="file",di.accept=".csv,.json,.geojson",di.onchange=async tr=>{var Wr;const fr=(Wr=tr.target.files)==null?void 0:Wr[0];if(fr)try{Mo("...");const qr=await fr.text();let Xi=[];if(fr.name.endsWith(".csv")?Xi=J0(qr):(fr.name.endsWith(".json")||fr.name.endsWith(".geojson"))&&(Xi=yb(qr)),Xi.length>0){const Xr=Xi.map($n=>X0($n));co.push(...Xr),oc(),Mo(`: ${Xi.length}`),Fr(`${Xi.length}`,"success"),on("","",`${fr.name}${Xi.length}`,"success")}else Fr("","warning"),on("","","","warning")}catch(qr){console.error(":",qr),Fr("","error"),on("","",`${fr.name}`,"error"),Mo("")}},di.click()}),(hn=document.getElementById("importMission"))==null||hn.addEventListener("click",()=>{const di=document.createElement("input");di.type="file",di.accept=".json",di.onchange=async tr=>{var Wr;const fr=(Wr=tr.target.files)==null?void 0:Wr[0];if(fr)try{Mo("...");const qr=await fr.text(),Xi=s2(qr);if(Xi&&Xi.waypoints&&Xi.waypoints.length>0){const Xr=Xi.waypoints.map((qo,On)=>({id:`mission_waypoint_${On+1}`,name:`_${Xi.name}_WP${On+1}`,longitude:qo.position.longitude,latitude:qo.position.latitude,altitude:qo.position.altitude,type:"flight",source:`mission_${fr.name}`}));co.push(...Xr),oc(),Mo(`: ${Xi.waypoints.length}`),Fr(`${Xi.name}${Xi.waypoints.length}`,"success"),on("","",`${Xi.name}: ${Xi.waypoints.length}`,"success");const $n=Xi.waypoints[0];dr.flyTo({center:[$n.position.longitude,$n.position.latitude],zoom:16,duration:2e3})}else Fr("","warning"),on("","","","warning")}catch(qr){console.error(":",qr),Fr("","error"),on("","",`${fr.name}`,"error"),Mo("")}},di.click()}),(Co=document.getElementById("loadSampleFlightData"))==null||Co.addEventListener("click",async()=>{try{Mo("...");const di=J0(S2);if(di.length>0){const tr=di.map(fr=>X0(fr));co.push(...tr),oc(),Mo(`: ${di.length}`),Fr(`${di.length}`,"success"),on("","",`${di.length}`,"success")}else Fr("","error"),on("","","","error")}catch(di){console.error(":",di),Fr("","error"),on("","",`: ${di instanceof Error?di.message:""}`,"error"),Mo("")}}),(zn=document.getElementById("loadSampleTrajectory"))==null||zn.addEventListener("click",async()=>{try{Mo("...");const di=J0(I2);if(di.length>0){const tr=di.filter(Wr=>Wr.timestamp).sort((Wr,qr)=>new Date(Wr.timestamp).getTime()-new Date(qr.timestamp).getTime()),fr=tr.map((Wr,qr)=>{const Xi=X0(Wr);return Xi.name=`_${qr+1}`,Xi.type="flight",Xi});if(co.push(...fr),oc(),Mo(`: ${tr.length}`),Fr(`${tr.length}`,"success"),on("","",`${tr.length}`,"success"),tr.length>0){const Wr=tr[0];dr.flyTo({center:[Wr.position.longitude,Wr.position.latitude],zoom:16,duration:2e3})}}else Fr("","error"),on("","","","error")}catch(di){console.error(":",di),Fr("","error"),on("","",`: ${di instanceof Error?di.message:""}`,"error"),Mo("")}}),(Ys=document.getElementById("exportFlightData"))==null||Ys.addEventListener("click",()=>{if(co.length>0){const di=co.map(tr=>tv(tr));try{const tr=gb(di);Em(tr,"unified_flight_data.csv","text/csv");const fr=_b(di);Em(fr,"unified_flight_data.geojson","application/geo+json"),Mo(""),Fr("CSVGeoJSON","success"),on("","",`${di.length}`,"success")}catch(tr){console.error(":",tr),Fr("","error"),on("","","","error")}}else Fr("","warning"),on("","","","warning")}),(vs=document.getElementById("exportMission"))==null||vs.addEventListener("click",()=>{if(co.length>0){const di=co.filter(tr=>tr.type==="flight"||tr.type==="drone");if(di.length>0)try{const tr=di.map(Xr=>tv(Xr));if(tr.length===0)return;const fr=tr[0].position,Wr=qT("Generated_Mission",tr,{longitude:fr.longitude,latitude:fr.latitude,altitude:fr.altitude}),qr=o2(Wr);Em(qr,`flight_mission_${new Date().toISOString().slice(0,10)}.kml`,"application/vnd.google-earth.kml+xml");const Xi=JSON.stringify(Wr,null,2);Em(Xi,`flight_mission_${new Date().toISOString().slice(0,10)}.json`,"application/json"),Mo(""),Fr("KMLJSON","success"),on("","",`${Wr.waypoints.length}`,"success")}catch(tr){console.error(":",tr),Fr("","error"),on("","","","error")}else Fr("","warning"),on("","","","warning")}else Fr("","warning"),on("","","","warning")}),(Ps=document.getElementById("importTrajectory"))==null||Ps.addEventListener("click",()=>{const di=document.createElement("input");di.type="file",di.accept=".csv,.json,.geojson",di.onchange=async tr=>{var Wr;const fr=(Wr=tr.target.files)==null?void 0:Wr[0];if(fr)try{Mo("...");const qr=await fr.text();let Xi=[];fr.name.endsWith(".csv")?Xi=J0(qr):(fr.name.endsWith(".json")||fr.name.endsWith(".geojson"))&&(Xi=yb(qr));const Xr=Xi.filter($n=>$n.timestamp).sort(($n,qo)=>new Date($n.timestamp).getTime()-new Date(qo.timestamp).getTime());if(Xr.length>0){const $n=Xr.map((qo,On)=>{const ho=X0(qo);return ho.name=`_${On+1}`,ho.type="flight",ho});if(co.push(...$n),oc(),Mo(`: ${Xr.length}`),Fr(`${Xr.length}`,"success"),on("","",`${fr.name}${Xr.length}`,"success"),Xr.length>0){const qo=Xr[0];dr.flyTo({center:[qo.position.longitude,qo.position.latitude],zoom:16,duration:2e3})}}else Fr("","warning"),on("","","","warning")}catch(qr){console.error(":",qr),Fr("","error"),on("","",`${fr.name}`,"error"),Mo("")}},di.click()}),(Hn=document.getElementById("exportTrajectory"))==null||Hn.addEventListener("click",()=>{if(co.length>0){const di=co.filter(tr=>tr.type==="flight"||tr.type==="drone");if(di.length>0)try{const tr=di.map((qr,Xi)=>{const Xr=tv(qr);return Xr.timestamp||(Xr.timestamp=new Date(Date.now()+Xi*1e4).toISOString()),Xr.type="trajectory_point",Xr}),fr=gb(tr);Em(fr,"flight_trajectory.csv","text/csv");const Wr=_b(tr);Em(Wr,"flight_trajectory.geojson","application/geo+json"),Mo(""),Fr("CSVGeoJSON","success"),on("","",`${tr.length}`,"success")}catch(tr){console.error(":",tr),Fr("","error"),on("","","","error")}else Fr("","warning"),on("","","","warning")}else Fr("","warning"),on("","","","warning")})},xb=()=>{if(Mm){on("","","","warning");return}if(sl.length===0){on("","","","error");return}fg()&&Am&&(Vf.disable(),Am=!1,on("","","","info")),ov&&(f_.disable(),on("","","","info")),Mm=!0,dp=0,on("","",`${Ou}`,"success"),mg(),va!=null&&va.isEnabled()&&(va.setFlightStatus("FLYING"),va.setTotalPhases(sl.length),va.logEvent("FLIGHT",`Started: ${Ou}`));let jt=co.find(bt=>bt.type==="drone");if(jt)jt.name=`${Ou}`,jt.longitude=sl[0].position[0],jt.latitude=sl[0].position[1],jt.altitude=0;else{const bt={id:"inspection-drone-1",name:`${Ou}`,longitude:sl[0].position[0],latitude:sl[0].position[1],altitude:0,type:"drone",source:"flight-plan"};co.push(bt)}oc(),Db()},Db=()=>{if(!Mm||dp>=sl.length){q2();return}const jt=sl[dp],bt=co.find(qt=>qt.type==="drone");if(va!=null&&va.isEnabled()&&va.setCurrentPhase(jt,dp,sl.length),!bt){on("","","","error");return}bt.longitude=jt.position[0],bt.latitude=jt.position[1],bt.altitude=jt.position[2];let Lt=0;if(dp<sl.length-1){const qt=sl[dp+1];Lt=$2([jt.position[0],jt.position[1]],[qt.position[0],qt.position[1]])}else Lt=jt.bearing??0;const re=jt.zoom??18,Dt=jt.pitch??70;on(jt.phase,"",jt.action,"info",{latitude:bt.latitude,longitude:bt.longitude,altitude:bt.altitude},{bearing:Math.round(Lt*100)/100,pitch:Dt,zoom:re}),dr.flyTo({center:[bt.longitude,bt.latitude],zoom:re,pitch:Dt,bearing:Lt,duration:jt.duration}),oc(),setTimeout(()=>{dp++,mg(),Db()},jt.duration)},$2=(jt,bt)=>{const Lt=jt[1]*Math.PI/180,re=jt[0]*Math.PI/180,Dt=bt[1]*Math.PI/180,qt=bt[0]*Math.PI/180,nt=Math.sin(qt-re)*Math.cos(Dt),i=Math.cos(Lt)*Math.sin(Dt)-Math.sin(Lt)*Math.cos(Dt)*Math.cos(qt-re);return(Math.atan2(nt,i)*180/Math.PI+360)%360},iv=()=>{if(!Mm){on("","","","warning");return}Mm=!1,fg()&&Vf&&(Vf.enable(),Am=!0,console.log(": ")),on("","",`${dp+1}`,"warning"),mg(),va!=null&&va.isEnabled()&&(va.setFlightStatus("PAUSED"),va.logEvent("PAUSE",`Paused at phase ${dp+1}`))},q2=()=>{Mm=!1,fg()&&Vf&&(Vf.enable(),Am=!0,console.log(": ")),on("","",`${Ou}`,"success"),mg(),Fr("","success"),va!=null&&va.isEnabled()&&(va.setFlightStatus("COMPLETED"),va.logEvent("COMPLETE",`Finished: ${Ou}`))},vb=()=>{const jt={name:Ou,description:Dy,created:new Date().toISOString(),phases:sl,totalDuration:sl.reduce((qt,nt)=>qt+nt.duration,0)},bt=JSON.stringify(jt,null,2),Lt=new Blob([bt],{type:"application/json"}),re=URL.createObjectURL(Lt),Dt=document.createElement("a");Dt.href=re,Dt.download=`${Ou.replace(/\s+/g,"_")}_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.json`,document.body.appendChild(Dt),Dt.click(),document.body.removeChild(Dt),URL.revokeObjectURL(re),on("","","JSON","success")},bb=()=>{const jt=document.createElement("input");jt.type="file",jt.accept=".json",jt.onchange=bt=>{var re;const Lt=(re=bt.target.files)==null?void 0:re[0];if(Lt){const Dt=new FileReader;Dt.onload=qt=>{var nt;try{const i=JSON.parse((nt=qt.target)==null?void 0:nt.result);if(!i.name||!i.phases||!Array.isArray(i.phases))throw new Error("");if(sl=i.phases,Ou=i.name,Dy=i.description||"",dg.setFlightPlan(i),tx(i.phases),on("","",`${i.name}`,"success"),Fr("","success"),i.phases.length>0){const Le=i.phases[0].position;dr.flyTo({center:[Le[0],Le[1]],zoom:16,duration:2e3})}}catch{on("","","","error"),Fr("","error")}},Dt.readAsText(Lt)}},jt.click()};dr.on("click",jt=>{Pm||(sf?D2(jt.lngLat):of?U2(jt.lngLat):au&&(k2(jt.lngLat)||zy()))});dr.on("mousedown",jt=>{if(au){const bt=dr.project(jt.lngLat),Lt=20;let re=!1;co.forEach(Dt=>{const qt=dr.project([Dt.longitude,Dt.latitude]);Math.sqrt(Math.pow(bt.x-qt.x,2)+Math.pow(bt.y-qt.y,2))<Lt&&(re=!0,xa&&xa.id===Dt.id&&(O2(jt.lngLat),jt.preventDefault()))}),!re&&Pm&&Cb()}});dr.on("mousemove",jt=>{au&&Pm&&(jt.preventDefault(),N2(jt.lngLat))});dr.on("mouseup",jt=>{au&&Pm&&(jt.preventDefault(),Cb())});document.addEventListener("keydown",jt=>{(jt.key==="Delete"||jt.key==="Backspace")&&au&&xa&&(jt.preventDefault(),V2()),jt.key==="Escape"&&au&&zy()});dr.on("webglcontextlost",jt=>{console.error("WebGL context lost:",jt),jt.preventDefault(),confirm(`

Map rendering issue detected. Reload page?`)&&window.location.reload()});dr.on("webglcontextrestored",()=>{console.log("WebGL context restored")});let rv=null;window.addEventListener("resize",()=>{rv&&clearTimeout(rv),rv=window.setTimeout(()=>{dr.resize(),console.log("Map resized for iOS Safari")},100)});window.addEventListener("orientationchange",()=>{setTimeout(()=>{dr.resize(),console.log("Map resized after orientation change")},300)});dr.on("error",jt=>{if(console.error("MapLibre GL error:",jt),jt.error&&jt.error.message&&jt.error.message.includes("tile")){console.warn("Tile loading error (non-critical):",jt.error.message);return}jt.error&&jt.error.message&&console.error("Critical map error:",jt.error.message)});dr.on("load",()=>{console.log('map.on("load") '),setTimeout(()=>{dr.resize(),console.log("Initial map resize for iOS Safari")},100);try{M2(),console.log("setupLayers() ")}catch(xr){console.error("setupLayers() :",xr),alert("")}try{G2(),console.log("setupEventHandlers() ")}catch(xr){console.error("setupEventHandlers() :",xr),alert("")}Mo(" - "),console.log("");try{E2=new m2(dr,My),console.log("MapStyleManager"),dg=new g2(dr),dg.setLogUpdateCallback(Ci=>{lf=Ci,mg()}),console.log("FlightController"),Q0=new _2(dr,[139.7454,35.6586,100]),console.log("DroneModel"),f_=new y2(dr,Q0),console.log("GameController"),Vf=new x2(dr,Q0),console.log("TouchController"),va=new v2,va.setMap(dr),va.setDroneModel(Q0),va.setFlightController(dg),console.log("DebugManager"),fg()&&(Vf.enable(),Am=!0,console.log(": "));const xr={name:"",description:"",created:new Date().toISOString(),totalDuration:39e3,phases:sv};dg.setFlightPlan(xr),tx(xr.phases),on("","","","success")}catch(xr){console.error(":",xr),on("","","","error")}on("","","","success"),on("","","","info"),setTimeout(()=>{const xr=document.getElementById("flightLogContainer"),Ci=document.getElementById("toggleLog");xr&&Ci?(xr.classList.remove("hidden"),xr.classList.add("visible"),Ci.textContent="",console.log("")):console.error("FlightLogContainerToggle")},100);try{const xr=document.getElementById("flightPlanSelect");xr&&xr.addEventListener("change",async Rn=>{const pr=Rn.target.value;if(pr==="custom"){const $r=document.getElementById("importFlightPlan");$r&&$r.click();return}try{const $r={"mt-fuji":"./data/mt-fuji-flight-plan.json","tokyo-skytree":"./data/tokyo-skytree-flight-plan.json","kyoto-kinkakuji":"./data/kyoto-kinkakuji-flight-plan.json"};if(pr==="tokyo-tower"){const En={name:"",description:"",created:new Date().toISOString(),totalDuration:39e3,phases:sv};sl=En.phases,Ou=En.name,Dy=En.description;const $o=co.find(no=>no.type==="drone");$o&&($o.name=`${En.name}`,oc()),dg.setFlightPlan(En),tx(En.phases),Fr("","success"),dr.flyTo({center:[139.7454,35.6586],zoom:16,pitch:60,bearing:0,duration:2e3})}else{const En=$r[pr];if(!En){Fr("","error");return}const $o=await fetch(En);if(!$o.ok)throw new Error("");const no=await $o.json();sl=no.phases,Ou=no.name,Dy=no.description;const bo=co.find(Os=>Os.type==="drone");bo&&(bo.name=`${no.name}`,oc()),dg.setFlightPlan(no),tx(no.phases),Fr(`${no.name}`,"success");const ba=no.phases[0].position;dr.flyTo({center:[ba[0],ba[1]],zoom:no.phases[0].zoom||16,pitch:no.phases[0].pitch||60,bearing:no.phases[0].bearing||0,duration:2e3})}}catch($r){console.error(":",$r);const En=$r instanceof Error?$r.message:"Unknown error";Fr(`: ${En}`,"error"),on("","",`${En}`,"error")}});const Ci=document.getElementById("enableGameControl");Ci&&Ci.addEventListener("click",()=>{if(!f_){Fr("","error");return}f_.enable(),ov=!0,fg()&&(Vf.enable(),Am=!0);const Rn=document.getElementById("gameControlHelp");Rn&&(Rn.style.display="block");const pr=fg()?"":"/";Fr("","success"),on("","",`${pr}`,"info"),Ci.style.opacity="0.5",Ci.style.cursor="not-allowed"});const Re=document.getElementById("disableGameControl");Re&&Re.addEventListener("click",()=>{if(!f_)return;f_.disable(),ov=!1;const Rn=document.getElementById("gameControlHelp");Rn&&(Rn.style.display="none"),Fr("","info"),on("","","","info");const pr=document.getElementById("enableGameControl");pr&&(pr.style.opacity="1",pr.style.cursor="pointer"),fg()&&Am&&(Vf.disable(),Am=!1)})}catch(xr){console.error(":",xr),console.error("")}const jt=document.getElementById("infoPanelToggle"),bt=document.getElementById("infoPanel");jt&&bt&&(localStorage.getItem("infoPanelVisible")==="false"&&(bt.classList.remove("visible"),jt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
				<circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
				<path d="M12 16v-4m0-4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
			</svg>`),jt.addEventListener("click",()=>{const Ci=bt.classList.contains("visible");bt.classList.toggle("visible"),localStorage.setItem("infoPanelVisible",(!Ci).toString()),Ci?jt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
					<path d="M12 16v-4m0-4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>`:jt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>`}));const Lt=document.getElementById("flightPlanToggle"),re=document.getElementById("flightPlanExport");Lt&&re&&(localStorage.getItem("flightPlanVisible")==="false"&&(re.classList.remove("visible"),Lt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
				<path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" fill="currentColor"/>
			</svg>`),Lt.addEventListener("click",()=>{const Ci=re.classList.contains("visible");re.classList.toggle("visible"),localStorage.setItem("flightPlanVisible",(!Ci).toString()),Ci?Lt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" fill="currentColor"/>
				</svg>`:Lt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>`}));const Dt=document.getElementById("controlsToggle"),qt=document.getElementById("controls");Dt&&qt&&(localStorage.getItem("controlsVisible")==="true"&&(qt.classList.add("visible"),Dt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
				<path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
			</svg>`),Dt.addEventListener("click",()=>{const Ci=qt.classList.contains("visible");qt.classList.toggle("visible"),localStorage.setItem("controlsVisible",(!Ci).toString()),Ci?Dt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
					<path d="M3 12h18M3 6h18M3 18h18" stroke-width="2" stroke-linecap="round"/>
				</svg>`:Dt.innerHTML=`<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
					<path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
				</svg>`}));const nt=document.getElementById("helpButton"),i=document.getElementById("helpModalOverlay"),Le=document.getElementById("helpModalClose");nt&&i&&nt.addEventListener("click",()=>{i.classList.add("visible")}),Le&&i&&(Le.addEventListener("click",()=>{i.classList.remove("visible")}),i.addEventListener("click",xr=>{xr.target===i&&i.classList.remove("visible")}));const wi=document.getElementById("mapProviderSelect"),nr=document.getElementById("mapboxTokenSection"),bn=document.getElementById("mapboxTokenInput"),cn=document.getElementById("saveMapboxToken"),Rr=document.getElementById("currentProviderInfo");wi&&Rr&&(wi.value=up.provider,Rr.innerHTML=`: <strong>${up.provider==="mapbox"?"Mapbox GL":"MapLibre GL"}</strong>`,up.provider==="mapbox"&&nr&&(nr.style.display="block",bn&&up.mapboxAccessToken&&(bn.value=up.mapboxAccessToken)),wi.addEventListener("change",xr=>{const Ci=xr.target.value;Ci==="mapbox"&&nr?nr.style.display="block":nr&&(nr.style.display="none"),Ci==="maplibre"&&(confirm(`MapLibre GL
`)?(pb({provider:Ci}),location.reload()):(wi.value=up.provider,up.provider==="mapbox"&&nr&&(nr.style.display="block")))}),cn&&bn&&cn.addEventListener("click",()=>{const xr=bn.value.trim();if(!xr){alert("");return}if(!xr.startsWith("pk.")){alert(`Mapbox
pk.`);return}pb({provider:"mapbox",mapboxAccessToken:xr}),location.reload()})),console.log('map.on("load") ')});function fg(){const jt="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,bt=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),Lt=window.innerWidth<=768;return jt&&bt||jt&&Lt}
